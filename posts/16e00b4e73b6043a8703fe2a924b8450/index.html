<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python爬虫技术 第17节 使用BeautifulSoup - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/16e00b4e73b6043a8703fe2a924b8450/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Python爬虫技术 第17节 使用BeautifulSoup">
  <meta property="og:description" content="使用Python进行网页爬取是一个常见的任务，特别是当需要从网站上批量获取数据时。BeautifulSoup是一个非常流行的Python库，用于解析HTML和XML文档，非常适合用来提取网页中的信息。
下面我将通过一个简单的案例来介绍如何使用Python和BeautifulSoup来抓取网页上的数据。
安装依赖库 首先确保你安装了requests和beautifulsoup4这两个库。如果还没有安装，可以通过pip来安装：
pip install requests beautifulsoup4 示例代码 假设我们想要从一个新闻网站上抓取最新的头条新闻标题。这里以一个虚构的新闻网站为例。
1. 导入必要的库 import requests from bs4 import BeautifulSoup 2. 发送HTTP请求 我们需要向目标网站发送一个GET请求，并获取响应的内容。
url = &#39;https://example.com/news&#39; # 假设这是我们要爬取的新闻网站URL response = requests.get(url) html_content = response.text 3. 解析HTML文档 接下来，我们使用BeautifulSoup来解析HTML文档。
soup = BeautifulSoup(html_content, &#39;html.parser&#39;) 4. 提取所需的数据 假设我们想要获取所有的新闻标题，这些标题通常会被包含在一个特定的HTML标签中，比如&lt;h2&gt;或者&lt;a&gt;标签内。
titles = soup.find_all(&#39;h2&#39;, class_=&#39;news-title&#39;) # 这里的class_=&#39;news-title&#39;是假设的类名，请根据实际情况调整 for title in titles: print(title.text.strip()) 完整示例 让我们把上述代码整合到一个完整的脚本中：
import requests from bs4 import BeautifulSoup def fetch_news_titles(url): response = requests.get(url) if response.status_code == 200: soup = BeautifulSoup(response.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-28T11:40:44+08:00">
    <meta property="article:modified_time" content="2024-07-28T11:40:44+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python爬虫技术 第17节 使用BeautifulSoup</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>使用Python进行网页爬取是一个常见的任务，特别是当需要从网站上批量获取数据时。BeautifulSoup是一个非常流行的Python库，用于解析HTML和XML文档，非常适合用来提取网页中的信息。</p> 
<p>下面我将通过一个简单的案例来介绍如何使用Python和BeautifulSoup来抓取网页上的数据。</p> 
<h4><a id="_4"></a>安装依赖库</h4> 
<p>首先确保你安装了<code>requests</code>和<code>beautifulsoup4</code>这两个库。如果还没有安装，可以通过pip来安装：</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> requests beautifulsoup4
</code></pre> 
<h4><a id="_10"></a>示例代码</h4> 
<p>假设我们想要从一个新闻网站上抓取最新的头条新闻标题。这里以一个虚构的新闻网站为例。</p> 
<h5><a id="1__13"></a>1. 导入必要的库</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
</code></pre> 
<h5><a id="2_HTTP_19"></a>2. 发送HTTP请求</h5> 
<p>我们需要向目标网站发送一个GET请求，并获取响应的内容。</p> 
<pre><code class="prism language-python">url <span class="token operator">=</span> <span class="token string">'https://example.com/news'</span>  <span class="token comment"># 假设这是我们要爬取的新闻网站URL</span>
response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
html_content <span class="token operator">=</span> response<span class="token punctuation">.</span>text
</code></pre> 
<h5><a id="3_HTML_27"></a>3. 解析HTML文档</h5> 
<p>接下来，我们使用BeautifulSoup来解析HTML文档。</p> 
<pre><code class="prism language-python">soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html_content<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="4__33"></a>4. 提取所需的数据</h5> 
<p>假设我们想要获取所有的新闻标题，这些标题通常会被包含在一个特定的HTML标签中，比如<code>&lt;h2&gt;</code>或者<code>&lt;a&gt;</code>标签内。</p> 
<pre><code class="prism language-python">titles <span class="token operator">=</span> soup<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'h2'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'news-title'</span><span class="token punctuation">)</span>  <span class="token comment"># 这里的class_='news-title'是假设的类名，请根据实际情况调整</span>
<span class="token keyword">for</span> title <span class="token keyword">in</span> titles<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>title<span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_41"></a>完整示例</h4> 
<p>让我们把上述代码整合到一个完整的脚本中：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup

<span class="token keyword">def</span> <span class="token function">fetch_news_titles</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>
        soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>
        titles <span class="token operator">=</span> soup<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'h2'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'news-title'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>title<span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> title <span class="token keyword">in</span> titles<span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Failed to retrieve data from </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">'https://example.com/news'</span>
    news_titles <span class="token operator">=</span> fetch_news_titles<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">for</span> title <span class="token keyword">in</span> news_titles<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_64"></a>注意事项</h4> 
<ul><li>在实际使用中，你需要替换上面示例中的URL为真实的新闻网站URL，并且可能需要调整CSS选择器或HTML标签来匹配实际网站的结构。</li><li>有些网站可能使用JavaScript动态加载内容，这种情况下直接抓取HTML可能无法获取所有数据。此时可以考虑使用像Selenium这样的工具。</li><li>记得遵守目标网站的robots.txt文件规定以及相关法律法规，尊重网站的版权和数据使用政策。</li></ul> 
<p>接下来我们可以进一步扩展之前的案例，使其能够处理更复杂的网页结构，并添加一些额外的功能，如错误处理、日志记录等。此外，还可以增加对动态加载内容的支持。</p> 
<h4><a id="_74"></a>扩展案例</h4> 
<h5><a id="1__76"></a>1. 错误处理与日志记录</h5> 
<p>在实际爬虫项目中，错误处理非常重要。我们应该考虑到网络连接失败、服务器返回错误、网页结构变化等情况。同时，良好的日志记录可以帮助我们追踪程序运行的状态和问题。</p> 
<h5><a id="2__79"></a>2. 处理动态加载的内容</h5> 
<p>有些网站使用JavaScript来动态加载内容，这使得直接抓取HTML变得不够全面。在这种情况下，我们可以使用Selenium来模拟浏览器行为。</p> 
<h5><a id="3__82"></a>3. 存储数据</h5> 
<p>最后，我们需要考虑如何存储抓取的数据。这里我们可以简单地将其写入文本文件或数据库。</p> 
<h4><a id="_85"></a>示例代码</h4> 
<h5><a id="1__87"></a>1. 引入必要的库</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>service <span class="token keyword">import</span> Service
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> time
</code></pre> 
<h5><a id="2__100"></a>2. 设置日志</h5> 
<pre><code class="prism language-python">logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="3__106"></a>3. 定义函数来抓取静态内容</h5> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">fetch_static_content</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Fetching static content from: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 抛出HTTP错误（如404）</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span>text
    <span class="token keyword">except</span> requests<span class="token punctuation">.</span>RequestException <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error fetching content: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre> 
<h5><a id="4__119"></a>4. 定义函数来抓取动态加载的内容</h5> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">fetch_dynamic_content</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    options <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>ChromeOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--headless'</span><span class="token punctuation">)</span>  <span class="token comment"># 无头模式运行</span>
    service <span class="token operator">=</span> Service<span class="token punctuation">(</span><span class="token string">'path/to/chromedriver'</span><span class="token punctuation">)</span>  <span class="token comment"># 指定chromedriver路径</span>
    driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>service<span class="token operator">=</span>service<span class="token punctuation">,</span> options<span class="token operator">=</span>options<span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Fetching dynamic content from: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token comment"># 假设有一个“加载更多”按钮需要点击</span>
        load_more_button <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>driver<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>until<span class="token punctuation">(</span>
            EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"load-more"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        load_more_button<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 等待新内容加载完成</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取页面源码</span>
        html_content <span class="token operator">=</span> driver<span class="token punctuation">.</span>page_source
        <span class="token keyword">return</span> html_content
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error fetching dynamic content: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        driver<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="5__149"></a>5. 定义函数来解析内容并提取数据</h5> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">parse_and_extract_data</span><span class="token punctuation">(</span>html_content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> html_content<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html_content<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>

    <span class="token comment"># 假设新闻标题都在&lt;h2&gt;标签里，并且有特定的class属性</span>
    titles <span class="token operator">=</span> soup<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'h2'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'news-title'</span><span class="token punctuation">)</span>
    news_items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'title'</span><span class="token punctuation">:</span> title<span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">for</span> title <span class="token keyword">in</span> titles<span class="token punctuation">]</span>

    <span class="token keyword">return</span> news_items
</code></pre> 
<h5><a id="6__164"></a>6. 定义主函数</h5> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">'https://example.com/news'</span>
    
    <span class="token comment"># 静态内容抓取</span>
    static_html <span class="token operator">=</span> fetch_static_content<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    static_news_items <span class="token operator">=</span> parse_and_extract_data<span class="token punctuation">(</span>static_html<span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Static content parsed."</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 动态内容抓取</span>
    dynamic_html <span class="token operator">=</span> fetch_dynamic_content<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    dynamic_news_items <span class="token operator">=</span> parse_and_extract_data<span class="token punctuation">(</span>dynamic_html<span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Dynamic content parsed."</span><span class="token punctuation">)</span>

    <span class="token comment"># 合并数据</span>
    all_news_items <span class="token operator">=</span> static_news_items <span class="token operator">+</span> dynamic_news_items
    
    <span class="token comment"># 写入文件</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'news_items.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> all_news_items<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
    
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Data saved to file."</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_193"></a>注意事项</h4> 
<ul><li>在使用Selenium时，确保已经安装了ChromeDriver，并将其路径设置正确。</li><li>请根据实际网站结构调整CSS选择器或HTML标签。</li><li>如果网站有反爬措施，可能还需要添加其他策略，例如使用代理、设置合理的延时等。</li></ul> 
<p>以上就是一个更完整的示例，它包含了错误处理、日志记录、动态内容抓取等功能。如果你有任何疑问或需要进一步的帮助，请随时告诉我！</p> 
<p>我们可以进一步优化代码，使其更加健壮和高效。以下是一些改进点：</p> 
<ol><li><strong>异常处理和重试机制</strong>：在网络不稳定的情况下，可以添加重试逻辑来提高爬虫的稳定性。</li><li><strong>异步请求</strong>：使用异步IO来并发处理多个请求，提高爬虫效率。</li><li><strong>更详细的日志记录</strong>：记录更多的信息以便于调试和监控。</li><li><strong>更优雅的退出机制</strong>：确保在发生错误时，程序能够安全地结束。</li></ol> 
<p>下面是优化后的代码示例：</p> 
<h4><a id="1__213"></a>1. 异步请求</h4> 
<p>我们将使用<code>asyncio</code>和<code>aiohttp</code>来进行异步请求，以提高效率。</p> 
<h4><a id="2__216"></a>2. 重试机制</h4> 
<p>对于网络请求，我们可以添加重试机制，以应对偶尔的网络波动。</p> 
<h4><a id="3__219"></a>3. 日志记录</h4> 
<p>我们将使用更详细的日志记录，包括请求状态、异常信息等。</p> 
<h4><a id="4__222"></a>4. 安全退出</h4> 
<p>确保在发生错误时，程序能够安全地结束。</p> 
<h4><a id="_225"></a>示例代码</h4> 
<h5><a id="1__227"></a>1. 安装额外依赖</h5> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> aiohttp
</code></pre> 
<h5><a id="2__232"></a>2. 更新导入模块</h5> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> bs4 <span class="token keyword">import</span> BeautifulSoup
<span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> ClientSession<span class="token punctuation">,</span> ClientResponseError
<span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>chrome<span class="token punctuation">.</span>service <span class="token keyword">import</span> Service
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>common<span class="token punctuation">.</span>by <span class="token keyword">import</span> By
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support<span class="token punctuation">.</span>ui <span class="token keyword">import</span> WebDriverWait
<span class="token keyword">from</span> selenium<span class="token punctuation">.</span>webdriver<span class="token punctuation">.</span>support <span class="token keyword">import</span> expected_conditions <span class="token keyword">as</span> EC
<span class="token keyword">import</span> time
</code></pre> 
<h5><a id="3__246"></a>3. 设置日志</h5> 
<pre><code class="prism language-python">logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="4__252"></a>4. 定义异步请求函数</h5> 
<pre><code class="prism language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">,</span> max_retries<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> retry <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_retries<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> response<span class="token punctuation">:</span>
                response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
                logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Fetched </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string"> successfully."</span></span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> ClientResponseError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Failed to fetch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">, status code: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">.</span>status<span class="token punctuation">}</span></span><span class="token string">. Retrying..."</span></span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error fetching </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">. Retrying..."</span></span><span class="token punctuation">)</span>

        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span>retry <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Exponential backoff</span>

    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Failed to fetch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string"> after </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>max_retries<span class="token punctuation">}</span></span><span class="token string"> retries."</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">None</span>
</code></pre> 
<h5><a id="5__272"></a>5. 定义异步抓取静态内容函数</h5> 
<pre><code class="prism language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch_static_content</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">:</span>
    html_content <span class="token operator">=</span> <span class="token keyword">await</span> fetch<span class="token punctuation">(</span>session<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    <span class="token keyword">return</span> html_content
</code></pre> 
<h5><a id="6__279"></a>6. 定义抓取动态内容函数</h5> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">fetch_dynamic_content</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    options <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>ChromeOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>
    options<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--headless'</span><span class="token punctuation">)</span>  <span class="token comment"># 无头模式运行</span>
    service <span class="token operator">=</span> Service<span class="token punctuation">(</span><span class="token string">'path/to/chromedriver'</span><span class="token punctuation">)</span>  <span class="token comment"># 指定chromedriver路径</span>
    driver <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>service<span class="token operator">=</span>service<span class="token punctuation">,</span> options<span class="token operator">=</span>options<span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Fetching dynamic content from: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>url<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        driver<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        <span class="token comment"># 假设有一个“加载更多”按钮需要点击</span>
        load_more_button <span class="token operator">=</span> WebDriverWait<span class="token punctuation">(</span>driver<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>until<span class="token punctuation">(</span>
            EC<span class="token punctuation">.</span>element_to_be_clickable<span class="token punctuation">(</span><span class="token punctuation">(</span>By<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"load-more"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        load_more_button<span class="token punctuation">.</span>click<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 等待新内容加载完成</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token comment"># 获取页面源码</span>
        html_content <span class="token operator">=</span> driver<span class="token punctuation">.</span>page_source
        <span class="token keyword">return</span> html_content
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error fetching dynamic content: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        driver<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="7__309"></a>7. 定义解析内容并提取数据函数</h5> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">parse_and_extract_data</span><span class="token punctuation">(</span>html_content<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> html_content<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    soup <span class="token operator">=</span> BeautifulSoup<span class="token punctuation">(</span>html_content<span class="token punctuation">,</span> <span class="token string">'html.parser'</span><span class="token punctuation">)</span>

    <span class="token comment"># 假设新闻标题都在&lt;h2&gt;标签里，并且有特定的class属性</span>
    titles <span class="token operator">=</span> soup<span class="token punctuation">.</span>find_all<span class="token punctuation">(</span><span class="token string">'h2'</span><span class="token punctuation">,</span> class_<span class="token operator">=</span><span class="token string">'news-title'</span><span class="token punctuation">)</span>
    news_items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'title'</span><span class="token punctuation">:</span> title<span class="token punctuation">.</span>text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">for</span> title <span class="token keyword">in</span> titles<span class="token punctuation">]</span>

    <span class="token keyword">return</span> news_items
</code></pre> 
<h5><a id="8__324"></a>8. 定义主函数</h5> 
<pre><code class="prism language-python"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    url <span class="token operator">=</span> <span class="token string">'https://example.com/news'</span>

    <span class="token keyword">async</span> <span class="token keyword">with</span> ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token comment"># 静态内容抓取</span>
        static_html <span class="token operator">=</span> <span class="token keyword">await</span> fetch_static_content<span class="token punctuation">(</span>url<span class="token punctuation">,</span> session<span class="token punctuation">)</span>
        static_news_items <span class="token operator">=</span> parse_and_extract_data<span class="token punctuation">(</span>static_html<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Static content parsed."</span><span class="token punctuation">)</span>

        <span class="token comment"># 动态内容抓取</span>
        dynamic_html <span class="token operator">=</span> fetch_dynamic_content<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
        dynamic_news_items <span class="token operator">=</span> parse_and_extract_data<span class="token punctuation">(</span>dynamic_html<span class="token punctuation">)</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Dynamic content parsed."</span><span class="token punctuation">)</span>

    <span class="token comment"># 合并数据</span>
    all_news_items <span class="token operator">=</span> static_news_items <span class="token operator">+</span> dynamic_news_items

    <span class="token comment"># 写入文件</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'news_items.txt'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> all_news_items<span class="token punctuation">:</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>

    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Data saved to file."</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_354"></a>注意事项</h4> 
<ul><li>确保安装了<code>aiohttp</code>库。</li><li>调整<code>fetch</code>函数中的重试次数和等待时间以适应你的需求。</li><li>如果使用Selenium，确保已经安装了ChromeDriver，并将其路径设置正确。</li><li>请根据实际网站结构调整CSS选择器或HTML标签。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e3e3579e729e42f7849b82b143ba1c46/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PostgreSQL入门与进阶学习，体系化的SQL知识，完成终极目标高可用与容灾，性能优化与架构设计，以及安全策略</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/eb22cc1a19de1395db574dc9b55431cb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Redis系列】RedisTemplate的使用与注意事项</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>