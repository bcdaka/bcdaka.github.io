<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL Server中的CTE魔法：解锁公用表表达式的强大力量 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/6de90057d5b6fb5d7ff241e6213407e6/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="SQL Server中的CTE魔法：解锁公用表表达式的强大力量">
  <meta property="og:description" content="SQL Server中的CTE魔法：解锁公用表表达式的强大力量 在SQL Server的数据处理中，公用表表达式（Common Table Expressions，简称CTE）是一种强大的工具，它允许开发者在查询中定义临时的结果集，这些结果集可以在一个或多个SELECT、INSERT、UPDATE或DELETE语句中被引用。本文将深入探讨如何在SQL Server中使用CTE，并通过代码示例展示其灵活性和强大功能。
1. CTE的基本概念 CTE提供了一种定义临时结果集的方法，这些结果集可以是简单的数据集，也可以是复杂的多步骤计算。
2. CTE的基本语法 CTE的基本语法如下：
WITH CTE_Name (Column1, Column2, ...) AS ( -- CTE查询定义 SELECT Column1, Column2, ... FROM SomeTable WHERE SomeCondition ) -- 使用CTE的查询 SELECT * FROM CTE_Name; 3. 使用CTE进行数据过滤 CTE可以用于数据过滤，创建复杂的过滤逻辑。
WITH FilteredData (EmployeeID, DepartmentID) AS ( SELECT EmployeeID, DepartmentID FROM Employees WHERE DepartmentID IN (1, 2, 5) ) SELECT * FROM FilteredData; 4. CTE在数据聚合中的应用 CTE也可以用于数据聚合，简化复杂的GROUP BY查询。
WITH DepartmentTotals (DepartmentID, TotalSales) AS ( SELECT DepartmentID, SUM(SalesAmount) FROM Sales GROUP BY DepartmentID ) SELECT DepartmentID, TotalSales FROM DepartmentTotals ORDER BY TotalSales DESC; 5.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-04T21:20:59+08:00">
    <meta property="article:modified_time" content="2024-08-04T21:20:59+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL Server中的CTE魔法：解锁公用表表达式的强大力量</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="SQL_ServerCTE_0"></a>SQL Server中的CTE魔法：解锁公用表表达式的强大力量</h4> 
<p>在SQL Server的数据处理中，公用表表达式（Common Table Expressions，简称CTE）是一种强大的工具，它允许开发者在查询中定义临时的结果集，这些结果集可以在一个或多个SELECT、INSERT、UPDATE或DELETE语句中被引用。本文将深入探讨如何在SQL Server中使用CTE，并通过代码示例展示其灵活性和强大功能。</p> 
<h5><a id="1_CTE_4"></a>1. CTE的基本概念</h5> 
<p>CTE提供了一种定义临时结果集的方法，这些结果集可以是简单的数据集，也可以是复杂的多步骤计算。</p> 
<h5><a id="2_CTE_8"></a>2. CTE的基本语法</h5> 
<p>CTE的基本语法如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">WITH</span> CTE_Name <span class="token punctuation">(</span>Column1<span class="token punctuation">,</span> Column2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
    <span class="token comment">-- CTE查询定义</span>
    <span class="token keyword">SELECT</span> Column1<span class="token punctuation">,</span> Column2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">FROM</span> SomeTable
    <span class="token keyword">WHERE</span> SomeCondition
<span class="token punctuation">)</span>
<span class="token comment">-- 使用CTE的查询</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> CTE_Name<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="3_CTE_26"></a>3. 使用CTE进行数据过滤</h5> 
<p>CTE可以用于数据过滤，创建复杂的过滤逻辑。</p> 
<pre><code class="prism language-sql"><span class="token keyword">WITH</span> FilteredData <span class="token punctuation">(</span>EmployeeID<span class="token punctuation">,</span> DepartmentID<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> EmployeeID<span class="token punctuation">,</span> DepartmentID
    <span class="token keyword">FROM</span> Employees
    <span class="token keyword">WHERE</span> DepartmentID <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> FilteredData<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="4_CTE_42"></a>4. CTE在数据聚合中的应用</h5> 
<p>CTE也可以用于数据聚合，简化复杂的GROUP BY查询。</p> 
<pre><code class="prism language-sql"><span class="token keyword">WITH</span> DepartmentTotals <span class="token punctuation">(</span>DepartmentID<span class="token punctuation">,</span> TotalSales<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> DepartmentID<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>SalesAmount<span class="token punctuation">)</span>
    <span class="token keyword">FROM</span> Sales
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> DepartmentID
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> DepartmentID<span class="token punctuation">,</span> TotalSales
<span class="token keyword">FROM</span> DepartmentTotals
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> TotalSales <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="5_CTE_59"></a>5. 递归CTE的使用</h5> 
<p>SQL Server支持递归CTE，它可以用于查询具有层级或递归关系的数据。</p> 
<pre><code class="prism language-sql"><span class="token keyword">WITH</span> EmployeeHierarchy <span class="token punctuation">(</span>EmployeeID<span class="token punctuation">,</span> ManagerID<span class="token punctuation">,</span> EmployeeLevel<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> EmployeeID<span class="token punctuation">,</span> ManagerID<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">AS</span> EmployeeLevel
    <span class="token keyword">FROM</span> Employees
    <span class="token keyword">WHERE</span> ManagerID <span class="token operator">IS</span> <span class="token boolean">NULL</span>
    <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
    <span class="token keyword">SELECT</span> e<span class="token punctuation">.</span>EmployeeID<span class="token punctuation">,</span> e<span class="token punctuation">.</span>ManagerID<span class="token punctuation">,</span> eh<span class="token punctuation">.</span>EmployeeLevel <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token keyword">FROM</span> Employees e
    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> EmployeeHierarchy eh <span class="token keyword">ON</span> e<span class="token punctuation">.</span>ManagerID <span class="token operator">=</span> eh<span class="token punctuation">.</span>EmployeeID
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span>
<span class="token keyword">FROM</span> EmployeeHierarchy<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="6_CTEJOIN_79"></a>6. CTE与JOIN操作</h5> 
<p>CTE可以与JOIN操作结合使用，处理复杂的数据关联。</p> 
<pre><code class="prism language-sql"><span class="token keyword">WITH</span> ProductSales <span class="token punctuation">(</span>ProductID<span class="token punctuation">,</span> TotalUnits<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> ProductID<span class="token punctuation">,</span> <span class="token function">SUM</span><span class="token punctuation">(</span>UnitsSold<span class="token punctuation">)</span>
    <span class="token keyword">FROM</span> Sales
    <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> ProductID
<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> p<span class="token punctuation">.</span>ProductID<span class="token punctuation">,</span> p<span class="token punctuation">.</span>ProductName<span class="token punctuation">,</span> ps<span class="token punctuation">.</span>TotalUnits
<span class="token keyword">FROM</span> Products p
<span class="token keyword">JOIN</span> ProductSales ps <span class="token keyword">ON</span> p<span class="token punctuation">.</span>ProductID <span class="token operator">=</span> ps<span class="token punctuation">.</span>ProductID<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="7_CTE_96"></a>7. CTE在数据插入和更新操作中的应用</h5> 
<p>CTE不仅可以用于查询，还可以用于INSERT和UPDATE操作。</p> 
<pre><code class="prism language-sql"><span class="token keyword">WITH</span> NewSalesData <span class="token punctuation">(</span>SaleID<span class="token punctuation">,</span> ProductID<span class="token punctuation">,</span> UnitsSold<span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">150</span>
    <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
    <span class="token keyword">SELECT</span> <span class="token number">102</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">200</span>
<span class="token punctuation">)</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> Sales <span class="token punctuation">(</span>SaleID<span class="token punctuation">,</span> ProductID<span class="token punctuation">,</span> UnitsSold<span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> SaleID<span class="token punctuation">,</span> ProductID<span class="token punctuation">,</span> UnitsSold
<span class="token keyword">FROM</span> NewSalesData<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="8__113"></a>8. 结论</h5> 
<p>CTE是SQL Server中一项强大的功能，它提供了一种清晰、高效的方式来处理复杂的数据集。通过本文的详细介绍，你应该已经掌握了CTE的基本语法和多种应用场景。</p> 
<p>无论是进行数据过滤、聚合、递归查询，还是与JOIN操作结合使用，CTE都能提供简洁而强大的解决方案。此外，CTE还可以用于数据插入和更新操作，进一步扩展了其应用范围。</p> 
<p>通过本文的深入分析和实践指导，我们不仅理解了CTE的灵活性和强大功能，还学会了如何在SQL Server中有效使用CTE。现在，你可以自信地在SQL查询和数据处理任务中应用CTE，提升你的工作效率和数据处理能力。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bb423d12ad31b122d44788e18925d53d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">断电引起redo和数据文件不一致故障恢复---惜分飞</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1b69c8399a7d0af574873e9c081e4358/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java 并发编程：volatile 关键字介绍与使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>