<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AI大模型探索之路-实战篇12： 构建互动式Agent智能数据分析平台：实现多轮对话控制 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/85d4bb1f7ad7130dc7ed506e1361cead/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="AI大模型探索之路-实战篇12： 构建互动式Agent智能数据分析平台：实现多轮对话控制">
  <meta property="og:description" content="系列篇章💥 AI大模型探索之路-实战篇4：深入DB-GPT数据应用开发框架调研
AI大模型探索之路-实战篇5：探索Open Interpreter开放代码解释器调研
AI大模型探索之路-实战篇6：掌握Function Calling的详细流程
AI大模型探索之路-实战篇7：Function Calling技术实战自动生成函数
AI大模型探索之路-实战篇8：多轮对话与Function Calling技术应用
AI大模型探索之路-实战篇9：探究Agent智能数据分析平台的架构与功能
AI大模型探索之路-实战篇10：数据预处理的艺术：构建Agent智能数据分析平台的基础
AI大模型探索之路-实战篇11： Function Calling技术整合：强化Agent智能数据分析平台功能
目录 系列篇章💥一、前言二、引入背景知识库1、定义OpenAI客户端2、定义工具函数生成器3、两次大模型API调用封装4、user_demographics数据查询服务封装5、user_demographics函数信息生成测试6、第一次数据查询对话测试7、读取数据字典8、第二次数据查询对话测试9、数据库基本信息查询测试10、数据分析调用测试 三、实现交互确认1、定义数据库基本信息获取函数2、函数信息生成测试检查：3、数据分析测试4、定义SQL提取函数5、两次次大模型API两次调用封装改造6、定义消息列表7、数据查询分析测试18、数据查询分析测试29、数据查询分析测试3 四、实现完整的多轮对话效果五、结语 一、前言 在Agent智能数据分析平台的实战开发中，继我们之前关于Function Calling技术整合的讨论之后，本文将专注于实现一个核心功能——多轮对话控制系统。这一机制能够让用户通过自然语言与系统进行连续的交流，从而更准确、更高效地完成数据分析任务。
二、引入背景知识库 引入数据字典知识，作为大模型对话的背景知识库。
1、定义OpenAI客户端 定义大模型客户端，用于与大模型交互对话
import openai import os import numpy as np import pandas as pd import json import io from openai import OpenAI import inspect import pymysql openai.api_key = os.getenv(&#34;OPENAI_API_KEY&#34;) client = OpenAI(api_key=openai.api_key) 2、定义工具函数生成器 定义一个函数，用于自动生成function calling功能需要的，工具函数信息体
def auto_functions(functions_list): &#34;&#34;&#34; Chat模型的functions参数编写函数 :param functions_list: 包含一个或者多个函数对象的列表； :return：满足Chat模型functions参数要求的functions对象 &#34;&#34;&#34; def functions_generate(functions_list): # 创建空列表，用于保存每个函数的描述字典 functions = [] # 对每个外部函数进行循环 for function in functions_list: # 读取函数对象的函数说明 function_description = inspect.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-01T14:46:27+08:00">
    <meta property="article:modified_time" content="2024-06-01T14:46:27+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">AI大模型探索之路-实战篇12： 构建互动式Agent智能数据分析平台：实现多轮对话控制</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>系列篇章💥</h2> 
<p><a href="https://xundaomalu.blog.csdn.net/article/details/139169884" rel="nofollow">AI大模型探索之路-实战篇4：深入DB-GPT数据应用开发框架调研</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139190028" rel="nofollow">AI大模型探索之路-实战篇5：探索Open Interpreter开放代码解释器调研</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139186663" rel="nofollow">AI大模型探索之路-实战篇6：掌握Function Calling的详细流程</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139193382" rel="nofollow">AI大模型探索之路-实战篇7：Function Calling技术实战自动生成函数</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139194151" rel="nofollow">AI大模型探索之路-实战篇8：多轮对话与Function Calling技术应用</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139205615" rel="nofollow">AI大模型探索之路-实战篇9：探究Agent智能数据分析平台的架构与功能</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139216544" rel="nofollow">AI大模型探索之路-实战篇10：数据预处理的艺术：构建Agent智能数据分析平台的基础</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139216752" rel="nofollow">AI大模型探索之路-实战篇11： Function Calling技术整合：强化Agent智能数据分析平台功能</a></p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_0" rel="nofollow">系列篇章💥</a></li><li><a href="#_18" rel="nofollow">一、前言</a></li><li><a href="#_20" rel="nofollow">二、引入背景知识库</a></li><li><ul><li><a href="#1OpenAI_22" rel="nofollow">1、定义OpenAI客户端</a></li><li><a href="#2_40" rel="nofollow">2、定义工具函数生成器</a></li><li><a href="#3API_97" rel="nofollow">3、两次大模型API调用封装</a></li><li><a href="#4user_demographics_164" rel="nofollow">4、user_demographics数据查询服务封装</a></li><li><a href="#5user_demographics_198" rel="nofollow">5、user_demographics函数信息生成测试</a></li><li><a href="#6_214" rel="nofollow">6、第一次数据查询对话测试</a></li><li><a href="#7_241" rel="nofollow">7、读取数据字典</a></li><li><a href="#8_258" rel="nofollow">8、第二次数据查询对话测试</a></li><li><a href="#9_285" rel="nofollow">9、数据库基本信息查询测试</a></li><li><a href="#10_307" rel="nofollow">10、数据分析调用测试</a></li></ul> 
  </li><li><a href="#_329" rel="nofollow">三、实现交互确认</a></li><li><ul><li><a href="#1_331" rel="nofollow">1、定义数据库基本信息获取函数</a></li><li><a href="#2_369" rel="nofollow">2、函数信息生成测试检查：</a></li><li><a href="#3_385" rel="nofollow">3、数据分析测试</a></li><li><a href="#4SQL_399" rel="nofollow">4、定义SQL提取函数</a></li><li><a href="#5API_407" rel="nofollow">5、两次次大模型API两次调用封装改造</a></li><li><a href="#6_486" rel="nofollow">6、定义消息列表</a></li><li><a href="#71_499" rel="nofollow">7、数据查询分析测试1</a></li><li><a href="#82_510" rel="nofollow">8、数据查询分析测试2</a></li><li><a href="#93_526" rel="nofollow">9、数据查询分析测试3</a></li></ul> 
  </li><li><a href="#_542" rel="nofollow">四、实现完整的多轮对话效果</a></li><li><a href="#_610" rel="nofollow">五、结语</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_18"></a>一、前言</h2> 
<p>在Agent智能数据分析平台的实战开发中，继我们之前关于Function Calling技术整合的讨论之后，本文将专注于实现一个核心功能——多轮对话控制系统。这一机制能够让用户通过自然语言与系统进行连续的交流，从而更准确、更高效地完成数据分析任务。</p> 
<h2><a id="_20"></a>二、引入背景知识库</h2> 
<p>引入数据字典知识，作为大模型对话的背景知识库。</p> 
<h3><a id="1OpenAI_22"></a>1、定义OpenAI客户端</h3> 
<p>定义大模型客户端，用于与大模型交互对话</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> openai
<span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> json
<span class="token keyword">import</span> io
<span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI
<span class="token keyword">import</span> inspect
<span class="token keyword">import</span> pymysql

openai<span class="token punctuation">.</span>api_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span>

client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>api_key<span class="token operator">=</span>openai<span class="token punctuation">.</span>api_key<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2_40"></a>2、定义工具函数生成器</h3> 
<p>定义一个函数，用于自动生成function calling功能需要的，工具函数信息体</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">auto_functions</span><span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Chat模型的functions参数编写函数
    :param functions_list: 包含一个或者多个函数对象的列表；
    :return：满足Chat模型functions参数要求的functions对象
    """</span>
    <span class="token keyword">def</span> <span class="token function">functions_generate</span><span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 创建空列表，用于保存每个函数的描述字典</span>
        functions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 对每个外部函数进行循环</span>
        <span class="token keyword">for</span> function <span class="token keyword">in</span> functions_list<span class="token punctuation">:</span>
            <span class="token comment"># 读取函数对象的函数说明</span>
            function_description <span class="token operator">=</span> inspect<span class="token punctuation">.</span>getdoc<span class="token punctuation">(</span>function<span class="token punctuation">)</span>
            <span class="token comment"># 读取函数的函数名字符串</span>
            function_name <span class="token operator">=</span> function<span class="token punctuation">.</span>__name__

            system_prompt <span class="token operator">=</span> <span class="token string">'以下是某的函数说明：%s'</span> <span class="token operator">%</span> function_description
            user_prompt <span class="token operator">=</span> '根据这个函数的函数说明，请帮我创建一个JSON格式的字典，这个字典有如下<span class="token number">5</span>点要求：\
                           <span class="token number">1.</span>字典总共有三个键值对；\
                           <span class="token number">2.</span>第一个键值对的Key是字符串name，value是该函数的名字：<span class="token operator">%</span>s，也是字符串；\
                           <span class="token number">3.</span>第二个键值对的Key是字符串description，value是该函数的函数的功能说明，也是字符串；\
                           <span class="token number">4.</span>第三个键值对的Key是字符串parameters，value是一个JSON Schema对象，用于说明该函数的参数输入规范。\
                           <span class="token number">5.</span>输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句' <span class="token operator">%</span> function_name

            response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                              model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span>
                              messages<span class="token operator">=</span><span class="token punctuation">[</span>
                                <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system_prompt<span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> user_prompt<span class="token punctuation">}</span>
                              <span class="token punctuation">]</span>
                            <span class="token punctuation">)</span>
            json_function_description<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"```"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            json_str<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span><span class="token string">"function"</span><span class="token punctuation">:</span>json_function_description<span class="token punctuation">}</span>
            functions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span>
        <span class="token keyword">return</span> functions
    
    max_attempts <span class="token operator">=</span> <span class="token number">4</span>
    attempts <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">while</span> attempts <span class="token operator">&lt;</span> max_attempts<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            functions <span class="token operator">=</span> functions_generate<span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span>
            <span class="token keyword">break</span>  <span class="token comment"># 如果代码成功执行，跳出循环</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            attempts <span class="token operator">+=</span> <span class="token number">1</span>  <span class="token comment"># 增加尝试次数</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"发生错误："</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
            <span class="token keyword">if</span> attempts <span class="token operator">==</span> max_attempts<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"已达到最大尝试次数，程序终止。"</span><span class="token punctuation">)</span>
                <span class="token keyword">raise</span>  <span class="token comment"># 重新引发最后一个异常</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在重新运行..."</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> functions
</code></pre> 
<h3><a id="3API_97"></a>3、两次大模型API调用封装</h3> 
<p>封装funcation calling中两次大模型API得调用</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">run_conversation</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> functions_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    能够自动执行外部函数调用的对话模型
    :param messages: 必要参数，字典类型，输入到Chat模型的messages参数对象
    :param functions_list: 可选参数，默认为None，可以设置为包含全部外部函数的列表对象
    :param model: Chat模型，可选参数，默认模型为gpt-3.5-turbo
    :return：Chat模型输出结果
    """</span>
    <span class="token comment"># 如果没有外部函数库，则执行普通的对话任务</span>
    <span class="token keyword">if</span> functions_list <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                        model<span class="token operator">=</span>model<span class="token punctuation">,</span>
                        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
        response_message <span class="token operator">=</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message
        final_response <span class="token operator">=</span> response_message<span class="token punctuation">.</span>content
        
    <span class="token comment"># 若存在外部函数库，则需要灵活选取外部函数并进行回答</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 创建functions对象</span>
        tools <span class="token operator">=</span> auto_functions<span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span>

        <span class="token comment"># 创建外部函数库字典</span>
        available_functions <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">:</span> func <span class="token keyword">for</span> func <span class="token keyword">in</span> functions_list<span class="token punctuation">}</span>

        <span class="token comment"># 第一次调用大模型</span>
        response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                        model<span class="token operator">=</span>model<span class="token punctuation">,</span>
                        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
                        tools<span class="token operator">=</span>tools<span class="token punctuation">,</span>
                        tool_choice<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
        response_message <span class="token operator">=</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message

        tool_calls <span class="token operator">=</span> response_message<span class="token punctuation">.</span>tool_calls
        <span class="token keyword">if</span> tool_calls<span class="token punctuation">:</span>
            messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>response_message<span class="token punctuation">)</span> 
            <span class="token keyword">for</span> tool_call <span class="token keyword">in</span> tool_calls<span class="token punctuation">:</span>
                function_name <span class="token operator">=</span> tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>name
                function_to_call <span class="token operator">=</span> available_functions<span class="token punctuation">[</span>function_name<span class="token punctuation">]</span>
                function_args <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span>
                
                function_response <span class="token operator">=</span> function_to_call<span class="token punctuation">(</span><span class="token operator">**</span>function_args<span class="token punctuation">)</span>
                messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token string">"tool_call_id"</span><span class="token punctuation">:</span> tool_call<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                        <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"tool"</span><span class="token punctuation">,</span>
                        <span class="token string">"name"</span><span class="token punctuation">:</span> function_name<span class="token punctuation">,</span>
                        <span class="token string">"content"</span><span class="token punctuation">:</span> function_response<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span> 
            <span class="token comment">## 第二次调用模型</span>
            second_response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                model<span class="token operator">=</span>model<span class="token punctuation">,</span>
                messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
            <span class="token punctuation">)</span> 
            <span class="token comment"># 获取最终结果</span>
            final_response <span class="token operator">=</span> second_response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            final_response <span class="token operator">=</span> response_message<span class="token punctuation">.</span>content
                
    <span class="token keyword">return</span> final_response
</code></pre> 
<h3><a id="4user_demographics_164"></a>4、user_demographics数据查询服务封装</h3> 
<p>定义一个get_user_demographics函数，用于获取user_demographics 表的相关信息</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_user_demographics</span><span class="token punctuation">(</span>sql_query<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    用户获取user_demographics 表的相关信息
    :param sql_query: 字符串形式的SQL语句
    :return SQL查询的user_demographics 表的相关信息
    """</span>
    mysql_pw<span class="token operator">=</span><span class="token string">"iquery_agent"</span>
    
    connection <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
    host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库地址</span>
    user<span class="token operator">=</span><span class="token string">'iquery_agent'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库用户名</span>
    passwd<span class="token operator">=</span>mysql_pw<span class="token punctuation">,</span>  <span class="token comment"># 数据库密码</span>
    db<span class="token operator">=</span><span class="token string">'iquery'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库名</span>
    charset<span class="token operator">=</span><span class="token string">'utf8'</span>  <span class="token comment"># 字符集选择utf8   </span>
    <span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cursor<span class="token punctuation">:</span>
            sql <span class="token operator">=</span> sql_query
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
            results <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    column_names <span class="token operator">=</span> <span class="token punctuation">[</span>desc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> desc <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>description<span class="token punctuation">]</span>

    <span class="token comment"># 使用results和column_names创建DataFrame</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>results<span class="token punctuation">,</span> columns<span class="token operator">=</span>column_names<span class="token punctuation">)</span>
        
    <span class="token keyword">return</span> df<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span>orient <span class="token operator">=</span> <span class="token string">"records"</span><span class="token punctuation">)</span>         
</code></pre> 
<h3><a id="5user_demographics_198"></a>5、user_demographics函数信息生成测试</h3> 
<p>使用工具函数生成器，对测试是否能够正常生成user_demographics相关数据查询的工具函数信息</p> 
<pre><code class="prism language-python"><span class="token comment">#定义工具函数列表（当前只有user_demographics信息获取的函数）</span>
functions_list <span class="token operator">=</span> <span class="token punctuation">[</span>get_user_demographics<span class="token punctuation">]</span>

<span class="token comment">#user_demographics相关数据查询的工具函数信息，生成测试</span>
tools <span class="token operator">=</span> auto_functions<span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span>
tools
</code></pre> 
<p>生成的函数信息如下：<br> <img src="https://images2.imgbox.com/21/23/sQRRPGZG_o.png" alt="在这里插入图片描述"></p> 
<p>注意：结构生成不一定正确，大模型缺少稳定性；可能需要多次调用测试；也可以再生成函数中，加入校验；比如：如果缺失关键key、value，就让大模型重新生成。</p> 
<h3><a id="6_214"></a>6、第一次数据查询对话测试</h3> 
<p>使用自然语言对话的方式，进行数据查询分析</p> 
<pre><code class="prism language-python">messages<span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"请问user_demographics表中个人属性为老年男性的数据总共有多少条？"</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    
response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
        tools<span class="token operator">=</span>tools<span class="token punctuation">,</span>
        tool_choice<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span>  
    <span class="token punctuation">)</span>

response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message       
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python">ChatCompletionMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">'assistant'</span><span class="token punctuation">,</span> function_call<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> tool_calls<span class="token operator">=</span><span class="token punctuation">[</span>ChatCompletionMessageToolCall<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'call_5VK3ywSsn76wNBfAEc17FaWr'</span><span class="token punctuation">,</span> function<span class="token operator">=</span>Function<span class="token punctuation">(</span>arguments<span class="token operator">=</span><span class="token string">'{"sql_query":"SELECT COUNT(*) FROM user_demographics WHERE age &gt;= 60 AND gender = \'male\'"}'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'get_user_demographics'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>可以从结果中检查大模型是否正常找到自己生成的工具函数，以及生成的相关SQL是否正确；<br> 查询SQL中使用了年龄大于60岁，来查询老年人。</p> 
<h3><a id="7_241"></a>7、读取数据字典</h3> 
<p>读取本地的数据字典</p> 
<pre><code class="prism language-python"><span class="token comment"># 打开并读取Markdown文件</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/root/autodl-tmp/iquery项目/data/数据字典/iquery数据字典.md'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    md_content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
md_content
</code></pre> 
<p>输出</p> 
<pre><code class="prism language-python"><span class="token string">'# iquery数据字典：iquery数据库数据字典\n\n本数据字典记录了iquery数据库中各张数据表的基本情况。\n\n## 1.user_demographics数据表\n\n- 基本解释\n\n  \u200b\t\tuser_demographics数据表记录了电信用户的个人基本情况，主要涵盖客户基本生物属性，包括性别、年龄状况、是否结婚以及是否经济独立等。\n\n- 数据来源\n\n  \u200b\tuser_demographics数据集由一线业务人员人工采集记录，并且通过回访确认相关信息，数据集的准确性和可信度都非常高。\n\n- 各字段说明\n\n| Column Name | Description | Value Range | Value Explanation | Type |\n|-------------|-------------|-------------|-------------------|------|\n| customerID | 客户ID，user_demographics数据表主键 |              | 由数字和字母组成的 | VARCHAR(255) |\n| gender | 用户的性别 | Female, Male | Female (女性), Male (男性) | VARCHAR(255) |\n| SeniorCitizen | 是否为老人 | 0, 1 | 0 (不是), 1 (是) | INT |\n| Partner | 用户是否有伴侣 | Yes, No | Yes (有), No (没有) | VARCHAR(255) |\n| Dependents | 用户经济是否独立，往往用于判断用户是否已经成年 | No, Yes | Yes (有), No (没有) | VARCHAR(255) |\n\n## 2.user_services数据表\n\n- 基本解释\n\n  \u200b        user_services数据表记录了每位用户订购电信服务的基本情况，截至目前，电信服务商提供了种类多样的服务，包括电话类服务和网络类服务等，本数据集表记录了每位用户订阅电信服务的基本情况。\n\n- 数据来源\n\n  \u200b\t\tuser_services数据表由后台系统自动创建生成，并未经过人工校验。\n\n- 各字段说明\n\n| Column Name | Description | Value Range | Value Explanation | Type |\n|-------------|-------------|-------------|-------------------|------|\n| customerID | 客户ID，user_services数据表主键 |  | 由数字和字母组成的 | VARCHAR(255) |\n| PhoneService | 用户是否有电话服务 | No, Yes | Yes (有), No (没有) | VARCHAR(255) |\n| MultipleLines | 用户是否开通了多条电话业务 | No phone service, No, Yes | Yes (有多条电话线业务), No (没有多条电话线业务), No phone service (没有电话服务) | VARCHAR(255) |\n| InternetService | 用户的互联网服务类型 | DSL, Fiber optic, No | DSL (DSL), Fiber optic (光纤), No (没有) | VARCHAR(255) |\n| OnlineSecurity | 是否开通网络安全服务 | No, Yes, No internet service | Yes（有）、No（无） or No internetservice（没有网路服务） | VARCHAR(255) |\n| OnlineBackup | 是否开通在线备份服务 | Yes, No, No internet service | Yes（有）、No（无） or No internetservice（没有网路服务） | VARCHAR(255) |\n| DeviceProtection | 是否开通设备保护服务 | No, Yes, No internet service | Yes（有）、No（无） or No internetservice（没有网路服务） | VARCHAR(255) |\n| TechSupport | 是否开通技术支持业务 | No, Yes, No internet service | Yes（有）、No（无） or No internetservice（没有网路服务） | VARCHAR(255) |\n| StreamingTV | 是否开通网络电视 | No, Yes, No internet service | Yes（有）、No（无） or No internetservice（没有网路服务） | VARCHAR(255) |\n| StreamingMovies | 是否开通网络电影 | No, Yes, No internet service | Yes（有）、No（无） or No internetservice（没有网路服务） | VARCHAR(255) |\n\n## 3.user_payments数据表\n\n- 基本解释\n\n  \u200b\t\tuser_payments数据表记录了每一位用户支付状况，既包括用户的支付方式和合同类型，同时也包含用户具体支付金额，包括月付金额和总金额等。\n\n- 数据来源\n\n  \u200b\t\tuser_payments数据表由后台自动记录生成，并未经过校验。\n\n- 各字段说明\n\n| Column Name | Description | Value Range | Value Explanation | Type |\n|-------------|-------------|-------------|-------------------|------|\n| customerID | 客户ID，user_payments数据表主键 |  | 由数字和字母组成的 | VARCHAR(255) |\n| Contract | 合同类型 | Month-to-month, One year, Two year | Month-to-month (月付), One year (一年付), Two year (两年付) | VARCHAR(255) |\n| PaperlessBilling | 是否无纸化账单 | Yes, No | Yes (是), No (否) | VARCHAR(255) |\n| PaymentMethod | 支付方式 | Electronic check, Mailed check, Bank transfer (automatic), Credit card (automatic) | Electronic check (电子检查), Mailed check (邮寄支票), Bank transfer (automatic) (银行转账), Credit card (automatic) (信用卡) | VARCHAR(255) |\n| MonthlyCharges | 月费用 |  | 用户平均每月支付费用 | FLOAT        |\n| TotalCharges | 总费用 |  | 截至目前用户总消费金额 | VARCHAR(255) |\n\n## 4.user_churn\n\n- 基本解释\n\n  \u200b\t\tuser_churn数据表记录了当前用户流失情况。\n\n- 数据来源\n\n  \u200b\t\tuser_churn数据表由后台自动创建并记录，当合同截至后但用户未续费，则判断该用户目前处于流失状态。\n\n- 各字段说明\n\n| Column Name | Description | Value Range | Value Explanation | Type |\n|-------------|-------------|-------------|-------------------|------|\n| customerID | 客户ID，user_churn数据表主键 |             | 由数字和字母组成的 | VARCHAR(255) |\n| Churn | 用户是否流失 | No, Yes | Yes (是), No (否) | VARCHAR(255) |\n\n'</span>
</code></pre> 
<h3><a id="8_258"></a>8、第二次数据查询对话测试</h3> 
<p>将数据字典作为背景知识，再次使用自然语言对话的方式，进行数据查询分析</p> 
<pre><code class="prism language-python">messages<span class="token operator">=</span><span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> md_content<span class="token punctuation">}</span><span class="token punctuation">,</span> 
      <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"请问user_demographics表中个人属性为老年男性的数据总共有多少条？"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
        tools<span class="token operator">=</span>tools<span class="token punctuation">,</span>
        tool_choice<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span>  
    <span class="token punctuation">)</span>

response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python">ChatCompletionMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">'assistant'</span><span class="token punctuation">,</span> function_call<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> tool_calls<span class="token operator">=</span><span class="token punctuation">[</span>ChatCompletionMessageToolCall<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'call_e4LEDDcytWdGUx0m98plDpUa'</span><span class="token punctuation">,</span> function<span class="token operator">=</span>Function<span class="token punctuation">(</span>arguments<span class="token operator">=</span><span class="token string">'{"sql_query":"SELECT * FROM user_demographics WHERE SeniorCitizen = 1 AND gender = \'Male\'"}'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'get_user_demographics'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>通过输出结果可以看到，这一次数据查询中使用了SeniorCitizen 字段，因为背景知识中，这个字段是用来标识老人的，不需要通过年龄判断。<br> <img src="https://images2.imgbox.com/1e/6c/bcRJJ6DG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="9_285"></a>9、数据库基本信息查询测试</h3> 
<p>调用大模型API查询数据库的基本情况信息</p> 
<pre><code class="prism language-python">messages<span class="token operator">=</span><span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> md_content<span class="token punctuation">}</span><span class="token punctuation">,</span> 
      <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"请帮我介绍下iquery这个数据库的基本情况"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python"><span class="token string">'iquery数据库是一个用于电信用户数据分析的数据库，主要包括了四张数据表：user_demographics、user_services、user_payments和user_churn。这些数据表记录了电信用户的个人基本情况、订购的电信服务情况、支付情况以及流失情况。用户可以通过iquery数据库中的数据来进行用户行为分析、用户流失预测、产品定价优化等工作。每张数据表都有各自的字段说明，方便用户了解和利用数据库中的数据。'</span>
</code></pre> 
<h3><a id="10_307"></a>10、数据分析调用测试</h3> 
<p>让大模型帮忙分析user_demographics数据表和user_services数据表的数据可信度。</p> 
<pre><code class="prism language-python">messages<span class="token operator">=</span><span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> md_content<span class="token punctuation">}</span><span class="token punctuation">,</span> 
      <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"user_demographics数据表和user_services数据表哪张表的数据可信度更高呢？"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python">根据描述，user_demographics数据表由一线业务人员人工采集记录，并通过回访确认相关信息，数据集的准确性和可信度都非常高。而user_services数据表由后台系统自动生成，并未经过人工校验。因此，user_demographics数据表的数据可信度更高。
</code></pre> 
<h2><a id="_329"></a>三、实现交互确认</h2> 
<p>在数据查询分析前，让大模型输出将要执行的SQL，让用户确认检查；同时咨询是否需要执行</p> 
<h3><a id="1_331"></a>1、定义数据库基本信息获取函数</h3> 
<p>定义一个获取数据库基本信息的工具函数</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">sql_inter</span><span class="token punctuation">(</span>sql_query<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    用于获取iquery数据库中各张表的有关相关信息，\
    核心功能是将输入的SQL代码传输至iquery数据库所在的MySQL环境中进行运行，\
    并最终返回SQL代码运行结果。需要注意的是，本函数是借助pymysql来连接MySQL数据库。
    :param sql_query: 字符串形式的SQL查询语句，用于执行对MySQL中iquery数据库中各张表进行查询，并获得各表中的各类相关信息
    :return：sql_query在MySQL中的运行结果。
    """</span>
    
    mysql_pw <span class="token operator">=</span> <span class="token string">"iquery_agent"</span>
    
    connection <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
            host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库地址</span>
            user<span class="token operator">=</span><span class="token string">'iquery_agent'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库用户名</span>
            passwd<span class="token operator">=</span>mysql_pw<span class="token punctuation">,</span>  <span class="token comment"># 数据库密码</span>
            db<span class="token operator">=</span><span class="token string">'iquery'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库名</span>
            charset<span class="token operator">=</span><span class="token string">'utf8'</span>  <span class="token comment"># 字符集选择utf8</span>
        <span class="token punctuation">)</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cursor<span class="token punctuation">:</span>
            <span class="token comment"># SQL查询语句</span>
            sql <span class="token operator">=</span> sql_query
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>

            <span class="token comment"># 获取查询结果</span>
            results <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    
    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2_369"></a>2、函数信息生成测试检查：</h3> 
<pre><code class="prism language-python"><span class="token comment">#定义工具函数列表</span>
functions_list <span class="token operator">=</span> <span class="token punctuation">[</span>sql_inter<span class="token punctuation">]</span>

<span class="token comment">#工具函数信息生成</span>
tools <span class="token operator">=</span> auto_functions<span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span>
tools
</code></pre> 
<p>输出：<br> <img src="https://images2.imgbox.com/ea/28/HFcbxJxP_o.png" alt="在这里插入图片描述"></p> 
<p>检查生成的函数信息结构是否正确，是否有缺失的key、value</p> 
<h3><a id="3_385"></a>3、数据分析测试</h3> 
<pre><code class="prism language-python">messages <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> md_content<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"请问user_demographics数据表的主键和user_services数据表的主键是否完全一致？"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
run_conversation<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> functions_list<span class="token operator">=</span>functions_list<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：<br> <img src="https://images2.imgbox.com/c3/f6/QU3E0j9g_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4SQL_399"></a>4、定义SQL提取函数</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">extract_sql</span><span class="token punctuation">(</span>json_str<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 提取并返回'sql_query'的值</span>
    <span class="token keyword">return</span> json_str<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'sql_query'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="5API_407"></a>5、两次次大模型API两次调用封装改造</h3> 
<p>改造二次大模型API两次调用的封装函数，引入用户确认的逻辑</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">check_code_run</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> functions_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span>auto_run <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    能够自动执行外部函数调用的对话模型
    :param messages: 必要参数，字典类型，输入到Chat模型的messages参数对象
    :param functions_list: 可选参数，默认为None，可以设置为包含全部外部函数的列表对象
    :param model: Chat模型，可选参数，默认模型为gpt-3.5-turbo
    :return：Chat模型输出结果
    """</span>
    <span class="token comment"># 如果没有外部函数库，则执行普通的对话任务</span>
    <span class="token keyword">if</span> functions_list <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                        model<span class="token operator">=</span>model<span class="token punctuation">,</span>
                        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
                        <span class="token punctuation">)</span>
        response_message <span class="token operator">=</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message
        final_response <span class="token operator">=</span> response_message<span class="token punctuation">.</span>content
        
    <span class="token comment"># 若存在外部函数库，则需要灵活选取外部函数并进行回答</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 创建functions对象</span>
        tools <span class="token operator">=</span> auto_functions<span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span>
        

        <span class="token comment"># 创建外部函数库字典</span>
        available_functions <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">:</span> func <span class="token keyword">for</span> func <span class="token keyword">in</span> functions_list<span class="token punctuation">}</span>

        <span class="token comment"># 第一次调用大模型</span>
        response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                        model<span class="token operator">=</span>model<span class="token punctuation">,</span>
                        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
                        tools<span class="token operator">=</span>tools<span class="token punctuation">,</span>
                        tool_choice<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>
        response_message <span class="token operator">=</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message
        tool_calls <span class="token operator">=</span> response_message<span class="token punctuation">.</span>tool_calls
        <span class="token keyword">if</span> tool_calls<span class="token punctuation">:</span>
            messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>response_message<span class="token punctuation">)</span> 
            <span class="token keyword">for</span> tool_call <span class="token keyword">in</span> tool_calls<span class="token punctuation">:</span>
                function_name <span class="token operator">=</span> tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>name
                function_to_call <span class="token operator">=</span> available_functions<span class="token punctuation">[</span>function_name<span class="token punctuation">]</span>
                function_args <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span>
              
              
                <span class="token keyword">if</span> auto_run <span class="token operator">==</span> <span class="token boolean">False</span><span class="token punctuation">:</span>
                    sql_query <span class="token operator">=</span> extract_sql<span class="token punctuation">(</span>function_args<span class="token punctuation">)</span>

                    res <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'即将执行以下代码：%s。是否确认并继续执行（1），或者退出本次运行过程（2）'</span> <span class="token operator">%</span> sql_query<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"终止运行"</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">None</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在执行代码，请稍后..."</span><span class="token punctuation">)</span>
                        
                function_response <span class="token operator">=</span> function_to_call<span class="token punctuation">(</span><span class="token operator">**</span>function_args<span class="token punctuation">)</span>
                messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token string">"tool_call_id"</span><span class="token punctuation">:</span> tool_call<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                        <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"tool"</span><span class="token punctuation">,</span>
                        <span class="token string">"name"</span><span class="token punctuation">:</span> function_name<span class="token punctuation">,</span>
                        <span class="token string">"content"</span><span class="token punctuation">:</span> function_response<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span> 
            <span class="token comment">## 第二次调用模型</span>
            second_response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                model<span class="token operator">=</span>model<span class="token punctuation">,</span>
                messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
            <span class="token punctuation">)</span> 
            <span class="token comment"># 获取最终结果</span>
            final_response <span class="token operator">=</span> second_response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            final_response <span class="token operator">=</span> response_message<span class="token punctuation">.</span>content
    <span class="token keyword">del</span> messages
                
    <span class="token keyword">return</span> final_response
</code></pre> 
<h3><a id="6_486"></a>6、定义消息列表</h3> 
<pre><code class="prism language-python">messages <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> md_content<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"请问iquery数据库下user_demographics表的第10条数据内容是？"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
<span class="token comment">#函数列表查看</span>
functions_list
</code></pre> 
<p><img src="https://images2.imgbox.com/b3/ae/yxZxL4r9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="71_499"></a>7、数据查询分析测试1</h3> 
<pre><code class="prism language-python">check_code_run<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> 
               functions_list<span class="token operator">=</span>functions_list<span class="token punctuation">,</span> 
               model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span> 
               auto_run <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：<br> <img src="https://images2.imgbox.com/09/2b/zAlWbaR9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="82_510"></a>8、数据查询分析测试2</h3> 
<pre><code class="prism language-python">messages <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> md_content<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"请问iquery数据库下user_demographics表有多少条数据？"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
check_code_run<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> 
               functions_list<span class="token operator">=</span>functions_list<span class="token punctuation">,</span> 
               model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span> 
               auto_run <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：<br> <img src="https://images2.imgbox.com/6f/a2/g6kqjIOP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="93_526"></a>9、数据查询分析测试3</h3> 
<pre><code class="prism language-python">messages <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> md_content<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"请问iquery数据库下user_demographics表中，男性和女性的分别有多少人"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>
check_code_run<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> 
               functions_list<span class="token operator">=</span>functions_list<span class="token punctuation">,</span> 
               model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span> 
               auto_run <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：<br> <img src="https://images2.imgbox.com/1c/bf/R50HfkD2_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_542"></a>四、实现完整的多轮对话效果</h2> 
<p>经过上述步骤的不断优化和测试，我们最终实现了一个完整的多轮对话控制系统。该系统不仅能够理解用户的查询意图，还能够在需要时向用户确认信息，从而使得整个数据分析过程更加透明、可控。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tiktoken

<span class="token keyword">def</span> <span class="token function">chat_with_inter</span><span class="token punctuation">(</span>functions_list<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> 
                    prompt<span class="token operator">=</span><span class="token string">"你好呀"</span><span class="token punctuation">,</span> 
                    model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span> 
                    system_message<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"你是一个智能助手。"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                    auto_run <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token comment"># 创建函数列表对应的参数解释列表</span>
    functions <span class="token operator">=</span> auto_functions<span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span>
    
    <span class="token comment"># 多轮对话阈值</span>
    <span class="token keyword">if</span> <span class="token string">'gpt-4'</span> <span class="token keyword">in</span> model<span class="token punctuation">:</span>
        tokens_thr <span class="token operator">=</span> <span class="token number">6000</span>
    <span class="token keyword">elif</span> <span class="token string">'16k'</span> <span class="token keyword">in</span> model<span class="token punctuation">:</span>
        tokens_thr <span class="token operator">=</span> <span class="token number">14000</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        tokens_thr <span class="token operator">=</span> <span class="token number">3000</span>
    
    messages <span class="token operator">=</span> system_message
    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">## 计算token大小</span>
    embedding_model <span class="token operator">=</span> <span class="token string">"text-embedding-ada-002"</span>
    <span class="token comment"># 模型对应的分词器（TOKENIZER）</span>
    embedding_encoding <span class="token operator">=</span> <span class="token string">"cl100k_base"</span>
    encoding <span class="token operator">=</span> tiktoken<span class="token punctuation">.</span>get_encoding<span class="token punctuation">(</span>embedding_encoding<span class="token punctuation">)</span>
    tokens_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">(</span>prompt <span class="token operator">+</span> system_message<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>           
        answer <span class="token operator">=</span> check_code_run<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> 
                                functions_list<span class="token operator">=</span>functions_list<span class="token punctuation">,</span> 
                                model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                auto_run <span class="token operator">=</span> auto_run<span class="token punctuation">)</span>
        
        
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"模型回答: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>answer<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># 询问用户是否还有其他问题</span>
        user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"您还有其他问题吗？(输入退出以结束对话): "</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> user_input <span class="token operator">==</span> <span class="token string">"退出"</span><span class="token punctuation">:</span>
            <span class="token keyword">del</span> messages
            <span class="token keyword">break</span>

        <span class="token comment"># 记录新一轮问答</span>
        messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> answer<span class="token punctuation">}</span><span class="token punctuation">)</span>
        messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> user_input<span class="token punctuation">}</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 计算当前总token数</span>
        tokens_count <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">(</span>answer <span class="token operator">+</span> user_input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 删除超出token阈值的对话内容</span>
        <span class="token keyword">while</span> tokens_count <span class="token operator">&gt;=</span> tokens_thr<span class="token punctuation">:</span>
            tokens_count <span class="token operator">-=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>messages<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
chat_with_inter<span class="token punctuation">(</span>functions_list<span class="token operator">=</span>functions_list<span class="token punctuation">,</span> 
                prompt<span class="token operator">=</span><span class="token string">"我想根据iquery数据库中数据分析用户流失情况，请问需要用到iquery数据库中的哪几张表呢？"</span><span class="token punctuation">,</span> 
                model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span> 
                system_message<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> md_content<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                auto_run <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>对话效果<br> <img src="https://images2.imgbox.com/b8/14/C6PrO92I_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_610"></a>五、结语</h2> 
<p>在本篇章中，我们进一步强化了Agent智能数据分析平台的功能，通过实现可控的多轮对话交互确认逻辑，极大地提升了用户体验和系统的安全性。这一进步将为未来更加复杂、更加智能化的数据分析平台的构建奠定坚实的基础。</p> 
<p><img src="https://images2.imgbox.com/f9/5d/OpsvMlKr_o.png" alt="在这里插入图片描述"></p> 
<p>🎯🔖更多专栏系列文章：<a href="https://blog.csdn.net/xiaobing259/category_12628007.html?spm=1001.2014.3001.5482"><strong>AIGC-AI大模型探索之路</strong></a></p> 
<blockquote> 
 <p>😎 <strong>作者介绍</strong>：我是寻道AI小兵，资深程序老猿，从业10年+、互联网系统架构师，目前专注于AIGC的探索。<br> 📖 <strong>技术交流</strong>：建立有技术交流群，可以扫码👇 加入社群，500本各类编程书籍、AI教程、AI工具等你领取！<br> <strong>如果文章内容对您有所触动，别忘了<font color="red"><strong>点赞、⭐关注，收藏</strong></font>！加入我，让我们携手同行AI的探索之旅，一起开启智能时代的大门！</strong></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1028fec28fc399d4d9418054775f3b11/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">随心笔记，第四更</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/efb4eea5aa66c7672abe107e6ba3f44b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【机器学习】基于YOLOv10实现你的第一个视觉AI大模型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>