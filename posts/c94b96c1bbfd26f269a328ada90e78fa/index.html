<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android Perfetto Trace性能分析 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/c94b96c1bbfd26f269a328ada90e78fa/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android Perfetto Trace性能分析">
  <meta property="og:description" content="版权声明：转载必须注明本文转自严振杰的博客：http://blog.yanzhenjie.com
本人用 Perfetto 快 2 年了，公司一些同事和网友都来咨询过使用姿势，本人只能把自己一个略显粗糙点的笔记发给同事，有点不够细节和不够深度，于是趁着清明假期，我把经验总结成一篇博客，结合 Perfetto 官网资料取长补短尽量做到深入浅出。
Perfetto 支持多个平台，包括 Linux、Android 和 Chrome，并提供了用于记录系统级和应用级活动的服务和库、低开销的针对 Native 和 Java 的内存分析工具、可供 SQL 分析跟踪文件的 C&#43;&#43;库和 Python 库（Python 基于 C&#43;&#43;库），以及基于 Web 可视化方便分析 Trace 文件的 Perfetto UI。
快速开始，Android 抓 Trace： https://perfetto.dev/docs/quickstart/android-tracing 可视化工具，Perfetto UI： 地址：https://ui.perfetto.dev/教程：https://perfetto.dev/docs/visualization/perfetto-ui 开源： 地址：https://github.com/google/perfetto贡献：https://perfetto.dev/docs/contributing/getting-started 聪明的同学从上面的信息中可以了解到很多信息了，下面咱们就展开细节聊一聊。
1、生成 Perfetto 抓 Trace 的配置 做 App 性能分析，一般关注这几类信息：
Memory。CPU。GPU。Power。系统层消耗。 我们在抓 Trace 的时候可以指定应用、内存、CPU、GPU、电源和系统事件等，使用 Perfetto 时可以使用 PerfettoUI 来生成配置：https://ui.perfetto.dev/#!/record。
第一步，选择目标 Android 设备系统版本。打开 Perfetto UI，选择要抓 Trace 的目标设备，有 2 种方式，如图一所示：
方式一，选择目标系统版本。方式二，选择 ADB 连接的设备。 （图一） 第二步，调整 Trace 文件记录设置。主要是为了控制 Trace 文件大小或者 Trace 记录时长，如果文件太大则加载缓慢操作也不太顺畅，如图二所示：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-11T17:59:58+08:00">
    <meta property="article:modified_time" content="2024-04-11T17:59:58+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android Perfetto Trace性能分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>版权声明：转载必须注明本文转自严振杰的博客：<a href="http://blog.yanzhenjie.com" rel="nofollow">http://blog.yanzhenjie.com</a></p> 
</blockquote> 
<p>本人用 Perfetto 快 2 年了，公司一些同事和网友都来咨询过使用姿势，本人只能把自己一个略显粗糙点的笔记发给同事，有点不够细节和不够深度，于是趁着清明假期，我把经验总结成一篇博客，结合 Perfetto 官网资料取长补短尽量做到深入浅出。</p> 
<p>Perfetto 支持多个平台，包括 Linux、Android 和 Chrome，并提供了用于记录系统级和应用级活动的服务和库、低开销的针对 Native 和 Java 的内存分析工具、可供 SQL 分析跟踪文件的 C++库和 Python 库（Python 基于 C++库），以及基于 Web 可视化方便分析 Trace 文件的 Perfetto UI。</p> 
<ul><li>快速开始，Android 抓 Trace： 
  <ul><li><a href="https://perfetto.dev/docs/quickstart/android-tracing" rel="nofollow">https://perfetto.dev/docs/quickstart/android-tracing</a></li></ul> </li><li>可视化工具，Perfetto UI： 
  <ul><li>地址：<a href="https://ui.perfetto.dev/" rel="nofollow">https://ui.perfetto.dev/</a></li><li>教程：<a href="https://perfetto.dev/docs/visualization/perfetto-ui" rel="nofollow">https://perfetto.dev/docs/visualization/perfetto-ui</a></li></ul> </li><li>开源： 
  <ul><li>地址：<a href="https://github.com/google/perfetto">https://github.com/google/perfetto</a></li><li>贡献：<a href="https://perfetto.dev/docs/contributing/getting-started" rel="nofollow">https://perfetto.dev/docs/contributing/getting-started</a></li></ul> </li></ul> 
<p>聪明的同学从上面的信息中可以了解到很多信息了，下面咱们就展开细节聊一聊。</p> 
<h3><a id="1_Perfetto__Trace__18"></a>1、生成 Perfetto 抓 Trace 的配置</h3> 
<p>做 App 性能分析，一般关注这几类信息：</p> 
<ol><li>Memory。</li><li>CPU。</li><li>GPU。</li><li>Power。</li><li>系统层消耗。</li></ol> 
<p>我们在抓 Trace 的时候可以指定应用、内存、CPU、GPU、电源和系统事件等，使用 Perfetto 时可以使用 PerfettoUI 来生成配置：<a href="https://ui.perfetto.dev/#!/record" rel="nofollow">https://ui.perfetto.dev/#!/record</a>。</p> 
<p><strong>第一步</strong>，选择目标 Android 设备系统版本。打开 Perfetto UI，选择要抓 Trace 的目标设备，有 2 种方式，如图一所示：</p> 
<ul><li>方式一，选择目标系统版本。</li><li>方式二，选择 ADB 连接的设备。</li></ul> 
<center> 
 <img width="600" src="https://images2.imgbox.com/89/58/LKshbcWp_o.png"> 
 <br>（图一） 
</center> 
<p><strong>第二步</strong>，调整 Trace 文件记录设置。主要是为了控制 Trace 文件大小或者 Trace 记录时长，如果文件太大则加载缓慢操作也不太顺畅，如图二所示：</p> 
<center> 
 <img width="600" src="https://images2.imgbox.com/7b/39/taLC78gQ_o.gif"> 
 <br>（图二） 
</center> 
<p><strong>第三步</strong>，配置要分析的探针信息。</p> 
<p>收集 CPU 相关信息，需要点击在 Probes 下的 CPU，然后根据需要打开对应开关并做配置，如图三所示：</p> 
<center> 
 <img width="600" src="https://images2.imgbox.com/7f/f1/CkySlqsE_o.png"> 
 <br>（图三） 
</center> 
<p>收集 GPU 相关信息，需要点击在 Probes 下的 GPU，然后根据需要打开对应开关，如图四所示：</p> 
<center> 
 <img width="600" src="https://images2.imgbox.com/75/d2/h6yXXDM9_o.png"> 
 <br>（图四） 
</center> 
<p>收集电源信息和内存信息同上，不再赘述。</p> 
<p>这里需要<font color="red"><b>强调收集 atrace 的配置</b></font>，选中 Probes 下的 Android apps &amp; avcs，如图五所示：</p> 
<center> 
 <img width="600" src="https://images2.imgbox.com/7d/89/2hdJnu84_o.gif"> 
 <br>（图五） 
</center> 
<p>按照以下操作步骤和注意项：</p> 
<ol><li>打开 atrace 开关。</li><li>默认是抓取所有 app trace，可以关闭<code>Record events from Android apps and services</code>，在下面添加目标 App 包名。</li><li>在 Categories 下选择你关注的 trace 类型。</li></ol> 
<p><strong>第四步</strong>，选择【Recording command】保存配置，一共有 3 种方式。</p> 
<p>方式一，保存在本地，打开【Recording command】的页面后，点击按钮复制配置内容，如图六所示：</p> 
<center> 
 <img width="600" src="https://images2.imgbox.com/f9/b7/NJGxkpNr_o.png"> 
 <br>（图六） 
</center> 
<p>方式二，在 Perfetto UI 持久化保存，如图七所示：</p> 
<center> 
 <img width="600" src="https://images2.imgbox.com/eb/52/qqPt0BZb_o.png"> 
 <br>（图七） 
</center> 
<p>方式三，生成远端链接分享给别人下载，如图八所示：</p> 
<center> 
 <img width="600" src="https://images2.imgbox.com/b7/db/a1I4EIF1_o.png"> 
 <br>（图八） 
</center> 
<p>我们可以多尝试下配置会更加熟悉和了解细节，保存后可以根据文档手动增删改一些配置（见下文），比如我们主要关注 CPU 信息时，做好对应设置生成的配置如下：</p> 
<pre><code class="prism language-yml"><span class="token key atrule">buffers</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token key atrule">size_kb</span><span class="token punctuation">:</span> <span class="token number">63488</span>
    <span class="token key atrule">fill_policy</span><span class="token punctuation">:</span> DISCARD
<span class="token punctuation">}</span>
<span class="token key atrule">buffers</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token key atrule">size_kb</span><span class="token punctuation">:</span> <span class="token number">2048</span>
    <span class="token key atrule">fill_policy</span><span class="token punctuation">:</span> DISCARD
<span class="token punctuation">}</span>
<span class="token key atrule">data_sources</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    config <span class="token punctuation">{<!-- --></span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"android.packages_list"</span>
        <span class="token key atrule">target_buffer</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token key atrule">data_sources</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    config <span class="token punctuation">{<!-- --></span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"android.gpu.memory"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token key atrule">data_sources</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    config <span class="token punctuation">{<!-- --></span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"linux.process_stats"</span>
        <span class="token key atrule">target_buffer</span><span class="token punctuation">:</span> <span class="token number">1</span>
        process_stats_config <span class="token punctuation">{<!-- --></span>
            <span class="token key atrule">scan_all_processes_on_start</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token key atrule">data_sources</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    config <span class="token punctuation">{<!-- --></span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"linux.sys_stats"</span>
        sys_stats_config <span class="token punctuation">{<!-- --></span>
            <span class="token key atrule">stat_period_ms</span><span class="token punctuation">:</span> <span class="token number">1000</span>
            <span class="token key atrule">stat_counters</span><span class="token punctuation">:</span> STAT_CPU_TIMES
            <span class="token key atrule">stat_counters</span><span class="token punctuation">:</span> STAT_FORK_COUNT
            <span class="token comment">#cpufreq_period_ms: 1000</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token key atrule">data_sources</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    config <span class="token punctuation">{<!-- --></span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"linux.ftrace"</span>
        ftrace_config <span class="token punctuation">{<!-- --></span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"sched/sched_switch"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"power/suspend_resume"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"sched/sched_wakeup"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"sched/sched_wakeup_new"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"sched/sched_waking"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"power/cpu_frequency"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"power/cpu_idle"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"power/gpu_frequency"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"gpu_mem/gpu_mem_total"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"power/gpu_work_period"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"raw_syscalls/sys_enter"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"raw_syscalls/sys_exit"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"sched/sched_process_exit"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"sched/sched_process_free"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"task/task_newtask"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"task/task_rename"</span>
            <span class="token key atrule">ftrace_events</span><span class="token punctuation">:</span> <span class="token string">"ftrace/print"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"am"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"aidl"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"dalvik"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"binder_lock"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"camera"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"database"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"gfx"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"network"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"sm"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"ss"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"view"</span>
            <span class="token key atrule">atrace_categories</span><span class="token punctuation">:</span> <span class="token string">"webview"</span>
            <span class="token key atrule">atrace_apps</span><span class="token punctuation">:</span> <span class="token string">"com.taobao.android"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token key atrule">duration_ms</span><span class="token punctuation">:</span> <span class="token number">40000</span>
</code></pre> 
<blockquote> 
 <p>实际运行时，因为手机系统版本不一致原因，可能遇到以下错误：</p> 
 <pre><code class="prism language-shell">-:36:13 error: No field named <span class="token string">"cpufreq_period_ms"</span> <span class="token keyword">in</span> proto SysStatsConfig
            cpufreq_period_ms: <span class="token number">1000</span>
</code></pre> 
 <p>如上面给出的配置示例，注释对应配置行后再尝试。</p> 
</blockquote> 
<p>在实际操作中，会根据不同的场景和需求对抓 Trace 的配置文件做修改，如何修改可以参考官网文档（<a href="https://perfetto.dev/docs/" rel="nofollow">https://perfetto.dev/docs/</a>）数据源配置，文档位置如图九所示：</p> 
<center> 
 <img width="600" src="https://images2.imgbox.com/af/b9/NJJD45Nj_o.png"> 
 <br>（图九） 
</center> 
<p>生成后好放在电脑的本地（比如桌面），可以把它命名为 perfetto.pbtx。</p> 
<h3><a id="2_Perfetto_Trace_174"></a>2、按照配置抓 Perfetto Trace</h3> 
<p>让手机抓 Perfetto Trace 有 3 种方式：</p> 
<ol><li>使用手机的 Traceur app 抓取，很多国产手机没有，本文不做介绍。</li><li>使用 adb 命令抓取。</li><li>使用 Perfetto UI 抓取。</li><li>使用 Python 脚本抓取（<font color="red"><strong>推荐</strong></font>）。</li></ol> 
<p>值得注意的是 Perfetto 从 Android 9（P）开始集成，从 Android 11（R）开始默认开启。在 Android 9（P）和 Android 10（Q）上需要先确保开启 Trace 服务：</p> 
<pre><code class="prism language-shell">adb shell setprop persist.traced.enable <span class="token number">1</span>
</code></pre> 
<blockquote> 
 <p>如果你要在 Android 9（P）之前的设备上使用 Perfetto，请参考官网文档：<br> <a href="https://perfetto.dev/docs/quickstart/android-tracing#recording-a-trace-through-the-cmdline" rel="nofollow">https://perfetto.dev/docs/quickstart/android-tracing#recording-a-trace-through-the-cmdline</a></p> 
</blockquote> 
<p>如果执行了抓取后，没有抓到对应 App 的 Trace，启用<code>systrace VERBOSE</code>再试试：</p> 
<pre><code class="prism language-shell">adb shell setprop log.tag.enableSystrace VERBOSE
</code></pre> 
<h4><a id="21_adb__198"></a>2.1、使用 adb 命令抓取</h4> 
<ol><li>通过 adb 把配置推送到手机： 
  <ul><li><code>adb push ~/Desktop/perfetto.pbtx /data/local/tmp/perfetto.pbtx</code></li></ul> </li><li>使用 adb 让手机以指定配置抓 Perfetto Trace： 
  <ul><li><code>adb shell 'cat /data/local/tmp/perfetto.pbtx | perfetto --txt -c - -o /data/misc/perfetto-traces/trace'</code></li></ul> </li><li>结束抓取： 
  <ul><li><code>adb shell 'perfetto --attach=perf_debug --stop'</code></li></ul> </li></ol> 
<p>抓取完成后，使用 adb 命令导出 Trace 文件到电脑，进行分析即可。该方式操作步骤多略显繁琐，根据实际情况作为备用方式。</p> 
<h4><a id="22_Perfetto_UI__209"></a>2.2、使用 Perfetto UI 抓取</h4> 
<p>使用 Perfetto UI 抓取 Trace 时，选择目标 Android 设备系统版本时，需要<font color="red"><strong>选择 ADB 连接的设备</strong></font>，在 Perfetto UI 上配置完成后，不用保存到本地，直接点击【Start Recording】开始录制，如图十所示：</p> 
<center> 
 <img width="600" src="https://images2.imgbox.com/54/81/VahElb7q_o.png"> 
 <br>（图十） 
</center> 
<p>在 Perfetto UI 抓取 Trace 时不能手动结束，需要等在【Recording Setting】中设置的【Max Duration】倒计时结束，当我们点击了录制后会看到如下提示：</p> 
<pre><code class="prism language-text">Recording in progress for 40000 ms...
</code></pre> 
<p>录制结束后，Perfetto UI 会直接在 Web 界面打开 Trace 文件，我们可以直接进行分析。该方式比较方便，配置可以在 Perfetto UI 持久化保存，美中不足的是 Perfetto UI 抓到的 Trace 文件不能下载发给别人。</p> 
<h4><a id="23_python__223"></a>2.3、使用 python 脚本抓取</h4> 
<p>使用 python 脚本抓取到 Trace 后，会把 Trace 文件保存到本地，也会自动在浏览器通过 Perfetto UI 直接打开 Trace 文件，我们直接进行分析。</p> 
<p>使用 python 脚本抓取时需要满足以下几个条件：</p> 
<ol><li>Android 设备通过 adb 连接到电脑。</li><li>把 python 脚本保存在本地，在本地运行 python 脚本。</li><li>把抓 Trace 的配置保存在本地，运行 python 脚本时需要指定配置文件。</li></ol> 
<p>python 脚本在 GitHub 上的开源地址，可以通过浏览器看源码：<br> <a href="https://github.com/google/perfetto/blob/main/tools/record_android_trace">https://github.com/google/perfetto/blob/main/tools/record_android_trace</a><br> raw.githubusercontent.com 下载链接：<br> <a href="https://raw.githubusercontent.com/google/perfetto/master/tools/record_android_trace" rel="nofollow">https://raw.githubusercontent.com/google/perfetto/master/tools/record_android_trace</a></p> 
<p>现在我们把 python 脚本和抓 Trace 的配置放在桌面，命名和目录结构如下：</p> 
<pre><code class="prism language-text">~/Desktop$
├── perfetto.py
├── perfetto.pbtx
</code></pre> 
<p>此时我们手机与电脑通过 adb 连接，然后运行以下命令抓取 Trace：</p> 
<pre><code class="prism language-bash">python3 perfetto.py <span class="token parameter variable">-c</span> perfetto.pbtx <span class="token parameter variable">-o</span> trace_file.perfetto-trace
</code></pre> 
<blockquote> 
 <p>上述命令中，<code>-c</code>是指定配置文件位置，<code>-o</code>是指定 trace 文件保存位置。</p> 
</blockquote> 
<p>运行命令后，我们开始操作 App，然后觉得抓取到目标 Trace 了，按下<code>ctrl + c</code>结束即可，此时 Trace 文件会被放在<code>-o</code>指定的位置，且 Perfetto UI 会被自动打开，我们直接进行分析即可。</p> 
<blockquote> 
 <p>而且我们不用担心抓的 Trace 太大网站内存绷不住，因为 python 脚本会自动下载当前系统的 trace_processor 来解析，细节可以从官网了解。<br> https://perfetto.dev/docs/visualization/large-traces</p> 
</blockquote> 
<h3><a id="3Trace__259"></a>3、Trace 分析</h3> 
<p>先大概了解下 Trace 的基本概念，一个 Trace 段在 Perfetto UI 中用 Slice 表示，它并不代表一个方法，而是一个 Trace 的开始到结束，需要在代码中标记。</p> 
<pre><code class="prism language-java"><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">beginSection</span><span class="token punctuation">(</span><span class="token string">"Choreographer#doFrame"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">endSection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>如上述代码所示，一个 Trace 段必须是一个<code>Trace#beginSection(String)</code>对应一个<code>Trace#endSection()</code>。</p> 
<h4><a id="31_271"></a>3.1、使用图形界面分析</h4> 
<p>正式操作之前先掌握一些基本操作技巧。</p> 
<p>基本操作 1，打开 Trace 文件后，可以整体上观察哪些线程有问题，比如<code>耗时久</code>、<code>Uninterruptiable Sleep (non-IO)</code>等，定位到有问题的线程或者 Trace 段后，我们就可以对线程和 Trace 段进行更详细的分析了，如图十一所示：</p> 
<center> 
 <img width="650" src="https://images2.imgbox.com/c3/0e/RNHRuYtB_o.gif"> 
 <br>（图十一） 
</center> 
<p>基本操作 2，在对线程和 Trace 段进行详细分析之前，对要分析的进程和线程做下钉操作（如图十二所示）：</p> 
<ol><li>在列表中点击要分析的 App 进程，点击后该进程会展开子列表，展示所有线程。</li><li>找到<code>RenderThread</code>（渲染线程）并点击名称右侧的钉图标，把该线程钉在列表顶部。</li></ol> 
<center> 
 <img width="650" src="https://images2.imgbox.com/c5/10/kzMfQdty_o.png"> 
 <br>（图十二） 
</center> 
<p>这样做的目的是方便观察<strong>主线程</strong>和<strong>渲染线程</strong>发生了什么，找到性能瓶颈所在。</p> 
<p>下面我们一起看 3 个例子。</p> 
<h5><a id="311Uninterruptible_Sleep_nonIO_290"></a>3.1.1、Uninterruptible Sleep (non-IO)</h5> 
<p>我们看一个最经典的<font color="red"><strong>方法耗时分析</strong></font>，看过 Framework 源码的同学都知道系统层<code>Choreographer#doFrame()</code>是执行一帧绘制（包括<code>layout</code>、<code>measure</code>、<code>draw</code>），如果我们页面操作时（比如浏览信息流）略显卡顿，那么必定存在某一帧或者更多帧耗时久的情况。用 Perfetto UI 打开 Trace，一眼就能看到有些些 Trace 段比较长，选中该段 Trace（这个 Trace 是系统层加的），如图十三所示：</p> 
<center> 
 <img width="650" src="https://images2.imgbox.com/c2/4d/jwor8cx1_o.png"> 
 <br>（图十三） 
</center> 
<p>观察 Slice Details 后会很一目了然的看到该 Trace 的耗时：</p> 
<ol><li>看到这一帧耗时 177ms，很明显这么久的一帧会肉眼可见的卡顿一下。</li><li>查看 Duration 列表，可以看到有意外，存在耗时较久的<code>Sleeping</code>和<code>Uninterruptible Sleep (non-IO)</code>。</li><li>Running 比较久，可以点击箭头展开查看细节。</li></ol> 
<p>很明显，主线程存在不符合预期的<code>Uninterruptible Sleep (non-IO)</code>状态，这个 case 中比较明显的棕色段就是<code>Uninterruptible Sleep</code>的信息（不明显的放大横轴段就能看到）。</p> 
<p>重点来了，<font color="red"><strong>如何定位是什么原因引起的 Uninterruptible Sleep？</strong></font>我们可以这样操作，以<code>Uninterruptible Sleep</code>为中心放大横轴，到足够大了可以看到 App 主线程行慢慢露出<code>Runnable</code>和<code>Running</code>，如图十四所示：</p> 
<center> 
 <img width="650" src="https://images2.imgbox.com/42/8e/aRRyWxNi_o.png"> 
 <br>（图十四） 
</center> 
<ol><li><code>Runnable</code>不表示线程，而是表示当前线程可运行了。</li><li><code>Running</code>表示当前线程正在运行。</li></ol> 
<p>此时我们选中距离<code>Uninterruptible Sleep</code>最近的<code>Runnable</code>，如图十五所示：</p> 
<center> 
 <img width="650" src="https://images2.imgbox.com/c5/89/nMroqDAu_o.png"> 
 <br>（图十五） 
</center> 
<p>在<code>Selection Details</code>中可以看到<code>Waker</code>信息，它表示唤起当前线程（这里是主线程）的线程，可以看到这里是<code>dp2ndk</code>线程阻塞了主线程。同时，我们在 App 进程子列表中找到<code>dp2ndk</code>线程，并钉住。此时<code>dp2ndk</code>、渲染线程、主线程等就会同时钉在顶部，方便我们做对比确认信息。</p> 
<p>从图十五可以看到，<code>dp2ndk</code>线程占用了 CPU，这里需要做优化。</p> 
<h5><a id="312monitor_contention_with_owner_319"></a>3.1.2、monitor contention with owner</h5> 
<p>在 Perfetto UI 打开 Trace，放大缩小横轴到适当大小，横向滑动 Trace 段，可以看到类似<code>monitor contention with owner [xxx]</code>的 Trace 段，它会阻塞主线程或者渲染线程，点击主线程或者渲染线程后面的<code>Runnable</code>观察<code>Waker</code>，可以看到是哪个线程阻塞的，如图十六所示：</p> 
<center> 
 <img width="650" src="https://images2.imgbox.com/1a/12/Og6biedu_o.png"> 
 <br>（图十六） 
</center> 
<p>此时我们选中距离<code>Uninterruptible Sleep</code>最近的<code>Runnable</code>，从图十六的<code>Slice Details</code>中可以看到，<code>NetworkKit-GRS_</code>线程占用了 CPU，这里需要做优化。</p> 
<h5><a id="313Lock_contention_on_InternTable_lock_327"></a>3.1.3、Lock contention on InternTable lock</h5> 
<p><code>Lock contention on [xxx]</code>的类型比较多，都属于锁操作，在 App 启动过程中或者页面操作过程中非常常见，如图十七所示，发现某个 Trace 耗时较长时，单独选中该段 Trace，在 Slices 中会列出子 Trace 段列表，可以更好的看出耗时 Trace。</p> 
<p>类似<code>Lock contention on InternTable lock</code>的渲染帧会影响页面流畅性，造成 App 卡顿，如图十七所示：</p> 
<center> 
 <img width="650" src="https://images2.imgbox.com/a3/e6/XJ1zbbht_o.gif"> 
 <br>（图十七） 
</center> 
<h4><a id="32_SQL__335"></a>3.2、使用 SQL 聚合分析</h4> 
<p>官网文档：</p> 
<ul><li>常见查询：<a href="https://perfetto.dev/docs/analysis/common-queries" rel="nofollow">https://perfetto.dev/docs/analysis/common-queries</a></li><li>语法：<a href="https://perfetto.dev/docs/analysis/perfetto-sql-syntax" rel="nofollow">https://perfetto.dev/docs/analysis/perfetto-sql-syntax</a></li><li>表字段介绍：<a href="https://perfetto.dev/docs/analysis/sql-tables" rel="nofollow">https://perfetto.dev/docs/analysis/sql-tables</a>。</li></ul> 
<p>使用图形界面只能一个个 Case 具体分析，当我们梳理出具体的多个 Cas 时，有时候需要拿到聚合数据给对应同事做优化，可以使用 SQL 查询。</p> 
<p>例如，统计名为<code>renderConvertView[smart_ui_jiangliu]</code>的 Trace 的平均耗时：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> name<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>dur<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span> <span class="token keyword">AS</span> dur <span class="token keyword">FROM</span> slice <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'renderConvertView[smart_ui_jiangliu]'</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> name
</code></pre> 
<p>结果如图十八所示：</p> 
<center> 
 <img width="650" src="https://images2.imgbox.com/eb/88/sArvtTSX_o.png"> 
 <br>（图十八） 
</center> 
<p>例如，统计名为<code>Lock contention on thread list lock (owner tid: 4054)</code>的 Trace，并按照耗时降序排序：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> ts<span class="token punctuation">,</span> dur<span class="token punctuation">,</span> name <span class="token keyword">FROM</span> slice <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'read from memory'</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> dur <span class="token keyword">DESC</span>
</code></pre> 
<p>结果如图十九所示：</p> 
<center> 
 <img width="650" src="https://images2.imgbox.com/06/4e/SNQuVToi_o.png"> 
 <br>（图十九） 
</center> 
<h3><a id="4_365"></a>4、结语</h3> 
<p>本文介绍了 Perfetto 配置生成、抓取 Trace、使用 Perfetto UI 分析 Trace 三块内容。在 Trace 分析时主要介绍了基于 CPU 的分析，没有介绍 GPU、内存、电量分析的细节，因为日常工作中本人用的不是很多，所以暂时写不了就不误导读者了，有机会再补充一篇文章。</p> 
<p>本文介绍的内容是不到官网的 1/3 的，但是一些细节也是官网没有的，很多人在实操时就卡在这些细节上，这也是我写这篇文章的原因。</p> 
<p>感兴趣的读者可以加我的 QQ 交流群：<a href="https://qm.qq.com/cgi-bin/qm/qr?k=6RdPw9r9yT8nqjEuKJkA-2kHmHwDCVXY&amp;jump_from=webapi&amp;authKey=bBM/fnWLYuyhTSkKofUYaNLQUlMkRuH+fIx7lF6/pkeYylo4MZQxbt0mJKqJo5rq" rel="nofollow">46523908</a>。</p> 
<p>本文完，感谢阅读。</p> 
<blockquote> 
 <p>版权声明：转载必须注明本文转自严振杰的博客：<a href="http://blog.yanzhenjie.com" rel="nofollow">http://blog.yanzhenjie.com</a></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/668ce266411f935be07d1a8cdf772dd5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CentOS 7 下安装RabbitMQ教程_centos7安装rabbitmq</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/64ed51058745df953aa9164d6f794835/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">前端：纯前端快速实现html导出word和pdf</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>