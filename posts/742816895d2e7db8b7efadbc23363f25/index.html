<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【深入学习Redis丨第二篇】Redis集群部署详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/742816895d2e7db8b7efadbc23363f25/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【深入学习Redis丨第二篇】Redis集群部署详解">
  <meta property="og:description" content="文章目录 Redis集群部署Redis4 Cluster部署 Redis集群部署 1 Redis各节点部署
使用源码安装各节点，不过与非cluster方式不同的是，配置文件中需启动cluster相关的配置。
因本次为伪分布式部署，生产环境部署时建议至少3台机器部署（其中每台机器1主1从）
ipport192.168.56.1017000192.168.56.1017001192.168.56.1017002192.168.56.1017003192.168.56.1017004192.168.56.1017005 1.1 启动cluster各节点
创建数据目录
mkdir -p /data/redis/cluster/{7000,7001,7002,7003,7004,7005} 配置文件中主要修改如下内容，其他的可按需调整，也可保持默认值，各节点中注意修改对应的端口号
bind 192.168.56.101 port 7000 daemonize yes pidfile /data/redis/cluster/7000/redis_7000.pid logfile &#34;/data/redis/cluster/7000/redis_7000.log&#34; appendonly yes appendfilename &#34;appendonly.aof&#34; appendfsync everysec cluster-enabled yes cluster-config-file nodes-7000.conf #注意此文件自动生成，且初始化时不要有和此重名的文件 cluster-node-timeout 5000 cluster-slave-validity-factor 10 cluster-migration-barrier 1 cluster-require-full-coverage yes cluster-slave-no-failover no 启动各节点，建议用redis用户启动
useradd redis chown -R redis:redis /data/redis/ su - redis cd /data/redis/cluster/7001 cp /data/redis/cluster/7000/redis.conf . sed -i &#34;s#7000#7001#g&#34; redis.conf redis-server redis.conf 其他节点和7001类似启动，启动后进程中会标记redis节点以cluster模式启动">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-02T11:14:54+08:00">
    <meta property="article:modified_time" content="2024-06-02T11:14:54+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【深入学习Redis丨第二篇】Redis集群部署详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li>Redis集群部署</li><li>Redis4 Cluster部署</li></ul> 
</div> 
<p></p> 
<p><img src="https://images2.imgbox.com/89/29/c7LsPhNZ_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="Redis_5"></a>Redis集群部署</h2> 
<p><strong>1 Redis各节点部署</strong></p> 
<p>使用源码安装各节点，不过与非cluster方式不同的是，配置文件中需启动cluster相关的配置。</p> 
<p>因本次为伪分布式部署，生产环境部署时建议至少3台机器部署（其中每台机器1主1从）</p> 
<table><thead><tr><th><br></th><th><br></th></tr></thead><tbody><tr><td><strong>ip</strong></td><td><strong>port</strong></td></tr><tr><td>192.168.56.101</td><td>7000</td></tr><tr><td>192.168.56.101</td><td>7001</td></tr><tr><td>192.168.56.101</td><td>7002</td></tr><tr><td>192.168.56.101</td><td>7003</td></tr><tr><td>192.168.56.101</td><td>7004</td></tr><tr><td>192.168.56.101</td><td>7005</td></tr></tbody></table> 
<p><strong>1.1 启动cluster各节点</strong></p> 
<p>创建数据目录</p> 
<pre><code>mkdir -p  /data/redis/cluster/{7000,7001,7002,7003,7004,7005}
</code></pre> 
<p>配置文件中主要修改如下内容，其他的可按需调整，也可保持默认值，各节点中注意修改对应的端口号</p> 
<pre><code>bind 192.168.56.101
port 7000
daemonize yes
pidfile /data/redis/cluster/7000/redis_7000.pid
logfile "/data/redis/cluster/7000/redis_7000.log"
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
cluster-enabled yes
cluster-config-file nodes-7000.conf     #注意此文件自动生成，且初始化时不要有和此重名的文件
cluster-node-timeout 5000
cluster-slave-validity-factor 10
cluster-migration-barrier 1
cluster-require-full-coverage yes
cluster-slave-no-failover no
</code></pre> 
<p>启动各节点，建议用redis用户启动</p> 
<pre><code>useradd redis
chown -R  redis:redis  /data/redis/
su - redis
cd /data/redis/cluster/7001
cp /data/redis/cluster/7000/redis.conf . 
sed -i "s#7000#7001#g" redis.conf
redis-server redis.conf
</code></pre> 
<p>其他节点和7001类似启动，启动后进程中会标记redis节点以cluster模式启动</p> 
<p><img src="https://images2.imgbox.com/99/34/zjxvUcUw_o.png" alt="在这里插入图片描述"></p> 
<p><strong>2. 按照依赖</strong></p> 
<p>因redis5之前版本前cluster安装依赖ruby，且版本要求比较苛刻，本次安装的版本redis4.0.14，依赖的ruby版本为&gt;=ruby2.4,因此大家安装时可以安装高版本的ruby，本次使用的是ruby2.7.5版本</p> 
<p><strong>2.1 编译安装ruby</strong></p> 
<p>下载ruby，建议从官网下载源码进行编译安装<br> https://www.ruby-lang.org/en/downloads/</p> 
<pre><code>tar -zxvf  ruby-2.7.5.tar.gz
cd ruby-2.7.5 
./configure
make  
make install
</code></pre> 
<p>安装完毕后，检查ruby以及gem版本</p> 
<p><strong>2.2 安装openssl-devel及zlib-devel</strong></p> 
<p>安装完ruby后，使用gem安装redis包，此时如果没有安装openssl 则回报如下错误</p> 
<pre><code>gem install  redis
ERROR:  Loading command: install (LoadError)
    cannot load such file -- openssl
ERROR:  While executing gem ... (NoMethodError)
    undefined method `invoke_with_build_args' for nil:NilClass
</code></pre> 
<p>按照过程如下：</p> 
<p>yum方式先安装openssl</p> 
<pre><code> yum install openssl-devel -y
</code></pre> 
<p>再进入ruby源码目录中的ext目录下，找到openssl目录，进入后进行安装</p> 
<pre><code>cd ruby-2.7.5/ext/openssl
ruby extconf.rb 
make
make install
</code></pre> 
<p>zlib-devel包如报错，也可同上方式处理。</p> 
<p>在执行make,若出现如下报错：</p> 
<pre><code> make: *** 没有规则可以创建“ossl_asn1.o”需要的目标“/include/ruby.h” 停止。
</code></pre> 
<p>可以在Makefile顶部中的增加 top_srcdir = …/…</p> 
<p>再次执行 make &amp;&amp; make install</p> 
<p><strong>2.3 gem安装redis</strong></p> 
<pre><code> gem install redis
</code></pre> 
<p><strong>3. 初始化redis集群</strong></p> 
<p>相关依赖安装完成后，即可初始化redis集群，命令及过程如下：</p> 
<pre><code>[redis@localhost redis-4.0.14]$ src/redis-trib.rb create --replicas 1 192.168.56.101:7000 192.168.56.101:7001 192.168.56.101:7002 192.168.56.101:7003 192.168.56.101:7004 192.168.56.101:7005
&gt;&gt;&gt; Creating cluster
&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...
Using 3 masters:
192.168.56.101:7000
192.168.56.101:7001
192.168.56.101:7002
Adding replica 192.168.56.101:7004 to 192.168.56.101:7000
Adding replica 192.168.56.101:7005 to 192.168.56.101:7001
Adding replica 192.168.56.101:7003 to 192.168.56.101:7002
&gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity
[WARNING] Some slaves are in the same host as their master
M: cd6663924f0c31e6b60b815dca9cb7ea863f5573 192.168.56.101:7000
   slots:0-5460 (5461 slots) master
M: abc1f43c9a4e8813e9da15433ac66cd185dc39fe 192.168.56.101:7001
   slots:5461-10922 (5462 slots) master
M: 43fa53cec1ae164f784e5d439aaf80ee2f7e35af 192.168.56.101:7002
   slots:10923-16383 (5461 slots) master
S: 6ffcd16f1d445b0091c6239bc0988fb8a77fac96 192.168.56.101:7003
   replicates cd6663924f0c31e6b60b815dca9cb7ea863f5573
S: c523846d491f8df0bc97033b025b0d24375a13f8 192.168.56.101:7004
   replicates abc1f43c9a4e8813e9da15433ac66cd185dc39fe
S: 905dc9de7e074c282aab44b4ed5680a2020bcf4c 192.168.56.101:7005
   replicates 43fa53cec1ae164f784e5d439aaf80ee2f7e35af
Can I set the above configuration? (type 'yes' to accept): yes
&gt;&gt;&gt; Nodes configuration updated
&gt;&gt;&gt; Assign a different config epoch to each node
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join....
&gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.101:7000)
M: cd6663924f0c31e6b60b815dca9cb7ea863f5573 192.168.56.101:7000
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
M: 43fa53cec1ae164f784e5d439aaf80ee2f7e35af 192.168.56.101:7002
   slots:10923-16383 (5461 slots) master
   1 additional replica(s)
S: c523846d491f8df0bc97033b025b0d24375a13f8 192.168.56.101:7004
   slots: (0 slots) slave
   replicates abc1f43c9a4e8813e9da15433ac66cd185dc39fe
S: 6ffcd16f1d445b0091c6239bc0988fb8a77fac96 192.168.56.101:7003
   slots: (0 slots) slave
   replicates cd6663924f0c31e6b60b815dca9cb7ea863f5573
M: abc1f43c9a4e8813e9da15433ac66cd185dc39fe 192.168.56.101:7001
   slots:5461-10922 (5462 slots) master
   1 additional replica(s)
S: 905dc9de7e074c282aab44b4ed5680a2020bcf4c 192.168.56.101:7005
   slots: (0 slots) slave
   replicates 43fa53cec1ae164f784e5d439aaf80ee2f7e35af
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
</code></pre> 
<p>至此，redis集群初始化完毕，各节点slot范围及角色也打印出来了</p> 
<h2><a id="Redis4_Cluster_216"></a>Redis4 Cluster部署</h2> 
<p><strong>1、安装redis集群节点</strong></p> 
<p>因本次为伪分布式部署，生产环境部署时建议至少3台机器部署（其中每台机器1主1从），依旧和redis4.0.14的方式一样部署</p> 
<table><thead><tr><th><br></th><th><br></th></tr></thead><tbody><tr><td>**ip **</td><td>**port **</td></tr><tr><td>192.168.56.101</td><td>7000</td></tr><tr><td>192.168.56.101</td><td>7001</td></tr><tr><td>192.168.56.101</td><td>7002</td></tr><tr><td>192.168.56.101</td><td>7003</td></tr><tr><td>192.168.56.101</td><td>7004</td></tr><tr><td>192.168.56.101</td><td>7005</td></tr></tbody></table> 
<p><strong>1.1 启动cluster各节点</strong></p> 
<p>创建数据目录</p> 
<pre><code>mkdir -p  /data/redis/cluster/{7000,7001,7002,7003,7004,7005}
</code></pre> 
<p>配置文件中主要修改如下内容，其他的可按需调整，也可保持默认值，各节点中注意修改对应的端口号</p> 
<pre><code>bind 192.168.56.103
port 7000
daemonize yes
pidfile /data/redis/cluster/7000/redis_7000.pid
logfile "/data/redis/cluster/7000/redis_7000.log"
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
cluster-enabled yes
cluster-config-file nodes-7000.conf     #注意此文件自动生成，且初始化时不要有和此重名的文件
cluster-node-timeout 5000
cluster-slave-validity-factor 10
cluster-migration-barrier 1
cluster-require-full-coverage yes
cluster-slave-no-failover no
</code></pre> 
<p>启动各节点，建议用redis用户启动</p> 
<pre><code>useradd redis
chown -R  redis:redis  /data/redis/
su - redis
cd /data/redis/cluster/7001
cp /data/redis/cluster/7000/redis.conf . 
sed -i "s#7000#7001#g" redis.conf
redis-server redis.conf
</code></pre> 
<p>其他节点和7001类似启动，启动后进程中会标记redis节点以cluster模式启动</p> 
<p><img src="https://images2.imgbox.com/6e/8c/REUiNXHr_o.png" alt="在这里插入图片描述"></p> 
<p><strong>2. 初始化集群</strong></p> 
<p>redis5.x之后的版本初始化集群相当便捷，命令及过程如下</p> 
<pre><code>redis-cli --cluster create --cluster-replicas 1 192.168.56.103:7000 192.168.56.103:7001 192.168.56.103:7002 192.168.56.103:7003 192.168.56.103:7004 192.168.56.103:7005
&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...
Master[0] -&gt; Slots 0 - 5460
Master[1] -&gt; Slots 5461 - 10922
Master[2] -&gt; Slots 10923 - 16383
Adding replica 192.168.56.103:7004 to 192.168.56.103:7000
Adding replica 192.168.56.103:7005 to 192.168.56.103:7001
Adding replica 192.168.56.103:7003 to 192.168.56.103:7002
&gt;&gt;&gt; Trying to optimize slaves allocation for anti-affinity
[WARNING] Some slaves are in the same host as their master
M: 84ea774c08450db01bf5a518e3b9e55fd26d4d34 192.168.56.103:7000
   slots:[0-5460] (5461 slots) master
M: eb98e53273fd348deb5eabcc6bfffc20484749b1 192.168.56.103:7001
   slots:[5461-10922] (5462 slots) master
M: e059d418c11401189558d0f33bd5658297c10939 192.168.56.103:7002
   slots:[10923-16383] (5461 slots) master
S: 23eed1c27ad11c685e5a226e2f82d5c0b6384c79 192.168.56.103:7003
   replicates e059d418c11401189558d0f33bd5658297c10939
S: cfa2549ea7782bb4f0ed6d45e9e3704a7d38d540 192.168.56.103:7004
   replicates 84ea774c08450db01bf5a518e3b9e55fd26d4d34
S: c3e14c4139bfa88af03ea97679715f051a122806 192.168.56.103:7005
   replicates eb98e53273fd348deb5eabcc6bfffc20484749b1
Can I set the above configuration? (type 'yes' to accept): yes
&gt;&gt;&gt; Nodes configuration updated
&gt;&gt;&gt; Assign a different config epoch to each node
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join
.
&gt;&gt;&gt; Performing Cluster Check (using node 192.168.56.103:7000)
M: 84ea774c08450db01bf5a518e3b9e55fd26d4d34 192.168.56.103:7000
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: 23eed1c27ad11c685e5a226e2f82d5c0b6384c79 192.168.56.103:7003
   slots: (0 slots) slave
   replicates e059d418c11401189558d0f33bd5658297c10939
M: eb98e53273fd348deb5eabcc6bfffc20484749b1 192.168.56.103:7001
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: c3e14c4139bfa88af03ea97679715f051a122806 192.168.56.103:7005
   slots: (0 slots) slave
   replicates eb98e53273fd348deb5eabcc6bfffc20484749b1
S: cfa2549ea7782bb4f0ed6d45e9e3704a7d38d540 192.168.56.103:7004
   slots: (0 slots) slave
   replicates 84ea774c08450db01bf5a518e3b9e55fd26d4d34
M: e059d418c11401189558d0f33bd5658297c10939 192.168.56.103:7002
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.

</code></pre> 
<p>看到如下结果，代表成功配置并分配slot完成</p> 
<p><img src="https://images2.imgbox.com/41/f3/Crm4I4en_o.png" alt="在这里插入图片描述"></p> 
<p>查看各节点信息也可以用如下命令</p> 
<pre><code>[redis@localhost 7005]$ redis-cli -h 192.168.56.103 -p 7000 cluster nodes
23eed1c27ad11c685e5a226e2f82d5c0b6384c79 192.168.56.103:7003@17003 slave e059d418c11401189558d0f33bd5658297c10939 0 1646118171000 4 connected
eb98e53273fd348deb5eabcc6bfffc20484749b1 192.168.56.103:7001@17001 master - 0 1646118171604 2 connected 5461-10922
c3e14c4139bfa88af03ea97679715f051a122806 192.168.56.103:7005@17005 slave eb98e53273fd348deb5eabcc6bfffc20484749b1 0 1646118171000 6 connected
cfa2549ea7782bb4f0ed6d45e9e3704a7d38d540 192.168.56.103:7004@17004 slave 84ea774c08450db01bf5a518e3b9e55fd26d4d34 0 1646118170000 5 connected
e059d418c11401189558d0f33bd5658297c10939 192.168.56.103:7002@17002 master - 0 1646118169590 3 connected 10923-16383
84ea774c08450db01bf5a518e3b9e55fd26d4d34 192.168.56.103:7000@17000 myself,master - 0 1646118171000 1 connected 0-5460
</code></pre> 
<hr> 
<p><img src="https://images2.imgbox.com/f4/40/Q05nFu7Z_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c7fc028862aea35a85a41656329858b2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于MingGW64 GCC编译Windows平台上的 libuvc</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7808ccc1395e4cf58d6f388f0bedf8d0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">列表和列表项</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>