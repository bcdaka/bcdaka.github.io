<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spark学习之SparkSQL - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/0f5f688dd81bc7ef0b4cd72de47f860e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Spark学习之SparkSQL">
  <meta property="og:description" content="SparkSQL 1、SparkSql初识案例 :WordCount spark sql处理数据的步骤1、读取数据源2、将读取到的DF注册成一个临时视图3、使用sparkSession的sql函数，编写sql语句操作临时视图，返回的依旧是一个DataFrame4、将结果写出到hdfs上 import org.apache.spark.SparkContext import org.apache.spark.sql.{DataFrame, Dataset, Row, SaveMode, SparkSession} object Demo1WordCount { def main(args: Array[String]): Unit = { //创建编写spark sql的环境 val sparkSession: SparkSession = SparkSession /** * 用于创建或配置 SparkSession 实例的一个构建器（Builder）模式的应用 * 使用 SparkSession.builder()，你可以链式地设置各种配置选项， * 并最终通过调用 .getOrCreate() 方法来获取一个 SparkSession 实例。 */ .builder() // 执行模式：本地执行 .master(&#34;local&#34;) // 名称 .appName(&#34;sql语法风格编写WordCount&#34;) // 获取SparkSession.builder()创建的 SparkSession 实例 .getOrCreate() /** * spark sql是spark core的上层api，如果要想使用rdd的编程 * 可以直接通过sparkSession获取SparkContext对象 */ val context: SparkContext = sparkSession.sparkContext //spark sql的核心数据类型是DataFrame（注意与RDD的区别） val df1: DataFrame = sparkSession.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-16T20:32:10+08:00">
    <meta property="article:modified_time" content="2024-07-16T20:32:10+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spark学习之SparkSQL</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="SparkSQL_0"></a>SparkSQL</h4> 
<h5><a id="1SparkSql_WordCount_2"></a>1、SparkSql初识案例 :WordCount</h5> 
<blockquote> 
 <ul><li>spark sql处理数据的步骤</li><li>1、读取数据源</li><li>2、将读取到的DF注册成一个临时视图</li><li>3、使用sparkSession的sql函数，编写sql语句操作临时视图，返回的依旧是一个DataFrame</li><li>4、将结果写出到hdfs上</li></ul> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token class-name">SparkContext</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">DataFrame</span><span class="token punctuation">,</span> <span class="token class-name">Dataset</span><span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">,</span> <span class="token class-name">SaveMode</span><span class="token punctuation">,</span> <span class="token class-name">SparkSession</span><span class="token punctuation">}</span>


object <span class="token class-name">Demo1WordCount</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//创建编写spark sql的环境</span>
    val sparkSession<span class="token operator">:</span> <span class="token class-name">SparkSession</span> <span class="token operator">=</span> <span class="token class-name">SparkSession</span>
    <span class="token comment">/**
     * 用于创建或配置 SparkSession 实例的一个构建器（Builder）模式的应用
     * 使用 SparkSession.builder()，你可以链式地设置各种配置选项，
     * 并最终通过调用 .getOrCreate() 方法来获取一个 SparkSession 实例。
     */</span>
      <span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 执行模式：本地执行</span>
      <span class="token punctuation">.</span><span class="token function">master</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span>
      <span class="token comment">// 名称</span>
      <span class="token punctuation">.</span><span class="token function">appName</span><span class="token punctuation">(</span><span class="token string">"sql语法风格编写WordCount"</span><span class="token punctuation">)</span>
      <span class="token comment">// 获取SparkSession.builder()创建的 SparkSession 实例</span>
      <span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * spark sql是spark core的上层api，如果要想使用rdd的编程
     * 可以直接通过sparkSession获取SparkContext对象
     */</span>
        val context<span class="token operator">:</span> <span class="token class-name">SparkContext</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>sparkContext

    <span class="token comment">//spark sql的核心数据类型是DataFrame（注意与RDD的区别）</span>
    val df1<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span> <span class="token comment">// 读取csv格式的文件，但是实际上这种做法可以读取任意分隔符的文本文件</span>
      <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"sep"</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span> <span class="token comment">//指定读取数据的列与列之间的分隔符</span>
      <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token string">"line STRING"</span><span class="token punctuation">)</span> <span class="token comment">// 指定表的列字段 包括列名和列数据类型</span>
      <span class="token comment">// 读取文件数据</span>
      <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"spark/data/wcs/words.txt"</span><span class="token punctuation">)</span>

    <span class="token comment">//    println(df1)</span>
    <span class="token comment">//查看DataFrame的数据内容</span>
    <span class="token comment">//    df1.show()</span>
    <span class="token comment">//查看表结构</span>
    <span class="token comment">//    df1.printSchema()</span>

    <span class="token comment">/**
     * sql语句是无法直接作用在DataFrame上面的
     * 需要提前将要使用sql分析的DataFrame注册成一张表（临时视图）
     */</span>
    <span class="token comment">//老版本的做法将df注册成一张表</span>
    <span class="token comment">//    df1.registerTempTable("wcs")</span>
    df1<span class="token punctuation">.</span><span class="token function">createOrReplaceTempView</span><span class="token punctuation">(</span><span class="token string">"wcs"</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 编写sql语句作用在表上
     * sql语法是完全兼容hive语法
     */</span>
    val df2<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span>
      <span class="token triple-quoted-string string">"""
        |select
        |t1.word,
        |count(1) as counts
        |from(
        |select
        |explode(split(line,'\\|')) as word
        |from wcs) t1 group by t1.word
        |"""</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>
    <span class="token comment">//    df2.show()</span>

    <span class="token comment">//通过观察源码发现，DataFrame底层数据类型其实就是封装了DataSet的数据类型</span>
    <span class="token comment">// 对DataFrame或Dataset进行重分区，Spark将这个DataFrame或Dataset的数据重新分配到1个分区中。</span>
    val resDS<span class="token operator">:</span> <span class="token class-name">Dataset</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> df2<span class="token punctuation">.</span><span class="token function">repartition</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 将计算后的DataFrame保存到本地磁盘文件中
     */</span>
    resDS<span class="token punctuation">.</span>write
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span> <span class="token comment">//默认的分隔符是英文逗号</span>
      <span class="token comment">//      .option("sep","\t")</span>
      <span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span><span class="token class-name">SaveMode<span class="token punctuation">.</span>Overwrite</span><span class="token punctuation">)</span> <span class="token comment">// 如果想每次覆盖之前的执行结果的话，可以在写文件的同时指定写入模式，使用模式枚举类</span>
      <span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token string">"spark/data/sqlout1"</span><span class="token punctuation">)</span> <span class="token comment">// 保存的路径其实是指定的一个文件夹</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="DataFrame_DSL_93"></a>DataFrame DSL</h4> 
<blockquote> 
 <p>Spark SQL中的DataFrame DSL（Domain Specific Language，领域特定语言）是一种用于处理DataFrame的编程风格，它允许开发者以命令式的方式，通过调用API接口来操作DataFrame。这种风格**介于代码和纯SQL之间，**提供了一种更加灵活和强大的数据处理方式。</p> 
 <p>DataFrame DSL（Domain Specific Language，领域特定语言）中的<strong>API接口是一系列用于操作DataFrame的函数和方法。</strong></p> 
</blockquote> 
<h5><a id="1DSLWordCount_99"></a>1、DSL处理WordCount</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">DataFrame</span><span class="token punctuation">,</span> <span class="token class-name">SaveMode</span><span class="token punctuation">,</span> <span class="token class-name">SparkSession</span><span class="token punctuation">}</span>

object <span class="token class-name">Demo2DSLWordCount</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//创建SparkSession对象</span>
    val sparkSession<span class="token operator">:</span> <span class="token class-name">SparkSession</span> <span class="token operator">=</span> <span class="token class-name">SparkSession</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">master</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">appName</span><span class="token punctuation">(</span><span class="token string">"DSL语法风格编写spark sql"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    val df1<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token string">"line STRING"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"sep"</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"spark/data/wcs/words.txt"</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 如果要想使用DSL语法编写spark sql的话，需要导入两个隐式转换
     */</span>
    <span class="token comment">//将sql中的函数，封装成spark程序中的一个个的函数直接调用，以传参的方式调用</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
    <span class="token comment">//主要作用是，将来可以在调用的函数中，使用$函数，将列名字符串类型转成一个ColumnName类型</span>
    <span class="token comment">//而ColumnName是继承自Column类的</span>
    <span class="token keyword">import</span> <span class="token namespace">sparkSession<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_

    <span class="token comment">//老版本聚合操作</span>
    <span class="token comment">//    df1.select(explode(split($"line","\\|")) as "word")</span>
    <span class="token comment">//      .groupBy($"word")</span>
    <span class="token comment">//      .count().show()</span>

    <span class="token comment">//新版本聚合操作</span>
    <span class="token comment">// .as("word") == as "word" </span>
    val resDF<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> df1<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token function">explode</span><span class="token punctuation">(</span><span class="token function">split</span><span class="token punctuation">(</span>$<span class="token string">"line"</span><span class="token punctuation">,</span> <span class="token string">"\\|"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> as <span class="token string">"word"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>$<span class="token string">"word"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">agg</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span>$<span class="token string">"word"</span><span class="token punctuation">)</span> as <span class="token string">"counts"</span><span class="token punctuation">)</span>

    resDF
      <span class="token comment">// 重分区</span>
      <span class="token punctuation">.</span><span class="token function">repartition</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>write
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"sep"</span><span class="token punctuation">,</span><span class="token string">"\t"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span><span class="token class-name">SaveMode<span class="token punctuation">.</span>Overwrite</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token string">"spark/data/sqlout2"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2DSLApi_151"></a>2、DSLApi</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span><span class="token class-name">Window</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">DataFrame</span><span class="token punctuation">,</span> <span class="token class-name">SaveMode</span><span class="token punctuation">,</span> <span class="token class-name">SparkSession</span><span class="token punctuation">,</span> expressions<span class="token punctuation">}</span>


object <span class="token class-name">Demo3DSLApi</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//创建SparkSession对象</span>
    val sparkSession<span class="token operator">:</span> <span class="token class-name">SparkSession</span> <span class="token operator">=</span> <span class="token class-name">SparkSession</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string">"spark.sql.shuffle.partitions"</span><span class="token punctuation">,</span><span class="token string">"1"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">master</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">appName</span><span class="token punctuation">(</span><span class="token string">"DSL语法风格编写spark sql"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 如果要想使用DSL语法编写spark sql的话，需要导入两个隐式转换
     */</span>
    <span class="token comment">//将sql中的函数，封装成spark程序中的一个个的函数直接调用，以传参的方式调用</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
    <span class="token comment">//主要作用是，将来可以在调用的函数中，使用$函数，将列名字符串类型转成一个ColumnName类型</span>
    <span class="token comment">//而ColumnName是继承自Column类的</span>
    <span class="token keyword">import</span> <span class="token namespace">sparkSession<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_

    <span class="token comment">/**
     * 读取json数据文件，转成DF
     * 读取json数据的时候，是不需要指定表结构，可以自动根据json的键值来构建DataFrame
     */</span>
    <span class="token comment">//老版本的读取json数据的方式</span>
<span class="token comment">//        val df1: DataFrame = sparkSession.read</span>
<span class="token comment">//          .format("json")</span>
<span class="token comment">//          .load("spark/data/students.json")</span>

    val df1<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
      <span class="token comment">// 由于是json数据，数据中就有它们的列名，所以无需再为它们设置列名</span>
      <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">"spark/data/students.json"</span><span class="token punctuation">)</span>

    <span class="token comment">//默认显示20行数据</span>
    <span class="token comment">//    df1.show()</span>
    <span class="token comment">//传入要查看的行数</span>
    <span class="token comment">//    df1.show(100)</span>
    <span class="token comment">//传入第二个参数 truncate = false，观察的更加详细,默认每一列只会保留20个字符</span>
<span class="token comment">//        df1.show(10,truncate = false)</span>

    <span class="token comment">/**
     * DSL语法的第一个函数 select
     * 类似于纯sql语法中的select关键字，传入要查询的列
     */</span>
<span class="token comment">//    select name,clazz from xxx;</span>
            df1<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        df1<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>$<span class="token string">"name"</span><span class="token punctuation">,</span> $<span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//查询每个学生的姓名，原本的年龄，年龄+1</span>
        df1<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">/**
     * 与select功能差不多的查询函数
     * 如果要以传字符串的形式给到select的话，并且还想对列进行表达式处理的话，可以使用selectExpr函数
     */</span>
        df1<span class="token punctuation">.</span><span class="token function">selectExpr</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"age+1 as new_age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//如果想要使用select函数查询的时候对列做操作的话，可以使用$函数将列变成一个对象</span>
        df1<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>$<span class="token string">"name"</span><span class="token punctuation">,</span> $<span class="token string">"age"</span><span class="token punctuation">,</span> $<span class="token string">"age"</span> <span class="token operator">+</span> <span class="token number">1</span> as <span class="token string">"new_age"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * DSL语法函数：where
     * === : 类似于sql中的= 等于某个值
     * =!= : 类似于sql中的!=或者&lt;&gt;  不等于某个值
     */</span>
        df1<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"gender='男'"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        df1<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"gender='男' and substring(clazz,0,2)='理科'"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//TODO 建议使用隐式转换中的功能进行处理过滤，$"gender"，将gender转换成一个ColumnName类对象</span>
    <span class="token comment">//过滤出男生且理科的</span>
        df1<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>$<span class="token string">"gender"</span> <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">"男"</span> and <span class="token function">substring</span><span class="token punctuation">(</span>$<span class="token string">"clazz"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">"理科"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">//过滤出女生且理科的</span>
        df1<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>$<span class="token string">"gender"</span> <span class="token operator">=</span><span class="token operator">!=</span> <span class="token string">"男"</span> and <span class="token function">substring</span><span class="token punctuation">(</span>$<span class="token string">"clazz"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">"理科"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * DSL语法函数：groupBy
     *
     * 非分组字段是无法出现在select查询语句中的
     */</span>
    <span class="token comment">//查询每个班级的人数</span>
        df1<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"clazz"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">agg</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token string">"clazz"</span><span class="token punctuation">)</span> as <span class="token string">"counts"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * DSL语法函数：orderBy
     */</span>
    df1<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"clazz"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">agg</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token string">"clazz"</span><span class="token punctuation">)</span> as <span class="token string">"counts"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>$<span class="token string">"counts"</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * DSL语法函数: join
     */</span>
    val df2<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"sep"</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span>
<span class="token comment">//      .schema("sid STRING,subject_id STRING,score INT")</span>
      <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token string">"id STRING,subject_id STRING,score INT"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"spark/data/score.txt"</span><span class="token punctuation">)</span>

    <span class="token comment">// 关联的字段名不一样的情况</span>
<span class="token comment">//    df2.join(df1,$"id" === $"sid","inner")</span>
<span class="token comment">//      .select("id","name","age","gender","clazz","subject_id","score")</span>
<span class="token comment">//      .show(10)</span>
    <span class="token comment">// 关联的字段名一样的情况</span>
    df2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>df1<span class="token punctuation">,</span><span class="token string">"id"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"age"</span><span class="token punctuation">,</span><span class="token string">"gender"</span><span class="token punctuation">,</span><span class="token string">"clazz"</span><span class="token punctuation">,</span><span class="token string">"subject_id"</span><span class="token punctuation">,</span><span class="token string">"score"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token comment">//如果关联的字段名一样且想使用其他连接方式的话,可以将字段名字用Seq()传入,同时可以传连接方式</span>
    df2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>df1<span class="token punctuation">,</span> <span class="token class-name">Seq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"left"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"age"</span><span class="token punctuation">,</span><span class="token string">"gender"</span><span class="token punctuation">,</span><span class="token string">"clazz"</span><span class="token punctuation">,</span><span class="token string">"subject_id"</span><span class="token punctuation">,</span><span class="token string">"score"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * DSL语法函数: 开窗
     * 无论是在纯sql中还是在DSL语法中,开窗是不会改变原表条数
     */</span>
    <span class="token comment">//计算每个班级总分前3的学生</span>
    <span class="token comment">//纯sql的方式实现</span>
<span class="token comment">//    df1.createOrReplaceTempView("students")</span>
<span class="token comment">//    df2.createOrReplaceTempView("scores")</span>
<span class="token comment">//    sparkSession.sql(</span>
<span class="token comment">//      """</span>
<span class="token comment">//        |select</span>
<span class="token comment">//        |*</span>
<span class="token comment">//        |from</span>
<span class="token comment">//        |(</span>
<span class="token comment">//        |select t1.id,</span>
<span class="token comment">//        |t2.name,</span>
<span class="token comment">//        |t2.clazz,</span>
<span class="token comment">//        |t1.sumScore,</span>
<span class="token comment">//        |row_number() over(partition by t2.clazz order by t1.sumScore desc) as rn</span>
<span class="token comment">//        |from</span>
<span class="token comment">//        |(</span>
<span class="token comment">//        | select id,</span>
<span class="token comment">//        |        sum(score) as sumScore</span>
<span class="token comment">//        | from</span>
<span class="token comment">//        |   scores</span>
<span class="token comment">//        | group by id) t1</span>
<span class="token comment">//        |join</span>
<span class="token comment">//        | students t2</span>
<span class="token comment">//        |on(t1.id=t2.id)) tt1 where tt1.rn&lt;=3</span>
<span class="token comment">//        |""".stripMargin).show()</span>

    <span class="token comment">//DSL语法实现</span>
    df2<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token comment">//根据学号分组</span>
      <span class="token punctuation">.</span><span class="token function">agg</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span> as <span class="token string">"sumScore"</span><span class="token punctuation">)</span> <span class="token comment">// 计算每个人总分</span>
      <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>df1<span class="token punctuation">,</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token comment">// 与学生信息表关联,得到班级列</span>
      <span class="token comment">// over 不要写成 over()</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>$<span class="token string">"name"</span><span class="token punctuation">,</span>$<span class="token string">"clazz"</span><span class="token punctuation">,</span>$<span class="token string">"sumScore"</span><span class="token punctuation">,</span><span class="token function">row_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token class-name">Window</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"clazz"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>$<span class="token string">"sumScore"</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span> as <span class="token string">"rn"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>$<span class="token string">"rn"</span> <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment">//      .repartition(1)</span>
      <span class="token punctuation">.</span>write
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span><span class="token class-name">SaveMode<span class="token punctuation">.</span>Overwrite</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token string">"spark/data/sqlout3"</span><span class="token punctuation">)</span>


  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3SourceApi_317"></a>3、SourceApi</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">DataFrame</span><span class="token punctuation">,</span> <span class="token class-name">SaveMode</span><span class="token punctuation">,</span> <span class="token class-name">SparkSession</span><span class="token punctuation">}</span>

object <span class="token class-name">Demo4SourceAPI</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val sparkSession<span class="token operator">:</span> <span class="token class-name">SparkSession</span> <span class="token operator">=</span> <span class="token class-name">SparkSession</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">master</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">appName</span><span class="token punctuation">(</span><span class="token string">"data source api"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string">"spark.sql.shuffle.partitions"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 导入隐式转换你
     */</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
    <span class="token keyword">import</span> <span class="token namespace">sparkSession<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_

    <span class="token comment">/**
     * ==========================================读写csv格式的数据==========================================
     * 可以读取使用分隔符分开的数据文件，例如.txt文件
     * 默认切分的分隔符为 ","
     */</span>
    <span class="token comment">//如果是直接调用csv函数读取数据的话，无法做表结构的设置</span>
        val df1<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
          <span class="token punctuation">.</span><span class="token function">csv</span><span class="token punctuation">(</span><span class="token string">"spark/data/test1.csv"</span><span class="token punctuation">)</span>
        <span class="token comment">//使用format的形式读取数据的同时可以设置表结构</span>
        val df2<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
          <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token string">"id STRING,name STRING,age INT"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"spark/data/test1.csv"</span><span class="token punctuation">)</span>
        df2<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        val df3<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
          <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token string">"id STRING,name STRING,age INT,gender STRING,clazz STRING"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"sep"</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"spark/data/students.txt"</span><span class="token punctuation">)</span>

        df3<span class="token punctuation">.</span><span class="token function">createOrReplaceTempView</span><span class="token punctuation">(</span><span class="token string">"students"</span><span class="token punctuation">)</span>

        val resDF1<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span><span class="token function">sql</span><span class="token punctuation">(</span>
          <span class="token triple-quoted-string string">"""
            |select
            |clazz,
            |count(1) as counts
            |from students
            |group by clazz
            |"""</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>
        <span class="token comment">//以csv格式写出到磁盘文件夹中</span>
        resDF1<span class="token punctuation">.</span>write
          <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
    <span class="token comment">//      .option("sep",",")</span>
          <span class="token comment">// 模式为覆盖写</span>
          <span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span><span class="token class-name">SaveMode<span class="token punctuation">.</span>Overwrite</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token string">"spark/data/sqlout4"</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * ==========================================读写json格式的数据==========================================
     * 对数据进行读取时，无需为其字段命名，会用它的键值作为列名
     */</span>
        val df5<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
          <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">"spark/data/students.json"</span><span class="token punctuation">)</span>

        df5<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">agg</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span> as <span class="token string">"counts"</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>write
          <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">"spark/data/sqlout5"</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * ==========================================读写parquet格式的数据==========================================
     *
     * parquet格式的文件存储，是由【信息熵】决定的
     * 存储有大量重复数据时，数据量比一般存储要少
     */</span>
        val df6<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
          <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">"spark/data/students2.json"</span><span class="token punctuation">)</span>

        <span class="token comment">//以parquet格式写出去</span>
        df6<span class="token punctuation">.</span>write
          <span class="token punctuation">.</span><span class="token function">parquet</span><span class="token punctuation">(</span><span class="token string">"spark/data/sqlout7"</span><span class="token punctuation">)</span>

<span class="token comment">//    读取parquet格式的数据</span>
        val df4<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
          <span class="token punctuation">.</span><span class="token function">parquet</span><span class="token punctuation">(</span><span class="token string">"spark/data/sqlout7/part-00000-23f5482d-74d5-4569-9bf4-ea0ec91e86dd-c000.snappy.parquet"</span><span class="token punctuation">)</span>
        df4<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * ==========================================读写orc格式的数据==========================================
     * 存储大量重复的数据时，数据量最少
     * 最常使用
     */</span>
    val df7<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token string">"spark/data/students2.json"</span><span class="token punctuation">)</span>
    df7<span class="token punctuation">.</span>write
      <span class="token punctuation">.</span><span class="token function">orc</span><span class="token punctuation">(</span><span class="token string">"spark/data/sqlout8"</span><span class="token punctuation">)</span>

    sparkSession<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span><span class="token function">orc</span><span class="token punctuation">(</span><span class="token string">"spark/data/sqlout8/part-00000-a33e356c-fd1f-4a5e-a87f-1d5b28f6008b-c000.snappy.orc"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token comment">/**
     * ==========================================读写jdbc格式的数据==========================================
     *
     */</span>
    sparkSession<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"jdbc"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://192.168.128.100:3306/studentdb?useUnicode=true&amp;characterEncoding=UTF-8&amp;useSSL=false"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"dbtable"</span><span class="token punctuation">,</span> <span class="token string">"studentdb.jd_goods"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span>truncate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="4RDDDataFrame_437"></a>4、RDD到DataFrame的类型转换</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token class-name">SparkContext</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>rdd<span class="token punctuation">.</span></span><span class="token constant">RDD</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">DataFrame</span><span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">,</span> <span class="token class-name">SparkSession</span><span class="token punctuation">}</span>

object <span class="token class-name">Demo5RDD2DataFrame</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val sparkSession<span class="token operator">:</span> <span class="token class-name">SparkSession</span> <span class="token operator">=</span> <span class="token class-name">SparkSession</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">master</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">appName</span><span class="token punctuation">(</span><span class="token string">"rdd与df之间的转换"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string">"spark.sql.shuffle.partitions"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">//通过SparkSession获取sparkContext对象</span>
    val sparkContext<span class="token operator">:</span> <span class="token class-name">SparkContext</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>sparkContext

    <span class="token comment">//作用1：使用$函数，将字符串转换成列名对象</span>
    <span class="token comment">//作用2：可以在不同的数据结构之间转换</span>
    <span class="token keyword">import</span> <span class="token namespace">sparkSession<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_

    <span class="token comment">/**
     * spark core的核心数据结构是：RDD
     * spark sql的核心数据结构是DataFrame
     */</span>
    <span class="token comment">// RDD-&gt;DataFrame  .toDF</span>
    val linesRDD<span class="token operator">:</span> <span class="token constant">RDD</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> sparkContext<span class="token punctuation">.</span><span class="token function">textFile</span><span class="token punctuation">(</span><span class="token string">"spark/data/students.txt"</span><span class="token punctuation">)</span>
    val stuRDD<span class="token operator">:</span> <span class="token constant">RDD</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> linesRDD<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
      line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span> match <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> gender<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> clazz<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
          <span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    val resRDD1<span class="token operator">:</span> <span class="token constant">RDD</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> stuRDD<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>_5<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>kv<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">(</span>kv<span class="token punctuation">.</span>_1<span class="token punctuation">,</span> kv<span class="token punctuation">.</span>_2<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    val df1<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> resRDD1<span class="token punctuation">.</span>toDF
    val df2<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> df1<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>$<span class="token string">"_1"</span> as <span class="token string">"clazz"</span><span class="token punctuation">,</span> $<span class="token string">"_2"</span> as <span class="token string">"counts"</span><span class="token punctuation">)</span>
    <span class="token comment">/**
     *用于打印出该数据集的架构（schema）信息。
     * 架构是指数据集中各列的名称、数据类型以及可能的元数据（如是否为空、默认值等）。
     */</span>
    df2<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// DataFrame-&gt;RDD  .rdd</span>
    val resRDD2<span class="token operator">:</span> <span class="token constant">RDD</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> df2<span class="token punctuation">.</span>rdd
    <span class="token comment">//TODO RDD[Row]类型数据的取值</span>
    resRDD2<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>row<span class="token operator">:</span><span class="token class-name">Row</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
      val clazz<span class="token operator">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> row<span class="token punctuation">.</span>getAs<span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"clazz"</span><span class="token punctuation">)</span>
    <span class="token comment">//TODO 这里的泛型最好使用Integer与在DataFrame中的类型保持一致</span>
      val counts<span class="token operator">:</span> <span class="token class-name">Integer</span> <span class="token operator">=</span> row<span class="token punctuation">.</span>getAs<span class="token punctuation">[</span><span class="token class-name">Integer</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"counts"</span><span class="token punctuation">)</span>
      s<span class="token string">"班级:$clazz, 人数:$counts"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span>println<span class="token punctuation">)</span>

    resRDD2<span class="token punctuation">.</span>map <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> <span class="token class-name">Row</span><span class="token punctuation">(</span>clazz<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span> counts<span class="token operator">:</span><span class="token class-name">Integer</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span>
        s<span class="token string">"班级:$clazz, 人数:$counts"</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">foreach</span><span class="token punctuation">(</span>println<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="5_501"></a>5、开窗函数</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>expressions<span class="token punctuation">.</span></span><span class="token class-name">Window</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">DataFrame</span><span class="token punctuation">,</span> <span class="token class-name">Dataset</span><span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">,</span> <span class="token class-name">SparkSession</span><span class="token punctuation">}</span>

<span class="token comment">/**
 * 开窗：over
 *  聚合开窗函数：sum  count  lag(取上一条)  lead(取后一条)
 *  排序开窗函数：row_number rank dense_rank
 *
 *  练习开窗的题目： DSL语法去做
 *    统计总分年级排名前十学生各科的分数
 *    统计每科都及格的学生
 *    统计总分大于年级平均分的学生
 *    统计每个班级的每个名次之间的分数差
 */</span>
object <span class="token class-name">Demo6WindowFun</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val sparkSession<span class="token operator">:</span> <span class="token class-name">SparkSession</span> <span class="token operator">=</span> <span class="token class-name">SparkSession</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">master</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">appName</span><span class="token punctuation">(</span><span class="token string">"rdd与df之间的转换"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string">"spark.sql.shuffle.partitions"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 导入隐式转换你
     */</span>
    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
    <span class="token keyword">import</span> <span class="token namespace">sparkSession<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_

    <span class="token comment">/**
     * 读取三个数据文件
     * 补充：
     * agg() 方法允许你指定一个或多个聚合函数，这些函数将应用于 DataFrame 的列上，以生成聚合后的结果。
     * withColumn():用于向 DataFrame 中添加新的列或替换已存在的列。
     */</span>
    val studentsDF<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token string">"id STRING,name STRING,age INT,gender STRING,clazz STRING"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"spark/data/students.txt"</span><span class="token punctuation">)</span>
<span class="token comment">//    studentsDF.show()</span>
    val scoresDF<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token string">"id STRING,subject_id STRING,score INT"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"spark/data/score.txt"</span><span class="token punctuation">)</span>
<span class="token comment">//    scoresDF.show()</span>
    val subjectsDF<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token string">"subject_id STRING,subject_name STRING,subject_score INT"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"spark/data/subject.txt"</span><span class="token punctuation">)</span>
<span class="token comment">//    subjectsDF.show()</span>

    <span class="token comment">//统计总分年级排名前十学生各科的分数</span>
    <span class="token comment">/**
     * dense_rank() 在处理并列排名时不会留下空缺。
     * 即，如果有两行或多行具有相同的排名依据值，它们将被赋予相同的排名，
     * 并且下一个排名的值会紧接着这些并列排名的最后一个值
     */</span>
    val resDS1<span class="token operator">:</span> <span class="token class-name">Dataset</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> scoresDF<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>studentsDF<span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withColumn</span><span class="token punctuation">(</span><span class="token string">"sumScore"</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span> over <span class="token class-name">Window</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withColumn</span><span class="token punctuation">(</span><span class="token string">"rn"</span><span class="token punctuation">,</span> <span class="token function">dense_rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token class-name">Window</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token function">substring</span><span class="token punctuation">(</span>$<span class="token string">"clazz"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>$<span class="token string">"sumScore"</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>$<span class="token string">"rn"</span> <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span>

    <span class="token comment">//统计每科都及格的学生</span>
    val resDS2<span class="token operator">:</span> <span class="token class-name">Dataset</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> scoresDF<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>subjectsDF<span class="token punctuation">,</span> <span class="token string">"subject_id"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>$<span class="token string">"score"</span> <span class="token operator">&gt;=</span> $<span class="token string">"subject_score"</span> <span class="token operator">*</span> <span class="token number">0.6</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withColumn</span><span class="token punctuation">(</span><span class="token string">"jigeCount"</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token function">expr</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> over <span class="token class-name">Window</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>$<span class="token string">"jigeCount"</span> <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">)</span>

    <span class="token comment">//统计总分大于年级平均分的学生,TODO(注：需要对年级进行分组：文科/理科，对班级字段进行切分)</span>
    val resDS3<span class="token operator">:</span> <span class="token class-name">Dataset</span><span class="token punctuation">[</span><span class="token class-name">Row</span><span class="token punctuation">]</span> <span class="token operator">=</span> scoresDF
      <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>studentsDF<span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withColumn</span><span class="token punctuation">(</span><span class="token string">"sumScore"</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span>$<span class="token string">"score"</span><span class="token punctuation">)</span> over <span class="token class-name">Window</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withColumn</span><span class="token punctuation">(</span><span class="token string">"avgScore"</span><span class="token punctuation">,</span> <span class="token function">avg</span><span class="token punctuation">(</span>$<span class="token string">"sumScore"</span><span class="token punctuation">)</span> over <span class="token class-name">Window</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span><span class="token function">substring</span><span class="token punctuation">(</span>$<span class="token string">"clazz"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>$<span class="token string">"sumScore"</span> <span class="token operator">&gt;</span> $<span class="token string">"avgScore"</span><span class="token punctuation">)</span>

    <span class="token comment">//统计每个班级的每个名次之间的分数差</span>
    scoresDF
      <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>studentsDF<span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">)</span>
      <span class="token comment">// 使用分组来求解，只查询分组中的字段和聚合后的新字段，而不会出现有科目编号，使一个学生有六组数据的情况</span>
      <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"clazz"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">agg</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span> as <span class="token string">"sumScore"</span><span class="token punctuation">)</span>
      <span class="token comment">// |1500100001|文科六班|     406|, 只会输出 groupby 的字段和新添加的字段</span>
      <span class="token punctuation">.</span><span class="token function">withColumn</span><span class="token punctuation">(</span><span class="token string">"rn"</span><span class="token punctuation">,</span> <span class="token function">row_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span> over <span class="token class-name">Window</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span>$<span class="token string">"clazz"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>$<span class="token string">"sumScore"</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withColumn</span><span class="token punctuation">(</span><span class="token string">"beforeSumScore"</span><span class="token punctuation">,</span> <span class="token function">lag</span><span class="token punctuation">(</span>$<span class="token string">"sumScore"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">750</span><span class="token punctuation">)</span> over <span class="token class-name">Window</span><span class="token punctuation">.</span><span class="token function">partitionBy</span><span class="token punctuation">(</span>$<span class="token string">"clazz"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span>$<span class="token string">"sumScore"</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withColumn</span><span class="token punctuation">(</span><span class="token string">"cha"</span><span class="token punctuation">,</span> $<span class="token string">"beforeSumScore"</span> <span class="token operator">-</span> $<span class="token string">"sumScore"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="6yarn_595"></a>6、提交到yarn上进行执行</h5> 
<blockquote> 
 <p>idea里面将代码编写好打包上传到集群中运行，上线使用</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span><span class="token class-name">DataFrame</span><span class="token punctuation">,</span> <span class="token class-name">SparkSession</span><span class="token punctuation">}</span>

object <span class="token class-name">Demo8SubmitYarn</span> <span class="token punctuation">{<!-- --></span>
  def <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> <span class="token class-name">Array</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    val sparkSession<span class="token operator">:</span> <span class="token class-name">SparkSession</span> <span class="token operator">=</span> <span class="token class-name">SparkSession</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//      .master("local")</span>
      <span class="token punctuation">.</span><span class="token function">appName</span><span class="token punctuation">(</span><span class="token string">"提交到yarn 计算每个班级的人数"</span><span class="token punctuation">)</span>
      <span class="token comment">//TODO 设置shuffle分区数（进行重分区），参数设置的优先级：代码优先级 &gt; 命令优先级 &gt; 配置文件优先级</span>
      <span class="token comment">// 分区数越多，并行度越高，理论上可以加快数据处理速度。但过高的分区数也可能导致调度和管理开销增加，反而降低性能。</span>
      <span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token string">"spark.sql.shuffle.partitions"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">getOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
    <span class="token keyword">import</span> <span class="token namespace">sparkSession<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_

    val df1<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> sparkSession<span class="token punctuation">.</span>read
      <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token string">"id STRING,name STRING,age INT,gender STRING,clazz STRING"</span><span class="token punctuation">)</span>
      <span class="token comment">// TODO 下面函数中的路径为HDFS上的路径（图为要打包到集群中运行）</span>
      <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    val df2<span class="token operator">:</span> <span class="token class-name">DataFrame</span> <span class="token operator">=</span> df1<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>$<span class="token string">"clazz"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">agg</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">)</span> as <span class="token string">"counts"</span><span class="token punctuation">)</span>

    df2<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    df2<span class="token punctuation">.</span>write
      <span class="token comment">// 将数据存储到HDFS上的路径</span>
      <span class="token punctuation">.</span><span class="token function">csv</span><span class="token punctuation">(</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fc64bfdad3be7726ae320a58a7d65b27/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Redis】集群</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/900b20399e0bc1e9b08cb6ad0920578a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">最大电子书平台Z-Library</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>