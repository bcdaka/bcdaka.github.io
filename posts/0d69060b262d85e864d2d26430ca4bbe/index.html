<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>解决Flutter在WEB中加载图片的跨域问题 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/0d69060b262d85e864d2d26430ca4bbe/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="解决Flutter在WEB中加载图片的跨域问题">
  <meta property="og:description" content="1、环境版本 Flutter版本：3.16.9
开发IDE：android studio 2023.1.1 Patch2
受影响环境：WEB (Android、IOS、Windows等都不受影响)
IDE输出的错误：
The following ProgressEvent$ object was thrown resolving an image codec:
[object ProgressEvent]
When the exception was thrown, this was the stack: Image provider: NetworkImage(&#34;https://randomuser.me/api/portraits/med/men/62.jpg&#34;, scale: 1.0)
Image key: NetworkImage(&#34;https://randomuser.me/api/portraits/med/men/62.jpg&#34;, scale: 1.0)
2、Flutter关于图片跨域问题的描述 2.1、内存、asset 和同源网络图片 如果图片在应用内存中有编码后的字节信息、或者以 asset 的方式提供、或者和应用存储在同一服务器上（也就是同源），则不需要做额外工作。图片既可以在 HTML 也可以在 CanvasKit 模式下，使用 Image.memory、 Image.asset 和 Image.network 来展示。
2.2、跨域图片 通常，可以配置内容分发网络 (CDN) 来自定义哪些域名可以访问你的内容。例如：Firebase 站点托管允许在 firebase.json 文件中， 指定一个自定义的 Access-Control-Allow-Origin 头。
如果无法从你的应用层面去配置图片服务器的 CORS，你依然可以通过另一个服务器代理请求，从而加载图片。这要求中转服务器对图片加载有充分的访问权。
此方法适用于源图片服务器公开提供了图片，却没有正确配置 CORS 头的情况。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-12T14:23:25+08:00">
    <meta property="article:modified_time" content="2024-03-12T14:23:25+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">解决Flutter在WEB中加载图片的跨域问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>1、环境版本</h2> 
<p>Flutter版本：3.16.9</p> 
<p>开发IDE：android studio 2023.1.1 Patch2</p> 
<p>受影响环境：WEB (<strong>Android、IOS、Windows等都不受影响</strong>)</p> 
<p>IDE输出的错误：</p> 
<blockquote> 
 <p>The following ProgressEvent$ object was thrown resolving an image codec:<br>   [object ProgressEvent]</p> 
 <p>When the exception was thrown, this was the stack: <br> Image provider: NetworkImage("https://randomuser.me/api/portraits/med/men/62.jpg", scale: 1.0)<br> Image key: NetworkImage("https://randomuser.me/api/portraits/med/men/62.jpg", scale: 1.0)</p> 
</blockquote> 
<h2>2、Flutter关于图片跨域问题的描述</h2> 
<h3 id="in-memory-asset-and-same-origin-network-images">2.1、内存、asset 和同源网络图片</h3> 
<p>        如果图片在应用内存中有编码后的字节信息、或者以 <a href="https://flutter.cn/docs/ui/assets/assets-and-images" rel="nofollow" title="asset">asset</a> 的方式提供、或者和应用存储在同一服务器上（也就是同源），则不需要做额外工作。图片既可以在 HTML 也可以在 CanvasKit 模式下，使用 <a href="https://api.flutter-io.cn/flutter/widgets/Image/Image.memory.html" rel="nofollow" title="Image.memory">Image.memory</a>、 <a href="https://api.flutter-io.cn/flutter/widgets/Image/Image.asset.html" rel="nofollow" title="Image.asset">Image.asset</a> 和 <a href="https://api.flutter-io.cn/flutter/widgets/Image/Image.network.html" rel="nofollow" title="Image.network">Image.network</a> 来展示。</p> 
<h3 id="cross-origin-images">2.2、跨域图片</h3> 
<p>        通常，可以配置内容分发网络 (CDN) 来自定义哪些域名可以访问你的内容。例如：Firebase 站点托管允许在 <code>firebase.json</code> 文件中， <a href="https://firebase.google.cn/docs/hosting/full-config#headers" rel="nofollow" title="指定一个自定义的">指定一个自定义的</a> <code>Access-Control-Allow-Origin</code> 头。</p> 
<p>        如果无法从你的应用层面去配置图片服务器的 CORS，你依然可以通过另一个服务器代理请求，从而加载图片。这要求中转服务器对图片加载有充分的访问权。</p> 
<p>        此方法适用于源图片服务器公开提供了图片，却没有正确配置 CORS 头的情况。</p> 
<p>        <strong>例子：</strong>使用 <a href="https://developers.cloudflare.com/workers/examples/cors-header-proxy" rel="nofollow" title="CloudFlare Workers">CloudFlare Workers</a>。使用 <a href="https://github.com/7kfpun/cors-proxy" title="Firebase Functions">Firebase Functions</a>。</p> 
<p>        以上这些官方文档提供解决跨域问题的方式，其实在实际业务环境中并不是太适合。</p> 
<h3 id="use-img-in-a-platform-view">2.3、使用 <code>&lt;img&gt;<strong>来解决</strong></code></h3> 
<p>        Flutter 支持在应用中使用 <a href="https://api.flutter-io.cn/flutter/widgets/HtmlElementView-class.html" rel="nofollow" title="HtmlElementView">HtmlElementView</a> 嵌入 HTML。通过它可以创建一个 <code>&lt;img&gt;</code> 元素来渲染另一个域名的图片。但是，一定要记住，此方法也附带了「Web 中的 Flutter 渲染器」一节中提到的限制。<a href="https://github.com/flutter/flutter/issues/71884" title="就目前而言">就目前而言</a>，在 CanvasKit 渲染器中过多地使用 HTML 元素，可能较为影响性能。如果图片和非图片内容交替出现， Flutter 需要在 <code>&lt;img&gt;</code> 元素之间创建额外的 WebGL 上下文。如果你的应用需要一次性在同一屏幕中展示大量的图片，请考虑使用 HTML 渲染器替代 CanvasKit。</p> 
<h4>2.3.1、&lt;img&gt;Widget组件封装</h4> 
<p id="use-img-in-a-platform-view">        <strong>参考网上的解决方案</strong>，先写个使用&lt;img&gt;的Widget的封装</p> 
<div> 
 <pre><code class="language-Dart">import 'dart:html';
import 'dart:ui' as ui;
import 'package:flutter/cupertino.dart';

class WebImage extends StatelessWidget{
  String url;
  double width;
  double height;

  WebImage(this.url, this.width, this.height);

  @override
  Widget build(BuildContext context) {
    String _divId = "web_image_" + DateTime.now().toIso8601String();
    // ignore: undefined_prefixed_name
    ui.platformViewRegistry.registerViewFactory(
      _divId,
          (int viewId) =&gt; ImageElement(src: url),
    );
    return SizedBox(
      width: width,
      height: height,
      child: HtmlElementView(key: UniqueKey(),
        viewType: _divId,),
    );
  }

}</code></pre> 
</div> 
<p>        使用WebImage组件：</p> 
<pre><code class="language-Dart">WebImage("图片网址", 50, 50),</code></pre> 
<p>         如果要显示圆形的头像图片可以这样写：</p> 
<pre><code class="language-Dart">ClipOval(
  child: WebImage("网络图片地址", 50, 50)
),</code></pre> 
<p>         效果：</p> 
<p class="img-center"><img alt="" height="352" src="https://images2.imgbox.com/cf/e9/edlKh0Ar_o.png" width="580"></p> 
<h4>2.3.2、使用后带来性能问题</h4> 
<p>        上面方式有一个很严重的问题，<strong>如果一个页面中图片特别多</strong>，比如列表，那么使用这种方式的话在pc上运行会特别卡，甚至卡死(<span style="color:#fe2c24;"><strong>所以少量使用时就不需要再望下看了</strong></span>)。会出现大量如下信息：</p> 
<blockquote> 
 <p>Flutter: restoring WebGL context.</p> 
 <p>Flutter: restoring WebGL context.</p> 
 <p>Flutter: restoring WebGL context.</p> 
 <p>...</p> 
</blockquote> 
<p>        官方文档（https://flutter.dev/docs/development/platform-integration/web-images ）中已经提到了 ：</p> 
<blockquote> 
 <p>As of today, using too many HTML elements with the CanvasKit renderer may hurt performance. If images interleave non-image content Flutter needs to create extra WebGL contexts between theelements. If your application needs to display a lot of images on the same screen all at once, consider using the HTML renderer instead of CanvasKit.</p> 
</blockquote> 
<p>        如果在一个页面有很多图片，则使用HTML renderer来代替CanvasKit。</p> 
<p>        那么什么是HTML renderer，什么是CanvasKit，如何使用这两个？</p> 
<p>        根据https://flutter.cn/docs/development/tools/web-renderers 官方文档，flutter对于web的渲染是有两种模式，即html和Canvaskit。</p> 
<p>        Canvaskit将 Skia 编译成 WebAssembly 格式，并使用 WebGL 渲染。应用在移动和桌面端保持一致，有更好的性能，以及降低不同浏览器渲染效果不一致的风险。但是应用的大小会增加大约 2MB。</p> 
<p>        默认情况下flutter自动选择渲染器。移动端浏览器选择 HTML，桌面端浏览器选择 CanvasKit。</p> 
<p>        但是我们如果想使用HTML renderer，就必须强制设置一下，而这个设置并不是在代码中，而是在启动参数中，如下</p> 
<blockquote> 
 <p>flutter run -d chrome --web-renderer html （或canvaskit）//运行命令</p> 
 <p>flutter build web --web-renderer html （或canvaskit） //编译打包</p> 
</blockquote> 
<p>        我们通过在终端执行flutter run -d chrome --web-renderer html 来运行我们的应用，就会发现即使页面中有很多图片，也不会出现明显卡顿卡死的现象了。<br>         如果使用Android studio，则需要对运行进行配置，如图：</p> 
<p><img alt="" height="220" src="https://images2.imgbox.com/01/34/gzY5y3dr_o.png" width="666"></p> 
<p>        在配置中的Additional run args一栏中添加--web-renderer html即可，再运行就会以HTML renderer的方式来运行。</p> 
<p>        最后编译打包的时候也要加上--web-renderer html才可以。</p> 
<p>        <span style="color:#fe2c24;"><strong>但配置后会了出现一些影响：</strong></span></p> 
<p>        改成html render后发现所有<strong>文字无法选择了，导致无法进行复制等行为</strong>。运行后通过开发者工具查看页面节点信息，可以看到整个body都被设置成了user-select: none; touch-action: none，这样就导致整个页面上的文本都无法选择。这个是flutter框架的行为，目前在flutter项目中还没有发现可以取消这个配置的api。</p> 
<h2>3、使用总结</h2> 
<ul><li>少量使用直接复制代码用上即可</li><li>加载大量外部图片优先考虑使用代理</li><li>假如你有图片服务端的控制权限，那直接配置服务端的跨域设置</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7ce755223001e5a62c1f802f728e6272/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">快速上手PyWebIO：Python开发者的Web应用利器！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0f178c496fe9efa71fd2a0f75df697d1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL 自增列解析（Auto_increment）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>