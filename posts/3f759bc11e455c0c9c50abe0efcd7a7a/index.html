<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【2024】springboot支付宝沙箱支付详细步骤（一篇搞定） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3f759bc11e455c0c9c50abe0efcd7a7a/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【2024】springboot支付宝沙箱支付详细步骤（一篇搞定）">
  <meta property="og:description" content="springboot支付宝沙箱支付详细步骤 支付宝沙箱环境配置进入支付宝的开放平台——沙箱支付密钥的生成 spring boot 环境配置导入支付宝支付的依赖到pom.xml中在 application.yml 里面进行配置alipay的java配置：AplipayConfig.java支付接口重要！前端配置！！ 接口测试回调接口在上面的Controller中配置内网穿透：https://natapp.cn/ 支付宝沙箱环境配置 进入支付宝的开放平台——沙箱支付 沙箱环境
进入个人沙箱环境
点击进入沙箱环境并用支付宝登陆
沙箱管理界面如图所示：
appid，支付宝网关，自定义密钥等
沙箱账号界面如图所示：
这里是用来支付的账号和密码
密钥的生成 密钥工具下载
这时我们拿到两个密钥，将它们保存，这两个密钥很重要
应用私钥应用公钥 拿到两个密钥后，进行自定义密钥配置
进入最开始的沙箱管理界面，点击自定义密钥，点击设置并查看，我们选择的是公钥模式
在这里将上一步骤生成的应用公钥填进来
得到支付宝公钥这另一个密钥，记住并保存这个支付宝公钥
至此，我们沙箱环境的配置和基本参数都已经获取到。
spring boot 环境配置 导入支付宝支付的依赖到pom.xml中 &lt;!-- 支付宝依赖沙箱支付 --&gt; &lt;dependency&gt; &lt;groupId&gt;com.alipay.sdk&lt;/groupId&gt; &lt;artifactId&gt;alipay-easysdk&lt;/artifactId&gt; &lt;version&gt;2.2.0&lt;/version&gt; &lt;/dependency&gt; &lt;!-- 支付宝相关--&gt; &lt;dependency&gt; &lt;groupId&gt;com.alipay.sdk&lt;/groupId&gt; &lt;artifactId&gt;alipay-sdk-java&lt;/artifactId&gt; &lt;version&gt;4.34.0.ALL&lt;/version&gt; 在 application.yml 里面进行配置 alipay: appId: appPrivateKey: alipayPublicKey: notifyUrl: alipay的java配置：AplipayConfig.java package com.kp.config; import com.alipay.easysdk.factory.Factory; import com.alipay.easysdk.kernel.Config; import lombok.Data; import org.springframework.boot.context.properties.ConfigurationProperties; import org.springframework.stereotype.Component; import javax.annotation.PostConstruct; @Data @Component //读取yml文件中alipay 开头的配置 @ConfigurationProperties(prefix = &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-04T16:19:47+08:00">
    <meta property="article:modified_time" content="2024-04-04T16:19:47+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【2024】springboot支付宝沙箱支付详细步骤（一篇搞定）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>springboot支付宝沙箱支付详细步骤</h4> 
 <ul><li><a href="#_1" rel="nofollow">支付宝沙箱环境配置</a></li><li><ul><li><a href="#_3" rel="nofollow">进入支付宝的开放平台——沙箱支付</a></li><li><a href="#_17" rel="nofollow">密钥的生成</a></li></ul> 
  </li><li><a href="#spring_boot__38" rel="nofollow">spring boot 环境配置</a></li><li><ul><li><a href="#pomxml_39" rel="nofollow">导入支付宝支付的依赖到pom.xml中</a></li><li><a href="#_applicationyml__54" rel="nofollow">在 application.yml 里面进行配置</a></li><li><a href="#alipayjavaAplipayConfigjava_63" rel="nofollow">alipay的java配置：AplipayConfig.java</a></li><li><a href="#_103" rel="nofollow">支付接口</a></li><li><a href="#_223" rel="nofollow">重要！前端配置！！</a></li></ul> 
  </li><li><a href="#_247" rel="nofollow">接口测试</a></li><li><a href="#Controller_253" rel="nofollow">回调接口在上面的Controller中配置</a></li><li><ul><li><a href="#httpsnatappcn_255" rel="nofollow">内网穿透：https://natapp.cn/</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>支付宝沙箱环境配置</h2> 
<h3><a id="_3"></a>进入支付宝的开放平台——沙箱支付</h3> 
<p><a href="https://open.alipay.com/develop/sandbox/app" rel="nofollow">沙箱环境</a><br> <strong>进入个人沙箱环境</strong></p> 
<blockquote> 
 <p>点击进入沙箱环境并用支付宝登陆</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/63/29/khFpcM6N_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>沙箱管理界面如图所示：</p> 
</blockquote> 
<p>appid，支付宝网关，自定义密钥等<br> <img src="https://images2.imgbox.com/a0/1f/ANu8PtAL_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>沙箱账号界面如图所示：</p> 
</blockquote> 
<p>这里是用来支付的账号和密码<br> <img src="https://images2.imgbox.com/4a/eb/INu7g8TG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_17"></a>密钥的生成</h3> 
<p><a href="https://opendocs.alipay.com/common/02kipk?pathHash=0d20b438" rel="nofollow">密钥工具下载</a></p> 
<p><img src="https://images2.imgbox.com/58/3f/8t2dgsyC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/76/35/eYaMGnVI_o.png" alt="在这里插入图片描述"></p> 
<p><em><strong>这时我们拿到两个密钥，将它们保存，这两个密钥很重要</strong></em></p> 
<ul><li>应用私钥</li><li>应用公钥</li></ul> 
<p><strong>拿到两个密钥后，进行自定义密钥配置</strong></p> 
<p>进入最开始的沙箱管理界面，点击自定义密钥，点击设置并查看，我们选择的是公钥模式<br> <img src="https://images2.imgbox.com/77/71/48Y3jKvp_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>在这里将上一步骤生成的应用公钥填进来</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/8e/d4/1CN74Tsj_o.png" alt="在这里插入图片描述"><br> 得到支付宝公钥这另一个密钥，记住并保存这个支付宝公钥<br> <img src="https://images2.imgbox.com/46/ec/v7dDsDoG_o.png" alt="在这里插入图片描述"><br> 至此，我们沙箱环境的配置和基本参数都已经获取到。</p> 
<h2><a id="spring_boot__38"></a>spring boot 环境配置</h2> 
<h3><a id="pomxml_39"></a>导入支付宝支付的依赖到pom.xml中</h3> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>        支付宝依赖沙箱支付 <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>sdk<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>alipay<span class="token operator">-</span>easysdk<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">2.2</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>        支付宝相关<span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>sdk<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>alipay<span class="token operator">-</span>sdk<span class="token operator">-</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">4.34</span><span class="token number">.0</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
</code></pre> 
<h3><a id="_applicationyml__54"></a>在 application.yml 里面进行配置</h3> 
<pre><code class="prism language-java">alipay<span class="token operator">:</span>
  appId<span class="token operator">:</span> 
  appPrivateKey<span class="token operator">:</span> 
  alipayPublicKey<span class="token operator">:</span> 
  notifyUrl<span class="token operator">:</span> 
</code></pre> 
<h3><a id="alipayjavaAplipayConfigjava_63"></a>alipay的java配置：AplipayConfig.java</h3> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kp<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">Factory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>kernel<span class="token punctuation">.</span></span><span class="token class-name">Config</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostConstruct</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span>
<span class="token comment">//读取yml文件中alipay 开头的配置</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"alipay"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliPayConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appPrivateKey<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> alipayPublicKey<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> notifyUrl<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 设置参数（全局只需设置一次）</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>protocol <span class="token operator">=</span> <span class="token string">"https"</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>gatewayHost <span class="token operator">=</span> <span class="token string">"openapi.alipaydev.com"</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>signType <span class="token operator">=</span> <span class="token string">"RSA2"</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>appId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appId<span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>merchantPrivateKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appPrivateKey<span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>alipayPublicKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>alipayPublicKey<span class="token punctuation">;</span>
        config<span class="token punctuation">.</span>notifyUrl <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>notifyUrl<span class="token punctuation">;</span>
        <span class="token class-name">Factory</span><span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=======支付宝SDK初始化成功======="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_103"></a>支付接口</h3> 
<p>新建一个 AliPayController.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kp<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>easysdk<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">Factory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>kp<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">AliPayConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>kp<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">AliPay</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>kp<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">Orders</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>kp<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">OrderMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transactional</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AlipayApiException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AlipayClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DefaultAlipayClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alipay<span class="token punctuation">.</span>api<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">AlipayTradePagePayRequest</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"alipay"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliPayController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">AliPayConfig</span> aliPayConfig<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderMapper</span> shopOrderMapper<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GATEWAY_URL</span> <span class="token operator">=</span><span class="token string">"https://openapi-sandbox.dl.alipaydev.com/gateway.do"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">FORMAT</span> <span class="token operator">=</span><span class="token string">"JSON"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CHARSET</span> <span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SIGN_TYPE</span> <span class="token operator">=</span><span class="token string">"RSA2"</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/pay"</span><span class="token punctuation">)</span> <span class="token comment">// &amp;subject=xxx&amp;traceNo=xxx&amp;totalAmount=xxx</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pay</span><span class="token punctuation">(</span><span class="token class-name">AliPay</span> aliPay<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">AlipayClient</span> alipayClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAlipayClient</span><span class="token punctuation">(</span><span class="token constant">GATEWAY_URL</span><span class="token punctuation">,</span> aliPayConfig<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                aliPayConfig<span class="token punctuation">.</span><span class="token function">getAppPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">FORMAT</span><span class="token punctuation">,</span> <span class="token constant">CHARSET</span><span class="token punctuation">,</span> aliPayConfig<span class="token punctuation">.</span><span class="token function">getAlipayPublicKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">SIGN_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AlipayTradePagePayRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlipayTradePagePayRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span>aliPayConfig<span class="token punctuation">.</span><span class="token function">getNotifyUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span><span class="token function">setBizContent</span><span class="token punctuation">(</span><span class="token string">"{\"out_trade_no\":\""</span> <span class="token operator">+</span> aliPay<span class="token punctuation">.</span><span class="token function">getTraceNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\","</span>
                <span class="token operator">+</span> <span class="token string">"\"total_amount\":\""</span> <span class="token operator">+</span> aliPay<span class="token punctuation">.</span><span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\","</span>
                <span class="token operator">+</span> <span class="token string">"\"subject\":\""</span> <span class="token operator">+</span> aliPay<span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\","</span>
                <span class="token operator">+</span> <span class="token string">"\"product_code\":\"FAST_INSTANT_TRADE_PAY\"}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> form <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 调用SDK生成表单</span>
            form <span class="token operator">=</span> alipayClient<span class="token punctuation">.</span><span class="token function">pageExecute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AlipayApiException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/html;charset="</span> <span class="token operator">+</span> <span class="token constant">CHARSET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 直接将完整的表单html输出到页面</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpResponse<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/notify"</span><span class="token punctuation">)</span>  <span class="token comment">// 注意这里必须是POST接口</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">payNotify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"trade_status"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TRADE_SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=========支付宝异步回调========"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> requestParams <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> requestParams<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                params<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// System.out.println(name + " = " + request.getParameter(name));</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">String</span> tradeNo <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> gmtPayment <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"gmt_payment"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> alipayTradeNo <span class="token operator">=</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 支付宝验签</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Factory<span class="token punctuation">.</span>Payment<span class="token punctuation">.</span>Common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">verifyNotify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 验签通过</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"交易名称: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"subject"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"交易状态: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trade_status"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"支付宝交易凭证号: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"商户订单号: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"out_trade_no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"交易金额: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"total_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"买家在支付宝唯一id: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"buyer_id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"买家付款时间: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"gmt_payment"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"买家付款金额: "</span> <span class="token operator">+</span> params<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"buyer_pay_amount"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 更新订单未已支付</span>
                <span class="token class-name">Orders</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Orders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>tradeNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                order.setCheckoutTime(params.get("gmt_payment"));</span>
                shopOrderMapper<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>参数 Alipay.java</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kp<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AliPay</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> traceNo<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> totalAmount<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> subject<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> alipayTraceNo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>注意：在拦截器里面加上 忽略alipay接口的配置，这很重要！</strong><br> <img src="https://images2.imgbox.com/a5/5d/a4P3lZkj_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_223"></a>重要！前端配置！！</h3> 
<blockquote> 
 <p>res.data.consignee以及其他两个参数都是下单时候的参数</p> 
</blockquote> 
<pre><code class="prism language-java">async <span class="token function">goToPaySuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        remark<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>note<span class="token punctuation">,</span>
        payMethod<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        addressBookId<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>address<span class="token punctuation">.</span>id
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> await <span class="token function">addOrderApi</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>'params<span class="token operator">:</span>'<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token char">'res:'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>code <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        window<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>`http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8090</span><span class="token operator">/</span>alipay<span class="token operator">/</span>pay<span class="token operator">?</span>subject<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>consignee<span class="token punctuation">}</span><span class="token operator">&amp;</span>traceNo<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&amp;</span>totalAmount<span class="token operator">=</span>$<span class="token punctuation">{<!-- --></span>res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>amount<span class="token punctuation">}</span>`<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token char">'付款成功'</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>$<span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> type<span class="token operator">:</span>'warning'<span class="token punctuation">,</span> message<span class="token operator">:</span>res<span class="token punctuation">.</span>msg<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
<h2><a id="_247"></a>接口测试</h2> 
<p>测试的url格式：</p> 
<blockquote> 
 <p>http://localhost:9090/alipay/paysubject=xxx&amp;traceNo=xxx&amp;totalAmount=1000<br> <img src="https://images2.imgbox.com/cf/e0/nddzl15H_o.png" alt="在这里插入图片描述"><br> 使用沙箱账号登录，支付就可以</p> 
</blockquote> 
<h2><a id="Controller_253"></a>回调接口在上面的Controller中配置</h2> 
<h3><a id="httpsnatappcn_255"></a>内网穿透：https://natapp.cn/</h3> 
<p>配置免费的隧道，端口：（你的项目端口）<br> <img src="https://images2.imgbox.com/29/d0/ya1AU6WT_o.png" alt="在这里插入图片描述"><br> 软件下载地址：<br> <a href="https://natapp.cn/#download" rel="nofollow">内网穿透软件下载</a></p> 
<p>下载好软件后，打开配置下authtoken：</p> 
<blockquote> 
 <p>参考这个步骤，把authtoken复制过来</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/fd/fa/jqhY3gN1_o.png" alt="在这里插入图片描述"><br> 双击启动 natapp.exe即可。<br> 看到这个表示你启动成功了：<br> <img src="https://images2.imgbox.com/7b/b0/m2Uw9Iwp_o.png" alt="在这里插入图片描述"><br> idea里面配置notify接口并测试<br> 更改 application.yml 里的配置：</p> 
<p><img src="https://images2.imgbox.com/fc/00/jNTgPX0S_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d9/43/guAshZX6_o.png" alt="在这里插入图片描述"></p> 
<p>至此，集成完毕！撒花！坑太多了！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cf7b2245bdcbfa5e4a09a24a986f7847/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">机器学习模型SHAP解释——R语言</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/df30baa425e2624fc10b3b2412fb3215/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">YOLOv8测试3：在Python中将YOLOv8模型封装成API接口使用（上传测试图片并返回识别结果，附测试代码）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>