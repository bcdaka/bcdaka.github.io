<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python—使用LangChain调用千帆大模型 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/da2d0574d972785e48526df27aea092b/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Python—使用LangChain调用千帆大模型">
  <meta property="og:description" content="文章目录 前言一、安装LangChain二、获取千帆API Key、Secret Key三、简单对话案例实现四、构建语言模型应用程序:LLM1.初始化模型2.LLM初始化和调用 五、提示词模板（PromptTemplate）: 管理 LLM 的提示1.定义提示模板2.组合 LLM 和提示词3.组合输出解析器 六、信息检索链(Retrieval Chain)1.加载索引数据2.存储向量数据3.创建检索链传入问题4.使用检索器动态选择最相关的文档并将其传递5.完整代码及调用 七、实现简单的聊天机器人1.聊天模型将使用消息进行响应。2.传入一个消息列表：3.使用ConversationChain记住过去的用户输入和模型输出4.对话5.聊天检索1)加载博客文章。2)将其拆分并存储在向量中3)创建会话记忆4)整体代码示例 总结 前言 LangChain就是一个 LLM 编程框架，你想开发一个基于 LLM 应用，需要什么组件它都有，直接使用就行；甚至针对常规的应用流程，它利用链(LangChain中Chain的由来)这个概念已经内置标准化方案了。
LangChain是一个用于开发由语言模型提供支持的应用程序的框架。它使应用程序能够：
数据感知：将语言模型连接到其他数据源具有代理性质：允许语言模型与其环境交互 名称网址LangChain中文网https://www.langchain.com.cn/LangChain官网https://www.langchain.com/LangChain API文档地址https://api.python.langchain.com/en/latest/langchain_api_reference.html# 环境：
名称版本Python3.9LangChain0.1.0 一、安装LangChain 此次我安装的最新版为：0.1.0
pip install langchain #安装qianfan pip install qianfan 二、获取千帆API Key、Secret Key 登录百度云搜索进入千帆大模型控制台没有应用则创建应用获取APIKey、SecretKey
三、简单对话案例实现 调用千帆大模型，实现让大模型讲个故事
&#34;&#34;&#34;For basic init and call&#34;&#34;&#34; import os from langchain_community.chat_models import QianfanChatEndpoint from langchain_core.messages import HumanMessage os.environ[&#34;QIANFAN_AK&#34;] = &#34;API_KEY&#34; os.environ[&#34;QIANFAN_SK&#34;] = &#34;SECRET_KEY&#34; chat = QianfanChatEndpoint( streaming=True, ) res = chat([HumanMessage(content=&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-07T20:28:56+08:00">
    <meta property="article:modified_time" content="2024-06-07T20:28:56+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python—使用LangChain调用千帆大模型</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li>前言</li><li>一、安装LangChain</li><li>二、获取千帆API Key、Secret Key</li><li>三、简单对话案例实现</li><li>四、构建语言模型应用程序:LLM</li><li><ul><li>1.初始化模型</li><li>2.LLM初始化和调用</li></ul> 
  </li><li>五、提示词模板（PromptTemplate）: 管理 LLM 的提示</li><li><ul><li>1.定义提示模板</li><li>2.组合 LLM 和提示词</li><li>3.组合输出解析器</li></ul> 
  </li><li>六、信息检索链(Retrieval Chain)</li><li><ul><li>1.加载索引数据</li><li>2.存储向量数据</li><li>3.创建检索链传入问题</li><li>4.使用检索器动态选择最相关的文档并将其传递</li><li>5.完整代码及调用</li></ul> 
  </li><li>七、实现简单的聊天机器人</li><li><ul><li>1.聊天模型将使用消息进行响应。</li><li>2.传入一个消息列表：</li><li>3.使用ConversationChain记住过去的用户输入和模型输出</li><li>4.对话</li><li>5.聊天检索</li><li><ul><li>1)加载博客文章。</li><li>2)将其拆分并存储在向量中</li><li>3)创建会话记忆</li><li>4)整体代码示例</li></ul> 
  </li></ul> 
  </li><li>总结</li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_6"></a>前言</h2> 
<p><strong>LangChain</strong>就是一个 LLM 编程框架，你想开发一个基于 LLM 应用，需要什么组件它都有，直接使用就行；甚至针对常规的应用流程，它利用链(LangChain中Chain的由来)这个概念已经内置标准化方案了。</p> 
<p><strong>LangChain</strong>是一个用于开发由语言模型提供支持的应用程序的框架。它使应用程序能够：</p> 
<ul><li><strong>数据感知</strong>：将语言模型连接到其他数据源</li><li><strong>具有代理性质</strong>：允许语言模型与其环境交互</li></ul> 
<table><thead><tr><th>名称</th><th>网址</th></tr></thead><tbody><tr><td>LangChain中文网</td><td><a href="https://www.langchain.com.cn/" rel="nofollow">https://www.langchain.com.cn/</a></td></tr><tr><td>LangChain官网</td><td><a href="https://www.langchain.com/" rel="nofollow">https://www.langchain.com/</a></td></tr><tr><td>LangChain API文档地址</td><td><a href="https://api.python.langchain.com/en/latest/langchain_api_reference.html#" rel="nofollow">https://api.python.langchain.com/en/latest/langchain_api_reference.html#</a></td></tr></tbody></table> 
<p><strong>环境：</strong></p> 
<table><thead><tr><th>名称</th><th>版本</th></tr></thead><tbody><tr><td>Python</td><td>3.9</td></tr><tr><td>LangChain</td><td>0.1.0</td></tr></tbody></table> 
<h2><a id="LangChain_28"></a>一、安装LangChain</h2> 
<p>此次我安装的最新版为：0.1.0</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> langchain
<span class="token comment">#安装qianfan</span>
pip <span class="token function">install</span> qianfan
</code></pre> 
<h2><a id="API_KeySecret_Key_37"></a>二、获取千帆API Key、Secret Key</h2> 
<ul><li>登录百度云搜索进入千帆大模型控制台</li><li>没有应用则创建应用</li><li>获取APIKey、SecretKey<br> <img src="https://images2.imgbox.com/19/6e/iXCtLujX_o.png" alt="在这里插入图片描述"></li></ul> 
<h2><a id="_42"></a>三、简单对话案例实现</h2> 
<blockquote> 
 <p>调用千帆大模型，实现让大模型讲个故事</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">"""For basic init and call"""</span>
<span class="token keyword">import</span> os

<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint
<span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>messages <span class="token keyword">import</span> HumanMessage

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_AK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"API_KEY"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_SK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SECRET_KEY"</span>

chat <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span>
    streaming<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
res <span class="token operator">=</span> chat<span class="token punctuation">(</span><span class="token punctuation">[</span>HumanMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"讲一个故事"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>content<span class="token punctuation">)</span>

</code></pre> 
<p>输出结果如下：<br> <img src="https://images2.imgbox.com/5c/15/omjyaAuU_o.png" alt="在这里插入图片描述"><br> 到此最简单的案例就已经实现了。</p> 
<h2><a id="LLM_66"></a>四、构建语言模型应用程序:LLM</h2> 
<p>LangChain 最基本的构建块是对某些输入调用 LLM。</p> 
<p>让我们来看一个简单的例子。</p> 
<p>我们假设我们正在构建一个基于公司产品生成公司名称的服务。</p> 
<h3><a id="1_73"></a>1.初始化模型</h3> 
<pre><code class="prism language-python"><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>llms <span class="token keyword">import</span> QianfanLLMEndpoint
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_AK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"API_KEY"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_SK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SECRET_KEY"</span>
llm <span class="token operator">=</span> QianfanLLMEndpoint<span class="token punctuation">(</span>temperature<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="2LLM_82"></a>2.LLM初始化和调用</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>llms <span class="token keyword">import</span> QianfanLLMEndpoint

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_AK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"API_KEY"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_SK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SECRET_KEY"</span>

llm <span class="token operator">=</span> QianfanLLMEndpoint<span class="token punctuation">(</span>temperature<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>

text <span class="token operator">=</span> <span class="token string">"对于一家生产彩色袜子的公司来说，什么是一个好的公司名称?"</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<h2><a id="PromptTemplate__LLM__96"></a>五、提示词模板（PromptTemplate）: 管理 LLM 的提示</h2> 
<p>调用 LLM 是很好的第一步，但这仅仅是个开始。</p> 
<p>通常在应用程序中使用 LLM 时，不会将用户输入直接发送到 LLM。</p> 
<p>相反，您可能接受用户输入并构造一个提示符，然后将其发送给 LLM。</p> 
<p>例如，在前一个示例中，我们传入的文本被硬编码为询问一家生产彩色袜子的公司的名称。在这个虚构的服务中，我们希望只获取描述公司业务的用户输入，然后用这些信息格式化提示符。</p> 
<h3><a id="1_104"></a>1.定义提示模板</h3> 
<ul><li>ChatPromptTemplate:是聊天提示词模板<br> <a href="https://api.python.langchain.com/en/latest/prompts/langchain_core.prompts.chat.ChatPromptTemplate.html?highlight=chatprompttemplate%20from_messages#" rel="nofollow">ChatPromptTemplate文档地址</a></li></ul> 
<pre><code class="prism language-python"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> ChatPromptTemplate

prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_messages<span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"我想去{location}旅游，能帮我简单介绍一下吗？"</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

</code></pre> 
<h3><a id="2_LLM__117"></a>2.组合 LLM 和提示词</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>llms <span class="token keyword">import</span> QianfanLLMEndpoint
<span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> ChatPromptTemplate

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_AK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"API_KEY"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_SK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SECRET_KEY"</span>

llm <span class="token operator">=</span> QianfanLLMEndpoint<span class="token punctuation">(</span>temperature<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>


prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_messages<span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"我想去{location}旅游，能帮我简单介绍一下吗？"</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

chat <span class="token operator">=</span> prompt <span class="token operator">|</span> llm
result <span class="token operator">=</span> chat<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"location"</span><span class="token punctuation">:</span> <span class="token string">"海南"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

</code></pre> 
<h3><a id="3_141"></a>3.组合输出解析器</h3> 
<p>ChatModel（因此，此链）的输出是一条消息。但是，使用字符串通常要方便得多。让我们添加一个简单的输出解析器，将聊天消息转换为字符串。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> StrOutputParser

output_parser <span class="token operator">=</span> StrOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>我们现在可以将其添加到上一个链中：</p> 
<pre><code class="prism language-python">chain <span class="token operator">=</span> prompt <span class="token operator">|</span> llm <span class="token operator">|</span> output_parser
</code></pre> 
<p>我们现在可以调用它并提出相同的问题。答案现在将是一个字符串（而不是 ChatMessage）。</p> 
<h2><a id="Retrieval_Chain_154"></a>六、信息检索链(Retrieval Chain)</h2> 
<p>实现目标：</p> 
<blockquote> 
 <p>提供一份文档，提出问题，在文档中检索出答案。我这里是提供了一个<a href="https://zhuanlan.zhihu.com/p/85289282" rel="nofollow">知乎-中国古代史-明朝</a>的网址。</p> 
</blockquote> 
<p>我们将从检索器中查找相关文档，然后将它们传递到提示中。 Retriever 可以由任何东西支持——SQL 表、互联网等——但在本例中，我们将填充一个向量存储并将其用作检索器。</p> 
<h3><a id="1_162"></a>1.加载索引数据</h3> 
<p>首先，我们需要加载要索引的数据：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> WebBaseLoader
WEB_URL <span class="token operator">=</span> <span class="token string">"https://zhuanlan.zhihu.com/p/85289282"</span>
<span class="token comment"># 使用WebBaseLoader加载HTML</span>
loader <span class="token operator">=</span> WebBaseLoader<span class="token punctuation">(</span>WEB_URL<span class="token punctuation">)</span>
docs <span class="token operator">=</span> loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2_172"></a>2.存储向量数据</h3> 
<p>接下来，我们需要将其索引到向量存储中。</p> 
<p>下载向量数据库Chroma</p> 
<pre><code class="prism language-python">pip install chromadb
</code></pre> 
<p>根据版本问题可能出现的问题：</p> 
<blockquote> 
 <p>问题：<br> Your system has an unsupported version of sqlite3. Chroma requires sqlite3 ＞= 3.35.0.</p> 
 <p>解决方案：<br> 根据自己的操作系统在 <a href="https://www.sqlite.org/download.html" rel="nofollow">SQLite Download Page </a>下载最新的sqlite包，解压后是"sqlite3.def"和"sqlite3.dll"两个文件。将这两个文件覆盖到 "python安装目录/DLLs"下即可。</p> 
</blockquote> 
<p>然后我们可以构建我们的索引：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>vectorstores <span class="token keyword">import</span> Chroma
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> QianfanEmbeddingsEndpoint
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>text_splitter <span class="token keyword">import</span> RecursiveCharacterTextSplitter
<span class="token comment"># 导入千帆向量模型</span>
embeddings <span class="token operator">=</span> QianfanEmbeddingsEndpoint<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 导入递归字符文本分割器</span>
text_splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">(</span>chunk_size <span class="token operator">=</span> <span class="token number">384</span><span class="token punctuation">,</span> chunk_overlap <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> separators<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"\n\n"</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"。"</span><span class="token punctuation">,</span> <span class="token string">"，"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 导入文本</span>
documents <span class="token operator">=</span> text_splitter<span class="token punctuation">.</span>split_documents<span class="token punctuation">(</span>docs<span class="token punctuation">)</span>
<span class="token comment"># 存入向量数据库</span>
vector <span class="token operator">=</span> Chroma<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span>documents<span class="token punctuation">,</span> embeddings<span class="token punctuation">)</span>

</code></pre> 
<h3><a id="3_208"></a>3.创建检索链传入问题</h3> 
<p>我们设置一个链，该链接受一个问题和检索到的文档并生成一个答案。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains<span class="token punctuation">.</span>combine_documents <span class="token keyword">import</span> create_stuff_documents_chain
<span class="token comment"># 创建提示词模板</span>
prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""使用下面的语料来回答本模板最末尾的问题。如果你不知道问题的答案，直接回答 "我不知道"，禁止随意编造答案。
        为了保证答案尽可能简洁，你的回答必须不超过三句话，你的回答中不可以带有星号。
        请注意！在每次回答结束之后，你都必须接上 "感谢你的提问" 作为结束语
        以下是一对问题和答案的样例：
            请问：秦始皇的原名是什么
            秦始皇原名嬴政。感谢你的提问。
        
        以下是语料：
&lt;context&gt;
{context}
&lt;/context&gt;

Question: {input}"""</span><span class="token punctuation">)</span>
<span class="token comment">#创建千帆LLM模型</span>
llm <span class="token operator">=</span> QianfanLLMEndpoint<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#创建检索链</span>
document_chain <span class="token operator">=</span> create_stuff_documents_chain<span class="token punctuation">(</span>llm<span class="token punctuation">,</span> prompt<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="4_232"></a>4.使用检索器动态选择最相关的文档并将其传递</h3> 
<pre><code class="prism language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> create_retrieval_chain

retriever <span class="token operator">=</span> vector<span class="token punctuation">.</span>as_retriever<span class="token punctuation">(</span><span class="token punctuation">)</span>
retrieval_chain <span class="token operator">=</span> create_retrieval_chain<span class="token punctuation">(</span>retriever<span class="token punctuation">,</span> document_chain<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="5_240"></a>5.完整代码及调用</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> create_retrieval_chain
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains<span class="token punctuation">.</span>combine_documents <span class="token keyword">import</span> create_stuff_documents_chain
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> WebBaseLoader
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> QianfanEmbeddingsEndpoint
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>vectorstores <span class="token keyword">import</span> Chroma
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>text_splitter <span class="token keyword">import</span> RecursiveCharacterTextSplitter
<span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> ChatPromptTemplate
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>llms <span class="token keyword">import</span> QianfanLLMEndpoint

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_AK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"API_KEY"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_SK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SECRET_KEY"</span>

<span class="token comment"># 定义URL</span>
WEB_URL <span class="token operator">=</span> <span class="token string">"https://zhuanlan.zhihu.com/p/85289282"</span>
<span class="token comment"># 使用WebBaseLoader加载HTML</span>
loader <span class="token operator">=</span> WebBaseLoader<span class="token punctuation">(</span>WEB_URL<span class="token punctuation">)</span>
docs <span class="token operator">=</span> loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 导入千帆向量模型</span>
embeddings <span class="token operator">=</span> QianfanEmbeddingsEndpoint<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 导入递归字符文本分割器</span>
text_splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">(</span>chunk_size <span class="token operator">=</span> <span class="token number">384</span><span class="token punctuation">,</span> chunk_overlap <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> separators<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"\n\n"</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"。"</span><span class="token punctuation">,</span> <span class="token string">"，"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 导入文本</span>
documents <span class="token operator">=</span> text_splitter<span class="token punctuation">.</span>split_documents<span class="token punctuation">(</span>docs<span class="token punctuation">)</span>
<span class="token comment"># 存入向量数据库</span>
vector <span class="token operator">=</span> Chroma<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span>documents<span class="token punctuation">,</span> embeddings<span class="token punctuation">)</span>

<span class="token comment"># 创建提示词模板</span>
prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""使用下面的语料来回答本模板最末尾的问题。如果你不知道问题的答案，直接回答 "我不知道"，禁止随意编造答案。
        为了保证答案尽可能简洁，你的回答必须不超过三句话，你的回答中不可以带有星号。
        请注意！在每次回答结束之后，你都必须接上 "感谢你的提问" 作为结束语
        以下是一对问题和答案的样例：
            请问：秦始皇的原名是什么
            秦始皇原名嬴政。感谢你的提问。
        
        以下是语料：
&lt;context&gt;
{context}
&lt;/context&gt;

Question: {input}"""</span><span class="token punctuation">)</span>
<span class="token comment">#创建千帆LLM模型</span>
llm <span class="token operator">=</span> QianfanLLMEndpoint<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#我们设置一个链，该链接受一个问题和检索到的文档并生成一个答案。</span>
document_chain <span class="token operator">=</span> create_stuff_documents_chain<span class="token punctuation">(</span>llm<span class="token punctuation">,</span> prompt<span class="token punctuation">)</span>
<span class="token comment">#使用检索器动态选择最相关的文档并将其传递。</span>
retriever <span class="token operator">=</span> vector<span class="token punctuation">.</span>as_retriever<span class="token punctuation">(</span><span class="token punctuation">)</span>
retrieval_chain <span class="token operator">=</span> create_retrieval_chain<span class="token punctuation">(</span>retriever<span class="token punctuation">,</span> document_chain<span class="token punctuation">)</span>
<span class="token comment">#调用这个链了。这将返回一个字典 - 来自 LLM 的响应在键中answer</span>
response <span class="token operator">=</span> retrieval_chain<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">"input"</span><span class="token punctuation">:</span> <span class="token string">"朱元璋时期中国多少人口?"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">[</span><span class="token string">"answer"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre> 
<p>结果示例：</p> 
<blockquote> 
 <p>抱歉，我无法得知朱元璋时期中国具体的人口数量。不过，我可以告诉你，在明朝时期，中国的人口数量在历史上经历了巨大的变化。明朝初年，由于元朝末年的战乱和瘟疫，人口数量相对较少。然而，随着时间的推移，明朝政府实行了一系列轻徭薄赋的政策，促进了社会经济的恢复和发展，人口数量也逐渐增加。在明朝中后期，由于农业、手工业和商业的繁荣，中国的人口数量达到了历史高峰。</p> 
</blockquote> 
<h2><a id="_303"></a>七、实现简单的聊天机器人</h2> 
<p>使用普通聊天模型，我们可以通过传递一个消息或使用ChatModel发送更多消息。</p> 
<h3><a id="1_306"></a>1.聊天模型将使用消息进行响应。</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema <span class="token keyword">import</span> HumanMessage<span class="token punctuation">,</span> SystemMessage
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_AK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"API_KEY"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_SK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SECRET_KEY"</span>

chat <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span><span class="token punctuation">)</span>
res <span class="token operator">=</span> chat<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">[</span>
    HumanMessage<span class="token punctuation">(</span>
        content<span class="token operator">=</span><span class="token string">"把这句话从中文翻译成英语:我喜欢编程。"</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>content<span class="token punctuation">)</span>

</code></pre> 
<blockquote> 
 <p>输出结果：I enjoy programming.</p> 
</blockquote> 
<h3><a id="2_328"></a>2.传入一个消息列表：</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema <span class="token keyword">import</span> HumanMessage<span class="token punctuation">,</span> SystemMessage
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_AK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"API_KEY"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_SK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SECRET_KEY"</span>

<span class="token comment">#使用默认的模型回答不正确，所以切换至模型：ERNIE-Bot-4</span>
chat <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'ERNIE-Bot-4'</span><span class="token punctuation">,</span>temperature<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">)</span>
res <span class="token operator">=</span> chat<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">[</span>
    SystemMessage<span class="token punctuation">(</span>
        content<span class="token operator">=</span><span class="token string">"你是把中文翻译成英文的得力助手。"</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    HumanMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"我喜欢编程。"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p>输出结果：I enjoy programming.</p> 
</blockquote> 
<h3><a id="3ConversationChain_351"></a>3.使用ConversationChain记住过去的用户输入和模型输出</h3> 
<p>然后，我们可以将聊天模型包装在<strong>ConversationChain</strong>中，它有内置内存，用于记住过去的用户输入和模型输出。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema <span class="token keyword">import</span> HumanMessage<span class="token punctuation">,</span> SystemMessage
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> ConversationChain
 
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_AK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"API_KEY"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_SK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SECRET_KEY"</span>

chat <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'ERNIE-Bot-4'</span><span class="token punctuation">,</span>temperature<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">)</span>
conversation <span class="token operator">=</span> ConversationChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>chat<span class="token punctuation">)</span>
res <span class="token operator">=</span> conversation<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"input"</span><span class="token punctuation">:</span><span class="token string">"你是把中文翻译成英文的得力助手:我喜欢编程"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#结果为： to English. Your sentence "我喜欢编程" translates to "I enjoy programming."</span>

res2<span class="token operator">=</span>conversation<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"input"</span><span class="token punctuation">:</span><span class="token string">"把他翻译成德语"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res2<span class="token punctuation">)</span>
<span class="token comment">#结果为：将其翻译成德语为 "Ich genieße das Programmieren.</span>
</code></pre> 
<h3><a id="4_374"></a>4.对话</h3> 
<p>我们通过ConversationBufferMemory可以指定我们的对话记录</p> 
<p>此案例是指定对话记录，继续进行对话。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> LLMChain
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>memory <span class="token keyword">import</span> ConversationBufferMemory
<span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> ChatPromptTemplate<span class="token punctuation">,</span> SystemMessagePromptTemplate<span class="token punctuation">,</span> MessagesPlaceholder<span class="token punctuation">,</span> \
    HumanMessagePromptTemplate

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_AK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"API_KEY"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_SK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SECRET_KEY"</span>

chat <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'ERNIE-Bot-4'</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">)</span>
prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_messages<span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
        SystemMessagePromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span>
            <span class="token string">"你是一个聊天机器人"</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        MessagesPlaceholder<span class="token punctuation">(</span>variable_name<span class="token operator">=</span><span class="token string">"chat_history"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        HumanMessagePromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">"{question}"</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
memory <span class="token operator">=</span> ConversationBufferMemory<span class="token punctuation">(</span>memory_key<span class="token operator">=</span><span class="token string">"chat_history"</span><span class="token punctuation">,</span> return_messages<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
memory<span class="token punctuation">.</span>save_context<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"input"</span><span class="token punctuation">:</span> <span class="token string">"你好"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">"output"</span><span class="token punctuation">:</span> <span class="token string">"你好，请问有什么我可以帮助你的吗？"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
memory<span class="token punctuation">.</span>save_context<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"input"</span><span class="token punctuation">:</span> <span class="token string">"把这句话从中文翻译成英语:我喜欢编程。"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">"output"</span><span class="token punctuation">:</span> <span class="token string">" I enjoy programming."</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
conversation <span class="token operator">=</span> LLMChain<span class="token punctuation">(</span>llm<span class="token operator">=</span>chat<span class="token punctuation">,</span> prompt<span class="token operator">=</span>prompt<span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> memory<span class="token operator">=</span>memory<span class="token punctuation">)</span>

<span class="token comment"># 注意，我们只是传入了“question”变量——“chat_history”由内存填充</span>
res <span class="token operator">=</span> conversation<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"question"</span><span class="token punctuation">:</span> <span class="token string">"现在把这个句子译成德语。"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>

</code></pre> 
<p>输出结果如下：<br> <img src="https://images2.imgbox.com/42/5b/4diP8hrx_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_412"></a>5.聊天检索</h3> 
<p>现在，假设我们想要与文档或其他知识来源聊天。</p> 
<p>这是一个流行的用例，结合了聊天和文档检索。</p> 
<p>它允许我们与模型没有训练过的特定信息进行聊天。</p> 
<h4><a id="1_420"></a>1)加载博客文章。</h4> 
<pre><code class="prism language-python"><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> WebBaseLoader
<span class="token comment"># 加载博客文章。</span>
loader <span class="token operator">=</span> WebBaseLoader<span class="token punctuation">(</span><span class="token string">"https://zhuanlan.zhihu.com/p/85289282"</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="2_428"></a>2)将其拆分并存储在向量中</h4> 
<pre><code class="prism language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>text_splitter <span class="token keyword">import</span> RecursiveCharacterTextSplitter

text_splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">(</span>chunk_size<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> chunk_overlap<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
all_splits <span class="token operator">=</span> text_splitter<span class="token punctuation">.</span>split_documents<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>vectorstores <span class="token keyword">import</span> Chroma
<span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> OpenAIEmbeddings

vectorstore <span class="token operator">=</span> Chroma<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span>documents<span class="token operator">=</span>all_splits<span class="token punctuation">,</span> embedding<span class="token operator">=</span>OpenAIEmbeddings<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="3_441"></a>3)创建会话记忆</h4> 
<pre><code class="prism language-python">memory <span class="token operator">=</span> ConversationSummaryMemory<span class="token punctuation">(</span>
    llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> memory_key<span class="token operator">=</span><span class="token string">"chat_history"</span><span class="token punctuation">,</span> return_messages<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> ConversationalRetrievalChain
<span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI

llm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span><span class="token punctuation">)</span>
retriever <span class="token operator">=</span> vectorstore<span class="token punctuation">.</span>as_retriever<span class="token punctuation">(</span><span class="token punctuation">)</span>
qa <span class="token operator">=</span> ConversationalRetrievalChain<span class="token punctuation">.</span>from_llm<span class="token punctuation">(</span>llm<span class="token punctuation">,</span> retriever<span class="token operator">=</span>retriever<span class="token punctuation">,</span> memory<span class="token operator">=</span>memory<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="4_457"></a>4)整体代码示例</h4> 
<pre><code class="prism language-python"><span class="token comment"># 聊天检索</span>
<span class="token keyword">import</span> os
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> ConversationChain<span class="token punctuation">,</span> LLMChain<span class="token punctuation">,</span> ConversationalRetrievalChain
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>memory <span class="token keyword">import</span> ConversationBufferMemory<span class="token punctuation">,</span> ConversationSummaryMemory
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> QianfanEmbeddingsEndpoint
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>vectorstores <span class="token keyword">import</span> Chroma
<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> WebBaseLoader
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>text_splitter <span class="token keyword">import</span> RecursiveCharacterTextSplitter

os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_AK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"API_KEY"</span>
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"QIANFAN_SK"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"SECRET_KEY"</span>

<span class="token comment"># 加载博客文章。</span>
loader <span class="token operator">=</span> WebBaseLoader<span class="token punctuation">(</span><span class="token string">"https://zhuanlan.zhihu.com/p/85289282"</span><span class="token punctuation">)</span>
data <span class="token operator">=</span> loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 将其拆分并存储在向量中。</span>
text_splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">(</span>chunk_size<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> chunk_overlap<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
all_splits <span class="token operator">=</span> text_splitter<span class="token punctuation">.</span>split_documents<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token comment"># 存储在向量中。</span>
vectorstore <span class="token operator">=</span> Chroma<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span>documents<span class="token operator">=</span>all_splits<span class="token punctuation">,</span> embedding<span class="token operator">=</span>QianfanEmbeddingsEndpoint<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 像以前一样创建我们的记忆，但是让我们使用 ConversationSummaryMemory</span>
retriever <span class="token operator">=</span> vectorstore<span class="token punctuation">.</span>as_retriever<span class="token punctuation">(</span><span class="token punctuation">)</span>

chat <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'ERNIE-Bot-4'</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">)</span>
memory <span class="token operator">=</span> ConversationSummaryMemory<span class="token punctuation">(</span>
    llm<span class="token operator">=</span>chat<span class="token punctuation">,</span> memory_key<span class="token operator">=</span><span class="token string">"chat_history"</span><span class="token punctuation">,</span> return_messages<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span>
qa <span class="token operator">=</span> ConversationalRetrievalChain<span class="token punctuation">.</span>from_llm<span class="token punctuation">(</span>llm<span class="token operator">=</span>chat<span class="token punctuation">,</span> retriever<span class="token operator">=</span>retriever<span class="token punctuation">,</span> memory<span class="token operator">=</span>memory<span class="token punctuation">)</span>

res <span class="token operator">=</span> qa<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"question"</span><span class="token punctuation">:</span> <span class="token string">"请帮我出3个明朝的题目并给出答案"</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">"answer"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre> 
<p>结果：<br> <img src="https://images2.imgbox.com/22/1c/Bk7MXF7N_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_499"></a>总结</h2> 
<p>LangCahin框架功能非常强大，但是要注意版本问题。在LangChain0.1.0版本之后很多写法就变了。英文官网上也是只有部分更新的新的写法，老写法也依然支持但是已经不推荐使用了。后续还会持续学习，会继续更新更多用法。</p> 
<p>存疑：由于是新手python选手，安装python环境直接使用最新的3.12版本装不上LangChain也换电脑试了还是不行被迫改为3.8或3.9。有懂的大佬可以评论讲解一下。</p> 
<p><code>本文很多文案和代码示例都来源于官网(略有修改)，有一些文案翻译的不对凑活看吧。</code></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fd27d64e7d00d7493f7c0dc91ec3d136/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">链表的回文结构OJ</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d33c9445ca466a4d3092851ce8531918/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mysql optimizer_switch : 查询优化器优化策略深入解析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>