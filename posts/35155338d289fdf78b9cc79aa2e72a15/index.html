<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL案例：MHA实现主备切换（主从架构）万字详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/35155338d289fdf78b9cc79aa2e72a15/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="MySQL案例：MHA实现主备切换（主从架构）万字详解">
  <meta property="og:description" content="目录
MHA
概念
MHA的组成
特点
案例介绍
（1）案例需求
（2）案例实现思路
（3）案例拓扑图
（4）案例环境
案例步骤
基本环境配置
关闭防火墙和内核安全机制
安装数据库
授权
主从复制的授权
高可用MHA的授权
部署主从架构
部署MHA
安装MHA
在所有节点安装node组件
换仓库源
免密连接
测试
安装manager组件
修改脚本和配置文件
测试免密登录
测试主从连接
配置IP
启动MHA
查看日志
测试
模拟故障
子接口vip的变化
修复
MHA MHA全称是MySQL Master High Availability，它是一款开源的高可用程序，‌专门为MySQL的主从复制架构设计，‌提供了自动化的主节点故障转移功能。‌
概念 是一套优秀的MySQL高可用环境下故障切换和主从复制的软件MySQL故障过程中，MHA能做到0-30秒内自动完成故障切换 MHA的组成 MHA Manager（管理节点）MHA Node（数据节点） 特点 在发生故障自动切换的过程中，MHA会尝试从故障的主服务器上保存二进制日志，最大程度保证数据不丢失使用半同步复制，可以大大降低数据丢失的风险目前MHA支持一主多从架构，最少3台服务器，也就是一主两从 案例介绍 （1）案例需求 本案例要求通过 MHA 监控 MySQL 数据库在故障时进行自动切换，不影响业务。
（2）案例实现思路 安装MySQL 数据库配置MySQL一主两从安装MHA软件配置无密码认证配置MySQL MHA 高可用模拟master故障切换 （3）案例拓扑图 （4）案例环境 主机
操作系统
IP 地址
角色
服务器
CentOS7.9">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-02T17:36:55+08:00">
    <meta property="article:modified_time" content="2024-08-02T17:36:55+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL案例：MHA实现主备切换（主从架构）万字详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="MHA-toc" style="margin-left:0px;"><a href="#MHA" rel="nofollow">MHA</a></p> 
<p id="%E6%A6%82%E5%BF%B5-toc" style="margin-left:40px;"><a href="#%E6%A6%82%E5%BF%B5" rel="nofollow">概念</a></p> 
<p id="MHA%E7%9A%84%E7%BB%84%E6%88%90-toc" style="margin-left:40px;"><a href="#MHA%E7%9A%84%E7%BB%84%E6%88%90" rel="nofollow">MHA的组成</a></p> 
<p id="%E7%89%B9%E7%82%B9-toc" style="margin-left:40px;"><a href="#%E7%89%B9%E7%82%B9" rel="nofollow">特点</a></p> 
<p id="%E6%A1%88%E4%BE%8B%E4%BB%8B%E7%BB%8D-toc" style="margin-left:0px;"><a href="#%E6%A1%88%E4%BE%8B%E4%BB%8B%E7%BB%8D" rel="nofollow">案例介绍</a></p> 
<p id="%EF%BC%881%EF%BC%89%E6%A1%88%E4%BE%8B%E9%9C%80%E6%B1%82-toc" style="margin-left:40px;"><a href="#%EF%BC%881%EF%BC%89%E6%A1%88%E4%BE%8B%E9%9C%80%E6%B1%82" rel="nofollow">（1）案例需求</a></p> 
<p id="%EF%BC%882%EF%BC%89%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF-toc" style="margin-left:40px;"><a href="#%EF%BC%882%EF%BC%89%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF" rel="nofollow">（2）案例实现思路</a></p> 
<p id="%EF%BC%883%EF%BC%89%E6%A1%88%E4%BE%8B%E6%8B%93%E6%89%91%E5%9B%BE-toc" style="margin-left:40px;"><a href="#%EF%BC%883%EF%BC%89%E6%A1%88%E4%BE%8B%E6%8B%93%E6%89%91%E5%9B%BE" rel="nofollow">（3）案例拓扑图</a></p> 
<p id="%EF%BC%884%EF%BC%89%E6%A1%88%E4%BE%8B%E7%8E%AF%E5%A2%83-toc" style="margin-left:40px;"><a href="#%EF%BC%884%EF%BC%89%E6%A1%88%E4%BE%8B%E7%8E%AF%E5%A2%83" rel="nofollow">（4）案例环境</a></p> 
<p id="%E6%A1%88%E4%BE%8B%E6%AD%A5%E9%AA%A4-toc" style="margin-left:0px;"><a href="#%E6%A1%88%E4%BE%8B%E6%AD%A5%E9%AA%A4" rel="nofollow">案例步骤</a></p> 
<p id="%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE-toc" style="margin-left:40px;"><a href="#%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE" rel="nofollow">基本环境配置</a></p> 
<p id="%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%E5%92%8C%E5%86%85%E6%A0%B8%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6-toc" style="margin-left:80px;"><a href="#%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%E5%92%8C%E5%86%85%E6%A0%B8%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6" rel="nofollow">关闭防火墙和内核安全机制</a></p> 
<p id="%E5%AE%89%E8%A3%85%E6%95%B0%E6%8D%AE%E5%BA%93-toc" style="margin-left:80px;"><a href="#%E5%AE%89%E8%A3%85%E6%95%B0%E6%8D%AE%E5%BA%93" rel="nofollow">安装数据库</a></p> 
<p id="%E6%8E%88%E6%9D%83-toc" style="margin-left:80px;"><a href="#%E6%8E%88%E6%9D%83" rel="nofollow">授权</a></p> 
<p id="%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%8E%88%E6%9D%83-toc" style="margin-left:120px;"><a href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%8E%88%E6%9D%83" rel="nofollow">主从复制的授权</a></p> 
<p id="%E9%AB%98%E5%8F%AF%E7%94%A8MHA%E7%9A%84%E6%8E%88%E6%9D%83-toc" style="margin-left:120px;"><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8MHA%E7%9A%84%E6%8E%88%E6%9D%83" rel="nofollow">高可用MHA的授权</a></p> 
<p id="%E9%83%A8%E7%BD%B2%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84-toc" style="margin-left:40px;"><a href="#%E9%83%A8%E7%BD%B2%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84" rel="nofollow">部署主从架构</a></p> 
<p id="%E9%83%A8%E7%BD%B2MHA-toc" style="margin-left:40px;"><a href="#%E9%83%A8%E7%BD%B2MHA" rel="nofollow">部署MHA</a></p> 
<p id="%E5%AE%89%E8%A3%85MHA-toc" style="margin-left:80px;"><a href="#%E5%AE%89%E8%A3%85MHA" rel="nofollow">安装MHA</a></p> 
<p id="%E5%9C%A8%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85node%E7%BB%84%E4%BB%B6-toc" style="margin-left:120px;"><a href="#%E5%9C%A8%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85node%E7%BB%84%E4%BB%B6" rel="nofollow">在所有节点安装node组件</a></p> 
<p id="%E6%8D%A2%E4%BB%93%E5%BA%93%E6%BA%90-toc" style="margin-left:160px;"><a href="#%E6%8D%A2%E4%BB%93%E5%BA%93%E6%BA%90" rel="nofollow">换仓库源</a></p> 
<p id="%E5%85%8D%E5%AF%86%E8%BF%9E%E6%8E%A5-toc" style="margin-left:120px;"><a href="#%E5%85%8D%E5%AF%86%E8%BF%9E%E6%8E%A5" rel="nofollow">免密连接</a></p> 
<p id="%E6%B5%8B%E8%AF%95-toc" style="margin-left:160px;"><a href="#%E6%B5%8B%E8%AF%95" rel="nofollow">测试</a></p> 
<p id="%E5%AE%89%E8%A3%85manager%E7%BB%84%E4%BB%B6-toc" style="margin-left:80px;"><a href="#%E5%AE%89%E8%A3%85manager%E7%BB%84%E4%BB%B6" rel="nofollow">安装manager组件</a></p> 
<p id="%E4%BF%AE%E6%94%B9%E8%84%9A%E6%9C%AC%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-toc" style="margin-left:120px;"><a href="#%E4%BF%AE%E6%94%B9%E8%84%9A%E6%9C%AC%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" rel="nofollow">修改脚本和配置文件</a></p> 
<p id="%E6%B5%8B%E8%AF%95%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95-toc" style="margin-left:120px;"><a href="#%E6%B5%8B%E8%AF%95%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95" rel="nofollow">测试免密登录</a></p> 
<p id="%E6%B5%8B%E8%AF%95%E4%B8%BB%E4%BB%8E%E8%BF%9E%E6%8E%A5-toc" style="margin-left:120px;"><a href="#%E6%B5%8B%E8%AF%95%E4%B8%BB%E4%BB%8E%E8%BF%9E%E6%8E%A5" rel="nofollow">测试主从连接</a></p> 
<p id="%E9%85%8D%E7%BD%AEIP-toc" style="margin-left:80px;"><a href="#%E9%85%8D%E7%BD%AEIP" rel="nofollow">配置IP</a></p> 
<p id="%E5%90%AF%E5%8A%A8MHA-toc" style="margin-left:80px;"><a href="#%E5%90%AF%E5%8A%A8MHA" rel="nofollow">启动MHA</a></p> 
<p id="%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97-toc" style="margin-left:120px;"><a href="#%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97" rel="nofollow">查看日志</a></p> 
<p id="%E6%B5%8B%E8%AF%95-toc" style="margin-left:40px;"><a href="#%E6%B5%8B%E8%AF%95" rel="nofollow">测试</a></p> 
<p id="%E6%A8%A1%E6%8B%9F%E6%95%85%E9%9A%9C-toc" style="margin-left:80px;"><a href="#%E6%A8%A1%E6%8B%9F%E6%95%85%E9%9A%9C" rel="nofollow">模拟故障</a></p> 
<p id="%E5%AD%90%E6%8E%A5%E5%8F%A3vip%E7%9A%84%E5%8F%98%E5%8C%96-toc" style="margin-left:120px;"><a href="#%E5%AD%90%E6%8E%A5%E5%8F%A3vip%E7%9A%84%E5%8F%98%E5%8C%96" rel="nofollow">子接口vip的变化</a></p> 
<p id="%E4%BF%AE%E5%A4%8D-toc" style="margin-left:80px;"><a href="#%E4%BF%AE%E5%A4%8D" rel="nofollow">修复</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="MHA">MHA</h2> 
<p>MHA全称是MySQL Master High Availability，它是一款开源的高可用程序，‌专门为MySQL的主从复制架构设计，‌提供了自动化的主节点故障转移功能。‌</p> 
<h3 id="%E6%A6%82%E5%BF%B5">概念</h3> 
<ul><li>是一套优秀的MySQL高可用环境下故障切换和主从复制的软件</li><li>MySQL故障过程中，MHA能做到0-30秒内自动完成故障切换</li></ul> 
<h3 id="MHA%E7%9A%84%E7%BB%84%E6%88%90">MHA的组成</h3> 
<ul><li>MHA Manager（管理节点）</li><li>MHA Node（数据节点）</li></ul> 
<h3 id="%E7%89%B9%E7%82%B9">特点</h3> 
<ul><li>在发生故障自动切换的过程中，MHA会尝试从故障的主服务器上保存二进制日志，最大程度保证数据不丢失</li><li>使用半同步复制，可以大大降低数据丢失的风险</li><li>目前MHA支持一主多从架构，最少3台服务器，也就是一主两从</li></ul> 
<h2 id="%E6%A1%88%E4%BE%8B%E4%BB%8B%E7%BB%8D">案例介绍</h2> 
<h3 id="%EF%BC%881%EF%BC%89%E6%A1%88%E4%BE%8B%E9%9C%80%E6%B1%82">（1）案例需求</h3> 
<p>本案例要求通过 MHA 监控 MySQL 数据库在故障时进行自动切换，不影响业务。</p> 
<h3 id="%EF%BC%882%EF%BC%89%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">（2）案例实现思路</h3> 
<ol><li>安装MySQL 数据库</li><li>配置MySQL一主两从</li><li>安装MHA软件</li><li>配置无密码认证</li><li>配置MySQL MHA 高可用</li><li>模拟master故障切换</li></ol> 
<h3 id="%EF%BC%883%EF%BC%89%E6%A1%88%E4%BE%8B%E6%8B%93%E6%89%91%E5%9B%BE">（3）案例拓扑图</h3> 
<p><img alt="" height="514" src="https://images2.imgbox.com/8e/43/cqLUn6A3_o.png" width="711"></p> 
<h3 id="%EF%BC%884%EF%BC%89%E6%A1%88%E4%BE%8B%E7%8E%AF%E5%A2%83">（4）案例环境</h3> 
<table><tbody><tr><td> <p style="text-align:center;"><strong><span style="color:#e7fafa;"><span style="background-color:#956fe7;">主机</span></span></strong></p> </td><td> <p style="text-align:center;"><strong><span style="color:#e7fafa;"><span style="background-color:#956fe7;">操作系统</span></span></strong></p> </td><td> <p style="text-align:center;"><strong><span style="color:#e7fafa;"><span style="background-color:#956fe7;">IP 地址</span></span></strong></p> </td><td> <p style="text-align:center;"><strong><span style="color:#e7fafa;"><span style="background-color:#956fe7;">角色</span></span></strong></p> </td></tr><tr><td> <p>服务器</p> </td><td> <p>CentOS7.9</p> </td><td> <p>192.168.10.101</p> </td><td> <p>管理节点，安装 node、manager 组件</p> </td></tr><tr><td> <p>服务器</p> </td><td> <p>CentOS7.9</p> </td><td> <p>192.168.10.102</p> </td><td> <p>Master 节点，安装 node 组件</p> </td></tr><tr><td> <p>服务器</p> </td><td> <p>CentOS7.9</p> </td><td> <p>192.168.10.103</p> </td><td> <p>Slave 节点，安装 node 组件</p> </td></tr><tr><td> <p>服务器</p> </td><td> <p>CentOS7.9</p> </td><td> <p>192.168.10.104</p> </td><td> <p>Slave 节点，安装 node 组件</p> </td></tr><tr><td> <p>测试机</p> </td><td> <p>CentOS7.9</p> </td><td> <p>192.168.10.105</p> </td><td> <p>作为客户端测试结果</p> </td></tr></tbody></table> 
<hr> 
<h2 id="%E6%A1%88%E4%BE%8B%E6%AD%A5%E9%AA%A4">案例步骤</h2> 
<h3 id="%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">基本环境配置</h3> 
<h4 id="%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%E5%92%8C%E5%86%85%E6%A0%B8%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6">关闭防火墙和内核安全机制</h4> 
<p>打开除了测试机的其他四台作为服务器的主机，都连接上XShell</p> 
<p>因为接下来有相同操作，右键终端空白处给4台数据库主机都开启会话同步</p> 
<p><img alt="" height="60" src="https://images2.imgbox.com/81/c8/gh2XhnHf_o.png" width="449"></p> 
<p>使用disable永久关闭防火墙，修改selinux文件来永久关闭内核安全机制，为了实现每个主机都能通过名称的方式互相通信，在hosts文件末尾追加以下内容</p> 
<pre><code class="language-bash">[root@localhost ~]# systemctl stop firewalld
[root@localhost ~]# systemctl disable firewalld
[root@localhost ~]# setenforce 0
[root@localhost ~]# vim /etc/sysconfig/selinux
SELINUX=disabled    # 修改参数为disabled
[root@localhost ~]# vim /etc/hosts
192.168.10.101 MHA-manager
192.168.10.102 Mysql1
192.168.10.103 Mysql2
192.168.10.104 Mysql3
# 保存并退出</code></pre> 
<h4 id="%E5%AE%89%E8%A3%85%E6%95%B0%E6%8D%AE%E5%BA%93">安装数据库</h4> 
<p>此时需要安装数据库，而101作为管理服务器的角色，用不到数据库所以不用安装，把101的会话同步关掉，然后安装数据库软件包</p> 
<p><img alt="" height="49" src="https://images2.imgbox.com/48/39/EZ5fBVU6_o.png" width="748"></p> 
<p>此时会话同步的主机应该是102、103、104，101是关闭会话同步的</p> 
<p><strong><span style="color:#e7fafa;"><span style="background-color:#956fe7;">在102输入</span></span></strong></p> 
<p>使用yum为3个主从服务器安装<span style="color:#956fe7;"><span style="background-color:#e7fafa;">mariadb</span></span>服务端</p> 
<pre><code class="language-bash">[root@localhost ~]# yum -y install mariadb-server</code></pre> 
<p>修改mysql的配置文件，在[<span style="color:#956fe7;"><span style="background-color:#e7fafa;">mysqld]</span></span>单元下方添加以下内容</p> 
<pre><code class="language-bash">[root@localhost ~]# vim /etc/my.cnf
[mysqld]
server-id=102
log-bin=master-bin
binlog-format=MIXED
relay-log-purge=0
log-slave-updates=true</code></pre> 
<ul><li>relay-log-purge：如果=1，表示在SQL线程执行完中继日志的语句后，删除掉该中继日志，如果=0，执行完语句后保留该日志 
  <ul><li>在高可用环境中，每一个节点都有可能成为主节点，所以要长期保存生成的日志信息，所以=0</li></ul></li><li>log-slave-updates：允许从节点同步主节点的数据并扩展给其他节点</li></ul> 
<p>因为开着会话同步，但是server-id的参数又不能重复，所以先<span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">关闭</span></strong></span>全部会话同步，然后修改另外两个主机的<span style="color:#956fe7;"><span style="background-color:#e7fafa;">server-id</span></span></p> 
<p><img alt="" height="60" src="https://images2.imgbox.com/58/8e/bjL998i5_o.png" width="449"></p> 
<pre><code class="language-bash"># 103主机改为：
server-id=103
# 104主机改为：
server-id=104</code></pre> 
<h4 id="%E6%8E%88%E6%9D%83">授权</h4> 
<p>然后再开启会话同步，和刚才一样，把101的会话同步关闭，只同步三台服务器的会话</p> 
<p><img alt="" height="60" src="https://images2.imgbox.com/b6/36/pD9vECu1_o.png" width="449"></p> 
<p><img alt="" height="49" src="https://images2.imgbox.com/01/d6/UqjLBBp6_o.png" width="748"></p> 
<p><strong><span style="color:#e7fafa;"><span style="background-color:#956fe7;">在102输入</span></span></strong></p> 
<p>启动mariadb数据库，设置密码，然后登录进去</p> 
<pre><code class="language-bash">[root@Mysql1 ~]# systemctl start mariadb
[root@Mysql1 ~]# mysqladmin -uroot password 'pwd123'</code></pre> 
<h5 id="%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%8E%88%E6%9D%83">主从复制的授权</h5> 
<p>使用grant语句授权给从服务器可以访问所有库的所有表</p> 
<pre><code class="language-sql">MariaDB [(none)]&gt; grant replication slave on *.* to 'myslave'@'192.168.10.%' identified by '123456';</code></pre> 
<h5 id="%E9%AB%98%E5%8F%AF%E7%94%A8MHA%E7%9A%84%E6%8E%88%E6%9D%83">高可用MHA的授权</h5> 
<p>指定网段和主机名的连接权限</p> 
<blockquote> 
 <p>MHA是整个架构的管理者，所以授权设为all，因为mha的权限很大。所以mha的权限应该授权给装有MHA的主机来使用</p> 
</blockquote> 
<p>如果要基于IP地址来连接：可以指定为IP地址</p> 
<p>如果要基于主机名来连接：可以指定为主机名，比如：<span style="color:#ffd900;"><span style="background-color:#0d0016;">'mha'@'Mysql1'</span></span></p> 
<blockquote> 
 <p>如果觉得192.168.10.0的网段范围太大了，可以单独指定多个IP设置</p> 
</blockquote> 
<pre><code class="language-sql">MariaDB [(none)]&gt; grant all privileges on *.* to 'mha'@'192.168.10.%' identified by 'manager';
MariaDB [(none)]&gt; grant all privileges on *.* to 'mha'@'Mysql1' identified by 'manager';
MariaDB [(none)]&gt; grant all privileges on *.* to 'mha'@'Mysql2' identified by 'manager';
MariaDB [(none)]&gt; grant all privileges on *.* to 'mha'@'Mysql3' identified by 'manager';
MariaDB [(none)]&gt; flush privileges;    # 刷新权限</code></pre> 
<p>输入完上方的语句就可以<span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">关闭</span></strong></span>会话同步了</p> 
<p><img alt="" height="60" src="https://images2.imgbox.com/95/7e/Cp1crj0s_o.png" width="449"></p> 
<hr> 
<h3 id="%E9%83%A8%E7%BD%B2%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84">部署主从架构</h3> 
<p>在实现高可用多主复制之前，要由MHA程序来确定，在安装MHA之前，要先部署出一个普通的主从架构</p> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在102输入</span></strong></span></p> 
<p>这里我们先让102主机作为主服务器，使用<span style="color:#ffd900;"><span style="background-color:#0d0016;">show</span></span>命令查看主服务器上的二进制日志的状态信息，以便后续使用</p> 
<pre><code class="language-sql">MariaDB [(none)]&gt; show master status;
+-------------------+----------+--------------+------------------+
| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+-------------------+----------+--------------+------------------+
| master-bin.000003 |     1196 |              |                  |
+-------------------+----------+--------------+------------------+</code></pre> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在103、104输入</span></strong></span></p> 
<p>这里102和103的操作是一样的，所以再开启会话同步，但是注意只同步103和104两个从服务器的输入</p> 
<p><img alt="" height="60" src="https://images2.imgbox.com/de/97/2N95OVI5_o.png" width="449"></p> 
<p>使用change语句修改主从复制的参数设置，指定主服务器的IP、连接的用户、密码、二进制日志文件名、二进制日志文件中语句的位置</p> 
<p>这里使用的二进制日志名和位置，就是刚才在102主服务器使用<span style="color:#ffd900;"><span style="background-color:#0d0016;">show master status;</span></span>查询到的信息</p> 
<p>然后开启从服务器的复制（<span style="color:#ffd900;"><span style="background-color:#0d0016;">start slave;</span></span>）再使用<span style="color:#ffd900;"><span style="background-color:#0d0016;">show</span></span>命令查看从服务器的状态信息，确保IO线程和SQL线程状态都是YES</p> 
<pre><code class="language-sql">MariaDB [(none)]&gt; change master to master_host='192.168.10.102', master_user='myslave', master_password='123456', master_log_file='master-bin.000003', master_log_pos=1196;
MariaDB [(none)]&gt; start slave;
MariaDB [(none)]&gt; show slave status\G;
Slave_IO_Running: Yes
Slave_SQL_Running: Yes</code></pre> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">关闭会话同步</span></strong></span></p> 
<p><img alt="" height="60" src="https://images2.imgbox.com/e3/26/RMUUePkE_o.png" width="449"></p> 
<hr> 
<h3 id="%E9%83%A8%E7%BD%B2MHA">部署MHA</h3> 
<h4 id="%E5%AE%89%E8%A3%85MHA">安装MHA</h4> 
<h5 id="%E5%9C%A8%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85node%E7%BB%84%E4%BB%B6">在所有节点安装node组件</h5> 
<p>确保所有主机都在终端界面，如果在数据库内的终端，要使用quit命令回到bash终端并且直接输入cd命令回到root用户家目录</p> 
<p><span style="color:#956fe7;"><span style="background-color:#e7fafa;">然后再次同步所有主机的会话输入，注意是所有主机</span></span></p> 
<p><strong><span style="color:#e7fafa;"><span style="background-color:#956fe7;">在101操作</span></span></strong></p> 
<p>把下图的软件包导入进每个主机中</p> 
<p><img alt="" height="32" src="https://images2.imgbox.com/7d/ce/hhq9JQhZ_o.png" width="232"></p> 
<h6 id="%E6%8D%A2%E4%BB%93%E5%BA%93%E6%BA%90">换仓库源</h6> 
<p>因为需要安装MHA所需要的依赖环境，所以这里把仓库源换成阿里云的yum仓库</p> 
<p>直接把下方的四行命令全部复制，然后粘贴到终端里回车</p> 
<pre><code class="language-bash">rm -rf /etc/yum.repos.d/*
curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo
yum clean all</code></pre> 
<p>使用yum命令安装所以相关依赖软件包，如下</p> 
<pre><code class="language-bash">yum install -y perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker perl-CPAN</code></pre> 
<ul><li>perl-DBD-MySQL：因为MHA是perl语言编写的，所以要使用perl来管理mysql数据库</li><li>perl-Config-Tiny：从配置文件中提取值</li><li>perl-Log-Dispatch：日志功能</li><li>perl-Parallel-ForkManage：多线程管理</li><li>perl-ExtUtils-CBuilde：用于编译和构建 C 语言扩展模块</li><li>perl-ExtUtils-MakeMaker：用于自动生成 Makefile，它简化了Perl模块的发布和安装过程</li><li>perl-CPAN：是Perl的一个资源库和分发系统，提供了数千个Perl模块和工具的集合</li></ul> 
<p>安装完后，解压刚才导入的mha软件包，然后cd进入解压目录</p> 
<pre><code class="language-bash">[root@MHA-manager ~]# tar zxvf mha4mysql-node-0.57.tar.gz
[root@MHA-manager ~]# cd mha4mysql-node-0.57</code></pre> 
<p>使用perl命令执行perl脚本，目的是生成一个名为 Makefile 的文件。这个 Makefile 包含了安装和编译所需的指令</p> 
<p>然后编译，安装。<span style="color:#e7fafa;"><span style="background-color:#956fe7;">注意检查4个会话同步的主机是否操作正常</span></span></p> 
<pre><code class="language-bash">[root@MHA-manager mha4mysql-node-0.57]# perl Makefile.PL
[root@MHA-manager mha4mysql-node-0.57]# make &amp;&amp; make install
[root@MHA-manager mha4mysql-node-0.57]# cd    # 回到root用户家目录</code></pre> 
<hr> 
<h5 id="%E5%85%8D%E5%AF%86%E8%BF%9E%E6%8E%A5">免密连接</h5> 
<p>因为要通过MHA在其他节点之间进行通信和操作，实现免密登录时为了可以安全而无缝（快速响应）的远程操作和管理</p> 
<p>所以需要在所有主机上都生成密钥对，此时的会话同步不用改变</p> 
<pre><code class="language-bash">[root@MHA-manager ~]# ssh-keygen -t rsa
# 回车直到显示终端，密钥对生成成功</code></pre> 
<p><span style="color:#e7fafa;"><span style="background-color:#956fe7;">此时关闭所有会话同步</span></span></p> 
<p>因为接下来的操作不一致，步骤繁琐</p> 
<ol><li>MHA服务器（101）要把公钥发送给主从服务器（102、103、104）</li><li>主服务器（102）要把公钥发送给两个从服务器（103、104）</li><li>1号从服务器（103）要把公钥发送给主服务器（102）和2号从服务器（104）</li><li>2号从服务器（104）要把公钥发送给主服务器（102）和1号从服务器（103）</li></ol> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">还是在MHA服务器（101）操作</span></strong></span></p> 
<p>使用<span style="color:#ffd900;"><span style="background-color:#0d0016;">ssh-copy-id</span></span>指定要发送公钥的主机IP，<span style="color:#956fe7;"><span style="background-color:#e7fafa;">交互界面</span></span>输入yes，再输入该主机的密码</p> 
<pre><code class="language-bash">[root@MHA-manager ~]# ssh-copy-id 192.168.10.102
[root@MHA-manager ~]# ssh-copy-id 192.168.10.103
[root@MHA-manager ~]# ssh-copy-id 192.168.10.104</code></pre> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">来到主服务器（102）操作</span></strong></span></p> 
<p>步骤同上，拷贝公钥到两个从服务器</p> 
<pre><code class="language-bash">[root@Mysql1 ~]# ssh-copy-id 192.168.10.103
[root@Mysql1 ~]# ssh-copy-id 192.168.10.104</code></pre> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">来到1号从服务器（103）操作</span></strong></span></p> 
<p>步骤同上，拷贝公钥到主服务器和2号从服务器</p> 
<pre><code class="language-bash">[root@Mysql2 ~]# ssh-copy-id 192.168.10.102
[root@Mysql2 ~]# ssh-copy-id 192.168.10.104</code></pre> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">来到2号从服务器（104）操作</span></strong></span></p> 
<p>步骤同上，拷贝公钥到主服务器和1号从服务器</p> 
<pre><code class="language-bash">[root@Mysql3 ~]# ssh-copy-id 192.168.10.102
[root@Mysql3 ~]# ssh-copy-id 192.168.10.103</code></pre> 
<h6 id="%E6%B5%8B%E8%AF%95">测试</h6> 
<p>在104主机连接102和103，如果都是直接登录进去，就说明免密登录实现成功了</p> 
<pre><code class="language-bash">[root@mysql3 ~]# ssh 192.168.10.102
[root@mysql1 ~]# exit
[root@mysql3 ~]# ssh 192.168.10.103
[root@mysql2 ~]# exit</code></pre> 
<hr> 
<h4 id="%E5%AE%89%E8%A3%85manager%E7%BB%84%E4%BB%B6">安装manager组件</h4> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">回到MHA服务器（101）操作</span></strong></span></p> 
<p>导入MHA的manager组件到MHA服务器（101）准备安装</p> 
<p><img alt="" height="29" src="https://images2.imgbox.com/b4/4d/vpNgeslN_o.png" width="256"></p> 
<p>解压、进入解压目录、配置、编译、安装</p> 
<pre><code class="language-bash">[root@MHA-manager ~]# tar zxvf mha4mysql-manager-0.57.tar.gz
[root@MHA-manager ~]# cd mha4mysql-manager-0.57
[root@MHA-manager mha4mysql-manager-0.57]# perl Makefile.PL
[root@MHA-manager mha4mysql-manager-0.57]# make &amp;&amp; make install</code></pre> 
<h5 id="%E4%BF%AE%E6%94%B9%E8%84%9A%E6%9C%AC%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">修改脚本和配置文件</h5> 
<p>在manager解压目录下，samples目录下的scripts目录，存放着管理脚本，作用分别如下</p> 
<ul><li>master_ip_failover：自动切换vip（Vrtual IP）</li><li>master_ip_online_change：在线切换vip</li><li>power_manager：故障发生后关闭主机的脚本</li><li>send_report：因故障切换后发送报告的脚本</li></ul> 
<blockquote> 
 <p>这里的VIP指的是一个虚拟IP，这个IP是整个MySQL的集群对外的一个IP，在集群中，哪个主机时master就用这个IP</p> 
</blockquote> 
<p>最后拷贝这些脚本到<span style="color:#ffd900;"><span style="background-color:#0d0016;">/usr/local/bin</span></span>目录下，能够方便的在终端使用脚本</p> 
<pre><code class="language-bash">[root@MHA-manager mha4mysql-manager-0.57]# cd samples
[root@MHA-manager samples]# cd scripts/
[root@MHA-manager scripts]# ls
master_ip_failover  master_ip_online_change  power_manager  send_report
[root@MHA-manager scripts]# cp * /usr/local/bin/</code></pre> 
<p>cd进入<span style="color:#ffd900;"><span style="background-color:#0d0016;">/usr/local/bin</span></span>目录下，打开刚才拷贝过来的文件</p> 
<pre><code class="language-bash">[root@MHA-manager scripts]# cd /usr/local/bin/
[root@MHA-manager bin]# vim master_ip_failover</code></pre> 
<p>把以下内容全部替换到<span style="color:#ffd900;"><span style="background-color:#0d0016;">master_ip_failover</span></span>文件中</p> 
<p>因为vim编辑器会在上一行带有#的情况下，为下方复制的所有行也添加#注释。</p> 
<p>所以先单独复制指定解释器的这一行，再复制下方内容。或者使用vi编辑器而不是vim编辑器复制</p> 
<pre><code class="language-bash">#!/usr/bin/env perl</code></pre> 
<p> 再添加下方内容</p> 
<pre><code class="language-bash">
use strict;
use warnings FATAL =&gt; 'all';
use Getopt::Long;
my (
$command,
$ssh_user,
$orig_master_host,
$orig_master_ip,
$orig_master_port,
$new_master_host, $new_master_ip, $new_master_port
);
my $vip = '192.168.10.200/24';
my $key = '1';
my $ssh_start_vip = "/usr/sbin/ifconfig ens33:$key $vip up";
my $ssh_stop_vip = "/usr/sbin/ifconfig ens33:$key down";
GetOptions(
'command=s' =&gt; \$command,
'ssh_user=s' =&gt; \$ssh_user,
'orig_master_host=s' =&gt; \$orig_master_host,
'orig_master_ip=s' =&gt; \$orig_master_ip,
'orig_master_port=i' =&gt; \$orig_master_port,
'new_master_host=s' =&gt; \$new_master_host,
'new_master_ip=s' =&gt; \$new_master_ip,
'new_master_port=i' =&gt; \$new_master_port,
);
exit &amp;main();
sub main {
print "\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n";
if ( $command eq "stop" || $command eq "stopssh" ) {
my $exit_code = 1;
eval {
print "Disabling the VIP on old master: $orig_master_host \n";
&amp;stop_vip();
$exit_code = 0;
};
if ($@) {
warn "Got Error: $@\n";
exit $exit_code;
}
exit $exit_code;
}
elsif ( $command eq "start" ) {
my $exit_code = 10;
eval {
print "Enabling the VIP - $vip on the new master - $new_master_host \n";
&amp;start_vip();
$exit_code = 0;
};
if ($@) {
warn $@;
exit $exit_code;
}
exit $exit_code;
}
elsif ( $command eq "status" ) {
print "Checking the Status of the script.. OK \n";
exit 0;
}
else {
&amp;usage();
exit 1;
}
}
sub start_vip() {
`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`;
}
sub stop_vip() {
return 0 unless ($ssh_user);
`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`;
}
sub usage {
print
"Usage: master_ip_failover --command=start | stop | stopssh | status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n";
}</code></pre> 
<p>首先在<span style="color:#ffd900;"><span style="background-color:#0d0016;">/etc/</span></span>下创建一个用于放置配置文件的目录，然后在manager解压目录的<span style="color:#ffd900;"><span style="background-color:#0d0016;">samples/conf目录</span></span>下，拷贝<span style="color:#ffd900;"><span style="background-color:#0d0016;">app1</span></span>配置文件到刚才创建的<span style="color:#ffd900;"><span style="background-color:#0d0016;">masterha目录</span></span>，然后打开拷贝过去的该文件</p> 
<pre><code class="language-bash">[root@MHA-manager bin]# cd /etc
[root@MHA-manager etc]# mkdir masterha
[root@MHA-manager etc]# cd /root/mha4mysql-manager-0.57/samples/conf/
[root@MHA-manager conf]# cp app1.cnf /etc/masterha/
[root@MHA-manager conf]# vim /etc/masterha/app1.cnf</code></pre> 
<p>把下方内容全部替换到<span style="color:#956fe7;"><span style="background-color:#e7fafa;">app1.cnf</span></span>文件中</p> 
<p>其中的工作目录，我们的系统中还没有，所以<span style="color:#ffd900;"><span style="background-color:#0d0016;">mkdir -p /var/log/masterha/app1</span></span>创建出来</p> 
<ul><li>第5行的二进制日志文件位置，注意要对应主服务器上存放二进制日志的路径</li><li>第14行指定的两个备用的从主机要改为对应的两个从服务器的IP</li></ul> 
<pre><code class="language-bash">[server default] 
manager_workdir=/var/log/masterha/app1 
manager_log=/var/log/masterha/app1/manager.log 
master_binlog_dir=/var/lib/mysql
master_ip_failover_script= /usr/local/bin/master_ip_failover 
master_ip_online_change_script= /usr/local/bin/master_ip_online_change 
user=mha 
password=manager 
ping_interval=1 
remote_workdir=/tmp 
repl_user=myslave 
repl_password=123456 
secondary_check_script= /usr/local/bin/masterha_secondary_check -s 192.168.10.103 -s 192.168.10.104
shutdown_script="" 
ssh_user=root 
[server1] 
hostname=192.168.10.102 
port=3306 
[server2] 
hostname=192.168.10.103
port=3306 
candidate_master=1 
check_repl_delay=0 
[server3] 
hostname=192.168.10.104 
port=3306</code></pre> 
<p>同样的内容，下方是一些对应注释</p> 
<p>注意：下方带注释的内容不要复制进<span style="color:#956fe7;"><span style="background-color:#e7fafa;">app1.cnf</span></span>中，可能会影响配置文件的使用</p> 
<pre><code class="language-bash">[server default]
manager_workdir=/var/log/masterha/app1            # 工作目录，如果没有需要创建出来
manager_log=/var/log/masterha/app1/manager.log    # 生成的日志文件名
#master_binlog_dir=/usr/local/mysql/data 
master_binlog_dir=/var/lib/mysql                  # 日志文件位置
master_ip_failover_script= /usr/local/bin/master_ip_failover    # 指定自动切换VIP脚本的位置
master_ip_online_change_script= /usr/local/bin/master_ip_online_change    # 指定在线切换VIP脚本的位置
user=mha    # 对应之前在主服务器授权给mha的用户
password=manager  # 对应之前在主服务器授权给mha用户的密码
ping_interval=1
remote_workdir=/tmp
repl_user=myslave       # 主从复制连接用的用户
repl_password=123456    # 主从复制连接的密码
secondary_check_script= /usr/local/bin/masterha_secondary_check -s 192.168.10.103 -s 192.168.10.104  # 指定脚本，检查作为备用的两个从主机的状态
shutdown_script=""
ssh_user=root
[server1]  # 对应主服务器
hostname=192.168.10.102
port=3306
[server2]  # 对应从服务器
hostname=192.168.10.103
port=3306
candidate_master=1  # 如果master故障了，优先候选的master是[server2]
check_repl_delay=0  # 检查复制延迟，0表示忽略
[server3]  # 对应从服务器
hostname=192.168.10.104
port=3306
</code></pre> 
<p>保存并退出</p> 
<hr> 
<h5 id="%E6%B5%8B%E8%AF%95%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95">测试免密登录</h5> 
<p>使用命令测试ssh的免密登录，如果正常会输出下方代码块最后一行内容</p> 
<p>这里如果出错了，一般就是<span style="color:#e7fafa;"><span style="background-color:#956fe7;">免密登录</span></span>有问题或者<span style="color:#956fe7;"><span style="background-color:#e7fafa;">app1.cnf</span></span>的文件配置有问题</p> 
<pre><code class="language-bash">[root@MHA-manager ~]# masterha_check_ssh -conf=/etc/masterha/app1.cnf
Fri Aug  2 10:53:05 2024 - [info] All SSH connection tests passed successfully.    # 出现这行表示成功</code></pre> 
<h5 id="%E6%B5%8B%E8%AF%95%E4%B8%BB%E4%BB%8E%E8%BF%9E%E6%8E%A5">测试主从连接</h5> 
<p>测试mysql主从连接的情况，如果正常会输出下方代码块最后一行内容</p> 
<p>这里如果出错哦了，有可能是授权或配置文件出问题了，可以去数据库使用<span style="color:#ffd900;"><span style="background-color:#0d0016;">show slave status;</span></span>查看状态来排除</p> 
<pre><code class="language-bash">[root@MHA-manager ~]# masterha_check_repl -conf=/etc/masterha/app1.cnf
MySQL Replication Health is OK.    # 出现这行表示成功</code></pre> 
<hr> 
<h4 id="%E9%85%8D%E7%BD%AEIP">配置IP</h4> 
<p>这里配置的IP是刚才在配置文件中指定的VIP，由于这个IP我们还没有定义出来，所以需要先创建出来</p> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在102操作</span></strong></span></p> 
<p>因为虚拟IP是会随着master的变更而转移的，所以直接创建一个临时的子接口就行了</p> 
<p>使用<span style="color:#956fe7;"><span style="background-color:#e7fafa;">ifconfig</span></span>命令创建一个临时的子接口，指定接口IP为<span style="color:#956fe7;"><span style="background-color:#e7fafa;">192.168.10.200</span></span>，然后使用<span style="color:#956fe7;"><span style="background-color:#e7fafa;">ifconfig</span></span>查看是否创建成功</p> 
<pre><code class="language-bash">[root@Mysql1 ~]# ifconfig ens33:1 192.168.10.200
[root@Mysql1 mysql]# ifconfig
ens33:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.10.200  netmask 255.255.255.0  broadcast 192.168.10.255</code></pre> 
<hr> 
<h4 id="%E5%90%AF%E5%8A%A8MHA">启动MHA</h4> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在101操作</span></strong></span></p> 
<p>启动MHA 管理器，并且以后台进程的方式运行，同时将日志记录到指定的文件中，忽略任何可能的标准输入，并配置好在发现主服务器不可用时自动移除，并忽略最后一次故障转移的历史记录</p> 
<pre><code class="language-bash">[root@MHA-manager ~]# nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt;/dev/null&gt; /var/log/masterha/app1/manager.log 2&gt;&amp;1 &amp;</code></pre> 
<table><tbody><tr><td style="width:252px;"> <p style="text-align:center;"><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">参数</span></strong></span></p> </td><td style="width:436px;"> <p style="text-align:center;"><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">说明</span></strong></span></p> </td></tr><tr><td style="width:252px;"> <p style="text-align:center;">nohup</p> </td><td style="width:436px;"> <p>全称 no hang up（不挂起），用于在系统后台不挂起地运行命令，退出终端不会影响程序的运行。</p> </td></tr><tr><td style="width:252px;"> <p style="text-align:center;">--conf</p> </td><td style="width:436px;"> <p>指定配置文件的路径</p> </td></tr><tr><td style="width:252px;"> <p style="text-align:center;">--remove_dead_master_conf</p> </td><td style="width:436px;"> <p>当发生主从切换后，老的主库的 IP 地址将会从配置文件中移除</p> <p>确保MHA不会继续尝试连接已经不可用的主服务器</p> </td></tr><tr><td style="width:252px;"> <p style="text-align:center;">--ignore_last_failover</p> </td><td style="width:436px;"> <p>这个选项告诉MHA忽略最后一次故障转移的历史记录。</p> <p>在某些情况下，如果你希望MHA不考虑上一次的故障转移事件，可以使用这个选项。</p> </td></tr><tr><td style="text-align:center;width:252px;"></td><td style="width:436px;"> <p>进程可能会在终端需要输入时挂起，或者受到其他影响，通过将命令的标准输入重定向都/dev/null</p> <p>确保命令不会等待终端输入，而是在后台继续运行。</p> </td></tr><tr><td style="width:252px;"> <p style="text-align:center;">/var/log/masterha/app1/manager.log</p> </td><td style="width:436px;"> <p>日志文件绝对路径</p> </td></tr><tr><td style="width:252px;"> <p style="text-align:center;">2&gt;&amp;1</p> </td><td style="width:436px;"> <p>表示将标准输出和错误输出都重定向到manager.log</p> </td></tr><tr><td style="width:252px;"> <p style="text-align:center;">&amp;</p> </td><td style="width:436px;"> <p>末尾的&amp;，表示在后台运行</p> </td></tr></tbody></table> 
<p>启动后，使用<span style="color:#ffd900;"><span style="background-color:#0d0016;">masterha_check_status</span></span>命令检查mha的状态</p> 
<pre><code class="language-bash">[root@MHA-manager ~]# masterha_check_status --conf=/etc/masterha/app1.cnf 
app1 (pid:1533) is running(0:PING_OK), master:192.168.10.102    # 出现这行表示正在运行，当前的master是102主机</code></pre> 
<h5 id="%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97">查看日志</h5> 
<p>如果要查看日志信息，可以cat之前的配置文件中指定的生成路径</p> 
<pre><code class="language-bash">[root@MHA-manager ~]# cat /var/log/masterha/app1/manager.log</code></pre> 
<h3>测试</h3> 
<p>先打开作为测试机的主机，并连接上XShell</p> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在105（测试机）操作</span></strong></span></p> 
<p>连接整个集群的VIP，能正常连接，接下来模拟故障</p> 
<pre><code class="language-bash">[root@localhost ~]# yum -y install mysql
[root@localhost ~]# mysql -umha -pmanager -h 192.168.10.200
MariaDB [(none)]&gt; show databases;</code></pre> 
<h4 id="%E6%A8%A1%E6%8B%9F%E6%95%85%E9%9A%9C">模拟故障</h4> 
<p><strong><span style="color:#e7fafa;"><span style="background-color:#956fe7;">在101（MHA）操作</span></span></strong></p> 
<p>首先来到101主机使用<span style="color:#ffd900;"><span style="background-color:#0d0016;">tail -f</span></span>来动态显示mha日志文件的末尾十行内容，等会102故障时，立刻去101主机看日志的变化</p> 
<pre><code class="language-bash">[root@mha-manager masterha]# tail -f /var/log/masterha/app1/manager.log</code></pre> 
<p>要测试主备切换的话，需要出现故障才会进行切换，所以这里先模拟一个故障</p> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在102（master）操作</span></strong></span></p> 
<p>来到Master主机，关闭数据库服务，</p> 
<pre><code class="language-bash">[root@Mysql1 ~]# systemctl stop mariadb</code></pre> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在101（MHA）操作</span></strong></span></p> 
<p>查看日志文件的变化</p> 
<pre><code class="language-bash">[root@MHA-manager ~]# tail /var/log/masterha/app1/manager.log 
Invalidated master IP address on 192.168.10.102(192.168.10.102:3306)                   # 发现master地址无效
The latest slave 192.168.10.103(192.168.10.103:3306) has all relay logs for recovery.  # 指出了候选的从服务器，具有所有用于恢复的中继日志
Selected 192.168.10.103(192.168.10.103:3306) as a new master.                          # 选择新的主服务器，192.168.10.103:3306升级为新的主服务器
192.168.10.103(192.168.10.103:3306): OK: Applying all logs succeeded.                  # 新的主服务器成功应用了所有的日志。
192.168.10.103(192.168.10.103:3306): OK: Activated master IP address.                  # 新的主服务器的IP地址激活成功。
192.168.10.104(192.168.10.104:3306): This host has the latest relay log events.        # 指出另一台服务器192.168.10.104:3306有最新的中继日志事件
Generating relay diff files from the latest slave succeeded.                           # 从最新的从服务器成功生成了中继日志的差异文件。
# 服务器192.168.10.104成功应用了所有的日志，并且作为从服务器开始复制数据，数据源是192.168.10.103。
192.168.10.104(192.168.10.104:3306): OK: Applying all logs succeeded. Slave started, replicating from 192.168.10.103(192.168.10.103:3306)
# 服务器192.168.10.103成功重置了从服务器的信息
192.168.10.103(192.168.10.103:3306): Resetting slave info succeeded.
# 主服务器的故障切换到192.168.10.103成功完成
Master failover to 192.168.10.103(192.168.10.103:3306) completed successfully.</code></pre> 
<h5 id="%E5%AD%90%E6%8E%A5%E5%8F%A3vip%E7%9A%84%E5%8F%98%E5%8C%96">子接口vip的变化</h5> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在102（原master）操作</span></strong></span></p> 
<p>使用<span style="color:#956fe7;"><span style="background-color:#e7fafa;">ifconfig</span></span>查看此时的102（原master）的接口信息，可以发现192.168.10.200不见了</p> 
<pre><code class="language-bash">[root@mysql1 ~]# ifconfig</code></pre> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在103（现master）操作</span></strong></span></p> 
<p>使用<span style="color:#956fe7;"><span style="background-color:#e7fafa;">ifconfig</span></span>查看接口信息，可以看到vip的1<span style="color:#956fe7;"><span style="background-color:#e7fafa;">92.168.10.200</span></span>来到了103主机</p> 
<pre><code class="language-bash">[root@mysql2 ~]# ifconfig
ens33:1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.10.200  netmask 255.255.255.0  broadcast 192.168.10.255</code></pre> 
<p>那么我们就可以得知，vip（Vrtual IP）在哪个主机，哪个主机就是master服务器</p> 
<h4 id="%E4%BF%AE%E5%A4%8D">修复</h4> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在103（现master）操作</span></strong></span></p> 
<p>103已经不是从服务器了，所以关闭复制的线程（<span style="color:#ffd900;"><span style="background-color:#0d0016;">stop slave;</span></span>）</p> 
<p>再重置103之前作为从服务器的复制配置和状态</p> 
<p>目的是：假如有一天103故障了，修好以后又作为从服务器运行时，103会开始全新的复制过程，以便进行新一轮的测试或开发工作。</p> 
<pre><code class="language-sql">MariaDB [(none)]&gt; stop slave;
MariaDB [(none)]&gt; reset slave;
MariaDB [(none)]&gt; show master status;
+-------------------+----------+--------------+------------------+
| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+-------------------+----------+--------------+------------------+
| master-bin.000003 |     1196 |              |                  |
+-------------------+----------+--------------+------------------+</code></pre> 
<p><span style="color:#e7fafa;"><strong><span style="background-color:#956fe7;">在102操作</span></strong></span></p> 
<p>如果原本的master服务器（102）的故障被修好了，102并不能接替现在的master成为主服务器，只能当做现master服务器（103）的从服务器去存在，所以这里需要为102配置作为从服务器相关设置</p> 
<p>配置102作为从服务器连接主服务器（103）的参数，启动复制进程，查看状态确保IO线程和SQL线程正常启动</p> 
<blockquote> 
 <p>注意<span style="color:#956fe7;"><span style="background-color:#e7fafa;">change</span></span>语句指定的二进制日志文件和位置，是要跟现master服务器的状态信息一致的（<span style="color:#956fe7;"><span style="background-color:#e7fafa;">master-bin.000004、245</span></span>）</p> 
</blockquote> 
<pre><code class="language-bash">MariaDB [(none)]&gt; change master to master_host='192.168.10.103', master_user='myslave', master_password='123456', master_log_file='master-bin.000003', master_log_pos=1196;
MariaDB [(none)]&gt; start slave;
MariaDB [(none)]&gt; show slave status\G;
Slave_IO_Running: Yes
Slave_SQL_Running: Yes</code></pre> 
<p>作为从服务器，应该只有读取数据（select）的权利，所以这里设置为只读</p> 
<pre><code class="language-sql">MariaDB [(none)]&gt; set global read_only=1;</code></pre> 
<p>如果此时去104（第二个从服务器）</p> 
<p>登录进数据库，查看<span style="color:#956fe7;"><span style="background-color:#e7fafa;">slave</span></span>的状态信息，可以发现master的IP也变成了103（先master）而不是102（原master）了</p> 
<pre><code class="language-sql">MariaDB [(none)]&gt; show slave status\G;
Master_Host: 192.168.10.103</code></pre> 
<p><strong><span style="color:#e7fafa;"><span style="background-color:#956fe7;">在105操作</span></span></strong></p> 
<p>最后再去测试机测试，案例完成</p> 
<pre><code class="language-sql">MariaDB [(none)]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| test               |
+--------------------+</code></pre> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/241b4df9c9841905b9f0eda81f3cef67/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">电脑自动重启是什么原因？重启原因排查和解决办法！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c7420e86121a4450442703e2e483593a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JVM—对象已死？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>