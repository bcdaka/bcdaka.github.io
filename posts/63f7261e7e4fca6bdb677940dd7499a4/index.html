<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL中的窗口函数 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/63f7261e7e4fca6bdb677940dd7499a4/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="SQL中的窗口函数">
  <meta property="og:description" content="1.窗口函数简介 窗口函数是SQL中的一项高级特性，用于在不改变查询结果集行数的情况下，对每一行执行聚合计算或者其他复杂的计算，也就是说窗口函数可以跨行计算，可以扫描所有的行，并把结果填到每一行中。这些函数通常与OVER()子句一起使用，可以定义窗口或分区，并在上面执行计算，使用窗口函数，可以使许多难以处理的棘手问题变得较为容易。
窗口函数的特点包括：
输入多行（一个窗口），返回一个值：窗口函数为每行数据进行一次计算，但不会改变原始查询结果集的行数计算方式灵活：可以使用partition by字句将数据分区，并使用order by子句来进行排序等一些复杂运算与聚合函数结合使用：可以与聚合函数结合使用，在不分组的情况下计算如总和、平均值、最小值、最大值等聚合值。 2.语法结构解析 &lt;窗口函数&gt; OVER ( [PARTITION BY &lt;分组列&gt;] [ORDER BY &lt;排序列&gt;] [ROWS 或 RANGE &lt;窗口框架定义&gt;] ) 其中：
PARTITION BY 子句用于将数据分成不同的分区，窗口函数将在每个分区内执行。可以理解为group by ORDER BY 子句定义了数据的排序方式，决定窗口函数的计算顺序。ROWS BETWEEN 子句指定了窗口的范围，可以是行数、区间等。 3.常用的窗口函数SQL示例 常用的窗口函数有：
聚合函数：SUM()、AVG()、COUNT()、MAX()、MIN()等排名函数： ROW_NUMBER()：为窗口内的每一行分配一个唯一的序号，序号连续且不重复；RANK()：排名函数，允许有并列的名次，名次后面会出现空位。ENSE_RANK()：排名函数，允许有并列的名次，名次后面不会空出位置，即序号连续。 分组窗口函数： NTILE()：将窗口内的行分为指定数量的组，每组的行数尽可能相等。 分布窗口函数 PERCENT_RANK()：计算每一行的相对排名，返回一个介于0到1之间的值，表示当前行在分区中的排名百分比。CUME_DIST()：计算小于或等于当前行的行数占窗口总行数的比例。 取值窗口函数 LAG()：访问当前行之前的第n行数据。LEAD()：访问当前行之后的第n行数据。FIRST_VALUE()：获取窗口内第一行的值。LAST_VALUE()：获取窗口内最后一行的值。NTH_VALUE()：获取窗口内第n行的值，如果存在多行则返回第一个。 这里以employees表为例：
CREATE TABLE employees ( employee_id INT PRIMARY KEY, name VARCHAR(255), department_name VARCHAR(255), salary DECIMAL(10, 2) ); -- 插入数据 INSERT INTO employees (employee_id, department_name, name, salary) VALUES (1, &#39;财务部&#39;, &#39;张三&#39;, 30000), (2, &#39;财务部&#39;, &#39;李四&#39;, 25000), (3, &#39;市场部&#39;, &#39;王五&#39;, 40000), (4, &#39;市场部&#39;, &#39;赵六&#39;, 35000), (5, &#39;市场部&#39;, &#39;孙七&#39;, 50000), (6, &#39;技术部&#39;, &#39;周八&#39;, 45000), (7, &#39;技术部&#39;, &#39;钱九&#39;, 60000), (8, &#39;技术部&#39;, &#39;吴十&#39;, 55000); 聚合窗口函数查询 SELECT employee_id, name, department_name, salary, SUM(salary) OVER (PARTITION BY department_name) AS total_salary, AVG(salary) OVER (PARTITION BY department_name) AS average_salary, COUNT(*) OVER (PARTITION BY department_name) AS employee_count, MAX(salary) OVER (PARTITION BY department_name) AS max_salary, MIN(salary) OVER (PARTITION BY department_name) AS min_salary FROM employees; 执行输入如下：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-03T23:10:08+08:00">
    <meta property="article:modified_time" content="2024-08-03T23:10:08+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL中的窗口函数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_0"></a>1.窗口函数简介</h3> 
<p>窗口函数是SQL中的一项高级特性，用于在不改变查询结果集行数的情况下，对每一行执行聚合计算或者其他复杂的计算，也就是说窗口函数可以跨行计算，可以扫描所有的行，并把结果填到每一行中。这些函数通常与<code>OVER()</code>子句一起使用，可以定义窗口或分区，并在上面执行计算，使用窗口函数，可以使许多难以处理的棘手问题变得较为容易。<br> 窗口函数的<strong>特点</strong>包括：</p> 
<ol><li>输入多行（一个窗口），返回一个值：窗口函数为每行数据进行一次计算，但不会改变原始查询结果集的行数</li><li>计算方式灵活：可以使用<code>partition by</code>字句将数据分区，并使用<code>order by</code>子句来进行排序等一些复杂运算</li><li>与聚合函数结合使用：可以与聚合函数结合使用，在不分组的情况下计算如总和、平均值、最小值、最大值等聚合值。</li></ol> 
<h3><a id="2_7"></a>2.语法结构解析</h3> 
<pre><code>&lt;窗口函数&gt; OVER (
    [PARTITION BY &lt;分组列&gt;]
    [ORDER BY &lt;排序列&gt;]
    [ROWS 或 RANGE &lt;窗口框架定义&gt;]
)
</code></pre> 
<p>其中：</p> 
<ul><li><code>PARTITION BY</code> 子句用于将数据分成不同的分区，窗口函数将在每个分区内执行。可以理解为<code>group by </code></li><li><code>ORDER BY</code> 子句定义了数据的排序方式，决定窗口函数的计算顺序。</li><li><code>ROWS BETWEEN</code> 子句指定了窗口的范围，可以是行数、区间等。</li></ul> 
<h3><a id="3SQL_21"></a>3.常用的窗口函数SQL示例</h3> 
<p>常用的窗口函数有：</p> 
<ol><li><strong>聚合函数</strong>：<code>SUM()</code>、<code>AVG()</code>、<code>COUNT()</code>、<code>MAX()</code>、<code>MIN()</code>等</li><li><strong>排名函数</strong>： 
  <ul><li><code>ROW_NUMBER()</code>：为窗口内的每一行分配一个唯一的序号，序号连续且不重复；</li><li><code>RANK()</code>：排名函数，允许有并列的名次，名次后面会出现空位。</li><li><code>ENSE_RANK()</code>：排名函数，允许有并列的名次，名次后面不会空出位置，即序号连续。</li></ul> </li><li><strong>分组窗口函数</strong>： 
  <ul><li><code>NTILE()</code>：将窗口内的行分为指定数量的组，每组的行数尽可能相等。</li></ul> </li><li><strong>分布窗口函数</strong> 
  <ul><li><code>PERCENT_RANK()</code>：计算每一行的相对排名，返回一个介于0到1之间的值，表示当前行在分区中的排名百分比。</li><li><code>CUME_DIST()</code>：计算小于或等于当前行的行数占窗口总行数的比例。</li></ul> </li><li>取值窗口函数 
  <ul><li><code>LAG()</code>：访问当前行之前的第n行数据。</li><li><code>LEAD()</code>：访问当前行之后的第n行数据。</li><li><code>FIRST_VALUE()</code>：获取窗口内第一行的值。</li><li><code>LAST_VALUE()</code>：获取窗口内最后一行的值。</li><li><code>NTH_VALUE()</code>：获取窗口内第n行的值，如果存在多行则返回第一个。</li></ul> </li></ol> 
<p>这里以employees表为例：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employees <span class="token punctuation">(</span>
    employee_id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    department_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    salary <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 插入数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees <span class="token punctuation">(</span>employee_id<span class="token punctuation">,</span> department_name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> salary<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'财务部'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'财务部'</span><span class="token punctuation">,</span> <span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token number">25000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'市场部'</span><span class="token punctuation">,</span> <span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token number">40000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'市场部'</span><span class="token punctuation">,</span> <span class="token string">'赵六'</span><span class="token punctuation">,</span> <span class="token number">35000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'市场部'</span><span class="token punctuation">,</span> <span class="token string">'孙七'</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'技术部'</span><span class="token punctuation">,</span> <span class="token string">'周八'</span><span class="token punctuation">,</span> <span class="token number">45000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'技术部'</span><span class="token punctuation">,</span> <span class="token string">'钱九'</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'技术部'</span><span class="token punctuation">,</span> <span class="token string">'吴十'</span><span class="token punctuation">,</span> <span class="token number">55000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_61"></a>聚合窗口函数查询</h4> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">)</span> <span class="token keyword">AS</span> total_salary<span class="token punctuation">,</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">)</span> <span class="token keyword">AS</span> average_salary<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">)</span> <span class="token keyword">AS</span> employee_count<span class="token punctuation">,</span>
    <span class="token function">MAX</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">)</span> <span class="token keyword">AS</span> max_salary<span class="token punctuation">,</span>
    <span class="token function">MIN</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">)</span> <span class="token keyword">AS</span> min_salary
<span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
</code></pre> 
<p>执行输入如下：<br> <img src="https://images2.imgbox.com/d0/87/OVtgGPGo_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_78"></a>排名窗口函数查询</h4> 
<h5><a id="ROW_NUMBER_79"></a>ROW_NUMBER()窗口函数查询</h5> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> salary_rank
<span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
</code></pre> 
<p>执行输出如下：<br> <img src="https://images2.imgbox.com/c6/a0/5roxRgvP_o.png" alt="在这里插入图片描述"><br> 如果想要在部门内分区添加行号</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> salary_rank
<span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
</code></pre> 
<p>执行结果如下：<br> <img src="https://images2.imgbox.com/9c/c7/5ZPjQXS3_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="RANK__DENSE_RANK_106"></a>RANK() &amp;&amp; DENSE_RANK()</h5> 
<p><code>RANK()</code> 和 <code>DENSE_RANK()</code> 函数的主要区别在于<strong>处理并列名次的方式</strong>。<code>RANK() </code>函数在遇到并列名次时会在下一个名次处留出空位，而 <code>DENSE_RANK() </code>函数则不会留出空位，名次连续。<br> 我们需要确保每个部门至少有两个员工的薪资是相同的。我们假如插入的数据如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees <span class="token punctuation">(</span>employee_id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> department_name<span class="token punctuation">,</span> salary<span class="token punctuation">)</span> <span class="token keyword">VALUES</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Alice'</span><span class="token punctuation">,</span> <span class="token string">'财务部'</span><span class="token punctuation">,</span> <span class="token number">70000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Bob'</span><span class="token punctuation">,</span> <span class="token string">'财务部'</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Charlie'</span><span class="token punctuation">,</span> <span class="token string">'财务部'</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 与Bob薪资相同</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'David'</span><span class="token punctuation">,</span> <span class="token string">'市场部'</span><span class="token punctuation">,</span> <span class="token number">80000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'Eve'</span><span class="token punctuation">,</span> <span class="token string">'市场部'</span><span class="token punctuation">,</span> <span class="token number">80000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 与David薪资相同</span>
<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Frank'</span><span class="token punctuation">,</span> <span class="token string">'市场部'</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'Grace'</span><span class="token punctuation">,</span> <span class="token string">'技术部'</span><span class="token punctuation">,</span> <span class="token number">90000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'Heidi'</span><span class="token punctuation">,</span> <span class="token string">'技术部'</span><span class="token punctuation">,</span> <span class="token number">75000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token string">'Ivan'</span><span class="token punctuation">,</span> <span class="token string">'技术部'</span><span class="token punctuation">,</span> <span class="token number">75000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 与Heidi薪资相同</span>
<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'Judy'</span><span class="token punctuation">,</span> <span class="token string">'财务部'</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 与Bob和Charlie薪资相同</span>
<span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">'Karl'</span><span class="token punctuation">,</span> <span class="token string">'市场部'</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 与Frank薪资相同</span>
<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token string">'Linda'</span><span class="token punctuation">,</span> <span class="token string">'技术部'</span><span class="token punctuation">,</span> <span class="token number">90000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 与Grace薪资相同</span>
<span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token string">'Mike'</span><span class="token punctuation">,</span> <span class="token string">'财务部'</span><span class="token punctuation">,</span> <span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 新薪资水平</span>
<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token string">'Nancy'</span><span class="token punctuation">,</span> <span class="token string">'市场部'</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">-- 与Bob和Charlie薪资相同</span>
<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string">'Oliver'</span><span class="token punctuation">,</span> <span class="token string">'技术部'</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 与Bob和Charlie薪资相同</span>
</code></pre> 
<p>执行包含 <code>RANK()</code> 和 <code>DENSE_RANK()</code> 函数的查询：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> salary_rank<span class="token punctuation">,</span>
    DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> dense_salary_rank
<span class="token keyword">FROM</span> employees
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">,</span> salary <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre> 
<p>执行结果如下：<br> <img src="https://images2.imgbox.com/ce/62/OZSp5CZO_o.png" alt="在这里插入图片描述"><br> 在这个结果中，以财务部为例，</p> 
<ul><li>Alice 薪资最高，排名 1。</li><li>Bob、Charlie 和 Judy 薪资相同，使用 RANK() 函数时，他们的排名依次为 2、2、2（跳过3、4），使用 DENSE_RANK() 函数时，排名连续为 2、2、2（名次连续）。</li></ul> 
<h4><a id="_146"></a>分组窗口函数查询</h4> 
<p>分组窗口函数<code>NTILE()</code> 将数据分为指定数量的组，每组的行数尽可能相等。假设我们要根据员工的薪资将他们分为四组（例如：高收入、中等收入、较低收入和最低收入），我们可以对每个部门使用 <code>NTILE(4)</code> 来实现：</p> 
<pre><code class="prism language-sql">    <span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    NTILE<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> salary_quartile
<span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
</code></pre> 
<p>执行结果如下：<br> <img src="https://images2.imgbox.com/a7/6e/QMziYsKJ_o.png" alt="在这里插入图片描述"><br> 在这个结果中，每个部分都被分为了4组，以市场部为例：<br> 市场部 的 David 和 Eve 位于最高收入组（1），Nancy在中等收入组(2)，Frank分到了较低收入组（3），Karl 被分到了最低收入组（4）注意，由于 NTILE() 函数的目的是将数据分为尽可能相等的组，每个部门5个人，分为4组，每个部门肯定有两个人会分到同一个组内。</p> 
<h4><a id="_163"></a>分布窗口函数查询</h4> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    PERCENT_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> salary_percent_rank<span class="token punctuation">,</span>
    CUME_DIST<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> salary_cume_dist
<span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
</code></pre> 
<p>执行结果如下：<br> <img src="https://images2.imgbox.com/a5/8d/YX2AtFIz_o.png" alt="在这里插入图片描述"><br> ERCENT_RANK() 说明：<br> <code>PERCENT_RANK()</code> 函数返回一个介于<strong>0到1</strong>之间的值，表示当前员工薪资在部门中的排名百分比。例如，如果一个员工的 salary_percent_rank 是0.50，这意味着他的薪资低于或等于部门中50%的员工薪资。</p> 
<ul><li>在 “财务部” 中，Alice 的薪资是最高的，所以她的薪资百分比排名是0.00（即她是最高薪）。Judy、Bob 和 Charlie 的薪资相同，并且低于Alice，所以他们的薪资百分比排名是0.25。</li><li>Mike 的薪资是最低的，所以他的薪资百分比排名是1.00。</li></ul> 
<p>CUME_DIST() 说明：</p> 
<ul><li><code>CUME_DIST()</code> 函数返回一个介于0到1之间的值，用于求分区中<strong>大于等于或小于等于</strong>当前行的数据在分区中的占比。如果是升序排列，则统计是：小于等于当前值的行数/总行数 ，如果是降序排列，则统计：大于等于当前值的行数/总行数。</li><li>这里按薪水降序排列，表示大于或等于当前员工薪资的员工数量占部门总员工数量的比例。在 “财务部” 中，Alice 的 salary_cume_dist 是0.2，因为她的薪资是最高的。Judy、Bob 和 Charlie 的薪资相同，并且有4个的员工薪资大于等于他们，所以他们的 salary_cume_dist 是0.80。Mike 是最低薪资，部门所有人都大于等于他，所以他的 salary_cume_dist 是1。</li></ul> 
<h4><a id="_186"></a>取值窗口函数查询</h4> 
<h5><a id="LAG_187"></a>LAG</h5> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    LAG<span class="token punctuation">(</span>salary<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> prev_salary
<span class="token keyword">FROM</span> employees
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">,</span> salary <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9d/f8/d85dqend_o.png" alt="在这里插入图片描述"><br> LAG(salary, 1, 0) 说明：</p> 
<ul><li><code>LAG()</code> 函数返回当前员工之前第一个员工的薪资。如果没有前一个员工（即当前是部门中薪资最高的员工），则返回指定的默认值，这里我们使用0作为默认值。</li></ul> 
<h5><a id="LEAD_205"></a>LEAD</h5> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    LEAD<span class="token punctuation">(</span>salary<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> next_salary
<span class="token keyword">FROM</span> employees
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">,</span> salary <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/36/fe/52NfUOUn_o.png" alt="在这里插入图片描述"><br> LEAD(salary, 1, 0) 说明：</p> 
<p><code>LEAD()</code> 函数返回当前员工之后第一个员工的薪资。如果没有后一个员工（即当前是部门中薪资最低的员工），则返回指定的默认值，这里我们使用0作为默认值。</p> 
<h5><a id="FIRST_VALUE_223"></a>FIRST_VALUE</h5> 
<p><code>FIRST_VALUE</code>函数用于取当前行所对应窗口的第一条数据的值。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    FIRST_VALUE<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> max_salary_in_department
<span class="token keyword">FROM</span> employees
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">,</span> salary <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre> 
<p>执行结果如下：<br> <img src="https://images2.imgbox.com/92/d6/ZHrngkpF_o.png" alt="在这里插入图片描述"><br> FIRST_VALUE(salary) 说明：<br> <code>FIRST_VALUE()</code> 函数返回部门中薪资是按降序排列的，因此 <code>FIRST_VALUE()</code> 实际上是返回该部门的最高薪资。</p> 
<h5><a id="LAST_VALUE_241"></a>LAST_VALUE</h5> 
<p><code>LAST_VALUE</code>函数用于取当前行所对应窗口的最后一条数据的值。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    LAST_VALUE<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> min_salary_in_department
<span class="token keyword">FROM</span> employees
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">,</span> salary <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre> 
<p>执行结果如下：<br> <img src="https://images2.imgbox.com/8b/4a/PpdfMSSw_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="NTH_VALUE_257"></a>NTH_VALUE</h5> 
<p>获取窗口内第n行的值</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    NTH_VALUE<span class="token punctuation">(</span>salary<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> third_salary_in_department
<span class="token keyword">FROM</span> employees
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">,</span> salary <span class="token keyword">DESC</span><span class="token punctuation">;</span>
</code></pre> 
<p>执行结果</p> 
<p><img src="https://images2.imgbox.com/86/10/laXl7gqB_o.png" alt="在这里插入图片描述"></p> 
<p><strong>注意</strong>，这里third_salary_in_department会有null值，实际上这和分区内默认的取值范围有关，<code>NTH_VALUE(salary, 3)</code> 将始终返回每个分区中的第三行的值，因为这里默认取值范围从排序后的第一个行（即 <code>ORDER BY</code> 子句中的第一个值）到当前行，所以在当前行窗口范围内没有第三行的值时，就会显示null值。如果我们指定窗口取值范围如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    employee_id<span class="token punctuation">,</span>
    name<span class="token punctuation">,</span>
    department_name<span class="token punctuation">,</span>
    salary<span class="token punctuation">,</span>
    NTH_VALUE<span class="token punctuation">(</span>salary<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> department_name <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">desc</span>
        <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token keyword">UNBOUNDED</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">UNBOUNDED</span> <span class="token keyword">FOLLOWING</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> third_salary_in_department
<span class="token keyword">FROM</span> employees
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> department_name<span class="token punctuation">;</span>
</code></pre> 
<p>则执行结果如下：<br> <img src="https://images2.imgbox.com/4a/d6/uW1DvqXy_o.png" alt="在这里插入图片描述"><br> 这里使用了<code>ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code>来指定窗口的范围为第一行到最后一行，这意味着窗口包括了分区内的所有行。在这种情况下，<code>NTH_VALUE(salary, 3)</code> 将始终返回每个分区中的第三行的值，只要该分区至少有三行数据。</p> 
<h3><a id="4_291"></a><strong>4.窗口的范围</strong></h3> 
<p>窗口的范围，有的资料上面也叫<code>Framing（分帧）</code>,大致可以分为两种，一种是根据行（rows between）来划分，一种是根据列值（range between）来划分，它们都可以确定一个窗口应该包含哪些行。窗口的开始和结束可以使用以下关键字来定义：</p> 
<ul><li><code>UNBOUNDED PRECEDING</code>：从分区中的第一行开始（前面所有行）。</li><li><code>CURRENT ROW</code>：包括当前行。</li><li><code>n PRECEDING</code>：从当前行之前的第 n 行开始。</li><li><code>n FOLLOWING</code>：包括当前行之后第 n 行。</li><li><code>UNBOUNDED FOLLOWING</code>：到分区中的最后一行结束（后面所有行）。</li></ul> 
<h4><a id="rows_betweenand_299"></a>基于行划分：rows between…and…</h4> 
<p>语法格式如下：</p> 
<pre><code class="prism language-sql"><span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token operator">&lt;</span><span class="token keyword">column</span><span class="token operator">&gt;</span> <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token operator">&lt;</span><span class="token keyword">start</span><span class="token operator">&gt;</span> <span class="token operator">and</span> <span class="token operator">&lt;</span><span class="token keyword">end</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre> 
<p>例如，假设你有一个包含销售数据的表，并希望计算每一行及其前两行的总和：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    sales_date<span class="token punctuation">,</span>
    sales_amount<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>sales_amount<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> sales_date
        <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token number">2</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> running_total
<span class="token keyword">FROM</span>
    sales<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="range_betweenand_318"></a>基于列值划分：range between…and…</h4> 
<p>语法格式如下：</p> 
<pre><code class="prism language-sql"><span class="token function">sum</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token operator">&lt;</span><span class="token keyword">column</span><span class="token operator">&gt;</span> range <span class="token operator">between</span> <span class="token operator">&lt;</span><span class="token keyword">start</span><span class="token operator">&gt;</span> <span class="token operator">and</span> <span class="token operator">&lt;</span><span class="token keyword">end</span><span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre> 
<p>例如，我们有一个包含商品数据的表，我们希望计算每个商品价格及其前后20单位价格范围内的商品总和：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
    product_id<span class="token punctuation">,</span>
    product_price<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span>product_price<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
        <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> product_price
        RANGE <span class="token operator">BETWEEN</span> <span class="token number">20</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token number">20</span> <span class="token keyword">FOLLOWING</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> price_range_total
<span class="token keyword">FROM</span>
    products<span class="token punctuation">;</span>
</code></pre> 
<p>假设当前行product_price值为70，那其窗口范围是product_price列的值位于50（70-20）到90（70+20）之间的所有的行。</p> 
<h3><a id="5_338"></a>5.窗口函数的缺省值</h3> 
<p>over后的窗口函数划分语句，包括<code>partition by</code> 、<code>order by</code> 、<code>（row|range）between ...and...</code>这三部分，实际上这些内容也都可以省略不写。</p> 
<ul><li>partition by省略不写，表示不分区。在不进行分区的情况下，将会把整张表的全部内容作为窗口进行划分。</li><li>order by 省略，表示不排序</li><li>（row|range）between …and…省略不写，则使用其默认值，默认值分为以下两种情况： 
  <ul><li>over后面包含order by ,则默认值为：range between unbounded preceding and current row</li><li>over后面不包含order by ,则默认值为：rows between unbounded preceding and unbounded following。</li></ul> </li></ul> 
<h3><a id="_347"></a>小结：</h3> 
<p>可以看出，窗口产生的用法很类似聚合函数，不同的是聚合函数是将多行数据汇总为单个结果，窗口函数的话在同一个select中我们可以按照不同的列进行分区，而且多个窗口函数的列之间不受影响，功能很强大，语法也比较灵活，在进行复杂的数据分析或写一些报表时我们就可以考虑用窗口函数来去实现。</p> 
<h3><a id="_355"></a>参考文档：</h3> 
<p><a href="https://developer.aliyun.com/article/1541419" rel="nofollow">https://developer.aliyun.com/article/1541419</a><br> <a href="https://mysql.net.cn/doc/refman/8.0/en/window-functions.html" rel="nofollow">https://mysql.net.cn/doc/refman/8.0/en/window-functions.html</a><br> <a href="https://support.huaweicloud.com/intl/zh-cn/sqlref-spark-dli/dli_08_0069.html" rel="nofollow">https://support.huaweicloud.com/intl/zh-cn/sqlref-spark-dli/dli_08_0069.html</a><br> <a href="https://www.cnblogs.com/xfeiyun/p/16965394.html" rel="nofollow">https://www.cnblogs.com/xfeiyun/p/16965394.html</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0db4c26ccd53c84e5b9fa479c9a2dbba/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Visual Studio 和 VSCode哪个更好?</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/775a25cc8600381be34b8506f80496b3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL —— 库，数据类型 与 表</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>