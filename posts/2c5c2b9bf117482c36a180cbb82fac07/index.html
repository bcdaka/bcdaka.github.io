<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>JS前端实现网页复制文本（兼容IOS端、微信浏览器 源码解析） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/2c5c2b9bf117482c36a180cbb82fac07/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="JS前端实现网页复制文本（兼容IOS端、微信浏览器 源码解析）">
  <meta property="og:description" content="在这段时间前端网页开发中，遇到点击按钮，实现复制文本到剪切板中的需求，记录一下实现过程和遇到的坑：
首先介绍一下常用的2种复制方法：
1. 使用 document.execCommand() 方法：
function copyToClipboard(text) { const textArea = document.createElement(&#39;textArea&#39;) textArea.value = val //添加到dom节点中 textArea.style.width = 0 textArea.style.position = &#39;fixed&#39; textArea.style.left = &#39;-999px&#39; textArea.style.top = &#39;10px&#39; textArea.setAttribute(&#39;readonly&#39;, &#39;readonly&#39;) document.body.appendChild(textArea) textArea.select() document.execCommand(&#39;copy&#39;) // 移除元素 document.body.removeChild(textArea) } copyToClipboard(&#34;复制的内容&#34;) 该方法相对来说比较老，特别是 execCommand 已经弃用了，所以尽可能使用其他方法。
2. 使用 navigator.clipboard 方法：
function copyToClipboard(text) { navigator.clipboard .writeText(text) .then(() =&gt; { console.log(&#34;复制成功&#34;) }) .catch((err) =&gt; { console.log(&#34;复制失败，请重试&#34;); }); } copyToClipboard(&#34;复制的内容&#34;) 该方法在 ios浏览器和微信浏览器 中复制无效，判断navigator.clipboard是存在的，但就是writeText时出错，显示拒绝，所以在chrome上运行的网页可以考虑使用该方法。
为什么在IOS和微信中会复制失败呢？
测试发现navigator.clipboard是存在的，但就是writeText时出错，显示拒绝
经查找，gpt给出的可能失败的原因有：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-12T18:34:30+08:00">
    <meta property="article:modified_time" content="2024-04-12T18:34:30+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">JS前端实现网页复制文本（兼容IOS端、微信浏览器 源码解析）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>在这段时间前端网页开发中，遇到点击按钮，实现复制文本到剪切板中的需求，记录一下实现过程和遇到的坑：</p> 
<p>首先介绍一下常用的2种复制方法：</p> 
<p><strong>1. 使用 <code>document.execCommand()</code> 方法：</strong></p> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">copyToClipboard</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> textArea <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'textArea'</span><span class="token punctuation">)</span>
    textArea<span class="token punctuation">.</span>value <span class="token operator">=</span> val
    
    <span class="token comment">//添加到dom节点中</span>
    textArea<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">0</span>
    textArea<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">'fixed'</span>
    textArea<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token string">'-999px'</span>
    textArea<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token string">'10px'</span>
    textArea<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'readonly'</span><span class="token punctuation">,</span> <span class="token string">'readonly'</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>textArea<span class="token punctuation">)</span>

    textArea<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">'copy'</span><span class="token punctuation">)</span>
    
    <span class="token comment">// 移除元素</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>textArea<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
 
 <span class="token function">copyToClipboard</span><span class="token punctuation">(</span><span class="token string">"复制的内容"</span><span class="token punctuation">)</span>
</code></pre> 
<p>该方法相对来说比较老，特别是 <code>execCommand</code> 已经弃用了，所以尽可能使用其他方法。</p> 
<p><strong>2. 使用 <code>navigator.clipboard</code> 方法：</strong></p> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">copyToClipboard</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   navigator<span class="token punctuation">.</span>clipboard
    <span class="token punctuation">.</span><span class="token function">writeText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"复制成功"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"复制失败，请重试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token function">copyToClipboard</span><span class="token punctuation">(</span><span class="token string">"复制的内容"</span><span class="token punctuation">)</span>
</code></pre> 
<p>该方法在 <strong>ios浏览器和微信浏览器</strong> 中复制无效，判断navigator.clipboard是存在的，但就是writeText时出错，显示拒绝，所以在chrome上运行的网页可以考虑使用该方法。</p> 
<p><strong>为什么在IOS和微信中会复制失败呢？</strong></p> 
<p>测试发现navigator.clipboard是存在的，但就是writeText时出错，显示拒绝<br> 经查找，gpt给出的可能失败的原因有：</p> 
<ul><li><strong>安全策略</strong>对网页脚本的能力有限制，特别是在涉及到访问剪贴板这类敏感操作时。如果没有明确的用户交互，例如点击选中后复制，JavaScript可能无法成功执行复制命令。</li></ul> 
<p><strong>在此情况下，我们可以尝试使用第三方库来解决无法复制的问题：</strong></p> 
<ol start="3"><li>使用第三方库，例如 <code>clipboard</code>:</li></ol> 
<pre><code class="prism language-js">npm install clipboard <span class="token operator">--</span>save
</code></pre> 
<p>初始化时，new一个clipboard对象，同时通过类名绑定复制按钮，实现复制功能</p> 
<pre><code class="prism language-js"><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> clipboard <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClipboardJS</span><span class="token punctuation">(</span><span class="token string">".copyBtn"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function-variable function">text</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">trigger</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> copyText<span class="token punctuation">;</span> <span class="token comment">//copyText 需要复制的文本</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"复制成功"</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"复制失败，请重试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      clipboard<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>经测试，在chrome和IOS、微信浏览器上都可以复制成功。</p> 
<h4><a id="IOS_86"></a>思考：为什么第三库可以绕过IOS和微信浏览器中的安全策略呢？</h4> 
<p>我们通过GitHub参考源码：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fzenorocha%2Fclipboard.js" rel="nofollow" title="https://github.com/zenorocha/clipboard.js">查看源码</a></p> 
<ol><li>首先绑定 按钮 点击事件</li></ol> 
<pre><code class="prism language-js"><span class="token function">listenClick</span><span class="token punctuation">(</span><span class="token parameter">trigger</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listener <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>trigger<span class="token punctuation">,</span> <span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onClick</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>初始化 new clipboard(“.btn”)后， <code>listenClick</code>函数负责监听<code>click</code>点击事件。会遍历所有的节点，给节点添加监听事件。</p> 
<ol start="2"><li>触发点击事件</li></ol> 
<pre><code class="prism language-js"><span class="token comment">/**
   * Defines a new `ClipboardAction` on each click event.
   * @param {Event} e
   */</span>
  <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> trigger <span class="token operator">=</span> e<span class="token punctuation">.</span>delegateTarget <span class="token operator">||</span> e<span class="token punctuation">.</span>currentTarget<span class="token punctuation">;</span>
    <span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'copy'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token function">ClipboardActionDefault</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      action<span class="token punctuation">,</span>
      <span class="token literal-property property">container</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">,</span>
      <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>trigger<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Fires an event based on the copy operation result.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span>text <span class="token operator">?</span> <span class="token string">'success'</span> <span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      action<span class="token punctuation">,</span>
      text<span class="token punctuation">,</span>
      trigger<span class="token punctuation">,</span>
      <span class="token function">clearSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>trigger<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          trigger<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAllRanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>当我们点击之后会触发执行<code>this.onClick</code>函数，会触发执行剪切板命令，并通过<code>Emitter.emit</code>进行来进行执行。</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> ClipboardActionCut <span class="token keyword">from</span> <span class="token string">'./cut'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ClipboardActionCopy <span class="token keyword">from</span> <span class="token string">'./copy'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Inner function which performs selection from either `text` or `target`
 * properties and then executes copy or cut operations.
 * @param {Object} options
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">ClipboardActionDefault</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">//...省略</span>

  <span class="token comment">// Define selection strategy based on `text` property.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">ClipboardActionCopy</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> container <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Defines which selection strategy based on `target` property.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> action <span class="token operator">===</span> <span class="token string">'cut'</span>
      <span class="token operator">?</span> <span class="token function">ClipboardActionCut</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">ClipboardActionCopy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> container <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ClipboardActionDefault<span class="token punctuation">;</span>
</code></pre> 
<p>Clipboard除了指定点击按钮，还有可选项用于动态指定需要复制的目标，<code>target</code>、<code>text</code>，<code>container</code></p> 
<p>我们文章中直接使用的是<code>text</code>，意思就是接受一个 <code>文本</code> 作为复制项，所以直接给看上面代码中逻辑，会执行<code>ClipboardActionCopy</code>函数。</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> select <span class="token keyword">from</span> <span class="token string">'select'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> command <span class="token keyword">from</span> <span class="token string">'../common/command'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> createFakeElement <span class="token keyword">from</span> <span class="token string">'../common/create-fake-element'</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Create fake copy action wrapper using a fake element.
 * @param {String} target
 * @param {Object} options
 * @return {String}
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">fakeCopyAction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> fakeElement <span class="token operator">=</span> <span class="token function">createFakeElement</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>fakeElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> selectedText <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>fakeElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'copy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fakeElement<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> selectedText<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Copy action wrapper.
 * @param {String|HTMLElement} target
 * @param {Object} options
 * @return {String}
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">ClipboardActionCopy</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter">target<span class="token punctuation">,</span>
  options <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">container</span><span class="token operator">:</span> document<span class="token punctuation">.</span>body <span class="token punctuation">}</span></span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> selectedText <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    selectedText <span class="token operator">=</span> <span class="token function">fakeCopyAction</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    target <span class="token keyword">instanceof</span> <span class="token class-name">HTMLInputElement</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">'search'</span><span class="token punctuation">,</span> <span class="token string">'url'</span><span class="token punctuation">,</span> <span class="token string">'tel'</span><span class="token punctuation">,</span> <span class="token string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>target<span class="token operator">?.</span>type<span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// If input type doesn't support `setSelectionRange`. Simulate it. https://developer.mozilla.org/en-US/docs/Web/API/HTMLInputElement/setSelectionRange</span>
    selectedText <span class="token operator">=</span> <span class="token function">fakeCopyAction</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>value<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    selectedText <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'copy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> selectedText<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ClipboardActionCopy<span class="token punctuation">;</span>
</code></pre> 
<p>以上函数逻辑对三种类型做了判断：</p> 
<ol><li>字符串类型，说明目标是一个纯文本，就需要额外创建一个<code>textarea</code>标签，为什么不是<code>input</code>标签呢？是因为对于换行文本内容使用<code>textarea</code>会更友好。</li><li>第二种是节点类型，不为<code>text', 'search', 'url', 'tel', 'password'</code>这几种类型之一的，均通过创建<code>textarea</code>的方式进行拷贝。</li><li>第三种是为<code>text', 'search', 'url', 'tel'</code>类型其中之一的直接执行<code>document.execCommand('copy')</code>指令。</li></ol> 
<p>一般使用比较多会穿string类型，此时会执行<code>fakeCopyAction</code>函数。其中执行了<code>createFakeElement(value)</code>函数，就是创建一个<code>textarea</code>标签，并将需要复制的内容放进去，再执行<code>const selectedText = select(fakeElement)</code>操作，我们可以看下<code>select</code>函数：</p> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> selectedText<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>nodeName <span class="token operator">===</span> <span class="token string">'SELECT'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        selectedText <span class="token operator">=</span> element<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>nodeName <span class="token operator">===</span> <span class="token string">'INPUT'</span> <span class="token operator">||</span> element<span class="token punctuation">.</span>nodeName <span class="token operator">===</span> <span class="token string">'TEXTAREA'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> isReadOnly <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token string">'readonly'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadOnly<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            element<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'readonly'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        element<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        element<span class="token punctuation">.</span><span class="token function">setSelectionRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> element<span class="token punctuation">.</span>value<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadOnly<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            element<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'readonly'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        selectedText <span class="token operator">=</span> element<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token string">'contenteditable'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            element<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">var</span> selection <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">getSelection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> range <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        range<span class="token punctuation">.</span><span class="token function">selectNodeContents</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        selection<span class="token punctuation">.</span><span class="token function">removeAllRanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        selection<span class="token punctuation">.</span><span class="token function">addRange</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>

        selectedText <span class="token operator">=</span> selection<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> selectedText<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> select<span class="token punctuation">;</span>
</code></pre> 
<p>由上面代码可知：</p> 
<p>如果元素是<code>&lt;input&gt;</code>或<code>&lt;textarea&gt;</code>标签：</p> 
<ul><li>首先检查元素是否有<code>readonly</code>属性。如果有，则暂时移除该属性，以便能够更改和选中元素的内容。</li><li>接着调用<code>element.select()</code>方法，这会使输入框或文本区域中的所有文本被选中。</li><li>使用<code>setSelectionRange()</code>方法进一步确保整个文本被选中（从位置0到文本长度）。</li><li>在获取完选择文本后，如果元素原来有<code>readonly</code>属性，则恢复该属性。</li></ul> 
<p><strong>终于是找到了 核心逻辑了，通过js主动选中<code>textarea</code>中的文本，从而绕过了 IOS和微信浏览的保护机制了</strong></p> 
<p>后面就是执行<code>command </code>复制文本的逻辑了：</p> 
<pre><code class="prism language-js"><span class="token comment">/**
 * Executes a given operation type.
 * @param {String} type
 * @return {Boolean}
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">command</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><a href="https://github.com/zenorocha/clipboard.js/tree/master">clipboard</a>的使用场景非常丰富，具体可以阅读<a href="https://clipboardjs.com/" rel="nofollow">官网</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a3cd188f7eb67cb54760070ec966dfe1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2024 年 AI代码助手AI Coding Assistant智能工具</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8b9cbcaa73a22e115a1b08ec39057280/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">手把手从零搭建ChatGPT网站midjourney-AI绘画系统，附详细搭建部署教程文档</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>