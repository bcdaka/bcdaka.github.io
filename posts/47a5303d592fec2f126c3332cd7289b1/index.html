<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>oracle数据库慢查询SQL - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/47a5303d592fec2f126c3332cd7289b1/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="oracle数据库慢查询SQL">
  <meta property="og:description" content="目录
场景：
环境：
慢SQL查询一：
问题一：办件列表查询慢
分析：
解决方法：
问题二：系统性卡顿
分析：
解决方法：
慢SQL查询二
扩展：
场景： 线上环境出现办件列表查询非常慢大概要1分钟才刷出来，及很多功能都出现系统性卡顿。
环境： oracle数据库，工作表历史表act_hi_proinst单表数据量一百多万
慢SQL查询一： select *
from (select v.sql_id,
v.sql_text,
v.sql_fulltext,
v.FIRST_LOAD_TIME,
v.last_load_time,
v.elapsed_time,
v.cpu_time,
v.disk_reads,
v.EXECUTIONS,
v.LOADS,
v.cpu_time / v.executions / 1000 / 1000 ave_cpu_time,
v.ELAPSED_TIME / v.executions / 1000 / 1000 ave_time
from v$sql v) a
where a.last_LOAD_TIME &gt; &#39;2024-01-01/00:00:00&#39; and ave_time &gt; 5 and a.executions &gt; 0 order by ave_time desc;
其中各字段含义如下：
v.sql_text: 包含SQL语句的文本内容">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-02T14:50:14+08:00">
    <meta property="article:modified_time" content="2024-02-02T14:50:14+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">oracle数据库慢查询SQL</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:40px;"></p> 
<p id="%E5%9C%BA%E6%99%AF%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E5%9C%BA%E6%99%AF%EF%BC%9A" rel="nofollow">场景：</a></p> 
<p id="%E7%8E%AF%E5%A2%83%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E7%8E%AF%E5%A2%83%EF%BC%9A" rel="nofollow">环境：</a></p> 
<p id="%E6%85%A2SQL%E6%9F%A5%E8%AF%A2%E4%B8%80%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E6%85%A2SQL%E6%9F%A5%E8%AF%A2%E4%B8%80%EF%BC%9A" rel="nofollow">慢SQL查询一：</a></p> 
<p id="%E9%97%AE%E9%A2%98%E4%B8%80%EF%BC%9A%E5%8A%9E%E4%BB%B6%E5%88%97%E8%A1%A8%E6%9F%A5%E8%AF%A2%E6%85%A2-toc" style="margin-left:80px;"><a href="#%E9%97%AE%E9%A2%98%E4%B8%80%EF%BC%9A%E5%8A%9E%E4%BB%B6%E5%88%97%E8%A1%A8%E6%9F%A5%E8%AF%A2%E6%85%A2" rel="nofollow">问题一：办件列表查询慢</a></p> 
<p id="%E5%88%86%E6%9E%90%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E5%88%86%E6%9E%90%EF%BC%9A" rel="nofollow">分析：</a></p> 
<p id="%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A" rel="nofollow">解决方法：</a></p> 
<p id="%E9%97%AE%E9%A2%98%E4%BA%8C%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%80%A7%E5%8D%A1%E9%A1%BF-toc" style="margin-left:80px;"><a href="#%E9%97%AE%E9%A2%98%E4%BA%8C%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%80%A7%E5%8D%A1%E9%A1%BF" rel="nofollow">问题二：系统性卡顿</a></p> 
<p id="%E5%88%86%E6%9E%90%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E5%88%86%E6%9E%90%EF%BC%9A" rel="nofollow">分析：</a></p> 
<p id="%C2%A0%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%C2%A0%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A" rel="nofollow"> 解决方法：</a></p> 
<p id="%E6%85%A2SQL%E6%9F%A5%E8%AF%A2%E4%BA%8C-toc" style="margin-left:40px;"><a href="#%E6%85%A2SQL%E6%9F%A5%E8%AF%A2%E4%BA%8C" rel="nofollow">慢SQL查询二</a></p> 
<p id="%C2%A0%E6%89%A9%E5%B1%95%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%C2%A0%E6%89%A9%E5%B1%95%EF%BC%9A" rel="nofollow"> 扩展：</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h3 id="%E5%9C%BA%E6%99%AF%EF%BC%9A">场景：</h3> 
<blockquote> 
 <p>线上环境出现办件列表查询非常慢大概要1分钟才刷出来，及很多功能都出现系统性卡顿。</p> 
</blockquote> 
<h3 id="%E7%8E%AF%E5%A2%83%EF%BC%9A">环境：</h3> 
<blockquote> 
 <p>oracle数据库，工作表历史表act_hi_proinst单表数据量一百多万</p> 
</blockquote> 
<h3 id="%E6%85%A2SQL%E6%9F%A5%E8%AF%A2%E4%B8%80%EF%BC%9A">慢SQL查询一：</h3> 
<blockquote> 
 <p><br> select *<br> from (select v.sql_id,<br> v.sql_text,<br> v.sql_fulltext,<br> v.FIRST_LOAD_TIME,<br> v.last_load_time,<br> v.elapsed_time,<br> v.cpu_time,<br> v.disk_reads,<br> v.EXECUTIONS,<br> v.LOADS,<br> v.cpu_time / v.executions / 1000 / 1000 ave_cpu_time,<br> v.ELAPSED_TIME / v.executions / 1000 / 1000 ave_time<br> from v$sql v) a<br> where a.last_LOAD_TIME &gt; '2024-01-01/00:00:00'  and ave_time &gt; 5 and a.executions &gt; 0 order by ave_time desc;</p> 
 <p></p> 
</blockquote> 
<p> 其中各字段含义如下：</p> 
<blockquote> 
 <p>v.sql_text: 包含SQL语句的文本内容<br> v.sql_fulltext: 包含完整的SQL语句文本内容<br> v.FIRST_LOAD_TIME: SQL语句第一次加载到共享池中的时间<br> v.last_load_time: SQL语句最后一次加载到共享池中的时间<br> v.elapsed_time: SQL语句的总执行时间（以微秒为单位）<br> v.cpu_time: SQL语句的总CPU执行时间（以微秒为单位）<br> v.disk_reads: SQL语句的总磁盘读取次数<br> v.EXECUTIONS: SQL语句的总执行次数<br> v.LOADS: SQL语句的总加载次数<br> ave_cpu_time: 每次执行的平均CPU执行时间（以秒为单位）<br> ave_time: 每次执行的平均总执行时间（以秒为单位）</p> 
</blockquote> 
<h4 id="%E9%97%AE%E9%A2%98%E4%B8%80%EF%BC%9A%E5%8A%9E%E4%BB%B6%E5%88%97%E8%A1%A8%E6%9F%A5%E8%AF%A2%E6%85%A2">问题一：办件列表查询慢</h4> 
<p>办件查询列表主要涉及到如下两个SQL语句</p> 
<pre><code>    select * from (
     select a.*,rownum as num from (
       select RES.* ,H.NAME_ as bizName, H.XZQ_ as bizXzq, H.DUE_DATE_ as bizDueDate, H.PROC_DEF_KEY_ as bizProcDefKey, 
      H.CATEGORY_ as bizCategory, H.DATUM_TYPE_ as bizDatumType, H.START_USER_ID_ as bizStartUserId, H.DEPT_CODE_ as bizDeptCode,
      H.F1_ as bizF1, H.F2_ as bizF2, H.F3_ as bizF3, H.F4_ as bizF4, H.F5_ as bizF5, H.F6_ as bizF6, H.F7_ as bizF7, 
      H.F8_ as bizF8, H.F9_ as bizF9, H.F10_ as bizF10, H.F11_ as bizF11, H.F12_ as bizF12, H.F13_ as bizF13, H.F14_ as bizF14,
      H.F15_ as bizF15, H.F16_ as bizF16, H.F17_ as bizF17, H.F18_ as bizF18, H.F19_ as bizF19, H.F20_ as bizF20
	  from gisqbpm.ACT_HI_PROCINST RES
	  left join gisqbpm.ACT_HI_BIZ_PROCINST H on  H.PROC_INST_ID_ = RES.PROC_INST_ID_)a where rownum&lt;15 )b 
    where b.num&gt;0</code></pre> 
<p>线上测试1.58秒 </p> 
<pre><code>select count(RES.ID_) 
      from gisqbpm.ACT_HI_PROCINST RES, gisqbpm.ACT_HI_BIZ_PROCINST H 
      where  H.PROC_INST_ID_ = RES.PROC_INST_ID_;  </code></pre> 
<p> 但是分页查询总数的sql语句执行五次，5.932s，3.78s，2.89s,  2.5s，1.9s</p> 
<h4 id="%E5%88%86%E6%9E%90%EF%BC%9A">分析：</h4> 
<blockquote> 
 <p>原因是前端刚打开办件查询列表时，由于查询总数的sql语句，没有任何过滤条件导致两种表只有关联查询并没有过滤故全表扫描耗时较长。</p> 
</blockquote> 
<h4 id="%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A">解决方法：</h4> 
<blockquote> 
 <p>由于两张关联表中数据是一对一的，因此如果仅仅考虑第一次查询慢的问题，直接可以去掉关联，单表查询的总数就可以了。</p> 
 <p>但是事与愿违，这只能解决办件查询第一进入的问题，如果有条件参数过滤的话（关联表的参数）还要加上这个关联表，后端改动有点大。</p> 
 <p>因此建议线上前端处理办件查询第一次进入时带上时间范围。</p> 
</blockquote> 
<h4 id="%E9%97%AE%E9%A2%98%E4%BA%8C%EF%BC%9A%E7%B3%BB%E7%BB%9F%E6%80%A7%E5%8D%A1%E9%A1%BF">问题二：系统性卡顿</h4> 
<p>描述也不算是系统系卡顿吧，有写接口还是比较快的，只能说有很多重要的操作反应都很慢，下面是获取的当天的慢SQL。</p> 
<p><img alt="" height="125" src="https://images2.imgbox.com/bd/aa/Ue1Yq0fY_o.png" width="799"></p> 
<p>这里挑选了几个耗时较长的简单的分析（这里面的sql是另外一个部门的）</p> 
<blockquote> 
 <p>DECLARE job BINARY_INTEGER := :job; next_date DATE := :mydate;  broken BOOLEAN := FALSE;</p> 
 <p>BEGIN pro_inert_rybjlcx_sed; :mydate := next_date; IF broken THEN :b := 1; ELSE :b := 0; END IF; END; </p> 
</blockquote> 
<p><span style="color:#fe2c24;">1.该SQL执行（Execution）一次 ，加载（LOADS）一次 平均耗时将近一个小时。执行 </span>pro_inert_rybjlcx_sed慢</p> 
<blockquote> 
 <p>SELECT COUNT(0) FROM (SELECT * FROM (select * from v_fwdyaq where 1=1) WHERE 1=1 )</p> 
</blockquote> 
<p><span style="color:#fe2c24;">2..该SQL执行（Execution）11次 ，加载（LOADS）216次 平均每次执行耗时接近半个小时。需要对该语句重点优化</span></p> 
<blockquote> 
 <p>DECLARE job BINARY_INTEGER := :job; next_date DATE := :mydate;  broken BOOLEAN := FALSE;</p> 
 <p>BEGIN sms_ts; :mydate := next_date; IF broken THEN :b := 1; ELSE :b := 0; END IF; END; </p> 
</blockquote> 
<p><span style="color:#fe2c24;">3.该SQL执行（Execution）四次 ，加载（LOADS）2次 平均每次执行耗时25秒。加载较频繁需要重点优化行 sms_ts操作</span></p> 
<blockquote> 
 <p>SELECT COUNT(DISTINCT "A2"."QLBSM") FROM "BDCDJ"."DJFZ_CQZS" "A2","BDCDJ"."QLR" "A1" WHERE "A2"."QLBSM"="A1"."QLBSM" AND "A2"."QSZT"=1 AND TRIM("A2"."BDCQZH")=:1 AND "A1"."QLRMC" LIKE :2</p> 
</blockquote> 
<p><span style="color:#fe2c24;">4.该SQL执行（Execution）317次 ，加载（LOADS）29次 平均每次执行耗时9秒。执行和加载较频繁需要重点优化行</span></p> 
<p><img alt="" height="277" src="https://images2.imgbox.com/6b/f8/sPuU9NEL_o.png" width="961"></p> 
<blockquote> 
 <pre><code>select * from ( select a.*, ROWNUM rnum from (     select RES.*, H.NAME_ as bizName, H.XZQ_ as bizXzq, H.DUE_DATE_ as bizDueDate, H.PROC_DEF_KEY_ as bizProcDefKey,        H.CATEGORY_ as bizCategory, H.DATUM_TYPE_ as bizDatumType, H.START_USER_ID_ as bizStartUserId,       H.F1_ as bizF1, H.F2_ as bizF2, H.F3_ as bizF3,H.F4_ as bizF4, H.F5_ as bizF5, H.F6_ as bizF6, H.F7_ as bizF7,        H.F8_ as bizF8, H.F9_ as bizF9, H.F10_ as bizF10, H.F11_ as bizF11, H.F12_ as bizF12, H.F13_ as bizF13, H.F14_ as bizF14,       H.F15_ as bizF15, H.F16_ as bizF16, H.F17_ as bizF17, H.F18_ as bizF18, H.F19_ as bizF19, H.F20_ as bizF20                  from ACT_HI_PROCINST RES            left join ACT_HI_BIZ_PROCINST H on  H.PROC_INST_ID_ = RES.PROC_INST_ID_                  WHERE  (RES.DELETE_REASON_ &lt;&gt; :1 or RES.DELETE_REASON_ is null)               order by RES.START_TIME_ desc        ) a where ROWNUM &lt; :2) where rnum  &gt;= :3</code></pre> 
 <p>分页查询语句执行了7680次，平均每次执行10s,看SQL执行计划走了时间字段，然而线上没有，线上加上索引线上执行为0.1秒</p> 
</blockquote> 
<h4>分析：</h4> 
<blockquote> 
 <p>线上START_TIME_ 列没有走索引</p> 
</blockquote> 
<h4 id="%C2%A0%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A"> 解决方法：</h4> 
<p>添加索引</p> 
<p><img alt="" height="281" src="https://images2.imgbox.com/f9/aa/EE5vA9KD_o.png" width="1038"></p> 
<p></p> 
<h3 id="%E6%85%A2SQL%E6%9F%A5%E8%AF%A2%E4%BA%8C">慢SQL查询二</h3> 
<blockquote> 
 <p>select *<br> from (select v.sql_id,<br> v.SQL_FULLTEXT,<br> v.EXECUTIONS,<br> v.ELAPSED_TIME / v.executions / 1000 / 1000 ave_time,<br> v.parsing_user_id,<br> last_LOAD_TIME<br> from v$sql v) a<br> where a.last_LOAD_TIME &gt; '2024-02-01/00:00:00'  and ave_time &gt; 5 and a.executions &gt; 0 <br> and a.parsing_user_id=(SELECT user_id FROM all_users  where username='GISQBPM')<br> order by ave_time desc;</p> 
 <p></p> 
</blockquote> 
<h3 id="%C2%A0%E6%89%A9%E5%B1%95%EF%BC%9A"> 扩展：</h3> 
<p>1.loads 和execution的区别于联系？</p> 
<blockquote> 
 <ol><li> <p>loads：表示SQL语句在共享池中被加载的次数。每当一个SQL语句被解析并放入共享池中，loads的值就会增加。这个值可以帮助您了解一个SQL语句被重复使用的频率。</p> </li><li> <p>executions：表示SQL语句被执行的次数。每当一个SQL语句被实际执行，executions的值就会增加。这个值可以帮助您了解一个SQL语句在实际执行过程中的频率。</p> </li></ol> 
</blockquote> 
<p>2. 同一个SQL为什么会被重复加入到共享池</p> 
<blockquote> 
 <p>在Oracle数据库中，同一个SQL语句可能会被重复加入到共享池的原因有以下几点：</p> 
 <ol><li> <p>绑定变量不同：如果SQL语句使用了绑定变量，即在SQL语句中使用了占位符，那么不同的绑定变量值会导致不同的SQL语句被加入到共享池中。</p> </li><li> <p>SQL语句文本不同：即使SQL语句的逻辑相同，但如果SQL语句的文本不同（比如空格、大小写等），Oracle也会将它们当作不同的SQL语句进行处理。</p> </li><li> <p>不同的解析环境：在不同的解析环境下，相同的SQL语句可能会被多次解析并加载到共享池中，比如在不同的会话或者不同的数据库连接中。</p> </li><li> <p>共享池空间不足：如果共享池空间不足，Oracle可能会根据一些策略进行SQL语句的淘汰和重新加载，这也会导致同一个SQL语句被重复加载到共享池中。</p> </li></ol> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/415d55d9580c023950357090f4e7fc83/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL中如何将字符串替换</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4d83724b11bfa666ed30a5d295b27ec2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Unity 接入海康摄像头（WebGL，PC），避坑专用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>