<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【prometheus】Pushgateway安装和使用 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/eaabfdd85421f91ed1a5c18251b1605d/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【prometheus】Pushgateway安装和使用">
  <meta property="og:description" content="目录
一、Pushgateway概述
1.1 Pushgateway简介
1.2 Pushgateway优点
1.3 pushgateway缺点
二、测试环境
三、安装测试
3.1 pushgateway安装
3.2 prometheus添加pushgateway
3.3 推送指定的数据格式到pushgateway
1.添加单条数据
2.添加复杂数据
3.SDk-prometheus-client使用
【Prometheus】概念和工作原理介绍_prometheus工作原理-CSDN博客
【Prometheus】k8s集群部署node-exporter_kubectl 安装 promethues node-exporter-CSDN博客
【prometheus】k8s集群部署prometheus server-CSDN博客
【prometheus】k8s集群部署Grafana安装和配置|Prometheus监控K8S
【prometheus】k8s集群部署AlertManager实现邮件和钉钉告警-CSDN博客
【prometheus】监控MySQL并实现可视化-CSDN博客
【prometheus】监控nginx-CSDN博客
一、Pushgateway概述 1.1 Pushgateway简介 Pushgateway是prometheus的一个组件，prometheus server默认是通过exporter主动获取数据（默认采取pull拉取数据），pushgateway则是通过被动方式推送数据到prometheus server，用户可以写一些自定义的监控脚本把需要监控的数据发送给pushgateway， 然后pushgateway再把数据发送给Prometheus server。
1.2 Pushgateway优点 Prometheus 默认采用定时pull 模式拉取targets数据，但是如果不在一个子网或者防火墙，prometheus就拉取不到targets数据，所以可以采用各个target往pushgateway上push数据，然后prometheus去pushgateway上定时pull数据在监控业务数据的时候，需要将不同数据汇总, 汇总之后的数据可以由pushgateway统一收集，然后由 Prometheus 统一拉取。 1.3 pushgateway缺点 Prometheus拉取状态只针对 pushgateway, 不能对每个节点都有效；Pushgateway出现问题，整个采集到的数据都会出现问题监控下线，prometheus还会拉取到旧的监控数据，需要手动清理 pushgateway不要的数据。 二、测试环境 IP 主机名
192.168.2.139
master1
192.168.40.140
node1
三、安装测试 3.1 pushgateway安装 在node1节点操作
docker pull prom/pushgateway docker run -d --name pushgateway -p 9091:9091 prom/pushgateway 在浏览器访问192.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-06T08:48:18+08:00">
    <meta property="article:modified_time" content="2024-05-06T08:48:18+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【prometheus】Pushgateway安装和使用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p class="img-center"><img alt="" height="534" id="iSh5U" src="https://images2.imgbox.com/32/c0/3ecr1Kug_o.png" width="950"></p> 
<p id="u935185e5"><strong>目录</strong></p> 
<p id="nD8qb-toc" style="margin-left:0px;"><a href="#nD8qb" rel="nofollow">一、Pushgateway概述</a></p> 
<p id="iBk5X-toc" style="margin-left:40px;"><a href="#iBk5X" rel="nofollow">1.1 Pushgateway简介</a></p> 
<p id="o9tMl-toc" style="margin-left:40px;"><a href="#o9tMl" rel="nofollow">1.2 Pushgateway优点</a></p> 
<p id="BgFcn-toc" style="margin-left:40px;"><a href="#BgFcn" rel="nofollow">1.3 pushgateway缺点</a></p> 
<p id="EtbC5-toc" style="margin-left:0px;"><a href="#EtbC5" rel="nofollow">二、测试环境</a></p> 
<p id="jO5Ky-toc" style="margin-left:0px;"><a href="#jO5Ky" rel="nofollow">三、安装测试</a></p> 
<p id="Jkj6n-toc" style="margin-left:40px;"><a href="#Jkj6n" rel="nofollow">3.1 pushgateway安装</a></p> 
<p id="op7h2-toc" style="margin-left:40px;"><a href="#op7h2" rel="nofollow">3.2 prometheus添加pushgateway</a></p> 
<p id="kmfq6-toc" style="margin-left:40px;"><a href="#kmfq6" rel="nofollow">3.3 推送指定的数据格式到pushgateway</a></p> 
<p id="BtXYw-toc" style="margin-left:80px;"><a href="#BtXYw" rel="nofollow">1.添加单条数据</a></p> 
<p id="JTBAn-toc" style="margin-left:80px;"><a href="#JTBAn" rel="nofollow">2.添加复杂数据</a></p> 
<p id="w4ukg-toc" style="margin-left:80px;"><a href="#w4ukg" rel="nofollow">3.SDk-prometheus-client使用</a></p> 
<hr id="hr-toc"> 
<hr id="M7VIy"> 
<p id="ub5171905"><a href="https://kangll.blog.csdn.net/article/details/136219364?spm=1001.2014.3001.5502" rel="nofollow" title="【Prometheus】概念和工作原理介绍_prometheus工作原理-CSDN博客">【Prometheus】概念和工作原理介绍_prometheus工作原理-CSDN博客</a></p> 
<p id="ub9ed7285"><a href="https://kangll.blog.csdn.net/article/details/136447177?spm=1001.2014.3001.5502" rel="nofollow" title="【Prometheus】k8s集群部署node-exporter_kubectl 安装 promethues node-exporter-CSDN博客">【Prometheus】k8s集群部署node-exporter_kubectl 安装 promethues node-exporter-CSDN博客</a></p> 
<p id="ucdaa64fa"><a href="https://kangll.blog.csdn.net/article/details/136783153?spm=1001.2014.3001.5502" rel="nofollow" title="【prometheus】k8s集群部署prometheus server-CSDN博客">【prometheus】k8s集群部署prometheus server-CSDN博客</a></p> 
<p id="u022ca3e6"><a href="https://kangll.blog.csdn.net/article/details/137217639?spm=1001.2014.3001.5502" rel="nofollow" title="【prometheus】k8s集群部署Grafana安装和配置|Prometheus监控K8S">【prometheus】k8s集群部署Grafana安装和配置|Prometheus监控K8S</a></p> 
<p id="u63ccb1df"><a href="https://kangll.blog.csdn.net/article/details/138046738?spm=1001.2014.3001.5502" rel="nofollow" title="【prometheus】k8s集群部署AlertManager实现邮件和钉钉告警-CSDN博客">【prometheus】k8s集群部署AlertManager实现邮件和钉钉告警-CSDN博客</a></p> 
<p id="u50a6a340"><a href="https://kangll.blog.csdn.net/article/details/138174969?spm=1001.2014.3001.5502" rel="nofollow" title="【prometheus】监控MySQL并实现可视化-CSDN博客">【prometheus】监控MySQL并实现可视化-CSDN博客</a></p> 
<p id="uea575570"><a href="https://kangll.blog.csdn.net/article/details/138275830?spm=1001.2014.3001.5502" rel="nofollow" title="【prometheus】监控nginx-CSDN博客">【prometheus】监控nginx-CSDN博客</a></p> 
<hr> 
<h2><span style="color:#511b78;">一、Pushgateway概述</span></h2> 
<hr id="CDk9J"> 
<h3 id="iBk5X">1.1 Pushgateway简介</h3> 
<hr id="ciJ2y"> 
<blockquote> 
 <p id="u6d087d1b">Pushgateway是prometheus的一个组件，prometheus server默认是通过exporter主动获取数据（默认采取pull拉取数据），pushgateway则是通过被动方式推送数据到prometheus server，用户可以写一些自定义的监控脚本把需要监控的数据发送给pushgateway， 然后pushgateway再把数据发送给Prometheus server。<img alt="" height="558" src="https://images2.imgbox.com/7c/ef/CwOoVcY8_o.png" width="929"></p> 
</blockquote> 
<h3 id="o9tMl">1.2 Pushgateway优点</h3> 
<hr id="M9TMK"> 
<ul><li id="u4a5a8918">Prometheus 默认采用定时pull 模式拉取targets数据，但是如果不在一个子网或者防火墙，prometheus就拉取不到targets数据，所以可以采用各个target往pushgateway上push数据，然后prometheus去pushgateway上定时pull数据</li><li id="u2448d212">在监控业务数据的时候，需要将不同数据汇总, 汇总之后的数据可以由pushgateway统一收集，然后由 Prometheus 统一拉取。</li></ul> 
<h3 id="BgFcn">1.3 pushgateway缺点</h3> 
<hr id="CUyo5"> 
<ul><li id="u05e6f523">Prometheus拉取状态只针对 pushgateway, 不能对每个节点都有效；</li><li id="u4d31caa1">Pushgateway出现问题，整个采集到的数据都会出现问题</li><li id="u80b3c325">监控下线，prometheus还会拉取到旧的监控数据，需要手动清理 pushgateway不要的数据。</li></ul> 
<hr> 
<h2 id="EtbC5"><span style="color:#511b78;">二、测试环境</span></h2> 
<hr id="jgV4c"> 
<table id="XRNwE"><tbody><tr><td> <p id="u7edc6101"><strong>IP </strong></p> </td><td> <p id="u7d42e23a"><strong>主机名</strong></p> </td></tr><tr><td> <p id="uafcb8820">192.168.2.139</p> </td><td> <p id="u672aeb11">master1</p> </td></tr><tr><td> <p id="ud9d22ca3">192.168.40.140</p> </td><td> <p id="ueb1d7429">node1</p> </td></tr></tbody></table> 
<hr id="GJTru"> 
<h2 id="jO5Ky"><span style="color:#511b78;">三、安装测试</span></h2> 
<hr id="va06J"> 
<h3 id="Jkj6n"><span style="color:#956fe7;">3.1 pushgateway安装</span></h3> 
<hr id="ZPUzd"> 
<p id="u4762fbfd">在node1节点操作</p> 
<pre id="ANJXA"><code>docker pull prom/pushgateway
docker run -d --name pushgateway -p 9091:9091 prom/pushgateway</code></pre> 
<p id="uc495ed2c">在浏览器访问192.168.2.140:9091出现如下ui界面<img alt="" height="754" src="https://images2.imgbox.com/01/c4/A3bimTL2_o.png" width="890"></p> 
<p id="ua375308d"></p> 
<h3 id="op7h2"><span style="color:#956fe7;">3.2 prometheus添加pushgateway</span></h3> 
<hr id="HNjke"> 
<p id="u0ccd8bd7">修改prometheus-cfg.yaml文件</p> 
<pre id="papv7"><code>- job_name: 'pushgateway'
      scrape_interval: 5s
      static_configs:
      - targets: ['192.168.2.140:9091']
   honor_labels: true</code></pre> 
<p id="u4b1ace5d">更新</p> 
<pre id="vqJIL"><code>kubectl apply -f prometheus-alertmanager-cfg.yaml
kubectl delete -f prometheus-alertmanager-deploy.yaml
kubectl apply  -f prometheus-alertmanager-deploy.yaml</code></pre> 
<p id="ufb8c6e3c">登录prometheus <a href="http://192.168.2.139:30242/targets" rel="nofollow" title="http://192.168.2.139:30242/targets">http://192.168.2.139:30242/targets</a><img alt="" height="941" src="https://images2.imgbox.com/99/8b/euewxzfr_o.png" width="1200"></p> 
<p id="u5ccaf149"></p> 
<h3 id="kmfq6"><span style="color:#956fe7;">3.3 推送指定的数据格式到pushgateway</span></h3> 
<hr id="Lvv08"> 
<h4 id="BtXYw">1.添加单条数据</h4> 
<pre id="E1oq1"><code># 向 {job="test_job"} 添加单条数据：
echo " metric 3.6" | curl --data-binary @- http://192.168.2.140:9091/metrics/job/test_job
</code></pre> 
<p id="ub3d66ca6">这里需要注意的是将&lt;key &amp; value&gt;推送给pushgateway，curl --data-binary是将HTTP POST请求中的数据发送给HTTP服务器（pushgateway），和用户提交THML表单时浏览器的行为是一样的，HTTP POST请求中的数据为纯二进制数据。<img alt="" height="634" src="https://images2.imgbox.com/41/21/2cNAfNEB_o.png" width="1200"></p> 
<p id="u794cb8e5">prometheus web中查询</p> 
<p class="img-center"><img alt="" height="368" id="u8b416374" src="https://images2.imgbox.com/e1/e4/69TICTJu_o.png" width="901"></p> 
<h4 id="JTBAn">2.添加复杂数据</h4> 
<pre id="Wq259"><code># 添加复杂数据
cat &lt;&lt;EOF | curl --data-binary @- http://192.168.2.140:9091/metrics/job/test_job/instance/test_instance
# TYPE node_memory_usage gauge
node_memory_usage 26
# TYPE memory_total gauge
node_memory_total 26000
EOF</code></pre> 
<p id="ube84cb7a"><a href="http://192.168.0.143:9091/metrics/job/pushgateway/instance/%24instance_name%EF%BC%8C%E8%BF%99%E6%9D%A1%E8%BF%9E%E6%8E%A5%E4%B8%BB%E8%A6%81%E5%88%86%E4%B8%BA%E4%B8%89%E4%B8%AA%E9%83%A8%E5%88%86%EF%BC%9A" rel="nofollow" title="这条连接主要分为三个部分：">这条连接主要分为三个部分：</a></p> 
<ul><li id="u705b31b9">http://192.168.2.143:9091/metrics/job/test_job：这是URL的主location，发送到哪个URL</li><li id="u9d7c22cd">job/test_job：表示是推送到哪个prometheus定义的job里面，上面我们定义的job_name为pushgateway</li><li id="ucf18ff83">instance/test_instance：表示推送后显示的主机名称是什么，从上面pushgateway图也可以看出</li></ul> 
<p class="img-center"><img alt="" height="495" id="u2ba8400d" src="https://images2.imgbox.com/7a/1e/OruvTzAE_o.png" width="1200"></p> 
<p id="u4750d9c8">如下是删除某个实例</p> 
<pre id="oebng"><code># 删除某个组下某个实例的所有数据
curl -X DELETE http://192.168.2.140:9091/metrics/job/test_job/instance/test_instance

# 删除某个组下的所有数据：
curl -X DELETE http://192.168.2.140:9091/metrics/job/test_job</code></pre> 
<h4 id="w4ukg">3.SDk-prometheus-client使用</h4> 
<hr id="bxRz2"> 
<p id="u1c3814fa"><strong>python安装 prometheus_client</strong></p> 
<p id="ua51551dc">使用 pip 工具可以非常方便地安装 prometheus_client：<img alt="" height="281" src="https://images2.imgbox.com/94/a3/KFSWwVcX_o.png" width="1054"></p> 
<p id="u9bc12e75">测试脚本</p> 
<pre id="HA97g"><code class="language-python"># -*- coding: utf-8 -*-

# 导入所需的库
from prometheus_client import CollectorRegistry, Gauge, push_to_gateway


if __name__ == '__main__':
    # 定义和注册指标
    registry = CollectorRegistry()
    labels = ['req_status', 'req_method', 'req_url']
    g_one = Gauge('requests_total', 'url请求次数', labels, registry=registry)
    g_two = Gauge('avg_response_time_seconds', '1分钟内的URL平均响应时间', labels, registry=registry)

    # 收集和记录指标数据
    g_one.labels('200','GET', '/test/url').set(1) #set设定值
    g_two.labels('200','GET', '/test/api/url/').set(10) #set设定值

    # 推送指标数据到Pushgateway
    push_to_gateway('http://192.168.2.140:9091', job='SampleURLMetrics', registry=registry)
</code></pre> 
<p id="u6419241a">在这个示例中，我们定义了一个名为requests_total的指标，记录了一个值为1和10的示例数据，并将指标数据推送到了名为example_job的job中。<img alt="" height="709" src="https://images2.imgbox.com/93/84/AaR68p7A_o.png" width="1200"></p> 
<p id="ufb51e686"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/26f01c967c1b7df59eefb12bb6d557ff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JavaScript算法描述【排序与搜索】六大经典排序|搜索旋转排序数组|在排序数组中查找元素的第一个和最后一个位置、数组中的第K个|</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6d8881496f79bc31f25668ad7a440aa6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">springAI框架学习总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>