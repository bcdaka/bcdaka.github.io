<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于Django的博客系统之用HayStack连接elasticsearch增加搜索功能（五） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/a57c891b8c828f83734e21ca3fa6df4f/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="基于Django的博客系统之用HayStack连接elasticsearch增加搜索功能（五）">
  <meta property="og:description" content="上一篇：搭建基于Django的博客系统数据库迁移从Sqlite3到MySQL（四）
下一篇：基于Django的博客系统之增加类别导航栏（六）
功能概述 添加搜索框用于搜索博客。 需求详细描述 1. 添加搜索框用于搜索博客
描述： 在博客首页添加搜索框，用户可以通过关键词搜索博客文章。功能要求： 搜索框位置：导航栏或页面顶部。支持根据标题和内容进行搜索。搜索结果显示匹配的博客列表。 用户故事： 作为用户，我希望能够通过搜索框快速找到感兴趣的博客文章。 技术结构 实现一个博客搜索功能，可以同时使用 Elasticsearch 和 MySQL 各自的优势。以下是如何区分和结合使用这两种技术的方法：
使用 MySQL 的部分 数据存储： 存储博客文章的基本信息，如标题、作者、发布时间、分类等。存储用户信息、评论、标签等结构化数据。 基础查询和管理： 进行常规的 CRUD 操作，如创建、读取、更新、删除博客文章。进行简单的过滤和排序，如按发布时间、作者、分类等查询文章。 使用 Elasticsearch 的部分 全文搜索： 存储和索引博客文章的全文内容，以支持全文搜索功能。对用户搜索的关键词进行快速匹配，返回相关的文章列表。 复杂查询： 支持复杂的查询需求，如模糊搜索、布尔搜索、按相关性排序等。支持自动补全、拼写纠错等高级搜索功能。 集成 MySQL 和 Elasticsearch 数据同步： 需要将 MySQL 中的博客文章数据同步到 Elasticsearch 中，以确保搜索功能能够使用最新的数据。可以使用定时任务或实时数据同步机制来保持两者数据的一致性。例如，使用工具如 Logstash、Beats 或自定义的同步程序。 搜索接口设计： 提供一个统一的搜索接口，前端用户提交搜索请求时，后台从 Elasticsearch 中查询搜索结果。查询到的搜索结果中包含文章的基本信息，从 Elasticsearch 返回文章的 ID，然后从 MySQL 中获取详细信息（如作者、评论等）。 实现步骤 要在 Django 博客应用中添加搜索框，以便用户可以搜索博客内容，可以按照以下步骤进行：
1. 安装 Django 搜索库 首先，确保你已经安装了 Django 搜索库。一个常用的选择是 django-haystack 库，它提供了与多个搜索引擎（如 Elasticsearch、Solr 和 Whoosh 等）集成的功能。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-31T13:55:02+08:00">
    <meta property="article:modified_time" content="2024-05-31T13:55:02+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于Django的博客系统之用HayStack连接elasticsearch增加搜索功能（五）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><a href="https://blog.csdn.net/finly4599/article/details/139290101?spm=1001.2014.3001.5502">上一篇：搭建基于Django的博客系统数据库迁移从Sqlite3到MySQL（四）</a><br> <a href="https://blog.csdn.net/finly4599/article/details/139350606?spm=1001.2014.3001.5502">下一篇：基于Django的博客系统之增加类别导航栏（六）</a></p> 
<h3><a id="_3"></a>功能概述</h3> 
<ol><li>添加搜索框用于搜索博客。</li></ol> 
<h3><a id="_7"></a>需求详细描述</h3> 
<p><strong>1. 添加搜索框用于搜索博客</strong></p> 
<ul><li><strong>描述：</strong> 在博客首页添加搜索框，用户可以通过关键词搜索博客文章。</li><li>功能要求： 
  <ul><li>搜索框位置：导航栏或页面顶部。</li><li>支持根据标题和内容进行搜索。</li><li>搜索结果显示匹配的博客列表。</li></ul> </li><li>用户故事： 
  <ul><li>作为用户，我希望能够通过搜索框快速找到感兴趣的博客文章。</li></ul> </li></ul> 
<h2><a id="_19"></a>技术结构</h2> 
<p>实现一个博客搜索功能，可以同时使用 Elasticsearch 和 MySQL 各自的优势。以下是如何区分和结合使用这两种技术的方法：</p> 
<h4><a id="_MySQL__22"></a>使用 MySQL 的部分</h4> 
<ol><li><strong>数据存储</strong>： 
  <ul><li>存储博客文章的基本信息，如标题、作者、发布时间、分类等。</li><li>存储用户信息、评论、标签等结构化数据。</li></ul> </li><li><strong>基础查询和管理</strong>： 
  <ul><li>进行常规的 CRUD 操作，如创建、读取、更新、删除博客文章。</li><li>进行简单的过滤和排序，如按发布时间、作者、分类等查询文章。</li></ul> </li></ol> 
<h4><a id="_Elasticsearch__31"></a>使用 Elasticsearch 的部分</h4> 
<ol><li><strong>全文搜索</strong>： 
  <ul><li>存储和索引博客文章的全文内容，以支持全文搜索功能。</li><li>对用户搜索的关键词进行快速匹配，返回相关的文章列表。</li></ul> </li><li><strong>复杂查询</strong>： 
  <ul><li>支持复杂的查询需求，如模糊搜索、布尔搜索、按相关性排序等。</li><li>支持自动补全、拼写纠错等高级搜索功能。</li></ul> </li></ol> 
<h4><a id="_MySQL__Elasticsearch_40"></a>集成 MySQL 和 Elasticsearch</h4> 
<ol><li><strong>数据同步</strong>： 
  <ul><li>需要将 MySQL 中的博客文章数据同步到 Elasticsearch 中，以确保搜索功能能够使用最新的数据。</li><li>可以使用定时任务或实时数据同步机制来保持两者数据的一致性。例如，使用工具如 Logstash、Beats 或自定义的同步程序。</li></ul> </li><li><strong>搜索接口设计</strong>： 
  <ul><li>提供一个统一的搜索接口，前端用户提交搜索请求时，后台从 Elasticsearch 中查询搜索结果。</li><li>查询到的搜索结果中包含文章的基本信息，从 Elasticsearch 返回文章的 ID，然后从 MySQL 中获取详细信息（如作者、评论等）。</li></ul> </li></ol> 
<h3><a id="_49"></a>实现步骤</h3> 
<p>要在 Django 博客应用中添加搜索框，以便用户可以搜索博客内容，可以按照以下步骤进行：</p> 
<h4><a id="1__Django__53"></a>1. 安装 Django 搜索库</h4> 
<p>首先，确保你已经安装了 Django 搜索库。一个常用的选择是 <code>django-haystack</code> 库，它提供了与多个搜索引擎（如 Elasticsearch、Solr 和 Whoosh 等）集成的功能。</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> django-haystack
</code></pre> 
<h4><a id="2__61"></a>2. 配置搜索引擎</h4> 
<p>选择并配置你想要使用的搜索引擎。例如，如果选择使用 Whoosh 搜索引擎，需要在 <code>settings.py</code> 文件中配置 Haystack 设置：</p> 
<pre><code class="prism language-python"><span class="token comment"># settings.py</span>

INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># 其他应用...</span>
    <span class="token string">'haystack'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

HAYSTACK_CONNECTIONS <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'haystack.backends.elasticsearch_backend.ElasticsearchSearchEngine'</span><span class="token punctuation">,</span>
        <span class="token string">'URL'</span><span class="token punctuation">:</span> <span class="token string">'http://localhost:9200/'</span><span class="token punctuation">,</span>  <span class="token comment"># Elasticsearch 服务器的 URL</span>
        <span class="token string">'INDEX_NAME'</span><span class="token punctuation">:</span> <span class="token string">'haystack'</span><span class="token punctuation">,</span>  <span class="token comment"># Elasticsearch 索引的名称</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

HAYSTACK_SIGNAL_PROCESSOR <span class="token operator">=</span> <span class="token string">'haystack.signals.RealtimeSignalProcessor'</span>
</code></pre> 
<h4><a id="3__84"></a>3. 创建搜索索引类</h4> 
<p>为你的博客模型创建一个搜索索引类，告诉 Haystack 如何索引你的数据。假设你有一个名为 <code>Post</code> 的博客模型：</p> 
<pre><code class="prism language-python"><span class="token comment"># search_indexes.py</span>

<span class="token keyword">from</span> haystack <span class="token keyword">import</span> indexes
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Post

<span class="token keyword">class</span> <span class="token class-name">PostIndex</span><span class="token punctuation">(</span>indexes<span class="token punctuation">.</span>SearchIndex<span class="token punctuation">,</span> indexes<span class="token punctuation">.</span>Indexable<span class="token punctuation">)</span><span class="token punctuation">:</span>
    text <span class="token operator">=</span> indexes<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>document<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> use_template<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get_model</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> Post
</code></pre> 
<p>在这个示例中，我们使用 <code>text</code> 字段来索引博客内容。你可以根据需要添加更多的字段。</p> 
<h4><a id="4__103"></a>4. 创建搜索模板</h4> 
<p>在你的博客模板文件夹中创建一个模板文件，用于显示搜索结果。这个模板将根据搜索结果显示匹配的博客文章。</p> 
<pre><code class="prism language-html"><span class="token comment">&lt;!-- templates/search/post_text.txt --&gt;</span>

{<!-- -->{ object.title }}
{<!-- -->{ object.content }}
</code></pre> 
<p><strong>同步索引</strong>：运行 Django 的管理命令来创建或更新搜索索引。</p> 
<pre><code class="prism language-bash">python manage.py rebuild_index
</code></pre> 
<h4><a id="5__URL__120"></a>5. 更新 URL 配置</h4> 
<p>将搜索视图添加到你的 URL 配置中，以便用户可以访问搜索页面并执行搜索。</p> 
<pre><code class="prism language-python"><span class="token comment"># urls.py</span>

<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> views

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># 其他 URL 配置...</span>
    path<span class="token punctuation">(</span><span class="token string">'search/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>SearchView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'search'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="6__136"></a>6. 创建搜索视图</h4> 
<p>创建一个视图类来处理搜索请求，并将搜索结果呈现给用户。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> haystack<span class="token punctuation">.</span>query <span class="token keyword">import</span> SearchQuerySet

<span class="token keyword">def</span> <span class="token function">search_view</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    query <span class="token operator">=</span> request<span class="token punctuation">.</span>GET<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'q'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    results <span class="token operator">=</span> SearchQuerySet<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>content<span class="token operator">=</span>query<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'search_results.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'results'</span><span class="token punctuation">:</span> results<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="7__149"></a>7. 创建搜索模板</h4> 
<p>创建一个模板文件，用于显示搜索结果。在这个模板中，你可以根据需要定制搜索结果的展示方式。</p> 
<pre><code class="prism language-html"><span class="token comment">&lt;!-- templates/search.html --&gt;</span>

{% for result in page.object_list %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{ result.object.get_absolute_url }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ result.object.title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{<!-- -->{ result.object.content }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
{% empty %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>No results found.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
{% endfor %}

{% if is_paginated %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pagination<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>step-links<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            {% if page.has_previous %}
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?q={<!-- -->{ query }}&amp;page=1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="«">&amp;laquo;</span> first<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?q={<!-- -->{ query }}&amp;page={<!-- -->{ page.previous_page_number }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>previous<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            {% endif %}

            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>current<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                Page {<!-- -->{ page.number }} of {<!-- -->{ page.paginator.num_pages }}.
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>

            {% if page.has_next %}
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?q={<!-- -->{ query }}&amp;page={<!-- -->{ page.next_page_number }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>next<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?q={<!-- -->{ query }}&amp;page={<!-- -->{ page.paginator.num_pages }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>last <span class="token entity named-entity" title="»">&amp;raquo;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            {% endif %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endif %}
</code></pre> 
<h4><a id="8__184"></a>8. 创建搜索表单</h4> 
<p>最后，创建一个搜索表单，让用户输入搜索关键字并提交搜索请求。</p> 
<pre><code class="prism language-html"><span class="token comment">&lt;!-- templates/search_form.html --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{% url 'search' %}<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>get<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>q<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Search...<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Search<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>将搜索表单包含在你的博客页面中的适当位置，用户就可以使用它来搜索博客内容了。</p> 
<p>这就是在 Django 博客应用中添加搜索框的基本步骤。根据你的需求，你可以进一步定制搜索功能，例如添加搜索结果的高亮显示、自定义搜索表单字段等。</p> 
<h3><a id="elasticsearch_201"></a>连接elasticsearch</h3> 
<p>具体参看这篇<a href="https://blog.csdn.net/finly4599/article/details/139292916?spm=1001.2014.3001.5502">Windows安装ElasticSearch版本7.17.0</a></p> 
<p>要连接 Elasticsearch，你需要配置 Django Haystack 的后端为 Elasticsearch 后端。下面是一些步骤：</p> 
<ol><li><strong>安装 Elasticsearch</strong>：首先确保你已经安装了 Elasticsearch 并且它正在运行。你可以从 Elasticsearch 的官方网站上下载并安装它。</li><li><strong>安装 Haystack</strong>：确保你已经安装了 Django Haystack。你可以使用 pip 进行安装：<code>pip install django-haystack</code>。</li><li><strong>安装 Elasticsearch 后端</strong>：你需要安装与 Elasticsearch 兼容的 Haystack 后端。通常情况下，你需要安装 <code>elasticsearch-dsl</code>，它是 Elasticsearch 的 Python 客户端库。你可以使用 pip 进行安装：<code>pip install elasticsearch-dsl</code>。</li><li><strong>配置 Haystack 设置</strong>：在 Django 项目的 <code>settings.py</code> 文件中，配置 Haystack 设置以使用 Elasticsearch 后端。这包括指定 Elasticsearch 的主机和端口等信息。</li></ol> 
<pre><code class="prism language-python">HAYSTACK_CONNECTIONS <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'ENGINE'</span><span class="token punctuation">:</span> <span class="token string">'haystack.backends.elasticsearch_backend.ElasticsearchSearchEngine'</span><span class="token punctuation">,</span>
        <span class="token string">'URL'</span><span class="token punctuation">:</span> <span class="token string">'http://localhost:9200/'</span><span class="token punctuation">,</span>  <span class="token comment"># Elasticsearch 服务器的 URL</span>
        <span class="token string">'INDEX_NAME'</span><span class="token punctuation">:</span> <span class="token string">'haystack'</span><span class="token punctuation">,</span>  <span class="token comment"># Elasticsearch 索引的名称</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol><li><strong>建立索引</strong>：运行 <code>python manage.py rebuild_index</code> 命令来建立你的模型的搜索索引。这将会在 Elasticsearch 中创建对应的索引。</li><li><strong>运行你的应用程序</strong>：现在你的 Django 应用程序应该能够连接到 Elasticsearch 并使用它来进行全文搜索了。</li></ol> 
<h3><a id="_224"></a>问题和解决</h3> 
<p>报错<code> from django.utils.datetime_safe import date, datetime ModuleNotFoundError: No module named 'django.utils.datetime_safe'</code></p> 
<p>分析解决：</p> 
<p>在 Django 3.2 中，<code>django.utils.datetime_safe</code> 模块已被移除。这个模块提供了在处理日期和时间时的安全操作，以防止由于 <code>datetime</code> 和 <code>date</code> 对象的类型不同而导致的一些问题。</p> 
<p>如果你的代码中依赖了 <code>django.utils.datetime_safe</code> 模块，你可以尝试以下替代方法：</p> 
<ol><li><strong>直接使用 datetime 和 date</strong>：在绝大多数情况下，直接使用内置的 <code>datetime</code> 和 <code>date</code> 类应该没有问题。只要确保在处理日期和时间时，类型的转换和比较是正确的即可。</li><li><strong>在需要的地方进行转换</strong>：如果你的代码在某些情况下需要确保 <code>datetime</code> 和 <code>date</code> 对象的类型一致，你可以手动进行转换。比如，使用 <code>timezone.now()</code> 获取当前时间，使用 <code>datetime.strptime()</code> 将字符串转换为 <code>datetime</code> 对象等。</li><li><strong>更新依赖</strong>：如果你使用的是第三方库，可以尝试更新这些库的版本，看看是否有与 Django 3.2 兼容的版本。</li></ol> 
<p>确保你的代码不再依赖于 <code>django.utils.datetime_safe</code> 模块后，就可以解决这个错误了。切换为<code>elasticsearch</code>连接。报错如下<code> raise MissingDependency( haystack.exceptions.MissingDependency: The 'elasticsearch5' backend requires the installation of 'elasticsearch&gt;=5.0.0,&lt;6.0.0'. Please refer to the documentation.</code></p> 
<p><img src="https://images2.imgbox.com/32/47/wIhdpixB_o.png" alt="在这里插入图片描述"></p> 
<p>修改<code>settings.py</code>中<code>HAYSTACK_CONNECTIONS</code>连接的<code>Elasticsearch</code>版本为8.x，如下：</p> 
<pre><code>HAYSTACK_CONNECTIONS = {
    'default': {
        'ENGINE': 'haystack.backends.elasticsearch8_backend.Elasticsearch8SearchEngine',
        'URL': 'http://localhost:9200/',
        'INDEX_NAME': 'myblog',
    },
}
</code></pre> 
<p>报错<code>ModuleNotFoundError: No module named 'haystack.backends.elasticsearch8_backend'</code></p> 
<p>原因：<code>Haystack</code>中没有提供一个专门用于<code>Elasticsearch</code> 8.x 的后端引擎。使用 <code>haystack.backends.elasticsearch7_backend.Elasticsearch7SearchEngine</code> 就可以支持 <code>Elasticsearch</code> 7.x。</p> 
<p>重新安装<code>elasticsearch</code>版本号为7.17。见这篇文章</p> 
<p>卸载不需要的驱动</p> 
<pre><code class="prism language-bash">pip uninstall elasticsearch
pip uninstall elasticsearch-dsl
</code></pre> 
<p>安装需要的驱动</p> 
<pre><code class="prism language-bash"> pip <span class="token function">install</span> <span class="token assign-left variable">elasticsearch</span><span class="token operator">==</span><span class="token number">7.17</span>.0
 pip <span class="token function">install</span> elasticsearch-dsl<span class="token operator">==</span><span class="token number">7.4</span>.1
</code></pre> 
<p>再次调用启动搜索<code>index</code>命令<code>python manage.py rebuild_index</code></p> 
<p>报错<code>ImportError: cannot import name 'datetime_safe' from 'django.utils'</code></p> 
<p>原因：Django 3.2 中移除了 <code>django.utils.datetime_safe</code> 模块引起的。Haystack 应该已经更新以适应 Django 3.2。</p> 
<p>执行命令下载haystack支持django5.0.7</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> git+https://github.com/django-haystack/django-haystack.git
</code></pre> 
<p>再次调用启动搜索<code>index</code>命令</p> 
<pre><code class="prism language-bash">python manage.py rebuild_index
</code></pre> 
<p>运行成功。效果如下：</p> 
<p><img src="https://images2.imgbox.com/d9/25/asWUP0G5_o.png" alt="在这里插入图片描述"></p> 
<p>调用<code>http://localhost:8000/search/?q=%E6%AF%94%E4%BC%AF</code>后，结果如下：</p> 
<p><img src="https://images2.imgbox.com/5d/03/sLCCA4tM_o.png" alt="在这里插入图片描述"></p> 
<p>分析原因<code>elasticsearch</code>的index有问题。</p> 
<p>用<code>tree /F</code>命令获取全文件夹下的文件格式表。</p> 
<p>通过下面命令获取当前<code>elasticsearch</code>里面的<code>index</code>：</p> 
<p><code>Invoke-WebRequest -Uri "http://localhost:9200/_cat/indices?v"</code></p> 
<p>在<code>post_text.txt</code>里面添加一段<code>index</code>的指向</p> 
<pre><code>&lt;!-- templates/search/indexes/blog/post_text.txt --&gt;
</code></pre> 
<p>执行index命令<code>python manage.py rebuild_index</code></p> 
<p>执行成功，如下：<br> <img src="https://images2.imgbox.com/7f/aa/betVLn4A_o.png" alt="在这里插入图片描述"><br> <code>postman</code>调用api<code>http://localhost:9200/myblog</code>结果返回成功：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"myblog"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"aliases"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"snowball"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"django_ct"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"django_id"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"keyword"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span>
                            <span class="token string-property property">"ignore_above"</span><span class="token operator">:</span> <span class="token number">256</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"snowball"</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"snowball"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"index"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"max_ngram_diff"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"routing"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"allocation"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"include"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"_tier_preference"</span><span class="token operator">:</span> <span class="token string">"data_content"</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"number_of_shards"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"provided_name"</span><span class="token operator">:</span> <span class="token string">"myblog"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"creation_date"</span><span class="token operator">:</span> <span class="token string">"1716964128114"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"analysis"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"haystack_ngram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"ngram"</span><span class="token punctuation">,</span>
                            <span class="token string-property property">"min_gram"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
                            <span class="token string-property property">"max_gram"</span><span class="token operator">:</span> <span class="token string">"4"</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"haystack_edgengram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"edge_ngram"</span><span class="token punctuation">,</span>
                            <span class="token string-property property">"min_gram"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
                            <span class="token string-property property">"max_gram"</span><span class="token operator">:</span> <span class="token string">"15"</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"edgengram_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                                <span class="token string">"haystack_edgengram"</span><span class="token punctuation">,</span>
                                <span class="token string">"lowercase"</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span>
                            <span class="token string-property property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"standard"</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string-property property">"ngram_analyzer"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                                <span class="token string">"haystack_ngram"</span><span class="token punctuation">,</span>
                                <span class="token string">"lowercase"</span>
                            <span class="token punctuation">]</span><span class="token punctuation">,</span>
                            <span class="token string-property property">"tokenizer"</span><span class="token operator">:</span> <span class="token string">"standard"</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string-property property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"uuid"</span><span class="token operator">:</span> <span class="token string">"1GzZNjZzSmOtmFdLuGWhvw"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"created"</span><span class="token operator">:</span> <span class="token string">"7170099"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="index_414"></a>搜索index</h3> 
<p>修改搜索视图以获取匹配的博客文章 ID，并从 MySQL 中获取详细信息：</p> 
<pre><code class="prism language-python"><span class="token comment"># blog/views.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render
<span class="token keyword">from</span> haystack<span class="token punctuation">.</span>query <span class="token keyword">import</span> SearchQuerySet
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> BlogPost
<span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> BlogSearchForm

<span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    form <span class="token operator">=</span> BlogSearchForm<span class="token punctuation">(</span>request<span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 从 Elasticsearch 获取匹配的博客文章 ID</span>
        sqs <span class="token operator">=</span> form<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">)</span>
        matched_ids <span class="token operator">=</span> <span class="token punctuation">[</span>result<span class="token punctuation">.</span>pk <span class="token keyword">for</span> result <span class="token keyword">in</span> sqs<span class="token punctuation">]</span>

        <span class="token comment"># 从 MySQL 数据库中获取详细信息</span>
        results <span class="token operator">=</span> BlogPost<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>id__in<span class="token operator">=</span>matched_ids<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> render<span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'search_results.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token string">'form'</span><span class="token punctuation">:</span> form<span class="token punctuation">,</span> <span class="token string">'results'</span><span class="token punctuation">:</span> results<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>访问’http://localhost:8000’输入搜索growing,访问’http://localhost:8000/search/?q=growing’,得到结果如下：</p> 
<p><img src="https://images2.imgbox.com/06/65/VC0mRR7C_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e2592a0d402121e72e54979e50cc63ae/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">校园志愿者|基于SprinBoot&#43;vue的校园志愿者管理系统(源码&#43;数据库&#43;文档)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b735b3067c7aed86955ba70743bfd689/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Hive-因精度丢失导致的 join 数据异常</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>