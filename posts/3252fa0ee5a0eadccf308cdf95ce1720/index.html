<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MongoDB聚合：分组统计$group的用法详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3252fa0ee5a0eadccf308cdf95ce1720/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="MongoDB聚合：分组统计$group的用法详解">
  <meta property="og:description" content="MongoDB不像关系型数据库，普通的查询不支持汇总，要进行复杂的分组汇总，需要使用聚合管道，$group可以说是MongoDB聚合管道进行数据分析最常用的一个阶段。该阶段根据分组键值（组键）把文档分成若干组，每个唯一的键值对应一个文档。组键通常是一个或多个字段，也可以是表达式的结果。$group阶段输出的结果中，_id字段的值就是组键的值，输出文档中还可以包含汇总表达式的字段，汇总表达式的功能非常丰富，下面的列表会简单介绍，具体的使用方法可以参考详细说明。
$group的语法 { $group: { _id: &lt;expression&gt;, // 组键，就是分组的键值字段或表达式 &lt;field1&gt;: { &lt;accumulator1&gt; : &lt;expression1&gt; }, ... } } 字段说明：
字段说明_id不可省略，通过_id表达式指定分组的依据，如果直接指定_id的值为null或常量，则把全部的输入文档汇总后返回一个文档field可选，汇总表达式计算的结果_id和field可以是任何合法的表达式。 分组汇总操作符 分组汇总操作符比较多，功能丰富且强大，这里简要介绍其用途，详细的用法后续再专文介绍。
操作符用途介绍$accumulator返回累加结果$addToSet把分组中不重复的表达式的值作为数组返回，注意数组的元素无序的，类似分组内的distinct$avg返回数值的平均值。非数值会被忽略$bottom按照指定的顺序返回分组中最后一个元素$bottomN按照指定的顺序返回分组中最后N个元素字段的集合，如果分组元素数量小于N，则返回全部$count返回分组内的元素数量$first返回分组内第一个元素表达式的结果$firstN返回分组内前n个元素的聚合。只有文档有序时才有意义$last返回分组中最后一个文档的表达式的结果$lastN返回分组内最后n个元素的聚合。只有文档有序时才有意义$max返回每个分组表达式值的最大值$maxN返回分组内最大的n个元素的集合$median返回分组中的中位数$mergeObjects返回分组合并后的文档$min返回分组内表达式的最小值$percentile返回与指定百分位数值相对应的值的数组$push返回每个分组表达式值的数组$stdDevPop返回标准差$stdDevSamp返回样本标准差$sum返回合计值，忽略空值$top根据指定的顺序返回组内最前面的元素$topN根据指定的顺序返回组内前N个元素的聚合 注意 $group使用内存不能超过100M，超过会报错。如果想要处理更多数据或者少用一些内存，可使用allowDiskUse选项把数据写入临时文件。当使用$first、$last等操作符时，可以考虑在参与排序的分组字段上添加索引，某些情况下，这些操作可以使用索引快速定位到相应的记录。 一些例子 统计数量 创建并插入数据：
db.sales.insertMany([ { &#34;_id&#34; : 1, &#34;item&#34; : &#34;abc&#34;, &#34;price&#34; : Decimal128(&#34;10&#34;), &#34;quantity&#34; : Int32(&#34;2&#34;), &#34;date&#34; : ISODate(&#34;2014-03-01T08:00:00Z&#34;) }, { &#34;_id&#34; : 2, &#34;item&#34; : &#34;jkl&#34;, &#34;price&#34; : Decimal128(&#34;20&#34;), &#34;quantity&#34; : Int32(&#34;1&#34;), &#34;date&#34; : ISODate(&#34;2014-03-01T09:00:00Z&#34;) }, { &#34;_id&#34; : 3, &#34;item&#34; : &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-11T21:57:38+08:00">
    <meta property="article:modified_time" content="2024-02-11T21:57:38+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MongoDB聚合：分组统计$group的用法详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>MongoDB不像关系型数据库，普通的查询不支持汇总，要进行复杂的分组汇总，需要使用聚合管道，<code>$group</code>可以说是MongoDB聚合管道进行数据分析最常用的一个阶段。该阶段根据分组键值（组键）把文档分成若干组，每个唯一的键值对应一个文档。组键通常是一个或多个字段，也可以是表达式的结果。<code>$group</code>阶段输出的结果中，<code>_id</code>字段的值就是组键的值，输出文档中还可以包含汇总表达式的字段，汇总表达式的功能非常丰富，下面的列表会简单介绍，具体的使用方法可以参考详细说明。</p> 
<h3><a id="group_2"></a>$group的语法</h3> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
 <span class="token literal-property property">$group</span><span class="token operator">:</span>
   <span class="token punctuation">{<!-- --></span>
     <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token operator">&lt;</span>expression<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token comment">// 组键，就是分组的键值字段或表达式</span>
     <span class="token operator">&lt;</span>field1<span class="token operator">&gt;</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">&lt;</span>accumulator1<span class="token operator">&gt;</span> <span class="token operator">:</span> <span class="token operator">&lt;</span>expression1<span class="token operator">&gt;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token operator">...</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p><strong>字段说明：</strong></p> 
<table><thead><tr><th>字段</th><th>说明</th></tr></thead><tbody><tr><td>_id</td><td>不可省略，通过<code>_id</code>表达式指定分组的依据，如果直接指定<code>_id</code>的值为<code>null</code>或常量，则把全部的输入文档汇总后返回一个文档</td></tr><tr><td>field</td><td>可选，汇总表达式计算的结果</td></tr><tr><td>_id和field可以是任何合法的表达式。</td><td></td></tr></tbody></table> 
<h3><a id="_19"></a>分组汇总操作符</h3> 
<p>分组汇总操作符比较多，功能丰富且强大，这里简要介绍其用途，详细的用法后续再专文介绍。</p> 
<table><thead><tr><th>操作符</th><th>用途介绍</th></tr></thead><tbody><tr><td><code>$accumulator</code></td><td>返回累加结果</td></tr><tr><td><code>$addToSet</code></td><td>把分组中不重复的表达式的值作为数组返回，注意数组的元素无序的，类似分组内的distinct</td></tr><tr><td><code>$avg</code></td><td>返回数值的平均值。非数值会被忽略</td></tr><tr><td><code>$bottom</code></td><td>按照指定的顺序返回分组中最后一个元素</td></tr><tr><td><code>$bottomN</code></td><td>按照指定的顺序返回分组中最后N个元素字段的集合，如果分组元素数量小于N，则返回全部</td></tr><tr><td><code>$count</code></td><td>返回分组内的元素数量</td></tr><tr><td><code>$first</code></td><td>返回分组内第一个元素表达式的结果</td></tr><tr><td><code>$firstN</code></td><td>返回分组内前n个元素的聚合。只有文档有序时才有意义</td></tr><tr><td><code>$last</code></td><td>返回分组中最后一个文档的表达式的结果</td></tr><tr><td><code>$lastN</code></td><td>返回分组内最后n个元素的聚合。只有文档有序时才有意义</td></tr><tr><td><code>$max</code></td><td>返回每个分组表达式值的最大值</td></tr><tr><td><code>$maxN</code></td><td>返回分组内最大的n个元素的集合</td></tr><tr><td><code>$median</code></td><td>返回分组中的中位数</td></tr><tr><td><code>$mergeObjects</code></td><td>返回分组合并后的文档</td></tr><tr><td><code>$min</code></td><td>返回分组内表达式的最小值</td></tr><tr><td><code>$percentile</code></td><td>返回与指定百分位数值相对应的值的数组</td></tr><tr><td><code>$push</code></td><td>返回每个分组表达式值的数组</td></tr><tr><td><code>$stdDevPop</code></td><td>返回标准差</td></tr><tr><td><code>$stdDevSamp</code></td><td>返回样本标准差</td></tr><tr><td><code>$sum</code></td><td>返回合计值，忽略空值</td></tr><tr><td><code>$top</code></td><td>根据指定的顺序返回组内最前面的元素</td></tr><tr><td><code>$topN</code></td><td>根据指定的顺序返回组内前N个元素的聚合</td></tr></tbody></table> 
<h3><a id="_45"></a>注意</h3> 
<ol><li><code>$group</code>使用内存不能超过100M，超过会报错。如果想要处理更多数据或者少用一些内存，可使用allowDiskUse选项把数据写入临时文件。</li><li>当使用<code>$first、$last</code>等操作符时，可以考虑在参与排序的分组字段上添加索引，某些情况下，这些操作可以使用索引快速定位到相应的记录。</li></ol> 
<h3><a id="_48"></a>一些例子</h3> 
<h4><a id="_49"></a>统计数量</h4> 
<p>创建并插入数据：</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>sales<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-03-01T08:00:00Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"jkl"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-03-01T09:00:00Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span> <span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-03-15T09:00:00Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span>  <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"20"</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-04-04T11:21:39.736Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-04-04T21:23:13.331Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"def"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"7.5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"5"</span> <span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2015-06-04T05:08:13Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"def"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"7.5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2015-09-10T08:43:00Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"5"</span> <span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2016-02-06T20:20:13Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="sales_63"></a>统计sales全部文档数量</h5> 
<p>相当于collection.find({}).count()</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>sales<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">$group</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
       <span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
       <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$count</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span> <span class="token punctuation">)</span>
</code></pre> 
<p><strong>结果：</strong></p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="distinct_79"></a>检索不同的值，等价于distinct</h5> 
<p>仍以上例的sales集合数据为例</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>sales<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span> <span class="token punctuation">[</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$group</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span> <span class="token operator">:</span> <span class="token string">"$item"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span>
</code></pre> 
<p><strong>结果：</strong></p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"abc"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"jkl"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"def"</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"xyz"</span> <span class="token punctuation">}</span>
</code></pre> 
<p>等价于：</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>sales<span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="Item_95"></a>按Item分组</h5> 
<p>下面的聚合先按照item进行分组，计算每个item销售总额，并且返回大于等于100的item。</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>sales<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token comment">//阶段1</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">$group</span> <span class="token operator">:</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token literal-property property">_id</span> <span class="token operator">:</span> <span class="token string">"$item"</span><span class="token punctuation">,</span>
          <span class="token literal-property property">totalSaleAmount</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$sum</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$multiply</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"$price"</span><span class="token punctuation">,</span> <span class="token string">"$quantity"</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token comment">//阶段2</span>
     <span class="token punctuation">{<!-- --></span>
       <span class="token literal-property property">$match</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"totalSaleAmount"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$gte</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">]</span>
 <span class="token punctuation">)</span>
</code></pre> 
<p><strong>阶段1：</strong><br> <code>$group</code>阶段，根据item进行分组，并计算每个item的销售总额。<br> <strong>阶段2：</strong><br> <code>$math</code>阶段，过滤结果文档，只返回销售总额<code>totalSaleAmount</code>大于等于100的文档。<br> <strong>结果：</strong></p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string-property property">"totalSaleAmount"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"170"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> <span class="token string-property property">"totalSaleAmount"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"150"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"def"</span><span class="token punctuation">,</span> <span class="token string-property property">"totalSaleAmount"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"112.5"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_125"></a>计算总数、合计和平均值</h4> 
<p>创建一个sales集合并插入记录：</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>sales<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-03-01T08:00:00Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"jkl"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"20"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-03-01T09:00:00Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span> <span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-03-15T09:00:00Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span>  <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"20"</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-04-04T11:21:39.736Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-04-04T21:23:13.331Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"def"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"7.5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"5"</span> <span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2015-06-04T05:08:13Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"def"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"7.5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span><span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2015-09-10T08:43:00Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string-property property">"item"</span> <span class="token operator">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string-property property">"price"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-property property">"quantity"</span> <span class="token operator">:</span> <span class="token function">Int32</span><span class="token punctuation">(</span><span class="token string">"5"</span> <span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token string-property property">"date"</span> <span class="token operator">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">"2016-02-06T20:20:13Z"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_139"></a>按照日期分组</h5> 
<p>下面的聚合管道计算2014年的销售总额、平均销量和销售数量</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>sales<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token comment">//阶段1</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">$match</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"date"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$gte</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ISODate</span><span class="token punctuation">(</span><span class="token string">"2014-01-01"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">$lt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ISODate</span><span class="token punctuation">(</span><span class="token string">"2015-01-01"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//阶段2</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">$group</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
       <span class="token literal-property property">_id</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$dateToString</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">"%Y-%m-%d"</span><span class="token punctuation">,</span> <span class="token literal-property property">date</span><span class="token operator">:</span> <span class="token string">"$date"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token literal-property property">totalSaleAmount</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$sum</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$multiply</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"$price"</span><span class="token punctuation">,</span> <span class="token string">"$quantity"</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token literal-property property">averageQuantity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$avg</span><span class="token operator">:</span> <span class="token string">"$quantity"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$sum</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">//阶段3</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">$sort</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">totalSaleAmount</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>阶段1</strong><br> 使用<code>$math</code>只允许2014年的数据进入下一阶段.<br> <strong>阶段2</strong><br> 使用<code>$group</code>根据日期进行分组，统计每个分组的销售总额、平均销量和销售数量。<br> <strong>阶段3</strong><br> 使用<code>$sort</code>按照销售总额进行降序排序<br> <strong>结果：</strong></p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"2014-04-04"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"totalSaleAmount"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"200"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token string-property property">"averageQuantity"</span> <span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"2014-03-15"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"totalSaleAmount"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"50"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token string-property property">"averageQuantity"</span> <span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"2014-03-01"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"totalSaleAmount"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"40"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token string-property property">"averageQuantity"</span> <span class="token operator">:</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="null_186"></a>按控制null分组</h5> 
<p>下面的聚合操作，指定分组_id为空，计算集合中所有文档的总销售额、平均数量和计数。</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>sales<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">$group</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
       <span class="token literal-property property">_id</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
       <span class="token literal-property property">totalSaleAmount</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$sum</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$multiply</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"$price"</span><span class="token punctuation">,</span> <span class="token string">"$quantity"</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token literal-property property">averageQuantity</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$avg</span><span class="token operator">:</span> <span class="token string">"$quantity"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$sum</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>结果：</strong></p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string-property property">"totalSaleAmount"</span> <span class="token operator">:</span> <span class="token function">Decimal128</span><span class="token punctuation">(</span><span class="token string">"452.5"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string-property property">"averageQuantity"</span> <span class="token operator">:</span> <span class="token number">7.875</span><span class="token punctuation">,</span>
  <span class="token string-property property">"count"</span> <span class="token operator">:</span> <span class="token number">8</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_209"></a>数据透视</h4> 
<p>创建books集合并插入数据</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">8751</span><span class="token punctuation">,</span> <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"The Banquet"</span><span class="token punctuation">,</span> <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"Dante"</span><span class="token punctuation">,</span> <span class="token string-property property">"copies"</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">8752</span><span class="token punctuation">,</span> <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"Divine Comedy"</span><span class="token punctuation">,</span> <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"Dante"</span><span class="token punctuation">,</span> <span class="token string-property property">"copies"</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">8645</span><span class="token punctuation">,</span> <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"Eclogues"</span><span class="token punctuation">,</span> <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"Dante"</span><span class="token punctuation">,</span> <span class="token string-property property">"copies"</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">7000</span><span class="token punctuation">,</span> <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"The Odyssey"</span><span class="token punctuation">,</span> <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"Homer"</span><span class="token punctuation">,</span> <span class="token string-property property">"copies"</span> <span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">7020</span><span class="token punctuation">,</span> <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"Iliad"</span><span class="token punctuation">,</span> <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"Homer"</span><span class="token punctuation">,</span> <span class="token string-property property">"copies"</span> <span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_220"></a>根据作者对标题分组</h5> 
<p>下面的聚合操作将books集合中的数据透视为按作者分组的标题。</p> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
   <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$group</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span> <span class="token operator">:</span> <span class="token string">"$author"</span><span class="token punctuation">,</span> <span class="token literal-property property">books</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$push</span><span class="token operator">:</span> <span class="token string">"$title"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
 <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>结果</strong></p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"Homer"</span><span class="token punctuation">,</span> <span class="token string-property property">"books"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"The Odyssey"</span><span class="token punctuation">,</span> <span class="token string">"Iliad"</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"Dante"</span><span class="token punctuation">,</span> <span class="token string-property property">"books"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"The Banquet"</span><span class="token punctuation">,</span> <span class="token string">"Divine Comedy"</span><span class="token punctuation">,</span> <span class="token string">"Eclogues"</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_232"></a>根据作者对文档分组</h5> 
<pre><code class="prism language-js">db<span class="token punctuation">.</span>books<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
   <span class="token comment">// 阶段1</span>
   <span class="token punctuation">{<!-- --></span>
     <span class="token literal-property property">$group</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">_id</span> <span class="token operator">:</span> <span class="token string">"$author"</span><span class="token punctuation">,</span> <span class="token literal-property property">books</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$push</span><span class="token operator">:</span> <span class="token string">"$$ROOT"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token comment">// 阶段2</span>
   <span class="token punctuation">{<!-- --></span>
     <span class="token literal-property property">$addFields</span><span class="token operator">:</span>
       <span class="token punctuation">{<!-- --></span>
         <span class="token literal-property property">totalCopies</span> <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">$sum</span><span class="token operator">:</span> <span class="token string">"$books.copies"</span> <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
 <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>阶段1：</strong><br> 分组<code>$group</code>，根据作者对文档进行分组，使用<code>$$ROOT</code>把文档作为books的元素。<br> <strong>阶段2：</strong><br> <code>$addFields</code>会在输出文档中添加一个字段，即每位作者的图书总印数。<br> <strong>结果：</strong></p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"Homer"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"books"</span> <span class="token operator">:</span>
     <span class="token punctuation">[</span>
       <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">7000</span><span class="token punctuation">,</span> <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"The Odyssey"</span><span class="token punctuation">,</span> <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"Homer"</span><span class="token punctuation">,</span> <span class="token string-property property">"copies"</span> <span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">7020</span><span class="token punctuation">,</span> <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"Iliad"</span><span class="token punctuation">,</span> <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"Homer"</span><span class="token punctuation">,</span> <span class="token string-property property">"copies"</span> <span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
     <span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token string-property property">"totalCopies"</span> <span class="token operator">:</span> <span class="token number">20</span>
<span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token string">"Dante"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"books"</span> <span class="token operator">:</span>
     <span class="token punctuation">[</span>
       <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">8751</span><span class="token punctuation">,</span> <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"The Banquet"</span><span class="token punctuation">,</span> <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"Dante"</span><span class="token punctuation">,</span> <span class="token string-property property">"copies"</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">8752</span><span class="token punctuation">,</span> <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"Divine Comedy"</span><span class="token punctuation">,</span> <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"Dante"</span><span class="token punctuation">,</span> <span class="token string-property property">"copies"</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"_id"</span> <span class="token operator">:</span> <span class="token number">8645</span><span class="token punctuation">,</span> <span class="token string-property property">"title"</span> <span class="token operator">:</span> <span class="token string">"Eclogues"</span><span class="token punctuation">,</span> <span class="token string-property property">"author"</span> <span class="token operator">:</span> <span class="token string">"Dante"</span><span class="token punctuation">,</span> <span class="token string-property property">"copies"</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span>
     <span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token string-property property">"totalCopies"</span> <span class="token operator">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以上内容参考mongodb官方文档整理而来<br> <strong>如果这篇文章对你有用，可点赞、收藏，让它帮助更多人</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6eb83c6865e55cf156af3c59d4f78163/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">java连接SQL Server（自用）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9837384ab386ff91b77a8cd713bb299c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">HiveSQL题——前后函数(lag/lead)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>