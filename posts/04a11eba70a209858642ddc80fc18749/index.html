<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>钉钉企业内部H5微应用或小程序之钉消息推送 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/04a11eba70a209858642ddc80fc18749/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="钉钉企业内部H5微应用或小程序之钉消息推送">
  <meta property="og:description" content="钉钉简单的推送钉消息 一、钉钉准备工作 首先进入钉钉开放平台 你得有企业内部微应用或者小程序 没有创建的话去看我另一篇文章有说明
钉钉开放平台创建企业内部H5微应用或者小程序-CSDN博客
看不懂话也可以参考官方文档：创建应用 - 钉钉开放平台
二、开发的准备工作 1.pom的导入
&lt;!-- 钉钉SDK --&gt; &lt;dependency&gt; &lt;groupId&gt;com.aliyun&lt;/groupId&gt; &lt;artifactId&gt;dingtalk&lt;/artifactId&gt; &lt;version&gt;1.2.15&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.aliyun&lt;/groupId&gt; &lt;artifactId&gt;alibaba-dingtalk-service-sdk&lt;/artifactId&gt; &lt;version&gt;2.0.0&lt;/version&gt; &lt;/dependency&gt; 2.配置文件（yml配置文件）
#钉钉信息 dingtalk: corpid: dingxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx appkey: dingxxxxxxxxxxxxxxxx appsecret: 89QA-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx-xxxx agentid: 2xxxxxxxxx 这里的配置信息是你的应用信息（在钉钉后台-应用管理）
三、代码实现 添加工具类 获取钉钉AccessToken
/** * 钉钉工具类 * @date 2023-07-07 9:30 */ @Slf4j @Component public class DingTalkUtil { @Value(&#34;${dingtalk.appKey}&#34;) private String appKey; @Value(&#34;${dingtalk.appSecret}&#34;) private String appSecret; /** * 获取钉钉AccessToken * * @return */ public String getAccessToken() { try { DingTalkClient client = new DefaultDingTalkClient(&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-28T17:05:40+08:00">
    <meta property="article:modified_time" content="2024-05-28T17:05:40+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">钉钉企业内部H5微应用或小程序之钉消息推送</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4><a href="https://so.csdn.net/so/search?q=%E9%92%89%E9%92%89&amp;spm=1001.2101.3001.7020" title="钉钉">钉钉</a>简单的推送钉消息</h4> 
<p></p> 
<h3>一、钉钉准备工作</h3> 
<p>首先进入<a class="link-info" href="https://open.dingtalk.com/" rel="nofollow" title="钉钉开放平台">钉钉开放平台</a> 你得有<strong>企业内部微应用</strong>或者<strong>小程序</strong> 没有创建的话去看我另一篇文章有说明</p> 
<p><a href="https://blog.csdn.net/qq_60782107/article/details/138559048?spm=1001.2014.3001.5502" title="钉钉开放平台创建企业内部H5微应用或者小程序-CSDN博客">钉钉开放平台创建企业内部H5微应用或者小程序-CSDN博客</a></p> 
<p>看不懂话也可以参考官方文档：<a href="https://open.dingtalk.com/document/orgapp/create-orgapp" rel="nofollow" title="创建应用 - 钉钉开放平台">创建应用 - 钉钉开放平台</a></p> 
<p></p> 
<h3>二、开发的准备工作</h3> 
<blockquote> 
 <p>1.pom的导入</p> 
</blockquote> 
<pre><code class="language-java">&lt;!-- 钉钉SDK --&gt;
&lt;dependency&gt;
   &lt;groupId&gt;com.aliyun&lt;/groupId&gt;
   &lt;artifactId&gt;dingtalk&lt;/artifactId&gt;
   &lt;version&gt;1.2.15&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
   &lt;groupId&gt;com.aliyun&lt;/groupId&gt;
   &lt;artifactId&gt;alibaba-dingtalk-service-sdk&lt;/artifactId&gt;
   &lt;version&gt;2.0.0&lt;/version&gt;
&lt;/dependency&gt;
            
</code></pre> 
<blockquote> 
 <p>2.配置文件（yml配置文件）</p> 
</blockquote> 
<pre><code class="language-java">#钉钉信息
dingtalk:
  corpid: dingxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
  appkey: dingxxxxxxxxxxxxxxxx
  appsecret: 89QA-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx-xxxx
  agentid: 2xxxxxxxxx</code></pre> 
<p>这里的配置信息是你的应用信息（在钉钉后台-应用管理）</p> 
<p><img alt="" height="621" src="https://images2.imgbox.com/c8/39/2xolSbmk_o.png" width="1200"></p> 
<blockquote> 
 <h3>三、代码实现</h3> 
 <p>添加工具类 获取钉钉AccessToken</p> 
</blockquote> 
<pre><code>/**
 * 钉钉工具类
 * @date 2023-07-07 9:30
 */
@Slf4j
@Component
public class DingTalkUtil {

    @Value("${dingtalk.appKey}")
    private String appKey;

    @Value("${dingtalk.appSecret}")
    private String appSecret;

    /**
     * 获取钉钉AccessToken
     *
     * @return
     */
    public String getAccessToken() {
        try {
            DingTalkClient client = new DefaultDingTalkClient("https://oapi.dingtalk.com/gettoken");
            OapiGettokenRequest req = new OapiGettokenRequest();
            req.setAppkey(appKey);
            req.setAppsecret(appSecret);
            req.setHttpMethod("GET");
            OapiGettokenResponse rsp = client.execute(req);
            if (rsp.getErrcode() == 0) {
                return rsp.getAccessToken();
            } else {
                throw new JeecgBootException("获取dingtalk授权失败!");
            }
        } catch (ApiException e) {
            e.printStackTrace();
        }

        return null;
    }

}</code></pre> 
<blockquote> 
 <p>调用钉钉接口之前都是需要用到access_token校验的，接着调用用户电话获得钉钉的userId（某个人在企业里的唯一ID）</p> 
</blockquote> 
<pre><code class="language-java">
/**
     * 获取钉钉的用户的userid
     *
     * @param phone 用户电话
     * @return 钉钉用户内部userId
     */
    public String getDingTalkUserId(String phone) throws Exception {

        String accessToken = this.getAccessToken();
        if (accessToken == null) {
            throw new Exception("获取到access_token失败！");
        }
        try {
            DingTalkClient client = new DefaultDingTalkClient("https://oapi.dingtalk.com/topapi/v2/user/getbymobile");
            OapiV2UserGetbymobileRequest req = new OapiV2UserGetbymobileRequest();
            req.setMobile(phone);
            OapiV2UserGetbymobileResponse rsp = client.execute(req, accessToken);
            String userId = rsp.getResult().getUserid();
            return userId;
        } catch (ApiException e) {
            log.error("请求获取钉钉用户的userid失败:{}", e.getErrMsg());
        }
        return null;
    }

</code></pre> 
<blockquote> 
 <p><strong>发送消息工具类</strong>（可给单个或多个人发送）</p> 
</blockquote> 
<pre><code class="language-java">package org.jeecg.modules.aigoes.util;

import com.alibaba.fastjson.JSONObject;
import lombok.extern.slf4j.Slf4j;
import org.jeecg.common.util.TokenUtils;
import org.jeecg.modules.message.util.DingTalkUtil;
import org.jeecg.modules.system.entity.SysTenant;
import org.jeecg.modules.system.service.ISysTenantService;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import java.io.*;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.List;
import java.util.stream.Collectors;

/**
 * rwy
 * @date 2023-07-07 9:30
 */
@Slf4j
@Component
public class MessageUtils {

    @Resource
    private DingTalkUtil dingTalkUtil;

    // 钉钉发送消息给指定用户列表
    public void sendMessageNew(List&lt;String&gt; userIdList, String picUrl, String messageUrlDing, String text, String title) throws Exception {
        String accessToken = dingTalkUtil.getAccessToken();
        String messageUrl = "https://oapi.dingtalk.com/topapi/message/corpconversation/asyncsend_v2?access_token=" + accessToken;

        JSONObject jsonObject = new JSONObject();
        //钉钉后台应用的agent_id
        jsonObject.put("agent_id", sysTenant.getAgentId());
        //推送的userId                                                              
      jsonObject.put("userid_list",userIdList.stream().collect(Collectors.joining(",")));
        jsonObject.put("to_all_user", false);
        JSONObject msgObj = new JSONObject();
        //消息类型
        msgObj.put("msgtype", "action_card");

        JSONObject textObj = new JSONObject();
        //标题
        textObj.put("title", title);
        //内容
        textObj.put("markdown", text);
        //按钮名称
        textObj.put("single_title", picUrl);
        //跳转地址 填小程序莫页面地址或微应用的
        textObj.put("single_url", messageUrlDing);
        msgObj.put("action_card",textObj);
        jsonObject.put("msg", msgObj);

        String jsonBody = jsonObject.toJSONString();
        System.out.println(jsonBody);

        //发送POST请求
        JSONObject response = httpPost(messageUrl, jsonBody, "UTF-8");
        System.out.println(response);
    }


   public JSONObject httpPost(String url, String requestData, String charset) throws IOException {
        URL apiUrl = new URL(url);
        HttpURLConnection connection = (HttpURLConnection) apiUrl.openConnection();
        connection.setRequestMethod("POST");
        connection.setDoOutput(true);

        // 设置请求头部
        connection.setRequestProperty("Content-Type", "application/json;charset=" + charset);

        // 发送请求数据
        try (OutputStream outputStream = connection.getOutputStream()) {
            outputStream.write(requestData.getBytes(charset));
            outputStream.flush();
        }

        // 获取响应结果
        try (InputStream inputStream = connection.getInputStream();
             BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream, charset))) {
            StringBuilder response = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                response.append(line);
            }
            return JSONObject.parseObject(response.toString());
        }
    } 

}
</code></pre> 
<blockquote> 
 <p>这里需要注意的是你选择的<a href="https://open.dingtalk.com/document/orgapp/message-types-and-data-format#title-qbr-ab2-nks" rel="nofollow" title="消息通知类型 - 钉钉开放平台">消息通知类型 - 钉钉开放平台</a>，我这里选择是<strong>卡片消息 </strong>因为卡片消息支持整体跳转ActionCard样式和独立跳转ActionCard样式以及可以展示图片和添加多个按钮 样式和可玩性比较高。</p> 
</blockquote> 
<blockquote> 
 <p><strong>测试发送钉消息</strong></p> 
 <p>注意事项：<strong><a class="link-info" href="https://open.dingtalk.com/document/orgapp/message-link-description#title-mzg-rmf-ty0" rel="nofollow" title="小程序链接">小程序链接</a>和微应用微应用唯一区别在这跳转地址 要跳转小程序前面是需要加 eapp:// 列如以下是这样的 eapp://pagesA/pages/Home/h-psy/ 而微应用不用加</strong></p> 
</blockquote> 
<pre><code class="language-java">/**
     * 发送钉消息
     * @return
     * @throws Exception
     */
    @GetMapping("/cs2")
    public Result&lt;?&gt; cs() throws Exception {
        String headteacherId = "661xxxxxxxxxxxxxxx";
        messageUtils.sendMessageNew(Collections.singletonList(headteacherId),
                "点击查看详情","pagesA/pages/Home/h-psy/mood",
                "### &lt;font color=#04CFFF&gt;测试天气消息&lt;/font&gt;  \n  **天气还不错。**",
                "天气报告");
        return Result.OK();
    }</code></pre> 
<p><img alt="" height="778" src="https://images2.imgbox.com/4c/1d/4DtgQHRL_o.png" width="1200"></p> 
<p></p> 
<h3>四、调试API Explorer</h3> 
<p> 钉钉专门的API调用工具可以自己试试<a href="https://open-dev.dingtalk.com/apiExplorer#/?devType=org&amp;api=dingtalk.oapi.message.corpconversation.asyncsend_v2" rel="nofollow" title="API Explorer">API Explorer</a> </p> 
<p>1.根据自己应用的appKey和appSecret来获取accessToken。</p> 
<p><img alt="" height="919" src="https://images2.imgbox.com/19/cd/rPGi4PN9_o.png" width="1200"></p> 
<p>2. 工作通知-异步发送工作通知</p> 
<blockquote> 
 <p><strong>填入内容 然后往下拉找到我们要发的消息类型我这里是卡片消息（这里你也可以选别的消息类型）填入必填的参数再点发起调用 也是能够成功发送的。</strong></p> 
</blockquote> 
<p><img alt="" height="900" src="https://images2.imgbox.com/bf/64/7ZCwrFzh_o.jpg" width="753"><img alt="" height="734" src="https://images2.imgbox.com/98/1a/gGGXieAE_o.png" width="1200"><img alt="" height="118" src="https://images2.imgbox.com/02/fa/PsxgGsOR_o.png" width="433"></p> 
<p>最后希望能帮助到你们。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/906dd19900badee8977d7a28d120edb6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Android】多种方式实现圆角控件View、图片、背景、边框（最全）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9f5b4a057cbc3b64700754bd8dc1636f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">智慧冶金：TSINGSEE青犀AI&#43;视频技术助力打造高效、安全的生产环境</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>