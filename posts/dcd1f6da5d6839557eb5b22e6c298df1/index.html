<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 添加自己的时钟小部件 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/dcd1f6da5d6839557eb5b22e6c298df1/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android 添加自己的时钟小部件">
  <meta property="og:description" content="小部件，也叫微件，
它的介绍参考官网 应用 widget 概览 https://developer.android.google.cn/develop/ui/views/appwidgets/overview?hl=zh-cn 直接上图，原生系统上，时钟应用的小部件效果。
我也整一个。
1.创建小部件布局文件 这个文件就是最终显示在桌面的小部件的样式。
res/layout/time_widget_layout.xml
&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt; &lt;LinearLayout xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34; android:layout_width=&#34;match_parent&#34; android:layout_height=&#34;match_parent&#34; android:paddingTop=&#34;6dp&#34; android:paddingBottom=&#34;6dp&#34; android:gravity=&#34;center&#34; android:orientation=&#34;vertical&#34;&gt; &lt;TextClock android:id=&#34;@&#43;id/tv_date&#34; android:layout_width=&#34;match_parent&#34; android:layout_height=&#34;22dp&#34; android:format12Hour=&#34;yyyy/MM/dd E&#34; android:format24Hour=&#34;yyyy/MM/dd E&#34; android:gravity=&#34;center&#34; android:textSize=&#34;17sp&#34; android:textColor=&#34;#DBE1FF&#34; /&gt; &lt;TextClock android:id=&#34;@&#43;id/tv_time&#34; android:layout_width=&#34;match_parent&#34; android:layout_height=&#34;101dp&#34; android:format12Hour=&#34;h:mm&#34; android:format24Hour=&#34;HH:mm&#34; android:gravity=&#34;center&#34; android:textColor=&#34;#DBE1FF&#34; android:textSize=&#34;@dimen/textclock_time_size&#34; /&gt; &lt;/LinearLayout&gt; 使用 TextClock 显示日期、时间，很方便，它会自己更新，不需要添加刷新逻辑。
2.创建小部件配置文件 AppWidgetProviderInfo 对象定义了 widget 的基本特性。
res/xml/time_widget.xml
&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt; &lt;appwidget-provider xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34; android:initialLayout=&#34;@layout/time_widget_layout&#34; android:minHeight=&#34;110dp&#34; android:minWidth=&#34;110dp&#34; android:resizeMode=&#34;vertical|horizontal&#34; android:previewImage=&#34;@drawable/pic_beauty&#34; android:updatePeriodMillis=&#34;3000&#34; /&gt; android:initialLayout ：指向小部件布局文件 。android:minHeight 、android:minWidth ：小部件原始占用区域大小，也是最小占用区域大小，我的示例占用的是 2 x 2 。android:resizeMode=“vertical|horizontal” ：是否支持调整大小，这个是横向、纵向都支持。android:previewImage ：小部件的预览图。android:previewLayout：小部件预览页面的布局。本例只设置了预览图，没有添加布局，有需要自己添加即可。android:updatePeriodMillis ：小部件更新时间间隔。 小部件的大小要根据实际情况计算，参考官网示例">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-26T16:34:11+08:00">
    <meta property="article:modified_time" content="2024-06-26T16:34:11+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 添加自己的时钟小部件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>小部件，也叫微件，<br> 它的介绍参考官网 <a href="https://developer.android.google.cn/develop/ui/views/appwidgets/overview?hl=zh-cn" rel="nofollow">应用 widget 概览 https://developer.android.google.cn/develop/ui/views/appwidgets/overview?hl=zh-cn </a></p> 
<p>直接上图，原生系统上，时钟应用的小部件效果。<br> <img src="https://images2.imgbox.com/2b/d6/FmcCBMjx_o.gif" alt="在这里插入图片描述"></p> 
<p>我也整一个。</p> 
<h2><a id="1_8"></a>1.创建小部件布局文件</h2> 
<p>这个文件就是最终显示在桌面的小部件的样式。<br> res/layout/time_widget_layout.xml</p> 
<pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:paddingTop="6dp"
    android:paddingBottom="6dp"
    android:gravity="center"
    android:orientation="vertical"&gt;

    &lt;TextClock
        android:id="@+id/tv_date"
        android:layout_width="match_parent"
        android:layout_height="22dp"
        android:format12Hour="yyyy/MM/dd E"
        android:format24Hour="yyyy/MM/dd E"
        android:gravity="center"
        android:textSize="17sp"
        android:textColor="#DBE1FF" /&gt;

    &lt;TextClock
        android:id="@+id/tv_time"
        android:layout_width="match_parent"
        android:layout_height="101dp"
        android:format12Hour="h:mm"
        android:format24Hour="HH:mm"
        android:gravity="center"
        android:textColor="#DBE1FF"
        android:textSize="@dimen/textclock_time_size" /&gt;

&lt;/LinearLayout&gt;
</code></pre> 
<p>使用 <code>TextClock</code> 显示日期、时间，很方便，它会自己更新，不需要添加刷新逻辑。</p> 
<h2><a id="2_44"></a>2.创建小部件配置文件</h2> 
<p>AppWidgetProviderInfo 对象定义了 widget 的基本特性。</p> 
<p>res/xml/time_widget.xml</p> 
<pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;appwidget-provider xmlns:android="http://schemas.android.com/apk/res/android"
    android:initialLayout="@layout/time_widget_layout"
    android:minHeight="110dp"
    android:minWidth="110dp"
    android:resizeMode="vertical|horizontal"
    android:previewImage="@drawable/pic_beauty"
    android:updatePeriodMillis="3000" /&gt;
</code></pre> 
<ul><li><code>android:initialLayout</code> ：指向小部件布局文件 。</li><li>android:minHeight 、android:minWidth ：小部件原始占用区域大小，也是最小占用区域大小，我的示例占用的是 2 x 2 。</li><li>android:resizeMode=“vertical|horizontal” ：是否支持调整大小，这个是横向、纵向都支持。</li><li>android:previewImage ：小部件的预览图。</li><li><code>android:previewLayout</code>：小部件预览页面的布局。本例只设置了预览图，没有添加布局，有需要自己添加即可。</li><li>android:updatePeriodMillis ：小部件更新时间间隔。</li></ul> 
<p>小部件的大小要根据实际情况计算，参考官网示例<br> <img src="https://images2.imgbox.com/ca/59/LqFmCNaM_o.png" alt="在这里插入图片描述"><br> 参考 <a href="https://developer.android.google.cn/guide/practices/ui_guidelines/widget_design?hl=zh-cn#anatomy_determining_size" rel="nofollow">Android Developers 应用微件设计指南</a></p> 
<h2><a id="3AppWidgetProvider_69"></a>3.实现AppWidgetProvider</h2> 
<h3><a id="31__AppWidgetProvider_70"></a>3.1 在清单中声明自定义的 AppWidgetProvider</h3> 
<p>AppWidgetProvider 本质是 receiver 。</p> 
<pre><code>        &lt;receiver
            android:name=".appwidget.TimeWidgetProvider"
            android:exported="true"
            android:label="TimeWidgetLabel"&gt;
            &lt;meta-data
                android:name="android.appwidget.provider"
                android:resource="@xml/time_widget" /&gt;

            &lt;intent-filter&gt;
                &lt;action android:name="android.appwidget.action.APPWIDGET_UPDATE" /&gt;
            &lt;/intent-filter&gt;
        &lt;/receiver&gt;
</code></pre> 
<ul><li>android:name=“.appwidget.TimeWidgetProvider” ：要实现的自定义 AppWidgetProvider</li><li>&lt;meta-data/&gt; 里的 android:name 是默认格式，不要改；android:resource 指向小部件配置文件。</li><li>&lt;intent-filter&gt; 里的是默认格式，不要修改。</li></ul> 
<h3><a id="32__AppWidgetProvider_90"></a>3.2 实现自定义的 AppWidgetProvider</h3> 
<p>创建 TimeWidgetProvider ，继承 <code>AppWidgetProvider</code> ，</p> 
<pre><code>public class TimeWidgetProvider extends AppWidgetProvider {

    public static final String TAG = TimeWidgetProvider.class.getSimpleName();

    @Override
    public void onReceive(Context context, Intent intent) {
        super.onReceive(context, intent);
        Log.d(TAG, "onReceive : " + intent.getAction());
    }

    @Override
    public void onUpdate(Context context, AppWidgetManager appWidgetManager, int[] appWidgetIds) {
        super.onUpdate(context, appWidgetManager, appWidgetIds);
        Log.d(TAG, "onUpdate");
    }
}

</code></pre> 
<p>onReceive 里会接收到这些广播：</p> 
<ul><li>android.appwidget.action.APPWIDGET_ENABLED ：小部件第一次被添加到桌面时触发。如果添加同一个小部件两次，第二次添加不会触发。对应 onEnabled 方法。</li><li>android.appwidget.action.APPWIDGET_UPDATE ：小部件被添加到桌面或者小部件更新时触发。对应 onUpdate 方法。</li><li>android.appwidget.action.APPWIDGET_DELETED ：小部件被删除时触发。如果同一个小部件有多个，删一个触发一次。对应 onDeleted方法。</li><li>android.appwidget.action.APPWIDGET_DISABLED ：同一个小部件，最后一个被删除时触发。对应 onDisabled方法。</li><li>android.appwidget.action.APPWIDGET_UPDATE_OPTIONS ：用户调整小部件大小时触发。对应 onAppWidgetOptionsChanged 方法。</li></ul> 
<p>到这里，初版已OK。</p> 
<h3><a id="33__120"></a>3.3 更新小部件</h3> 
<p>使用 <code>RemoteViews</code> 更新调整UI 、添加点击事件，然后调用 <code>AppWidgetManager.updateAppWidget</code> 即可。</p> 
<pre><code>	private RemoteViews remoteViews;
	private AppWidgetManager mAppWidgetManager;
    private int[] mAppWidgetIds;

	public void onUpdate(Context context, AppWidgetManager appWidgetManager, int[] appWidgetIds) {
        super.onUpdate(context, appWidgetManager, appWidgetIds);
        Log.d(TAG, "onUpdate");
        mAppWidgetManager = appWidgetManager;
        mAppWidgetIds = appWidgetIds;
        Log.d(TAG, "onUpdate appWidgetIds:" + Arrays.toString(mAppWidgetIds));
        createRemoteViews(context);
    }

    private void createRemoteViews(Context context) {
        if (remoteViews == null) {
            Log.d(TAG, "createRemoteViews");
            remoteViews = new RemoteViews(context.getPackageName(), R.layout.time_widget_layout);//注释1

            Intent intent = new Intent("android.settings.DATE_SETTINGS");
            intent.setPackage("com.android.settings");
            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TOP);
            
            PendingIntent pendingIntent1, pendingIntent2;
            if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.S) {
                pendingIntent1 = PendingIntent.getActivity(context, 101, intent, PendingIntent.FLAG_IMMUTABLE);
                pendingIntent2 = PendingIntent.getActivity(context, 102, intent, PendingIntent.FLAG_IMMUTABLE);
            } else {
                pendingIntent1 = PendingIntent.getActivity(context, 101, intent, PendingIntent.FLAG_UPDATE_CURRENT);
                pendingIntent2 = PendingIntent.getActivity(context, 102, intent, PendingIntent.FLAG_UPDATE_CURRENT);
            }
            remoteViews.setOnClickPendingIntent(R.id.tv_time, pendingIntent1);
            remoteViews.setOnClickPendingIntent(R.id.tv_date, pendingIntent2);//注释2

            for (int id:mAppWidgetIds) {
                mAppWidgetManager.updateAppWidget(id, remoteViews);//注释3
            }

        }
</code></pre> 
<p><strong>注释1</strong> ：通过 RemoteViews 找到 小部件布局文件，</p> 
<p>RemoteViews 提供了很多方法更新小部件，如</p> 
<ul><li>setTextViewText(@IdRes int viewId, CharSequence text) ：根据 id 设置 TextView 。</li><li>setImageViewResource(@IdRes int viewId, @DrawableRes int srcId) ：根据 id 设置 ImageView。</li><li>setOnClickPendingIntent(@IdRes int viewId, PendingIntent pendingIntent) ：根据 id 设置点击事件。</li></ul> 
<p>本例用的 <code>TextClock</code> ，会自动更新时间，就没有加 RemoteViews 的逻辑。</p> 
<p><strong>注释2</strong> ：使用 <code>PendingIntent</code> 为各个控件添加点击事件。如果不加，默认打开应用首页。本例打开原生设置的 日期和时间 。</p> 
<p><strong>注释3</strong> ：调用 <code>AppWidgetManager.updateAppWidget</code> 更新小部件。</p> 
<p>最终效果：<br> <img src="https://images2.imgbox.com/5c/29/azEj5Z5a_o.gif" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/285f23c5fd918283727823762e87adf7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">什么是前端开发？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3d7bff48478d5f6b9174f83725b31df4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;学习/复习18----迭代器/反向迭代器及在list/vector中的应用、list与vector模拟实现复习</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>