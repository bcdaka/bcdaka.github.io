<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL开窗函数 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/4a65a2834efe67ffeb2a15850137ef12/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="MySQL开窗函数">
  <meta property="og:description" content="测试环境：mysql8.0.18
官方文档：https://dev.mysql.com/doc/refman/8.0/en/window-functions.html
一、窗口函数介绍二、语法结构三、自定义窗口1.rows（重点）2.range3.默认窗口 四、常用窗口函数示例1.row_number &amp; rank &amp; dense_rank2.lead &amp; lag3.first_value &amp; last_value &amp; nth_value4.ntile5.cume_dist &amp; percent_rank（了解） 一、窗口函数介绍 开窗函数是mysql8.0中的新特性，用于实现和group by分组函数类似的分组聚合功能。区别在于：
分组函数：对一个集合输出一个标量结果，改变了数据的粒度，且丢失了非分组字段及非聚合字段的信息。开窗函数：分别以每一行为当前行，与当前行相关的所有行为窗口，对同一个窗口内的数据进行聚合等类似操作，结果附加到当前行的后面，不改变原始数据粒度，不丢失原始数据信息。 二、语法结构 开窗函数|聚合函数 over([分组函数] [排序函数] [自定义窗口]) ，over是进行开窗，里面的分组函数、排序函数、自定义窗口都可以省略。
开窗函数|聚合函数：不可省略，用于对窗口范围内的所有数据行进行某种指定操作。可以是只适用于开窗函数的非聚合函数(https://dev.mysql.com/doc/refman/8.0/en/window-functions-usage.html)，也可以是适用于group by的聚合函数(https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html)。
分组函数：partition by ...，根据指定的字段对表分组，分组字段可以有多个。省略时表示整个表为一组。
排序函数：order by ...，排序字段也可以有多个，当排序字段为多个时表示先按照第一个字段排序，当第一个字段相等确定不了顺序时再按照第二个字段排序，以此类推…
三、自定义窗口 这部分可以直接查看文档https://dev.mysql.com/doc/refman/8.0/en/window-functions-frames.html，个人觉得这部分算是开窗函数里最重要的了，弄明白了各种情况下窗口的大小，其他的就没啥容易混淆的点了。
mysql中的窗口类型有两种：rows和range。rows是以物理行距离为基准通过计算与当前行的物理距离计算窗口大小，range是以当前行的值为基准通过计算与当前行值的差值计算窗口大小。
窗口大小可通过between 上界 and 下界来指定，其中，窗口的上下界分别有下面几种取值：
unbounded preceding：包含当前行及当前行之前的所有记录。n preceding：包含当前行及当前行之前的n-1行，实际窗口大小n。current row：仅包含当前行。unbounded following：包含当前行及当前行之后的所有记录。n following：包含当前行及当前行之后的n-1行，实际窗口大小n。 当窗口下界为current row时，可以不使用between and，也就是下面几种情况可简写：
1）between unbounded preceding and current row --&gt; unbounded preceding
2）between n preceding and current row --&gt; n preceding
3）between current row and current row --&gt; current row">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-30T17:20:09+08:00">
    <meta property="article:modified_time" content="2024-03-30T17:20:09+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL开窗函数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>测试环境：mysql8.0.18<br> 官方文档：<a href="https://dev.mysql.com/doc/refman/8.0/en/window-functions.html" rel="nofollow">https://dev.mysql.com/doc/refman/8.0/en/window-functions.html</a></p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4> </h4> 
 <ul><li><a href="#_4" rel="nofollow">一、窗口函数介绍</a></li><li><a href="#_9" rel="nofollow">二、语法结构</a></li><li><a href="#_16" rel="nofollow">三、自定义窗口</a></li><li><ul><li><a href="#1rows_33" rel="nofollow">1.rows（重点）</a></li><li><a href="#2range_68" rel="nofollow">2.range</a></li><li><a href="#3_91" rel="nofollow">3.默认窗口</a></li></ul> 
  </li><li><a href="#_105" rel="nofollow">四、常用窗口函数示例</a></li><li><ul><li><a href="#1row_number__rank__dense_rank_107" rel="nofollow">1.row_number &amp; rank &amp; dense_rank</a></li><li><a href="#2lead__lag_123" rel="nofollow">2.lead &amp; lag</a></li><li><a href="#3first_value__last_value__nth_value_137" rel="nofollow">3.first_value &amp; last_value &amp; nth_value</a></li><li><a href="#4ntile_153" rel="nofollow">4.ntile</a></li><li><a href="#5cume_dist__percent_rank_165" rel="nofollow">5.cume_dist &amp; percent_rank（了解）</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_4"></a>一、窗口函数介绍</h2> 
<p>开窗函数是mysql8.0中的新特性，用于实现和<code>group by</code>分组函数类似的分组聚合功能。区别在于：</p> 
<ul><li>分组函数：对一个集合输出一个标量结果，改变了数据的粒度，且丢失了非分组字段及非聚合字段的信息。</li><li>开窗函数：分别以每一行为当前行，与当前行相关的所有行为窗口，对同一个窗口内的数据进行聚合等类似操作，结果附加到当前行的后面，不改变原始数据粒度，不丢失原始数据信息。</li></ul> 
<h2><a id="_9"></a>二、语法结构</h2> 
<p><code>开窗函数|聚合函数 over([分组函数] [排序函数] [自定义窗口]) </code>，over是进行开窗，里面的分组函数、排序函数、自定义窗口都可以省略。</p> 
<p><code>开窗函数|聚合函数</code>：不可省略，用于对窗口范围内的所有数据行进行某种指定操作。可以是只适用于开窗函数的非聚合函数(<a href="https://dev.mysql.com/doc/refman/8.0/en/window-functions-usage.html" rel="nofollow">https://dev.mysql.com/doc/refman/8.0/en/window-functions-usage.html</a>)，也可以是适用于group by的聚合函数(<a href="https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html" rel="nofollow">https://dev.mysql.com/doc/refman/8.0/en/aggregate-functions.html</a>)。<br> <code>分组函数</code>：<code>partition by ...</code>，根据指定的字段对表分组，分组字段可以有多个。省略时表示整个表为一组。<br> <code>排序函数</code>：<code>order by ...</code>，排序字段也可以有多个，当排序字段为多个时表示先按照第一个字段排序，当第一个字段相等确定不了顺序时再按照第二个字段排序，以此类推…</p> 
<h2><a id="_16"></a>三、自定义窗口</h2> 
<p>这部分可以直接查看文档<a href="https://dev.mysql.com/doc/refman/8.0/en/window-functions-frames.html" rel="nofollow">https://dev.mysql.com/doc/refman/8.0/en/window-functions-frames.html</a>，个人觉得这部分算是开窗函数里最重要的了，弄明白了各种情况下窗口的大小，其他的就没啥容易混淆的点了。</p> 
<p>mysql中的窗口类型有两种：<code>rows</code>和<code>range</code>。<mark>rows是以物理行距离为基准通过计算与当前行的物理距离计算窗口大小，range是以当前行的值为基准通过计算与当前行值的差值计算窗口大小。</mark></p> 
<p>窗口大小可通过<code>between 上界 and 下界</code>来指定，其中，窗口的上下界分别有下面几种取值：</p> 
<ul><li><code>unbounded preceding</code>：包含当前行及当前行之前的所有记录。</li><li><code>n preceding</code>：包含当前行及当前行之前的n-1行，实际窗口大小n。</li><li><code>current row</code>：仅包含当前行。</li><li><code>unbounded following</code>：包含当前行及当前行之后的所有记录。</li><li><code>n following</code>：包含当前行及当前行之后的n-1行，实际窗口大小n。</li></ul> 
<p>当窗口下界为<code>current row</code>时，可以不使用between and，也就是下面几种情况可简写：<br> 1）<code>between unbounded preceding and current row</code> --&gt; <code>unbounded preceding</code><br> 2）<code>between n preceding and current row</code> --&gt; <code>n preceding</code><br> 3）<code>between current row and current row</code> --&gt; <code>current row</code><br> 而following的情况不支持简写，原因可以参考下<a href="https://tongyi.aliyun.com/qianwen/share?shareId=9f266051-f188-4772-8600-49ae44017873" rel="nofollow">怎么理解mysql开窗函数 unbounded following这种简写形式不支持 而unbounded preceding支持</a>，觉得有些道理。</p> 
<h3><a id="1rows_33"></a>1.rows（重点）</h3> 
<p>物理范围窗口，窗口大小只与当前行的物理距离有关。下面造点测试数据：</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> test_rows_range <span class="token keyword">as</span>
<span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> <span class="token string">'2020-10-03'</span> <span class="token keyword">as</span> trans_date<span class="token punctuation">,</span> <span class="token number">349</span> <span class="token keyword">as</span> sales
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token number">2</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> <span class="token string">'2020-10-01'</span> <span class="token keyword">as</span> trans_date<span class="token punctuation">,</span> <span class="token number">563</span> <span class="token keyword">as</span> sales 
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token number">3</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> <span class="token string">'2020-10-02'</span> <span class="token keyword">as</span> trans_date<span class="token punctuation">,</span> <span class="token number">716</span> <span class="token keyword">as</span> sales
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token number">4</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> <span class="token string">'2020-10-05'</span> <span class="token keyword">as</span> trans_date<span class="token punctuation">,</span> <span class="token number">628</span> <span class="token keyword">as</span> sales
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token number">5</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> <span class="token string">'2020-10-02'</span> <span class="token keyword">as</span> trans_date<span class="token punctuation">,</span> <span class="token number">412</span> <span class="token keyword">as</span> sales
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token number">6</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> <span class="token string">'2020-10-02'</span> <span class="token keyword">as</span> trans_date<span class="token punctuation">,</span> <span class="token number">857</span> <span class="token keyword">as</span> sales
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token number">7</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> <span class="token string">'2020-10-08'</span> <span class="token keyword">as</span> trans_date<span class="token punctuation">,</span> <span class="token number">201</span> <span class="token keyword">as</span> sales
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token number">8</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> <span class="token string">'2020-10-05'</span> <span class="token keyword">as</span> trans_date<span class="token punctuation">,</span> <span class="token number">191</span> <span class="token keyword">as</span> sales
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token number">9</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> <span class="token string">'2020-10-06'</span> <span class="token keyword">as</span> trans_date<span class="token punctuation">,</span> <span class="token number">675</span> <span class="token keyword">as</span> sales
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token number">10</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span> <span class="token string">'2020-10-08'</span> <span class="token keyword">as</span> trans_date<span class="token punctuation">,</span> <span class="token number">941</span> <span class="token keyword">as</span> sales<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a4/ef/5Du6fY5a_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
	<span class="token function">sum</span><span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token number">1</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token number">1</span> <span class="token keyword">following</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum1<span class="token punctuation">,</span>		<span class="token comment">-- 当前行的前一行、后一行、及当前行共3行作为一个窗口</span>
	<span class="token function">sum</span><span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date <span class="token keyword">rows</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum2<span class="token punctuation">,</span>		<span class="token comment">-- 当前行及当前行之前的所有行为窗口</span>
	<span class="token function">sum</span><span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date <span class="token keyword">rows</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum3		<span class="token comment">-- 仅取当前行为窗口</span>
<span class="token keyword">from</span> test_rows_range<span class="token punctuation">;</span>
</code></pre> 
<p>output：<br> <img src="https://images2.imgbox.com/c4/57/anzGDaZU_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2range_68"></a>2.range</h3> 
<p>逻辑范围窗口，业务中一般都会和<code>order by</code>连用，否则使用range窗口没啥实际意义。range类型窗口的上下界依然可以沿用rows类型窗口的上下界，规则是以当前行order by字段的值为基准，对值按照指定的上下界范围进行加减操作以确定逻辑窗口上下界的值。例如当前行的值为3，自定义窗口大小为<code>range between 2 preceding and 1 following</code>，那么此时逻辑窗口的临界值为[3-2, 3+1] -&gt; [1, 4]，所有order by字段值在该范围内的行都属于当前行窗口中的记录。</p> 
<blockquote> 
 <p>这里有两个小细节：<br> 1）因为range是以行的值为基准，按照指定的上下界对值进行加减操作以确定窗口上下临界值的范围，因此range窗口的order by排序字段只能是数值型或日期时间类型这样支持逻辑意义上加减的字段类型，否则像varchar这种类型就会报下面这个错误：<br> <code>&gt; 3587 - Window '&lt;unnamed window&gt;' with RANGE N PRECEDING/FOLLOWING frame requires exactly one ORDER BY expression, of numeric or temporal type</code><br> 2）当排序字段为数值型时，自定义窗口的格式可以直接沿用rows中列举的上下界，例如<code>range n preceding</code>，这时窗口的上界值为当前行的值-n。但是如果为时间日期类型时对于<code>n preceding</code>这样的上界就不能使用了，因为mysql不知道是在这个时间日期的基础上-n day？还是-n hour？，因此需要用<code>range between interval 1 day preceding and interval 1 day following</code>这种语法格式明确一下，否则会报下面异常：<br> <code>&gt; 3588 - Window '&lt;unnamed window&gt;' with RANGE frame has ORDER BY expression of datetime type. Only INTERVAL bound value allowed.</code><br> 但是，对于<code>unbounded preceding</code>这样的上界，就不用interval的形式指定，很好理解，这种上界包括了所有小于当前行的值的记录，此时是- day还是- hour已经不重要了。</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 修改trans_date字段类型为date</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> test_rows_range <span class="token keyword">modify</span> trans_date <span class="token keyword">date</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
	<span class="token function">sum</span><span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date range <span class="token operator">between</span> <span class="token keyword">interval</span> <span class="token number">1</span> <span class="token keyword">day</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">interval</span> <span class="token number">1</span> <span class="token keyword">day</span> <span class="token keyword">following</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum1<span class="token punctuation">,</span> 	<span class="token comment">-- 当前行的日期&amp;前一天的日期&amp;后一天的日期 的所有行作为一个窗口</span>
	<span class="token function">sum</span><span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date range <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum2<span class="token punctuation">,</span>		<span class="token comment">-- 所有小于等于当前行日期的行作为窗口</span>
	<span class="token function">sum</span><span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date range <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum3		<span class="token comment">-- 仅取和当前行日期相等的行作为窗口</span>
<span class="token keyword">from</span> test_rows_range<span class="token punctuation">;</span>
</code></pre> 
<p>output：<br> <img src="https://images2.imgbox.com/de/90/3zoKVEOa_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_91"></a>3.默认窗口</h3> 
<p>如果不显式指定窗口大小，则默认窗口大小主要分为over()中有没有<code>order by</code>子句两种情况：</p> 
<ul><li>没有<code>order by</code>子句：默认窗口为每个组内的全部行。</li><li>有<code>order by</code>子句：默认窗口为<code>range unbounded preceding</code>。</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
	<span class="token function">sum</span><span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum1<span class="token punctuation">,</span> 	<span class="token comment">-- 无order by，窗口范围为全部行</span>
	<span class="token function">sum</span><span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> sum2		<span class="token comment">-- 有order by，窗口范围为当前行及之前的所有行</span>
<span class="token keyword">from</span> test_rows_range<span class="token punctuation">;</span>
</code></pre> 
<p>output：<br> <img src="https://images2.imgbox.com/46/43/V9DXNyRL_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_105"></a>四、常用窗口函数示例</h2> 
<p>这部分可以直接查看文档<a href="https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html" rel="nofollow">https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptions.html</a></p> 
<h3><a id="1row_number__rank__dense_rank_107"></a>1.row_number &amp; rank &amp; dense_rank</h3> 
<p>这三个都是排序函数，区别在于：</p> 
<ul><li>row_number()：序号不重复，不间断。</li><li>rank()：序号可重复，可间断。</li><li>dense_rank()，序号可重复，不间断。</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
	row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> rn<span class="token punctuation">,</span>
	rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> rk<span class="token punctuation">,</span>	
	dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> drk
<span class="token keyword">from</span> test_rows_range<span class="token punctuation">;</span>
</code></pre> 
<p>output：<br> <img src="https://images2.imgbox.com/04/70/Nm2zd4UM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2lead__lag_123"></a>2.lead &amp; lag</h3> 
<p>对指定字段整体上移(lead)或者下移(lag)。</p> 
<ul><li>lead(col, n, default)：上移。参数col表示移动的字段，不可缺省；参数n表示移动的距离，可缺省，缺省值默认值为1；参数default表示当出现空值时用来填充的默认值，可缺省，缺省时用null填充。</li><li>lag(col, n, default)：下移，参数含义同上。</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
	lead<span class="token punctuation">(</span>sales<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>lead<span class="token punctuation">`</span></span><span class="token punctuation">,</span>	<span class="token comment">-- 将sales字段值整体上移1位，空值用0填充</span>
	lag<span class="token punctuation">(</span>sales<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> lag1<span class="token punctuation">,</span>	<span class="token comment">-- 将sales字段值整体下移1位，空值用0填充</span>
	lag<span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> lag2	<span class="token comment">-- 将sales字段值整体下移1位，空值不处理</span>
<span class="token keyword">from</span> test_rows_range<span class="token punctuation">;</span>
</code></pre> 
<p>output：<br> <img src="https://images2.imgbox.com/e5/83/ltIbReIp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3first_value__last_value__nth_value_137"></a>3.first_value &amp; last_value &amp; nth_value</h3> 
<p>下面几个函数的作用是取窗口中指定顺序的字段值。</p> 
<ul><li>first_value(col)：取窗口中字段col的第一个值。</li><li>last_value(col)：取窗口中字段col的最后一个值。</li><li>nth_value(col, n)：取窗口中第n顺序的值。</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
	first_value<span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>first<span class="token punctuation">`</span></span><span class="token punctuation">,</span>	<span class="token comment">-- 取每个窗口第一个值</span>
	last_value<span class="token punctuation">(</span>sales<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">last</span><span class="token punctuation">,</span>	<span class="token comment">-- 取每个窗口最后一个值</span>
	nth_value<span class="token punctuation">(</span>sales<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> nth		<span class="token comment">-- 取每个窗口第二个值</span>
<span class="token keyword">from</span> test_rows_range<span class="token punctuation">;</span>
</code></pre> 
<p>output：<br> <img src="https://images2.imgbox.com/fd/e3/GVsTaw69_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4ntile_153"></a>4.ntile</h3> 
<p>将数据分组。</p> 
<ul><li>ntile(n)：n是指定的组数。分组逻辑是从小到后为每条数据打上一个组号的标签，尽可能使每组内的数据相对均匀，当每组内的数据不能完全一样时，多余的数据优先给组号较小的分组。</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
	ntile<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> ntile4	<span class="token comment">-- 数据均匀分为4组</span>
<span class="token keyword">from</span> test_rows_range<span class="token punctuation">;</span>
</code></pre> 
<p>output：<br> <img src="https://images2.imgbox.com/81/63/k8d1Xn1K_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5cume_dist__percent_rank_165"></a>5.cume_dist &amp; percent_rank（了解）</h3> 
<p>这两个函数基本不用，了解即可，下面是两个函数的官方描述。<br> <img src="https://images2.imgbox.com/08/8f/DhYM6rGC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/23/3e/WqlmvcbV_o.png" alt="在这里插入图片描述"><br> 从文档中可以看到这两个函数都应该与order by放在一起使用，返回的结果也都和order by字段的值有关。</p> 
<ul><li><code>cume_dist</code>：返回的是窗口中所有小于等于当前行order by字段的值的总行数 / 窗口所在的分组内的总行数。</li><li><code>percent_rank</code>：返回的是窗口中所有小于当前行order by字段的值的总行数 / 窗口所在的分组内的总行数-1。</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
	cume_dist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>cume_dist<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
	percent_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token identifier"><span class="token punctuation">`</span>percent_rank<span class="token punctuation">`</span></span>
<span class="token keyword">from</span> test_rows_range<span class="token punctuation">;</span>
</code></pre> 
<p>output：<br> <img src="https://images2.imgbox.com/fd/f2/OGdhkAkc_o.png" alt="在这里插入图片描述"><br> 解释一下这个输出结果，默认窗口<code>range unbounded preceding</code>，对于cume_dist列，第一行trans_date为’2020-10-01’时，窗口内小于等于这一行的总行数为1，而这个窗口所在的分组也就是整个表总行数为10，因此第一行结果为0.1；而对于后面3个连续的0.4，是因为窗口类型为range，小于等于第二行值’2020-10-02’的总行数为4，所以结果为0.4。</p> 
<p>对于percent_rank列，窗口所在的分组也就是整个表总行数为10，所以分母都为10-1=9。窗口内小于第一行’2020-10-01’的总行数为0，所以该列第一个值为0，后面以此类推…</p> 
<p><font color="red"><strong>PS</strong></font><br> 文档中没看到直接的描述，但在测试中发现了这两个函数有一些特点：<br> 1）只适用于range类型窗口，这并不是说显式指定rows会报错，而是mysql忽略指定，输出的结果和range类型一致。<br> 2）窗口范围自定义无效，也就是只能为默认窗口<code>range unbounded preceding</code>，像是修改为<code>range between interval 1 day preceding and interval 1 day preceding</code>无效。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>
	cume_dist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> dist_range<span class="token punctuation">,</span>
	cume_dist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date <span class="token keyword">rows</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span><span class="token punctuation">)</span> <span class="token keyword">as</span> dist_rows<span class="token punctuation">,</span>
	percent_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date<span class="token punctuation">)</span> <span class="token keyword">as</span> percent_range<span class="token punctuation">,</span>
	percent_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date <span class="token keyword">rows</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span><span class="token punctuation">)</span> <span class="token keyword">as</span> percent_rows<span class="token punctuation">,</span>
	percent_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> trans_date range <span class="token operator">between</span> <span class="token keyword">interval</span> <span class="token number">1</span> <span class="token keyword">day</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">interval</span> <span class="token number">1</span> <span class="token keyword">day</span> <span class="token keyword">preceding</span><span class="token punctuation">)</span> <span class="token keyword">as</span> percent_range1	<span class="token comment">-- 自定义窗口无效，不影响输出</span>
<span class="token keyword">from</span> test_rows_range<span class="token punctuation">;</span>
</code></pre> 
<p>output：<br> <img src="https://images2.imgbox.com/cf/f4/vEC6fuj8_o.png" alt="在这里插入图片描述"><br> 可以看到结果均无变化，我的理解是这两个函数都是用来计算某行记录在排序后的总体分布情况，因此rows类型的窗口因为忽略了重复值的影响所以不合适。而在此需求中更没必要让用户可以自定义指定窗口，因为这两个需求的总体思路都是按照<mark>当前行值在所有数据中的相对位置 / 所有记录数</mark>这样的思路来计算。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/28339799b8d6cb6f956a0d63e8ab05f3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C语言strlen函数的的用法详解及其模拟实现（详细）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5bbf82e02c7b27745ff6f31e5ab277e3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">idea从零开发Android 安卓 (超详细)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>