<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL8.4一主一从环境搭建 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/0fb89427dfb5f5579f2a2989c33a87e9/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="MySQL8.4一主一从环境搭建">
  <meta property="og:description" content="MySQL8.4一主一从环境搭建 一、MySQL数据库服务环境搭建 1.1、下载及上传mysql二进制安装包 下载地址
MySQL :: Download MySQL Community Server
上传mysql-8.4.0-linux-glibc2.17-x86_64.tar.xz到soft目录
ls -lsa /soft
1.2、增加MySQL用户组及用户 groupadd mysql
useradd -r -s /bin/false -g mysql mysql
mkdir -p /mysql/data/3306/data
mkdir -p /mysql/backup/backup-db
chown -R mysql:mysql /mysql
1.3、编辑配置文件my.cnf vi /mysql/data/3306/my.cnf
[mysqld]
server-id=573306
port=3306
basedir=/mysql/app/mysql
datadir=/mysql/data/3306/data
log-error=/mysql/log/3306/superdb-error.log
socket=/mysql/data/3306/mysql.sock
pid-file=/mysql/data/3306/mysql.pid
character-set-server=utf8mb4
lower_case_table_names=1
innodb_log_file_size=1G
default-storage-engine=INNODB
mysql_native_password=on
secure_file_priv=&#39;&#39;
[mysql]
prompt=(\\u@\\h)[\\d]&gt;\\_
[client]
port=3306
default-character-set=utf8mb4
1.4、解压 cd /soft
ls
xz -d mysql-8.4.0-linux-glibc2.17-x86_64.tar.xz
tar xvf mysql-8.4.0-linux-glibc2.17-x86_64.tar
mv mysql-8.4.0-linux-glibc2.17-x86_64 /mysql/app/mysql">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-14T10:39:19+08:00">
    <meta property="article:modified_time" content="2024-05-14T10:39:19+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL8.4一主一从环境搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 style="background-color:transparent;">MySQL8.4一主一从环境搭建</h2> 
<h2>一、MySQL数据库服务环境搭建</h2> 
<h4>1.1、下载及上传mysql二进制安装包</h4> 
<p>下载地址</p> 
<p><a href="https://dev.mysql.com/downloads/mysql/" rel="nofollow" title="MySQL :: Download MySQL Community Server">MySQL :: Download MySQL Community Server</a></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/6e/ca/5tZ6wS8J_o.png"></p> 
<p></p> 
<p>上传mysql-8.4.0-linux-glibc2.17-x86_64.tar.xz到soft目录<br> ls -lsa /soft</p> 
<p></p> 
<h4>1.2、增加MySQL用户组及用户</h4> 
<p><br> groupadd mysql<br> useradd -r -s /bin/false -g mysql mysql</p> 
<p>mkdir -p /mysql/data/3306/data<br> mkdir -p /mysql/backup/backup-db<br><br> chown -R mysql:mysql /mysql</p> 
<p></p> 
<h4>1.3、编辑配置文件my.cnf</h4> 
<p>vi /mysql/data/3306/my.cnf</p> 
<p><br> [mysqld]<br> server-id=573306<br> port=3306<br> basedir=/mysql/app/mysql<br> datadir=/mysql/data/3306/data<br> log-error=/mysql/log/3306/superdb-error.log<br> socket=/mysql/data/3306/mysql.sock<br> pid-file=/mysql/data/3306/mysql.pid<br> character-set-server=utf8mb4<br> lower_case_table_names=1<br> innodb_log_file_size=1G<br> default-storage-engine=INNODB<br> mysql_native_password=on<br> secure_file_priv=''</p> 
<p><br> [mysql]<br> prompt=(\\u@\\h)[\\d]&gt;\\_</p> 
<p>[client]<br> port=3306<br> default-character-set=utf8mb4</p> 
<h4>1.4、解压</h4> 
<p><br> cd /soft<br> ls<br> xz -d mysql-8.4.0-linux-glibc2.17-x86_64.tar.xz<br> tar xvf mysql-8.4.0-linux-glibc2.17-x86_64.tar<br> mv mysql-8.4.0-linux-glibc2.17-x86_64 /mysql/app/mysql</p> 
<p></p> 
<h4>1.5、mysql初始化<br>  </h4> 
<p>/mysql/app/mysql/bin/mysqld  --defaults-file=/mysql/data/3306/my.cnf  --initialize --user=mysql --basedir=/mysql/app/mysql --datadir=/mysql/data/3306/data</p> 
<p></p> 
<h4>1.6、安全模式启动mysql<br>  </h4> 
<p>/mysql/app/mysql/bin/mysqld_safe --defaults-file=/mysql/data/3306/my.cnf  &amp;</p> 
<p></p> 
<h4>1.7、设置软连接sock软连接</h4> 
<p></p> 
<p>ln -sf /mysql/data/3306/mysql.sock /tmp/mysql.sock</p> 
<p></p> 
<h4>1.8、编辑环境变量mysql home目录及登陆提示</h4> 
<p></p> 
<p>vi ~/.bash_profile</p> 
<p>PATH=$PATH:/mysql/app/mysql/bin:$HOME/bin<br> export MYSQL_PS1="(\u@\h:\p)[\d]&gt;"</p> 
<p>source ~/.bash_profile</p> 
<p><br> tail -fn300 /mysql/log/3306/superdb-error.log</p> 
<h4><br> 1.9、登陆mysql设置密码</h4> 
<p></p> 
<p>defaultmysqlpwd=`grep 'A temporary password' /mysql/log/3306/superdb-error.log |awk -F "root@localhost: " '{ print $2}' |tail -n1`<br> mysql -uroot -p"${defaultmysqlpwd}" --connect-expired-password &lt;&lt;EOF<br> ALTER USER 'root'@'localhost' IDENTIFIED BY 'Root@2024';<br> EOF<br> sleep 1</p> 
<p>mysql -uroot -p</p> 
<p>create user 'root'@'%' identified  by 'Root@2024';<br> grant all privileges on *.* to 'root'@'%';<br> flush privileges;<br> exit</p> 
<h4>1.10、设置service mysqld 服务</h4> 
<p><br> mv /mysql/app/mysql/support-files/mysql.server /mysql/app/mysql/support-files/mysql.server.bak</p> 
<p>vi /mysql/app/mysql/support-files/mysql.server</p> 
<pre><code class="language-bash">#!/bin/sh
# Copyright Abandoned 1996 TCX DataKonsult AB &amp; Monty Program KB &amp; Detron HB
# This file is public domain and comes with NO WARRANTY of any kind

# MySQL daemon start/stop script.

# Usually this is put in /etc/init.d (at least on machines SYSV R4 based
# systems) and linked to /etc/rc3.d/S99mysql and /etc/rc0.d/K01mysql.
# When this is done the mysql server will be started when the machine is
# started and shut down when the systems goes down.

# Comments to support chkconfig on RedHat Linux
# chkconfig: 2345 64 36
# description: A very fast and reliable SQL database engine.

# Comments to support LSB init script conventions
### BEGIN INIT INFO
# Provides: mysql
# Required-Start: $local_fs $network $remote_fs
# Should-Start: ypbind nscd ldap ntpd xntpd
# Required-Stop: $local_fs $network $remote_fs
# Default-Start:  2 3 4 5
# Default-Stop: 0 1 6
# Short-Description: start and stop MySQL
# Description: MySQL is a very fast and reliable SQL database engine.
### END INIT INFO
 
# If you install MySQL on some other places than /usr/local/mysql, then you
# have to do one of the following things for this script to work:
#
# - Run this script from within the MySQL installation directory
# - Create a /etc/my.cnf file with the following information:
#   [mysqld]
#   basedir=&lt;path-to-mysql-installation-directory&gt;
# - Add the above to any other configuration file (for example ~/.my.ini)
#   and copy my_print_defaults to /usr/bin
# - Add the path to the mysql-installation-directory to the basedir variable
#   below.
#
# If you want to affect other MySQL variables, you should make your changes
# in the /etc/my.cnf, ~/.my.cnf or other MySQL configuration files.

# If you change base dir, you must also change datadir. These may get
# overwritten by settings in the MySQL configuration files.

basedir=/mysql/app/mysql
datadir=/mysql/data/3306/data

# Default value, in seconds, afterwhich the script should timeout waiting
# for server start. 
# Value here is overriden by value in my.cnf. 
# 0 means don't wait at all
# Negative numbers mean to wait indefinitely
service_startup_timeout=900

# Lock directory for RedHat / SuSE.
lockdir='/var/lock/subsys'
lock_file_path="$lockdir/mysql"

# The following variables are only set for letting mysql.server find things.

# Set some defaults
mysqld_pid_file_path=/mysql/data/3306/mysql.pid
if test -z "$basedir"
then
  basedir=/mysql/app/mysql
  bindir=/mysql/app/mysql/bin
  if test -z "$datadir"
  then
    datadir=/mysql/data/3306/data
  fi
  sbindir=/mysql/app/mysql/bin
  libexecdir=/mysql/app/mysql/bin
else
  bindir="$basedir/bin"
  if test -z "$datadir"
  then
    datadir="/mysql/app/3306/data"
  fi
  sbindir="$basedir/sbin"
  libexecdir="$basedir/libexec"
fi

# datadir_set is used to determine if datadir was set (and so should be
# *not* set inside of the --basedir= handler.)
datadir_set=

#
# Use LSB init script functions for printing messages, if possible
#
lsb_functions="/lib/lsb/init-functions"
if test -f $lsb_functions ; then
  . $lsb_functions
else
  log_success_msg()
  {
    echo " SUCCESS! $@"
  }
  log_failure_msg()
  {
    echo " ERROR! $@"
  }
fi

PATH="/sbin:/usr/sbin:/bin:/mysql/app/mysql/bin:/usr/bin:$basedir/bin"
export PATH

mode=$1    # start or stop

[ $# -ge 1 ] &amp;&amp; shift


other_args="$*"   # uncommon, but needed when called from an RPM upgrade action
           # Expected: "--skip-networking --skip-grant-tables"
           # They are not checked here, intentionally, as it is the resposibility
           # of the "spec" file author to give correct arguments only.

case `echo "testing\c"`,`echo -n testing` in
    *c*,-n*) echo_n=   echo_c=     ;;
    *c*,*)   echo_n=-n echo_c=     ;;
    *)       echo_n=   echo_c='\c' ;;
esac

parse_server_arguments() {
  for arg do
    case "$arg" in
      --basedir=*)  basedir=`echo "$arg" | sed -e 's/^[^=]*=//'`
                    bindir="$basedir/bin"
		    if test -z "$datadir_set"; then
		      datadir="$basedir/data"
		    fi
		    sbindir="$basedir/sbin"
		    libexecdir="$basedir/libexec"
        ;;
      --datadir=*)  datadir=`echo "$arg" | sed -e 's/^[^=]*=//'`
		    datadir_set=1
	;;
      --pid-file=*) mysqld_pid_file_path=`echo "$arg" | sed -e 's/^[^=]*=//'` ;;
      --service-startup-timeout=*) service_startup_timeout=`echo "$arg" | sed -e 's/^[^=]*=//'` ;;
    esac
  done
}

wait_for_pid () {
  verb="$1"           # created | removed
  pid="$2"            # process ID of the program operating on the pid-file
  pid_file_path="$3" # path to the PID file.

  i=0
  avoid_race_condition="by checking again"

  while test $i -ne $service_startup_timeout ; do

    case "$verb" in
      'created')
        # wait for a PID-file to pop into existence.
        test -s "$pid_file_path" &amp;&amp; i='' &amp;&amp; break
        ;;
      'removed')
        # wait for this PID-file to disappear
        test ! -s "$pid_file_path" &amp;&amp; i='' &amp;&amp; break
        ;;
      *)
        echo "wait_for_pid () usage: wait_for_pid created|removed pid pid_file_path"
        exit 1
        ;;
    esac

    # if server isn't running, then pid-file will never be updated
    if test -n "$pid"; then
      if kill -0 "$pid" 2&gt;/dev/null; then
        :  # the server still runs
      else
        # The server may have exited between the last pid-file check and now.  
        if test -n "$avoid_race_condition"; then
          avoid_race_condition=""
          continue  # Check again.
        fi

        # there's nothing that will affect the file.
        log_failure_msg "The server quit without updating PID file ($pid_file_path)."
        return 1  # not waiting any more.
      fi
    fi

    echo $echo_n ".$echo_c"
    i=`expr $i + 1`
    sleep 1

  done

  if test -z "$i" ; then
    log_success_msg
    return 0
  else
    log_failure_msg
    return 1
  fi
}

# Get arguments from the my.cnf file,
# the only group, which is read from now on is [mysqld]
if test -x "$bindir/my_print_defaults";  then
  print_defaults="$bindir/my_print_defaults"
else
  # Try to find basedir in /etc/my.cnf
  conf=/mysql/data/3306/my.cnf
  print_defaults=
  if test -r $conf
  then
    subpat='^[^=]*basedir[^=]*=\(.*\)$'
    dirs=`sed -e "/$subpat/!d" -e 's//\1/' $conf`
    for d in $dirs
    do
      d=`echo $d | sed -e 's/[ 	]//g'`
      if test -x "$d/bin/my_print_defaults"
      then
        print_defaults="$d/bin/my_print_defaults"
        break
      fi
    done
  fi

  # Hope it's in the PATH ... but I doubt it
  test -z "$print_defaults" &amp;&amp; print_defaults="my_print_defaults"
fi

#
# Read defaults file from 'basedir'.   If there is no defaults file there
# check if it's in the old (depricated) place (datadir) and read it from there
#

extra_args=""
if test -r "/mysql/data/3306/my.cnf"
then
  extra_args="-e /mysql/data/3306/my.cnf"
fi

parse_server_arguments `$print_defaults $extra_args mysqld server mysql_server mysql.server`

#
# Set pid file if not given
#
if test -z "$mysqld_pid_file_path"
then
  mysqld_pid_file_path=$datadir/`hostname`.pid
else
  case "$mysqld_pid_file_path" in
    /* ) ;;
    * )  mysqld_pid_file_path="$datadir/$mysqld_pid_file_path" ;;
  esac
fi

case "$mode" in
  'start')
    # Start daemon

    # Safeguard (relative paths, core dumps..)
    cd $basedir

    echo $echo_n "Starting MySQL"
    if test -x $bindir/mysqld_safe
    then
      # Give extra arguments to mysqld with the my.cnf file. This script
      # may be overwritten at next upgrade.
      $bindir/mysqld_safe --defaults-file=/mysql/data/3306/my.cnf --datadir="$datadir" --pid-file="$mysqld_pid_file_path" $other_args &gt;/dev/null &amp;
      wait_for_pid created "$!" "$mysqld_pid_file_path"; return_value=$?

      # Make lock for RedHat / SuSE
      if test -w "$lockdir"
      then
        touch "$lock_file_path"
      fi

      exit $return_value
    else
      log_failure_msg "Couldn't find MySQL server ($bindir/mysqld_safe)"
    fi
    ;;

  'stop')
    # Stop daemon. We use a signal here to avoid having to know the
    # root password.

    if test -s "$mysqld_pid_file_path"
    then
      # signal mysqld_safe that it needs to stop
      touch "$mysqld_pid_file_path.shutdown"

      mysqld_pid=`cat "$mysqld_pid_file_path"`

      if (kill -0 $mysqld_pid 2&gt;/dev/null)
      then
        echo $echo_n "Shutting down MySQL"
        kill $mysqld_pid
        # mysqld should remove the pid file when it exits, so wait for it.
        wait_for_pid removed "$mysqld_pid" "$mysqld_pid_file_path"; return_value=$?
      else
        log_failure_msg "MySQL server process #$mysqld_pid is not running!"
        rm "$mysqld_pid_file_path"
      fi

      # Delete lock for RedHat / SuSE
      if test -f "$lock_file_path"
      then
        rm -f "$lock_file_path"
      fi
      exit $return_value
    else
      log_failure_msg "MySQL server PID file could not be found!"
    fi
    ;;

  'restart')
    # Stop the service and regardless of whether it was
    # running or not, start it again.
    if $0 stop  $other_args; then
      $0 start $other_args
    else
      log_failure_msg "Failed to stop running server, so refusing to try to start."
      exit 1
    fi
    ;;

  'reload'|'force-reload')
    if test -s "$mysqld_pid_file_path" ; then
      read mysqld_pid &lt;  "$mysqld_pid_file_path"
      kill -HUP $mysqld_pid &amp;&amp; log_success_msg "Reloading service MySQL"
      touch "$mysqld_pid_file_path"
    else
      log_failure_msg "MySQL PID file could not be found!"
      exit 1
    fi
    ;;
  'status')
    # First, check to see if pid file exists
    if test -s "$mysqld_pid_file_path" ; then 
      read mysqld_pid &lt; "$mysqld_pid_file_path"
      if kill -0 $mysqld_pid 2&gt;/dev/null ; then 
        log_success_msg "MySQL running ($mysqld_pid)"
        exit 0
      else
        log_failure_msg "MySQL is not running, but PID file exists"
        exit 1
      fi
    else
      # Try to find appropriate mysqld process
      mysqld_pid=`pidof $libexecdir/mysqld`

      # test if multiple pids exist
      pid_count=`echo $mysqld_pid | wc -w`
      if test $pid_count -gt 1 ; then
        log_failure_msg "Multiple MySQL running but PID file could not be found ($mysqld_pid)"
        exit 5
      elif test -z $mysqld_pid ; then 
        if test -f "$lock_file_path" ; then 
          log_failure_msg "MySQL is not running, but lock file ($lock_file_path) exists"
          exit 2
        fi 
        log_failure_msg "MySQL is not running"
        exit 3
      else
        log_failure_msg "MySQL is running but PID file could not be found"
        exit 4
      fi
    fi
    ;;
    *)
      # usage
      basename=`basename "$0"`
      echo "Usage: $basename  {start|stop|restart|reload|force-reload|status}  [ MySQL server options ]"
      exit 1
    ;;
esac

exit 0</code></pre> 
<p><br> cp /mysql/app/mysql/support-files/mysql.server /etc/init.d/mysqld</p> 
<p>chmod 775 /etc/init.d/mysqld</p> 
<p><br> chkconfig --list<br> chkconfig --add mysqld<br> chkconfig --list</p> 
<p>service mysqld status</p> 
<p>service mysqld stop</p> 
<p>service mysqld start</p> 
<p></p> 
<h2>二、数据准备，模拟生产的环境</h2> 
<h3>2.1、主节点创建库及测试表</h3> 
<pre><code class="language-sql">create database db01;
use db01;

create table dept
( deptno int unsigned auto_increment primary key comment '部门编号',
dname  varchar(15) comment '部门名称'  ,
loc  varchar(50) comment '部门所在位置'
)engine = innodb default charset=utf8mb4 comment='员工部门表';

create table emp(
empno int unsigned auto_increment primary key comment '雇员编号',
ename varchar(15)  comment '雇员姓名' ,
job varchar(10)   comment '雇员职位'  ,
mgr int unsigned  comment '雇员对应的领导的编号',
hiredate  date    comment '雇员的雇佣日期' ,
sal decimal(7,2)  comment '雇员的基本工资' ,
comm  decimal(7,2)   comment '奖金'  ,
deptno int unsigned   comment '所在部门' ,
foreign key(deptno) references dept(deptno)
)engine = innodb default charset =utf8mb4 comment='雇员信息表';

create table salgrade
(
grade int comment '工资等级',
losal int comment '此等级的最低工资',
hisal int comment '此等级的最高工资'
)engine=innodb default charset=utf8mb4 comment='工资等级表';

alter table salgrade add constraint pk_salgrade_primary primary key (grade,losal,hisal);

create table bonus
(   ename  varchar(10) comment '雇员姓名',
job    varchar(9) comment '雇员职位',
sal    decimal(7,2) comment '雇员工资',
comm   decimal(7,2) comment '雇员奖金'
)engine=innodb default charset=utf8mb4 comment='雇员奖金表' ;

alter table bonus add constraint pk_bonus_primary primary key (ename,job);

show full columns from emp;
select * from information_schema.tables where table_schema='db01' and table_name='emp';
select * from information_schema.columns where table_schema='db01' and table_name='emp';

insert into dept values (10,'ACCOUNTING','NEW YORK');
insert into dept values (20,'RESEARCH','DALLAS');
insert into dept values (30,'SALES','CHICAGO');
insert into dept values (40,'OPERATIONS','BOSTON');

insert into emp values    (7369,'SMITH','CLERK',7902,'1980-12-17',800,null,20);
insert into emp values    (7499,'ALLEN','SALESMAN',7698,'1981-2-20',1600,300,30);
insert into emp values    (7521,'WARD','SALESMAN',7698,'1981-2-22',1250,500,30);
insert into emp values    (7566,'JONES','MANAGER',7839,'1981-4-2',2975,null,20);
insert into emp values    (7654,'MARTIN','SALESMAN',7698,'1981-9-28',1250,1400,30);
insert into emp values    (7698,'BLAKE','MANAGER',7839,'1981-5-1',2850,null,30);
insert into emp values    (7782,'CLARK','MANAGER',7839,'1981-6-9',2450,null,10);
insert into emp values    (7788,'SCOTT','ANALYST',7566,'87-7-13',3000,null,20);
insert into emp values    (7839,'KING','PRESIDENT',null,'1981-11-17',5000,null,10);
insert into emp values    (7844,'TURNER','SALESMAN',7698,'1981-9-8',1500,0,30);
insert into emp values    (7876,'ADAMS','CLERK',7788,'87-7-13',1100,null,20);
insert into emp values    (7900,'JAMES','CLERK',7698,'1981-12-3',950,null,30);
insert into emp values    (7902,'FORD','ANALYST',7566,'1981-12-3',3000,null,20);
insert into emp values    (7934,'MILLER','CLERK',7782,'1982-1-23',1300,null,10);

insert into salgrade values (1,700,1200);
insert into salgrade values (2,1201,1400);
insert into salgrade values (3,1401,2000);
insert into salgrade values (4,2001,3000);
insert into salgrade values (5,3001,9999);
commit;
</code></pre> 
<h2><br> 三、搭建主从及测试</h2> 
<h4><br> 3.1、设置复制源配置</h4> 
<p><br> show variables like '%server_id%';</p> 
<h4>3.2、为复制创建用户</h4> 
<p>注意：主从节点都执行，方便后期主从切换</p> 
<p><br> CREATE USER 'repl'@'%' identified by 'Root@3306';<br> GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';<br>  <br> 测试从库连接主库<br> mysql -u repl -p -h 192.168.80.50</p> 
<h4><br> 3.3、获取复制源的二进制日志位置<br>  </h4> 
<p>在主节点的不同会话中，使用 SHOW BINARY LOG STATUS语句确定当前二进制日志文件名和位置：<br> SHOW BINARY LOG STATUS;</p> 
<pre><code class="language-sql">(root@localhost:mysql.sock)[(none)]&gt;SHOW BINARY LOG STATUS;
+---------------+----------+--------------+------------------+-------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+---------------+----------+--------------+------------------+-------------------+
| binlog.000001 |    11518 |              |                  |                   |
+---------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)</code></pre> 
<h4><br> 3.4、主节点备份及上传到备节点</h4> 
<p><br> 使用mysqldump工具创建要复制的所有数据库的转储。这是推荐的方法，尤其是在使用 InnoDB. <br> mysqldump --all-databases --master-data &gt; dbdump.db<br> 如果不使用 --master-data，则需要手动锁定单独会话中的所有表 --ignore-table使用选项 排除数据库中的所有表 --databases选项仅命名要转储的那些数据库<br><br> cd /mysql/backup/backup-db<br> mysqldump  -uroot  -p  --all-databases  --master-data=1 &gt; dbfulldump.db</p> 
<p>du -sh dbfulldump.db </p> 
<p><br> 从节点检查目录是的否存在<br> mkdir -p /mysql/backup/backup-db</p> 
<p>拷贝主节点的备份到从节点</p> 
<p>scp -r /mysql/backup/backup-db/dbfulldump.db root@192.168.80.51:/mysql/backup/backup-db</p> 
<p></p> 
<h4>3.5、设置副本</h4> 
<h5><br> 3.5.1、调整server_id</h5> 
<pre><code class="language-sql">show variables like '%server%';
+---------------------------------+--------------------------------------+
| Variable_name                   | Value                                |
+---------------------------------+--------------------------------------+
| character_set_server            | utf8mb4                              |
| collation_server                | utf8mb4_0900_ai_ci                   |
| immediate_server_version        | 999999                               |
| innodb_dedicated_server         | OFF                                  |
| innodb_ft_server_stopword_table |                                      |
| original_server_version         | 999999                               |
| server_id                       | 513306                               |
| server_id_bits                  | 32                                   |
| server_uuid                     | 81c80be9-10d4-11ef-b4df-000c290e14ee |
+---------------------------------+--------------------------------------+
9 rows in set (0.00 sec)</code></pre> 
<h5>3.5.2、导入数据</h5> 
<pre><code class="language-sql">show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)</code></pre> 
<p>source dbdump.db</p> 
<h5>3.5.3、配置连接到主服务器的相关信息</h5> 
<pre><code class="language-sql">CHANGE REPLICATION SOURCE TO SOURCE_HOST='192.168.80.50', SOURCE_LOG_FILE='binlog.000001', SOURCE_LOG_POS=11518, SOURCE_PORT=3306, SOURCE_USER='repl', SOURCE_PASSWORD='Root@3306';</code></pre> 
<h5>3.5.4、启动从服务器的复制线程</h5> 
<pre><code class="language-sql">start REPLICA;</code></pre> 
<p></p> 
<h4>3.6、验证</h4> 
<pre><code class="language-sql">show REPLICA status \G

show processlist \G

select * from db01.emp;

select * from db01.dept;</code></pre> 
<h5><br> 3.7、在线启用 GTID 事务<br> 3.7.1、主库</h5> 
<pre><code class="language-sql">SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = WARN;
SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = ON;
SET @@GLOBAL.GTID_MODE = OFF_PERMISSIVE;
SET @@GLOBAL.GTID_MODE = ON_PERMISSIVE;
SHOW STATUS LIKE 'ONGOING_ANONYMOUS_TRANSACTION_COUNT';
SET @@GLOBAL.GTID_MODE = ON;</code></pre> 
<h5>3.7.2、从库</h5> 
<pre><code class="language-sql">SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = WARN;
SET @@GLOBAL.ENFORCE_GTID_CONSISTENCY = ON;
SET @@GLOBAL.GTID_MODE = OFF_PERMISSIVE;
SET @@GLOBAL.GTID_MODE = ON_PERMISSIVE;
SHOW STATUS LIKE 'ONGOING_ANONYMOUS_TRANSACTION_COUNT';
SET @@GLOBAL.GTID_MODE = ON;
stop replica;
CHANGE REPLICATION SOURCE TO SOURCE_AUTO_POSITION = 1 ;
START replica;</code></pre> 
<h5><br> 3.7.3、修改配置文件</h5> 
<pre><code class="language-sql">gtid_mode = ON
enforce_gtid_consistency = ON</code></pre> 
<h5 style="background-color:transparent;">3.7.4、主节点模拟增量数据产生及数据同步</h5> 
<pre><code class="language-sql">CREATE TABLE t_city_list(
id bigint auto_increment,
country VARCHAR(64),
city VARCHAR(64),
constraint pk_t_city_list_id primary key(id)
);

INSERT INTO t_city_list(country,city) VALUES ('中国','北京');
INSERT INTO t_city_list(country,city) VALUES ('中国','广州');
INSERT INTO t_city_list(country,city) VALUES ('中国','深圳');
INSERT INTO t_city_list(country,city) VALUES ('中国','香港');
INSERT INTO t_city_list(country,city) VALUES ('中国','上海');
INSERT INTO t_city_list(country,city) VALUES ('日本','东京');
INSERT INTO t_city_list(country,city) VALUES ('日本','大阪');
commit;

select * from db01.t_city_list</code></pre> 
<p><strong>从节点检查</strong></p> 
<pre><code class="language-sql">select * from t_city_list;</code></pre> 
<p><strong>主节点再次新增数据</strong></p> 
<pre><code class="language-sql">INSERT INTO t_city_list(country,city) VALUES ('中国','中山');
INSERT INTO t_city_list(country,city) VALUES ('中国','珠海');</code></pre> 
<p><strong>从节点再次检查数据同步情况</strong></p> 
<pre><code class="language-sql">select * from t_city_list;</code></pre> 
<h4><br> 3.8、主备切换</h4> 
<h5><br> 3.8.1、设置主库只读</h5> 
<pre><code class="language-sql">set global read_only=ON;
set global super_read_only=ON;</code></pre> 
<h5>3.8.2、查看从库进程状态</h5> 
<pre><code class="language-sql">show replica status \G;</code></pre> 
<p>确认参数项<br> Slave_IO_Running              参数值为YES<br> Slave_SQL_Running           参数值为YES<br> Seconds_Behind_Master    参数值为   0</p> 
<h5>3.8.3、主备节点两边的executed_gtid集合对比</h5> 
<pre><code class="language-sql">select @@global.gtid_executed;
+-------------------------------------------+
| @@global.gtid_executed                    |
+-------------------------------------------+
| e9adc552-10d5-11ef-81ba-000c2940f616:1-10 |
+-------------------------------------------+
1 row in set (0.00 sec)

show global variables like 'gtid_%';
+----------------------------------+-------------------------------------------+
| Variable_name                    | Value                                     |
+----------------------------------+-------------------------------------------+
| gtid_executed                    | e9adc552-10d5-11ef-81ba-000c2940f616:1-10 |
| gtid_executed_compression_period | 0                                         |
| gtid_mode                        | ON                                        |
| gtid_owned                       |                                           |
| gtid_purged                      |                                           |
+----------------------------------+-------------------------------------------+
5 rows in set (0.00 sec)</code></pre> 
<h5><br> 3.8.4、从库停掉复制进程并清空主从信息(原从库)</h5> 
<pre><code class="language-sql">stop replica;
reset replica all;</code></pre> 
<h5><br> 3.8.5、从库关闭只读(原从库)</h5> 
<pre><code class="language-sql">set global read_only=off;
set global super_read_only=off;</code></pre> 
<h5>3.8.6、主库设置执行原主库转为从库</h5> 
<pre><code class="language-sql">CHANGE MASTER TO MASTER_HOST='192.168.80.51',MASTER_PORT=3306, MASTER_USER='repl', MASTER_PASSWORD='Root@3306',master_auto_position=1; #mysql5.7/mysql8.0

CHANGE REPLICATION SOURCE TO SOURCE_HOST='192.168.80.51',SOURCE_PORT=3306,SOURCE_USER='repl', SOURCE_PASSWORD='Root@3306',SOURCE_auto_position=1; #mysql8.4

start replica;</code></pre> 
<h5>3.8.7、检查验证</h5> 
<p>新从节点原主节点80.50</p> 
<pre><code class="language-sql">show replica status \G;</code></pre> 
<p>新主节点原从节点80.51</p> 
<pre><code class="language-sql">INSERT INTO db01.t_city_list(country,city) VALUES ('中国','兰州');</code></pre> 
<p>新主从节点检查数据同步情况</p> 
<pre><code class="language-sql">select * from db01.t_city_list;</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/64ad6b688dc23e2966d1ac9111fe32ac/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PostgreSQL导入Excel数据</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ec6cffdaca2913b58b5e1e202bd8621f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java mapper批量更新、插入、查询</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>