<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ROS2高效学习第十章 -- ros2 高级组件其四之 webots - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/2fc26c6316e3f49c42f9bec81aa6baa5/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="ROS2高效学习第十章 -- ros2 高级组件其四之 webots">
  <meta property="og:description" content="ros2 高级组件其四之 webots 1 前言和资料2 正文2.1 webots 引入和学习资料2.2 webots 安装以及样例测试2.3 自编写 webots_demo 3 总结 1 前言和资料 当前，在机器人仿真领域，有两大产品比较突出，一是来自 ros 社区的 gazebo，二是从商业转向开源的 webots。通常情况下，ros 的学习者都会深入研究 gazebo，比如本人之前的 ROS高效进阶系列。但由于 webots 转向开源，加上 ros 的支持，影响力越来越大，ros2 humble 官方 Tutorials 也正式引入了 webots 的内容。
本文先介绍 webots 以及学习资料，然后安装并测试 webots，最后基于 ros2 humble 官方 Tutorials 中 webots 的内容，利用 webots 实现一个差速轮式机器人的运动仿真。
本文参考资料如下：
（1）Simulation-Webots
（2）其他资料见文章内容
2 正文 2.1 webots 引入和学习资料 （1）webots 引入：webots 是来自瑞士的 Cyberbotics 公司（Cyberbotics 官网）推出的机器人仿真软件，旨在降低机器人技术开发的门槛，并加速从理论到实践的转化过程。该平台用户群体非常广泛，涵盖了教育、科研和工业界。2018年以前，webots 是一款商业软件，2018年12月以后，Webots作为开放源码软件在Apache 2.0许可下发布（webots github）。
（2）gazebo 和 webots 的比较：这里我推荐两篇博客，大家大致了解下他们的异同即可。本文不建议读者在这里花费太多时间，适当了解后，尽快学习才是王道！
第一，ROS仿真平台总结">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-04T22:13:41+08:00">
    <meta property="article:modified_time" content="2024-05-04T22:13:41+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ROS2高效学习第十章 -- ros2 高级组件其四之 webots</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>ros2 高级组件其四之 webots</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1 前言和资料</a></li><li><a href="#2__7" rel="nofollow">2 正文</a></li><li><ul><li><a href="#21_webots__8" rel="nofollow">2.1 webots 引入和学习资料</a></li><li><a href="#22_webots__21" rel="nofollow">2.2 webots 安装以及样例测试</a></li><li><a href="#23__webots_demo_46" rel="nofollow">2.3 自编写 webots_demo</a></li></ul> 
  </li><li><a href="#3__280" rel="nofollow">3 总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1 前言和资料</h2> 
<p>当前，在机器人仿真领域，有两大产品比较突出，一是来自 ros 社区的 gazebo，二是从商业转向开源的 webots。通常情况下，ros 的学习者都会深入研究 gazebo，比如本人之前的 <a href="https://blog.csdn.net/cy1641395022/article/details/134980083">ROS高效进阶系列</a>。但由于 webots 转向开源，加上 ros 的支持，影响力越来越大，ros2 humble 官方 Tutorials 也正式引入了 webots 的内容。<br> 本文先介绍 webots 以及学习资料，然后安装并测试 webots，最后基于 ros2 humble 官方 Tutorials 中 webots 的内容，利用 webots 实现一个差速轮式机器人的运动仿真。<br> 本文参考资料如下：<br> （1）<a href="https://docs.ros.org/en/humble/Tutorials/Advanced/Simulators/Webots/Simulation-Webots.html" rel="nofollow">Simulation-Webots</a><br> （2）其他资料见文章内容</p> 
<h2><a id="2__7"></a>2 正文</h2> 
<h3><a id="21_webots__8"></a>2.1 webots 引入和学习资料</h3> 
<p>（1）webots 引入：webots 是来自瑞士的 Cyberbotics 公司（<a href="https://cyberbotics.com/" rel="nofollow">Cyberbotics 官网</a>）推出的机器人仿真软件，旨在降低机器人技术开发的门槛，并加速从理论到实践的转化过程。该平台用户群体非常广泛，涵盖了教育、科研和工业界。2018年以前，webots 是一款商业软件，2018年12月以后，Webots作为开放源码软件在Apache 2.0许可下发布（<a href="https://github.com/cyberbotics">webots github</a>）。<br> （2）gazebo 和 webots 的比较：这里我推荐两篇博客，大家大致了解下他们的异同即可。本文不建议读者在这里花费太多时间，适当了解后，尽快学习才是王道！<br> 第一，<a href="https://blog.csdn.net/crp997576280/article/details/106396478">ROS仿真平台总结</a><br> 第二，<a href="https://www.guyuehome.com/8218" rel="nofollow">到底该用哪款神器来仿真我的机器人？</a><br> （3）webots 和 ros：webots 本身是一款独立的仿真软件，跟 ros 没有关系。后来，ros1 有了 webots_ros 软件包，ros2 有了 webots_ros2 软件包，从而打通了 ros 与 webots 之间的接口，使得两者之间可以顺利通信。本文我们将使用 webots_ros2 ：<a href="https://github.com/cyberbotics/webots_ros2">webots_ros2 github</a><br> （4）webots 学习资料：这些资料都在 Cyberbotics 官网，有时会打不开，请多试几次。或者用翻墙梯子，体验会好很多。<br> 第一，<a href="https://cyberbotics.com/doc/guide/index" rel="nofollow">webots 入门手册</a> ，尤其是里面的 <a href="https://cyberbotics.com/doc/guide/tutorials" rel="nofollow">webots tutorials</a> ，<br> 补充：另外推荐 <a href="https://blog.csdn.net/crp997576280/article/details/106396478">webots 中文系列教学博客</a>，可供读者参考。<br> 第二，<a href="https://cyberbotics.com/doc/reference/index" rel="nofollow">webots 参考手册</a><br> 第三，<a href="https://cyberbotics.com/doc/automobile/index" rel="nofollow">webots 自动驾驶仿真</a><br> （5）webots 学习路线：把上面的webots 学习资料按顺序学完，并动手实践。</p> 
<h3><a id="22_webots__21"></a>2.2 webots 安装以及样例测试</h3> 
<p>（1）webots 安装：由于 webots 是从商业转向的开源，因此安装非常简单，如下。本系列 ros2 文章的基础环境是 Ubuntu22.04 + ros2 humble，安装的 webots 版本是 webotsR2023b。</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> ~
<span class="token comment"># 先安装 webots_ros2</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> ros-humble-webots-ros2
<span class="token comment"># 启动机器臂样例，程序会自动查找 webots ，如果没有找到，则会询问你是否自动安装，如果yes，则默认安装在: ~/.ros/webotsR2023b/webots</span>
ros2 launch webots_ros2_universal_robot multirobot_launch.py
<span class="token comment"># 设置 WEBOTS_HOME，方便查找安装位置</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">WEBOTS_HOME</span><span class="token operator">=</span>/home/ycao/.ros/webotsR2023b/webots
</code></pre> 
<p><img src="https://images2.imgbox.com/96/f4/tBUCyAoE_o.png" alt="在这里插入图片描述" width="600" height="350"><br> （2）在 webots_ros2 中，利用 webots 实现了多种机器人仿真，包括 TurtleBot3 ，Tesla Model3，详细内容见：<a href="https://github.com/cyberbotics/webots_ros2/wiki/Examples">webots_ros2 Examples</a><br> 测试 TurtleBot3 :</p> 
<pre><code class="prism language-bash"><span class="token comment"># 启动 TurtleBot3 仿真环境</span>
ros2 launch webots_ros2_turtlebot robot_launch.py
<span class="token comment"># 再开一个窗口，控制 TurtleBot3 在仿真屋子里活动</span>
ros2 run teleop_twist_keyboard teleop_twist_keyboard
</code></pre> 
<p><img src="https://images2.imgbox.com/5f/0e/sEhi7cOW_o.png" alt="在这里插入图片描述" width="600" height="350"><br> 测试 Tesla Model3（怎么让车动起来，我没有详细研究，图也就不放了）：</p> 
<pre><code class="prism language-bash">ros2 launch webots_ros2_tesla robot_launch.py
</code></pre> 
<h3><a id="23__webots_demo_46"></a>2.3 自编写 webots_demo</h3> 
<p>（1）创建 webots_demo 软件包以及相关文件</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> ~/colcon_ws/src
ros2 pkg create --build-type ament_python <span class="token parameter variable">--license</span> Apache-2.0 webots_demo <span class="token parameter variable">--dependencies</span> rclpy geometry_msgs webots_ros2_driver
<span class="token builtin class-name">cd</span> webots_demo 
<span class="token function">mkdir</span> launch worlds
<span class="token function">touch</span> launch/mbot_launch.py
<span class="token function">touch</span> resource/mbot.urdf
<span class="token function">touch</span> webots_demo/mbot_driver.py webots_demo/obstacle_avoider.py
</code></pre> 
<p>（2）在 worlds 目录中添加 <a href="https://github.com/Jieshoudaxue/ros2_code/blob/main/webots_demo/worlds/my_world.wbt">my_world.wbt</a>，这个文件是 webots 的建模文件，里面包含虚拟仿真环境和一个差速轮式机器人。本文暂时不深究 webots 建模的细节，读者可以参考 <a href="https://cyberbotics.com/doc/guide/tutorials" rel="nofollow">webots tutorials</a> 。<br> （3）编写 mbot_driver.py：这是差速轮式机器人车轮电机控制程序，内部有注释帮助理解</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> rclpy
<span class="token keyword">from</span> geometry_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> Twist

HALF_DISTANCE_BETWEEN_WHEELS <span class="token operator">=</span> <span class="token number">0.045</span>
WHEEL_RADIUS <span class="token operator">=</span> <span class="token number">0.025</span>

<span class="token comment"># MbotDriver 是机器人的控制器程序，他创建了一个 ros2 节点 mbot_driver，</span>
<span class="token comment"># 订阅 cmd_vel 话题，接收 Twist 消息，然后根据 Twist 消息的线速度和角速度控制机器人的左右轮速度，从而实现机器人的运动控制。</span>
<span class="token keyword">class</span> <span class="token class-name">MbotDriver</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> webots_node<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取 webots 里的 robot 对象，在本样例就是 my_world.wbt 中的 mbot_car</span>
        self<span class="token punctuation">.</span>_robot <span class="token operator">=</span> webots_node<span class="token punctuation">.</span>robot

        <span class="token comment"># 获取左右轮的电机对象，并设置电机的目标位置为极大（一直旋转）和速度为 0</span>
        self<span class="token punctuation">.</span>_left_motor <span class="token operator">=</span> self<span class="token punctuation">.</span>_robot<span class="token punctuation">.</span>getDevice<span class="token punctuation">(</span><span class="token string">'left wheel motor'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_right_motor <span class="token operator">=</span> self<span class="token punctuation">.</span>_robot<span class="token punctuation">.</span>getDevice<span class="token punctuation">(</span><span class="token string">'right wheel motor'</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_left_motor<span class="token punctuation">.</span>setPosition<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_left_motor<span class="token punctuation">.</span>setVelocity<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_right_motor<span class="token punctuation">.</span>setPosition<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_right_motor<span class="token punctuation">.</span>setVelocity<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>_target_twist <span class="token operator">=</span> Twist<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 创建一个 ros2 节点 mbot_driver，订阅 cmd_vel 话题，用来驱动 mbot_car</span>
        <span class="token comment"># 接收到的 Twist 消息存入 self._target_twist 中，等待 step 函数处理</span>
        rclpy<span class="token punctuation">.</span>init<span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_node <span class="token operator">=</span> rclpy<span class="token punctuation">.</span>create_node<span class="token punctuation">(</span><span class="token string">'mbot_driver'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_node<span class="token punctuation">.</span>create_subscription<span class="token punctuation">(</span>Twist<span class="token punctuation">,</span> <span class="token string">'cmd_vel'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_cmd_vel_callback<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_cmd_vel_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> twist<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_target_twist <span class="token operator">=</span> twist

    <span class="token comment"># step 由 webots_ros2_driver.webots_controller.WebotsController 调用，称之为 simulation step</span>
    <span class="token comment"># 这里可以理解为是机器人控制器的主循环函数，周期调用</span>
    <span class="token keyword">def</span> <span class="token function">step</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 使用 spin_once 来处理 mbot_driver 的一次事件，这里是一次 cmd_vel 订阅</span>
        <span class="token comment"># 如果没有这个函数，_cmd_vel_callback 是不会被执行的</span>
        <span class="token comment"># 如果事件没来，会立即返回，不会阻塞，确保实时性</span>
        rclpy<span class="token punctuation">.</span>spin_once<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_node<span class="token punctuation">,</span> timeout_sec<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token comment"># 这里讲解了 Twist 理解 和 右手定则：https://blog.csdn.net/cy1641395022/article/details/131236155</span>
        <span class="token comment"># 获取机器人的前进速度和旋转速度，根据右手定则：</span>
        <span class="token comment"># 如果机器人向左转（顺时针），angular_speed为负；</span>
        <span class="token comment"># 如果机器人向右转（逆时针），angular_speed为正；</span>
        forward_speed <span class="token operator">=</span> self<span class="token punctuation">.</span>_target_twist<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>x
        angular_speed <span class="token operator">=</span> self<span class="token punctuation">.</span>_target_twist<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>z

        <span class="token comment"># 机器人的前进和旋转速度需要转换为左右轮转速，由于机器人是差速驱动，所以需要根据机器人的轮距和轮径来计算左右轮转速</span>
        <span class="token comment"># HALF_DISTANCE_BETWEEN_WHEELS 是机器人的轮距的一半，乘以 angular_speed 就是机器人内外轮线速度的补偿值</span>
        <span class="token comment"># 得到内外轮线速度后，再除以 WHEEL_RADIUS 就是内外轮的转速（角速度乘以旋转半径为线速度）</span>
        <span class="token comment"># 简单的三个场景，可以帮助理解这个公式：</span>
        <span class="token comment"># 第一，控制机器人直线前进（forward_speed 为正，angular_speed 为0），左右轮转速必须相同，且转向相同</span>
        <span class="token comment"># 第二，控制机器人原地顺时针旋转（forward_speed 为0，angular_speed 为负），左右轮转速必须相同，且转向相反</span>
        <span class="token comment"># 第三，控制机器人原地逆时针旋转（forward_speed 为0，angular_speed 为正），左右轮转速必须相同，且转向相反</span>
        command_motor_left <span class="token operator">=</span> <span class="token punctuation">(</span>forward_speed <span class="token operator">-</span> angular_speed <span class="token operator">*</span> HALF_DISTANCE_BETWEEN_WHEELS<span class="token punctuation">)</span> <span class="token operator">/</span> WHEEL_RADIUS
        command_motor_right <span class="token operator">=</span> <span class="token punctuation">(</span>forward_speed <span class="token operator">+</span> angular_speed <span class="token operator">*</span> HALF_DISTANCE_BETWEEN_WHEELS<span class="token punctuation">)</span> <span class="token operator">/</span> WHEEL_RADIUS

        <span class="token comment"># 设置左右轮的目标转速</span>
        self<span class="token punctuation">.</span>_left_motor<span class="token punctuation">.</span>setVelocity<span class="token punctuation">(</span>command_motor_left<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_right_motor<span class="token punctuation">.</span>setVelocity<span class="token punctuation">(</span>command_motor_right<span class="token punctuation">)</span>
</code></pre> 
<p>（4）编写 mbot.urdf：这是差速轮式机器人的 URDF 描述文件（Unified Robot Description Format，统一的机器人描述文件格式，使用 xml 格式），为机器人添加了左右距离传感器，并指定了车轮电机控制器。</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" ?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>robot</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>My robot<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>webots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>device</span> <span class="token attr-name">reference</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ds0<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>DistanceSensor<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ros</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>topicName</span><span class="token punctuation">&gt;</span></span>/left_sensor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>topicName</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alwaysOn</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>alwaysOn</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ros</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>device</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>device</span> <span class="token attr-name">reference</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ds1<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>DistanceSensor<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ros</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>topicName</span><span class="token punctuation">&gt;</span></span>/right_sensor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>topicName</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>alwaysOn</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>alwaysOn</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ros</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>device</span><span class="token punctuation">&gt;</span></span>    
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>webots_demo.mbot_driver.MbotDriver<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>webots</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>robot</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>（4）编写 obstacle_avoider.py：这个程序基于左右距离传感器的数据，通过 cmd_vel topic 控制机器人避障。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> rclpy
<span class="token keyword">from</span> rclpy<span class="token punctuation">.</span>node <span class="token keyword">import</span> Node
<span class="token keyword">from</span> sensor_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> Range
<span class="token keyword">from</span> geometry_msgs<span class="token punctuation">.</span>msg <span class="token keyword">import</span> Twist

MAX_RANGE <span class="token operator">=</span> <span class="token number">0.15</span>

<span class="token comment"># ObstacleAvoider 是机器人行动的控制程序，主要是避障，防止机器人撞墙</span>
<span class="token comment"># 他创建了一个 ros2 节点 obstacle_avoider，订阅了两个传感器话题 left_sensor 和 right_sensor，</span>
<span class="token comment"># 接收 Range 消息，然后根据传感器的距离，通过 cmd_vel 发给 mbot_driver 控制机器人运动</span>
<span class="token keyword">class</span> <span class="token class-name">ObstacleAvoider</span><span class="token punctuation">(</span>Node<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token string">'obstacle_avoider'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_publisher <span class="token operator">=</span> self<span class="token punctuation">.</span>create_publisher<span class="token punctuation">(</span>Twist<span class="token punctuation">,</span> <span class="token string">'cmd_vel'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>create_subscription<span class="token punctuation">(</span>Range<span class="token punctuation">,</span> <span class="token string">'left_sensor'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_left_sensor_callback<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>create_subscription<span class="token punctuation">(</span>Range<span class="token punctuation">,</span> <span class="token string">'right_sensor'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>_right_sensor_callback<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_left_sensor_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_left_sensor_value <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token builtin">range</span>

    <span class="token keyword">def</span> <span class="token function">_right_sensor_callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_right_sensor_value <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token builtin">range</span>

        <span class="token comment"># 每次收到一个传感器的数据，就计算一次机器人的运动控制</span>
        command_message <span class="token operator">=</span> Twist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        command_message<span class="token punctuation">.</span>linear<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0.1</span>
        <span class="token comment"># 如果左右传感器的距离有一个小于 0.9 * MAX_RANGE，就让机器人向顺时针向右转，否则默认为0，即直线行驶</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_left_sensor_value <span class="token operator">&lt;</span> <span class="token number">0.9</span> <span class="token operator">*</span> MAX_RANGE <span class="token keyword">or</span> self<span class="token punctuation">.</span>_right_sensor_value <span class="token operator">&lt;</span> <span class="token number">0.9</span> <span class="token operator">*</span> MAX_RANGE<span class="token punctuation">:</span>
            command_message<span class="token punctuation">.</span>angular<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2.0</span>

        self<span class="token punctuation">.</span>_publisher<span class="token punctuation">.</span>publish<span class="token punctuation">(</span>command_message<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    rclpy<span class="token punctuation">.</span>init<span class="token punctuation">(</span>args<span class="token operator">=</span>args<span class="token punctuation">)</span>
    avoider <span class="token operator">=</span> ObstacleAvoider<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rclpy<span class="token punctuation">.</span>spin<span class="token punctuation">(</span>avoider<span class="token punctuation">)</span>
    avoider<span class="token punctuation">.</span>destroy_node<span class="token punctuation">(</span><span class="token punctuation">)</span>
    rclpy<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>（5）编写 mbot_launch.py ：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> launch
<span class="token keyword">from</span> launch_ros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> Node
<span class="token keyword">from</span> launch <span class="token keyword">import</span> LaunchDescription
<span class="token keyword">from</span> ament_index_python<span class="token punctuation">.</span>packages <span class="token keyword">import</span> get_package_share_directory
<span class="token keyword">from</span> webots_ros2_driver<span class="token punctuation">.</span>webots_launcher <span class="token keyword">import</span> WebotsLauncher
<span class="token keyword">from</span> webots_ros2_driver<span class="token punctuation">.</span>webots_controller <span class="token keyword">import</span> WebotsController

<span class="token keyword">def</span> <span class="token function">generate_launch_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    package_dir <span class="token operator">=</span> get_package_share_directory<span class="token punctuation">(</span><span class="token string">'webots_demo'</span><span class="token punctuation">)</span>
    mbot_description_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>package_dir<span class="token punctuation">,</span> <span class="token string">'resource'</span><span class="token punctuation">,</span> <span class="token string">'mbot.urdf'</span><span class="token punctuation">)</span>

    <span class="token comment"># 使用 webots_ros2_driver.webots_launcher.WebotsLauncher 来启动 webots，加载 my_world.wbt</span>
    <span class="token comment"># my_world.wbt 内有一个 mbot_car 机器人</span>
    <span class="token comment"># 补充：如何制作 my_world.wbt，可以参考：</span>
    <span class="token comment"># https://cyberbotics.com/doc/guide/tutorials</span>
    webots_world <span class="token operator">=</span> WebotsLauncher<span class="token punctuation">(</span>
        world<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>package_dir<span class="token punctuation">,</span> <span class="token string">'worlds'</span><span class="token punctuation">,</span> <span class="token string">'my_world.wbt'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 使用 webots_ros2_driver.webots_controller.WebotsController 来启动 mbot_car 机器人的控制器</span>
    <span class="token comment"># 参数 robot_description 为 mbot.urdf，里面指定了 webots_demo.mbot_driver.MbotDriver 为机器人的控制器</span>
    mbot_controller <span class="token operator">=</span> WebotsController<span class="token punctuation">(</span>
        robot_name<span class="token operator">=</span><span class="token string">'mbot_car'</span><span class="token punctuation">,</span>
        parameters<span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'robot_description'</span><span class="token punctuation">:</span> mbot_description_path<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token punctuation">)</span>

    <span class="token comment"># 额外启动一个避障控制器，订阅 mbot_car 发来的左右距离传感器数据，通过 cmd_vel，控制 mbot_car 机器人的运动</span>
    obstacle_avoider <span class="token operator">=</span> Node<span class="token punctuation">(</span>
        package<span class="token operator">=</span><span class="token string">'webots_demo'</span><span class="token punctuation">,</span>
        executable<span class="token operator">=</span><span class="token string">'obstacle_avoider'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> LaunchDescription<span class="token punctuation">(</span><span class="token punctuation">[</span>
        webots_world<span class="token punctuation">,</span>
        mbot_controller<span class="token punctuation">,</span>
        obstacle_avoider<span class="token punctuation">,</span>
        launch<span class="token punctuation">.</span>actions<span class="token punctuation">.</span>RegisterEventHandler<span class="token punctuation">(</span>
            event_handler<span class="token operator">=</span>launch<span class="token punctuation">.</span>event_handlers<span class="token punctuation">.</span>OnProcessExit<span class="token punctuation">(</span>
                target_action<span class="token operator">=</span>webots_world<span class="token punctuation">,</span>
                on_exit<span class="token operator">=</span><span class="token punctuation">[</span>launch<span class="token punctuation">.</span>actions<span class="token punctuation">.</span>EmitEvent<span class="token punctuation">(</span>event<span class="token operator">=</span>launch<span class="token punctuation">.</span>events<span class="token punctuation">.</span>Shutdown<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>（6）修改 setup.py</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> glob <span class="token keyword">import</span> glob
<span class="token keyword">from</span> setuptools <span class="token keyword">import</span> find_packages<span class="token punctuation">,</span> setup

package_name <span class="token operator">=</span> <span class="token string">'webots_demo'</span>

setup<span class="token punctuation">(</span>
    name<span class="token operator">=</span>package_name<span class="token punctuation">,</span>
    version<span class="token operator">=</span><span class="token string">'0.0.0'</span><span class="token punctuation">,</span>
    packages<span class="token operator">=</span>find_packages<span class="token punctuation">(</span>exclude<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    data_files<span class="token operator">=</span><span class="token punctuation">[</span>
        <span class="token punctuation">(</span><span class="token string">'share/ament_index/resource_index/packages'</span><span class="token punctuation">,</span>
            <span class="token punctuation">[</span><span class="token string">'resource/'</span> <span class="token operator">+</span> package_name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token string">'share/'</span> <span class="token operator">+</span> package_name<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'package.xml'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'share'</span><span class="token punctuation">,</span> package_name<span class="token punctuation">,</span> <span class="token string">'launch'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> glob<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'launch'</span><span class="token punctuation">,</span> <span class="token string">'*_launch.py'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'share'</span><span class="token punctuation">,</span> package_name<span class="token punctuation">,</span> <span class="token string">'worlds'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> glob<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'worlds'</span><span class="token punctuation">,</span> <span class="token string">'*.wbt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'share'</span><span class="token punctuation">,</span> package_name<span class="token punctuation">,</span> <span class="token string">'resource'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> glob<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'resource'</span><span class="token punctuation">,</span> <span class="token string">'*.urdf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    install_requires<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'setuptools'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    zip_safe<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    maintainer<span class="token operator">=</span><span class="token string">'ycao'</span><span class="token punctuation">,</span>
    maintainer_email<span class="token operator">=</span><span class="token string">'1641395022@qq.com'</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">'TODO: Package description'</span><span class="token punctuation">,</span>
    license<span class="token operator">=</span><span class="token string">'Apache-2.0'</span><span class="token punctuation">,</span>
    tests_require<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'pytest'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    entry_points<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">'console_scripts'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">'mbot_driver = webots_demo.mbot_driver:main'</span><span class="token punctuation">,</span>
            <span class="token string">'obstacle_avoider = webots_demo.obstacle_avoider:main'</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>（7）编译并运行</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> ~/colcon_ws/src
colcon build --packages-select webots_demo
<span class="token builtin class-name">source</span> install/local_setup.bash
ros2 launch webots_demo mbot_launch.py
</code></pre> 
<p><img src="https://images2.imgbox.com/e8/70/ffChKVG0_o.gif" alt="在这里插入图片描述" width="600" height="350"></p> 
<h2><a id="3__280"></a>3 总结</h2> 
<p>本文主要通过一个差速轮式机器人仿真样例，为大家引入 webots ，但没有深入探究 webots 的建模细节。尽快如此，读者可以在本文的基础上，利用文中提到的资料，对 webots 进行深入的学习和研究。<br> 本文的代码托管在本人的 github 上：<a href="https://github.com/Jieshoudaxue/ros2_code/tree/main/webots_demo">webots_demo</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/873ffe689f3cbf5634992ce495526c0d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java重点原理精炼(免费版)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/697fde1701ef3ea36852a889a8b83143/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深度学习环境完整安装(Python&#43;Pycharm&#43;Pytorch cpu版)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>