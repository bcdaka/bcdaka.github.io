<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Spring Boot 3】的安全防线：整合 【Spring Security 6】 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/541aab8271a7d78ccabb898a30348534/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Spring Boot 3】的安全防线：整合 【Spring Security 6】">
  <meta property="og:description" content="简介 Spring Security 是 Spring 家族中的一个安全管理框架。相比与另外一个安全框架Shiro，它提供了更丰富的功能，社区资源也比Shiro丰富。
一般来说中大型的项目都是使用SpringSecurity 来做安全框架。小项目有Shiro的比较多，因为相比与SpringSecurity，Shiro的上手更加的简单。
一般Web应用的需要进行认证和授权。
认证：验证当前访问系统的是不是本系统的用户，并且要确认具体是哪个用户
授权：经过认证后判断当前用户是否有权限进行某个操作
而认证和授权也是SpringSecurity作为安全框架的核心功能。
1.快速入门 1.1.引入依赖 &lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-security --&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt; &lt;version&gt;3.1.8&lt;/version&gt; &lt;/dependency&gt; 如果是gradle则使用
// https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-security implementation group: &#39;org.springframework.boot&#39;, name: &#39;spring-boot-starter-security&#39;, version: &#39;3.1.8&#39; 引入SpringSecurity依赖后，再次输入地址，都会统一调转到一个登录界面，登录用户名是user,密码是在项目启动时，输出在控制台
2.SpringBoot整合Redis 我是在Windos环境下安装Redis，这里在Windows下启动Redis 需要进入到安装目录库
输入 redis-server.exe redis.windows.conf
2.1.引入依赖 &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt; &lt;version&gt;3.1.8&lt;/version&gt; &lt;/dependency&gt; implementation group: &#39;org.springframework.boot&#39;, name: &#39;spring-boot-starter-data-redis&#39;, version: &#39;3.1.8&#39; 2.2.配置Redis 在配置文件中对redis进行配置
# redis相关配置 spring: data: redis: port: 6379 host: 127.0.0.1 2.3.使用Redis Template 2.3.1.将Redis Template注入到Spring容器中 主要是为了 统一管理">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-02T19:48:05+08:00">
    <meta property="article:modified_time" content="2024-03-02T19:48:05+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Spring Boot 3】的安全防线：整合 【Spring Security 6】</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>简介</h2> 
<p>Spring Security 是 Spring 家族中的一个安全管理框架。相比与另外一个安全框架Shiro，它提供了更丰富的功能，社区资源也比Shiro丰富。</p> 
<p>一般来说中大型的项目都是使用SpringSecurity 来做安全框架。小项目有Shiro的比较多，因为相比与SpringSecurity，Shiro的上手更加的简单。</p> 
<p>一般Web应用的需要进行认证和授权。</p> 
<p>认证：验证当前访问系统的是不是本系统的用户，并且要确认具体是哪个用户</p> 
<p>授权：经过认证后判断当前用户是否有权限进行某个操作</p> 
<p>而认证和授权也是SpringSecurity作为安全框架的核心功能。</p> 
<h2><a id="1_18"></a>1.快速入门</h2> 
<h3><a id="11_20"></a>1.1.引入依赖</h3> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-security --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>如果是gradle则使用</p> 
<pre><code class="prism language-shell">// https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-security
implementation group: <span class="token string">'org.springframework.boot'</span>, name: <span class="token string">'spring-boot-starter-security'</span>, version: <span class="token string">'3.1.8'</span>

</code></pre> 
<p><strong>引入SpringSecurity依赖后，再次输入地址，都会统一调转到一个登录界面，登录用户名是user,密码是在项目启动时，输出在控制台</strong></p> 
<p><img src="https://images2.imgbox.com/0f/00/UJLWGVJg_o.png" alt="image-20240217123503799"></p> 
<p><img src="https://images2.imgbox.com/ac/a9/Jaq43u8a_o.png" alt="image-20240217123523370"></p> 
<p><img src="https://images2.imgbox.com/60/c8/QLcEGLVC_o.png" alt="image-20240217123722190"></p> 
<h2><a id="2SpringBootRedis_53"></a>2.SpringBoot整合Redis</h2> 
<blockquote> 
 <p>我是在Windos环境下安装Redis，这里在Windows下启动Redis 需要<code>进入到安装目录库</code></p> 
 <p>输入 <strong>redis-server.exe redis.windows.conf</strong></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/e6/74/BYzqxe1U_o.png" alt="image-20240217124753947"></p> 
<h4><a id="21_65"></a>2.1.引入依赖</h4> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<pre><code class="prism language-shell">implementation group: <span class="token string">'org.springframework.boot'</span>, name: <span class="token string">'spring-boot-starter-data-redis'</span>, version: <span class="token string">'3.1.8'</span>
</code></pre> 
<h4><a id="22Redis_83"></a>2.2.配置Redis</h4> 
<blockquote> 
 <p>在配置文件中对redis进行配置</p> 
</blockquote> 
<pre><code class="prism language-yaml"><span class="token comment"># redis相关配置 </span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
    <span class="token key atrule">redis</span><span class="token punctuation">:</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
</code></pre> 
<h4><a id="23Redis_Template_100"></a>2.3.使用Redis Template</h4> 
<h6><a id="231Redis_TemplateSpring_102"></a>2.3.1.将Redis Template注入到Spring容器中</h6> 
<blockquote> 
 <p>主要是为了 统一管理</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisTemplateConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"sysMyRedisTemplate"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> redisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectMapper</span> om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 持久化改动.设置可见性,</span>
        om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span><span class="token constant">ALL</span><span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 持久化改动.非final类型的对象，把对象类型也序列化进去，以便反序列化推测正确的类型</span>
        om<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span><span class="token constant">NON_FINAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 持久化改动.null字段不显示</span>
        om<span class="token punctuation">.</span><span class="token function">setSerializationInclusion</span><span class="token punctuation">(</span><span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span><span class="token punctuation">.</span><span class="token constant">NON_NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 持久化改动.POJO无public属性或方法时不报错</span>
        om<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">SerializationFeature</span><span class="token punctuation">.</span><span class="token constant">FAIL_ON_EMPTY_BEANS</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 持久化改动.setObjectMapper方法移除.使用构造方法传入ObjectMapper</span>
        <span class="token class-name">GenericJackson2JsonRedisSerializer</span> jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span>om<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span>redisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span>redisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="232RedisTemplate_139"></a>2.3.2.RedisTemplate工具类</h6> 
<blockquote> 
 <p>为了方便使用，可以封装一下工具类进行使用</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">BoundSetOperations</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">HashOperations</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">ValueOperations</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisCache</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 缓存基本的对象，Integer、String、实体类等
     *
     * @param key   缓存的键值
     * @param value 缓存的值
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 缓存基本的对象，Integer、String、实体类等
     *
     * @param key      缓存的键值
     * @param value    缓存的值
     * @param timeout  时间
     * @param timeUnit 时间颗粒度
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">T</span> value<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> timeout<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TimeUnit</span> timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置有效时间
     *
     * @param key     Redis键
     * @param timeout 超时时间
     * @return true=设置成功；false=设置失败
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">expire</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 设置有效时间
     *
     * @param key     Redis键
     * @param timeout 超时时间
     * @param unit    时间单位
     * @return true=设置成功；false=设置失败
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">expire</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获得缓存的基本对象。
     *
     * @param key 缓存键值
     * @return 缓存键值对应的数据
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getCacheObject</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> operation <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> operation<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除单个对象
     *
     * @param key
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">deleteObject</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除集合对象
     *
     * @param collection 多个对象
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">deleteObject</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Collection</span> collection<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 缓存List数据
     *
     * @param key      缓存的键值
     * @param dataList 待缓存的List数据
     * @return 缓存的对象
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">long</span> <span class="token function">setCacheList</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> dataList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Long</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPushAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dataList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> count <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获得缓存的list对象
     *
     * @param key 缓存的键值
     * @return 缓存键值对应的数据
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCacheList</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 缓存Set
     *
     * @param key     缓存键值
     * @param dataSet 缓存的数据
     * @return 缓存数据的对象
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">BoundSetOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">setCacheSet</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> dataSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BoundSetOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> setOperation <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundSetOps</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> it <span class="token operator">=</span> dataSet<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            setOperation<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> setOperation<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获得缓存的set
     *
     * @param key
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCacheSet</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 缓存Map
     *
     * @param key
     * @param dataMap
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">setCacheMap</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> dataMap<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataMap <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dataMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获得缓存的Map
     *
     * @param key
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getCacheMap</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 往Hash中存入数据
     *
     * @param key   Redis键
     * @param hKey  Hash键
     * @param value 值
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">setCacheMapValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> hKey<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hKey<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取Hash中的数据
     *
     * @param key  Redis键
     * @param hKey Hash键
     * @return Hash中的对象
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">getCacheMapValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> hKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">HashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> opsForHash <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> opsForHash<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">incrementCacheMapValue</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> hKey<span class="token punctuation">,</span> <span class="token keyword">int</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hKey<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 删除Hash中的数据
     *
     * @param key
     * @param hkey
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delCacheMapValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> hkey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">HashOperations</span> hashOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hashOperations<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取多个Hash中的数据
     *
     * @param key   Redis键
     * @param hKeys Hash键集合
     * @return Hash对象集合
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMultiCacheMapValue</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> hKeys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiGet</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> hKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获得缓存的基本对象列表
     *
     * @param pattern 字符串前缀
     * @return 对象列表
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> pattern<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h6><a id="233_373"></a>2.3.3.测试</h6> 
<blockquote> 
 <p>测试是否能正常使用</p> 
</blockquote> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/redis"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">redis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		redisCache<span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> redisCache<span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/35/f2/QboXrWBs_o.png" alt="image-20240217132211204"></p> 
<h2><a id="3SpringBootJJWT_395"></a>3.SpringBoot整合JJWT</h2> 
<h3><a id="31_397"></a>3.1.引入依赖</h3> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/io.jsonwebtoken/jjwt --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jjwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.12.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<pre><code class="prism language-shell">implementation group: <span class="token string">'io.jsonwebtoken'</span>, name: <span class="token string">'jjwt'</span>, version: <span class="token string">'0.12.5'</span>

</code></pre> 
<h3><a id="32JJW_418"></a>3.2.JJW工具类</h3> 
<blockquote> 
 <p>为了方便使用，我们将其封装成一个工具类<br> 由于使用的版本是新版本的JDK 以及 JJWT所以网 这里的工具类 写法会有些出入</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token comment">/**
 * JWT Token工具类，用于生成和解析JWT Token
 *
 * @Author: Tiam
 * @Date: 2023/10/23 16:38
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenUtil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 过期时间(单位:秒)
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">ACCESS_EXPIRE</span> <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 加密算法
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">SecureDigestAlgorithm</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecretKey</span><span class="token punctuation">,</span> <span class="token class-name">SecretKey</span><span class="token punctuation">&gt;</span></span> <span class="token constant">ALGORITHM</span> <span class="token operator">=</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token constant">SIG</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 私钥 / 生成签名的时候使用的秘钥secret，一般可以从本地配置文件中读取。
     * 切记：秘钥不能外露，在任何场景都不应该流露出去。
     * 应该大于等于 256位(长度32及以上的字符串)，并且是随机的字符串
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">SECRET</span> <span class="token operator">=</span> <span class="token string">"secrasdddddddddddddddddddddddddddddddddwqeqeqwewqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqetKey"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 秘钥实例
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">SecretKey</span> <span class="token constant">KEY</span> <span class="token operator">=</span> <span class="token class-name">Keys</span><span class="token punctuation">.</span><span class="token function">hmacShaKeyFor</span><span class="token punctuation">(</span><span class="token constant">SECRET</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * jwt签发者
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">JWT_ISS</span> <span class="token operator">=</span> <span class="token string">"Tiam"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * jwt主题
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">SUBJECT</span> <span class="token operator">=</span> <span class="token string">"Peripherals"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 生成访问令牌
     *
     * @param username 用户名
     * @return 访问令牌
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">genAccessToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 生成令牌ID</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置过期时间</span>
        <span class="token class-name">Date</span> expireDate <span class="token operator">=</span> <span class="token class-name">Date</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span><span class="token constant">ACCESS_EXPIRE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 设置头部信息</span>
                <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"typ"</span><span class="token punctuation">,</span> <span class="token string">"JWT"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"alg"</span><span class="token punctuation">,</span> <span class="token string">"HS256"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 设置自定义负载信息</span>
                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span> <span class="token comment">// 令牌ID</span>
                <span class="token punctuation">.</span><span class="token function">expiration</span><span class="token punctuation">(</span>expireDate<span class="token punctuation">)</span> <span class="token comment">// 过期日期</span>
                <span class="token punctuation">.</span><span class="token function">issuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 签发时间</span>
                <span class="token punctuation">.</span><span class="token function">subject</span><span class="token punctuation">(</span><span class="token constant">SUBJECT</span><span class="token punctuation">)</span> <span class="token comment">// 主题</span>
                <span class="token punctuation">.</span><span class="token function">issuer</span><span class="token punctuation">(</span><span class="token constant">JWT_ISS</span><span class="token punctuation">)</span> <span class="token comment">// 签发者</span>
                <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token constant">KEY</span><span class="token punctuation">,</span> <span class="token constant">ALGORITHM</span><span class="token punctuation">)</span> <span class="token comment">// 签名</span>
                <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token comment">/**
     * 获取payload中的用户信息
     *
     * @param token JWT Token
     * @return 用户信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUserFromToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> user <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token function">parseClaims</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>claims <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> claims<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取JWT令牌的过期时间
     *
     * @param token JWT令牌
     * @return 过期时间的毫秒级时间戳
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getExpirationTime</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token function">parseClaims</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>claims <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> claims<span class="token punctuation">.</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 解析token
     *
     * @param token token
     * @return Jws&lt;Claims&gt;
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Jws</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Claims</span><span class="token punctuation">&gt;</span></span> <span class="token function">parseClaim</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">verifyWith</span><span class="token punctuation">(</span><span class="token constant">KEY</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">parseSignedClaims</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 解析token的头部信息
     *
     * @param token token
     * @return token的头部信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">JwsHeader</span> <span class="token function">parseHeader</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">parseClaim</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 解析token的载荷信息
     *
     * @param token token
     * @return token的载荷信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Claims</span> <span class="token function">parsePayload</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">parseClaim</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 解析JWT Token中的Claims
     *
     * @param token JWT Token
     * @return Claims
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Claims</span> <span class="token function">parseClaims</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token constant">KEY</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="33_580"></a>3.3.测试</h3> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/jjwt"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">jjwt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> tokenByKey <span class="token operator">=</span> <span class="token class-name">TokenUtil</span><span class="token punctuation">.</span><span class="token function">genAccessToken</span><span class="token punctuation">(</span><span class="token string">"hrfan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"encoding"</span><span class="token punctuation">,</span> tokenByKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> map<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6d/08/oweXRvFA_o.png" alt="image-20240217141907501"></p> 
<h2><a id="4_600"></a>4.实战</h2> 
<p><strong>背景</strong></p> 
<blockquote> 
 <p>在企业开发中，一个安全的登录授权系统是至关重要的，它不仅可以保护用户的隐私信息，还能够确保只有经过授权的用户才能够访问特定的资源和功能。这样的系统不仅仅是为了满足用户的安全需求，也是为了保护企业的敏感数据和资源免受未经授权的访问和恶意攻击。</p> 
</blockquote> 
<p>首先，一个安全的登录授权系统必须具备可靠的身份验证机制。用户需要能够通过输入凭据（通常是用户名和密码）来验证其身份。这个过程需要保证用户的密码被安全地存储，并且在传输过程中使用加密技术保障用户凭据的安全性。</p> 
<p>其次，授权系统需要根据用户的身份和角色来管理用户对资源和功能的访问权限。不同的用户可能具有不同的角色和权限，例如普通用户、管理员、审计员等。系统需要根据用户的角色和权限来限制他们对资源的访问，以确保敏感数据不会被未经授权的用户获取。</p> 
<p><strong>下面使用SpringSecurity来实现一个简易的登录认证</strong></p> 
<p><strong>用户身份验证</strong></p> 
<ol><li><strong>登录页面</strong>: 我们需要一个登录页面，用户可以在该页面输入他们的凭据以进行身份验证。登录页面应该友好且易于理解。</li><li><strong>身份验证</strong>: 用户的用户名和密码应该被验证，只有在验证通过后才能进入系统。密码应该以安全的方式存储，例如使用哈希算法加密存储。</li><li><strong>认证失败处理</strong>: 如果用户提供的凭据无效，则系统应该向用户提供相应的错误消息，并允许他们再次尝试登录。</li></ol> 
<p><strong>访问控制</strong></p> 
<ol><li><strong>受保护资源</strong>: 我们的系统将有一些受保护的资源和功能，例如管理课程、学生信息等。只有经过身份验证的用户才能访问这些资源。</li><li><strong>角色和权限</strong>: 不同类型的用户应该有不同的角色和权限。例如，管理员可能具有管理课程和学生的权限，而普通用户可能只能访问课程内容。</li><li><strong>未经授权的访问</strong>: 如果用户尝试访问他们没有权限的资源，则系统应该拒绝访问，并向用户显示适当的错误消息。</li></ol> 
<p><strong>安全性</strong></p> 
<ol><li><strong>防范攻击</strong>: 我们的系统应该能够防范常见的安全攻击，如跨站脚本攻击、SQL注入等。</li><li><strong>密码安全</strong>: 用户的密码不应以明文形式存储在数据库中，而应该使用安全的加密算法进行存储。</li></ol> 
<h3><a id="41_637"></a>4.1.创建数据库表</h3> 
<h4><a id="411_639"></a>4.1.1.创建用户表</h4> 
<blockquote> 
 <p>Spring Security要求实现UserDetails接口是为了统一表示用户身份和权限信息，以便于在认证和授权过程中使用。UserDetails提供了标准化的用户信息模型，包括用户名、密码、权限等，使得Spring Security能够与不同的用户信息源集成，同时提供灵活性和可定制性。</p> 
</blockquote> 
<p><strong>RBCA模型介绍</strong></p> 
<p><code>RBAC（Role-Based Access Control）模型是一种访问控制模型</code>，它基于角色来管理对资源的访问权限。在RBAC模型中，用户被分配到不同的角色，而每个角色具有特定的权限。这种模型使得权限管理更加灵活和可扩展，同时降低了管理的复杂性。</p> 
<ul><li>user表代表系统中的用户。</li><li>role表代表系统中的角色。</li><li>permission表代表系统中的权限。</li><li>user_role表用于关联用户与角色。</li><li>role_permission表用于关联角色与权限。</li></ul> 
<p><img src="https://images2.imgbox.com/f3/21/vDW2vHua_o.png" alt="image-20240217233212640"></p> 
<pre><code class="prism language-postgresql">CREATE TABLE "hr_manager"."t_sys_my_user" (
	"sid" VARCHAR ( 50 ) COLLATE "pg_catalog"."default" NOT NULL,
	"user_no" VARCHAR ( 50 ) COLLATE "pg_catalog"."default",
	"user_name" VARCHAR ( 50 ) COLLATE "pg_catalog"."default",
	"password" VARCHAR ( 100 ) COLLATE "pg_catalog"."default",
	"nick_name" VARCHAR ( 100 ) COLLATE "pg_catalog"."default",
	"phone_number" VARCHAR ( 50 ) COLLATE "pg_catalog"."default",
	"email" VARCHAR ( 50 ) COLLATE "pg_catalog"."default",
	"department_id" VARCHAR ( 50 ) COLLATE "pg_catalog"."default",
	"department_name" VARCHAR ( 100 ) COLLATE "pg_catalog"."default",
	"is_admin" VARCHAR ( 1 ) COLLATE "pg_catalog"."default",
	"sex" VARCHAR ( 1 ) COLLATE "pg_catalog"."default",
	"post_id" VARCHAR ( 50 ) COLLATE "pg_catalog"."default",
	"post_name" VARCHAR ( 100 ) COLLATE "pg_catalog"."default",
	"is_account_non_expired" bool,
	"is_account_non_locked" bool,
	"is_credentials_non_expired" bool,
	"is_enabled" bool,
	"insert_user" VARCHAR ( 50 ) COLLATE "pg_catalog"."default",
	"insert_time" DATE,
	"update_user" VARCHAR ( 50 ) COLLATE "pg_catalog"."default",
	"update_time" DATE,
	"license_code" VARCHAR ( 20 ) COLLATE "pg_catalog"."default",
	CONSTRAINT "t_sys_my_user_pkey" PRIMARY KEY ( "sid" ) 
);
ALTER TABLE "hr_manager"."t_sys_my_user" OWNER TO "postgres";
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."sid" IS '主键SID';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."user_no" IS '用户登录账号';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."user_name" IS '用户名称';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."password" IS '用户密码';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."nick_name" IS '用户昵称';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."phone_number" IS '手机号码';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."email" IS '邮箱';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."department_id" IS '部门ID';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."department_name" IS '部门名称';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."is_admin" IS '是否为管理员 0 否 1 是';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."sex" IS '性别 0 男 1 女';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."post_id" IS '岗位ID';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."post_name" IS '岗位名称';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."is_account_non_expired" IS '账户是否过期';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."is_account_non_locked" IS '账户是否被锁定';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."is_credentials_non_expired" IS '密码是否过期';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."is_enabled" IS '账户是否可用';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."insert_user" IS '创建人';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."insert_time" IS '创建时间';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."update_user" IS '更新人';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."update_time" IS '更新时间';
COMMENT ON COLUMN "hr_manager"."t_sys_my_user"."license_code" IS '许可标识';
</code></pre> 
<h4><a id="412_724"></a>4.1.2.创建权限表</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span> <span class="token punctuation">(</span>
	<span class="token string">"sid"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token string">"parent_id"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"parent_name"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"permission_name"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"permission_code"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"router_path"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"router_name"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"auth_url"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"order_no"</span> int4<span class="token punctuation">,</span>
	<span class="token string">"type"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"icon"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"remark"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"insert_user"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"insert_time"</span> <span class="token keyword">DATE</span><span class="token punctuation">,</span>
	<span class="token string">"update_user"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"update_time"</span> <span class="token keyword">DATE</span><span class="token punctuation">,</span>
	<span class="token string">"license_code"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">20</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token keyword">CONSTRAINT</span> <span class="token string">"t_sys_my_permission_pkey"</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token string">"sid"</span> <span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span> OWNER <span class="token keyword">TO</span> <span class="token string">"postgres"</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"sid"</span> <span class="token operator">IS</span> <span class="token string">'主键SID'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"parent_id"</span> <span class="token operator">IS</span> <span class="token string">'父节点ID'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"parent_name"</span> <span class="token operator">IS</span> <span class="token string">'父节点名称'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"permission_name"</span> <span class="token operator">IS</span> <span class="token string">'权限名称'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"permission_code"</span> <span class="token operator">IS</span> <span class="token string">'授权标识符'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"router_path"</span> <span class="token operator">IS</span> <span class="token string">'路由地址'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"router_name"</span> <span class="token operator">IS</span> <span class="token string">'路由名称'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"auth_url"</span> <span class="token operator">IS</span> <span class="token string">'授权路径（对应文件在项目的地址）'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"order_no"</span> <span class="token operator">IS</span> <span class="token string">'序号（用于排序）'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"type"</span> <span class="token operator">IS</span> <span class="token string">'类型 0 目录 1 菜单 2 按钮'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"icon"</span> <span class="token operator">IS</span> <span class="token string">'图标'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"remark"</span> <span class="token operator">IS</span> <span class="token string">'备注'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"insert_user"</span> <span class="token operator">IS</span> <span class="token string">'创建人'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"insert_time"</span> <span class="token operator">IS</span> <span class="token string">'创建时间'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"update_user"</span> <span class="token operator">IS</span> <span class="token string">'更新人'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"update_time"</span> <span class="token operator">IS</span> <span class="token string">'更新时间'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_permission"</span><span class="token punctuation">.</span><span class="token string">"license_code"</span> <span class="token operator">IS</span> <span class="token string">'许可标识'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="413_771"></a>4.1.3.创建角色表</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role"</span> <span class="token punctuation">(</span>
	<span class="token string">"sid"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token string">"role_name"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">100</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"remark"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"insert_user"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"insert_time"</span> <span class="token keyword">DATE</span><span class="token punctuation">,</span>
	<span class="token string">"update_user"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"update_time"</span> <span class="token keyword">DATE</span><span class="token punctuation">,</span>
	<span class="token string">"status"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">255</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token keyword">CONSTRAINT</span> <span class="token string">"t_sys_my_role_pkey"</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token string">"sid"</span> <span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role"</span> OWNER <span class="token keyword">TO</span> <span class="token string">"postgres"</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role"</span><span class="token punctuation">.</span><span class="token string">"sid"</span> <span class="token operator">IS</span> <span class="token string">'主键SID'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role"</span><span class="token punctuation">.</span><span class="token string">"role_name"</span> <span class="token operator">IS</span> <span class="token string">'角色名称'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role"</span><span class="token punctuation">.</span><span class="token string">"remark"</span> <span class="token operator">IS</span> <span class="token string">'备注'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role"</span><span class="token punctuation">.</span><span class="token string">"insert_user"</span> <span class="token operator">IS</span> <span class="token string">'创建人'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role"</span><span class="token punctuation">.</span><span class="token string">"insert_time"</span> <span class="token operator">IS</span> <span class="token string">'创建时间'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role"</span><span class="token punctuation">.</span><span class="token string">"update_user"</span> <span class="token operator">IS</span> <span class="token string">'更新人'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role"</span><span class="token punctuation">.</span><span class="token string">"update_time"</span> <span class="token operator">IS</span> <span class="token string">'更新时间'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role"</span><span class="token punctuation">.</span><span class="token string">"status"</span> <span class="token operator">IS</span> <span class="token string">'是否使用 0 禁用 1 使用'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="414_798"></a>4.1.4.创建用户角色表</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_user_role"</span> <span class="token punctuation">(</span>
	<span class="token string">"sid"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token string">"role_sid"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"user_sid"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"insert_user"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"insert_time"</span> <span class="token keyword">DATE</span><span class="token punctuation">,</span>
	<span class="token keyword">CONSTRAINT</span> <span class="token string">"t_sys_my_user_role_pkey"</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token string">"sid"</span> <span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_user_role"</span> OWNER <span class="token keyword">TO</span> <span class="token string">"postgres"</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_user_role"</span><span class="token punctuation">.</span><span class="token string">"sid"</span> <span class="token operator">IS</span> <span class="token string">'主键SID'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_user_role"</span><span class="token punctuation">.</span><span class="token string">"role_sid"</span> <span class="token operator">IS</span> <span class="token string">'角色SID'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_user_role"</span><span class="token punctuation">.</span><span class="token string">"user_sid"</span> <span class="token operator">IS</span> <span class="token string">'用户SID'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_user_role"</span><span class="token punctuation">.</span><span class="token string">"insert_user"</span> <span class="token operator">IS</span> <span class="token string">'创建人'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_user_role"</span><span class="token punctuation">.</span><span class="token string">"insert_time"</span> <span class="token operator">IS</span> <span class="token string">'创建时间'</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="415_823"></a>4.1.5.创建角色权限表</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role_permission"</span> <span class="token punctuation">(</span>
	<span class="token string">"sid"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
	<span class="token string">"role_sid"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"permission_sid"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"insert_user"</span> <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span> <span class="token number">50</span> <span class="token punctuation">)</span> <span class="token keyword">COLLATE</span> <span class="token string">"pg_catalog"</span><span class="token punctuation">.</span><span class="token string">"default"</span><span class="token punctuation">,</span>
	<span class="token string">"insert_time"</span> <span class="token keyword">DATE</span><span class="token punctuation">,</span>
	<span class="token keyword">CONSTRAINT</span> <span class="token string">"t_sys_my_role_permission_pkey"</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span> <span class="token string">"sid"</span> <span class="token punctuation">)</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role_permission"</span> OWNER <span class="token keyword">TO</span> <span class="token string">"postgres"</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role_permission"</span><span class="token punctuation">.</span><span class="token string">"sid"</span> <span class="token operator">IS</span> <span class="token string">'主键SID'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role_permission"</span><span class="token punctuation">.</span><span class="token string">"role_sid"</span> <span class="token operator">IS</span> <span class="token string">'角色SID'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role_permission"</span><span class="token punctuation">.</span><span class="token string">"permission_sid"</span> <span class="token operator">IS</span> <span class="token string">'权限SID'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role_permission"</span><span class="token punctuation">.</span><span class="token string">"insert_user"</span> <span class="token operator">IS</span> <span class="token string">'创建人'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> <span class="token string">"hr_manager"</span><span class="token punctuation">.</span><span class="token string">"t_sys_my_role_permission"</span><span class="token punctuation">.</span><span class="token string">"insert_time"</span> <span class="token operator">IS</span> <span class="token string">'创建时间'</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="42_848"></a>4.2.创建实体类</h3> 
<h4><a id="421_850"></a>4.2.1.创建用户实体类</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysMyUser</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span><span class="token punctuation">,</span> <span class="token class-name">UserDetails</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@TableId</span>
    <span class="token comment">/**
     * sid
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sid<span class="token punctuation">;</span>

    <span class="token comment">/**
     * user_no
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userNo<span class="token punctuation">;</span>

    <span class="token comment">/**
     * user_name
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>

    <span class="token comment">/**
     * password
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token comment">/**
     * nick_name
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickName<span class="token punctuation">;</span>

    <span class="token comment">/**
     * phone_number
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phoneNumber<span class="token punctuation">;</span>

    <span class="token comment">/**
     * email
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

    <span class="token comment">/**
     * department_id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> departmentId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * department_name
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> departmentName<span class="token punctuation">;</span>

    <span class="token comment">/**
     * is_admin
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> isAdmin<span class="token punctuation">;</span>

    <span class="token comment">/**
     * sex
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>

    <span class="token comment">/**
     * post_id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> postId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * post_name
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> postName<span class="token punctuation">;</span>

    <span class="token comment">/**
     * is_account_non_expired
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isAccountNonExpired<span class="token punctuation">;</span>

    <span class="token comment">/**
     * is_account_non_locked
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isAccountNonLocked<span class="token punctuation">;</span>

    <span class="token comment">/**
     * is_credentials_non_expired
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isCredentialsNonExpired<span class="token punctuation">;</span>

    <span class="token comment">/**
     * is_enabled
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isEnabled<span class="token punctuation">;</span>

    <span class="token comment">/**
     * insert_user
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> insertUser<span class="token punctuation">;</span>

    <span class="token comment">/**
     * insert_time
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> insertTime<span class="token punctuation">;</span>

    <span class="token comment">/**
     * update_user
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> updateUser<span class="token punctuation">;</span>

    <span class="token comment">/**
     * update_time
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> updateTime<span class="token punctuation">;</span>

    <span class="token comment">/**
     * license_code
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> licenseCode<span class="token punctuation">;</span>





    <span class="token comment">/**
     * 权限列表 就是菜单列表
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMyPermission</span><span class="token punctuation">&gt;</span></span> permissionList<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 认证信息 就是用户配置code
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 用户权限信息
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>



    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> authorities<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userNo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isAccountNonExpired<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isAccountNonLocked<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isCredentialsNonExpired<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isEnabled<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="422_1030"></a>4.2.2.创建权限实体类</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysMyPermission</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@TableId</span>
    <span class="token comment">/**
    * sid
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sid<span class="token punctuation">;</span>

    <span class="token comment">/**
    * parent_id
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> parentId<span class="token punctuation">;</span>

    <span class="token comment">/**
    * parent_name
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> parentName<span class="token punctuation">;</span>

    <span class="token comment">/**
    * permission_name
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> permissionName<span class="token punctuation">;</span>

    <span class="token comment">/**
    * permission_code
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> permissionCode<span class="token punctuation">;</span>

    <span class="token comment">/**
    * router_path
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> routerPath<span class="token punctuation">;</span>

    <span class="token comment">/**
    * router_name
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> routerName<span class="token punctuation">;</span>

    <span class="token comment">/**
    * auth_url
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> authUrl<span class="token punctuation">;</span>

    <span class="token comment">/**
    * order_no
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">;</span>

    <span class="token comment">/**
    * type
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>

    <span class="token comment">/**
    * icon
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> icon<span class="token punctuation">;</span>

    <span class="token comment">/**
    * remark
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>

    <span class="token comment">/**
    * insert_user
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> insertUser<span class="token punctuation">;</span>

    <span class="token comment">/**
    * insert_time
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> insertTime<span class="token punctuation">;</span>

    <span class="token comment">/**
    * update_user
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> updateUser<span class="token punctuation">;</span>

    <span class="token comment">/**
    * update_time
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> updateTime<span class="token punctuation">;</span>

    <span class="token comment">/**
    * license_code
    */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> licenseCode<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 菜单的子集合
     */</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@JsonInclude</span><span class="token punctuation">(</span><span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span><span class="token punctuation">.</span><span class="token constant">NON_NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMyPermission</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="43ServiceDao_1136"></a>4.3.创建Service和Dao</h3> 
<blockquote> 
 <p>这里就不过多介绍了，直接贴上代码</p> 
</blockquote> 
<h4><a id="431UserService_1140"></a>4.3.1.UserService</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysMyUserService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SysMyUserMapper</span> userMapper<span class="token punctuation">;</span>


    <span class="token comment">/**
     * 根据用户id获取用户信息（包含用户具备的权限信息）
     * @param username 用户信息
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">SysMyUser</span> <span class="token function">getUserInfoByUserId</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取用户的基础信息</span>
        <span class="token class-name">SysMyUser</span> userInfo <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">getUserInfoByUserId</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> <span class="token string">"用户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据用户id对应的权限信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> autorizedList <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">getAutorizedListByUserId</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        userInfo<span class="token punctuation">.</span><span class="token function">setRoles</span><span class="token punctuation">(</span>autorizedList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 获取加密后的密码 ,使用BCryptPasswordEncoder加密 10次 生成密码
     * @param password 密码
     * @return 加密后的密码
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getEncoderPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BCryptPasswordEncoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> encodePassword <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> encodePassword<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="432UserMapper_1183"></a>4.3.2.UserMapper</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysMyUserMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMyUser</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/**
	 * 根据用户名账号获取用户信息
	 * @param username 用户信息
	 * @return 用户信息
	 */</span>
	<span class="token class-name">SysMyUser</span> <span class="token function">getUserInfoByUserId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/**
	 * 根据用户id获取用户具备的权限信息
	 * @param sid 用户id
	 * @return 用户具备的权限信息
	 */</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAutorizedListByUserId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"sid"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="433UserMapperxml_1207"></a>4.3.3.UserMapper.xml</h4> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mapper</span> <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.sys.my.core.user.dao.SysMyUserMapper<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>


    <span class="token comment">&lt;!-- 根据用户名账号获取用户信息 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getUserInfoByUserId<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.sys.my.core.user.model.SysMyUser<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        select * from t_sys_my_user u where u.user_no = #{username};
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 根据用户id获取用户具备的权限信息 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getAutorizedListByUserId<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.String<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        select
            p.permission_code
        from t_sys_my_role r
                 left join t_sys_my_user_role ur on ur.role_sid = r.sid
                 left join t_sys_my_role_permission rp on rp.role_sid = r.sid
                 left join t_sys_my_permission p on p.sid = rp.permission_sid
                 left join t_sys_my_user u on u.sid = ur.user_sid
        where p.status = '1' and r.status = '1' and u.sid = #{sid};
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="434SysMyPermissionService_1239"></a>4.3.4.SysMyPermissionService</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysMyPermissionService</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">MethodHandles</span><span class="token punctuation">.</span><span class="token function">lookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookupClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SysMyPermissionMapper</span> sysMyPermissionMapper<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 根据用户id查询对应的权限
     * @param userId 用户id
     * @return 权限列表
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMyPermission</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPermissionListByUserId</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 根据用户ID获取用户对应的权限</span>
        <span class="token keyword">return</span> sysMyPermissionMapper<span class="token punctuation">.</span><span class="token function">getMenuListByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="435SysMyPermissionMapper_1264"></a>4.3.5.SysMyPermissionMapper</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysMyPermissionMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMyPermission</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * 根据用户ID获取用户对应的权限
	 * @param userId 用户ID
	 * @return 权限列表
	 */</span>
	<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMyPermission</span><span class="token punctuation">&gt;</span></span> <span class="token function">getMenuListByUserId</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="436SysMyPermissionMapperxml_1282"></a>4.3.6.SysMyPermissionMapper.xml</h4> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> mapper <span class="token constant">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>mapper namespace<span class="token operator">=</span><span class="token string">"com.sys.my.core.permission.dao.SysMyPermissionMapper"</span><span class="token operator">&gt;</span>




    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 根据用户id获取用户具备的权限信息 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">"getMenuListByUserId"</span> resultType<span class="token operator">=</span><span class="token string">"com.sys.my.core.permission.model.SysMyPermission"</span><span class="token operator">&gt;</span>
        select
            p<span class="token punctuation">.</span>*
        from t_sys_my_role r
                 left join t_sys_my_user_role ur on ur<span class="token punctuation">.</span>role_sid <span class="token operator">=</span> r<span class="token punctuation">.</span>sid
                 left join t_sys_my_role_permission rp on rp<span class="token punctuation">.</span>role_sid <span class="token operator">=</span> r<span class="token punctuation">.</span>sid
                 left join t_sys_my_permission p on p<span class="token punctuation">.</span>sid <span class="token operator">=</span> rp<span class="token punctuation">.</span>permission_sid
                 left join t_sys_my_user u on u<span class="token punctuation">.</span>sid <span class="token operator">=</span> ur<span class="token punctuation">.</span>user_sid
        where p<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token char">'1'</span> and r<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token char">'1'</span> and u<span class="token punctuation">.</span>sid <span class="token operator">=</span> #<span class="token punctuation">{<!-- --></span>userId<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>mapper<span class="token operator">&gt;</span>
</code></pre> 
<h3><a id="44UserDetailsService_1315"></a>4.4.重写UserDetailsService方法</h3> 
<blockquote> 
 <p>重写 Spring Security 中的 UserDetailsService 接口的主要目的是<code>提供自定义的用户认证逻辑</code>。Spring Security 的 UserDetailsService 负责从数据源（通常是数据库）中加载用户信息，包括用户名、密码和权限等，以便进行身份验证。</p> 
 <p>通常情况下，我们需要重写 <code>UserDetailsService</code> 的 <code>loadUserByUsername()</code> 方法，该方法接收用户名作为参数，并返回一个 UserDetails 对象，该对象包含了与用户名对应的用户信息。在实际开发中，我们可能需要自定义的用户信息存储方式，或者希望在加载用户信息时进行一些特定的逻辑处理，比如自定义密码加密方式、从数据库或其他数据源加载用户信息等。</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 自定义UserDetailsService 用于认证和授权
 * 此处把用户的信息和权限交给spring security
 * spring security会对用户的信息和权限信息进行管理
 * @author hffan
 * serDetailService接口主要定义了一个方法 l
 * oadUserByUsername(String username)用于完成用户信息的查询，
 * 其中username就是登录时的登录名称，登录认证时，需要自定义一个实现类实现UserDetailService接口，
 * 完成数据库查询，该接口返回UserDetail。
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"customerUserDetailsService"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerUserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SysMyUserService</span> userService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SysMyPermissionService</span> permissionService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SysMyUser</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUserInfoByUserId</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果用户不存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"用户名或者密码错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 根据用户id查询用户权限</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysMyPermission</span><span class="token punctuation">&gt;</span></span> permissionList <span class="token operator">=</span> permissionService<span class="token punctuation">.</span><span class="token function">getPermissionListByUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 取出权限中配置code</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> permissionList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                                       <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item<span class="token punctuation">.</span><span class="token function">getPermissionCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                                       <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">-&gt;</span> item <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                                                       <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 转为数据</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> strings <span class="token operator">=</span> collect<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>collect<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorityList <span class="token operator">=</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">createAuthorityList</span><span class="token punctuation">(</span>strings<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置权限</span>
        user<span class="token punctuation">.</span><span class="token function">setAuthorities</span><span class="token punctuation">(</span>authorityList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置菜单</span>
        user<span class="token punctuation">.</span><span class="token function">setPermissionList</span><span class="token punctuation">(</span>permissionList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 授权</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="45_1372"></a>4.5.自定义异常</h3> 
<blockquote> 
 <p>自定义异常，通过传入的异常 可以获取对应的信息返回给前端</p> 
</blockquote> 
<h4><a id="451Token_1380"></a>4.5.1.Token认证自定义异常</h4> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 自定义异常 
 * AuthenticationException 是spring security提供的异常
 * 通过传入的异常 可以获取对应的信息返回给前端
 * token异常
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenException</span> <span class="token keyword">extends</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">TokenException</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="452_1401"></a>4.5.2.用户认证自定义异常</h4> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 自定义异常
 * 通过传入的异常 可以获取对应的信息返回给前端
 * 用户认证异常
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerAuthenionException</span> <span class="token keyword">extends</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">CustomerAuthenionException</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="46_1422"></a>4.6.编写自定义处理器</h3> 
<blockquote> 
 <p>通过实现SpringSecurity提供的一些接口，我们可以更好地管理身份验证和授权流程，提高用户体验和应用程序的安全性。</p> 
</blockquote> 
<h4><a id="461_1430"></a>4.6.1.匿名用户访问处理器</h4> 
<p><strong>AuthenticationEntryPoint</strong>：</p> 
<ul><li><strong>作用</strong>：AuthenticationEntryPoint 用于处理用户尝试访问受保护资源但未进行身份验证的情况。当用户尝试访问需要身份验证的资源但尚未进行身份验证时，AuthenticationEntryPoint 将被调用来触发身份验证流程。</li><li><strong>详细讲解</strong>：当用户尝试访问安全受保护的资源但未进行身份验证时，AuthenticationEntryPoint 的 commence() 方法将被调用。在这个方法中，我们可以定制返回响应给用户，例如重定向到登录页面或返回401未授权错误等。</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 匿名用户访问资源处理器
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"loginAuthenticationHandler"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginAuthenticationHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationEntryPoint</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> authException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServletOutputStream</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> res <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token class-name">ResultObject</span><span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">600</span><span class="token punctuation">,</span><span class="token string">"匿名用户没有权限进行访问！"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="462_1461"></a>4.6.2.认证用户无权限处理器</h4> 
<p><strong>AccessDeniedHandler</strong>：</p> 
<ul><li><strong>作用</strong>：AccessDeniedHandler 用于处理用户尝试访问受保护资源但权限不足的情况。当用户虽然进行了身份验证，但由于缺乏足够的权限而被拒绝访问资源时，AccessDeniedHandler 将被调用。</li><li><strong>详细讲解</strong>：AccessDeniedHandler 的 handle() 方法在访问被拒绝时被调用。我们可以在这个方法中定义自定义的行为，例如返回自定义的错误页面、向用户发送通知或记录拒绝的访问尝试。</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 认证用户访问无权限处理器
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"loginAccessDefineHandler"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginAccessDefineHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AccessDeniedHandler</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AccessDeniedException</span> accessDeniedException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServletOutputStream</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> res <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token class-name">ResultObject</span><span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token number">700</span><span class="token punctuation">,</span><span class="token string">"您没有开通对应的权限，请联系管理员！"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="463_1493"></a>4.6.3.账户信息异常处理器</h4> 
<p><strong>AuthenticationFailureHandler</strong>：</p> 
<ul><li><strong>作用</strong>：AuthenticationFailureHandler 用于处理身份验证失败的情况。当用户提供的凭据无效或身份验证过程出现错误时，AuthenticationFailureHandler 将被调用。</li><li><strong>详细讲解</strong>：AuthenticationFailureHandler 的 onAuthenticationFailure() 方法在身份验证失败时被调用。我们可以在这个方法中执行自定义的行为，例如记录登录失败次数、向用户发送通知或返回自定义的错误页面。</li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"loginFiledHandler"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginFiledHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationFailureHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1.设置响应编码</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServletOutputStream</span> out <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> code <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AccountExpiredException</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            str <span class="token operator">=</span> <span class="token string">"账户过期，登录失败!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            str <span class="token operator">=</span> <span class="token string">"用户名或密码错误，登录失败!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">CredentialsExpiredException</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            str <span class="token operator">=</span> <span class="token string">"密码过期，登录失败!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">DisabledException</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            str <span class="token operator">=</span> <span class="token string">"账户被禁用，登录失败!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">LockedException</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            str <span class="token operator">=</span> <span class="token string">"账户被锁，登录失败!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">InternalAuthenticationServiceException</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            str <span class="token operator">=</span> <span class="token string">"账户不存在，登录失败!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">CustomerAuthenionException</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">//token验证失败</span>
            code <span class="token operator">=</span> <span class="token number">600</span><span class="token punctuation">;</span>
            str <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            str <span class="token operator">=</span> <span class="token string">"登录失败!"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设置返回格式</span>
        <span class="token class-name">String</span> res <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span><span class="token class-name">ResultObject</span><span class="token punctuation">.</span><span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="464_1544"></a>4.6.4.登录成功处理器</h4> 
<p><strong>AuthenticationSuccessHandler</strong>：</p> 
<ul><li><strong>作用</strong>：AuthenticationSuccessHandler 用于处理身份验证成功的情况。当用户成功进行身份验证并被授权访问资源时，AuthenticationSuccessHandler 将被调用。</li><li><strong>详细讲解</strong>：AuthenticationSuccessHandler 的 onAuthenticationSuccess() 方法在身份验证成功时被调用。我们可以在这个方法中执行自定义的行为，例如记录登录成功的日志、向用户发送欢迎消息或重定向到特定页面。</li></ul> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 自定义认证成功处理器
 */</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"loginSuccessHandler"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginSuccessHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationSuccessHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisCache</span> redisCache<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">,</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SysMyUser</span> user <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SysMyUser</span><span class="token punctuation">)</span>authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 登录成功处理</span>
        <span class="token comment">//1.生成token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">TokenUtil</span><span class="token punctuation">.</span><span class="token function">genAccessToken</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> expireTime <span class="token operator">=</span> <span class="token class-name">TokenUtil</span><span class="token punctuation">.</span><span class="token function">getExpirationTime</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置一下返回给前端的token信息</span>
        <span class="token class-name">LoginResultObject</span> vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginResultObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将实体类信息转为JSON</span>
        <span class="token comment">// TODO 将token存入coookie中 后面加载页面 根据用户的id取查询对应的权限</span>
        vo<span class="token punctuation">.</span><span class="token function">setUserInfo</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span><span class="token number">200L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// TODO 将token存放到redis中 退出或者修改密码 清空token 获取的时候 也从redis中进行获取</span>
        redisCache<span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>token<span class="token punctuation">,</span><span class="token class-name">TokenUtil</span><span class="token punctuation">.</span><span class="token constant">ACCESS_EXPIRE</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span>expireTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> res <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpServletResponse<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/json;charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServletOutputStream</span> out <span class="token operator">=</span> httpServletResponse<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="47_1598"></a>4.7.自定义过滤器</h3> 
<blockquote> 
 <p>实现 Spring Security 中的 OncePerRequestFilter 接口，用于处理用户请求的过滤逻辑。</p> 
 <ul><li>该过滤器用于对用户的请求进行拦截，验证用户的访问权限和身份信息。</li><li>如果请求的 URL 是某些特定的资源或者登录页面，则直接放行。</li><li>如果不是登录请求，则对请求中的 token 进行验证，以确保用户的身份信息有效。</li><li>如果验证通过，则将用户的身份信息设置到 Spring Security 的上下文中，从而完成用户的身份认证。</li></ul> 
</blockquote> 
<ul><li> <p><code>@Component("checkTokenFilter")</code>：将该类声明为 Spring 组件，并指定其名称为 “checkTokenFilter”。</p> </li><li> <p><code>@EqualsAndHashCode(callSuper=false)</code>：生成 equals() 和 hashCode() 方法，忽略父类 OncePerRequestFilter。</p> </li><li> <p><code>@Data</code>：Lombok 注解，自动生成 getter、setter、equals、hashCode 等方法。</p> </li><li> <p><code>@Autowired</code> 和 <code>@Value</code>：用于依赖注入和获取配置信息。</p> </li><li> <pre><code>doFilterInternal
</code></pre> <p>方法：这是 OncePerRequestFilter 类的抽象方法，用于实现具体的请求过滤逻辑。</p> 
  <ul><li>首先判断请求的 URL 是否属于特定的资源，如果是则放行。</li><li>判断是否是登录请求，如果是，则直接放行。</li><li>如果不是登录请求，则验证请求中的 token，确保用户的身份信息有效。</li><li>如果 token 验证失败，则调用 AuthenticationFailureHandler 处理身份验证失败的情况。</li><li>如果 token 验证通过，则将用户的身份信息设置到 Spring Security 的上下文中。</li></ul> </li><li> <pre><code>validateToken
</code></pre> <p>方法：用于验证请求中的 token。</p> 
  <ul><li>首先从请求头部获取 token，如果没有则从请求参数中获取，如果仍然没有则从 Redis 缓存中获取。</li><li>解析 token，获取其中的用户名。</li><li>根据用户名加载用户信息，使用自定义的 CustomerUserDetailsService。</li><li>如果用户信息加载成功，则创建 UsernamePasswordAuthenticationToken，并将用户信息设置到 Spring Security 上下文中。</li></ul> </li><li> <p>最后调用 <code>filterChain.doFilter(httpServletRequest, httpServletResponse)</code>，将请求传递给下一个过滤器处理。</p> </li></ul> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">"checkTokenFilter"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EqualsAndHashCode</span><span class="token punctuation">(</span>callSuper<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheckTokenFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${hrfan.login.url}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> loginUrl<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginFiledHandler</span> loginFailureHandler<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CustomerUserDetailsService</span> customerUserDetailsService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisCache</span> redisCache<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取请求的url(读取配置文件的url)</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"swagger"</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"webjars"</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"v3"</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"profile"</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"swagger-ui"</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"swagger-resources"</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"csrf"</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"favicon"</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"v2"</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getServletPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"getImageCode"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">,</span> httpServletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>loginUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 是登录请求放行</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">,</span> httpServletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//token验证（如果不是登录请求 验证toekn）</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>loginUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">validateToken</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                loginFailureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">,</span>httpServletResponse<span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">,</span>httpServletResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token comment">//token验证</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">validateToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">//从请求的头部获取token</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果请求头部没有获取到token，则从请求参数中获取token</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 请求参数中也没有 那就从redis中进行获取根据ip地址取</span>
            token <span class="token operator">=</span> redisCache<span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRemoteAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomerAuthenionException</span><span class="token punctuation">(</span><span class="token string">"token不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//解析token</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token class-name">TokenUtil</span><span class="token punctuation">.</span><span class="token function">getUserFromToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomerAuthenionException</span><span class="token punctuation">(</span><span class="token string">"token解析失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取用户信息</span>
        <span class="token class-name">UserDetails</span> user <span class="token operator">=</span> customerUserDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CustomerAuthenionException</span><span class="token punctuation">(</span><span class="token string">"token验证失败!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">UsernamePasswordAuthenticationToken</span> authenticationToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        authenticationToken<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置到spring security上下文</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authenticationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="48_1730"></a>4.8.设置登录返回信息</h3> 
<blockquote> 
 <p>用户返回用户登录 成功或者失败的信息，成功后需要包含用户的相关信息 和token</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 登录返回信息
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginResultObject</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> token<span class="token punctuation">;</span>
    <span class="token comment">//token过期时间</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> expireTime<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SysMyUser</span> userInfo<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> code<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="49span_stylecolorredSpringSecurityspan_1754"></a>4.9.编写SpringSecurity配置</h3> 
<pre><code class="prism language-markdown">#### 注意
	因为新版本的SpringSecurity和旧版本的差距较大，所以这里保留了旧版本的写法
	我使用的SpringBoot 和 SpringSecurity 版本都是相对较新的 3.1.8版本 JDK版本是21
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>my<span class="token punctuation">.</span>config<span class="token punctuation">.</span>security<span class="token punctuation">.</span>details_service<span class="token punctuation">.</span></span><span class="token class-name">CustomerUserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>my<span class="token punctuation">.</span>config<span class="token punctuation">.</span>security<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">CheckTokenFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>my<span class="token punctuation">.</span>config<span class="token punctuation">.</span>security<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">LoginAccessDefineHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>my<span class="token punctuation">.</span>config<span class="token punctuation">.</span>security<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">LoginAuthenticationHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>my<span class="token punctuation">.</span>config<span class="token punctuation">.</span>security<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">LoginFiledHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>my<span class="token punctuation">.</span>config<span class="token punctuation">.</span>security<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">LoginSuccessHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableWebSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">SessionCreationPolicy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span><span class="token class-name">PasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">SecurityFilterChain</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">UsernamePasswordAuthenticationFilter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>cors<span class="token punctuation">.</span></span><span class="token class-name">CorsConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>cors<span class="token punctuation">.</span></span><span class="token class-name">CorsConfigurationSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>cors<span class="token punctuation">.</span></span><span class="token class-name">UrlBasedCorsConfigurationSource</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * SpringSecurity配置类
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>  <span class="token comment">//启用Spring Security</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringSecurityConfig</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CustomerUserDetailsService</span> customerUserDetailsService<span class="token punctuation">;</span>



    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginSuccessHandler</span> loginSuccessHandler<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginFiledHandler</span> loginFiledHandler<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginAuthenticationHandler</span> loginAuthenticationHandler<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">LoginAccessDefineHandler</span> loginAccessDefineHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">CheckTokenFilter</span> checkTokenFilter<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 密码处理
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 新版的实现方法不再和旧版一样在配置类里面重写方法，而是构建了一个过滤链对象并通过@Bean注解注入到IOC容器中
     * 新版整体代码 （注意：新版AuthenticationManager认证管理器默认全局）
     * @param http http安全配置
     * @return SecurityFilterChain
     * @throws Exception 异常
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        http    <span class="token comment">// 使用自己自定义的过滤器 去过滤接口请求</span>
                <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>checkTokenFilter<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">(</span>formLogin<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
                        <span class="token comment">// 这里更改SpringSecurity的认证接口地址，这样就默认处理这个接口的登录请求了</span>
                        formLogin<span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">"/api/v1/user/login"</span><span class="token punctuation">)</span>
                                <span class="token comment">//　自定义的登录验证成功或失败后的去向</span>
                                <span class="token punctuation">.</span><span class="token function">successHandler</span><span class="token punctuation">(</span>loginSuccessHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">failureHandler</span><span class="token punctuation">(</span>loginFiledHandler<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            	<span class="token comment">// 禁用了 CSRF 保护。</span>
                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>csrf<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> csrf<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            	<span class="token comment">// 配置了会话管理策略为 STATELESS（无状态）。在无状态的会话管理策略下，应用程序不会创建或使用 HTTP 会话，每个请求都是独立的，服务器不会在请求之间保留任何状态信息。</span>
                <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">(</span>sessionManagement<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> sessionManagement<span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span><span class="token constant">STATELESS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authorizeRequests<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
                        <span class="token comment">// 这里过滤一些 不需要token的接口地址</span>
                        authorizeRequests
                                <span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token string">"/api/v1/test/getTestInfo"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span>  <span class="token string">"/v3/**"</span><span class="token punctuation">,</span><span class="token string">"/profile/**"</span><span class="token punctuation">,</span><span class="token string">"/swagger-ui.html"</span><span class="token punctuation">,</span>
                                        <span class="token string">"/swagger-resources/**"</span><span class="token punctuation">,</span>
                                        <span class="token string">"/v2/api-docs"</span><span class="token punctuation">,</span>
                                        <span class="token string">"/v3/api-docs"</span><span class="token punctuation">,</span>
                                        <span class="token string">"/webjars/**"</span><span class="token punctuation">,</span><span class="token string">"/swagger-ui/**"</span><span class="token punctuation">,</span><span class="token string">"/v2/**"</span><span class="token punctuation">,</span><span class="token string">"/favicon.ico"</span><span class="token punctuation">,</span><span class="token string">"/webjars/springfox-swagger-ui/**"</span><span class="token punctuation">,</span><span class="token string">"/static/**"</span><span class="token punctuation">,</span> <span class="token string">"/webjars/**"</span><span class="token punctuation">,</span> <span class="token string">"/v2/api-docs"</span><span class="token punctuation">,</span> <span class="token string">"/v2/feign-docs"</span><span class="token punctuation">,</span>
                                        <span class="token string">"/swagger-resources/configuration/ui"</span><span class="token punctuation">,</span>
                                        <span class="token string">"/test/user"</span><span class="token punctuation">,</span>
                                        <span class="token string">"/swagger-resources"</span><span class="token punctuation">,</span> <span class="token string">"/swagger-resources/configuration/security"</span><span class="token punctuation">,</span>
                                        <span class="token string">"/swagger-ui.html"</span><span class="token punctuation">,</span> <span class="token string">"/webjars/**"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token string">"/api/v1/user/login"</span><span class="token punctuation">,</span><span class="token string">"/api/v1/user/getImageCode"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">(</span>exceptionHandling<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> exceptionHandling
                        <span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span>loginAuthenticationHandler<span class="token punctuation">)</span> <span class="token comment">// 匿名处理</span>
                        <span class="token punctuation">.</span><span class="token function">accessDeniedHandler</span><span class="token punctuation">(</span>loginAccessDefineHandler<span class="token punctuation">)</span>  <span class="token comment">// 无权限处理</span>
                <span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cors<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> cors<span class="token punctuation">.</span><span class="token function">configurationSource</span><span class="token punctuation">(</span><span class="token function">configurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> headers<span class="token punctuation">.</span><span class="token function">frameOptions</span><span class="token punctuation">(</span><span class="token punctuation">(</span>frameOptionsConfig <span class="token operator">-&gt;</span> frameOptionsConfig<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">(</span>headers<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> headers<span class="token punctuation">.</span><span class="token function">frameOptions</span><span class="token punctuation">(</span><span class="token punctuation">(</span>frameOptionsConfig <span class="token operator">-&gt;</span> frameOptionsConfig<span class="token punctuation">.</span><span class="token function">sameOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构建过滤链并返回</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// 旧版本 需要继承  extends WebSecurityConfigurerAdapter</span>

    <span class="token comment">// 新版的比较简单，直接定义好数据源，注入就可以了，无需手动到配置类中去将它提交给AuthenticationManager进行管理。</span>
    <span class="token comment">// /**</span>
    <span class="token comment">//  * 配置认证处理器</span>
    <span class="token comment">//  * 自定义的UserDetailsService</span>
    <span class="token comment">//  * @param auth</span>
    <span class="token comment">//  * @throws Exception</span>
    <span class="token comment">//  */</span>
    <span class="token comment">// @Override</span>
    <span class="token comment">// protected void configure(AuthenticationManagerBuilder auth) throws Exception {<!-- --></span>
    <span class="token comment">//     auth.userDetailsService(customerUserDetailsService);</span>
    <span class="token comment">// }</span>

    <span class="token comment">// /**</span>
    <span class="token comment">//  * 配置权限资源</span>
    <span class="token comment">//  * @param http</span>
    <span class="token comment">//  * @throws Exception</span>
    <span class="token comment">//  */</span>
    <span class="token comment">// @Override</span>
    <span class="token comment">// protected void configure(HttpSecurity http) throws Exception {<!-- --></span>
    <span class="token comment">//     // 每次请求前检查token</span>
    <span class="token comment">//     http.addFilterBefore(checkTokenFilter, UsernamePasswordAuthenticationFilter.class);</span>
    <span class="token comment">//     http.formLogin()</span>
    <span class="token comment">//             .loginProcessingUrl("/api/v1/user/login")</span>
    <span class="token comment">//             //　自定义的登录验证成功或失败后的去向</span>
    <span class="token comment">//             .successHandler(loginSuccessHandler).failureHandler(loginFiledHandler)</span>
    <span class="token comment">//             // 禁用csrf防御机制(跨域请求伪造)，这么做在测试和开发会比较方便。</span>
    <span class="token comment">//             .and().csrf().disable()</span>
    <span class="token comment">//             .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span>
    <span class="token comment">//             .and()</span>
    <span class="token comment">//             .authorizeRequests()</span>
    <span class="token comment">//             .antMatchers("/api/v1/test/getTestInfo").permitAll()</span>
    <span class="token comment">//             // 放心swagger相关请求</span>
    <span class="token comment">//             .antMatchers(  "/v3/**","/profile/**","/swagger-ui.html",</span>
    <span class="token comment">//                     "/swagger-resources/**",</span>
    <span class="token comment">//                     "/v2/api-docs",</span>
    <span class="token comment">//                     "/v3/api-docs",</span>
    <span class="token comment">//                     "/webjars/**","/swagger-ui/**","/v2/**","/favicon.ico","/webjars/springfox-swagger-ui/**","/static/**", "/webjars/**", "/v2/api-docs", "/v2/feign-docs",</span>
    <span class="token comment">//                     "/swagger-resources/configuration/ui",</span>
    <span class="token comment">//                     "/swagger-resources", "/swagger-resources/configuration/security",</span>
    <span class="token comment">//                     "/swagger-ui.html", "/webjars/**").permitAll()</span>
    <span class="token comment">//             .antMatchers("/api/v1/user/login","/api/v1/user/getImageCode").permitAll()</span>
    <span class="token comment">//             .anyRequest().authenticated()</span>
    <span class="token comment">//             .and()</span>
    <span class="token comment">//             .exceptionHandling()</span>
    <span class="token comment">//             // 匿名处理</span>
    <span class="token comment">//             .authenticationEntryPoint(loginAuthenticationHandler)</span>
    <span class="token comment">//             // 无权限处理</span>
    <span class="token comment">//             .accessDeniedHandler(loginAccessDefineHandler)</span>
    <span class="token comment">//             // 跨域配置</span>
    <span class="token comment">//             .and()</span>
    <span class="token comment">//             .cors()</span>
    <span class="token comment">//             .configurationSource(configurationSource());</span>
    <span class="token comment">//     // 设置iframe</span>
    <span class="token comment">//     http.headers().frameOptions().sameOrigin();</span>
    <span class="token comment">//     http.headers().frameOptions().disable();</span>
    <span class="token comment">//</span>
    <span class="token comment">// }</span>


    <span class="token comment">/**
     * 跨域配置
     */</span>
    <span class="token class-name">CorsConfigurationSource</span> <span class="token function">configurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">CorsConfiguration</span> corsConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorsConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        corsConfiguration<span class="token punctuation">.</span><span class="token function">setAllowedHeaders</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        corsConfiguration<span class="token punctuation">.</span><span class="token function">setAllowedMethods</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        corsConfiguration<span class="token punctuation">.</span><span class="token function">setAllowedOrigins</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        corsConfiguration<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">3600L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">UrlBasedCorsConfigurationSource</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UrlBasedCorsConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        source<span class="token punctuation">.</span><span class="token function">registerCorsConfiguration</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">,</span> corsConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> source<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="410_1956"></a>4.10.配置文件配置</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">hrfan</span><span class="token punctuation">:</span>
  <span class="token key atrule">login</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"/api/v1/user/login"</span>
</code></pre> 
<h3><a id="5_1970"></a>5.测试</h3> 
<h4><a id="51_1974"></a>5.1.测试登录密码错误</h4> 
<p><img src="https://images2.imgbox.com/7b/09/9JtwwEdZ_o.png" alt="image-20240218001551442"></p> 
<h4><a id="52_1982"></a>5.2.测试正确密码</h4> 
<p><img src="https://images2.imgbox.com/96/8a/wiu2vqTh_o.png" alt="image-20240218001649070"></p> 
<h4><a id="53token_1990"></a>5.3.测试无token访问接口</h4> 
<blockquote> 
 <p>SpringSecurity为我们提供了基于注解的权限控制方案。</p> 
 <p>在启动类上加上 <code>@EnableGlobalMethodSecurity(prePostEnabled = true)</code></p> 
</blockquote> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/jjwt"</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('user_list')"</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">jjwt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 这里的user_list 就是我们权限中permission_code</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"测试无token访问！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/96/6d/hZvVtCgd_o.png" alt="image-20240218002547214"></p> 
<h4><a id="54_2013"></a>5.4.测试不登陆访问</h4> 
<p><img src="https://images2.imgbox.com/85/6b/a56iGkJ4_o.png" alt="image-20240218002712121"></p> 
<h4><a id="55_2021"></a>5.5.测试登录访问不受限制接口</h4> 
<p><img src="https://images2.imgbox.com/56/f6/jrlRQycO_o.png" alt="image-20240218002909117"></p> 
<p><img src="https://images2.imgbox.com/11/60/hMYH0pf2_o.png" alt="image-20240218004426367"></p> 
<h4><a id="56__2035"></a>5.6.测试放开的通用接口 例如/**</h4> 
<p><img src="https://images2.imgbox.com/2c/46/gJOKBpFl_o.png" alt="image-20240218004734952"></p> 
<p><img src="https://images2.imgbox.com/11/07/zXMmVXLF_o.png" alt="image-20240218004839439"></p> 
<h4><a id="57__2047"></a>5.7.测试权限标识 和数据库不一致</h4> 
<p><img src="https://images2.imgbox.com/66/e6/Jv7zhnF3_o.png" alt="image-20240218091500059"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/822c14cd480f66fd6386e7628592bd1b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">手把手完成前端Vue3 &#43; Vite项目工程化搭建</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6f13518b65adfd27fbd1e601b80dcbc6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何使用 CrewAI 构建协作型 AI Agents</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>