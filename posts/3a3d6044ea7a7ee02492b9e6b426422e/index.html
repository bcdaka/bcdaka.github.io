<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>谷粒商城实战笔记-27-分布式组件-SpringCloud-Gateway-创建&amp;测试API网关 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3a3d6044ea7a7ee02492b9e6b426422e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="谷粒商城实战笔记-27-分布式组件-SpringCloud-Gateway-创建&测试API网关">
  <meta property="og:description" content="本节的主要内容是创建网关模块，将网关注册到Nacos，并配置路由进行测试。
一，创建网关模块 右键工程New-&gt;Module，创建新模块，模块名称 gulimall-gateway。
填充各种信息。
选中Gateway依赖。
点击Create创建模块。
二，网关服务配置 1，依赖common模块 &lt;dependency&gt; &lt;groupId&gt;com.atguigu.gulimall&lt;/groupId&gt; &lt;artifactId&gt;gulimall-common&lt;/artifactId&gt; &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt; &lt;/dependency&gt; 因为网关服务也需要使用注册中心和配置中心，所以需要相关的包的依赖，通过依赖common模块得到。
2，启动服务发现 通过在启动类增加注解，让服务启动后注册到注册中心。
@EnableDiscoveryClient 3，创建配置文件 在resources目录下新建三个配置文件。
① application.properties
配置Nacos注册中心相关信息。
server.port=80 spring.cloud.nacos.discovery.server-addr=localhost:8848 spring.application.name=gulimall-gateway ② bootstrap.properties
配置Nacos配置中心的相关信息，注意，要事先在Nacos上创建一个名为gateway的命名空间，网关模块的所有配置文件都存放在这个命名空间下。
spring.application.name=gulimall-gateway spring.cloud.nacos.config.server-addr=localhost:8848 spring.cloud.nacos.config.namespace=405d2201-d62b-4203-80c8-800e9387ad40 ③ application.yml
这个文件中，编写网关路由配置，具体内容见下一部分。
三，网关路由配置 1，路由配置 这一部分，我们以两个实际的需求为例，练习如何配置网关。
网关的作用是根据网关配置的规则，将接收到的请求转发到相应的服务。
为了方便演示，假设有这样的需求，在浏览器输入如下url时，将请求转发到百度。
http://localhost/?url=baidu 在浏览器输入如下url时，将请求转发到腾讯。
http://localhost/?url=qq 该如何编写配置文件呢？
仓库Spring Cloud Gateway的官方文档，参考其格式。
因为我们需要根据url上的查询条件进行对应的转发，所以找到Gateway关于Query的断言配置文档。
参照这个文档进行配置。
application.yml
spring: cloud: gateway: routes: - id: baidu_test uri: https://www.baidu.com predicates: - Query=url,baidu - id: qq_test uri: https://www.qq.com predicates: - Query=url,qq 这里定义了两个路由规则，用于根据查询参数url的值来决定请求应该转发到哪个目标URI。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-11T16:06:38+08:00">
    <meta property="article:modified_time" content="2024-07-11T16:06:38+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">谷粒商城实战笔记-27-分布式组件-SpringCloud-Gateway-创建&amp;测试API网关</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>本节的主要内容是创建网关模块，将网关注册到Nacos，并配置路由进行测试。</p> 
<h2><a id="_2"></a>一，创建网关模块</h2> 
<p>右键工程<code>New-&gt;Module</code>，创建新模块，模块名称 <code>gulimall-gateway</code>。</p> 
<p><img src="https://images2.imgbox.com/d0/94/we72dFuZ_o.png" alt="在这里插入图片描述"></p> 
<p>填充各种信息。</p> 
<p><img src="https://images2.imgbox.com/c7/f5/MRrJc3j6_o.png" alt="在这里插入图片描述"></p> 
<p>选中Gateway依赖。</p> 
<p><img src="https://images2.imgbox.com/0d/f3/F2e7FIPy_o.png" alt="在这里插入图片描述"><br> 点击Create创建模块。</p> 
<h2><a id="_20"></a>二，网关服务配置</h2> 
<h3><a id="1common_22"></a>1，依赖common模块</h3> 
<pre><code class="prism language-clike">		<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>gulimall<span class="token operator">-</span>common<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span>SNAPSHOT<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>因为网关服务也需要使用注册中心和配置中心，所以需要相关的包的依赖，通过依赖common模块得到。</p> 
<h3><a id="2_34"></a>2，启动服务发现</h3> 
<p>通过在启动类增加注解，让服务启动后注册到注册中心。</p> 
<pre><code class="prism language-clike">@EnableDiscoveryClient
</code></pre> 
<h3><a id="3_42"></a>3，创建配置文件</h3> 
<p>在resources目录下新建三个配置文件。</p> 
<p><strong>① application.properties</strong></p> 
<p>配置Nacos注册中心相关信息。</p> 
<pre><code class="prism language-clike">server<span class="token punctuation">.</span>port<span class="token operator">=</span><span class="token number">80</span>
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span>server<span class="token operator">-</span>addr<span class="token operator">=</span>localhost<span class="token punctuation">:</span><span class="token number">8848</span>
spring<span class="token punctuation">.</span>application<span class="token punctuation">.</span>name<span class="token operator">=</span>gulimall<span class="token operator">-</span>gateway
</code></pre> 
<p><strong>② bootstrap.properties</strong></p> 
<p>配置Nacos配置中心的相关信息，注意，要事先在Nacos上创建一个名为gateway的命名空间，网关模块的所有配置文件都存放在这个命名空间下。</p> 
<p><img src="https://images2.imgbox.com/cc/49/RXzhWaSl_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-clike">spring<span class="token punctuation">.</span>application<span class="token punctuation">.</span>name<span class="token operator">=</span>gulimall<span class="token operator">-</span>gateway
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>server<span class="token operator">-</span>addr<span class="token operator">=</span>localhost<span class="token punctuation">:</span><span class="token number">8848</span>
spring<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>config<span class="token punctuation">.</span>namespace<span class="token operator">=</span><span class="token number">405</span>d2201<span class="token operator">-</span>d62b<span class="token operator">-</span><span class="token number">4203</span><span class="token operator">-</span><span class="token number">80</span>c8<span class="token operator">-</span><span class="token number">800e9387</span>ad40
</code></pre> 
<p><strong>③ application.yml</strong></p> 
<p>这个文件中，编写网关路由配置，具体内容见下一部分。</p> 
<h2><a id="_75"></a>三，网关路由配置</h2> 
<h3><a id="1_77"></a>1，路由配置</h3> 
<p>这一部分，我们以两个实际的需求为例，练习如何配置网关。</p> 
<p>网关的作用是根据网关配置的规则，将接收到的请求转发到相应的服务。</p> 
<p>为了方便演示，假设有这样的需求，在浏览器输入如下url时，将请求转发到百度。</p> 
<pre><code class="prism language-clike">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">/</span><span class="token operator">?</span>url<span class="token operator">=</span>baidu
</code></pre> 
<p>在浏览器输入如下url时，将请求转发到腾讯。</p> 
<pre><code class="prism language-clike">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">/</span><span class="token operator">?</span>url<span class="token operator">=</span>qq
</code></pre> 
<p>该如何编写配置文件呢？</p> 
<p>仓库Spring Cloud Gateway的<a href="https://cloud.spring.io/spring-cloud-gateway/reference/html/#the-query-route-predicate-factory" rel="nofollow">官方文档</a>，参考其格式。</p> 
<p>因为我们需要根据url上的查询条件进行对应的转发，所以找到Gateway关于Query的断言配置文档。</p> 
<p><img src="https://images2.imgbox.com/79/d9/Qqj3qkL4_o.png" alt="在这里插入图片描述"></p> 
<p>参照这个文档进行配置。</p> 
<p><strong>application.yml</strong></p> 
<pre><code class="prism language-clike">spring<span class="token punctuation">:</span>
  cloud<span class="token punctuation">:</span>
    gateway<span class="token punctuation">:</span>
      routes<span class="token punctuation">:</span>
        <span class="token operator">-</span> id<span class="token punctuation">:</span> baidu_test
          uri<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com
          predicates<span class="token punctuation">:</span>
            <span class="token operator">-</span> Query<span class="token operator">=</span>url<span class="token punctuation">,</span>baidu
        <span class="token operator">-</span> id<span class="token punctuation">:</span> qq_test
          uri<span class="token punctuation">:</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>qq<span class="token punctuation">.</span>com
          predicates<span class="token punctuation">:</span>
            <span class="token operator">-</span> Query<span class="token operator">=</span>url<span class="token punctuation">,</span>qq
</code></pre> 
<p>这里定义了两个路由规则，用于根据查询参数<code>url</code>的值来决定请求应该转发到哪个目标URI。</p> 
<ul><li> <p><code>spring.cloud.gateway.routes</code>: 这是Spring Cloud Gateway的路由配置列表。</p> </li><li> <p>每个<code>routes</code>项定义了一个路由规则。</p> </li><li> <p><code>id</code>: 每个路由规则需要一个唯一的ID，用于识别和管理路由。</p> </li><li> <p><code>uri</code>: 当路由规则匹配时，请求将被转发到这个URI地址。这里的<code>https://www.baidu.com</code>和<code>https://www.qq.com</code>分别指定了百度和腾讯网站的URL。</p> </li><li> <p><code>predicates</code>: 这是路由规则的断言列表，用于确定是否应用此路由规则。断言是基于请求的元数据进行评估的表达式。</p> 
  <ul><li> <p><code>Query=url,baidu</code>: 这个断言表示如果请求中包含名为<code>url</code>的查询参数，并且它的值等于<code>baidu</code>，那么这个路由规则会被触发，请求将被转发到<code>https://www.baidu.com</code>。</p> </li><li> <p><code>Query=url,qq</code>: 类似地，如果查询参数<code>url</code>的值为<code>qq</code>，则请求将被转发到<code>https://www.qq.com</code>。</p> </li></ul> </li></ul> 
<p>这样，当你的应用收到一个带有<code>url=baidu</code>或<code>url=qq</code>查询参数的请求时，Spring Cloud Gateway会根据上述规则将请求代理到相应的网站。</p> 
<h3><a id="2_142"></a>2，验证</h3> 
<p>在浏览器中访问如下地址。</p> 
<pre><code class="prism language-clike">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">/</span><span class="token operator">?</span>url<span class="token operator">=</span>baidu
</code></pre> 
<p><img src="https://images2.imgbox.com/9d/c8/bcYtRPCl_o.png" alt="在这里插入图片描述"></p> 
<p>有如上界面，说明网关服务配置和路由配置正常。</p> 
<h2><a id="_153"></a>错误记录</h2> 
<p>在启动Gateway的过程中会报错。</p> 
<pre><code class="prism language-clike">Error starting ApplicationContext<span class="token punctuation">.</span> To display the conditions report re<span class="token operator">-</span>run your application with <span class="token string">'debug'</span> enabled<span class="token punctuation">.</span>
<span class="token number">2024</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">11</span> <span class="token number">15</span><span class="token punctuation">:</span><span class="token number">57</span><span class="token punctuation">:</span><span class="token number">32.988</span> ERROR <span class="token number">27224</span> <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>b<span class="token punctuation">.</span>d<span class="token punctuation">.</span>LoggingFailureAnalysisReporter   <span class="token punctuation">:</span> 

<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
APPLICATION FAILED TO START
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>

Description<span class="token punctuation">:</span>

Failed to configure a DataSource<span class="token punctuation">:</span> <span class="token string">'url'</span> attribute is not specified and no embedded datasource could be configured<span class="token punctuation">.</span>

Reason<span class="token punctuation">:</span> Failed to determine a suitable driver class
</code></pre> 
<p><img src="https://images2.imgbox.com/e7/af/ZuXlTLSg_o.png" alt="在这里插入图片描述"></p> 
<p>原因是Gateway模块依赖common，common模块声明了对mybatis的依赖，mybatis的包会在启动时查找数据库相关的配置，而Gateway项目无需数据库，所以没有相关配置。</p> 
<p>解决办法，告知网关模块在启动时无需查找数据库相关的配置，通过在启动类注解上声明排除相关的包依赖即可。</p> 
<p><img src="https://images2.imgbox.com/34/aa/7n6CqGKt_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-clike">@<span class="token function">SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> DataSourceAutoConfiguration<span class="token punctuation">.</span>class<span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eb2501a4a34424b0d6d0166094cab3e0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43;：从C语言过渡到C&#43;&#43;</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a35fb2e2200d6af6bebdd0d14ca98d06/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">gitee上传和下载idea项目的流程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>