<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【微服务】第37节：微服务的注册中心Eureka - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/1ff65ac0db6034fe1f3f676338b12bf5/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【微服务】第37节：微服务的注册中心Eureka">
  <meta property="og:description" content="1.注册中心 本章主要学习Nacos中的一些特性和原理，以及与Eureka的功能对比。
1.1.环境隔离 企业实际开发中，往往会搭建多个运行环境，例如：
🔹 开发环境
🔹 测试环境
🔹 预发布环境
🔹 生产环境
这些不同环境之间的服务和数据之间需要隔离。
还有的企业中，会开发多个项目，共享nacos集群。此时，这些项目之间也需要把服务和数据隔离。
因此，Nacos提供了基于namespace的环境隔离功能。具体的隔离层次如图所示：
说明：
⭕Nacos中可以配置多个namespace，相互之间完全隔离。默认的namespace名为public
⭕namespace下还可以继续分组，也就是group ，相互隔离。 默认的group是DEFAULT_GROUP
⭕group之下就是服务和配置了
1.1.1.创建namespace nacos提供了一个默认的namespace，叫做public：
默认所有的服务和配置都属于这个namespace，当然我们也可以自己创建新的namespace：
📑 然后填写表单：
添加完成后，可以在页面看到我们新建的namespace，并且Nacos为我们自动生成了一个命名空间id：
我们切换到配置列表页，你会发现dev这个命名空间下没有任何配置：
因为之前我们添加的所有配置都在public下：
1.1.2.微服务配置namespace 默认情况下，所有的微服务注册发现、配置管理都是走public这个命名空间。如果要指定命名空间则需要修改application.yml文件。
比如，我们修改item-service服务的bootstrap.yml📄文件，添加服务发现配置，指定namespace：
spring: application: name: item-service # 服务名称 profiles: active: dev cloud: nacos: server-addr: 192.168.150.101 # nacos地址 discovery: # 服务发现配置 namespace: 8c468c63-b650-48da-a632-311c75e6d235 # 设置namespace，必须用id # 。。。略 启动item-service，查看服务列表，会发现item-service出现在dev下：
而其它服务则出现在public下：
此时访问http://localhost:8082/doc.html，基于swagger做测试：
会发现查询结果中缺少商品的最新价格信息。
我们查看服务运行日志：
会发现cart-service服务在远程调用item-service时，并没有找到可用的实例。这证明不同namespace之间确实是相互隔离的，不可访问。
当我们把namespace切换回public，或者统一都是以dev时访问恢复正常。
1.2.分级模型 在一些大型应用中，同一个服务可以部署很多实例。而这些实例可能分布在全国各地的不同机房。由于存在地域差异，网络传输的速度会有很大不同，因此在做服务治理时需要区分不同机房的实例。
例如item-service，我们可以部署3个实例：
🌐127.0.0.1:8081
🌐127.0.0.1:8082
🌐127.0.0.1:8083">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-18T23:06:54+08:00">
    <meta property="article:modified_time" content="2024-07-18T23:06:54+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【微服务】第37节：微服务的注册中心Eureka</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>1.注册中心</h2> 
<p>本章主要学习Nacos中的一些特性和原理，以及与Eureka的功能对比。</p> 
<h3 style="background-color:transparent;">1.1.环境隔离</h3> 
<p>企业实际开发中，往往会搭建多个运行环境，例如：</p> 
<ul><li> <p>🔹 开发环境</p> </li><li> <p>🔹 测试环境</p> </li><li> <p>🔹 预发布环境</p> </li><li> <p>🔹 生产环境</p> </li></ul> 
<p>这些不同环境之间的服务和数据之间需要隔离。</p> 
<p>还有的企业中，会开发多个项目，共享nacos集群。此时，这些项目之间也需要把服务和数据隔离。</p> 
<p></p> 
<p>因此，Nacos提供了基于<code>namespace</code>的环境隔离功能。具体的隔离层次如图所示：</p> 
<p><img alt="" height="309" src="https://images2.imgbox.com/df/f7/aMuK31Qq_o.png" width="818"></p> 
<p>说明：</p> 
<ul><li> <p>⭕Nacos中可以配置多个<code>namespace</code>，相互之间完全隔离。默认的<code>namespace</code>名为<code>public</code></p> </li><li> <p><code>⭕namespace</code>下还可以继续分组，也就是group ，相互隔离。 默认的group是<code>DEFAULT_GROUP</code></p> </li><li> <p><code>⭕group</code>之下就是服务和配置了</p> </li></ul> 
<p></p> 
<h4 style="background-color:transparent;">1.1.1.创建namespace</h4> 
<p>nacos提供了一个默认的<code>namespace</code>，叫做<code>public</code>：</p> 
<p><img alt="" height="355" src="https://images2.imgbox.com/3a/85/j4PX1nDU_o.png" width="809"></p> 
<p>默认所有的服务和配置都属于这个<code>namespace</code>，当然我们也可以自己创建新的<code>namespace</code>：</p> 
<p><img alt="" height="285" src="https://images2.imgbox.com/e9/b0/CUj6jSr7_o.png" width="810"></p> 
<p>📑 然后填写表单：</p> 
<p><img alt="" height="323" src="https://images2.imgbox.com/17/a3/2VU1WRGL_o.png" width="608"></p> 
<p>添加完成后，可以在页面看到我们新建的<code>namespace</code>，并且Nacos为我们自动生成了一个命名空间id：</p> 
<p><img alt="" height="287" src="https://images2.imgbox.com/01/8b/zH9Lkh1K_o.png" width="818"></p> 
<p>我们切换到配置列表页，你会发现<code>dev</code>这个命名空间下没有任何配置：</p> 
<p><img alt="" height="248" src="https://images2.imgbox.com/e9/d5/3wuRSrhM_o.png" width="811"></p> 
<p>因为之前我们添加的所有配置都在<code>public</code>下：</p> 
<p><img alt="" height="322" src="https://images2.imgbox.com/d5/b5/fQRTGvl2_o.png" width="812"></p> 
<p> </p> 
<h4 style="background-color:transparent;">1.1.2.微服务配置namespace</h4> 
<p>默认情况下，所有的微服务注册发现、配置管理都是走<code>public</code>这个命名空间。如果要指定命名空间则需要修改<code>application.yml</code>文件。</p> 
<p>比如，我们修改<code>item-service</code>服务的bootstrap.yml📄文件，添加服务发现配置，指定<code>namespace</code>：</p> 
<pre><code class="language-TypeScript">spring:
  application:
    name: item-service # 服务名称
  profiles:
    active: dev
  cloud:
    nacos:
      server-addr: 192.168.150.101 # nacos地址
      discovery: # 服务发现配置
        namespace: 8c468c63-b650-48da-a632-311c75e6d235 # 设置namespace，必须用id
      # 。。。略</code></pre> 
<p>启动<code>item-service</code>，查看服务列表，会发现<code>item-service</code>出现在<code>dev</code>下：</p> 
<p><img alt="" height="262" src="https://images2.imgbox.com/a4/92/E1wuIGJF_o.png" width="815"></p> 
<p>而其它服务则出现在<code>public</code>下：</p> 
<p><img alt="" height="270" src="https://images2.imgbox.com/1b/99/VOW1ahSw_o.png" width="819"></p> 
<p>此时访问<code>http://localhost:8082/doc.html</code>，基于<code>swagger</code>做测试：</p> 
<p><img alt="" height="371" src="https://images2.imgbox.com/8b/41/ZJsgefkP_o.png" width="814"></p> 
<p>会发现查询结果中缺少商品的最新价格信息。</p> 
<p>我们查看服务运行日志：</p> 
<p><img alt="" height="287" src="https://images2.imgbox.com/3b/a7/6biJEVtI_o.png" width="816"></p> 
<p>会发现<code>cart-service</code>服务在远程调用<code>item-service</code>时，并没有找到可用的实例。这证明不同namespace之间确实是相互隔离的，不可访问。</p> 
<p>当我们把<code>namespace</code>切换回<code>public</code>，或者统一都是以<code>dev</code>时访问恢复正常。</p> 
<p></p> 
<h3 style="background-color:transparent;">1.2.分级模型</h3> 
<p>在一些大型应用中，同一个服务可以部署很多实例。而这些实例可能分布在全国各地的不同机房。由于存在地域差异，网络传输的速度会有很大不同，因此在做服务治理时需要区分不同机房的实例。</p> 
<p>例如item-service，我们可以部署3个实例：</p> 
<ul><li> <p>🌐127.0.0.1:8081</p> </li><li> <p>🌐127.0.0.1:8082</p> </li><li> <p>🌐127.0.0.1:8083</p> </li></ul> 
<p>假如这些实例分布在不同机房，例如：</p> 
<ul><li> <p>🌐127.0.0.1:8081，在上海机房</p> </li><li> <p>🌐127.0.0.1:8082，在上海机房</p> </li><li> <p>🌐127.0.0.1:8083，在杭州机房</p> </li></ul> 
<p></p> 
<p>Nacos中提供了集群（<code>cluster</code>）的概念，来对应不同机房。也就是说，一个服务（<code>service</code>）下可以有很多集群（<code>cluster</code>），而一个集群（<code>cluster</code>）中下又可以包含很多实例（<code>instance</code>）。</p> 
<p>如图：</p> 
<p><img alt="" height="386" src="https://images2.imgbox.com/6e/3c/tGhMFjGS_o.png" width="815"></p> 
<p>因此，结合我们上一节学习的<code>namespace</code>命名空间的知识，任何一个微服务的实例在注册到Nacos时，都会生成以下几个信息，用来确认当前实例的身份，从外到内依次是：</p> 
<ul><li> <p><strong>💠namespace：命名空间</strong></p> </li><li> <p><strong>💠group：分组</strong></p> </li><li> <p><strong>💠service：服务名</strong></p> </li><li> <p><strong>💠cluster：集群</strong></p> </li><li> <p><strong>💠instance：实例，包含ip和端口</strong></p> </li></ul> 
<p>这就是nacos中的服务分级模型。</p> 
<p></p> 
<p>在Nacos内部会有一个服务实例的注册表，是基于Map实现的，其结构与分级模型的对应关系如下：</p> 
<p><img alt="" height="349" src="https://images2.imgbox.com/e1/d9/JNpiINGN_o.png" width="817"></p> 
<p>查看nacos控制台，会发现默认情况下所有服务的集群都是default：</p> 
<p><img alt="" height="467" src="https://images2.imgbox.com/04/23/8astT4sA_o.png" width="813"></p> 
<p>如果我们要修改服务所在集群，只需要修改<code>bootstrap.yml</code>即可：</p> 
<pre><code class="language-TypeScript">spring:
  cloud:
    nacos:
      discovery:
        cluster-name: BJ # 集群名称，自定义</code></pre> 
<p>我们修改<code>item-service</code>的<code>bootstrap.yml</code>，然后重新创建一个实例：</p> 
<p><img alt="" height="204" src="https://images2.imgbox.com/c7/77/VFfGAqYf_o.png" width="743"></p> 
<p>再次查看nacos：</p> 
<p><img alt="" height="598" src="https://images2.imgbox.com/f2/69/tW3JpC4T_o.png" width="809"></p> 
<p>发现8084这个新的实例确实属于<code>BJ</code>这个集群了。</p> 
<p></p> 
<h3 style="background-color:transparent;">1.3.Eureka</h3> 
<p>Eureka是Netflix公司开源的一个服务注册中心组件，早期版本的SpringCloud都是使用Eureka作为注册中心。由于Eureka和Nacos的starter中提供的功能都是基于SpringCloudCommon规范，因此两者使用起来差别不大。</p> 
<p>结构说明：</p> 
<ul><li> <p><code>🔹<strong>eureka-server</strong></code>：Eureka的服务端，也就是注册中心。没错，Eureka服务端要自己创建项目</p> </li><li> <p><code>🔹<strong>order-service</strong></code><strong>：</strong>订单服务，是一个服务调用者，查询订单的时候要查询用户</p> </li><li> <p><code>🔹<strong>user-service</strong></code><strong>：</strong>用户服务，是一个服务提供者，对外暴露查询用户的接口</p> </li></ul> 
<p>启动以后，访问<code>localhost:10086</code>即可查看到Eureka的控制台，相对于Nacos来说简陋了很多：</p> 
<p><img alt="" height="425" src="https://images2.imgbox.com/2d/15/HtSwfFF7_o.png" width="822"></p> 
<p>微服务引入Eureka的方式也极其简单，分两步：</p> 
<ul><li> <p>🔹引入<code>eureka-client</code>依赖</p> </li><li> <p>🔹配置<code>eureka</code>地址</p> </li></ul> 
<p>接下来就是编写OpenFeign的客户端了，怎么样？是不是跟Nacos用起来基本一致。</p> 
<p></p> 
<h3 style="background-color:transparent;">1.4.Eureka和Nacos对比</h3> 
<p>Eureka和Nacos都能起到注册中心的作用，用法基本类似。但还是有一些区别的，例如：</p> 
<ul><li> <p>Nacos支持配置管理，而Eureka则不支持。</p> </li></ul> 
<p>而且服务注册发现上也有区别，我们来做一个实验：</p> 
<p>我们停止<code>user-service</code>服务，然后观察Eureka控制台，你会发现很长一段时间过去后，Eureka服务依然没有察觉<code>user-service</code>的异常状态。</p> 
<p></p> 
<blockquote> 
 <p><strong>💡 这与Eureka的健康检测机制有关。在Eureka中，健康检测的原理如下：</strong></p> 
 <ul><li> <p>🔹微服务启动时注册信息到Eureka，这点与Nacos一致。</p> </li><li> <p>🔹微服务每隔30秒向Eureka发送心跳请求，报告自己的健康状态。Nacos中默认是5秒一次。</p> </li><li> <p>🔹Eureka如果90秒未收到心跳，则认为服务疑似故障，可能被剔除。Nacos中则是15秒超时，30秒剔除。</p> </li><li> <p>🔹Eureka如果发现超过85%比例的服务都心跳异常，会认为是自己的网络异常，暂停剔除服务的功能。</p> </li><li> <p>🔹Eureka每隔60秒执行一次服务检测和清理任务；Nacos是每隔5秒执行一次。</p> </li></ul> 
</blockquote> 
<p>综上，你会发现Eureka是尽量不剔除服务，避免“误杀”，宁可放过一千，也不错杀一个。这就导致当服务真的出现故障时，迟迟不会被剔除，给服务的调用者带来困扰。</p> 
<p>不仅如此，当Eureka发现服务宕机并从服务列表中剔除以后，并不会将服务列表的变更消息推送给所有微服务。而是等待微服务自己来拉取时发现服务列表的变化。而微服务每隔30秒才会去Eureka更新一次服务列表，进一步推迟了服务宕机时被发现的时间。</p> 
<p>而Nacos中微服务除了自己定时去Nacos中拉取服务列表以外，Nacos还会在服务列表变更时主动推送最新的服务列表给所有的订阅者。</p> 
<p></p> 
<p>综上，Eureka和Nacos的相似点有：</p> 
<ul><li> <p>⭕都支持服务注册发现功能</p> </li><li> <p>⭕都有基于心跳的健康监测功能</p> </li><li> <p>⭕都支持集群，集群间数据同步默认是AP模式，即最全高可用性</p> </li></ul> 
<p>Eureka和Nacos的区别有：</p> 
<ul><li> <p>⭕Eureka的心跳是30秒一次，Nacos则是5秒一次</p> </li><li> <p>⭕Eureka如果90秒未收到心跳，则认为服务疑似故障，可能被剔除。Nacos中则是15秒超时，30秒剔除。</p> </li><li> <p>⭕Eureka每隔60秒执行一次服务检测和清理任务；Nacos是每隔5秒执行一次。</p> </li><li> <p>⭕Eureka只能等微服务自己每隔30秒更新一次服务列表；Nacos即有定时更新，也有在服务变更时的广播推送</p> </li><li> <p>⭕Eureka仅有注册中心功能，而Nacos同时支持注册中心、配置管理</p> </li><li> <p>⭕Eureka和Nacos都支持集群，而且默认都是AP模式</p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d79d886e8df6f127a1aba8233768e540/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于天地图使用Leaflet.js进行WebGIS开发实战</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/62992984b540b6521f0288df4ce3a3a7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C&#43;&#43;】C&#43;&#43;11的新特性 --- 右值引用与移动语义</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>