<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>python的websocket方法教程 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/622928fc9df6b0b6b1009613d7a910fe/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="python的websocket方法教程">
  <meta property="og:description" content="WebSocket是一种网络通信协议，它在单个TCP连接上提供全双工的通信信道。在本篇文章中，我们将探讨如何在Python中使用WebSocket实现实时通信。
websockets是Python中最常用的网络库之一，也是websocket协议的Python实现。它不仅作为基础组件在众多项目中发挥着重要作用，其源码也值得广大“Python玩家”研究。
官网:https://github.com/python-websockets/websockets
1. 什么是WebSocket？ WebSocket协议是在2008年由Web应用程序设计师和开发人员创建的，目的是为了在Web浏览器和服务器之间提供更高效、更低延迟的双向通信。它允许客户端和服务器在任何时候发送消息，无需重新建立TCP连接。WebSocket可以在Web浏览器和服务器之间传输文本和二进制数据，使得构建实时Web应用程序变得更加简单。
2. 在Python中使用WebSocket Python中有多个库可以帮助我们使用WebSocket，如：websockets、aiohttp等。在本文中，我们将使用websockets库来演示WebSocket编程。
要安装websockets库，你可以使用pip：
pip install websockets 3. 创建WebSocket服务器 使用websockets库，我们可以轻松地创建一个WebSocket服务器。以下是一个简单的示例：
import asyncio import websockets async def echo(websocket, path): async for message in websocket: print(f&#34;Received message: {message}&#34;) await websocket.send(f&#34;Echo: {message}&#34;) start_server = websockets.serve(echo, &#34;localhost&#34;, 8765) asyncio.get_event_loop().run_until_complete(start_server) asyncio.get_event_loop().run_forever() 在这个示例中，我们定义了一个名为echo的协程函数，它接收两个参数：websocket和path。该函数使用async for循环读取客户端发送的消息，并将消息发送回客户端。
然后，我们使用websockets.serve()函数创建一个WebSocket服务器，监听本地主机的8765端口。最后，我们使用asyncio的事件循环启动服务器。
4. 创建WebSocket客户端 要创建一个WebSocket客户端，我们同样可以使用websockets库。以下是一个简单的客户端示例：
import asyncio import websockets async def main(): async with websockets.connect(&#34;ws://localhost:8765&#34;) as websocket: message = &#34;Hello, server!&#34; await websocket.send(message) print(f&#34;Sent: {message}&#34;) response = await websocket.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-08T22:01:46+08:00">
    <meta property="article:modified_time" content="2023-12-08T22:01:46+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">python的websocket方法教程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>WebSocket是一种网络通信协议，它在单个TCP连接上提供全双工的通信信道。在本篇文章中，我们将探讨如何在Python中使用WebSocket实现实时通信。</p> 
<p>websockets是Python中最常用的网络库之一，也是websocket协议的Python实现。它不仅作为基础组件在众多项目中发挥着重要作用，其源码也值得广大“Python玩家”研究。<br> 官网:https://github.com/python-websockets/websockets</p> 
<h2><a id="1_WebSocket_4"></a>1. 什么是WebSocket？</h2> 
<p>WebSocket协议是在2008年由Web应用程序设计师和开发人员创建的，目的是为了在Web浏览器和服务器之间提供更高效、更低延迟的双向通信。它允许客户端和服务器在任何时候发送消息，无需重新建立TCP连接。WebSocket可以在Web浏览器和服务器之间传输文本和二进制数据，使得构建实时Web应用程序变得更加简单。</p> 
<h2><a id="2_PythonWebSocket_7"></a>2. 在Python中使用WebSocket</h2> 
<p>Python中有多个库可以帮助我们使用WebSocket，如：websockets、aiohttp等。在本文中，我们将使用websockets库来演示WebSocket编程。</p> 
<p>要安装websockets库，你可以使用pip：</p> 
<pre><code class="prism language-python">pip install websockets
</code></pre> 
<h2><a id="3_WebSocket_16"></a>3. 创建WebSocket服务器</h2> 
<p>使用websockets库，我们可以轻松地创建一个WebSocket服务器。以下是一个简单的示例：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">echo</span><span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">for</span> message <span class="token keyword">in</span> websocket<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Received message: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>message<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Echo: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>message<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

start_server <span class="token operator">=</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>echo<span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">8765</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>start_server<span class="token punctuation">)</span>
asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>在这个示例中，我们定义了一个名为echo的协程函数，它接收两个参数：websocket和path。该函数使用async for循环读取客户端发送的消息，并将消息发送回客户端。</p> 
<p>然后，我们使用websockets.serve()函数创建一个WebSocket服务器，监听本地主机的8765端口。最后，我们使用asyncio的事件循环启动服务器。</p> 
<h2><a id="4_WebSocket_38"></a>4. 创建WebSocket客户端</h2> 
<p>要创建一个WebSocket客户端，我们同样可以使用websockets库。以下是一个简单的客户端示例：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"ws://localhost:8765"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> websocket<span class="token punctuation">:</span>
        message <span class="token operator">=</span> <span class="token string">"Hello, server!"</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sent: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>message<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        response <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Received: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>response<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>在这个示例中，我们使用websockets.connect()函数建立与WebSocket服务器的连接。然后，我们使用send()方法向服务器发送消息，并使用recv()方法接收服务器的响应。</p> 
<h2><a id="5__59"></a>5. 总结</h2> 
<p>WebSocket协议为Web浏览器和服务器之间提供了实时双向通信的能力，使得构建实时Web应用程序变得更加容易。在Python中，我们可以使用websockets库轻松地实现WebSocket编程。</p> 
<h2><a id="6_websocketsasyncio_63"></a>6. 通过websockets这个项目，从大型开源项目中学习asyncio库。</h2> 
<p>一、asyncio.Transport<br> 在官方文档中，Transport被描述成对socket的抽象，它控制着如何传输数据。除了websockets，uvicorn、daphne等ASGI实现都会用到Transport。</p> 
<p>Transport继承于ReadTransport和WriteTransport，两者都继承于BaseTransport。顾名思义，Transport兼备读和写的功能，可以类比为读写socket对象。<br> <img src="https://images2.imgbox.com/91/18/5rYIaqmL_o.png" alt="在这里插入图片描述"></p> 
<p>Transport对象提供以下常用函数——</p> 
<p>is_reading：判断该Transport是否在读。</p> 
<p>set_write_buffer_limits：设置写入Transport的高和低水位。考虑到网络状况，有时不希望写入过多的数据。</p> 
<p>write、write_eof、write_line：为当前Transport写入数据，分别表示写入二进制数据、eof和二进制行数据。其中eof写入后不会关闭Transport，但会flush数据。</p> 
<p>abort：立刻关闭Transport，不接受新的数据。留在缓冲的数据也会丢失，后续调用Protocol的connection_lost函数。</p> 
<p>在websockets中，Transport使用场景不多，一般都是通过Protocol对象的回调参数使用的。在websocket的初始化过程中，会设置Transport的最高水位。同样，在这种场景下，该对象也是作为回调参数使用的。<br> <img src="https://images2.imgbox.com/15/87/3Hcc31Kt_o.png" alt="在这里插入图片描述"></p> 
<p>二、asyncio.Protocol<br> 如果Transport是对socket的抽象，那么Protocol就是对协议的抽象。它提供了如何使用Transport的方式。<br> <img src="https://images2.imgbox.com/2d/e8/nlnBGwUf_o.png" alt="在这里插入图片描述"></p> 
<p>用户使用的Protocol直接继承自BaseProtocol，并提供了六个Unimplemented函数需要用户去实现——</p> 
<p>connection_made：当连接建立时会执行该函数，该函数包含一个Transport类型的参数。</p> 
<p>connection_lost：当连接丢失或者关闭时会执行该函数，该函数包含一个Exception类型的参数。</p> 
<p>pause_writing：当Transport对象写入的数据高于之前设置的高水位时被调用，一般会暂停数据的写入。</p> 
<p>resume_writing：当Transport对象写入的数据低于之前设置的低水位时被调用，一般用于恢复数据写入。</p> 
<p>data_received：当有数据被接受时回调，该函数包含一个二进制对象data，用来表示接受的数据。</p> 
<p>eof_received：当被Transport对象被调用write_eof时被调用。</p> 
<p>在websockets中，server端的connection_made实现截图如图所示。在该函数中，websockets将用户实现的handler封装成task对象，并和websocket的server绑定。<br> <img src="https://images2.imgbox.com/7d/c2/3UFAgF7n_o.png" alt="在这里插入图片描述"></p> 
<p>而在client端中实现如第一节截图所示，只是在reader中注册该Transport对象。</p> 
<p>websockets的connection_lost函数实现方式如下。主要操作即更新状态、关闭pings、更新对应的waiter状态，以及维护reader对象。<br> <img src="https://images2.imgbox.com/a9/7d/31vSiEXf_o.png" alt="在这里插入图片描述"></p> 
<p>在其他函数的实现中，websockets也主要用到了reader对象完成数据流的暂停和恢复，以及数据的写入。</p> 
<p>从上面代码实现可以看出，websockets通过reader代理完成数据流的操作。这个reader是一个asyncio.StreamReader对象。这个对象具体如何使用将在下一篇介绍。</p> 
<h2><a id="_122"></a>附录：进阶版本：</h2> 
<p>python使用websockets库<br> serve:在server端使用，等待客户端的连接。如果连接成功，返回一个websocket。</p> 
<p>connect: 在client端使用，用于建立连接。</p> 
<p>send:发送数据</p> 
<p>recv:接收数据</p> 
<p>close:关闭连接</p> 
<p>服务端</p> 
<pre><code class="prism language-python"><span class="token comment">#!/usr/bin/python3</span>
<span class="token comment"># 主要功能：创建1个基本的websocket server, 符合asyncio 开发要求</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
    reply <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Data received as \"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data<span class="token punctuation">}</span></span><span class="token string">\".  time: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span>
    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>reply<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Send reply"</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># run forever</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>客户端</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets
<span class="token keyword">import</span> time


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">ws_client</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> websocket<span class="token punctuation">:</span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"Hello, I am PyPy."</span><span class="token punctuation">)</span>
            response <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>ws_client<span class="token punctuation">(</span><span class="token string">'ws://localhost:9999'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>服务端</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets

IP_ADDR <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
IP_PORT <span class="token operator">=</span> <span class="token string">"9090"</span>

<span class="token comment"># 握手，通过接收Hi，发送"success"来进行双方的握手。</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">serverHands</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        recv_text <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"recv_text="</span> <span class="token operator">+</span> recv_text<span class="token punctuation">)</span>
        <span class="token keyword">if</span> recv_text <span class="token operator">==</span> <span class="token string">"Hi"</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"connected success"</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"connected fail"</span><span class="token punctuation">)</span>



<span class="token comment"># 接收从客户端发来的消息并处理，再返给客户端success</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">serverRecv</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        recv_text <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"recv:"</span><span class="token punctuation">,</span> recv_text<span class="token punctuation">)</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"success,get mess:"</span><span class="token operator">+</span> recv_text<span class="token punctuation">)</span>


<span class="token comment"># 握手并且接收数据</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">serverRun</span><span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">await</span> serverHands<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
    <span class="token keyword">await</span> serverRecv<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>


<span class="token comment"># main function</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======server======"</span><span class="token punctuation">)</span>
    server <span class="token operator">=</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>serverRun<span class="token punctuation">,</span> IP_ADDR<span class="token punctuation">,</span> IP_PORT<span class="token punctuation">)</span>
    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>server<span class="token punctuation">)</span>
    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>客户端</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets

IP_ADDR <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
IP_PORT <span class="token operator">=</span> <span class="token string">"9090"</span>



<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">clientHands</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token comment"># 通过发送hello握手</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">"Hi"</span><span class="token punctuation">)</span>
        response_str <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 接收"success"来进行双方的握手</span>
        <span class="token keyword">if</span> <span class="token string">"success"</span> <span class="token keyword">in</span> response_str<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"握手成功"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>


<span class="token comment"># 向服务器端发送消息</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">clientSend</span><span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        input_text <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"input text: "</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> input_text <span class="token operator">==</span> <span class="token string">"exit"</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'"exit", bye!'</span></span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span>reason<span class="token operator">=</span><span class="token string">"exit"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>input_text<span class="token punctuation">)</span>
        recv_text <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>recv_text<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>


<span class="token comment"># 进行websocket连接</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">clientRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    ipaddress <span class="token operator">=</span> IP_ADDR <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> IP_PORT
    <span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"ws://"</span> <span class="token operator">+</span> ipaddress<span class="token punctuation">)</span> <span class="token keyword">as</span> websocket<span class="token punctuation">:</span>
        <span class="token keyword">await</span> clientHands<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
        <span class="token keyword">await</span> clientSend<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>


<span class="token comment"># main function</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======client======"</span><span class="token punctuation">)</span>
    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>clientRun<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>服务端</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding:utf8 -*-</span>

<span class="token keyword">import</span> json
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> websockets
<span class="token keyword">import</span> multiprocessing

IP <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span>
PORT_CHAT <span class="token operator">=</span> <span class="token number">9090</span>

USERS <span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment">#提供聊天的后台</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">ServerWs</span><span class="token punctuation">(</span>websocket<span class="token punctuation">,</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(pathname)s[line:%(lineno)d] - %(levelname)s: %(message)s'</span><span class="token punctuation">,</span>
                        filename<span class="token operator">=</span><span class="token string">"chat.log"</span><span class="token punctuation">,</span>
                        level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
    <span class="token comment"># 握手</span>
    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"handshake"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">for</span> message <span class="token keyword">in</span> websocket<span class="token punctuation">:</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
        message <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token comment"># 用户发信息</span>
        <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'send'</span><span class="token punctuation">:</span>
            name <span class="token operator">=</span> <span class="token string">'404'</span>
            <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> USERS<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> v <span class="token operator">==</span> websocket<span class="token punctuation">:</span>
                    name <span class="token operator">=</span> k
            data<span class="token punctuation">[</span><span class="token string">"from"</span><span class="token punctuation">]</span> <span class="token operator">=</span> name
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>USERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># asyncio.wait doesn't accept an empty list</span>
                message <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>
                    <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">:</span> name<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment"># 用户注册</span>
        <span class="token keyword">elif</span> data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'register'</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                USERS<span class="token punctuation">[</span>data<span class="token punctuation">[</span><span class="token string">"uuid"</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> websocket
                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>USERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># asyncio.wait doesn't accept an empty list</span>
                    message <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>
                        <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"login"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"user_list"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>USERS<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> exp<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
        <span class="token comment"># 用户注销</span>
        <span class="token keyword">elif</span> data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'unregister'</span><span class="token punctuation">:</span>
            <span class="token keyword">del</span> USERS<span class="token punctuation">[</span>data<span class="token punctuation">[</span><span class="token string">"uuid"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>USERS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># asyncio.wait doesn't accept an empty list</span>
                message <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>
                    <span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"logout"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"user_list"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>USERS<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">#打印日志</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token comment"># 群发</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">[</span>user<span class="token punctuation">.</span>send<span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token keyword">for</span> user <span class="token keyword">in</span> USERS<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">server_run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"server"</span><span class="token punctuation">)</span>
    start_server <span class="token operator">=</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>ServerWs<span class="token punctuation">,</span> <span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> PORT_CHAT<span class="token punctuation">)</span>
    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>start_server<span class="token punctuation">)</span>
    asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Process
    multiprocessing<span class="token punctuation">.</span>freeze_support<span class="token punctuation">(</span><span class="token punctuation">)</span>
    server <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>server_run<span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>服务端</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> websockets
<span class="token keyword">import</span> time
<span class="token keyword">import</span> json
<span class="token keyword">import</span> threading
<span class="token comment"># 功能模块</span>
<span class="token keyword">class</span> <span class="token class-name">OutputHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>message<span class="token punctuation">,</span>send_ms<span class="token punctuation">,</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 用户发信息</span>
        <span class="token keyword">await</span> send_ms<span class="token punctuation">(</span>message<span class="token punctuation">,</span> websocket<span class="token punctuation">)</span>
        <span class="token comment"># 单发消息</span>
        <span class="token comment"># await send_ms(message, websocket)</span>
        <span class="token comment"># 群发消息</span>
        <span class="token comment">#await s('hi起来')</span>


<span class="token comment"># 存储所有的客户端</span>
Clients <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token comment"># 服务端</span>
<span class="token keyword">class</span> <span class="token class-name">WS_Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>ip <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
        self<span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token number">9090</span>

    <span class="token comment"># 回调函数(发消息给客户端)</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">callback_send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> websocket<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>sendMsg<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> websocket<span class="token punctuation">)</span>

    <span class="token comment"># 发送消息</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'sendMsg:'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
        <span class="token comment"># websocket不为空，单发，为空，群发消息</span>
        <span class="token keyword">if</span> websocket <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 群发消息</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>broadcastMsg<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        <span class="token comment"># 避免被卡线程</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span>

    <span class="token comment"># 群发消息</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">broadcastMsg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> user <span class="token keyword">in</span> Clients<span class="token punctuation">:</span>
            <span class="token keyword">await</span> user<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>


    <span class="token comment"># 针对不同的信息进行请求，可以考虑json文本</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">runCaseX</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>jsonMsg<span class="token punctuation">,</span>websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'runCase'</span><span class="token punctuation">)</span>
        op <span class="token operator">=</span> OutputHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 参数：消息、方法、socket</span>
        <span class="token keyword">await</span> op<span class="token punctuation">.</span>run<span class="token punctuation">(</span>jsonMsg<span class="token punctuation">,</span>self<span class="token punctuation">.</span>callback_send<span class="token punctuation">,</span>websocket<span class="token punctuation">)</span>

    <span class="token comment"># 连接一个客户端，起一个循环监听</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">echo</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>websocket<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 添加到客户端列表</span>
        <span class="token comment"># Clients.append(websocket)</span>
        <span class="token comment"># 握手</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"handshake"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 循环监听</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token comment"># 接受信息</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token comment"># 接受文本</span>
                recv_text <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
                message <span class="token operator">=</span> <span class="token string">"Get message: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>recv_text<span class="token punctuation">)</span>
                <span class="token comment"># 返回客户端信息</span>
                <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token comment"># 转json</span>
                data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>recv_text<span class="token punctuation">)</span>

                <span class="token comment"># 用户发信息</span>
                <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'send'</span><span class="token punctuation">:</span>
                    name <span class="token operator">=</span> <span class="token string">'404'</span>
                    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> Clients<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        <span class="token keyword">if</span> v <span class="token operator">==</span> websocket<span class="token punctuation">:</span>
                            name <span class="token operator">=</span> k
                    data<span class="token punctuation">[</span><span class="token string">"from"</span><span class="token punctuation">]</span> <span class="token operator">=</span> name
                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>Clients<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># asyncio.wait doesn't accept an empty list</span>
                        message <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"send"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"from"</span><span class="token punctuation">:</span> name<span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token keyword">await</span> self<span class="token punctuation">.</span>runCaseX<span class="token punctuation">(</span>jsonMsg<span class="token operator">=</span>message<span class="token punctuation">,</span> websocket<span class="token operator">=</span>websocket<span class="token punctuation">)</span>

                <span class="token comment"># 用户注册</span>
                <span class="token keyword">elif</span> data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'register'</span><span class="token punctuation">:</span>
                    <span class="token keyword">try</span><span class="token punctuation">:</span>
                        Clients<span class="token punctuation">[</span>data<span class="token punctuation">[</span><span class="token string">"uuid"</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> websocket
                        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>Clients<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># asyncio.wait doesn't accept an empty list</span>
                            message <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"register"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"user_list"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>Clients<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                            <span class="token keyword">await</span> self<span class="token punctuation">.</span>runCaseX<span class="token punctuation">(</span>jsonMsg<span class="token operator">=</span>message<span class="token punctuation">,</span> websocket<span class="token operator">=</span>websocket<span class="token punctuation">)</span>
                    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> exp<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>

                <span class="token comment"># 用户注销</span>
                <span class="token keyword">elif</span> data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'unregister'</span><span class="token punctuation">:</span>
                    <span class="token keyword">del</span> Clients<span class="token punctuation">[</span>data<span class="token punctuation">[</span><span class="token string">"uuid"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

                <span class="token comment"># 对message进行解析，跳进不同功能区</span>
                <span class="token comment"># await self.runCaseX(jsonMsg=data,websocket=websocket)</span>
            <span class="token comment"># 链接断开</span>
            <span class="token keyword">except</span> websockets<span class="token punctuation">.</span>ConnectionClosed<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ConnectionClosed..."</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
                <span class="token comment"># del Clients</span>
                <span class="token keyword">break</span>
            <span class="token comment"># 无效状态</span>
            <span class="token keyword">except</span> websockets<span class="token punctuation">.</span>InvalidState<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"InvalidState..."</span><span class="token punctuation">)</span>
                <span class="token comment"># del Clients</span>
                <span class="token keyword">break</span>
            <span class="token comment"># 报错</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ws连接报错"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span>
                <span class="token comment"># del Clients</span>
                <span class="token keyword">break</span>



    <span class="token comment"># 启动服务器</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">runServer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>serve<span class="token punctuation">(</span>self<span class="token punctuation">.</span>echo<span class="token punctuation">,</span> self<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> self<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>Future<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># run forever</span>

	<span class="token comment"># 多协程模式，防止阻塞主线程无法做其他事情</span>
    <span class="token keyword">def</span> <span class="token function">WebSocketServer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>self<span class="token punctuation">.</span>runServer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 多线程启动</span>
    <span class="token keyword">def</span> <span class="token function">startServer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 多线程启动，否则会堵塞</span>
        thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>self<span class="token punctuation">.</span>WebSocketServer<span class="token punctuation">)</span>
        thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># thread.join()</span>


<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"server"</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> WS_Server<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>startServer<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1422a70518bd855b45b7ab921182f1ca/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Wireshark 分析常见 Web 攻击的流量特征</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/651ef463318d6cd4eb28f5ac89a73bea/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">排序算法-插入/希尔排序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>