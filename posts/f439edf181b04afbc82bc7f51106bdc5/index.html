<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【CV大模型SAM（Segment-Anything）】真是太强大了，分割一切的SAM大模型使用方法:可通过不同的提示得到想要的分割目标 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/f439edf181b04afbc82bc7f51106bdc5/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【CV大模型SAM（Segment-Anything）】真是太强大了，分割一切的SAM大模型使用方法:可通过不同的提示得到想要的分割目标">
  <meta property="og:description" content="目录 前言安装运行环境SAM模型的使用方法导入相关库并定义显示函数导入待分割图片使用不同提示方法进行目标分割方法一：使用单个提示点进行目标分割方法二：使用多个提示点进行目标分割方法三：用方框指定一个目标进行分割方式四：将点与方框结合，进行目标分割方法五：多个方框同时输入，进行多目标分割 总结 本文主要介绍SAM模型的使用方法：如何使用不同的提示进行目标分割。而且该模型在CPU的环境下就可以快速运行，真心不错~,赶紧来试试吧
关于Segment-Anything模型的相关代码、论文PDF、预训练模型、使用方法等，我都已打包好，供需要的小伙伴交流研究，获取方式如下：
关注文末名片GZH：阿旭算法与机器学习，回复：【SAM】即可获取SAM相关代码、论文、预训练模型、使用方法文档等
前言 最近GPT一直都被炒的火热，没想到这么快就见到了CV的大模型，而且拥有新数据集&#43;新范式&#43;超强零样本泛化能力。
虽然此次出现的CV大模型没有NLP中的GPT那么强大的效果：用一个模型就可以处理N多下游任务。但这也是一个很好的开始，也应该是CV未来的发展趋势。
SAM（Segment-Anything Model）的出现统一了分割这个任务（CV任务的一个子集）的下流应用，说明了CV的大模型是可能存在的。其肯定会对CV的研究带来巨大的变革，很多任务会被统一处理，可能再过不久，检测、分割和追踪也会被all in one了。
项目地址：https://github.com/facebookresearch/segment-anything
Demo：https://segment-anything.com/
安装运行环境 运行需要python&gt;=3.8, 以及pytorch&gt;=1.7和torchvision&gt;=0.8。
安装依赖库：
pip install git&#43;https://github.com/facebookresearch/segment-anything.git SAM模型的使用方法 导入相关库并定义显示函数 下面导入了运行所需的第三方库，以及定义了用于展示点、方框以及分割目标的函数。
import numpy as np import torch import matplotlib.pyplot as plt import cv2 def show_mask(mask, ax, random_color=False): if random_color: color = np.concatenate([np.random.random(3), np.array([0.6])], axis=0) else: color = np.array([30/255, 144/255, 255/255, 0.6]) h, w = mask.shape[-2:] mask_image = mask.reshape(h, w, 1) * color.reshape(1, 1, -1) ax.imshow(mask_image) def show_points(coords, labels, ax, marker_size=375): pos_points = coords[labels==1] neg_points = coords[labels==0] ax.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-04-11T07:45:00+08:00">
    <meta property="article:modified_time" content="2023-04-11T07:45:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【CV大模型SAM（Segment-Anything）】真是太强大了，分割一切的SAM大模型使用方法:可通过不同的提示得到想要的分割目标</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_9" rel="nofollow">前言</a></li><li><a href="#_16" rel="nofollow">安装运行环境</a></li><li><a href="#SAM_24" rel="nofollow">SAM模型的使用方法</a></li><li><ul><li><a href="#_25" rel="nofollow">导入相关库并定义显示函数</a></li><li><a href="#_60" rel="nofollow">导入待分割图片</a></li><li><a href="#_77" rel="nofollow">使用不同提示方法进行目标分割</a></li><li><ul><li><a href="#_106" rel="nofollow">方法一：使用单个提示点进行目标分割</a></li><li><a href="#_172" rel="nofollow">方法二：使用多个提示点进行目标分割</a></li><li><a href="#_256" rel="nofollow">方法三：用方框指定一个目标进行分割</a></li><li><a href="#_288" rel="nofollow">方式四：将点与方框结合，进行目标分割</a></li><li><a href="#_325" rel="nofollow">方法五：多个方框同时输入，进行多目标分割</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_369" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<p><strong>本文主要介绍SAM模型的使用方法：如何使用不同的提示进行目标分割。而且该模型在CPU的环境下就可以快速运行，真心不错~,赶紧来试试吧</strong></p> 
<p>关于Segment-Anything模型的<strong>相关代码、论文PDF、预训练模型、使用方法</strong>等，我都已打包好，供需要的小伙伴交流研究，<strong>获取方式如下</strong>：</p> 
<blockquote> 
 <p><strong>关注文末名片GZH：阿旭算法与机器学习，回复：【SAM】即可获取SAM相关代码、论文、预训练模型、使用方法文档等</strong><br> <img src="https://images2.imgbox.com/b7/81/1kB2fZPq_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2c/9d/nTgZOHiC_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h2><a id="_9"></a>前言</h2> 
<p>最近GPT一直都被炒的火热，没想到这么快就见到了CV的大模型，而且拥有新数据集+新范式+超强零样本泛化能力。<br> 虽然此次出现的CV大模型没有NLP中的GPT那么强大的效果：用一个模型就可以处理N多下游任务。但这也是一个很好的开始，也应该是CV未来的发展趋势。<br> SAM（Segment-Anything Model）的出现统一了分割这个任务（CV任务的一个子集）的下流应用，说明了CV的大模型是可能存在的。其肯定会对CV的研究带来巨大的变革，很多任务会被统一处理，可能再过不久，检测、分割和追踪也会被all in one了。</p> 
<blockquote> 
 <p>项目地址：https://github.com/facebookresearch/segment-anything<br> Demo：https://segment-anything.com/</p> 
</blockquote> 
<h2><a id="_16"></a>安装运行环境</h2> 
<p>运行需要python&gt;=3.8, 以及pytorch&gt;=1.7和torchvision&gt;=0.8。<br> 安装依赖库：</p> 
<pre><code class="prism language-python">pip install git<span class="token operator">+</span>https<span class="token punctuation">:</span><span class="token operator">//</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>facebookresearch<span class="token operator">/</span>segment<span class="token operator">-</span>anything<span class="token punctuation">.</span>git
</code></pre> 
<h2><a id="SAM_24"></a>SAM模型的使用方法</h2> 
<h3><a id="_25"></a>导入相关库并定义显示函数</h3> 
<p>下面导入了运行所需的第三方库，以及定义了用于展示点、方框以及分割目标的函数。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> cv2
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">show_mask</span><span class="token punctuation">(</span>mask<span class="token punctuation">,</span> ax<span class="token punctuation">,</span> random_color<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> random_color<span class="token punctuation">:</span>
        color <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        color <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">30</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">144</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token operator">/</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    h<span class="token punctuation">,</span> w <span class="token operator">=</span> mask<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    mask_image <span class="token operator">=</span> mask<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> color<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>mask_image<span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">show_points</span><span class="token punctuation">(</span>coords<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> ax<span class="token punctuation">,</span> marker_size<span class="token operator">=</span><span class="token number">375</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pos_points <span class="token operator">=</span> coords<span class="token punctuation">[</span>labels<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span>
    neg_points <span class="token operator">=</span> coords<span class="token punctuation">[</span>labels<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">]</span>
    ax<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>pos_points<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pos_points<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'*'</span><span class="token punctuation">,</span> s<span class="token operator">=</span>marker_size<span class="token punctuation">,</span> edgecolor<span class="token operator">=</span><span class="token string">'white'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">1.25</span><span class="token punctuation">)</span>
    ax<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>neg_points<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> neg_points<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'*'</span><span class="token punctuation">,</span> s<span class="token operator">=</span>marker_size<span class="token punctuation">,</span> edgecolor<span class="token operator">=</span><span class="token string">'white'</span><span class="token punctuation">,</span> linewidth<span class="token operator">=</span><span class="token number">1.25</span><span class="token punctuation">)</span>   
    
<span class="token keyword">def</span> <span class="token function">show_box</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> ax<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x0<span class="token punctuation">,</span> y0 <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    w<span class="token punctuation">,</span> h <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    ax<span class="token punctuation">.</span>add_patch<span class="token punctuation">(</span>plt<span class="token punctuation">.</span>Rectangle<span class="token punctuation">(</span><span class="token punctuation">(</span>x0<span class="token punctuation">,</span> y0<span class="token punctuation">)</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> edgecolor<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span> facecolor<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lw<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    
</code></pre> 
<h3><a id="_60"></a>导入待分割图片</h3> 
<pre><code class="prism language-python">image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'images/truck.jpg'</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/63/6b/D1kiKBpd_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_77"></a>使用不同提示方法进行目标分割</h3> 
<p>首先，加载SAM预训练模型。【<strong>文末已将所有文件打包，感兴趣的小伙伴可自行获取</strong>】</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">".."</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> segment_anything <span class="token keyword">import</span> sam_model_registry<span class="token punctuation">,</span> SamPredictor

sam_checkpoint <span class="token operator">=</span> <span class="token string">"./models/sam_vit_b_01ec64.pth"</span>
model_type <span class="token operator">=</span> <span class="token string">"vit_b"</span>

device <span class="token operator">=</span> <span class="token string">"cpu"</span>  <span class="token comment"># or  "cuda"</span>

sam <span class="token operator">=</span> sam_model_registry<span class="token punctuation">[</span>model_type<span class="token punctuation">]</span><span class="token punctuation">(</span>checkpoint<span class="token operator">=</span>sam_checkpoint<span class="token punctuation">)</span>
sam<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token operator">=</span>device<span class="token punctuation">)</span>

predictor <span class="token operator">=</span> SamPredictor<span class="token punctuation">(</span>sam<span class="token punctuation">)</span>
</code></pre> 
<p>通过调用<code>SamPredictor.set_image</code>函数，将输入的图像进行编码，<code>SamPredictor</code> 会使用这些编码进行后续的目标分割任务。</p> 
<pre><code class="prism language-python">predictor<span class="token punctuation">.</span>set_image<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
</code></pre> 
<p>在上图车的图片上,选择一个点。点的<strong>输入格式为(x, y)和并表示出点所带有的标签1(前景点)或0(背景点)</strong>。可以输入多个点，在这里我们先只用一个点，选择的点会显示为一个五角星的标记。</p> 
<h4><a id="_106"></a>方法一：使用单个提示点进行目标分割</h4> 
<pre><code class="prism language-python">input_point <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">375</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 标记点</span>
input_label <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 点所对应的标签</span>
</code></pre> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
show_points<span class="token punctuation">(</span>input_point<span class="token punctuation">,</span> input_label<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'on'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>  
</code></pre> 
<p><img src="https://images2.imgbox.com/f9/fc/5rGIN6la_o.png" alt="在这里插入图片描述"><br> 用 <code>SamPredictor.predict</code>进行分割，模型会返回这些分割目标对应的置信度。</p> 
<pre><code class="prism language-python">masks<span class="token punctuation">,</span> scores<span class="token punctuation">,</span> logits <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>
    point_coords<span class="token operator">=</span>input_point<span class="token punctuation">,</span>
    point_labels<span class="token operator">=</span>input_label<span class="token punctuation">,</span>
    multimask_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>参数说明：</p> 
<blockquote> 
 <p>point_coords: 提示的坐标点位置<br> point_labels: 提示点对应的类型，1前景，0背景<br> boxes: 提示的方框<br> multimask_output: 多目标输出还是但目标输出True or False</p> 
</blockquote> 
<p><code>multimask_output=True</code> （默认），SAM模型会输出3个分割目标和对应的置信度<code>scores</code>。这个设置主要是用于面对歧义的提示点，因为一个提示点可能在多个分割的目标内部，<code>multimask_output=True</code> 能够将包含该提示点的所有目标都分割出来。<br> 如下面示例所示：2种车窗户、还有整个车均包含了五角星的提示点。</p> 
<pre><code class="prism language-python">masks<span class="token punctuation">.</span>shape  <span class="token comment"># (number_of_masks) x H x W</span>
</code></pre> 
<pre><code>(3, 1200, 1800)
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>mask<span class="token punctuation">,</span> score<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>masks<span class="token punctuation">,</span> scores<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    show_mask<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    show_points<span class="token punctuation">(</span>input_point<span class="token punctuation">,</span> input_label<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Mask </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">, Score: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>score<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">18</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>  
</code></pre> 
<p><img src="https://images2.imgbox.com/b5/91/WmMXL8xF_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c3/37/tlSoUVwV_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9c/b8/ct6AJyQE_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_172"></a>方法二：使用多个提示点进行目标分割</h4> 
<p>单个提示点通常会存在歧义的影响，因为可能多个目标均包含该点。为了得到我们想要的单个目标，我们可以在目标上进行多个点的提示，以获取该目标的分割结果。<br> 例如下面在卡车上用2个提示点，从而直接提取出整个车的分割结果，而不是窗户。这是需要设置<code>multimask_output=False</code>，用于提取单个目标分割结果。</p> 
<pre><code class="prism language-python">input_point <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">375</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1125</span><span class="token punctuation">,</span> <span class="token number">625</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
input_label <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

mask_input <span class="token operator">=</span> logits<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>scores<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># Choose the model's best mask</span>
</code></pre> 
<pre><code class="prism language-python">masks<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>
    point_coords<span class="token operator">=</span>input_point<span class="token punctuation">,</span>
    point_labels<span class="token operator">=</span>input_label<span class="token punctuation">,</span>
    mask_input<span class="token operator">=</span>mask_input<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    multimask_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">masks<span class="token punctuation">.</span>shape
</code></pre> 
<pre><code>(1, 1200, 1800)
</code></pre> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
show_mask<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
show_points<span class="token punctuation">(</span>input_point<span class="token punctuation">,</span> input_label<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/69/cPCVl1tG_o.png" alt="在这里插入图片描述"></p> 
<p>如果我们仅想得到窗户的分割结果，我们可以使用背景点（label=0，下图红的五角星）将车子的其他部分剔除掉。<br> ​</p> 
<pre><code class="prism language-python">input_point <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">375</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1125</span><span class="token punctuation">,</span> <span class="token number">625</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
input_label <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

mask_input <span class="token operator">=</span> logits<span class="token punctuation">[</span>np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>scores<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># Choose the model's best mask</span>
</code></pre> 
<pre><code class="prism language-python">masks<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>
    point_coords<span class="token operator">=</span>input_point<span class="token punctuation">,</span>
    point_labels<span class="token operator">=</span>input_label<span class="token punctuation">,</span>
    mask_input<span class="token operator">=</span>mask_input<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    multimask_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
show_mask<span class="token punctuation">(</span>masks<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
show_points<span class="token punctuation">(</span>input_point<span class="token punctuation">,</span> input_label<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/1a/ZpzJji6B_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_256"></a>方法三：用方框指定一个目标进行分割</h4> 
<p>SAM模型可以用一个方框作为输入，格式为[x1,y1,x2,y2]。来进行单个目标的分割，如下面所示，通过方框对车的轮子进行分割。</p> 
<pre><code class="prism language-python">input_box <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">425</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">875</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">masks<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>
    point_coords<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    point_labels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    box<span class="token operator">=</span>input_box<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    multimask_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
show_mask<span class="token punctuation">(</span>masks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
show_box<span class="token punctuation">(</span>input_box<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>​<br> <img src="https://images2.imgbox.com/7e/c6/kDEeFU6x_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_288"></a>方式四：将点与方框结合，进行目标分割</h4> 
<p>如下示例：将轮胎的中心轮毂部分剔除，仅得到轮胎外部。<br> 方框用于得到轮胎；点标记为背景（<code>input_label = np.array([0])</code>），起到剔除作用。</p> 
<pre><code class="prism language-python">input_box <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">425</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">875</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
input_point <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">575</span><span class="token punctuation">,</span> <span class="token number">750</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
input_label <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">masks<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>
    point_coords<span class="token operator">=</span>input_point<span class="token punctuation">,</span>
    point_labels<span class="token operator">=</span>input_label<span class="token punctuation">,</span>
    box<span class="token operator">=</span>input_box<span class="token punctuation">,</span>
    multimask_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
show_mask<span class="token punctuation">(</span>masks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
show_box<span class="token punctuation">(</span>input_box<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
show_points<span class="token punctuation">(</span>input_point<span class="token punctuation">,</span> input_label<span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/fc/f1/5WnaxmoS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_325"></a>方法五：多个方框同时输入，进行多目标分割</h4> 
<p>通过同时输入多个方框，可用于分割不同方框中的目标。下面是对车的不同目标的分割效果。</p> 
<pre><code class="prism language-python">input_boxes <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token number">75</span><span class="token punctuation">,</span> <span class="token number">275</span><span class="token punctuation">,</span> <span class="token number">1725</span><span class="token punctuation">,</span> <span class="token number">850</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">425</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">700</span><span class="token punctuation">,</span> <span class="token number">875</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">1375</span><span class="token punctuation">,</span> <span class="token number">550</span><span class="token punctuation">,</span> <span class="token number">1650</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token number">1240</span><span class="token punctuation">,</span> <span class="token number">675</span><span class="token punctuation">,</span> <span class="token number">1400</span><span class="token punctuation">,</span> <span class="token number">750</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span> device<span class="token operator">=</span>predictor<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">transformed_boxes <span class="token operator">=</span> predictor<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>apply_boxes_torch<span class="token punctuation">(</span>input_boxes<span class="token punctuation">,</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
masks<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _ <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict_torch<span class="token punctuation">(</span>
    point_coords<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    point_labels<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    boxes<span class="token operator">=</span>transformed_boxes<span class="token punctuation">,</span>
    multimask_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">masks<span class="token punctuation">.</span>shape  <span class="token comment"># (batch_size) x (num_predicted_masks_per_input) x H x W</span>
</code></pre> 
<pre><code>torch.Size([4, 1, 1200, 1800])
</code></pre> 
<pre><code class="prism language-python">plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
<span class="token keyword">for</span> mask <span class="token keyword">in</span> masks<span class="token punctuation">:</span>
    show_mask<span class="token punctuation">(</span>mask<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> random_color<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> box <span class="token keyword">in</span> input_boxes<span class="token punctuation">:</span>
    show_box<span class="token punctuation">(</span>box<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> plt<span class="token punctuation">.</span>gca<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/10/41/LNrwyW3T_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_369"></a>总结</h2> 
<p>以上便是SAM模型的使用方法，可以通过不同的提示方式得到不同的分割结果。总体来说，效果还是很不错的，关键是居然还可以在CPU环境下快速运行。感兴趣的小伙伴，也可以自己试试哦~</p> 
<p><strong>如果文章对你有帮助，感谢点赞+关注！</strong></p> 
<blockquote> 
 <p><strong>关注下方名片GZH：阿旭算法与机器学习，回复：【SAM】即可获取SAM相关代码、论文、预训练模型、使用方法文档等，欢迎共同学习交流</strong></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/47d53e6f5fbfed67dd027d23ae8ef026/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43;实现：学生管理系统（详细解析）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/af272119b59278b9f881120b99037ed2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CSS实现三角形的四种方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>