<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Web 播放 RTSP(Webrtc方案) - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/c03a965e319ce632bddbf404a613cc66/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Web 播放 RTSP(Webrtc方案)">
  <meta property="og:description" content="Web 播放 RTSP(Webrtc方案) 需求背景 项目需要在 web 上播放海康摄像头，这个在各种智慧类应用上应该是常见需求，在前几年的时候也有这个需求，那时候通过旧版本谷歌浏览器可以直接播放 rtmp 解决了问题；现在谷歌浏览器已经不再支持，项目上又有这个需求，打算好好处理下。大概需求内容项目有多个车，每个车有多个摄像头，web对这些摄像头进行管理呈现。
Web 播放视频流方案 web 播放视频流有多种方案有 HLS、flv、webrtc 等等，我们这里选用 webrtc 方案，webrtc 播放视频是网页原生支持的音视频通信技术，对比其他其他方案有低时延等优点
Webrtc 实践 海康摄像头推送 rtsp 流，web 播放 webrtc，搜索 rtsp 转 webrtc 发现开源项目 https://github.com/deepch/RTSPtoWebRTC，golang 编写，参照项目说明，项目跑起来很简单，代码仓库拉下来运行就行了，RTSPtoWebRTC 项目自带 http 代理了简单 web 页面
按照项目说明将 config 修改为本地海康摄像头地址，重新运行验证，摄像头就播放出来了
自身项目为前后端分离，开始迁移该项目的 webrtc 代码到自己的项目中，编写一个 Webrtc 组件
export function WebRtcPlayer(props: { suuid: string, url: string }) { let ref = useRef&lt;HTMLVideoElement&gt;(); useEffect(() =&gt; { let { suuid, url } = props; let stream = new MediaStream(); const pc = new RTCPeerConnection(); pc.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-13T10:27:34+08:00">
    <meta property="article:modified_time" content="2024-06-13T10:27:34+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Web 播放 RTSP(Webrtc方案)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Web__RTSPWebrtc_1"></a>Web 播放 RTSP(Webrtc方案)</h2> 
<h2><a id="_3"></a>需求背景</h2> 
<p>项目需要在 web 上播放海康摄像头，这个在各种智慧类应用上应该是常见需求，在前几年的时候也有这个需求，那时候通过旧版本谷歌浏览器可以直接播放 rtmp 解决了问题；现在谷歌浏览器已经不再支持，项目上又有这个需求，打算好好处理下。大概需求内容项目有多个车，每个车有多个摄像头，web对这些摄像头进行管理呈现。</p> 
<h2><a id="Web__7"></a>Web 播放视频流方案</h2> 
<p>web 播放视频流有多种方案有 HLS、flv、webrtc 等等，我们这里选用 webrtc 方案，webrtc 播放视频是网页原生支持的音视频通信技术，对比其他其他方案有低时延等优点</p> 
<h2><a id="Webrtc__11"></a>Webrtc 实践</h2> 
<ol><li> <p>海康摄像头推送 rtsp 流，web 播放 webrtc，搜索 rtsp 转 webrtc 发现开源项目 <a href="https://github.com/deepch/RTSPtoWebRTC">https://github.com/deepch/RTSPtoWebRTC</a>，golang 编写，参照项目说明，项目跑起来很简单，代码仓库拉下来运行就行了，<code>RTSPtoWebRTC</code> 项目自带 http 代理了简单 web 页面</p> </li><li> <p>按照项目说明将 config 修改为本地海康摄像头地址，重新运行验证，摄像头就播放出来了<br> <img src="https://images2.imgbox.com/ca/13/FDxG3TOW_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bf/eb/3fHlHPbj_o.png" alt="[图片]"></p> </li><li> <p>自身项目为前后端分离，开始迁移该项目的 webrtc 代码到自己的项目中，编写一个 Webrtc 组件</p> </li></ol> 
<pre><code class="prism language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">WebRtcPlayer</span><span class="token punctuation">(</span>props<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> suuid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> ref <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>HTMLVideoElement<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> <span class="token punctuation">{<!-- --></span> suuid<span class="token punctuation">,</span> url <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>

        <span class="token keyword">let</span> stream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> pc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pc<span class="token punctuation">.</span><span class="token function-variable function">onnegotiationneeded</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">let</span> offer <span class="token operator">=</span> <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> pc<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>offer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'suuid'</span><span class="token punctuation">,</span> suuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token function">btoa</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>localDescription<span class="token punctuation">.</span>sdp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token constant">APP_CONFIG</span><span class="token punctuation">.</span>rtc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/stream/receiver/</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span> suuid<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
                method<span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
                body<span class="token operator">:</span> formData
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resp <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> resp<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RTCSessionDescription</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                        type<span class="token operator">:</span> <span class="token string">'answer'</span><span class="token punctuation">,</span>
                        sdp<span class="token operator">:</span> <span class="token function">atob</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        pc<span class="token punctuation">.</span><span class="token function-variable function">ontrack</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            stream<span class="token punctuation">.</span><span class="token function">addTrack</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>track<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ref<span class="token punctuation">.</span>current<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> stream<span class="token punctuation">;</span>
            <span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>streams<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">' track is delivered'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        pc<span class="token punctuation">.</span><span class="token function-variable function">oniceconnectionstatechange</span> <span class="token operator">=</span> e <span class="token operator">=&gt;</span> <span class="token function">log</span><span class="token punctuation">(</span>pc<span class="token punctuation">.</span>iceConnectionState<span class="token punctuation">)</span>

        <span class="token keyword">let</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> msg <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// document.getElementById('div').innerHTML += msg + '&lt;br&gt;'</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//新增加的http接口</span>
        <span class="token keyword">let</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'suuid'</span><span class="token punctuation">,</span> suuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token constant">APP_CONFIG</span><span class="token punctuation">.</span>rtc<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/codec</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            method<span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
            body<span class="token operator">:</span> formData
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resp <span class="token operator">=&gt;</span> resp<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span>data <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>el <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                    pc<span class="token punctuation">.</span><span class="token function">addTransceiver</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">'direction'</span><span class="token operator">:</span> <span class="token string">'sendrecv'</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                pc<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RTCSessionDescription</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    type<span class="token operator">:</span> <span class="token string">'answer'</span><span class="token punctuation">,</span>
                    sdp<span class="token operator">:</span> <span class="token function">atob</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">//demo中使用的接口</span>
        <span class="token comment">// fetch("http://127.0.0.1:8083/stream/codec/" + suuid)</span>
        <span class="token comment">//     .then(resp =&gt; resp.json())</span>
        <span class="token comment">//     .then(data =&gt; {<!-- --></span>
        <span class="token comment">//         (data as any[]).forEach(el =&gt; {<!-- --></span>
        <span class="token comment">//             pc.addTransceiver(el.Type, {<!-- --></span>
        <span class="token comment">//                 'direction': 'sendrecv'</span>
        <span class="token comment">//             })</span>
        <span class="token comment">//         })</span>
        <span class="token comment">//         pc.setRemoteDescription(new RTCSessionDescription({<!-- --></span>
        <span class="token comment">//             type: 'answer',</span>
        <span class="token comment">//             sdp: atob(data)</span>
        <span class="token comment">//         }))</span>
        <span class="token comment">//     }).catch(e =&gt; {<!-- --></span>
        <span class="token comment">//         console.warn(e);</span>
        <span class="token comment">//     })</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>video ref<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>ref<span class="token punctuation">}</span> style<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> width<span class="token operator">:</span> <span class="token string">"600px"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> autoPlay muted controls <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其中 <code>fetch(${APP_CONFIG.rtc}/stream/receiver/ + suuid</code> 和 <code>fetch(http://127.0.0.1:8083/stream/codec/ + suuid)</code> 是项目 demo 中使用到的接口，项目跑起，可以在项目里看到摄像头，初步完成。</p> 
<ol><li> <p>观察项目代码，发现：</p> 
  <ol><li>config 配置了 rtsp 流地址信息，<code>on_demand</code> 即是否是未请求也处理 rtsp</li><li>http 接口用于信令交换（<code>/stream/codec/</code> 用于查询配置返回 codec 信息，<code>/stream/receiver/</code> 用于发起一个协程 <code> go RTSPWorkerLoop</code>）</li></ol> </li><li> <p>我的项目是内网环境且 rtsp 需要预先设置好改动就要重启有点麻烦，于是做出修改：</p> 
  <ol><li>config 修改配置 <code>on_demand</code> 为 false，网页未请求则不处理 rtsp，满足大量 rtsp 配置选播放</li><li>去掉 ice 配置，ice 配置是一个公网环境用的，内网没有</li><li>新增 http 接口动态传入设备的摄像头配置，传递参数 key 和 rtsp 地址，如果 key 在配置里不存在则写入 config，其他和 <code>/stream/codec/</code> 代码一致</li></ol> </li></ol> 
<p>完成修改后运行项目播放 ok，断网播放 ok，本地服务器 docker 部署再次测试发现没法播放，连接断了 <code>WritePacket WebRTC Client Offline</code>，</p> 
<ol start="6"><li>搜索问题，发现项目 issue：<a href="https://github.com/deepch/RTSPtoWebRTC/issues/183">https://github.com/deepch/RTSPtoWebRTC/issues/183</a>，修改 docker 配置 network:"host"解决问题，再次测试播放 ok</li></ol> 
<p><img src="https://images2.imgbox.com/eb/ca/bFwG8M7R_o.png" alt="外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传"></p> 
<ol start="7"><li>项目部署 RTSPtoWebRTC 能播通信链路 ok，基本可以在项目上使用，当然项目 RTSPtoWebRTC 本身是 demo 型，一些细节未处理，比如 <code>/stream/codec/</code> 接口内部在 <code>coGe(suuid string) []av.CodecData</code> 方法里直接 100 次循环，但是并未完成视频的等待，导致在后续流程 sps()会报错 <code>index out of range</code>，这个可以修改等待代码解决</li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/29299034f1454248a7f418a7b472a6c4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">浅谈配置元件之HTTP请求默认值</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4487214334f559a9b0ca3cce102be813/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">uniapp条件编辑语法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>