<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>数据仓库哈哈 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/6da709b153a0d30a05f9962b95564b7e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="数据仓库哈哈">
  <meta property="og:description" content="数据仓库 基本概念数据库（database）和数据仓库（Data Warehouse）的异同 整体架构分层架构方法论ER模型（建模理论）维度模型 何为分层第一层：数据源（ODS ER模型）设计要点日志表业务表1活动信息表（全量表）2活动规则表（全量表）3一级品类表（全量表）4二级品类表（全量表）5三级品类表（全量表）6编码字典表（全量表）7省份表（全量表）8地区表（全量表）9品牌表（全量表）10购物车表（全量表）11优惠券信息表（全量表）12商品平台属性表（全量表）13商品表（全量表）14商品销售属性值表（全量表）15SPU表（全量表）16营销坑位表（全量表）17营销渠道表（全量表）18购物车表（增量表）19评论表（增量表）20优惠券领用表（增量表）21收藏表（增量表）22订单明细表（增量表）23订单明细活动关联表（增量表）24订单明细优惠券关联表（增量表）25订单表（增量表）26退单表（增量表）27订单状态流水表（增量表）28支付表（增量表）29退款表（增量表）30用户表（增量表）31数据装载脚本 第二层：数据加工（DWD data warehouse detail）事实表设计（事务型事实表） 事务的原子性事实表设计（周期型快照事实表） 从当前表中取数据后再放回去需考虑去重问题，增加retry的容错性事实表设计（累积型快照事实表）分区策略 第三层：数据统计（DWS data warehouse summary 提高性能的关键层）第四层：数据分析（ADS application data service）表的设计（要点）优化（假）1流量主题1.1各渠道流量统计 第五层：共通层（DIM dimension）设计要点是否创建表维度表设计1商品维度表2优惠券维度表3活动（规则）维度表4地区维度表5营销坑位维度表6营销渠道维度表7日期维度表8用户维度表（拉链（压缩）表） CTE : 共通表表达式拉链表设计任务调度器 基本概念 本质是对数据进行加工处理后对外提供数据服务
数据库（database）和数据仓库（Data Warehouse）的异同 数据库用于存储企业基础，核心的业务数据从数据来源进行区分 数据库：企业的业务系统数据仓库：数据库（后台的后台） 从数据存储进行区分 数据库：存储的目的为了可以快速进行数据查询操作
索引 ： SQL
存储方式：行式存储
数据量：不能存储海量数据数据仓库：存储的目的为了可以快速进行统计分析
索引 ： 没有索引（k-v）
存储方式：列式存储
数据量：必须存储海量数据 从数据价值进行区分 数据库 ：保障企业业务系统的执行
事务（回滚）数据仓库 ：统计分析的结果可以为企业的经营决策提供数据依据
没有事务
数据仓库不是数据流转的终点 ：可视化才是数据的终点 整体架构 Spark : 数据的统计分析
数据仓库：数据的统计分析
数据仓库不能直接对接MySQL数据库作为数据源！
数据库不是为了数据仓库服务的。数据仓库如果直接对象数据库，会导致数据库的性能降低数据库不能存储海量数据。数据仓库必须获取海量数据数据库采用行式存储。数据仓库为了提高统计分析效率，所以需要列式存储 数据仓库应该增加自己的数据源
数据仓库的数据源中的数据应该和MySQL数据库中的数据保持一致
数据仓库的数据源应该不断融合（汇总）MySQL数据库中的数据
将数据库的数据汇总的到数据仓库数据源的过程，一般称之为数据同步，也称之为数据采集
分层架构 数据仓库计算周期为1天：1天统计一回数据结果
方法论 ER模型（建模理论） ER（Entity Relationship）（实体关系）模型
采用面向对象的方式设计表（和Java一样）">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-10T21:15:04+08:00">
    <meta property="article:modified_time" content="2024-07-10T21:15:04+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">数据仓库哈哈</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>数据仓库</h4> 
 <ul><li><a href="#_2" rel="nofollow">基本概念</a></li><li><ul><li><a href="#databaseData_Warehouse_4" rel="nofollow">数据库（database）和数据仓库（Data Warehouse）的异同</a></li></ul> 
  </li><li><a href="#_27" rel="nofollow">整体架构</a></li><li><a href="#_45" rel="nofollow">分层架构</a></li><li><ul><li><a href="#_47" rel="nofollow">方法论</a></li><li><ul><li><a href="#ER_48" rel="nofollow">ER模型（建模理论）</a></li><li><a href="#_57" rel="nofollow">维度模型</a></li></ul> 
   </li><li><a href="#_71" rel="nofollow">何为分层</a></li><li><a href="#ODS_ER_83" rel="nofollow">第一层：数据源（ODS ER模型）</a></li><li><ul><li><a href="#_103" rel="nofollow">设计要点</a></li><li><a href="#_107" rel="nofollow">日志表</a></li><li><a href="#_201" rel="nofollow">业务表</a></li><li><ul><li><a href="#1_202" rel="nofollow">1活动信息表（全量表）</a></li><li><a href="#2_224" rel="nofollow">2活动规则表（全量表）</a></li><li><a href="#3_248" rel="nofollow">3一级品类表（全量表）</a></li><li><a href="#4_266" rel="nofollow">4二级品类表（全量表）</a></li><li><a href="#5_285" rel="nofollow">5三级品类表（全量表）</a></li><li><a href="#6_304" rel="nofollow">6编码字典表（全量表）</a></li><li><a href="#7_323" rel="nofollow">7省份表（全量表）</a></li><li><a href="#8_345" rel="nofollow">8地区表（全量表）</a></li><li><a href="#9_363" rel="nofollow">9品牌表（全量表）</a></li><li><a href="#10_382" rel="nofollow">10购物车表（全量表）</a></li><li><a href="#11_408" rel="nofollow">11优惠券信息表（全量表）</a></li><li><a href="#12_439" rel="nofollow">12商品平台属性表（全量表）</a></li><li><a href="#13_461" rel="nofollow">13商品表（全量表）</a></li><li><a href="#14_487" rel="nofollow">14商品销售属性值表（全量表）</a></li><li><a href="#15SPU_510" rel="nofollow">15SPU表（全量表）</a></li><li><a href="#16_531" rel="nofollow">16营销坑位表（全量表）</a></li><li><a href="#17_551" rel="nofollow">17营销渠道表（全量表）</a></li><li><a href="#18_569" rel="nofollow">18购物车表（增量表）</a></li><li><a href="#19_597" rel="nofollow">19评论表（增量表）</a></li><li><a href="#20_624" rel="nofollow">20优惠券领用表（增量表）</a></li><li><a href="#21_650" rel="nofollow">21收藏表（增量表）</a></li><li><a href="#22_674" rel="nofollow">22订单明细表（增量表）</a></li><li><a href="#23_705" rel="nofollow">23订单明细活动关联表（增量表）</a></li><li><a href="#24_729" rel="nofollow">24订单明细优惠券关联表（增量表）</a></li><li><a href="#25_753" rel="nofollow">25订单表（增量表）</a></li><li><a href="#26_794" rel="nofollow">26退单表（增量表）</a></li><li><a href="#27_822" rel="nofollow">27订单状态流水表（增量表）</a></li><li><a href="#28_843" rel="nofollow">28支付表（增量表）</a></li><li><a href="#29_872" rel="nofollow">29退款表（增量表）</a></li><li><a href="#30_901" rel="nofollow">30用户表（增量表）</a></li><li><a href="#31_930" rel="nofollow">31数据装载脚本</a></li></ul> 
   </li></ul> 
   </li><li><a href="#DWD_data_warehouse_detail_1074" rel="nofollow">第二层：数据加工（DWD data warehouse detail）</a></li><li><ul><li><ul><li><a href="#_1080" rel="nofollow">事实表设计（事务型事实表）</a></li></ul> 
    </li><li><a href="#_1129" rel="nofollow">事务的原子性</a></li><li><a href="#_1134" rel="nofollow">事实表设计（周期型快照事实表）</a></li></ul> 
   </li><li><a href="#retry_1148" rel="nofollow">从当前表中取数据后再放回去需考虑去重问题，增加retry的容错性</a></li><li><ul><li><a href="#_1151" rel="nofollow">事实表设计（累积型快照事实表）</a></li><li><a href="#_1162" rel="nofollow">分区策略</a></li></ul> 
   </li><li><a href="#DWS_data_warehouse_summary__1172" rel="nofollow">第三层：数据统计（DWS data warehouse summary 提高性能的关键层）</a></li><li><a href="#ADS_application_data_service_1183" rel="nofollow">第四层：数据分析（ADS application data service）</a></li><li><ul><li><a href="#_1188" rel="nofollow">表的设计（要点）</a></li><li><a href="#_1199" rel="nofollow">优化（假）</a></li><li><a href="#1_1205" rel="nofollow">1流量主题</a></li><li><ul><li><a href="#11_1206" rel="nofollow">1.1各渠道流量统计</a></li></ul> 
   </li></ul> 
   </li><li><a href="#DIM_dimension_1230" rel="nofollow">第五层：共通层（DIM dimension）</a></li><li><ul><li><a href="#_1234" rel="nofollow">设计要点</a></li><li><a href="#_1240" rel="nofollow">是否创建表</a></li><li><a href="#_1248" rel="nofollow">维度表设计</a></li><li><ul><li><a href="#1_1272" rel="nofollow">1商品维度表</a></li><li><a href="#2_1429" rel="nofollow">2优惠券维度表</a></li><li><a href="#3_1541" rel="nofollow">3活动（规则）维度表</a></li><li><a href="#4_1636" rel="nofollow">4地区维度表</a></li><li><a href="#5_1691" rel="nofollow">5营销坑位维度表</a></li><li><a href="#6_1725" rel="nofollow">6营销渠道维度表</a></li><li><a href="#7_1756" rel="nofollow">7日期维度表</a></li><li><a href="#8_1811" rel="nofollow">8用户维度表（拉链（压缩）表）</a></li></ul> 
   </li></ul> 
   </li><li><a href="#CTE___1957" rel="nofollow">CTE : 共通表表达式</a></li><li><a href="#_1982" rel="nofollow">拉链表设计</a></li><li><a href="#_2006" rel="nofollow">任务调度器</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>基本概念</h2> 
<p>本质是对数据进行加工处理后对外提供数据服务</p> 
<h3><a id="databaseData_Warehouse_4"></a>数据库（database）和数据仓库（Data Warehouse）的异同</h3> 
<ol><li>数据库用于存储企业基础，核心的业务数据</li><li>从数据来源进行区分 
  <ul><li>数据库：企业的业务系统</li><li>数据仓库：数据库（后台的后台）</li></ul> </li><li>从数据存储进行区分 
  <ul><li>数据库：存储的目的为了可以快速进行数据查询操作<br> 索引 ： SQL<br> 存储方式：行式存储<br> 数据量：不能存储海量数据</li><li>数据仓库：存储的目的为了可以快速进行统计分析<br> 索引 ： 没有索引（k-v）<br> 存储方式：列式存储<br> 数据量：必须存储海量数据</li></ul> </li><li>从数据价值进行区分 
  <ul><li>数据库 ：保障企业业务系统的执行<br> 事务（回滚）</li><li>数据仓库 ：统计分析的结果可以为企业的经营决策提供数据依据<br> 没有事务<br> 数据仓库不是数据流转的终点 ：可视化才是数据的终点</li></ul> </li></ol> 
<p><img src="https://images2.imgbox.com/30/95/RfiCPxD8_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_27"></a>整体架构</h2> 
<p>Spark : 数据的统计分析<br> <img src="https://images2.imgbox.com/60/08/nSYa21ma_o.png" alt="在这里插入图片描述"><br> 数据仓库：数据的统计分析<br> <img src="https://images2.imgbox.com/0a/61/5DjSizcv_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f6/42/WYJJCq1V_o.png" alt="在这里插入图片描述"><br> 数据仓库不能直接对接MySQL数据库作为数据源！</p> 
<ol><li>数据库不是为了数据仓库服务的。数据仓库如果直接对象数据库，会导致数据库的性能降低</li><li>数据库不能存储海量数据。数据仓库必须获取海量数据</li><li>数据库采用行式存储。数据仓库为了提高统计分析效率，所以需要列式存储</li></ol> 
<p>数据仓库应该增加自己的数据源</p> 
<p><img src="https://images2.imgbox.com/86/3f/GHZ6f9ex_o.png" alt="在这里插入图片描述"><br> 数据仓库的数据源中的数据应该和MySQL数据库中的数据保持一致<br> 数据仓库的数据源应该不断融合（汇总）MySQL数据库中的数据<br> 将数据库的数据汇总的到数据仓库数据源的过程，一般称之为数据同步，也称之为数据采集<br> <img src="https://images2.imgbox.com/8b/ee/hptgEAvJ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_45"></a>分层架构</h2> 
<p>数据仓库计算周期为1天：1天统计一回数据结果</p> 
<h3><a id="_47"></a>方法论</h3> 
<h4><a id="ER_48"></a>ER模型（建模理论）</h4> 
<p>ER（Entity Relationship）（实体关系）模型<br> 采用面向对象的方式设计表（和Java一样）</p> 
<ul><li>将对象理解为表</li><li>将对象之间的关系理解为表之间的关系</li></ul> 
<p><a href="http://t.csdnimg.cn/NawIA" rel="nofollow">超详细内容（带图）看这里</a></p> 
<h4><a id="_57"></a>维度模型</h4> 
<p>事实 ：行为所产生的事情（数据）<br> 维度：分析数据的角度（状态）</p> 
<p><a href="http://t.csdnimg.cn/2iMWQ" rel="nofollow">超详细内容（带图）看这里</a></p> 
<h3><a id="_71"></a>何为分层</h3> 
<p>Spark中的方法可能会含有shuffle功能，<br> shuffle操作会将完整的计算流程一分为二，会分为2个阶段（Stage）,前面一个阶段称之为Map阶段，后面的阶段称之为Reduce阶段，<br> shuffle中前一个阶段的任务不执行完，后面的阶段的任务不允许执行的，<br> Task Pool(任务池) - 任务调度（FIFO, FAIR）。</p> 
<p><strong>数据仓库</strong>也存在同样的问题，将整个计算流程分为了4段，<br> 在数据仓库中不称之为段，一般称之为层，每一层有特殊的含义和特殊的功能<br> 前面一层的数据没有处理完，后面一层的数据没有办法处理</p> 
<p><img src="https://images2.imgbox.com/7c/fc/SVSplZpa_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="ODS_ER_83"></a>第一层：数据源（ODS ER模型）</h3> 
<p>功能：</p> 
<ul><li> <p>为整个数据仓库作为数据来源</p> </li><li> <p>不断汇总业务数据和日志数据<br> 数据量非常大：海量数据 -&gt; 考虑资源问题：使用最少的资源存储最多的资源（考虑使用压缩算法gzip、lzo、snappy）；考虑网络资源：考虑传输方式，数据尽可能不变（格式、压缩方式、存储方式）</p> <p><strong>统计</strong>本质上就是对行为数据进行统计<br> <strong>分析</strong>本质上就是站在什么角度对统计结果进行分析</p> </li></ul> 
<pre><code class="prism language-sql"><span class="token comment">-- ODS</span>
    <span class="token comment">-- 1. ODS层表建模方式：ER模型</span>
    <span class="token comment">-- 2. 数据格式不变，数据压缩方式 gzip</span>
    <span class="token comment">-- 3. 表名</span>
        <span class="token comment">-- 分层标记（ods_） + 同步数据的表名 + 增量/全量（inc/full）</span>
            <span class="token comment">-- 增量，全量</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/48/f5/suSATf6I_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_103"></a>设计要点</h4> 
<p>（1）ODS层的表结构设计依托于从业务系统同步过来的数据结构。<br> （2）ODS层要保存全部历史数据，故其压缩格式应选择压缩比较高的，此处选择gzip。<br> （3）ODS层表名的命名规范为：ods_表名_单分区增量全量标识（inc/full）。</p> 
<h4><a id="_107"></a>日志表</h4> 
<p>1）建表语句</p> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_log_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_log_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>common<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>ar :STRING<span class="token punctuation">,</span>
        ba :STRING<span class="token punctuation">,</span>
        ch :STRING<span class="token punctuation">,</span>
        is_new :STRING<span class="token punctuation">,</span>
        md :STRING<span class="token punctuation">,</span>
        mid :STRING<span class="token punctuation">,</span>
        os :STRING<span class="token punctuation">,</span>
        sid :STRING<span class="token punctuation">,</span>
        uid :STRING<span class="token punctuation">,</span>
        vc :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'公共信息'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>page<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>during_time :STRING<span class="token punctuation">,</span>
        item :STRING<span class="token punctuation">,</span>
        item_type :STRING<span class="token punctuation">,</span>
        last_page_id :STRING<span class="token punctuation">,</span>
        page_id :STRING<span class="token punctuation">,</span>
        from_pos_id :STRING<span class="token punctuation">,</span>
        from_pos_seq :STRING<span class="token punctuation">,</span>
        refer_id :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'页面信息'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>actions<span class="token punctuation">`</span></span> ARRAY<span class="token operator">&lt;</span>STRUCT<span class="token operator">&lt;</span>action_id:STRING<span class="token punctuation">,</span>
        item:STRING<span class="token punctuation">,</span>
        item_type:STRING<span class="token punctuation">,</span>
        ts:<span class="token keyword">BIGINT</span><span class="token operator">&gt;&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'动作信息'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>displays<span class="token punctuation">`</span></span> ARRAY<span class="token operator">&lt;</span>STRUCT<span class="token operator">&lt;</span>display_type :STRING<span class="token punctuation">,</span>
        item :STRING<span class="token punctuation">,</span>
        item_type :STRING<span class="token punctuation">,</span>
        <span class="token identifier"><span class="token punctuation">`</span>pos_seq<span class="token punctuation">`</span></span> :STRING<span class="token punctuation">,</span>
        pos_id :STRING<span class="token operator">&gt;&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'曝光信息'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>start<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>entry :STRING<span class="token punctuation">,</span>
        first_open :<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
        loading_time :<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
        open_ad_id :<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
        open_ad_ms :<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
        open_ad_skip_ms :<span class="token keyword">BIGINT</span><span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'启动信息'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>err<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>error_code:<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
            msg:STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'错误信息'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span>  <span class="token keyword">COMMENT</span> <span class="token string">'时间戳'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动信息表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_log_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2）数据装载</p> 
<pre><code class="prism language-sql"><span class="token keyword">load</span> <span class="token keyword">data</span> inpath <span class="token string">'/origin_data/gmall/log/topic_log/2022-06-08'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> ods_log_inc <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>3）每日数据装载脚本<br> （1）在hadoop102的/home/atguigu/bin目录下创建hdfs_to_ods_log.sh</p> 
<pre><code class="prism language-sql">vim hdfs_to_ods_log<span class="token punctuation">.</span>sh
</code></pre> 
<p>（2）编写如下内容</p> 
<pre><code class="prism language-sql"><span class="token comment">#!/bin/bash</span>

<span class="token comment"># 定义变量方便修改</span>
APP<span class="token operator">=</span>gmall

<span class="token comment"># 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>n <span class="token string">"$1"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
   do_date<span class="token operator">=</span>$<span class="token number">1</span>
<span class="token keyword">else</span>
   do_date<span class="token operator">=</span><span class="token identifier"><span class="token punctuation">`</span>date -d "-1 day" +%F<span class="token punctuation">`</span></span>
fi

echo <span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span> 日志日期为 $do_date <span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span><span class="token operator">=</span>
<span class="token keyword">sql</span><span class="token operator">=</span><span class="token string">"
load data inpath '/origin_data/$APP/log/topic_log/$do_date' into table ${APP}.ods_log_inc partition(dt='$do_date');
"</span>
hive <span class="token operator">-</span>e <span class="token string">"$sql"</span>
</code></pre> 
<p>（3）增加脚本执行权限</p> 
<pre><code class="prism language-sql">chmod <span class="token operator">+</span>x hdfs_to_ods_log<span class="token punctuation">.</span>sh
</code></pre> 
<p>（4）脚本用法</p> 
<pre><code class="prism language-sql"> hdfs_to_ods_log<span class="token punctuation">.</span>sh <span class="token number">2022</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">08</span>
</code></pre> 
<h4><a id="_201"></a>业务表</h4> 
<h5><a id="1_202"></a>1活动信息表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_activity_info_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_activity_info_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>              STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动id'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_name<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_desc<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动描述'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>start_time<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'开始时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>end_time<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'结束时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动信息表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_activity_info_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="2_224"></a>2活动规则表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_activity_rule_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_activity_rule_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                  STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_type<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span></span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减金额'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span></span>     <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减件数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span></span>    <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span></span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠折扣'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_level<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠级别'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动规则表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_activity_rule_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="3_248"></a>3一级品类表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_category1_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_category1_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>               STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span>             STRING <span class="token keyword">COMMENT</span> <span class="token string">'分类名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'一级品类表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_category1_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="4_266"></a>4二级品类表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_category2_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_category2_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>               STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span>             STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级分类名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>category1_id<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级分类编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'二级品类表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_category2_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="5_285"></a>5三级品类表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_category3_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_category3_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>               STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span>             STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级分类名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>category2_id<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级分类编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'三级品类表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_category3_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="6_304"></a>6编码字典表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_dic_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_dic_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>dic_code<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>dic_name<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'编码名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>parent_code<span class="token punctuation">`</span></span>  STRING <span class="token keyword">COMMENT</span> <span class="token string">'父编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>  STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建日期'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改日期'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'编码字典表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_dic_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="7_323"></a>7省份表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_province_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_province_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>              STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span>            STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>region_id<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>area_code<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>iso_code<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'旧版国际标准地区编码，供可视化使用'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>iso_3166_2<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'新版国际标准地区编码，供可视化使用'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'省份表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_province_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="8_345"></a>8地区表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_region_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_region_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>               STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>region_name<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'地区表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_region_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="9_363"></a>9品牌表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_base_trademark_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_base_trademark_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>               STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>logo_url<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌LOGO的图片路径'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'品牌表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_base_trademark_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="10_382"></a>10购物车表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_cart_info_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_cart_info_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>            STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU_ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>cart_price<span class="token punctuation">`</span></span>   <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'放入购物车时价格'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_num<span class="token punctuation">`</span></span>      <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'数量'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>img_url<span class="token punctuation">`</span></span>      <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品图片地址'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU名称 (冗余)'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>is_checked<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否被选中'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>  STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>is_ordered<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否已经下单'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>order_time<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'下单时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'购物车全量表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_cart_info_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="11_408"></a>11优惠券信息表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_coupon_info_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_coupon_info_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                 STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>coupon_name<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>coupon_type<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'购物券类型 1 现金券 2 折扣券 3 满减券 4 满件打折券'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span></span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满额数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span></span>    <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满件数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span></span>   <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'减免金额'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span></span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'折扣'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>range_type<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'范围类型 1、商品(SPUID) 2、品类(三级品类id) 3、品牌'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>limit_num<span class="token punctuation">`</span></span>        <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最多领用次数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>taken_count<span class="token punctuation">`</span></span>      <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'已领用次数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>start_time<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'可以领取的开始时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>end_time<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'可以领取的结束时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>range_desc<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'范围描述'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券信息表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_coupon_info_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="12_439"></a>12商品平台属性表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_sku_attr_value_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_sku_attr_value_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>              STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>attr_id<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>value_id<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性值ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU_ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>attr_name<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>value_name<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'平台属性值名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品平台属性表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_sku_attr_value_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="13_461"></a>13商品表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_sku_info_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_sku_info_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU_ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span></span>           STRING <span class="token keyword">COMMENT</span> <span class="token string">'SPU_ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span>            <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'价格'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_desc<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU规格描述'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>weight<span class="token punctuation">`</span></span>           <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'重量'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span></span>             STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级品类ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_default_img<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'默认显示图片地址'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>is_sale<span class="token punctuation">`</span></span>           STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否在售'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_sku_info_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="14_487"></a>14商品销售属性值表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_sku_sale_attr_value_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_sku_sale_attr_value_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                      STRING <span class="token keyword">COMMENT</span> <span class="token string">'编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_id<span class="token punctuation">`</span></span>                 STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU_ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span></span>                 STRING <span class="token keyword">COMMENT</span> <span class="token string">'SPU_ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sale_attr_value_id<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性值ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sale_attr_id<span class="token punctuation">`</span></span>          STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sale_attr_name<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sale_attr_value_name<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'销售属性值名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>            STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>           STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品销售属性值表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_sku_sale_attr_value_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="15SPU_510"></a>15SPU表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_spu_info_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_spu_info_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>              STRING <span class="token keyword">COMMENT</span> <span class="token string">'SPU_ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'SPU名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>description<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'描述信息'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span></span>  STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级品类ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span></span>           STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'SPU表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_spu_info_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="16_531"></a>16营销坑位表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_promotion_pos_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_promotion_pos_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                   STRING <span class="token keyword">COMMENT</span> <span class="token string">'营销坑位ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>pos_location<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'营销坑位位置'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>pos_type<span class="token punctuation">`</span></span>            STRING <span class="token keyword">COMMENT</span> <span class="token string">'营销坑位类型：banner,宫格,列表,瀑布'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>promotion_type<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'营销类型：算法、固定、搜索'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'营销坑位表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_promotion_pos_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="17_551"></a>17营销渠道表（全量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_promotion_refer_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_promotion_refer_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                  STRING <span class="token keyword">COMMENT</span> <span class="token string">'外部营销渠道ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>refer_name<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'外部营销渠道名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'营销渠道表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    <span class="token boolean">NULL</span> DEFINED <span class="token keyword">AS</span> <span class="token string">''</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_promotion_refer_full/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="18_569"></a>18购物车表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_cart_info_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_cart_info_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        user_id :STRING<span class="token punctuation">,</span>
        sku_id :STRING<span class="token punctuation">,</span>
        cart_price :<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        sku_num :<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
        img_url :STRING<span class="token punctuation">,</span>
        sku_name :STRING<span class="token punctuation">,</span>
        is_checked :STRING<span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span>
        operate_time :STRING<span class="token punctuation">,</span>
        is_ordered :STRING<span class="token punctuation">,</span>
        order_time:STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'购物车增量表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_cart_info_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="19_597"></a>19评论表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_comment_info_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_comment_info_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        user_id :STRING<span class="token punctuation">,</span>
        nick_name :STRING<span class="token punctuation">,</span>
        head_img :STRING<span class="token punctuation">,</span>
        sku_id :STRING<span class="token punctuation">,</span>
        spu_id :STRING<span class="token punctuation">,</span>
        order_id :STRING<span class="token punctuation">,</span>
        appraise :STRING<span class="token punctuation">,</span>
        comment_txt :STRING<span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span>
        operate_time :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'评论表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_comment_info_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="20_624"></a>20优惠券领用表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_coupon_use_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_coupon_use_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span> 
        coupon_id :STRING<span class="token punctuation">,</span>
        user_id :STRING<span class="token punctuation">,</span>
        order_id :STRING<span class="token punctuation">,</span>
        coupon_status :STRING<span class="token punctuation">,</span>
        get_time :STRING<span class="token punctuation">,</span>
        using_time:STRING<span class="token punctuation">,</span>
        used_time :STRING<span class="token punctuation">,</span>expire_time :STRING<span class="token punctuation">,</span> 
        create_time :STRING<span class="token punctuation">,</span>
        operate_time :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券领用表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_coupon_use_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="21_650"></a>21收藏表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_favor_info_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_favor_info_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        user_id :STRING<span class="token punctuation">,</span>
        sku_id :STRING<span class="token punctuation">,</span>
        spu_id :STRING<span class="token punctuation">,</span>
        is_cancel :STRING<span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span>
        operate_time:STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>
    STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'收藏表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_favor_info_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="22_674"></a>22订单明细表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_detail_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_detail_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        order_id :STRING<span class="token punctuation">,</span>
        sku_id :STRING<span class="token punctuation">,</span>
        sku_name :STRING<span class="token punctuation">,</span>
        img_url :STRING<span class="token punctuation">,</span>
        order_price:<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        sku_num :<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span>
        source_type :STRING<span class="token punctuation">,</span>
        source_id :STRING<span class="token punctuation">,</span>
        split_total_amount:<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        split_activity_amount :<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        split_coupon_amount:<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        operate_time :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>
    STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单明细表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_detail_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="23_705"></a>23订单明细活动关联表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_detail_activity_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_detail_activity_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        order_id :STRING<span class="token punctuation">,</span>
        order_detail_id :STRING<span class="token punctuation">,</span>
        activity_id :STRING<span class="token punctuation">,</span>
        activity_rule_id :STRING<span class="token punctuation">,</span>
        sku_id:STRING<span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span> 
        operate_time :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单明细活动关联表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_detail_activity_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="24_729"></a>24订单明细优惠券关联表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_detail_coupon_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_detail_coupon_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        order_id :STRING<span class="token punctuation">,</span>
        order_detail_id :STRING<span class="token punctuation">,</span>
        coupon_id :STRING<span class="token punctuation">,</span>
        coupon_use_id :STRING<span class="token punctuation">,</span>
        sku_id:STRING<span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span> 
        operate_time :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单明细优惠券关联表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_detail_coupon_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="25_753"></a>25订单表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_info_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_info_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        consignee :STRING<span class="token punctuation">,</span>
        consignee_tel :STRING<span class="token punctuation">,</span>
        total_amount :<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        order_status :STRING<span class="token punctuation">,</span>
        user_id:STRING<span class="token punctuation">,</span>
        payment_way :STRING<span class="token punctuation">,</span>
        delivery_address :STRING<span class="token punctuation">,</span>
        order_comment :STRING<span class="token punctuation">,</span>
        out_trade_no :STRING<span class="token punctuation">,</span>
        trade_body:STRING<span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span>
        operate_time :STRING<span class="token punctuation">,</span>
        expire_time :STRING<span class="token punctuation">,</span>
        process_status :STRING<span class="token punctuation">,</span>
        tracking_no:STRING<span class="token punctuation">,</span>
        parent_order_id :STRING<span class="token punctuation">,</span>
        img_url :STRING<span class="token punctuation">,</span>
        province_id :STRING<span class="token punctuation">,</span>
        activity_reduce_amount:<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        coupon_reduce_amount :<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        original_total_amount :<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        freight_fee:<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        freight_fee_reduce :<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        refundable_time :<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_info_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="26_794"></a>26退单表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_refund_info_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_refund_info_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        user_id :STRING<span class="token punctuation">,</span>
        order_id :STRING<span class="token punctuation">,</span>
        sku_id :STRING<span class="token punctuation">,</span>
        refund_type :STRING<span class="token punctuation">,</span>
        refund_num :<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
        refund_amount:<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        refund_reason_type :STRING<span class="token punctuation">,</span>
        refund_reason_txt :STRING<span class="token punctuation">,</span>
        refund_status :STRING<span class="token punctuation">,</span>
        create_time:STRING<span class="token punctuation">,</span>
        operate_time :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退单表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_refund_info_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="27_822"></a>27订单状态流水表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_order_status_log_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_order_status_log_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        order_id :STRING<span class="token punctuation">,</span>
        order_status :STRING<span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span>
        operate_time :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单状态流水表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_order_status_log_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="28_843"></a>28支付表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_payment_info_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_payment_info_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        out_trade_no :STRING<span class="token punctuation">,</span>
        order_id :STRING<span class="token punctuation">,</span>
        user_id :STRING<span class="token punctuation">,</span>
        payment_type :STRING<span class="token punctuation">,</span>
        trade_no:STRING<span class="token punctuation">,</span>
        total_amount :<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        subject :STRING<span class="token punctuation">,</span>
        payment_status :STRING<span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span>
        callback_time:STRING<span class="token punctuation">,</span>
        callback_content :STRING<span class="token punctuation">,</span>
        operate_time :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_payment_info_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="29_872"></a>29退款表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_refund_payment_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_refund_payment_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        out_trade_no :STRING<span class="token punctuation">,</span>
        order_id :STRING<span class="token punctuation">,</span>
        sku_id :STRING<span class="token punctuation">,</span>
        payment_type :STRING<span class="token punctuation">,</span>
        trade_no :STRING<span class="token punctuation">,</span>
        total_amount:<span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        subject :STRING<span class="token punctuation">,</span>
        refund_status :STRING<span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span>
        callback_time :STRING<span class="token punctuation">,</span>
        callback_content:STRING<span class="token punctuation">,</span>
        operate_time :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_refund_payment_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="30_901"></a>30用户表（增量表）</h5> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ods_user_info_inc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ods_user_info_inc
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>type<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'变动类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>ts<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'变动时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> STRUCT<span class="token operator">&lt;</span>id :STRING<span class="token punctuation">,</span>
        login_name :STRING<span class="token punctuation">,</span>
        nick_name :STRING<span class="token punctuation">,</span>
        passwd :STRING<span class="token punctuation">,</span>
        name :STRING<span class="token punctuation">,</span>
        phone_num :STRING<span class="token punctuation">,</span>
        email:STRING<span class="token punctuation">,</span>
        head_img :STRING<span class="token punctuation">,</span>
        user_level :STRING<span class="token punctuation">,</span>
        birthday :STRING<span class="token punctuation">,</span>
        gender :STRING<span class="token punctuation">,</span>
        create_time :STRING<span class="token punctuation">,</span>
        operate_time:STRING<span class="token punctuation">,</span>
        <span class="token keyword">status</span> :STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'数据'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>old<span class="token punctuation">`</span></span>  MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>STRING<span class="token operator">&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'旧值'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    <span class="token keyword">ROW</span> FORMAT SERDE <span class="token string">'org.apache.hadoop.hive.serde2.JsonSerDe'</span>
LOCATION <span class="token string">'/warehouse/gmall/ods/ods_user_info_inc/'</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'compression.codec'</span><span class="token operator">=</span><span class="token string">'org.apache.hadoop.io.compress.GzipCodec'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="31_930"></a>31数据装载脚本</h5> 
<p>（1）在hadoop102的/home/atguigu/bin目录下创建hdfs_to_ods_db.sh</p> 
<pre><code class="prism language-bash"><span class="token function">vim</span> hdfs_to_ods_db.sh
</code></pre> 
<p>（2）编写如下内容</p> 
<pre><code class="prism language-shell"><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">APP</span><span class="token operator">=</span>gmall

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$2</span>"</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span><span class="token keyword">then</span>
   <span class="token assign-left variable">do_date</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token keyword">else</span> 
   <span class="token assign-left variable">do_date</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> <span class="token parameter variable">-d</span> <span class="token string">'-1 day'</span> +%F<span class="token variable">`</span></span>
<span class="token keyword">fi</span>

<span class="token function-name function">load_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token assign-left variable">sql</span><span class="token operator">=</span><span class="token string">""</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable">$*</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token comment">#判断路径是否存在</span>
        hadoop fs <span class="token parameter variable">-test</span> <span class="token parameter variable">-e</span> /origin_data/<span class="token variable">$APP</span>/db/<span class="token variable">${i<span class="token operator">:</span>4}</span>/<span class="token variable">$do_date</span>
        <span class="token comment">#路径存在方可装载数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
            <span class="token assign-left variable">sql</span><span class="token operator">=</span><span class="token variable">$sql</span><span class="token string">"load data inpath '/origin_data/<span class="token variable">$APP</span>/db/<span class="token variable">${i<span class="token operator">:</span>4}</span>/<span class="token variable">$do_date</span>' OVERWRITE into table <span class="token variable">${APP}</span>.<span class="token variable">$i</span> partition(dt='<span class="token variable">$do_date</span>');"</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">done</span>
    hive <span class="token parameter variable">-e</span> <span class="token string">"<span class="token variable">$sql</span>"</span>
<span class="token punctuation">}</span>

<span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>
    <span class="token string">"ods_activity_info_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_activity_info_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_activity_rule_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_activity_rule_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_base_category1_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_base_category1_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_base_category2_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_base_category2_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_base_category3_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_base_category3_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_base_dic_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_base_dic_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_base_province_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_base_province_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_base_region_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_base_region_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_base_trademark_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_base_trademark_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_cart_info_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_cart_info_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_coupon_info_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_coupon_info_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_sku_attr_value_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_sku_attr_value_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_sku_info_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_sku_info_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_sku_sale_attr_value_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_sku_sale_attr_value_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_spu_info_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_spu_info_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_promotion_pos_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_promotion_pos_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_promotion_refer_full"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_promotion_refer_full"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>

    <span class="token string">"ods_cart_info_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_cart_info_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_comment_info_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_comment_info_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_coupon_use_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_coupon_use_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_favor_info_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_favor_info_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_order_detail_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_order_detail_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_order_detail_activity_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_order_detail_activity_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_order_detail_coupon_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_order_detail_coupon_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_order_info_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_order_info_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_order_refund_info_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_order_refund_info_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_order_status_log_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_order_status_log_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_payment_info_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_payment_info_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_refund_payment_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_refund_payment_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"ods_user_info_inc"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_user_info_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token string">"all"</span><span class="token punctuation">)</span>
        load_data <span class="token string">"ods_activity_info_full"</span> <span class="token string">"ods_activity_rule_full"</span> <span class="token string">"ods_base_category1_full"</span> <span class="token string">"ods_base_category2_full"</span> <span class="token string">"ods_base_category3_full"</span> <span class="token string">"ods_base_dic_full"</span> <span class="token string">"ods_base_province_full"</span> <span class="token string">"ods_base_region_full"</span> <span class="token string">"ods_base_trademark_full"</span> <span class="token string">"ods_cart_info_full"</span> <span class="token string">"ods_coupon_info_full"</span> <span class="token string">"ods_sku_attr_value_full"</span> <span class="token string">"ods_sku_info_full"</span> <span class="token string">"ods_sku_sale_attr_value_full"</span> <span class="token string">"ods_spu_info_full"</span> <span class="token string">"ods_promotion_pos_full"</span> <span class="token string">"ods_promotion_refer_full"</span> <span class="token string">"ods_cart_info_inc"</span> <span class="token string">"ods_comment_info_inc"</span> <span class="token string">"ods_coupon_use_inc"</span> <span class="token string">"ods_favor_info_inc"</span> <span class="token string">"ods_order_detail_inc"</span> <span class="token string">"ods_order_detail_activity_inc"</span> <span class="token string">"ods_order_detail_coupon_inc"</span> <span class="token string">"ods_order_info_inc"</span> <span class="token string">"ods_order_refund_info_inc"</span> <span class="token string">"ods_order_status_log_inc"</span> <span class="token string">"ods_payment_info_inc"</span> <span class="token string">"ods_refund_payment_inc"</span> <span class="token string">"ods_user_info_inc"</span>
    <span class="token punctuation">;</span><span class="token punctuation">;</span>
<span class="token keyword">esac</span>
</code></pre> 
<p>（3）增加脚本执行权限</p> 
<pre><code class="prism language-bash"><span class="token function">chmod</span> +x hdfs_to_ods_db.sh
</code></pre> 
<p>（4）脚本用法</p> 
<pre><code class="prism language-bash">hdfs_to_ods_db.sh all <span class="token number">2022</span>-06-08
</code></pre> 
<h3><a id="DWD_data_warehouse_detail_1074"></a>第二层：数据加工（DWD data warehouse detail）</h3> 
<p>功能：将数据源中的数据进行加工处理（判空、无效）<br> 为了后续统计分析做数据准备<br> 数据量非常大，所以分离出了DIM层将数据整合<br> 压缩方式：snappy</p> 
<h5><a id="_1080"></a>事实表设计（事务型事实表）</h5> 
<pre><code>-- DWD
    -- Data Warehouse Detail
        -- detail : 详细，明细
        -- DWD层表主要设计的目的为了统计分析做准备
            -- 表中主要保存的是行为数据
            -- 多个行为数据中如果存在共通性的内容，那么可以提炼出来形成DIM层维度表的数据
        -- 表的设计要点
            -- 表的设计要依据维度建模理论中的事实表
            -- 表设计时需要orc列式存储以及snappy压缩
            -- 命名规范：
                -- 分层标记（dwd_） + 数据域(分类) + 原子性行为名称 + 增量/全量（inc/full）
                    -- 绝大多数的行为数据都是增量数据采集
                    -- 特殊情况例外，可以采用全量方式实现。
                -- dwd_user_login_success_inc

-- 事实表
    -- 维度引用 + 度量值（行为产生时可以用于统计分析的数值：金额，数量，个数）
    -- 事实表会根据场景分为3大类：
        -- 1. 事务型事实表
            -- 行为是原子性
                -- 用户登录（非原子）
                    -- 用户登录成功（原子）
                    -- 用户登录失败（原子）
            -- 粒度：描述一行数据的详细程度
                -- 描述的越详细（维度越多），粒度越细
                -- 描述的越简单（维度越多），粒度越粗
            -- 设计步骤：
                -- 1. 选择业务过程 ：确定表
                -- 2. 声明粒度：确定行
                -- 3. 确认维度：确定列
                -- 4. 确认事实：确定度量值
        -- 2. 周期快照事实表
        -- 3. 累积快照事实表

-- 交易域加购事务事实表
    -- 交易域 : trade
    -- 加购 : 行为
        -- 将商品加入到购物车中的行为
            -- 购物车中没有这个商品，往购物车中增加商品
            -- 购物车中有这个商品，继续往购物车中增加该商品
    -- 事务事实表
        -- 原子性
            -- 时间（行为时间） + 用户 + 商品 + 数量
        -- 表的字段结构：必要的维度属性 + 度量值 + 可选的维度属性
    -- 建表语句
        -- 分区策略：哪一天的行为数据存放到哪一天分区
</code></pre> 
<h4><a id="_1129"></a>事务的原子性</h4> 
<p>登录成功（OK） 登录失败（OK）<br> 下单成功（OK） 下单失败（非正常业务行为，不需要再创建一张表）<br> 支付成功（OK） 支付失败（OK）</p> 
<h4><a id="_1134"></a>事实表设计（周期型快照事实表）</h4> 
<p>全量</p> 
<pre><code>-- 事务性事实表局限性
-- 事实表只针对于当前行为进行的统计分析时，性能可以得到保障。
-- 当前行为事实表和其他行为数据进行关联时，数据量会几何爆炸性增长，性能会急剧下降。
-- 存量性统计指标使用事务性事实表效率太低，所以一般会采用其他事实表的设计方式
    -- 2. 周期型快照事实表

-- 交易域购物车周期快照事实表
    -- 交易域
    -- 购物车 ： cart_info
    -- 周期快照事实表
</code></pre> 
<h3><a id="retry_1148"></a>从当前表中取数据后再放回去需考虑去重问题，增加retry的容错性</h3> 
<h4><a id="_1151"></a>事实表设计（累积型快照事实表）</h4> 
<pre><code>-- 多行为统计指标使用事务性事实表效率太低，所以一般会采用其他事实表的设计方式
-- 3. 累积型快照事实表
    -- 使用一张表保存多个行为的状态数据

-- 交易域交易流程累积快照事实表
    -- 交易域
    -- 交易流程 : 以订单为基础的交易流程
    -- 累积快照事实表
</code></pre> 
<h4><a id="_1162"></a>分区策略</h4> 
<pre><code>-- 事务性事实表：哪一天的行为数据存放到哪一天的分区
-- 周期性事实表：每一天存储一份数据
-- 累积快照事实表：从业务流程中获取最后一个业务行为时间作为分区字段
    -- 下单时间 (X)
    -- 支付时间 (X)
    -- 收货时间 (OK)
</code></pre> 
<h3><a id="DWS_data_warehouse_summary__1172"></a>第三层：数据统计（DWS data warehouse summary 提高性能的关键层）</h3> 
<p>功能：将加工后的数据进行统计<br> 数据量非常大<br> 压缩方式：snappy</p> 
<p><img src="https://images2.imgbox.com/d1/b0/RyWcz2s5_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/65/34/CGIkAWQv_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="ADS_application_data_service_1183"></a>第四层：数据分析（ADS application data service）</h3> 
<p>功能：将统计结果进行分析，为用户提供经营决策<br> 压缩方式：gzip<br> 数据格式：tsv</p> 
<h4><a id="_1188"></a>表的设计（要点）</h4> 
<pre><code>        -- ADS层中存储的是统计分析的最终结果
            -- 数据量不多
                -- 表不需要分区
            -- 无需做进一步聚合
                -- 无需orc列式存储和snappy压缩
                -- 行式存储 + gzip
            -- 结果还需要向后流转（可视化）
                -- tsv
            -- 表的结构不能太复杂（满足客户的需求即可）
</code></pre> 
<h4><a id="_1199"></a>优化（假）</h4> 
<p>Spark：</p> 
<ul><li>reduceByKey（函数内部combine减少落盘数据量）和groupByKey</li><li>cache、persist和checkpoint</li><li>DWS</li></ul> 
<h4><a id="1_1205"></a>1流量主题</h4> 
<h5><a id="11_1206"></a>1.1各渠道流量统计</h5> 
<p>1）建表语句</p> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> ads_traffic_stats_by_channel<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> ads_traffic_stats_by_channel
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span>               STRING <span class="token keyword">COMMENT</span> <span class="token string">'统计日期'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>recent_days<span class="token punctuation">`</span></span>      <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最近天数,1:最近1天,7:最近7天,30:最近30天'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>channel<span class="token punctuation">`</span></span>          STRING <span class="token keyword">COMMENT</span> <span class="token string">'渠道'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>uv_count<span class="token punctuation">`</span></span>         <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'访客人数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>avg_duration_sec<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'会话平均停留时长，单位为秒'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>avg_page_count<span class="token punctuation">`</span></span>   <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'会话平均浏览页面数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sv_count<span class="token punctuation">`</span></span>         <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'会话数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>bounce_rate<span class="token punctuation">`</span></span>      <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'跳出率'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'各渠道流量统计'</span>
    <span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
    LOCATION <span class="token string">'/warehouse/gmall/ads/ads_traffic_stats_by_channel/'</span><span class="token punctuation">;</span>
</code></pre> 
<p>2）数据装载</p> 
<h3><a id="DIM_dimension_1230"></a>第五层：共通层（DIM dimension）</h3> 
<p>功能：将共同的数据放在共通的表中，可在多个统计需求中使用<br> dimension：维度，分析数据的角度<br> 该层不需要一开始就设计，可以等DWD层设计的差不多了，或是写着写着发现DWD中有好多表都用到了共通的字段，有大量冗余数据，那么就可以将这部分共通的数据提取成一个表</p> 
<h4><a id="_1234"></a>设计要点</h4> 
<p>（1）DIM层的设计依据是维度建模理论，该层存储维度模型的维度表。<br> （2）DIM层的数据存储格式为orc列式存储+snappy压缩。<br> （3）DIM层表名的命名规范为dim_表名_全量表或者拉链表标识（full/zip）。<br> 绝大多数的维度表都是全量表</p> 
<h4><a id="_1240"></a>是否创建表</h4> 
<ul><li> <p>数据量少，应用面窄 ：无需创建表（放用得到的表里即可，即维度退化）</p> </li><li> <p>数据量少，应用面广 ：无需创建独立表，一般和其他的数放置在一张表中（数据字典表（编码表-&gt;是树形表））</p> </li><li> <p>树形(有上下级)数据保存时一般会采用 parent - child节点的设计方式</p> 
  <ul><li>一般情况下，会采用一张表来设计上下级结构：部门（depart）<br> – 表中的列：下级部门（主键）（N）， 上级部门（外键）(1)</li><li>字典表也是树形表</li></ul> </li></ul> 
<h4><a id="_1248"></a>维度表设计</h4> 
<ol><li>确定维度表：确定维度的表是否该创建 
  <ul><li>原则上来讲，每一个分析数据的角度（维度）都应该创建一张表 
    <ul><li>案例：统计各个省份，各个品牌的订单总销量<br> – 订单属于事实（行为）表，省份和品牌就是维度表</li><li>案例：统计各个性别不同年龄段的订单总销量<br> – 订单属于事实（行为）表, 性别和年龄就是维度表</li></ul> </li><li>如果多个维度存在关联，那么一般就会只创建一张表，表中包含了多个关联的维度</li><li>如果分析数据的角度应用场景少，而且数据量小，不需要创建专门的维度表 
    <ul><li>案例：支付方式（微信支付，支付宝支付）</li></ul> </li></ul> </li><li>确定主维表和相关维表(用于分析维度表的列) 
  <ul><li>确定表中的列 
    <ul><li>案例：省份维度表<br> – 列：名称</li><li>数据仓库的数据都来自于MySQL业务数据，<br> – 维度表的列的声明可以参考业务数据库表的字段</li><li>MySQL业务数据库中具有唯一性字段的那个业务表称之为主维表<br> – 其他的表称之为相关维表。</li></ul> </li></ul> </li><li>确定表中的列 
  <ul><li>尽可能丰富（多）</li><li>编码和文字共存</li><li>沉淀通用属性 ：tel, xxx<br> – 计算或转换</li></ul> </li></ol> 
<h5><a id="1_1272"></a>1商品维度表</h5> 
<pre><code class="prism language-sql"><span class="token comment">-- 商品维度表 ：dim_sku_full</span>
    <span class="token comment">-- 确定维度表</span>
    <span class="token comment">-- 主维表和相关维表</span>
        <span class="token comment">-- 主维表和相关维表都是MySQL业务表</span>
            <span class="token comment">-- 主要用于分析列的表称之主维表（主键）</span>
                <span class="token comment">-- sku_info</span>
            <span class="token comment">-- 其他用于分析列的表称之相关维表</span>
                <span class="token comment">-- sku_attr_value</span>
                <span class="token comment">-- sku_sale_attr_value</span>
    <span class="token comment">-- 确定表的列</span>
    <span class="token comment">-- 建表语句</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_sku_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_sku_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                   STRING <span class="token keyword">COMMENT</span> <span class="token string">'SKU_ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span>                <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品价格'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span></span>             STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_desc<span class="token punctuation">`</span></span>             STRING <span class="token keyword">COMMENT</span> <span class="token string">'商品描述'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>weight<span class="token punctuation">`</span></span>               <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'重量'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>is_sale<span class="token punctuation">`</span></span>              <span class="token keyword">BOOLEAN</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否在售'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span></span>               STRING <span class="token keyword">COMMENT</span> <span class="token string">'SPU编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span></span>             STRING <span class="token keyword">COMMENT</span> <span class="token string">'SPU名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级品类ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>category3_name<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'三级品类名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>category2_id<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级品类id'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>category2_name<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'二级品类名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>category1_id<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级品类ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>category1_name<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'一级品类名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span></span>                  STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span></span>               STRING <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_attr_values<span class="token punctuation">`</span></span>      ARRAY<span class="token operator">&lt;</span>STRUCT<span class="token operator">&lt;</span>attr_id :STRING<span class="token punctuation">,</span>
        value_id :STRING<span class="token punctuation">,</span>
        attr_name :STRING<span class="token punctuation">,</span>
        value_name:STRING<span class="token operator">&gt;&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'平台属性'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_sale_attr_values<span class="token punctuation">`</span></span> ARRAY<span class="token operator">&lt;</span>STRUCT<span class="token operator">&lt;</span>sale_attr_id :STRING<span class="token punctuation">,</span>
        sale_attr_value_id :STRING<span class="token punctuation">,</span>
        sale_attr_name :STRING<span class="token punctuation">,</span>
        sale_attr_value_name:STRING<span class="token operator">&gt;&gt;</span> <span class="token keyword">COMMENT</span> <span class="token string">'销售属性'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>          STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品维度表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    STORED <span class="token keyword">AS</span> ORC
    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_sku_full/'</span>
    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'orc.compress'</span> <span class="token operator">=</span> <span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 数据装载</span>
    <span class="token comment">-- load</span>
        <span class="token comment">-- 数据源一定是ODS层</span>
    <span class="token comment">-- save</span>
        <span class="token comment">-- 分区字段其实也是表的字段，但是我们一般称之为虚拟字段</span>
            <span class="token comment">-- 数据字段(列)：存储在数据文件中</span>
            <span class="token comment">-- 分区字段：存储在路径中</span>
    <span class="token comment">-- 分区</span>
        <span class="token comment">-- dt : date(日期)</span>
        <span class="token comment">-- 策略：将每天采集的数据存放到ODS层的每天分区中</span>
            <span class="token comment">-- 将ODS层每天的数据关联后存放到DIM层的每天分区中</span>
        <span class="token comment">-- 分区存储应该采用overwrite而不是into</span>
<span class="token keyword">set</span> hive<span class="token punctuation">.</span>vectorized<span class="token punctuation">.</span>execution<span class="token punctuation">.</span>enabled<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_sku_full <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    sku<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>               <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT 'SKU_ID',</span>
    <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span>                <span class="token punctuation">,</span><span class="token comment">--DECIMAL(16, 2) COMMENT '商品价格',</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span></span>             <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '商品名称',</span>
    <span class="token identifier"><span class="token punctuation">`</span>sku_desc<span class="token punctuation">`</span></span>             <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '商品描述',</span>
    <span class="token identifier"><span class="token punctuation">`</span>weight<span class="token punctuation">`</span></span>               <span class="token punctuation">,</span><span class="token comment">--DECIMAL(16, 2) COMMENT '重量',</span>
    <span class="token identifier"><span class="token punctuation">`</span>is_sale<span class="token punctuation">`</span></span>              <span class="token punctuation">,</span><span class="token comment">--BOOLEAN COMMENT '是否在售',</span>
    <span class="token identifier"><span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span></span>               <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT 'SPU编号',</span>
    <span class="token identifier"><span class="token punctuation">`</span>spu_name<span class="token punctuation">`</span></span>             <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT 'SPU名称',</span>
    <span class="token identifier"><span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span></span>         <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '三级品类ID',</span>
    <span class="token identifier"><span class="token punctuation">`</span>category3_name<span class="token punctuation">`</span></span>       <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '三级品类名称',</span>
    <span class="token identifier"><span class="token punctuation">`</span>category2_id<span class="token punctuation">`</span></span>         <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '二级品类id',</span>
    <span class="token identifier"><span class="token punctuation">`</span>category2_name<span class="token punctuation">`</span></span>       <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '二级品类名称',</span>
    <span class="token identifier"><span class="token punctuation">`</span>category1_id<span class="token punctuation">`</span></span>         <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '一级品类ID',</span>
    <span class="token identifier"><span class="token punctuation">`</span>category1_name<span class="token punctuation">`</span></span>       <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '一级品类名称',</span>
    <span class="token identifier"><span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span></span>                <span class="token punctuation">,</span><span class="token comment">--  STRING COMMENT '品牌ID',</span>
    <span class="token identifier"><span class="token punctuation">`</span>tm_name<span class="token punctuation">`</span></span>              <span class="token punctuation">,</span><span class="token comment">-- STRING COMMENT '品牌名称',</span>
    sku_attr_values<span class="token punctuation">,</span>
    sku_sale_attr_values<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>          <span class="token comment">--STRING COMMENT '创建时间'</span>
<span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                   <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT 'SKU_ID',</span>
        <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span>                <span class="token punctuation">,</span><span class="token comment">--DECIMAL(16, 2) COMMENT '商品价格',</span>
        <span class="token identifier"><span class="token punctuation">`</span>sku_name<span class="token punctuation">`</span></span>             <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '商品名称',</span>
        <span class="token identifier"><span class="token punctuation">`</span>sku_desc<span class="token punctuation">`</span></span>             <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '商品描述',</span>
        <span class="token identifier"><span class="token punctuation">`</span>weight<span class="token punctuation">`</span></span>               <span class="token punctuation">,</span><span class="token comment">--DECIMAL(16, 2) COMMENT '重量',</span>
        <span class="token identifier"><span class="token punctuation">`</span>is_sale<span class="token punctuation">`</span></span>              <span class="token punctuation">,</span><span class="token comment">--BOOLEAN COMMENT '是否在售',</span>
        <span class="token identifier"><span class="token punctuation">`</span>spu_id<span class="token punctuation">`</span></span>               <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT 'SPU编号',</span>
        <span class="token identifier"><span class="token punctuation">`</span>category3_id<span class="token punctuation">`</span></span>         <span class="token punctuation">,</span><span class="token comment">--STRING COMMENT '三级品类ID',</span>
        <span class="token identifier"><span class="token punctuation">`</span>tm_id<span class="token punctuation">`</span></span>                <span class="token punctuation">,</span><span class="token comment">--  STRING COMMENT '品牌ID',</span>
        create_time
    <span class="token keyword">from</span> ods_sku_info_full
    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span> sku
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        spu_name
    <span class="token keyword">from</span> ods_spu_info_full
    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span> spu <span class="token keyword">on</span> sku<span class="token punctuation">.</span>spu_id <span class="token operator">=</span> spu<span class="token punctuation">.</span>id
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        tm_name
    <span class="token keyword">from</span> ods_base_trademark_full
    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span> tm <span class="token keyword">on</span> sku<span class="token punctuation">.</span>tm_id <span class="token operator">=</span> tm<span class="token punctuation">.</span>id
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        name category3_name<span class="token punctuation">,</span>
        category2_id
    <span class="token keyword">from</span> ods_base_category3_full
    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span> c3 <span class="token keyword">on</span> sku<span class="token punctuation">.</span>category3_id <span class="token operator">=</span> c3<span class="token punctuation">.</span>id
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        name category2_name<span class="token punctuation">,</span>
        category1_id
    <span class="token keyword">from</span> ods_base_category2_full
    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span> c2 <span class="token keyword">on</span> c3<span class="token punctuation">.</span>category2_id <span class="token operator">=</span> c2<span class="token punctuation">.</span>id
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        name category1_name
    <span class="token keyword">from</span> ods_base_category1_full
    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span> c1 <span class="token keyword">on</span> c2<span class="token punctuation">.</span>category1_id <span class="token operator">=</span> c1<span class="token punctuation">.</span>id
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
<span class="token comment">-- 将查询结果转换为结构体后，形成Array</span>
<span class="token comment">-- 将多个结构体的数据聚合成一个数组类型的数据（聚合操作）</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        collect_list<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span><span class="token string">"attr_id"</span><span class="token punctuation">,</span> attr_id<span class="token punctuation">,</span> <span class="token string">"value_id"</span><span class="token punctuation">,</span> value_id<span class="token punctuation">,</span> <span class="token string">"attr_name"</span><span class="token punctuation">,</span> attr_name<span class="token punctuation">,</span> <span class="token string">"value_name"</span><span class="token punctuation">,</span> value_name<span class="token punctuation">)</span><span class="token punctuation">)</span> sku_attr_values
    <span class="token keyword">from</span> ods_sku_attr_value_full
    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-06-08'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id
<span class="token punctuation">)</span> sav <span class="token keyword">on</span> sku<span class="token punctuation">.</span>id <span class="token operator">=</span> sav<span class="token punctuation">.</span>sku_id
<span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        sku_id<span class="token punctuation">,</span>
        collect_list<span class="token punctuation">(</span>named_struct<span class="token punctuation">(</span><span class="token string">"sale_attr_id"</span><span class="token punctuation">,</span> sale_attr_id<span class="token punctuation">,</span> <span class="token string">"sale_attr_value_id"</span><span class="token punctuation">,</span> sale_attr_value_id<span class="token punctuation">,</span> <span class="token string">"sale_attr_name"</span><span class="token punctuation">,</span> sale_attr_name<span class="token punctuation">,</span> <span class="token string">"sale_attr_value_name"</span><span class="token punctuation">,</span> sale_attr_value_name<span class="token punctuation">)</span><span class="token punctuation">)</span> sku_sale_attr_values
    <span class="token keyword">from</span> ods_sku_sale_attr_value_full
    <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-06-08'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> sku_id
<span class="token punctuation">)</span> ssav <span class="token keyword">on</span> sku<span class="token punctuation">.</span>id <span class="token operator">=</span> ssav<span class="token punctuation">.</span>sku_id<span class="token punctuation">;</span>

<span class="token comment">-- join &amp; left join</span>
    <span class="token comment">-- join 要求2张表的数据同时满足条件才能作为结果返回</span>
    <span class="token comment">-- left join 要求2张表的数据左边的表不满足条件也能作为结果返回</span>
        <span class="token comment">-- 使用left join 替换 join，必须保证，替换后不影响结果</span>
</code></pre> 
<h5><a id="2_1429"></a>2优惠券维度表</h5> 
<p>1）建表语句</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 创建表</span>
<span class="token comment">-- 分析表中的列</span>
    <span class="token comment">-- 主维表</span>
        <span class="token comment">-- coupon_info</span>
            <span class="token comment">-- base_dic</span>
    <span class="token comment">-- 相关维表</span>
<span class="token comment">-- 建表语句</span>
    <span class="token comment">-- 表名</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_coupon_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_coupon_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                  STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>coupon_name<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>coupon_type_code<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券类型编码'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>coupon_type_name<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠券类型名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span></span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满额数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span></span>     <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满件数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动编号'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span></span>   <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'减免金额'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span></span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'折扣'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_rule<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠规则:满元*减*元，满*件打*折'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>range_type_code<span class="token punctuation">`</span></span>  STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠范围类型编码'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>range_type_name<span class="token punctuation">`</span></span>  STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠范围类型名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>limit_num<span class="token punctuation">`</span></span>         <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'最多领取次数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>taken_count<span class="token punctuation">`</span></span>       <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'已领取次数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>start_time<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'可以领取的开始时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>end_time<span class="token punctuation">`</span></span>          STRING <span class="token keyword">COMMENT</span> <span class="token string">'可以领取的结束时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>expire_time<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'过期时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠券维度表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    STORED <span class="token keyword">AS</span> ORC
    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_coupon_full/'</span>
    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'orc.compress'</span> <span class="token operator">=</span> <span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2）数据装载</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_coupon_full <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    id<span class="token punctuation">,</span>
    coupon_name<span class="token punctuation">,</span>
    coupon_type<span class="token punctuation">,</span>
    coupon_dic<span class="token punctuation">.</span>dic_name<span class="token punctuation">,</span>
    condition_amount<span class="token punctuation">,</span>
    condition_num<span class="token punctuation">,</span>
    activity_id<span class="token punctuation">,</span>
    benefit_amount<span class="token punctuation">,</span>
    benefit_discount<span class="token punctuation">,</span>
    <span class="token keyword">case</span> coupon_type
        <span class="token keyword">when</span> <span class="token string">'3201'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'满'</span><span class="token punctuation">,</span>condition_amount<span class="token punctuation">,</span><span class="token string">'元减'</span><span class="token punctuation">,</span>benefit_amount<span class="token punctuation">,</span><span class="token string">'元'</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> <span class="token string">'3202'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'满'</span><span class="token punctuation">,</span>condition_num<span class="token punctuation">,</span><span class="token string">'件打'</span><span class="token punctuation">,</span> benefit_discount<span class="token punctuation">,</span><span class="token string">' 折'</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> <span class="token string">'3203'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'减'</span><span class="token punctuation">,</span>benefit_amount<span class="token punctuation">,</span><span class="token string">'元'</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span> benefit_rule<span class="token punctuation">,</span>
    create_time<span class="token punctuation">,</span>
    range_type<span class="token punctuation">,</span>
    range_dic<span class="token punctuation">.</span>dic_name<span class="token punctuation">,</span>
    limit_num<span class="token punctuation">,</span>
    taken_count<span class="token punctuation">,</span>
    start_time<span class="token punctuation">,</span>
    end_time<span class="token punctuation">,</span>
    operate_time<span class="token punctuation">,</span>
    expire_time
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        coupon_name<span class="token punctuation">,</span>
        coupon_type<span class="token punctuation">,</span>
        condition_amount<span class="token punctuation">,</span>
        condition_num<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        benefit_amount<span class="token punctuation">,</span>
        benefit_discount<span class="token punctuation">,</span>
        create_time<span class="token punctuation">,</span>
        range_type<span class="token punctuation">,</span>
        limit_num<span class="token punctuation">,</span>
        taken_count<span class="token punctuation">,</span>
        start_time<span class="token punctuation">,</span>
        end_time<span class="token punctuation">,</span>
        operate_time<span class="token punctuation">,</span>
        expire_time
    <span class="token keyword">from</span> ods_coupon_info_full
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span>ci
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dic_code<span class="token punctuation">,</span>
        dic_name
    <span class="token keyword">from</span> ods_base_dic_full
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span>
    <span class="token operator">and</span> parent_code<span class="token operator">=</span><span class="token string">'32'</span>
<span class="token punctuation">)</span>coupon_dic
<span class="token keyword">on</span> ci<span class="token punctuation">.</span>coupon_type<span class="token operator">=</span>coupon_dic<span class="token punctuation">.</span>dic_code
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dic_code<span class="token punctuation">,</span>
        dic_name
    <span class="token keyword">from</span> ods_base_dic_full
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span>
    <span class="token operator">and</span> parent_code<span class="token operator">=</span><span class="token string">'33'</span>
<span class="token punctuation">)</span>range_dic
<span class="token keyword">on</span> ci<span class="token punctuation">.</span>range_type<span class="token operator">=</span>range_dic<span class="token punctuation">.</span>dic_code<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="3_1541"></a>3活动（规则）维度表</h5> 
<p>1）建表语句</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 活动(规则)维度表</span>
    <span class="token comment">-- activity_info</span>
    <span class="token comment">-- activity_rule</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_activity_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_activity_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_rule_id<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动规则ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_id<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_name<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_type_code<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动类型编码'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_type_name<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动类型名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>activity_desc<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'活动描述'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>start_time<span class="token punctuation">`</span></span>           STRING <span class="token keyword">COMMENT</span> <span class="token string">'开始时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>end_time<span class="token punctuation">`</span></span>             STRING <span class="token keyword">COMMENT</span> <span class="token string">'结束时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>          STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>condition_amount<span class="token punctuation">`</span></span>    <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减金额'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>condition_num<span class="token punctuation">`</span></span>       <span class="token keyword">BIGINT</span> <span class="token keyword">COMMENT</span> <span class="token string">'满减件数'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_amount<span class="token punctuation">`</span></span>      <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠金额'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_discount<span class="token punctuation">`</span></span>   <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'优惠折扣'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_rule<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠规则'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>benefit_level<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'优惠级别'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'活动维度表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    STORED <span class="token keyword">AS</span> ORC
    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_activity_full/'</span>
    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'orc.compress'</span> <span class="token operator">=</span> <span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2）数据装载</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_activity_full <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    <span class="token keyword">rule</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    info<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    activity_name<span class="token punctuation">,</span>
    <span class="token keyword">rule</span><span class="token punctuation">.</span>activity_type<span class="token punctuation">,</span>
    dic<span class="token punctuation">.</span>dic_name<span class="token punctuation">,</span>
    activity_desc<span class="token punctuation">,</span>
    start_time<span class="token punctuation">,</span>
    end_time<span class="token punctuation">,</span>
    create_time<span class="token punctuation">,</span>
    condition_amount<span class="token punctuation">,</span>
    condition_num<span class="token punctuation">,</span>
    benefit_amount<span class="token punctuation">,</span>
    benefit_discount<span class="token punctuation">,</span>
    <span class="token keyword">case</span> <span class="token keyword">rule</span><span class="token punctuation">.</span>activity_type
        <span class="token keyword">when</span> <span class="token string">'3101'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'满'</span><span class="token punctuation">,</span>condition_amount<span class="token punctuation">,</span><span class="token string">'元减'</span><span class="token punctuation">,</span>benefit_amount<span class="token punctuation">,</span><span class="token string">'元'</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> <span class="token string">'3102'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'满'</span><span class="token punctuation">,</span>condition_num<span class="token punctuation">,</span><span class="token string">'件打'</span><span class="token punctuation">,</span> benefit_discount<span class="token punctuation">,</span><span class="token string">' 折'</span><span class="token punctuation">)</span>
        <span class="token keyword">when</span> <span class="token string">'3103'</span> <span class="token keyword">then</span> concat<span class="token punctuation">(</span><span class="token string">'打'</span><span class="token punctuation">,</span> benefit_discount<span class="token punctuation">,</span><span class="token string">'折'</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span> benefit_rule<span class="token punctuation">,</span>
    benefit_level
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        activity_id<span class="token punctuation">,</span>
        activity_type<span class="token punctuation">,</span>
        condition_amount<span class="token punctuation">,</span>
        condition_num<span class="token punctuation">,</span>
        benefit_amount<span class="token punctuation">,</span>
        benefit_discount<span class="token punctuation">,</span>
        benefit_level
    <span class="token keyword">from</span> ods_activity_rule_full
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span><span class="token keyword">rule</span>
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        activity_name<span class="token punctuation">,</span>
        activity_type<span class="token punctuation">,</span>
        activity_desc<span class="token punctuation">,</span>
        start_time<span class="token punctuation">,</span>
        end_time<span class="token punctuation">,</span>
        create_time
    <span class="token keyword">from</span> ods_activity_info_full
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span>info
<span class="token keyword">on</span> <span class="token keyword">rule</span><span class="token punctuation">.</span>activity_id<span class="token operator">=</span>info<span class="token punctuation">.</span>id
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        dic_code<span class="token punctuation">,</span>
        dic_name
    <span class="token keyword">from</span> ods_base_dic_full
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span>
    <span class="token operator">and</span> parent_code<span class="token operator">=</span><span class="token string">'31'</span>
<span class="token punctuation">)</span>dic
<span class="token keyword">on</span> <span class="token keyword">rule</span><span class="token punctuation">.</span>activity_type<span class="token operator">=</span>dic<span class="token punctuation">.</span>dic_code<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="4_1636"></a>4地区维度表</h5> 
<p>1）建表语句</p> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_province_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_province_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>              STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>province_name<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'省份名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>area_code<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区编码'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>iso_code<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'旧版国际标准地区编码，供可视化使用'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>iso_3166_2<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'新版国际标准地区编码，供可视化使用'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>region_id<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>region_name<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'地区名称'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'地区维度表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    STORED <span class="token keyword">AS</span> ORC
    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_province_full/'</span>
    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'orc.compress'</span> <span class="token operator">=</span> <span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2）数据装载</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_province_full <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    province<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    province<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    province<span class="token punctuation">.</span>area_code<span class="token punctuation">,</span>
    province<span class="token punctuation">.</span>iso_code<span class="token punctuation">,</span>
    province<span class="token punctuation">.</span>iso_3166_2<span class="token punctuation">,</span>
    region_id<span class="token punctuation">,</span>
    region_name
<span class="token keyword">from</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        name<span class="token punctuation">,</span>
        region_id<span class="token punctuation">,</span>
        area_code<span class="token punctuation">,</span>
        iso_code<span class="token punctuation">,</span>
        iso_3166_2
    <span class="token keyword">from</span> ods_base_province_full
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span>province
<span class="token keyword">left</span> <span class="token keyword">join</span>
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        id<span class="token punctuation">,</span>
        region_name
    <span class="token keyword">from</span> ods_base_region_full
    <span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span>
<span class="token punctuation">)</span>region
<span class="token keyword">on</span> province<span class="token punctuation">.</span>region_id<span class="token operator">=</span>region<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="5_1691"></a>5营销坑位维度表</h5> 
<p>1）建表语句</p> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_promotion_pos_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_promotion_pos_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                 STRING <span class="token keyword">COMMENT</span> <span class="token string">'营销坑位ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>pos_location<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'营销坑位位置'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>pos_type<span class="token punctuation">`</span></span>          STRING <span class="token keyword">COMMENT</span> <span class="token string">'营销坑位类型 '</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>promotion_type<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'营销类型'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'营销坑位维度表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    STORED <span class="token keyword">AS</span> ORC
    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_promotion_pos_full/'</span>
    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'orc.compress'</span> <span class="token operator">=</span> <span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2）数据装载</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_promotion_pos_full <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span>         
    <span class="token identifier"><span class="token punctuation">`</span>pos_location<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>pos_type<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>promotion_type<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>
<span class="token keyword">from</span> ods_promotion_pos_full 
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="6_1725"></a>6营销渠道维度表</h5> 
<p>1）建表语句</p> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_promotion_refer_full<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_promotion_refer_full
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>                    STRING <span class="token keyword">COMMENT</span> <span class="token string">'营销渠道ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>refer_name<span class="token punctuation">`</span></span>          STRING <span class="token keyword">COMMENT</span> <span class="token string">'营销渠道名称'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'营销渠道维度表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    STORED <span class="token keyword">AS</span> ORC
    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_promotion_refer_full/'</span>
    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'orc.compress'</span> <span class="token operator">=</span> <span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2）数据装载</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_promotion_refer_full <span class="token keyword">partition</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> 
    <span class="token identifier"><span class="token punctuation">`</span>refer_name<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span>   
<span class="token keyword">from</span> ods_promotion_refer_full 
<span class="token keyword">where</span> dt<span class="token operator">=</span><span class="token string">'2022-06-08'</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="7_1756"></a>7日期维度表</h5> 
<p>日期维度表不需要从MySQL中导，而是从文件中另行导入，也不需要每天导入，每年导入一次即可<br> 1）建表语句</p> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_date<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_date
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>date_id<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'日期ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>week_id<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'周ID,一年中的第几周'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>week_day<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'周几'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>day<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'每月的第几天'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>month<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'一年中的第几月'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>quarter<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'一年中的第几季度'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>year<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'年份'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>is_workday<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否是工作日'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>holiday_id<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'节假日'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'日期维度表'</span>
    STORED <span class="token keyword">AS</span> ORC
    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_date/'</span>
    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'orc.compress'</span> <span class="token operator">=</span> <span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2）数据装载</p> 
<p>（1）创建临时表</p> 
<pre><code class="prism language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> tmp_dim_date_info<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> tmp_dim_date_info <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>date_id<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'日'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>week_id<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'周ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>week_day<span class="token punctuation">`</span></span>      STRING <span class="token keyword">COMMENT</span> <span class="token string">'周几'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>day<span class="token punctuation">`</span></span>            STRING <span class="token keyword">COMMENT</span> <span class="token string">'每月的第几天'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>month<span class="token punctuation">`</span></span>          STRING <span class="token keyword">COMMENT</span> <span class="token string">'第几月'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>quarter<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'第几季度'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>year<span class="token punctuation">`</span></span>           STRING <span class="token keyword">COMMENT</span> <span class="token string">'年'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>is_workday<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'是否是工作日'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>holiday_id<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'节假日'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'时间维度表'</span>
<span class="token keyword">ROW</span> FORMAT DELIMITED <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">'\t'</span>
LOCATION <span class="token string">'/warehouse/gmall/tmp/tmp_dim_date_info/'</span><span class="token punctuation">;</span>
</code></pre> 
<p>（2）将数据文件上传到HFDS上临时表路径/warehouse/gmall/tmp/tmp_dim_date_info<br> <img src="https://images2.imgbox.com/ee/ae/HTFjEnWG_o.png" alt="在这里插入图片描述"><br> TSV格式的数据</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 日期数据不是由我们自己提供的</span>
    <span class="token comment">-- TSV -&gt; ORC</span>
    <span class="token comment">-- ODS(全量) -&gt; DIM(ORC)</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_date <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tmp_dim_date_info<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="8_1811"></a>8用户维度表（拉链（压缩）表）</h5> 
<ul><li>将大量数据的表进行特殊的设计进行改善，让数据减少，并且不影响业务逻辑<br> – 将数据状态进行时间标记：开始 + 结束</li><li>设计拉链表时，需要在基本表的设计基础上，增加2个额外字段，用于表示状态的范围（开始，结束）</li><li>拉链表的数据，每一个状态的变化会保存一条数据，如果状态没有任何的变化，那么数据只有一条<br> 1）建表语句</li></ul> 
<pre><code class="prism language-sql"><span class="token comment">-- 表名：dim_user_full</span>
<span class="token comment">-- 表中列</span>
    <span class="token comment">-- 主维表 : user_info</span>
    <span class="token comment">-- 相关维表 : user_address</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> dim_user_zip<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> dim_user_zip
<span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>           STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户ID'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span>         STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户姓名'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>phone_num<span class="token punctuation">`</span></span>    STRING <span class="token keyword">COMMENT</span> <span class="token string">'手机号码'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>email<span class="token punctuation">`</span></span>        STRING <span class="token keyword">COMMENT</span> <span class="token string">'邮箱'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>user_level<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'用户等级'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>birthday<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'生日'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span>       STRING <span class="token keyword">COMMENT</span> <span class="token string">'性别'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span>  STRING <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>operate_time<span class="token punctuation">`</span></span> STRING <span class="token keyword">COMMENT</span> <span class="token string">'操作时间'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>start_date<span class="token punctuation">`</span></span>   STRING <span class="token keyword">COMMENT</span> <span class="token string">'开始日期'</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>end_date<span class="token punctuation">`</span></span>     STRING <span class="token keyword">COMMENT</span> <span class="token string">'结束日期'</span>
<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户维度表'</span>
    PARTITIONED <span class="token keyword">BY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> STRING<span class="token punctuation">)</span>
    STORED <span class="token keyword">AS</span> ORC
    LOCATION <span class="token string">'/warehouse/gmall/dim/dim_user_zip/'</span>
    TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">'orc.compress'</span> <span class="token operator">=</span> <span class="token string">'snappy'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2）数据装载<br> ① 首日装载</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 全量表</span>
    <span class="token comment">-- DataX</span>
        <span class="token comment">-- TSV</span>
<span class="token comment">-- 增量表</span>
    <span class="token comment">-- Maxwell</span>
        <span class="token comment">-- JSON</span>
            <span class="token comment">-- 首日(全量-select) : bootstrap (3种类型)</span>
            <span class="token comment">-- 每日(增量-binlog) : insert, update, delete</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_user_zip <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt <span class="token operator">=</span> <span class="token string">'9999-12-31'</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token keyword">data</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
       concat<span class="token punctuation">(</span>substr<span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>                name<span class="token punctuation">,</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">.</span>phone_num <span class="token operator">regexp</span> <span class="token string">'^(13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\\d{8}$'</span><span class="token punctuation">,</span>
          concat<span class="token punctuation">(</span>substr<span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">.</span>phone_num<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> phone_num<span class="token punctuation">,</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">.</span>email <span class="token operator">regexp</span> <span class="token string">'^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\\.[a-zA-Z0-9_-]+)+$'</span><span class="token punctuation">,</span>
          concat<span class="token punctuation">(</span><span class="token string">'*@'</span><span class="token punctuation">,</span> split<span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">.</span>email<span class="token punctuation">,</span> <span class="token string">'@'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span>   email<span class="token punctuation">,</span>
       <span class="token keyword">data</span><span class="token punctuation">.</span>user_level<span class="token punctuation">,</span>
       <span class="token keyword">data</span><span class="token punctuation">.</span>birthday<span class="token punctuation">,</span>
       <span class="token keyword">data</span><span class="token punctuation">.</span>gender<span class="token punctuation">,</span>
       <span class="token keyword">data</span><span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
       <span class="token keyword">data</span><span class="token punctuation">.</span>operate_time<span class="token punctuation">,</span>
       <span class="token string">'2022-06-08'</span>                                        start_date<span class="token punctuation">,</span>
       <span class="token string">'9999-12-31'</span>                                        end_date
<span class="token keyword">from</span> ods_user_info_inc
<span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-06-08'</span>
  <span class="token operator">and</span> <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'bootstrap-insert'</span><span class="token punctuation">;</span>
</code></pre> 
<p>② 每日装载</p> 
<pre><code class="prism language-sql"><span class="token keyword">set</span> hive<span class="token punctuation">.</span><span class="token keyword">exec</span><span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span><span class="token keyword">partition</span><span class="token punctuation">.</span><span class="token keyword">mode</span><span class="token operator">=</span>nonstrict<span class="token punctuation">;</span>
<span class="token keyword">insert</span> overwrite <span class="token keyword">table</span> dim_user_zip <span class="token keyword">partition</span> <span class="token punctuation">(</span>dt<span class="token punctuation">)</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>
       name<span class="token punctuation">,</span>
       phone_num<span class="token punctuation">,</span>
       email<span class="token punctuation">,</span>
       user_level<span class="token punctuation">,</span>
       birthday<span class="token punctuation">,</span>
       gender<span class="token punctuation">,</span>
       create_time<span class="token punctuation">,</span>
       operate_time<span class="token punctuation">,</span>
       start_date<span class="token punctuation">,</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>rn <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> date_sub<span class="token punctuation">(</span><span class="token string">'2022-06-09'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end_date<span class="token punctuation">)</span>     end_date<span class="token punctuation">,</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>rn <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'9999-12-31'</span><span class="token punctuation">,</span> date_sub<span class="token punctuation">(</span><span class="token string">'2022-06-09'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> dt
<span class="token keyword">from</span> <span class="token punctuation">(</span>
         <span class="token keyword">select</span> id<span class="token punctuation">,</span>
                name<span class="token punctuation">,</span>
                phone_num<span class="token punctuation">,</span>
                email<span class="token punctuation">,</span>
                user_level<span class="token punctuation">,</span>
                birthday<span class="token punctuation">,</span>
                gender<span class="token punctuation">,</span>
                create_time<span class="token punctuation">,</span>
                operate_time<span class="token punctuation">,</span>
                start_date<span class="token punctuation">,</span>
                end_date<span class="token punctuation">,</span>
                row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> id <span class="token keyword">order</span> <span class="token keyword">by</span> start_date <span class="token keyword">desc</span><span class="token punctuation">)</span> rn
         <span class="token keyword">from</span> <span class="token punctuation">(</span>
                  <span class="token keyword">select</span> id<span class="token punctuation">,</span>
                         name<span class="token punctuation">,</span>
                         phone_num<span class="token punctuation">,</span>
                         email<span class="token punctuation">,</span>
                         user_level<span class="token punctuation">,</span>
                         birthday<span class="token punctuation">,</span>
                         gender<span class="token punctuation">,</span>
                         create_time<span class="token punctuation">,</span>
                         operate_time<span class="token punctuation">,</span>
                         start_date<span class="token punctuation">,</span>
                         end_date
                  <span class="token keyword">from</span> dim_user_zip
                  <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'9999-12-31'</span>
                  <span class="token keyword">union</span>
                  <span class="token keyword">select</span> id<span class="token punctuation">,</span>
                         concat<span class="token punctuation">(</span>substr<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span>                name<span class="token punctuation">,</span>
                         <span class="token keyword">if</span><span class="token punctuation">(</span>phone_num <span class="token operator">regexp</span>
                            <span class="token string">'^(13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\\d{8}$'</span><span class="token punctuation">,</span>
                            concat<span class="token punctuation">(</span>substr<span class="token punctuation">(</span>phone_num<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> phone_num<span class="token punctuation">,</span>
                         <span class="token keyword">if</span><span class="token punctuation">(</span>email <span class="token operator">regexp</span> <span class="token string">'^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\\.[a-zA-Z0-9_-]+)+$'</span><span class="token punctuation">,</span>
                            concat<span class="token punctuation">(</span><span class="token string">'*@'</span><span class="token punctuation">,</span> split<span class="token punctuation">(</span>email<span class="token punctuation">,</span> <span class="token string">'@'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span>   email<span class="token punctuation">,</span>
                         user_level<span class="token punctuation">,</span>
                         birthday<span class="token punctuation">,</span>
                         gender<span class="token punctuation">,</span>
                         create_time<span class="token punctuation">,</span>
                         operate_time<span class="token punctuation">,</span>
                         <span class="token string">'2022-06-09'</span>                                   start_date<span class="token punctuation">,</span>
                         <span class="token string">'9999-12-31'</span>                                   end_date
                  <span class="token keyword">from</span> <span class="token punctuation">(</span>
                           <span class="token keyword">select</span> <span class="token keyword">data</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span>
                                  <span class="token keyword">data</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                                  <span class="token keyword">data</span><span class="token punctuation">.</span>phone_num<span class="token punctuation">,</span>
                                  <span class="token keyword">data</span><span class="token punctuation">.</span>email<span class="token punctuation">,</span>
                                  <span class="token keyword">data</span><span class="token punctuation">.</span>user_level<span class="token punctuation">,</span>
                                  <span class="token keyword">data</span><span class="token punctuation">.</span>birthday<span class="token punctuation">,</span>
                                  <span class="token keyword">data</span><span class="token punctuation">.</span>gender<span class="token punctuation">,</span>
                                  <span class="token keyword">data</span><span class="token punctuation">.</span>create_time<span class="token punctuation">,</span>
                                  <span class="token keyword">data</span><span class="token punctuation">.</span>operate_time<span class="token punctuation">,</span>
                                  row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token keyword">data</span><span class="token punctuation">.</span>id <span class="token keyword">order</span> <span class="token keyword">by</span> ts <span class="token keyword">desc</span><span class="token punctuation">)</span> rn
                           <span class="token keyword">from</span> ods_user_info_inc
                           <span class="token keyword">where</span> dt <span class="token operator">=</span> <span class="token string">'2022-06-09'</span>
                       <span class="token punctuation">)</span> t1
                  <span class="token keyword">where</span> rn <span class="token operator">=</span> <span class="token number">1</span>
              <span class="token punctuation">)</span> t2
     <span class="token punctuation">)</span> t3<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="CTE___1957"></a>CTE : 共通表表达式</h3> 
<pre><code class="prism language-sql"><span class="token keyword">with</span>
aa <span class="token keyword">as</span> <span class="token punctuation">(</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_table_part <span class="token punctuation">)</span><span class="token punctuation">,</span>
ab <span class="token keyword">as</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> aa<span class="token punctuation">)</span>
<span class="token keyword">select</span>
    <span class="token operator">*</span>
<span class="token keyword">from</span> aa
<span class="token keyword">join</span> ab<span class="token punctuation">;</span>

<span class="token keyword">select</span>
    <span class="token operator">*</span>
<span class="token keyword">from</span> <span class="token punctuation">(</span>
     <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_table_part
<span class="token punctuation">)</span>  aa
<span class="token keyword">join</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_table_part
<span class="token punctuation">)</span> bb<span class="token punctuation">;</span>

<span class="token keyword">select</span>
    <span class="token operator">*</span>
<span class="token keyword">from</span> dim_sku_full
</code></pre> 
<h3><a id="_1982"></a>拉链表设计</h3> 
<pre><code class="prism language-sql"><span class="token comment">-- 数据装载</span>
    <span class="token comment">-- load</span>
    <span class="token comment">-- save</span>
    <span class="token comment">-- 增量表得数据操作一般都会写2个</span>
        <span class="token comment">-- 首日数据装载</span>
        <span class="token comment">-- 每日数据装载</span>
<span class="token comment">-- 首日数据装载</span>
    <span class="token comment">-- 同步方式：maxwell - 全量 - bootstrap - select * from user_info</span>
        <span class="token comment">-- MySQL不保存行为数据，也就意味着不保存历史行为数据</span>
    <span class="token comment">-- 拉链表会在当前表得字段得基础上，额外添加两个字段（start, end），用于标记状态得有效范围</span>
        <span class="token comment">-- start : 无法判断开始范围</span>
        <span class="token comment">-- end   : 无法判断</span>
        <span class="token comment">-- 折中地考虑</span>
            <span class="token comment">-- 从当天开始，结束时间取时间极大值（避免数据频繁修改）</span>
        <span class="token comment">-- 分区策略</span>
            <span class="token comment">-- 绝大多数得维度表得分区策略都是以天为单位</span>
                <span class="token comment">-- 分区不能采用开始日期作为分区字段</span>
                    <span class="token comment">-- 无法判断数据是否为历史状态还是最新状态</span>
                    <span class="token comment">-- 好得方式是使用结束时间为分区字段</span>
</code></pre> 
<h3><a id="_2006"></a>任务调度器</h3> 
<p>保证每一层的SQL跑完再跑下一层<br> <img src="https://images2.imgbox.com/f1/2a/7lqqfi8T_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e924ecfb65017439c9731c9ded83fa60/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">用JavaScript将 NCR（Numeric Character Reference）标记转换为对应字符的方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/48843f9826eeebb89f9799e1e9015fee/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【人工智能】Transformers之Pipeline（概述）：30w&#43;大模型极简应用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>