<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>电力需求预测挑战赛｜Datawhale AI夏令营第二期｜代码及笔记分享 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/16e08288d1f69da4f0532fa71aaa9cfd/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="电力需求预测挑战赛｜Datawhale AI夏令营第二期｜代码及笔记分享">
  <meta property="og:description" content="最新分数：215.14567（13/1605）
赛题简介 赛事链接：电力需求预测挑战赛（科大讯飞xDatawhale）
给定多个房屋对应电力消耗历史N天的相关序列数据等信息，预测房屋对应电力的消耗。主要特征包括房屋id，日标识dt（1为数据集最近1天），房屋类型type，预测目标电力消耗target。本赛题是一个典型的多变量时间序列问题。当下时间序列预测的方法主要有三种：
1.传统的时间序列预测方法，ARIMA和指数平滑法
2.基于机器学习的方法，lightgbm、xgboost、catboost
3.基于深度学习的方法，RNN、LSTM、Wavenet
数据读取 导入必要的库，pandas、numpy、scipy等用于数据读取和计算，sklearn、lightgbm、xgboost、catboost等用于模型训练，tqdm用于处理进程的可视化展示，joblib用于模型的保存和加载，以及其他涉及系统变量的库。
训练集共有2877305行数据，时间范围为11-506不等。
测试集共有58320行数据，时间范围为1-10。
探索性数据分析 基本信息
定义data_stats函数展示数据集的基本信息情况，包括属性个数、最大属性占比、特征类型。
def data_stats(data): stats = [] for col in data.columns: stats.append((col, data[col].nunique(), round(data[col].value_counts(normalize = True, dropna = False).values[0] * 100, 3), data[col].dtype)) stats_df = pd.DataFrame(stats, columns = [&#39;特征&#39;,&#39;属性个数&#39;,&#39;最大属性占比&#39;,&#39;特征类型&#39;]) return stats_df data_stats(train) 特征属性个数最大属性占比特征类型0id58320.017object1dt4960.203int642type1920.722int643target1813040.004float64 data_stats(test) 特征属性个数最大属性占比特征类型0id58320.017object1dt1010.000int642type1920.645int64 不同type类型对应target的柱状图
可以发现不同type对应的电力需求存在比较大的差异，因此type应该是模型训练中的一个重要特征，可以根据type构建多个特征。
type_target_df = train.groupby(&#39;type&#39;)[&#39;target&#39;].mean().reset_index() plt.figure(figsize=(8, 4)) plt.bar(type_target_df[&#39;type&#39;], type_target_df[&#39;target&#39;], color=[&#39;#5ba2e6&#39;, &#39;#f89732&#39;]) plt.xlabel(&#39;Type&#39;) plt.ylabel(&#39;Average Target Value&#39;) plt.title(&#39;Bar Chart of Target by Type&#39;) plt.show() 不同id的target变化趋势折线图">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-21T07:22:56+08:00">
    <meta property="article:modified_time" content="2024-07-21T07:22:56+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">电力需求预测挑战赛｜Datawhale AI夏令营第二期｜代码及笔记分享</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>最新分数：215.14567（13/1605）<br> <img src="https://images2.imgbox.com/ae/20/Xy5x4QQ3_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_2"></a>赛题简介</h2> 
<p>赛事链接：<a href="https://challenge.xfyun.cn/topic/info?type=electricity-demand&amp;option=ssgy&amp;ch=dw24_3Gp2Ih" rel="nofollow">电力需求预测挑战赛（科大讯飞xDatawhale）</a><br> 给定多个房屋对应电力消耗历史N天的相关序列数据等信息，预测房屋对应电力的消耗。主要特征包括<strong>房屋id，日标识dt（1为数据集最近1天），房屋类型type，预测目标电力消耗target</strong>。本赛题是一个典型的<strong>多变量</strong>时间序列问题。当下时间序列预测的方法主要有三种：<br> 1.传统的时间序列预测方法，ARIMA和指数平滑法<br> 2.基于机器学习的方法，lightgbm、xgboost、catboost<br> 3.基于深度学习的方法，RNN、LSTM、Wavenet</p> 
<h2><a id="_8"></a>数据读取</h2> 
<p><strong>导入必要的库</strong>，pandas、numpy、scipy等用于数据读取和计算，sklearn、lightgbm、xgboost、catboost等用于模型训练，tqdm用于处理进程的可视化展示，joblib用于模型的保存和加载，以及其他涉及系统变量的库。<br> <strong>训练集</strong>共有2877305行数据，时间范围为11-506不等。<br> <strong>测试集</strong>共有58320行数据，时间范围为1-10。</p> 
<h2><a id="_12"></a>探索性数据分析</h2> 
<p><strong>基本信息</strong><br> 定义data_stats函数展示数据集的基本信息情况，包括属性个数、最大属性占比、特征类型。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">data_stats</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    stats <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> col <span class="token keyword">in</span> data<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
        stats<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> data<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>nunique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token builtin">round</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span>normalize <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> dropna <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      data<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">)</span>
        stats_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>stats<span class="token punctuation">,</span> columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'特征'</span><span class="token punctuation">,</span><span class="token string">'属性个数'</span><span class="token punctuation">,</span><span class="token string">'最大属性占比'</span><span class="token punctuation">,</span><span class="token string">'特征类型'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> stats_df
</code></pre> 
<pre><code class="prism language-python">data_stats<span class="token punctuation">(</span>train<span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>特征</th><th>属性个数</th><th>最大属性占比</th><th>特征类型</th></tr></thead><tbody><tr><th>0</th><td>id</td><td>5832</td><td>0.017</td><td>object</td></tr><tr><th>1</th><td>dt</td><td>496</td><td>0.203</td><td>int64</td></tr><tr><th>2</th><td>type</td><td>19</td><td>20.722</td><td>int64</td></tr><tr><th>3</th><td>target</td><td>181304</td><td>0.004</td><td>float64</td></tr></tbody></table> 
<pre><code class="prism language-python">data_stats<span class="token punctuation">(</span>test<span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>特征</th><th>属性个数</th><th>最大属性占比</th><th>特征类型</th></tr></thead><tbody><tr><th>0</th><td>id</td><td>5832</td><td>0.017</td><td>object</td></tr><tr><th>1</th><td>dt</td><td>10</td><td>10.000</td><td>int64</td></tr><tr><th>2</th><td>type</td><td>19</td><td>20.645</td><td>int64</td></tr></tbody></table> 
<p><strong>不同type类型对应target的柱状图</strong><br> 可以发现不同type对应的电力需求存在比较大的差异，因此type应该是模型训练中的一个重要特征，可以根据type构建多个特征。</p> 
<pre><code class="prism language-python">type_target_df <span class="token operator">=</span> train<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>type_target_df<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> type_target_df<span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'#5ba2e6'</span><span class="token punctuation">,</span> <span class="token string">'#f89732'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Type'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'Average Target Value'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Bar Chart of Target by Type'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6a/34/DkcImyR9_o.png" alt="在这里插入图片描述"><br> <strong>不同id的target变化趋势折线图</strong><br> 可以看到不同id的电力需求变化趋势存在着很大的差异，因此对于id也可以尝试进行标签编码作为类别特征用于模型训练。</p> 
<pre><code class="prism language-python">unique_ids <span class="token operator">=</span> train<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>
fig<span class="token punctuation">,</span> axes <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sharex<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> sharey<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
axes <span class="token operator">=</span> axes<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i<span class="token punctuation">,</span> unique_id <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>unique_ids<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    specific_id_df <span class="token operator">=</span> train<span class="token punctuation">[</span>train<span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">==</span> unique_id<span class="token punctuation">]</span>
    axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>plot<span class="token punctuation">(</span>specific_id_df<span class="token punctuation">[</span><span class="token string">'dt'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> specific_id_df<span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> linestyle<span class="token operator">=</span><span class="token string">'-'</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'#5ba2e6'</span><span class="token punctuation">)</span>
    axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"ID: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>unique_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'DateTime'</span><span class="token punctuation">)</span>
    axes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Target Value'</span><span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>tight_layout<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/82/a2/gvd8HP1P_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_183"></a>特征工程</h2> 
<h3><a id="_185"></a>特征构造</h3> 
<h4><a id="_186"></a>历史平移特征</h4> 
<p>提取具有相似性的信息，将t-1、t-2、…、t-n个时间单位的值用作第t个时间单位的特征，时间区间为<strong>一个月左右</strong>，也可以根据数据的<strong>周期性</strong>来确定。</p> 
<pre><code class="prism language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shift<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    
data<span class="token punctuation">[</span><span class="token string">'3_mean_target'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'target_shift10'</span><span class="token punctuation">]</span> <span class="token operator">+</span> data<span class="token punctuation">[</span><span class="token string">'target_shift11'</span><span class="token punctuation">]</span> <span class="token operator">+</span> data<span class="token punctuation">[</span><span class="token string">'target_shift12'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span>
data<span class="token punctuation">[</span><span class="token string">'5_mean_target'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'3_mean_target'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> data<span class="token punctuation">[</span><span class="token string">'target_shift13'</span><span class="token punctuation">]</span> <span class="token operator">+</span> data<span class="token punctuation">[</span><span class="token string">'target_shift14'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">5</span>
data<span class="token punctuation">[</span><span class="token string">'7_mean_target'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'5_mean_target'</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">5</span> <span class="token operator">+</span> data<span class="token punctuation">[</span><span class="token string">'target_shift15'</span><span class="token punctuation">]</span> <span class="token operator">+</span> data<span class="token punctuation">[</span><span class="token string">'target_shift16'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">7</span>
</code></pre> 
<h4><a id="_196"></a>历史平移+差分特征</h4> 
<p>可以帮助获取相邻阶段的增长差异，描述数据的涨减变化情况。</p> 
<pre><code class="prism language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> d <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">_diff</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>d<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span><span class="token punctuation">.</span>diff<span class="token punctuation">(</span>d<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_203"></a>窗口统计特征</h4> 
<p>窗口统计可以构建不同的窗口大小，然后基于窗口范围进统计均值、最大值、最小值、中位数、方差的信息，可以反映最近阶段数据的变化情况。</p> 
<pre><code class="prism language-python"><span class="token keyword">for</span> win <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">180</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">360</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_win</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>win<span class="token punctuation">}</span></span><span class="token string">_mean'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>win<span class="token punctuation">,</span> min_periods<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> closed<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
    data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_win</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>win<span class="token punctuation">}</span></span><span class="token string">_max'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>win<span class="token punctuation">,</span> min_periods<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> closed<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
    data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_win</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>win<span class="token punctuation">}</span></span><span class="token string">_min'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>win<span class="token punctuation">,</span> min_periods<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> closed<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
    data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_win</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>win<span class="token punctuation">}</span></span><span class="token string">_std'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>win<span class="token punctuation">,</span> min_periods<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> closed<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
</code></pre> 
<h4><a id="_213"></a>历史平移+窗口统计特征</h4> 
<p>通过历史平移获取上个阶段的信息。</p> 
<pre><code class="prism language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> win <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">150</span><span class="token punctuation">,</span><span class="token number">180</span><span class="token punctuation">,</span><span class="token number">240</span><span class="token punctuation">,</span><span class="token number">360</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">_win</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>win<span class="token punctuation">}</span></span><span class="token string">_mean'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>win<span class="token punctuation">,</span> min_periods<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> closed<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
        data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">_win</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>win<span class="token punctuation">}</span></span><span class="token string">_max'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>win<span class="token punctuation">,</span> min_periods<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> closed<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
        data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">_win</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>win<span class="token punctuation">}</span></span><span class="token string">_min'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>win<span class="token punctuation">,</span> min_periods<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> closed<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
        data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">_win</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>win<span class="token punctuation">}</span></span><span class="token string">_sum'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>win<span class="token punctuation">,</span> min_periods<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> closed<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
        data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">_win</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>win<span class="token punctuation">}</span></span><span class="token string">_std'</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'target_shift</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">]</span><span class="token punctuation">.</span>rolling<span class="token punctuation">(</span>window<span class="token operator">=</span>win<span class="token punctuation">,</span> min_periods<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> closed<span class="token operator">=</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
</code></pre> 
<h4><a id="_225"></a>自动化特征构造</h4> 
<p>OpenFE是一个自动化特征生成的框架，可以高效的构建有效的新特征，显著地提升GBDT（例如LightGBM，XGBoost等）和各种SOTA神经网络（例如Transformer，AutoInt，TabNet等）在表格类数据的效果。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> openfe <span class="token keyword">import</span> OpenFE<span class="token punctuation">,</span> tree_to_formula<span class="token punctuation">,</span> transform<span class="token punctuation">,</span> TwoStageFeatureSelector
ofe <span class="token operator">=</span> OpenFE<span class="token punctuation">(</span><span class="token punctuation">)</span>
ofe_features <span class="token operator">=</span> ofe<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>data<span class="token operator">=</span>train_x<span class="token punctuation">,</span> label<span class="token operator">=</span>train_y<span class="token punctuation">,</span>
                       metric<span class="token operator">=</span><span class="token string">'rmse'</span><span class="token punctuation">,</span> categorical_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                       n_data_blocks<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> feature_boosting<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                       n_jobs<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> task<span class="token operator">=</span><span class="token string">'regression'</span><span class="token punctuation">,</span>verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
fs <span class="token operator">=</span> TwoStageFeatureSelector<span class="token punctuation">(</span>metric<span class="token operator">=</span><span class="token string">'rmse'</span><span class="token punctuation">,</span> categorical_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>n_jobs<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
features <span class="token operator">=</span> fs<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>data<span class="token operator">=</span>train_x<span class="token punctuation">,</span> label<span class="token operator">=</span>train_y<span class="token punctuation">)</span>
</code></pre> 
<p>根据上述的自动化特征构造和选择，可以构建如下的特征：</p> 
<pre><code class="prism language-python">data<span class="token punctuation">[</span><span class="token string">'GroupByThenRank_id_type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rank<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> pct<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
data<span class="token punctuation">[</span><span class="token string">'GroupByThenRank_dt_type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'dt'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rank<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> pct<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values
data<span class="token punctuation">[</span><span class="token string">'log_dt'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>log<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>dt<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>nan<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_244"></a>相关性分析</h3> 
<p>相关性分析被广泛应用于评估特征与目标变量之间的相关性。通过计算相关系数或其他相关性度量，我们可以筛选出与目标变量相关性较高的特征。设定合适的阈值，我们可以选择保留相关性高于阈值的特征，从而减少特征空间的维度，提高模型的训练效率。</p> 
<pre><code class="prism language-python">train_se <span class="token operator">=</span> data_fe<span class="token punctuation">[</span>data_fe<span class="token punctuation">.</span>target<span class="token punctuation">.</span>notnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
features <span class="token operator">=</span> train_se<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
corr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> feat <span class="token keyword">in</span> features<span class="token punctuation">:</span>
    corr<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>train_se<span class="token punctuation">[</span><span class="token punctuation">[</span>feat<span class="token punctuation">,</span> <span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>corr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

se <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>corr<span class="token punctuation">,</span> index<span class="token operator">=</span>features<span class="token punctuation">)</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_256"></a>模型训练</h2> 
<pre><code class="prism language-python"><span class="token comment"># 进行数据切分</span>
train <span class="token operator">=</span> data_fe<span class="token punctuation">[</span>data_fe<span class="token punctuation">.</span>target<span class="token punctuation">.</span>notnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test <span class="token operator">=</span> data_fe<span class="token punctuation">[</span>data_fe<span class="token punctuation">.</span>target<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 确定输入特征</span>
train_cols <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> data_fe<span class="token punctuation">.</span>columns <span class="token keyword">if</span> f <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">,</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="_267"></a>交叉验证</h3> 
<p>关于时间序列数据的交叉验证，能够直接使用且不打乱时间顺序的有TimeSeriesSplit、K-Fold方法，此外还有MonteCarloCV、GroupTimeSeriesSplit两种自定义的方法。<br> <strong>TimeSeriesSplit</strong>：时间序列被分成几个大小相等的折叠，然后每一次折首先被用来测试一个模型，然后重新训练它，除了第一折只用于训练。<br> <strong>K-Fold</strong>：将原始数据集分成K个子集，称为折（fold）。 然后，模型在K个不同的训练集上进行K次训练和验证，在每次训练中，其中一个折被作为验证集，而剩下的K-1个折被用作训练集。在某些情况下，K-fold交叉验证对时间序列是有用的。<br> <strong>MonteCarloCV</strong>：训练集的大小在每次迭代过程中都是固定的，验证原点是随机选择的，这个原点标志着训练集的结束和验证的开始。<br> <strong>GroupTimeSeriesSplit</strong>：首先计算一下unique的个数，根据group的分组进行相关的按照时间的组合，每次平移一个group，其中前几个group对应的数据为训练集，而紧接着时间后的一个group的数据为验证集。<br> 在本数据集中，由于整个数据的时间序列不是连续的，只是每个id对应的时间序列是连续的，因此保留观测的时间顺序反而不是很有效，甚至会降低分数，在这里依旧适用K-Fold的方法，使用shuffle=True来打乱顺序。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> StratifiedKFold<span class="token punctuation">,</span> KFold<span class="token punctuation">,</span> GroupKFold
<span class="token keyword">import</span> lightgbm <span class="token keyword">as</span> lgb
<span class="token keyword">import</span> xgboost <span class="token keyword">as</span> xgb
<span class="token keyword">from</span> catboost <span class="token keyword">import</span> CatBoostRegressor
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error<span class="token punctuation">,</span> mean_absolute_error
<span class="token keyword">def</span> <span class="token function">cv_model</span><span class="token punctuation">(</span>clf<span class="token punctuation">,</span> train_x<span class="token punctuation">,</span> train_y<span class="token punctuation">,</span> test_x<span class="token punctuation">,</span> clf_name<span class="token punctuation">,</span> seed <span class="token operator">=</span> <span class="token number">2024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    clf：调用模型
    train_x：训练数据
    train_y：训练数据对应标签
    test_x：测试数据
    clf_name：选择使用模型名
    seed：随机种子
    '''</span>
    folds <span class="token operator">=</span> <span class="token number">5</span>
    kf <span class="token operator">=</span> KFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span>folds<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span>seed<span class="token punctuation">)</span>
    oof <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>train_x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    test_predict <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>test_x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    cv_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>train_index<span class="token punctuation">,</span> valid_index<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>train_x<span class="token punctuation">,</span> train_y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'************************************ {} ************************************'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        trn_x<span class="token punctuation">,</span> trn_y<span class="token punctuation">,</span> val_x<span class="token punctuation">,</span> val_y <span class="token operator">=</span> train_x<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span><span class="token punctuation">,</span> train_y<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span><span class="token punctuation">,</span> train_x<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>valid_index<span class="token punctuation">]</span><span class="token punctuation">,</span> train_y<span class="token punctuation">[</span>valid_index<span class="token punctuation">]</span>
        
        <span class="token keyword">if</span> clf_name <span class="token operator">==</span> <span class="token string">"lgb"</span><span class="token punctuation">:</span>
            train_matrix <span class="token operator">=</span> clf<span class="token punctuation">.</span>Dataset<span class="token punctuation">(</span>trn_x<span class="token punctuation">,</span> label<span class="token operator">=</span>trn_y<span class="token punctuation">)</span>
            valid_matrix <span class="token operator">=</span> clf<span class="token punctuation">.</span>Dataset<span class="token punctuation">(</span>val_x<span class="token punctuation">,</span> label<span class="token operator">=</span>val_y<span class="token punctuation">)</span>
            params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'boosting_type'</span><span class="token punctuation">:</span> <span class="token string">'gbdt'</span><span class="token punctuation">,</span>
                <span class="token string">'objective'</span><span class="token punctuation">:</span> <span class="token string">'regression'</span><span class="token punctuation">,</span>
                <span class="token string">'metric'</span><span class="token punctuation">:</span> <span class="token string">'mae'</span><span class="token punctuation">,</span>
                <span class="token string">'min_child_weight'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
                <span class="token string">'num_leaves'</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token operator">**</span> <span class="token number">6</span><span class="token punctuation">,</span>
                <span class="token string">'lambda_l2'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
                <span class="token string">'feature_fraction'</span><span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>
                <span class="token string">'bagging_fraction'</span><span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>
                <span class="token string">'bagging_freq'</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
                <span class="token string">'learning_rate'</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
                <span class="token string">'seed'</span><span class="token punctuation">:</span> <span class="token number">2024</span><span class="token punctuation">,</span>
                <span class="token string">'nthread'</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span>
            <span class="token punctuation">}</span>
            callback <span class="token operator">=</span> <span class="token punctuation">[</span>lgb<span class="token punctuation">.</span>early_stopping<span class="token punctuation">(</span>stopping_rounds<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            model <span class="token operator">=</span> clf<span class="token punctuation">.</span>train<span class="token punctuation">(</span>params<span class="token punctuation">,</span> train_matrix<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> valid_sets<span class="token operator">=</span><span class="token punctuation">[</span>train_matrix<span class="token punctuation">,</span> valid_matrix<span class="token punctuation">]</span><span class="token punctuation">,</span>
                              categorical_feature<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> callbacks <span class="token operator">=</span> callback<span class="token punctuation">)</span>
            val_pred <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>val_x<span class="token punctuation">,</span> num_iteration<span class="token operator">=</span>model<span class="token punctuation">.</span>best_iteration<span class="token punctuation">)</span>
            test_pred <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_x<span class="token punctuation">,</span> num_iteration<span class="token operator">=</span>model<span class="token punctuation">.</span>best_iteration<span class="token punctuation">)</span>
            joblib<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>model<span class="token punctuation">,</span><span class="token string">"lgbmodel_157_5.pkl"</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> clf_name <span class="token operator">==</span> <span class="token string">"xgb"</span><span class="token punctuation">:</span>
            xgb_params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">'booster'</span><span class="token punctuation">:</span> <span class="token string">'gbtree'</span><span class="token punctuation">,</span> 
              <span class="token string">'objective'</span><span class="token punctuation">:</span> <span class="token string">'reg:squarederror'</span><span class="token punctuation">,</span>
              <span class="token string">'eval_metric'</span><span class="token punctuation">:</span> <span class="token string">'mae'</span><span class="token punctuation">,</span>
              <span class="token string">'max_depth'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
              <span class="token string">'lambda'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
              <span class="token string">'subsample'</span><span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
              <span class="token string">'colsample_bytree'</span><span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
              <span class="token string">'colsample_bylevel'</span><span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
              <span class="token string">'eta'</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
              <span class="token string">'tree_method'</span><span class="token punctuation">:</span> <span class="token string">'hist'</span><span class="token punctuation">,</span>
              <span class="token string">'seed'</span><span class="token punctuation">:</span> <span class="token number">2024</span><span class="token punctuation">,</span>
              <span class="token string">'nthread'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span>
              <span class="token punctuation">}</span>
            train_matrix <span class="token operator">=</span> clf<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>trn_x <span class="token punctuation">,</span> label<span class="token operator">=</span>trn_y<span class="token punctuation">)</span>
            valid_matrix <span class="token operator">=</span> clf<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>val_x <span class="token punctuation">,</span> label<span class="token operator">=</span>val_y<span class="token punctuation">)</span>
            test_matrix <span class="token operator">=</span> clf<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>test_x<span class="token punctuation">)</span>
            
            watchlist <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>train_matrix<span class="token punctuation">,</span> <span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>valid_matrix<span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            
            model <span class="token operator">=</span> clf<span class="token punctuation">.</span>train<span class="token punctuation">(</span>xgb_params<span class="token punctuation">,</span> train_matrix<span class="token punctuation">,</span> num_boost_round<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> evals<span class="token operator">=</span>watchlist<span class="token punctuation">,</span> verbose_eval<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> early_stopping_rounds<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span>
            val_pred  <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>valid_matrix<span class="token punctuation">)</span>
            test_pred <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_matrix<span class="token punctuation">)</span>
            joblib<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>model<span class="token punctuation">,</span><span class="token string">"xgbmodel_157_5.pkl"</span><span class="token punctuation">)</span>
            
        <span class="token keyword">if</span> clf_name <span class="token operator">==</span> <span class="token string">"cat"</span><span class="token punctuation">:</span>
            params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'learning_rate'</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token string">'depth'</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'bootstrap_type'</span><span class="token punctuation">:</span><span class="token string">'Bernoulli'</span><span class="token punctuation">,</span>
                      <span class="token string">'thread_count'</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'od_type'</span><span class="token punctuation">:</span> <span class="token string">'Iter'</span><span class="token punctuation">,</span> <span class="token string">'od_wait'</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> 
                      <span class="token string">'random_seed'</span><span class="token punctuation">:</span> <span class="token number">2024</span><span class="token punctuation">,</span> <span class="token string">'allow_writing_files'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span>
            
            model <span class="token operator">=</span> clf<span class="token punctuation">(</span>iterations<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token operator">**</span>params<span class="token punctuation">)</span>
            model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>trn_x<span class="token punctuation">,</span> trn_y<span class="token punctuation">,</span> eval_set<span class="token operator">=</span><span class="token punctuation">(</span>val_x<span class="token punctuation">,</span> val_y<span class="token punctuation">)</span><span class="token punctuation">,</span>
                      use_best_model<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> 
                      metric_period<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
                      cat_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                      verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            
            val_pred  <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>val_x<span class="token punctuation">)</span>
            test_pred <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_x<span class="token punctuation">)</span>
            joblib<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>model<span class="token punctuation">,</span><span class="token string">"catmodel_165_5.pkl"</span><span class="token punctuation">)</span>
        
        oof<span class="token punctuation">[</span>valid_index<span class="token punctuation">]</span> <span class="token operator">=</span> val_pred
        test_predict <span class="token operator">+=</span> test_pred <span class="token operator">/</span> kf<span class="token punctuation">.</span>n_splits
        
        score <span class="token operator">=</span> mean_absolute_error<span class="token punctuation">(</span>val_y<span class="token punctuation">,</span> val_pred<span class="token punctuation">)</span>
        cv_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>score<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>cv_scores<span class="token punctuation">)</span>
        
    <span class="token keyword">return</span> oof<span class="token punctuation">,</span> test_predict

<span class="token comment"># 选择lightgbm模型</span>
lgb_oof<span class="token punctuation">,</span> lgb_test <span class="token operator">=</span> cv_model<span class="token punctuation">(</span>lgb<span class="token punctuation">,</span> train<span class="token punctuation">[</span>train_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> train<span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test<span class="token punctuation">[</span>train_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'lgb'</span><span class="token punctuation">)</span>
<span class="token comment"># 选择xgboost模型</span>
xgb_oof<span class="token punctuation">,</span> xgb_test <span class="token operator">=</span> cv_model<span class="token punctuation">(</span>xgb<span class="token punctuation">,</span> train<span class="token punctuation">[</span>train_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> train<span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test<span class="token punctuation">[</span>train_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'xgb'</span><span class="token punctuation">)</span>
<span class="token comment"># 选择catboost模型</span>
cat_oof<span class="token punctuation">,</span> cat_test <span class="token operator">=</span> cv_model<span class="token punctuation">(</span>CatBoostRegressor<span class="token punctuation">,</span> train<span class="token punctuation">[</span>train_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> train<span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test<span class="token punctuation">[</span>train_cols<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'cat'</span><span class="token punctuation">)</span>

<span class="token comment"># 进行取平均融合</span>
final_test <span class="token operator">=</span> <span class="token punctuation">(</span>lgb_test <span class="token operator">+</span> xgb_test <span class="token operator">+</span> cat_test<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span>
</code></pre> 
<h3><a id="_385"></a>模型融合</h3> 
<p>利用多个基学习器学习原数据，然后将这几个基学习学习到的数据交给第二层模型进行拟合。说白了就是将第一层模型的输出作为第二层模型的输入。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> Ridge
<span class="token keyword">def</span> <span class="token function">stack_model</span><span class="token punctuation">(</span>oof_1<span class="token punctuation">,</span> oof_2<span class="token punctuation">,</span> oof_3<span class="token punctuation">,</span> predictions_1<span class="token punctuation">,</span> predictions_2<span class="token punctuation">,</span> predictions_3<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">'''
    输入的oof_1, oof_2, oof_3可以对应lgb_oof，xgb_oof，cat_oof
    predictions_1, predictions_2, predictions_3对应lgb_test，xgb_test，cat_test
    '''</span>
    train_stack <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>oof_1<span class="token punctuation">,</span> oof_2<span class="token punctuation">,</span> oof_3<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    test_stack <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>predictions_1<span class="token punctuation">,</span> predictions_2<span class="token punctuation">,</span> predictions_3<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    oof <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>train_stack<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    predictions <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>test_stack<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> RepeatedKFold
    folds <span class="token operator">=</span> RepeatedKFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> n_repeats<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">2021</span><span class="token punctuation">)</span>
    
    <span class="token keyword">for</span> fold_<span class="token punctuation">,</span> <span class="token punctuation">(</span>trn_idx<span class="token punctuation">,</span> val_idx<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>folds<span class="token punctuation">.</span>split<span class="token punctuation">(</span>train_stack<span class="token punctuation">,</span> train_stack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"fold n°{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>fold_<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        trn_data<span class="token punctuation">,</span> trn_y <span class="token operator">=</span> train_stack<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>trn_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span>trn_idx<span class="token punctuation">]</span>
        val_data<span class="token punctuation">,</span> val_y <span class="token operator">=</span> train_stack<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span>
        
        clf <span class="token operator">=</span> Ridge<span class="token punctuation">(</span>random_state<span class="token operator">=</span><span class="token number">2021</span><span class="token punctuation">)</span>
        clf<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>trn_data<span class="token punctuation">,</span> trn_y<span class="token punctuation">)</span>

        oof<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span> <span class="token operator">=</span> clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>val_data<span class="token punctuation">)</span>
        predictions <span class="token operator">+=</span> clf<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_stack<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
        
        score_single <span class="token operator">=</span> mean_absolute_error<span class="token punctuation">(</span>val_y<span class="token punctuation">,</span> oof<span class="token punctuation">[</span>val_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
        scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>score_single<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>fold_<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token number">5</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> score_single<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'mean: '</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>scores<span class="token punctuation">)</span><span class="token punctuation">)</span>
   
    <span class="token keyword">return</span> oof<span class="token punctuation">,</span> predictions

stack_oof<span class="token punctuation">,</span> stack_pred <span class="token operator">=</span> stack_model<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>lgb_oof<span class="token punctuation">)</span><span class="token punctuation">,</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>xgb_oof<span class="token punctuation">)</span><span class="token punctuation">,</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cat_oof<span class="token punctuation">)</span><span class="token punctuation">,</span> 
                                    pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>lgb_test<span class="token punctuation">)</span><span class="token punctuation">,</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>xgb_test<span class="token punctuation">)</span><span class="token punctuation">,</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>cat_test<span class="token punctuation">)</span><span class="token punctuation">,</span> train<span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="Optuna_425"></a>Optuna超参数调优</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">cat_optuna</span><span class="token punctuation">(</span>trial<span class="token punctuation">,</span>data<span class="token operator">=</span>data<span class="token punctuation">,</span>target<span class="token operator">=</span>target<span class="token punctuation">)</span><span class="token punctuation">:</span>

    param <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'loss_function'</span><span class="token punctuation">:</span> <span class="token string">'RMSE'</span><span class="token punctuation">,</span>
        <span class="token string">'task_type'</span><span class="token punctuation">:</span> <span class="token string">'GPU'</span><span class="token punctuation">,</span>
        <span class="token string">'random_state'</span><span class="token punctuation">:</span> <span class="token number">2024</span><span class="token punctuation">,</span>
        <span class="token string">'n_estimators'</span><span class="token punctuation">:</span>  <span class="token number">1000</span><span class="token punctuation">,</span>
        <span class="token string">'od_type'</span><span class="token punctuation">:</span> <span class="token string">'Iter'</span><span class="token punctuation">,</span>
        <span class="token string">'od_wait'</span><span class="token punctuation">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
        <span class="token string">'use_best_model'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token string">'l2_leaf_reg'</span><span class="token punctuation">:</span> trial<span class="token punctuation">.</span>suggest_float<span class="token punctuation">(</span><span class="token string">'l2_leaf_reg'</span><span class="token punctuation">,</span> <span class="token number">1e-3</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'learning_rate'</span><span class="token punctuation">:</span> trial<span class="token punctuation">.</span>suggest_float<span class="token punctuation">(</span><span class="token string">'learning_rate'</span><span class="token punctuation">,</span> <span class="token number">0.001</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'max_depth'</span><span class="token punctuation">:</span> trial<span class="token punctuation">.</span>suggest_int<span class="token punctuation">(</span><span class="token string">'max_depth'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'bootstrap_type'</span><span class="token punctuation">:</span> trial<span class="token punctuation">.</span>suggest_categorical<span class="token punctuation">(</span><span class="token string">'bootstrap_type'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Bayesian'</span><span class="token punctuation">,</span> <span class="token string">'Bernoulli'</span><span class="token punctuation">,</span> <span class="token string">'MVS'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'min_data_in_leaf'</span><span class="token punctuation">:</span> trial<span class="token punctuation">.</span>suggest_int<span class="token punctuation">(</span><span class="token string">'min_data_in_leaf'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> param<span class="token punctuation">[</span><span class="token string">"bootstrap_type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"Bayesian"</span><span class="token punctuation">:</span>
        param<span class="token punctuation">[</span><span class="token string">"bagging_temperature"</span><span class="token punctuation">]</span> <span class="token operator">=</span> trial<span class="token punctuation">.</span>suggest_float<span class="token punctuation">(</span><span class="token string">"bagging_temperature"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> param<span class="token punctuation">[</span><span class="token string">"bootstrap_type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"Bernoulli"</span><span class="token punctuation">:</span>
        param<span class="token punctuation">[</span><span class="token string">"subsample"</span><span class="token punctuation">]</span> <span class="token operator">=</span> trial<span class="token punctuation">.</span>suggest_float<span class="token punctuation">(</span><span class="token string">"subsample"</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> log<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    kf <span class="token operator">=</span> KFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">2024</span><span class="token punctuation">)</span>
    catcv_scores<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>train_index<span class="token punctuation">,</span> valid_index<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>data<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'************************************ {} ************************************'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        trn_x<span class="token punctuation">,</span> trn_y<span class="token punctuation">,</span> val_x<span class="token punctuation">,</span> val_y <span class="token operator">=</span> data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>valid_index<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token punctuation">[</span>valid_index<span class="token punctuation">]</span>
        
        model <span class="token operator">=</span> CatBoostRegressor<span class="token punctuation">(</span><span class="token operator">**</span>param<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>trn_x<span class="token punctuation">,</span> trn_y<span class="token punctuation">,</span> eval_set<span class="token operator">=</span><span class="token punctuation">(</span>val_x<span class="token punctuation">,</span> val_y<span class="token punctuation">)</span><span class="token punctuation">,</span> cat_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">,</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                  verbose<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> early_stopping_rounds<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
        val_preds <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>val_x<span class="token punctuation">)</span>
        rmse <span class="token operator">=</span> mean_squared_error<span class="token punctuation">(</span>val_y<span class="token punctuation">,</span> val_preds<span class="token punctuation">)</span>
        catcv_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>rmse<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>catcv_scores<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>catcv_scores<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">optuna<span class="token punctuation">.</span>visualization<span class="token punctuation">.</span>plot_optimization_history<span class="token punctuation">(</span>study<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c8/82/vWEPxMFe_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">optuna<span class="token punctuation">.</span>visualization<span class="token punctuation">.</span>plot_param_importances<span class="token punctuation">(</span>study<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/04/84/Xq9QbMK8_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">optuna<span class="token punctuation">.</span>visualization<span class="token punctuation">.</span>plot_edf<span class="token punctuation">(</span>study<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f0/73/rHTx3iul_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_480"></a>参考资料</h2> 
<p>1.<a href="https://weread.qq.com/web/reader/33c325b07296e25333c79e7kecc32f3013eccbc87e4b62e" rel="nofollow">机器学习算法竞赛实战</a><br> 2.<a href="https://zg104.github.io/ML/tsfe.html#%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE%E7%9A%84%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B%E6%80%BB%E7%BB%93" rel="nofollow">时间序列数据的特征工程总结</a><br> 3.<a href="https://github.com/IIIS-Li-Group/OpenFE">OpenFE</a><br> 4.<a href="https://avoid.overfit.cn/post/6e8c6d96d4954f8589e6118cb351139d" rel="nofollow">时间序列的蒙特卡罗交叉验证</a><br> 5.<a href="https://avoid.overfit.cn/post/6e8c6d96d4954f8589e6118cb351139d" rel="nofollow">9个时间序列交叉验证方法的介绍和对比</a><br> 6.<a href="https://blog.csdn.net/qq_33431368/article/details/136064366">时间序列特有的交叉验证方法GroupTimeSeriesSplit</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/61074dfd49f6dfceeb50a8ab40a427b8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Flink调优详解：案例解析（第42天）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a863bed17046cdc3b0ec8b7bd291e61d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python酷库之旅-第三方库Pandas(035)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>