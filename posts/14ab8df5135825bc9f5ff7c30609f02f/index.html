<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spark SQL - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/14ab8df5135825bc9f5ff7c30609f02f/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Spark SQL">
  <meta property="og:description" content="Spark SQL 一、Spark SQL架构 能够直接访问现存的Hive数据
提供JDBC/ODBC接口供第三方工具借助Spark进行数据处理
提供更高层级的接口方便处理数据
支持多种操作方式：SQL、API编程
API编程：Spark SQL基于SQL开发了一套SQL语句的算子，名称和标准的SQL语句相似 支持Parquet、CSV、JSON、RDBMS、Hive、HBase等多种外部数据源。(掌握多种数据读取方式)
Spark SQL核心：是RDD&#43;Schema(算子&#43;表结构)，为了更方便我们操作，会将RDD&#43;Schema发给DataFrame
数据回灌：用于将处理和清洗后的数据回写到Hive中，以供后续分析和使用。
BI Tools：主要用于数据呈现。
Spark Application：开发人员使用Spark Application编写数据处理和分析逻辑，这些应用可以用不同的编程语言编写，比如Python、Scala、Java等。
二、Spark SQL运行原理 Catalyst优化器的运行流程： Frontend（前端） 输入：用户可以通过SQL查询或DataFrame API来输入数据处理逻辑。Unresolved Logical Plan（未解析的逻辑计划）：输入的SQL查询或DataFrame转换操作会首先被转换为一个未解析的逻辑计划，这个计划包含了用户请求的所有操作，但其中的表名和列名等可能尚未解析。 Catalyst Optimizer（Catalyst优化器） Catalyst优化器是Spark SQL的核心组件，它负责将逻辑计划转换为物理执行计划，并进行优化。Catalyst优化器包括以下几个阶段： Analysis（分析）：将未解析的逻辑计划中的表名和列名解析为具体的元数据，这一步依赖于Catalog（元数据存储）。输出是一个解析后的逻辑计划。Logical Optimization（逻辑优化）：对解析后的逻辑计划进行各种优化，如投影剪切、过滤下推等。优化后的逻辑计划更加高效。Physical Planning（物理计划）：将优化后的逻辑计划转换为一个或多个物理执行计划。每个物理计划都代表了一种可能的执行方式。Cost Model（成本模型）：评估不同物理计划的执行成本，选择代价最低的物理计划作为最终的物理计划。 Backend（后端） Code Generation（代码生成）：将选择的物理计划转换为可以在Spark上执行的RDD操作。这一步会生成实际的执行代码。RDDs：最终生成的RDD操作被执行，以完成用户请求的数据处理任务。 一个SQL查询在Spark SQL中的优化流程 SELECT name FROM( SELECT id, name FROM people ) p WHERE p.id = 1 Filter下压：将Filter操作推到更靠近数据源的位置，以减少不必要的数据处理。合并Projection：减少不必要的列选择IndexLookup return:name：如果存在索引，可以直接通过索引查找并返回name列 三、Spark SQL API SparkContext：Spark应用的主入口，代表了与Spark集群的连接。
SQLContext：Spark SQL的编程入口，使用SQLContext可以运行SQL查询、加载数据源和创建DataFrame。
HiveContext：SQLContext的一个子集，可以执行HiveQL查询，并且可以访问Hive元数据和UDF。
SparkSession：Spark2.0后推荐使用，合并了SQLContext和HiveContext，提供了与Spark所有功能交互的单一入口点。
创建一个SparkSession就包含了一个SparkContext。
若同时需要创建SparkContext和SparkSession，必须先创建SparkContext再创建SparkSession。否则，会抛出如下异常，提示重复创建SparkContext：
详细解释 创建SparkSession的代码 val conf: SparkConf = new SparkConf() .">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-14T16:34:38+08:00">
    <meta property="article:modified_time" content="2024-07-14T16:34:38+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spark SQL</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/d0/bf/D5r1SMtc_o.gif" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9e/d9/mpj1JF6e_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Spark_SQL_3"></a>Spark SQL</h3> 
<h4><a id="Spark_SQL_5"></a>一、Spark SQL架构</h4> 
<ul><li> <p>能够直接访问现存的Hive数据</p> </li><li> <p>提供JDBC/ODBC接口供第三方工具借助Spark进行数据处理</p> </li><li> <p>提供更高层级的接口方便处理数据</p> </li><li> <p>支持多种操作方式：SQL、API编程</p> 
  <ul><li>API编程：Spark SQL基于SQL开发了一套SQL语句的算子，名称和标准的SQL语句相似</li></ul> </li><li> <p>支持Parquet、CSV、JSON、RDBMS、Hive、HBase等多种外部数据源。(掌握多种数据读取方式)<br> <img src="https://images2.imgbox.com/7d/0d/vwD4LXWL_o.png" alt="在这里插入图片描述"></p> </li><li> <p>Spark SQL核心：是<strong>RDD+Schema</strong>(算子+表结构)，为了更方便我们操作，会将<strong>RDD+Schema</strong>发给<strong>DataFrame</strong></p> </li><li> <p>数据回灌：用于将处理和清洗后的数据回写到Hive中，以供后续分析和使用。</p> </li><li> <p>BI Tools：主要用于数据呈现。</p> </li><li> <p>Spark Application：开发人员使用Spark Application编写数据处理和分析逻辑，这些应用可以用不同的编程语言编写，比如Python、Scala、Java等。</p> </li></ul> 
<h4><a id="Spark_SQL_25"></a>二、Spark SQL运行原理</h4> 
<p><img src="https://images2.imgbox.com/16/eb/evJ9u9Vb_o.png" alt="在这里插入图片描述"></p> 
<ul><li>Catalyst优化器的运行流程：</li></ul> 
<ol><li><strong>Frontend（前端）</strong> 
  <ul><li><strong>输入</strong>：用户可以通过SQL查询或DataFrame API来输入数据处理逻辑。</li><li><strong>Unresolved Logical Plan（未解析的逻辑计划）</strong>：输入的SQL查询或DataFrame转换操作会首先被转换为一个未解析的逻辑计划，这个计划包含了用户请求的所有操作，但其中的表名和列名等可能尚未解析。</li></ul> </li><li><strong>Catalyst Optimizer（Catalyst优化器）</strong> Catalyst优化器是Spark SQL的核心组件，它负责将逻辑计划转换为物理执行计划，并进行优化。Catalyst优化器包括以下几个阶段： 
  <ul><li><strong>Analysis（分析）</strong>：将未解析的逻辑计划中的表名和列名解析为具体的元数据，这一步依赖于Catalog（元数据存储）。输出是一个解析后的逻辑计划。</li><li><strong>Logical Optimization（逻辑优化）</strong>：对解析后的逻辑计划进行各种优化，如投影剪切、过滤下推等。优化后的逻辑计划更加高效。</li><li><strong>Physical Planning（物理计划）</strong>：将优化后的逻辑计划转换为一个或多个物理执行计划。每个物理计划都代表了一种可能的执行方式。</li><li><strong>Cost Model（成本模型）</strong>：评估不同物理计划的执行成本，选择代价最低的物理计划作为最终的物理计划。</li></ul> </li><li><strong>Backend（后端）</strong> 
  <ul><li><strong>Code Generation（代码生成）</strong>：将选择的物理计划转换为可以在Spark上执行的RDD操作。这一步会生成实际的执行代码。</li><li><strong>RDDs</strong>：最终生成的RDD操作被执行，以完成用户请求的数据处理任务。</li></ul> </li></ol> 
<ul><li>一个SQL查询在Spark SQL中的优化流程</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> name <span class="token keyword">FROM</span><span class="token punctuation">(</span>
  <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> name <span class="token keyword">FROM</span> people
<span class="token punctuation">)</span> p
<span class="token keyword">WHERE</span> p<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cd/a9/D0MnmelR_o.png" alt="在这里插入图片描述"></p> 
<ul><li>Filter下压：将Filter操作推到更靠近数据源的位置，以减少不必要的数据处理。</li><li>合并Projection：减少不必要的列选择</li><li>IndexLookup return:name：如果存在索引，可以直接通过索引查找并返回<code>name</code>列</li></ul> 
<h4><a id="Spark_SQL_API_64"></a>三、Spark SQL API</h4> 
<ol><li> <p>SparkContext：Spark应用的主入口，代表了与Spark集群的连接。</p> </li><li> <p>SQLContext：Spark SQL的编程入口，使用SQLContext可以运行SQL查询、加载数据源和创建DataFrame。</p> </li><li> <p>HiveContext：SQLContext的一个子集，可以执行HiveQL查询，并且可以访问Hive元数据和UDF。</p> </li><li> <p><strong>SparkSession</strong>：Spark2.0后推荐使用，合并了SQLContext和HiveContext，提供了与Spark所有功能交互的单一入口点。</p> <p>创建一个SparkSession就包含了一个SparkContext。</p> </li><li> <p>若同时需要创建SparkContext和SparkSession，必须先创建SparkContext再创建SparkSession。否则，会抛出如下异常，提示重复创建SparkContext：</p> </li></ol> 
<h5><a id="_78"></a>详细解释</h5> 
<h6><a id="SparkSession_80"></a>创建SparkSession的代码</h6> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> conf<span class="token operator">:</span> SparkConf <span class="token operator">=</span> <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span><span class="token string">"local[4]"</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span><span class="token string">"SparkSql"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> 
	SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
		<span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="SparkSessionBuilder_93"></a>优化：减少创建代码，SparkSessionBuilder工具类</h6> 
<pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ybg</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>SparkConf<span class="token punctuation">,</span> SparkContext<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SparkSession

<span class="token comment">// 封装SparkSession的创建方法</span>
<span class="token keyword">class</span> SparkSessionBuilder<span class="token punctuation">(</span>master<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>appName<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">lazy</span> <span class="token keyword">val</span> config<span class="token operator">:</span>SparkConf <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">new</span> SparkConf<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setMaster<span class="token punctuation">(</span>master<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>setAppName<span class="token punctuation">(</span>appName<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">lazy</span> <span class="token keyword">val</span> spark<span class="token operator">:</span>SparkSession <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>config<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">lazy</span> <span class="token keyword">val</span> sc<span class="token operator">:</span>SparkContext <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    spark<span class="token punctuation">.</span>sparkContext
  <span class="token punctuation">}</span>

  <span class="token keyword">def</span> stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> spark<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      spark<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">object</span> SparkSessionBuilder <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> apply<span class="token punctuation">(</span>master<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> appName<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> SparkSessionBuilder <span class="token operator">=</span> <span class="token keyword">new</span> SparkSessionBuilder<span class="token punctuation">(</span>master<span class="token punctuation">,</span> appName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Spark_SQL_132"></a>四、Spark SQL依赖</h4> 
<h5><a id="pomxml_134"></a>pom.xml</h5> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spark.version</span><span class="token punctuation">&gt;</span></span>3.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spark.version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spark.scala.version</span><span class="token punctuation">&gt;</span></span>2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spark.scala.version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hadoop.version</span><span class="token punctuation">&gt;</span></span>3.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hadoop.version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mysql.version</span><span class="token punctuation">&gt;</span></span>8.0.33<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mysql.version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hive.version</span><span class="token punctuation">&gt;</span></span>3.1.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hive.version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hbase.version</span><span class="token punctuation">&gt;</span></span>2.3.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>hbase.version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jackson.version</span><span class="token punctuation">&gt;</span></span>2.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jackson.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- spark-core --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-core_${spark.scala.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

  <span class="token comment">&lt;!-- spark-sql --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.spark<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spark-sql_${spark.scala.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spark.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  若出现如下异常：
  Caused by: com.fasterxml.jackson.databind.JsonMappingException: 
  Scala module 2.10.0 requires Jackson Databind version &gt;= 2.10.0 and &lt; 2.11.0
    追加如下依赖：
	--&gt;
  <span class="token comment">&lt;!-- jackson-databind --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  
  <span class="token comment">&lt;!-- mysql --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${mysql.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="log4jproperties_187"></a>log4j.properties</h5> 
<p>log4j.properties应该放在资源包下。</p> 
<pre><code class="prism language-properties">log4j.rootLogger=ERROR, stdout, logfile # 设置可显示的信息等级
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%d %p [%c] - %m%n
log4j.appender.logfile=org.apache.log4j.FileAppender
log4j.appender.logfile.File=log/spark_first.log
log4j.appender.logfile.layout=org.apache.log4j.PatternLayout
log4j.appender.logfile.layout.ConversionPattern=%d %p [%c] - %m%n
</code></pre> 
<h4><a id="Spark_SQL_204"></a>五、Spark SQL数据集</h4> 
<h5><a id="1DataSet_206"></a>1、DataSet</h5> 
<ul><li><strong>简介</strong>： 
  <ul><li>从Spark 1.6开始引入的新的抽象。</li><li>是特定领域对象中的强类型集合。</li><li>可以使用函数式编程或SQL查询进行操作。</li><li>等于RDD + Schema。</li></ul> </li></ul> 
<h5><a id="2DataFrame_214"></a>2、DataFrame</h5> 
<ul><li><strong>简介：</strong> 
  <ul><li>DataFrame是特殊的DataSet：<code>DataFrame=DataSet[Row]</code>，行对象的集合，每一行就是一个行对象。</li><li>类似于传统数据的二维表格。</li></ul> </li><li><strong>特性</strong>： 
  <ul><li>Schema：在RDD基础上增加了Schema，描述数据结构信息</li><li>嵌套数据类型：支持<code>struct</code>,<code>map</code>,<code>array</code>等嵌套数据类型。</li><li>API：提供类似SQL的操作接口。</li></ul> </li></ul> 
<h5><a id="_224"></a>详细解释</h5> 
<h6><a id="DataSet_226"></a>创建DataSet的代码</h6> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 提供了一组隐式转换，这些转换允许将Scala的本地集合类型(如Seq、Array、List等)转换为Spark的DataSet。</span>
<span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
<span class="token keyword">val</span> dsPhone<span class="token operator">:</span> Dataset<span class="token punctuation">[</span>Product<span class="token punctuation">]</span> <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataset<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span>
  Product<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Huawei Mate60"</span><span class="token punctuation">,</span> <span class="token number">5888.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Product<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"IPhone"</span><span class="token punctuation">,</span> <span class="token number">5666.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Product<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"OPPO"</span><span class="token punctuation">,</span> <span class="token number">1888.0f</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
dsPhone<span class="token punctuation">.</span>printSchema<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">/**
 * root
 * |-- id: integer (nullable = false)
 * |-- name: string (nullable = true)
 * |-- price: float (nullable = false)
 */</span>
</code></pre> 
<h6><a id="_246"></a></h6> 
<h6><a id="DataFrame_248"></a>创建DataFrame的代码</h6> 
<ul><li> <p>读取CSV文件</p> 
  <ul><li> <p>对于CSV文件，在构建DataFrame之前，必须要先创建一个Schema，再根据文件类型分不同情况进行导入。(读取JSON文件或者数据库表都并不需要)</p> </li><li> <p>注意：必须要<code>import spark.implicits._</code>，导入隐式类，才能够识别一些隐式转换，否则会报错。</p> </li><li> <p>CSV文件在创建DataFrame时，可以选择尽量模仿Hive中的OpenCSVSerDe的</p> </li></ul> </li></ul> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
<span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
<span class="token keyword">val</span> schema<span class="token operator">:</span> StructType <span class="token operator">=</span> StructType<span class="token punctuation">(</span>
  Seq<span class="token punctuation">(</span>
    StructField<span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> LongType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"locale"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"birthYear"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"gender"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"joinedAt"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"location"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"timezone"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">val</span> frmUsers<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>read
<span class="token punctuation">.</span>schema<span class="token punctuation">(</span>schema<span class="token punctuation">)</span>
<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"separator"</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span> <span class="token comment">// 指定文件分割符</span>
<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"header"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span> <span class="token comment">// 指定CSV文件包含表头</span>
<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"quoteChar"</span><span class="token punctuation">,</span> <span class="token string">"\""</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"escapeChar"</span><span class="token punctuation">,</span> <span class="token string">"\\"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>csv<span class="token punctuation">(</span><span class="token string">"C:\\Users\\lenovo\\Desktop\\users.csv"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>repartition<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>读取JSON文件</li></ul> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> frmUsers2<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>read<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token string">"hdfs://single01:9000/spark/cha02/users.json"</span><span class="token punctuation">)</span>
frmUsers2<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>读取数据库表</li></ul> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> url <span class="token operator">=</span> <span class="token string">"jdbc:mysql://single01:3306/test_db_for_bigdata"</span> <span class="token comment">// 数据库连接地址</span>
<span class="token keyword">val</span> mysql <span class="token operator">=</span> <span class="token keyword">new</span> Properties<span class="token punctuation">(</span><span class="token punctuation">)</span>
mysql<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"driver"</span><span class="token punctuation">,</span> <span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">)</span>
mysql<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span>
mysql<span class="token punctuation">.</span>setProperty<span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span>
spark
  <span class="token punctuation">.</span>read
  <span class="token punctuation">.</span>jdbc<span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token string">"test_table1_for_hbase_import"</span><span class="token punctuation">,</span>mysql<span class="token punctuation">)</span> <span class="token comment">// (url,TableName,连接属性)</span>
  <span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="Spark_SQL_305"></a>六、Spark_SQL的两种编码方式</h4> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> spark<span class="token operator">:</span> SparkSession <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>config<span class="token punctuation">(</span>conf<span class="token punctuation">)</span>
<span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
<span class="token keyword">val</span> schema<span class="token operator">:</span> StructType <span class="token operator">=</span> StructType<span class="token punctuation">(</span>
  Seq<span class="token punctuation">(</span>
    StructField<span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> LongType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"locale"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"birthYear"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"gender"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"joinedAt"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"location"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"timezone"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">val</span> frmUsers<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>read
<span class="token punctuation">.</span>schema<span class="token punctuation">(</span>schema<span class="token punctuation">)</span>
<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"separator"</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span> <span class="token comment">// 指定文件分割符</span>
<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"header"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span> <span class="token comment">// 指定CSV文件包含表头</span>
<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"quoteChar"</span><span class="token punctuation">,</span> <span class="token string">"\""</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"escapeChar"</span><span class="token punctuation">,</span> <span class="token string">"\\"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>csv<span class="token punctuation">(</span><span class="token string">"C:\\Users\\lenovo\\Desktop\\users.csv"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>repartition<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>此处已经创建好了<code>DataFrame</code></p> 
<h5><a id="1_SQL_336"></a>1. 面向标准SQL语句（偷懒用）</h5> 
<pre><code class="prism language-scala">frmUsers<span class="token punctuation">.</span>registerTempTable<span class="token punctuation">(</span><span class="token string">"user_info"</span><span class="token punctuation">)</span> <span class="token comment">// 此方法已过期</span>
spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>
      <span class="token triple-quoted-string string">"""
        |select * from user_info
        |where gender='female'
        |"""</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>
		<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="2_SparkSQL_348"></a>2. 使用Spark中的SQL算子（更规范）</h5> 
<pre><code class="prism language-scala">frmUsers
      <span class="token punctuation">.</span>where<span class="token punctuation">(</span>$<span class="token string">"birthYear"</span><span class="token operator">&gt;</span><span class="token number">1990</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>$<span class="token string">"locale"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>agg<span class="token punctuation">(</span>
        count<span class="token punctuation">(</span>$<span class="token string">"locale"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"locale_count"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        round<span class="token punctuation">(</span>avg<span class="token punctuation">(</span>$<span class="token string">"birthYear"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"avg_birth_year"</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span>where<span class="token punctuation">(</span>$<span class="token string">"locale_count"</span><span class="token operator">&gt;=</span><span class="token number">10</span> and $<span class="token string">"avg_birth_year"</span><span class="token operator">&gt;=</span><span class="token number">1993</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>$<span class="token string">"locale_count"</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
      <span class="token punctuation">.</span>select<span class="token punctuation">(</span>
        $<span class="token string">"locale"</span><span class="token punctuation">,</span> $<span class="token string">"locale_count"</span><span class="token punctuation">,</span> $<span class="token string">"avg_birth_year"</span><span class="token punctuation">,</span>
        dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>over<span class="token punctuation">(</span>win<span class="token punctuation">)</span>
          <span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"rnk_by_locale_count"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        lag<span class="token punctuation">(</span>$<span class="token string">"locale_count"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span>over<span class="token punctuation">(</span>win<span class="token punctuation">)</span>
          <span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"last_locale_count"</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_372"></a>七、常用算子</h4> 
<h5><a id="1SQL_374"></a>1.基本SQL模板</h5> 
<pre><code class="prism language-sql"><span class="token keyword">select</span>
		col<span class="token punctuation">,</span>cols<span class="token operator">*</span><span class="token punctuation">,</span>agg<span class="token operator">*</span>
<span class="token keyword">where</span>
		conditionCols
<span class="token keyword">group</span> <span class="token keyword">by</span>
		col<span class="token punctuation">,</span>cols<span class="token operator">*</span>
<span class="token keyword">having</span>
		condition
<span class="token keyword">order</span> <span class="token keyword">by</span>
		col <span class="token keyword">asc</span><span class="token operator">|</span><span class="token keyword">desc</span>
<span class="token keyword">limit</span>
		n
</code></pre> 
<h5><a id="2select_391"></a>2.select</h5> 
<p><code>select</code>语句在代码的开头可以不写，因为有后续的类似<code>where</code>和<code>group by</code>语句已经对列进行了操作，指明了列名。如果后续有<code>select</code>语句，则优先按照后面的<code>select</code>语句进行。</p> 
<pre><code class="prism language-java">frmUsers<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>
	$<span class="token string">"locale"</span><span class="token punctuation">,</span>$<span class="token string">"locale_count"</span>
<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="3agg_401"></a>3.agg</h5> 
<pre><code class="prism language-scala"><span class="token punctuation">.</span>agg<span class="token punctuation">(</span>
  count<span class="token punctuation">(</span>$<span class="token string">"locale"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"locale_count"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  round<span class="token punctuation">(</span>avg<span class="token punctuation">(</span>$<span class="token string">"birthYear"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"avg_birth_year"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="4_410"></a>4.窗口函数</h5> 
<ul><li>over子句</li></ul> 
<p>注意：over子句中的分区信息是可以被重用的</p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> win<span class="token operator">:</span> WindowSpec <span class="token operator">=</span> Window<span class="token punctuation">.</span>partitionBy<span class="token punctuation">(</span>$<span class="token string">"gender"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>$<span class="token string">"locale_count"</span><span class="token punctuation">.</span>desc<span class="token punctuation">)</span>
frmUsers
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">.</span>select<span class="token punctuation">(</span>
		dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span>
  		<span class="token punctuation">.</span>over<span class="token punctuation">(</span>win<span class="token punctuation">)</span>
  		<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"rnk_by_locale_count"</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span>
</code></pre> 
<h5><a id="5show_427"></a>5.show</h5> 
<p>show(N)表示显示符合条件的至多N条数据。(不是取前N条再提取出其中符合条件的数据)</p> 
<pre><code class="prism language-scala">frmUsers
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="6_where_437"></a>6.条件筛选 where</h5> 
<pre><code class="prism language-scala">newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>isNull
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>isNaN
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>isNotNull

newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>gt<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>		<span class="token operator">&lt;</span><span class="token keyword">=&gt;</span>	$<span class="token string">"cus_state"</span><span class="token operator">&gt;</span><span class="token number">10</span>
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>geq<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>	<span class="token operator">&lt;</span><span class="token keyword">=&gt;</span>	$<span class="token string">"cus_state"</span><span class="token operator">&gt;=</span><span class="token number">10</span>
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>lt<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>		<span class="token operator">&lt;</span><span class="token keyword">=&gt;</span>	$<span class="token string">"cus_state"</span><span class="token operator">&lt;</span><span class="token number">10</span>
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>leq<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>	<span class="token operator">&lt;</span><span class="token keyword">=&gt;</span>	$<span class="token string">"cus_state"</span><span class="token operator">&lt;=</span><span class="token number">10</span>
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>eq<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>		<span class="token operator">&lt;</span><span class="token keyword">=&gt;</span>	$<span class="token string">"cus_state"</span><span class="token operator">==</span><span class="token operator">=</span><span class="token number">10</span>
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>ne<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>		<span class="token operator">&lt;</span><span class="token keyword">=&gt;</span>	$<span class="token string">"cus_state"</span><span class="token operator">=</span><span class="token operator">!=</span><span class="token number">10</span>
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>between<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span>

newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>like<span class="token punctuation">(</span><span class="token string">"张%"</span><span class="token punctuation">)</span>
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>rlike<span class="token punctuation">(</span><span class="token string">"\\d+"</span><span class="token punctuation">)</span>

newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>isin<span class="token punctuation">(</span>list<span class="token operator">:</span><span class="token builtin">Any</span><span class="token operator">*</span><span class="token punctuation">)</span>
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> $<span class="token string">"cus_state"</span><span class="token punctuation">.</span>isInCollection<span class="token punctuation">(</span>values<span class="token operator">:</span>Itrable<span class="token punctuation">[</span>_<span class="token punctuation">]</span><span class="token punctuation">)</span>

多条件：
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> ColOne and ColTwo
newCol<span class="token operator">:</span>Column <span class="token operator">=</span> ColOne or ColTwo
</code></pre> 
<p>在Spark SQL中，不存在Having子句，Where子句的实际作用根据相对于分组语句的前后决定。</p> 
<h5><a id="7_465"></a>7.分组</h5> 
<pre><code class="prism language-scala"><span class="token comment">// 多重分组</span>
<span class="token comment">/**
rollup的效果：
select birthYear,count(*) from user group by birthYear
union all
select gender,birthYear,count(*) from user group by gender,birthYear
存在"字段不对应"的情况：
空缺的字段会自动补全为null
*/</span>
frmUsers
	<span class="token punctuation">.</span>rollup<span class="token punctuation">(</span><span class="token string">"gender"</span><span class="token punctuation">,</span> <span class="token string">"birthYear"</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-scala"><span class="token comment">// 为了方便查找到每个数据行所对应的分组方式</span>
spark<span class="token punctuation">.</span>sql<span class="token punctuation">(</span>
  <span class="token triple-quoted-string string">"""
  |select grouping__id,gender,birthYear,count(8) as cnt from user_info
  |group by gender,birthday,
  |grouping sets(gender,birthday,(gender,birthYear))
  |"""</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>
<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment">// 这里的group by子句定义了分组的列，到grouping sets明确指定了分组的组合</span>
<span class="token comment">// 因而，在数仓设计的过程中，我们能够对不同分组依据下的不同数据依据grouping__id做分区。</span>
</code></pre> 
<ul><li> <p><code>RollUp</code>和<code>Cube</code>的区别</p> <p>假设有三列：<code>1</code>, <code>2</code>, <code>3</code>，使用<code>CUBE(1, 2, 3)</code>，会生成以下组合：</p> 
  <ol><li><code>GROUP BY ()</code>（不分组，整体聚合）</li><li><code>GROUP BY (1)</code></li><li><code>GROUP BY (2)</code></li><li><code>GROUP BY (3)</code></li><li><code>GROUP BY (1, 2)</code></li><li><code>GROUP BY (1, 3)</code></li><li><code>GROUP BY (2, 3)</code></li><li><code>GROUP BY (1, 2, 3)</code></li></ol> <p><code>ROLLUP</code>生成的分组组合是层级的，它从最详细的分组开始，一步步减少分组的列，直到整体聚合。</p> <p>假设有三列：<code>1</code>, <code>2</code>, <code>3</code>，使用<code>ROLLUP(1, 2, 3)</code>，会生成以下组合：</p> 
  <ol><li><code>GROUP BY (1, 2, 3)</code>（最详细的分组）</li><li><code>GROUP BY (1, 2)</code></li><li><code>GROUP BY (1)</code></li><li><code>GROUP BY ()</code>（不分组，整体聚合）</li></ol> </li></ul> 
<h5><a id="8_518"></a>8.关联查询</h5> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> frmClass<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>
  Seq<span class="token punctuation">(</span>
    Class<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"yb12211"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Class<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"yb12309"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Class<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"yb12401"</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">val</span> frmStu<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>
  Seq<span class="token punctuation">(</span>
    Student<span class="token punctuation">(</span><span class="token string">"henry"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Student<span class="token punctuation">(</span><span class="token string">"ariel"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Student<span class="token punctuation">(</span><span class="token string">"jack"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Student<span class="token punctuation">(</span><span class="token string">"rose"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Student<span class="token punctuation">(</span><span class="token string">"jerry"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Student<span class="token punctuation">(</span><span class="token string">"mary"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token comment">// 1.笛卡尔积(默认情况下)</span>
frmStu<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"S"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>join<span class="token punctuation">(</span>frmClass<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment">/**
+-----+-------+-------+---------+
| name|classId|classId|className|
+-----+-------+-------+---------+
|henry|    1 |    1 |  yb12211|
|henry|    1 |    2 |  yb12309|
|henry|    1 |    3 |  yb12401|
|ariel|    2 |    1 |  yb12211|
|ariel|    2 |    2 |  yb12309|
|ariel|    2 |    3 |  yb12401|
| jack|    1 |    1 |  yb12211|
| jack|    1 |    2 |  yb12309|
| jack|    1 |    3 |  yb12401|
| rose|    4 |    1 |  yb12211|
| rose|    4 |    2 |  yb12309|
| rose|    4 |    3 |  yb12401|
|jerry|    2 |    1 |  yb12211|
|jerry|    2 |    2 |  yb12309|
|jerry|    2 |    3 |  yb12401|
| mary|    1 |    1 |  yb12211|
| mary|    1 |    2 |  yb12309|
| mary|    1 |    3 |  yb12401|
+-----+-------+-------+---------+
*/</span>
<span class="token comment">// 2.内连接</span>
frmStu<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"S"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>join<span class="token punctuation">(</span>frmClass<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token string">"S.classId"</span> <span class="token operator">==</span><span class="token operator">=</span> $<span class="token string">"C.classId"</span><span class="token punctuation">,</span><span class="token string">"inner"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment">/**
+-----+-------+-------+---------+
| name|classId|classId|className|
+-----+-------+-------+---------+
|henry|    1 |    1 |  yb12211|
|ariel|    2 |    2 |  yb12309|
| jack|    1 |    1 |  yb12211|
|jerry|    2 |    2 |  yb12309|
| mary|    1 |    1 |  yb12211|
+-----+-------+-------+---------+
*/</span>
<span class="token comment">// 启用using：使用Seq("Column")代表关联字段</span>
frmStu<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"S"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>join<span class="token punctuation">(</span>frmClass<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Seq<span class="token punctuation">(</span><span class="token string">"classId"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"right"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

<span class="token comment">// 3.外连接</span>
frmStu<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"S"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>join<span class="token punctuation">(</span>frmClass<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token string">"S.classId"</span> <span class="token operator">==</span><span class="token operator">=</span> $<span class="token string">"C.classId"</span><span class="token punctuation">,</span><span class="token string">"outer"</span><span class="token punctuation">)</span> <span class="token comment">// left | right | outer</span>
<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment">/**
+-----+-------+-------+---------+
| name|classId|classId|className|
+-----+-------+-------+---------+
|henry|    1 |    1 |  yb12211|
| jack|    1 |    1 |  yb12211|
| mary|    1 |    1 |  yb12211|
| null|  null |    3 |  yb12401|
| rose|    4 |  null |    null|
|ariel|    2 |    2 |  yb12309|
|jerry|    2 |    2 |  yb12309|
+-----+-------+-------+---------+
*/</span>
<span class="token comment">// 4.反连接：返回左数据集中所有没有关联字段匹配记录的左数据集的行</span>
frmStu<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"S"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>join<span class="token punctuation">(</span>frmClass<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token string">"S.classId"</span> <span class="token operator">==</span><span class="token operator">=</span> $<span class="token string">"C.classId"</span><span class="token punctuation">,</span><span class="token string">"anti"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment">/**
+----+-------+
|name|classId|
+----+-------+
|rose|    4 |
+----+-------+
*/</span>
<span class="token comment">// 5.半连接：返回左数据集中所有有关联字段匹配记录的左数据集的行</span>
frmStu<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"S"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>join<span class="token punctuation">(</span>frmClass<span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token string">"S.classId"</span> <span class="token operator">==</span><span class="token operator">=</span> $<span class="token string">"C.classId"</span><span class="token punctuation">,</span><span class="token string">"semi"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment">/**

+-----+-------+
| name|classId|
+-----+-------+
|henry|    1 |
|ariel|    2 |
| jack|    1 |
|jerry|    2 |
| mary|    1 |
+-----+-------+
*/</span>
</code></pre> 
<h5><a id="9_634"></a>9.排序</h5> 
<pre><code class="prism language-scala">frmStu<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span>cols<span class="token operator">:</span>Column<span class="token operator">*</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="10_640"></a>10.数据截取</h5> 
<pre><code class="prism language-scala">frmStu<span class="token punctuation">.</span>tail<span class="token punctuation">(</span>n<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span>
frmStu<span class="token punctuation">.</span>take<span class="token punctuation">(</span>n<span class="token operator">:</span><span class="token builtin">Int</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="SQL_647"></a>八.SQL函数</h4> 
<h6><a id="_649"></a>常用函数</h6> 
<pre><code class="prism language-java">$<span class="token string">"NAME"</span> <span class="token operator">=</span> <span class="token function">col</span><span class="token punctuation">(</span><span class="token string">"NAME"</span><span class="token punctuation">)</span>						<span class="token comment">// 取列值</span>
<span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"ALIAS_NAME"</span><span class="token punctuation">)</span>							<span class="token comment">// 别名</span>
<span class="token function">as</span><span class="token punctuation">(</span>alias<span class="token operator">:</span><span class="token class-name">Seq</span><span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span>						<span class="token comment">// 多个别名</span>
<span class="token function">when</span><span class="token punctuation">(</span><span class="token constant">CONDITION</span><span class="token punctuation">,</span><span class="token constant">V1</span><span class="token punctuation">)</span>						<span class="token comment">// 条件  </span>
  <span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">otherwise</span><span class="token punctuation">(</span><span class="token constant">VN</span><span class="token punctuation">)</span>
<span class="token function">lit</span><span class="token punctuation">(</span><span class="token class-name">V</span><span class="token punctuation">)</span>											<span class="token comment">// 常量列</span>
<span class="token function">withColumn</span><span class="token punctuation">(</span>colName<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span> <span class="token comment">// 扩展列(通常用于使用窗口函数做扩展列)</span>
<span class="token function">cast</span><span class="token punctuation">(</span><span class="token class-name">DataType</span><span class="token punctuation">)</span>							 <span class="token comment">// 类型转换</span>
</code></pre> 
<p><strong>常用函数案例</strong></p> 
<pre><code class="prism language-scala">spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span>
  Test<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>Array<span class="token punctuation">(</span><span class="token string">"money"</span><span class="token punctuation">,</span><span class="token string">"freedom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Map<span class="token punctuation">(</span><span class="token string">"java"</span><span class="token operator">-&gt;</span><span class="token number">85</span><span class="token punctuation">,</span><span class="token string">"c++"</span><span class="token operator">-&gt;</span><span class="token number">92</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Test<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>Array<span class="token punctuation">(</span><span class="token string">"beauty"</span><span class="token punctuation">,</span><span class="token string">"writing"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Map<span class="token punctuation">(</span><span class="token string">"math"</span><span class="token operator">-&gt;</span><span class="token number">91</span><span class="token punctuation">,</span><span class="token string">"English"</span><span class="token operator">-&gt;</span><span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Test<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>Array<span class="token punctuation">(</span><span class="token string">"movie"</span><span class="token punctuation">,</span><span class="token string">"draw"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Map<span class="token punctuation">(</span><span class="token string">"Sql"</span><span class="token operator">-&gt;</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token string">"LLM"</span><span class="token operator">-&gt;</span><span class="token number">77</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 多个explode不能写在一个select中</span>
<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>explode<span class="token punctuation">(</span>$<span class="token string">"hobbies"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"hobby"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>$<span class="token string">"scores"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>$<span class="token string">"hobby"</span><span class="token punctuation">,</span>explode<span class="token punctuation">(</span>$<span class="token string">"scores"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span><span class="token string">"course"</span><span class="token punctuation">,</span><span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>$<span class="token string">"hobby"</span><span class="token punctuation">,</span>$<span class="token string">"course"</span><span class="token punctuation">,</span>$<span class="token string">"score"</span><span class="token punctuation">.</span>cast<span class="token punctuation">(</span><span class="token string">"Integer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">"score_rank"</span><span class="token punctuation">,</span>
 	when<span class="token punctuation">(</span>$<span class="token string">"score"</span><span class="token operator">&gt;=</span><span class="token number">90</span><span class="token punctuation">,</span>lit<span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	when<span class="token punctuation">(</span>$<span class="token string">"score"</span><span class="token operator">&gt;=</span><span class="token number">80</span><span class="token punctuation">,</span>lit<span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	when<span class="token punctuation">(</span>$<span class="token string">"score"</span><span class="token operator">&gt;=</span><span class="token number">70</span><span class="token punctuation">,</span>lit<span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	when<span class="token punctuation">(</span>$<span class="token string">"score"</span><span class="token operator">&gt;=</span><span class="token number">60</span><span class="token punctuation">,</span>lit<span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span>otherwise<span class="token punctuation">(</span>lit<span class="token punctuation">(</span><span class="token string">"E"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="_683"></a>集合函数</h6> 
<pre><code class="prism language-scala">array
	size<span class="token punctuation">(</span>collectCol<span class="token operator">:</span>Column<span class="token punctuation">)</span>	 <span class="token comment">// 计算数组大小</span>
	array<span class="token punctuation">(</span>cols<span class="token operator">:</span>Column<span class="token operator">*</span><span class="token punctuation">)</span>			<span class="token comment">// 一行中的多列转为单列数组类型</span>
	array_sort<span class="token punctuation">(</span>arrayCol<span class="token operator">:</span>Column<span class="token punctuation">)</span>  <span class="token comment">// 对数组列中的元素进行排序</span>
	array_contains<span class="token punctuation">(</span>arrayCol<span class="token operator">:</span>Column<span class="token punctuation">,</span>value<span class="token operator">:</span><span class="token builtin">Any</span><span class="token punctuation">)</span>  <span class="token comment">// 依次判断数组列的各个元素是否含有特定值</span>
	array_distinct<span class="token punctuation">(</span>arrayCol<span class="token operator">:</span>Column<span class="token punctuation">)</span>  <span class="token comment">// 对数组列的各个元素进行去重并返回去重后的结果</span>
	array_join<span class="token punctuation">(</span>arrayCol<span class="token operator">:</span>Column<span class="token punctuation">,</span>sep<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>nullReplacement<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token comment">// 对数组列的各个元素进行拼接</span>
	array_except<span class="token punctuation">(</span>arrayCol<span class="token operator">:</span>Column<span class="token punctuation">)</span>
	array_intersect<span class="token punctuation">(</span>arrayCol<span class="token operator">:</span>Column<span class="token punctuation">)</span>
	array_union<span class="token punctuation">(</span>arrayCol<span class="token operator">:</span>Column<span class="token punctuation">)</span>
map
	map_keys<span class="token punctuation">(</span>mapCol<span class="token operator">:</span>Column<span class="token punctuation">)</span>
	map_values<span class="token punctuation">(</span>mapCol<span class="token operator">:</span>Column<span class="token punctuation">)</span>
	map_entries<span class="token punctuation">(</span>mapCol<span class="token operator">:</span>Column<span class="token punctuation">)</span>
</code></pre> 
<p><strong>集合函数案例</strong></p> 
<pre><code class="prism language-scala">data<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>size<span class="token punctuation">(</span>$<span class="token string">"hobbies"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"hobbies_cnt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span> 
data<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>array_sort<span class="token punctuation">(</span>$<span class="token string">"hobbies"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"hobbies_sort"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span> 
data<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>array_contains<span class="token punctuation">(</span>$<span class="token string">"hobbies"</span><span class="token punctuation">,</span><span class="token string">"money"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span> 
data<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>array_distinct<span class="token punctuation">(</span>$<span class="token string">"hobbies"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"unique_hobbies"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span> 
data<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>array_join<span class="token punctuation">(</span>$<span class="token string">"hobbies"</span><span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">,</span><span class="token string">"Unknown Value"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"union_hobby"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span> 
data<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">"next_hobbies"</span><span class="token punctuation">,</span>lead<span class="token punctuation">(</span>$<span class="token string">"hobbies"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> over<span class="token punctuation">(</span>Window<span class="token punctuation">.</span>orderBy<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>where<span class="token punctuation">(</span>$<span class="token string">"next_hobbies"</span><span class="token punctuation">.</span>isNotNull<span class="token punctuation">)</span> <span class="token comment">// 提前做条件筛选</span>
<span class="token punctuation">.</span>select<span class="token punctuation">(</span>
  array_intersect<span class="token punctuation">(</span>$<span class="token string">"hobbies"</span><span class="token punctuation">,</span>$<span class="token string">"next_hobbies"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"intersect_hobbies"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
data<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>
            map_keys<span class="token punctuation">(</span>$<span class="token string">"scores"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"course_list"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            map_values<span class="token punctuation">(</span>$<span class="token string">"scores"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"scores"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            map_entries<span class="token punctuation">(</span>$<span class="token string">"scores"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"course_score_list"</span><span class="token punctuation">)</span>
           <span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 考java的学生人数有多少</span>
<span class="token keyword">val</span> num<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>select<span class="token punctuation">(</span>
  array_contains<span class="token punctuation">(</span>map_keys<span class="token punctuation">(</span>$<span class="token string">"scores"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"java"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"isJava"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>$<span class="token string">"isJava"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="_728"></a>字符串函数</h6> 
<pre><code class="prism language-java"><span class="token comment">// 提取</span>
<span class="token comment">// 1、提取 json</span>
<span class="token function">json_tuple</span><span class="token punctuation">(</span>jsonCol<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span> fields<span class="token operator">:</span><span class="token class-name">String</span><span class="token operator">*</span><span class="token punctuation">)</span>		<span class="token comment">// $"jsonString" =&gt; field1,field2 获取单层Json字段</span>
<span class="token function">get_json_object</span><span class="token punctuation">(</span>jsonCol<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span> path<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">)</span>	<span class="token comment">// $"jsonString" =&gt; $.field1[.field2] 获取多层嵌套Json字段</span>
  
<span class="token comment">// 2、正则分组</span>
<span class="token function">regexp_extract</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span> pattern<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span> groupId<span class="token operator">:</span><span class="token class-name">Int</span><span class="token punctuation">)</span>
  
<span class="token comment">// 3、分裂与截取</span>
<span class="token function">split</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span>pattern<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">)</span>
<span class="token function">substring</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span>pos<span class="token operator">:</span><span class="token class-name">Int</span><span class="token punctuation">,</span>len<span class="token operator">:</span><span class="token class-name">Int</span><span class="token punctuation">)</span>
<span class="token function">substring_index</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span>sep<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>groupId<span class="token operator">:</span><span class="token class-name">Int</span><span class="token punctuation">)</span>
	<span class="token comment">// groupId +N 从左向右前N个</span>
	<span class="token comment">// groupId -N 从右向左前N个</span>
	<span class="token comment">// 第N个 substring_index(substring_index(COL,SEP,+N),SEP,-1)</span>

<span class="token comment">// 4、子字符串在字段中的位置(表示子字符串的第一个字符在字符串中的索引位置)</span>
<span class="token function">locate</span><span class="token punctuation">(</span>subStr<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>		<span class="token comment">// 有则&gt;0，否则=0，</span>
<span class="token function">instr</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span>subStr<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">)</span>

<span class="token comment">// 5、字符串拼接</span>
<span class="token function">concat</span><span class="token punctuation">(</span>cols<span class="token operator">:</span><span class="token class-name">Column</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token function">concat_ws</span><span class="token punctuation">(</span>sep<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>cols<span class="token operator">:</span><span class="token class-name">Column</span><span class="token operator">*</span><span class="token punctuation">)</span>

<span class="token comment">// 6、内容长度</span>
<span class="token function">length</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>							<span class="token comment">// 字符长度</span>
<span class="token comment">// 字节长度，未提供算子，需要通过 spark.sql(""" select octet_length(...)""") 实现</span>

<span class="token comment">// 7、定长填充</span>
<span class="token function">lpad</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span>len<span class="token operator">:</span><span class="token class-name">Int</span><span class="token punctuation">,</span>pad<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">)</span>
<span class="token function">rpad</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span>len<span class="token operator">:</span><span class="token class-name">Int</span><span class="token punctuation">,</span>pad<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">)</span>

<span class="token comment">// 8、清除两端空格</span>
<span class="token function">ltrim</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>
<span class="token function">rtrim</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>
<span class="token function">trim</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>

<span class="token comment">// 9、大小写转换</span>
<span class="token function">initcap</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>							<span class="token comment">// 每个单词首字母大写</span>
<span class="token function">upper</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>							<span class="token comment">// 全大写</span>
<span class="token function">lower</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>							<span class="token comment">// 全小写</span>

<span class="token function">hash</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>							<span class="token comment">// 去哈希值</span>
<span class="token function">regexp_replace</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span>pattern<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span>replace<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">)</span>	<span class="token comment">// 正则替换</span>
<span class="token function">translate</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span>from<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token keyword">to</span><span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">)</span>	<span class="token comment">// 按字母转换</span>
<span class="token function">reverse</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>							<span class="token comment">// 翻转</span>

<span class="token comment">// 10、转码</span>
<span class="token function">encode</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span> charSet<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">)</span>
<span class="token function">decode</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">,</span> charSet<span class="token operator">:</span><span class="token class-name">String</span><span class="token punctuation">)</span>

<span class="token comment">// 11、非对称加密</span>
<span class="token function">sha1</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>
<span class="token function">md5</span><span class="token punctuation">(</span>col<span class="token operator">:</span><span class="token class-name">Column</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>字符串函数案例</strong></p> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> frm<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark
<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span>
  Json<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token triple-quoted-string string">"""{"name":"henry","age":22,"hobbies":["beauty","money","power"],"address":{"province":"jiangsu","city":"nanjing"}}"""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Json<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token triple-quoted-string string">"""{"name":"jack","age":23,"hobbies":["beauty","power"],"address":{"province":"jiangsu","city":"wuxi"}}"""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  Json<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token triple-quoted-string string">"""{"name":"tom","age":24,"hobbies":["beauty","money"],"address":{"province":"jiangsu","city":"yancheng"}}"""</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>
frm<span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>
           json_tuple<span class="token punctuation">(</span>$<span class="token string">"json"</span><span class="token punctuation">,</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"age"</span><span class="token punctuation">,</span><span class="token string">"hobbies"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"age"</span><span class="token punctuation">,</span><span class="token string">"hobbies"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           get_json_object<span class="token punctuation">(</span>$<span class="token string">"json"</span><span class="token punctuation">,</span><span class="token string">"$.address.province"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"province"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           get_json_object<span class="token punctuation">(</span>$<span class="token string">"json"</span><span class="token punctuation">,</span><span class="token string">"$.address.city"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>


<span class="token comment">// 通过正则提取获取特定的日志信息</span>
<span class="token keyword">val</span> regex_line <span class="token operator">=</span> <span class="token string">"(.*?) (INFO|WARN|ERROR) (.*?):(.*)"</span>
<span class="token keyword">val</span> regex_log <span class="token operator">=</span> <span class="token string">"^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2},\\d{3} (INFO|WARN|ERROR) .*"</span>
<span class="token keyword">val</span> frm<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark
<span class="token punctuation">.</span>read
<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token string">"spark-warehouse/datanode.log"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token string">"line"</span><span class="token punctuation">)</span>

frm
<span class="token punctuation">.</span>where<span class="token punctuation">(</span>$<span class="token string">"line"</span><span class="token punctuation">.</span>rlike<span class="token punctuation">(</span>regex_log<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>select<span class="token punctuation">(</span>
  regexp_extract<span class="token punctuation">(</span>$<span class="token string">"line"</span><span class="token punctuation">,</span>regex_line<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"log_in_time"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  regexp_extract<span class="token punctuation">(</span>$<span class="token string">"line"</span><span class="token punctuation">,</span>regex_line<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"log_type"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  regexp_extract<span class="token punctuation">(</span>$<span class="token string">"line"</span><span class="token punctuation">,</span>regex_line<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"log_full_pack"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  regexp_extract<span class="token punctuation">(</span>$<span class="token string">"line"</span><span class="token punctuation">,</span>regex_line<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"log_detail"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token comment">// 获取错误日志信息中错误类别及其所占数量</span>
<span class="token punctuation">.</span>where<span class="token punctuation">(</span>$<span class="token string">"log_type"</span><span class="token punctuation">.</span>equalTo<span class="token punctuation">(</span><span class="token string">"ERROR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>$<span class="token string">"log_detail"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>



</code></pre> 
<h6><a id="Spark_829"></a>Spark自定义函数流程</h6> 
<p>自定义函数流程：定义-注册-调用</p> 
<blockquote> 
 <ul><li> <p>建议将自定义函数实现，单独建对象保存</p> <pre><code class="prism language-scala"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>StandardCharsets<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>Base64
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span>Cipher
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span>SecretKeySpec

<span class="token keyword">object</span> SparkUtil <span class="token punctuation">{<!-- --></span>
	 <span class="token comment">/**
   * 处理密钥
   * @param secret 密钥
   */</span>
  <span class="token keyword">private</span> <span class="token keyword">def</span> secretInit<span class="token punctuation">(</span>secret<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 对密钥长度进行约束</span>
    <span class="token keyword">val</span> allowNumBits<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Array<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token comment">// 如果密钥长度符合，将密钥转换为AES密钥对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>allowNumBits<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>secret<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">new</span> SecretKeySpec<span class="token punctuation">(</span>
          secret<span class="token punctuation">.</span>getBytes<span class="token punctuation">(</span>StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"AES"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> RuntimeException<span class="token punctuation">(</span>
          s"AES secret size of numBits $<span class="token punctuation">{<!-- --></span>secret<span class="token punctuation">.</span>size<span class="token punctuation">}</span> not in 
          permitted values <span class="token punctuation">(</span>$<span class="token punctuation">{<!-- --></span>allowNumBits<span class="token punctuation">.</span>mkString<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>"<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 加密函数
   * @param src 源数据
   * @param secret 密钥
   */</span>
  <span class="token keyword">def</span> encrypt<span class="token punctuation">(</span>src<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>secret<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取加密算法实例</span>
    <span class="token keyword">val</span> cipher<span class="token operator">:</span> Cipher <span class="token operator">=</span> Cipher<span class="token punctuation">.</span>getInstance<span class="token punctuation">(</span><span class="token string">"AES"</span><span class="token punctuation">)</span>
    <span class="token comment">// 初始化加密模式，使用给定的密钥(需要先用key()对密钥进行处理)</span>
    cipher<span class="token punctuation">.</span>init<span class="token punctuation">(</span>Cipher<span class="token punctuation">.</span>ENCRYPT_MODE<span class="token punctuation">,</span>secretInit<span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 执行加密操作</span>
    <span class="token keyword">val</span> bytes<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Byte</span><span class="token punctuation">]</span> <span class="token operator">=</span> cipher<span class="token punctuation">.</span>doFinal<span class="token punctuation">(</span>src<span class="token punctuation">.</span>getBytes<span class="token punctuation">(</span>StandardCharset<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 返回加密后的数据</span>
    Base64<span class="token punctuation">.</span>getEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encodeToString<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/**
   * 解密函数
   * @param dest 待解密数据
   * @param secret 密钥
   */</span>
  <span class="token keyword">def</span> decrypt<span class="token punctuation">(</span>dest<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>secret<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> cipher<span class="token operator">:</span> Cipher <span class="token operator">=</span> Cipher<span class="token punctuation">.</span>getInstance<span class="token punctuation">(</span><span class="token string">"AES"</span><span class="token punctuation">)</span>
    cipher<span class="token punctuation">.</span>init<span class="token punctuation">(</span>Cipher<span class="token punctuation">.</span>DECRYPT_MODE<span class="token punctuation">,</span>secretInit<span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> bytes<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">Byte</span><span class="token punctuation">]</span> <span class="token operator">=</span> cipher<span class="token punctuation">.</span>doFinal<span class="token punctuation">(</span>
        Base64<span class="token punctuation">.</span>getDecoder<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>dest<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token builtin">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> </li><li> <p>在 Spark 环境下导入对象实现的方法，并在 SparkSession 中注册 UDF 函数</p> <pre><code class="prism language-scala"><span class="token keyword">import</span> <span class="token namespace">core<span class="token punctuation">.</span></span>SparkUtil<span class="token punctuation">.</span><span class="token punctuation">{<!-- --></span>encrypt<span class="token punctuation">,</span>decrypt<span class="token punctuation">}</span>
spark<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span>
    <span class="token string">"aes_encrypt"</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>src<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>secret<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span> 
    	<span class="token keyword">=&gt;</span>encrypt<span class="token punctuation">(</span>src<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">,</span>StringType<span class="token punctuation">)</span>
spark<span class="token punctuation">.</span>udf<span class="token punctuation">.</span>register<span class="token punctuation">(</span>
    <span class="token string">"aes_decrypt"</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span>src<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">,</span>secret<span class="token operator">:</span><span class="token builtin">String</span><span class="token punctuation">)</span>
    	<span class="token keyword">=&gt;</span>decrypt<span class="token punctuation">(</span>src<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">,</span>StringType<span class="token punctuation">)</span>
</code></pre> </li><li> <p>在 SparkSql 中调用注册函数</p> <pre><code class="prism language-scala"><span class="token keyword">val</span> frm<span class="token operator">:</span> DataFrame <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span>Seq<span class="token punctuation">(</span>
	Test<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>Array<span class="token punctuation">(</span><span class="token string">"money"</span><span class="token punctuation">,</span><span class="token string">"freedom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Map<span class="token punctuation">(</span><span class="token string">"java"</span><span class="token operator">-&gt;</span><span class="token number">85</span><span class="token punctuation">,</span><span class="token string">"mysql"</span><span class="token operator">-&gt;</span><span class="token number">67</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  	Test<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>Array<span class="token punctuation">(</span><span class="token string">"beauty"</span><span class="token punctuation">,</span><span class="token string">"beauty"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Map<span class="token punctuation">(</span><span class="token string">"java"</span><span class="token operator">-&gt;</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token string">"mysql"</span><span class="token operator">-&gt;</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  	Test<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>Array<span class="token punctuation">(</span><span class="token string">"sports"</span><span class="token punctuation">,</span><span class="token string">"beauty"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Map<span class="token punctuation">(</span><span class="token string">"java"</span><span class="token operator">-&gt;</span><span class="token number">76</span><span class="token punctuation">,</span><span class="token string">"html"</span><span class="token operator">-&gt;</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">val</span> secret <span class="token operator">=</span> <span class="token string">"henryyb2211ariel"</span>

<span class="token keyword">val</span> frmEncrypt<span class="token operator">:</span> DataFrame <span class="token operator">=</span> frm
  <span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>
	callUDF<span class="token punctuation">(</span>
	  <span class="token string">"aes_encrypt"</span><span class="token punctuation">,</span>
	  array_join<span class="token punctuation">(</span>$<span class="token string">"hobbies"</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	  lit<span class="token punctuation">(</span>secret<span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"encrypted_hobbies"</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>

<span class="token keyword">val</span> frmDecrypt<span class="token operator">:</span> DataFrame <span class="token operator">=</span> frmEncrypt
  <span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span>
	split<span class="token punctuation">(</span>
	  callUDF<span class="token punctuation">(</span>
		<span class="token string">"aes_decrypt"</span><span class="token punctuation">,</span>
		$<span class="token string">"encrypted_hobbies"</span><span class="token punctuation">,</span>
		lit<span class="token punctuation">(</span>secret<span class="token punctuation">)</span>
	  <span class="token punctuation">)</span><span class="token punctuation">,</span>
	  <span class="token string">","</span>
	<span class="token punctuation">)</span><span class="token punctuation">.</span>as<span class="token punctuation">(</span><span class="token string">"hobbies"</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> </li></ul> 
</blockquote> 
<h6><a id="_937"></a></h6> 
<p><img src="https://images2.imgbox.com/a8/1f/oOI6Rejq_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/df830ef302bbf882da0d712990439391/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【学习笔记】无人机（UAV）在3GPP系统中的增强支持(十三)-更换无人机控制器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c45a7b6b754a839925491716d5a661a9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【qt】考试系统项目</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>