<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nginx &#43; lnmp架构部署 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/d1d987b3a044cce43de97344a23a5018/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="nginx &#43; lnmp架构部署">
  <meta property="og:description" content="一、nginx简介 Nginx是一款轻量级的Web服务器/反向代理服务器及电子（IMAP/POP3）代理服务器。
Nginx由俄罗斯的程序设计师Igor Sysoev所开发，最初供俄国大型的入口网站及搜寻引擎Rambler使用。
第一个公开版本0.1.0发布于2004年10月4日。其将源代码以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名。2011年6月1日，nginx 1.0.4发布。
nginx的特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。
二、nginx的特性与优点 1、nginx特性 Nginx是一个很牛的高性能WEB和反向代理服务器，它具有很多非常优越的特性：
（1）在高连接并发情况下，nginx是apache服务器不错的替代品，能够支持高达5万个并发连接数的响应
（2）使用epoll and kqueue作为开发模型
（3）Nginx作为负载均衡服务器：nginx既可以在内部直接支持和PHP程序对外进行服务，也可以支持作为HTTP代理服务器对外进行服务
（4）Nginx采用C进行编写，不论系统资源开销还是CPU使用效率都比Perlbal要好很多。
2、nginx的优点 （1）高并发连接：官方测试能够支撑5万并发连接，在实际生产环境中跑到2-3万并发连接数
（2）内存消耗少：在3万并发连接下，开启的10个nginx进程才消耗150M内存（15M*10=150M）
（3）配置文件非常简单：风格跟程序一样通俗易懂
（4）成本低廉：nginx为开源软件，可以免费使用。而购买F5 BIG-IPNetScaler等硬件负载均衡交换机则需要十多万至几十万人民币
（5）支持Rewrite重写规则：能够根据域名、URL的不同，将HTTP请求分到不同的后端服务器群组
（6）内置的健康检查功能：如果Nginx Proxy后端的某台Web服务器宕机了，不会影响前端访问
（7）节省带宽：支持GZIP压缩，可以添加浏览器本地缓存的Header头
（8）稳定性高：用于反向代理，宕机的概率微乎其微
（9）模块化设计：模块可以动态编译
（10）外围支持好：文档全，二次开发和模块较多
（11）支持热部署：可以不停机重载配置文件
（12）支持事件驱动、AIO（AsyncIO，异步IO）、mmap（Memory Map，内存映射）等性能优化
三、nginx的功能及应用类别 1、nginx的基本功能 （1）静态资源的web服务器，能缓存打开的文件描述符
（2）http、smtp、pop3协议的反向代理服务器
（3）缓存加速、负载均衡
（4）支持FastCGI（fpm，LNMP），uWSGI（Python）等
（5）模块化（非DSO机制），过滤器zip、SSI及图像的大小调整
（6）支持SSL
2、nginx的扩展功能 （1）基于名称和IP的虚拟主机
（2）支持keepalive
（3）支持平滑升级
（4）定制访问日志、支持使用日志缓冲区提高日志存储性能
（5）支持URL重写
（6）支持路径别名
（7）支持基于IP及用户的访问控制
（8）支持速率限制，支持并发数限制
3、nginx的应用类别 （1）使用nginx结合FastCGI运行PHP、JSP、Perl等程序
（2）使用nginx作反向代理、负载均衡、规则过滤
（3）使用nginx运行静态HTML网页、图片
（4）nginx与其他新技术的结合应用
四、nginx的模块与工作原理 nginx由内核和模块组成。其中，内核的设计非常微小和简洁，完成的工作也非常简单，仅仅通过查找配置文件将客户端请求映射到一个location block（location是nginx配置中的一个指令，用于URL匹配），而在这个location中所配置的每个指令将会启动不同的模块去完成相应的工作
1、nginx的模块分类 nginx的模块从结构上分为核心模块、基础模块和第三方模块
（1）HTTP模块、EVENT模块和MAIL模块等属于核心模块
（2）HTTP Access模块、HTTP FastCGI模块、HTTP Proxy模块和HTTP Rewrite模块属于基本模块
（3）HTTP Upstream模块、Request Hash模块、Notice模块和HTTP Access Key模块属于第三方模块">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-26T16:08:36+08:00">
    <meta property="article:modified_time" content="2024-08-26T16:08:36+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nginx &#43; lnmp架构部署</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="nginx_0"></a>一、nginx简介</h2> 
<p>Nginx是一款轻量级的Web服务器/反向代理服务器及电子（IMAP/POP3）代理服务器。</p> 
<p>Nginx由俄罗斯的程序设计师Igor Sysoev所开发，最初供俄国大型的入口网站及搜寻引擎Rambler使用。</p> 
<p>第一个公开版本0.1.0发布于2004年10月4日。其将源代码以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名。2011年6月1日，nginx 1.0.4发布。</p> 
<p>nginx的特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。</p> 
<h2><a id="nginx_9"></a>二、nginx的特性与优点</h2> 
<h3><a id="1nginx_10"></a>1、nginx特性</h3> 
<p>Nginx是一个很牛的高性能WEB和反向代理服务器，它具有很多非常优越的特性：<br> （1）在高连接并发情况下，nginx是apache服务器不错的替代品，能够支持高达5万个并发连接数的响应</p> 
<p>（2）使用epoll and kqueue作为开发模型</p> 
<p>（3）Nginx作为负载均衡服务器：nginx既可以在内部直接支持和PHP程序对外进行服务，也可以支持作为HTTP代理服务器对外进行服务</p> 
<p>（4）Nginx采用C进行编写，不论系统资源开销还是CPU使用效率都比Perlbal要好很多。</p> 
<h3><a id="2nginx_20"></a>2、nginx的优点</h3> 
<p>（1）高并发连接：官方测试能够支撑5万并发连接，在实际生产环境中跑到2-3万并发连接数</p> 
<p>（2）内存消耗少：在3万并发连接下，开启的10个nginx进程才消耗150M内存（15M*10=150M）</p> 
<p>（3）配置文件非常简单：风格跟程序一样通俗易懂</p> 
<p>（4）成本低廉：nginx为开源软件，可以免费使用。而购买F5 BIG-IPNetScaler等硬件负载均衡交换机则需要十多万至几十万人民币</p> 
<p>（5）支持Rewrite重写规则：能够根据域名、URL的不同，将HTTP请求分到不同的后端服务器群组</p> 
<p>（6）内置的健康检查功能：如果Nginx Proxy后端的某台Web服务器宕机了，不会影响前端访问</p> 
<p>（7）节省带宽：支持GZIP压缩，可以添加浏览器本地缓存的Header头</p> 
<p>（8）稳定性高：用于反向代理，宕机的概率微乎其微</p> 
<p>（9）模块化设计：模块可以动态编译</p> 
<p>（10）外围支持好：文档全，二次开发和模块较多</p> 
<p>（11）支持热部署：可以不停机重载配置文件</p> 
<p>（12）支持事件驱动、AIO（AsyncIO，异步IO）、mmap（Memory Map，内存映射）等性能优化</p> 
<h2><a id="nginx_45"></a>三、nginx的功能及应用类别</h2> 
<h3><a id="1nginx_46"></a>1、nginx的基本功能</h3> 
<p>（1）静态资源的web服务器，能缓存打开的文件描述符<br> （2）http、smtp、pop3协议的反向代理服务器<br> （3）缓存加速、负载均衡<br> （4）支持FastCGI（fpm，LNMP），uWSGI（Python）等<br> （5）模块化（非DSO机制），过滤器zip、SSI及图像的大小调整<br> （6）支持SSL</p> 
<h3><a id="2nginx_54"></a>2、nginx的扩展功能</h3> 
<p>（1）基于名称和IP的虚拟主机<br> （2）支持keepalive<br> （3）支持平滑升级<br> （4）定制访问日志、支持使用日志缓冲区提高日志存储性能<br> （5）支持URL重写<br> （6）支持路径别名<br> （7）支持基于IP及用户的访问控制<br> （8）支持速率限制，支持并发数限制</p> 
<h3><a id="3nginx_65"></a>3、nginx的应用类别</h3> 
<p>（1）使用nginx结合FastCGI运行PHP、JSP、Perl等程序<br> （2）使用nginx作反向代理、负载均衡、规则过滤<br> （3）使用nginx运行静态HTML网页、图片<br> （4）nginx与其他新技术的结合应用</p> 
<h2><a id="nginx_71"></a>四、nginx的模块与工作原理</h2> 
<p>nginx由内核和模块组成。其中，内核的设计非常微小和简洁，完成的工作也非常简单，仅仅通过查找配置文件将客户端请求映射到一个location block（location是nginx配置中的一个指令，用于URL匹配），而在这个location中所配置的每个指令将会启动不同的模块去完成相应的工作</p> 
<h3><a id="1nginx_74"></a>1、nginx的模块分类</h3> 
<p>nginx的模块从结构上分为核心模块、基础模块和第三方模块</p> 
<p>（1）HTTP模块、EVENT模块和MAIL模块等属于核心模块</p> 
<p>（2）HTTP Access模块、HTTP FastCGI模块、HTTP Proxy模块和HTTP Rewrite模块属于基本模块</p> 
<p>（3）HTTP Upstream模块、Request Hash模块、Notice模块和HTTP Access Key模块属于第三方模块</p> 
<p>用户根据自己的需要开发的模块都属于第三方模块。正是有了如此多模块的支撑，nginx的功能才会如此强大</p> 
<h4><a id="nginxnotifyhandlers_84"></a>nginx模块从功能上分为三类，分别是：notify–handlers</h4> 
<p>（1）Handlers（处理器模块）。此类模块直接处理请求，并进行输出内容和修改headers信息等操作。handlers处理器模块一般只能有一个</p> 
<p>（2）Filters（过滤器模块）。此类模块主要对其他处理器模块输出的内容进行修改操作，最后由nginx输出</p> 
<p>（3）Proxies（代理器模块）。就是nginx的HTTP Upstream之类的模块，这些模块主要与后端一些服务比如fastcgi等操作交互，实现服务代理和负载均衡等功能</p> 
<h4><a id="nginx_91"></a>nginx模块分为：</h4> 
<p>核心模块、事件模块、标准Http模块、可选Http模块、邮件模块、第三方模块和补丁等nginx基本模块：所谓基本模块，指的是nginx默认的功能模块，它们提供的指令，允许你使用定义nginx基本功能的变量，在编译时不能被禁用，包括：</p> 
<p>（1）核心模块：基本功能和指令，如进程管理和安全。常见的核心模块指令，大部分是放置在配置文件的顶部</p> 
<p>（2）事件模块：在Nginx内配置网络使用的能力。常见的events（事件）模块指令，大部分是放置在配置文件的顶部</p> 
<p>（3）配置模块：提供包含机制</p> 
<h3><a id="2nginx_100"></a>2、nginx的工作原理</h3> 
<p>nginx的模块直接被编译进nginx，因此属于静态编译方式。</p> 
<p>启动nginx后，nginx的模块被自动加载，与Apache不一样，首先将模块编译为一个so文件，然后在配置文件中指定是否进行加载。</p> 
<p>在解析配置文件时，nginx的每个模块都有可能去处理某个请求，但是同一个处理请求只能由一个模块来完成。</p> 
<p>nginx的进程架构：<br> 启动nginx时，会启动一个Master进程，这个进程不处理任何客户端的请求，主要用来产生worker线程，一个worker线程用来处理n个request。</p> 
<h4><a id="Nginx_110"></a>Nginx进程模型</h4> 
<p>Nginx默认采用多进程工作方式，Nginx启动后，会运行一个master进程和多个worker进程。其中master充当整个进程组与用户的交互接口，同时对进程进行监护，管理worker进程来实现重启服务、平滑升级、更换日志文件、配置文件实时生效等功能。worker用来处理基本的网络事件，worker之间是平等的，他们共同竞争来处理来自客户端的请求。<br> <img src="https://images2.imgbox.com/9f/a6/Adi3DBrb_o.png" alt="在这里插入图片描述"></p> 
<p>在创建master进程时，先建立需要监听的socket（listenfd），然后从master进程中fork()出多个worker进程，如此一来每个worker进程多可以监听用户请求的socket。一般来说，当一个连接进来后，所有在Worker都会收到通知，但是只有一个进程可以接受这个连接请求，其它的都失败，这是所谓的惊群现象。nginx提供了一个accept_mutex（互斥锁），有了这把锁之后，同一时刻，就只会有一个进程在accpet连接，这样就不会有惊群问题了。</p> 
<p>先打开accept_mutex选项，只有获得了accept_mutex的进程才会去添加accept事件。nginx使用一个叫ngx_accept_disabled的变量来控制是否去竞accept_mutex锁。ngx_accept_disabled = nginx单进程的所有连接总数 / 8 -空闲连接数量，当ngx_accept_disabled大于0时，不会去尝试获取accept_mutex锁ngx_accept_disable越大，于是让出的机会就越多，这样其它进程获取锁的机会也就越大。不去accept，每个worker进程的连接数就控制下来了，其它进程的连接池就会得到利用，这样，nginx就控制了多进程间连接的平衡。</p> 
<p>每个worker进程都有一个独立的连接池，连接池的大小是worker_connections。这里的连接池里面保存的其实不是真实的连接，它只是一个worker_connections大小的一个ngx_connection_t结构的数组。并且，nginx会通过一个链表free_connections来保存所有的空闲ngx_connection_t，每次获取一个连接时，就从空闲连接链表中获取一个，用完后，再放回空闲连接链表里面。一个nginx能建立的最大连接数，应该是worker_connections * worker_processes。当然，这里说的是最大连接数，对于HTTP请求本地资源来说，能够支持的最大并发数量是worker_connections * worker_processes，而如果是HTTP作为反向代理来说，最大并发数量应该是worker_connections * worker_processes/2。因为作为反向代理服务器，每个并发会建立与客户端的连接和与后端服务的连接，会占用两个连接。</p> 
<h2><a id="nginx_119"></a>五、nginx搭建</h2> 
<h3><a id="_120"></a>环境：</h3> 
<p>rocky Linux9 虚拟机<br> 192.168.100.111 nginx.example.com</p> 
<p>检查 firewalld 与 selinux 是否关闭</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># getenforce </span>
Disabled
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># systemctl status firewalld</span>
○ firewalld<span class="token punctuation">.</span>service <span class="token operator">-</span> firewalld <span class="token operator">-</span> dynamic firewall daemon
     Loaded<span class="token punctuation">:</span> loaded <span class="token punctuation">(</span><span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>systemd<span class="token operator">/</span>system<span class="token operator">/</span>firewalld<span class="token punctuation">.</span>service<span class="token punctuation">;</span> disabled<span class="token punctuation">;</span> preset<span class="token punctuation">:</span> enabled<span class="token punctuation">)</span>
     Active<span class="token punctuation">:</span> inactive <span class="token punctuation">(</span>dead<span class="token punctuation">)</span>
       Docs<span class="token punctuation">:</span> man<span class="token punctuation">:</span>firewalld<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="1__ngnix_136"></a>1、安装软件包 并 创建ngnix用户</h3> 
<pre><code class="prism language-python"><span class="token operator">//</span>开发工具包
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mount /dev/cdrom /mnt/</span>
mount<span class="token punctuation">:</span> <span class="token operator">/</span>mnt<span class="token punctuation">:</span> WARNING<span class="token punctuation">:</span> source write<span class="token operator">-</span>protected<span class="token punctuation">,</span> mounted read<span class="token operator">-</span>only<span class="token punctuation">.</span>
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># yum -y groupinstall “Development Tools” </span>

<span class="token operator">//</span>创建你滚下服务用户
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># useradd  -r -M -s /sbin/nologin nginx</span>
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># id nginx</span>
uid<span class="token operator">=</span><span class="token number">991</span><span class="token punctuation">(</span>nginx<span class="token punctuation">)</span> gid<span class="token operator">=</span><span class="token number">988</span><span class="token punctuation">(</span>nginx<span class="token punctuation">)</span> groups<span class="token operator">=</span><span class="token number">988</span><span class="token punctuation">(</span>nginx<span class="token punctuation">)</span>

<span class="token operator">//</span>依赖包及常用工具
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># yum -y install pcre-devel openssl openssl-devel gd-devel gcc gcc-c++ make zlib-devel wget lrzsz chrony</span>
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># systemctl restart chronyd</span>
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># systemctl enable chronyd</span>
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># hwclock -w</span>

</code></pre> 
<h3><a id="2_157"></a>2、创建日志存放目录和包文件存放目录</h3> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mkdir -p /var/log/nginx</span>
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># chown -R nginx.nginx /var/log/nginx/</span>
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># ll /var/log/ | grep nginx</span>
drwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x  <span class="token number">2</span> nginx  nginx       <span class="token number">6</span> Aug <span class="token number">26</span> <span class="token number">10</span><span class="token punctuation">:</span><span class="token number">06</span> nginx

<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># mkdir /opt/software</span>
<span class="token punctuation">[</span>root@nginx <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># cd /opt/software/</span>
<span class="token operator">//</span>直接将包文件拖进来
<span class="token punctuation">[</span>root@nginx software<span class="token punctuation">]</span><span class="token comment"># rz -E</span>
rz waiting to receive<span class="token punctuation">.</span>
<span class="token punctuation">[</span>root@nginx software<span class="token punctuation">]</span><span class="token comment"># ls</span>
nginx<span class="token operator">-</span><span class="token number">1.24</span><span class="token number">.0</span><span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz

</code></pre> 
<h3><a id="3nginx_174"></a>3、解压nginx源码包并编译安装</h3> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@nginx software<span class="token punctuation">]</span><span class="token comment"># tar -zxvf nginx-1.24.0.tar.gz -C /usr/local/</span>
<span class="token punctuation">[</span>root@nginx software<span class="token punctuation">]</span><span class="token comment"># cd /usr/local/</span>

<span class="token punctuation">[</span>root@nginx local<span class="token punctuation">]</span><span class="token comment"># cd nginx/</span>
<span class="token punctuation">[</span>root@nginx nginx<span class="token operator">-</span><span class="token number">1.24</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token comment"># ./configure \</span>
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span>prefix<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span>user<span class="token operator">=</span>nginx \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span>group<span class="token operator">=</span>nginx \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>debug \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>http_ssl_module \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>http_realip_module \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>http_image_filter_module \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>http_gunzip_module \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>http_gzip_static_module \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">with</span><span class="token operator">-</span>http_stub_status_module \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span>http<span class="token operator">-</span>log<span class="token operator">-</span>path<span class="token operator">=</span><span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>access<span class="token punctuation">.</span>log \
<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">-</span>error<span class="token operator">-</span>log<span class="token operator">-</span>path<span class="token operator">=</span><span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>error<span class="token punctuation">.</span>log

<span class="token punctuation">[</span>root@nginx nginx<span class="token operator">-</span><span class="token number">1.24</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token comment"># make</span>

<span class="token punctuation">[</span>root@nginx nginx<span class="token operator">-</span><span class="token number">1.24</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token comment"># make install</span>

</code></pre> 
<h3><a id="4_200"></a>4、配置环境变量</h3> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@nginx nginx<span class="token operator">-</span><span class="token number">1.24</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token comment"># echo "export PATH=/usr/local/nginx/sbin:$PATH" &gt; /etc/profile.d/nginx.sh</span>
<span class="token punctuation">[</span>root@nginx nginx<span class="token operator">-</span><span class="token number">1.24</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token comment"># . /etc/profile.d/nginx.sh </span>

</code></pre> 
<h3><a id="5nginx_207"></a>5、启动nginx</h3> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@nginx nginx<span class="token operator">-</span><span class="token number">1.24</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token comment"># nginx</span>
nginx<span class="token punctuation">:</span> <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> bind<span class="token punctuation">(</span><span class="token punctuation">)</span> to <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">80</span> failed <span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">:</span> Address already <span class="token keyword">in</span> use<span class="token punctuation">)</span>
nginx<span class="token punctuation">:</span> <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> bind<span class="token punctuation">(</span><span class="token punctuation">)</span> to <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">80</span> failed <span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">:</span> Address already <span class="token keyword">in</span> use<span class="token punctuation">)</span>
nginx<span class="token punctuation">:</span> <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> bind<span class="token punctuation">(</span><span class="token punctuation">)</span> to <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">80</span> failed <span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">:</span> Address already <span class="token keyword">in</span> use<span class="token punctuation">)</span>
nginx<span class="token punctuation">:</span> <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> bind<span class="token punctuation">(</span><span class="token punctuation">)</span> to <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">80</span> failed <span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">:</span> Address already <span class="token keyword">in</span> use<span class="token punctuation">)</span>
nginx<span class="token punctuation">:</span> <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> bind<span class="token punctuation">(</span><span class="token punctuation">)</span> to <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">80</span> failed <span class="token punctuation">(</span><span class="token number">98</span><span class="token punctuation">:</span> Address already <span class="token keyword">in</span> use<span class="token punctuation">)</span>
nginx<span class="token punctuation">:</span> <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> still could <span class="token keyword">not</span> bind<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">//</span>查看端口情况
<span class="token punctuation">[</span>root@nginx nginx<span class="token operator">-</span><span class="token number">1.24</span><span class="token number">.0</span><span class="token punctuation">]</span><span class="token comment"># ss -nalt</span>
State         Recv<span class="token operator">-</span>Q        Send<span class="token operator">-</span>Q               Local Address<span class="token punctuation">:</span>Port               Peer Address<span class="token punctuation">:</span>Port        Process        
LISTEN        <span class="token number">0</span>             <span class="token number">128</span>                        <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">22</span>                      <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token operator">*</span>                          
LISTEN        <span class="token number">0</span>             <span class="token number">511</span>                        <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">80</span>                      <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token operator">*</span>                          
LISTEN        <span class="token number">0</span>             <span class="token number">128</span>                           <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">22</span>                         <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token operator">*</span>                        

服务控制方式，使用nginx命令
<span class="token operator">-</span>t   检查配置文件语法
<span class="token operator">-</span>v   输出nginx的版本
<span class="token operator">-</span>c   指定配置文件路径
<span class="token operator">-</span>s   发送服务控制信号，可选值有stop、quit、reopen、<span class="token builtin">reload</span>

</code></pre> 
<h2><a id="_231"></a>六、配置文件详解</h2> 
<p>主配置文件：/usr/local/nginx/nginx.conf<br> 默认启动nginx时，使用的配置文件是：安装路径/conf/nginx.conf<br> 可以在启动nginx时通过-c选项来指定要读取的配置文件</p> 
<h3><a id="nginx_235"></a>nginx常见的配置文件及其作用</h3> 
<p>nginx.conf nginx的基本配置文件<br> mime.types MIME类型关联的扩展文件<br> fastcgi.conf 与fastcgi相关的配置<br> proxy.conf 与proxy相关的配置<br> sites.conf 配置nginx提供的网站，包括虚拟主机</p> 
<h3><a id="Nginxconf_242"></a>Nginx.conf配置文件详解</h3> 
<p>main配置段：全局配置段，其中main配置段中可能包含event配置段<br> events{}：定义event模型工作特性<br> http{}：定义http协议相关的配置</p> 
<p>支持使用变量：<br> （1）内置变量：模块会提供内建变量定义<br> （2）自定义变量：set var_name value</p> 
<p>//用于调试、定位问题的配置参数<br> daemon {on|off}; //是否以守护进程方式运行nginx，调试应设置为off<br> master_process {on|off}; //是否以master/worker模型来运行nginx，调试时可以设置为off<br> error_log 位置 级别； //配置错误日志</p> 
<p>error_log里的位置和级别的一些选项<br> <img src="https://images2.imgbox.com/f0/5b/u5OarNlM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_258"></a>正常运行必备的配置参数</h3> 
<p>user USERNAME [GROUPNAME]; //指定运行worker进程的用户和组<br> pid /path/to/pid_file; //指定nginx守护进程的pid文件<br> worker_rlimit_nofile number; //设置所有worker进程最大可以打开的文件数，默认为1024<br> worker_rlimit_core size; //指明所有worker进程所能够使用的总体的最大核心文件大小，保持默认即可</p> 
<h3><a id="_264"></a>优化性能的配置参数</h3> 
<p>worker_processes n; //启动n个worker进程，这里的n为了避免上下文切换，通常设置为cpu总核心数-1或等于总核心数<br> worker_cpu_affinity cpumask …; //将进程绑定到某cpu中，避免频繁刷新缓存<br> #cpumask：使用8位二进制表示cpu核心，如：<br> 0000 0001 #第一颗cpu核心<br> 0000 0010 #第二颗cpu核心<br> 0000 0100 #第三颗cpu核心<br> 0000 1000 #第四颗cpu核心<br> 0001 0000 #第五颗cpu核心<br> 0010 0000 #第六颗cpu核心<br> 0100 0000 #第七颗cpu核心<br> 1000 0000 #第八颗cpu核心<br> timer_resolution interval; //计时器解析度。降低此值，可减少gettimeofday（）系统调用的次数<br> worker_priority number; //指明worker进程的nice值</p> 
<h3><a id="event_279"></a>事件相关的配置：event{}段中的配置参数</h3> 
<p>accept_mutex {off|on}; //master调度用户请求至各worker进程时使用的负载均衡锁；on表示能让多个worker轮流的、序列化的去响应新请求<br> lock_file file; //accept_mutex用到的互斥锁所文件路径<br> use [epoll | rtsig | select | poll]; //指明使用的事件模型，建议让nginx自行选择<br> worker_connections 1024; //每个进程能够接受的最大连接数</p> 
<h3><a id="_285"></a>//网络连接相关的配置参数</h3> 
<p>keepalive_timeout number; //长连接的超时时长，默认为65s<br> keepalive_requests number; //在一个长连接上所能够允许请求的最大资源数<br> keepalive_disable [msie6|safari|none]; //为指定类型的UserAgent禁用长连接<br> tcp_nodelay on|off; //是否对长连接使用TCP_NODELAY选项，为了提升用户体验，通常设为on<br> client_header_timeout number; //读取http请求报文首部的超时时长<br> client_body_timeout number; //读取http请求报文body部分的超时时长<br> send_timeout number; //发送响应报文的超时时长</p> 
<p>Fastcgi的相关配置参数<br> LNMP：php要启用fpm模型</p> 
<p>location ~ .php$ {<!-- --><br> root html;<br> fastcgi_pass 127.0.0.1:9000; //定义反向代理<br> fastcgi_index index.php;<br> fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;<br> include fastcgi_params;<br> }</p> 
<h3><a id="_305"></a>常需要进行调整的参数</h3> 
<p>worker_processes<br> worker_connections<br> worker_cpu_affinity<br> worker_priority</p> 
<p>http{…}:配置http相关，由ngx_http_core_module模块引入。Nginx的HTTP配置主要包括4个区块<br> http {//协议级别<br> include mime.types;<br> default_type application/octet-stream;<br> keepalive_timeout 65;<br> gzip on;<br> upstream {//负载均衡配置<br> …<br> }<br> server {//服务器级别，每个server类似于httpd中的一个<br> listen 80;<br> server_name localhost;<br> location / {//请求级别，类似于httpd中的，用于定义URL与本地文件系统的映射关系<br> root html;<br> index index.html index.htm;<br> }<br> }<br> }</p> 
<h3><a id="http_331"></a>http{}端配置指定</h3> 
<p>server{}：定义一个虚拟主机<br> server {<!-- --><br> listen 80;<br> server_name www.example.com;<br> root “/vhost/web”;<br> }</p> 
<h3><a id="listen__339"></a>listen: 指定监听的地址和端口</h3> 
<p>listen address[:port]<br> listen port;</p> 
<h2><a id="lnmp_343"></a>七、lnmp部署</h2> 
<h3><a id="_344"></a>环境</h3> 
<p>nginx：192.168.100.111<br> Mysql：192.168.100.200<br> php：192.168.100.112<br> <strong>MYSQL部署：http://t.csdnimg.cn/qIyYN</strong></p> 
<h3><a id="1mysql_349"></a>1、修改mysql主机文件</h3> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@mysql <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># vim /etc/man_db.conf </span>
<span class="token operator">//</span>找到下面
<span class="token comment"># every automatically generated MANPATH includes these fields</span>
<span class="token comment">#</span>
<span class="token comment">#MANDATORY_MANPATH                      /usr/src/pvm3/man</span>
<span class="token comment">#</span>
MANDATORY_MANPATH                       <span class="token operator">/</span>usr<span class="token operator">/</span>man
MANDATORY_MANPATH                       <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>man
MANDATORY_MANPATH                       <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>share<span class="token operator">/</span>man
<span class="token operator">//</span>在后面添加一行信息
MANDATORY_MANPATH                       <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>mysql<span class="token operator">/</span>man


<span class="token punctuation">[</span>root@mysql <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># vim /etc/ld.so.conf.d/mysql.conf</span>
<span class="token operator">//</span>查看该文件内的信息
<span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>mysql<span class="token operator">/</span>lib

</code></pre> 
<h3><a id="2phpphp_369"></a>2、安装php依赖包和工具及php</h3> 
<p>安装php依赖包</p> 
<pre><code class="prism language-python">yum <span class="token operator">-</span>y install libxml2 libxml2<span class="token operator">-</span>devel openssl openssl<span class="token operator">-</span>devel bzip2 bzip2<span class="token operator">-</span>devel libcurl libcurl<span class="token operator">-</span>devel libicu<span class="token operator">-</span>devel libjpeg libjpeg<span class="token operator">-</span>devel libpng libpng<span class="token operator">-</span>devel openldap<span class="token operator">-</span>devel pcre<span class="token operator">-</span>devel freetype freetype<span class="token operator">-</span>devel gmp gmp<span class="token operator">-</span>devel  readline readline<span class="token operator">-</span>devel libxslt libxslt<span class="token operator">-</span>devel  php<span class="token operator">-</span>mysqlnd
</code></pre> 
<p>安装php</p> 
<pre><code class="prism language-python">yum <span class="token operator">-</span>y install php<span class="token operator">-</span><span class="token operator">*</span>
</code></pre> 
<h3><a id="3php_378"></a>3、配置php</h3> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@php <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># vim /etc/php-fpm.d/www.conf </span>
<span class="token punctuation">;</span>listen <span class="token operator">=</span> <span class="token operator">/</span>run<span class="token operator">/</span>php<span class="token operator">-</span>fpm<span class="token operator">/</span>www<span class="token punctuation">.</span>sock 
<span class="token operator">//</span>找到这里将listen侦听的端口改为

<span class="token punctuation">;</span> Note<span class="token punctuation">:</span> This value <span class="token keyword">is</span> mandatory<span class="token punctuation">.</span>
listen <span class="token operator">=</span><span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>

<span class="token operator">//</span>这里填nginx主机ip
listen<span class="token punctuation">.</span>allowed_clients <span class="token operator">=</span> <span class="token number">192.168</span><span class="token number">.100</span><span class="token number">.111</span>
</code></pre> 
<h3><a id="4_391"></a>4、生成测试页面</h3> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@php <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># vim /var/www/html/index.php</span>
<span class="token operator">&lt;</span>?php
        phpinfo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
?<span class="token operator">&gt;</span>

<span class="token punctuation">[</span>root@php <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># chown -R apache.apache /var/www/html/</span>
<span class="token punctuation">[</span>root@php <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># systemctl restart php-fpm.service </span>
<span class="token punctuation">[</span>root@php <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment"># systemctl enable php-fpm.service </span>

</code></pre> 
<h3><a id="5nginx_404"></a>5、nginx节点操作测试</h3> 
<h4><a id="nginxphp_405"></a>整合nginx和php</h4> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@nginx nginx<span class="token punctuation">]</span><span class="token comment"># vim /usr/local/nginx/conf/nginx.conf</span>
<span class="token operator">//</span>修改内容
        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
            root   html<span class="token punctuation">;</span>
            index  index<span class="token punctuation">.</span>php index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
                location <span class="token operator">~</span> \<span class="token punctuation">.</span>php$ <span class="token punctuation">{<!-- --></span>
                        root           html<span class="token punctuation">;</span>
                        fastcgi_pass   <span class="token number">192.168</span><span class="token number">.100</span><span class="token number">.112</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token punctuation">;</span>
                        fastcgi_index  index<span class="token punctuation">.</span>php<span class="token punctuation">;</span>
                        fastcgi_param  SCRIPT_FILENAME  <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token operator">/</span>$fastcgi_script_name<span class="token punctuation">;</span>
                        include        fastcgi_params<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

</code></pre> 
<h4><a id="nginx_423"></a>测试nginx配置文件</h4> 
<pre><code class="prism language-python"><span class="token punctuation">[</span>root@nginx nginx<span class="token punctuation">]</span><span class="token comment"># nginx -t</span>
nginx<span class="token punctuation">:</span> the configuration <span class="token builtin">file</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf syntax <span class="token keyword">is</span> ok
nginx<span class="token punctuation">:</span> configuration <span class="token builtin">file</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>nginx<span class="token punctuation">.</span>conf test <span class="token keyword">is</span> successful
<span class="token punctuation">[</span>root@nginx nginx<span class="token punctuation">]</span><span class="token comment"># nginx -s stop</span>
<span class="token punctuation">[</span>root@nginx nginx<span class="token punctuation">]</span><span class="token comment"># nginx</span>
<span class="token punctuation">[</span>root@nginx nginx<span class="token punctuation">]</span><span class="token comment"># ps -ef | grep nginx</span>
root         <span class="token number">829</span>       <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">05</span> ?        <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> nginx<span class="token punctuation">:</span> master process nginx
nginx        <span class="token number">830</span>     <span class="token number">829</span>  <span class="token number">0</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">05</span> ?        <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> nginx<span class="token punctuation">:</span> worker process
root         <span class="token number">832</span>     <span class="token number">673</span>  <span class="token number">0</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">06</span> pts<span class="token operator">/</span><span class="token number">0</span>    <span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span> grep <span class="token operator">-</span><span class="token operator">-</span>color<span class="token operator">=</span>auto nginx
<span class="token punctuation">[</span>root@nginx nginx<span class="token punctuation">]</span><span class="token comment"># ss -anlt</span>
State         Recv<span class="token operator">-</span>Q        Send<span class="token operator">-</span>Q               Local Address<span class="token punctuation">:</span>Port               Peer Address<span class="token punctuation">:</span>Port        Process        
LISTEN        <span class="token number">0</span>             <span class="token number">511</span>                        <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">80</span>                      <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token operator">*</span>                          
LISTEN        <span class="token number">0</span>             <span class="token number">128</span>                        <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token number">22</span>                      <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token punctuation">:</span><span class="token operator">*</span>                          
LISTEN        <span class="token number">0</span>             <span class="token number">128</span>                           <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">22</span>                         <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token operator">*</span>   
</code></pre> 
<p>验证<br> <img src="https://images2.imgbox.com/b6/47/gT7TjST0_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/48976a9c8de1bd8bba5d37acc8021fb6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">★ 数据结构 ★ 二叉树（下）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c8df48458877266d4872117594dd75ea/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">小程序常用的模板语法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>