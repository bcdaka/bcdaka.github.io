<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ai玩游戏(马里奥)项目(机器强化学习)详解 （二）设置游戏、预处理和环境矢量化 DummyVecEnv&amp;VecFrameStack 人工智能项目 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/8143f955884e02d9c8411ad9d7d6a602/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="ai玩游戏(马里奥)项目(机器强化学习)详解 （二）设置游戏、预处理和环境矢量化 DummyVecEnv&VecFrameStack 人工智能项目">
  <meta property="og:description" content="前言 上文讲解了强化学习模型ai训练玩马里奥游戏的环境，本文正式开始详细讲述训练过程。请在以下训练环境中运行本文的代码：
##环境## #pip install gym==0.23 #pip install nes-py==8.1.8 #pip install gym-super-mario-bros==7.3.0 #pip install stable_baselines3==2.0.0 #pip install Optuna 一、库导入与游戏环境设置 1）import库 import gym_super_mario_bros from nes_py.wrappers import JoypadSpace from gym_super_mario_bros.actions import SIMPLE_MOVEMENT 其中SIMPLE_MOVEMENT用于加入简化的操作方法，可以方便我们的AI操作马里奥。我们print以下SIMPLE_MOVEMENT查看：
[[&#39;NOOP&#39;], [&#39;right&#39;], [&#39;right&#39;, &#39;A&#39;], [&#39;right&#39;, &#39;B&#39;], [&#39;right&#39;, &#39;A&#39;, &#39;B&#39;], [&#39;A&#39;], [&#39;left&#39;]] 是一个操作的列表。
2）设置游戏环境对象 environment = gym_super_mario_bros.make(&#39;SuperMarioBros-v0&#39;) environment = JoypadSpace(environment, SIMPLE_MOVEMENT) 我们设置一个游戏环境的对象，其中使用的马里奥版本是标准版本（v0）
当然，你也可以使用别的版本，各个版本的差异请访问gymmario官网
第二行限定了ai的动作空间。即简单操作中包含的7个不同的按键组合。
我们这里涉及到了动作空间和观察空间，简单来说动作空间就是我们能干嘛，观察空间是我们的ai能看到啥，具体解释请看解释网址。
3）打开游戏窗口 done = True for step in range(10000): if done: environment.reset() state, reward, done, info = environment.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-20T22:47:44+08:00">
    <meta property="article:modified_time" content="2024-04-20T22:47:44+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ai玩游戏(马里奥)项目(机器强化学习)详解 （二）设置游戏、预处理和环境矢量化 DummyVecEnv&amp;VecFrameStack 人工智能项目</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_2"></a>前言</h2> 
<p>上文讲解了强化学习模型ai训练玩马里奥游戏的环境，本文正式开始详细讲述训练过程。请在以下训练环境中运行本文的代码：</p> 
<pre><code>##环境##
#pip install gym==0.23
#pip install nes-py==8.1.8
#pip install gym-super-mario-bros==7.3.0
#pip install stable_baselines3==2.0.0
#pip install Optuna

</code></pre> 
<hr> 
<h2><a id="_19"></a>一、库导入与游戏环境设置</h2> 
<h4><a id="1import_20"></a>1）import库</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> gym_super_mario_bros
<span class="token keyword">from</span> nes_py<span class="token punctuation">.</span>wrappers <span class="token keyword">import</span> JoypadSpace
<span class="token keyword">from</span> gym_super_mario_bros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> SIMPLE_MOVEMENT
</code></pre> 
<p>其中SIMPLE_MOVEMENT用于加入简化的操作方法，可以方便我们的AI操作马里奥。我们print以下SIMPLE_MOVEMENT查看：</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'NOOP'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'right'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'right'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'right'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token punctuation">[</span><span class="token string">'right'</span><span class="token punctuation">,</span> <span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'left'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>是一个操作的列表。</p> 
<h4><a id="2_33"></a>2）设置游戏环境对象</h4> 
<pre><code class="prism language-python">environment <span class="token operator">=</span> gym_super_mario_bros<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">'SuperMarioBros-v0'</span><span class="token punctuation">)</span>
environment <span class="token operator">=</span> JoypadSpace<span class="token punctuation">(</span>environment<span class="token punctuation">,</span> SIMPLE_MOVEMENT<span class="token punctuation">)</span>
</code></pre> 
<p>我们设置一个游戏环境的对象，其中使用的马里奥版本是标准版本（v0）<br> 当然，你也可以使用别的版本，各个版本的差异请访问<a href="https://pypi.org/project/gym-super-mario-bros/" rel="nofollow">gymmario官网</a><br> 第二行限定了ai的动作空间。即简单操作中包含的7个不同的按键组合。</p> 
<p>我们这里涉及到了动作空间和观察空间，简单来说动作空间就是我们能干嘛，观察空间是我们的ai能看到啥，具体解释请看<a href="https://zhuanlan.zhihu.com/p/658889348" rel="nofollow">解释网址</a>。</p> 
<h4><a id="3_44"></a>3）打开游戏窗口</h4> 
<pre><code class="prism language-python">done <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> done<span class="token punctuation">:</span>
        environment<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> environment<span class="token punctuation">.</span>step<span class="token punctuation">(</span>environment<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
environment<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>此段望文生义即可，其中action_sample是指动作空间中的随便一个样例；.render()方法将游戏显示在屏幕上。这段实现了打开游戏，随机做10000个动作，然后关闭窗口。</p> 
<p>运行代码效果如下（完整代码在下方）：<br> <img src="https://images2.imgbox.com/f7/4f/EvRMNMhh_o.gif" alt="请添加图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> gym_super_mario_bros
<span class="token keyword">from</span> nes_py<span class="token punctuation">.</span>wrappers <span class="token keyword">import</span> JoypadSpace
<span class="token keyword">from</span> gym_super_mario_bros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> SIMPLE_MOVEMENT

environment <span class="token operator">=</span> gym_super_mario_bros<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">'SuperMarioBros-v0'</span><span class="token punctuation">)</span>
environment <span class="token operator">=</span> JoypadSpace<span class="token punctuation">(</span>environment<span class="token punctuation">,</span> SIMPLE_MOVEMENT<span class="token punctuation">)</span>

done <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token keyword">for</span> step <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> done<span class="token punctuation">:</span>
        environment<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
    state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> environment<span class="token punctuation">.</span>step<span class="token punctuation">(</span>environment<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    environment<span class="token punctuation">.</span>render<span class="token punctuation">(</span><span class="token punctuation">)</span>
environment<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_Repreprocessing_77"></a>二、预处理 Repreprocessing与环境矢量化</h2> 
<p>接下来，我们要进行预处理，开始正式识别、训练。</p> 
<h4><a id="1_79"></a>1）预处理的库</h4> 
<p>代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> gym<span class="token punctuation">.</span>wrappers <span class="token keyword">import</span> FrameStack<span class="token punctuation">,</span> GrayScaleObservation
<span class="token keyword">from</span> stable_baselines3<span class="token punctuation">.</span>common<span class="token punctuation">.</span>vec_env <span class="token keyword">import</span> VecFrameStack<span class="token punctuation">,</span> DummyVecEnv
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
</code></pre> 
<p>Framestake 检测马里奥和敌人的移动轨迹 ，Gray 将彩色的游戏灰化，方便处理，matplotlib用于可视化。</p> 
<h6><a id="stablepytorchGPU_88"></a>注意，请在下载stable之前，下载pytorch，选择能支持GPU加速的版本~</h6> 
<h4><a id="2_91"></a>2）初始化、矢量化</h4> 
<pre><code class="prism language-python">environment <span class="token operator">=</span> gym_super_mario_bros<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">'SuperMarioBros-v0'</span><span class="token punctuation">)</span>
environment <span class="token operator">=</span> JoypadSpace<span class="token punctuation">(</span>environment<span class="token punctuation">,</span> SIMPLE_MOVEMENT<span class="token punctuation">)</span>
environment <span class="token operator">=</span> GrayScaleObservation<span class="token punctuation">(</span>environment<span class="token punctuation">,</span> keep_dim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
environment <span class="token operator">=</span> DummyVecEnv<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">lambda</span> <span class="token punctuation">:</span> environment<span class="token punctuation">]</span><span class="token punctuation">)</span>
environment <span class="token operator">=</span> VecFrameStack<span class="token punctuation">(</span>environment <span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> channels_order<span class="token operator">=</span><span class="token string">'last'</span><span class="token punctuation">)</span>
</code></pre> 
<p>一开始的取样维度为240 * 256 * 3。240 * 256是长宽、3是三种原色的表。<br> 第三行灰化图降维减少训练量。240 * 256 * 3–&gt;240 * 256 * 1</p> 
<p>第四行完成环境的向量化，如果要用多个环境，可以直接state[0],state[1]这样调用，在后续训练时，向量化的多个环境便会在同一个线程或者进程中被使用，从而提高采样和训练的效率。<br> 第四行运行完成 变为 1 * 240 * 256 * 1</p> 
<p>第五行堆叠了最后一维的数量（图片的数量），使得可以一次处理更多图片（此处是4张，其中一张是有初始化的，我们可以切片<code>state[0][:,:,3]</code>查看到之前的灰度图）。channels_order=last表示堆在最后一维。<br> 第五行运行完变为 1 * 240 * 256 * 4.</p> 
<h4><a id="3_109"></a>3）矢量化的效果展示</h4> 
<pre><code class="prism language-python">state <span class="token operator">=</span> environment<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> environment<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">[</span>environment<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/45/c6/IRpi6PF1_o.png" alt="在这里插入图片描述"></p> 
<p>以上代码用plt可视化查看以下我们矢量化环境的state中保存的照片<br> （此段的完整代码附在后面）。</p> 
<h4><a id="4_124"></a>4）你可能遇到的问题</h4> 
<h2><a id="shimmypip_install_shimmy_125"></a>遇到需要shimmy问题：pip install shimmy</h2> 
<h2><a id="ModuleNotFoundError_No_module_named_cv2_126"></a>遇到ModuleNotFoundError: No module named ‘cv2’</h2> 
<p>执行<code>pip install opencv-contrib-python -i https://pypi.tuna.tsinghua.edu.cn/simple</code></p> 
<p>本文最终代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> gym_super_mario_bros
<span class="token keyword">from</span> nes_py<span class="token punctuation">.</span>wrappers <span class="token keyword">import</span> JoypadSpace
<span class="token keyword">from</span> gym_super_mario_bros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> SIMPLE_MOVEMENT

<span class="token keyword">from</span> gym<span class="token punctuation">.</span>wrappers <span class="token keyword">import</span> FrameStack<span class="token punctuation">,</span> GrayScaleObservation
<span class="token keyword">from</span> stable_baselines3<span class="token punctuation">.</span>common<span class="token punctuation">.</span>vec_env <span class="token keyword">import</span> VecFrameStack<span class="token punctuation">,</span> DummyVecEnv
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt

environment <span class="token operator">=</span> gym_super_mario_bros<span class="token punctuation">.</span>make<span class="token punctuation">(</span><span class="token string">'SuperMarioBros-v0'</span><span class="token punctuation">)</span>
environment <span class="token operator">=</span> JoypadSpace<span class="token punctuation">(</span>environment<span class="token punctuation">,</span> SIMPLE_MOVEMENT<span class="token punctuation">)</span>
environment <span class="token operator">=</span> GrayScaleObservation<span class="token punctuation">(</span>environment<span class="token punctuation">,</span> keep_dim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
environment <span class="token operator">=</span> DummyVecEnv<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">lambda</span> <span class="token punctuation">:</span> environment<span class="token punctuation">]</span><span class="token punctuation">)</span>
environment <span class="token operator">=</span> VecFrameStack<span class="token punctuation">(</span>environment <span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> channels_order<span class="token operator">=</span><span class="token string">'last'</span><span class="token punctuation">)</span>

state <span class="token operator">=</span> environment<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>
state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">,</span> info <span class="token operator">=</span> environment<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">[</span>environment<span class="token punctuation">.</span>action_space<span class="token punctuation">.</span>sample<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0983437d40f06a1101bec6670bb9f1b5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Docker部署node.js并运行项目</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/346839c48d115d63b363acdf287bebd6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Android 腾讯地图】腾讯地图开发记录 ① ( 地图基础显示 | 创建应用和申请key | 配置远程依赖库 | 配置腾讯地图 Key | 同意隐私协议 | 布局设置 | 覆盖自定义地图图片 )</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>