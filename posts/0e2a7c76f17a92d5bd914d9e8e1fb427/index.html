<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【重生之我在学Android原生】Media3 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/0e2a7c76f17a92d5bd914d9e8e1fb427/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【重生之我在学Android原生】Media3">
  <meta property="og:description" content="相关文章 【重生之我在学Android原生】ContentProvider(Java)
【重生之我在学Android原生】Media3
前言 内容颇多，尽量从简
ExoPlayer使用 官方文档
参考文章
实现效果 Android（java）
使用ExoPlayer播放视频，自定义ExoPlayer界面，记录播放位置（横屏竖屏切换/切换至后台等）
案例实现 创建项目 添加依赖 Sync 一下
/// Jetpack Media3 ExoPlayer implementation (&#34;androidx.media3:media3-exoplayer:1.3.1&#34;) implementation (&#34;androidx.media3:media3-ui:1.3.1&#34;) implementation (&#34;androidx.media3:media3-common:1.3.1&#34;) 转到activity_main.xml 选择Player.View
&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt; &lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34; xmlns:app=&#34;http://schemas.android.com/apk/res-auto&#34; xmlns:tools=&#34;http://schemas.android.com/tools&#34; android:layout_width=&#34;match_parent&#34; android:layout_height=&#34;match_parent&#34; tools:context=&#34;.MainActivity&#34;&gt; &lt;androidx.media3.ui.PlayerView android:id=&#34;@&#43;id/video_view&#34; android:layout_width=&#34;match_parent&#34; android:layout_height=&#34;match_parent&#34; app:layout_constraintBottom_toBottomOf=&#34;parent&#34; app:layout_constraintEnd_toEndOf=&#34;parent&#34; app:layout_constraintStart_toStartOf=&#34;parent&#34; app:layout_constraintTop_toTopOf=&#34;parent&#34; /&gt; &lt;/androidx.constraintlayout.widget.ConstraintLayout&gt; player初始化 要在Activity的生命周期中完成player的初始化销毁等
package com.test.exoplayerexampleapplication; import androidx.annotation.OptIn; import androidx.appcompat.app.AppCompatActivity; import androidx.media3.common.util.UnstableApi; import androidx.media3.common.util.Util; import androidx.media3.ui.PlayerView; import android.os.Bundle; public class MainActivity extends AppCompatActivity { @Override protected void onCreate(Bundle savedInstanceState) { super.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-14T16:01:50+08:00">
    <meta property="article:modified_time" content="2024-05-14T16:01:50+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【重生之我在学Android原生】Media3</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>相关文章</h2> 
<p><a href="https://blog.csdn.net/sheng_er_sheng/article/details/137158255">【重生之我在学Android原生】ContentProvider(Java)</a><br> <a href="https://blog.csdn.net/sheng_er_sheng/article/details/137568029">【重生之我在学Android原生】Media3</a></p> 
<h2><a id="_3"></a>前言</h2> 
<p>内容颇多，尽量从简</p> 
<h2><a id="ExoPlayer_5"></a>ExoPlayer使用</h2> 
<p><a href="https://developer.android.google.cn/media/guides?hl=zh-cn" rel="nofollow">官方文档</a><br> <a href="https://developer.android.google.cn/codelabs/exoplayer-intro?hl=zh-cn#0" rel="nofollow">参考文章</a></p> 
<h3><a id="_8"></a>实现效果</h3> 
<p>Android（java）<br> 使用ExoPlayer播放视频，自定义ExoPlayer界面，记录播放位置（横屏竖屏切换/切换至后台等）</p> 
<h3><a id="_12"></a>案例实现</h3> 
<h4><a id="_13"></a>创建项目</h4> 
<p><img src="https://images2.imgbox.com/56/d2/rxMDJPVt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/62/be/Twg61fcD_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_16"></a>添加依赖</h4> 
<p><img src="https://images2.imgbox.com/2e/b4/xNLZ60Rn_o.png" alt="在这里插入图片描述"><br> Sync 一下</p> 
<pre><code class="prism language-kt"><span class="token comment">/// Jetpack Media3 ExoPlayer</span>
    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-exoplayer:1.3.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-ui:1.3.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-common:1.3.1"</span></span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="activity_mainxml_26"></a>转到activity_main.xml</h4> 
<p><img src="https://images2.imgbox.com/06/c1/KP6bQfxS_o.png" alt="在这里插入图片描述"><br> 选择Player.View</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.constraintlayout.widget.ConstraintLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">tools:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.media3.ui.PlayerView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/video_view<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintBottom_toBottomOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintEnd_toEndOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintStart_toStartOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintTop_toTopOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>androidx.constraintlayout.widget.ConstraintLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="player_49"></a>player初始化</h4> 
<p>要在Activity的生命周期中完成player的初始化销毁等<br> <img src="https://images2.imgbox.com/17/6d/42Do1bOA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/db/8a/v4ga8JQg_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>exoplayerexampleapplication</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">OptIn</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">AppCompatActivity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UnstableApi</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Util</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>ui<span class="token punctuation">.</span></span><span class="token class-name">PlayerView</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Bundle</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OptIn</span><span class="token punctuation">(</span>markerClass <span class="token operator">=</span> <span class="token class-name">UnstableApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">&gt;=</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">initializePlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OptIn</span><span class="token punctuation">(</span>markerClass <span class="token operator">=</span> <span class="token class-name">UnstableApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">initializePlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initializePlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="PlayerViewExoPlayer_91"></a>定义PlayerView，ExoPlayer</h4> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">PlayerView</span> playerView<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ExoPlayer</span> exoPlayer<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Uri</span> videoOneUri <span class="token operator">=</span> <span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"http://www.w3school.com.cn/example/html5/mov_bbb.mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在AndroidManifest.xml中定义网络权限，如果链接是Http，还需加userCleartextTraffic<br> <img src="https://images2.imgbox.com/f2/ea/FNE3ygn5_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<pre><code class="prism language-xml">android:usesCleartextTraffic="true"
</code></pre> 
<p>定义initializePlayer()方法</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initializePlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        playerView <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span>video_view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        exoPlayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExoPlayer<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playerView<span class="token punctuation">.</span><span class="token function">setPlayer</span><span class="token punctuation">(</span>exoPlayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MediaItem</span> mediaItem <span class="token operator">=</span> <span class="token class-name">MediaItem</span><span class="token punctuation">.</span><span class="token function">fromUri</span><span class="token punctuation">(</span>videoOneUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
        exoPlayer<span class="token punctuation">.</span><span class="token function">addMediaItem</span><span class="token punctuation">(</span>mediaItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        exoPlayer<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>运行可以播放视频<br> <img src="https://images2.imgbox.com/a4/b1/6nMJyzdx_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_118"></a>释放资源</h4> 
<p>媒体播放器是很占用资源的，所以当不再需要播放器时，要释放它，当然也要在Activity的生命周期中释放资源<br> <img src="https://images2.imgbox.com/b9/7e/0tp6vQVd_o.png" alt="在这里插入图片描述"><br> 在onStop和onPause适当调用<br> <img src="https://images2.imgbox.com/78/cc/laj6mLLJ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@OptIn</span><span class="token punctuation">(</span>markerClass <span class="token operator">=</span> <span class="token class-name">UnstableApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">releasePlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OptIn</span><span class="token punctuation">(</span>markerClass <span class="token operator">=</span> <span class="token class-name">UnstableApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">&gt;=</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">releasePlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">releasePlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        exoPlayer<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_144"></a>记录视频的播放状态</h4> 
<p>重新运行项目，测试切换至后台<br> <img src="https://images2.imgbox.com/d6/9c/T9epHxap_o.png" alt="在这里插入图片描述"><br> 切换至后台的生命周期，可以知道当APP放到后台，会调用player.release()方法释放<br> <img src="https://images2.imgbox.com/3b/c3/0DdjWOC5_o.png" alt="在这里插入图片描述"><br> 我们发现视频切换到后台，再切换回来，之前的播放到第四秒，切换回来发现，又回到第0秒。所以，现在需要记录之前播放的位置，播放的状态，播放到第几个视频了。<br> 既然没有onDestory掉Activity<br> 那么定义三个变量(播放位置，播放状态，第几个视频)</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">Long</span> playbackPosition <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> currentMediaItemIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> playWhenReady <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5b/9a/3AqkC1zw_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">playbackPosition <span class="token operator">=</span> exoPlayer<span class="token punctuation">.</span><span class="token function">getCurrentPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentMediaItemIndex <span class="token operator">=</span> exoPlayer<span class="token punctuation">.</span><span class="token function">getCurrentMediaItemIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playWhenReady <span class="token operator">=</span> exoPlayer<span class="token punctuation">.</span><span class="token function">getPlayWhenReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java">exoPlayer<span class="token punctuation">.</span><span class="token function">setPlayWhenReady</span><span class="token punctuation">(</span>playWhenReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
        exoPlayer<span class="token punctuation">.</span><span class="token function">seekTo</span><span class="token punctuation">(</span>currentMediaItemIndex<span class="token punctuation">,</span> playbackPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>添加新的视频链接</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Uri</span> videoTwoUri <span class="token operator">=</span> <span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"https://media.w3.org/2010/05/sintel/trailer.mp4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/b0/6Z7wnjvQ_o.png" alt="在这里插入图片描述"><br> 运行测试，播放下一个视频，并播放至一半，切换到后台，再切换回来<br> <img src="https://images2.imgbox.com/93/dd/jHaTidJ9_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_174"></a>横竖屏切换</h4> 
<p><img src="https://images2.imgbox.com/cb/73/GCSgwGfs_o.png" alt="在这里插入图片描述"><br> 横竖屏切换的生命周期，Activity被Destory了<br> <img src="https://images2.imgbox.com/2f/32/m13zmMOk_o.png" alt="在这里插入图片描述"></p> 
<p>使用SharedPreference来存储键值对，<a href="https://developer.android.google.cn/training/data-storage/shared-preferences?hl=zh-cn" rel="nofollow">参考官方文档</a>，官方推荐用DataStore<br> <img src="https://images2.imgbox.com/81/61/XUuFSTDQ_o.png" alt="在这里插入图片描述"><br> 那使用<a href="https://developer.android.google.cn/topic/libraries/architecture/datastore?hl=zh-cn" rel="nofollow">DataStore</a><br> <img src="https://images2.imgbox.com/27/a3/7drrVC72_o.png" alt="在这里插入图片描述"><br> 我们现在做的事情是，使用DataStore Preference来存储视频在释放之前的播放进度，播放状态，播放到第几个视频了。<br> 按照官网配置<a href="https://developer.android.google.cn/topic/libraries/architecture/datastore?hl=zh-cn#preferences-datastore-dependencies" rel="nofollow">Preferences DataStore</a><br> 引入依赖<br> <img src="https://images2.imgbox.com/36/79/VyruF26t_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-kt"><span class="token comment">/// Preferences DataStore</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.datastore:datastore-preferences:1.0.0"</span></span><span class="token punctuation">)</span>
    <span class="token comment">/// RxJava2 support</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.datastore:datastore-preferences-rxjava2:1.0.0"</span></span><span class="token punctuation">)</span>
    <span class="token comment">/// RxJava3 support</span>
    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.datastore:datastore-preferences-rxjava3:1.0.0"</span></span><span class="token punctuation">)</span>
</code></pre> 
<p>实例RxDataStore，销毁</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">RxDataStore</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Preferences</span><span class="token punctuation">&gt;</span></span> dataStore<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>dataStore <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dataStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RxPreferenceDataStoreBuilder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"ExoPlayerKeys"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataStore <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dataStore<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8a/44/kbd0QBxA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d7/3d/XMzb50XR_o.png" alt="在这里插入图片描述"><br> 定义三个Key</p> 
<pre><code class="prism language-java">    <span class="token class-name">Preferences<span class="token punctuation">.</span>Key</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> currentMediaItemIndexPK<span class="token punctuation">;</span>
    <span class="token class-name">Preferences<span class="token punctuation">.</span>Key</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> playbackPositionPK<span class="token punctuation">;</span>
    <span class="token class-name">Preferences<span class="token punctuation">.</span>Key</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> playWhenReadyPK<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java">currentMediaItemIndexPK <span class="token operator">=</span> <span class="token class-name">PreferencesKeys</span><span class="token punctuation">.</span><span class="token function">intKey</span><span class="token punctuation">(</span><span class="token string">"currentMediaItemIndex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playbackPositionPK <span class="token operator">=</span> <span class="token class-name">PreferencesKeys</span><span class="token punctuation">.</span><span class="token function">intKey</span><span class="token punctuation">(</span><span class="token string">"playbackPosition"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        playWhenReadyPK <span class="token operator">=</span> <span class="token class-name">PreferencesKeys</span><span class="token punctuation">.</span><span class="token function">booleanKey</span><span class="token punctuation">(</span><span class="token string">"playWhenReady"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/80/7a/2Wn3tZDY_o.png" alt="在这里插入图片描述"><br> 使用PreferencesKeys存储值<br> <img src="https://images2.imgbox.com/8c/31/eizjknVe_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveVideoRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        dataStore<span class="token punctuation">.</span><span class="token function">updateDataAsync</span><span class="token punctuation">(</span>preferences <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">MutablePreferences</span> mutablePreferences <span class="token operator">=</span> preferences<span class="token punctuation">.</span><span class="token function">toMutablePreferences</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mutablePreferences<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentMediaItemIndexPK<span class="token punctuation">,</span> currentMediaItemIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mutablePreferences<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>playbackPositionPK<span class="token punctuation">,</span> playbackPosition<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mutablePreferences<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>playWhenReadyPK<span class="token punctuation">,</span> playWhenReady<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Single</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>mutablePreferences<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>在onCreate()中取出之前存储的值，首次运行时，是没有存值的，所以会异常NULL，所以没有值就初始化这些变量<br> <img src="https://images2.imgbox.com/25/95/C41vRmpB_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            currentMediaItemIndex <span class="token operator">=</span> dataStore<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>preferences <span class="token operator">-&gt;</span> preferences<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentMediaItemIndexPK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">blockingFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            currentMediaItemIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            playbackPosition <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>dataStore<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>preferences <span class="token operator">-&gt;</span> preferences<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>playbackPositionPK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">blockingFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            playbackPosition <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            playWhenReady <span class="token operator">=</span> dataStore<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>preferences <span class="token operator">-&gt;</span> preferences<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>playWhenReadyPK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">blockingFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            playWhenReady <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>删除APP，重新运行项目，旋转屏幕也能记录播放状态，和播放进度，播放第几个视频<br> <img src="https://images2.imgbox.com/e0/d0/srDbZN2e_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1a/9c/yACQHLvJ_o.png" alt="在这里插入图片描述"><br> 旋转后，仍然从之前播放的进度继续，保持暂停。</p> 
<h4><a id="_265"></a>监听事件</h4> 
<p><a href="https://developer.android.google.cn/codelabs/exoplayer-intro?hl=zh_cn#5" rel="nofollow">参考链接</a></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@OptIn</span><span class="token punctuation">(</span>markerClass <span class="token operator">=</span> <span class="token class-name">UnstableApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addPlayerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Player<span class="token punctuation">.</span>Listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@OptIn</span><span class="token punctuation">(</span>markerClass <span class="token operator">=</span> <span class="token class-name">UnstableApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPlaybackStateChanged</span><span class="token punctuation">(</span><span class="token keyword">int</span> playbackState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Player<span class="token punctuation">.</span>Listener</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPlaybackStateChanged</span><span class="token punctuation">(</span>playbackState<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> stateString <span class="token operator">=</span> <span class="token string">"UNKNOWN_STATE"</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>playbackState <span class="token operator">==</span> <span class="token class-name">ExoPlayer</span><span class="token punctuation">.</span><span class="token constant">STATE_IDLE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    stateString <span class="token operator">=</span> <span class="token string">"EXoPlayer.STATE_IDLE"</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>playbackState <span class="token operator">==</span> <span class="token class-name">ExoPlayer</span><span class="token punctuation">.</span><span class="token constant">STATE_BUFFERING</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    stateString <span class="token operator">=</span> <span class="token string">"ExoPlayer.STATE_BUFFERING"</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>playbackState <span class="token operator">==</span> <span class="token class-name">Player</span><span class="token punctuation">.</span><span class="token constant">STATE_READY</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    stateString <span class="token operator">=</span> <span class="token string">"ExoPlayer.STATE_READY"</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>playbackState <span class="token operator">==</span> <span class="token class-name">Player</span><span class="token punctuation">.</span><span class="token constant">STATE_ENDED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    stateString <span class="token operator">=</span> <span class="token string">"ExoPlayer.STATE_ENDED"</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"changed state to "</span> <span class="token operator">+</span> stateString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        exoPlayer<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        analyticsListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnalyticsListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRenderedFirstFrame</span><span class="token punctuation">(</span><span class="token class-name">EventTime</span> eventTime<span class="token punctuation">,</span> <span class="token class-name">Object</span> output<span class="token punctuation">,</span> <span class="token keyword">long</span> renderTimeMs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">AnalyticsListener</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onRenderedFirstFrame</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> output<span class="token punctuation">,</span> renderTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"AnalyticsListener - onRenderedFirstFrame - 等待多长时间才能在屏幕上看到有意义的内容 - "</span> <span class="token operator">+</span> renderTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDroppedVideoFrames</span><span class="token punctuation">(</span><span class="token class-name">EventTime</span> eventTime<span class="token punctuation">,</span> <span class="token keyword">int</span> droppedFrames<span class="token punctuation">,</span> <span class="token keyword">long</span> elapsedMs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">AnalyticsListener</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDroppedVideoFrames</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> droppedFrames<span class="token punctuation">,</span> elapsedMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"AnalyticsListener - onDroppedVideoFrames - 视频丢帧 - "</span> <span class="token operator">+</span> droppedFrames<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAudioUnderrun</span><span class="token punctuation">(</span><span class="token class-name">EventTime</span> eventTime<span class="token punctuation">,</span> <span class="token keyword">int</span> bufferSize<span class="token punctuation">,</span> <span class="token keyword">long</span> bufferSizeMs<span class="token punctuation">,</span> <span class="token keyword">long</span> elapsedSinceLastFeedMs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">AnalyticsListener</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onAudioUnderrun</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> bufferSize<span class="token punctuation">,</span> bufferSizeMs<span class="token punctuation">,</span> elapsedSinceLastFeedMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"AnalyticsListener - onAudioUnderrun - 音频欠载 - "</span> <span class="token operator">+</span> bufferSizeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        exoPlayer<span class="token punctuation">.</span><span class="token function">addAnalyticsListener</span><span class="token punctuation">(</span>analyticsListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="ExoPlayer_312"></a>自定义ExoPlayer界面</h4> 
<p>按住Command键，左键查看PlayerView.java,鼠标hover在文件上，看它的位置，可以顺藤摸瓜找到它的源码</p> 
<p><img src="https://images2.imgbox.com/3a/dd/QGaWJOrY_o.png" alt="在这里插入图片描述"><br> 布局界面在这里<br> <img src="https://images2.imgbox.com/8f/55/6yXppGqz_o.png" alt="在这里插入图片描述"><br> 复制到自己的项目中<br> <img src="https://images2.imgbox.com/d1/8a/fqS50jyF_o.png" alt="在这里插入图片描述"><br> 在此基础上更改custom_player_control_view.xml<br> <img src="https://images2.imgbox.com/29/a3/fsM27t59_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dd/1c/UpLvQA9c_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="MediaSessionService_323"></a>MediaSessionService后台播放</h2> 
<p><a href="https://developer.android.google.cn/media/media3/session/control-playback?hl=zh-cn" rel="nofollow">参考文章</a></p> 
<h3><a id="_327"></a>实现效果</h3> 
<p>让媒体挂在后台播放，如下图<br> <img src="https://images2.imgbox.com/74/ba/TjUDpY9p_o.png" alt="在这里插入图片描述"><br> 正如官网所说，可以用在长视频，听视频。显然上面没有很多的交互，如果短视频用这个，既看不到播放的内容，也没啥交互，就还是不用MediaSession<br> <img src="https://images2.imgbox.com/0b/3a/qx5fvdn9_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_332"></a>案例实现</h3> 
<p>按照官方配置的步骤，语言还是采用Java。将构建一个MediaSession，让他在后台一直播放，同时可以自定义几个按钮，如点赞，收藏。最后监听视频是否播放。</p> 
<h4><a id="MediaController_335"></a>MediaController</h4> 
<p>显然需要用到MediaSessionService和MediaController<br> <img src="https://images2.imgbox.com/79/72/rHRXXknv_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/18/24/BE3P2ozj_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_340"></a>创建项目</h4> 
<p><img src="https://images2.imgbox.com/76/2f/JQ42VFsI_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/45/42/GVwXyCiz_o.png" alt="在这里插入图片描述"><br> 按照步骤，先new 一个ListenableFuture controllerFuture<br> 先引入依赖<br> <img src="https://images2.imgbox.com/3c/2f/cNOAy9kK_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d8/34/PI1jtUJ2_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-kts">    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-session:1.3.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-exoplayer:1.3.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-ui:1.3.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-common:1.3.1"</span></span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0f/41/P2UXc3FL_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="MediaController_354"></a>定义MediaController</h4> 
<p><img src="https://images2.imgbox.com/8c/5b/AbIolmsu_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>mediasessionserviceexample</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span><span class="token class-name">AppCompatActivity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">MediaItem</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">MediaMetadata</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">MediaController</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">SessionToken</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">ComponentName</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">Uri</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>os<span class="token punctuation">.</span></span><span class="token class-name">Bundle</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ListenableFuture</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">MoreExecutors</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutionException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainActivity</span> <span class="token keyword">extends</span> <span class="token class-name">AppCompatActivity</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaController</span><span class="token punctuation">&gt;</span></span> controllerFuture<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> mediaUrl <span class="token operator">=</span> <span class="token string">"https://media.w3.org/2010/05/sintel/trailer.mp4"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">SessionToken</span> sessionToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> 你的服务<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        controllerFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaController<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> sessionToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        controllerFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Uri</span> uri <span class="token operator">=</span> <span class="token class-name">Uri</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>mediaUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MediaMetadata</span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaMetadata<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setArtist</span><span class="token punctuation">(</span><span class="token string">"阿笙"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"我名字是视频"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MediaItem</span> mediaItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaItem<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setMediaId</span><span class="token punctuation">(</span><span class="token string">"media-one"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setUri</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setMediaMetadata</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">MediaController</span> mediaController <span class="token operator">=</span> controllerFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mediaController<span class="token punctuation">.</span><span class="token function">setMediaItem</span><span class="token punctuation">(</span>mediaItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mediaController<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> <span class="token operator">|</span> <span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">MoreExecutors</span><span class="token punctuation">.</span><span class="token function">directExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MediaController</span><span class="token punctuation">.</span><span class="token function">releaseFuture</span><span class="token punctuation">(</span>controllerFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="MediaSessionService_413"></a>定义服务MediaSessionService</h4> 
<p><img src="https://images2.imgbox.com/cf/34/85RArjLF_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>mediasessionserviceexample</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Intent</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">NonNull</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Nullable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Player</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>exoplayer<span class="token punctuation">.</span></span><span class="token class-name">ExoPlayer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">MediaSession</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">MediaSession</span><span class="token punctuation">.</span><span class="token class-name">ControllerInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">MediaSessionService</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlaybackService</span> <span class="token keyword">extends</span> <span class="token class-name">MediaSessionService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">MediaSession</span> mediaSession <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExoPlayer</span> player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExoPlayer<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> player<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MediaSession</span> <span class="token function">onGetSession</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ControllerInfo</span> controllerInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mediaSession<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTaskRemoved</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> rootIntent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onTaskRemoved</span><span class="token punctuation">(</span>rootIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Player</span> player <span class="token operator">=</span> mediaSession<span class="token punctuation">.</span><span class="token function">getPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>player<span class="token punctuation">.</span><span class="token function">getPlayWhenReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> player<span class="token punctuation">.</span><span class="token function">getMediaItemCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> player<span class="token punctuation">.</span><span class="token function">getPlaybackState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Player</span><span class="token punctuation">.</span><span class="token constant">STATE_ENDED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">stopSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaSession<span class="token punctuation">.</span><span class="token function">getPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaSession<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaSession <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e1/3c/Bgk7B8KY_o.png" alt="在这里插入图片描述"><br> 注册服务/申明服务</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span>service android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".PlaybackService"</span>
            android<span class="token operator">:</span>foregroundServiceType<span class="token operator">=</span><span class="token string">"mediaPlayback"</span>
            android<span class="token operator">:</span>exported<span class="token operator">=</span><span class="token string">"true"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>intent<span class="token operator">-</span>filter<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>action android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"androidx.media3.session.MediaSessionService"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>intent<span class="token operator">-</span>filter<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>service<span class="token operator">&gt;</span>
</code></pre> 
<p>申明权限（网络、前台服务）</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.INTERNET"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.FOREGROUND_SERVICE"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0a/0c/tL2u1C2x_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_480"></a>运行项目</h4> 
<p>下拉通知，可以看到这个服务，<br> <img src="https://images2.imgbox.com/c5/d4/3Ywewa9D_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="CommandButton_483"></a>定义按钮CommandButton</h4> 
<p>引入图标<br> <img src="https://images2.imgbox.com/b4/7c/hy1isxzM_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9d/ee/QNt7HdyJ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">CommandButton</span> cBRemoveFromLikes<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">CommandButton</span> cBRemoveFromFavorites<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">CommandButton</span> cBAddToLikes<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">CommandButton</span> cBAddToFavorites<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SessionCommand</span> sCAddToLikes<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SessionCommand</span> sCAddToFavorites<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SessionCommand</span> sCRemoveFromLike<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">SessionCommand</span> sCRemoveFromFavorite<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SAVE_TO_LIKES</span> <span class="token operator">=</span> <span class="token string">"save to likes"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SAVE_TO_FAVORITES</span> <span class="token operator">=</span> <span class="token string">"save to favorites"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">REMOVE_FROM_LIKES</span> <span class="token operator">=</span> <span class="token string">"remove from likes"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">REMOVE_FROM_FAVORITES</span> <span class="token operator">=</span> <span class="token string">"remove from favorites"</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java">sCAddToLikes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionCommand</span><span class="token punctuation">(</span><span class="token constant">SAVE_TO_LIKES</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sCAddToFavorites <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionCommand</span><span class="token punctuation">(</span><span class="token constant">SAVE_TO_FAVORITES</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sCRemoveFromLike <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionCommand</span><span class="token punctuation">(</span><span class="token constant">REMOVE_FROM_LIKES</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sCRemoveFromFavorite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SessionCommand</span><span class="token punctuation">(</span><span class="token constant">REMOVE_FROM_FAVORITES</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cBAddToLikes <span class="token operator">=</span> <span class="token function">buildCommandButton</span><span class="token punctuation">(</span><span class="token constant">SAVE_TO_LIKES</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>like_icon<span class="token punctuation">,</span> sCAddToLikes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cBAddToFavorites <span class="token operator">=</span> <span class="token function">buildCommandButton</span><span class="token punctuation">(</span><span class="token constant">SAVE_TO_FAVORITES</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>favorite_icon<span class="token punctuation">,</span> sCAddToFavorites<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cBRemoveFromLikes <span class="token operator">=</span> <span class="token function">buildCommandButton</span><span class="token punctuation">(</span><span class="token constant">REMOVE_FROM_LIKES</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>like_remove_icon<span class="token punctuation">,</span> sCRemoveFromLike<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cBRemoveFromFavorites <span class="token operator">=</span> <span class="token function">buildCommandButton</span><span class="token punctuation">(</span><span class="token constant">REMOVE_FROM_FAVORITES</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>favorite_remove_icon<span class="token punctuation">,</span> sCRemoveFromFavorite<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">CommandButton</span> <span class="token function">buildCommandButton</span><span class="token punctuation">(</span><span class="token class-name">String</span> displayName<span class="token punctuation">,</span> <span class="token keyword">int</span> iconResId<span class="token punctuation">,</span> <span class="token class-name">SessionCommand</span> sessionCommand<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommandButton<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setDisplayName</span><span class="token punctuation">(</span>displayName<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setIconResId</span><span class="token punctuation">(</span>iconResId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSessionCommand</span><span class="token punctuation">(</span>sessionCommand<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="MediaSession_520"></a>自定义MediaSession的布局</h4> 
<p><img src="https://images2.imgbox.com/b3/a6/kDR2C48P_o.png" alt="在这里插入图片描述"><br> 定义MediaSession可以使用哪些自定义命令<br> 在MediaSession.Builder()中setCallback 回调，setCustomLayout布局<br> <img src="https://images2.imgbox.com/39/f8/svv70Luu_o.png" alt="在这里插入图片描述"><br> 通过接收customAction的值，判断当前是什么命令，对应设置布局<br> <img src="https://images2.imgbox.com/5a/ac/ADu4uByt_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">CustomMediaSessionCallback</span> <span class="token keyword">implements</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>Callback</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@OptIn</span><span class="token punctuation">(</span>markerClass <span class="token operator">=</span> <span class="token class-name">UnstableApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ConnectionResult</span> <span class="token function">onConnect</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ControllerInfo</span> controller<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">SessionCommands</span> sessionCommands <span class="token operator">=</span> <span class="token class-name">ConnectionResult</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_SESSION_COMMANDS</span><span class="token punctuation">.</span><span class="token function">buildUpon</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sCAddToLikes<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sCAddToFavorites<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sCRemoveFromLike<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sCRemoveFromFavorite<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionResult<span class="token punctuation">.</span>AcceptedResultBuilder</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">setAvailableSessionCommands</span><span class="token punctuation">(</span>sessionCommands<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@OptIn</span><span class="token punctuation">(</span>markerClass <span class="token operator">=</span> <span class="token class-name">UnstableApi</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SessionResult</span><span class="token punctuation">&gt;</span></span> <span class="token function">onCustomCommand</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ControllerInfo</span> controller<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">SessionCommand</span> customCommand<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Bundle</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">CommandButton</span> buttonOne <span class="token operator">=</span> mediaSession<span class="token punctuation">.</span><span class="token function">getCustomLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">CommandButton</span> buttonTwo <span class="token operator">=</span> mediaSession<span class="token punctuation">.</span><span class="token function">getCustomLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>customCommand<span class="token punctuation">.</span>customAction<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> <span class="token constant">SAVE_TO_LIKES</span><span class="token operator">:</span>
                    mediaSession<span class="token punctuation">.</span><span class="token function">setCustomLayout</span><span class="token punctuation">(</span><span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>cBRemoveFromLikes<span class="token punctuation">,</span> buttonTwo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">SAVE_TO_FAVORITES</span><span class="token operator">:</span>
                    mediaSession<span class="token punctuation">.</span><span class="token function">setCustomLayout</span><span class="token punctuation">(</span><span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>buttonOne<span class="token punctuation">,</span> cBRemoveFromFavorites<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">REMOVE_FROM_LIKES</span><span class="token operator">:</span>
                    mediaSession<span class="token punctuation">.</span><span class="token function">setCustomLayout</span><span class="token punctuation">(</span><span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>cBAddToLikes<span class="token punctuation">,</span> buttonTwo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">REMOVE_FROM_FAVORITES</span><span class="token operator">:</span>
                    mediaSession<span class="token punctuation">.</span><span class="token function">setCustomLayout</span><span class="token punctuation">(</span><span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>buttonOne<span class="token punctuation">,</span> cBAddToFavorites<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"not implement"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">immediateFuture</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SessionResult</span><span class="token punctuation">(</span><span class="token class-name">SessionResult</span><span class="token punctuation">.</span><span class="token constant">RESULT_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_571"></a>运行测试</h4> 
<p><img src="https://images2.imgbox.com/c5/3c/BmK94nFe_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Playerplay_573"></a>自定义Player的行为(play等)</h4> 
<p><img src="https://images2.imgbox.com/66/7a/tBvROhwQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">        <span class="token class-name">ExoPlayer</span> player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExoPlayer<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ForwardingPlayer</span> forwardingPlayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForwardingPlayer</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"ForwardingPlayer Log"</span><span class="token punctuation">,</span> <span class="token string">"play!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        mediaSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> forwardingPlayer<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CustomMediaSessionCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCustomLayout</span><span class="token punctuation">(</span><span class="token class-name">ImmutableList</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>cBAddToLikes<span class="token punctuation">,</span> cBAddToFavorites<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="MediaLibraryService_592"></a>MediaLibraryService</h2> 
<h3><a id="_593"></a>实现目标</h3> 
<p><a href="https://developer.android.google.cn/media/media3/session/serve-content?hl=zh-cn" rel="nofollow">参考文档</a><br> 主要实现三个函数</p> 
<ul><li>onGetLibraryRoot()</li><li>onGetChildren()</li><li>onGetSearchResult()<br> <img src="https://images2.imgbox.com/48/12/gOiw73iy_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="_600"></a>实现效果</h3> 
<p>创建一个目录，目录下有三个文件，并且可以根据标题搜索这三个文件<br> <img src="https://images2.imgbox.com/e9/4f/8vYmv0UW_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_604"></a>案例实现</h3> 
<p>采用JAVA实现</p> 
<h4><a id="_606"></a>创建项目接着引入依赖</h4> 
<p><img src="https://images2.imgbox.com/03/b3/HyHzd9NJ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-kts">    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-session:1.3.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-exoplayer:1.3.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-ui:1.3.1"</span></span><span class="token punctuation">)</span>
    <span class="token function">implementation</span> <span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"androidx.media3:media3-common:1.3.1"</span></span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="MediaLibraryService_615"></a>初始化MediaLibraryService</h4> 
<p><img src="https://images2.imgbox.com/45/b2/s9fhfHTw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/90/cd/yZqViHNv_o.png" alt="在这里插入图片描述"><br> 和MediaSession操作差不多，先实例<br> <img src="https://images2.imgbox.com/ad/a4/2Oyi0Z9g_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>medialibraryservicetestapplication</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">NonNull</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Nullable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">MediaItem</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>exoplayer<span class="token punctuation">.</span></span><span class="token class-name">ExoPlayer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">LibraryResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">MediaLibraryService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">MediaSession</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span></span><span class="token class-name">ImmutableList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ListenableFuture</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlaybackService</span> <span class="token keyword">extends</span> <span class="token class-name">MediaLibraryService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">MediaLibrarySession</span> mediaLibrarySession <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">MediaLibrarySession<span class="token punctuation">.</span>Callback</span> callback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaLibrarySession<span class="token punctuation">.</span>Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibraryResult</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">onGetLibraryRoot</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaLibrarySession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> browser<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>LibraryParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">MediaLibrarySession<span class="token punctuation">.</span>Callback</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onGetLibraryRoot</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> browser<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibraryResult</span><span class="token punctuation">&lt;</span><span class="token class-name">ImmutableList</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">onGetChildren</span><span class="token punctuation">(</span><span class="token class-name">MediaLibrarySession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> browser<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> parentId<span class="token punctuation">,</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>LibraryParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">MediaLibrarySession<span class="token punctuation">.</span>Callback</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onGetChildren</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> browser<span class="token punctuation">,</span> parentId<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibraryResult</span><span class="token punctuation">&lt;</span><span class="token class-name">ImmutableList</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">onGetSearchResult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaLibrarySession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> browser<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> query<span class="token punctuation">,</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>LibraryParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">MediaLibrarySession<span class="token punctuation">.</span>Callback</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onGetSearchResult</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> browser<span class="token punctuation">,</span> query<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MediaLibrarySession</span> <span class="token function">onGetSession</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> controllerInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mediaLibrarySession<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExoPlayer</span> player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExoPlayer<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaLibrarySession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>MediaLibrarySession<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> player<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaLibrarySession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mediaLibrarySession<span class="token punctuation">.</span><span class="token function">getPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mediaLibrarySession<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mediaLibrarySession <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_680"></a>创建树形结构存储数据</h4> 
<p>要获取根对象，需要有一个建好的树形数据，就如下面这幅图上，它是一个树，树的根节点RootNode，分叉出去好几个类目，简单起见，这里先弄简单的Root-&gt;Music/Game/Study<br> <img src="https://images2.imgbox.com/8a/7c/Hho1eQPY_o.png" alt="在这里插入图片描述"><br> 定义树<br> <img src="https://images2.imgbox.com/bc/86/jjGnIbTn_o.png" alt="在这里插入图片描述"><br> 构建根节点，添加三个子节点到根节点<br> <img src="https://images2.imgbox.com/72/90/dEaRplul_o.png" alt="在这里插入图片描述"><br> 最后改为单例</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>medialibraryservicetestapplication</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tree</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TreeNode</span><span class="token punctuation">&gt;</span></span> treeNodes<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROOT_ID</span> <span class="token operator">=</span> <span class="token string">"root"</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MUSIC_ID</span> <span class="token operator">=</span> <span class="token string">"music"</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GAME_ID</span> <span class="token operator">=</span> <span class="token string">"game"</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">STUDY_ID</span> <span class="token operator">=</span> <span class="token string">"study"</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROOT_TITLE</span> <span class="token operator">=</span> <span class="token string">"root title"</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">MUSIC_TITLE</span> <span class="token operator">=</span> <span class="token string">"music title"</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GAME_TITLE</span> <span class="token operator">=</span> <span class="token string">"game title"</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">STUDY_TITLE</span> <span class="token operator">=</span> <span class="token string">"study title"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">Tree</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Tree</span> <span class="token function">genInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isInitialized <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isInitialized<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            isInitialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            treeNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TreeNode</span> rootNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token constant">ROOT_ID</span><span class="token punctuation">,</span> <span class="token constant">ROOT_TITLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TreeNode</span> musicNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token constant">MUSIC_ID</span><span class="token punctuation">,</span> <span class="token constant">MUSIC_TITLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TreeNode</span> gameNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token constant">GAME_ID</span><span class="token punctuation">,</span> <span class="token constant">GAME_TITLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TreeNode</span> studyNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span><span class="token constant">STUDY_ID</span><span class="token punctuation">,</span> <span class="token constant">STUDY_TITLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rootNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>musicNode<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rootNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>gameNode<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rootNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>studyNode<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            treeNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">ROOT_ID</span><span class="token punctuation">,</span> rootNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_727"></a>获取根节点</h4> 
<p><img src="https://images2.imgbox.com/32/12/QgW5o00F_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token class-name">MediaItem</span> <span class="token function">getTreeRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>treeNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ROOT_ID</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java">        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibraryResult</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">onGetLibraryRoot</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaLibrarySession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> browser<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>LibraryParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">immediateFuture</span><span class="token punctuation">(</span><span class="token class-name">LibraryResult</span><span class="token punctuation">.</span><span class="token function">ofItem</span><span class="token punctuation">(</span><span class="token class-name">Tree</span><span class="token punctuation">.</span><span class="token function">genInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTreeRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_742"></a>获取结点的子节点集合</h4> 
<p><img src="https://images2.imgbox.com/f6/5c/APpFA3WM_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span></span> <span class="token function">getNodeChildren</span><span class="token punctuation">(</span><span class="token class-name">String</span> treeNodeId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>treeNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>treeNodeId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibraryResult</span><span class="token punctuation">&lt;</span><span class="token class-name">ImmutableList</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">onGetChildren</span><span class="token punctuation">(</span><span class="token class-name">MediaLibrarySession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> browser<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> parentId<span class="token punctuation">,</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>LibraryParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> <span class="token class-name">Tree</span><span class="token punctuation">.</span><span class="token function">genInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeChildren</span><span class="token punctuation">(</span>parentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>children<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">immediateFuture</span><span class="token punctuation">(</span><span class="token class-name">LibraryResult</span><span class="token punctuation">.</span><span class="token function">ofItemList</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">immediateFuture</span><span class="token punctuation">(</span><span class="token class-name">LibraryResult</span><span class="token punctuation">.</span><span class="token function">ofError</span><span class="token punctuation">(</span><span class="token class-name">LibraryResult</span><span class="token punctuation">.</span><span class="token constant">RESULT_ERROR_BAD_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Service_760"></a>注册Service及申明权限</h4> 
<p><img src="https://images2.imgbox.com/de/5e/7j5bnl5P_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.FOREGROUND_SERVICE<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span>
            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.PlaybackService<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>foregroundServiceType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mediaPlayback<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>androidx.media3.session.MediaSessionService<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="MediaBrowserMediaLibraryService_776"></a>MediaBrowser浏览MediaLibraryService定义的媒体库</h4> 
<p><img src="https://images2.imgbox.com/0f/d0/pimn3jHq_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/22/36/8lZ46fAw_o.png" alt="在这里插入图片描述"><br> 获取MediaLibraryService构建的媒体库的根节点<br> <img src="https://images2.imgbox.com/23/8f/FIfetBGq_o.png" alt="在这里插入图片描述"><br> 获取某一节点下的子节点<br> <img src="https://images2.imgbox.com/5d/73/kKz9aH1x_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_783"></a>运行测试</h4> 
<p>运行项目，并在60行打上断点，看到value属性值为三个MediaItem对象<br> 可以看到获取到根节点下的三个子节点<br> <img src="https://images2.imgbox.com/f2/71/3sHTQKqY_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>test<span class="token punctuation">.</span>medialibraryservicetestapplication</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">NonNull</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Nullable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">MediaItem</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>exoplayer<span class="token punctuation">.</span></span><span class="token class-name">ExoPlayer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">LibraryResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">MediaLibraryService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">androidx<span class="token punctuation">.</span>media3<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span><span class="token class-name">MediaSession</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span></span><span class="token class-name">ImmutableList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Futures</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ListenableFuture</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PlaybackService</span> <span class="token keyword">extends</span> <span class="token class-name">MediaLibraryService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">MediaLibrarySession</span> mediaLibrarySession <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token class-name">MediaLibrarySession<span class="token punctuation">.</span>Callback</span> callback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaLibrarySession<span class="token punctuation">.</span>Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibraryResult</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">onGetLibraryRoot</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaLibrarySession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> browser<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>LibraryParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">immediateFuture</span><span class="token punctuation">(</span><span class="token class-name">LibraryResult</span><span class="token punctuation">.</span><span class="token function">ofItem</span><span class="token punctuation">(</span><span class="token class-name">Tree</span><span class="token punctuation">.</span><span class="token function">genInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTreeRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibraryResult</span><span class="token punctuation">&lt;</span><span class="token class-name">ImmutableList</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">onGetChildren</span><span class="token punctuation">(</span><span class="token class-name">MediaLibrarySession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> browser<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> parentId<span class="token punctuation">,</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>LibraryParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span></span> children <span class="token operator">=</span> <span class="token class-name">Tree</span><span class="token punctuation">.</span><span class="token function">genInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeChildren</span><span class="token punctuation">(</span>parentId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>children<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">immediateFuture</span><span class="token punctuation">(</span><span class="token class-name">LibraryResult</span><span class="token punctuation">.</span><span class="token function">ofItemList</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">immediateFuture</span><span class="token punctuation">(</span><span class="token class-name">LibraryResult</span><span class="token punctuation">.</span><span class="token function">ofError</span><span class="token punctuation">(</span><span class="token class-name">LibraryResult</span><span class="token punctuation">.</span><span class="token constant">RESULT_ERROR_BAD_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibraryResult</span><span class="token punctuation">&lt;</span><span class="token class-name">ImmutableList</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">onGetSearchResult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaLibrarySession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> browser<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> query<span class="token punctuation">,</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>LibraryParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">MediaLibrarySession<span class="token punctuation">.</span>Callback</span><span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onGetSearchResult</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> browser<span class="token punctuation">,</span> query<span class="token punctuation">,</span> page<span class="token punctuation">,</span> pageSize<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">MediaLibrarySession</span> <span class="token function">onGetSession</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> controllerInfo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mediaLibrarySession<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExoPlayer</span> player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExoPlayer<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mediaLibrarySession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>MediaLibrarySession<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> player<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mediaLibrarySession <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mediaLibrarySession<span class="token punctuation">.</span><span class="token function">getPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mediaLibrarySession<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mediaLibrarySession <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_854"></a>搜索媒体库</h4> 
<p>首先还是去Tree中定义搜索的函数<br> <img src="https://images2.imgbox.com/06/69/MljvE5H3_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span></span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> query<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span></span> titleMatches <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> it<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>it <span class="token operator">-&gt;</span> it<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        titleNodes<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>title <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">TreeNode</span> treeNode <span class="token operator">=</span> titleNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> word <span class="token operator">:</span> words<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">boolean</span> contains <span class="token operator">=</span> title<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span><span class="token punctuation">)</span> word<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>contains<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">assert</span> treeNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    titleMatches<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>treeNode<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> titleMatches<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TreeNode</span><span class="token punctuation">&gt;</span></span> titleNodes<span class="token punctuation">;</span>
titleNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            titleNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">MUSIC_TITLE</span><span class="token punctuation">,</span> musicNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            titleNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">GAME_TITLE</span><span class="token punctuation">,</span> gameNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            titleNodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">STUDY_TITLE</span><span class="token punctuation">,</span> studyNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b4/94/f7uCvdTs_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java">        <span class="token annotation punctuation">@NonNull</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibraryResult</span><span class="token punctuation">&lt;</span><span class="token class-name">ImmutableList</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">onGetSearchResult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaLibrarySession</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">MediaSession<span class="token punctuation">.</span>ControllerInfo</span> browser<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> query<span class="token punctuation">,</span> <span class="token keyword">int</span> page<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">MediaLibraryService<span class="token punctuation">.</span>LibraryParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">immediateFuture</span><span class="token punctuation">(</span><span class="token class-name">LibraryResult</span><span class="token punctuation">.</span><span class="token function">ofItemList</span><span class="token punctuation">(</span><span class="token class-name">Tree</span><span class="token punctuation">.</span><span class="token function">genInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="MediaBrowser__890"></a>MediaBrowser 搜索</h4> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">searchMedia</span><span class="token punctuation">(</span><span class="token class-name">String</span> query<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibraryResult</span><span class="token punctuation">&lt;</span><span class="token class-name">ImmutableList</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> searchFuture <span class="token operator">=</span> mediaBrowser<span class="token punctuation">.</span><span class="token function">getSearchResult</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        searchFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">LibraryResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ImmutableList</span><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> immutableListLibraryResult <span class="token operator">=</span> searchFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ImmutableList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaItem</span><span class="token punctuation">&gt;</span></span> value <span class="token operator">=</span> immutableListLibraryResult<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> <span class="token operator">|</span> <span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">MoreExecutors</span><span class="token punctuation">.</span><span class="token function">directExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a0/6f/dPR2MOol_o.png" alt="在这里插入图片描述"><br> 搜索“ga”，可以查到“game”这个MediaItem<br> <img src="https://images2.imgbox.com/29/80/Ptykv9uK_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_907"></a>填坑中…</h2> 
<p>内容是真的多!</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f92435272b53072f87b2dd839e73297a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Hadoop上传文件到HDFS的步骤</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3941187f32bafe6e8deef7fa8198b261/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【ChatGPT】官方Mac版下载</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>