<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>xmind导入导出支持图片功能源码改造 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/a845f8ddcc4f92e58eb0356bc9a9635e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="xmind导入导出支持图片功能源码改造">
  <meta property="og:description" content="xmind导入导出支持图片功能
在开发用例管理平台的过程中，需要使用xmind来管理用例。所以也涉及到xmind用例的导入导出功能，
在开始的时候，xmind文件中没有图片，所以使用xmind,xmindparser包就可以完成改任务。现在新增需求，
要求支持xmind文件中图片的导入导出。原有的包，并不支持图片的操作，所以需要对这两个包进行一些改造。
1.环境 python3.8
2.xmind版本，xmind8，xmindzen
3.需要的python包 xmind包，xmindparser包
xmindparser包改造
针对xmind8版本，需要改动xreader.py文件的image_of方法
原方法：
def image_of(node):
img = node.find(&#39;img&#39;)
if img is not None:
return &#39;[Image]&#39;
因为项目需要图片的内容信息，还有图片的大小，所以将图片的附件、高、宽，拼接一起返回
改造后方法：
def image_of(node):
img = node.find(&#39;img&#39;)
if img is not None:
src_attribute = img.get(&#39;{http://www.w3.org/1999/xhtml}src&#39;)
height_attribute = img.get(&#39;{http://www.w3.org/2000/svg}height&#39;)
width_attribute = img.get(&#39;{http://www.w3.org/2000/svg}width&#39;)
return str(src_attribute) &#43; &#39;:&#39; &#43; str(height_attribute) &#43; &#39;:&#39; &#43; str(width_attribute)
return None
针对xmindzen版本，需要改动zenreader.py文件的image_of方法
def image_of(node):
img = node.get(&#39;image&#39;, None)
if img is not None:">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-03T17:08:29+08:00">
    <meta property="article:modified_time" content="2024-07-03T17:08:29+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">xmind导入导出支持图片功能源码改造</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>xmind导入导出支持图片功能<br> 在开发用例管理平台的过程中，需要使用xmind来管理用例。所以也涉及到xmind用例的导入导出功能，<br> 在开始的时候，xmind文件中没有图片，所以使用xmind,xmindparser包就可以完成改任务。现在新增需求，<br> 要求支持xmind文件中图片的导入导出。原有的包，并不支持图片的操作，所以需要对这两个包进行一些改造。<br> 1.环境 python3.8<br> 2.xmind版本，xmind8，xmindzen<br> 3.需要的python包 xmind包，xmindparser包</p> 
<p>xmindparser包改造<br> 针对xmind8版本，需要改动xreader.py文件的image_of方法<br> 原方法：<br> def image_of(node):<br>     img = node.find('img')</p> 
<p>    if img is not None:<br>         return '[Image]'<br> 因为项目需要图片的内容信息，还有图片的大小，所以将图片的附件、高、宽，拼接一起返回<br> 改造后方法：<br> def image_of(node):<br>     img = node.find('img')<br>     if img is not None:<br>         src_attribute = img.get('{http://www.w3.org/1999/xhtml}src')<br>         height_attribute = img.get('{http://www.w3.org/2000/svg}height')<br>         width_attribute = img.get('{http://www.w3.org/2000/svg}width')<br>         return str(src_attribute) + ':' + str(height_attribute) + ':' + str(width_attribute)<br>     return None</p> 
<p>针对xmindzen版本，需要改动zenreader.py文件的image_of方法<br> def image_of(node):<br>     img = node.get('image', None)<br>     if img is not None:<br>         src_attribute = img.get('src')<br>         height_attribute = img.get('height')<br>         width_attribute = img.get('width')<br>         return str(src_attribute) + ':' + str(height_attribute) + ':' + str(width_attribute)<br>     return None</p> 
<p>使用改造后方法，下载xmind的图片<br> xmind_file = /data/xmind/test.xmind<br> xmind_content_dict = xmind_to_dict(xmind_file)<br> zFile = ZipFile(xmind_file, 'r')<br> image_data = zFile.read('attachments/xxxxxxxx')# 这就是改造后image_of方法中的src_attribute字段<br> file_name = '/data/image/image.jpg'<br> with open(file_name, 'wb') as f:<br>     f.write(image_data)<br> 即可将文件保存到file_name</p> 
<p>xmind库改造<br> const.py新增内容如下<br> # 图片<br> IMAGE = 'xhtml:img'<br> IMAGE_SRC = 'xhtml:src'<br> IMAGE_HEIGHT = 'svg:height'<br> IMAGE_WIDTH = 'svg:width'</p> 
<p>markerref.py新增内容如下<br> class ImageElement(WorkbookMixinElement):<br>     TAG_NAME = const.IMAGE</p> 
<p>    def __init__(self, node=None, ownerWorkbook=None):<br>         super(ImageElement, self).__init__(node, ownerWorkbook)</p> 
<p>    def getXhtmlSrc(self):<br>         '''取消前缀，只留图片名称，后续直接在attachments文件夹下找该图片'''<br>         return self.getAttribute(const.IMAGE_SRC).replace('xap:attachments/', '')</p> 
<p>    def getImageHeight(self):<br>         return self.getAttribute(const.IMAGE_HEIGHT)</p> 
<p>    def getImageWidth(self):<br>         return self.getAttribute(const.IMAGE_WIDTH)</p> 
<p>    def setXhtmlSrc(self, src):<br>         return self.setAttribute(const.IMAGE_SRC, f"xap:attachments/{src}")</p> 
<p>    def setImageHeight(self, height):<br>         return self.setAttribute(const.IMAGE_HEIGHT, height)</p> 
<p>    def setImageWidth(self, width):<br>         return self.setAttribute(const.IMAGE_WIDTH, width)</p> 
<p>topic.py文件新增如下内容<br> TopicElement类下的<br> getData函数的data字段新增'image': self.getImage()<br> TopicElement类下新增三个函数<br> def getImage(self):<br>     image = self._get_image()<br>     if image:<br>         image = ImageElement(image, self.getOwnerWorkbook())<br>         return {<!-- --><br>             'src': image.getXhtmlSrc(),<br>             'height': image.getImageHeight(),<br>             'width': image.getImageWidth()<br>         }</p> 
<p>def setImage(self, src, height, width):<br>     image = self._get_image()<br>     if not image:<br>         image = ImageElement(None, self.getOwnerWorkbook())<br>         self.appendChild(image)<br>     else:<br>         image = ImageElement(image, self.getOwnerWorkbook())<br>     image.setXhtmlSrc(src)<br>     image.setImageHeight(height)<br>     image.setImageWidth(width)<br> def _get_image(self):<br>     return self.getFirstChildNodeByTagName(const.IMAGE)</p> 
<p>改造后xmind增加图片附件的流程</p> 
<p>MANIFEST_TEMPLATE = """<br> &lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;<br> &lt;manifest xmlns="urn:xmind:xmap:xmlns:manifest:1.0" password-hint=""&gt;<br> &lt;file-entry full-path="attachments/" media-type=""/&gt;<br> {}<br> &lt;file-entry full-path="content.xml" media-type="text/xml"/&gt;<br> &lt;file-entry full-path="META-INF/" media-type=""/&gt;<br> &lt;file-entry full-path="META-INF/manifest.xml" media-type="text/xml"/&gt;<br> &lt;file-entry full-path="comments.xml" media-type="text/xml"/&gt;<br> &lt;file-entry full-path="styles.xml" media-type="text/xml"/&gt;<br> &lt;/manifest&gt;<br> """<br> image_name = '图片名称.png'<br> image_data = b'文件byte数据'<br> height = 300<br> width = 300</p> 
<p>xmind_file_path = f"{str(uuid.uuid4())}.xmind"<br> workbook = xmind.load(path)<br> # get the first sheet(a new workbook has a blank sheet by default)<br> sheet = workbook.getPrimarySheet()<br> sheet.setTitle(tree['data']['text'])  # 设置画布名称<br> root_topic = sheet.getRootTopic()<br> root_topic.setTitle(tree['data']['text'])  # 设置主题名称<br> sub_topic = root_topic.addSubTopic() # 新增child主题<br> sub_topic.setImage(img_name, height, width) # 设置图片<br> xmind.save(workbook, path=xmind_file_path) # 先保存</p> 
<p>for img_name, img_data in image_dict.items():<br>     azip.writestr(f'attachments/{img_name}', data=img_data)  # 将图片写入attachments中<br>     manifest_img += f'&lt;file-entry full-path="attachments/{img_name}" media-type="image/{img_name.split(".")[-1]}"/&gt;'<br> azip.writestr(f'META-INF/manifest.xml', data=MANIFEST_TEMPLATE.format(manifest_img))  # 写入META-INF/manifest.xml文件<br> azip.close()</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a4a077825321ab0d8f894a91ab89e39f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java 7新特性深度解析：提升效率与功能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4361e69dd668c3afba208e5dc59b946d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在鸿蒙ArkTS中使用Three.js实现3D模型渲染</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>