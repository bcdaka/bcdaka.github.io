<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>解决uniapp微信小程序Android与iOS系统获取蓝牙广播包中deviceid不同的办法 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/4727fad4a09577a722fd17761c7a244c/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="解决uniapp微信小程序Android与iOS系统获取蓝牙广播包中deviceid不同的办法">
  <meta property="og:description" content="前言 因为小程序官方是支持接入低能蓝牙（BLE）的，所以在一个项目中也尝试使用如何接入蓝牙，我们从微信的官方网站就可以清楚知道如何使用，但是其中也是有很多坑的。本着学习的心态，自己也手把手带你摸坑，一起处理一些平台兼容性的问题以及一些逻辑判断问题
作者在开发一款共享干衣机小程序，用的是uniapp框架进行开发的，开发期间时遇到了 苹果(ios) 和 安卓(android)手机 获取到的 deviceId(mac)地址不一致问题;
1、设备绑定 在共享设备铺货到酒店等场所时，我们会让工作人员使用小程序码对共享干衣机设备进行绑定，这个目的就是为了解决，用户打开蓝牙连接时会出现N个蓝牙，用户会不知所措的问题。
绑定过程需要填写以下信息:
1、蓝牙名称：自动生成2、设备编码：扫描提前生成的小程序码（里面包含了设备编码）3、设备：选择设备就是我们选择蓝牙然后拿到deviceId(mac地址)4、代理商5、商户6、网点 2、用户使用流程 我们这个共享项目的用户使用流程是：
1、用户扫码(生成的小程序码) 里面包含设备蓝牙信息；2、弹出连接蓝牙给用户连接 (通过小程序码里的蓝牙信息里的deviceId(mac地址)过滤掉其他蓝牙,只显示用户扫码设备的蓝牙)；3、用户连接成功后 隐藏连接蓝牙按钮显示 立即使用按钮；4、用户选择使用时长(默认30分钟)；5、点击立即使用调用支付；6、支付成功后 (小程序下发开关定时指令给干衣机设备进行使用)； 3、平台差异化 因为我们使用的是uniapp框架开发所以没看到uniapp说明这个…（大坑）
后来我们从微信文档上面看到这样一段话：
看到这里我就想着，完犊子了，因为我们的手机平台有安卓和苹果，唯一标识蓝牙的就是deviceId，但是苹果搜索出来就不是这个了，而是uuid的一串字符串。因为苹果官方认为透露deviceId（MAC地址）会有安全问题，索性直接屏蔽了。
4、问题分析 开发安卓和IOS的APP中，在获取蓝牙模块的MAC地址的时候有区别。
安卓系统在蓝牙这一块，给了获取蓝牙模块MAC地址的接口，所以直接用就行，包括安卓端的微信小程序或者其他小程序。
IOS比较严谨，不允许获取蓝牙模块的MAC地址，没有给出API，所以必须要在蓝牙模块这一端做一些特别的设置。
在设备绑定时工作人员用安卓绑定的设备是唯一的，而用户使用ios搜索蓝牙时，每个用户搜索到的蓝牙设备都是uuid随机的deviceId与我们绑定deviceId的不匹配，因此也就无法在用户使用的时候过滤其他蓝牙了。
5、解决方案 方法1-特定的UUID去读取MAC地址 其实这类型的应用并不多，因为他需要建立连接之后，才能获取到mac地址，这样就不实用了
在程序开发中我们很少有采用这样的方式的 。其实实现也很简单，一说就懂
所以这个方法，暂时不推荐使用，请详细了解一下方法二。
方法2–MAC地址存放在蓝牙模块广播包里面 在广播包里面，查找蓝牙的 MAC 地址，一般良心厂商都会存放在广播包里面，所以可以获取到。
作者开发的蓝牙线路板蓝牙厂商没有写进去…，然后联系厂商重新烧录进去。
经过了九九八十一天来回邮寄线路板，厂商终于把 mac 地址写入进advertisData去了。
这里我们称之为：advertisData（当前蓝牙设备的广播数据段中的 ManufacturerData 数据段， 类型为：ArrayBuffer）。
做这个的目的，有如下原因：
1、微信小程序开发：无法直接获取蓝牙芯片的 mac 地址，没有相应的API，所以可以通过这个获取到，具体网上可以搜一下
2、APP 开发–IOS 端，也没办法直接获取 MAC 地址，也是通过这个方式得到蓝牙芯片的 MAC 地址
3、APP 开发–安卓端，没有这个问题，直接通过 API 时可以获取到蓝牙芯片的 mac 地址的。所以用不用这个功能，都无所谓
实现代码：
// 初始化蓝牙模块 uni.openBluetoothAdapter({ success(res) { // 开始搜寻附近的蓝牙外围设备 uni.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-13T08:45:56+08:00">
    <meta property="article:modified_time" content="2024-06-13T08:45:56+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">解决uniapp微信小程序Android与iOS系统获取蓝牙广播包中deviceid不同的办法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_0"></a>前言</h4> 
<p>因为小程序官方是支持接入低能蓝牙（BLE）的，所以在一个项目中也尝试使用如何接入蓝牙，我们从微信的官方网站就可以清楚知道如何使用，但是其中也是有很多坑的。本着学习的心态，自己也手把手带你摸坑，一起处理一些平台兼容性的问题以及一些逻辑判断问题</p> 
<p>作者在开发一款共享干衣机小程序，用的是<code>uniapp</code>框架进行开发的，开发期间时遇到了 苹果(ios) 和 安卓(android)手机 获取到的 <code>deviceId(mac)</code>地址不一致问题;</p> 
<h4><a id="1_6"></a>1、设备绑定</h4> 
<p>在共享设备铺货到酒店等场所时，我们会让工作人员使用小程序码对共享干衣机设备进行绑定，这个目的就是为了解决，用户打开蓝牙连接时会出现N个蓝牙，用户会不知所措的问题。</p> 
<p><strong>绑定过程需要填写以下信息:</strong></p> 
<p><img src="https://images2.imgbox.com/92/33/zvXr6hsJ_o.png" alt="在这里插入图片描述"></p> 
<ul><li>1、蓝牙名称：自动生成</li><li>2、设备编码：扫描提前生成的小程序码（里面包含了设备编码）</li><li>3、设备：选择设备就是我们选择蓝牙然后拿到<code>deviceId(mac地址)</code></li><li>4、代理商</li><li>5、商户</li><li>6、网点</li></ul> 
<h4><a id="2_22"></a>2、用户使用流程</h4> 
<p><strong>我们这个共享项目的用户使用流程是：</strong></p> 
<ul><li>1、用户扫码(生成的小程序码) 里面包含设备蓝牙信息；</li><li>2、弹出连接蓝牙给用户连接 (通过小程序码里的蓝牙信息里的<code>deviceId(mac地址)</code>过滤掉其他蓝牙,只显示用户扫码设备的蓝牙)；</li><li>3、用户连接成功后 隐藏连接蓝牙按钮显示 立即使用按钮；</li><li>4、用户选择使用时长(默认30分钟)；</li><li>5、点击立即使用调用支付；</li><li>6、支付成功后 (小程序下发开关定时指令给干衣机设备进行使用)；</li></ul> 
<h4><a id="3_34"></a>3、平台差异化</h4> 
<p>因为我们使用的是<code>uniapp</code>框架开发所以没看到<code>uniapp</code>说明这个…（大坑）<br> 后来我们从微信文档上面看到这样一段话：</p> 
<p><img src="https://images2.imgbox.com/6b/a9/U40yrYq3_o.png" alt="在这里插入图片描述"></p> 
<p>看到这里我就想着，完犊子了，因为我们的手机平台有安卓和苹果，唯一标识蓝牙的就是<code>deviceId</code>，但是苹果搜索出来就不是这个了，而是<code>uuid</code>的一串字符串。因为苹果官方认为透露<code>deviceId（MAC地址）</code>会有安全问题，索性直接屏蔽了。</p> 
<h4><a id="4_44"></a>4、问题分析</h4> 
<p>开发安卓和IOS的APP中，在获取蓝牙模块的MAC地址的时候有区别。<br> 安卓系统在蓝牙这一块，给了获取蓝牙模块MAC地址的接口，所以直接用就行，包括安卓端的微信小程序或者其他小程序。<br> IOS比较严谨，不允许获取蓝牙模块的MAC地址，没有给出API，所以必须要在蓝牙模块这一端做一些特别的设置。</p> 
<p>在设备绑定时工作人员用安卓绑定的设备是唯一的，而用户使用ios搜索蓝牙时，每个用户搜索到的蓝牙设备都是<code>uuid</code>随机的<code>deviceId</code>与我们绑定<code>deviceId</code>的不匹配，因此也就无法在用户使用的时候过滤其他蓝牙了。</p> 
<h4><a id="5_53"></a>5、解决方案</h4> 
<h5><a id="1UUIDMAC_55"></a>方法1-特定的UUID去读取MAC地址</h5> 
<p>其实这类型的应用并不多，因为他需要建立连接之后，才能获取到mac地址，这样就不实用了</p> 
<p>在程序开发中我们很少有采用这样的方式的 。其实实现也很简单，一说就懂</p> 
<p>所以这个方法，暂时不推荐使用，请详细了解一下方法二。</p> 
<h5><a id="2MAC_63"></a>方法2–MAC地址存放在蓝牙模块广播包里面</h5> 
<p>在广播包里面，查找蓝牙的 MAC 地址，一般良心厂商都会存放在广播包里面，所以可以获取到。<br> 作者开发的蓝牙线路板蓝牙厂商没有写进去…，然后联系厂商重新烧录进去。</p> 
<p><img src="https://images2.imgbox.com/a3/df/06r8dNaR_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ab/14/maCSQPep_o.png" alt="在这里插入图片描述"></p> 
<p>经过了九九八十一天来回邮寄线路板，厂商终于把 mac 地址写入进<code>advertisData</code>去了。</p> 
<p><img src="https://images2.imgbox.com/d5/14/Abt0lAzE_o.jpg" alt="在这里插入图片描述"></p> 
<p>这里我们称之为：<code>advertisData（当前蓝牙设备的广播数据段中的 ManufacturerData 数据段， 类型为：ArrayBuffer）</code>。</p> 
<p><strong>做这个的目的，有如下原因：</strong></p> 
<ul><li> <p>1、微信小程序开发：无法直接获取蓝牙芯片的 mac 地址，没有相应的API，所以可以通过这个获取到，具体网上可以搜一下</p> </li><li> <p>2、APP 开发–IOS 端，也没办法直接获取 MAC 地址，也是通过这个方式得到蓝牙芯片的 MAC 地址</p> </li><li> <p>3、APP 开发–安卓端，没有这个问题，直接通过 API 时可以获取到蓝牙芯片的 mac 地址的。所以用不用这个功能，都无所谓</p> </li></ul> 
<p>实现代码：</p> 
<pre><code class="prism language-js"><span class="token comment">// 初始化蓝牙模块</span>
uni<span class="token punctuation">.</span><span class="token function">openBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 开始搜寻附近的蓝牙外围设备</span>
    uni<span class="token punctuation">.</span><span class="token function">startBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 监听寻找到新设备的事件</span>
       uni<span class="token punctuation">.</span><span class="token function">onBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">devices</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">ab2hex</span><span class="token punctuation">(</span>devices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>advertisData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 获取到 mac 地址</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// ArrayBuffer转16进度字符串示例</span>
<span class="token keyword">function</span> <span class="token function">ab2hex</span><span class="token punctuation">(</span><span class="token parameter">buffer</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> hexArr <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">bit</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string">'00'</span> <span class="token operator">+</span> bit<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">return</span> hexArr<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>至此成功，我们拿到了蓝牙的<code>mac地址</code>，然后就可以进行后续操作了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1d2a47893d8baa2f1d8b2df352ff7503/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【中间件】Pulsar集群安装</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c471428da0fa41fa1439189212abbe51/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java一分钟之-GraalVM Native Image：构建原生可执行文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>