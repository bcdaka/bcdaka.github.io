<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>向量数据库之Lancedb学习记录 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/82fbd862e2c101c8649ea8af447541e5/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="向量数据库之Lancedb学习记录">
  <meta property="og:description" content="简介 Lancedb是一个用于人工智能的开源矢量数据库，旨在存储、管理、查询和检索大规模多模式数据的嵌入。Lancedb的核心是用Rust编写的，并构建在Lance之上，专为高性能 ML 工作负载和快速随机访问而设计。
快速开始 安装 pip install lancedb 目前0.6.8需要pyarrow-12.0.0及以上，亲测15.0会报错。
创建客户端 import lancedb import pandas as pd import pyarrow as pa uri = &#34;data/sample-lancedb&#34; db = lancedb.connect(uri) # 异步客户端 #async_db = await lancedb.connect_async(uri) 与Chroma不同，lancedb没有服务端-客户端模式。支持同步和异步客户端，看起来异步客户端更新较快，从官方文档来看没发现使用上的区别。
创建一张表 data = [ {&#34;vector&#34;: [3.1, 4.1], &#34;item&#34;: &#34;foo&#34;, &#34;price&#34;: 10.0}, {&#34;vector&#34;: [5.9, 26.5], &#34;item&#34;: &#34;bar&#34;, &#34;price&#34;: 20.0}, ] tbl = db.create_table(&#34;my_table&#34;, data=data) 如果表名已经存在，则会报错。如果希望覆盖已经创建的同名表，可以添加mode=&#39;overwrite’参数。
tbl = db.create_table(&#34;my_table&#34;, data=data, mode=&#39;overwrite&#39;) 如果不希望覆盖已经创建的同名表，而直接打开的话，可以添加exist_ok=True参数。
tbl = db.create_table(&#34;my_table&#34;, data=data, exist_ok=True) 创建一张空表 schema = pa.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-15T19:25:39+08:00">
    <meta property="article:modified_time" content="2024-04-15T19:25:39+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">向量数据库之Lancedb学习记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>简介</h2> 
<p>Lancedb是一个用于人工智能的开源矢量数据库，旨在存储、管理、查询和检索大规模多模式数据的嵌入。Lancedb的核心是用Rust编写的，并构建在Lance之上，专为高性能 ML 工作负载和快速随机访问而设计。</p> 
<h2><a id="_3"></a>快速开始</h2> 
<h3><a id="_4"></a>安装</h3> 
<pre><code class="prism language-shell">pip <span class="token function">install</span> lancedb
</code></pre> 
<p>目前0.6.8需要pyarrow-12.0.0及以上，亲测15.0会报错。</p> 
<h3><a id="_11"></a>创建客户端</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> lancedb
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> pyarrow <span class="token keyword">as</span> pa

uri <span class="token operator">=</span> <span class="token string">"data/sample-lancedb"</span>
db <span class="token operator">=</span> lancedb<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>uri<span class="token punctuation">)</span>   
<span class="token comment"># 异步客户端</span>
<span class="token comment">#async_db = await lancedb.connect_async(uri)    </span>
</code></pre> 
<p>与Chroma不同，lancedb没有服务端-客户端模式。支持同步和异步客户端，看起来异步客户端更新较快，从官方文档来看没发现使用上的区别。</p> 
<h3><a id="_24"></a>创建一张表</h3> 
<pre><code class="prism language-python">data <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"vector"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3.1</span><span class="token punctuation">,</span> <span class="token number">4.1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"item"</span><span class="token punctuation">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">10.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"vector"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">5.9</span><span class="token punctuation">,</span> <span class="token number">26.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"item"</span><span class="token punctuation">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">20.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

tbl <span class="token operator">=</span> db<span class="token punctuation">.</span>create_table<span class="token punctuation">(</span><span class="token string">"my_table"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span> 
</code></pre> 
<p>如果表名已经存在，则会报错。如果希望覆盖已经创建的同名表，可以添加mode='overwrite’参数。</p> 
<pre><code class="prism language-python">tbl <span class="token operator">=</span> db<span class="token punctuation">.</span>create_table<span class="token punctuation">(</span><span class="token string">"my_table"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">'overwrite'</span><span class="token punctuation">)</span> 
</code></pre> 
<p>如果不希望覆盖已经创建的同名表，而直接打开的话，可以添加exist_ok=True参数。</p> 
<pre><code class="prism language-python">tbl <span class="token operator">=</span> db<span class="token punctuation">.</span>create_table<span class="token punctuation">(</span><span class="token string">"my_table"</span><span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> 
</code></pre> 
<h3><a id="_43"></a>创建一张空表</h3> 
<pre><code class="prism language-python">schema <span class="token operator">=</span> pa<span class="token punctuation">.</span>schema<span class="token punctuation">(</span><span class="token punctuation">[</span>pa<span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">"vector"</span><span class="token punctuation">,</span> pa<span class="token punctuation">.</span>list_<span class="token punctuation">(</span>pa<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> list_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
tbl <span class="token operator">=</span> db<span class="token punctuation">.</span>create_table<span class="token punctuation">(</span><span class="token string">"empty_table"</span><span class="token punctuation">,</span> schema<span class="token operator">=</span>schema<span class="token punctuation">)</span>
</code></pre> 
<p>类似SQL语法，先创建一张空表，插入数据可以放到后面进行。</p> 
<h3><a id="_50"></a>添加数据</h3> 
<pre><code class="prism language-python"><span class="token comment"># 直接添加数据</span>
data <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"vector"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1.3</span><span class="token punctuation">,</span> <span class="token number">1.4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"item"</span><span class="token punctuation">:</span> <span class="token string">"fizz"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">100.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"vector"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">9.5</span><span class="token punctuation">,</span> <span class="token number">56.2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"item"</span><span class="token punctuation">:</span> <span class="token string">"buzz"</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">200.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
tbl<span class="token punctuation">.</span>add<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token comment"># 添加df数据帧</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
tbl<span class="token punctuation">.</span>add<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_65"></a>查找数据</h3> 
<pre><code class="prism language-python"><span class="token comment"># Synchronous client</span>
tbl<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_pandas<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>通过向量来查找相似的向量。默认情况下没有对向量创建索引，因此是全表暴力检索。官方推荐数据量超过50万以上才需要创建索引，否则全表暴力检索的延迟也在可以接受的范围之内。（明明就是没实现，还说的冠冕堂皇。。）</p> 
<h3><a id="_73"></a>删除数据</h3> 
<pre><code class="prism language-python">tbl<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token string">'item = "fizz"'</span><span class="token punctuation">)</span>
</code></pre> 
<p>类似SQL语法中的WHERE声明，需要指定字段和对应的值。</p> 
<h3><a id="_80"></a>修改数据</h3> 
<pre><code class="prism language-python">table<span class="token punctuation">.</span>update<span class="token punctuation">(</span>where<span class="token operator">=</span><span class="token string">'item = "fizz"'</span><span class="token punctuation">,</span> values<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"vector"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>类似SQL语法中的UPDATE声明，需要指定字段和对应的值。</p> 
<h3><a id="_88"></a>删除表</h3> 
<pre><code class="prism language-python">db<span class="token punctuation">.</span>drop_table<span class="token punctuation">(</span><span class="token string">"my_table"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_93"></a>查看所有表</h3> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>table_names<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
tbl <span class="token operator">=</span> db<span class="token punctuation">.</span>open_table<span class="token punctuation">(</span><span class="token string">"my_table"</span><span class="token punctuation">)</span>    
</code></pre> 
<p>table_names可以返回该数据库中已经创建的所有表，使用open_table可以打开对应的表。</p> 
<h2><a id="_101"></a>高级用法</h2> 
<h3><a id="_102"></a>数据类型</h3> 
<h4><a id="_103"></a>多种数据类型</h4> 
<p>除了直接添加数据和添加df数据帧之外，lancedb还支持用pyarrow创建schema和添加数据。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pyarrow <span class="token keyword">as</span> pa
schema <span class="token operator">=</span> pa<span class="token punctuation">.</span>schema<span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
        pa<span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">"vector"</span><span class="token punctuation">,</span> pa<span class="token punctuation">.</span>list_<span class="token punctuation">(</span>pa<span class="token punctuation">.</span>float16<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        pa<span class="token punctuation">.</span>field<span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> pa<span class="token punctuation">.</span>string<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>   
</code></pre> 
<p>lancedb直接float16数据类型，这就比chromadb有存储优势了。</p> 
<h4><a id="_116"></a>自定义数据类型</h4> 
<pre><code class="prism language-python"><span class="token keyword">from</span> lancedb<span class="token punctuation">.</span>pydantic <span class="token keyword">import</span> Vector<span class="token punctuation">,</span> LanceModel

<span class="token keyword">class</span> <span class="token class-name">Content</span><span class="token punctuation">(</span>LanceModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    movie_id<span class="token punctuation">:</span> <span class="token builtin">int</span>
    vector<span class="token punctuation">:</span> Vector<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span>
    genres<span class="token punctuation">:</span> <span class="token builtin">str</span>
    title<span class="token punctuation">:</span> <span class="token builtin">str</span>
    imdb_id<span class="token punctuation">:</span> <span class="token builtin">int</span>

    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">imdb_url</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"https://www.imdb.com/title/tt</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>imdb_id<span class="token punctuation">}</span></span><span class="token string">"</span></span>   
</code></pre> 
<p>LanceModel是pydantic.BaseModel的子类，主要就是实现了Vector数据类型的定义，避免手动创建schema中vector的定义，只需要指定维度即可。</p> 
<h4><a id="_133"></a>复合数据类型</h4> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Document</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    content<span class="token punctuation">:</span> <span class="token builtin">str</span>
    source<span class="token punctuation">:</span> <span class="token builtin">str</span>
    
<span class="token keyword">class</span> <span class="token class-name">NestedSchema</span><span class="token punctuation">(</span>LanceModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">str</span>
    vector<span class="token punctuation">:</span> Vector<span class="token punctuation">(</span><span class="token number">1536</span><span class="token punctuation">)</span>
    document<span class="token punctuation">:</span> Document

tbl <span class="token operator">=</span> db<span class="token punctuation">.</span>create_table<span class="token punctuation">(</span><span class="token string">"nested_table"</span><span class="token punctuation">,</span> schema<span class="token operator">=</span>NestedSchema<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"overwrite"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_146"></a>索引</h3> 
<h4><a id="IVF_PQ_147"></a>创建IVF_PQ索引</h4> 
<pre><code class="prism language-python">tbl<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span>num_partitions<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_sub_vectors<span class="token operator">=</span><span class="token number">96</span><span class="token punctuation">)</span>
</code></pre> 
<p>lancedb支持创建倒排索引的乘积量化。num_partitions是索引中的分区数，默认值是行数的平方根。num_sub_vectors是子向量的数量，默认值是向量的维度除以16。</p> 
<h4><a id="GPU_153"></a>使用GPU创建</h4> 
<pre><code class="prism language-python">accelerator<span class="token operator">=</span><span class="token string">"cuda"</span>
<span class="token comment"># accelerator="mps"</span>
</code></pre> 
<p>支持CUDA的GPU或者Apple的MPS加速</p> 
<h4><a id="_160"></a>使用索引加速近似查找</h4> 
<pre><code class="prism language-python">tbl<span class="token punctuation">.</span>search<span class="token punctuation">(</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1536</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
<span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> \
<span class="token punctuation">.</span>nprobes<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> \
<span class="token punctuation">.</span>refine_factor<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> \
<span class="token punctuation">.</span>to_pandas<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>nprobes是探针数量，默认为20，增加探针数量则会提高查找的精度并相应增加计算耗时。refine_factor是一个粗召的数量，用于读取额外元素并重新排列，以此来提高召回。</p> 
<h3><a id="_171"></a>向量化模型</h3> 
<h4><a id="_173"></a>内置向量模型</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> lancedb
<span class="token keyword">from</span> lancedb<span class="token punctuation">.</span>pydantic <span class="token keyword">import</span> LanceModel<span class="token punctuation">,</span> Vector
<span class="token keyword">from</span> lancedb<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> get_registry

model <span class="token operator">=</span> get_registry<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"sentence-transformers"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"BAAI/bge-small-en-v1.5"</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">"cpu"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Words</span><span class="token punctuation">(</span>LanceModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    text<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> model<span class="token punctuation">.</span>SourceField<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 指定这个字段为需要模型进行向量化的字段</span>
    vector<span class="token punctuation">:</span> Vector<span class="token punctuation">(</span>model<span class="token punctuation">.</span>ndims<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> model<span class="token punctuation">.</span>VectorField<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 指定这个字段为模型向量化的结果</span>

table <span class="token operator">=</span> db<span class="token punctuation">.</span>create_table<span class="token punctuation">(</span><span class="token string">"words"</span><span class="token punctuation">,</span> schema<span class="token operator">=</span>Words<span class="token punctuation">)</span>
table<span class="token punctuation">.</span>add<span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"hello world"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"goodbye world"</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

query <span class="token operator">=</span> <span class="token string">"greetings"</span>
actual <span class="token operator">=</span> table<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_pydantic<span class="token punctuation">(</span>Words<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>actual<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
</code></pre> 
<p>官方支持了多种sentence-transformers的向量化模型。用上述方法调用内置模型需要指定模型的SourceField和VectorField。</p> 
<h4><a id="_200"></a>自定义向量模型</h4> 
<pre><code class="prism language-python"><span class="token keyword">from</span> lancedb<span class="token punctuation">.</span>embeddings <span class="token keyword">import</span> register
<span class="token keyword">from</span> lancedb<span class="token punctuation">.</span>util <span class="token keyword">import</span> attempt_import_or_raise

<span class="token decorator annotation punctuation">@register</span><span class="token punctuation">(</span><span class="token string">"sentence-transformers"</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">SentenceTransformerEmbeddings</span><span class="token punctuation">(</span>TextEmbeddingFunction<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"all-MiniLM-L6-v2"</span>
    <span class="token comment"># set more default instance vars like device, etc.</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_ndims <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">generate_embeddings</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> texts<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_embedding_model<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>texts<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">ndims</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_ndims <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_ndims <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>generate_embeddings<span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_ndims

    <span class="token decorator annotation punctuation">@cached</span><span class="token punctuation">(</span>cache<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
    <span class="token keyword">def</span> <span class="token function">_embedding_model</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> sentence_transformers<span class="token punctuation">.</span>SentenceTransformer<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">from</span> lancedb<span class="token punctuation">.</span>pydantic <span class="token keyword">import</span> LanceModel<span class="token punctuation">,</span> Vector

registry <span class="token operator">=</span> EmbeddingFunctionRegistry<span class="token punctuation">.</span>get_instance<span class="token punctuation">(</span><span class="token punctuation">)</span>
stransformer <span class="token operator">=</span> registry<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"sentence-transformers"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">TextModelSchema</span><span class="token punctuation">(</span>LanceModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    vector<span class="token punctuation">:</span> Vector<span class="token punctuation">(</span>stransformer<span class="token punctuation">.</span>ndims<span class="token punctuation">)</span> <span class="token operator">=</span> stransformer<span class="token punctuation">.</span>VectorField<span class="token punctuation">(</span><span class="token punctuation">)</span>
    text<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> stransformer<span class="token punctuation">.</span>SourceField<span class="token punctuation">(</span><span class="token punctuation">)</span>

tbl <span class="token operator">=</span> db<span class="token punctuation">.</span>create_table<span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">,</span> schema<span class="token operator">=</span>TextModelSchema<span class="token punctuation">)</span>

tbl<span class="token punctuation">.</span>add<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"halo"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
result <span class="token operator">=</span> tbl<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>官方提供了模板用于自定义模型，但是我觉得直接调用模型进行向量化表示更直接吧，这样感觉有点追求格式化的统一了。</p> 
<h2><a id="_244"></a>总结</h2> 
<p>与Chromadb对比，没有服务端模式，全部在客户端完成，虽然官方声称有云原生的版本，但感觉大部分场景下可能都不需要放在云上，感觉这一款产品会更加轻量化。<br> 此外，创建表的时候没有默认的向量化模型，感觉对开发者可能更加灵活一些，相比之下Chromadb默认会从HuggingFace下载模型，对于内网环境不太友好。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2a0e48673d6c262fab9e5fe23c3f9c2d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python 基于列表实现的通讯录管理系统(有完整源码)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fd4b2bc01dcc78be9789257d7d7ffd3f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在Debian 12系统上安装Docker</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>