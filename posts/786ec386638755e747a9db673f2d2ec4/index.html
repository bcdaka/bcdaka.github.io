<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>开源TinyFSM状态机适用于嵌入式工业平台吗？ - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/786ec386638755e747a9db673f2d2ec4/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="开源TinyFSM状态机适用于嵌入式工业平台吗？">
  <meta property="og:description" content="文章目录 引言基于传统 C&#43;&#43; 实现的状态机TinyFSM 实现的对比现代 C&#43;&#43; 实现的状态机性能对比TinyFSM 性能测试传统 C&#43;&#43; 性能测试现代 C&#43;&#43; 性能测试 工业Misra C&#43;&#43;编程标准TinyFSM 的优缺点分析结论 引言 TinyFSM是一个为C&#43;&#43;设计的轻量级有限状态机开源库库。
在嵌入式系统开发中，TinyFSM等状态机适用于控制系统和通信协议等场景，然而，开发者也需考虑该库的性能并考虑是否遵循工业C&#43;&#43;标准。
传统 C&#43;&#43; 实现不仅能很容易的满足工业标准的要求，还能提供更高的性能和更低的内存开销。
现代 C&#43;&#43; 实现虽然引入了许多新特性，可以简化代码结构，但在性能上可能不如传统 C&#43;&#43; 实现高效。
反而TinyFSM本身很多地方设计不满足工业C&#43;&#43;标准。
基于传统 C&#43;&#43; 实现的状态机 在嵌入式系统中，传统 C&#43;&#43; 实现的状态机通过显式管理状态变量和使用 switch 语句处理事件，可以有效控制内存和运行时开销，同时确保代码符合 MISRA C&#43;&#43; 规范。以下是一个简单的门状态机示例：
#include &lt;iostream&gt; enum class DoorState { Closed, Open, Locked }; class DoorStateMachine { public: DoorStateMachine() : state(DoorState::Closed) {} void open() { switch (state) { case DoorState::Closed: std::cout &lt;&lt; &#34;Door is opened\n&#34;; state = DoorState::Open; break; case DoorState::Open: std::cout &lt;&lt; &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-18T08:04:29+08:00">
    <meta property="article:modified_time" content="2024-06-18T08:04:29+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">开源TinyFSM状态机适用于嵌入式工业平台吗？</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_2" rel="nofollow">引言</a></li><li><a href="#_C__9" rel="nofollow">基于传统 C++ 实现的状态机</a></li><li><a href="#TinyFSM__83" rel="nofollow">TinyFSM 实现的对比</a></li><li><a href="#_C__146" rel="nofollow">现代 C++ 实现的状态机</a></li><li><a href="#_212" rel="nofollow">性能对比</a></li><li><ul><li><a href="#TinyFSM__224" rel="nofollow">TinyFSM 性能测试</a></li><li><a href="#_C__287" rel="nofollow">传统 C++ 性能测试</a></li><li><a href="#_C__345" rel="nofollow">现代 C++ 性能测试</a></li></ul> 
   </li><li><a href="#Misra_C_397" rel="nofollow">工业Misra C++编程标准</a></li><li><a href="#TinyFSM__405" rel="nofollow">TinyFSM 的优缺点分析</a></li><li><a href="#_418" rel="nofollow">结论</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_2"></a>引言</h3> 
<p><a href="https://github.com/digint/tinyfsm">TinyFSM</a>是一个为C++设计的轻量级有限状态机开源库库。<br> 在嵌入式系统开发中，TinyFSM等状态机适用于控制系统和通信协议等场景，然而，开发者也需考虑该库的性能并考虑是否遵循工业C++标准。<br> 传统 C++ 实现不仅能很容易的满足工业标准的要求，还能提供更高的性能和更低的内存开销。<br> 现代 C++ 实现虽然引入了许多新特性，可以简化代码结构，但在性能上可能不如传统 C++ 实现高效。<br> 反而TinyFSM本身很多地方设计不满足工业C++标准。</p> 
<h3><a id="_C__9"></a>基于传统 C++ 实现的状态机</h3> 
<p>在嵌入式系统中，传统 C++ 实现的状态机通过显式管理状态变量和使用 <code>switch</code> 语句处理事件，可以有效控制内存和运行时开销，同时确保代码符合 MISRA C++ 规范。以下是一个简单的门状态机示例：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">DoorState</span> <span class="token punctuation">{<!-- --></span> Closed<span class="token punctuation">,</span> Open<span class="token punctuation">,</span> Locked <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">DoorStateMachine</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">DoorStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">state</span><span class="token punctuation">(</span>DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is opened\n"</span><span class="token punctuation">;</span>
        state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Open<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Open<span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is already open\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Locked<span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Cannot open, door is locked\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is already closed\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Open<span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is closed\n"</span><span class="token punctuation">;</span>
        state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Locked<span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Cannot close, door is locked\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is locked\n"</span><span class="token punctuation">;</span>
        state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Locked<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Open<span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Cannot lock, door is open\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Locked<span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is already locked\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
  DoorState state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  DoorStateMachine door<span class="token punctuation">;</span>

  door<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  door<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  door<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  door<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="TinyFSM__83"></a>TinyFSM 实现的对比</h3> 
<p>TinyFSM 是一个轻量级状态机库，通过继承 <code>tinyfsm::Fsm</code> 和定义状态类，能够直观地定义状态和事件处理函数。以下是使用 TinyFSM 实现的门状态机代码：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tinyfsm.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">OpenEvent</span> <span class="token operator">:</span> <span class="token base-clause">tinyfsm<span class="token double-colon punctuation">::</span><span class="token class-name">Event</span></span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">CloseEvent</span> <span class="token operator">:</span> <span class="token base-clause">tinyfsm<span class="token double-colon punctuation">::</span><span class="token class-name">Event</span></span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">LockEvent</span> <span class="token operator">:</span> <span class="token base-clause">tinyfsm<span class="token double-colon punctuation">::</span><span class="token class-name">Event</span></span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">DoorState</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> tinyfsm<span class="token double-colon punctuation">::</span><span class="token class-name">Fsm</span><span class="token operator">&lt;</span><span class="token class-name">DoorState</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>OpenEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid transition\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>CloseEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid transition\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>LockEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid transition\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Closed</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">DoorState</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>OpenEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is opened\n"</span><span class="token punctuation">;</span>
    <span class="token generic-function"><span class="token function">transit</span><span class="token generic class-name"><span class="token operator">&lt;</span>Open<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>LockEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is locked\n"</span><span class="token punctuation">;</span>
    <span class="token generic-function"><span class="token function">transit</span><span class="token generic class-name"><span class="token operator">&lt;</span>Locked<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Open</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">DoorState</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>CloseEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is closed\n"</span><span class="token punctuation">;</span>
    <span class="token generic-function"><span class="token function">transit</span><span class="token generic class-name"><span class="token operator">&lt;</span>Closed<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Locked</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">DoorState</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>OpenEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Cannot open, door is locked\n"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">FSM_INITIAL_STATE</span><span class="token punctuation">(</span>DoorState<span class="token punctuation">,</span> Closed<span class="token punctuation">)</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">DoorState</span><span class="token double-colon punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">DoorState</span><span class="token double-colon punctuation">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">OpenEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">DoorState</span><span class="token double-colon punctuation">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">CloseEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">DoorState</span><span class="token double-colon punctuation">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">LockEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">DoorState</span><span class="token double-colon punctuation">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">OpenEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_C__146"></a>现代 C++ 实现的状态机</h3> 
<p>现代 C++（如 C++14 和 C++17）引入了许多新特性，使得开发高效、可维护的代码更加容易。在状态机实现中，现代 C++ 特性如 <code>std::function</code> 和 <code>std::unordered_map</code> 可以显著简化代码结构。以下是一个基于现代 C++ 实现的状态机示例：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unordered_map&gt;</span></span>

<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">DoorState</span> <span class="token punctuation">{<!-- --></span> Closed<span class="token punctuation">,</span> Open<span class="token punctuation">,</span> Locked <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">DoorEvent</span> <span class="token punctuation">{<!-- --></span> OpenEvent<span class="token punctuation">,</span> CloseEvent<span class="token punctuation">,</span> LockEvent <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">DoorStateMachine</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">DoorStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">state</span><span class="token punctuation">(</span>DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    stateHandlers<span class="token punctuation">[</span>DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">]</span><span class="token punctuation">[</span>DoorEvent<span class="token double-colon punctuation">::</span>OpenEvent<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">handleOpenFromClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    stateHandlers<span class="token punctuation">[</span>DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">]</span><span class="token punctuation">[</span>DoorEvent<span class="token double-colon punctuation">::</span>LockEvent<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">handleLockFromClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    stateHandlers<span class="token punctuation">[</span>DoorState<span class="token double-colon punctuation">::</span>Open<span class="token punctuation">]</span><span class="token punctuation">[</span>DoorEvent<span class="token double-colon punctuation">::</span>CloseEvent<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">handleCloseFromOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    stateHandlers<span class="token punctuation">[</span>DoorState<span class="token double-colon punctuation">::</span>Locked<span class="token punctuation">]</span><span class="token punctuation">[</span>DoorEvent<span class="token double-colon punctuation">::</span>OpenEvent<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">handleOpenFromLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> eventHandler <span class="token operator">=</span> stateHandlers<span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler <span class="token operator">!=</span> stateHandlers<span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      eventHandler<span class="token operator">-&gt;</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Invalid event\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">handleOpenFromClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is opened\n"</span><span class="token punctuation">;</span>
    state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Open<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">handleLockFromClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is locked\n"</span><span class="token punctuation">;</span>
    state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Locked<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">handleCloseFromOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Door is closed\n"</span><span class="token punctuation">;</span>
    state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">handleOpenFromLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Cannot open, door is locked\n"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  DoorState state<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>DoorState<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>DoorEvent<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stateHandlers<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  DoorStateMachine door<span class="token punctuation">;</span>

  door<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent<span class="token double-colon punctuation">::</span>OpenEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  door<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent<span class="token double-colon punctuation">::</span>CloseEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  door<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent<span class="token double-colon punctuation">::</span>LockEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  door<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent<span class="token double-colon punctuation">::</span>OpenEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_212"></a>性能对比</h3> 
<ul><li> <p>以下在树莓派5上测试，基本信息如下</p> <pre><code>CPU：2.4GHz 四核 64位 Arm Cortex-A76
内存：32位 LPDDR4X SDRAM，4267MT/s
</code></pre> </li><li> <p>使用了benchmark多次深度压测。</p> </li><li> <p>平均数据分别为：</p> <p>TinyFSM 传统C++ 现代C++<br> 5.91 ns 1.25 ns 413 ns</p> </li></ul> 
<h4><a id="TinyFSM__224"></a>TinyFSM 性能测试</h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;benchmark/benchmark.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;tinyfsm.hpp&gt;</span></span>

<span class="token comment">// 事件定义</span>
<span class="token keyword">struct</span> <span class="token class-name">OpenEvent</span> <span class="token operator">:</span> <span class="token base-clause">tinyfsm<span class="token double-colon punctuation">::</span><span class="token class-name">Event</span></span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">CloseEvent</span> <span class="token operator">:</span> <span class="token base-clause">tinyfsm<span class="token double-colon punctuation">::</span><span class="token class-name">Event</span></span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">LockEvent</span> <span class="token operator">:</span> <span class="token base-clause">tinyfsm<span class="token double-colon punctuation">::</span><span class="token class-name">Event</span></span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 状态机基类</span>
<span class="token keyword">class</span> <span class="token class-name">DoorState</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> tinyfsm<span class="token double-colon punctuation">::</span><span class="token class-name">Fsm</span><span class="token operator">&lt;</span><span class="token class-name">DoorState</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>OpenEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>CloseEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>LockEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义具体状态类</span>
<span class="token keyword">class</span> <span class="token class-name">Closed</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">DoorState</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>OpenEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span> <span class="token generic-function"><span class="token function">transit</span><span class="token generic class-name"><span class="token operator">&lt;</span>Open<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>LockEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span> <span class="token generic-function"><span class="token function">transit</span><span class="token generic class-name"><span class="token operator">&lt;</span>Locked<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Open</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">DoorState</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>CloseEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span> <span class="token generic-function"><span class="token function">transit</span><span class="token generic class-name"><span class="token operator">&lt;</span>Closed<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Locked</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">DoorState</span></span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">react</span><span class="token punctuation">(</span>OpenEvent <span class="token keyword">const</span> <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">FSM_INITIAL_STATE</span><span class="token punctuation">(</span>DoorState<span class="token punctuation">,</span> Closed<span class="token punctuation">)</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">BM_TinyFSM</span><span class="token punctuation">(</span>benchmark<span class="token double-colon punctuation">::</span>State <span class="token operator">&amp;</span>state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> _ <span class="token operator">:</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">DoorState</span><span class="token double-colon punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DoorState</span><span class="token double-colon punctuation">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">OpenEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DoorState</span><span class="token double-colon punctuation">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">CloseEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DoorState</span><span class="token double-colon punctuation">::</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">LockEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">BENCHMARK</span><span class="token punctuation">(</span>BM_TinyFSM<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">BENCHMARK_MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>测试结果</p> 
<p>：</p> 
<pre><code>Benchmark           Time             CPU   Iterations
-----------------------------------------------------
BM_TinyFSM       5.91 ns         5.91 ns    116692670
</code></pre> 
<h4><a id="_C__287"></a>传统 C++ 性能测试</h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;benchmark/benchmark.h&gt;</span></span>

<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">DoorState</span> <span class="token punctuation">{<!-- --></span> Closed<span class="token punctuation">,</span> Open<span class="token punctuation">,</span> Locked <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">DoorEvent</span> <span class="token punctuation">{<!-- --></span> OpenEvent<span class="token punctuation">,</span> CloseEvent<span class="token punctuation">,</span> LockEvent <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">DoorStateMachine</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">DoorStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">state</span><span class="token punctuation">(</span>DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> DoorEvent<span class="token double-colon punctuation">::</span>OpenEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Open<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> DoorEvent<span class="token double-colon punctuation">::</span>LockEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Locked<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Open<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> DoorEvent<span class="token double-colon punctuation">::</span>CloseEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> DoorState<span class="token double-colon punctuation">::</span>Locked<span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  DoorState state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">BM_TraditionalCPPStateMachine</span><span class="token punctuation">(</span>benchmark<span class="token double-colon punctuation">::</span>State<span class="token operator">&amp;</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  DoorStateMachine door<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> _ <span class="token operator">:</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    benchmark<span class="token double-colon punctuation">::</span><span class="token function">DoNotOptimize</span><span class="token punctuation">(</span>door<span class="token punctuation">)</span><span class="token punctuation">;</span>
    door<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent<span class="token double-colon punctuation">::</span>OpenEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    door<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent<span class="token double-colon punctuation">::</span>CloseEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    door<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent<span class="token double-colon punctuation">::</span>LockEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">BENCHMARK</span><span class="token punctuation">(</span>BM_TraditionalCPPStateMachine<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">BENCHMARK_MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>测试结果：</p> 
<pre><code>Benchmark                         Time             CPU   Iterations
-------------------------------------------------------------------
BM_TraditionalCPPStateMachine       1.25 ns         1.25 ns    558856294
</code></pre> 
<h4><a id="_C__345"></a>现代 C++ 性能测试</h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;benchmark/benchmark.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unordered_map&gt;</span></span>

<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">DoorState</span> <span class="token punctuation">{<!-- --></span> Closed<span class="token punctuation">,</span> Open<span class="token punctuation">,</span> Locked <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">DoorEvent</span> <span class="token punctuation">{<!-- --></span> OpenEvent<span class="token punctuation">,</span> CloseEvent<span class="token punctuation">,</span> LockEvent <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">DoorStateMachine</span> <span class="token punctuation">{<!-- --></span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token function">DoorStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">state</span><span class="token punctuation">(</span>DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    stateHandlers<span class="token punctuation">[</span>DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">]</span><span class="token punctuation">[</span>DoorEvent<span class="token double-colon punctuation">::</span>OpenEvent<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Open<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    stateHandlers<span class="token punctuation">[</span>DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">]</span><span class="token punctuation">[</span>DoorEvent<span class="token double-colon punctuation">::</span>LockEvent<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Locked<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    stateHandlers<span class="token punctuation">[</span>DoorState<span class="token double-colon punctuation">::</span>Open<span class="token punctuation">]</span><span class="token punctuation">[</span>DoorEvent<span class="token double-colon punctuation">::</span>CloseEvent<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> state <span class="token operator">=</span> DoorState<span class="token double-colon punctuation">::</span>Closed<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">void</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> eventHandler <span class="token operator">=</span> stateHandlers<span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventHandler <span class="token operator">!=</span> stateHandlers<span class="token punctuation">[</span>state<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      eventHandler<span class="token operator">-&gt;</span><span class="token function">second</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  DoorState state<span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>DoorState<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>unordered_map<span class="token operator">&lt;</span>DoorEvent<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> stateHandlers<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">BM_ModernCPPStateMachine</span><span class="token punctuation">(</span>benchmark<span class="token double-colon punctuation">::</span>State<span class="token operator">&amp;</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> _ <span class="token operator">:</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    DoorStateMachine door<span class="token punctuation">;</span>
    door<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent<span class="token double-colon punctuation">::</span>OpenEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    door<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent<span class="token double-colon punctuation">::</span>CloseEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    door<span class="token punctuation">.</span><span class="token function">handleEvent</span><span class="token punctuation">(</span>DoorEvent<span class="token double-colon punctuation">::</span>LockEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">BENCHMARK</span><span class="token punctuation">(</span>BM_ModernCPPStateMachine<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">BENCHMARK_MAIN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>测试结果：</p> 
<pre><code>Benchmark                         Time             CPU   Iterations
-------------------------------------------------------------------
BM_ModernCPPStateMachine        413 ns          413 ns      1694224
</code></pre> 
<h3><a id="Misra_C_397"></a>工业Misra C++编程标准</h3> 
<p>MISRA C++ 是工业领域的一个要求比较高的标准。以下是一些多态和继承的规则：</p> 
<ul><li><strong>规则 10-3-1</strong>：虚函数应有明确的用途，避免不必要的虚函数调用。</li><li><strong>规则 10-3-2</strong>：禁止多重继承。</li><li><strong>规则 10-3-3</strong>：尽量避免继承深度超过两个层次。</li><li><strong>规则 10-3-4</strong>：构造函数和析构函数中不应调用虚函数。</li><li><strong>规则 10-3-5</strong>：禁止多态对象的拷贝和赋值。</li></ul> 
<h3><a id="TinyFSM__405"></a>TinyFSM 的优缺点分析</h3> 
<p><strong>优点</strong>：</p> 
<ol><li><strong>简洁和易用性</strong>：通过继承和定义状态类，TinyFSM 使状态和事件处理函数的定义更加直观。</li><li><strong>代码可读性</strong>：每个状态独立成类，使状态转换逻辑清晰明了，便于理解和维护。</li><li><strong>减少错误</strong>：提供了一个经过验证的框架，降低了手动管理状态转换时的出错风险。</li><li><strong>可扩展性</strong>：可以轻松添加新状态和事件，只需定义新的状态类和事件类型。</li></ol> 
<p><strong>缺点</strong>：</p> 
<ol><li><strong>内存使用</strong>：使用多态和虚函数增加了对象的内存开销，对于内存资源有限的嵌入式系统可能不太合适。</li><li><strong>运行时开销</strong>：虚函数调用需要通过虚表查找实际的函数地址，增加了运行时开销。</li><li><strong>不符合工业编码规范</strong>：TinyFSM 不符合严格的工业编码规范（如 MISRA C++）。</li></ol> 
<h3><a id="_418"></a>结论</h3> 
<p>总之，工业领域是否要选择TinyFSM还需要三思，尽管现代编程技术如 TinyFSM 对代码结构的简化带来了吸引力，但在需要遵循严格工业标准的环境中，推荐采用更传统的 C++ 编程方法。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/21a6f9367e2dd37d36928f346a8f1ab4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">网络安全（完整）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6770c1e9ad6ff9ff562d5ad59f98e68e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何去掉el-input-number两侧的上下按键</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>