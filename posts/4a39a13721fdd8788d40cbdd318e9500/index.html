<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Go-Zero 数据库实战：配置、建模与业务逻辑一体化 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/4a39a13721fdd8788d40cbdd318e9500/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Go-Zero 数据库实战：配置、建模与业务逻辑一体化">
  <meta property="og:description" content="前言 在之前的几篇文章中，我们深入学习了Go-Zero框架的实战应用，包括模板定制化、API定义、抽奖算法设计等内容。本文将继续探索Go-Zero框架的实践技巧，并介绍一些与数据库操作相关的主题。
在现代应用程序开发中，对数据库的操作是非常常见且重要的一部分。Go-Zero框架提供了强大的数据库支持，使得我们可以轻松地进行数据库访问和操作。本文将重点介绍如何使用Go-Zero框架进行数据库的增删改查（CRUD）操作，并提供详细的示例代码和解释。
在本文中，我们将使用MySQL数据库作为示例，并结合Go-Zero框架的相关组件，如数据模型（Model）、事务处理、连接池等，来展示数据库操作的最佳实践。无论你是初学者还是有一定经验的开发者，本文都将为你提供有用的信息和技巧，帮助你更好地理解和应用Go-Zero框架中的数据库操作。
在阅读本文之前，请确保你已经按照前几篇文章中的说明进行了必要的准备工作，包括安装所需的工具和设置项目环境。同时，本文假设你已经具备一定的数据库基础知识，如表的创建、数据的插入和查询等。
通过学习本文，你将掌握以下内容：
如何配置和初始化数据库连接；如何使用Go-Zero框架的Model组件进行数据表的创建和映射；如何进行常见的CRUD操作，包括数据的插入、查询、更新和删除；如何处理数据库事务；实现用户注册业务逻辑。 我们鼓励你跟随示例代码，动手实践，并根据自己的需求进行定制和扩展。无论是为了学习Go-Zero的数据库操作，还是为了解决具体的业务问题，本文都将为你提供实用的指导和技巧。
祝你阅读愉快，并从中获得所需的知识和灵感！
实战前准备 本次实战我们是建立在（六）Go-Zero实战之docker开发环境部署 基础之上，如果没有学习过，可以点击跳转学习，然后再看本文哦！
本次实战采用的是docker部署，请提前准备好相关环境，关于docker环境的搭建在（六）Go-Zero实战之docker开发环境部署 中也有讲解，不了解小伙伴建议先行实战docker环境搭建哦！
目录结构说明 在app下面我们将会新建一个服务comment，表示晒单评论服务，deploy/sql存放的是我们的建表语句，相关语句将会在接下来的讲解中给大家。 实战 配置docker组件 在docker-commpose-env.yml中添加如下配置mysql mysql: image: mysql/mysql-server:8.0.28 container_name: mysql environment: # 时区上海 - Time zone Shanghai (Change if needed) TZ: Asia/Shanghai # root 密码 - root password MYSQL_ROOT_PASSWORD: xxxxxx #这里填上mysql的密码 ports: - 33069:3306 volumes: # 数据挂载 - Data mounting - ./data/mysql/data:/var/lib/mysql # 日志 command: # 将mysql8.0默认密码策略 修改为 原先 策略 (mysql8.0对其默认策略做了更改 会导致密码无法匹配) # Modify the Mysql 8.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-26T15:26:17+08:00">
    <meta property="article:modified_time" content="2024-07-26T15:26:17+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Go-Zero 数据库实战：配置、建模与业务逻辑一体化</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>前言</h3> 
<p>在之前的几篇文章中，我们深入学习了Go-Zero框架的实战应用，包括模板定制化、API定义、抽奖算法设计等内容。本文将继续探索Go-Zero框架的实践技巧，并介绍一些与数据库操作相关的主题。</p> 
<p>在现代应用程序开发中，对数据库的操作是非常常见且重要的一部分。Go-Zero框架提供了强大的数据库支持，使得我们可以轻松地进行数据库访问和操作。本文将重点介绍如何使用Go-Zero框架进行数据库的增删改查（CRUD）操作，并提供详细的示例代码和解释。</p> 
<p>在本文中，我们<strong>将使用MySQL数据库作为示例，并结合Go-Zero框架的相关组件，如数据模型（Model）、事务处理、连接池等，来展示数据库操作的最佳实践。无论你是初学者还是有一定经验的开发者，本文都将为你提供有用的信息和技巧，帮助你更好地理解和应用Go-Zero框架中的数据库操作。</strong></p> 
<p>在阅读本文之前，请确保你已经按照前几篇文章中的说明进行了必要的准备工作，包括安装所需的工具和设置项目环境。同时，本文假设你已经具备一定的数据库基础知识，如表的创建、数据的插入和查询等。</p> 
<p>通过学习本文，你将掌握以下内容：</p> 
<ul><li>如何配置和初始化数据库连接；</li><li>如何使用Go-Zero框架的Model组件进行数据表的创建和映射；</li><li>如何进行常见的CRUD操作，包括数据的插入、查询、更新和删除；</li><li>如何处理数据库事务；</li><li>实现用户注册业务逻辑。</li></ul> 
<p>我们鼓励你跟随示例代码，动手实践，并根据自己的需求进行定制和扩展。无论是为了学习Go-Zero的数据库操作，还是为了解决具体的业务问题，本文都将为你提供实用的指导和技巧。</p> 
<p>祝你阅读愉快，并从中获得所需的知识和灵感！</p> 
<h3><a id="_22"></a>实战前准备</h3> 
<p>本次实战我们是建立在<a href="https://mp.weixin.qq.com/s?__biz=MzIyNjM0MzQyNg==&amp;mid=2247493750&amp;idx=1&amp;sn=dd4a36be1d880d07adb12a14137c49c8&amp;chksm=e873471bdf04ce0d3a1ae7c906b533ec17cec205af7fea9b1b2c9b4496848d4fb3c34e0c43f9&amp;token=1673936420&amp;lang=zh_CN#rd" rel="nofollow">（六）Go-Zero实战之docker开发环境部署</a> 基础之上，如果没有学习过，可以点击跳转学习，然后再看本文哦！</p> 
<p>本次实战采用的是docker部署，请提前准备好相关环境，关于docker环境的搭建在<a href="https://mp.weixin.qq.com/s?__biz=MzIyNjM0MzQyNg==&amp;mid=2247493750&amp;idx=1&amp;sn=dd4a36be1d880d07adb12a14137c49c8&amp;chksm=e873471bdf04ce0d3a1ae7c906b533ec17cec205af7fea9b1b2c9b4496848d4fb3c34e0c43f9&amp;token=1673936420&amp;lang=zh_CN#rd" rel="nofollow">（六）Go-Zero实战之docker开发环境部署</a> 中也有讲解，不了解小伙伴建议先行实战docker环境搭建哦！</p> 
<h3><a id="_28"></a>目录结构说明</h3> 
<p><img src="https://images2.imgbox.com/21/bb/f0cd0rqc_o.png" alt=""></p> 
<ul><li>在app下面我们将会新建一个服务comment，表示晒单评论服务，deploy/sql存放的是我们的建表语句，相关语句将会在接下来的讲解中给大家。</li></ul> 
<h3><a id="_36"></a>实战</h3> 
<h4><a id="docker_38"></a>配置docker组件</h4> 
<ul><li>在docker-commpose-env.yml中添加如下配置mysql</li></ul> 
<p><img src="https://images2.imgbox.com/6d/31/FDTrlX9R_o.png" alt=""></p> 
<pre><code class="prism language-yml">  <span class="token key atrule">mysql</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql/mysql<span class="token punctuation">-</span>server<span class="token punctuation">:</span>8.0.28
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token comment"># 时区上海 - Time zone Shanghai (Change if needed)</span>
      <span class="token key atrule">TZ</span><span class="token punctuation">:</span> Asia/Shanghai
      <span class="token comment"># root 密码 - root password</span>
      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> xxxxxx <span class="token comment">#这里填上mysql的密码</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 33069<span class="token punctuation">:</span><span class="token number">3306</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token comment"># 数据挂载 - Data mounting</span>
      <span class="token punctuation">-</span> ./data/mysql/data<span class="token punctuation">:</span>/var/lib/mysql
      <span class="token comment"># 日志</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token comment"># 将mysql8.0默认密码策略 修改为 原先 策略 (mysql8.0对其默认策略做了更改 会导致密码无法匹配) </span>
      <span class="token comment"># Modify the Mysql 8.0 default password strategy to the original strategy (MySQL8.0 to change its default strategy will cause the password to be unable to match)</span>
      <span class="token punctuation">-</span><span class="token punctuation">-</span>default<span class="token punctuation">-</span>authentication<span class="token punctuation">-</span>plugin=mysql_native_password
      <span class="token punctuation">-</span><span class="token punctuation">-</span>character<span class="token punctuation">-</span>set<span class="token punctuation">-</span>server=utf8mb4
      <span class="token punctuation">-</span><span class="token punctuation">-</span>collation<span class="token punctuation">-</span>server=utf8mb4_general_ci
      <span class="token punctuation">-</span><span class="token punctuation">-</span>explicit_defaults_for_timestamp=true
      <span class="token punctuation">-</span><span class="token punctuation">-</span>lower_case_table_names=1
    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> testProject_net
</code></pre> 
<ul><li>在本次实战中我们会使用到缓存（使用sqlc库），因此也进行了redis的配置。如果不想走缓存，可以使用sqlx库，后续根据需求再添加缓存。</li><li>在docker-commpose-env.yml中添加如下配置redis</li></ul> 
<p><img src="https://images2.imgbox.com/3c/1c/SXIh7o36_o.png" alt=""></p> 
<pre><code class="prism language-yml">  <span class="token comment">#redis容器 - Redis container</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>6.2.5
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> redis
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 36379<span class="token punctuation">:</span><span class="token number">6379</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token comment"># 时区上海 - Time zone Shanghai (Change if needed)</span>
      <span class="token key atrule">TZ</span><span class="token punctuation">:</span> Asia/Shanghai
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token comment"># 数据文件 - data files</span>
      <span class="token punctuation">-</span> ./data/redis/data<span class="token punctuation">:</span>/data<span class="token punctuation">:</span>rw
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"redis-server --requirepass G62m50oigInC30sf  --appendonly yes"</span>
    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> testProject_net
</code></pre> 
<ul><li>在进行复制粘贴的时候需要注意缩进哦！</li></ul> 
<h3><a id="_106"></a>重新启动项目所依赖的环境</h3> 
<pre><code class="prism language-shell">$ <span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker-compose-env.yml up <span class="token parameter variable">-d</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/05/44/wfJrrAj7_o.png" alt=""></p> 
<h3><a id="Navicate_116"></a>Navicate连接数据库</h3> 
<p><img src="https://images2.imgbox.com/c8/d4/butg9XiV_o.png" alt=""></p> 
<h3><a id="GoZero_122"></a>Go-Zero操作数据库</h3> 
<p>go-zero提供了两个操作数据库的库，分别是sqlc和sqlx。区别是前者带缓存，后者不带缓存。</p> 
<p><img src="https://images2.imgbox.com/30/c1/QOoaXjbx_o.png" alt=""></p> 
<p>我们先在<a href="https://mp.weixin.qq.com/s?__biz=MzIyNjM0MzQyNg==&amp;mid=2247493750&amp;idx=1&amp;sn=dd4a36be1d880d07adb12a14137c49c8&amp;chksm=e873471bdf04ce0d3a1ae7c906b533ec17cec205af7fea9b1b2c9b4496848d4fb3c34e0c43f9&amp;token=1673936420&amp;lang=zh_CN#rd" rel="nofollow">（六）Go-Zero实战之docker开发环境部署</a> 中创建的usercent服务进行gozero操作数据库相关内容的学习</p> 
<p><img src="https://images2.imgbox.com/79/e5/Oefu96GN_o.png" alt=""></p> 
<ul><li>tips：相关服务和表结构在<a href="https://mp.weixin.qq.com/s?__biz=MzIyNjM0MzQyNg==&amp;mid=2247493750&amp;idx=1&amp;sn=dd4a36be1d880d07adb12a14137c49c8&amp;chksm=e873471bdf04ce0d3a1ae7c906b533ec17cec205af7fea9b1b2c9b4496848d4fb3c34e0c43f9&amp;token=1673936420&amp;lang=zh_CN#rd" rel="nofollow">（六）Go-Zero实战之docker开发环境部署</a> 中已经实现，如果本地没有的小伙伴可以先进行（六）的学习和操作哦！</li><li>在<a href="https://mp.weixin.qq.com/s?__biz=MzIyNjM0MzQyNg==&amp;mid=2247493750&amp;idx=1&amp;sn=dd4a36be1d880d07adb12a14137c49c8&amp;chksm=e873471bdf04ce0d3a1ae7c906b533ec17cec205af7fea9b1b2c9b4496848d4fb3c34e0c43f9&amp;token=1673936420&amp;lang=zh_CN#rd" rel="nofollow">（六）Go-Zero实战之docker开发环境部署 </a> 中我们已经定义了两个RPC接口，接下来我们通过实现这两个register接口展示如何使用gozero操作数据库。</li></ul> 
<h3><a id="model_139"></a>使用脚本生成数据库对应的model</h3> 
<ul><li>tips：这一小节的内容在<a href="https://mp.weixin.qq.com/s?__biz=MzIyNjM0MzQyNg==&amp;mid=2247492691&amp;idx=1&amp;sn=0637d94acb3e8998627f5a36b8d6be0e&amp;chksm=e8734b3edf04c2282fadf8801b0d6bee32ef057a3e0faec8e32aa404fefee9706d44f2c31782&amp;token=1673936420&amp;lang=zh_CN#rd" rel="nofollow">（三）Go-Zero和goctl：解锁微服务开发的神器，快速上手指南</a> 中有过详细的讲解，如果有不清楚的小伙伴可以点击这里进行回顾哦！本节仅进行操作以及效果展示。</li><li>脚本如下(放在目录的deploy/script/mysql/genModel.sh下)：</li></ul> 
<pre><code class="prism language-shell"><span class="token shebang important">#!/usr/bin/env bash</span>

<span class="token comment"># 使用方法：</span>
<span class="token comment"># ./genModel.sh lottery lottery</span>
<span class="token comment"># ./genModel.sh lottery prize</span>
<span class="token comment"># ./genModel.sh looklook_usercenter user_contact</span>
<span class="token comment"># 再将./genModel下的文件剪切到对应服务的model目录里面，记得改package</span>

<span class="token comment">#生成的表名</span>
<span class="token assign-left variable">tables</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token comment">#表生成的genmodel目录</span>
<span class="token assign-left variable">modeldir</span><span class="token operator">=</span>./genModel

<span class="token comment"># 数据库配置</span>
<span class="token assign-left variable">host</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1
<span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">33069</span>
<span class="token assign-left variable">dbname</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">username</span><span class="token operator">=</span>root
<span class="token assign-left variable">passwd</span><span class="token operator">=</span>PXDN93VRKUm8TeE7
<span class="token assign-left variable">template</span><span class="token operator">=</span><span class="token punctuation">..</span>/<span class="token punctuation">..</span>/goctl/1.6.1

<span class="token builtin class-name">echo</span> <span class="token string">"开始创建库：<span class="token variable">$dbname</span> 的表：<span class="token variable">$2</span>"</span>
goctl model mysql datasource <span class="token parameter variable">-url</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${username}</span>:<span class="token variable">${passwd}</span>@tcp(<span class="token variable">${host}</span>:<span class="token variable">${port}</span>)/<span class="token variable">${dbname}</span>"</span> <span class="token parameter variable">-table</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${tables}</span>"</span> <span class="token parameter variable">-dir</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${modeldir}</span>"</span> <span class="token parameter variable">-cache</span><span class="token operator">=</span>true <span class="token parameter variable">--home</span><span class="token operator">=</span><span class="token string">"<span class="token variable">${template}</span>"</span> <span class="token parameter variable">--style</span><span class="token operator">=</span>goZero
</code></pre> 
<ul><li>使用GitBash打开deploy/script/mysql目录，执行脚本</li></ul> 
<p><img src="https://images2.imgbox.com/19/da/0XjUge4h_o.png" alt=""></p> 
<ul><li>将相关代码放到model下</li></ul> 
<p><img src="https://images2.imgbox.com/af/8b/jzAjAnvH_o.png" alt=""></p> 
<ul><li>把包名改成model</li></ul> 
<p><img src="https://images2.imgbox.com/a8/a7/jS7caoqh_o.png" alt=""></p> 
<ul><li>配置文件中加入如下配置，用于jwt鉴权以及mysql、redis连接配置的获取</li></ul> 
<p><img src="https://images2.imgbox.com/58/78/N6D9Gc2n_o.png" alt=""></p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> config

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/zeromicro/go-zero/core/stores/cache"</span>
	<span class="token string">"github.com/zeromicro/go-zero/zrpc"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	zrpc<span class="token punctuation">.</span>RpcServerConf
	CheckinRpcConf zrpc<span class="token punctuation">.</span>RpcClientConf
	JwtAuth        <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
		AccessSecret <span class="token builtin">string</span>
		AccessExpire <span class="token builtin">int64</span>
	<span class="token punctuation">}</span>
	DB <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
		DataSource <span class="token builtin">string</span>
	<span class="token punctuation">}</span>
	Cache cache<span class="token punctuation">.</span>CacheConf
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>svc下的serviceContext加入如下配置，用于获取mysql连接</li></ul> 
<p><img src="https://images2.imgbox.com/fb/f9/0uSa0VBO_o.png" alt=""></p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> svc

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/zeromicro/go-zero/core/stores/redis"</span>
	<span class="token string">"github.com/zeromicro/go-zero/core/stores/sqlx"</span>
	<span class="token string">"testProject/app/usercenter/cmd/rpc/internal/config"</span>
	<span class="token string">"testProject/app/usercenter/model"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> ServiceContext <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Config    config<span class="token punctuation">.</span>Config
	UserModel model<span class="token punctuation">.</span>UserModel

	RedisClient <span class="token operator">*</span>redis<span class="token punctuation">.</span>Redis
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewServiceContext</span><span class="token punctuation">(</span>c config<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token operator">*</span>ServiceContext <span class="token punctuation">{<!-- --></span>
	sqlConn <span class="token operator">:=</span> sqlx<span class="token punctuation">.</span><span class="token function">NewMysql</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>DB<span class="token punctuation">.</span>DataSource<span class="token punctuation">)</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ServiceContext<span class="token punctuation">{<!-- --></span>
		UserModel<span class="token punctuation">:</span> model<span class="token punctuation">.</span><span class="token function">NewUserModel</span><span class="token punctuation">(</span>sqlConn<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Cache<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Config<span class="token punctuation">:</span>    c<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>rpc/etc/usercenter.yaml加上jwtAuth配置</li></ul> 
<pre><code class="prism language-yaml"><span class="token comment">#jwtAuth</span>
<span class="token key atrule">JwtAuth</span><span class="token punctuation">:</span>
  <span class="token key atrule">AccessSecret</span><span class="token punctuation">:</span> ae0536f9<span class="token punctuation">-</span>6450<span class="token punctuation">-</span>4606<span class="token punctuation">-</span>8e13<span class="token punctuation">-</span>5a19ed505da0
  <span class="token key atrule">AccessExpire</span><span class="token punctuation">:</span> <span class="token number">31536000</span>
</code></pre> 
<ul><li>注册model</li></ul> 
<p><img src="https://images2.imgbox.com/0d/5a/dnZKz6Xd_o.png" alt=""></p> 
<pre><code class="prism language-go">UserModel<span class="token punctuation">:</span>        model<span class="token punctuation">.</span><span class="token function">NewUserModel</span><span class="token punctuation">(</span>sqlConn<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Cache<span class="token punctuation">)</span><span class="token punctuation">,</span>
</code></pre> 
<ul><li>这样我们就可以在userModel下写我们自己的sql操作了</li></ul> 
<p><img src="https://images2.imgbox.com/fb/ec/r9QEcxGL_o.png" alt=""></p> 
<h3><a id="_273"></a>事务操作</h3> 
<ul><li>sqlc为我们提供了事务操作，相关源码如下：</li></ul> 
<p><img src="https://images2.imgbox.com/65/16/hRVSXAcp_o.png" alt=""></p> 
<ul><li>我们可以基于官方提供的TransactCtx方法，封装自己的事务处理方法 
  <ul><li>首先在userModel里面注册Trans方法，如下图所示</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/a2/4a/1AgxbstK_o.png" alt=""></p> 
<pre><code class="prism language-go"><span class="token function">Trans</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> session sqlx<span class="token punctuation">.</span>Session<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre> 
<ul><li>接着写这个方法的实现，其实就是对原本的函数进行了一个封装。</li></ul> 
<p><img src="https://images2.imgbox.com/2e/48/aJmeVTAR_o.png" alt=""></p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>defaultUserModel<span class="token punctuation">)</span> <span class="token function">Trans</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> fn <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> session sqlx<span class="token punctuation">.</span>Session<span class="token punctuation">)</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">TransactCtx</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> session sqlx<span class="token punctuation">.</span>Session<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> session<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>通过这个例子，我们可以知道gozero如何注册自己的数据库操作方法，以及了解到如何进行事务操作。</li></ul> 
<h3><a id="_308"></a>注册业务逻辑的实现</h3> 
<ul><li>首先我们先在tool下新增encryption.go文件，增加一个md5加密字符串的函数</li></ul> 
<p><img src="https://images2.imgbox.com/4e/cb/xsWDeGIP_o.png" alt=""></p> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">Md5ByString</span><span class="token punctuation">(</span>str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	m <span class="token operator">:=</span> md5<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> str<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	arr <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%x"</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>在logic/registerLogic.go里面编写我们的注册逻辑，注册业务代码如下</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>RegisterLogic<span class="token punctuation">)</span> <span class="token function">Register</span><span class="token punctuation">(</span>in <span class="token operator">*</span>pb<span class="token punctuation">.</span>RegisterReq<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>RegisterResp<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span>svcCtx<span class="token punctuation">.</span>UserModel<span class="token punctuation">.</span><span class="token function">Trans</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> session sqlx<span class="token punctuation">.</span>Session<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
       user <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
       <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>Password<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
          user<span class="token punctuation">.</span>Password <span class="token operator">=</span> tool<span class="token punctuation">.</span><span class="token function">Md5ByString</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>Password<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
       insertResult<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span>svcCtx<span class="token punctuation">.</span>UserModel<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
       <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Register db user Insert err:%v,user:%+v"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
       lastId<span class="token punctuation">,</span> err <span class="token operator">:=</span> insertResult<span class="token punctuation">.</span><span class="token function">LastInsertId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Wrapf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"Register db user insertResult.LastInsertId err:%v,user:%+v"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> user<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
       fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"lastId:"</span><span class="token punctuation">,</span> lastId<span class="token punctuation">)</span>

       <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
       logx<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Register:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
       <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>usercenter<span class="token punctuation">.</span>RegisterResp<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>

<span class="token punctuation">}</span>
</code></pre> 
<ul><li>tips：这个是最简单的插入一条数据的逻辑，实际生产中我们往往需要添加各种校验以及登录回调，jwt返回等，根据实际需求进行修改。如果读者朋友有需求，后续文章我们也会完善这个注册逻辑。</li><li>可以看见我们实际调用了Insert方法进行了插入操作。gozero框架的默认模板帮我们封装好了常规的增删改查操作，我们可以直接调用即可，如果有额外需求我们可以在userModel.go定义自己的sql查询方法，或者自定义我们自己的goctl，关于自定义模板可以看我前面的文章<a href="https://mp.weixin.qq.com/s?__biz=MzIyNjM0MzQyNg==&amp;mid=2247492741&amp;idx=1&amp;sn=2e73862e8a04aa28d17b4271d174aa12&amp;chksm=e8734be8df04c2fe052b7db637b68b8e914004940a93c5c7cc79421a12845506b1e5833df713&amp;token=1673936420&amp;lang=zh_CN#rd" rel="nofollow">（四）Go-Zero自定义goctl实战：定制化模板，加速你的微服务开发效率</a>哦！</li><li>接下来我们简单看一下模板中对于增删查改方法的实现</li><li>插入操作</li></ul> 
<p><img src="https://images2.imgbox.com/09/d6/KmaHVI8j_o.png" alt=""></p> 
<ul><li>删除操作</li></ul> 
<p><img src="https://images2.imgbox.com/37/cd/9cf9OTQJ_o.png" alt=""></p> 
<ul><li>更新操作</li></ul> 
<p><img src="https://images2.imgbox.com/0b/67/JjLjsYG2_o.png" alt=""></p> 
<ul><li>查询操作</li></ul> 
<p><img src="https://images2.imgbox.com/4d/e2/JKsqCSs7_o.png" alt=""></p> 
<ul><li>更多的数据库操作建议可以查看官方文档<a href="https://go-zero.dev/docs/tasks/cli/mysql" rel="nofollow">mysql 代码生成 | go-zero Documentation</a>，本教程更注重于实践操作以及代码实现。</li></ul> 
<h3><a id="_387"></a>测试与验证</h3> 
<ul><li>编写完业务后我们启动服务，关于服务启动在<a href="https://mp.weixin.qq.com/s?__biz=MzIyNjM0MzQyNg==&amp;mid=2247492741&amp;idx=1&amp;sn=2e73862e8a04aa28d17b4271d174aa12&amp;chksm=e8734be8df04c2fe052b7db637b68b8e914004940a93c5c7cc79421a12845506b1e5833df713&amp;token=1673936420&amp;lang=zh_CN#rd" rel="nofollow">（三）Go-Zero和goctl：解锁微服务开发的神器，快速上手指南 </a>中有详细讲解，这里不进行重复讲解。</li></ul> 
<p><img src="https://images2.imgbox.com/70/3b/BpuUmTuE_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/f4/4f/JXwU17Mw_o.png" alt=""></p> 
<p><img src="https://images2.imgbox.com/fa/d5/rxxHTyaF_o.png" alt=""></p> 
<ul><li>可以看见成功进行了用户注册，说明插入操作有效。</li></ul> 
<h3><a id="_404"></a>结语</h3> 
<p>至此，我们已经完成了数据库相关配置，以及通过用户服务和注册接口了解到了常规的增删改查操作。</p> 
<p>关于更详细的实现，如果有小伙伴有需求，我们可以单独拿一节课来进行详细的拆分讲解。</p> 
<p>本篇文章介绍了Go-Zero中的数据库操作，并提供了常用的命令示例。通过学习和实践，我们可以更加熟练地使用Go-Zero进行高效的数据库操作。在后续的文章中，我们将进一步探索数据库操作的高级用法和技巧，为小伙伴们提供更多的参考。</p> 
<h2><a id="__412"></a>欢迎关注 ❤</h2> 
<p>我的文章都首发在同名公众号：<a href="https://mp.weixin.qq.com/s/fcx8THeyVp17CnLY_MolvQ" rel="nofollow">王中阳</a></p> 
<p>需要简历优化或者就业辅导，可以直接加我微信：wangzhongyang1993，备注：知乎</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ad3720921ef5106a42a7bdc29c2a3345/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">EasyExcel 初使用—— Java 实现读取 Excel 功能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a02805cd5108777f9b43adc2ea76a9a0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SpringBoot详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>