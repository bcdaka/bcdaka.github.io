<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微服务安全——OAuth2.1详解、授权码模式、SpringAuthorizationServer实战、SSO单点登录、Gateway整合OAuth2 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/0e9915a36f561d2a1acec1b4eb4a8ac8/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="微服务安全——OAuth2.1详解、授权码模式、SpringAuthorizationServer实战、SSO单点登录、Gateway整合OAuth2">
  <meta property="og:description" content="文章目录 Spring Authorization Server介绍OAuth2.0协议介绍角色OAuth2.0协议的运行流程应用场景授权模式详解客户端模式密码模式授权码模式简化模式token刷新模式 OAuth 2.1 协议介绍授权码模式&#43;PKCE扩展设备授权码模式拓展授权模式 OpenID Connect 1.0协议Spring Authorization Server 实战认证/授权服务器搭建搭建授权码模式测试刷新令牌测试客户端模式测试 oauth2客户端搭建说明搭建客户端客户端测试 oauth2资源服务器搭建说明搭建资源服务器资源服务器测试自定义异常处理类 基于数据库存储改造授权服务器客户端注册信息存储改造用户信息存储改造测试 SSO单点登录实战实现思路授权服务器搭建订单服务搭建商品服务搭建单点登录测试 微服务网关整合Oauth2安全认证实战实现思路配置授权服务器网关接入OAuth2资源服务器配置测试 Spring Authorization Server介绍 Spring Authorization Server 是一个框架，它提供了 OAuth 2.1 和 OpenID Connect 1.0 规范以及其他相关规范的实现。
它建立在 Spring Security 之上，为构建 OpenID Connect 1.0 身份提供者和 OAuth2 授权服务器产品提供了一个安全、轻量级和可定制的基础。
说白了，Spring Authorization Server 就是一个认证（授权）服务器。
官方主页：https://spring.io/projects/spring-authorization-server
因为随着网络和设备的发展，原先的 OAuth 2.0 已经不能满足现今的需求了，OAuth 社区对 OAuth 2.0 中的几种授权模式进行了取舍和优化，并增加一些新的特性， 于是推出了 OAuth 2.1
而原先的 Spring Security OAuth 2.0 使用的是 OAuth 2.0 协议，为满足新的变化，Spring Security 团队重新写了一套叫 Spring Authorization Server 的认证授权框架来替换原先的 Spring Security OAuth 2.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-26T18:42:58+08:00">
    <meta property="article:modified_time" content="2024-07-26T18:42:58+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微服务安全——OAuth2.1详解、授权码模式、SpringAuthorizationServer实战、SSO单点登录、Gateway整合OAuth2</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Spring_Authorization_Server_4" rel="nofollow">Spring Authorization Server介绍</a></li><li><a href="#OAuth20_55" rel="nofollow">OAuth2.0协议介绍</a></li><li><ul><li><a href="#_67" rel="nofollow">角色</a></li><li><a href="#OAuth20_107" rel="nofollow">OAuth2.0协议的运行流程</a></li><li><a href="#_147" rel="nofollow">应用场景</a></li><li><a href="#_172" rel="nofollow">授权模式详解</a></li><li><ul><li><a href="#_186" rel="nofollow">客户端模式</a></li><li><a href="#_245" rel="nofollow">密码模式</a></li><li><a href="#_316" rel="nofollow">授权码模式</a></li><li><a href="#_436" rel="nofollow">简化模式</a></li><li><a href="#token_516" rel="nofollow">token刷新模式</a></li></ul> 
  </li></ul> 
  </li><li><a href="#OAuth_21__573" rel="nofollow">OAuth 2.1 协议介绍</a></li><li><ul><li><a href="#PKCE_585" rel="nofollow">授权码模式+PKCE扩展</a></li><li><a href="#_642" rel="nofollow">设备授权码模式</a></li><li><a href="#_686" rel="nofollow">拓展授权模式</a></li></ul> 
  </li><li><a href="#OpenID_Connect_10_702" rel="nofollow">OpenID Connect 1.0协议</a></li><li><a href="#Spring_Authorization_Server__716" rel="nofollow">Spring Authorization Server 实战</a></li><li><ul><li><a href="#_734" rel="nofollow">认证/授权服务器搭建</a></li><li><ul><li><a href="#_753" rel="nofollow">搭建</a></li><li><a href="#_1084" rel="nofollow">授权码模式测试</a></li><li><a href="#_1148" rel="nofollow">刷新令牌测试</a></li><li><a href="#_1166" rel="nofollow">客户端模式测试</a></li></ul> 
   </li><li><a href="#oauth2_1182" rel="nofollow">oauth2客户端搭建</a></li><li><ul><li><a href="#_1184" rel="nofollow">说明</a></li><li><a href="#_1206" rel="nofollow">搭建客户端</a></li><li><a href="#_1396" rel="nofollow">客户端测试</a></li></ul> 
   </li><li><a href="#oauth2_1570" rel="nofollow">oauth2资源服务器搭建</a></li><li><ul><li><a href="#_1572" rel="nofollow">说明</a></li><li><a href="#_1590" rel="nofollow">搭建资源服务器</a></li><li><a href="#_1776" rel="nofollow">资源服务器测试</a></li><li><a href="#_1854" rel="nofollow">自定义异常处理类</a></li></ul> 
   </li><li><a href="#_2152" rel="nofollow">基于数据库存储改造授权服务器</a></li><li><ul><li><a href="#_2154" rel="nofollow">客户端注册信息存储改造</a></li><li><a href="#_2411" rel="nofollow">用户信息存储改造</a></li><li><a href="#_2798" rel="nofollow">测试</a></li></ul> 
  </li></ul> 
  </li><li><a href="#SSO_2835" rel="nofollow">SSO单点登录实战</a></li><li><ul><li><a href="#_2843" rel="nofollow">实现思路</a></li><li><a href="#_2858" rel="nofollow">授权服务器搭建</a></li><li><a href="#_2867" rel="nofollow">订单服务搭建</a></li><li><a href="#_2955" rel="nofollow">商品服务搭建</a></li><li><a href="#_3021" rel="nofollow">单点登录测试</a></li></ul> 
  </li><li><a href="#Oauth2_3117" rel="nofollow">微服务网关整合Oauth2安全认证实战</a></li><li><ul><li><a href="#_3119" rel="nofollow">实现思路</a></li><li><a href="#_3144" rel="nofollow">配置授权服务器</a></li><li><a href="#OAuth2_3162" rel="nofollow">网关接入OAuth2</a></li><li><a href="#_3498" rel="nofollow">资源服务器配置</a></li><li><a href="#_3612" rel="nofollow">测试</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p><br><br></p> 
<h2><a id="Spring_Authorization_Server_4"></a>Spring Authorization Server介绍</h2> 
<p>Spring Authorization Server 是一个框架，它提供了 <code>OAuth 2.1</code> 和 <code>OpenID Connect 1.0</code> 规范以及其他相关规范的实现。</p> 
<p>它建立在 Spring Security 之上，为构建 OpenID Connect 1.0 身份提供者和 OAuth2 授权服务器产品提供了一个安全、轻量级和可定制的基础。</p> 
<p>说白了，Spring Authorization Server 就是一个认证（授权）服务器。</p> 
<p><br><br></p> 
<p>官方主页：https://spring.io/projects/spring-authorization-server</p> 
<p><br><br></p> 
<p>因为随着网络和设备的发展，原先的 OAuth 2.0 已经不能满足现今的需求了，OAuth 社区对 OAuth 2.0 中的几种授权模式进行了取舍和优化，并增加一些新的特性， 于是推出了 OAuth 2.1</p> 
<p>而原先的 Spring Security OAuth 2.0 使用的是 OAuth 2.0 协议，为满足新的变化，Spring Security 团队重新写了一套叫 Spring Authorization Server 的认证授权框架来替换原先的 Spring Security OAuth 2.0。</p> 
<p>从官网中可以看到，原先的 Spring Security OAuth 2.0 已从 Spring Security 目录下被移除，接着是多出 Spring Authorization Server 作为单独项目。</p> 
<p><br><br><br> <img src="https://images2.imgbox.com/4c/db/8HLtTq56_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>Springboot2.x Oauth2实现：</p> 
<ul><li>Spring Security Oauth2 支持搭建授权服务器和资源服务器</li></ul> 
<p>Springboot3.x Oauth2实现：</p> 
<ul><li>Spring Security6 自身提供资源和客户端类库支持</li><li>Spring Authorization Server支持授权服务器搭建</li></ul> 
<p><br><br></p> 
<h2><a id="OAuth20_55"></a>OAuth2.0协议介绍</h2> 
<p>OAuth 2.0 （Open Authorization）是一种开放标准的授权协议，允许用户授权第三方应用访问其在某个服务提供者上的受保护资源，而无需将其实际的凭证（如用户名和密码）分享给第三方应用。</p> 
<p>这种方式可以增加安全性，同时允许用户更好地控制其数据的访问权限。</p> 
<p>OAuth2.0协议：https://datatracker.ietf.org/doc/html/rfc6749</p> 
<p><br><br></p> 
<h3><a id="_67"></a>角色</h3> 
<ul><li> <p><strong>客户端（client）</strong></p> <p>使用授权服务器作为认证渠道的平台，一般指的是第三方应用。</p> <p>例如，微信提供 OAuth 2.0 认证平台，我们的 APP 支持微信登录，那么我们的 APP 对于微信服务来说就是客户端。</p> <p>又例如，我们是政府某一平台的服务，我们平台维护的数据代表着足够高的权威，那么其他政府部门或合作方，需要从我们的平台中查询数据，或者利用我们平台的认证进行登录，那么其他部门或合作方的应用就是客户端。</p> </li><li> <p><strong>资源服务器（resource server）</strong></p> <p>简单的说，就是提供接口给客户端访问的服务器，访问资源服务器上受保护的接口，则需要带上令牌（token）。</p> <p>例如分布式微服务中的用户服务、订单服务等部署的服务器都属于资源服务器。</p> </li><li> <p><strong>资源所有者（resource owner）</strong></p> <p>拥有该资源的主体对象，一般指用户。</p> <p>客户端向资源服务器请求获取用户数据时，资源所有者参与确认授权或拒绝操作。</p> </li><li> <p><strong>授权服务器（authorization server）</strong></p> <p>对客户端和用户进行身份认证、授权的服务器，认证授权成功，则颁发令牌（token）。</p> </li></ul> 
<p><br><br></p> 
<p>举例，我在京东的网址上进行微信扫码登录，我手机扫码后需要点击确认按钮，进行登录。</p> 
<p><strong>客户端</strong>就是京东；<strong>资源所有者</strong>就是我，我微信扫描并点击确认；京东拿到我的授权信息进行申请token，<strong>授权服务器</strong>进行相应的身份认证后就给京东颁发token；京东就能拿到这个token去访问微信的<strong>资源服务器</strong>了。</p> 
<p><br><br></p> 
<h3><a id="OAuth20_107"></a>OAuth2.0协议的运行流程</h3> 
<p>OAuth 2.0的运行流程如下图，摘自<a href="https://datatracker.ietf.org/doc/html/rfc6749" rel="nofollow">RFC 6749</a>：</p> 
<p><img src="https://images2.imgbox.com/26/ef/pNG3HcYF_o.png" alt="在这里插入图片描述"></p> 
<p>（A）用户打开客户端以后，客户端要求用户给予授权。</p> 
<p>（B）用户同意给予客户端授权。</p> 
<p>（C）客户端使用上一步获得的授权，向授权服务器申请令牌。</p> 
<p>（D）授权服务器对客户端进行认证以后，确认无误，同意发放令牌。</p> 
<p>（E）客户端使用令牌，向资源服务器申请获取资源。</p> 
<p>（F）资源服务器确认令牌无误，同意向客户端开放资源。</p> 
<p><br><br></p> 
<blockquote> 
 <p>令牌（token）与密码（password）的作用是一样的，都可以进入系统，但是有三点差异。</p> 
 <p>（1）令牌是短期的，到期会自动失效，用户自己无法修改。密码一般长期有效，用户不修改，就不会发生变化。</p> 
 <p>（2）令牌可以被数据所有者撤销，会立即失效。密码一般不允许被他人撤销。</p> 
 <p>（3）令牌有权限范围（scope）。对于网络服务来说，只读令牌就比读写令牌更安全。密码一般是完整权限。</p> 
 <p>上面这些设计，保证了令牌既可以让第三方应用获得权限，同时又随时可控，不会危及系统安全。这就是 OAuth 2.0 的优点。</p> 
</blockquote> 
<p><br><br></p> 
<h3><a id="_147"></a>应用场景</h3> 
<p>OAuth 2.0 在许多不同的应用场景中都能够发挥作用，尤其是那些涉及到第三方应用程序访问用户数据或资源的情况。以下是一些常见的 OAuth 2.0 应用场景：</p> 
<ul><li><strong>社交媒体登录</strong>：许多网站和应用程序允许用户使用其社交媒体账户（如Facebook、Google、Twitter等）进行登录。OAuth 2.0 可以用于授权第三方应用访问用户的社交媒体数据，如好友列表、社交活动等。</li><li><strong>第三方应用集成</strong>：用户可能使用多个不同的应用和服务，例如电子邮件、日历、云存储等。OAuth 2.0 可以用于实现单一的登录授权，使用户能够在多个应用之间共享数据，而无需在每个应用中都输入凭证。</li><li><strong>移动应用访问 API</strong>：移动应用可能需要访问后端服务器上的受保护资源，例如用户数据或其他服务。OAuth 2.0 可以确保安全地进行授权和访问控制，同时减少对用户凭证的需求。</li><li><strong>授权访问云服务</strong>：当用户需要将他们的数据存储在云服务（如Google Drive、Dropbox）中时，OAuth 2.0 可以确保这些服务只能以授权的方式访问用户的数据。</li><li><strong>API 访问控制</strong>：企业和开发者可以使用 OAuth 2.0 来实现对其 API 的访问控制。只有经过授权的应用程序才能访问和使用这些 API。</li><li><strong>联合身份验证</strong>：在不同的身份提供者之间实现联合身份验证，使用户可以使用一个身份提供者的凭证来访问另一个身份提供者的资源。</li><li><strong>医疗保健应用</strong>：在医疗保健领域，患者的健康数据可能由多个医疗应用和机构共享。OAuth 2.0 可以用于确保授权的数据访问，同时保护患者隐私。</li><li><strong>IoT 设备访问</strong>：物联网设备可能需要访问云服务或其他资源。OAuth 2.0 可以用于在 IoT 设备和云之间实现安全的授权流程。</li></ul> 
<p>这些只是 OAuth 2.0 可能应用的一些例子。基本上，任何需要实现安全的第三方应用程序访问用户数据或资源的情况下，OAuth 2.0 都可能是一个合适的解决方案。</p> 
<p><br><br></p> 
<h3><a id="_172"></a>授权模式详解</h3> 
<p>客户端凭证模式：适合无用户参与的应用</p> 
<p>资源所有者密码模式：官方应用</p> 
<p>授权码模式：应用最广泛，适合web应用/app/前端</p> 
<p>刷新令牌模式：适合令牌访问过期后刷新令牌</p> 
<p><br><br></p> 
<h4><a id="_186"></a>客户端模式</h4> 
<p>客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向"服务提供商"进行授权。</p> 
<p>客户端模式是安全级别最低而且要求授权服务器对客户高度信任的模式，因为客户端向授权服务器请求认证授权的过程中，至始至终都没有用户的参与，未经过用户允许，客户端凭提供自己在授权服务器注册的信息即可在授权服务器完成认证授权，而客户端获得认证授权以后，则拥有从资源服务器操作用户数据的权限，这种模式一般应用于公司内部系统或者有着高度保密责任的合作伙伴之间的对接。</p> 
<p><img src="https://images2.imgbox.com/2e/e7/Qj609Epo_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>它的步骤如下：</p> 
<p>（A）客户端向授权服务器进行身份认证，并要求一个访问令牌。</p> 
<p>（B）授权服务器确认无误后，向客户端提供访问令牌。</p> 
<p><br><br></p> 
<p>客户端模式的时序图如下：</p> 
<p><img src="https://images2.imgbox.com/72/4f/8P9cyqkP_o.png" alt="在这里插入图片描述"></p> 
<ol><li>客户端首先在认证服务器注册好客户端信息。</li><li>认证服务器存储维护客户端信息。</li><li>客户端带上 client_id、client_secret、grant_type（写死client_credentials）等参数向认证服务器发起获取 token 请求。</li><li>认证服务器校验客户端信息，校验通过，则发放令牌（access_token），校验失败，则返回异常信息。</li><li>客户端成功获取到令牌（access_token）后，就可以带着令牌去访问资源服务器了。</li></ol> 
<p><br><br></p> 
<p><strong>实现效果</strong></p> 
<ol><li> <p>A 应用在命令行向 B 发出请求。</p> <pre><code class="prism language-bash"><span class="token operator">&gt;</span> https://oauth.b.com/token?
<span class="token operator">&gt;</span>   <span class="token assign-left variable">grant_type</span><span class="token operator">=</span>client_credentials<span class="token operator">&amp;</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID<span class="token operator">&amp;</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">client_secret</span><span class="token operator">=</span>CLIENT_SECRET
</code></pre> </li><li> <p>B 网站验证通过以后，直接返回令牌。</p> <p><img src="https://images2.imgbox.com/37/07/gBRfLRo4_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<p><br><br></p> 
<h4><a id="_245"></a>密码模式</h4> 
<p>如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌，这种方式称为"密码模式"。</p> 
<p><strong>密码模式是一种安全级别较低而且要求资源拥有者（用户）完全信任客户端的模式</strong>，该模式可以理解为在客户端模式的基础上增加了对用户的账号、密码在认证服务器进行校验的操作，是客户端代理用户的操作。在 OAuth 2.1 中，密码模式已经被废除，在第三方平台上，使用密码模式，对于用户来说是一种非常不安全的行为，假设某平台客户端支持 QQ 登录，用户使用自己 QQ 的账号、密码在该平台上输入进行登录，则该平台将拥有用户 QQ 的账号、密码，对于用户来说，将自己 QQ 的账号、密码提供给第三方平台，这种行为是非常不安全的。</p> 
<p><strong>密码模式一般适合应用在自己公司内部使用的系统和自己公司的 app 产品</strong>，例如一些 ERP、CRM、WMS 系统，因为都是自己公司的产品，这种情况下就不存在用户提供账号、密码给第三方客户端进行代理登录的情形了。</p> 
<p><img src="https://images2.imgbox.com/47/d4/fgOsCly1_o.png" alt="在这里插入图片描述"></p> 
<p>它的步骤如下：</p> 
<p>（A）用户向客户端提供用户名和密码。</p> 
<p>（B）客户端将用户名和密码发给授权服务器，向后者请求令牌。</p> 
<p>（C）授权服务器确认无误后，向客户端提供访问令牌。</p> 
<p><br><br></p> 
<p>密码模式的时序图如下：</p> 
<p><img src="https://images2.imgbox.com/66/1e/HXhT340O_o.png" alt="在这里插入图片描述"></p> 
<p>1：客户端首先在认证服务器注册好客户端信息。</p> 
<p>2：认证服务器存储维护客户端信息。</p> 
<p>3：用户提供认证平台的账号、密码给客户端（这里的客户端可以是浏览器、APP、第三方应用的服务器）。</p> 
<p>4：客户端带上 client_id、client_secret、grant_type（写死password）、username、password 等参数向认证服务器发起获取 token 请求。</p> 
<p>5：认证服务器校验客户端信息，校验失败，则返回异常信息,校验通过，则往下继续校验用户验账号、密码。</p> 
<p>6：认证服务器校验用户账号、密码，校验通过，则发放令牌（access_token），校验失败，则返回异常信息。</p> 
<p>7：客户端成功获取到令牌（access_token）后，就可以带着令牌去访问资源服务器了。</p> 
<p><br><br></p> 
<p><strong>实现效果</strong></p> 
<ol><li> <p>A 网站要求用户提供 B 网站的用户名和密码，拿到以后，A 就直接向 B 请求令牌。整个过程中，客户端不得保存用户的密码。</p> <pre><code class="prism language-bash"><span class="token operator">&gt;</span> https://oauth.b.com/token?
<span class="token operator">&gt;</span>   <span class="token assign-left variable">grant_type</span><span class="token operator">=</span>password<span class="token operator">&amp;</span>       <span class="token comment"># 授权方式是"密码模式"</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">username</span><span class="token operator">=</span>USERNAME<span class="token operator">&amp;</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">password</span><span class="token operator">=</span>PASSWORD<span class="token operator">&amp;</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID
<span class="token operator">&gt;</span>   <span class="token assign-left variable">client_secret</span><span class="token operator">=</span>client_secret
</code></pre> </li><li> <p>B 网站验证身份通过后，直接给出令牌。注意，这时不需要跳转，而是把令牌放在 JSON 数据里面，作为 HTTP 回应，A 因此拿到令牌。</p> <p><img src="https://images2.imgbox.com/10/a2/AzQAbqv5_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<p><br><br></p> 
<h4><a id="_316"></a>授权码模式</h4> 
<p>授权码（authorization code）方式，指的是<strong>第三方应用先申请一个授权码，然后再用该授权码获取令牌。</strong></p> 
<p>授权码模式是 OAuth 2.0 协议中安全级别最高的一种认证模式，他与密码模式一样，都需要使用到用户的账号信息在认证平台的登录操作，但有所不同的是，密码模式是要求用户直接将自己在认证平台的账号、密码提供给第三方应用（客户端），由第三方平台进行代理用户在认证平台的登录操作；</p> 
<p>而授权码模式则是用户在认证平台提供的界面进行登录，然后通过用户确认授权后才将一次性授权码提供给第三方应用，第三方应用拿到一次性授权码以后才去认证平台获取 token。</p> 
<p>适用场景：目前市面上主流的第三方验证都是采用这种模式，比如在京东网址进行微信扫码登录，我扫码之后点击确认按钮</p> 
<p><img src="https://images2.imgbox.com/b3/90/zHUIJWBq_o.png" alt="在这里插入图片描述"></p> 
<p>它的步骤如下：</p> 
<p>（A）用户访问客户端，后者将前者导向授权服务器。</p> 
<p>（B）用户选择是否给予客户端授权。</p> 
<p>（C）假设用户给予授权，授权服务器将用户导向客户端事先指定的"重定向URI"（redirection URI），同时附上一个授权码。</p> 
<p>（D）客户端收到授权码，附上早先的"重定向URI"，向授权服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见。</p> 
<p>（E）授权服务器核对了授权码和重定向URI，确认无误后，向客户端发送访问令牌（access token）和更新令牌（refresh token）。</p> 
<p><br><br></p> 
<p>授权码模式的时序图如下：</p> 
<p><img src="https://images2.imgbox.com/7e/32/XrCbDnUW_o.png" alt="在这里插入图片描述"></p> 
<p>1：客户端首先在认证服务器注册好客户端信息。</p> 
<p>2：认证服务器存储维护客户端信息。</p> 
<p>3：用户在客户端上发起登录。</p> 
<p>4：向认证服务器发起认证授权请求，例如http://localhost:9000/auth/oauth/authorize?client_id=xxx&amp;response_type=code&amp;scope=message.read&amp;redirect_uri=http://www.baidu.com，注意，此时参数不需要client_secret。</p> 
<p>5：认证服务器带上客户端参数，将操作引导至用户授权确认页面，用户在该页面进行授权确认操作。</p> 
<p>6：用户在授权页面选择授权范围，点击确认提交，则带上客户端参数和用户授权范围向认证服务器获取授权码。注意，此处操作已经脱离了客户端。</p> 
<p>7：认证服务器校验客户端信息和授权范围（因为客户端在认证平台注册的时候，注册信息包含授权范围，如果用户选择的授权范围不在注册信息包含的范围内，则将因权限不足返回失败）。</p> 
<p>8：校验通过，将授权码拼接到客户端注册的回调地址返回给客户端。</p> 
<p>9：客户端拿到认证服务器返回的授权码后，带上客户端信息和授权码向认证服务器换取令牌（access_token）。</p> 
<p>10：认证服务器校验授权码是否有效，如果有效，则返回令牌（access_token）；如果无效，则返回异常信息。</p> 
<p>11：客户端成功获取到令牌（access_token）后，就可以带着令牌去访问资源服务器了。</p> 
<p><br><br></p> 
<p><strong>实现效果</strong></p> 
<ol><li> <p>A网站提供一个链接，用户点击后就会跳转到 B 网站，授权用户数据给 A 网站使用。下面就是 A 网站跳转 B 网站的一个示意链接。</p> <pre><code class="prism language-bash"><span class="token operator">&gt;</span> https://b.com/oauth/authorize?
<span class="token operator">&gt;</span>   <span class="token assign-left variable">response_type</span><span class="token operator">=</span>code<span class="token operator">&amp;</span>            <span class="token comment">#要求返回授权码（code）</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID<span class="token operator">&amp;</span>           <span class="token comment">#让 B 知道是谁在请求   </span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>CALLBACK_URL<span class="token operator">&amp;</span>     <span class="token comment">#B 接受或拒绝请求后的跳转网址 </span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">scope</span><span class="token operator">=</span>read                       <span class="token comment"># 要求的授权范围（这里是只读）        </span>
<span class="token operator">&gt;</span>
</code></pre> <p>客户端申请授权的URI，包含以下参数：</p> 
  <ul><li>response_type：表示授权类型，必选项，此处的值固定为"code"</li><li>client_id：表示客户端的ID，必选项</li><li>redirect_uri：表示重定向URI，可选项</li><li>scope：表示申请的权限范围，可选项</li><li>state：表示客户端的当前状态，可以指定任意值，授权服务器会原封不动地返回这个值</li></ul> </li><li> <p>用户跳转后，B 网站会要求用户登录，然后询问是否同意给予 A 网站授权。用户表示同意，这时 B 网站就会跳回redirect_uri参数指定的网址。跳转时，会传回一个授权码，就像下面这样。</p> <pre><code class="prism language-bash"><span class="token operator">&gt;</span> https://a.com/callback?code<span class="token operator">=</span>AUTHORIZATION_CODE    <span class="token comment">#code参数就是授权码</span>
<span class="token operator">&gt;</span>
</code></pre> </li><li> <p>A 网站拿到授权码以后，就可以在后端，向 B 网站请求令牌。 用户不可见，服务端行为</p> <pre><code class="prism language-bash"><span class="token operator">&gt;</span> https://b.com/oauth/token?
<span class="token operator">&gt;</span>  <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID<span class="token operator">&amp;</span>
<span class="token operator">&gt;</span>  <span class="token assign-left variable">client_secret</span><span class="token operator">=</span>CLIENT_SECRET<span class="token operator">&amp;</span>    <span class="token comment"># client_id和client_secret用来让 B 确认 A 的身份,client_secret参数是保密的，因此只能在后端发请求</span>
<span class="token operator">&gt;</span>  <span class="token assign-left variable">grant_type</span><span class="token operator">=</span>authorization_code<span class="token operator">&amp;</span>   <span class="token comment"># 采用的授权方式是授权码</span>
<span class="token operator">&gt;</span>  <span class="token assign-left variable">code</span><span class="token operator">=</span>AUTHORIZATION_CODE<span class="token operator">&amp;</span>          <span class="token comment"># 上一步拿到的授权码</span>
<span class="token operator">&gt;</span>  <span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>CALLBACK_URL        <span class="token comment"># 令牌颁发后的回调网址    </span>
<span class="token operator">&gt;</span>
</code></pre> </li><li> <p>B 网站收到请求以后，就会颁发令牌。具体做法是向redirect_uri指定的网址，发送一段 JSON 数据。</p> <pre><code class="prism language-bash"> <span class="token punctuation">{<!-- --></span>    
   <span class="token string">"access_token"</span><span class="token builtin class-name">:</span><span class="token string">"ACCESS_TOKEN"</span>,     <span class="token comment"># 令牌</span>
   <span class="token string">"token_type"</span><span class="token builtin class-name">:</span><span class="token string">"bearer"</span>,
   <span class="token string">"expires_in"</span>:2592000,
   <span class="token string">"refresh_token"</span><span class="token builtin class-name">:</span><span class="token string">"REFRESH_TOKEN"</span>,
   <span class="token string">"scope"</span><span class="token builtin class-name">:</span><span class="token string">"read"</span>,
   <span class="token string">"uid"</span>:100101,
   <span class="token string">"info"</span>:<span class="token punctuation">{<!-- --></span><span class="token punctuation">..</span>.<span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p><br><br></p> 
<h4><a id="_436"></a>简化模式</h4> 
<p>简化模式（也叫隐式模式）是相对于授权码模式而言的，对授权码模式的交互做了一下简化，省去了客户端使用授权码去认证服务器换取令牌（access_token）的操作，即用户在代理页面选择授权范围提交授权确认后，认证服务器通过客户端注册的回调地址直接就给客户端返回令牌（access_token）了。</p> 
<p>这种方式把令牌直接传给前端，是很不安全的。因此，只能用于一些安全要求不高的场景，并且令牌的有效期必须非常短，通常就是会话期间（session）有效，浏览器关掉，令牌就失效了。</p> 
<p><img src="https://images2.imgbox.com/75/25/inTLbjb6_o.png" alt="在这里插入图片描述"></p> 
<p>它的步骤如下：</p> 
<p>（A）客户端将用户导向授权服务器。</p> 
<p>（B）用户决定是否给于客户端授权。</p> 
<p>（C）假设用户给予授权，授权服务器将用户导向客户端指定的"重定向URI"，并在URI的Hash部分包含了访问令牌。</p> 
<p>（D）浏览器向资源服务器发出请求，其中不包括上一步收到的Hash值。</p> 
<p>（E）资源服务器返回一个网页，其中包含的代码可以获取Hash值中的令牌。</p> 
<p>（F）浏览器执行上一步获得的脚本，提取出令牌。</p> 
<p>（G）浏览器将令牌发给客户端。</p> 
<p><br><br></p> 
<p>简化模式时序图如下：</p> 
<p><img src="https://images2.imgbox.com/2c/60/9TYxciDC_o.png" alt="在这里插入图片描述"></p> 
<p>1：客户端首先在认证服务器注册好客户端信息。</p> 
<p>2：认证服务器存储维护客户端信息。</p> 
<p>3：用户在客户端上发起登录。</p> 
<p>4：向认证服务器发起认证授权请求，例如http://localhost:9000/auth/oauth/authorize?client_id=xxx&amp;response_type=token&amp;scope=message.read&amp;redirect_uri=http://www.baidu.com，注意，此时参数不需要 client_secret。</p> 
<p>5：认证服务器带上客户端参数，将操作引导至用户授权确认页面，用户在该页面进行授权确认操作。</p> 
<p>6：用户在授权页面选择授权范围，点击确认提交，则带上客户端参数和用户授权范围向认证服务器获取令牌（access_token）。注意，此处操作已经脱离了客户端。</p> 
<p>7：认证服务器校验代理页面提交的参数信息，校验通过，则将令牌（access_token）拼接到客户端注册的回调地址返回给客户端；校验失败，则返回异常信息。</p> 
<p>8：客户端成功获取到令牌（access_token）后，就可以带着令牌去访问资源服务器了。</p> 
<p><br><br></p> 
<p><strong>实现效果</strong></p> 
<ol><li> <p>A 网站提供一个链接，要求用户跳转到 B 网站，授权用户数据给 A 网站使用。</p> <pre><code class="prism language-bash"><span class="token operator">&gt;</span> https://b.com/oauth/authorize?
<span class="token operator">&gt;</span>   <span class="token assign-left variable">response_type</span><span class="token operator">=</span>token<span class="token operator">&amp;</span>          <span class="token comment"># response_type参数为token，表示要求直接返回令牌</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID<span class="token operator">&amp;</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>CALLBACK_URL<span class="token operator">&amp;</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">scope</span><span class="token operator">=</span>read
<span class="token operator">&gt;</span>
</code></pre> </li><li> <p>用户跳转到 B 网站，登录后同意给予 A 网站授权。这时，B 网站就会跳回redirect_uri参数指定的跳转网址，并且把令牌作为 URL 参数，传给 A 网站。</p> <pre><code class="prism language-bash"><span class="token operator">&gt;</span> https://a.com/callback<span class="token comment">#token=ACCESS_TOKEN     #token参数就是令牌，A 网站直接在前端拿到令牌。</span>
<span class="token operator">&gt;</span>
</code></pre> </li></ol> 
<p><br><br></p> 
<h4><a id="token_516"></a>token刷新模式</h4> 
<p>令牌的有效期到了，如果让用户重新走一遍上面的流程，再申请一个新的令牌，很可能体验不好，而且也没有必要。OAuth 2.0 允许用户自动更新令牌。</p> 
<p>token刷新模式是对 access_token 过期的一种补办操作，这种补办操作，减少了用户重新操作登录的流程。</p> 
<p>OAuth 2.0 在给客户端颁发 access_token 的时候，同时也给客户端发放了 refresh_token，而 refresh_token 的有效期要远大于 access_token 的有效期。当客户端带着已过期的 access_token 去访问资源服务器中受保护的资源时，将会访问失败，此时就需要客户端使用 refresh_token 去获取新的 access_token。客户端端获取到新的 access_token 后，就可以带上他去访问资源服务器中受保护的资源了。</p> 
<p><img src="https://images2.imgbox.com/66/5c/Twdmad0Z_o.png" alt="在这里插入图片描述"><br> <br><br></p> 
<p>token 刷新模式时序图如下：</p> 
<p><img src="https://images2.imgbox.com/8b/6c/Oq5E3sYW_o.png" alt="在这里插入图片描述"></p> 
<p>1：客户端向认证服务器请求认证授权。</p> 
<p>2：认证服务器存返回 access_token、refresh_token、授权范围、过期时间。</p> 
<p>3：access_token 过期后，客户端仍旧带着过期的 access_token 去请求资源服务器中受保护的资源。</p> 
<p>4：资源服务器提示客户端，这是非法的 access_token。</p> 
<p>5：客户端使用 refresh_token 向认证服务器获取新的 access_token。</p> 
<p>6：认证服务器校验 refresh_token 的有效性，校验通过，则给客户端颁发新的 access_token；校验失败，则返回异常信息。</p> 
<p>7：客户端成功获取到新的 access_token 后，就可以带着新的 access_token 去访问资源服务器了。</p> 
<p><br><br></p> 
<p>具体方法是，B 网站颁发令牌的时候，一次性颁发两个令牌，一个用于获取数据，另一个用于获取新的令牌（refresh token 字段）。令牌到期前，用户使用 refresh token 发一个请求，去更新令牌。</p> 
<pre><code class="prism language-bash"><span class="token operator">&gt;</span> https://b.com/oauth/token?
<span class="token operator">&gt;</span>   <span class="token assign-left variable">grant_type</span><span class="token operator">=</span>refresh_token<span class="token operator">&amp;</span>    <span class="token comment"># grant_type参数为refresh_token表示要求更新令牌</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">client_id</span><span class="token operator">=</span>CLIENT_ID<span class="token operator">&amp;</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">client_secret</span><span class="token operator">=</span>CLIENT_SECRET<span class="token operator">&amp;</span>
<span class="token operator">&gt;</span>   <span class="token assign-left variable">refresh_token</span><span class="token operator">=</span>REFRESH_TOKEN    <span class="token comment"># 用于更新令牌的令牌</span>
<span class="token operator">&gt;</span>
</code></pre> 
<p><br><br></p> 
<p><img src="https://images2.imgbox.com/a9/64/jcwOJbUm_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h2><a id="OAuth_21__573"></a>OAuth 2.1 协议介绍</h2> 
<p>OAuth 2.1去掉了OAuth2.0中的密码模式、简化模式，增加了设备授权码模式，同时也对授权码模式增加了PKCE扩展。</p> 
<p>OAuth2.1协议 官网：https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-07</p> 
<p>OAuth 2.1 的变化 有道云笔记： https://note.youdao.com/s/DRnLx34U</p> 
<p><br><br></p> 
<h3><a id="PKCE_585"></a>授权码模式+PKCE扩展</h3> 
<p>在OAuth2.0版本的授权码的基础上，进行了扩展。下面的之前授权码模式的流程：</p> 
<p>（A）用户访问客户端，后者将前者导向授权服务器。</p> 
<p>（B）用户选择是否给予客户端授权。</p> 
<p>（C）假设用户给予授权，授权服务器将用户导向客户端事先指定的"重定向URI"（redirection URI），同时附上一个授权码。</p> 
<p>（D）客户端收到授权码，附上早先的"重定向URI"，向授权服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见。</p> 
<p>（E）授权服务器核对了授权码和重定向URI，确认无误后，向客户端发送访问令牌（access token）和更新令牌（refresh token）。</p> 
<p><br><br></p> 
<p>在步骤C，授权服务器通过重定向URL，将授权码Code发送给客户端，此时可能会被黑客拦截，他得到了code，他去利用code进行申请token，进而去访问资源服务器。</p> 
<p><br><br></p> 
<p>为了减轻这种攻击，官方增加PKCE扩展，先来看一下官方的交互图：</p> 
<p><img src="https://images2.imgbox.com/53/9d/IamhADP2_o.png" alt="在这里插入图片描述"></p> 
<p>A. 客户端通过“/oauth2/authorize”地址向认证服务器发起获取授权码请求的时候增加两个参数，即 <code>code_challenge</code> 和 <code>code_challenge_method</code>，其中，<code>code_challenge_method </code>是加密方法（例如：S256 或 plain），<code>code_challenge </code>是使用<code>code_challenge_method</code>加密方法加密后的值。</p> 
<p>B. 认证服务器给客户端返回授权码，同时记录下 <code>code_challenge</code>、<code>code_challenge_method</code> 的值。</p> 
<p>C. 客户端使用 code 向认证服务器获取 Access Token 的时候，带上 <code>code_verifier </code>参数，其值为步骤A加密前的初始值。</p> 
<p>D. 认证服务器收到步骤 C 的请求时，将 <code>code_verifier </code>的值使用 <code>code_challenge_method </code>的方法进行加密，然后将加密后的值与步骤A中的 <code>code_challenge </code>进行比较，看看是否一致。</p> 
<p><br><br></p> 
<p>上面交互过程中，恶意程序如果在B处截获授权码后，使用授权码向认证服务器换取 Access Token，但由于恶意程序没有 code_verifier 的值，因此在认证服务器无法校验通过，从而获取 Access Token 失败。</p> 
<p>对于如何创建 <code>code_challenge</code> 的值，官网给出了下面两种对应的方法。</p> 
<ul><li>plain code_challenge = code_verifier 0.3.0被废弃了</li><li>S256 code_challenge = BASE64URL-ENCODE(SHA256(ASCII(code_verifier)))</li></ul> 
<p><br><br></p> 
<h3><a id="_642"></a>设备授权码模式</h3> 
<p>了解即可，微服务安全方面暂时用不到该模式</p> 
<p>设备授权码模式，是一种为解决不便在当前设备上进行文本输入而提供的一种认证授权模式，例如：智能电视、媒体控制台、数字相框、打印机等。大家也可以脑补一下一些扫码登录的情形。使用设备授权码模式，有以下要求。</p> 
<p>(1) 该设备已连接到互联网。</p> 
<p>(2) 设备能够支持发出 HTTPS 请求。</p> 
<p>(3) 设备能够显示或以其他通信方式将 URI 和 Code 发给用户。</p> 
<p>(4) 用户有辅助设备(如个人电脑或智能手机)，他们可以从中处理请求。</p> 
<p>设备授权码登录官网交互图如下：</p> 
<p><img src="https://images2.imgbox.com/bc/9b/lndUaBTM_o.png" alt="在这里插入图片描述"></p> 
<p>(A) 客户端带上包含客户端信息的参数向认证服务器（地址：/oauth2/device_authorization）发起授权访问。</p> 
<p>(B) 认证服务器给客户端返回设备码、用户码及需要用户验证用户码的 URI。</p> 
<p>© 客户端指示用户需要在另一设备进行访问授权的URI和用户码。</p> 
<p>(D) 用户根据URI打开页面，输入用户码和确认授权，向认证服务器发起认证请求。</p> 
<p>(E) 客户端在完成步骤（C）之后就开始带上客户端信息和设备码向认证服务器轮询获取令牌信息。</p> 
<p>(F) 认证服务器收到客户端使用设备码获取令牌信息的请求后，检查用户是否已提交授权确认，如果用户已提交授权确认，则返回令牌信息。</p> 
<p><br><br></p> 
<p><img src="https://images2.imgbox.com/d7/3a/aVGNrkgn_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h3><a id="_686"></a>拓展授权模式</h3> 
<p>OAuth2.1 也提供拓展授权模式的操作实现。</p> 
<p>虽然 OAuth2.1 移除了密码模式（password），但是通过拓展授权模式可以实现密码模式。</p> 
<p>在实际应用中，客户端、授权服务器、资源服务器往往都是同一家公司的产品，那么这个时候，使用账号、密码进行登录的情形也比较常见，此时就需要通过拓展授权模式来实现账号、密码登录了。</p> 
<blockquote> 
 <p>拓展授权模式官网文档： https://docs.spring.io/spring-authorization-server/docs/current/reference/html/guides/how-to-ext-grant-type.html</p> 
</blockquote> 
<p><br><br></p> 
<h2><a id="OpenID_Connect_10_702"></a>OpenID Connect 1.0协议</h2> 
<p><a href="https://openid.net/specs/openid-connect-core-1_0.html" rel="nofollow">官方文档</a></p> 
<p>OpenID Connect 1.0 是 OAuth 2.0 协议之上的一个简单的身份层。其实就是<strong>客户端向认证服务器请求认证授权的时候，多返回一个 id_token</strong>，该 id_token 是一串使用 jwt 加密过的字符串，如下如所示</p> 
<p><img src="https://images2.imgbox.com/3c/d1/ijR8CF4Q_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h2><a id="Spring_Authorization_Server__716"></a>Spring Authorization Server 实战</h2> 
<p><strong>版本要求：</strong></p> 
<ul><li>Spring Authorization Server 版本：1.1.2</li><li>JDK 版本：17</li><li>Spring Boot 版本：3.1.4</li></ul> 
<p>Spring Authorization Server是建立在SpringSecurity的基础之上的</p> 
<p>Spring Authorization Server提供了 <code>OAuth 2.1</code> 和 <code>OpenID Connect 1.0</code> 规范以及其他相关规范的实现。</p> 
<p><br><br></p> 
<h3><a id="_734"></a>认证/授权服务器搭建</h3> 
<p><strong>Spring Authorization Server重要组件：</strong></p> 
<ul><li>SecurityFilterChain -&gt; authorizationServerSecurityFilterChain Spring Security的过滤器链，用于协议端点的。</li><li>SecurityFilterChain -&gt; defaultSecurityFilterChain Spring Security的过滤器链，用于Spring Security的身份认证</li><li>UserDetailsService 主要进行用户身份验证</li><li>RegisteredClientRepository 主要用于管理客户端</li><li>JWKSource 用于签名访问令牌</li><li>KeyPair 启动时生成的带有密钥的KeyPair实例，用于创建上面的JWKSource</li><li>JwtDecoder JwtDecoder的一个实例，用于解码已签名的访问令牌</li><li>AuthorizationServerSettings 用于配置Spring Authorization Server的AuthorizationServerSettings实例。</li></ul> 
<p><br><br></p> 
<h4><a id="_753"></a>搭建</h4> 
<p><strong>引入依赖</strong></p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-authorization-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>完整的pom.xml文件内容如下</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tuling<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>auth-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>auth-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>auth-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-authorization-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><br><br></p> 
<p><strong>yml配置文件</strong></p> 
<p>就指定一个服务端口、日志</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">org.springframework.security</span><span class="token punctuation">:</span> trace
</code></pre> 
<p><br><br></p> 
<p><strong>配置授权服务器</strong></p> 
<p>直接从<a href="https://docs.spring.io/spring-authorization-server/docs/1.1.2-SNAPSHOT/reference/html/getting-started.html" rel="nofollow">官网 配置文件</a>将 SecurityConfig 拷贝放到config下</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tuling<span class="token punctuation">.</span>authserver<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>jwk<span class="token punctuation">.</span></span><span class="token class-name">JWKSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>jwk<span class="token punctuation">.</span></span><span class="token class-name">RSAKey</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>jwk<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">ImmutableJWKSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>jwk<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">JWKSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>proc<span class="token punctuation">.</span></span><span class="token class-name">SecurityContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Order</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">Customizer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableWebSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationGrantType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">ClientAuthenticationMethod</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>core<span class="token punctuation">.</span>oidc<span class="token punctuation">.</span></span><span class="token class-name">OidcScopes</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span></span><span class="token class-name">JwtDecoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">InMemoryRegisteredClientRepository</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RegisteredClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RegisteredClientRepository</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AuthorizationServerConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AuthorizationServerConfigurer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>settings<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerSettings</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>settings<span class="token punctuation">.</span></span><span class="token class-name">ClientSettings</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>provisioning<span class="token punctuation">.</span></span><span class="token class-name">InMemoryUserDetailsManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">SecurityFilterChain</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">LoginUrlAuthenticationEntryPoint</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span><span class="token class-name">MediaTypeRequestMatcher</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">KeyPair</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">KeyPairGenerator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span></span><span class="token class-name">RSAPrivateKey</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span></span><span class="token class-name">RSAPublicKey</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>


<span class="token comment">/**
 * https://docs.spring.io/spring-authorization-server/docs/1.1.2-SNAPSHOT/reference/html/getting-started.html
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 *  Spring Authorization Server 相关配置
	 *  主要配置OAuth 2.1和OpenID Connect 1.0
	 * @param http
	 * @return
	 * @throws Exception
	 */</span>
	<span class="token annotation punctuation">@Bean</span> 
	<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">authorizationServerSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">OAuth2AuthorizationServerConfiguration</span><span class="token punctuation">.</span><span class="token function">applyDefaultSecurity</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
		http<span class="token punctuation">.</span><span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AuthorizationServerConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
			<span class="token comment">//开启OpenID Connect 1.0（其中oidc为OpenID Connect的缩写）</span>
			<span class="token punctuation">.</span><span class="token function">oidc</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// Enable OpenID Connect 1.0</span>
		http
			<span class="token comment">// Redirect to the login page when not authenticated from the</span>
			<span class="token comment">// authorization endpoint</span>
			<span class="token comment">//将需要认证的请求，重定向到login进行登录认证。</span>
			<span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">(</span>exceptions<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> exceptions
				<span class="token punctuation">.</span><span class="token function">defaultAuthenticationEntryPointFor</span><span class="token punctuation">(</span>
					<span class="token keyword">new</span> <span class="token class-name">LoginUrlAuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
					<span class="token keyword">new</span> <span class="token class-name">MediaTypeRequestMatcher</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">TEXT_HTML</span><span class="token punctuation">)</span>
				<span class="token punctuation">)</span>
			<span class="token punctuation">)</span>
			<span class="token comment">// Accept access tokens for User Info and/or Client Registration</span>
			<span class="token comment">// 使用jwt处理接收到的access token</span>
			<span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resourceServer<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> resourceServer
				<span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 *  Spring Security 过滤链配置（此处是纯Spring Security相关配置）
	 */</span>
	<span class="token annotation punctuation">@Bean</span> 
	<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">defaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
		http
			<span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authorize<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> authorize
				<span class="token comment">//设置所有请求都需要认证，未认证的请求都被重定向到login页面进行登录</span>
				<span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">)</span>
			<span class="token comment">// Form login handles the redirect to the login page from the</span>
			<span class="token comment">// authorization server filter chain</span>
			<span class="token comment">// 由Spring Security过滤链中UsernamePasswordAuthenticationFilter过滤器拦截处理“login”页面提交的登录信息。</span>
			<span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 *  Spring Security的配置
	 * 设置用户信息，校验用户名、密码
	 * 正常的流程是自定义一个service类，实现UserDetailsService接口，去查询DB 查询用户信息，封装为一个UserDetails对象返回
	 * 这里就直接写一个user存入内存中进行测试
	 * @return
	 */</span>
	<span class="token annotation punctuation">@Bean</span> 
	<span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">userDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">withDefaultPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token string">"hushang"</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//基于内存的用户数据校验</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 注册客户端信息
	 *
	 * 查询认证服务器信息
	 * http://127.0.0.1:9000/.well-known/openid-configuration
	 *
	 * 获取授权码
	 * http://localhost:9000/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=profile openid&amp;redirect_uri=http://www.baidu.com
	 *
	 * 正常的流程是存在一个web前端页面提供给客户端进行注册，然后后端接口会将客户端注册信息保存在DB中，然后去查询DB，最后封装为一个RegisteredClient
	 * 我这里就直接写一个客户端，存放在内存中进行测试
	 */</span>
	<span class="token annotation punctuation">@Bean</span> 
	<span class="token keyword">public</span> <span class="token class-name">RegisteredClientRepository</span> <span class="token function">registeredClientRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">RegisteredClient</span> oidcClient <span class="token operator">=</span> <span class="token class-name">RegisteredClient</span><span class="token punctuation">.</span><span class="token function">withId</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">clientId</span><span class="token punctuation">(</span><span class="token string">"oidc-client"</span><span class="token punctuation">)</span>
				<span class="token comment">//{noop}开头，表示“secret”以明文存储</span>
				<span class="token punctuation">.</span><span class="token function">clientSecret</span><span class="token punctuation">(</span><span class="token string">"{noop}secret"</span><span class="token punctuation">)</span>
				<span class="token comment">// 就使用默认的认证方式</span>
				<span class="token punctuation">.</span><span class="token function">clientAuthenticationMethod</span><span class="token punctuation">(</span><span class="token class-name">ClientAuthenticationMethod</span><span class="token punctuation">.</span><span class="token constant">CLIENT_SECRET_BASIC</span><span class="token punctuation">)</span>
				<span class="token comment">// 配置授权码模式,刷新令牌，客户端模式</span>
				<span class="token punctuation">.</span><span class="token function">authorizationGrantType</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationGrantType</span><span class="token punctuation">.</span><span class="token constant">AUTHORIZATION_CODE</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">authorizationGrantType</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationGrantType</span><span class="token punctuation">.</span><span class="token constant">REFRESH_TOKEN</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">authorizationGrantType</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationGrantType</span><span class="token punctuation">.</span><span class="token constant">CLIENT_CREDENTIALS</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">redirectUri</span><span class="token punctuation">(</span><span class="token string">"http://spring-oauth-client:9001/login/oauth2/code/messaging-client-oidc"</span><span class="token punctuation">)</span>
				<span class="token comment">//我们暂时还没有客户端服务，以免重定向跳转错误导致接收不到授权码</span>
				<span class="token punctuation">.</span><span class="token function">redirectUri</span><span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">postLogoutRedirectUri</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:8080/"</span><span class="token punctuation">)</span>
				<span class="token comment">//设置客户端权限范围</span>
				<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token class-name">OidcScopes</span><span class="token punctuation">.</span><span class="token constant">OPENID</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">scope</span><span class="token punctuation">(</span><span class="token class-name">OidcScopes</span><span class="token punctuation">.</span><span class="token constant">PROFILE</span><span class="token punctuation">)</span>
				<span class="token comment">//客户端设置用户需要确认授权</span>
				<span class="token punctuation">.</span><span class="token function">clientSettings</span><span class="token punctuation">(</span><span class="token class-name">ClientSettings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">requireAuthorizationConsent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">//配置基于内存的客户端信息</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryRegisteredClientRepository</span><span class="token punctuation">(</span>oidcClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 配置 JWK，为JWT(id_token)提供加密密钥，用于加密/解密或签名/验签
	 * JWK详细见：https://datatracker.ietf.org/doc/html/draft-ietf-jose-json-web-key-41
	 */</span>
	<span class="token annotation punctuation">@Bean</span> 
	<span class="token keyword">public</span> <span class="token class-name">JWKSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> <span class="token function">jwkSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">KeyPair</span> keyPair <span class="token operator">=</span> <span class="token function">generateRsaKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">RSAPublicKey</span> publicKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RSAPublicKey</span><span class="token punctuation">)</span> keyPair<span class="token punctuation">.</span><span class="token function">getPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">RSAPrivateKey</span> privateKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RSAPrivateKey</span><span class="token punctuation">)</span> keyPair<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">RSAKey</span> rsaKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RSAKey<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">privateKey</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">keyID</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">JWKSet</span> jwkSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JWKSet</span><span class="token punctuation">(</span>rsaKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableJWKSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>jwkSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 *  生成RSA密钥对，给上面jwkSource() 方法的提供密钥对
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">KeyPair</span> <span class="token function">generateRsaKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
		<span class="token class-name">KeyPair</span> keyPair<span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">KeyPairGenerator</span> keyPairGenerator <span class="token operator">=</span> <span class="token class-name">KeyPairGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"RSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			keyPairGenerator<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			keyPair <span class="token operator">=</span> keyPairGenerator<span class="token punctuation">.</span><span class="token function">generateKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> keyPair<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 配置jwt解析器
	 */</span>
	<span class="token annotation punctuation">@Bean</span> 
	<span class="token keyword">public</span> <span class="token class-name">JwtDecoder</span> <span class="token function">jwtDecoder</span><span class="token punctuation">(</span><span class="token class-name">JWKSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> jwkSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">OAuth2AuthorizationServerConfiguration</span><span class="token punctuation">.</span><span class="token function">jwtDecoder</span><span class="token punctuation">(</span>jwkSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/**
	 * 配置授权服务器请求地址
	 */</span>
	<span class="token annotation punctuation">@Bean</span> 
	<span class="token keyword">public</span> <span class="token class-name">AuthorizationServerSettings</span> <span class="token function">authorizationServerSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//什么都不配置，则使用默认地址</span>
		<span class="token keyword">return</span> <span class="token class-name">AuthorizationServerSettings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p><img src="https://images2.imgbox.com/56/fc/CahRdwrV_o.png" alt="在这里插入图片描述"></p> 
<p>至此，一个简单的认证授权服务端就搭建好了，该服务使用的端口是9000</p> 
<p>我们可以使用后面的url查询认证服务器信息,这里的<code>/.well-known/openid-configuration</code> 是依赖包内部提供 默认的访问路径</p> 
<p>http://127.0.0.1:9000/.well-known/openid-configuration</p> 
<p><br><br></p> 
<p>向授权服务器获取授权码，其中<code>/oauth2/authorize</code>也是内部提供的接口</p> 
<pre><code class="prism language-bash"><span class="token comment"># response_type=code 表示当前是授权码模式     </span>
<span class="token comment"># client_id、scope这两个请求参数要和客户端往授权服务器注册信息对应上，如果客户端注册时没有profile openid中的某一个，那么授权服务器就不会返回code</span>
<span class="token comment"># redirect_uri 重定向地址，也就是用户授权之后 code应该发给谁，目前我们还没有编写客户端的接口，所以这里就直接写百度，然后从浏览器拿code进行测试</span>
http://localhost:9000/oauth2/authorize?response_type<span class="token operator">=</span>code<span class="token operator">&amp;</span><span class="token assign-left variable">client_id</span><span class="token operator">=</span>oidc-client<span class="token operator">&amp;</span><span class="token assign-left variable">scope</span><span class="token operator">=</span>profile openid<span class="token operator">&amp;</span><span class="token assign-left variable">redirect_uri</span><span class="token operator">=</span>http://www.baidu.com
</code></pre> 
<p><br><br></p> 
<h4><a id="_1084"></a>授权码模式测试</h4> 
<p>使用 http://localhost:9000/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=profile openid&amp;redirect_uri=http://www.baidu.com 请求获取授权码，则跳转至下面登录页面。</p> 
<p><img src="https://images2.imgbox.com/bc/94/8e3TLo8X_o.png" alt="在这里插入图片描述"></p> 
<p>输入我们上面配置文件中配置的User，用户名：hushang，密码：123456，则跳转至授权页面</p> 
<p><br><br><br> <img src="https://images2.imgbox.com/90/2f/mhH6UWMY_o.png" alt="在这里插入图片描述"></p> 
<p>勾选授权信息<code>profile</code>复选框，点击<code>Submit Consent</code>提交按钮，则返回如下结果</p> 
<p><img src="https://images2.imgbox.com/fc/4f/weFlS3E0_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>从浏览器地址栏中，我们看到授权服务器已经返回了授权码 code，接下来，我们使用授权 code 向http://localhost:9000/oauth2/token地址请求获取令牌。</p> 
<p><strong>postman测试</strong>，</p> 
<p>需要带上client_id和client_secret，这两个请求参数也需要和客户端往授权服务器注册时的内容对应上</p> 
<p><img src="https://images2.imgbox.com/79/06/o94Udthw_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p><img src="https://images2.imgbox.com/79/ac/yPwKrh6w_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>在请求体中添加我们上一步获取到的code</p> 
<p><img src="https://images2.imgbox.com/b7/90/zAU7Nu7g_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>请求体中指定的授权码模式，也是需要和客户端往授权服务器注册时的内容对应上</p> 
<p><br><br></p> 
<p><img src="https://images2.imgbox.com/45/64/8L1mTaor_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h4><a id="_1148"></a>刷新令牌测试</h4> 
<p>当token过期后，我们使用授权服务器返回的refresh_toke去进行刷新token</p> 
<p>测试http://localhost:9000/oauth2/token 地址，参数授权类型 grant_type 的值改为 refresh_token，传入授权码模式返回的 refresh_token</p> 
<p><img src="https://images2.imgbox.com/63/aa/O3LTELvy_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h4><a id="_1166"></a>客户端模式测试</h4> 
<p>客户端模式就比授权码模式要简单</p> 
<p>带上client_id,client_secret,指定客户端模式grant_type为client_credentials，访问http://localhost:9000/oauth2/token</p> 
<p><img src="https://images2.imgbox.com/29/ad/tdMfPpUS_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h3><a id="oauth2_1182"></a>oauth2客户端搭建</h3> 
<h4><a id="_1184"></a>说明</h4> 
<p><strong>客户端的主要职责是识别用户操作是否有身份认证，已认证，则放行，未认证，则拒绝或引导到认证服务器进行认证。</strong></p> 
<p>前面我们介绍了授权服务器的搭建，由于我们没有自己的客户端回调地址，在测试过程中，我们是使用http://www.baidu.com作为回调地址，获取到授权码code后，再使用postman去获取令牌信息的。</p> 
<p>接下来，我们将搭建自己的客户端，实现连贯的令牌获取操作， 操作流程如下：</p> 
<p><img src="https://images2.imgbox.com/63/cc/W8u2lZNk_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>假设我们公司的web平台产品支持微信登录，那么对于微信平台来说，我们的web平台就是客户端（第三方），那么，首先我们就得需要在微信开发者平台中注册客户端信息，例如：申请客户端id（client_id，微信平台叫appId）、密钥（secret）、配置授权码回调地址等。</p> 
<p>前面我们搭建的授权服务器就类似微信平台的授权服务器，接下来要搭建的客户端auth-client就类似公司的web平台。</p> 
<p><br><br></p> 
<h4><a id="_1206"></a>搭建客户端</h4> 
<p>因为我是在同一台机器上进行启动客户端和认证授权服务器的，ip都是127.0.0.1，在ip相同的情况下，会出现cookie覆盖的情形，这会导致认证服务器重定向到客户端地址时会出现[authorization_request_not_found]异常，为解决这个问题，可以在C:\Windows\System32\drivers\etc目录下的hosts文件添加了一行IP域名映射</p> 
<pre><code class="prism language-bash"><span class="token number">127.0</span>.0.1      spring-oauth-server 	spring-oauth-client
</code></pre> 
<p><br><br></p> 
<p><strong>Spring Security OAuth2 Client组件介绍：</strong></p> 
<ul><li>ClientRegistration 注册的客户端</li><li>ClientRegistrationRepository ClientRegistration的存储仓库</li><li>OAuth2AuthorizedClient 已授权过的客户端</li><li>OAuth2AuthorizedClientRepository 已授权过的客户端存储库持久化</li><li>OAuth2AuthorizationRequestRedirectFilter 该过滤器处理 /oauth2/authorization 路径，转发给 认证中心 对应的路径 /oauth2/authorize</li><li>OAuth2AuthorizationCodeGrantFilter 负责处理 认证中心 的授权码回调请求，如地址重定向</li><li>OAuth2LoginAuthenticationFilter 处理第三方认证的回调(该回调有授权码)，拿着授权码到第三方认证服务器获取access_token和refresh_token</li></ul> 
<p><br><br></p> 
<p><strong>引入依赖</strong></p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--spring-boot-starter-oauth2-client--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--spring-boot-starter-web--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>完整是pom.xml文件</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
	<span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tuling<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>auth-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>auth-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>auth-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>

		<span class="token comment">&lt;!--spring-boot-starter-oauth2-client--&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
		<span class="token comment">&lt;!--spring-boot-starter-web--&gt;</span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><br><br></p> 
<p>yml配置文件中的配置，注意我授权服务器使用的是9000端口，客户端使用的是9001端口</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9001</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">org.springframework.security</span><span class="token punctuation">:</span> trace

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> auth<span class="token punctuation">-</span>client
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">provider</span><span class="token punctuation">:</span>
          <span class="token comment">#认证服务器信息，下面这个string可以自定义，但是要和下方messaging-client-oidc.provider的对应上</span>
          <span class="token key atrule">oauth-server</span><span class="token punctuation">:</span>
            <span class="token comment">#授权地址</span>
            <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>server<span class="token punctuation">:</span><span class="token number">9000</span>
            <span class="token key atrule">authorizationUri</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.security.oauth2.client.provider.oauth<span class="token punctuation">-</span>server.issuer<span class="token punctuation">-</span>uri<span class="token punctuation">}</span>/oauth2/authorize
            <span class="token comment">#令牌获取地址</span>
            <span class="token key atrule">tokenUri</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.security.oauth2.client.provider.oauth<span class="token punctuation">-</span>server.issuer<span class="token punctuation">-</span>uri<span class="token punctuation">}</span>/oauth2/token
        <span class="token key atrule">registration</span><span class="token punctuation">:</span>
          <span class="token comment"># 下面这个string可以自定义，这里自定义的要和最下面redirect-uri的最后一个请求地址对应上</span>
          <span class="token key atrule">messaging-client-oidc</span><span class="token punctuation">:</span>
            <span class="token comment">#认证提供者，标识由哪个认证服务器进行认证，和上面的oauth-server进行关联</span>
            <span class="token key atrule">provider</span><span class="token punctuation">:</span> oauth<span class="token punctuation">-</span>server
            <span class="token comment">#客户端名称</span>
            <span class="token key atrule">client-name</span><span class="token punctuation">:</span> web平台
            <span class="token comment">#客户端id，从认证平台申请的客户端id</span>
            <span class="token key atrule">client-id</span><span class="token punctuation">:</span> oidc<span class="token punctuation">-</span>client
            <span class="token comment">#客户端秘钥</span>
            <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> secret
            <span class="token comment">#客户端认证方式</span>
            <span class="token key atrule">client-authentication-method</span><span class="token punctuation">:</span> client_secret_basic
            <span class="token comment">#使用授权码模式获取令牌（token）</span>
            <span class="token key atrule">authorization-grant-type</span><span class="token punctuation">:</span> authorization_code
            <span class="token comment">#回调地址，接收认证服务器回传code的接口地址，之前我们是使用http://www.baidu.com代替</span>
            <span class="token comment"># /login/oauth2/code/messaging-client-oidc 这个接口是使用的oauth2-client依赖默认提供的接口</span>
            <span class="token comment"># 这里最后的messaging-client-oidc 需要和上方我们自定义是string对应上</span>
            <span class="token comment"># 该接口会收到code授权码之后，会去调用授权服务器获取token，</span>
            <span class="token comment"># 也就是我们上方配置的${spring.security.oauth2.client.provider.oauth-server.tokenUri}</span>
            <span class="token comment"># 也可以使用自定义的接口，只不过需要我们自己拿到code之后再去调用资源服务器获取token</span>
            <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>client<span class="token punctuation">:</span>9001/login/oauth2/code/messaging<span class="token punctuation">-</span>client<span class="token punctuation">-</span>oidc
            <span class="token key atrule">scope</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> profile
              <span class="token punctuation">-</span> openid

</code></pre> 
<p><br><br></p> 
<p>我们上面配置的信息，需要和授权服务器进行客户端注册时的信息匹配上。当然，下图右边只是模拟的一个客户端注册信息，真实的情况下是客户端先进行注册，客户端的注册信息是保存在DB中的，我这里就直接模拟的一个客户端注册信息保存在内存中。</p> 
<p><img src="https://images2.imgbox.com/67/a5/ttQTzWTP_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p><strong>新建测试类</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2AuthorizedClient</span> <span class="token function">token</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RegisteredOAuth2AuthorizedClient</span> <span class="token class-name">OAuth2AuthorizedClient</span> oAuth2AuthorizedClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//通过OAuth2AuthorizedClient对象获取到客户端和token令牌相关的信息，然后直接返回给前端页面</span>
        <span class="token keyword">return</span> oAuth2AuthorizedClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<h4><a id="_1396"></a>客户端测试</h4> 
<p>启动认证服务器和客户端服务，浏览器输入http://spring-oauth-client:9001/token地址发起接口访问。此时我们会看到，浏览器地址被重定向到认证服务器http://spring-oauth-server:9000/login中被要求进行登录</p> 
<p><img src="https://images2.imgbox.com/85/cf/FlVMZal5_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>输入用户在认证服务器的用户名：hushang，密码：123456，则跳转到认证服务器授权页面</p> 
<p><br><br></p> 
<p><img src="https://images2.imgbox.com/16/6c/182uCe2p_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>勾选授权信息profile，点击提交按钮，则返回如下结果</p> 
<p>此时我们看到了浏览器中的地址为http://spring-oauth-client:9001/token?continue，且返回了客户端及token信息。也看到了认证服务器将授权码拼接到了回调地址http://spring-oauth-client:9001/login/oauth2/code/messaging-client-oidc中传给客户端。</p> 
<p><br><br><br> <img src="https://images2.imgbox.com/04/b1/MKIPxAxQ_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>详情</p> 
<p><img src="https://images2.imgbox.com/b6/38/MVj2xKOt_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>在看看请求</p> 
<p><img src="https://images2.imgbox.com/39/16/IosgYDyK_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/99/bf/FVVuKPpP_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>我们来看看<code>@RegisteredOAuth2AuthorizedClient OAuth2AuthorizedClient</code>对象中的详细信息</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/token"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2AuthorizedClient</span> <span class="token function">token</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RegisteredOAuth2AuthorizedClient</span> <span class="token class-name">OAuth2AuthorizedClient</span> oAuth2AuthorizedClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//通过OAuth2AuthorizedClient对象获取到客户端和token令牌相关的信息，然后直接返回给前端页面</span>
        <span class="token keyword">return</span> oAuth2AuthorizedClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"clientRegistration"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"registrationId"</span><span class="token operator">:</span> <span class="token string">"messaging-client-oidc"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"clientId"</span><span class="token operator">:</span> <span class="token string">"oidc-client"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"clientSecret"</span><span class="token operator">:</span> <span class="token string">"secret"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"clientAuthenticationMethod"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"client_secret_basic"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"authorizationGrantType"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"authorization_code"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"redirectUri"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-client:9001/login/oauth2/code/messaging-client-oidc"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"scopes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"profile"</span><span class="token punctuation">,</span>
      <span class="token string">"openid"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"providerDetails"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"authorizationUri"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/oauth2/authorize"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"tokenUri"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/oauth2/token"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"userInfoEndpoint"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"uri"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/userinfo"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"authenticationMethod"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"header"</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"userNameAttributeName"</span><span class="token operator">:</span> <span class="token string">"sub"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"jwkSetUri"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/oauth2/jwks"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"issuerUri"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"configurationMetadata"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"authorization_endpoint"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/oauth2/authorize"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"token_endpoint"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/oauth2/token"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"introspection_endpoint"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/oauth2/introspect"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"revocation_endpoint"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/oauth2/revoke"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"device_authorization_endpoint"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/oauth2/device_authorization"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"issuer"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"jwks_uri"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/oauth2/jwks"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"scopes_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"openid"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"response_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"code"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"grant_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"authorization_code"</span><span class="token punctuation">,</span>
          <span class="token string">"client_credentials"</span><span class="token punctuation">,</span>
          <span class="token string">"refresh_token"</span><span class="token punctuation">,</span>
          <span class="token string">"urn:ietf:params:oauth:grant-type:device_code"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"token_endpoint_auth_methods_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"client_secret_basic"</span><span class="token punctuation">,</span>
          <span class="token string">"client_secret_post"</span><span class="token punctuation">,</span>
          <span class="token string">"client_secret_jwt"</span><span class="token punctuation">,</span>
          <span class="token string">"private_key_jwt"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"introspection_endpoint_auth_methods_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"client_secret_basic"</span><span class="token punctuation">,</span>
          <span class="token string">"client_secret_post"</span><span class="token punctuation">,</span>
          <span class="token string">"client_secret_jwt"</span><span class="token punctuation">,</span>
          <span class="token string">"private_key_jwt"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"revocation_endpoint_auth_methods_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"client_secret_basic"</span><span class="token punctuation">,</span>
          <span class="token string">"client_secret_post"</span><span class="token punctuation">,</span>
          <span class="token string">"client_secret_jwt"</span><span class="token punctuation">,</span>
          <span class="token string">"private_key_jwt"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"request_uri_parameter_supported"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string-property property">"subject_types_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"public"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string-property property">"userinfo_endpoint"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/userinfo"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"end_session_endpoint"</span><span class="token operator">:</span> <span class="token string">"http://spring-oauth-server:9000/connect/logout"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"id_token_signing_alg_values_supported"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"RS256"</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"clientName"</span><span class="token operator">:</span> <span class="token string">"web平台"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"principalName"</span><span class="token operator">:</span> <span class="token string">"hushang"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"accessToken"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"tokenValue"</span><span class="token operator">:</span> <span class="token string">"eyJraWQiOiIwZDM2OWM5OS1lODNlLTQ4ZDktOWExYS1mNGI2OTM5YTIyODQiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJodXNoYW5nIiwiYXVkIjoib2lkYy1jbGllbnQiLCJuYmYiOjE3MjE3MDM4NTcsInNjb3BlIjpbIm9wZW5pZCIsInByb2ZpbGUiXSwiaXNzIjoiaHR0cDovL3NwcmluZy1vYXV0aC1zZXJ2ZXI6OTAwMCIsImV4cCI6MTcyMTcwNDE1NywiaWF0IjoxNzIxNzAzODU3fQ.Cqu2SLMqSPxuguj_t0hQ3EHwvxEl9Mp_4TN9Xrb1_I9EeKQ4ZjPi0WmqHjSHZfOo0esVNJQHBr15OfS6wu_x0pVbWKh8vA8fnbDe51dUTg0p3kLPOJdnPMPlGqbSn0UUE1c99GFYSnoYvhLF90ZpqmC4c3W00GqfT3f0q9tzc142BYKCGfPqQ-erkqSizSN186ZipttqZlMIQMdGUFjs_NL9qMfMgVLvAcTwCMOafHRJKY2UcPf7qvfk_EhltH1vy3i-f6s150RaJMX1nK90x7_tL-JWdz2AVzxiFyycW0p1E2I86MeQ4aBb4iG1Ty5zc9JQfMnePq9LoEFDw3uw2A"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"issuedAt"</span><span class="token operator">:</span> <span class="token string">"2024-07-23T03:04:17.191914800Z"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"expiresAt"</span><span class="token operator">:</span> <span class="token string">"2024-07-23T03:09:17.191914800Z"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"tokenType"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"value"</span><span class="token operator">:</span> <span class="token string">"Bearer"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"scopes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"openid"</span><span class="token punctuation">,</span>
      <span class="token string">"profile"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"refreshToken"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"tokenValue"</span><span class="token operator">:</span> <span class="token string">"kgVw7-0YDM-QhZ_sULqi62Wge20Kz00--Nw8j4g1Hc0G3wDUki4FRj-j24NiQ2uz3qEBmXLt_7_4D_SY3GPvRBEaNKfU_OWcRE0sKMO6xtMawKXl5Km7aviwTV5N3cbw"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"issuedAt"</span><span class="token operator">:</span> <span class="token string">"2024-07-23T03:04:17.191914800Z"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"expiresAt"</span><span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<h3><a id="oauth2_1570"></a>oauth2资源服务器搭建</h3> 
<h4><a id="_1572"></a>说明</h4> 
<p>资源服务器在分布式服务中就是指用户服务、商品服务、订单服务那些了，访问资源服务器中受保护的资源，都需要带上令牌（token）进行访问。</p> 
<p>资源服务器往往和客户端一起配合使用，<strong>客户端侧重于身份认证，资源服务器侧重于权限校验</strong>，如果在Spring Cloud（Alibaba）微服务架构中，可以将客户端框架spring-boot-starter-oauth2-client集成到网关服务上，将资源服务器框架spring-boot-starter-oauth2-resource-server集成到用户服务、商品服务、订单服务等微服务上。</p> 
<p>下面我们开始来搭建资源服务器。客户端、资源服务器交互时序图如下:</p> 
<p><img src="https://images2.imgbox.com/62/ea/KuyK2vTz_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h4><a id="_1590"></a>搭建资源服务器</h4> 
<p><strong>引入依赖</strong></p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--spring-boot-starter-oauth2-resource-server--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--spring-boot-starter-web--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>完整的pom.xml文件</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tuling<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!--spring-boot-starter-oauth2-resource-server--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--spring-boot-starter-web--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<p><br><br></p> 
<p><strong>配置application.yml</strong></p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9002</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">org.springframework.security</span><span class="token punctuation">:</span> trace

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> resource<span class="token punctuation">-</span>server
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">resource-server</span><span class="token punctuation">:</span>
        <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
		  <span class="token comment"># 资源服务器获取到token之后要去授权服务器进行解析token</span>
          <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>server<span class="token punctuation">:</span><span class="token number">9000</span>
</code></pre> 
<p><br><br></p> 
<p><strong>配置Spring Security</strong></p> 
<pre><code class="prism language-java"><span class="token comment">// 配置所有的请求都需要认证，权限方法就没有在配置类中进行配置了，直接使用注解的方式配置在接口上，所以下面就加上了@EnableMethodSecurity注解</span>
<span class="token comment">// 其实这里就是SpringSecurity的配置</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableMethodSecurity</span><span class="token punctuation">(</span>jsr250Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

        http<span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authorizeHttpRequests<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> authorizeHttpRequests
                        <span class="token comment">//所有的访问都需要通过身份认证</span>
                        <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            	<span class="token comment">// 使用jwt处理接收到的access token</span>
                <span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oauth2ResourceServer<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> oauth2ResourceServer
                        <span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p><strong>添加测试接口类</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MessagesController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/messages1"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessages1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">" hello Message 1"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/messages2"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('SCOPE_profile')"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessages2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">" hello Message 2"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/messages3"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('SCOPE_Message')"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessages3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">" hello Message 3"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/messages4"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAuthority('ROLE_USER')"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMessages4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">" hello Message 4"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 由于接口资源地址没有在Spring Security配置中放开，因此三个接口访问都需要传入accessToken。其中，messages1接口的要求只需传入accessToken，messages2接口要求传入accessToken和拥有profile权限，messages3接口要求传入accessToken和拥有Message权限</span>
<span class="token comment">// 而message4接口是新增的一个，试试用户的这个权限访问结果</span>
</code></pre> 
<p><br><br></p> 
<h4><a id="_1776"></a>资源服务器测试</h4> 
<p>postman直接访问http://localhost:9002/messages1地址，不带token，则返回如下401结果。</p> 
<p><img src="https://images2.imgbox.com/fa/22/XdTWnKI0_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>使用http://spring-oauth-client:9001/token地址，向客户端发起请求，获取token</p> 
<p><img src="https://images2.imgbox.com/89/30/gxh4DjJm_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>然后请求http://localhost:9002/messages1地址，带上accessToken，则返回如下成功结果</p> 
<p><img src="https://images2.imgbox.com/a4/a6/HiaRoJvx_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>再请求http://localhost:9002/messages2地址，带上accessToken，同样返回成功，结果如下</p> 
<p><img src="https://images2.imgbox.com/93/a2/jYnehexB_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>再请求http://localhost:9002/messages3地址，带上accessToken，则返回403了，因为我当前accessToken没有Message权限，结果如下</p> 
<p>错误提示：需要比请求更高的权限</p> 
<p><img src="https://images2.imgbox.com/e8/36/cMdWwkGq_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>访问message4接口也是一样的错误，所以这里只是校验客户端token的scope，不是校验具体登录用户的权限</p> 
<p><img src="https://images2.imgbox.com/b9/97/ZDXI5Rkx_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h4><a id="_1854"></a>自定义异常处理类</h4> 
<p>在 Spring Authorization Server 的过滤链中有一个叫 ExceptionTranslationFilter 的过滤器，在认证或授权过程中，如果出现 AuthenticationException（认证异常）和 AccessDeniedException（授权异常），都由 ExceptionTranslationFilter 过滤器捕获进行处理。</p> 
<p>ExceptionTranslationFilter 会处理捕获到的 AuthenticationException 或 AccessDeniedException异常。</p> 
<pre><code class="prism language-java"><span class="token comment">// ExceptionTranslationFilter#handleSpringSecurityException</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleSpringSecurityException</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>
                                           <span class="token class-name">FilterChain</span> chain<span class="token punctuation">,</span> <span class="token class-name">RuntimeException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 认证异常</span>
        <span class="token function">handleAuthenticationException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 授权异常</span>
        <span class="token function">handleAccessDeniedException</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">)</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>如果我们要自定义对AuthenticationException、AccessDeniedException 异常的处理，那么我们就需自定义<code>AuthenticationEntryPoint</code>、<code>AccessDeniedException</code> 的实现类，然后将自定义的异常实现类设置到配置中去。</p> 
<p>我们可以通过 <code>accessDeniedHandler(AccessDeniedHandler accessDeniedHandler)</code>、<code>authenticationEntryPoint(AuthenticationEntryPoint authenticationEntryPoint)</code> 方法，将自定义的异常设置到配置中去。</p> 
<p><br><br></p> 
<p><strong>具体自定义的类如下</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Getter</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">ResultCodeEnum</span> <span class="token punctuation">{<!-- --></span>

    <span class="token function">SUCCESS</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">"成功"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">FAIL</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">,</span> <span class="token string">"失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ResultCodeEnum</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>tuling<span class="token punctuation">.</span>resourceserver<span class="token punctuation">.</span>exception</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>shaded<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token class-name">Gson</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AuthenticationException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">AccessDeniedException</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 状态码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 返回信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 数据
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token class-name">T</span> body<span class="token punctuation">,</span> <span class="token class-name">ResultCodeEnum</span> resultCodeEnum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//封装数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            result<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//状态码</span>
        result<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>resultCodeEnum<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//返回信息</span>
        result<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>resultCodeEnum<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token class-name">ResultCodeEnum</span><span class="token punctuation">.</span><span class="token constant">FAIL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">code</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exceptionResponse</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">OAuth2AuthenticationException</span> o<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            message <span class="token operator">=</span> o<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            message <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">exceptionResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">exceptionResponse</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AccessDeniedException</span><span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">ResponseResult</span> responseResult <span class="token operator">=</span> <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> jsonResult <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>responseResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token constant">SC_OK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">APPLICATION_JSON_UTF8_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>jsonResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">InsufficientAuthenticationException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>resource<span class="token punctuation">.</span></span><span class="token class-name">InvalidBearerTokenException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationEntryPoint</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">LoginUrlAuthenticationEntryPoint</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 自定义AuthenticationEntryPoint
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAuthenticationEntryPoint</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationEntryPoint</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commence</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> authException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>authException <span class="token keyword">instanceof</span> <span class="token class-name">InsufficientAuthenticationException</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> accept <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>accept<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">TEXT_HTML_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果是html请求类型，则返回登录页</span>
                <span class="token class-name">LoginUrlAuthenticationEntryPoint</span> loginUrlAuthenticationEntryPoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginUrlAuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                loginUrlAuthenticationEntryPoint<span class="token punctuation">.</span><span class="token function">commence</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>response<span class="token punctuation">,</span>authException<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//如果是api请求类型，则返回json</span>
                <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">exceptionResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span><span class="token string">"需要带上令牌进行访问"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>authException <span class="token keyword">instanceof</span> <span class="token class-name">InvalidBearerTokenException</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">exceptionResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span><span class="token string">"令牌无效或已过期"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">exceptionResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span>authException<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span><span class="token class-name">AccessDeniedException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">AbstractOAuth2TokenAuthenticationToken</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span><span class="token class-name">AccessDeniedHandler</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 自定义AccessDeniedHandler
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyAccessDeniedHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AccessDeniedHandler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AccessDeniedException</span> accessDeniedException<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">AbstractOAuth2TokenAuthenticationToken</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">exceptionResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span><span class="token string">"权限不足"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ResponseResult</span><span class="token punctuation">.</span><span class="token function">exceptionResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span>accessDeniedException<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p><strong>SecurityConfig 中配置异常处理的类</strong></p> 
<p>之前的配置项</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

    http<span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authorizeHttpRequests<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> authorizeHttpRequests
                               <span class="token comment">//所有的访问都需要通过身份认证</span>
                               <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                              <span class="token punctuation">)</span>
		<span class="token comment">// 使用jwt处理接收到的access token</span>
        <span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oauth2ResourceServer<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> oauth2ResourceServer
                              <span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                             <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>现在的配置</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

    http<span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authorizeHttpRequests<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> authorizeHttpRequests
                               <span class="token comment">//所有的访问都需要通过身份认证</span>
                               <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                              <span class="token punctuation">)</span>
        <span class="token comment">// 使用jwt处理接收到的access token</span>
        <span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oauth2ResourceServer<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> oauth2ResourceServer
                              <span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                              <span class="token comment">// 自定义异常处理类</span>
                              <span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyAuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                              <span class="token punctuation">.</span><span class="token function">accessDeniedHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyAccessDeniedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                             <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p>测试</p> 
<p><img src="https://images2.imgbox.com/74/54/yorrWDWy_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p><img src="https://images2.imgbox.com/94/60/BcsUXZJw_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p><img src="https://images2.imgbox.com/a1/34/Vilp8Jc7_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h3><a id="_2152"></a>基于数据库存储改造授权服务器</h3> 
<h4><a id="_2154"></a>客户端注册信息存储改造</h4> 
<p><strong>引入依赖</strong></p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span> <span class="token comment">&lt;!-- lookup parent from repository --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tuling<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>auth-server-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>auth-server-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>auth-server-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!--Spring Authorization Server--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-authorization-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--lombok--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--mysql--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- mybatis-plus 3.5.3及以上版本 才支持 spring boot 3--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 添加spring security cas支持 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-cas<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<p>注意：这里需添加 spring-security-cas 依赖，否则启动时报 java.lang.ClassNotFoundException: org.springframework.security.cas.jackson2.CasJackson2Module 错误。</p> 
<p><br><br></p> 
<p><strong>准备sql脚本，创建oauth-server数据库</strong></p> 
<p>在上面的认证过程中，客户端信息是基于内存的，写死在代码中，现在我们将他改造从数据库中读取。</p> 
<p>我们在<code> org.springframework.security.oauth2.server.authorization</code> 包下，可以看到 oauth2-registered-client-schema.sql、oauth2-authorization-consent-schema.sql、oauth2-authorization-schema.sql 三个 sql 文件。</p> 
<p><img src="https://images2.imgbox.com/8f/56/xUeiW68s_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>新建 mysql 数据库 oauth-server，执行下面的 sql 语句。</p> 
<pre><code class="prism language-sql"><span class="token comment">/**
 * 客户端信息表
 */</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> oauth2_registered_client <span class="token punctuation">(</span>
    id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    client_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    client_id_issued_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    client_secret <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    client_secret_expires_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    client_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    client_authentication_methods <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    authorization_grant_types <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    redirect_uris <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    post_logout_redirect_uris <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    scopes <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    client_settings <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    token_settings <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">/**
 * 授权确认表
 */</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> oauth2_authorization_consent <span class="token punctuation">(</span>
    registered_client_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    principal_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    authorities <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>registered_client_id<span class="token punctuation">,</span> principal_name<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">/**
 * 授权信息表
 */</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> oauth2_authorization <span class="token punctuation">(</span>
    id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    registered_client_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    principal_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    authorization_grant_type <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    authorized_scopes <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    attributes <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    state <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    authorization_code_value <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    authorization_code_issued_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    authorization_code_expires_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    authorization_code_metadata <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    access_token_value <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    access_token_issued_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    access_token_expires_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    access_token_metadata <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    access_token_type <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    access_token_scopes <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    oidc_id_token_value <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    oidc_id_token_issued_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    oidc_id_token_expires_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    oidc_id_token_metadata <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    refresh_token_value <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    refresh_token_issued_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    refresh_token_expires_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    refresh_token_metadata <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    user_code_value <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    user_code_issued_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    user_code_expires_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    user_code_metadata <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    device_code_value <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    device_code_issued_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    device_code_expires_at <span class="token keyword">timestamp</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    device_code_metadata <span class="token keyword">blob</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><br><br></p> 
<p><strong>注册客户端信息</strong></p> 
<p>将上面config配置类代码中注册的客户端信息整理成 sql 语句插入数据库表。</p> 
<p>注意：此时将客户端密钥 {noop}secret，改为密文存储。</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>oauth-server<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>oauth2_registered_client<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_id_issued_at<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_secret_expires_at<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_authentication_methods<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>authorization_grant_types<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>redirect_uris<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>post_logout_redirect_uris<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>scopes<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_settings<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>token_settings<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'3eacac0e-0de9-4727-9a64-6bdd4be2ee1f'</span><span class="token punctuation">,</span> <span class="token string">'oidc-client'</span><span class="token punctuation">,</span> <span class="token string">'2023-07-12 07:33:42'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$.J0Rfg7y2Mu8AN8Dk2vL.eBFa9NGbOYCPOAFEw.QhgGLVXjO7eFDC'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'3eacac0e-0de9-4727-9a64-6bdd4be2ee1f'</span><span class="token punctuation">,</span> <span class="token string">'client_secret_basic'</span><span class="token punctuation">,</span> <span class="token string">'refresh_token,authorization_code'</span><span class="token punctuation">,</span> <span class="token string">'http://www.baidu.com'</span><span class="token punctuation">,</span> <span class="token string">'http://127.0.0.1:8080/'</span><span class="token punctuation">,</span> <span class="token string">'openid,profile'</span><span class="token punctuation">,</span> <span class="token string">'{\"@class\":\"java.util.Collections$UnmodifiableMap\",\"settings.client.require-proof-key\":false,\"settings.client.require-authorization-consent\":true}'</span><span class="token punctuation">,</span> <span class="token string">'{\"@class\":\"java.util.Collections$UnmodifiableMap\",\"settings.token.reuse-refresh-tokens\":true,\"settings.token.id-token-signature-algorithm\":[\"org.springframework.security.oauth2.jose.jws.SignatureAlgorithm\",\"RS256\"],\"settings.token.access-token-time-to-live\":[\"java.time.Duration\",300.000000000],\"settings.token.access-token-format\":{\"@class\":\"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat\",\"value\":\"self-contained\"},\"settings.token.refresh-token-time-to-live\":[\"java.time.Duration\",3600.000000000],\"settings.token.authorization-code-time-to-live\":[\"java.time.Duration\",300.000000000],\"settings.token.device-code-time-to-live\":[\"java.time.Duration\",300.000000000]}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p><br><br></p> 
<p><strong>添加数据库连接，application.yml 配置如下</strong></p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">org.springframework.security</span><span class="token punctuation">:</span> trace

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>server
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/oauth<span class="token punctuation">-</span>server<span class="token punctuation">?</span>serverTimezone=UTC<span class="token important">&amp;userUnicode=true&amp;characterEncoding=utf-</span><span class="token number">8</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">1234</span>
</code></pre> 
<p><br><br></p> 
<p>在 SecurityConfig 中分别注入 RegisteredClientRepository、OAuth2AuthorizationService、OAuth2AuthorizationConsentService 。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 客户端信息
 * 对应表：oauth2_registered_client
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RegisteredClientRepository</span> <span class="token function">registeredClientRepository</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcRegisteredClientRepository</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * 授权信息
 * 对应表：oauth2_authorization
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">OAuth2AuthorizationService</span> <span class="token function">authorizationService</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">,</span> <span class="token class-name">RegisteredClientRepository</span> registeredClientRepository<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcOAuth2AuthorizationService</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">,</span> registeredClientRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 授权确认
 *对应表：oauth2_authorization_consent
 */</span>
<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">OAuth2AuthorizationConsentService</span> <span class="token function">authorizationConsentService</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">,</span> <span class="token class-name">RegisteredClientRepository</span> registeredClientRepository<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcOAuth2AuthorizationConsentService</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">,</span> registeredClientRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<h4><a id="_2411"></a>用户信息存储改造</h4> 
<p>在 SecurityConfig 类中的 UserDetailsService 也是基于内存的，用户信息在代码中写死，我们也把他改成从数据库中读取，新建 sys_user 表如下。</p> 
<pre><code class="prism language-java"><span class="token constant">CREATE</span> <span class="token constant">TABLE</span> `sys_user` <span class="token punctuation">(</span>
  `id` bigint <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">AUTO_INCREMENT</span> <span class="token constant">COMMENT</span> <span class="token char">'id'</span><span class="token punctuation">,</span>
  `username` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token constant">CHARACTER</span> <span class="token constant">SET</span> utf8mb4 <span class="token constant">COLLATE</span> utf8mb4_0900_ai_ci <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> <span class="token char">'用户名'</span><span class="token punctuation">,</span>
  `password` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">CHARACTER</span> <span class="token constant">SET</span> utf8mb4 <span class="token constant">COLLATE</span> utf8mb4_0900_ai_ci <span class="token constant">NOT</span> <span class="token constant">NULL</span> <span class="token constant">DEFAULT</span> '' <span class="token constant">COMMENT</span> <span class="token char">'密码'</span><span class="token punctuation">,</span>
  `name` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token constant">CHARACTER</span> <span class="token constant">SET</span> utf8mb4 <span class="token constant">COLLATE</span> utf8mb4_0900_ai_ci <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'姓名'</span><span class="token punctuation">,</span>
  `description` <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token constant">CHARACTER</span> <span class="token constant">SET</span> utf8mb4 <span class="token constant">COLLATE</span> utf8mb4_0900_ai_ci <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> <span class="token char">'描述'</span><span class="token punctuation">,</span>
  `status` tinyint <span class="token constant">DEFAULT</span> <span class="token constant">NULL</span> <span class="token constant">COMMENT</span> '状态（<span class="token number">1</span>：正常 <span class="token number">0</span>：停用）'<span class="token punctuation">,</span>
  <span class="token class-name">PRIMARY</span> <span class="token constant">KEY</span> <span class="token punctuation">(</span>`id`<span class="token punctuation">)</span> <span class="token class-name">USING</span> <span class="token constant">BTREE</span><span class="token punctuation">,</span>
  <span class="token constant">UNIQUE</span> <span class="token constant">KEY</span> `idx_username` <span class="token punctuation">(</span>`username`<span class="token punctuation">)</span> <span class="token class-name">USING</span> <span class="token constant">BTREE</span>
<span class="token punctuation">)</span> <span class="token constant">ENGINE</span><span class="token operator">=</span><span class="token class-name">InnoDB</span> <span class="token constant">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">14</span> <span class="token class-name">DEFAULT</span> <span class="token constant">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token constant">COLLATE</span><span class="token operator">=</span>utf8mb4_0900_ai_ci <span class="token constant">ROW_FORMAT</span><span class="token operator">=</span><span class="token class-name">DYNAMIC</span> <span class="token constant">COMMENT</span><span class="token operator">=</span><span class="token char">'用户表'</span><span class="token punctuation">;</span>

<span class="token constant">INSERT</span> <span class="token constant">INTO</span> `oauth<span class="token operator">-</span>server`<span class="token punctuation">.</span>`sys_user` <span class="token punctuation">(</span>`id`<span class="token punctuation">,</span> `username`<span class="token punctuation">,</span> `password`<span class="token punctuation">,</span> `name`<span class="token punctuation">,</span> `description`<span class="token punctuation">,</span> `status`<span class="token punctuation">)</span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> 'hushang<span class="token char">', '</span>$<span class="token number">2</span>a$<span class="token number">10</span>$<span class="token number">8f</span>yY0WbNAr980e6nLcPL5ugmpkLLH3serye5SJ3UcDForTW5b0Sx<span class="token punctuation">.</span><span class="token char">', '</span>测试用户<span class="token char">', '</span><span class="token class-name">Spring</span> <span class="token class-name">Security</span> 测试用户'<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>给 sys_user 增加对应的对应的实体和功能实现类，SysUserEntity、SysUserMapper、SysUserService、SysUserServiceImpl 代码如下。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">IdType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableName</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">"sys_user"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserEntity</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 主键
     */</span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">AUTO</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 用户名
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 密码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 名字
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 描述
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> description<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 状态
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">BaseMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysUserMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUserEntity</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SysUserService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     *
     * 根据用户名查询用户信息
     */</span>
    <span class="token class-name">SysUserEntity</span> <span class="token function">selectByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>core<span class="token punctuation">.</span>conditions<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">LambdaQueryWrapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">ServiceImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUserMapper</span><span class="token punctuation">,</span> <span class="token class-name">SysUserEntity</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">SysUserService</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SysUserEntity</span> <span class="token function">selectByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUserEntity</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SysUserEntity</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">,</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p>SecurityConfig 类，将 UserDetailsService 基于内存实现的代码注释掉，增加 PasswordEncoder 配置，SecurityConfig 改造后代码如下。</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     *设置用户信息，校验用户名、密码
     */</span>
<span class="token comment">//    @Bean</span>
<span class="token comment">//    public UserDetailsService userDetailsService() {<!-- --></span>
<span class="token comment">//        UserDetails userDetails = User.withDefaultPasswordEncoder()</span>
<span class="token comment">//                .username("hushang")</span>
<span class="token comment">//                .password("123456")</span>
<span class="token comment">//                .roles("USER")</span>
<span class="token comment">//                .build();</span>
<span class="token comment">//        //基于内存的用户数据校验</span>
<span class="token comment">//        return new InMemoryUserDetailsManager(userDetails);</span>
<span class="token comment">//    }</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p>创建 UserDetailsServiceImpl 类继承 UserDetailsService 接口，添加 @Service 注解交给 Spring 容器管理，重写 loadUserByUsername(String username) 方法,实现用户信息从数据库查询，UserDetailsServiceImpl 代码如下。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>authority<span class="token punctuation">.</span></span><span class="token class-name">SimpleGrantedAuthority</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UsernameNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">SysUserService</span> sysUserService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">SysUserEntity</span> sysUserEntity <span class="token operator">=</span> sysUserService<span class="token punctuation">.</span><span class="token function">selectByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">&gt;</span></span> grantedAuthorityList <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SimpleGrantedAuthority</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>sysUserEntity<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>grantedAuthorityList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p>修改全部完成，可以进行测试。此时config配置类的内容如下所示</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>jwk<span class="token punctuation">.</span></span><span class="token class-name">JWKSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>jwk<span class="token punctuation">.</span></span><span class="token class-name">RSAKey</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>jwk<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">ImmutableJWKSet</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>jwk<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">JWKSource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>nimbusds<span class="token punctuation">.</span>jose<span class="token punctuation">.</span>proc<span class="token punctuation">.</span></span><span class="token class-name">SecurityContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Order</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">JdbcTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">Customizer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">HttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableWebSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">User</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetails</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>core<span class="token punctuation">.</span>userdetails<span class="token punctuation">.</span></span><span class="token class-name">UserDetailsService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span><span class="token class-name">PasswordEncoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>jwt<span class="token punctuation">.</span></span><span class="token class-name">JwtDecoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span></span><span class="token class-name">JdbcOAuth2AuthorizationConsentService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span></span><span class="token class-name">JdbcOAuth2AuthorizationService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AuthorizationConsentService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AuthorizationService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">JdbcRegisteredClientRepository</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RegisteredClientRepository</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AuthorizationServerConfiguration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">OAuth2AuthorizationServerConfigurer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>server<span class="token punctuation">.</span>authorization<span class="token punctuation">.</span>settings<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerSettings</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>provisioning<span class="token punctuation">.</span></span><span class="token class-name">InMemoryUserDetailsManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span></span><span class="token class-name">SecurityFilterChain</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span><span class="token class-name">LoginUrlAuthenticationEntryPoint</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>util<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span><span class="token class-name">MediaTypeRequestMatcher</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">KeyPair</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">KeyPairGenerator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span></span><span class="token class-name">RSAPrivateKey</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>interfaces<span class="token punctuation">.</span></span><span class="token class-name">RSAPublicKey</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token punctuation">{<!-- --></span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">authorizationServerSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">OAuth2AuthorizationServerConfiguration</span><span class="token punctuation">.</span><span class="token function">applyDefaultSecurity</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
        http<span class="token punctuation">.</span><span class="token function">getConfigurer</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AuthorizationServerConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token comment">//开启OpenID Connect 1.0（其中oidc为OpenID Connect的缩写）。</span>
                <span class="token punctuation">.</span><span class="token function">oidc</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        http
                <span class="token comment">//将需要认证的请求，重定向到login页面行登录认证。</span>
                <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">(</span>exceptions<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> exceptions
                        <span class="token punctuation">.</span><span class="token function">defaultAuthenticationEntryPointFor</span><span class="token punctuation">(</span>
                                <span class="token keyword">new</span> <span class="token class-name">LoginUrlAuthenticationEntryPoint</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                <span class="token keyword">new</span> <span class="token class-name">MediaTypeRequestMatcher</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span><span class="token constant">TEXT_HTML</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token comment">// 使用jwt处理接收到的access token</span>
                <span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resourceServer<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> resourceServer
                        <span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     *Spring Security 过滤链配置（此处是纯Spring Security相关配置）
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">defaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        http
                <span class="token comment">//设置所有请求都需要认证，未认证的请求都被重定向到login页面进行登录</span>
                <span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authorize<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> authorize
                        <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                <span class="token comment">// 由Spring Security过滤链中UsernamePasswordAuthenticationFilter过滤器拦截处理“login”页面提交的登录信息。</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 客户端信息
     * 对应表：oauth2_registered_client
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RegisteredClientRepository</span> <span class="token function">registeredClientRepository</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcRegisteredClientRepository</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 授权信息
     * 对应表：oauth2_authorization
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2AuthorizationService</span> <span class="token function">authorizationService</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">,</span> <span class="token class-name">RegisteredClientRepository</span> registeredClientRepository<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcOAuth2AuthorizationService</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">,</span> registeredClientRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 授权确认
     *对应表：oauth2_authorization_consent
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">OAuth2AuthorizationConsentService</span> <span class="token function">authorizationConsentService</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">,</span> <span class="token class-name">RegisteredClientRepository</span> registeredClientRepository<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcOAuth2AuthorizationConsentService</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">,</span> registeredClientRepository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     *设置用户信息，校验用户名、密码
     */</span>
<span class="token comment">//    @Bean</span>
<span class="token comment">//    public UserDetailsService userDetailsService() {<!-- --></span>
<span class="token comment">//        UserDetails userDetails = User.withDefaultPasswordEncoder()</span>
<span class="token comment">//                .username("fox")</span>
<span class="token comment">//                .password("123456")</span>
<span class="token comment">//                .roles("USER")</span>
<span class="token comment">//                .build();</span>
<span class="token comment">//        //基于内存的用户数据校验</span>
<span class="token comment">//        return new InMemoryUserDetailsManager(userDetails);</span>
<span class="token comment">//    }</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *配置 JWK，为JWT(id_token)提供加密密钥，用于加密/解密或签名/验签
     * JWK详细见：https://datatracker.ietf.org/doc/html/draft-ietf-jose-json-web-key-41
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JWKSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> <span class="token function">jwkSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">KeyPair</span> keyPair <span class="token operator">=</span> <span class="token function">generateRsaKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RSAPublicKey</span> publicKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RSAPublicKey</span><span class="token punctuation">)</span> keyPair<span class="token punctuation">.</span><span class="token function">getPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RSAPrivateKey</span> privateKey <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RSAPrivateKey</span><span class="token punctuation">)</span> keyPair<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RSAKey</span> rsaKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RSAKey<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">privateKey</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">keyID</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JWKSet</span> jwkSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JWKSet</span><span class="token punctuation">(</span>rsaKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableJWKSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>jwkSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *生成RSA密钥对，给上面jwkSource() 方法的提供密钥对
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">KeyPair</span> <span class="token function">generateRsaKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">KeyPair</span> keyPair<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">KeyPairGenerator</span> keyPairGenerator <span class="token operator">=</span> <span class="token class-name">KeyPairGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"RSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyPairGenerator<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyPair <span class="token operator">=</span> keyPairGenerator<span class="token punctuation">.</span><span class="token function">generateKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> keyPair<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 配置jwt解析器
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JwtDecoder</span> <span class="token function">jwtDecoder</span><span class="token punctuation">(</span><span class="token class-name">JWKSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SecurityContext</span><span class="token punctuation">&gt;</span></span> jwkSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">OAuth2AuthorizationServerConfiguration</span><span class="token punctuation">.</span><span class="token function">jwtDecoder</span><span class="token punctuation">(</span>jwkSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *配置认证服务器请求地址
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthorizationServerSettings</span> <span class="token function">authorizationServerSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//什么都不配置，则使用默认地址</span>
        <span class="token keyword">return</span> <span class="token class-name">AuthorizationServerSettings</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<h4><a id="_2798"></a>测试</h4> 
<p>启动服务，再次访问 http://localhost:9000/oauth2/authorize?response_type=code&amp;client_id=oidc-client&amp;scope=profile openid&amp;redirect_uri=http://www.baidu.com 地址，会跳转到登录界面。请求参数包括：请求模式为授权码code、client_id、scope、redirect_uri</p> 
<p><img src="https://images2.imgbox.com/53/f4/urOMVnC9_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>输入用户名：hushang，密码：123456，则跳转至授权页面</p> 
<p><img src="https://images2.imgbox.com/8c/d8/FjWTKJkj_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>勾选授权信息profile，点击提交按钮，则返回如下结果</p> 
<p><img src="https://images2.imgbox.com/9d/c8/HF4xBQPK_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h2><a id="SSO_2835"></a>SSO单点登录实战</h2> 
<p>单点登录（Single Sign On），简称为 SSO，是比较流行的企业业务整合的解决方案之一。它的用途在于，不管多么复杂的应用群，只要在用户权限范围内，那么就可以做到，用户只需要登录一次就可以访问权限范围内的所有应用子系统。</p> 
<p><br><br></p> 
<h3><a id="_2843"></a>实现思路</h3> 
<p>单点登录涉及到多个客户端，客户端就以订单服务、商品服务为例。以下是单点登录中，订单服务、商品服务、认证服务器的交互时序图：</p> 
<p><br><br></p> 
<h3><a id="_2858"></a>授权服务器搭建</h3> 
<p>参考上方Spring Authorization Server实战中搭建授权服务器<br> <img src="https://images2.imgbox.com/60/7c/FbEhi0Iv_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h3><a id="_2867"></a>订单服务搭建</h3> 
<p>订单服务作为客户端，参考前面客户端的搭建</p> 
<p>引入依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--spring-boot-starter-oauth2-client--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><br><br></p> 
<p>我在本机的hosts文件下又增加一条本机的域名映射<code> 127.0.0.1 spring-oauth-client-order</code></p> 
<p>application.yml配置如下</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">ip</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>client<span class="token punctuation">-</span>order
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9003</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">org.springframework.security</span><span class="token punctuation">:</span> trace

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>client<span class="token punctuation">-</span>order
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">provider</span><span class="token punctuation">:</span>
          <span class="token comment">#认证服务器信息</span>
          <span class="token key atrule">oauth-server</span><span class="token punctuation">:</span>
            <span class="token comment">#授权地址</span>
            <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>server<span class="token punctuation">:</span><span class="token number">9000</span>
            <span class="token key atrule">authorizationUri</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.security.oauth2.client.provider.oauth<span class="token punctuation">-</span>server.issuer<span class="token punctuation">-</span>uri<span class="token punctuation">}</span>/oauth2/authorize
            <span class="token comment">#令牌获取地址</span>
            <span class="token key atrule">tokenUri</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.security.oauth2.client.provider.oauth<span class="token punctuation">-</span>server.issuer<span class="token punctuation">-</span>uri<span class="token punctuation">}</span>/oauth2/token
        <span class="token key atrule">registration</span><span class="token punctuation">:</span>
          <span class="token key atrule">messaging-client-oidc</span><span class="token punctuation">:</span>
            <span class="token comment">#认证提供者，标识由哪个认证服务器进行认证，和上面的oauth-server进行关联</span>
            <span class="token key atrule">provider</span><span class="token punctuation">:</span> oauth<span class="token punctuation">-</span>server
            <span class="token comment">#客户端名称</span>
            <span class="token key atrule">client-name</span><span class="token punctuation">:</span> web平台<span class="token punctuation">-</span>SSO客户端<span class="token punctuation">-</span>订单服务
            <span class="token comment">#客户端id，从认证平台申请的客户端id</span>
            <span class="token key atrule">client-id</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>client<span class="token punctuation">-</span>id<span class="token punctuation">-</span>order
            <span class="token comment">#客户端秘钥</span>
            <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> secret
            <span class="token comment">#客户端认证方式为client_secret_basic</span>
            <span class="token key atrule">client-authentication-method</span><span class="token punctuation">:</span> client_secret_basic
            <span class="token comment">#使用授权码模式获取令牌（token）</span>
            <span class="token key atrule">authorization-grant-type</span><span class="token punctuation">:</span> authorization_code
            <span class="token comment">#回调地址，接收认证服务器回传code的接口地址，之前我们是使用http://www.baidu.com代替</span>
            <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>client<span class="token punctuation">-</span>order<span class="token punctuation">:</span>9003/login/oauth2/code/messaging<span class="token punctuation">-</span>client<span class="token punctuation">-</span>oidc
            <span class="token key atrule">scope</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> profile
              <span class="token punctuation">-</span> openid
</code></pre> 
<p><br><br></p> 
<p>oauth2_registered_client表增加一条订单服务的客户端记录</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>oauth-server<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>oauth2_registered_client<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_id_issued_at<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_secret_expires_at<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_authentication_methods<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>authorization_grant_types<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>redirect_uris<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>post_logout_redirect_uris<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>scopes<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_settings<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>token_settings<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'3eacac0e-0de9-4727-9a64-6bdd4be2ee3'</span><span class="token punctuation">,</span> <span class="token string">'web-client-id-order'</span><span class="token punctuation">,</span> <span class="token string">'2023-07-12 07:33:42'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$.J0Rfg7y2Mu8AN8Dk2vL.eBFa9NGbOYCPOAFEw.QhgGLVXjO7eFDC'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'web平台-SSO客户端-订单服务'</span><span class="token punctuation">,</span> <span class="token string">'client_secret_basic'</span><span class="token punctuation">,</span> <span class="token string">'refresh_token,authorization_code'</span><span class="token punctuation">,</span> <span class="token string">'http://spring-oauth-client-order:9003/login/oauth2/code/messaging-client-oidc'</span><span class="token punctuation">,</span> <span class="token string">'http://127.0.0.1:9000/'</span><span class="token punctuation">,</span> <span class="token string">'openid,profile'</span><span class="token punctuation">,</span> <span class="token string">'{\"@class\":\"java.util.Collections$UnmodifiableMap\",\"settings.client.require-proof-key\":false,\"settings.client.require-authorization-consent\":true}'</span><span class="token punctuation">,</span> <span class="token string">'{\"@class\":\"java.util.Collections$UnmodifiableMap\",\"settings.token.reuse-refresh-tokens\":true,\"settings.token.id-token-signature-algorithm\":[\"org.springframework.security.oauth2.jose.jws.SignatureAlgorithm\",\"RS256\"],\"settings.token.access-token-time-to-live\":[\"java.time.Duration\",1800.000000000],\"settings.token.access-token-format\":{\"@class\":\"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat\",\"value\":\"self-contained\"},\"settings.token.refresh-token-time-to-live\":[\"java.time.Duration\",3600.000000000],\"settings.token.authorization-code-time-to-live\":[\"java.time.Duration\",300.000000000],\"settings.token.device-code-time-to-live\":[\"java.time.Duration\",300.000000000]}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><br><br></p> 
<h3><a id="_2955"></a>商品服务搭建</h3> 
<p>商品服务作为客户端，参考前面客户端的搭建</p> 
<p>我在本机的hosts文件下又增加一条本机的域名映射<code> 127.0.0.1 spring-oauth-client-product</code></p> 
<p>application.yml配置如下</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">ip</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>client<span class="token punctuation">-</span>product
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9004</span>

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">org.springframework.security</span><span class="token punctuation">:</span> trace

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>client<span class="token punctuation">-</span>product
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">provider</span><span class="token punctuation">:</span>
          <span class="token comment">#认证服务器信息</span>
          <span class="token key atrule">oauth-server</span><span class="token punctuation">:</span>
            <span class="token comment">#授权地址</span>
            <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>server<span class="token punctuation">:</span><span class="token number">9000</span>
            <span class="token key atrule">authorizationUri</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.security.oauth2.client.provider.oauth<span class="token punctuation">-</span>server.issuer<span class="token punctuation">-</span>uri<span class="token punctuation">}</span>/oauth2/authorize
            <span class="token comment">#令牌获取地址</span>
            <span class="token key atrule">tokenUri</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.security.oauth2.client.provider.oauth<span class="token punctuation">-</span>server.issuer<span class="token punctuation">-</span>uri<span class="token punctuation">}</span>/oauth2/token
        <span class="token key atrule">registration</span><span class="token punctuation">:</span>
          <span class="token key atrule">messaging-client-oidc</span><span class="token punctuation">:</span>
            <span class="token comment">#认证提供者，标识由哪个认证服务器进行认证，和上面的oauth-server进行关联</span>
            <span class="token key atrule">provider</span><span class="token punctuation">:</span> oauth<span class="token punctuation">-</span>server
            <span class="token comment">#客户端名称</span>
            <span class="token key atrule">client-name</span><span class="token punctuation">:</span> web平台<span class="token punctuation">-</span>SSO客户端<span class="token punctuation">-</span>商品服务
            <span class="token comment">#客户端id，从认证平台申请的客户端id</span>
            <span class="token key atrule">client-id</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>client<span class="token punctuation">-</span>id<span class="token punctuation">-</span>product
            <span class="token comment">#客户端秘钥</span>
            <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> secret
            <span class="token comment">#客户端认证方式</span>
            <span class="token key atrule">client-authentication-method</span><span class="token punctuation">:</span> client_secret_basic
            <span class="token comment">#使用授权码模式获取令牌（token）</span>
            <span class="token key atrule">authorization-grant-type</span><span class="token punctuation">:</span> authorization_code
            <span class="token comment">#回调地址，接收认证服务器回传code的接口地址，之前我们是使用http://www.baidu.com代替</span>
            <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>client<span class="token punctuation">-</span>product<span class="token punctuation">:</span>9004/login/oauth2/code/messaging<span class="token punctuation">-</span>client<span class="token punctuation">-</span>oidc
            <span class="token key atrule">scope</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> profile
              <span class="token punctuation">-</span> openid
</code></pre> 
<p><br><br></p> 
<p>oauth2_registered_client表增加一条商品服务的客户端记录</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>oauth-server<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>oauth2_registered_client<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_id_issued_at<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_secret_expires_at<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_authentication_methods<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>authorization_grant_types<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>redirect_uris<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>post_logout_redirect_uris<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>scopes<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_settings<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>token_settings<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'3eacac0e-0de9-4727-9a64-6bdd4be2ee4'</span><span class="token punctuation">,</span> <span class="token string">'web-client-id-product'</span><span class="token punctuation">,</span> <span class="token string">'2023-07-12 07:33:42'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$.J0Rfg7y2Mu8AN8Dk2vL.eBFa9NGbOYCPOAFEw.QhgGLVXjO7eFDC'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'web平台-SSO客户端-商品服务'</span><span class="token punctuation">,</span> <span class="token string">'client_secret_basic'</span><span class="token punctuation">,</span> <span class="token string">'refresh_token,authorization_code'</span><span class="token punctuation">,</span> <span class="token string">'http://spring-oauth-client-product:9004/login/oauth2/code/messaging-client-oidc'</span><span class="token punctuation">,</span> <span class="token string">'http://127.0.0.1:9000/'</span><span class="token punctuation">,</span> <span class="token string">'openid,profile'</span><span class="token punctuation">,</span> <span class="token string">'{\"@class\":\"java.util.Collections$UnmodifiableMap\",\"settings.client.require-proof-key\":false,\"settings.client.require-authorization-consent\":true}'</span><span class="token punctuation">,</span> <span class="token string">'{\"@class\":\"java.util.Collections$UnmodifiableMap\",\"settings.token.reuse-refresh-tokens\":true,\"settings.token.id-token-signature-algorithm\":[\"org.springframework.security.oauth2.jose.jws.SignatureAlgorithm\",\"RS256\"],\"settings.token.access-token-time-to-live\":[\"java.time.Duration\",1800.000000000],\"settings.token.access-token-format\":{\"@class\":\"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat\",\"value\":\"self-contained\"},\"settings.token.refresh-token-time-to-live\":[\"java.time.Duration\",3600.000000000],\"settings.token.authorization-code-time-to-live\":[\"java.time.Duration\",300.000000000],\"settings.token.device-code-time-to-live\":[\"java.time.Duration\",300.000000000]}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><br><br></p> 
<h3><a id="_3021"></a>单点登录测试</h3> 
<p>商品服务和订单服务都写了一些简单的html页面，并在各自的WebSecurityConfig配置类中对一些index.html资源的访问无需认证</p> 
<p><img src="https://images2.imgbox.com/85/e1/ixv67BLp_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p><strong>测试无需登录的请求</strong></p> 
<p>浏览器输入地址http://spring-oauth-client-order:9003/index，测试放开保护的资源，能正常访问，结果如下</p> 
<p><img src="https://images2.imgbox.com/7a/22/SGz1s3Sn_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p><strong>测试需要登录的请求</strong></p> 
<p>浏览器输入地址http://spring-oauth-client-order:9003/order1，测试受保护的资源，就会跳转至授权服务器的登录认证页面，结果如下：</p> 
<p><img src="https://images2.imgbox.com/e9/75/NFDToNZi_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>输入用户：hushang，密码：123456，提交登录，跳转到授权确认页面。</p> 
<p><img src="https://images2.imgbox.com/5c/d2/TDv9k6hS_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>勾选授权信息，提交确认授权，则成功跳转到订单页面1，结果如下</p> 
<p><img src="https://images2.imgbox.com/c7/b5/d3Z7QcYa_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>点击“跳转到商品页面1”，此时我们从订单服务跳转到商品服务，属于跨客户端服务，由于我们在操作订单服务时已经输入用户名和密码进行了登录，session会话已存在，因此在此处就绕过了用户名、密码登录了。</p> 
<p><img src="https://images2.imgbox.com/14/26/bXMsGUmE_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>勾选授权信息，提交确认授权，则成功跳转到订单页面1，结果如下：</p> 
<p><br><br><br> <img src="https://images2.imgbox.com/17/15/HY7ciYHR_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>在首次访问订单服务或商品服务受保护的资源时，在登录过程中，都会跳转到授权确认页面进行授权确认，如果想去掉授权确认页面的这一步操作，实现无感确认，可以将oauth2_registered_client表中对应的客户端记录，client_settings字段的settings.client.require-authorization-consent值设置为false。</p> 
<p>将settings.client.require-authorization-consent值设置为false后，上面的测试，首次访问商品服务进行登录时，输入用户名、密码提交后，将不会跳转到授权确认页面，直接默认授权，从商品服务的页面首次跳转到订单服务的页面时，也不会先跳转到授权确认页面，而是直接跳转到订单服务的页面。</p> 
<p><br><br></p> 
<h2><a id="Oauth2_3117"></a>微服务网关整合Oauth2安全认证实战</h2> 
<h3><a id="_3119"></a>实现思路</h3> 
<p><img src="https://images2.imgbox.com/ef/63/qqQBJUyx_o.png" alt="在这里插入图片描述"></p> 
<ol><li>用户请求受限资源</li><li>网关检测没有认证信息，通过RedirectServerAuthenticationEntryPoint处理并发起OAuth2登录授权申请</li><li>授权申请到达认证授权服务器，认证授权服务器检测到未登录重定向至登录页面并展示给用户</li><li>用户登录成功后请求重定向至授权申请接口，通过校验后携带Token重定向至回调地址(redirect_uri)，注意：这里回调地址要设置为网关的地址，htttp://{网关ip}:{网关port}/login/oauth2/code/{registrationId}，后边的/login/oauth2/code/{registrationId}路径是固定的，这是框架(Security OAuth2 Client)自带的端点</li><li>请求到达网关，由OAuth2LoginAuthenticationWebFilter拦截并调用父类AuthenticationWebFilter的filter方法进行处理</li><li>AuthenticationWebFilter调用OidcAuthorizationCodeReactiveAuthenticationManager或OAuth2LoginReactiveAuthenticationManager类处理(由授权申请的scope决定，包含openid就走OidcAuthorizationCodeReactiveAuthenticationManager，否则走另一个)</li><li>在获取AccessToken成功以后调用ReactiveOAuth2UserService获取用户信息</li><li>获取到用户信息后会解析并将认证信息保存至ReactiveSecurityContextHolder中</li><li>完成这一系列的认证之后会重定向至最一开始请求的受限资源，这时候就能获取到认证信息了</li><li>如果访问的是被网关代理的服务则会通过令牌中继(TokenRelay)携带token访问</li></ol> 
<p>这就是网关通过认证服务获取认证信息的一个流程，基本上只需要添加配置文件即可由框架引导进行OAuth2认证流程。</p> 
<p><br><br></p> 
<h3><a id="_3144"></a>配置授权服务器</h3> 
<p>参考上方Spring Authorization Server实战中搭建授权服务器</p> 
<p>授权服务器中注册网关客户端信息</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>oauth-server<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>oauth2_registered_client<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_id_issued_at<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_secret_expires_at<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_name<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_authentication_methods<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>authorization_grant_types<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>redirect_uris<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>post_logout_redirect_uris<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>scopes<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>client_settings<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>token_settings<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'3eacac0e-0de9-4727-9a64-6bdd4be2ee6'</span><span class="token punctuation">,</span> <span class="token string">'mall-gateway-id'</span><span class="token punctuation">,</span> <span class="token string">'2023-07-12 07:33:42'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$.J0Rfg7y2Mu8AN8Dk2vL.eBFa9NGbOYCPOAFEw.QhgGLVXjO7eFDC'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'网关服务'</span><span class="token punctuation">,</span> <span class="token string">'client_secret_basic'</span><span class="token punctuation">,</span> <span class="token string">'refresh_token,authorization_code'</span><span class="token punctuation">,</span> <span class="token string">'http://mall-gateway:8888/login/oauth2/code/messaging-client-oidc'</span><span class="token punctuation">,</span> <span class="token string">'http://127.0.0.1:9000/'</span><span class="token punctuation">,</span> <span class="token string">'openid,profile'</span><span class="token punctuation">,</span> <span class="token string">'{\"@class\":\"java.util.Collections$UnmodifiableMap\",\"settings.client.require-proof-key\":false,\"settings.client.require-authorization-consent\":true}'</span><span class="token punctuation">,</span> <span class="token string">'{\"@class\":\"java.util.Collections$UnmodifiableMap\",\"settings.token.reuse-refresh-tokens\":true,\"settings.token.id-token-signature-algorithm\":[\"org.springframework.security.oauth2.jose.jws.SignatureAlgorithm\",\"RS256\"],\"settings.token.access-token-time-to-live\":[\"java.time.Duration\",1800.000000000],\"settings.token.access-token-format\":{\"@class\":\"org.springframework.security.oauth2.server.authorization.settings.OAuth2TokenFormat\",\"value\":\"self-contained\"},\"settings.token.refresh-token-time-to-live\":[\"java.time.Duration\",3600.000000000],\"settings.token.authorization-code-time-to-live\":[\"java.time.Duration\",300.000000000],\"settings.token.device-code-time-to-live\":[\"java.time.Duration\",300.000000000]}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><br><br></p> 
<h3><a id="OAuth2_3162"></a>网关接入OAuth2</h3> 
<p>网关可以作为客户端和资源服务器</p> 
<p>注意：<strong>Spring Cloud Gateway</strong>网关使用的是webflux，需要webflux版本的Spring Security支持</p> 
<p>官方文档：https://docs.spring.io/spring-security/reference/reactive/oauth2/client/index.html</p> 
<p><br><br></p> 
<p><strong>引入依赖</strong></p> 
<p>引入oauth2客户端和资源服务的依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--spring-boot-starter-oauth2-client--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--spring-boot-starter-oauth2-resource-server--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>完整pom.xml文件</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!--
		父项目中的版本
		&lt;spring-boot.version&gt;3.0.2&lt;/spring-boot.version&gt;
		&lt;spring-cloud-alibaba.version&gt;2022.0.0.0&lt;/spring-cloud-alibaba.version&gt;
		&lt;spring-cloud.version&gt;2022.0.0&lt;/spring-cloud.version&gt;
	--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tuling<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tulingmall<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.tuling<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mall-gateway-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.1-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mall-gateway-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>mall-gateway-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- gateway网关 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- nacos服务注册与发现 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!-- SpringBoot3默认剔除了ribbon，所以这里需要引入loadbalancer的依赖 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-loadbalancer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-webflux<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!--spring-boot-starter-oauth2-client--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token comment">&lt;!--spring-boot-starter-oauth2-resource-server--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><br><br></p> 
<p><strong>application.yml中添加客户端与资源服务配置配置</strong></p> 
<pre><code class="prism language-yml">  <span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token comment"># 资源服务器配置</span>
      <span class="token key atrule">resourceserver</span><span class="token punctuation">:</span>
        <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
          <span class="token comment"># Jwt中claims的iss属性，也就是jwt的签发地址，即认证服务器的根路径</span>
          <span class="token comment"># 资源服务器会进一步的配置，通过该地址获取公钥以解析jwt</span>
          <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>server<span class="token punctuation">:</span><span class="token number">9000</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">provider</span><span class="token punctuation">:</span>
          <span class="token comment">#认证服务器信息,oauth-server这个string可以自定义，但是需要和下方进行匹配</span>
          <span class="token key atrule">oauth-server</span><span class="token punctuation">:</span>
            <span class="token comment">#授权地址</span>
            <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>server<span class="token punctuation">:</span><span class="token number">9000</span>
            <span class="token comment"># 获取用户信息的地址，默认的/userinfo端点需要IdToken获取，为避免麻烦自定一个用户信息接口</span>
<span class="token comment">#            user-info-uri: ${spring.security.oauth2.client.provider.oauth-server.issuer-uri}/user</span>
<span class="token comment">#            user-name-attribute: name</span>
            <span class="token key atrule">authorizationUri</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.security.oauth2.client.provider.oauth<span class="token punctuation">-</span>server.issuer<span class="token punctuation">-</span>uri<span class="token punctuation">}</span>/oauth2/authorize
            <span class="token comment">#令牌获取地址</span>
            <span class="token key atrule">tokenUri</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.security.oauth2.client.provider.oauth<span class="token punctuation">-</span>server.issuer<span class="token punctuation">-</span>uri<span class="token punctuation">}</span>/oauth2/token
        <span class="token key atrule">registration</span><span class="token punctuation">:</span>
          <span class="token comment"># 下面这个string可以自定义，但是需要和下方redirect-uri的最后进行匹配</span>
          <span class="token key atrule">messaging-client-oidc</span><span class="token punctuation">:</span>
            <span class="token comment">#认证提供者，标识由哪个认证服务器进行认证，和上面的oauth-server进行关联</span>
            <span class="token key atrule">provider</span><span class="token punctuation">:</span> oauth<span class="token punctuation">-</span>server
            <span class="token comment">#客户端名称</span>
            <span class="token key atrule">client-name</span><span class="token punctuation">:</span> 网关服务
            <span class="token comment">#客户端id，从认证平台申请的客户端id</span>
            <span class="token key atrule">client-id</span><span class="token punctuation">:</span> mall<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>id
            <span class="token comment">#客户端秘钥</span>
            <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> secret
            <span class="token comment">#客户端认证方式</span>
            <span class="token key atrule">client-authentication-method</span><span class="token punctuation">:</span> client_secret_basic
            <span class="token comment">#使用授权码模式获取令牌（token）</span>
            <span class="token key atrule">authorization-grant-type</span><span class="token punctuation">:</span> authorization_code
            <span class="token comment">#回调地址，接收认证服务器回传code的接口地址，之前我们是使用http://www.baidu.com代替</span>
            <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//mall<span class="token punctuation">-</span>gateway<span class="token punctuation">:</span>8888/login/oauth2/code/messaging<span class="token punctuation">-</span>client<span class="token punctuation">-</span>oidc
            <span class="token key atrule">scope</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> profile
              <span class="token punctuation">-</span> openid
</code></pre> 
<p><br><br></p> 
<p>完整的yml文件内容</p> 
<pre><code class="prism language-yml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8888</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mall<span class="token punctuation">-</span>gateway

  <span class="token comment">#配置nacos注册中心地址</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> nacos.mall.com<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
        <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos

    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span>
        <span class="token comment"># 令牌中继  会在请求头中添加token向下游传递</span>
        <span class="token punctuation">-</span> TokenRelay=
      <span class="token comment">#设置路由：路由id、路由到微服务的uri、断言</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> user_route   <span class="token comment">#路由ID，全局唯一</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//mall<span class="token punctuation">-</span>user  <span class="token comment">#lb 整合负载均衡器ribbon,loadbalancer</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span>   <span class="token comment"># 断言，路径相匹配的进行路由</span>

        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> order_route  <span class="token comment">#路由ID，全局唯一</span>
          <span class="token comment"># 测试 http://localhost:8888/order/findOrderByUserId/1</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//mall<span class="token punctuation">-</span>order  <span class="token comment">#lb 整合负载均衡器loadbalancer</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/order/<span class="token important">**</span>   <span class="token comment"># 断言，路径相匹配的进行路由</span>


  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
      <span class="token comment"># 资源服务器配置</span>
      <span class="token key atrule">resourceserver</span><span class="token punctuation">:</span>
        <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
          <span class="token comment"># Jwt中claims的iss属性，也就是jwt的签发地址，即认证服务器的根路径</span>
          <span class="token comment"># 资源服务器会进一步的配置，通过该地址获取公钥以解析jwt</span>
          <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>server<span class="token punctuation">:</span><span class="token number">9000</span>
      <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">provider</span><span class="token punctuation">:</span>
          <span class="token comment">#认证服务器信息</span>
          <span class="token key atrule">oauth-server</span><span class="token punctuation">:</span>
            <span class="token comment">#授权地址</span>
            <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>server<span class="token punctuation">:</span><span class="token number">9000</span>
            <span class="token key atrule">authorizationUri</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.security.oauth2.client.provider.oauth<span class="token punctuation">-</span>server.issuer<span class="token punctuation">-</span>uri<span class="token punctuation">}</span>/oauth2/authorize
            <span class="token comment">#令牌获取地址</span>
            <span class="token key atrule">tokenUri</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>spring.security.oauth2.client.provider.oauth<span class="token punctuation">-</span>server.issuer<span class="token punctuation">-</span>uri<span class="token punctuation">}</span>/oauth2/token
        <span class="token key atrule">registration</span><span class="token punctuation">:</span>
          <span class="token key atrule">messaging-client-oidc</span><span class="token punctuation">:</span>
            <span class="token comment">#认证提供者，标识由哪个认证服务器进行认证，和上面的oauth-server进行关联</span>
            <span class="token key atrule">provider</span><span class="token punctuation">:</span> oauth<span class="token punctuation">-</span>server
            <span class="token comment">#客户端名称</span>
            <span class="token key atrule">client-name</span><span class="token punctuation">:</span> 网关服务
            <span class="token comment">#客户端id，从认证平台申请的客户端id</span>
            <span class="token key atrule">client-id</span><span class="token punctuation">:</span> mall<span class="token punctuation">-</span>gateway<span class="token punctuation">-</span>id
            <span class="token comment">#客户端秘钥</span>
            <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> secret
            <span class="token comment">#客户端认证方式</span>
            <span class="token key atrule">client-authentication-method</span><span class="token punctuation">:</span> client_secret_basic
            <span class="token comment">#使用授权码模式获取令牌（token）</span>
            <span class="token key atrule">authorization-grant-type</span><span class="token punctuation">:</span> authorization_code
            <span class="token comment">#回调地址，接收认证服务器回传code的接口地址，之前我们是使用http://www.baidu.com代替</span>
            <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//mall<span class="token punctuation">-</span>gateway<span class="token punctuation">:</span>8888/login/oauth2/code/messaging<span class="token punctuation">-</span>client<span class="token punctuation">-</span>oidc
            <span class="token key atrule">scope</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> profile
              <span class="token punctuation">-</span> openid
</code></pre> 
<p><br><br></p> 
<p><strong>编写网关资源服务配置</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">Customizer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>method<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableReactiveMethodSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span></span><span class="token class-name">EnableWebFluxSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerHttpSecurity</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">SecurityWebFilterChain</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 资源服务器配置
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebFluxSecurity</span>
<span class="token annotation punctuation">@EnableReactiveMethodSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 配置认证相关的过滤器链
     *
     * @param http Spring Security的核心配置类
     * @return 过滤器链
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityWebFilterChain</span> <span class="token function">defaultSecurityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">ServerHttpSecurity</span> http<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 全部请求都需要认证</span>
        http<span class="token punctuation">.</span><span class="token function">authorizeExchange</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authorize<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> authorize
                <span class="token punctuation">.</span><span class="token function">anyExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 开启OAuth2登录</span>
        http<span class="token punctuation">.</span><span class="token function">oauth2Login</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置当前服务为资源服务，解析请求头中的token</span>
        http<span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resourceServer<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> resourceServer
                        <span class="token comment">// 使用jwt</span>
                        <span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">/*
                // 请求未携带Token处理
                .authenticationEntryPoint(this::authenticationEntryPoint)
                // 权限不足处理
                .accessDeniedHandler(this::accessDeniedHandler)
                // Token解析失败处理
                .authenticationFailureHandler(this::failureHandler)
                */</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 禁用csrf与cors</span>
        http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">(</span>csrf<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> csrf<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        http<span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cors<span class="token punctuation">)</span><span class="token operator">-&gt;</span>cors<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> 
<p>需要注意的是开启方法级别鉴权的注解变了，webflux的注解和webmvc的注解不一样，并且过滤器链也换成SecurityWebFilterChain了</p> 
<p><br><br></p> 
<p><strong>增加令牌中继配置</strong></p> 
<p>注意：配置文件中令牌中继(TokenRelay)的配置就是添加一个<code>filter：TokenRelay=</code>; 当网关引入spring-boot-starter-oauth2-client依赖并设置spring.security.oauth2.client.*属性时，会自动创建一个TokenRelayGatewayFilterFactory过滤器，它会从认证信息中获取access token，并放入下游请求的请求头中。</p> 
<p>Gateway关于TokenRelay的文档： https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-tokenrelay-gatewayfilter-factory</p> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">default-filters</span><span class="token punctuation">:</span>
        <span class="token comment"># 令牌中继  会在请求头中添加token向下游传递</span>
        <span class="token punctuation">-</span> TokenRelay=
</code></pre> 
<p><br><br></p> 
<h3><a id="_3498"></a>资源服务器配置</h3> 
<p>会员微服务需要调用订单微服务，它们都属于资源服务器，各个微服务都进行下面的操作</p> 
<p><strong>引入资源服务器依赖</strong></p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--spring-boot-starter-oauth2-resource-server--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-oauth2-resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><br><br></p> 
<p><strong>application.yml中添加资源服务器配置</strong></p> 
<pre><code class="prism language-yml">  <span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">security</span><span class="token punctuation">:</span>
      <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
        <span class="token comment"># 资源服务器配置</span>
        <span class="token key atrule">resource-server</span><span class="token punctuation">:</span>
          <span class="token key atrule">jwt</span><span class="token punctuation">:</span>
            <span class="token comment"># Jwt中claims的iss属性，也就是jwt的签发地址，即认证服务器的根路径</span>
            <span class="token comment"># 资源服务器会进一步的配置，通过该地址获取公钥以解析jwt</span>
            <span class="token key atrule">issuer-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>oauth<span class="token punctuation">-</span>server<span class="token punctuation">:</span><span class="token number">9000</span>
</code></pre> 
<p><br><br></p> 
<p><strong>配置资源服务器</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableMethodSecurity</span><span class="token punctuation">(</span>jsr250Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResourceServerConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>

        http<span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authorizeHttpRequests<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> authorizeHttpRequests
                        <span class="token comment">//所有的访问都需要通过身份认证</span>
                        <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
            	<span class="token comment">// 使用jwt处理接收到的access token</span>
                <span class="token punctuation">.</span><span class="token function">oauth2ResourceServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>oauth2ResourceServer<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> oauth2ResourceServer
                        <span class="token punctuation">.</span><span class="token function">jwt</span><span class="token punctuation">(</span><span class="token class-name">Customizer</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p><strong>添加openFeign拦截器</strong></p> 
<p>会员服务调用订单服务，token令牌需要向下游微服务传递，可以借助openFeign拦截器实现</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignAuthRequestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> template<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 业务逻辑  模拟认证逻辑</span>
        <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span>
                <span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> attributes<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> access_token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"从Request中解析请求头:{}"</span><span class="token punctuation">,</span>access_token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置token</span>
            template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span>access_token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><br><br></p> 
<p>在application.yml 中增加openFeign拦截器配置</p> 
<p><img src="https://images2.imgbox.com/46/97/H9pWkJyo_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<h3><a id="_3612"></a>测试</h3> 
<p>访问：http://mall-gateway:8888/user/findOrderByUserId/1</p> 
<p>因为没有访问权限，会跳转到授权服务器登录界面</p> 
<p><img src="https://images2.imgbox.com/04/21/Py1JMfhW_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>输入用户：hushang，密码：123456，提交登录，跳转到授权确认页面。</p> 
<p><img src="https://images2.imgbox.com/57/31/pxAY0UwG_o.png" alt="在这里插入图片描述"></p> 
<p><br><br></p> 
<p>勾选授权信息，提交确认授权，返回如下结果：</p> 
<p><img src="https://images2.imgbox.com/aa/bc/0VCkNvs0_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1c79bdcd125fba3c8f131abd94b762fc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[练习]如何使用递归算法？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8614afb07b63191b17760b9791f3788f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【AI人工智能】文心智能体，00后疯感工牌生成器，低代码工作流的简单应用以及图片快速响应解决方案，干货满满，不容错过哦</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>