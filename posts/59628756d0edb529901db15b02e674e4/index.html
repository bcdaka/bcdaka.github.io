<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenCV及rembg去除图像背景 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/59628756d0edb529901db15b02e674e4/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="OpenCV及rembg去除图像背景">
  <meta property="og:description" content="OpenCV去除图像背景 去除图像背景，需要综合使用二值化（thresholding）、腐蚀（erosion）、膨胀（dilation）以及位运算（bitwise operations），代码如下：
#include &#34;opencv2/imgcodecs.hpp&#34; #include &#34;opencv2/highgui.hpp&#34; #include &#34;opencv2/imgproc.hpp&#34; #include &lt;iostream&gt; using namespace cv; int main(int argc, char** argv) { CommandLineParser parser(argc, argv, &#34;{@input | dog.jpg | input image}&#34;); // Read an image Mat src = imread(samples::findFile(parser.get&lt;String&gt;(&#34;@input&#34;))); if (src.empty()) { std::cout &lt;&lt; &#34;Could not open or find the image!\n&#34; &lt;&lt; std::endl; std::cout &lt;&lt; &#34;Usage: &#34; &lt;&lt; argv[0] &lt;&lt; &#34; &lt;Input image&gt;&#34; &lt;&lt; std::endl; return EXIT_FAILURE; } // Convert the image to grayscale Mat grayImg; cvtColor(src, grayImg, COLOR_BGR2GRAY); // Remove the background using a threshold // median filter is applied to reduce noise in the image // ksize is 5 Mat grayImgBlurred; medianBlur(grayImg, grayImgBlurred, 5); // A binary threshold is applied to the grayscale image using a threshold Mat binaryImg; double thresh = threshold(grayImgBlurred, binaryImg, 150, 255, THRESH_BINARY_INV); // Output the thresh std::cout &lt;&lt; thresh &lt;&lt; std::endl; // The binary image is eroded to remove small objects and fill in small gaps using erode Mat erodedMask; erode(binaryImg, erodedMask, getStructuringElement(MORPH_RECT, Size(3, 3)), Point(-1, 1), 2); // The binary image is dilated to expand the remaining foreground objects # and fill in gaps using dilate Mat mask; dilate(erodedMask, mask, getStructuringElement(MORPH_RECT, Size(3, 3)), Point(-1, 1), 2); // The original input image is combined with the binary mask using bitwise_and Mat backgroundRemovedImg; bitwise_and(src, src, backgroundRemovedImg, mask); // Display the processed images imshow(&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-04T18:15:35+08:00">
    <meta property="article:modified_time" content="2024-08-04T18:15:35+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenCV及rembg去除图像背景</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="OpenCV_0"></a>OpenCV去除图像背景</h2> 
<p>去除图像背景，需要综合使用二值化（thresholding）、腐蚀（erosion）、膨胀（dilation）以及位运算（bitwise operations），代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/imgcodecs.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/highgui.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/imgproc.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    CommandLineParser <span class="token function">parser</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"{@input | dog.jpg | input image}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Read an image</span>
    Mat src <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>samples<span class="token double-colon punctuation">::</span><span class="token function">findFile</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span>String<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"@input"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>src<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not open or find the image!\n"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Usage: "</span> <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" &lt;Input image&gt;"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> EXIT_FAILURE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Convert the image to grayscale</span>
    Mat grayImg<span class="token punctuation">;</span>
    <span class="token function">cvtColor</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> grayImg<span class="token punctuation">,</span> COLOR_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Remove the background using a threshold</span>
    <span class="token comment">// median filter is applied to reduce noise in the image</span>
    <span class="token comment">// ksize is 5</span>
    Mat grayImgBlurred<span class="token punctuation">;</span>
    <span class="token function">medianBlur</span><span class="token punctuation">(</span>grayImg<span class="token punctuation">,</span> grayImgBlurred<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// A binary threshold is applied to the grayscale image using a threshold</span>
    Mat binaryImg<span class="token punctuation">;</span>
    <span class="token keyword">double</span> thresh <span class="token operator">=</span> <span class="token function">threshold</span><span class="token punctuation">(</span>grayImgBlurred<span class="token punctuation">,</span> binaryImg<span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> THRESH_BINARY_INV<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Output the thresh</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> thresh <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">// The binary image is eroded to remove small objects and fill in small gaps using erode</span>
    Mat erodedMask<span class="token punctuation">;</span>
    <span class="token function">erode</span><span class="token punctuation">(</span>binaryImg<span class="token punctuation">,</span> erodedMask<span class="token punctuation">,</span> <span class="token function">getStructuringElement</span><span class="token punctuation">(</span>MORPH_RECT<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// The binary image is dilated to expand the remaining foreground objects # and fill in gaps using dilate</span>
    Mat mask<span class="token punctuation">;</span>
    <span class="token function">dilate</span><span class="token punctuation">(</span>erodedMask<span class="token punctuation">,</span> mask<span class="token punctuation">,</span> <span class="token function">getStructuringElement</span><span class="token punctuation">(</span>MORPH_RECT<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// The original input image is combined with the binary mask using bitwise_and</span>
    Mat backgroundRemovedImg<span class="token punctuation">;</span>
    <span class="token function">bitwise_and</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src<span class="token punctuation">,</span> backgroundRemovedImg<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Display the processed images</span>
    <span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"Background Removed Image"</span><span class="token punctuation">,</span> backgroundRemovedImg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EXIT_SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment">###Background removal is removing the background from an image</span>

<span class="token keyword">import</span> cv2

<span class="token comment"># Read an image</span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'../data/dog.jpg'</span><span class="token punctuation">)</span>
<span class="token comment"># Convert the image to grayscale</span>
gray_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
  
<span class="token comment"># Remove the background using a threshold</span>
<span class="token comment"># median filter is applied to reduce noise in the image</span>
gray_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>medianBlur<span class="token punctuation">(</span>gray_img<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># A binary threshold is applied to the grayscale image using a threshold</span>
ret<span class="token punctuation">,</span> thresh <span class="token operator">=</span> cv2<span class="token punctuation">.</span>threshold<span class="token punctuation">(</span>gray_img<span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>THRESH_BINARY_INV<span class="token punctuation">)</span>

<span class="token comment"># The binary image is eroded to remove small objects and fill in small gaps using erode</span>
mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>erode<span class="token punctuation">(</span>thresh<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> iterations<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment"># The binary image is dilated to expand the remaining foreground objects # and fill in gaps using dilate</span>
mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dilate<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> iterations<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token comment"># The original input image is combined with the binary mask using bitwise_and</span>
background_removed_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>bitwise_and<span class="token punctuation">(</span>img<span class="token punctuation">,</span> img<span class="token punctuation">,</span> mask<span class="token operator">=</span>mask<span class="token punctuation">)</span>

<span class="token comment"># Display the processed images </span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'Background Removed Image'</span><span class="token punctuation">,</span> background_removed_img<span class="token punctuation">)</span>


<span class="token comment"># Wait for a key press and then close the windows</span>
cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>原图：<br> <img src="https://images2.imgbox.com/a0/38/6X7xzq2r_o.jpg" alt="原来的狗狗"><br> 处理后：<br> <img src="https://images2.imgbox.com/19/8b/NTzH9A55_o.png" alt="处理后的狗狗"><br> 显然，这个结果并不美丽，我们可以尝试修改参数修正，但结果总是难以令人满意。于是采用更好更省事的办法，引用<code>rembg</code>库，调用u2net模型，去除背景。</p> 
<h2><a id="rembg_100"></a>使用<code>rembg</code>库去除图像背景</h2> 
<p><a href="https://pypi.org/project/rembg/" rel="nofollow"><code>rembg</code></a>库地址为：<code>https://pypi.org/project/rembg/</code>，这是一个基于机器学习模型的库，安装命令如下：</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> rembg
</code></pre> 
<p>如果有CUDA，可以安装GPU版：</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> rembg<span class="token punctuation">[</span>gpu<span class="token punctuation">]</span>
</code></pre> 
<p>使用该库，去除图像背景的代码如下：</p> 
<pre><code class="prism language-python"><span class="token comment">### For background removal using rembg library</span>

<span class="token keyword">from</span> rembg <span class="token keyword">import</span> remove
<span class="token keyword">import</span> cv2

<span class="token comment">#input path for image</span>
input_path <span class="token operator">=</span> <span class="token string">'../data/dog.jpg'</span>
output_path <span class="token operator">=</span> <span class="token string">'output.png'</span>

<span class="token comment">#read the image</span>
<span class="token builtin">input</span> <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>input_path<span class="token punctuation">)</span>
output <span class="token operator">=</span> remove<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
<span class="token comment"># save the image </span>
cv2<span class="token punctuation">.</span>imwrite<span class="token punctuation">(</span>output_path<span class="token punctuation">,</span> output<span class="token punctuation">)</span>

<span class="token comment"># Display the processed images </span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'output.png'</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'Background Removed Image'</span><span class="token punctuation">,</span> img<span class="token punctuation">)</span>

<span class="token comment"># Wait for a key press and then close the windows</span>
cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>运行效果如下：</p> 
<p><img src="https://images2.imgbox.com/dd/db/LfIEd6SA_o.png" alt="去除背景后的狗狗"><br> 效果较之于第一种方法，更简洁，当然，安装的包也是很多的。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8d922ea996b42ae9e4f9fdc40a3cc201/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Yarn：一个快速、可靠且安全的JavaScript包管理工具</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aa30eadd817e6ed2a3ecfb0f278949ee/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">目标跟踪那些事</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>