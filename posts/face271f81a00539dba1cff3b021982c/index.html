<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>LoRa模型训练教程（炼丹，Stable Diffusion） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/face271f81a00539dba1cff3b021982c/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="LoRa模型训练教程（炼丹，Stable Diffusion）">
  <meta property="og:description" content="1. lora介绍（Low Rank Adaption） 何为LoRA？LoRA并不是扩散模型专有的技术，而是从隔壁语言模型（LLM）迁移过来的，旨在解决避免将整个模型参数拷贝下来才能对模型进行调校的问题。因为大型语言模型的参数量过于恐怖，比如最近新出的GPT-4参数量约为100 万亿。
LoRA采用的方式是向原有的模型中插入新的数据处理层，这样就避免了去修改原有的模型参数，从而避免将整个模型进行拷贝的情况，同时其也优化了插入层的参数量，最终实现了一种很轻量化的模型调校方法。
和上文提到的Hypernetwork相同，LoRA在稳定扩散模型里也将注意打在了crossattention（注意力交叉）机制上，LoRA将会将自己的权重添加到注意力交叉层的权重中，以此来实现微调。
添加是以向量（矩阵）的形式，如果这样做，LoRA势必需要存储同样大小的参数，那么LoRA又有了个好点子，直接以向量（矩阵）相乘的形式存储，最终文件大小就会小很多了。 https://www.bilibili.com/read/cv22533819?spm_id_from=333.999.0.0
2. 环境准备 为了使用LoRa，需要stable-diffusion-webui的环境：
stable-diffusion-webui
想要自己训练lora，可以使用以下工具
lora-scripts（LoRA training scripts for kohya-ss/sd-scripts）
3. 模型训练 各种大模型以及社区训练好的模型可以在这里下载civitai（需要魔法），使用方法可见第五章。
1. 数据准备（最重要） 数据准备是训练过程中的重要步骤，因为好的数据集会大大提高模型的性能，质量比数量更重。
需要关注的主要点有：
数据质量(抠图)：确保你的图像是准确的、清晰的，没有噪声和其他不必要的干扰因素。因此，需要进行目标识别与抠图。我找了几个实用的方式，手动操作的话可以用这个网站，免费全尺寸抠图人像抠图（单张操作）。数量多的话可以用remove.bg网站的api来进行抠图，有每月50张的免费额度。附录有写好的python脚本，填上api和图像目录就行。
【更新】 通过多个本地分割案例测试，该方法Semantic Guided Human Matting也能够很好的进行抠图,可以点击链接进入相应的git仓库按步骤进行本地部署。图像尺寸：在训练模型之前，需要将所有的图像调整到同一尺寸。图像尺寸的选择取决于你的模型和数据，基于sd-1.5一般为512*512. 修改图像尺寸可以使用该网站的功能。修改尺寸工具数据标签：每个样本都应该有准确的标签。可以使用多种方法生成标签Tag。我们可以手动填写每个标签，但建议大家先批量自动生成，然后再进行手动修改，这样的效果可以更好。
如果你需要某一部分是可控的，那么就将这一部分放在标签内；如果某一部分是该LoRA的特征，那么最好不要去添加。
举例：如果我们需要后续可以修改头发的颜色，那就在标签内填写现在有头发特征，如黑发｜长发，这样后续才方便我们使用SD生成时进行修改。如果关于该图的所有Tag内都没有关于头发的描述，那么AI将会理解关于头发的部分，是这个LoRA的一部分，是内置在LoRA模型内无法进行单独修改的。数据的多样性：你的数据应该涵盖所有可能的情况。例如，数据集应该包括各种不同的角度和环境条件下的图像。数据数量：至少大于5张，越多越好，一般10-20张够用。 参考资料：图像素材准备与打标
2. 模型选择 在开始训练前，你需要选择一个适合你任务的模型。模型的选择通常取决于你的任务类型以及你的计算资源，看是训练 真人模型还是动漫模型，需要选择合适的大模型底膜。例如真人模型要选 majic_mix.safetensor.
3. 训练过程 在开始训练前，你需要设置一些超参数。这些参数在lora-scripts的train.sh中定义：
# Train data path | 设置训练用模型、图片 pretrained_model=&#34;./sd-models/model.ckpt&#34; # base model path | 底模路径 is_v2_model=0 # SD2.0 model | SD2.0模型 2.0模型下 clip_skip 默认无效 parameterization=0 # parameterization | 参数化 本参数需要和 V2 参数同步使用 实验性功能 train_data_dir=&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-24T17:00:18+08:00">
    <meta property="article:modified_time" content="2024-01-24T17:00:18+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">LoRa模型训练教程（炼丹，Stable Diffusion）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_loraLow_Rank_Adaption_1"></a>1. lora介绍（Low Rank Adaption）</h3> 
<p>何为LoRA？LoRA并不是扩散模型专有的技术，而是从隔壁语言模型（LLM）迁移过来的，旨在解决避免将整个模型参数拷贝下来才能对模型进行调校的问题。因为大型语言模型的参数量过于恐怖，比如最近新出的GPT-4参数量约为100 万亿。</p> 
<p>LoRA采用的方式是向原有的模型中插入新的数据处理层，这样就避免了去修改原有的模型参数，从而避免将整个模型进行拷贝的情况，同时其也优化了插入层的参数量，最终实现了一种很轻量化的模型调校方法。</p> 
<p>和上文提到的Hypernetwork相同，LoRA在稳定扩散模型里也将注意打在了crossattention（注意力交叉）机制上，LoRA将会将自己的权重添加到注意力交叉层的权重中，以此来实现微调。</p> 
<p>添加是以向量（矩阵）的形式，如果这样做，LoRA势必需要存储同样大小的参数，那么LoRA又有了个好点子，直接以向量（矩阵）相乘的形式存储，最终文件大小就会小很多了。 https://www.bilibili.com/read/cv22533819?spm_id_from=333.999.0.0</p> 
<h3><a id="2__11"></a>2. 环境准备</h3> 
<p>为了使用LoRa，需要stable-diffusion-webui的环境：<br> <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui">stable-diffusion-webui</a></p> 
<p>想要自己训练lora，可以使用以下工具<br> <a href="https://github.com/Akegarasu/lora-scripts">lora-scripts</a>（LoRA training scripts for kohya-ss/sd-scripts）</p> 
<h3><a id="3__19"></a>3. 模型训练</h3> 
<p>各种大模型以及社区训练好的模型可以在这里下载<a href="civitai.com" rel="nofollow">civitai</a>（需要魔法），使用方法可见第五章。</p> 
<h4><a id="1__23"></a>1. 数据准备（最重要）</h4> 
<p>数据准备是训练过程中的重要步骤，因为好的数据集会大大提高模型的性能，<strong>质量比数量更重</strong>。<br> 需要关注的主要点有：</p> 
<ul><li><strong>数据质量(抠图)</strong>：确保你的图像是准确的、清晰的，没有噪声和其他不必要的干扰因素。因此，需要进行目标识别与抠图。我找了几个实用的方式，手动操作的话可以用这个网站，免费全尺寸抠图<a href="https://www.erase.bg/zh/upload" rel="nofollow">人像抠图（单张操作）</a>。数量多的话可以用<a href="remove.bg" rel="nofollow">remove.bg</a>网站的api来进行抠图，有每月50张的免费额度。附录有写好的python脚本，填上api和图像目录就行。<br> 【更新】 通过多个本地分割案例测试，该方法<a href="https://github.com/cxgincsu/SemanticGuidedHumanMatting">Semantic Guided Human Matting</a>也能够很好的进行抠图,可以点击链接进入相应的git仓库按步骤进行本地部署。</li><li><strong>图像尺寸</strong>：在训练模型之前，需要将所有的图像调整到同一尺寸。图像尺寸的选择取决于你的模型和数据，基于sd-1.5一般为512*512. 修改图像尺寸可以使用该网站的功能。<a href="https://www.birme.net/" rel="nofollow">修改尺寸工具</a></li><li><strong>数据标签</strong>：每个样本都应该有准确的标签。可以使用多种方法生成标签Tag。我们可以手动填写每个标签，但建议大家先批量自动生成，然后再进行手动修改，这样的效果可以更好。<br> 如果你需要某一部分是可控的，那么就将这一部分放在标签内；如果某一部分是该LoRA的特征，那么最好不要去添加。<br> 举例：如果我们需要后续可以修改头发的颜色，那就在标签内填写现在有头发特征，如黑发｜长发，这样后续才方便我们使用SD生成时进行修改。如果关于该图的所有Tag内都没有关于头发的描述，那么AI将会理解关于头发的部分，是这个LoRA的一部分，是内置在LoRA模型内无法进行单独修改的。</li><li><strong>数据的多样性</strong>：你的数据应该涵盖所有可能的情况。例如，数据集应该包括各种不同的角度和环境条件下的图像。</li><li><strong>数据数量</strong>：至少大于5张，越多越好，一般10-20张够用。</li></ul> 
<p>参考资料：<a href="https://openai.wiki/sd-lora-prepare.html" rel="nofollow">图像素材准备与打标</a></p> 
<h4><a id="2__38"></a>2. 模型选择</h4> 
<p>在开始训练前，你需要选择一个适合你任务的模型。模型的选择通常取决于你的任务类型以及你的计算资源，看是训练 真人模型还是动漫模型，需要选择合适的大模型底膜。例如真人模型要选 majic_mix.safetensor.</p> 
<h4><a id="3__42"></a>3. 训练过程</h4> 
<p>在开始训练前，你需要设置一些超参数。这些参数在<a href="https://github.com/Akegarasu/lora-scripts">lora-scripts</a>的<em><strong>train.sh</strong></em>中定义：</p> 
<pre><code class="prism language-bash">
<span class="token comment"># Train data path | 设置训练用模型、图片</span>
<span class="token assign-left variable">pretrained_model</span><span class="token operator">=</span><span class="token string">"./sd-models/model.ckpt"</span> <span class="token comment"># base model path | 底模路径</span>
<span class="token assign-left variable">is_v2_model</span><span class="token operator">=</span><span class="token number">0</span>                             <span class="token comment"># SD2.0 model | SD2.0模型 2.0模型下 clip_skip 默认无效</span>
<span class="token assign-left variable">parameterization</span><span class="token operator">=</span><span class="token number">0</span>                        <span class="token comment"># parameterization | 参数化 本参数需要和 V2 参数同步使用 实验性功能</span>
<span class="token assign-left variable">train_data_dir</span><span class="token operator">=</span><span class="token string">"./train/aki"</span>              <span class="token comment"># train dataset path | 训练数据集路径</span>
<span class="token assign-left variable">reg_data_dir</span><span class="token operator">=</span><span class="token string">""</span>                           <span class="token comment"># directory for regularization images | 正则化数据集路径，默认不使用正则化图像。</span>

<span class="token comment"># Network settings | 网络设置</span>
<span class="token assign-left variable">network_module</span><span class="token operator">=</span><span class="token string">"networks.lora"</span> <span class="token comment"># 在这里将会设置训练的网络种类，默认为 networks.lora 也就是 LoRA 训练。如果你想训练 LyCORIS（LoCon、LoHa） 等，则修改这个值为 lycoris.kohya</span>
<span class="token assign-left variable">network_weights</span><span class="token operator">=</span><span class="token string">""</span>             <span class="token comment"># pretrained weights for LoRA network | 若需要从已有的 LoRA 模型上继续训练，请填写 LoRA 模型路径。</span>
<span class="token assign-left variable">network_dim</span><span class="token operator">=</span><span class="token number">32</span>                 <span class="token comment"># network dim | 常用 4~128，不是越大越好   </span>
<span class="token assign-left variable">network_alpha</span><span class="token operator">=</span><span class="token number">32</span>               <span class="token comment"># network alpha | 常用与 network_dim 相同的值或者采用较小的值，如 network_dim的一半 防止下溢。默认值为 1，使用较小的 alpha 需要提升学习率。</span>

<span class="token comment"># Train related params | 训练相关参数</span>
<span class="token assign-left variable">resolution</span><span class="token operator">=</span><span class="token string">"512,512"</span>  <span class="token comment"># image resolution w,h. 图片分辨率，宽,高。支持非正方形，但必须是 64 倍数。</span>
<span class="token assign-left variable">batch_size</span><span class="token operator">=</span><span class="token number">1</span>          <span class="token comment"># batch size</span>
<span class="token assign-left variable">max_train_epoches</span><span class="token operator">=</span><span class="token number">10</span>  <span class="token comment"># max train epoches | 最大训练 epoch</span>
<span class="token assign-left variable">save_every_n_epochs</span><span class="token operator">=</span><span class="token number">2</span> <span class="token comment"># save every n epochs | 每 N 个 epoch 保存一次</span>

<span class="token assign-left variable">train_unet_only</span><span class="token operator">=</span><span class="token number">0</span>         <span class="token comment"># train U-Net only | 仅训练 U-Net，开启这个会牺牲效果大幅减少显存使用。6G显存可以开启</span>
<span class="token assign-left variable">train_text_encoder_only</span><span class="token operator">=</span><span class="token number">0</span> <span class="token comment"># train Text Encoder only | 仅训练 文本编码器</span>
<span class="token assign-left variable">stop_text_encoder_training</span><span class="token operator">=</span><span class="token number">0</span> <span class="token comment"># stop text encoder training | 在第N步时停止训练文本编码器</span>

<span class="token assign-left variable">noise_offset</span><span class="token operator">=</span><span class="token string">"0"</span>  <span class="token comment"># noise offset | 在训练中添加噪声偏移来改良生成非常暗或者非常亮的图像，如果启用，推荐参数为0.1</span>
<span class="token assign-left variable">keep_tokens</span><span class="token operator">=</span><span class="token number">0</span>   <span class="token comment"># keep heading N tokens when shuffling caption tokens | 在随机打乱 tokens 时，保留前 N 个不变。</span>
<span class="token assign-left variable">min_snr_gamma</span><span class="token operator">=</span><span class="token number">0</span> <span class="token comment"># minimum signal-to-noise ratio (SNR) value for gamma-ray | 伽马射线事件的最小信噪比（SNR）值  默认为 0</span>

<span class="token comment"># Learning rate | 学习率</span>
<span class="token assign-left variable">lr</span><span class="token operator">=</span><span class="token string">"1e-4"</span>
<span class="token assign-left variable">unet_lr</span><span class="token operator">=</span><span class="token string">"1e-4"</span>
<span class="token assign-left variable">text_encoder_lr</span><span class="token operator">=</span><span class="token string">"1e-5"</span>
<span class="token assign-left variable">lr_scheduler</span><span class="token operator">=</span><span class="token string">"cosine_with_restarts"</span> <span class="token comment"># "linear", "cosine", "cosine_with_restarts", "polynomial", "constant", "constant_with_warmup", "adafactor"</span>
<span class="token assign-left variable">lr_warmup_steps</span><span class="token operator">=</span><span class="token number">0</span>                   <span class="token comment"># warmup steps | 学习率预热步数，lr_scheduler 为 constant 或 adafactor 时该值需要设为0。</span>
<span class="token assign-left variable">lr_restart_cycles</span><span class="token operator">=</span><span class="token number">1</span>                 <span class="token comment"># cosine_with_restarts restart cycles | 余弦退火重启次数，仅在 lr_scheduler 为 cosine_with_restarts 时起效。</span>

<span class="token comment"># Output settings | 输出设置</span>
<span class="token assign-left variable">output_name</span><span class="token operator">=</span><span class="token string">"aki"</span>           <span class="token comment"># output model name | 模型保存名称</span>
<span class="token assign-left variable">save_model_as</span><span class="token operator">=</span><span class="token string">"safetensors"</span> <span class="token comment"># model save ext | 模型保存格式 ckpt, pt, safetensors</span>

<span class="token comment"># Resume training state | 恢复训练设置</span>
<span class="token assign-left variable">save_state</span><span class="token operator">=</span><span class="token number">0</span> <span class="token comment"># save state | 保存训练状态 名称类似于 &lt;output_name&gt;-??????-state ?????? 表示 epoch 数</span>
<span class="token assign-left variable">resume</span><span class="token operator">=</span><span class="token string">""</span>    <span class="token comment"># resume from state | 从某个状态文件夹中恢复训练 需配合上方参数同时使用 由于规范文件限制 epoch 数和全局步数不会保存 即使恢复时它们也从 1 开始 与 network_weights 的具体实现操作并不一致</span>

<span class="token comment"># 其他设置</span>
<span class="token assign-left variable">min_bucket_reso</span><span class="token operator">=</span><span class="token number">256</span>              <span class="token comment"># arb min resolution | arb 最小分辨率</span>
<span class="token assign-left variable">max_bucket_reso</span><span class="token operator">=</span><span class="token number">1024</span>             <span class="token comment"># arb max resolution | arb 最大分辨率</span>
<span class="token assign-left variable">persistent_data_loader_workers</span><span class="token operator">=</span><span class="token number">0</span> <span class="token comment"># persistent dataloader workers | 容易爆内存，保留加载训练集的worker，减少每个 epoch 之间的停顿</span>
<span class="token assign-left variable">clip_skip</span><span class="token operator">=</span><span class="token number">2</span>                      <span class="token comment"># clip skip | 玄学 一般用 2</span>

<span class="token comment"># 优化器设置</span>
<span class="token assign-left variable">optimizer_type</span><span class="token operator">=</span><span class="token string">"AdamW8bit"</span> <span class="token comment"># Optimizer type | 优化器类型 默认为 AdamW8bit，可选：AdamW AdamW8bit Lion SGDNesterov SGDNesterov8bit DAdaptation AdaFactor</span>

<span class="token comment"># LyCORIS 训练设置</span>
<span class="token assign-left variable">algo</span><span class="token operator">=</span><span class="token string">"lora"</span>  <span class="token comment"># LyCORIS network algo | LyCORIS 网络算法 可选 lora、loha、lokr、ia3、dylora。lora即为locon</span>
<span class="token assign-left variable">conv_dim</span><span class="token operator">=</span><span class="token number">4</span>   <span class="token comment"># conv dim | 类似于 network_dim，推荐为 4</span>
<span class="token assign-left variable">conv_alpha</span><span class="token operator">=</span><span class="token number">4</span> <span class="token comment"># conv alpha | 类似于 network_alpha，可以采用与 conv_dim 一致或者更小的值</span>
<span class="token assign-left variable">dropout</span><span class="token operator">=</span><span class="token string">"0"</span>  <span class="token comment"># dropout | dropout 概率, 0 为不使用 dropout, 越大则 dropout 越多，推荐 0~0.5， LoHa/LoKr/(IA)^3暂时不支持</span>

</code></pre> 
<p>实际经过测试以后发现这两个值设置为128，64或128，128训练的效果会比较好：</p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">network_dim</span><span class="token operator">=</span><span class="token number">128</span>                
<span class="token assign-left variable">network_alpha</span><span class="token operator">=</span><span class="token number">128</span>             
</code></pre> 
<p><em><strong>batch_size</strong></em>表示一次训练同时有几张图一起，越大速度越快，但相应显存要求也越高，我是4090，改成了6.</p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">batch_size</span><span class="token operator">=</span><span class="token number">6</span>          <span class="token comment"># batch size</span>
</code></pre> 
<p>lr学习率，如果训练的时候出现 loss=nan 一般就是学习率设大了，可以参考下述参数：</p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">lr</span><span class="token operator">=</span><span class="token string">"1e-5"</span>
<span class="token assign-left variable">unet_lr</span><span class="token operator">=</span><span class="token string">"1e-5"</span>
<span class="token assign-left variable">text_encoder_lr</span><span class="token operator">=</span><span class="token string">"1e-6"</span>
</code></pre> 
<p>如果有多显卡用于训练，添加以下代码（实例为两张显卡的情况）：</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">CUDA_VISIBLE_DEVICES</span><span class="token operator">=</span><span class="token number">0,1</span>
<span class="token assign-left variable">multi_gpu</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre> 
<p>并在源代码73行改成这样，添加 --num_processes=2：</p> 
<pre><code class="prism language-bash"><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">$multi_gpu</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token assign-left variable">launchArgs</span><span class="token operator">+=</span><span class="token punctuation">(</span><span class="token string">"--multi_gpu --num_processes=2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">fi</span>
</code></pre> 
<h4><a id="4__136"></a>4. 模型验证</h4> 
<p>一旦模型训练完毕，你就需要验证其性能。这通常通过在测试集上评估模型来实现。一般查看loss在0.08左右就是训练的不错的结果了</p> 
<p>此外，还可以在stable-diffusion网页版中使用plot-xyz功能进行测试，通过可视化的方式直观地了解模型的性能。</p> 
<p>参考资料：<a href="https://www.bilibili.com/video/BV1Cs4y1q7wQ/" rel="nofollow">调参验证</a></p> 
<h3><a id="5_Stable_Diffusion_WebUILoRa_144"></a>5. 在Stable Diffusion WebUI中加载和使用LoRa模型</h3> 
<p>c站下载相应模型后将文件放入 stable-diffusion-webui\models\Lora文件夹中<br> 选择好ckpt模型后点击1处再点击2处（若未显示模型则点击刷新）<br> <img src="https://images2.imgbox.com/8c/8d/esDBE6AF_o.png" alt="在这里插入图片描述"><br> 网上都有，可供参考资料：<a href="https://zhuanlan.zhihu.com/p/625192010" rel="nofollow">如何使用lora</a></p> 
<h3><a id="6__152"></a>6. 附录</h3> 
<p>利用<a href="remove.bg" rel="nofollow">remove.bg</a>网站的api来进行抠图的脚本</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> absolute_import
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> os
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor<span class="token punctuation">,</span> as_completed
<span class="token keyword">import</span> signal
<span class="token keyword">from</span> functools <span class="token keyword">import</span> partial

<span class="token comment"># Specify the API keys to use. Each API key can process 50 images per month for free.</span>
API_ENDPOINT <span class="token operator">=</span> <span class="token string">"https://api.remove.bg/v1.0/removebg"</span>
<span class="token comment"># List of API keys for load balancing</span>
api_keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'api-key'</span><span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">RemoveBg</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> api_key<span class="token punctuation">,</span> error_log_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>__api_key <span class="token operator">=</span> api_key
        logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span>error_log_file<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_check_arguments</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> type_level<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token punctuation">,</span> channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Check if arguments are valid."""</span>
        <span class="token keyword">if</span> size <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"auto"</span><span class="token punctuation">,</span> <span class="token string">"preview"</span><span class="token punctuation">,</span> <span class="token string">"small"</span><span class="token punctuation">,</span> <span class="token string">"regular"</span><span class="token punctuation">,</span> <span class="token string">"medium"</span><span class="token punctuation">,</span> <span class="token string">"hd"</span><span class="token punctuation">,</span> <span class="token string">"full"</span><span class="token punctuation">,</span> <span class="token string">"4k"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"size argument wrong"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">type</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"auto"</span><span class="token punctuation">,</span> <span class="token string">"person"</span><span class="token punctuation">,</span> <span class="token string">"product"</span><span class="token punctuation">,</span> <span class="token string">"animal"</span><span class="token punctuation">,</span> <span class="token string">"car"</span><span class="token punctuation">,</span> <span class="token string">"car_interior"</span><span class="token punctuation">,</span> <span class="token string">"car_part"</span><span class="token punctuation">,</span> <span class="token string">"transportation"</span><span class="token punctuation">,</span> <span class="token string">"graphics"</span><span class="token punctuation">,</span> <span class="token string">"other"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"type argument wrong"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> type_level <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"none"</span><span class="token punctuation">,</span> <span class="token string">"latest"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"type_level argument wrong"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token builtin">format</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"jpg"</span><span class="token punctuation">,</span> <span class="token string">"zip"</span><span class="token punctuation">,</span> <span class="token string">"png"</span><span class="token punctuation">,</span> <span class="token string">"auto"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"format argument wrong"</span><span class="token punctuation">)</span> 
 
        <span class="token keyword">if</span> channels <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"rgba"</span><span class="token punctuation">,</span> <span class="token string">"alpha"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"channels argument wrong"</span><span class="token punctuation">)</span> 
        
    <span class="token keyword">def</span> <span class="token function">_output_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">,</span> new_file_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># If successful, write out the file</span>
        <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> requests<span class="token punctuation">.</span>codes<span class="token punctuation">.</span>ok<span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>new_file_name<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> removed_bg_file<span class="token punctuation">:</span>
                removed_bg_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
        <span class="token comment"># Otherwise, print out the error</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            error_reason <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"errors"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Unable to save %s due to %s"</span><span class="token punctuation">,</span> new_file_name<span class="token punctuation">,</span> error_reason<span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">remove_background_from_img_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img_file_path<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token string">"preview"</span><span class="token punctuation">,</span> 
                                       <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span> type_level<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">,</span> 
                                       <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">,</span> roi<span class="token operator">=</span><span class="token string">"0 0 100% 100%"</span><span class="token punctuation">,</span> 
                                       crop<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> scale<span class="token operator">=</span><span class="token string">"original"</span><span class="token punctuation">,</span> 
                                       position<span class="token operator">=</span><span class="token string">"original"</span><span class="token punctuation">,</span> channels<span class="token operator">=</span><span class="token string">"rgba"</span><span class="token punctuation">,</span> 
                                       shadow<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> semitransparency<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                       bg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> bg_type<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> new_file_name<span class="token operator">=</span><span class="token string">"no-bg.png"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>_check_arguments<span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token punctuation">,</span> type_level<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token punctuation">,</span> channels<span class="token punctuation">)</span>

        img_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>img_file_path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
        files <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'image_file'</span><span class="token punctuation">:</span> img_file<span class="token punctuation">}</span>
        
        data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'size'</span><span class="token punctuation">:</span> size<span class="token punctuation">,</span>
            <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token builtin">type</span><span class="token punctuation">,</span>
            <span class="token string">'type_level'</span><span class="token punctuation">:</span> type_level<span class="token punctuation">,</span>
            <span class="token string">'format'</span><span class="token punctuation">:</span> <span class="token builtin">format</span><span class="token punctuation">,</span>
            <span class="token string">'roi'</span><span class="token punctuation">:</span> roi<span class="token punctuation">,</span>
            <span class="token string">'crop'</span><span class="token punctuation">:</span> <span class="token string">'true'</span> <span class="token keyword">if</span> crop <span class="token keyword">else</span> <span class="token string">'false'</span><span class="token punctuation">,</span>
            <span class="token string">'crop_margin'</span><span class="token punctuation">:</span> crop<span class="token punctuation">,</span>
            <span class="token string">'scale'</span><span class="token punctuation">:</span> scale<span class="token punctuation">,</span>
            <span class="token string">'position'</span><span class="token punctuation">:</span> position<span class="token punctuation">,</span>
            <span class="token string">'channels'</span><span class="token punctuation">:</span> channels<span class="token punctuation">,</span>
            <span class="token string">'add_shadow'</span><span class="token punctuation">:</span> <span class="token string">'true'</span> <span class="token keyword">if</span> shadow <span class="token keyword">else</span> <span class="token string">'false'</span><span class="token punctuation">,</span>
            <span class="token string">'semitransparency'</span><span class="token punctuation">:</span> <span class="token string">'true'</span> <span class="token keyword">if</span> semitransparency <span class="token keyword">else</span> <span class="token string">'false'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># Open image file to send information post request and send the post request</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>
            API_ENDPOINT<span class="token punctuation">,</span>
            files<span class="token operator">=</span>files<span class="token punctuation">,</span>
            data<span class="token operator">=</span>data<span class="token punctuation">,</span>
            headers<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'X-Api-Key'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>__api_key<span class="token punctuation">}</span><span class="token punctuation">)</span>
        response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_output_file<span class="token punctuation">(</span>response<span class="token punctuation">,</span> new_file_name<span class="token punctuation">)</span>

        <span class="token comment"># Close original file</span>
        img_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        
<span class="token comment"># Specify the input folder containing the images</span>
input_folder <span class="token operator">=</span> <span class="token string">'文件地址'</span>

<span class="token comment"># Specify the output folder to save the processed images</span>
output_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>input_folder<span class="token punctuation">,</span> <span class="token string">'cutout'</span><span class="token punctuation">)</span>

error_log_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>input_folder<span class="token punctuation">,</span> <span class="token string">'error.log'</span><span class="token punctuation">)</span>

<span class="token comment"># Create an instance of RemoveBg for each API key</span>
removebg_instances <span class="token operator">=</span> <span class="token punctuation">[</span>RemoveBg<span class="token punctuation">(</span>api_key<span class="token operator">=</span>key<span class="token punctuation">,</span> error_log_file<span class="token operator">=</span><span class="token string">'error.log'</span><span class="token punctuation">)</span> <span class="token keyword">for</span> key <span class="token keyword">in</span> api_keys<span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">remove_background_from_image</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> output_folder<span class="token punctuation">,</span> removebg_instance<span class="token punctuation">)</span><span class="token punctuation">:</span>
    file_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    new_file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_folder<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        removebg_instance<span class="token punctuation">.</span>remove_background_from_img_file<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> new_file_name<span class="token operator">=</span>new_file_path<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Background removed for </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>file_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error processing </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>file_path<span class="token punctuation">}</span></span><span class="token string"> with API key </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>removebg_instance<span class="token punctuation">.</span>_RemoveBg__api_key<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">remove_background_from_images_in_folder</span><span class="token punctuation">(</span>folder_path<span class="token punctuation">,</span> output_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>output_folder<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
        <span class="token comment"># Create a partial function with the fixed output folder argument</span>
        remove_bg_partial <span class="token operator">=</span> partial<span class="token punctuation">(</span>remove_background_from_image<span class="token punctuation">,</span> output_folder<span class="token operator">=</span>output_folder<span class="token punctuation">)</span>

        <span class="token comment"># List the files in the folder</span>
        file_list <span class="token operator">=</span> <span class="token punctuation">[</span>file_name <span class="token keyword">for</span> file_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>folder_path<span class="token punctuation">)</span>
                     <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>folder_path<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
                     <span class="token keyword">and</span> file_name<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token string">'.jpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># Submit tasks to the executor and store the Future objects</span>
        futures <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> file_name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>file_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
            file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>folder_path<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span>
            removebg_instance <span class="token operator">=</span> removebg_instances<span class="token punctuation">[</span>i <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>removebg_instances<span class="token punctuation">)</span><span class="token punctuation">]</span>
            futures<span class="token punctuation">.</span>append<span class="token punctuation">(</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>remove_bg_partial<span class="token punctuation">,</span> file_path<span class="token punctuation">,</span> removebg_instance<span class="token operator">=</span>removebg_instance<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># Wait for the tasks to complete and handle keyboard interrupts</span>
            <span class="token keyword">for</span> future <span class="token keyword">in</span> as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>
                future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"All futures have completed."</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Keyboard interrupt received. Cancelling..."</span><span class="token punctuation">)</span>
            <span class="token comment"># Cancel any pending tasks</span>
            <span class="token keyword">for</span> future <span class="token keyword">in</span> futures<span class="token punctuation">:</span>
                future<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># Ensure exceptions in the cancelled tasks are propagated</span>
                future<span class="token punctuation">.</span>exception<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment"># Raise the KeyboardInterrupt to terminate the script</span>
            <span class="token keyword">raise</span>


<span class="token comment"># Set up the signal handler for SIGINT (Ctrl+C)</span>
signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> signal<span class="token punctuation">.</span>SIG_DFL<span class="token punctuation">)</span>

<span class="token comment"># Remove background from PNG and JPG images in the input folder concurrently with a maximum of 2 workers and load balancing across multiple API keys</span>
remove_background_from_images_in_folder<span class="token punctuation">(</span>input_folder<span class="token punctuation">,</span> output_folder<span class="token punctuation">)</span>

</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/28e4d8d9f8f7c8f1090fe6298d82bc58/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据结构奇妙旅程之二叉树题型解法总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4dd0213da23a99696b5eeb1ba6a72427/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python GUI框架---- PySide6安装与使用 - 打包部署</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>