<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>æ·±å…¥ç†è§£BPEã€WordPieceã€Unigramåˆ†è¯ç®—æ³• - ç¼–ç¨‹å¤§å’–</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3416ff4c6b3359868afaa2fae03e327a/">
  <meta property="og:site_name" content="ç¼–ç¨‹å¤§å’–">
  <meta property="og:title" content="æ·±å…¥ç†è§£BPEã€WordPieceã€Unigramåˆ†è¯ç®—æ³•">
  <meta property="og:description" content="ç›®å½• 1. å‰è¨€1.1 word-levelåˆ†è¯1.2 char-levelåˆ†è¯1.3 ä¸ºä»€ä¹ˆè¦æœ‰subword-levelåˆ†è¯ï¼Ÿ 2. å­è¯åˆ†è¯2.1 BPE2.1.1 å­¦ä¹ æµç¨‹2.1.2 åˆ†è¯æµç¨‹2.1.3 ä»é›¶å®ç°BPE2.1.4 è§£ç æµç¨‹ 2.2 WordPiece2.2.1 å­¦ä¹ æµç¨‹2.2.2 åˆ†è¯æµç¨‹2.2.3 ä»é›¶å®ç°WordPiece2.2.4 è§£ç æµç¨‹ 2.3 Unigram2.3.1 å­¦ä¹ æµç¨‹2.3.2 åˆ†è¯æµç¨‹2.3.3 ä»é›¶å®ç°Unigram2.3.4 è§£ç æµç¨‹ 3. ä¸‰ç§åˆ†è¯æ–¹æ³•çš„æ¯”è¾ƒRef 1. å‰è¨€ NLPä»»åŠ¡ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç¯èŠ‚å°±æ˜¯åˆ†è¯ã€‚åˆ†è¯å™¨ï¼ˆTokenizerï¼‰åœ¨æ•´ä¸ªä»»åŠ¡æµç¨‹ä¸­æ‰®æ¼”çš„è§’è‰²å¦‚ä¸‹
å³ç»™å®šä¸€æ®µæ–‡æœ¬ï¼Œåˆ†è¯å™¨ä¼šå°†å…¶åˆ†å‰²æˆä¸€ä¸ªä¸ªtokenï¼Œè¿™äº›tokenä¼šæ ¹æ®vocabè½¬åŒ–æˆå¯¹åº”çš„IDä»¥ä½œä¸ºæ¨¡å‹çš„è¾“å…¥ã€‚
å®Œæ•´çš„åˆ†è¯æµç¨‹åŒ…å«ä»¥ä¸‹å››ä¸ªæ­¥éª¤
æ ‡å‡†åŒ–é˜¶æ®µï¼ˆNormalizationï¼‰ï¼šå…ˆå°†åŸå§‹æ–‡æœ¬ï¼ˆraw textï¼‰åšä¸€ä¸ªé¢„å¤„ç†ï¼Œä¾‹å¦‚å»æ‰Unicodeå­—ç¬¦çš„é‡éŸ³ï¼ˆÃ© å˜æˆ eï¼‰ï¼Œå°†æ‰€æœ‰å­—æ¯å…¨éƒ¨è½¬åŒ–æˆå°å†™å­—æ¯ï¼ˆE å˜æˆ eï¼‰ç­‰ã€‚è¿™ä¸€æ­¥å¯ä»¥ç†è§£ä¸ºæ•°æ®æ¸…æ´—ï¼›é¢„åˆ†è¯é˜¶æ®µï¼ˆPre-tokenizationï¼‰ï¼šè¿›è¡Œä¸€éç²—ç•¥çš„åˆ†è¯ï¼Œä¾‹å¦‚åŸºäºç©ºæ ¼&amp;æ ‡ç‚¹çš„åˆ†è¯ï¼Œå³word-levelã€‚æ³¨æ„é¢„åˆ†è¯ç»“æœçš„ç²’åº¦å¿…é¡»å¤§äºæœ€ç»ˆåˆ†è¯ç»“æœçš„ç²’åº¦ï¼›æ¨¡å‹é˜¶æ®µï¼ˆModelï¼‰ï¼šåœ¨é¢„åˆ†è¯çš„è¯­æ–™ä¸Šè¿›è¡Œè®­ç»ƒï¼ˆæ³¨æ„åˆ†è¯å™¨çš„è®­ç»ƒå’Œæ¨¡å‹çš„è®­ç»ƒæ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼æ¨¡å‹çš„è®­ç»ƒæ˜¯é€šè¿‡æ¢¯åº¦ä¸‹é™æ¥é™ä½lossï¼Œå…·æœ‰éšæœºæ€§ï¼Œè€Œåˆ†è¯å™¨çš„è®­ç»ƒæ˜¯ä¸€ä¸ªç»Ÿè®¡è¿‡ç¨‹ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ç¡®å®šæ€§çš„ï¼‰ï¼›åå¤„ç†é˜¶æ®µï¼ˆPostprocessorï¼‰ï¼šæ·»åŠ ä¸€äº›ç‰¹æ®Šçš„tokenï¼Œä¾‹å¦‚BERTä¸­çš„ [CLS] å’Œ [SEP]ã€‚ åˆ†è¯çš„ç²’åº¦ä¸»è¦æœ‰ä¸‰ç§ï¼šword-levelã€char-levelå’Œsubword-levelï¼Œå¯¹äºå‰ä¸¤ç§ç²’åº¦ï¼Œåˆ™ä¸éœ€è¦ç»å†ç¬¬ä¸‰é˜¶æ®µï¼ˆæ¨¡å‹é˜¶æ®µï¼‰ã€‚
æœ¬æ–‡å°†ä¸»è¦èšç„¦äºç¬¬ä¸‰é˜¶æ®µï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹word-levelå’Œchar-levelåˆ†è¯ã€‚
1.1 word-levelåˆ†è¯ word-levelåˆ†è¯çš„ä¸€ä¸ªç›´è§‚å‡ºå‘ç‚¹æ˜¯åŸºäºç©ºæ ¼åˆ†è¯ï¼Œå³å¯¹å­—ç¬¦ä¸²è°ƒç”¨ split() æ–¹æ³•
text = &#34;Don&#39;t you love ğŸ¤— Transformers? We sure do.&#34; print(text.split()) # [&#34;Don&#39;t&#34;, &#39;you&#39;, &#39;love&#39;, &#39;ğŸ¤—&#39;, &#39;Transformers?&#39;, &#39;We&#39;, &#39;sure&#39;, &#39;do.&#39;] ä½†è¿™ä¸ªç»“æœä¸æ˜¯æœ€ä¼˜çš„ï¼Œå› ä¸º Transformers?">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-10-04T16:05:04+08:00">
    <meta property="article:modified_time" content="2023-10-04T16:05:04+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§å’–" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§å’–</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">æ·±å…¥ç†è§£BPEã€WordPieceã€Unigramåˆ†è¯ç®—æ³•</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>ç›®å½•</h4> 
 <ul><li><a href="#1__4" rel="nofollow">1. å‰è¨€</a></li><li><ul><li><a href="#11_wordlevel_36" rel="nofollow">1.1 word-levelåˆ†è¯</a></li><li><a href="#12_charlevel_65" rel="nofollow">1.2 char-levelåˆ†è¯</a></li><li><a href="#13_subwordlevel_75" rel="nofollow">1.3 ä¸ºä»€ä¹ˆè¦æœ‰subword-levelåˆ†è¯ï¼Ÿ</a></li></ul> 
  </li><li><a href="#2__87" rel="nofollow">2. å­è¯åˆ†è¯</a></li><li><ul><li><a href="#21_BPE_96" rel="nofollow">2.1 BPE</a></li><li><ul><li><a href="#211__98" rel="nofollow">2.1.1 å­¦ä¹ æµç¨‹</a></li><li><a href="#212__150" rel="nofollow">2.1.2 åˆ†è¯æµç¨‹</a></li><li><a href="#213_BPE_171" rel="nofollow">2.1.3 ä»é›¶å®ç°BPE</a></li><li><a href="#214__342" rel="nofollow">2.1.4 è§£ç æµç¨‹</a></li></ul> 
   </li><li><a href="#22_WordPiece_389" rel="nofollow">2.2 WordPiece</a></li><li><ul><li><a href="#221__391" rel="nofollow">2.2.1 å­¦ä¹ æµç¨‹</a></li><li><a href="#222__412" rel="nofollow">2.2.2 åˆ†è¯æµç¨‹</a></li><li><a href="#223_WordPiece_427" rel="nofollow">2.2.3 ä»é›¶å®ç°WordPiece</a></li><li><a href="#224__562" rel="nofollow">2.2.4 è§£ç æµç¨‹</a></li></ul> 
   </li><li><a href="#23_Unigram_590" rel="nofollow">2.3 Unigram</a></li><li><ul><li><a href="#231__593" rel="nofollow">2.3.1 å­¦ä¹ æµç¨‹</a></li><li><a href="#232__650" rel="nofollow">2.3.2 åˆ†è¯æµç¨‹</a></li><li><a href="#233_Unigram_752" rel="nofollow">2.3.3 ä»é›¶å®ç°Unigram</a></li><li><a href="#234__830" rel="nofollow">2.3.4 è§£ç æµç¨‹</a></li></ul> 
  </li></ul> 
  </li><li><a href="#3__839" rel="nofollow">3. ä¸‰ç§åˆ†è¯æ–¹æ³•çš„æ¯”è¾ƒ</a></li><li><a href="#Ref_853" rel="nofollow">Ref</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__4"></a>1. å‰è¨€</h2> 
<p>NLPä»»åŠ¡ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç¯èŠ‚å°±æ˜¯åˆ†è¯ã€‚åˆ†è¯å™¨ï¼ˆTokenizerï¼‰åœ¨æ•´ä¸ªä»»åŠ¡æµç¨‹ä¸­æ‰®æ¼”çš„è§’è‰²å¦‚ä¸‹</p> 
<div align="center"> 
 <img src="https://images2.imgbox.com/2d/79/cK5sNo99_o.png" width="70%"> 
</div> 
<p>å³ç»™å®šä¸€æ®µæ–‡æœ¬ï¼Œåˆ†è¯å™¨ä¼šå°†å…¶åˆ†å‰²æˆä¸€ä¸ªä¸ªtokenï¼Œè¿™äº›tokenä¼šæ ¹æ®vocabè½¬åŒ–æˆå¯¹åº”çš„IDä»¥ä½œä¸ºæ¨¡å‹çš„è¾“å…¥ã€‚</p> 
<p>å®Œæ•´çš„åˆ†è¯æµç¨‹åŒ…å«ä»¥ä¸‹å››ä¸ªæ­¥éª¤</p> 
<div align="center"> 
 <img src="https://images2.imgbox.com/8f/07/KgsupEWM_o.png" width="60%"> 
</div> 
<ul><li><strong>æ ‡å‡†åŒ–é˜¶æ®µ</strong>ï¼ˆNormalizationï¼‰ï¼šå…ˆå°†åŸå§‹æ–‡æœ¬ï¼ˆraw textï¼‰åšä¸€ä¸ªé¢„å¤„ç†ï¼Œä¾‹å¦‚å»æ‰Unicodeå­—ç¬¦çš„é‡éŸ³ï¼ˆ<code>Ã©</code> å˜æˆ <code>e</code>ï¼‰ï¼Œå°†æ‰€æœ‰å­—æ¯å…¨éƒ¨è½¬åŒ–æˆå°å†™å­—æ¯ï¼ˆ<code>E</code> å˜æˆ <code>e</code>ï¼‰ç­‰ã€‚è¿™ä¸€æ­¥å¯ä»¥ç†è§£ä¸ºæ•°æ®æ¸…æ´—ï¼›</li><li><strong>é¢„åˆ†è¯é˜¶æ®µ</strong>ï¼ˆPre-tokenizationï¼‰ï¼šè¿›è¡Œä¸€éç²—ç•¥çš„åˆ†è¯ï¼Œä¾‹å¦‚åŸºäºç©ºæ ¼&amp;æ ‡ç‚¹çš„åˆ†è¯ï¼Œå³word-levelã€‚æ³¨æ„é¢„åˆ†è¯ç»“æœçš„ç²’åº¦å¿…é¡»å¤§äºæœ€ç»ˆåˆ†è¯ç»“æœçš„ç²’åº¦ï¼›</li><li><strong>æ¨¡å‹é˜¶æ®µ</strong>ï¼ˆModelï¼‰ï¼šåœ¨é¢„åˆ†è¯çš„è¯­æ–™ä¸Šè¿›è¡Œè®­ç»ƒï¼ˆæ³¨æ„åˆ†è¯å™¨çš„è®­ç»ƒå’Œæ¨¡å‹çš„è®­ç»ƒæ˜¯ä¸¤ä¸ªæ¦‚å¿µï¼æ¨¡å‹çš„è®­ç»ƒæ˜¯é€šè¿‡æ¢¯åº¦ä¸‹é™æ¥é™ä½lossï¼Œå…·æœ‰éšæœºæ€§ï¼Œè€Œåˆ†è¯å™¨çš„è®­ç»ƒæ˜¯ä¸€ä¸ªç»Ÿè®¡è¿‡ç¨‹ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ç¡®å®šæ€§çš„ï¼‰ï¼›</li><li><strong>åå¤„ç†é˜¶æ®µ</strong>ï¼ˆPostprocessorï¼‰ï¼šæ·»åŠ ä¸€äº›ç‰¹æ®Šçš„tokenï¼Œä¾‹å¦‚BERTä¸­çš„ <code>[CLS]</code> å’Œ <code>[SEP]</code>ã€‚</li></ul> 
<p>åˆ†è¯çš„ç²’åº¦ä¸»è¦æœ‰ä¸‰ç§ï¼šword-levelã€char-levelå’Œsubword-levelï¼Œå¯¹äºå‰ä¸¤ç§ç²’åº¦ï¼Œåˆ™ä¸éœ€è¦ç»å†ç¬¬ä¸‰é˜¶æ®µï¼ˆæ¨¡å‹é˜¶æ®µï¼‰ã€‚</p> 
<p>æœ¬æ–‡å°†ä¸»è¦èšç„¦äºç¬¬ä¸‰é˜¶æ®µï¼Œä½†åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹word-levelå’Œchar-levelåˆ†è¯ã€‚</p> 
<h3><a id="11_wordlevel_36"></a>1.1 word-levelåˆ†è¯</h3> 
<p>word-levelåˆ†è¯çš„ä¸€ä¸ªç›´è§‚å‡ºå‘ç‚¹æ˜¯åŸºäºç©ºæ ¼åˆ†è¯ï¼Œå³å¯¹å­—ç¬¦ä¸²è°ƒç”¨ <code>split()</code> æ–¹æ³•</p> 
<pre><code class="prism language-py">text <span class="token operator">=</span> <span class="token string">"Don't you love ğŸ¤— Transformers? We sure do."</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># ["Don't", 'you', 'love', 'ğŸ¤—', 'Transformers?', 'We', 'sure', 'do.']</span>
</code></pre> 
<p>ä½†è¿™ä¸ªç»“æœä¸æ˜¯æœ€ä¼˜çš„ï¼Œå› ä¸º <code>Transformers?</code> å’Œ <code>do.</code> ä¸­éƒ½å«æœ‰æ ‡ç‚¹ç¬¦å·ã€‚å¦‚æœå…è®¸æ ‡ç‚¹ç¬¦å·ç´§è·Ÿåœ¨å•è¯åé¢ï¼Œé‚£ä¹ˆå½“è¯­æ–™åº“è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œ<code>Transformers?</code>ã€<code>Transformers!</code>ã€<code>Transformers.</code> ç­‰éƒ½ä¼šçº³å…¥åˆ°è¯è¡¨å½“ä¸­ï¼Œè¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ã€‚</p> 
<p>æˆ‘ä»¬å¯ä»¥è°ƒç”¨ <code>tokenizers</code> åº“ä¸­çš„ <code>Whitespace()</code> æ¥å®ç°åŸºäºç©ºæ ¼&amp;æ ‡ç‚¹çš„åˆ†è¯</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tokenizers<span class="token punctuation">.</span>pre_tokenizers <span class="token keyword">import</span> Whitespace

tokenizer <span class="token operator">=</span> Whitespace<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tokenizer<span class="token punctuation">.</span>pre_tokenize_str<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># [('Don', (0, 3)), ("'", (3, 4)), ('t', (4, 5)), ('you', (6, 9)), ('love', (10, 14)), ('ğŸ¤—', (15, 16)), ('Transformers', (17, 29)), ('?', (29, 30)), ('We', (31, 33)), ('sure', (34, 38)), ('do', (39, 41)), ('.', (41, 42))]</span>
</code></pre> 
<blockquote> 
 <p>ğŸ“ <code>Whitespace()</code> å†…éƒ¨ä½¿ç”¨çš„æ˜¯æ­£åˆ™è¡¨è¾¾å¼ <code>\w+|[^\w\s]+</code>ã€‚</p> 
</blockquote> 
<p>ä½†è¿™ä¸ªç»“æœä»ä¸æ˜¯æœ€ä¼˜çš„ï¼Œå› ä¸º <code>Don't</code> çš„æ„æ€æ˜¯ <code>Do not</code>ï¼Œæ‰€ä»¥åº”å½“å…·æœ‰ <code>[Do, n't]</code> çš„åˆ†è¯ç»“æœï¼Œè€Œä¸æ˜¯ <code>[Don', t]</code>ã€‚</p> 
<p>è¦æƒ³è¾¾åˆ°åˆç†çš„æ•ˆæœï¼Œå°±è¦ä½¿ç”¨åŸºäºè§„åˆ™çš„åˆ†è¯å™¨äº†ï¼Œä¾‹å¦‚ <code>spaCy</code> æˆ–è€… <code>Moses</code>ã€‚</p> 
<h3><a id="12_charlevel_65"></a>1.2 char-levelåˆ†è¯</h3> 
<p>char-levelåˆ†è¯éå¸¸ç®€å•ï¼Œå³æŠŠå­—ç¬¦ä¸²ä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦çœ‹ä½œä¸€ä¸ªtoken</p> 
<pre><code class="prism language-python">text <span class="token operator">=</span> <span class="token string">"Don't you love ğŸ¤— Transformers? We sure do."</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># ['D', 'o', 'n', "'", 't', ' ', 'y', 'o', 'u', ' ', 'l', 'o', 'v', 'e', ' ', 'ğŸ¤—', ' ', 'T', 'r', 'a', 'n', 's', 'f', 'o', 'r', 'm', 'e', 'r', 's', '?', ' ', 'W', 'e', ' ', 's', 'u', 'r', 'e', ' ', 'd', 'o', '.']</span>
</code></pre> 
<h3><a id="13_subwordlevel_75"></a>1.3 ä¸ºä»€ä¹ˆè¦æœ‰subword-levelåˆ†è¯ï¼Ÿ</h3> 
<ul><li>word-levelåˆ†è¯å¾ˆå®¹æ˜“é€ æˆè¯è¡¨è¿‡å¤§ï¼Œä¸”å®¹æ˜“å‡ºç°OOVé—®é¢˜ï¼ˆTransformer-XLä½¿ç”¨word-levelåˆ†è¯ï¼Œè¯è¡¨å¤§å°ä¸º267735ï¼Œè€ŒåŸºäºsubword-levelçš„è¯è¡¨å¤§å°é€šå¸¸ä¸ä¼šè¶…è¿‡50000ï¼‰ï¼›</li><li>åœ¨word-levelæ„ä¹‰ä¸‹ï¼Œç”±lookè¡ç”Ÿå‡ºçš„looksã€lookingã€lookedç­‰éƒ½ä¼šè¢«æ·»åŠ è¿›è¯è¡¨å½“ä¸­ï¼Œä½†è¿™äº›è¯çš„åŒºåˆ«ä»…ä»…åœ¨äºæ—¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´åº”å½“ä¿å­˜å‰ç¼€ <code>look</code> å’Œæ—¶æ€ <code>s</code>ã€<code>ing</code>ã€<code>ed</code>ï¼ˆå‡è®¾ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          n 
         
        
       
         n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span> ä¸ªè¯æ¯ä¸ªéƒ½æœ‰ä¸‰ç§æ—¶æ€ï¼Œé‚£ä¹ˆåè€…ç›¸æ¯”å‰è€…èƒ½å¤ŸèŠ‚çº¦ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          3 
         
        
          n 
         
        
          âˆ’ 
         
        
          ( 
         
        
          n 
         
        
          + 
         
        
          3 
         
        
          ) 
         
        
          = 
         
        
          2 
         
        
          n 
         
        
          âˆ’ 
         
        
          3 
         
        
       
         3n-(n+3)=2n-3 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">3</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">3</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">2</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">3</span></span></span></span></span> ä¸ªtokençš„ç©ºé—´ï¼‰ï¼›</li><li>åŸºäºword-levelçš„æ¨¡å‹å­¦åˆ°çš„oldã€olderã€oldestä¹‹é—´çš„å…³ç³»æ— æ³•æ³›åŒ–åˆ°smartã€smarterã€smartestä¹‹é—´ï¼›</li><li>char-levelèƒ½å¤Ÿå¾ˆå¥½åœ°è§£å†³OOVé—®é¢˜ï¼Œä½†ä¸€ä¸ªcharèƒ½å¤Ÿè¡¨ç¤ºçš„è¯­ä¹‰è¿œæ²¡æœ‰ä¸€ä¸ªwordèƒ½å¤Ÿè¡¨ç¤ºçš„è¯­ä¹‰ä¸°å¯Œï¼›</li><li>æŒ‰ç…§char-levelåˆ†è¯å¾ˆå®¹æ˜“å¯¼è‡´sequence lengthè¿‡é•¿ã€‚</li></ul> 
<p>subword-levelåˆ†è¯ç²’åº¦ä»‹äºä¸¤è€…ä¹‹é—´ï¼Œèƒ½å¤Ÿè¾ƒå¥½åœ°å¹³è¡¡OOVé—®é¢˜ã€‚</p> 
<h2><a id="2__87"></a>2. å­è¯åˆ†è¯</h2> 
<p>å­è¯åˆ†è¯ï¼ˆSubword Tokenizationï¼‰ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p> 
<ul><li><strong>Byte-Pair Encoding</strong>ï¼šGPTã€GPT-2ã€RoBERTaã€DeBERTaã€BARTç­‰ï¼›</li><li><strong>WordPiece</strong>ï¼šBERTã€DistilBERTã€MobileBERTç­‰ï¼›</li><li><strong>Unigram</strong>ï¼šT5ã€XLNetã€ALBERTã€mBARTç­‰ã€‚</li></ul> 
<h3><a id="21_BPE_96"></a>2.1 BPE</h3> 
<h4><a id="211__98"></a>2.1.1 å­¦ä¹ æµç¨‹</h4> 
<p>BPEæ—¢ç„¶å±äºsubword-levelåˆ†è¯ï¼Œé‚£è‡ªç„¶å°±è¦ç»å†é¢„åˆ†è¯é˜¶æ®µï¼Œå³éœ€è¦å…ˆå¯¹åŸå§‹æ–‡æœ¬è¿›è¡Œä¸€éword-levelåˆ†è¯ã€‚</p> 
<p>ä¸ºå™è¿°ç®€ä¾¿èµ·è§ï¼Œå‡è®¾åœ¨ç»å†äº†æ ‡å‡†åŒ–ã€é¢„åˆ†è¯é˜¶æ®µåæˆ‘ä»¬çš„è¯­æ–™åº“åªå«ä»¥ä¸‹ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         5 
        
       
      
        5 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">5</span></span></span></span></span> ç§å•è¯ï¼ˆæ¯ä¸ªå•è¯å³ä¾§çš„æ•°å­—ä»£è¡¨è¿™ä¸ªå•è¯å‡ºç°çš„é¢‘æ•°ï¼‰</p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span><span class="token string">"hug"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"pug"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"pun"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"bun"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"hugs"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>BPEé¦–å…ˆå»ºç«‹ä¸€ä¸ªåŸºç¡€è¯è¡¨ï¼ˆbase vocabularyï¼‰ï¼Œå®ƒç”±æ„æˆä¸Šè¿°æ‰€æœ‰å•è¯çš„<strong>å­—ç¬¦</strong>ç»„æˆï¼Œå³</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">]</span>
</code></pre> 
<p>æ¥ä¸‹æ¥ï¼ŒBPEå°†ä¸æ–­å­¦ä¹ merge ruleä»¥ä»åŸºç¡€è¯è¡¨ä¸­é€‰å–ä¸¤ä¸ªå…ƒç´ å¹¶åˆå¹¶æˆä¸€ä¸ªæ–°çš„å…ƒç´ ç„¶åæ·»åŠ åˆ°è¯è¡¨ä¸­ï¼ˆåŸå…ˆçš„ä¸¤ä¸ªå…ƒç´ ä¸ä¼šåˆ é™¤ï¼‰ï¼Œ<strong>ç›´åˆ°è¯è¡¨è¾¾åˆ°é¢„å…ˆæŒ‡å®šçš„å¤§å°ä¸ºæ­¢</strong>ã€‚</p> 
<blockquote> 
 <p>ğŸ“ æ¯ä¸€æ¡merge ruleéƒ½å¯¹åº”äº†ä¸€ä¸ªè¦æ·»åŠ åˆ°è¯è¡¨ä¸­çš„æ–°å…ƒç´ ï¼Œmerge rulesé€šå¸¸åˆç®€ç§°ä¸ºmergesï¼Œæ‰€ä»¥æœ€ç»ˆè¯è¡¨å¤§å°=åŸºç¡€è¯è¡¨å¤§å°+mergesçš„æ•°é‡ã€‚åŸºç¡€è¯è¡¨çš„å¤§å°é€šå¸¸æ˜¯ç¡®å®šçš„ï¼Œæ‰€ä»¥å”¯ä¸€çš„è¶…å‚æ•°å°±æ˜¯mergesçš„æ•°é‡ã€‚ä¾‹å¦‚ï¼š</p> 
 <ul><li>GPT-1ï¼šbase vocab sizeï¼š478ï¼Œmergesï¼š40kï¼Œtotal vocab sizeï¼š40478</li><li>GPT-2ï¼šbase vocab sizeï¼š256ï¼Œmergesï¼š50kï¼Œspecial tokensï¼š1ï¼Œtotal vocab sizeï¼š50257</li></ul> 
</blockquote> 
<p>åŸºç¡€è¯è¡¨æ˜¯char-levelçš„ï¼Œè¯´æ˜<strong>BPEä¹Ÿæ˜¯ä»char-levelå¼€å§‹å­¦ä¹ merges</strong>ï¼Œå³ä¸€å¼€å§‹åˆå¹¶çš„éƒ½æ˜¯charï¼Œéšç€å­¦ä¹ çš„è¿›è¡Œï¼Œåˆå¹¶çš„å°±æ˜¯subwordäº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¹‹å‰çš„æ¯ä¸ªå•è¯éƒ½åˆ’åˆ†æˆå­—ç¬¦</p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"u"</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"u"</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span> <span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"u"</span> <span class="token string">"g"</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>ç°ç»Ÿè®¡æ¯ä¸ª<strong>å•è¯å†…</strong>çš„æ‰€æœ‰pairï¼Œå¹¶æ‰¾åˆ°å‡ºç°<strong>é¢‘æ•°æœ€é«˜</strong>çš„é‚£ä¸€ä¸ªpairï¼ˆè¿™é‡Œçš„pairæŒ‡çš„æ˜¯ç›¸é‚»å…ƒç´ ç»„æˆçš„å¯¹ï¼Œä¾‹å¦‚ <code>[a, bc, d, e]</code> å«æœ‰ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         3 
        
       
      
        3 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">3</span></span></span></span></span> ä¸ªpairï¼š<code>[(a, bc), (bc, d), (d, e)]</code>ï¼‰ï¼Œç„¶å<strong>åˆå¹¶</strong>è¿™ä¸ªpairã€‚</p> 
<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¾ˆæ˜æ˜¾ <code>(u, g)</code> è¿™ä¸ªpairå‡ºç°çš„é¢‘æ•°æœ€é«˜ï¼Œå®ƒä¸€å…±å‡ºç°äº† <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         20 
        
       
      
        20 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">20</span></span></span></span></span> æ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å­¦åˆ°çš„ç¬¬ä¸€æ¡merge ruleå°±æ˜¯ <code>(u, g) -&gt; ug</code>ï¼Œæˆ‘ä»¬å°† <code>ug</code> æ·»åŠ åˆ°è¯è¡¨å½“ä¸­ï¼Œç„¶åå°†è¯­æ–™åº“ä¸­çš„æ‰€æœ‰ <code>(u, g)</code> åˆå¹¶æˆ <code>ug</code></p> 
<pre><code class="prism language-python">Vocabulary<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"ug"</span><span class="token punctuation">]</span>
Merges<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token string">"g"</span><span class="token punctuation">)</span>
Corpus<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span> <span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"ug"</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>ç»§ç»­é‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° <code>(u, n)</code> è¿™ä¸ªpairå‡ºç°çš„é¢‘ç‡æœ€é«˜ï¼Œé«˜è¾¾ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         16 
        
       
      
        16 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">16</span></span></span></span></span> æ¬¡ï¼Œæ‰€ä»¥BPEå­¦åˆ°çš„ç¬¬äºŒæ¡merge ruleæ˜¯ <code>(u, n) -&gt; un</code>ï¼Œæ­¤æ—¶æœ‰</p> 
<pre><code class="prism language-python">Vocabulary<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token string">"un"</span><span class="token punctuation">]</span>
Merges<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">)</span>
Corpus<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"ug"</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>ç»§ç»­é‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° <code>(h, ug)</code> è¿™ä¸ªpairå‡ºç°çš„é¢‘ç‡æœ€é«˜ï¼Œå…±å‡ºç° <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         15 
        
       
      
        15 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">15</span></span></span></span></span> æ¬¡ï¼Œæ‰€ä»¥BPEå­¦åˆ°çš„ç¬¬ä¸‰æ¡merge ruleæ˜¯ <code>(h, ug) -&gt; hug</code>ï¼Œæ­¤æ—¶æœ‰</p> 
<pre><code class="prism language-python">Vocabulary<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token string">"hug"</span><span class="token punctuation">]</span>
Merges<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"ug"</span><span class="token punctuation">)</span>
Corpus<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"hug"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"hug"</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>å‡è®¾æˆ‘ä»¬é¢„å…ˆå¸Œæœ›å­¦å¾— <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         3 
        
       
      
        3 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">3</span></span></span></span></span> ä¸ªmergesï¼Œé‚£ä¹ˆBPEçš„æµç¨‹å°±åˆ°æ­¤ç»“æŸäº†ã€‚</p> 
<h4><a id="212__150"></a>2.1.2 åˆ†è¯æµç¨‹</h4> 
<p>æˆ‘ä»¬å·²ç»çŸ¥é“BPEæ˜¯æ€æ ·å­¦ä¹ çš„äº†ï¼Œé‚£ä¹ˆç»™å®šä¸€æ®µæ–‡æœ¬ï¼Œæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨BPEå¯¹å®ƒè¿›è¡Œåˆ†è¯å‘¢ï¼Ÿ</p> 
<p>å‡è®¾æ–‡æœ¬æ˜¯ <code>str</code> å‹ï¼Œè‡ªç„¶åœ°ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯¹å®ƒåº”ç”¨å‰ä¸¤ä¸ªæµç¨‹ï¼šæ ‡å‡†åŒ–å’Œé¢„åˆ†è¯ï¼Œæ­¤æ—¶æ–‡æœ¬å˜æˆäº† <code>List[str]</code> å‹ï¼Œå…¶ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªwordã€‚ä¹‹åï¼Œå¯¹äºæ¯ä¸€ä¸ªwordï¼Œæˆ‘ä»¬å…ˆå°†å®ƒå…¨éƒ¨æ‹†ä¸ºå­—ç¬¦ï¼Œç„¶å<strong>ä»å‰å¾€å</strong>æ‰«æä¹‹å‰å­¦å¾—çš„mergesï¼Œèƒ½å¤Ÿåº”ç”¨ä¸€æ¡å°±åº”ç”¨ä¸€æ¡ã€‚å½“æ‰€æœ‰wordéƒ½è¿‡å®Œåï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†æœ€ç»ˆçš„åˆ†è¯ç»“æœã€‚</p> 
<p>è¿™é‡Œä»…ä»¥å•ä¸ªwordä¸ºä¾‹ã€‚å‡è®¾æœ‰ä¸€ä¸ªwordæ˜¯ <code>bug</code>ï¼Œæˆ‘ä»¬å…±æœ‰ä¸‰ä¸ªmerges</p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span><span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"ug"</span>
<span class="token punctuation">(</span><span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"un"</span>
<span class="token punctuation">(</span><span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"ug"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"hug"</span>
</code></pre> 
<p>é¦–å…ˆå°† <code>bug</code> æ‹†ä¸ºå­—ç¬¦ï¼š<code>[b, u, g]</code>ï¼Œç„¶åä»å‰å¾€åæ‰«æmergesï¼Œå‘ç°ç¬¬ä¸€æ¡å¯ä»¥åº”ç”¨ï¼Œåº”ç”¨ä¹‹åå¾—åˆ° <code>[b, ug]</code>ï¼Œè€Œç¬¬äºŒã€ä¸‰æ¡éƒ½ä¸èƒ½åº”ç”¨ï¼Œäºæ˜¯å¯¹äºè¯¥wordçš„åˆ†è¯ç»“æŸã€‚</p> 
<p>å¯¹äº <code>mug</code> è€Œè¨€ï¼ŒåŒæ ·æ˜¯å…ˆæ‹†æˆå­—ç¬¦ <code>[m, u, g]</code>ï¼Œæ³¨æ„åˆ°ç”±äº <code>m</code> ä¸åœ¨è¯è¡¨å½“ä¸­ï¼Œæ‰€ä»¥å®é™…æ‹†å®Œåæ˜¯ <code>[[UNK], u, g]</code>ï¼Œåˆå¹¶å®Œåæ˜¯ <code>[[UNK], ug]</code>ã€‚</p> 
<p>åŒç†å¯å¾—ï¼Œå¯¹äº <code>thug</code> è€Œè¨€ï¼Œå…¶åˆ†è¯ç»“æœæ˜¯ <code>[[UNK], hug]</code>ã€‚å¯¹äº <code>unhug</code>ï¼Œå…¶åˆ†è¯ç»“æœæ˜¯ <code>[un, hug]</code>ã€‚</p> 
<blockquote> 
 <p>ğŸ“ å¯ä»¥çœ‹å‡ºï¼Œåªè¦å•è¯ä¸­æœ‰ä¸€ä¸ªå­—ç¬¦æ²¡æœ‰åœ¨åŸºç¡€è¯è¡¨ä¸­å‡ºç°ï¼Œé‚£ä¹ˆå…³äºè¯¥å•è¯çš„åˆ†è¯ç»“æœå°±ä¼šå‡ºç° <code>[UNK]</code>ã€‚æ‰€ä»¥ï¼Œå¦‚æœè¦æƒ³ä¿è¯å¯¹äºä¸€æ®µæ–‡æœ¬çš„åˆ†è¯ä¸ä¼šå‡ºç° <code>[UNK]</code>ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¿è¯è¯¥æ–‡æœ¬çš„é¢„åˆ†è¯ç»“æœä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦éƒ½è¢«åŒ…å«åœ¨åŸºç¡€è¯è¡¨å½“ä¸­ã€‚</p> 
</blockquote> 
<h4><a id="213_BPE_171"></a>2.1.3 ä»é›¶å®ç°BPE</h4> 
<p>ç”±äºæ ‡å‡†åŒ–å’Œé¢„åˆ†è¯è¿™ä¸¤ä¸ªé˜¶æ®µå¹¶ä¸åœ¨æˆ‘ä»¬çš„è€ƒè™‘èŒƒå›´å†…ï¼Œæ‰€ä»¥å‡è®¾ç°åœ¨å·²ç»å¾—åˆ°äº†é¢„åˆ†è¯çš„ç»“æœ <code>pre_tokenized_res</code>ï¼Œå…¶ç±»å‹æ˜¯ <code>List[str]</code>ï¼Œå…¶ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½å¯ä»¥è§†ä¸ºä¸€ä¸ªwordã€‚</p> 
<p>æ ¹æ®2.1.1ä¸­çš„å†…å®¹ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦ç»Ÿè®¡å‡ºæ¯ä¸ªwordå‡ºç°çš„é¢‘æ•°ï¼Œç„¶åå¯¹æ¯ä¸ªwordè¿›è¡Œchar-levelçš„åˆ’åˆ†ä»¥æ–¹ä¾¿åç»­è¿›è¡Œmerge</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_word_freqs</span><span class="token punctuation">(</span>pre_tokenized_res<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    word_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> pre_tokenized_res<span class="token punctuation">:</span>
        word_freqs<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> word_freqs


<span class="token keyword">def</span> <span class="token function">get_word_splits</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    word_splits <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> word_freqs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span>
    <span class="token keyword">return</span> word_splits
</code></pre> 
<p>æˆ‘ä»¬è¿˜éœ€è¦åŸºç¡€è¯è¡¨ä»¥åŠè®¡ç®—æ¯ä¸ªpairå‡ºç°çš„é¢‘æ•°</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_base_vocab</span><span class="token punctuation">(</span>word_splits<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    vocab <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> split <span class="token keyword">in</span> word_splits<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        vocab<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>split<span class="token punctuation">)</span>
    vocab <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>vocab<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> vocab


<span class="token keyword">def</span> <span class="token function">get_pair_freqs</span><span class="token punctuation">(</span>
    word_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    word_splits<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    pair_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> freq<span class="token punctuation">,</span> split <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> word_splits<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            pair_freqs<span class="token punctuation">[</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
    <span class="token keyword">return</span> pair_freqs
</code></pre> 
<p>å‡è®¾æˆ‘ä»¬å·²ç»ä» <code>pair_freqs</code> æ‰¾åˆ°äº†å‡ºç°é¢‘æ•°æœ€å¤šçš„é‚£ä¸ª <code>pair</code>ï¼Œé™¤äº†å°†è¿™ä¸ª <code>pair</code> æ·»åŠ åˆ° <code>merges</code> ä¹‹å¤–ï¼Œè¿˜éœ€è¦å¯¹ <code>word_splits</code> ä¸­çš„æ¯ä¸€ä¸ªè¿™æ ·çš„ <code>pair</code> è¿›è¡Œåˆå¹¶ï¼ŒåŒæ—¶å†è®¡ç®—ä¸€æ¬¡ <code>pair_freqs</code>ã€‚</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">merge_pair</span><span class="token punctuation">(</span>pair<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> word_splits<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        split <span class="token operator">=</span> word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> split<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> pair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">and</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> pair<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                split <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>pair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> pair<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>
        word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> split
    <span class="token keyword">return</span> word_splits
</code></pre> 
<blockquote> 
 <p>âš ï¸ è‡³äºä¸ºä»€ä¹ˆç”¨ <code>while</code> è€Œä¸ç”¨ <code>for</code> è¯·å‚è€ƒ <a href="https://blog.csdn.net/raelum/article/details/132265007">Pythonä¸­å…³äºå¯å˜å¾ªç¯çš„ä¸€äº›å‘</a>ã€‚</p> 
</blockquote> 
<p>ä¸‡äº‹ä¿±å¤‡ï¼Œç°åœ¨å¯ä»¥å®šä¹‰BPEçš„è®­ç»ƒå‡½æ•°äº†</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">bpe_train</span><span class="token punctuation">(</span>num_merges<span class="token punctuation">,</span> word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    merges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    vocab <span class="token operator">=</span> get_base_vocab<span class="token punctuation">(</span>word_splits<span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_merges<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pair_freqs <span class="token operator">=</span> get_pair_freqs<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> pair_freqs<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        max_freq_pair <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>pair_freqs<span class="token punctuation">,</span> key<span class="token operator">=</span>pair_freqs<span class="token punctuation">.</span>get<span class="token punctuation">)</span>
        word_splits <span class="token operator">=</span> merge_pair<span class="token punctuation">(</span>max_freq_pair<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
        merges<span class="token punctuation">.</span>append<span class="token punctuation">(</span>max_freq_pair<span class="token punctuation">)</span>
        vocab<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>max_freq_pair<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> vocab<span class="token punctuation">,</span> merges
</code></pre> 
<p>æˆ‘ä»¬å¯ä»¥æ‹¿WikiText-2çš„éªŒè¯é›†æ¥çœ‹ä¸€ä¸‹BPEç®—æ³•åˆ°åº•å­¦åˆ°äº†ä»€ä¹ˆï¼Œè®¾ç½®mergesçš„æ•°é‡ä¸º50ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> datasets <span class="token keyword">import</span> load_dataset
<span class="token keyword">from</span> tokenizers<span class="token punctuation">.</span>pre_tokenizers <span class="token keyword">import</span> Whitespace

pre_tokenizer <span class="token operator">=</span> Whitespace<span class="token punctuation">(</span><span class="token punctuation">)</span>

corpus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
data <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"wikitext"</span><span class="token punctuation">,</span> <span class="token string">"wikitext-2-v1"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"validation"</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> line <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    tokenized_line <span class="token operator">=</span> pre_tokenizer<span class="token punctuation">.</span>pre_tokenize_str<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    corpus<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tokenized_line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

word_freqs <span class="token operator">=</span> get_word_freqs<span class="token punctuation">(</span>corpus<span class="token punctuation">)</span>
word_splits <span class="token operator">=</span> get_word_splits<span class="token punctuation">(</span>word_freqs<span class="token punctuation">)</span>
vocab<span class="token punctuation">,</span> merges <span class="token operator">=</span> bpe_train<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab<span class="token punctuation">)</span>
<span class="token comment"># ['!', '"', '$', '%', '&amp;', "'", '(', ')', '*', '+', ',', '-', '.', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', ':', ';', '&lt;', '=', '&gt;', '?', '@', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '[', ']', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', '~', 'Â£', 'Â°', 'Â²', 'Â½', 'Ã‰', 'Ã', 'Ãš', 'Ã¡', 'Ã§', 'Ã©', 'Ã«', 'Ã­', 'Ã¼', 'Ä', 'Å', 'Å¡', 'Î±', 'Î²', 'Î³', 'Î¼', 'â€‘', 'â€“', 'â€”', 'â€˜', 'â€™', 'â€œ', 'â€', 'â€²', 'â€³', 'â„', 'â‚¤', 'âˆ’', 'â™­', 'â™¯', 'th', 'in', 'the', 'un', 'an', 'er', 'unk', 'on', 'ed', 'at', 're', 'en', 'or', 'st', 'and', 'of', 'al', 'ar', 'as', 'to', 'ing', 'es', 'it', 'is', 'ro', 'ic', 'he', 'ion', 'ou', 'il', 'le', 'ent', 'ac', 'ad', 'se', 'was', 'ur', 'for', 'The', 'be', 'ly', 'om', 'am', 'id', 'ig', 've', 'ch', 'lo', '@-', '@-@']</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>merges<span class="token punctuation">)</span>
<span class="token comment"># [('t', 'h'), ('i', 'n'), ('th', 'e'), ('u', 'n'), ('a', 'n'), ('e', 'r'), ('un', 'k'), ('o', 'n'), ('e', 'd'), ('a', 't'), ('r', 'e'), ('e', 'n'), ('o', 'r'), ('s', 't'), ('an', 'd'), ('o', 'f'), ('a', 'l'), ('a', 'r'), ('a', 's'), ('t', 'o'), ('in', 'g'), ('e', 's'), ('i', 't'), ('i', 's'), ('r', 'o'), ('i', 'c'), ('h', 'e'), ('i', 'on'), ('o', 'u'), ('i', 'l'), ('l', 'e'), ('en', 't'), ('a', 'c'), ('a', 'd'), ('s', 'e'), ('w', 'as'), ('u', 'r'), ('f', 'or'), ('T', 'he'), ('b', 'e'), ('l', 'y'), ('o', 'm'), ('a', 'm'), ('i', 'd'), ('i', 'g'), ('v', 'e'), ('c', 'h'), ('l', 'o'), ('@', '-'), ('@-', '@')]</span>
</code></pre> 
<p>å‡è®¾BPEå·²ç»è®­ç»ƒå®Œæ¯•ï¼Œç»™å®šä¸€æ®µæ–‡æœ¬ï¼Œæˆ‘ä»¬å¦‚ä½•ä½¿ç”¨mergeså¯¹å®ƒè¿›è¡Œåˆ†è¯å‘¢ï¼Ÿ</p> 
<p>ä¾ç„¶åªè€ƒè™‘é¢„åˆ†è¯åçš„æ–‡æœ¬ï¼Œå³ <code>pre_tokenized_text</code>ï¼Œå…¶ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª <code>word</code>ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯¹ <code>word</code> åˆ’åˆ†æˆchar-levelï¼Œç„¶åä»å‰å¾€åéå†mergeså¹¶åº”ç”¨åˆ° <code>word</code> ä¸Šã€‚</p> 
<p>å…ˆåªè€ƒè™‘ä»…å¯¹ä¸€ä¸ª <code>word</code> åˆ†è¯</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">tokenize_word</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> vocab<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> merges<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    get_pairs <span class="token operator">=</span> <span class="token keyword">lambda</span> word<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> word<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    bpe_ranks <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>merges<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>merges<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ç»™æ¯ä¸€æ¡merge ruleç¼–å·ï¼Œæ–¹ä¾¿ä¹‹åä»å‰å¾€åæŸ¥æ‰¾</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> word

    word <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'[UNK]'</span> <span class="token keyword">if</span> char <span class="token keyword">not</span> <span class="token keyword">in</span> vocab <span class="token keyword">else</span> char <span class="token keyword">for</span> char <span class="token keyword">in</span> word<span class="token punctuation">]</span>
    pairs <span class="token operator">=</span> get_pairs<span class="token punctuation">(</span>word<span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        bigram <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>pairs<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> pair<span class="token punctuation">:</span> bpe_ranks<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pair<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># å› ä¸ºè¦ä»å‰å¾€åå»åº”ç”¨ï¼Œæ‰€ä»¥è¦æ‰¾åˆ°ä¸‹æ ‡æœ€å°çš„é‚£ä¸ªpair</span>
        <span class="token keyword">if</span> bigram <span class="token keyword">not</span> <span class="token keyword">in</span> bpe_ranks<span class="token punctuation">:</span>
            <span class="token keyword">break</span>

        i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> word<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> bigram<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">and</span> word<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> bigram<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                word <span class="token operator">=</span> word<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>bigram<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> bigram<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> word<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            pairs <span class="token operator">=</span> get_pairs<span class="token punctuation">(</span>word<span class="token punctuation">)</span>

    <span class="token keyword">return</span> word
</code></pre> 
<p>æ•ˆæœ</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> partial

vocab <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token string">"hug"</span><span class="token punctuation">]</span>
merges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'h'</span><span class="token punctuation">,</span> <span class="token string">'ug'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
tokenize_word <span class="token operator">=</span> partial<span class="token punctuation">(</span>tokenize_word<span class="token punctuation">,</span> vocab<span class="token operator">=</span>vocab<span class="token punctuation">,</span> merges<span class="token operator">=</span>merges<span class="token punctuation">)</span>

words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"hug"</span><span class="token punctuation">,</span> <span class="token string">"bug"</span><span class="token punctuation">,</span> <span class="token string">"mug"</span><span class="token punctuation">,</span> <span class="token string">"unhug"</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> word <span class="token keyword">in</span> words<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>word<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tokenize_word<span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token comment"># hug: ['hug']</span>
<span class="token comment"># bug: ['b', 'ug']</span>
<span class="token comment"># mug: ['[UNK]', 'ug']</span>
<span class="token comment"># unhug: ['un', 'hug']</span>
</code></pre> 
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å¯¹ä¸€æ®µæ–‡æœ¬è¿›è¡Œåˆ†è¯äº†</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">tokenize</span><span class="token punctuation">(</span>pre_tokenized_text<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vocab<span class="token punctuation">,</span> merges<span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> pre_tokenized_text<span class="token punctuation">:</span>
        res<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>tokenize_word<span class="token punctuation">(</span>word<span class="token punctuation">,</span> vocab<span class="token punctuation">,</span> merges<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
</code></pre> 
<blockquote> 
 <p>âš ï¸ æ³¨æ„ï¼Œæˆªæ­¢ç›®å‰ï¼Œæˆ‘ä»¬çš„å®ç°ä¸»è¦æ˜¯ä¸ºäº†æ¸…æ™°åœ°å±•ç¤ºæµç¨‹ï¼Œå¹¶ä¸æ˜¯æœ€é«˜æ•ˆçš„å®ç°æ–¹å¼ï¼Œä¸‹æ–‡ç›¸åŒã€‚</p> 
</blockquote> 
<h4><a id="214__342"></a>2.1.4 è§£ç æµç¨‹</h4> 
<p>BPEçš„åˆ†è¯æµç¨‹å®é™…ä¸Šå°±æ˜¯ç¼–ç æµç¨‹ï¼ˆå°†å•è¯æ‹†åˆ†ä¸ºå­è¯ï¼‰ï¼Œé‚£ä¹ˆè§£ç æµç¨‹å°±æ˜¯å°†å­è¯ç»„åˆæˆå•è¯ã€‚ä»€ä¹ˆåœºæ™¯ä¸‹æ‰ä¼šæœ‰è¿™ä¸€éœ€è¦å‘¢ï¼Ÿ</p> 
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæ¨¡å‹æ¥æ”¶çš„è¾“å…¥å°±æ˜¯å­è¯åºåˆ—ï¼ˆé€šå¸¸ç”±å­è¯çš„IDæ¥è¡¨ç¤ºï¼‰ï¼Œè¾“å‡ºè‡ªç„¶ä¹Ÿæ˜¯å­è¯åºåˆ—ï¼Œä½†å­è¯åºåˆ—çš„å¯è¯»æ€§ä¸å¼ºï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬åŒ–æˆå•è¯åºåˆ—æ‰æ–¹ä¾¿äººç±»é˜…è¯»ã€‚</p> 
<p>ç»™å®šå­è¯åºåˆ—</p> 
<pre><code>[a, b, c, d, e, f]
</code></pre> 
<p>è¿™é‡Œæ¯ä¸ªå­—æ¯éƒ½ä»£è¡¨ä¸€ä¸ªå­è¯ï¼Œæ˜¾ç„¶ <code>a</code> è‚¯å®šæ˜¯ç¬¬ä¸€ä¸ªå•è¯çš„å¼€å¤´ï¼Œé‚£ä¹ˆæ€ä¹ˆç¡®å®šç¬¬ä¸€ä¸ªå•è¯çš„ç»“å°¾å‘¢ï¼Ÿå¦‚æœæ— æ³•ç¡®å®šå“ªä¸ªå­è¯æ˜¯ç¬¬ä¸€ä¸ªå•è¯çš„ç»“å°¾ï¼Œè‡ªç„¶å°±æ— æ³•ç¡®å®šå“ªä¸ªå­è¯æ˜¯ç¬¬äºŒä¸ªå•è¯çš„å¼€å¤´ã€‚</p> 
<p>ä¸€ä¸ªç›´è§‚çš„åšæ³•æ˜¯ï¼Œåœ¨BPEè®­ç»ƒä¹‹å‰åœ¨æ¯ä¸ªå•è¯çš„æœ«å°¾æ·»åŠ ä¸€ä¸ªæ ‡è®°ï¼Œä¾‹å¦‚ <code>#</code>ã€‚è¿™æ ·ä¸€æ¥ï¼Œå½“BPEè®­ç»ƒç»“æŸåï¼Œå¦‚æœä¸€ä¸ªå­è¯çš„æœ«å°¾å«æœ‰ <code>#</code>ï¼Œè¯´æ˜è¿™ä¸ªå­è¯å¿…å®šæ˜¯æŸä¸€ä¸ªå•è¯çš„ç»“å°¾ã€‚</p> 
<p>æŒ‰ç…§è¿™ç§æ–¹å¼ï¼Œæœ€ç»ˆä¼šå¾—åˆ°å¦‚ä¸‹å½¢å¼çš„å­è¯åºåˆ—</p> 
<pre><code>[a, b#, c, d, e#, f#]
</code></pre> 
<p>å¾ˆå®¹æ˜“å°†å…¶æ¢å¤æˆå•è¯åºåˆ—</p> 
<pre><code>[ab, cde, f]
</code></pre> 
<p>åœ¨BPEçš„<a href="https://arxiv.org/abs/1508.07909" rel="nofollow">åŸè®ºæ–‡</a>å½“ä¸­ï¼Œè¿™ä¸ªæ ‡è®°å°±æ˜¯ <code>&lt;/w&gt;</code>ï¼Œæ³¨æ„åˆ°æˆ‘ä»¬åœ¨2.1.3ä¸­çš„å®ç°å¹¶æ²¡æœ‰è€ƒè™‘æ ‡è®°ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯è‡ªè¡Œå®ç°ã€‚</p> 
<h3><a id="22_WordPiece_389"></a>2.2 WordPiece</h3> 
<h4><a id="221__391"></a>2.2.1 å­¦ä¹ æµç¨‹</h4> 
<p>WordPieceå’ŒBPEçš„æµç¨‹<strong>å‡ ä¹ä¸€è‡´</strong>ï¼Œä¸»è¦çš„åŒºåˆ«åœ¨äºï¼ŒBPEæ¯æ¬¡æŒ‰ç…§<strong>å‡ºç°é¢‘æ•°æœ€é«˜</strong>è¿™ä¸€åŸåˆ™æ¥é€‰å–pairï¼Œè€ŒWordPieceåˆ™æ˜¯æŒ‰ç…§<strong>èƒ½å¤Ÿæœ€å¤§é™åº¦æå‡è¯­è¨€æ¨¡å‹æ¦‚ç‡</strong>è¿™ä¸€åŸåˆ™æ¥é€‰å–pairã€‚</p> 
<p>å…·ä½“æ¥è®²ï¼Œå‡è®¾å¥å­ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         S 
        
       
      
        S 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span></span></span></span></span> ç”± <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
      
        n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span> ä¸ªå­è¯ç»„æˆ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          t 
         
        
          1 
         
        
       
         , 
        
        
        
          t 
         
        
          2 
         
        
       
         , 
        
       
         â‹¯ 
       â€‰ 
       
         , 
        
        
        
          t 
         
        
          n 
         
        
       
      
        t_1,t_2,\cdots,t_n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8095em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">â‹¯</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>ï¼Œä¸”å„ä¸ªå­è¯ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œåˆ™</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          log 
         
        
          â¡ 
         
        
          P 
         
        
          ( 
         
        
          S 
         
        
          ) 
         
        
          = 
         
         
         
           âˆ‘ 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           n 
          
         
        
          log 
         
        
          â¡ 
         
        
          P 
         
        
          ( 
         
         
         
           t 
          
         
           i 
          
         
        
          ) 
         
        
       
         \log P(S)=\sum_{i=1}^n \log P(t_i) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.9291em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>å¦‚æœé€‰å– <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          t 
         
        
          i 
         
        
       
         , 
        
        
        
          t 
         
        
          j 
         
        
       
      
        t_i,t_j 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9012em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span> è¿›è¡Œåˆå¹¶ï¼Œå¹¶è®°åˆå¹¶åçš„å­è¯ä¸º <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          t 
         
        
          k 
         
        
       
      
        t_k 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7651em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>ï¼Œé‚£ä¹ˆ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         log 
        
       
         â¡ 
        
       
         P 
        
       
         ( 
        
       
         S 
        
       
         ) 
        
       
      
        \log P(S) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="mclose">)</span></span></span></span></span> çš„å˜åŒ–å€¼ä¸º</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          log 
         
        
          â¡ 
         
        
          P 
         
        
          ( 
         
         
         
           t 
          
         
           k 
          
         
        
          ) 
         
        
          âˆ’ 
         
        
          ( 
         
        
          log 
         
        
          â¡ 
         
        
          P 
         
        
          ( 
         
         
         
           t 
          
         
           i 
          
         
        
          ) 
         
        
          + 
         
        
          log 
         
        
          â¡ 
         
        
          P 
         
        
          ( 
         
         
         
           t 
          
         
           j 
          
         
        
          ) 
         
        
          ) 
         
        
          = 
         
        
          log 
         
        
          â¡ 
         
         
          
          
            P 
           
          
            ( 
           
           
           
             t 
            
           
             k 
            
           
          
            ) 
           
          
          
          
            P 
           
          
            ( 
           
           
           
             t 
            
           
             i 
            
           
          
            ) 
           
          
            P 
           
          
            ( 
           
           
           
             t 
            
           
             j 
            
           
          
            ) 
           
          
         
        
       
         \log P(t_k)-(\log P(t_i)+\log P(t_j))=\log\frac{P(t_k)}{P(t_i)P(t_j)} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">))</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.3991em; vertical-align: -0.9721em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9721em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>å¯ä»¥çœ‹å‡ºï¼Œå˜åŒ–å€¼å°±æ˜¯ä¸¤ä¸ªå­è¯ä¹‹é—´çš„<strong>äº’ä¿¡æ¯</strong>ï¼Œæˆ‘ä»¬é€šå¸¸ç”¨ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         , 
        
        
        
          t 
         
        
          j 
         
        
       
         ) 
        
       
         / 
        
       
         ( 
        
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         ) 
        
       
         â‹… 
        
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          j 
         
        
       
         ) 
        
       
         ) 
        
       
      
        n(t_i,t_j)/(n(t_i)\cdot n(t_j)) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span> æ¥ä¼°è®¡ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         P 
        
       
         ( 
        
        
        
          t 
         
        
          k 
         
        
       
         ) 
        
       
         / 
        
       
         ( 
        
       
         P 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         ) 
        
       
         P 
        
       
         ( 
        
        
        
          t 
         
        
          j 
         
        
       
         ) 
        
       
         ) 
        
       
      
        P(t_k)/(P(t_i)P(t_j)) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span>ã€‚</p> 
<p>é™¤æ­¤ä¹‹å¤–ï¼ŒWordPieceè¿˜æœ‰ä¸€ç‚¹ä¸BPEä¸åŒï¼Œé‚£å°±æ˜¯ä¸€å¼€å§‹åœ¨å¯¹å•è¯è¿›è¡Œchar-levelåˆ’åˆ†çš„æ—¶å€™ï¼Œä¼šåœ¨æ¯ä¸ª<strong>éå•è¯å¼€å¤´</strong>çš„å­—ç¬¦å‰åŠ ä¸Š <code>##</code> å‰ç¼€ï¼Œè¿™ä¸ªå‰ç¼€æ˜¯ç”¨äºè§£ç è¿‡ç¨‹ä¸­çš„å­è¯åˆå¹¶ã€‚åœ¨åˆå¹¶ä¸¤ä¸ªå­è¯æ—¶ï¼Œåä¸€ä¸ªå­è¯çš„å‰ç¼€éœ€è¦å»æ‰ï¼Œä¾‹å¦‚ï¼Œ<code>(##h, ##ug) -&gt; ##hug</code>ã€<code>(b, ##ug) -&gt; bug</code>ã€‚</p> 
<h4><a id="222__412"></a>2.2.2 åˆ†è¯æµç¨‹</h4> 
<p>BPEè®­ç»ƒç»“æŸåä¼šä¿å­˜ <code>vocab</code> å’Œ <code>merges</code>ï¼Œè€ŒWordPiece<strong>åªä¿å­˜</strong> <code>vocab</code>ï¼Œé‚£WordPieceæ˜¯å¦‚ä½•å¯¹ä¸€æ®µæ–‡æœ¬è¿›è¡Œåˆ†è¯çš„å‘¢ï¼Ÿ</p> 
<p>å›é¡¾BPEï¼Œå®ƒé¦–å…ˆå°†ä¸€ä¸ªå•è¯æ‹†æˆå­—ç¬¦ï¼Œç„¶åä»å‰å¾€åéå† <code>merges</code> ç›´åˆ°ä¸èƒ½å†åº”ç”¨ä¸ºæ­¢ã€‚WordPieceå¹¶ä¸ä¼šå°†å•è¯æ‹†åˆ†æˆå­—ç¬¦ï¼Œè€Œæ˜¯é¦–å…ˆå¯»æ‰¾å‡ºç°åœ¨ <code>vocab</code> ä¸­çš„<strong>æœ€é•¿å‰ç¼€</strong>ï¼Œç„¶åå°†å•è¯ä¸€åˆ†ä¸ºäºŒï¼Œç”¨æ•°å­¦å…¬å¼æè¿°å°±æ˜¯</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          j 
         
        
          = 
         
         
          
          
            argâ€‰max 
           
          
            â¡ 
           
          
         
           i 
          
         
        
          ( 
         
        
          word 
         
        
          [ 
         
        
          : 
         
        
          i 
         
        
          ] 
        â€…â€Šâ€…â€Š 
         
         
           in 
         â€…â€Š 
         
           Â vocab 
          
         
        
          ) 
         
        
       
         j=\argmax_i (\text{word}[:i] \;\;\text{in\; vocab} ) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.854em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.6721em; vertical-align: -0.9221em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.4306em;"><span class="" style="top: -2.1779em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop"><span class="mord mathrm" style="margin-right: 0.0139em;">arg</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathrm">max</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9221em;"><span class=""></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord">word</span></span><span class="mopen">[</span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord text"><span class="mord">in</span><span class="mspace" style="margin-right: 0.2777em;"></span><span class="mord">Â vocab</span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>ç„¶åå°† <code>word</code> æ‹†åˆ†æˆ <code>word[:j]</code> å’Œ <code>##word[j:]</code>ï¼Œå‰è€…æ·»åŠ åˆ°æœ€ç»ˆç»“æœä¸­ï¼Œåè€…ç»§ç»­åº”ç”¨ä¸Šè¿°æ“ä½œã€‚</p> 
<p>BPEä»…ä»…ä¼šæŠŠé‚£äº›æ²¡æœ‰å‡ºç°åœ¨è¯è¡¨ä¸­çš„<strong>å­—ç¬¦</strong>æ ‡æˆ <code>[UNK]</code>ï¼Œè€Œåœ¨WordPieceçš„åˆ†è¯è¿‡ç¨‹ä¸­ï¼Œ<strong>åªè¦æœ‰ä¸€æ¬¡</strong>åœ¨è¯è¡¨ä¸­æ‰¾ä¸åˆ°æœ€é•¿å‰ç¼€ï¼Œé‚£ä¹ˆ<strong>æ•´ä¸ªå•è¯</strong>å°±ä¼šè¢«æ ‡è®°ä¸º <code>[UNK]</code>ã€‚</p> 
<h4><a id="223_WordPiece_427"></a>2.2.3 ä»é›¶å®ç°WordPiece</h4> 
<p>ç”±äºWordPieceå’ŒBPEå¤§ä½“ç›¸ä¼¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ”¹å†™ä¸€éƒ¨åˆ†å‡½æ•°å³å¯ã€‚</p> 
<p>é¦–å…ˆæ˜¯ <code>get_word_splits</code> å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦ç»™æ¯ä¸ªéå•è¯å¼€å¤´çš„å­—ç¬¦åŠ ä¸Š <code>##</code> å‰ç¼€</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_word_splits</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    word_splits <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> word_freqs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>c <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token string-interpolation"><span class="token string">f"##</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>c<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> word_splits
</code></pre> 
<p>BPEåªéœ€è¦è®¡ç®— <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         , 
        
        
        
          t 
         
        
          j 
         
        
       
         ) 
        
       
      
        n(t_i,t_j) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>ï¼Œè€ŒWordPieceé™¤äº† <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         , 
        
        
        
          t 
         
        
          j 
         
        
       
         ) 
        
       
      
        n(t_i,t_j) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> è¿˜éœ€è¦è®¡ç®— <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         ) 
        
       
      
        n(t_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>ã€‚æˆ‘ä»¬å°† <code>get_pair_freqs</code> æ”¹å†™æˆ <code>get_pair_scores</code></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_pair_scores</span><span class="token punctuation">(</span>
    word_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    word_splits<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    pair_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    subword_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> freq<span class="token punctuation">,</span> split <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> word_splits<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            subword_freqs<span class="token punctuation">[</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
            <span class="token keyword">continue</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            pair_freqs<span class="token punctuation">[</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
            subword_freqs<span class="token punctuation">[</span>split<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
        subword_freqs<span class="token punctuation">[</span>split<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq

    pair_scores <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        pair<span class="token punctuation">:</span> freq <span class="token operator">/</span> <span class="token punctuation">(</span>subword_freqs<span class="token punctuation">[</span>pair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> subword_freqs<span class="token punctuation">[</span>pair<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> \
        <span class="token keyword">for</span> pair<span class="token punctuation">,</span> freq <span class="token keyword">in</span> pair_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pair_scores
</code></pre> 
<p>ç„¶åæ˜¯ <code>merge_pair</code> å‡½æ•°ï¼Œå”¯ä¸€éœ€è¦æ³¨æ„çš„ç»†èŠ‚å°±æ˜¯ï¼Œå½“ç¬¬äºŒä¸ªå­è¯å«æœ‰ <code>##</code> å‰ç¼€æ—¶ï¼Œéœ€è¦å°†å…¶å»æ‰</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">merge_pair</span><span class="token punctuation">(</span>pair<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a<span class="token punctuation">,</span> b <span class="token operator">=</span> pair
    <span class="token keyword">for</span> word <span class="token keyword">in</span> word_splits<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        split <span class="token operator">=</span> word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> split<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> a <span class="token keyword">and</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> b<span class="token punctuation">:</span>
                new_word <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> b<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'##'</span><span class="token punctuation">)</span> <span class="token keyword">else</span> a <span class="token operator">+</span> b
                split <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>new_word<span class="token punctuation">]</span> <span class="token operator">+</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>
        word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> split
    <span class="token keyword">return</span> word_splits
</code></pre> 
<p>æœ€åå°±æ˜¯WordPieceçš„è®­ç»ƒå‡½æ•°äº†ã€‚æ³¨æ„ç”±äºä¸éœ€è¦ä¿å­˜ <code>merges</code>ï¼Œå› æ­¤è®­ç»ƒåœæ­¢çš„æ¡ä»¶å°±æ˜¯è¯è¡¨å¤§å°è¾¾åˆ°é¢„å…ˆè®¾å®šçš„å€¼</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">wordpiece_train</span><span class="token punctuation">(</span>vocab_size<span class="token punctuation">,</span> word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    vocab <span class="token operator">=</span> get_base_vocab<span class="token punctuation">(</span>word_splits<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>vocab<span class="token punctuation">)</span> <span class="token operator">&lt;</span> vocab_size<span class="token punctuation">:</span>
        pair_scores <span class="token operator">=</span> get_pair_scores<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> pair_scores<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        max_score_pair <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>pair_scores<span class="token punctuation">,</span> key<span class="token operator">=</span>pair_scores<span class="token punctuation">.</span>get<span class="token punctuation">)</span>
        word_splits <span class="token operator">=</span> merge_pair<span class="token punctuation">(</span>max_score_pair<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
        a<span class="token punctuation">,</span> b <span class="token operator">=</span> max_score_pair
        new_word <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> b<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'##'</span><span class="token punctuation">)</span> <span class="token keyword">else</span> a <span class="token operator">+</span> b
        vocab<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_word<span class="token punctuation">)</span>
    <span class="token keyword">return</span> vocab
</code></pre> 
<p>ä¾æ—§æ‹¿WikiText-2çš„éªŒè¯é›†æ¥çœ‹ä¸€ä¸‹WordPieceç®—æ³•éƒ½å­¦åˆ°äº†ä»€ä¹ˆï¼Œè®¾ç½®æœ€ç»ˆè¯è¡¨å¤§å°ä¸º300ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> datasets <span class="token keyword">import</span> load_dataset
<span class="token keyword">from</span> tokenizers<span class="token punctuation">.</span>pre_tokenizers <span class="token keyword">import</span> Whitespace

pre_tokenizer <span class="token operator">=</span> Whitespace<span class="token punctuation">(</span><span class="token punctuation">)</span>

corpus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
data <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"wikitext"</span><span class="token punctuation">,</span> <span class="token string">"wikitext-2-v1"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"validation"</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> line <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    tokenized_line <span class="token operator">=</span> pre_tokenizer<span class="token punctuation">.</span>pre_tokenize_str<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    corpus<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tokenized_line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

word_freqs <span class="token operator">=</span> get_word_freqs<span class="token punctuation">(</span>corpus<span class="token punctuation">)</span>
word_splits <span class="token operator">=</span> get_word_splits<span class="token punctuation">(</span>word_freqs<span class="token punctuation">)</span>
vocab <span class="token operator">=</span> wordpiece_train<span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># ['!', '"', '##,', '##-', '##.', '##0', '##1', '##2', '##3', '##4', '##5', '##6', '##7', '##8', '##9', '##@', '##A', '##B', '##C', '##D']</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># ['XIV', 'UP', '##PI', 'UK', 'NFL', 'NHC', 'NCAA', 'NHS', 'NME', 'WWE', 'FBI', 'FIBA', 'FIFA', 'DVD', 'kW', 'HIV', 'HMCS', 'HBO', 'NBA', 'GBA']</span>
</code></pre> 
<p>ç›¸æ¯”BPEï¼ŒWordPieceçš„åˆ†è¯å®ç°è¾ƒä¸ºç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦æ”¹å†™ <code>tokenize_word</code> å‡½æ•°å³å¯</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">tokenize_word</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> vocab<span class="token punctuation">)</span><span class="token punctuation">:</span>
    new_word <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        i <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span>
        <span class="token keyword">while</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> word<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> vocab<span class="token punctuation">:</span>
            i <span class="token operator">-=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'[UNK]'</span><span class="token punctuation">]</span>
        new_word<span class="token punctuation">.</span>append<span class="token punctuation">(</span>word<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        word <span class="token operator">=</span> word<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            word <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"##</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>word<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    <span class="token keyword">return</span> new_word
</code></pre> 
<p>ç»§ç»­ä½¿ç”¨WikiText-2çš„éªŒè¯é›†å¹¶è®¾ç½®æœ€ç»ˆè¯è¡¨å¤§å°ä¸º3000ï¼Œå°è¯•å¯¹ä¸åŒå•è¯è¿›è¡Œåˆ†è¯ï¼Œæ•ˆæœå¦‚ä¸‹</p> 
<pre><code class="prism language-python">words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'occupied'</span><span class="token punctuation">,</span> <span class="token string">'upload'</span><span class="token punctuation">,</span> <span class="token string">'company'</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> word <span class="token keyword">in</span> words<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>tokenize_word<span class="token punctuation">(</span>word<span class="token punctuation">,</span> vocab<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># ['app', '##l', '##e']</span>
<span class="token comment"># ['occupi', '##e', '##d']</span>
<span class="token comment"># ['up', '##l', '##o', '##a', '##d']</span>
<span class="token comment"># ['comp', '##a', '##n', '##y']</span>
</code></pre> 
<h4><a id="224__562"></a>2.2.4 è§£ç æµç¨‹</h4> 
<p>æˆ‘ä»¬å¯ä»¥æ ¹æ® <code>##</code> æ¥è§£ç ï¼Œä»¥ä¸‹æä¾›äº†ä¸€ç§å¯èƒ½çš„å®ç°æ–¹æ¡ˆ</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    res<span class="token punctuation">,</span> cur <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'##'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cur<span class="token punctuation">)</span>
            cur <span class="token operator">=</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            cur <span class="token operator">+=</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cur<span class="token punctuation">)</span>

    <span class="token keyword">return</span> res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
</code></pre> 
<p>æ•ˆæœ</p> 
<pre><code class="prism language-python">output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Th'</span><span class="token punctuation">,</span> <span class="token string">'##i'</span><span class="token punctuation">,</span> <span class="token string">'##s'</span><span class="token punctuation">,</span> <span class="token string">'is'</span><span class="token punctuation">,</span> <span class="token string">'th'</span><span class="token punctuation">,</span> <span class="token string">'##e'</span><span class="token punctuation">,</span> <span class="token string">'Hugg'</span><span class="token punctuation">,</span> <span class="token string">'##i'</span><span class="token punctuation">,</span> <span class="token string">'##n'</span><span class="token punctuation">,</span> <span class="token string">'##g'</span><span class="token punctuation">,</span> <span class="token string">'Fac'</span><span class="token punctuation">,</span> <span class="token string">'##e'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'##o'</span><span class="token punctuation">,</span> <span class="token string">'##u'</span><span class="token punctuation">,</span> <span class="token string">'##r'</span><span class="token punctuation">,</span> <span class="token string">'##s'</span><span class="token punctuation">,</span> <span class="token string">'##e'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>decode<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># ['This', 'is', 'the', 'Hugging', 'Face', 'course']</span>
</code></pre> 
<h3><a id="23_Unigram_590"></a>2.3 Unigram</h3> 
<h4><a id="231__593"></a>2.3.1 å­¦ä¹ æµç¨‹</h4> 
<p>BPEå’ŒWordPieceéƒ½æ˜¯ä»ä¸€ä¸ªå°çš„åŸºç¡€è¯è¡¨å¼€å§‹ä¸æ–­å»æ‰©å……è¿™ä¸ªè¯è¡¨ï¼Œè€ŒUnigramåˆ™<strong>ä¸ä¹‹ç›¸å</strong>ï¼ŒUnigramä¼šå…ˆåˆå§‹åŒ–ä¸€ä¸ªå¤§çš„è¯è¡¨ï¼Œç„¶åä¸æ–­ä»ä¸­åˆ å»å­è¯ç›´è‡³è¯è¡¨è¾¾åˆ°æŒ‡å®šçš„å¤§å°ã€‚</p> 
<p>Unigramåˆå§‹åŒ–è¯è¡¨çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥åœ¨é¢„åˆ†è¯çš„ç»“æœä¸Šåº”ç”¨BPEç®—æ³•å¹¶è®¾ç½®è¾ƒå¤§çš„mergesä»¥è·å¾—åˆå§‹è¯è¡¨ï¼Œæˆ–è€…è®¡ç®—é¢„åˆ†è¯ç»“æœçš„æ‰€æœ‰<strong>ä¸¥æ ¼å­ä¸²</strong>å¹¶ä»ä¸­é€‰å–ä¸€äº›å‡ºç°é¢‘ç‡æœ€é«˜çš„å­ä¸²ä½œä¸ºåˆå§‹è¯è¡¨ã€‚</p> 
<p>è¿™é‡Œä»¥åè€…ä¸ºä¾‹ï¼ˆæ³¨æ„åˆå§‹è¯è¡¨è¿˜éœ€è¦åŒ…å«æ‰€æœ‰çš„åŸºç¡€å­—ç¬¦ä»¥é˜²æ­¢OOVï¼‰ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">init_vocab</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> init_vocab_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    char_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    subword_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> word<span class="token punctuation">,</span> freq <span class="token keyword">in</span> word_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            char_freqs<span class="token punctuation">[</span>word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
            <span class="token comment"># å­è¯çš„é•¿åº¦è‡³å°‘æ˜¯2ï¼Œå¹¶ä¸”word[i:j]æ˜¯å·¦é—­å³å¼€ï¼Œå› æ­¤jæœ€å¤šè¦å–åˆ°len(word)</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># å¿…é¡»æ˜¯ä¸¥æ ¼å­è¯ï¼Œå³ä¸èƒ½åŒ…å«è‡ªèº«</span>
                <span class="token keyword">if</span> j <span class="token operator">-</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    subword_freqs<span class="token punctuation">[</span>word<span class="token punctuation">[</span>i<span class="token punctuation">:</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
    char_freqs <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>char_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    subword_freqs <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>subword_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> init_vocab_size <span class="token operator">&gt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>char_freqs<span class="token punctuation">)</span>
    vocab_with_freqs <span class="token operator">=</span> char_freqs <span class="token operator">+</span> subword_freqs<span class="token punctuation">[</span><span class="token punctuation">:</span>init_vocab_size <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>char_freqs<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>vocab_with_freqs<span class="token punctuation">)</span>
</code></pre> 
<p>åœ¨å¾—åˆ°äº†åˆå§‹è¯è¡¨åï¼Œæˆ‘ä»¬å¦‚ä½•å¯¹å®ƒè¿›è¡Œå‰ªæå‘¢ï¼Ÿè¿™é‡Œæœ‰å¿…è¦å…ˆäº†è§£ä¸€ä¸‹Unigramçš„åˆ†è¯æµç¨‹ï¼Œè¯»è€…å¯å…ˆè·³è½¬è‡³2.3.2èŠ‚ã€‚</p> 
<p>ç°åœ¨å‡å®šä½ å·²ç»é˜…è¯»å®Œäº†2.3.2èŠ‚ã€‚Unigramé¦–å…ˆä¼šè®¡ç®—æ•´ä¸ªè¯­æ–™åº“ï¼ˆé¢„åˆ†è¯ç»“æœï¼‰ä¸Šçš„lossï¼Œå…·ä½“è€Œè¨€ï¼Œè®¾è¯­æ–™åº“ä¸­çš„æ‰€æœ‰å•è¯ä¸º <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          1 
         
        
       
         , 
        
       
         â‹¯ 
       â€‰ 
       
         , 
        
        
        
          w 
         
        
          N 
         
        
       
      
        w_1,\cdots,w_N 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">â‹¯</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">N</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>ï¼ˆå¯èƒ½ä¼šæœ‰é‡å¤ï¼‰ï¼Œé‚£ä¹ˆæ•´ä¸ªè¯­æ–™åº“çš„losså¯ä»¥è¡¨ç¤ºæˆ</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
        
          c 
         
        
          o 
         
        
          r 
         
        
          p 
         
        
          u 
         
        
          s 
         
        
          ) 
         
        
          = 
         
         
         
           âˆ‘ 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           N 
          
         
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
        
          ) 
         
        
          = 
         
         
         
           âˆ‘ 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           K 
          
         
         
         
           f 
          
         
           i 
          
         
        
          â‹… 
         
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           â€² 
          
         
        
          ) 
         
        
          , 
         
         
        
          word_freqs 
         
        
          [ 
         
         
         
           w 
          
         
           i 
          
         
           â€² 
          
         
        
          ] 
         
        
          = 
         
         
         
           f 
          
         
           i 
          
         
        
          , 
         
         
        
          { 
         
         
         
           w 
          
         
           i 
          
         
           â€² 
          
         
         
         
           } 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           K 
          
         
        
          âŠ‚ 
         
        
          { 
         
         
         
           w 
          
         
           i 
          
         
         
         
           } 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           N 
          
         
        
          , 
         
         
         
         
           âˆ‘ 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           K 
          
         
         
         
           f 
          
         
           i 
          
         
        
          = 
         
        
          N 
         
        
       
         loss(corpus)=\sum_{i=1}^Nloss(w_i)=\sum_{i=1}^Kf_i\cdot loss(w'_i),\quad \text{word\_freqs}[w'_i]=f_i,\quad \{w'_i\}_{i=1}^K \subset \{w_i\}_{i=1}^N,\quad \sum_{i=1}^Kf_i=N 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0278em;">cor</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.106em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8283em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">N</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.106em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8283em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1119em; vertical-align: -0.31em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -2.453em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 1em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord text"><span class="mord">word_freqs</span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -2.453em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.1413em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 1em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mopen">{<!-- --></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -2.453em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">âŠ‚</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.106em; vertical-align: -1.2777em;"></span><span class="mopen">{<!-- --></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">N</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 1em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8283em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">N</span></span></span></span></span></span></p> 
<p>è€Œ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
          â€² 
         
        
       
         ) 
        
       
      
        loss(w'_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> å°±æ˜¯ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          i 
         
        
          â€² 
         
        
       
      
        w'_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span></span></span></span></span> ç»è¿‡Unigramåˆ†è¯åå¯¹åº”çš„lossï¼Œå³</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
        
          c 
         
        
          o 
         
        
          r 
         
        
          p 
         
        
          u 
         
        
          s 
         
        
          ) 
         
        
          = 
         
         
         
           âˆ‘ 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           K 
          
         
        
          word_freqs 
         
        
          [ 
         
         
         
           w 
          
         
           i 
          
         
           â€² 
          
         
        
          ] 
         
        
          â‹… 
         
        
          tokenize_word 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           â€² 
          
         
        
          , 
        â€…â€Š 
        
          vocab_with_loss 
         
        
          ) 
         
        
          [ 
         
        
          1 
         
        
          ] 
         
        
       
         loss(corpus)=\sum_{i=1}^K\text{word\_freqs}[w'_i]\cdot \text{tokenize\_word}(w'_i,\;\text{vocab\_with\_loss})[1] 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0278em;">cor</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.106em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8283em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord text"><span class="mord">word_freqs</span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -2.453em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1119em; vertical-align: -0.31em;"></span><span class="mord text"><span class="mord">tokenize_word</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -2.453em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord text"><span class="mord">vocab_with_loss</span></span><span class="mclose">)</span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span></span></p> 
<p>æ¥ä¸‹æ¥ï¼ŒUnigramä¼šä¸ºvocabä¸­çš„æ¯ä¸ªå­è¯è®¡ç®—ä¸€ä¸ªscoreï¼Œè¿™ä¸ªscoreç­‰äºä»vocabä¸­ç§»é™¤è¯¥å­è¯å <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
       
         c 
        
       
         o 
        
       
         r 
        
       
         p 
        
       
         u 
        
       
         s 
        
       
         ) 
        
       
      
        loss(corpus) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0278em;">cor</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span> çš„å˜åŒ–å€¼ã€‚å¯ä»¥è¯æ˜ï¼Œè¿™ä¸ªå˜åŒ–å€¼ä¸€å®šæ˜¯<strong>éè´Ÿçš„</strong>ï¼Œå› æ­¤scoreè¶Šå°è¯´æ˜è¿™ä¸ªå­è¯åœ¨vocabä¸­è¶Šä¸é‡è¦ï¼Œæ•…å¯ä»¥ç§»é™¤ã€‚</p> 
<blockquote> 
 <p>âš ï¸ ä¸å°‘æ•™ç¨‹ä¼šæŠŠè¿™ä¸ªscoreç§°ä¸ºlossã€‚</p> 
</blockquote> 
<p>å°†vocabä¸­çš„å­è¯æŒ‰ç…§scoreä»å°åˆ°å¤§è¿›è¡Œæ’åºï¼Œå¹¶ç§»é™¤å‰ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
         % 
        
       
      
        p\% 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9444em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord">%</span></span></span></span></span> ä¸ªå­è¯ï¼ˆé€šå¸¸å– <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         10 
        
       
         , 
        
       
         20 
        
       
      
        10,20 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8389em; vertical-align: -0.1944em;"></span><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">20</span></span></span></span></span>ï¼‰ï¼Œç„¶åé‡æ–°è®¡ç®— <code>vocab_with_loss</code> ã€‚åå¤æ‰§è¡Œä¸Šè¿°æ“ä½œç›´è‡³vocabå¤§å°ç¬¦åˆè¦æ±‚ã€‚</p> 
<blockquote> 
 <p>ğŸ“ <strong>å…³äºå˜åŒ–å€¼æ˜¯éè´Ÿçš„è¯æ˜ï¼š</strong></p> 
 <p>æ³¨æ„åˆ° <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
        
          c 
         
        
          o 
         
        
          r 
         
        
          p 
         
        
          u 
         
        
          s 
         
        
          ) 
         
        
       
         loss(corpus) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0278em;">cor</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span> ä»…ä¸ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           â€² 
          
         
        
          ) 
         
        
       
         loss(w'_i) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> æœ‰å…³ï¼Œå› æ­¤åªéœ€è¦ç ”ç©¶åè€…çš„å˜åŒ–å€¼ã€‚å½“ç§»é™¤äº†ä¸€äº›å­è¯åï¼ŒåŒ…å«äº†è¿™äº›å­è¯çš„åˆ†è¯æ–¹æ¡ˆä¹Ÿå°±ä¸å†å­˜åœ¨ï¼Œç›¸åº”çš„åˆ†è¯æ–¹æ¡ˆç©ºé—´ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          S 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           â€² 
          
         
        
          ) 
         
        
       
         \mathcal{S}(w'_i) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord mathcal" style="margin-right: 0.075em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> å°±ä¼šç¼©å°ï¼Œè€Œ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           â€² 
          
         
        
          ) 
         
        
       
         loss(w'_i) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> æ˜¯åŸºäº <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          S 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           â€² 
          
         
        
          ) 
         
        
       
         \mathcal{S}(w'_i) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord mathcal" style="margin-right: 0.075em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> è®¡ç®—å‡ºçš„æœ€å°å€¼ï¼Œå› æ­¤è¿™ä¸ªæœ€å°å€¼ä¼šå¢å¤§ã€‚</p> 
 <p>ç±»ä¼¼äºï¼š<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          min 
         
        
          â¡ 
         
         
         
           S 
          
         
           â€² 
          
         
        
          â‰¥ 
         
        
          min 
         
        
          â¡ 
         
        
          S 
         
        
       
         \min S'\geq \min S 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8879em; vertical-align: -0.136em;"></span><span class="mop">min</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">â‰¥</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mop">min</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span></span></span></span></span>ï¼Œå…¶ä¸­ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
         
           â€² 
          
         
        
          âŠ† 
         
        
          S 
         
        
       
         S'\subseteq S 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8879em; vertical-align: -0.136em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">âŠ†</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span></span></span></span></span>ã€‚</p> 
</blockquote> 
<h4><a id="232__650"></a>2.3.2 åˆ†è¯æµç¨‹</h4> 
<p>Unigramåˆ†è¯ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒå‡è®¾å„ä¸ªå­è¯ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œå› æ­¤å¯¹äºä¸€ä¸ªå•è¯ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
      
        w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span> è€Œè¨€ï¼Œå°†å…¶æ‹†åˆ†æˆå­è¯åºåˆ— <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
         = 
        
       
         ( 
        
        
        
          w 
         
        
          1 
         
        
       
         , 
        
       
         â‹¯ 
       â€‰ 
       
         , 
        
        
        
          w 
         
        
          m 
         
        
       
         ) 
        
       
      
        w=(w_1,\cdots,w_m) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">â‹¯</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> åæœ‰</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
           
           
             P 
            
           
             ( 
            
           
             w 
            
           
             ) 
            
           
             = 
            
            
            
              âˆ 
             
             
             
               i 
              
             
               = 
              
             
               1 
              
             
            
              m 
             
            
           
             P 
            
           
             ( 
            
            
            
              w 
             
            
              i 
             
            
           
             ) 
            
           
          
          
          
          
            (1) 
           
          
         
        
       
         P(w)=\prod_{i=1}^m P(w_i)\tag{1} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.9291em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height: 2.9291em; vertical-align: -1.2777em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">1</span></span><span class="mord">)</span></span></span></span></span></span></span></p> 
<p>å…¶ä¸­ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         P 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
       
         ) 
        
       
      
        P(w_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> å¯ä»¥é€šè¿‡ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          i 
         
        
       
      
        w_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> å‡ºç°çš„é¢‘ç‡æ¥ä¼°è®¡ï¼ˆæ³¨æ„ä¸æ˜¯é¢‘æ•°ï¼‰ã€‚</p> 
<p>è®° <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         S 
        
       
         ( 
        
       
         w 
        
       
         ) 
        
       
      
        \mathcal{S}(w) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathcal" style="margin-right: 0.075em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)</span></span></span></span></span> ä¸ºå•è¯ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
      
        w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span> çš„æ‰€æœ‰åˆ†è¯æ–¹æ¡ˆï¼Œä»è€ŒUnigramçš„åˆ†è¯ç»“æœä¸º</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
           
            
            
              w 
             
            
              âˆ— 
             
            
           
             = 
            
            
             
             
               argâ€‰max 
              
             
               â¡ 
              
             
             
              
              
                w 
               
              
                â€² 
               
              
             
               âˆˆ 
              
             
               S 
              
             
               ( 
              
             
               w 
              
             
               ) 
              
             
            
           
             P 
            
           
             ( 
            
            
            
              w 
             
            
              â€² 
             
            
           
             ) 
            
           
          
          
          
          
            (2) 
           
          
         
        
       
         w^*=\argmax_{w'\in\mathcal{S}(w)} P(w')\tag{2} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7387em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7387em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.9623em; vertical-align: -1.1604em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.4306em;"><span class="" style="top: -2.1146em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mrel mtight">âˆˆ</span><span class="mord mathcal mtight" style="margin-right: 0.075em;">S</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="mclose mtight">)</span></span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop"><span class="mord mathrm" style="margin-right: 0.0139em;">arg</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathrm">max</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.1604em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height: 1.9623em; vertical-align: -1.1604em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">2</span></span><span class="mord">)</span></span></span></span></span></span></span></p> 
<p>è®¾ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
      
        w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span> çš„é•¿åº¦ä¸º <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
      
        n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span>ï¼Œè‹¥é™å®š <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         m 
        
       
         &gt; 
        
       
         1 
        
       
      
        m&gt;1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em; vertical-align: -0.0391em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span>ï¼ˆå³å¿…é¡»å¯¹ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
      
        w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span> è¿›è¡Œåˆ‡åˆ†ï¼‰ï¼Œåˆ™å¯çŸ¥ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         âˆ£ 
        
       
         S 
        
       
         âˆ£ 
        
       
         = 
        
        
        
          2 
         
         
         
           n 
          
         
           âˆ’ 
          
         
           1 
          
         
        
       
         âˆ’ 
        
       
         1 
        
       
      
        |\mathcal{S}|=2^{n-1}-1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">âˆ£</span><span class="mord mathcal" style="margin-right: 0.075em;">S</span><span class="mord">âˆ£</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8974em; vertical-align: -0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span>ï¼ˆä½¿ç”¨éš”æ¿æ³•ï¼Œå…±æœ‰ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
         âˆ’ 
        
       
         1 
        
       
      
        n-1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6667em; vertical-align: -0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span> ä¸ªç©ºï¼Œå¯æ”¾ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
       
         , 
        
       
         2 
        
       
         , 
        
       
         â‹¯ 
       â€‰ 
       
         , 
        
       
         n 
        
       
         âˆ’ 
        
       
         1 
        
       
      
        1,2,\cdots,n-1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8389em; vertical-align: -0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">â‹¯</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span> ä¸ªéš”æ¿ï¼‰ï¼Œå› æ­¤æš´åŠ›æ±‚è§£ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          âˆ— 
         
        
       
      
        w^* 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6887em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span></span></span></span></span> çš„æ—¶é—´å¤æ‚åº¦æ˜¯ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
        
        
          2 
         
        
          n 
         
        
       
         ) 
        
       
      
        O(2^n) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å¯è¡Œçš„ã€‚</p> 
<p>ä»æ•°å€¼ç¨³å®šæ€§çš„è§’åº¦æ¥è®²ï¼Œè®¡ç®— <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         P 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
       
         ) 
        
       
      
        P(w_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> çš„ä¹˜ç§¯æ²¡æœ‰è®¡ç®— <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         log 
        
       
         â¡ 
        
       
         P 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
       
         ) 
        
       
      
        \log P(w_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> çš„å’Œç¨³å®šï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¯¹ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         1 
        
       
         ) 
        
       
      
        (1) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> å¼å–è´Ÿå¯¹æ•°ï¼Œå¹¶è®° <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
       
         ) 
        
       
         = 
        
       
         âˆ’ 
        
       
         log 
        
       
         â¡ 
        
       
         P 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
       
         ) 
        
       
      
        loss(w_i)=-\log P(w_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">âˆ’</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>ï¼Œäºæ˜¯å°±æœ‰</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
           
           
             l 
            
           
             o 
            
           
             s 
            
           
             s 
            
           
             ( 
            
           
             w 
            
           
             ) 
            
           
             = 
            
            
            
              âˆ‘ 
             
             
             
               i 
              
             
               = 
              
             
               1 
              
             
            
              m 
             
            
           
             l 
            
           
             o 
            
           
             s 
            
           
             s 
            
           
             ( 
            
            
            
              w 
             
            
              i 
             
            
           
             ) 
            
           
          
          
          
          
            (3) 
           
          
         
        
       
         loss(w)=\sum_{i=1}^m loss(w_i)\tag{3} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.9291em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height: 2.9291em; vertical-align: -1.2777em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">3</span></span><span class="mord">)</span></span></span></span></span></span></span></p> 
<p>ä»è€Œ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         2 
        
       
         ) 
        
       
      
        (2) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span></span> å¼å˜æˆ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          âˆ— 
         
        
       
         = 
        
        
         
         
           argâ€‰min 
          
         
           â¡ 
          
         
         
          
          
            w 
           
          
            â€² 
           
          
         
           âˆˆ 
          
         
           S 
          
         
           ( 
          
         
           w 
          
         
           ) 
          
         
        
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
        
        
          w 
         
        
          â€² 
         
        
       
         ) 
        
       
      
        w^*=\argmin_{w'\in\mathcal{S}(w)} loss(w') 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6887em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.171em; vertical-align: -0.4191em;"></span><span class="mop"><span class="mop"><span class="mord mathrm" style="margin-right: 0.0139em;">arg</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathrm">min</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2809em;"><span class="" style="top: -2.4559em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mrel mtight">âˆˆ</span><span class="mord mathcal mtight" style="margin-right: 0.075em;">S</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4191em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">â€²</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>ã€‚</p> 
<p>å›åˆ°æ±‚è§£ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          âˆ— 
         
        
       
      
        w^* 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6887em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span></span></span></span></span> çš„é—®é¢˜ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŠ¨æ€è§„åˆ’çš„æ–¹æ³•å°†æ—¶é—´å¤æ‚åº¦é™ä½è‡³ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
        
        
          n 
         
        
          3 
         
        
       
         ) 
        
       
      
        O(n^3) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>ã€‚å…·ä½“æ¥è®²ï¼Œè®° <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         j 
        
       
         ] 
        
       
      
        dp[j] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span></span></span></span></span> ä¸ºå¯¹ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
         [ 
        
       
         : 
        
       
         j 
        
       
         ] 
        
       
      
        w[:j] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span></span></span></span></span> åˆ†è¯å¾—åˆ°çš„æœ€å°lossï¼Œå³ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         j 
        
       
         ] 
        
       
         = 
        
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
       
         w 
        
       
         [ 
        
       
         : 
        
       
         j 
        
        
        
          ] 
         
        
          âˆ— 
         
        
       
         ) 
        
       
      
        dp[j]=loss(w[:j]^*) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>ï¼Œä»è€Œ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         len 
        
       
         ( 
        
       
         w 
        
       
         ) 
        
       
         ] 
        
       
         = 
        
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
       
         w 
        
       
         [ 
        
       
         : 
        
       
         len 
        
       
         ( 
        
       
         w 
        
       
         ) 
        
        
        
          ] 
         
        
          âˆ— 
         
        
       
         ) 
        
       
         = 
        
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
        
        
          w 
         
        
          âˆ— 
         
        
       
         ) 
        
       
      
        dp[\text{len}(w)]=loss(w[:\text{len}(w)]^*)=loss(w^*) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord text"><span class="mord">len</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord text"><span class="mord">len</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> å°±æ˜¯æœ€ç»ˆç­”æ¡ˆã€‚</p> 
<blockquote> 
 <p>âš ï¸ è¿™é‡Œçš„ <code>w[:j]</code> éµå¾ªPythonçš„åˆ‡ç‰‡ï¼Œå³å·¦é—­å³å¼€ï¼Œå–ä¸åˆ° <code>j</code>ã€‚</p> 
</blockquote> 
<p>æ¥ä¸‹æ¥çœ‹è½¬ç§»æ–¹ç¨‹ã€‚å¯¹ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
         [ 
        
       
         : 
        
       
         j 
        
       
         ] 
        
       
      
        w[:j] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span></span></span></span></span> è¿›è¡Œåˆ†è¯å¯ä»¥å¾—åˆ°è‹¥å¹²ä¸ªå­è¯ï¼Œè¿™é‡Œæˆ‘ä»¬åªå…³æ³¨<strong>æœ€åä¸€ä¸ªå­è¯</strong>ï¼Œä¸å¦¨è®°ä¸º <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         t 
        
       
         o 
        
       
         k 
        
       
         e 
        
       
         n 
        
       
      
        token 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span>ï¼Œå¦‚ä¸‹ï¼š</p> 
<div align="center"> 
 <img src="https://images2.imgbox.com/59/ba/4yzv8p9r_o.png" width="50%"> 
</div> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         t 
        
       
         o 
        
       
         k 
        
       
         e 
        
       
         n 
        
       
      
        token 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span> çš„å·¦ç«¯ç‚¹ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
      
        i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span> çš„å–å€¼èŒƒå›´æ˜¯ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         [ 
        
       
         0 
        
       
         , 
        
       
         j 
        
       
         ) 
        
       
      
        [0,j) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">)</span></span></span></span></span>ï¼Œç”± <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         3 
        
       
         ) 
        
       
      
        (3) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">3</span><span class="mclose">)</span></span></span></span></span> å¼ï¼Œæˆ‘ä»¬æœ‰</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
           
           
             d 
            
           
             p 
            
           
             [ 
            
           
             j 
            
           
             ] 
            
           
             = 
            
            
             
             
               min 
              
             
               â¡ 
              
             
             
             
               0 
              
             
               â‰¤ 
              
             
               i 
              
             
               &lt; 
              
             
               j 
              
             
            
           
             ( 
            
           
             d 
            
           
             p 
            
           
             [ 
            
           
             i 
            
           
             ] 
            
           
             + 
            
           
             l 
            
           
             o 
            
           
             s 
            
           
             s 
            
           
             ( 
            
           
             t 
            
           
             o 
            
           
             k 
            
           
             e 
            
           
             n 
            
           
             ) 
            
           
             ) 
            
           
             = 
            
            
             
             
               min 
              
             
               â¡ 
              
             
             
             
               0 
              
             
               â‰¤ 
              
             
               i 
              
             
               &lt; 
              
             
               j 
              
             
            
           
             ( 
            
           
             d 
            
           
             p 
            
           
             [ 
            
           
             i 
            
           
             ] 
            
           
             + 
            
           
             l 
            
           
             o 
            
           
             s 
            
           
             s 
            
           
             ( 
            
           
             w 
            
           
             [ 
            
           
             i 
            
           
             : 
            
           
             j 
            
           
             ] 
            
           
             ) 
            
           
             ) 
            
           
          
          
          
          
            (4) 
           
          
         
        
       
         dp[j]=\min_{0\leq i&lt;j}( dp[i]+loss(token))=\min_{0\leq i&lt;j}(dp[i]+loss(w[i:j]))\tag{4} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.6138em; vertical-align: -0.8638em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6679em;"><span class="" style="top: -2.3723em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mrel mtight">â‰¤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop">min</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8638em;"><span class=""></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mclose">))</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.6138em; vertical-align: -0.8638em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6679em;"><span class="" style="top: -2.3723em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mrel mtight">â‰¤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop">min</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8638em;"><span class=""></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]))</span></span><span class="tag"><span class="strut" style="height: 1.6138em; vertical-align: -0.8638em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">4</span></span><span class="mord">)</span></span></span></span></span></span></span></p> 
<p>æ˜¾ç„¶ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         1 
        
       
         ] 
        
       
      
        dp[1] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> å°±æ˜¯ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
       
         w 
        
       
         [ 
        
       
         0 
        
       
         ] 
        
       
         ) 
        
       
      
        loss(w[0]) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">])</span></span></span></span></span>ï¼Œè€Œç”± <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         4 
        
       
         ) 
        
       
      
        (4) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mclose">)</span></span></span></span></span> å¼ï¼Œ<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         1 
        
       
         ] 
        
       
         = 
        
       
         d 
        
       
         p 
        
       
         [ 
        
       
         0 
        
       
         ] 
        
       
         + 
        
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
       
         w 
        
       
         [ 
        
       
         0 
        
       
         ] 
        
       
         ) 
        
       
      
        dp[1]=dp[0]+loss(w[0]) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">])</span></span></span></span></span>ï¼Œæ•…å¾—è¾¹ç•Œæ¡ä»¶ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         0 
        
       
         ] 
        
       
         = 
        
       
         0 
        
       
      
        dp[0]=0 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span>ã€‚</p> 
<p>æ³¨æ„ï¼Œåœ¨æ›´æ–° <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         j 
        
       
         ] 
        
       
      
        dp[j] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span></span></span></span></span> çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿å­˜ç›¸åº”çš„ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
      
        i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå½“ <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
      
        dp 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span></span></span></span></span> æ•°ç»„è®¡ç®—å®Œåï¼Œæˆ‘ä»¬å°±å¯ä»¥ä» <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         j 
        
       
         = 
        
       
         len 
        
       
         ( 
        
       
         w 
        
       
         ) 
        
       
      
        j=\text{len}(w) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.854em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord text"><span class="mord">len</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)</span></span></span></span></span> å¼€å§‹ä¸æ–­å‘å‰å›æº¯ä»¥è·å¾— <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          âˆ— 
         
        
       
      
        w^* 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6887em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">âˆ—</span></span></span></span></span></span></span></span></span></span></span></span>ã€‚</p> 
<p>ä¸ºäº†å®ç°è¯¥ç®—æ³•ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå°† <code>vocab_with_freqs</code> å¤„ç†æˆ <code>vocab_with_loss</code>ã€‚</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> math

<span class="token keyword">def</span> <span class="token function">process_vocab</span><span class="token punctuation">(</span>vocab_with_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    total_sum <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>vocab_with_freqs<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    vocab_with_loss <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>token<span class="token punctuation">:</span> <span class="token operator">-</span>math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>freq <span class="token operator">/</span> total_sum<span class="token punctuation">)</span> <span class="token keyword">for</span> token<span class="token punctuation">,</span> freq <span class="token keyword">in</span> vocab_with_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> vocab_with_loss
</code></pre> 
<p>æ¥ä¸‹æ¥å®ç°Unigramåˆ†è¯</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">tokenize_word</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'start'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'loss'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'start'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'loss'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            token <span class="token operator">=</span> word<span class="token punctuation">[</span>i<span class="token punctuation">:</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span> token <span class="token keyword">in</span> vocab_with_loss <span class="token keyword">and</span> dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                new_loss <span class="token operator">=</span> dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span> <span class="token operator">+</span> vocab_with_loss<span class="token punctuation">[</span>token<span class="token punctuation">]</span>
                <span class="token keyword">if</span> dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> new_loss <span class="token operator">&lt;</span> dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'start'</span><span class="token punctuation">:</span> i<span class="token punctuation">,</span> <span class="token string">'loss'</span><span class="token punctuation">:</span> new_loss<span class="token punctuation">}</span>

    word_loss <span class="token operator">=</span> dp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> word_loss <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'[UNK]'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> word_loss

    start<span class="token punctuation">,</span> end <span class="token operator">=</span> dp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'start'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span>
    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span> <span class="token operator">~</span>start<span class="token punctuation">:</span>
        res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>word<span class="token punctuation">[</span>start<span class="token punctuation">:</span>end<span class="token punctuation">]</span><span class="token punctuation">)</span>
        end <span class="token operator">=</span> start
        start <span class="token operator">=</span> dp<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'start'</span><span class="token punctuation">]</span>

    res<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> res<span class="token punctuation">,</span> word_loss
</code></pre> 
<p>è¯¥åŠ¨æ€è§„åˆ’ç®—æ³•åˆç§°Viterbiç®—æ³•ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
        
        
          n 
         
        
          3 
         
        
       
         ) 
        
       
      
        O(n^3) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>ã€‚å…·ä½“æ¨å¯¼å¦‚ä¸‹ï¼šç”±äºåˆ‡ç‰‡çš„æ—¶é—´å¤æ‚åº¦ä¸º <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
       
         j 
        
       
         âˆ’ 
        
       
         i 
        
       
         ) 
        
       
      
        O(j-i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span></span>ï¼Œæ‰€ä»¥æ€»æ—¶é—´å¤æ‚åº¦ä¸º</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
             
             
               âˆ‘ 
              
              
              
                i 
               
              
                = 
               
              
                0 
               
              
              
              
                n 
               
              
                âˆ’ 
               
              
                1 
               
              
             
             
             
               âˆ‘ 
              
              
              
                j 
               
              
                = 
               
              
                i 
               
              
                + 
               
              
                1 
               
              
             
               n 
              
             
            
              O 
             
            
              ( 
             
            
              j 
             
            
              âˆ’ 
             
            
              i 
             
            
              ) 
             
            
           
          
          
           
            
             
            
              = 
             
             
             
               âˆ‘ 
              
              
              
                i 
               
              
                = 
               
              
                0 
               
              
              
              
                n 
               
              
                âˆ’ 
               
              
                1 
               
              
             
            
              O 
             
             
             
               ( 
              
              
               
               
                 ( 
                
               
                 1 
                
               
                 + 
                
               
                 n 
                
               
                 âˆ’ 
                
               
                 i 
                
               
                 ) 
                
               
                 ( 
                
               
                 n 
                
               
                 âˆ’ 
                
               
                 i 
                
               
                 ) 
                
               
              
                2 
               
              
             
               ) 
              
             
            
              = 
             
             
             
               âˆ‘ 
              
              
              
                i 
               
              
                = 
               
              
                1 
               
              
             
               n 
              
             
            
              O 
             
             
             
               ( 
              
              
               
               
                 i 
                
               
                 ( 
                
               
                 i 
                
               
                 + 
                
               
                 1 
                
               
                 ) 
                
               
              
                2 
               
              
             
               ) 
              
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
            
              O 
             
             
             
               ( 
              
              
              
                âˆ‘ 
               
               
               
                 i 
                
               
                 = 
                
               
                 1 
                
               
              
                n 
               
              
              
              
                i 
               
              
                2 
               
              
             
               ) 
              
             
            
              = 
             
            
              O 
             
             
             
               ( 
              
              
               
               
                 n 
                
               
                 ( 
                
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
                 ) 
                
               
                 ( 
                
               
                 2 
                
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
                 ) 
                
               
              
                6 
               
              
             
               ) 
              
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
            
              O 
             
            
              ( 
             
             
             
               n 
              
             
               3 
              
             
            
              ) 
             
            
           
          
         
        
       
         \begin{aligned} \sum_{i=0}^{n-1}\sum_{j=i+1}^nO(j-i)&amp;=\sum_{i=0}^{n-1}O\left(\frac{(1+n-i)(n-i)}{2}\right)=\sum_{i=1}^nO\left(\frac{i(i+1)}{2}\right) \\ &amp;=O\left(\sum_{i=1}^n i^2\right)=O\left(\frac{n(n+1)(2n+1)}{6}\right) \\ &amp;=O(n^3) \end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 8.3667em; vertical-align: -3.9333em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.4333em;"><span class="" style="top: -6.4333em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8011em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mrel mtight">=</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.4138em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span><span class="" style="top: -2.9696em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"></span></span><span class="" style="top: -0.5278em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 3.9333em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.4333em;"><span class="" style="top: -6.4333em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8011em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">âˆ’</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">)</span></span></span></span></span><span class="" style="top: -2.9696em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">âˆ‘</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size4">)</span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">6</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">)</span></span></span></span></span><span class="" style="top: -0.5278em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height: 3.9333em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<h4><a id="233_Unigram_752"></a>2.3.3 ä»é›¶å®ç°Unigram</h4> 
<p>æˆ‘ä»¬åœ¨å‰ä¸¤å°èŠ‚ä¸­å·²ç»å®ç°äº†ä¸€äº›å‡½æ•°ï¼Œæ¥ä¸‹æ¥åªéœ€å®Œæˆå‰©ä¸‹çš„éƒ¨åˆ†ã€‚</p> 
<p>è®¡ç®—æ•´ä¸ªè¯­æ–™åº“ä¸Šçš„æŸå¤±ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">corpus_loss</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span><span class="token punctuation">:</span>
    loss <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> word<span class="token punctuation">,</span> freq <span class="token keyword">in</span> word_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        loss <span class="token operator">+=</span> freq <span class="token operator">*</span> tokenize_word<span class="token punctuation">(</span>word<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> loss
</code></pre> 
<p>ä¸ºvocabä¸­çš„æ¯ä¸ªå­è¯è®¡ç®—ç›¸åº”çš„scoreï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">compute_scores</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    scores <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    pre_loss <span class="token operator">=</span> corpus_loss<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span>
    <span class="token keyword">for</span> token <span class="token keyword">in</span> vocab_with_loss<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token keyword">continue</span>
        vocab_with_loss_ <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>vocab_with_loss<span class="token punctuation">)</span>
        vocab_with_loss_<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>token<span class="token punctuation">)</span>
        cur_loss <span class="token operator">=</span> corpus_loss<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> vocab_with_loss_<span class="token punctuation">)</span>
        scores<span class="token punctuation">[</span>token<span class="token punctuation">]</span> <span class="token operator">=</span> cur_loss <span class="token operator">-</span> pre_loss
    <span class="token keyword">return</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>scores<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>å®šä¹‰Unigramçš„è®­ç»ƒå‡½æ•°ï¼š</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">unigram_train</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> init_vocab_size<span class="token punctuation">,</span> vocab_size<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    vocab_with_freqs <span class="token operator">=</span> init_vocab<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> init_vocab_size<span class="token punctuation">)</span>
    vocab_with_loss <span class="token operator">=</span> process_vocab<span class="token punctuation">(</span>vocab_with_freqs<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>vocab_with_loss<span class="token punctuation">)</span> <span class="token operator">&gt;</span> vocab_size<span class="token punctuation">:</span>
        scores <span class="token operator">=</span> compute_scores<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span>
        num_to_remove <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>vocab_with_loss<span class="token punctuation">)</span> <span class="token operator">*</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>scores<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> num_to_remove <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_to_remove<span class="token punctuation">)</span><span class="token punctuation">:</span>
            vocab_with_freqs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        vocab_with_loss <span class="token operator">=</span> process_vocab<span class="token punctuation">(</span>vocab_with_freqs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> vocab_with_loss
</code></pre> 
<p>åŒæ ·æ‹¿WikiText-2çš„éªŒè¯é›†æ¥çœ‹ä¸€ä¸‹Unigramç®—æ³•éƒ½å­¦åˆ°äº†ä»€ä¹ˆï¼Œè®¾ç½®åˆå§‹è¯è¡¨å¤§å°ä¸º500ï¼Œæœ€ç»ˆè¯è¡¨å¤§å°ä¸º200ï¼Œä¸¢å¼ƒç‡ä¸º0.1ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹</p> 
<pre><code class="prism language-python">pre_tokenizer <span class="token operator">=</span> Whitespace<span class="token punctuation">(</span><span class="token punctuation">)</span>

corpus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
data <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"wikitext"</span><span class="token punctuation">,</span> <span class="token string">"wikitext-2-v1"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"validation"</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> line <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    tokenized_line <span class="token operator">=</span> pre_tokenizer<span class="token punctuation">.</span>pre_tokenize_str<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    corpus<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tokenized_line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

word_freqs <span class="token operator">=</span> get_word_freqs<span class="token punctuation">(</span>corpus<span class="token punctuation">)</span>
vocab_with_loss <span class="token operator">=</span> unigram_train<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
vocab_with_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> vocab_with_loss<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab_with_loss<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># [('!', 9.832349524702789), ('"', 5.970450906457211), ('$', 9.517268478062894), ('%', 9.646946301371425), ('&amp;', 10.77681113354364), ("'", 6.286570914229525), ('(', 6.786064971985966), (')', 6.787827086979365), ('*', 13.128186390707118), ('+', 12.435039210147172), (',', 4.56506426740248), ('-', 6.273304601332049), ('.', 4.7355365343654805), ('/', 9.001052005662027), ('0', 5.683060932736877), ('1', 5.607139156414499), ('2', 6.043540944928233), ('3', 6.869561406868152), ('4', 6.992621499625379), ('5', 6.809218276960683)]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab_with_loss<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># [('pt', 7.320043900726674), ('ated', 7.327579731415376), ('ound', 7.362995287922273), ('ite', 7.38678705247961), ('St', 7.388393478527883), ('ese', 7.396464547361675), ('Au', 7.414453585197748), ('oug', 7.427742817316431), ('stra', 7.432772165721433), ('qu', 7.434454251904418), ('rth', 7.444606623368436), ('ctio', 7.44801378169005), ('ction', 7.449721724035206), ('ass', 7.451432588438836), ('ave', 7.451432588438836), ('ough', 7.458305467726598), ('au', 7.475697210438467), ('nter', 7.502365457520629), ('ish', 7.511415293040546), ('oth', 7.515058284319047)]</span>
</code></pre> 
<p>åˆ†è¯æ•ˆæœ</p> 
<pre><code class="prism language-python">words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'ground'</span><span class="token punctuation">,</span> <span class="token string">'finish'</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> word <span class="token keyword">in</span> words<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>tokenize_word<span class="token punctuation">(</span>word<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># (['a', 'p', 'p', 'l', 'e'], 17.16241864337219)</span>
<span class="token comment"># (['g', 'r', 'ound'], 14.555457675482492)</span>
<span class="token comment"># (['f', 'i', 'n', 'ish'], 17.145052257815873)</span>
</code></pre> 
<p>å› ä¸ºè¯è¡¨è¾ƒå°ï¼Œæ‰€ä»¥åˆ†è¯æ•ˆæœå¹¶ä¸ç†æƒ³ã€‚</p> 
<h4><a id="234__830"></a>2.3.4 è§£ç æµç¨‹</h4> 
<p>Unigramé€šå¸¸ä¸SentencePieceç»“åˆåœ¨ä¸€èµ·ä½¿ç”¨ã€‚SentencePieceä¼šå°†æ–‡æœ¬ä¸­çš„ç©ºæ ¼æ›¿æ¢æˆ <code>â–</code>ï¼ˆU+2581ï¼‰ï¼Œè§£ç æ—¶åªéœ€è¦æ‰§è¡Œå¦‚ä¸‹æ“ä½œå³å¯</p> 
<pre><code class="prism language-python">detokenized <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'â–'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="3__839"></a>3. ä¸‰ç§åˆ†è¯æ–¹æ³•çš„æ¯”è¾ƒ</h2> 
<table><thead><tr><th>åˆ†è¯æ–¹æ³•</th><th>BPE</th><th>WordPiece</th><th>Unigram</th></tr></thead><tbody><tr><td>è®­ç»ƒ</td><td>ä»å°çš„åŸºç¡€è¯è¡¨å¼€å§‹ä¸æ–­å­¦ä¹ è§„åˆ™ä»¥æ‰©å……è¯è¡¨</td><td>å’ŒBPEç›¸åŒ</td><td>ä»å¤§çš„è¯è¡¨å¼€å§‹ä¸æ–­å­¦ä¹ è§„åˆ™ä»¥ç¼©å‡è¯è¡¨</td></tr><tr><td>è§„åˆ™</td><td>åˆå¹¶å‡ºç°é¢‘ç‡æœ€é«˜çš„pair</td><td>åˆå¹¶äº’ä¿¡æ¯æœ€å¤§çš„pair</td><td>ç§»é™¤ä½¿å¾—è¯­æ–™åº“çš„losså¢åŠ æœ€å°çš„å­è¯</td></tr><tr><td>ç»“æœ</td><td>è¯è¡¨+åˆå¹¶è§„åˆ™</td><td>ä»…æœ‰è¯è¡¨</td><td>å¸¦æœ‰lossçš„è¯è¡¨</td></tr><tr><td>ç¼–ç </td><td>å…ˆå°†å•è¯æ‹†æˆå­—ç¬¦ï¼Œç„¶åä¸æ–­åº”ç”¨åˆå¹¶è§„åˆ™</td><td>åœ¨è¯è¡¨ä¸­æ‰¾åˆ°å•è¯çš„æœ€é•¿å‰ç¼€ï¼Œå¯¹å•è¯çš„å‰©ä½™éƒ¨åˆ†é€’å½’æ‰§è¡Œä¸Šè¿°æ“ä½œ</td><td>é€‰å–æŸå¤±æœ€å°çš„åˆ†è¯æ–¹æ¡ˆ</td></tr></tbody></table> 
<hr> 
<h2><a id="Ref_853"></a>Ref</h2> 
<p>[1] <a href="https://huggingface.co/docs/transformers/tokenizer_summary" rel="nofollow">https://huggingface.co/docs/transformers/tokenizer_summary</a><br> [2] <a href="https://paddlepedia.readthedocs.io/en/latest/tutorials/pretrain_model/subword.html" rel="nofollow">https://paddlepedia.readthedocs.io/en/latest/tutorials/pretrain_model/subword.html</a><br> [3] <a href="https://huggingface.co/learn/nlp-course/chapter6/5?fw=pt" rel="nofollow">https://huggingface.co/learn/nlp-course/chapter6/5?fw=pt</a><br> [4] <a href="https://zhuanlan.zhihu.com/p/86965595" rel="nofollow">https://zhuanlan.zhihu.com/p/86965595</a><br> [5] <a href="https://wmathor.com/index.php/archives/1517/" rel="nofollow">https://wmathor.com/index.php/archives/1517/</a><br> [6] <a href="https://github.com/huggingface/transformers/blob/v4.31.0/src/transformers/models/gpt2/tokenization_gpt2.py#L104">https://github.com/huggingface/transformers/blob/v4.31.0/src/transformers/models/gpt2/tokenization_gpt2.py#L104</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4dce18f70746b13550d071fabf54ef53/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">ã€Cè¯­è¨€ã€‘å †æ’åº</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/49c298d48b8275db2bf25cfd05b5a42e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">æ·±å…¥äº†è§£ RabbitMQï¼šé«˜æ€§èƒ½æ¶ˆæ¯ä¸­é—´ä»¶</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§å’–.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>