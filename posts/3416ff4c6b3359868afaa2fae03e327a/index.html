<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深入理解BPE、WordPiece、Unigram分词算法 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3416ff4c6b3359868afaa2fae03e327a/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="深入理解BPE、WordPiece、Unigram分词算法">
  <meta property="og:description" content="目录 1. 前言1.1 word-level分词1.2 char-level分词1.3 为什么要有subword-level分词？ 2. 子词分词2.1 BPE2.1.1 学习流程2.1.2 分词流程2.1.3 从零实现BPE2.1.4 解码流程 2.2 WordPiece2.2.1 学习流程2.2.2 分词流程2.2.3 从零实现WordPiece2.2.4 解码流程 2.3 Unigram2.3.1 学习流程2.3.2 分词流程2.3.3 从零实现Unigram2.3.4 解码流程 3. 三种分词方法的比较Ref 1. 前言 NLP任务中最重要的一个环节就是分词。分词器（Tokenizer）在整个任务流程中扮演的角色如下
即给定一段文本，分词器会将其分割成一个个token，这些token会根据vocab转化成对应的ID以作为模型的输入。
完整的分词流程包含以下四个步骤
标准化阶段（Normalization）：先将原始文本（raw text）做一个预处理，例如去掉Unicode字符的重音（é 变成 e），将所有字母全部转化成小写字母（E 变成 e）等。这一步可以理解为数据清洗；预分词阶段（Pre-tokenization）：进行一遍粗略的分词，例如基于空格&amp;标点的分词，即word-level。注意预分词结果的粒度必须大于最终分词结果的粒度；模型阶段（Model）：在预分词的语料上进行训练（注意分词器的训练和模型的训练是两个概念！模型的训练是通过梯度下降来降低loss，具有随机性，而分词器的训练是一个统计过程，最终的结果是确定性的）；后处理阶段（Postprocessor）：添加一些特殊的token，例如BERT中的 [CLS] 和 [SEP]。 分词的粒度主要有三种：word-level、char-level和subword-level，对于前两种粒度，则不需要经历第三阶段（模型阶段）。
本文将主要聚焦于第三阶段，但在此之前，先让我们回顾一下word-level和char-level分词。
1.1 word-level分词 word-level分词的一个直观出发点是基于空格分词，即对字符串调用 split() 方法
text = &#34;Don&#39;t you love 🤗 Transformers? We sure do.&#34; print(text.split()) # [&#34;Don&#39;t&#34;, &#39;you&#39;, &#39;love&#39;, &#39;🤗&#39;, &#39;Transformers?&#39;, &#39;We&#39;, &#39;sure&#39;, &#39;do.&#39;] 但这个结果不是最优的，因为 Transformers?">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-10-04T16:05:04+08:00">
    <meta property="article:modified_time" content="2023-10-04T16:05:04+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深入理解BPE、WordPiece、Unigram分词算法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#1__4" rel="nofollow">1. 前言</a></li><li><ul><li><a href="#11_wordlevel_36" rel="nofollow">1.1 word-level分词</a></li><li><a href="#12_charlevel_65" rel="nofollow">1.2 char-level分词</a></li><li><a href="#13_subwordlevel_75" rel="nofollow">1.3 为什么要有subword-level分词？</a></li></ul> 
  </li><li><a href="#2__87" rel="nofollow">2. 子词分词</a></li><li><ul><li><a href="#21_BPE_96" rel="nofollow">2.1 BPE</a></li><li><ul><li><a href="#211__98" rel="nofollow">2.1.1 学习流程</a></li><li><a href="#212__150" rel="nofollow">2.1.2 分词流程</a></li><li><a href="#213_BPE_171" rel="nofollow">2.1.3 从零实现BPE</a></li><li><a href="#214__342" rel="nofollow">2.1.4 解码流程</a></li></ul> 
   </li><li><a href="#22_WordPiece_389" rel="nofollow">2.2 WordPiece</a></li><li><ul><li><a href="#221__391" rel="nofollow">2.2.1 学习流程</a></li><li><a href="#222__412" rel="nofollow">2.2.2 分词流程</a></li><li><a href="#223_WordPiece_427" rel="nofollow">2.2.3 从零实现WordPiece</a></li><li><a href="#224__562" rel="nofollow">2.2.4 解码流程</a></li></ul> 
   </li><li><a href="#23_Unigram_590" rel="nofollow">2.3 Unigram</a></li><li><ul><li><a href="#231__593" rel="nofollow">2.3.1 学习流程</a></li><li><a href="#232__650" rel="nofollow">2.3.2 分词流程</a></li><li><a href="#233_Unigram_752" rel="nofollow">2.3.3 从零实现Unigram</a></li><li><a href="#234__830" rel="nofollow">2.3.4 解码流程</a></li></ul> 
  </li></ul> 
  </li><li><a href="#3__839" rel="nofollow">3. 三种分词方法的比较</a></li><li><a href="#Ref_853" rel="nofollow">Ref</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__4"></a>1. 前言</h2> 
<p>NLP任务中最重要的一个环节就是分词。分词器（Tokenizer）在整个任务流程中扮演的角色如下</p> 
<div align="center"> 
 <img src="https://images2.imgbox.com/2d/79/cK5sNo99_o.png" width="70%"> 
</div> 
<p>即给定一段文本，分词器会将其分割成一个个token，这些token会根据vocab转化成对应的ID以作为模型的输入。</p> 
<p>完整的分词流程包含以下四个步骤</p> 
<div align="center"> 
 <img src="https://images2.imgbox.com/8f/07/KgsupEWM_o.png" width="60%"> 
</div> 
<ul><li><strong>标准化阶段</strong>（Normalization）：先将原始文本（raw text）做一个预处理，例如去掉Unicode字符的重音（<code>é</code> 变成 <code>e</code>），将所有字母全部转化成小写字母（<code>E</code> 变成 <code>e</code>）等。这一步可以理解为数据清洗；</li><li><strong>预分词阶段</strong>（Pre-tokenization）：进行一遍粗略的分词，例如基于空格&amp;标点的分词，即word-level。注意预分词结果的粒度必须大于最终分词结果的粒度；</li><li><strong>模型阶段</strong>（Model）：在预分词的语料上进行训练（注意分词器的训练和模型的训练是两个概念！模型的训练是通过梯度下降来降低loss，具有随机性，而分词器的训练是一个统计过程，最终的结果是确定性的）；</li><li><strong>后处理阶段</strong>（Postprocessor）：添加一些特殊的token，例如BERT中的 <code>[CLS]</code> 和 <code>[SEP]</code>。</li></ul> 
<p>分词的粒度主要有三种：word-level、char-level和subword-level，对于前两种粒度，则不需要经历第三阶段（模型阶段）。</p> 
<p>本文将主要聚焦于第三阶段，但在此之前，先让我们回顾一下word-level和char-level分词。</p> 
<h3><a id="11_wordlevel_36"></a>1.1 word-level分词</h3> 
<p>word-level分词的一个直观出发点是基于空格分词，即对字符串调用 <code>split()</code> 方法</p> 
<pre><code class="prism language-py">text <span class="token operator">=</span> <span class="token string">"Don't you love 🤗 Transformers? We sure do."</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># ["Don't", 'you', 'love', '🤗', 'Transformers?', 'We', 'sure', 'do.']</span>
</code></pre> 
<p>但这个结果不是最优的，因为 <code>Transformers?</code> 和 <code>do.</code> 中都含有标点符号。如果允许标点符号紧跟在单词后面，那么当语料库足够大的时候，<code>Transformers?</code>、<code>Transformers!</code>、<code>Transformers.</code> 等都会纳入到词表当中，这显然不是我们希望看到的。</p> 
<p>我们可以调用 <code>tokenizers</code> 库中的 <code>Whitespace()</code> 来实现基于空格&amp;标点的分词</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> tokenizers<span class="token punctuation">.</span>pre_tokenizers <span class="token keyword">import</span> Whitespace

tokenizer <span class="token operator">=</span> Whitespace<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tokenizer<span class="token punctuation">.</span>pre_tokenize_str<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># [('Don', (0, 3)), ("'", (3, 4)), ('t', (4, 5)), ('you', (6, 9)), ('love', (10, 14)), ('🤗', (15, 16)), ('Transformers', (17, 29)), ('?', (29, 30)), ('We', (31, 33)), ('sure', (34, 38)), ('do', (39, 41)), ('.', (41, 42))]</span>
</code></pre> 
<blockquote> 
 <p>📝 <code>Whitespace()</code> 内部使用的是正则表达式 <code>\w+|[^\w\s]+</code>。</p> 
</blockquote> 
<p>但这个结果仍不是最优的，因为 <code>Don't</code> 的意思是 <code>Do not</code>，所以应当具有 <code>[Do, n't]</code> 的分词结果，而不是 <code>[Don', t]</code>。</p> 
<p>要想达到合理的效果，就要使用基于规则的分词器了，例如 <code>spaCy</code> 或者 <code>Moses</code>。</p> 
<h3><a id="12_charlevel_65"></a>1.2 char-level分词</h3> 
<p>char-level分词非常简单，即把字符串中的每一个字符看作一个token</p> 
<pre><code class="prism language-python">text <span class="token operator">=</span> <span class="token string">"Don't you love 🤗 Transformers? We sure do."</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># ['D', 'o', 'n', "'", 't', ' ', 'y', 'o', 'u', ' ', 'l', 'o', 'v', 'e', ' ', '🤗', ' ', 'T', 'r', 'a', 'n', 's', 'f', 'o', 'r', 'm', 'e', 'r', 's', '?', ' ', 'W', 'e', ' ', 's', 'u', 'r', 'e', ' ', 'd', 'o', '.']</span>
</code></pre> 
<h3><a id="13_subwordlevel_75"></a>1.3 为什么要有subword-level分词？</h3> 
<ul><li>word-level分词很容易造成词表过大，且容易出现OOV问题（Transformer-XL使用word-level分词，词表大小为267735，而基于subword-level的词表大小通常不会超过50000）；</li><li>在word-level意义下，由look衍生出的looks、looking、looked等都会被添加进词表当中，但这些词的区别仅仅在于时态，所以我们更应当保存前缀 <code>look</code> 和时态 <code>s</code>、<code>ing</code>、<code>ed</code>（假设 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          n 
         
        
       
         n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span> 个词每个都有三种时态，那么后者相比前者能够节约 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          3 
         
        
          n 
         
        
          − 
         
        
          ( 
         
        
          n 
         
        
          + 
         
        
          3 
         
        
          ) 
         
        
          = 
         
        
          2 
         
        
          n 
         
        
          − 
         
        
          3 
         
        
       
         3n-(n+3)=2n-3 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">3</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">3</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">2</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">3</span></span></span></span></span> 个token的空间）；</li><li>基于word-level的模型学到的old、older、oldest之间的关系无法泛化到smart、smarter、smartest之间；</li><li>char-level能够很好地解决OOV问题，但一个char能够表示的语义远没有一个word能够表示的语义丰富；</li><li>按照char-level分词很容易导致sequence length过长。</li></ul> 
<p>subword-level分词粒度介于两者之间，能够较好地平衡OOV问题。</p> 
<h2><a id="2__87"></a>2. 子词分词</h2> 
<p>子词分词（Subword Tokenization）主要有以下三种：</p> 
<ul><li><strong>Byte-Pair Encoding</strong>：GPT、GPT-2、RoBERTa、DeBERTa、BART等；</li><li><strong>WordPiece</strong>：BERT、DistilBERT、MobileBERT等；</li><li><strong>Unigram</strong>：T5、XLNet、ALBERT、mBART等。</li></ul> 
<h3><a id="21_BPE_96"></a>2.1 BPE</h3> 
<h4><a id="211__98"></a>2.1.1 学习流程</h4> 
<p>BPE既然属于subword-level分词，那自然就要经历预分词阶段，即需要先对原始文本进行一遍word-level分词。</p> 
<p>为叙述简便起见，假设在经历了标准化、预分词阶段后我们的语料库只含以下 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         5 
        
       
      
        5 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">5</span></span></span></span></span> 种单词（每个单词右侧的数字代表这个单词出现的频数）</p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span><span class="token string">"hug"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"pug"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"pun"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"bun"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"hugs"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>BPE首先建立一个基础词表（base vocabulary），它由构成上述所有单词的<strong>字符</strong>组成，即</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">]</span>
</code></pre> 
<p>接下来，BPE将不断学习merge rule以从基础词表中选取两个元素并合并成一个新的元素然后添加到词表中（原先的两个元素不会删除），<strong>直到词表达到预先指定的大小为止</strong>。</p> 
<blockquote> 
 <p>📝 每一条merge rule都对应了一个要添加到词表中的新元素，merge rules通常又简称为merges，所以最终词表大小=基础词表大小+merges的数量。基础词表的大小通常是确定的，所以唯一的超参数就是merges的数量。例如：</p> 
 <ul><li>GPT-1：base vocab size：478，merges：40k，total vocab size：40478</li><li>GPT-2：base vocab size：256，merges：50k，special tokens：1，total vocab size：50257</li></ul> 
</blockquote> 
<p>基础词表是char-level的，说明<strong>BPE也是从char-level开始学习merges</strong>，即一开始合并的都是char，随着学习的进行，合并的就是subword了。所以，我们需要将之前的每个单词都划分成字符</p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"u"</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"u"</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span> <span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"u"</span> <span class="token string">"g"</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>现统计每个<strong>单词内</strong>的所有pair，并找到出现<strong>频数最高</strong>的那一个pair（这里的pair指的是相邻元素组成的对，例如 <code>[a, bc, d, e]</code> 含有 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         3 
        
       
      
        3 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">3</span></span></span></span></span> 个pair：<code>[(a, bc), (bc, d), (d, e)]</code>），然后<strong>合并</strong>这个pair。</p> 
<p>在上面的例子中，很明显 <code>(u, g)</code> 这个pair出现的频数最高，它一共出现了 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         20 
        
       
      
        20 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">20</span></span></span></span></span> 次，所以我们学到的第一条merge rule就是 <code>(u, g) -&gt; ug</code>，我们将 <code>ug</code> 添加到词表当中，然后将语料库中的所有 <code>(u, g)</code> 合并成 <code>ug</code></p> 
<pre><code class="prism language-python">Vocabulary<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"ug"</span><span class="token punctuation">]</span>
Merges<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token string">"g"</span><span class="token punctuation">)</span>
Corpus<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span> <span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"ug"</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>继续重复上述步骤，我们可以发现 <code>(u, n)</code> 这个pair出现的频率最高，高达 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         16 
        
       
      
        16 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">16</span></span></span></span></span> 次，所以BPE学到的第二条merge rule是 <code>(u, n) -&gt; un</code>，此时有</p> 
<pre><code class="prism language-python">Vocabulary<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token string">"un"</span><span class="token punctuation">]</span>
Merges<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">)</span>
Corpus<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"ug"</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>继续重复上述步骤，我们可以发现 <code>(h, ug)</code> 这个pair出现的频率最高，共出现 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         15 
        
       
      
        15 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">15</span></span></span></span></span> 次，所以BPE学到的第三条merge rule是 <code>(h, ug) -&gt; hug</code>，此时有</p> 
<pre><code class="prism language-python">Vocabulary<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token string">"hug"</span><span class="token punctuation">]</span>
Merges<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token string">"g"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"u"</span> <span class="token string">"n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"h"</span> <span class="token string">"ug"</span><span class="token punctuation">)</span>
Corpus<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"hug"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"p"</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"b"</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"hug"</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>假设我们预先希望学得 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         3 
        
       
      
        3 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">3</span></span></span></span></span> 个merges，那么BPE的流程就到此结束了。</p> 
<h4><a id="212__150"></a>2.1.2 分词流程</h4> 
<p>我们已经知道BPE是怎样学习的了，那么给定一段文本，我们如何使用BPE对它进行分词呢？</p> 
<p>假设文本是 <code>str</code> 型，自然地，我们需要先对它应用前两个流程：标准化和预分词，此时文本变成了 <code>List[str]</code> 型，其中的每一个元素都是一个word。之后，对于每一个word，我们先将它全部拆为字符，然后<strong>从前往后</strong>扫描之前学得的merges，能够应用一条就应用一条。当所有word都过完后，我们就得到了最终的分词结果。</p> 
<p>这里仅以单个word为例。假设有一个word是 <code>bug</code>，我们共有三个merges</p> 
<pre><code class="prism language-python"><span class="token punctuation">(</span><span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"ug"</span>
<span class="token punctuation">(</span><span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"un"</span>
<span class="token punctuation">(</span><span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"ug"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"hug"</span>
</code></pre> 
<p>首先将 <code>bug</code> 拆为字符：<code>[b, u, g]</code>，然后从前往后扫描merges，发现第一条可以应用，应用之后得到 <code>[b, ug]</code>，而第二、三条都不能应用，于是对于该word的分词结束。</p> 
<p>对于 <code>mug</code> 而言，同样是先拆成字符 <code>[m, u, g]</code>，注意到由于 <code>m</code> 不在词表当中，所以实际拆完后是 <code>[[UNK], u, g]</code>，合并完后是 <code>[[UNK], ug]</code>。</p> 
<p>同理可得，对于 <code>thug</code> 而言，其分词结果是 <code>[[UNK], hug]</code>。对于 <code>unhug</code>，其分词结果是 <code>[un, hug]</code>。</p> 
<blockquote> 
 <p>📝 可以看出，只要单词中有一个字符没有在基础词表中出现，那么关于该单词的分词结果就会出现 <code>[UNK]</code>。所以，如果要想保证对于一段文本的分词不会出现 <code>[UNK]</code>，那么就需要保证该文本的预分词结果中的每一个字符都被包含在基础词表当中。</p> 
</blockquote> 
<h4><a id="213_BPE_171"></a>2.1.3 从零实现BPE</h4> 
<p>由于标准化和预分词这两个阶段并不在我们的考虑范围内，所以假设现在已经得到了预分词的结果 <code>pre_tokenized_res</code>，其类型是 <code>List[str]</code>，其中的每一个元素都可以视为一个word。</p> 
<p>根据2.1.1中的内容，我们首先需要统计出每个word出现的频数，然后对每个word进行char-level的划分以方便后续进行merge</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_word_freqs</span><span class="token punctuation">(</span>pre_tokenized_res<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    word_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> pre_tokenized_res<span class="token punctuation">:</span>
        word_freqs<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">return</span> word_freqs


<span class="token keyword">def</span> <span class="token function">get_word_splits</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    word_splits <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> word_freqs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span>
    <span class="token keyword">return</span> word_splits
</code></pre> 
<p>我们还需要基础词表以及计算每个pair出现的频数</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_base_vocab</span><span class="token punctuation">(</span>word_splits<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    vocab <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> split <span class="token keyword">in</span> word_splits<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        vocab<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>split<span class="token punctuation">)</span>
    vocab <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>vocab<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> vocab


<span class="token keyword">def</span> <span class="token function">get_pair_freqs</span><span class="token punctuation">(</span>
    word_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    word_splits<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    pair_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> freq<span class="token punctuation">,</span> split <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> word_splits<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            pair_freqs<span class="token punctuation">[</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
    <span class="token keyword">return</span> pair_freqs
</code></pre> 
<p>假设我们已经从 <code>pair_freqs</code> 找到了出现频数最多的那个 <code>pair</code>，除了将这个 <code>pair</code> 添加到 <code>merges</code> 之外，还需要对 <code>word_splits</code> 中的每一个这样的 <code>pair</code> 进行合并，同时再计算一次 <code>pair_freqs</code>。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">merge_pair</span><span class="token punctuation">(</span>pair<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> word_splits<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        split <span class="token operator">=</span> word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> split<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> pair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">and</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> pair<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                split <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>pair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> pair<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>
        word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> split
    <span class="token keyword">return</span> word_splits
</code></pre> 
<blockquote> 
 <p>⚠️ 至于为什么用 <code>while</code> 而不用 <code>for</code> 请参考 <a href="https://blog.csdn.net/raelum/article/details/132265007">Python中关于可变循环的一些坑</a>。</p> 
</blockquote> 
<p>万事俱备，现在可以定义BPE的训练函数了</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">bpe_train</span><span class="token punctuation">(</span>num_merges<span class="token punctuation">,</span> word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    merges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    vocab <span class="token operator">=</span> get_base_vocab<span class="token punctuation">(</span>word_splits<span class="token punctuation">)</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_merges<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pair_freqs <span class="token operator">=</span> get_pair_freqs<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> pair_freqs<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        max_freq_pair <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>pair_freqs<span class="token punctuation">,</span> key<span class="token operator">=</span>pair_freqs<span class="token punctuation">.</span>get<span class="token punctuation">)</span>
        word_splits <span class="token operator">=</span> merge_pair<span class="token punctuation">(</span>max_freq_pair<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
        merges<span class="token punctuation">.</span>append<span class="token punctuation">(</span>max_freq_pair<span class="token punctuation">)</span>
        vocab<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>max_freq_pair<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> vocab<span class="token punctuation">,</span> merges
</code></pre> 
<p>我们可以拿WikiText-2的验证集来看一下BPE算法到底学到了什么，设置merges的数量为50，输出结果如下</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> datasets <span class="token keyword">import</span> load_dataset
<span class="token keyword">from</span> tokenizers<span class="token punctuation">.</span>pre_tokenizers <span class="token keyword">import</span> Whitespace

pre_tokenizer <span class="token operator">=</span> Whitespace<span class="token punctuation">(</span><span class="token punctuation">)</span>

corpus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
data <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"wikitext"</span><span class="token punctuation">,</span> <span class="token string">"wikitext-2-v1"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"validation"</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> line <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    tokenized_line <span class="token operator">=</span> pre_tokenizer<span class="token punctuation">.</span>pre_tokenize_str<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    corpus<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tokenized_line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

word_freqs <span class="token operator">=</span> get_word_freqs<span class="token punctuation">(</span>corpus<span class="token punctuation">)</span>
word_splits <span class="token operator">=</span> get_word_splits<span class="token punctuation">(</span>word_freqs<span class="token punctuation">)</span>
vocab<span class="token punctuation">,</span> merges <span class="token operator">=</span> bpe_train<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab<span class="token punctuation">)</span>
<span class="token comment"># ['!', '"', '$', '%', '&amp;', "'", '(', ')', '*', '+', ',', '-', '.', '/', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', ':', ';', '&lt;', '=', '&gt;', '?', '@', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '[', ']', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', '~', '£', '°', '²', '½', 'É', 'Î', 'Ú', 'á', 'ç', 'é', 'ë', 'í', 'ü', 'ā', 'ō', 'š', 'α', 'β', 'γ', 'μ', '‑', '–', '—', '‘', '’', '“', '”', '′', '″', '⁄', '₤', '−', '♭', '♯', 'th', 'in', 'the', 'un', 'an', 'er', 'unk', 'on', 'ed', 'at', 're', 'en', 'or', 'st', 'and', 'of', 'al', 'ar', 'as', 'to', 'ing', 'es', 'it', 'is', 'ro', 'ic', 'he', 'ion', 'ou', 'il', 'le', 'ent', 'ac', 'ad', 'se', 'was', 'ur', 'for', 'The', 'be', 'ly', 'om', 'am', 'id', 'ig', 've', 'ch', 'lo', '@-', '@-@']</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>merges<span class="token punctuation">)</span>
<span class="token comment"># [('t', 'h'), ('i', 'n'), ('th', 'e'), ('u', 'n'), ('a', 'n'), ('e', 'r'), ('un', 'k'), ('o', 'n'), ('e', 'd'), ('a', 't'), ('r', 'e'), ('e', 'n'), ('o', 'r'), ('s', 't'), ('an', 'd'), ('o', 'f'), ('a', 'l'), ('a', 'r'), ('a', 's'), ('t', 'o'), ('in', 'g'), ('e', 's'), ('i', 't'), ('i', 's'), ('r', 'o'), ('i', 'c'), ('h', 'e'), ('i', 'on'), ('o', 'u'), ('i', 'l'), ('l', 'e'), ('en', 't'), ('a', 'c'), ('a', 'd'), ('s', 'e'), ('w', 'as'), ('u', 'r'), ('f', 'or'), ('T', 'he'), ('b', 'e'), ('l', 'y'), ('o', 'm'), ('a', 'm'), ('i', 'd'), ('i', 'g'), ('v', 'e'), ('c', 'h'), ('l', 'o'), ('@', '-'), ('@-', '@')]</span>
</code></pre> 
<p>假设BPE已经训练完毕，给定一段文本，我们如何使用merges对它进行分词呢？</p> 
<p>依然只考虑预分词后的文本，即 <code>pre_tokenized_text</code>，其中的每个元素都是一个 <code>word</code>，我们需要先对 <code>word</code> 划分成char-level，然后从前往后遍历merges并应用到 <code>word</code> 上。</p> 
<p>先只考虑仅对一个 <code>word</code> 分词</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">tokenize_word</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> vocab<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> merges<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    get_pairs <span class="token operator">=</span> <span class="token keyword">lambda</span> word<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> word<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    bpe_ranks <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>merges<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>merges<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 给每一条merge rule编号，方便之后从前往后查找</span>

    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> word

    word <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'[UNK]'</span> <span class="token keyword">if</span> char <span class="token keyword">not</span> <span class="token keyword">in</span> vocab <span class="token keyword">else</span> char <span class="token keyword">for</span> char <span class="token keyword">in</span> word<span class="token punctuation">]</span>
    pairs <span class="token operator">=</span> get_pairs<span class="token punctuation">(</span>word<span class="token punctuation">)</span>

    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        bigram <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>pairs<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> pair<span class="token punctuation">:</span> bpe_ranks<span class="token punctuation">.</span>get<span class="token punctuation">(</span>pair<span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 因为要从前往后去应用，所以要找到下标最小的那个pair</span>
        <span class="token keyword">if</span> bigram <span class="token keyword">not</span> <span class="token keyword">in</span> bpe_ranks<span class="token punctuation">:</span>
            <span class="token keyword">break</span>

        i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> word<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> bigram<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">and</span> word<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> bigram<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                word <span class="token operator">=</span> word<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>bigram<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> bigram<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> word<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            pairs <span class="token operator">=</span> get_pairs<span class="token punctuation">(</span>word<span class="token punctuation">)</span>

    <span class="token keyword">return</span> word
</code></pre> 
<p>效果</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> functools <span class="token keyword">import</span> partial

vocab <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"g"</span><span class="token punctuation">,</span> <span class="token string">"h"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"s"</span><span class="token punctuation">,</span> <span class="token string">"u"</span><span class="token punctuation">,</span> <span class="token string">"ug"</span><span class="token punctuation">,</span> <span class="token string">"un"</span><span class="token punctuation">,</span> <span class="token string">"hug"</span><span class="token punctuation">]</span>
merges <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'u'</span><span class="token punctuation">,</span> <span class="token string">'n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'h'</span><span class="token punctuation">,</span> <span class="token string">'ug'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
tokenize_word <span class="token operator">=</span> partial<span class="token punctuation">(</span>tokenize_word<span class="token punctuation">,</span> vocab<span class="token operator">=</span>vocab<span class="token punctuation">,</span> merges<span class="token operator">=</span>merges<span class="token punctuation">)</span>

words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"hug"</span><span class="token punctuation">,</span> <span class="token string">"bug"</span><span class="token punctuation">,</span> <span class="token string">"mug"</span><span class="token punctuation">,</span> <span class="token string">"unhug"</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> word <span class="token keyword">in</span> words<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>word<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tokenize_word<span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token comment"># hug: ['hug']</span>
<span class="token comment"># bug: ['b', 'ug']</span>
<span class="token comment"># mug: ['[UNK]', 'ug']</span>
<span class="token comment"># unhug: ['un', 'hug']</span>
</code></pre> 
<p>接下来我们就可以对一段文本进行分词了</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">tokenize</span><span class="token punctuation">(</span>pre_tokenized_text<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> vocab<span class="token punctuation">,</span> merges<span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> pre_tokenized_text<span class="token punctuation">:</span>
        res<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>tokenize_word<span class="token punctuation">(</span>word<span class="token punctuation">,</span> vocab<span class="token punctuation">,</span> merges<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> res
</code></pre> 
<blockquote> 
 <p>⚠️ 注意，截止目前，我们的实现主要是为了清晰地展示流程，并不是最高效的实现方式，下文相同。</p> 
</blockquote> 
<h4><a id="214__342"></a>2.1.4 解码流程</h4> 
<p>BPE的分词流程实际上就是编码流程（将单词拆分为子词），那么解码流程就是将子词组合成单词。什么场景下才会有这一需要呢？</p> 
<p>我们知道，模型接收的输入就是子词序列（通常由子词的ID来表示），输出自然也是子词序列，但子词序列的可读性不强，我们需要将其转化成单词序列才方便人类阅读。</p> 
<p>给定子词序列</p> 
<pre><code>[a, b, c, d, e, f]
</code></pre> 
<p>这里每个字母都代表一个子词，显然 <code>a</code> 肯定是第一个单词的开头，那么怎么确定第一个单词的结尾呢？如果无法确定哪个子词是第一个单词的结尾，自然就无法确定哪个子词是第二个单词的开头。</p> 
<p>一个直观的做法是，在BPE训练之前在每个单词的末尾添加一个标记，例如 <code>#</code>。这样一来，当BPE训练结束后，如果一个子词的末尾含有 <code>#</code>，说明这个子词必定是某一个单词的结尾。</p> 
<p>按照这种方式，最终会得到如下形式的子词序列</p> 
<pre><code>[a, b#, c, d, e#, f#]
</code></pre> 
<p>很容易将其恢复成单词序列</p> 
<pre><code>[ab, cde, f]
</code></pre> 
<p>在BPE的<a href="https://arxiv.org/abs/1508.07909" rel="nofollow">原论文</a>当中，这个标记就是 <code>&lt;/w&gt;</code>，注意到我们在2.1.3中的实现并没有考虑标记，感兴趣的读者可自行实现。</p> 
<h3><a id="22_WordPiece_389"></a>2.2 WordPiece</h3> 
<h4><a id="221__391"></a>2.2.1 学习流程</h4> 
<p>WordPiece和BPE的流程<strong>几乎一致</strong>，主要的区别在于，BPE每次按照<strong>出现频数最高</strong>这一原则来选取pair，而WordPiece则是按照<strong>能够最大限度提升语言模型概率</strong>这一原则来选取pair。</p> 
<p>具体来讲，假设句子 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         S 
        
       
      
        S 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span></span></span></span></span> 由 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
      
        n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span> 个子词组成 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          t 
         
        
          1 
         
        
       
         , 
        
        
        
          t 
         
        
          2 
         
        
       
         , 
        
       
         ⋯ 
         
       
         , 
        
        
        
          t 
         
        
          n 
         
        
       
      
        t_1,t_2,\cdots,t_n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8095em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，且各个子词之间是相互独立的，则</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          log 
         
        
          ⁡ 
         
        
          P 
         
        
          ( 
         
        
          S 
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           n 
          
         
        
          log 
         
        
          ⁡ 
         
        
          P 
         
        
          ( 
         
         
         
           t 
          
         
           i 
          
         
        
          ) 
         
        
       
         \log P(S)=\sum_{i=1}^n \log P(t_i) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.9291em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>如果选取 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          t 
         
        
          i 
         
        
       
         , 
        
        
        
          t 
         
        
          j 
         
        
       
      
        t_i,t_j 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9012em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 进行合并，并记合并后的子词为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          t 
         
        
          k 
         
        
       
      
        t_k 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7651em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，那么 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         log 
        
       
         ⁡ 
        
       
         P 
        
       
         ( 
        
       
         S 
        
       
         ) 
        
       
      
        \log P(S) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="mclose">)</span></span></span></span></span> 的变化值为</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          log 
         
        
          ⁡ 
         
        
          P 
         
        
          ( 
         
         
         
           t 
          
         
           k 
          
         
        
          ) 
         
        
          − 
         
        
          ( 
         
        
          log 
         
        
          ⁡ 
         
        
          P 
         
        
          ( 
         
         
         
           t 
          
         
           i 
          
         
        
          ) 
         
        
          + 
         
        
          log 
         
        
          ⁡ 
         
        
          P 
         
        
          ( 
         
         
         
           t 
          
         
           j 
          
         
        
          ) 
         
        
          ) 
         
        
          = 
         
        
          log 
         
        
          ⁡ 
         
         
          
          
            P 
           
          
            ( 
           
           
           
             t 
            
           
             k 
            
           
          
            ) 
           
          
          
          
            P 
           
          
            ( 
           
           
           
             t 
            
           
             i 
            
           
          
            ) 
           
          
            P 
           
          
            ( 
           
           
           
             t 
            
           
             j 
            
           
          
            ) 
           
          
         
        
       
         \log P(t_k)-(\log P(t_i)+\log P(t_j))=\log\frac{P(t_k)}{P(t_i)P(t_j)} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">))</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.3991em; vertical-align: -0.9721em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9721em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<p>可以看出，变化值就是两个子词之间的<strong>互信息</strong>，我们通常用 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         , 
        
        
        
          t 
         
        
          j 
         
        
       
         ) 
        
       
         / 
        
       
         ( 
        
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         ) 
        
       
         ⋅ 
        
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          j 
         
        
       
         ) 
        
       
         ) 
        
       
      
        n(t_i,t_j)/(n(t_i)\cdot n(t_j)) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span> 来估计 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         P 
        
       
         ( 
        
        
        
          t 
         
        
          k 
         
        
       
         ) 
        
       
         / 
        
       
         ( 
        
       
         P 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         ) 
        
       
         P 
        
       
         ( 
        
        
        
          t 
         
        
          j 
         
        
       
         ) 
        
       
         ) 
        
       
      
        P(t_k)/(P(t_i)P(t_j)) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0315em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">/</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span>。</p> 
<p>除此之外，WordPiece还有一点与BPE不同，那就是一开始在对单词进行char-level划分的时候，会在每个<strong>非单词开头</strong>的字符前加上 <code>##</code> 前缀，这个前缀是用于解码过程中的子词合并。在合并两个子词时，后一个子词的前缀需要去掉，例如，<code>(##h, ##ug) -&gt; ##hug</code>、<code>(b, ##ug) -&gt; bug</code>。</p> 
<h4><a id="222__412"></a>2.2.2 分词流程</h4> 
<p>BPE训练结束后会保存 <code>vocab</code> 和 <code>merges</code>，而WordPiece<strong>只保存</strong> <code>vocab</code>，那WordPiece是如何对一段文本进行分词的呢？</p> 
<p>回顾BPE，它首先将一个单词拆成字符，然后从前往后遍历 <code>merges</code> 直到不能再应用为止。WordPiece并不会将单词拆分成字符，而是首先寻找出现在 <code>vocab</code> 中的<strong>最长前缀</strong>，然后将单词一分为二，用数学公式描述就是</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          j 
         
        
          = 
         
         
          
          
            arg max 
           
          
            ⁡ 
           
          
         
           i 
          
         
        
          ( 
         
        
          word 
         
        
          [ 
         
        
          : 
         
        
          i 
         
        
          ] 
             
         
         
           in 
            
         
            vocab 
          
         
        
          ) 
         
        
       
         j=\argmax_i (\text{word}[:i] \;\;\text{in\; vocab} ) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.854em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.6721em; vertical-align: -0.9221em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.4306em;"><span class="" style="top: -2.1779em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop"><span class="mord mathrm" style="margin-right: 0.0139em;">arg</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathrm">max</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.9221em;"><span class=""></span></span></span></span></span><span class="mopen">(</span><span class="mord text"><span class="mord">word</span></span><span class="mopen">[</span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord text"><span class="mord">in</span><span class="mspace" style="margin-right: 0.2777em;"></span><span class="mord"> vocab</span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>然后将 <code>word</code> 拆分成 <code>word[:j]</code> 和 <code>##word[j:]</code>，前者添加到最终结果中，后者继续应用上述操作。</p> 
<p>BPE仅仅会把那些没有出现在词表中的<strong>字符</strong>标成 <code>[UNK]</code>，而在WordPiece的分词过程中，<strong>只要有一次</strong>在词表中找不到最长前缀，那么<strong>整个单词</strong>就会被标记为 <code>[UNK]</code>。</p> 
<h4><a id="223_WordPiece_427"></a>2.2.3 从零实现WordPiece</h4> 
<p>由于WordPiece和BPE大体相似，所以我们只需要改写一部分函数即可。</p> 
<p>首先是 <code>get_word_splits</code> 函数，我们需要给每个非单词开头的字符加上 <code>##</code> 前缀</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_word_splits</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    word_splits <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> word <span class="token keyword">in</span> word_freqs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>c <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token string-interpolation"><span class="token string">f"##</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>c<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> word_splits
</code></pre> 
<p>BPE只需要计算 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         , 
        
        
        
          t 
         
        
          j 
         
        
       
         ) 
        
       
      
        n(t_i,t_j) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，而WordPiece除了 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         , 
        
        
        
          t 
         
        
          j 
         
        
       
         ) 
        
       
      
        n(t_i,t_j) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 还需要计算 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
         ( 
        
        
        
          t 
         
        
          i 
         
        
       
         ) 
        
       
      
        n(t_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。我们将 <code>get_pair_freqs</code> 改写成 <code>get_pair_scores</code></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_pair_scores</span><span class="token punctuation">(</span>
    word_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    word_splits<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    pair_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    subword_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> freq<span class="token punctuation">,</span> split <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> word_splits<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            subword_freqs<span class="token punctuation">[</span>split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
            <span class="token keyword">continue</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            pair_freqs<span class="token punctuation">[</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
            subword_freqs<span class="token punctuation">[</span>split<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
        subword_freqs<span class="token punctuation">[</span>split<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq

    pair_scores <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        pair<span class="token punctuation">:</span> freq <span class="token operator">/</span> <span class="token punctuation">(</span>subword_freqs<span class="token punctuation">[</span>pair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> subword_freqs<span class="token punctuation">[</span>pair<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> \
        <span class="token keyword">for</span> pair<span class="token punctuation">,</span> freq <span class="token keyword">in</span> pair_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pair_scores
</code></pre> 
<p>然后是 <code>merge_pair</code> 函数，唯一需要注意的细节就是，当第二个子词含有 <code>##</code> 前缀时，需要将其去掉</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">merge_pair</span><span class="token punctuation">(</span>pair<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    a<span class="token punctuation">,</span> b <span class="token operator">=</span> pair
    <span class="token keyword">for</span> word <span class="token keyword">in</span> word_splits<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        split <span class="token operator">=</span> word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>split<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> split<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> a <span class="token keyword">and</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> b<span class="token punctuation">:</span>
                new_word <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> b<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'##'</span><span class="token punctuation">)</span> <span class="token keyword">else</span> a <span class="token operator">+</span> b
                split <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>new_word<span class="token punctuation">]</span> <span class="token operator">+</span> split<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>
        word_splits<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> split
    <span class="token keyword">return</span> word_splits
</code></pre> 
<p>最后就是WordPiece的训练函数了。注意由于不需要保存 <code>merges</code>，因此训练停止的条件就是词表大小达到预先设定的值</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">wordpiece_train</span><span class="token punctuation">(</span>vocab_size<span class="token punctuation">,</span> word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span><span class="token punctuation">:</span>
    vocab <span class="token operator">=</span> get_base_vocab<span class="token punctuation">(</span>word_splits<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>vocab<span class="token punctuation">)</span> <span class="token operator">&lt;</span> vocab_size<span class="token punctuation">:</span>
        pair_scores <span class="token operator">=</span> get_pair_scores<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> pair_scores<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        max_score_pair <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>pair_scores<span class="token punctuation">,</span> key<span class="token operator">=</span>pair_scores<span class="token punctuation">.</span>get<span class="token punctuation">)</span>
        word_splits <span class="token operator">=</span> merge_pair<span class="token punctuation">(</span>max_score_pair<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
        a<span class="token punctuation">,</span> b <span class="token operator">=</span> max_score_pair
        new_word <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> b<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'##'</span><span class="token punctuation">)</span> <span class="token keyword">else</span> a <span class="token operator">+</span> b
        vocab<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_word<span class="token punctuation">)</span>
    <span class="token keyword">return</span> vocab
</code></pre> 
<p>依旧拿WikiText-2的验证集来看一下WordPiece算法都学到了什么，设置最终词表大小为300，输出结果如下</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> datasets <span class="token keyword">import</span> load_dataset
<span class="token keyword">from</span> tokenizers<span class="token punctuation">.</span>pre_tokenizers <span class="token keyword">import</span> Whitespace

pre_tokenizer <span class="token operator">=</span> Whitespace<span class="token punctuation">(</span><span class="token punctuation">)</span>

corpus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
data <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"wikitext"</span><span class="token punctuation">,</span> <span class="token string">"wikitext-2-v1"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"validation"</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> line <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    tokenized_line <span class="token operator">=</span> pre_tokenizer<span class="token punctuation">.</span>pre_tokenize_str<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    corpus<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tokenized_line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

word_freqs <span class="token operator">=</span> get_word_freqs<span class="token punctuation">(</span>corpus<span class="token punctuation">)</span>
word_splits <span class="token operator">=</span> get_word_splits<span class="token punctuation">(</span>word_freqs<span class="token punctuation">)</span>
vocab <span class="token operator">=</span> wordpiece_train<span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> word_freqs<span class="token punctuation">,</span> word_splits<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># ['!', '"', '##,', '##-', '##.', '##0', '##1', '##2', '##3', '##4', '##5', '##6', '##7', '##8', '##9', '##@', '##A', '##B', '##C', '##D']</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># ['XIV', 'UP', '##PI', 'UK', 'NFL', 'NHC', 'NCAA', 'NHS', 'NME', 'WWE', 'FBI', 'FIBA', 'FIFA', 'DVD', 'kW', 'HIV', 'HMCS', 'HBO', 'NBA', 'GBA']</span>
</code></pre> 
<p>相比BPE，WordPiece的分词实现较为简单，我们只需要改写 <code>tokenize_word</code> 函数即可</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">tokenize_word</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> vocab<span class="token punctuation">)</span><span class="token punctuation">:</span>
    new_word <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        i <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span>
        <span class="token keyword">while</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> word<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> vocab<span class="token punctuation">:</span>
            i <span class="token operator">-=</span> <span class="token number">1</span>
        <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'[UNK]'</span><span class="token punctuation">]</span>
        new_word<span class="token punctuation">.</span>append<span class="token punctuation">(</span>word<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        word <span class="token operator">=</span> word<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            word <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"##</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>word<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    <span class="token keyword">return</span> new_word
</code></pre> 
<p>继续使用WikiText-2的验证集并设置最终词表大小为3000，尝试对不同单词进行分词，效果如下</p> 
<pre><code class="prism language-python">words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'occupied'</span><span class="token punctuation">,</span> <span class="token string">'upload'</span><span class="token punctuation">,</span> <span class="token string">'company'</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> word <span class="token keyword">in</span> words<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>tokenize_word<span class="token punctuation">(</span>word<span class="token punctuation">,</span> vocab<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># ['app', '##l', '##e']</span>
<span class="token comment"># ['occupi', '##e', '##d']</span>
<span class="token comment"># ['up', '##l', '##o', '##a', '##d']</span>
<span class="token comment"># ['comp', '##a', '##n', '##y']</span>
</code></pre> 
<h4><a id="224__562"></a>2.2.4 解码流程</h4> 
<p>我们可以根据 <code>##</code> 来解码，以下提供了一种可能的实现方案</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    res<span class="token punctuation">,</span> cur <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">""</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'##'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cur<span class="token punctuation">)</span>
            cur <span class="token operator">=</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            cur <span class="token operator">+=</span> output<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cur<span class="token punctuation">)</span>

    <span class="token keyword">return</span> res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
</code></pre> 
<p>效果</p> 
<pre><code class="prism language-python">output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Th'</span><span class="token punctuation">,</span> <span class="token string">'##i'</span><span class="token punctuation">,</span> <span class="token string">'##s'</span><span class="token punctuation">,</span> <span class="token string">'is'</span><span class="token punctuation">,</span> <span class="token string">'th'</span><span class="token punctuation">,</span> <span class="token string">'##e'</span><span class="token punctuation">,</span> <span class="token string">'Hugg'</span><span class="token punctuation">,</span> <span class="token string">'##i'</span><span class="token punctuation">,</span> <span class="token string">'##n'</span><span class="token punctuation">,</span> <span class="token string">'##g'</span><span class="token punctuation">,</span> <span class="token string">'Fac'</span><span class="token punctuation">,</span> <span class="token string">'##e'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'##o'</span><span class="token punctuation">,</span> <span class="token string">'##u'</span><span class="token punctuation">,</span> <span class="token string">'##r'</span><span class="token punctuation">,</span> <span class="token string">'##s'</span><span class="token punctuation">,</span> <span class="token string">'##e'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>decode<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># ['This', 'is', 'the', 'Hugging', 'Face', 'course']</span>
</code></pre> 
<h3><a id="23_Unigram_590"></a>2.3 Unigram</h3> 
<h4><a id="231__593"></a>2.3.1 学习流程</h4> 
<p>BPE和WordPiece都是从一个小的基础词表开始不断去扩充这个词表，而Unigram则<strong>与之相反</strong>，Unigram会先初始化一个大的词表，然后不断从中删去子词直至词表达到指定的大小。</p> 
<p>Unigram初始化词表的方式有很多种，例如我们可以在预分词的结果上应用BPE算法并设置较大的merges以获得初始词表，或者计算预分词结果的所有<strong>严格子串</strong>并从中选取一些出现频率最高的子串作为初始词表。</p> 
<p>这里以后者为例（注意初始词表还需要包含所有的基础字符以防止OOV）：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">init_vocab</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">,</span> init_vocab_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    char_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    subword_freqs <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> word<span class="token punctuation">,</span> freq <span class="token keyword">in</span> word_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            char_freqs<span class="token punctuation">[</span>word<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
            <span class="token comment"># 子词的长度至少是2，并且word[i:j]是左闭右开，因此j最多要取到len(word)</span>
            <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 必须是严格子词，即不能包含自身</span>
                <span class="token keyword">if</span> j <span class="token operator">-</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    subword_freqs<span class="token punctuation">[</span>word<span class="token punctuation">[</span>i<span class="token punctuation">:</span>j<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> freq
    char_freqs <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>char_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    subword_freqs <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>subword_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> init_vocab_size <span class="token operator">&gt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>char_freqs<span class="token punctuation">)</span>
    vocab_with_freqs <span class="token operator">=</span> char_freqs <span class="token operator">+</span> subword_freqs<span class="token punctuation">[</span><span class="token punctuation">:</span>init_vocab_size <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>char_freqs<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>vocab_with_freqs<span class="token punctuation">)</span>
</code></pre> 
<p>在得到了初始词表后，我们如何对它进行剪枝呢？这里有必要先了解一下Unigram的分词流程，读者可先跳转至2.3.2节。</p> 
<p>现在假定你已经阅读完了2.3.2节。Unigram首先会计算整个语料库（预分词结果）上的loss，具体而言，设语料库中的所有单词为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          1 
         
        
       
         , 
        
       
         ⋯ 
         
       
         , 
        
        
        
          w 
         
        
          N 
         
        
       
      
        w_1,\cdots,w_N 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>（可能会有重复），那么整个语料库的loss可以表示成</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
        
          c 
         
        
          o 
         
        
          r 
         
        
          p 
         
        
          u 
         
        
          s 
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           N 
          
         
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           K 
          
         
         
         
           f 
          
         
           i 
          
         
        
          ⋅ 
         
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           ′ 
          
         
        
          ) 
         
        
          , 
         
         
        
          word_freqs 
         
        
          [ 
         
         
         
           w 
          
         
           i 
          
         
           ′ 
          
         
        
          ] 
         
        
          = 
         
         
         
           f 
          
         
           i 
          
         
        
          , 
         
         
        
          { 
         
         
         
           w 
          
         
           i 
          
         
           ′ 
          
         
         
         
           } 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           K 
          
         
        
          ⊂ 
         
        
          { 
         
         
         
           w 
          
         
           i 
          
         
         
         
           } 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           N 
          
         
        
          , 
         
         
         
         
           ∑ 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           K 
          
         
         
         
           f 
          
         
           i 
          
         
        
          = 
         
        
          N 
         
        
       
         loss(corpus)=\sum_{i=1}^Nloss(w_i)=\sum_{i=1}^Kf_i\cdot loss(w'_i),\quad \text{word\_freqs}[w'_i]=f_i,\quad \{w'_i\}_{i=1}^K \subset \{w_i\}_{i=1}^N,\quad \sum_{i=1}^Kf_i=N 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0278em;">cor</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.106em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8283em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.106em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8283em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1119em; vertical-align: -0.31em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -2.453em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 1em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord text"><span class="mord">word_freqs</span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -2.453em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.1413em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 1em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mopen">{<!-- --></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -2.453em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⊂</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.106em; vertical-align: -1.2777em;"></span><span class="mopen">{<!-- --></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose"><span class="mclose">}</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8913em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 1em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8283em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.1076em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">N</span></span></span></span></span></span></p> 
<p>而 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
          ′ 
         
        
       
         ) 
        
       
      
        loss(w'_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 就是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          i 
         
        
          ′ 
         
        
       
      
        w'_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 经过Unigram分词后对应的loss，即</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
        
          c 
         
        
          o 
         
        
          r 
         
        
          p 
         
        
          u 
         
        
          s 
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
          
          
            i 
           
          
            = 
           
          
            1 
           
          
         
           K 
          
         
        
          word_freqs 
         
        
          [ 
         
         
         
           w 
          
         
           i 
          
         
           ′ 
          
         
        
          ] 
         
        
          ⋅ 
         
        
          tokenize_word 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           ′ 
          
         
        
          , 
           
        
          vocab_with_loss 
         
        
          ) 
         
        
          [ 
         
        
          1 
         
        
          ] 
         
        
       
         loss(corpus)=\sum_{i=1}^K\text{word\_freqs}[w'_i]\cdot \text{tokenize\_word}(w'_i,\;\text{vocab\_with\_loss})[1] 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0278em;">cor</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.106em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8283em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord text"><span class="mord">word_freqs</span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -2.453em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1119em; vertical-align: -0.31em;"></span><span class="mord text"><span class="mord">tokenize_word</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -2.453em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord text"><span class="mord">vocab_with_loss</span></span><span class="mclose">)</span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span></span></p> 
<p>接下来，Unigram会为vocab中的每个子词计算一个score，这个score等于从vocab中移除该子词后 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
       
         c 
        
       
         o 
        
       
         r 
        
       
         p 
        
       
         u 
        
       
         s 
        
       
         ) 
        
       
      
        loss(corpus) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0278em;">cor</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span> 的变化值。可以证明，这个变化值一定是<strong>非负的</strong>，因此score越小说明这个子词在vocab中越不重要，故可以移除。</p> 
<blockquote> 
 <p>⚠️ 不少教程会把这个score称为loss。</p> 
</blockquote> 
<p>将vocab中的子词按照score从小到大进行排序，并移除前 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
         % 
        
       
      
        p\% 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.9444em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord">%</span></span></span></span></span> 个子词（通常取 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         10 
        
       
         , 
        
       
         20 
        
       
      
        10,20 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8389em; vertical-align: -0.1944em;"></span><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">20</span></span></span></span></span>），然后重新计算 <code>vocab_with_loss</code> 。反复执行上述操作直至vocab大小符合要求。</p> 
<blockquote> 
 <p>📝 <strong>关于变化值是非负的证明：</strong></p> 
 <p>注意到 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
        
          c 
         
        
          o 
         
        
          r 
         
        
          p 
         
        
          u 
         
        
          s 
         
        
          ) 
         
        
       
         loss(corpus) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0278em;">cor</span><span class="mord mathnormal">p</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span> 仅与 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           ′ 
          
         
        
          ) 
         
        
       
         loss(w'_i) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 有关，因此只需要研究后者的变化值。当移除了一些子词后，包含了这些子词的分词方案也就不再存在，相应的分词方案空间 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          S 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           ′ 
          
         
        
          ) 
         
        
       
         \mathcal{S}(w'_i) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord mathcal" style="margin-right: 0.075em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 就会缩小，而 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
          o 
         
        
          s 
         
        
          s 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           ′ 
          
         
        
          ) 
         
        
       
         loss(w'_i) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 是基于 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          S 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
           ′ 
          
         
        
          ) 
         
        
       
         \mathcal{S}(w'_i) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;"></span><span class="mord mathcal" style="margin-right: 0.075em;">S</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -2.4413em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2587em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 计算出的最小值，因此这个最小值会增大。</p> 
 <p>类似于：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          min 
         
        
          ⁡ 
         
         
         
           S 
          
         
           ′ 
          
         
        
          ≥ 
         
        
          min 
         
        
          ⁡ 
         
        
          S 
         
        
       
         \min S'\geq \min S 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8879em; vertical-align: -0.136em;"></span><span class="mop">min</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mop">min</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span></span></span></span></span>，其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           S 
          
         
           ′ 
          
         
        
          ⊆ 
         
        
          S 
         
        
       
         S'\subseteq S 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8879em; vertical-align: -0.136em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">⊆</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span></span></span></span></span>。</p> 
</blockquote> 
<h4><a id="232__650"></a>2.3.2 分词流程</h4> 
<p>Unigram分词，顾名思义，它假设各个子词之间相互独立，因此对于一个单词 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
      
        w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span> 而言，将其拆分成子词序列 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
         = 
        
       
         ( 
        
        
        
          w 
         
        
          1 
         
        
       
         , 
        
       
         ⋯ 
         
       
         , 
        
        
        
          w 
         
        
          m 
         
        
       
         ) 
        
       
      
        w=(w_1,\cdots,w_m) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 后有</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
           
           
             P 
            
           
             ( 
            
           
             w 
            
           
             ) 
            
           
             = 
            
            
            
              ∏ 
             
             
             
               i 
              
             
               = 
              
             
               1 
              
             
            
              m 
             
            
           
             P 
            
           
             ( 
            
            
            
              w 
             
            
              i 
             
            
           
             ) 
            
           
          
          
          
          
            (1) 
           
          
         
        
       
         P(w)=\prod_{i=1}^m P(w_i)\tag{1} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.9291em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∏</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height: 2.9291em; vertical-align: -1.2777em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">1</span></span><span class="mord">)</span></span></span></span></span></span></span></p> 
<p>其中 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         P 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
       
         ) 
        
       
      
        P(w_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 可以通过 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          i 
         
        
       
      
        w_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span> 出现的频率来估计（注意不是频数）。</p> 
<p>记 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         S 
        
       
         ( 
        
       
         w 
        
       
         ) 
        
       
      
        \mathcal{S}(w) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathcal" style="margin-right: 0.075em;">S</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)</span></span></span></span></span> 为单词 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
      
        w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span> 的所有分词方案，从而Unigram的分词结果为</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
           
            
            
              w 
             
            
              ∗ 
             
            
           
             = 
            
            
             
             
               arg max 
              
             
               ⁡ 
              
             
             
              
              
                w 
               
              
                ′ 
               
              
             
               ∈ 
              
             
               S 
              
             
               ( 
              
             
               w 
              
             
               ) 
              
             
            
           
             P 
            
           
             ( 
            
            
            
              w 
             
            
              ′ 
             
            
           
             ) 
            
           
          
          
          
          
            (2) 
           
          
         
        
       
         w^*=\argmax_{w'\in\mathcal{S}(w)} P(w')\tag{2} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7387em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7387em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.9623em; vertical-align: -1.1604em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.4306em;"><span class="" style="top: -2.1146em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathcal mtight" style="margin-right: 0.075em;">S</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="mclose mtight">)</span></span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop"><span class="mord mathrm" style="margin-right: 0.0139em;">arg</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathrm">max</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.1604em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8019em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height: 1.9623em; vertical-align: -1.1604em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">2</span></span><span class="mord">)</span></span></span></span></span></span></span></p> 
<p>设 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
      
        w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span> 的长度为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
      
        n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span>，若限定 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         m 
        
       
         &gt; 
        
       
         1 
        
       
      
        m&gt;1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em; vertical-align: -0.0391em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span>（即必须对 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
      
        w 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span></span></span></span></span> 进行切分），则可知 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ∣ 
        
       
         S 
        
       
         ∣ 
        
       
         = 
        
        
        
          2 
         
         
         
           n 
          
         
           − 
          
         
           1 
          
         
        
       
         − 
        
       
         1 
        
       
      
        |\mathcal{S}|=2^{n-1}-1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">∣</span><span class="mord mathcal" style="margin-right: 0.075em;">S</span><span class="mord">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8974em; vertical-align: -0.0833em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span>（使用隔板法，共有 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         n 
        
       
         − 
        
       
         1 
        
       
      
        n-1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6667em; vertical-align: -0.0833em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span> 个空，可放 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         1 
        
       
         , 
        
       
         2 
        
       
         , 
        
       
         ⋯ 
         
       
         , 
        
       
         n 
        
       
         − 
        
       
         1 
        
       
      
        1,2,\cdots,n-1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8389em; vertical-align: -0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span> 个隔板），因此暴力求解 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          ∗ 
         
        
       
      
        w^* 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6887em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span> 的时间复杂度是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
        
        
          2 
         
        
          n 
         
        
       
         ) 
        
       
      
        O(2^n) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，这显然是不可行的。</p> 
<p>从数值稳定性的角度来讲，计算 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         P 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
       
         ) 
        
       
      
        P(w_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 的乘积没有计算 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         log 
        
       
         ⁡ 
        
       
         P 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
       
         ) 
        
       
      
        \log P(w_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 的和稳定，因此我们可以对 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         1 
        
       
         ) 
        
       
      
        (1) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 式取负对数，并记 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
       
         ) 
        
       
         = 
        
       
         − 
        
       
         log 
        
       
         ⁡ 
        
       
         P 
        
       
         ( 
        
        
        
          w 
         
        
          i 
         
        
       
         ) 
        
       
      
        loss(w_i)=-\log P(w_i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">−</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，于是就有</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
           
           
             l 
            
           
             o 
            
           
             s 
            
           
             s 
            
           
             ( 
            
           
             w 
            
           
             ) 
            
           
             = 
            
            
            
              ∑ 
             
             
             
               i 
              
             
               = 
              
             
               1 
              
             
            
              m 
             
            
           
             l 
            
           
             o 
            
           
             s 
            
           
             s 
            
           
             ( 
            
            
            
              w 
             
            
              i 
             
            
           
             ) 
            
           
          
          
          
          
            (3) 
           
          
         
        
       
         loss(w)=\sum_{i=1}^m loss(w_i)\tag{3} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.9291em; vertical-align: -1.2777em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height: 2.9291em; vertical-align: -1.2777em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">3</span></span><span class="mord">)</span></span></span></span></span></span></span></p> 
<p>从而 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         2 
        
       
         ) 
        
       
      
        (2) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span></span> 式变成 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          ∗ 
         
        
       
         = 
        
        
         
         
           arg min 
          
         
           ⁡ 
          
         
         
          
          
            w 
           
          
            ′ 
           
          
         
           ∈ 
          
         
           S 
          
         
           ( 
          
         
           w 
          
         
           ) 
          
         
        
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
        
        
          w 
         
        
          ′ 
         
        
       
         ) 
        
       
      
        w^*=\argmin_{w'\in\mathcal{S}(w)} loss(w') 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6887em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.171em; vertical-align: -0.4191em;"></span><span class="mop"><span class="mop"><span class="mord mathrm" style="margin-right: 0.0139em;">arg</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathrm">min</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2809em;"><span class="" style="top: -2.4559em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">∈</span><span class="mord mathcal mtight" style="margin-right: 0.075em;">S</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4191em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。</p> 
<p>回到求解 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          ∗ 
         
        
       
      
        w^* 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6887em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span> 的问题上，我们可以使用动态规划的方法将时间复杂度降低至 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
        
        
          n 
         
        
          3 
         
        
       
         ) 
        
       
      
        O(n^3) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。具体来讲，记 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         j 
        
       
         ] 
        
       
      
        dp[j] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span></span></span></span></span> 为对 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
         [ 
        
       
         : 
        
       
         j 
        
       
         ] 
        
       
      
        w[:j] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span></span></span></span></span> 分词得到的最小loss，即 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         j 
        
       
         ] 
        
       
         = 
        
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
       
         w 
        
       
         [ 
        
       
         : 
        
       
         j 
        
        
        
          ] 
         
        
          ∗ 
         
        
       
         ) 
        
       
      
        dp[j]=loss(w[:j]^*) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，从而 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         len 
        
       
         ( 
        
       
         w 
        
       
         ) 
        
       
         ] 
        
       
         = 
        
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
       
         w 
        
       
         [ 
        
       
         : 
        
       
         len 
        
       
         ( 
        
       
         w 
        
       
         ) 
        
        
        
          ] 
         
        
          ∗ 
         
        
       
         ) 
        
       
         = 
        
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
        
        
          w 
         
        
          ∗ 
         
        
       
         ) 
        
       
      
        dp[\text{len}(w)]=loss(w[:\text{len}(w)]^*)=loss(w^*) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord text"><span class="mord">len</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord text"><span class="mord">len</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)</span><span class="mclose"><span class="mclose">]</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 就是最终答案。</p> 
<blockquote> 
 <p>⚠️ 这里的 <code>w[:j]</code> 遵循Python的切片，即左闭右开，取不到 <code>j</code>。</p> 
</blockquote> 
<p>接下来看转移方程。对 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         w 
        
       
         [ 
        
       
         : 
        
       
         j 
        
       
         ] 
        
       
      
        w[:j] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span></span></span></span></span> 进行分词可以得到若干个子词，这里我们只关注<strong>最后一个子词</strong>，不妨记为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         t 
        
       
         o 
        
       
         k 
        
       
         e 
        
       
         n 
        
       
      
        token 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span>，如下：</p> 
<div align="center"> 
 <img src="https://images2.imgbox.com/59/ba/4yzv8p9r_o.png" width="50%"> 
</div> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         t 
        
       
         o 
        
       
         k 
        
       
         e 
        
       
         n 
        
       
      
        token 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span> 的左端点 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
      
        i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span> 的取值范围是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         [ 
        
       
         0 
        
       
         , 
        
       
         j 
        
       
         ) 
        
       
      
        [0,j) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">)</span></span></span></span></span>，由 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         3 
        
       
         ) 
        
       
      
        (3) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">3</span><span class="mclose">)</span></span></span></span></span> 式，我们有</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
          
           
           
             d 
            
           
             p 
            
           
             [ 
            
           
             j 
            
           
             ] 
            
           
             = 
            
            
             
             
               min 
              
             
               ⁡ 
              
             
             
             
               0 
              
             
               ≤ 
              
             
               i 
              
             
               &lt; 
              
             
               j 
              
             
            
           
             ( 
            
           
             d 
            
           
             p 
            
           
             [ 
            
           
             i 
            
           
             ] 
            
           
             + 
            
           
             l 
            
           
             o 
            
           
             s 
            
           
             s 
            
           
             ( 
            
           
             t 
            
           
             o 
            
           
             k 
            
           
             e 
            
           
             n 
            
           
             ) 
            
           
             ) 
            
           
             = 
            
            
             
             
               min 
              
             
               ⁡ 
              
             
             
             
               0 
              
             
               ≤ 
              
             
               i 
              
             
               &lt; 
              
             
               j 
              
             
            
           
             ( 
            
           
             d 
            
           
             p 
            
           
             [ 
            
           
             i 
            
           
             ] 
            
           
             + 
            
           
             l 
            
           
             o 
            
           
             s 
            
           
             s 
            
           
             ( 
            
           
             w 
            
           
             [ 
            
           
             i 
            
           
             : 
            
           
             j 
            
           
             ] 
            
           
             ) 
            
           
             ) 
            
           
          
          
          
          
            (4) 
           
          
         
        
       
         dp[j]=\min_{0\leq i&lt;j}( dp[i]+loss(token))=\min_{0\leq i&lt;j}(dp[i]+loss(w[i:j]))\tag{4} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.6138em; vertical-align: -0.8638em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6679em;"><span class="" style="top: -2.3723em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8638em;"><span class=""></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mclose">))</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.6138em; vertical-align: -0.8638em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6679em;"><span class="" style="top: -2.3723em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span><span class="mrel mtight">≤</span><span class="mord mathnormal mtight">i</span><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span></span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8638em;"><span class=""></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]))</span></span><span class="tag"><span class="strut" style="height: 1.6138em; vertical-align: -0.8638em;"></span><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">4</span></span><span class="mord">)</span></span></span></span></span></span></span></p> 
<p>显然 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         1 
        
       
         ] 
        
       
      
        dp[1] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> 就是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
       
         w 
        
       
         [ 
        
       
         0 
        
       
         ] 
        
       
         ) 
        
       
      
        loss(w[0]) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">])</span></span></span></span></span>，而由 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         4 
        
       
         ) 
        
       
      
        (4) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">4</span><span class="mclose">)</span></span></span></span></span> 式，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         1 
        
       
         ] 
        
       
         = 
        
       
         d 
        
       
         p 
        
       
         [ 
        
       
         0 
        
       
         ] 
        
       
         + 
        
       
         l 
        
       
         o 
        
       
         s 
        
       
         s 
        
       
         ( 
        
       
         w 
        
       
         [ 
        
       
         0 
        
       
         ] 
        
       
         ) 
        
       
      
        dp[1]=dp[0]+loss(w[0]) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord">1</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">oss</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">])</span></span></span></span></span>，故得边界条件 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         0 
        
       
         ] 
        
       
         = 
        
       
         0 
        
       
      
        dp[0]=0 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord">0</span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span>。</p> 
<p>注意，在更新 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
         [ 
        
       
         j 
        
       
         ] 
        
       
      
        dp[j] 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mclose">]</span></span></span></span></span> 的时候，我们还需要保存相应的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         i 
        
       
      
        i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>，这样一来，当 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         p 
        
       
      
        dp 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span></span></span></span></span> 数组计算完后，我们就可以从 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         j 
        
       
         = 
        
       
         len 
        
       
         ( 
        
       
         w 
        
       
         ) 
        
       
      
        j=\text{len}(w) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.854em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord text"><span class="mord">len</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="mclose">)</span></span></span></span></span> 开始不断向前回溯以获得 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          w 
         
        
          ∗ 
         
        
       
      
        w^* 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6887em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0269em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6887em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>。</p> 
<p>为了实现该算法，我们需要先将 <code>vocab_with_freqs</code> 处理成 <code>vocab_with_loss</code>。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> math

<span class="token keyword">def</span> <span class="token function">process_vocab</span><span class="token punctuation">(</span>vocab_with_freqs<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    total_sum <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>vocab_with_freqs<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    vocab_with_loss <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>token<span class="token punctuation">:</span> <span class="token operator">-</span>math<span class="token punctuation">.</span>log<span class="token punctuation">(</span>freq <span class="token operator">/</span> total_sum<span class="token punctuation">)</span> <span class="token keyword">for</span> token<span class="token punctuation">,</span> freq <span class="token keyword">in</span> vocab_with_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword">return</span> vocab_with_loss
</code></pre> 
<p>接下来实现Unigram分词</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">tokenize_word</span><span class="token punctuation">(</span>word<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'start'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token string">'loss'</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">}</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'start'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'loss'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            token <span class="token operator">=</span> word<span class="token punctuation">[</span>i<span class="token punctuation">:</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span> token <span class="token keyword">in</span> vocab_with_loss <span class="token keyword">and</span> dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                new_loss <span class="token operator">=</span> dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span> <span class="token operator">+</span> vocab_with_loss<span class="token punctuation">[</span>token<span class="token punctuation">]</span>
                <span class="token keyword">if</span> dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> new_loss <span class="token operator">&lt;</span> dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    dp<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'start'</span><span class="token punctuation">:</span> i<span class="token punctuation">,</span> <span class="token string">'loss'</span><span class="token punctuation">:</span> new_loss<span class="token punctuation">}</span>

    word_loss <span class="token operator">=</span> dp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'loss'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> word_loss <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">'[UNK]'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> word_loss

    start<span class="token punctuation">,</span> end <span class="token operator">=</span> dp<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'start'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span>
    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">while</span> <span class="token operator">~</span>start<span class="token punctuation">:</span>
        res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>word<span class="token punctuation">[</span>start<span class="token punctuation">:</span>end<span class="token punctuation">]</span><span class="token punctuation">)</span>
        end <span class="token operator">=</span> start
        start <span class="token operator">=</span> dp<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'start'</span><span class="token punctuation">]</span>

    res<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> res<span class="token punctuation">,</span> word_loss
</code></pre> 
<p>该动态规划算法又称Viterbi算法，时间复杂度为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
        
        
          n 
         
        
          3 
         
        
       
         ) 
        
       
      
        O(n^3) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。具体推导如下：由于切片的时间复杂度为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
       
         j 
        
       
         − 
        
       
         i 
        
       
         ) 
        
       
      
        O(j-i) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span></span>，所以总时间复杂度为</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
             
             
               ∑ 
              
              
              
                i 
               
              
                = 
               
              
                0 
               
              
              
              
                n 
               
              
                − 
               
              
                1 
               
              
             
             
             
               ∑ 
              
              
              
                j 
               
              
                = 
               
              
                i 
               
              
                + 
               
              
                1 
               
              
             
               n 
              
             
            
              O 
             
            
              ( 
             
            
              j 
             
            
              − 
             
            
              i 
             
            
              ) 
             
            
           
          
          
           
            
             
            
              = 
             
             
             
               ∑ 
              
              
              
                i 
               
              
                = 
               
              
                0 
               
              
              
              
                n 
               
              
                − 
               
              
                1 
               
              
             
            
              O 
             
             
             
               ( 
              
              
               
               
                 ( 
                
               
                 1 
                
               
                 + 
                
               
                 n 
                
               
                 − 
                
               
                 i 
                
               
                 ) 
                
               
                 ( 
                
               
                 n 
                
               
                 − 
                
               
                 i 
                
               
                 ) 
                
               
              
                2 
               
              
             
               ) 
              
             
            
              = 
             
             
             
               ∑ 
              
              
              
                i 
               
              
                = 
               
              
                1 
               
              
             
               n 
              
             
            
              O 
             
             
             
               ( 
              
              
               
               
                 i 
                
               
                 ( 
                
               
                 i 
                
               
                 + 
                
               
                 1 
                
               
                 ) 
                
               
              
                2 
               
              
             
               ) 
              
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
            
              O 
             
             
             
               ( 
              
              
              
                ∑ 
               
               
               
                 i 
                
               
                 = 
                
               
                 1 
                
               
              
                n 
               
              
              
              
                i 
               
              
                2 
               
              
             
               ) 
              
             
            
              = 
             
            
              O 
             
             
             
               ( 
              
              
               
               
                 n 
                
               
                 ( 
                
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
                 ) 
                
               
                 ( 
                
               
                 2 
                
               
                 n 
                
               
                 + 
                
               
                 1 
                
               
                 ) 
                
               
              
                6 
               
              
             
               ) 
              
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              = 
             
            
              O 
             
            
              ( 
             
             
             
               n 
              
             
               3 
              
             
            
              ) 
             
            
           
          
         
        
       
         \begin{aligned} \sum_{i=0}^{n-1}\sum_{j=i+1}^nO(j-i)&amp;=\sum_{i=0}^{n-1}O\left(\frac{(1+n-i)(n-i)}{2}\right)=\sum_{i=1}^nO\left(\frac{i(i+1)}{2}\right) \\ &amp;=O\left(\sum_{i=1}^n i^2\right)=O\left(\frac{n(n+1)(2n+1)}{6}\right) \\ &amp;=O(n^3) \end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 8.3667em; vertical-align: -3.9333em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.4333em;"><span class="" style="top: -6.4333em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8011em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0572em;">j</span><span class="mrel mtight">=</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.4138em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0572em;">j</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span><span class="" style="top: -2.9696em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"></span></span><span class="" style="top: -0.5278em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 3.9333em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 4.4333em;"><span class="" style="top: -6.4333em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.8011em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">)</span></span></span></span></span><span class="" style="top: -2.9696em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.6514em;"><span class="" style="top: -1.8723em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2777em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size4">)</span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.427em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">6</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">)</span></span></span></span></span><span class="" style="top: -0.5278em;"><span class="pstrut" style="height: 3.8011em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 3.9333em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<h4><a id="233_Unigram_752"></a>2.3.3 从零实现Unigram</h4> 
<p>我们在前两小节中已经实现了一些函数，接下来只需完成剩下的部分。</p> 
<p>计算整个语料库上的损失：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">corpus_loss</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span><span class="token punctuation">:</span>
    loss <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> word<span class="token punctuation">,</span> freq <span class="token keyword">in</span> word_freqs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        loss <span class="token operator">+=</span> freq <span class="token operator">*</span> tokenize_word<span class="token punctuation">(</span>word<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> loss
</code></pre> 
<p>为vocab中的每个子词计算相应的score：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">compute_scores</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    scores <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    pre_loss <span class="token operator">=</span> corpus_loss<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span>
    <span class="token keyword">for</span> token <span class="token keyword">in</span> vocab_with_loss<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token keyword">continue</span>
        vocab_with_loss_ <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>vocab_with_loss<span class="token punctuation">)</span>
        vocab_with_loss_<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>token<span class="token punctuation">)</span>
        cur_loss <span class="token operator">=</span> corpus_loss<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> vocab_with_loss_<span class="token punctuation">)</span>
        scores<span class="token punctuation">[</span>token<span class="token punctuation">]</span> <span class="token operator">=</span> cur_loss <span class="token operator">-</span> pre_loss
    <span class="token keyword">return</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>scores<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>定义Unigram的训练函数：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">unigram_train</span><span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> init_vocab_size<span class="token punctuation">,</span> vocab_size<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">:</span>
    vocab_with_freqs <span class="token operator">=</span> init_vocab<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> init_vocab_size<span class="token punctuation">)</span>
    vocab_with_loss <span class="token operator">=</span> process_vocab<span class="token punctuation">(</span>vocab_with_freqs<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>vocab_with_loss<span class="token punctuation">)</span> <span class="token operator">&gt;</span> vocab_size<span class="token punctuation">:</span>
        scores <span class="token operator">=</span> compute_scores<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span>
        num_to_remove <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>vocab_with_loss<span class="token punctuation">)</span> <span class="token operator">*</span> p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>scores<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> num_to_remove <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_to_remove<span class="token punctuation">)</span><span class="token punctuation">:</span>
            vocab_with_freqs<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>scores<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        vocab_with_loss <span class="token operator">=</span> process_vocab<span class="token punctuation">(</span>vocab_with_freqs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> vocab_with_loss
</code></pre> 
<p>同样拿WikiText-2的验证集来看一下Unigram算法都学到了什么，设置初始词表大小为500，最终词表大小为200，丢弃率为0.1，输出结果如下</p> 
<pre><code class="prism language-python">pre_tokenizer <span class="token operator">=</span> Whitespace<span class="token punctuation">(</span><span class="token punctuation">)</span>

corpus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
data <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"wikitext"</span><span class="token punctuation">,</span> <span class="token string">"wikitext-2-v1"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"validation"</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> line <span class="token keyword">in</span> data<span class="token punctuation">:</span>
    tokenized_line <span class="token operator">=</span> pre_tokenizer<span class="token punctuation">.</span>pre_tokenize_str<span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    corpus<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tokenized_line<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

word_freqs <span class="token operator">=</span> get_word_freqs<span class="token punctuation">(</span>corpus<span class="token punctuation">)</span>
vocab_with_loss <span class="token operator">=</span> unigram_train<span class="token punctuation">(</span>word_freqs<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span>
vocab_with_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> vocab_with_loss<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab_with_loss<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># [('!', 9.832349524702789), ('"', 5.970450906457211), ('$', 9.517268478062894), ('%', 9.646946301371425), ('&amp;', 10.77681113354364), ("'", 6.286570914229525), ('(', 6.786064971985966), (')', 6.787827086979365), ('*', 13.128186390707118), ('+', 12.435039210147172), (',', 4.56506426740248), ('-', 6.273304601332049), ('.', 4.7355365343654805), ('/', 9.001052005662027), ('0', 5.683060932736877), ('1', 5.607139156414499), ('2', 6.043540944928233), ('3', 6.869561406868152), ('4', 6.992621499625379), ('5', 6.809218276960683)]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>vocab_with_loss<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># [('pt', 7.320043900726674), ('ated', 7.327579731415376), ('ound', 7.362995287922273), ('ite', 7.38678705247961), ('St', 7.388393478527883), ('ese', 7.396464547361675), ('Au', 7.414453585197748), ('oug', 7.427742817316431), ('stra', 7.432772165721433), ('qu', 7.434454251904418), ('rth', 7.444606623368436), ('ctio', 7.44801378169005), ('ction', 7.449721724035206), ('ass', 7.451432588438836), ('ave', 7.451432588438836), ('ough', 7.458305467726598), ('au', 7.475697210438467), ('nter', 7.502365457520629), ('ish', 7.511415293040546), ('oth', 7.515058284319047)]</span>
</code></pre> 
<p>分词效果</p> 
<pre><code class="prism language-python">words <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'apple'</span><span class="token punctuation">,</span> <span class="token string">'ground'</span><span class="token punctuation">,</span> <span class="token string">'finish'</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> word <span class="token keyword">in</span> words<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>tokenize_word<span class="token punctuation">(</span>word<span class="token punctuation">,</span> vocab_with_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># (['a', 'p', 'p', 'l', 'e'], 17.16241864337219)</span>
<span class="token comment"># (['g', 'r', 'ound'], 14.555457675482492)</span>
<span class="token comment"># (['f', 'i', 'n', 'ish'], 17.145052257815873)</span>
</code></pre> 
<p>因为词表较小，所以分词效果并不理想。</p> 
<h4><a id="234__830"></a>2.3.4 解码流程</h4> 
<p>Unigram通常与SentencePiece结合在一起使用。SentencePiece会将文本中的空格替换成 <code>▁</code>（U+2581），解码时只需要执行如下操作即可</p> 
<pre><code class="prism language-python">detokenized <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>pieces<span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'▁'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="3__839"></a>3. 三种分词方法的比较</h2> 
<table><thead><tr><th>分词方法</th><th>BPE</th><th>WordPiece</th><th>Unigram</th></tr></thead><tbody><tr><td>训练</td><td>从小的基础词表开始不断学习规则以扩充词表</td><td>和BPE相同</td><td>从大的词表开始不断学习规则以缩减词表</td></tr><tr><td>规则</td><td>合并出现频率最高的pair</td><td>合并互信息最大的pair</td><td>移除使得语料库的loss增加最小的子词</td></tr><tr><td>结果</td><td>词表+合并规则</td><td>仅有词表</td><td>带有loss的词表</td></tr><tr><td>编码</td><td>先将单词拆成字符，然后不断应用合并规则</td><td>在词表中找到单词的最长前缀，对单词的剩余部分递归执行上述操作</td><td>选取损失最小的分词方案</td></tr></tbody></table> 
<hr> 
<h2><a id="Ref_853"></a>Ref</h2> 
<p>[1] <a href="https://huggingface.co/docs/transformers/tokenizer_summary" rel="nofollow">https://huggingface.co/docs/transformers/tokenizer_summary</a><br> [2] <a href="https://paddlepedia.readthedocs.io/en/latest/tutorials/pretrain_model/subword.html" rel="nofollow">https://paddlepedia.readthedocs.io/en/latest/tutorials/pretrain_model/subword.html</a><br> [3] <a href="https://huggingface.co/learn/nlp-course/chapter6/5?fw=pt" rel="nofollow">https://huggingface.co/learn/nlp-course/chapter6/5?fw=pt</a><br> [4] <a href="https://zhuanlan.zhihu.com/p/86965595" rel="nofollow">https://zhuanlan.zhihu.com/p/86965595</a><br> [5] <a href="https://wmathor.com/index.php/archives/1517/" rel="nofollow">https://wmathor.com/index.php/archives/1517/</a><br> [6] <a href="https://github.com/huggingface/transformers/blob/v4.31.0/src/transformers/models/gpt2/tokenization_gpt2.py#L104">https://github.com/huggingface/transformers/blob/v4.31.0/src/transformers/models/gpt2/tokenization_gpt2.py#L104</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4dce18f70746b13550d071fabf54ef53/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C语言】堆排序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/49c298d48b8275db2bf25cfd05b5a42e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深入了解 RabbitMQ：高性能消息中间件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>