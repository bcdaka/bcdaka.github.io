<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【postgresql初级使用】条件表达式触发器，兼顾DML执行性能，又能执行复杂逻辑，只在结帐时计算总帐 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/6a97a0f95b7960588cd6e75a50b6f804/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【postgresql初级使用】条件表达式触发器，兼顾DML执行性能，又能执行复杂逻辑，只在结帐时计算总帐">
  <meta property="og:description" content="条件触发器 ​专栏内容：
postgresql使用入门基础手写数据库toadb并发编程 个人主页：我的主页
管理社区：开源数据库
座右铭：天行健，君子以自强不息；地势坤，君子以厚德载物.
文章目录 条件触发器概述 原理机制 语法 原理 案例 场景介绍 数据准备 创建触发器 效果验证 总结 结尾 概述 触发器trigger 是语句级的(row-level) 时, 被触发的频率是相当高的，会带来一定的性能开销。
今天给大家分享一种带有条件表达式的触发器，只在条件满足时触发，其它情况下并不会执行，这样既能满足触发器的复杂处理，也能满足性能的要求。
原理机制 下面就来详细了解一下带条件表达式的触发器吧。
语法 带条件表达式的触发器的SQL语法格式如下：
CREATE TRIGGER trigger_name {BEFORE | AFTER} { INSERT OR UPDATE OR DELETE OR TRUNCATE } ON table_name WHEN condition FOR [EACH] ROW EXECUTE FUNCTION function_name(); 说明
这里与普通触发器的语法类似，可以参见前面的分享；如果是行级的触发器，需要指定BEFORE或AFTER以及对应的事件；此处通过WHEN子句指定触发的条件，只有在条件满足时才能执行；触发器类型指定，行级触发器为FOR EACH ROW；最后指定触发器执行函数； 原理 在行级触发器中：
可以访问修改前的行与修改后的行，通过访问这两行的值设定条件表达式。修改前的行使用OLD.column_name进行引用，修改后的行引用方式为 NEW.column_name；INSERT命令没有OLD行，DELETE命令没有NEW行；INSTEAD OF不支持设置条件； 而在语句级触发器中没有可引用的行数据。
案例 下面我们通过一个案例来看看条件触发器的使用场景。
场景介绍 当在饭店消费时，会先点一些菜，过程中又会根据需要再加一些菜或者饮品，最后再统一结帐。
对于这样一个很常见的场景，通过条件触发器可以实现自动计算账单。
数据准备 新建两张表，一张为订单表，记录客户消费情况，以及订单状态；另一张为客户统计，记录客户总的消费金额。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-18T07:20:01+08:00">
    <meta property="article:modified_time" content="2024-06-18T07:20:01+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【postgresql初级使用】条件表达式触发器，兼顾DML执行性能，又能执行复杂逻辑，只在结帐时计算总帐</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>条件触发器</h2> 
<blockquote> 
 <p>​<strong>专栏内容</strong>：</p> 
 <ul><li><a href="https://blog.csdn.net/senllang/category_12346885.html">postgresql使用入门基础</a></li><li><a href="https://senllang.blog.csdn.net/category_12338586.html" rel="nofollow">手写数据库toadb</a></li><li><a href="https://blog.csdn.net/senllang/category_12265530.html">并发编程</a></li></ul> 
</blockquote> 
<blockquote> 
 <p><strong>个人主页</strong>：<a href="https://senllang.blog.csdn.net" rel="nofollow">我的主页</a><br> <strong>管理社区</strong>：<a href="https://bbs.csdn.net/forums/a0a6ea788b3949b6a06ab4811f9eec5d">开源数据库</a><br> <strong>座右铭：天行健，君子以自强不息；地势坤，君子以厚德载物.</strong></p> 
</blockquote> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_0" rel="nofollow">条件触发器</a></li><li><a href="#font_colorA0522D_font_13" rel="nofollow"><font color="#A0522D">概述 </font></a></li><li><a href="#font_colorA0522D_font_20" rel="nofollow"><font color="#A0522D">原理机制 </font></a></li><li><ul><li><a href="#font_colorA0522D_font_25" rel="nofollow"><font color="#A0522D">语法 </font></a></li><li><a href="#font_colorA0522D_font_45" rel="nofollow"><font color="#A0522D">原理 </font></a></li></ul> 
  </li><li><a href="#font_colorA0522D_font_55" rel="nofollow"><font color="#A0522D">案例 </font></a></li><li><ul><li><a href="#font_colorA0522D_font_60" rel="nofollow"><font color="#A0522D">场景介绍 </font></a></li><li><a href="#font_colorA0522D_font_66" rel="nofollow"><font color="#A0522D">数据准备 </font></a></li><li><a href="#font_colorA0522D_font_84" rel="nofollow"><font color="#A0522D">创建触发器 </font></a></li><li><a href="#font_colorA0522D_font_141" rel="nofollow"><font color="#A0522D">效果验证 </font></a></li></ul> 
  </li><li><a href="#font_colorA0522D_font_180" rel="nofollow"><font color="#A0522D">总结 </font></a></li><li><a href="#font_colorA0522D_font_187" rel="nofollow"><font color="#A0522D">结尾 </font></a></li></ul> 
</div> 
<p></p> 
<h2><a id="font_colorA0522D_font_13"></a><font color="#A0522D">概述 </font></h2> 
<hr> 
<p>触发器trigger 是语句级的(row-level) 时, 被触发的频率是相当高的，会带来一定的性能开销。</p> 
<p>今天给大家分享一种带有条件表达式的触发器，只在条件满足时触发，其它情况下并不会执行，这样既能满足触发器的复杂处理，也能满足性能的要求。</p> 
<h2><a id="font_colorA0522D_font_20"></a><font color="#A0522D">原理机制 </font></h2> 
<hr> 
<p>下面就来详细了解一下带条件表达式的触发器吧。</p> 
<h3><a id="font_colorA0522D_font_25"></a><font color="#A0522D">语法 </font></h3> 
<p>带条件表达式的触发器的SQL语法格式如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> trigger_name
{BEFORE <span class="token operator">|</span> <span class="token keyword">AFTER</span>} { <span class="token keyword">INSERT</span> <span class="token operator">OR</span> <span class="token keyword">UPDATE</span> <span class="token operator">OR</span> <span class="token keyword">DELETE</span> <span class="token operator">OR</span> <span class="token keyword">TRUNCATE</span> }
<span class="token keyword">ON</span> table_name
<span class="token keyword">WHEN</span> condition
<span class="token keyword">FOR</span> <span class="token punctuation">[</span>EACH<span class="token punctuation">]</span>  <span class="token keyword">ROW</span> 
<span class="token keyword">EXECUTE</span> <span class="token keyword">FUNCTION</span> function_name<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>说明</strong></p> 
<ul><li>这里与普通触发器的语法类似，可以参见前面的分享；</li><li>如果是行级的触发器，需要指定<code>BEFORE</code>或<code>AFTER</code>以及对应的事件；</li><li>此处通过<code>WHEN</code>子句指定触发的条件，只有在条件满足时才能执行；</li><li>触发器类型指定，行级触发器为<code>FOR EACH ROW</code>；</li><li>最后指定触发器执行函数；</li></ul> 
<h3><a id="font_colorA0522D_font_45"></a><font color="#A0522D">原理 </font></h3> 
<p>在行级触发器中：</p> 
<ul><li>可以访问修改前的行与修改后的行，通过访问这两行的值设定条件表达式。</li><li>修改前的行使用OLD.column_name进行引用，修改后的行引用方式为 NEW.column_name；</li><li><code>INSERT</code>命令没有OLD行，<code>DELETE</code>命令没有NEW行；</li><li><code>INSTEAD OF</code>不支持设置条件；</li></ul> 
<p>而在语句级触发器中没有可引用的行数据。</p> 
<h2><a id="font_colorA0522D_font_55"></a><font color="#A0522D">案例 </font></h2> 
<hr> 
<p>下面我们通过一个案例来看看条件触发器的使用场景。</p> 
<h3><a id="font_colorA0522D_font_60"></a><font color="#A0522D">场景介绍 </font></h3> 
<p>当在饭店消费时，会先点一些菜，过程中又会根据需要再加一些菜或者饮品，最后再统一结帐。</p> 
<p>对于这样一个很常见的场景，通过条件触发器可以实现自动计算账单。</p> 
<h3><a id="font_colorA0522D_font_66"></a><font color="#A0522D">数据准备 </font></h3> 
<p>新建两张表，一张为订单表，记录客户消费情况，以及订单状态；另一张为客户统计，记录客户总的消费金额。</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orders <span class="token punctuation">(</span>
    order_id <span class="token keyword">INT</span> GENERATED ALWAYS <span class="token keyword">AS</span> <span class="token keyword">IDENTITY</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    customer_id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    total_amount <span class="token keyword">NUMERIC</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token keyword">status</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> customer_stats <span class="token punctuation">(</span>
    customer_id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    total_spent <span class="token keyword">NUMERIC</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="font_colorA0522D_font_84"></a><font color="#A0522D">创建触发器 </font></h3> 
<p>下面在orders表上对<code>insert</code>,<code>update</code>事件创建两个触发器。</p> 
<p><strong>创建订单触发器</strong></p> 
<p>当有新客人时，会向<code>orders</code>表中插入一条新记录；</p> 
<p>此时通过触发器自动在<code>customer_stats</code>表中也插入客户ID，金额为0，此时订单状态还为<code>pending</code>。</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> insert_customer_stats<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">TRIGGER</span> 
<span class="token keyword">AS</span> $$
<span class="token keyword">BEGIN</span>
   <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> customer_stats <span class="token punctuation">(</span>customer_id<span class="token punctuation">)</span>
   <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>NEW<span class="token punctuation">.</span>customer_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">RETURN</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> plpgsql<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> insert_customer_stats_trigger
<span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span> <span class="token keyword">ON</span> orders
<span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">EXECUTE</span> <span class="token keyword">FUNCTION</span> insert_customer_stats<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>结帐付款</strong></p> 
<p>客人在过程中可能会变动订单金额，订单状态始终为<code>pending</code>, 最后结帐时将订单状态改为<code>completed</code>，此时生成帐单。</p> 
<p>在<code>orders</code>表上增加<code>UPDATE</code>事件的条件触发器，只有<code>NEW.status</code>为<code>completed</code>时才会触发，此时将客户金额插入<code>customer_stats</code>表中。</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> update_customer_stats<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">TRIGGER</span> 
<span class="token keyword">AS</span> 
$$
<span class="token keyword">BEGIN</span>
    <span class="token keyword">IF</span> NEW<span class="token punctuation">.</span><span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'completed'</span> <span class="token keyword">THEN</span>
        <span class="token comment">-- Update the total_spent for the customer</span>
        <span class="token keyword">UPDATE</span> customer_stats
        <span class="token keyword">SET</span> total_spent <span class="token operator">=</span> total_spent <span class="token operator">+</span> NEW<span class="token punctuation">.</span>total_amount
        <span class="token keyword">WHERE</span> customer_id <span class="token operator">=</span> NEW<span class="token punctuation">.</span>customer_id<span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
    <span class="token keyword">RETURN</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
$$ <span class="token keyword">LANGUAGE</span> plpgsql<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> update_customer_stats_trigger
<span class="token keyword">AFTER</span> <span class="token keyword">UPDATE</span> <span class="token keyword">ON</span> orders
<span class="token keyword">FOR EACH ROW</span>
<span class="token keyword">WHEN</span> <span class="token punctuation">(</span>OLD<span class="token punctuation">.</span><span class="token keyword">status</span> <span class="token operator">&lt;&gt;</span> <span class="token string">'completed'</span> <span class="token operator">AND</span> NEW<span class="token punctuation">.</span><span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'completed'</span><span class="token punctuation">)</span>
<span class="token keyword">EXECUTE</span> <span class="token keyword">FUNCTION</span> update_customer_stats<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="font_colorA0522D_font_141"></a><font color="#A0522D">效果验证 </font></h3> 
<p>好了，来测试一下业务流。</p> 
<p>先来了两波客人，分别点了100，200的菜品。</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> orders <span class="token punctuation">(</span>customer_id<span class="token punctuation">,</span> total_amount<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>两波客人都要结帐了，要忙了。</p> 
<pre><code class="prism language-sql"><span class="token keyword">UPDATE</span> orders
<span class="token keyword">SET</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token string">'completed'</span>
<span class="token keyword">WHERE</span> customer_id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>看一下这两波客人的账单：</p> 
<pre><code class="prism language-shell"><span class="token assign-left variable">postgres</span><span class="token operator">=</span><span class="token operator">&gt;</span> SELECT * FROM customer_stats<span class="token punctuation">;</span>
 customer_id <span class="token operator">|</span> total_spent
-------------+-------------
           <span class="token number">1</span> <span class="token operator">|</span>         <span class="token number">100</span>
           <span class="token number">2</span> <span class="token operator">|</span>         <span class="token number">200</span>
<span class="token punctuation">(</span><span class="token number">2</span> rows<span class="token punctuation">)</span>

</code></pre> 
<pre><code class="prism language-txt">先生/女士，这是您的账单，请您过目... 

请慢走，欢迎下次光临!
</code></pre> 
<h2><a id="font_colorA0522D_font_180"></a><font color="#A0522D">总结 </font></h2> 
<hr> 
<p>本章节分享了通过表达式条件来限制触发器执行，这样不仅提升DML操作的性能，同时还能利用触发器实现复杂的功能。</p> 
<p>最后通过一个经典的帐单结算的案例，演示了条件触发器，会在订单转为完成状态时自动生成帐单。</p> 
<h2><a id="font_colorA0522D_font_187"></a><font color="#A0522D">结尾 </font></h2> 
<hr> 
<blockquote> 
 <p><strong>非常感谢大家的支持，在浏览的同时别忘了留下您宝贵的评论，如果觉得值得鼓励，请点赞，收藏，我会更加努力！</strong></p> 
</blockquote> 
<p>作者邮箱：study@senllang.onaliyun.com<br> 如有错误或者疏漏欢迎指出，互相学习。</p> 
<p>注：未经同意，不得转载！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/431225d199a0358da0aca3f3139d9fb6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python GUI开发: tkinter选项卡，移动滑块，颜色选择框，文本对话框，对话输入框，通用消息框模块用法详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/21a6f9367e2dd37d36928f346a8f1ab4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">网络安全（完整）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>