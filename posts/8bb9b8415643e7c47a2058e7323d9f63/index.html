<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Mongodb-01】Mongodb亿级数据性能测试和压测 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/8bb9b8415643e7c47a2058e7323d9f63/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Mongodb-01】Mongodb亿级数据性能测试和压测">
  <meta property="og:description" content="mongodb数据性能测试 一，mongodb数据性能测试1，mongodb数据库创建和索引设置2，线程池&#43;批量方式插入数据3，一千万数据性能测试4，两千万数据性能测试5，五千万数据性能测试6，一亿条数据性能测试7，压测8，总结 一，mongodb数据性能测试 如需转载，请标明出处：https://zhenghuisheng.blog.csdn.net/article/details/139505973
之前公司将用户的游戏数据存储在mysql中，就是直接将json数据存储到mysql数据库里面，几个月不到，数据库里面已经有两亿条数据，而且每行中每个json数据量也比较大，导致占用的磁盘容量也比较大，因此为了解决mysql带来多方面的瓶颈，最终选择使用mongodb来代替mysql。为了测试mongodbdb的性能以及是否满足需求，因此做了以下测试，对mongodb在高流量时验证其增删改查的效率，以及对其进行压测
服务器配置：2核4g轻量级服务器 磁盘容量 70GB
每条数据大概在500个字节，索引有一个id主键索引，还有一个parentId和category的联合唯一索引，这里两个字段能保证唯一性，因此用唯一索引效率更优
1，mongodb数据库创建和索引设置 首先在Java代码中创建一个实体类，用这个类作为json对象插入到文档中即可。
@Data public class Archive { private String id; //账号id private String parentId; private String category; private String content; } 随后在mongodb中创建一个数据库，然后再该库下面建立一个名为 archive 的集合，mongodb的集合就是类似于mysql的表，两者概念是一样的。由于后期数据量可能非常大，因此根据mongodb官方文档所说，在数据插入前，尽量提前建立索引，为了满足业务需求，这里选择创建一个联合索引，由于我这边业务能保证要加索引的两个字段的唯一性，因此选择直接添加唯一索引
db.users.createIndex({parentId: 1,category:1}, {unique: true}) 如果navicate操作不方便的话，可以安装一个 Mongodb Compass 可视化工具，如下图，很多操作都是可以在这个可视化图形界面上面直接操作的
2，线程池&#43;批量方式插入数据 由于这边主要是io操作将数据插入，不需要计算之类的，因此选择使用io密集型线程池，接下来自定义一个线程池
@Slf4j public class ThreadPoolUtil { public static ThreadPoolExecutor pool = null; public static synchronized ThreadPoolExecutor getThreadPool() { if (pool == null) { //获取当前机器的cpu int cpuNum = Runtime.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-15T17:10:30+08:00">
    <meta property="article:modified_time" content="2024-06-15T17:10:30+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Mongodb-01】Mongodb亿级数据性能测试和压测</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>mongodb数据性能测试</h4> 
 <ul><li><a href="#mongodb_1" rel="nofollow">一，mongodb数据性能测试</a></li><li><ul><li><ul><li><ul><li><a href="#1mongodb_10" rel="nofollow">1，mongodb数据库创建和索引设置</a></li><li><a href="#2_36" rel="nofollow">2，线程池+批量方式插入数据</a></li><li><a href="#3_115" rel="nofollow">3，一千万数据性能测试</a></li><li><a href="#4_132" rel="nofollow">4，两千万数据性能测试</a></li><li><a href="#5_150" rel="nofollow">5，五千万数据性能测试</a></li><li><a href="#6_200" rel="nofollow">6，一亿条数据性能测试</a></li><li><a href="#7_241" rel="nofollow">7，压测</a></li><li><a href="#8_266" rel="nofollow">8，总结</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="mongodb_1"></a>一，mongodb数据性能测试</h2> 
<p>如需转载，请标明出处：<a href="https://zhenghuisheng.blog.csdn.net/article/details/139505973" rel="nofollow">https://zhenghuisheng.blog.csdn.net/article/details/139505973</a></p> 
<p>之前公司将用户的游戏数据存储在mysql中，就是直接将json数据存储到mysql数据库里面，几个月不到，数据库里面已经有两亿条数据，而且每行中每个json数据量也比较大，导致占用的磁盘容量也比较大，因此为了解决mysql带来多方面的瓶颈，最终选择使用mongodb来代替mysql。为了测试mongodbdb的性能以及是否满足需求，因此做了以下测试，对mongodb在高流量时验证其增删改查的效率，以及对其进行压测</p> 
<p><strong>服务器配置</strong>：2核4g轻量级服务器 磁盘容量 70GB</p> 
<p>每条数据大概在500个字节，索引有一个id主键索引，还有一个parentId和category的联合唯一索引，这里两个字段能保证唯一性，因此用唯一索引效率更优</p> 
<h5><a id="1mongodb_10"></a>1，mongodb数据库创建和索引设置</h5> 
<p>首先在Java代码中创建一个实体类，用这个类作为json对象插入到文档中即可。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Archive</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token comment">//账号id</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> parentId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> category<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> content<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>随后在mongodb中创建一个数据库，然后再该库下面建立一个名为 archive 的集合，mongodb的集合就是类似于mysql的表，两者概念是一样的。由于后期数据量可能非常大，因此根据mongodb官方文档所说，在数据插入前，尽量提前建立索引，为了满足业务需求，这里选择创建一个联合索引，由于我这边业务能保证要加索引的两个字段的唯一性，因此选择直接添加唯一索引</p> 
<pre><code class="prism language-java">db<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>parentId<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>category<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果navicate操作不方便的话，可以安装一个 <strong>Mongodb Compass</strong> 可视化工具，如下图，很多操作都是可以在这个可视化图形界面上面直接操作的<br> <img src="https://images2.imgbox.com/98/ca/0q3y6ecz_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2_36"></a>2，线程池+批量方式插入数据</h5> 
<p>由于这边主要是io操作将数据插入，不需要计算之类的，因此选择使用io密集型线程池，接下来自定义一个线程池</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolUtil</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> pool <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">getThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pool <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//获取当前机器的cpu</span>
            <span class="token keyword">int</span> cpuNum <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> maximumPoolSize <span class="token operator">=</span> cpuNum <span class="token operator">*</span> <span class="token number">2</span> <span class="token punctuation">;</span>
            pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                    maximumPoolSize <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    maximumPoolSize<span class="token punctuation">,</span>
                    <span class="token number">5L</span><span class="token punctuation">,</span>   <span class="token comment">//5s</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//数组有界队列</span>
                    <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//默认的线程工厂</span>
                    <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//直接抛异常，默认异常</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pool<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第二步就是定义一个线程任务，到时将任务丢到线程池里面，其代码如下，该任务实现Callable接口，每个线程插入10万条，每次批量插入100条数据，大概就是需要1000次</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArchiveTask</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">ArchiveTask</span><span class="token punctuation">(</span><span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mongoTemplate <span class="token operator">=</span> mongoTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Archive</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Archive</span> archive <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Archive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            archive<span class="token punctuation">.</span><span class="token function">setCategory</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            archive<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">SnowflakeUtils</span><span class="token punctuation">.</span><span class="token function">nextOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            archive<span class="token punctuation">.</span><span class="token function">setParentId</span><span class="token punctuation">(</span><span class="token class-name">SnowflakeUtils</span><span class="token punctuation">.</span><span class="token function">nextOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            archive<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>archive<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                mongoTemplate<span class="token punctuation">.</span><span class="token function">insertAll</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
                list<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//手动gc，100个对象没被引用会被回收</span>
                list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后定义一个测试类或者一个接口，我这边使用接口，部分代码如下，循环100次，就是会创建100个线程任务，随后将这个线程任务丢到线程池中，100乘以100000就是1千万条数据</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Resource</span>
<span class="token keyword">private</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> threadPool <span class="token operator">=</span> <span class="token class-name">ThreadPoolUtil</span><span class="token punctuation">.</span><span class="token function">getThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/add"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">ArchiveTask</span> archiveTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArchiveTask</span><span class="token punctuation">(</span>mongoTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
		threadPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>archiveTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"数据添加完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3_115"></a>3，一千万数据性能测试</h5> 
<p>mongodb性能测试，此时<strong>archive</strong> 集合中已有10134114条数据，平均每条数据大小674字节，1千多万条，此时的存储大小为5.5个g，索引的总大小为459m</p> 
<p>接下来通过唯一索引查询一条数据，这里直接通过parentId查询一条数据，此时数据还是在不断插入的</p> 
<pre><code class="prism language-java">db<span class="token punctuation">.</span>archive<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>parentId<span class="token operator">:</span><span class="token string">"2405291858848274156091867143"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>是的，如下图所示，1000多万条数据里面查询，只需要25ms即可将数据放回，当然这里没有在高流量的情况下进行压测。</p> 
<p><img src="https://images2.imgbox.com/60/33/W31Cfeia_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="4_132"></a>4，两千万数据性能测试</h5> 
<p>此时archive集合来到了两千万条，每条数据和之前一样，平均大小是674字节，数据总大小来到了10.92G，内存大小12.65g，索引总大小是913m<br> <img src="https://images2.imgbox.com/ab/5a/jINQaJpY_o.png" alt="在这里插入图片描述"></p> 
<p>接下来测试查询效率，依旧使用上面的这个parentId，由于设置的是parentId+category的联合唯一索引，接下来两个参数一起查</p> 
<pre><code class="prism language-java">db<span class="token punctuation">.</span>archive<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>parentId<span class="token operator">:</span><span class="token string">"2405291858848274156091867143"</span><span class="token punctuation">,</span>category<span class="token operator">:</span><span class="token string">"score"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>2000万的数据查询结果如下，只需要21ms，和上面的25ms慢了将近4ms，但是这4ms可以忽略</p> 
<p><img src="https://images2.imgbox.com/b8/cd/LQNXb8fZ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="5_150"></a>5，五千万数据性能测试</h5> 
<p>由于70G的磁盘容量已经只剩48G，因此在content字段将500字节的值调小，调整到150个字节，以便能插入更多数据。将上面的StringBuilder拼接的15个uuid改成1个uuid</p> 
<pre><code class="prism language-java">map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>此时数据来到50245694条数据，每条数据平均大小372kb，总存储大小12.66g，内存中的总大小17.45g，索引大小目前只有2.8g</p> 
<p><img src="https://images2.imgbox.com/c0/a5/FOJGEpYi_o.png" alt="在这里插入图片描述"></p> 
<p>为了保证拿到的parentId是一次没有查询过的，手动的插入一批数据，手动单条插入20条数据，耗时600ms，在插入数据时会改变索引，插入数据会稍微慢些。此时的插入操作都是在多线程插入大量数据的时候测试的</p> 
<pre><code class="prism language-java">db<span class="token punctuation">.</span>archive<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>parentId<span class="token operator">:</span><span class="token string">"2024111222337"</span><span class="token punctuation">,</span>category<span class="token operator">:</span><span class="token string">"score1"</span><span class="token punctuation">,</span>content<span class="token operator">:</span><span class="token string">"cbasbsadhpasdbsaodgs"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>archive<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>parentId<span class="token operator">:</span><span class="token string">"2024111222337"</span><span class="token punctuation">,</span>category<span class="token operator">:</span><span class="token string">"score2"</span><span class="token punctuation">,</span>content<span class="token operator">:</span><span class="token string">"cbasbsadhpasdbsaodgs"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>此时第一次查询这条数据，共耗时153ms，共查出20条数据</p> 
<p><img src="https://images2.imgbox.com/46/a8/dKn02h6k_o.png" alt="在这里插入图片描述"></p> 
<p>再第二次查询之后，花费78ms，内部应该也是会将查询结果加入到缓存中，方便第二次查询</p> 
<p><img src="https://images2.imgbox.com/6f/d4/GUlrZFLV_o.png" alt="在这里插入图片描述"></p> 
<p>在上面的插入操作中由于会破坏到索引结构，因此耗时久一点。接下来看这个更新操作，</p> 
<pre><code class="prism language-java">db<span class="token punctuation">.</span>archive<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span>
    <span class="token punctuation">{<!-- --></span> parentId<span class="token operator">:</span> <span class="token string">"2024111222337"</span><span class="token punctuation">,</span>category<span class="token operator">:</span><span class="token string">"score1"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> $set<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> content<span class="token operator">:</span> <span class="token string">"cbasbsadhpasdbsaodgsscore"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>其结果如下，更新了一条数据，只花费了13毫秒的时间，因此更新操作速度是很快的。由于这里每一条数据都是唯一数据，因此不测试批量更新</p> 
<p><img src="https://images2.imgbox.com/54/0e/W00sqloQ_o.png" alt="在这里插入图片描述"></p> 
<p>最后测试删除数据，将这20条数据全部删除，总共花费18毫秒</p> 
<p><img src="https://images2.imgbox.com/89/01/OfHlbcWN_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="6_200"></a>6，一亿条数据性能测试</h5> 
<p>数据通过多线程+批量插入的方式来到一亿条，存储大小15.5g，索引长度是6g</p> 
<pre><code class="prism language-java">db<span class="token punctuation">.</span>archive<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//查询共有多少条数据</span>
<span class="token number">100082694</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/d0/79/bII3XcDC_o.png" alt="在这里插入图片描述"></p> 
<p>接下来往里面重新插入一部分数据，往里面插入20条数据，大概花费160多ms，插入数据会导致索引重构，所以耗时久一些，批量插入性能会更快。重新插入的数据可以保证这条数据没被查过，并且知道parentId是什么</p> 
<pre><code class="prism language-java">db<span class="token punctuation">.</span>archive<span class="token punctuation">.</span><span class="token function">insertOne</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>parentId<span class="token operator">:</span><span class="token string">"20240531101059"</span><span class="token punctuation">,</span>category<span class="token operator">:</span><span class="token string">"score1"</span><span class="token punctuation">,</span>content<span class="token operator">:</span><span class="token string">"abcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxyabcdefghijklmnopqrstuvwxy"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>接下来测试查询数据，只需要19ms</p> 
<pre><code class="prism language-java">db<span class="token punctuation">.</span>archive<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>parentId<span class="token operator">:</span><span class="token string">"20240531101054"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>parentId<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>category<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//只返回部分字段</span>
db<span class="token punctuation">.</span>archive<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>parentId<span class="token operator">:</span><span class="token string">"20240531101058"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/fb/ca/WRRNR4CQ_o.png" alt="在这里插入图片描述"></p> 
<p>更新数据如下，只需要10ms</p> 
<pre><code class="prism language-java">db<span class="token punctuation">.</span>archive<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span>
    <span class="token punctuation">{<!-- --></span> parentId<span class="token operator">:</span> <span class="token string">"20240531101059"</span><span class="token punctuation">,</span>category<span class="token operator">:</span><span class="token string">"score1"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> $set<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> content<span class="token operator">:</span> <span class="token string">"cbasbsadhpasdbsaodgsscore"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/93/10/CndVVDDv_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="7_241"></a>7，压测</h5> 
<p>以下压测都是数据达到1亿之后进行测试的，并且都是使用的2核4g的服务器</p> 
<p>在1s内同时1000个线程插入数据，每个线程插入20条数据，中位数24，吞吐量391</p> 
<p><img src="https://images2.imgbox.com/2d/c1/SXe69M0f_o.png" alt="在这里插入图片描述"></p> 
<p>在1s内10000个线程插入数据，也是每个线程批量插入20条数据，可以发现就算是2核4g这么垃圾的轻量级服务器，10000qps也是毫无压力的</p> 
<p><img src="https://images2.imgbox.com/d4/01/3vfhqUSJ_o.png" alt="在这里插入图片描述"></p> 
<p>插入数据会破坏索引，相对于修改和查询是更慢的，接下来测试1s内10000个线程同时执行增改查，吞吐量可以达到2251.7</p> 
<p><img src="https://images2.imgbox.com/4c/f3/olMdijzw_o.png" alt="在这里插入图片描述"></p> 
<p>部分代码片段如下，让10000个线程随机的执行增改查的操作，在1s内是毫无压力的</p> 
<p><img src="https://images2.imgbox.com/de/c8/4JZe60L1_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="8_266"></a>8，总结</h5> 
<p>通过上面的数据以及mongodb的响应来看，mongodb的性能还是非常不错的。看看GPT对这种数据的评价，gpt也认为mongodb是非常合适的。当然不管什么数据和业务，只要其本质是 json 数据，不管json内部结构多复杂，用mongodb都是非常合适的。mongodb还适合存一些订单数据，地理数据，大数据等等，其应用范围是非常广泛的</p> 
<p><img src="https://images2.imgbox.com/92/3d/yA1No3ZL_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8435482b5c317213fc470a784b484fd9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Parallels Desktop 19 怎么破解激活免费赠送Parallels Desktop 19 for Mac密钥</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9cc683554d10597147b898faa9c143c1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL 数据类型详解：TINYINT、INT 和 BIGINT</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>