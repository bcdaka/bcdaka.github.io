<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>全面指南：用户行为从前端数据采集到实时处理的最佳实践 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/aeff330dc553e373c21d6ebe67352493/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="全面指南：用户行为从前端数据采集到实时处理的最佳实践">
  <meta property="og:description" content="引言
在当今的数据驱动世界，实时数据采集和处理已经成为企业做出及时决策的重要手段。本文将详细介绍如何通过前端JavaScript代码采集用户行为数据、利用API和Kafka进行数据传输、通过Flink实时处理数据的完整流程。无论你是想提升产品体验还是做用户行为分析，这篇文章都将为你提供全面的解决方案。
设计一个通用的ClickHouse表来存储用户事件时，需要考虑多种因素，包括事件类型、时间戳、用户信息、设备信息、地理位置、页面信息等。这个设计应具有扩展性和灵活性，以便支持未来可能添加的新事件类型或字段。
以下是一个通用的ClickHouse表设计示例：
表名：user_events CREATE TABLE user_events ( -- 基础信息 event_id UInt64, -- 事件唯一标识符 user_id String, -- 用户ID event_type String, -- 事件类型 (如 &#34;click&#34;, &#34;view&#34;, &#34;purchase&#34; 等) event_timestamp DateTime64(3), -- 事件发生时间，精确到毫秒 session_id String, -- 会话ID，用于追踪用户在一个会话中的所有活动 page_url String, -- 事件发生的页面URL referrer_url String, -- 事件发生前的来源页面URL -- 设备信息 device_type String, -- 设备类型 (如 &#34;desktop&#34;, &#34;mobile&#34;, &#34;tablet&#34;) os String, -- 操作系统 (如 &#34;Windows&#34;, &#34;iOS&#34;, &#34;Android&#34;) browser String, -- 浏览器类型 (如 &#34;Chrome&#34;, &#34;Safari&#34;) app_version String, -- 应用版本号（如果是移动应用） -- 地理位置信息 country String, -- 国家 region String, -- 省/州/地区 city String, -- 城市 ip_address String, -- 用户IP地址 -- 事件详细信息 product_id String DEFAULT &#39;&#39;, -- 产品ID (如事件涉及到某个产品) category_id String DEFAULT &#39;&#39;, -- 分类ID (如产品或内容的分类) campaign_id String DEFAULT &#39;&#39;, -- 广告活动ID (如涉及到营销活动) custom_data String DEFAULT &#39;&#39;, -- 自定义数据，存储JSON格式的额外信息 -- 索引和分区 PRIMARY KEY (event_id), -- 主键，用于唯一标识每个事件 INDEX idx_user_id (user_id) TYPE set(1024) GRANULARITY 3, -- 基于用户ID的索引，加速查询 INDEX idx_event_type (event_type) TYPE set(256) GRANULARITY 3, -- 基于事件类型的索引 INDEX idx_event_timestamp (event_timestamp) TYPE minmax GRANULARITY 1 -- 基于时间戳的索引 ) ENGINE = MergeTree() PARTITION BY toYYYYMM(event_timestamp) -- 按照事件发生的月份进行分区 ORDER BY (event_timestamp, user_id, event_type) -- 排序键，优化查询 TTL event_timestamp &#43; INTERVAL 1 YEAR DELETE -- 数据存储期限为1年，自动删除过期数据 SETTINGS index_granularity = 8192; -- 索引粒度设置 设计说明 基础信息">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-08T18:27:58+08:00">
    <meta property="article:modified_time" content="2024-08-08T18:27:58+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">全面指南：用户行为从前端数据采集到实时处理的最佳实践</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>引言<br> 在当今的数据驱动世界，实时数据采集和处理已经成为企业做出及时决策的重要手段。本文将详细介绍如何通过前端JavaScript代码采集用户行为数据、利用API和Kafka进行数据传输、通过Flink实时处理数据的完整流程。无论你是想提升产品体验还是做用户行为分析，这篇文章都将为你提供全面的解决方案。</p> 
<p>设计一个通用的ClickHouse表来存储用户事件时，需要考虑多种因素，包括事件类型、时间戳、用户信息、设备信息、地理位置、页面信息等。这个设计应具有扩展性和灵活性，以便支持未来可能添加的新事件类型或字段。</p> 
<p>以下是一个通用的ClickHouse表设计示例：</p> 
<h4><a id="user_events_7"></a>表名：<code>user_events</code></h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_events <span class="token punctuation">(</span>
    <span class="token comment">-- 基础信息</span>
    event_id        UInt64<span class="token punctuation">,</span>                      <span class="token comment">-- 事件唯一标识符</span>
    user_id         String<span class="token punctuation">,</span>                      <span class="token comment">-- 用户ID</span>
    event_type      String<span class="token punctuation">,</span>                      <span class="token comment">-- 事件类型 (如 "click", "view", "purchase" 等)</span>
    event_timestamp DateTime64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token comment">-- 事件发生时间，精确到毫秒</span>
    session_id      String<span class="token punctuation">,</span>                      <span class="token comment">-- 会话ID，用于追踪用户在一个会话中的所有活动</span>
    page_url        String<span class="token punctuation">,</span>                      <span class="token comment">-- 事件发生的页面URL</span>
    referrer_url    String<span class="token punctuation">,</span>                      <span class="token comment">-- 事件发生前的来源页面URL</span>

    <span class="token comment">-- 设备信息</span>
    device_type     String<span class="token punctuation">,</span>                      <span class="token comment">-- 设备类型 (如 "desktop", "mobile", "tablet")</span>
    os              String<span class="token punctuation">,</span>                      <span class="token comment">-- 操作系统 (如 "Windows", "iOS", "Android")</span>
    browser         String<span class="token punctuation">,</span>                      <span class="token comment">-- 浏览器类型 (如 "Chrome", "Safari")</span>
    app_version     String<span class="token punctuation">,</span>                      <span class="token comment">-- 应用版本号（如果是移动应用）</span>

    <span class="token comment">-- 地理位置信息</span>
    country         String<span class="token punctuation">,</span>                      <span class="token comment">-- 国家</span>
    region          String<span class="token punctuation">,</span>                      <span class="token comment">-- 省/州/地区</span>
    city            String<span class="token punctuation">,</span>                      <span class="token comment">-- 城市</span>
    ip_address      String<span class="token punctuation">,</span>                      <span class="token comment">-- 用户IP地址</span>

    <span class="token comment">-- 事件详细信息</span>
    product_id      String <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>           <span class="token comment">-- 产品ID (如事件涉及到某个产品)</span>
    category_id     String <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>           <span class="token comment">-- 分类ID (如产品或内容的分类)</span>
    campaign_id     String <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>           <span class="token comment">-- 广告活动ID (如涉及到营销活动)</span>
    custom_data     String <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>           <span class="token comment">-- 自定义数据，存储JSON格式的额外信息</span>

    <span class="token comment">-- 索引和分区</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>event_id<span class="token punctuation">)</span><span class="token punctuation">,</span>                      <span class="token comment">-- 主键，用于唯一标识每个事件</span>
    <span class="token keyword">INDEX</span> idx_user_id <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">TYPE</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> GRANULARITY <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment">-- 基于用户ID的索引，加速查询</span>
    <span class="token keyword">INDEX</span> idx_event_type <span class="token punctuation">(</span>event_type<span class="token punctuation">)</span> <span class="token keyword">TYPE</span> <span class="token keyword">set</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> GRANULARITY <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment">-- 基于事件类型的索引</span>
    <span class="token keyword">INDEX</span> idx_event_timestamp <span class="token punctuation">(</span>event_timestamp<span class="token punctuation">)</span> <span class="token keyword">TYPE</span> minmax GRANULARITY <span class="token number">1</span> <span class="token comment">-- 基于时间戳的索引</span>
<span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> MergeTree<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> toYYYYMM<span class="token punctuation">(</span>event_timestamp<span class="token punctuation">)</span>           <span class="token comment">-- 按照事件发生的月份进行分区</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>event_timestamp<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> event_type<span class="token punctuation">)</span>  <span class="token comment">-- 排序键，优化查询</span>
TTL event_timestamp <span class="token operator">+</span> <span class="token keyword">INTERVAL</span> <span class="token number">1</span> <span class="token keyword">YEAR</span> <span class="token keyword">DELETE</span>     <span class="token comment">-- 数据存储期限为1年，自动删除过期数据</span>
SETTINGS index_granularity <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span>               <span class="token comment">-- 索引粒度设置</span>
</code></pre> 
<h4><a id="_51"></a>设计说明</h4> 
<ol><li> <p><strong>基础信息</strong></p> 
  <ul><li><code>event_id</code>: 用于唯一标识每个事件，通常是自增或UUID。</li><li><code>user_id</code>: 用户的唯一标识符，可能是用户ID或匿名ID。</li><li><code>event_type</code>: 描述事件类型，如点击、浏览、购买等。</li><li><code>event_timestamp</code>: 记录事件发生的精确时间，使用<code>DateTime64(3)</code>支持毫秒级别的时间精度。</li><li><code>session_id</code>: 用于关联同一会话中的所有事件。</li></ul> </li><li> <p><strong>设备信息</strong></p> 
  <ul><li><code>device_type</code>, <code>os</code>, <code>browser</code>, <code>app_version</code>: 这些字段用于描述用户的设备、操作系统、浏览器等信息。</li></ul> </li><li> <p><strong>地理位置信息</strong></p> 
  <ul><li><code>country</code>, <code>region</code>, <code>city</code>, <code>ip_address</code>: 用于记录用户的地理位置信息，可以帮助进行区域分析。</li></ul> </li><li> <p><strong>事件详细信息</strong></p> 
  <ul><li><code>product_id</code>, <code>category_id</code>, <code>campaign_id</code>: 如果事件涉及到特定的产品、分类或营销活动，这些字段用于存储相关ID。</li><li><code>custom_data</code>: 以JSON格式存储额外的自定义数据，提供灵活性以支持将来可能的新需求。</li></ul> </li><li> <p><strong>索引和分区</strong></p> 
  <ul><li>索引设计通过对用户ID、事件类型和时间戳建立索引，加速常见的查询场景。</li><li>分区按月份分区，便于管理和查询大规模数据集。</li><li><code>TTL</code> 设置用于自动删除超过一年的旧数据，确保数据表的存储不会无限增长。</li></ul> </li><li> <p><strong>扩展性</strong></p> 
  <ul><li>设计中保留了<code>custom_data</code>字段，以支持将来可能的额外数据字段。</li><li>可以根据业务需求，进一步调整字段或添加新的字段。</li></ul> </li></ol> 
<p>这个表结构设计能够支持广泛的用户事件记录和查询需求，适用于各种分析场景。</p> 
<p>用户的7日访问、流失等指标通常用于分析用户的活跃度、留存率和流失情况。这类指标可以帮助你理解用户在一段时间内的行为，进而优化产品体验。以下是20个常见的用户行为分析指标，以及相应的SQL查询示例。</p> 
<h4><a id="1_7_7Day_Active_Users_83"></a>1. <strong>7日活跃用户数 (7-Day Active Users)</strong></h4> 
<ul><li><strong>指标描述</strong>：过去7天内至少访问过一次的用户数。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> user_activity
<span class="token keyword">WHERE</span> activity_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="2_7_7Day_Retention_Rate_92"></a>2. <strong>7日留存率 (7-Day Retention Rate)</strong></h4> 
<ul><li><strong>指标描述</strong>：在第1天注册的用户中，7天后仍然活跃的用户比例。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t2<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t1<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token keyword">AS</span> retention_rate
<span class="token keyword">FROM</span> 
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> user_activity <span class="token keyword">WHERE</span> activity_date <span class="token operator">=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span> t1
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> 
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> user_activity <span class="token keyword">WHERE</span> activity_date <span class="token operator">=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> t2
<span class="token keyword">ON</span> t1<span class="token punctuation">.</span>user_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="3_7_7Day_Churn_Rate_105"></a>3. <strong>7日流失率 (7-Day Churn Rate)</strong></h4> 
<ul><li><strong>指标描述</strong>：在过去7天内不再访问的用户比例。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t1<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t2<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t1<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token keyword">AS</span> churn_rate
<span class="token keyword">FROM</span> 
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> user_activity <span class="token keyword">WHERE</span> activity_date <span class="token operator">=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span> t1
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> 
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> user_activity <span class="token keyword">WHERE</span> activity_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">6</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span> t2
<span class="token keyword">ON</span> t1<span class="token punctuation">.</span>user_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="4__Active_User_Ratio_118"></a>4. <strong>活跃用户比率 (Active User Ratio)</strong></h4> 
<ul><li><strong>指标描述</strong>：活跃用户数与总用户数的比例。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span> <span class="token keyword">FROM</span> users<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token keyword">AS</span> active_user_ratio
<span class="token keyword">FROM</span> user_activity
<span class="token keyword">WHERE</span> activity_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="5_7_New_User_7Day_Retention_Rate_128"></a>5. <strong>新用户7日留存率 (New User 7-Day Retention Rate)</strong></h4> 
<ul><li><strong>指标描述</strong>：在过去7天内注册的新用户中，7天后仍然活跃的用户比例。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t2<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t1<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token keyword">AS</span> new_user_retention_rate
<span class="token keyword">FROM</span> 
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> registration_date <span class="token operator">=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span> t1
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> 
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> user_activity <span class="token keyword">WHERE</span> activity_date <span class="token operator">=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> t2
<span class="token keyword">ON</span> t1<span class="token punctuation">.</span>user_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="6_7_7Day_Return_Rate_141"></a>6. <strong>7日回访率 (7-Day Return Rate)</strong></h4> 
<ul><li><strong>指标描述</strong>：过去7天内访问过的用户在7天后再度访问的比例。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t2<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> t1<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token keyword">AS</span> return_rate
<span class="token keyword">FROM</span> 
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> user_activity <span class="token keyword">WHERE</span> activity_date <span class="token operator">=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span> t1
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> 
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id <span class="token keyword">FROM</span> user_activity <span class="token keyword">WHERE</span> activity_date <span class="token operator">=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">6</span> <span class="token keyword">DAY</span><span class="token punctuation">)</span> t2
<span class="token keyword">ON</span> t1<span class="token punctuation">.</span>user_id <span class="token operator">=</span> t2<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="7_7_Average_Visits_in_7_Days_154"></a>7. <strong>7日内用户平均访问次数 (Average Visits in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：用户在过去7天内的平均访问次数。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
    <span class="token function">AVG</span><span class="token punctuation">(</span>visits<span class="token punctuation">)</span> <span class="token keyword">AS</span> average_visits
<span class="token keyword">FROM</span> 
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> visits 
     <span class="token keyword">FROM</span> user_activity 
     <span class="token keyword">WHERE</span> activity_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span> 
     <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">)</span> t<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="8_7_Total_Visits_in_7_Days_167"></a>8. <strong>7日内总访问次数 (Total Visits in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：过去7天内的总访问次数。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> total_visits
<span class="token keyword">FROM</span> user_activity
<span class="token keyword">WHERE</span> activity_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="9__Daily_Active_Users_DAU_176"></a>9. <strong>每日活跃用户数 (Daily Active Users, DAU)</strong></h4> 
<ul><li><strong>指标描述</strong>：每天访问过网站的独立用户数。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> activity_date<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> daily_active_users
<span class="token keyword">FROM</span> user_activity
<span class="token keyword">WHERE</span> activity_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> activity_date<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="10_7_New_Users_in_7_Days_186"></a>10. <strong>7日内新用户数 (New Users in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：过去7天内注册的新用户数。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> new_users
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> registration_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="11_7_User_Engagement_in_7_Days_195"></a>11. <strong>7日内用户参与度 (User Engagement in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：用户在过去7天内的互动行为数量（如点击、点赞、评论等）。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> engagement
<span class="token keyword">FROM</span> user_engagement
<span class="token keyword">WHERE</span> engagement_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="12_7_Churned_Users_in_7_Days_204"></a>12. <strong>7日内流失用户数 (Churned Users in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：过去7天内没有再访问的用户数。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> churned_users
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> last_activity_date <span class="token operator">&lt;</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="13_7_Page_Views_in_7_Days_213"></a>13. <strong>7日内页面浏览量 (Page Views in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：过去7天内的页面浏览总数。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> page_views
<span class="token keyword">FROM</span> page_views
<span class="token keyword">WHERE</span> view_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="14_7_Average_Page_Views_in_7_Days_222"></a>14. <strong>7日内平均页面浏览量 (Average Page Views in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：用户在过去7天内的平均页面浏览次数。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>page_views<span class="token punctuation">)</span> <span class="token keyword">AS</span> average_page_views
<span class="token keyword">FROM</span> 
    <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> page_views 
     <span class="token keyword">FROM</span> page_views 
     <span class="token keyword">WHERE</span> view_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span> 
     <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">)</span> t<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="15_7_Churned_User_Rate_in_7_Days_234"></a>15. <strong>7日内用户流失比率 (Churned User Rate in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：过去7天内流失用户占总用户的比率。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
    <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span> <span class="token keyword">FROM</span> users<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token keyword">AS</span> churned_user_rate
<span class="token keyword">FROM</span> users
<span class="token keyword">WHERE</span> last_activity_date <span class="token operator">&lt;</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="16_7_Active_Days_in_7_Days_244"></a>16. <strong>7日内用户活跃天数 (Active Days in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：用户在过去7天内的活跃天数。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> activity_date<span class="token punctuation">)</span> <span class="token keyword">AS</span> active_days
<span class="token keyword">FROM</span> user_activity
<span class="token keyword">WHERE</span> activity_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="17_7_Visit_Frequency_in_7_Days_254"></a>17. <strong>7日内用户访问频率 (Visit Frequency in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：用户在过去7天内的访问频率。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">7.0</span> <span class="token keyword">AS</span> visit_frequency
<span class="token keyword">FROM</span> user_activity
<span class="token keyword">WHERE</span> activity_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="18_7_Clicks_in_7_Days_264"></a>18. <strong>7日内用户点击次数 (Clicks in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：用户在过去7天内的总点击次数。</li><li><strong>SQL示例</strong>：<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> user_id<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> clicks
<span class="token keyword">FROM</span> user_clicks
<span class="token keyword">WHERE</span> click_date <span class="token operator">&gt;=</span> CURDATE<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token number">7</span> <span class="token keyword">DAY</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> user_id<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="19_7_Engagement_Score_in_7_Days_274"></a>19. <strong>7日内用户参与度得分 (Engagement Score in 7 Days)</strong></h4> 
<ul><li><strong>指标描述</strong>：根据用户在过去7</li></ul> 
<p>在前端展现用户事件数据时，可以使用一些流行的开源库来可视化和展示这些数据。以下是几个适合的数据展示和可视化的开源库：</p> 
<h4><a id="1_Grafanahttpsgrafanacom_280"></a>1. <strong><a href="https://grafana.com/" rel="nofollow">Grafana</a></strong></h4> 
<ul><li><strong>用途</strong>：Grafana 是一个开源的仪表盘工具，适用于监控和数据分析。你可以将 ClickHouse 作为数据源，并使用 Grafana 来创建实时仪表盘，展示用户事件数据。</li><li><strong>特点</strong>： 
  <ul><li>支持多种图表类型：折线图、柱状图、饼图等。</li><li>可自定义的仪表盘和告警机制。</li><li>强大的查询编辑器，支持 SQL 查询。</li></ul> </li></ul> 
<h4><a id="2_Apache_Supersethttpssupersetapacheorg_287"></a>2. <strong><a href="https://superset.apache.org/" rel="nofollow">Apache Superset</a></strong></h4> 
<ul><li><strong>用途</strong>：Apache Superset 是一个开源的数据探索和可视化平台，支持 ClickHouse 等多种数据库。它可以帮助你快速构建复杂的查询和数据可视化仪表盘。</li><li><strong>特点</strong>： 
  <ul><li>直观的拖拽式界面，适合构建自定义报表和仪表盘。</li><li>支持多种可视化组件：图表、地图、表格等。</li><li>强大的 SQL Lab 功能，支持编写和运行 SQL 查询。</li></ul> </li></ul> 
<h4><a id="3_Metabasehttpswwwmetabasecom_294"></a>3. <strong><a href="https://www.metabase.com/" rel="nofollow">Metabase</a></strong></h4> 
<ul><li><strong>用途</strong>：Metabase 是一个简单易用的开源商业智能工具，可以帮助团队快速创建数据问答、图表和仪表盘，支持多种数据库。</li><li><strong>特点</strong>： 
  <ul><li>无需编写代码即可创建问题和仪表盘，适合非技术用户。</li><li>支持将查询结果嵌入到其他应用或网站中。</li><li>可以与 ClickHouse 集成，并生成各种可视化图表。</li></ul> </li></ul> 
<h4><a id="4_Chartjshttpswwwchartjsorg_301"></a>4. <strong><a href="https://www.chartjs.org/" rel="nofollow">Chart.js</a></strong></h4> 
<ul><li><strong>用途</strong>：Chart.js 是一个轻量级的 JavaScript 库，用于创建简单而灵活的图表。适用于直接在前端页面中展示用户事件数据。</li><li><strong>特点</strong>： 
  <ul><li>支持常见的图表类型：折线图、柱状图、饼图、雷达图等。</li><li>轻量级且易于集成，适合快速开发和展示。</li><li>提供丰富的定制选项，适合多种数据可视化需求。</li></ul> </li></ul> 
<h4><a id="5_EChartshttpsechartsapacheorg_308"></a>5. <strong><a href="https://echarts.apache.org/" rel="nofollow">ECharts</a></strong></h4> 
<ul><li><strong>用途</strong>：ECharts 是一个由 Apache 维护的强大的数据可视化库，适用于展示复杂的交互式图表和大规模数据集。</li><li><strong>特点</strong>： 
  <ul><li>支持多种复杂图表类型：热力图、关系图、地图等。</li><li>强大的交互功能，适合展示用户行为和事件流。</li><li>与 ClickHouse 集成后，可以轻松处理大规模数据展示。</li></ul> </li></ul> 
<h4><a id="6_D3jshttpsd3jsorg_315"></a>6. <strong><a href="https://d3js.org/" rel="nofollow">D3.js</a></strong></h4> 
<ul><li><strong>用途</strong>：D3.js 是一个功能强大的 JavaScript 库，用于基于数据生成动态和交互式图表。适合自定义复杂的用户事件数据可视化。</li><li><strong>特点</strong>： 
  <ul><li>强大的数据绑定和操纵功能，适合高度自定义的可视化需求。</li><li>支持创建从基本到复杂的各种图表。</li><li>与其他前端框架（如 React、Vue）无缝集成。</li></ul> </li></ul> 
<h4><a id="7_Redashhttpsredashio_322"></a>7. <strong><a href="https://redash.io/" rel="nofollow">Redash</a></strong></h4> 
<ul><li><strong>用途</strong>：Redash 是一个开源的数据查询和可视化工具，支持多种数据源，包括 ClickHouse。适合创建共享的查询和数据仪表盘。</li><li><strong>特点</strong>： 
  <ul><li>直观的查询构建界面，支持 SQL 查询。</li><li>可以轻松创建和分享数据可视化结果。</li><li>支持告警、嵌入式仪表盘等功能。</li></ul> </li></ul> 
<h4><a id="8_Kibanahttpswwwelasticcokibana_329"></a>8. <strong><a href="https://www.elastic.co/kibana/" rel="nofollow">Kibana</a></strong></h4> 
<ul><li><strong>用途</strong>：Kibana 是 Elasticsearch 的可视化工具，但也可以通过插件支持 ClickHouse。适用于实时数据监控和分析。</li><li><strong>特点</strong>： 
  <ul><li>强大的日志和时间序列分析能力。</li><li>支持多种数据可视化和仪表盘创建。</li><li>与 Elastic Stack 无缝集成，适合大数据环境。</li></ul> </li></ul> 
<h4><a id="_336"></a>选择建议：</h4> 
<ul><li>如果你需要快速构建可视化仪表盘，并且不想投入太多前端开发工作，<strong>Grafana</strong>、<strong>Metabase</strong> 或 <strong>Superset</strong> 是不错的选择。</li><li>如果你需要在已有的网站或应用中嵌入可视化组件，<strong>Chart.js</strong> 和 <strong>ECharts</strong> 可能更适合。</li><li>如果你需要高度定制化的可视化效果，<strong>D3.js</strong> 提供了最大的灵活性。</li></ul> 
<p>这些工具和库可以帮助你将用户事件数据以直观的方式展示出来，从而更好地理解用户行为并优化产品体验。</p> 
<h4><a id="_343"></a>一、前端数据采集：捕捉用户行为</h4> 
<p>数据采集的第一步是在用户与网页互动时捕捉各种行为事件，如点击、页面浏览等。我们可以通过JavaScript代码监听这些事件并将数据发送到后端。</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">function</span> <span class="token function">sendEvent</span><span class="token punctuation">(</span><span class="token parameter">eventType<span class="token punctuation">,</span> additionalData <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> eventData <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">userId</span><span class="token operator">:</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取用户ID的函数</span>
            <span class="token literal-property property">sessionId</span><span class="token operator">:</span> <span class="token function">getSessionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取会话ID的函数</span>
            <span class="token literal-property property">eventType</span><span class="token operator">:</span> eventType<span class="token punctuation">,</span>
            <span class="token literal-property property">pageUrl</span><span class="token operator">:</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
            <span class="token literal-property property">referrerUrl</span><span class="token operator">:</span> document<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span>
            <span class="token literal-property property">eventTimestamp</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">deviceType</span><span class="token operator">:</span> <span class="token function">getDeviceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取设备类型的函数</span>
            <span class="token literal-property property">os</span><span class="token operator">:</span> <span class="token function">getOS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取操作系统的函数</span>
            <span class="token literal-property property">browser</span><span class="token operator">:</span> <span class="token function">getBrowser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 获取浏览器类型的函数</span>
            <span class="token operator">...</span>additionalData <span class="token comment">// 额外的自定义数据</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">// 通过API发送数据</span>
        <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://your-api-endpoint.com/collect'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>eventData<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 示例：监听页面加载事件</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">sendEvent</span><span class="token punctuation">(</span><span class="token string">'page_load'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 示例：监听用户点击事件</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">sendEvent</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">element</span><span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="API_383"></a>二、接收API：将事件数据传输到后端</h4> 
<p>前端数据采集后，我们需要通过API将数据传输到后端。这一步骤的API应能够高效接收和处理大量请求。</p> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> kafka <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'kafka-node'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建Kafka Producer</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">kafka<span class="token punctuation">.</span>KafkaClient</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">kafkaHost</span><span class="token operator">:</span> <span class="token string">'localhost:9092'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">kafka<span class="token punctuation">.</span>Producer</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/collect'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token keyword">const</span> payloads <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">topic</span><span class="token operator">:</span> <span class="token string">'user_events'</span><span class="token punctuation">,</span> <span class="token literal-property property">messages</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">partition</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>payloads<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Failed to send message to Kafka'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Internal Server Error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Event sent to Kafka:'</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Event received'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'API server is running on port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="KafkaFlink_422"></a>三、Kafka与Flink：实时数据处理</h4> 
<p>数据通过API进入Kafka后，可以通过Flink进行实时处理。Flink是一个流处理框架，能够处理海量实时数据，并将处理结果存储或发送到其他系统。</p> 
<h5><a id="1_Kafka_Source_426"></a>1. 配置Kafka Source</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span></span><span class="token class-name">FlinkKafkaConsumer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">SimpleStringSchema</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaFlinkConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"flink_consumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            <span class="token string">"user_events"</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            properties
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>event <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 处理逻辑，如解析JSON并统计事件</span>
                <span class="token comment">// 返回处理后的数据</span>
                <span class="token keyword">return</span> event<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 或将数据写入数据库、HDFS等</span>

        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"Flink Kafka Consumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2__460"></a>2. 实时处理逻辑</h5> 
<p>在Flink中，你可以根据具体需求实现各种数据处理逻辑。例如，实时计算用户的点击量、页面浏览量等。</p> 
<h4><a id="_463"></a>四、总结</h4> 
<p>在这篇文章中，我们从前端数据采集开始，逐步深入到数据接收、Kafka传输和Flink实时处理。通过这样一个完整的数据处理链路，企业可以实时了解用户行为，从而更快地做出决策，优化产品体验。</p> 
<p>这种架构设计不仅具有高扩展性和灵活性，还能够处理大量实时数据，为你的业务提供强大的数据支持。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fc0173fbbb0e8f094deb30699b423c59/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">论文阅读:Efficient Core Maintenance in Large Bipartite Graphs | SIGMOD 2024</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/94631171e13091f96a18855353a880a3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深入了解C语言中的按位逻辑运算</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>