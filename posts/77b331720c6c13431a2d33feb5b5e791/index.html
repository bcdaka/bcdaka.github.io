<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>大数据技术之HBase（超级详细） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/77b331720c6c13431a2d33feb5b5e791/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="大数据技术之HBase（超级详细）">
  <meta property="og:description" content="大数据技术之HBase 第1章 HBase简介 1.1 什么是HBase HBase的原型是Google的BigTable论文，受到了该论文思想的启发，目前作为Hadoop的子项目来开发维护，用于支持结构化的数据存储。
官方网站：http://hbase.apache.org
– 2006年Google发表BigTable白皮书
– 2006年开始开发HBase
– 2008年北京成功开奥运会，程序员默默地将HBase弄成了Hadoop的子项目
– 2010年HBase成为Apache顶级项目
– 现在很多公司二次开发出了很多发行版本，你也开始使用了。
HBase是一个高可靠性、高性能、面向列、可伸缩的分布式存储系统，利用HBASE技术可在廉价PC Server上搭建起大规模结构化存储集群。
HBase的目标是存储并处理大型的数据，更具体来说是仅需使用普通的硬件配置，就能够处理由成千上万的行和列所组成的大型数据。
HBase是Google Bigtable的开源实现，但是也有很多不同之处。比如：Google Bigtable利用GFS作为其文件存储系统，HBase利用Hadoop HDFS作为其文件存储系统；Google运行MAPREDUCE来处理Bigtable中的海量数据，HBase同样利用Hadoop MapReduce来处理HBase中的海量数据；Google Bigtable利用Chubby作为协同服务，HBase利用Zookeeper作为对应。
1.2 HBase特点 1）海量存储
Hbase适合存储PB级别的海量数据，在PB级别的数据以及采用廉价PC存储的情况下，能在几十到百毫秒内返回数据。这与Hbase的极易扩展性息息相关。正式因为Hbase良好的扩展性，才为海量数据的存储提供了便利。
2）列式存储
这里的列式存储其实说的是列族存储，Hbase是根据列族来存储数据的。列族下面可以有非常多的列，列族在创建表的时候就必须指定。
3）极易扩展
Hbase的扩展性主要体现在两个方面，一个是基于上层处理能力（RegionServer）的扩展，一个是基于存储的扩展（HDFS）。
通过横向添加RegionSever的机器，进行水平扩展，提升Hbase上层的处理能力，提升Hbsae服务更多Region的能力。
备注：RegionServer的作用是管理region、承接业务的访问，这个后面会详细的介绍通过横向添加Datanode的机器，进行存储层扩容，提升Hbase的数据存储能力和提升后端存储的读写能力。
4）高并发
由于目前大部分使用Hbase的架构，都是采用的廉价PC，因此单个IO的延迟其实并不小，一般在几十到上百ms之间。这里说的高并发，主要是在并发的情况下，Hbase的单个IO延迟下降并不多。能获得高并发、低延迟的服务。
5）稀疏
稀疏主要是针对Hbase列的灵活性，在列族中，你可以指定任意多的列，在列数据为空的情况下，是不会占用存储空间的。
从图中可以看出Hbase是由Client、Zookeeper、Master、HRegionServer、HDFS等几个组件组成，下面来介绍一下几个组件的相关功能：
1）Client
Client包含了访问Hbase的接口，另外Client还维护了对应的cache来加速Hbase的访问，比如cache的.META.元数据的信息。
2）Zookeeper
HBase通过Zookeeper来做master的高可用、RegionServer的监控、元数据的入口以及集群配置的维护等工作。具体工作如下：
通过Zoopkeeper来保证集群中只有1个master在运行，如果master异常，会通过竞争机制产生新的master提供服务
通过Zoopkeeper来监控RegionServer的状态，当RegionSevrer有异常的时候，通过回调的形式通知Master RegionServer上下线的信息
通过Zoopkeeper存储元数据的统一入口地址
3）Hmaster
master节点的主要职责如下：
为RegionServer分配Region
维护整个集群的负载均衡
维护集群的元数据信息
发现失效的Region，并将失效的Region分配到正常的RegionServer上
当RegionSever失效的时候，协调对应Hlog的拆分
4）HregionServer
HregionServer直接对接用户的读写请求，是真正的“干活”的节点。它的功能概括如下：
管理master为其分配的Region
处理来自客户端的读写请求
负责和底层HDFS的交互，存储数据到HDFS
负责Region变大以后的拆分
负责Storefile的合并工作
5）HDFS
HDFS为Hbase提供最终的底层数据存储服务，同时为HBase提供高可用（Hlog存储在HDFS）的支持，具体功能概括如下：
提供元数据和表数据的底层分布式存储服务
数据多副本，保证的高可靠和高可用性
1.3 HBase中的角色 1.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-03-09T09:42:17+08:00">
    <meta property="article:modified_time" content="2023-03-09T09:42:17+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">大数据技术之HBase（超级详细）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="HBase_0"></a>大数据技术之HBase</h2> 
<h4><a id="1_HBase_1"></a>第1章 HBase简介</h4> 
<h5><a id="11_HBase_2"></a>1.1 什么是HBase</h5> 
<p>HBase的原型是Google的BigTable论文，受到了该论文思想的启发，目前作为Hadoop的子项目来开发维护，用于支持结构化的数据存储。<br> 官方网站：http://hbase.apache.org<br> – 2006年Google发表BigTable白皮书<br> – 2006年开始开发HBase<br> – 2008年北京成功开奥运会，程序员默默地将HBase弄成了Hadoop的子项目<br> – 2010年HBase成为Apache顶级项目<br> – 现在很多公司二次开发出了很多发行版本，你也开始使用了。<br> HBase是一个高可靠性、高性能、面向列、可伸缩的分布式存储系统，利用HBASE技术可在廉价PC Server上搭建起大规模结构化存储集群。<br> HBase的目标是存储并处理大型的数据，更具体来说是仅需使用普通的硬件配置，就能够处理由成千上万的行和列所组成的大型数据。<br> HBase是Google Bigtable的开源实现，但是也有很多不同之处。比如：Google Bigtable利用GFS作为其文件存储系统，HBase利用Hadoop HDFS作为其文件存储系统；Google运行MAPREDUCE来处理Bigtable中的海量数据，HBase同样利用Hadoop MapReduce来处理HBase中的海量数据；Google Bigtable利用Chubby作为协同服务，HBase利用Zookeeper作为对应。</p> 
<h5><a id="12_HBase_13"></a>1.2 HBase特点</h5> 
<p><strong>1）海量存储</strong><br> Hbase适合存储PB级别的海量数据，在PB级别的数据以及采用廉价PC存储的情况下，能在几十到百毫秒内返回数据。这与Hbase的极易扩展性息息相关。正式因为Hbase良好的扩展性，才为海量数据的存储提供了便利。<br> <strong>2）列式存储</strong><br> 这里的列式存储其实说的是列族存储，Hbase是根据列族来存储数据的。列族下面可以有非常多的列，列族在创建表的时候就必须指定。<br> <strong>3）极易扩展</strong><br> Hbase的扩展性主要体现在两个方面，一个是基于上层处理能力（RegionServer）的扩展，一个是基于存储的扩展（HDFS）。<br> 通过横向添加RegionSever的机器，进行水平扩展，提升Hbase上层的处理能力，提升Hbsae服务更多Region的能力。<br> 备注：RegionServer的作用是管理region、承接业务的访问，这个后面会详细的介绍通过横向添加Datanode的机器，进行存储层扩容，提升Hbase的数据存储能力和提升后端存储的读写能力。<br> <strong>4）高并发</strong><br> 由于目前大部分使用Hbase的架构，都是采用的廉价PC，因此单个IO的延迟其实并不小，一般在几十到上百ms之间。这里说的高并发，主要是在并发的情况下，Hbase的单个IO延迟下降并不多。能获得高并发、低延迟的服务。<br> <strong>5）稀疏</strong><br> 稀疏主要是针对Hbase列的灵活性，在列族中，你可以指定任意多的列，在列数据为空的情况下，是不会占用存储空间的。<br> <img src="https://images2.imgbox.com/c3/d5/ooO0egkG_o.png" alt="在这里插入图片描述"><br> 从图中可以看出Hbase是由Client、Zookeeper、Master、HRegionServer、HDFS等几个组件组成，下面来介绍一下几个组件的相关功能：<br> <strong>1）Client</strong><br> Client包含了访问Hbase的接口，另外Client还维护了对应的cache来加速Hbase的访问，比如cache的.META.元数据的信息。<br> <strong>2）Zookeeper</strong><br> HBase通过Zookeeper来做master的高可用、RegionServer的监控、元数据的入口以及集群配置的维护等工作。具体工作如下：<br> 通过Zoopkeeper来保证集群中只有1个master在运行，如果master异常，会通过竞争机制产生新的master提供服务<br> 通过Zoopkeeper来监控RegionServer的状态，当RegionSevrer有异常的时候，通过回调的形式通知Master RegionServer上下线的信息<br> 通过Zoopkeeper存储元数据的统一入口地址<br> <strong>3）Hmaster</strong><br> master节点的主要职责如下：<br> 为RegionServer分配Region<br> 维护整个集群的负载均衡<br> 维护集群的元数据信息<br> 发现失效的Region，并将失效的Region分配到正常的RegionServer上<br> 当RegionSever失效的时候，协调对应Hlog的拆分<br> <strong>4）HregionServer</strong><br> HregionServer直接对接用户的读写请求，是真正的“干活”的节点。它的功能概括如下：<br> 管理master为其分配的Region<br> 处理来自客户端的读写请求<br> 负责和底层HDFS的交互，存储数据到HDFS<br> 负责Region变大以后的拆分<br> 负责Storefile的合并工作<br> <strong>5）HDFS</strong><br> HDFS为Hbase提供最终的底层数据存储服务，同时为HBase提供高可用（Hlog存储在HDFS）的支持，具体功能概括如下：<br> 提供元数据和表数据的底层分布式存储服务<br> 数据多副本，保证的高可靠和高可用性</p> 
<h5><a id="13_HBase_53"></a>1.3 HBase中的角色</h5> 
<h5><a id="131_HMaster_54"></a>1.3.1 HMaster</h5> 
<p>功能<br> 1．监控RegionServer<br> 2．处理RegionServer故障转移<br> 3．处理元数据的变更<br> 4．处理region的分配或转移<br> 5．在空闲时间进行数据的负载均衡<br> 6．通过Zookeeper发布自己的位置给客户端<br> 1.3.2 RegionServer<br> <strong>功能：</strong><br> 1．负责存储HBase的实际数据<br> 2．处理分配给它的Region<br> 3．刷新缓存到HDFS<br> 4．维护Hlog<br> 5．执行压缩<br> 6．负责处理Region分片</p> 
<h5><a id="123__70"></a>1.2.3 其他组件</h5> 
<p><strong>1．Write-Ahead logs</strong><br> HBase的修改记录，当对HBase读写数据的时候，数据不是直接写进磁盘，它会在内存中保留一段时间（时间以及数据量阈值可以设定）。但把数据保存在内存中可能有更高的概率引起数据丢失，为了解决这个问题，数据会先写在一个叫做Write-Ahead logfile的文件中，然后再写入内存中。所以在系统出现故障的时候，数据可以通过这个日志文件重建。<br> <strong>2．Region</strong><br> Hbase表的分片，HBase表会根据RowKey值被切分成不同的region存储在RegionServer中，在一个RegionServer中可以有多个不同的region。<br> <strong>3．Store</strong><br> HFile存储在Store中，一个Store对应HBase表中的一个列族。<br> 4．MemStore<br> 顾名思义，就是内存存储，位于内存中，用来保存当前的数据操作，所以当数据保存在WAL中之后，RegsionServer会在内存中存储键值对。<br> <strong>5．HFile</strong><br> 这是在磁盘上保存原始数据的实际的物理文件，是实际的存储文件。StoreFile是以Hfile的形式存储在HDFS的。</p> 
<h4><a id="2_HBase_81"></a>第2章 HBase安装</h4> 
<h5><a id="21_Zookeeper_82"></a>2.1 Zookeeper正常部署</h5> 
<p>首先保证Zookeeper集群的正常部署，并启动之：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 zookeeper-3.4.10<span class="token punctuation">]</span>$ bin/zkServer.sh start
<span class="token punctuation">[</span>atguigu@hadoop103 zookeeper-3.4.10<span class="token punctuation">]</span>$ bin/zkServer.sh start
<span class="token punctuation">[</span>atguigu@hadoop104 zookeeper-3.4.10<span class="token punctuation">]</span>$ bin/zkServer.sh start
</code></pre> 
<h5><a id="22_Hadoop_91"></a>2.2 Hadoop正常部署</h5> 
<p>Hadoop集群的正常部署并启动：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 hadoop-2.7.2<span class="token punctuation">]</span>$ sbin/start-dfs.sh
<span class="token punctuation">[</span>atguigu@hadoop103 hadoop-2.7.2<span class="token punctuation">]</span>$ sbin/start-yarn.sh
</code></pre> 
<h5><a id="23_HBase_99"></a>2.3 HBase的解压</h5> 
<p>解压HBase到指定目录：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 software<span class="token punctuation">]</span>$ <span class="token function">tar</span> -zxvf hbase-1.3.1-bin.tar.gz -C /opt/module
</code></pre> 
<h5><a id="24_HBase_106"></a>2.4 HBase的配置文件</h5> 
<p>修改HBase对应的配置文件。<br> 1）hbase-env.sh修改内容：</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/opt/module/jdk1.8.0_144
<span class="token builtin class-name">export</span> <span class="token assign-left variable">HBASE_MANAGES_ZK</span><span class="token operator">=</span>false
</code></pre> 
<p>2）hbase-site.xml修改内容：</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>     
		<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>hbase.rootdir<span class="token operator">&lt;</span>/name<span class="token operator">&gt;</span>     
		<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>hdfs://hadoop102:9000/hbase<span class="token operator">&lt;</span>/value<span class="token operator">&gt;</span>   
	<span class="token operator">&lt;</span>/property<span class="token operator">&gt;</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>   
	<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>hbase.cluster.distributed<span class="token operator">&lt;</span>/name<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>true<span class="token operator">&lt;</span>/value<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/property<span class="token operator">&gt;</span>
</code></pre> 
<pre><code class="prism language-bash">   <span class="token operator">&lt;</span><span class="token operator">!</span>-- <span class="token number">0.98</span>后的新变动，之前版本没有.port,默认端口为60000 --<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>hbase.master.port<span class="token operator">&lt;</span>/name<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>value<span class="token operator">&gt;</span><span class="token number">1600</span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/value<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/property<span class="token operator">&gt;</span>
</code></pre> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>   
		<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>hbase.zookeeper.quorum<span class="token operator">&lt;</span>/name<span class="token operator">&gt;</span>
	 <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>hadoop102:2181,hadoop103:2181,hadoop104:218<span class="token operator"><span class="token file-descriptor important">1</span>&lt;</span>/value<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/property
</code></pre> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>   
		<span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>hbase.zookeeper.property.dataDir<span class="token operator">&lt;</span>/name<span class="token operator">&gt;</span>
	     <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>/opt/module/zookeeper-3.4.10/zkData<span class="token operator">&lt;</span>/value<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>/property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/configuration<span class="token operator">&gt;</span>
</code></pre> 
<p>3）regionservers：</p> 
<pre><code class="prism language-bash">hadoop102
hadoop103
hadoop104
</code></pre> 
<p>4）软连接hadoop配置文件到hbase：</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 module<span class="token punctuation">]</span>$ <span class="token function">ln</span> -s /opt/module/hadoop-2.7.2/etc/hadoop/core-site.xml 
/opt/module/hbase/conf/core-site.xml
</code></pre> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 module<span class="token punctuation">]</span>$ <span class="token function">ln</span> -s /opt/module/hadoop-2.7.2/etc/hadoop/hdfs-site.xml 
/opt/module/hbase/conf/hdfs-site.xml
</code></pre> 
<h5><a id="25_HBase_175"></a>2.5 HBase远程发送到其他集群</h5> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 module<span class="token punctuation">]</span>$ xsync hbase/ 
</code></pre> 
<h5><a id="26_HBase_181"></a>2.6 HBase服务的启动</h5> 
<p>1．启动方式1</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 hbase<span class="token punctuation">]</span>$ bin/hbase-daemon.sh start master
<span class="token punctuation">[</span>atguigu@hadoop102 hbase<span class="token punctuation">]</span>$ bin/hbase-daemon.sh start regionserver
</code></pre> 
<p>提示：如果集群之间的节点时间不同步，会导致regionserver无法启动，抛出ClockOutOfSyncException异常。</p> 
<h4><a id="3_HBase_Shell_190"></a>第3章 HBase Shell操作</h4> 
<h5><a id="31__191"></a>3.1 基本操作</h5> 
<p>1．进入HBase客户端命令行</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 hbase<span class="token punctuation">]</span>$ bin/hbase shell
</code></pre> 
<p>2．查看帮助命令</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:001:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token builtin class-name">help</span>
</code></pre> 
<p>3．查看当前数据库中有哪些表</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:002:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> list
</code></pre> 
<p>3.2 表的操作<br> 1．创建表</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:002:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> create <span class="token string">'student'</span>,<span class="token string">'info'</span>
</code></pre> 
<p>2．插入数据到表</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:003:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> put <span class="token string">'student'</span>,<span class="token string">'1001'</span>,<span class="token string">'info:sex'</span>,<span class="token string">'male'</span>
hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:004:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> put <span class="token string">'student'</span>,<span class="token string">'1001'</span>,<span class="token string">'info:age'</span>,<span class="token string">'18'</span>
hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:005:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> put <span class="token string">'student'</span>,<span class="token string">'1002'</span>,<span class="token string">'info:name'</span>,<span class="token string">'Janna'</span>
hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:006:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> put <span class="token string">'student'</span>,<span class="token string">'1002'</span>,<span class="token string">'info:sex'</span>,<span class="token string">'female'</span>
hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:007:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> put <span class="token string">'student'</span>,<span class="token string">'1002'</span>,<span class="token string">'info:age'</span>,<span class="token string">'20'</span>
</code></pre> 
<p>3．扫描查看表数据</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:008:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> scan <span class="token string">'student'</span>
</code></pre> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:009:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> scan <span class="token string">'student'</span>,<span class="token punctuation">{<!-- --></span>STARTROW <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'1001'</span>, STOPROW  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'1001'</span><span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:010:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> scan <span class="token string">'student'</span>,<span class="token punctuation">{<!-- --></span>STARTROW <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'1001'</span><span class="token punctuation">}</span>
</code></pre> 
<p>4．查看表结构</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:011:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> describe ‘student’
</code></pre> 
<p>5．更新指定字段的数据</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:012:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> put <span class="token string">'student'</span>,<span class="token string">'1001'</span>,<span class="token string">'info:name'</span>,<span class="token string">'Nick'</span>
hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:013:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> put <span class="token string">'student'</span>,<span class="token string">'1001'</span>,<span class="token string">'info:age'</span>,<span class="token string">'100'</span>
</code></pre> 
<p>6．查看“指定行”或“指定列族:列”的数据</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:014:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> get <span class="token string">'student'</span>,<span class="token string">'1001'</span>
hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:015:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> get <span class="token string">'student'</span>,<span class="token string">'1001'</span>,<span class="token string">'info:name'</span>
</code></pre> 
<p>7．统计表数据行数</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:021:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> count <span class="token string">'student'</span>
</code></pre> 
<p>8．删除数据<br> 删除某rowkey的全部数据：</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:016:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> deleteall <span class="token string">'student'</span>,<span class="token string">'1001'</span>
</code></pre> 
<p>删除某rowkey的某一列数据：</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:017:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> delete <span class="token string">'student'</span>,<span class="token string">'1002'</span>,<span class="token string">'info:sex'</span>
</code></pre> 
<p>9．清空表数据</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:018:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> truncate <span class="token string">'student'</span>
</code></pre> 
<p>提示：清空表的操作顺序为先disable，然后再truncate。<br> 10．删除表<br> 首先需要先让该表为disable状态：</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:019:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> disable <span class="token string">'student'</span>
</code></pre> 
<p>然后才能drop这个表：<br> h<code>base(main):020:0&gt; drop 'student'</code><br> 提示：如果直接drop表，会报错<code>：ERROR: Table student is enabled. Disable it first.</code><br> 11．变更表信息<br> 将info列族中的数据存放3个版本：</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:022:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> alter <span class="token string">'student'</span>,<span class="token punctuation">{<!-- --></span>NAME<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">'info'</span>,VERSIONS<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">3</span><span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:022:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> get <span class="token string">'student'</span>,<span class="token string">'1001'</span>,<span class="token punctuation">{<!-- --></span>COLUMN<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">'info:name'</span>,VERSIONS<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">3</span><span class="token punctuation">}</span>
</code></pre> 
<h4><a id="4_HBase_308"></a>第4章 HBase数据结构</h4> 
<h5><a id="41_RowKey_309"></a>4.1 RowKey</h5> 
<p>与nosql数据库们一样,RowKey是用来检索记录的主键。访问HBASE table中的行，只有三种方式：<br> 1.通过单个RowKey访问<br> 2.通过RowKey的range（正则）<br> 3.全表扫描<br> RowKey行键 (RowKey)可以是任意字符串(最大长度是64KB，实际应用中长度一般为 10-100bytes)，在HBASE内部，RowKey保存为字节数组。存储时，数据按照RowKey的字典序(byte order)排序存储。设计RowKey时，要充分排序存储这个特性，将经常一起读取的行存储放到一起。(位置相关性)</p> 
<h5><a id="42_Column_Family_315"></a>4.2 Column Family</h5> 
<p>列族：HBASE表中的每个列，都归属于某个列族。列族是表的schema的一部 分(而列不是)，必须在使用表之前定义。列名都以列族作为前缀。例如 courses:history，courses:math都属于courses 这个列族。</p> 
<h5><a id="43_Cell_317"></a>4.3 Cell</h5> 
<p>由{rowkey, column Family:columu, version} 唯一确定的单元。cell中的数据是没有类型的，全部是字节码形式存贮。<br> 关键字：无类型、字节码</p> 
<h5><a id="44_Time_Stamp_320"></a>4.4 Time Stamp</h5> 
<p>HBASE 中通过rowkey和columns确定的为一个存贮单元称为cell。每个 cell都保存 着同一份数据的多个版本。版本通过时间戳来索引。时间戳的类型是 64位整型。时间戳可以由HBASE(在数据写入时自动 )赋值，此时时间戳是精确到毫秒 的当前系统时间。时间戳也可以由客户显式赋值。如果应用程序要避免数据版 本冲突，就必须自己生成具有唯一性的时间戳。每个 cell中，不同版本的数据按照时间倒序排序，即最新的数据排在最前面。<br> 为了避免数据存在过多版本造成的的管理 (包括存贮和索引)负担，HBASE提供 了两种数据版本回收方式。一是保存数据的最后n个版本，二是保存最近一段 时间内的版本（比如最近七天）。用户可以针对每个列族进行设置。</p> 
<h5><a id="45__323"></a>4.5 命名空间</h5> 
<p>命名空间的结构:<img src="https://images2.imgbox.com/93/eb/ILhPCu5I_o.png" alt="在这里插入图片描述"></p> 
<ol><li>Table：表，所有的表都是命名空间的成员，即表必属于某个命名空间，如果没有指定，则在default默认的命名空间中。</li><li>RegionServer group：一个命名空间包含了默认的RegionServer Group。</li><li>Permission：权限，命名空间能够让我们来定义访问控制列表ACL（Access Control List）。例如，创建表，读取表，删除，更新等等操作。</li><li>Quota：限额，可以强制一个命名空间可包含的region的数量。</li></ol> 
<h4><a id="5_HBase_330"></a>第5章 HBase原理</h4> 
<h5><a id="51__331"></a>5.1 读流程</h5> 
<p>HBase读数据流程如图3所示<br> <img src="https://images2.imgbox.com/74/99/Xd9BIghB_o.png" alt="在这里插入图片描述"><br> 1）Client先访问zookeeper，从meta表读取region的位置，然后读取meta表中的数据。meta中又存储了用户表的region信息；<br> 2）根据namespace、表名和rowkey在meta表中找到对应的region信息；<br> 3）找到这个region对应的regionserver；<br> 4）查找对应的region；<br> 5）先从MemStore找数据，如果没有，再到BlockCache里面读；<br> 6）BlockCache还没有，再到StoreFile上读(为了读取的效率)；<br> 7）如果是从StoreFile里面读取的数据，不是直接返回给客户端，而是先写入BlockCache，再返回给客户端。</p> 
<h5><a id="52__341"></a>5.2 写流程</h5> 
<p>Hbase写流程如图2所示<br> <img src="https://images2.imgbox.com/51/0c/XiCFStU1_o.png" alt="在这里插入图片描述"><br> 1）Client向HregionServer发送写请求；<br> 2）HregionServer将数据写到HLog（write ahead log）。为了数据的持久化和恢复；<br> 3）HregionServer将数据写到内存（MemStore）；<br> 4）反馈Client写成功。<br> 5.3 数据Flush过程<br> 1）当MemStore数据达到阈值（默认是128M，老版本是64M），将数据刷到硬盘，将内存中的数据删除，同时删除HLog中的历史数据；<br> 2）并将数据存储到HDFS中；<br> 3）在HLog中做标记点。<br> 5.4 数据合并过程<br> 1）当数据块达到4块，Hmaster触发合并操作，Region将数据块加载到本地，进行合并；<br> 2）当合并的数据超过256M，进行拆分，将拆分后的Region分配给不同的HregionServer管理；<br> 3）当HregionServer宕机后，将HregionServer上的hlog拆分，然后分配给不同的HregionServer加载，修改.META.；<br> 4）注意：HLog会同步到HDFS。</p> 
<h4><a id="6_HBase_API_357"></a>第6章 HBase API操作</h4> 
<h5><a id="61__358"></a>6.1 环境准备</h5> 
<p>新建项目后在pom.xml中添加依赖：</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.apache.hbase<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>hbase-server<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.3</span>.<span class="token operator"><span class="token file-descriptor important">1</span>&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.apache.hbase<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>hbase-client<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.3</span>.<span class="token operator"><span class="token file-descriptor important">1</span>&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>jdk.tools<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>jdk.tools<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1</span>.<span class="token operator"><span class="token file-descriptor important">8</span>&lt;</span>/version<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>scope<span class="token operator">&gt;</span>system<span class="token operator">&lt;</span>/scope<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>systemPath<span class="token operator">&gt;</span><span class="token variable">${JAVA_HOME}</span>/lib/tools.jar<span class="token operator">&lt;</span>/systemPath<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> 
<h5><a id="62_HBaseAPI_383"></a>6.2 HBaseAPI</h5> 
<h5><a id="621_Configuration_384"></a>6.2.1 获取Configuration对象</h5> 
<pre><code class="prism language-bash">public static Configuration conf<span class="token punctuation">;</span>
static<span class="token punctuation">{<!-- --></span>
	//使用HBaseConfiguration的单例方法实例化
	conf <span class="token operator">=</span> HBaseConfiguration.create<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
conf.set<span class="token punctuation">(</span><span class="token string">"hbase.zookeeper.quorum"</span>, <span class="token string">"192.168.9.102"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
conf.set<span class="token punctuation">(</span><span class="token string">"hbase.zookeeper.property.clientPort"</span>, <span class="token string">"2181"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="622__396"></a>6.2.2 判断表是否存在</h5> 
<pre><code class="prism language-bash">public static boolean isTableExist<span class="token punctuation">(</span>String tableName<span class="token punctuation">)</span> throws MasterNotRunningException,
 ZooKeeperConnectionException, IOException<span class="token punctuation">{<!-- --></span>
	//在HBase中管理、访问表需要先创建HBaseAdmin对象
//Connection connection <span class="token operator">=</span> ConnectionFactory.createConnection<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
//HBaseAdmin admin <span class="token operator">=</span> <span class="token punctuation">(</span>HBaseAdmin<span class="token punctuation">)</span> connection.getAdmin<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	HBaseAdmin admin <span class="token operator">=</span> new HBaseAdmin<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin class-name">return</span> admin.tableExists<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token number">6.2</span>.3 创建表
public static void createTable<span class="token punctuation">(</span>String tableName, String<span class="token punctuation">..</span>. columnFamily<span class="token punctuation">)</span> throws
 MasterNotRunningException, ZooKeeperConnectionException, IOException<span class="token punctuation">{<!-- --></span>
	HBaseAdmin admin <span class="token operator">=</span> new HBaseAdmin<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	//判断表是否存在
	if<span class="token punctuation">(</span>isTableExist<span class="token punctuation">(</span>tableName<span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"表"</span> + tableName + <span class="token string">"已存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		//System.exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>else<span class="token punctuation">{<!-- --></span>
		//创建表属性对象,表名需要转字节
		HTableDescriptor descriptor <span class="token operator">=</span> new HTableDescriptor<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>tableName<span class="token punctuation">))</span><span class="token punctuation">;</span>
		//创建多个列族
		for<span class="token punctuation">(</span>String cf <span class="token builtin class-name">:</span> columnFamily<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			descriptor.addFamily<span class="token punctuation">(</span>new HColumnDescriptor<span class="token punctuation">(</span>cf<span class="token punctuation">))</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		//根据对表的配置，创建表
		admin.createTable<span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"表"</span> + tableName + <span class="token string">"创建成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="624__429"></a>6.2.4 删除表</h5> 
<pre><code class="prism language-bash">public static void dropTable<span class="token punctuation">(</span>String tableName<span class="token punctuation">)</span> throws MasterNotRunningException,
 ZooKeeperConnectionException, IOException<span class="token punctuation">{<!-- --></span>
	HBaseAdmin admin <span class="token operator">=</span> new HBaseAdmin<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	if<span class="token punctuation">(</span>isTableExist<span class="token punctuation">(</span>tableName<span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
		admin.disableTable<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		admin.deleteTable<span class="token punctuation">(</span>tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"表"</span> + tableName + <span class="token string">"删除成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>else<span class="token punctuation">{<!-- --></span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"表"</span> + tableName + <span class="token string">"不存在！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="625__445"></a>6.2.5 向表中插入数据</h5> 
<pre><code class="prism language-bash">public static void addRowData<span class="token punctuation">(</span>String tableName, String rowKey, String columnFamily, String
 column, String value<span class="token punctuation">)</span> throws IOException<span class="token punctuation">{<!-- --></span>
	//创建HTable对象
	HTable hTable <span class="token operator">=</span> new HTable<span class="token punctuation">(</span>conf, tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	//向表中插入数据
	Put put <span class="token operator">=</span> new Put<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>rowKey<span class="token punctuation">))</span><span class="token punctuation">;</span>
	//向Put对象中组装数据
	put.add<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>columnFamily<span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>column<span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>value<span class="token punctuation">))</span><span class="token punctuation">;</span>
	hTable.put<span class="token punctuation">(</span>put<span class="token punctuation">)</span><span class="token punctuation">;</span>
	hTable.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	System.out.println<span class="token punctuation">(</span><span class="token string">"插入数据成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="626__462"></a>6.2.6 删除多行数据</h5> 
<pre><code class="prism language-bash">public static void deleteMultiRow<span class="token punctuation">(</span>String tableName, String<span class="token punctuation">..</span>. rows<span class="token punctuation">)</span> throws IOException<span class="token punctuation">{<!-- --></span>
	HTable hTable <span class="token operator">=</span> new HTable<span class="token punctuation">(</span>conf, tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	List<span class="token operator">&lt;</span>Delete<span class="token operator">&gt;</span> deleteList <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span>Delete<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	for<span class="token punctuation">(</span>String row <span class="token builtin class-name">:</span> rows<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		Delete delete <span class="token operator">=</span> new Delete<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>row<span class="token punctuation">))</span><span class="token punctuation">;</span>
		deleteList.add<span class="token punctuation">(</span>delete<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	hTable.delete<span class="token punctuation">(</span>deleteList<span class="token punctuation">)</span><span class="token punctuation">;</span>
	hTable.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="627__477"></a>6.2.7 获取所有数据</h5> 
<pre><code class="prism language-bash">public static void getAllRows<span class="token punctuation">(</span>String tableName<span class="token punctuation">)</span> throws IOException<span class="token punctuation">{<!-- --></span>
	HTable hTable <span class="token operator">=</span> new HTable<span class="token punctuation">(</span>conf, tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	//得到用于扫描region的对象
	Scan scan <span class="token operator">=</span> new Scan<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	//使用HTable得到resultcanner实现类的对象
	ResultScanner resultScanner <span class="token operator">=</span> hTable.getScanner<span class="token punctuation">(</span>scan<span class="token punctuation">)</span><span class="token punctuation">;</span>
	for<span class="token punctuation">(</span>Result result <span class="token builtin class-name">:</span> resultScanner<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		Cell<span class="token punctuation">[</span><span class="token punctuation">]</span> cells <span class="token operator">=</span> result.rawCells<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		for<span class="token punctuation">(</span>Cell cell <span class="token builtin class-name">:</span> cells<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			//得到rowkey
			System.out.println<span class="token punctuation">(</span><span class="token string">"行键:"</span> + Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneRow<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			//得到列族
			System.out.println<span class="token punctuation">(</span><span class="token string">"列族"</span> + Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneFamily<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			System.out.println<span class="token punctuation">(</span><span class="token string">"列:"</span> + Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneQualifier<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			System.out.println<span class="token punctuation">(</span><span class="token string">"值:"</span> + Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneValue<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="628__500"></a>6.2.8 获取某一行数据</h5> 
<pre><code class="prism language-bash">public static void getRow<span class="token punctuation">(</span>String tableName, String rowKey<span class="token punctuation">)</span> throws IOException<span class="token punctuation">{<!-- --></span>
	HTable table <span class="token operator">=</span> new HTable<span class="token punctuation">(</span>conf, tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	Get get <span class="token operator">=</span> new Get<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>rowKey<span class="token punctuation">))</span><span class="token punctuation">;</span>
	//get.setMaxVersions<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>显示所有版本
    //get.setTimeStamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>显示指定时间戳的版本
	Result result <span class="token operator">=</span> table.get<span class="token punctuation">(</span>get<span class="token punctuation">)</span><span class="token punctuation">;</span>
	for<span class="token punctuation">(</span>Cell cell <span class="token builtin class-name">:</span> result.rawCells<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"行键:"</span> + Bytes.toString<span class="token punctuation">(</span>result.getRow<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"列族"</span> + Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneFamily<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"列:"</span> + Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneQualifier<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"值:"</span> + Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneValue<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"时间戳:"</span> + cell.getTimestamp<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="629__519"></a>6.2.9 获取某一行指定“列族:列”的数据</h5> 
<pre><code class="prism language-bash">public static void getRowQualifier<span class="token punctuation">(</span>String tableName, String rowKey, String family, String
 qualifier<span class="token punctuation">)</span> throws IOException<span class="token punctuation">{<!-- --></span>
	HTable table <span class="token operator">=</span> new HTable<span class="token punctuation">(</span>conf, tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	Get get <span class="token operator">=</span> new Get<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>rowKey<span class="token punctuation">))</span><span class="token punctuation">;</span>
	get.addColumn<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>family<span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>qualifier<span class="token punctuation">))</span><span class="token punctuation">;</span>
	Result result <span class="token operator">=</span> table.get<span class="token punctuation">(</span>get<span class="token punctuation">)</span><span class="token punctuation">;</span>
	for<span class="token punctuation">(</span>Cell cell <span class="token builtin class-name">:</span> result.rawCells<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"行键:"</span> + Bytes.toString<span class="token punctuation">(</span>result.getRow<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"列族"</span> + Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneFamily<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"列:"</span> + Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneQualifier<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		System.out.println<span class="token punctuation">(</span><span class="token string">"值:"</span> + Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneValue<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="63_MapReduce_537"></a>6.3 MapReduce</h5> 
<p>通过HBase的相关JavaAPI，我们可以实现伴随HBase操作的MapReduce过程，比如使用MapReduce将数据从本地文件系统导入到HBase的表中，比如我们从HBase中读取一些原始数据后使用MapReduce做数据分析。</p> 
<h5><a id="631_HBaseMapReduce_539"></a>6.3.1 官方HBase-MapReduce</h5> 
<p>1．查看HBase的MapReduce任务的执行</p> 
<pre><code class="prism language-bash">$ bin/hbase mapredcp
</code></pre> 
<p>2．环境变量的导入<br> （1）执行环境变量的导入（临时生效，在命令行执行下述操作）</p> 
<pre><code class="prism language-bash">$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">HBASE_HOME</span><span class="token operator">=</span>/opt/module/hbase-1.3.1
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">HADOOP_HOME</span><span class="token operator">=</span>/opt/module/hadoop-2.7.2
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">HADOOP_CLASSPATH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>$<span class="token punctuation">{<!-- --></span>HBASE_HOME<span class="token punctuation">}</span>/bin/hbase mapredcp<span class="token variable">`</span></span>
</code></pre> 
<p>（2）永久生效：在/etc/profile配置</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">HBASE_HOME</span><span class="token operator">=</span>/opt/module/hbase-1.3.1
<span class="token builtin class-name">export</span> <span class="token assign-left variable">HADOOP_HOME</span><span class="token operator">=</span>/opt/module/hadoop-2.7.2
</code></pre> 
<p>并在hadoop-env.sh中配置：（注意：在for循环之后配）</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">HADOOP_CLASSPATH</span><span class="token operator">=</span><span class="token variable">$HADOOP_CLASSPATH</span>:/opt/module/hbase/lib/*
</code></pre> 
<p>3．运行官方的MapReduce任务<br> – 案例一：统计Student表中有多少行数据</p> 
<pre><code class="prism language-bash">$ /opt/module/hadoop-2.7.2/bin/yarn jar lib/hbase-server-1.3.1.jar rowcounter student
</code></pre> 
<p>– 案例二：使用MapReduce将本地数据导入到HBase<br> 1）在本地创建一个tsv格式的文件：fruit.tsv</p> 
<pre><code class="prism language-bash"><span class="token number">1001</span>	Apple	Red
<span class="token number">1002</span>	Pear		Yellow
<span class="token number">1003</span>	Pineapple	Yellow
</code></pre> 
<p>2）创建HBase表</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:001:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> create <span class="token string">'fruit'</span>,<span class="token string">'info'</span>
</code></pre> 
<p>3）在HDFS中创建input_fruit文件夹并上传fruit.tsv文件</p> 
<pre><code class="prism language-bash">$ /opt/module/hadoop-2.7.2/bin/hdfs dfs -mkdir /input_fruit/
</code></pre> 
<pre><code class="prism language-bash">$ /opt/module/hadoop-2.7.2/bin/hdfs dfs -put fruit.tsv /input_fruit/
</code></pre> 
<p>4）执行MapReduce到HBase的fruit表中</p> 
<pre><code class="prism language-bash">$ /opt/module/hadoop-2.7.2/bin/yarn jar lib/hbase-server-1.3.1.jar importtsv <span class="token punctuation">\</span>
-Dimporttsv.columns<span class="token operator">=</span>HBASE_ROW_KEY,info:name,info:color fruit <span class="token punctuation">\</span>
hdfs://hadoop102:9000/input_fruit
</code></pre> 
<p>5）使用scan命令查看导入后的结果</p> 
<pre><code class="prism language-bash">hbase<span class="token punctuation">(</span>main<span class="token punctuation">)</span>:001:<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> scan ‘fruit’
</code></pre> 
<h5><a id="632_HBaseMapReduce1_614"></a>6.3.2 自定义HBase-MapReduce1</h5> 
<p>目标：将fruit表中的一部分数据，通过MR迁入到fruit_mr表中。<br> 分步实现：<br> 1．构建ReadFruitMapper类，用于读取fruit表中的数据</p> 
<pre><code class="prism language-bash">package com.atguigu<span class="token punctuation">;</span>

<span class="token function">import</span> java.io.IOException<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.Cell<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.CellUtil<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.client.Put<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.client.Result<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.io.ImmutableBytesWritable<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.mapreduce.TableMapper<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.util.Bytes<span class="token punctuation">;</span>

public class ReadFruitMapper extends TableMapper<span class="token operator">&lt;</span>ImmutableBytesWritable, Put<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>

	@Override
	protected void map<span class="token punctuation">(</span>ImmutableBytesWritable key, Result value, Context context<span class="token punctuation">)</span> 
	throws IOException, InterruptedException <span class="token punctuation">{<!-- --></span>
	//将fruit的name和color提取出来，相当于将每一行数据读取出来放入到Put对象中。
		Put put <span class="token operator">=</span> new Put<span class="token punctuation">(</span>key.get<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
		//遍历添加column行
		for<span class="token punctuation">(</span>Cell cell: value.rawCells<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
			//添加/克隆列族:info
			if<span class="token punctuation">(</span><span class="token string">"info"</span>.equals<span class="token punctuation">(</span>Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneFamily<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
				//添加/克隆列：name
				if<span class="token punctuation">(</span><span class="token string">"name"</span>.equals<span class="token punctuation">(</span>Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneQualifier<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
					//将该列cell加入到put对象中
					put.add<span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">;</span>
					//添加/克隆列:color
				<span class="token punctuation">}</span>else if<span class="token punctuation">(</span><span class="token string">"color"</span>.equals<span class="token punctuation">(</span>Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneQualifier<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
					//向该列cell加入到put对象中
					put.add<span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		//将从fruit读取到的每行数据写入到context中作为map的输出
		context.write<span class="token punctuation">(</span>key, put<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2． 构建WriteFruitMRReducer类，用于将读取到的fruit表中的数据写入到fruit_mr表中</p> 
<pre><code class="prism language-bash">package com.atguigu.hbase_mr<span class="token punctuation">;</span>

<span class="token function">import</span> java.io.IOException<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.client.Put<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.io.ImmutableBytesWritable<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.mapreduce.TableReducer<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.io.NullWritable<span class="token punctuation">;</span>

public class WriteFruitMRReducer extends TableReducer<span class="token operator">&lt;</span>ImmutableBytesWritable, Put, NullWritable<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
	@Override
	protected void reduce<span class="token punctuation">(</span>ImmutableBytesWritable key, Iterable<span class="token operator">&lt;</span>Put<span class="token operator">&gt;</span> values, Context context<span class="token punctuation">)</span> 
	throws IOException, InterruptedException <span class="token punctuation">{<!-- --></span>
		//读出来的每一行数据写入到fruit_mr表中
		for<span class="token punctuation">(</span>Put put: values<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			context.write<span class="token punctuation">(</span>NullWritable.get<span class="token punctuation">(</span><span class="token punctuation">)</span>, put<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3．构建Fruit2FruitMRRunner extends Configured implements Tool用于组装运行Job任务</p> 
<pre><code class="prism language-bash">//组装Job
	public int run<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
		//得到Configuration
		Configuration conf <span class="token operator">=</span> this.getConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		//创建Job任务
		Job job <span class="token operator">=</span> Job.getInstance<span class="token punctuation">(</span>conf, this.getClass<span class="token punctuation">(</span><span class="token punctuation">)</span>.getSimpleName<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
		job.setJarByClass<span class="token punctuation">(</span>Fruit2FruitMRRunner.class<span class="token punctuation">)</span><span class="token punctuation">;</span>

		//配置Job
		Scan scan <span class="token operator">=</span> new Scan<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		scan.setCacheBlocks<span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>
		scan.setCaching<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		//设置Mapper，注意导入的是mapreduce包下的，不是mapred包下的，后者是老版本
		TableMapReduceUtil.initTableMapperJob<span class="token punctuation">(</span>
		<span class="token string">"fruit"</span>, //数据源的表名
		scan, //scan扫描控制器
		ReadFruitMapper.class,//设置Mapper类
		ImmutableBytesWritable.class,//设置Mapper输出key类型
		Put.class,//设置Mapper输出value值类型
		job//设置给哪个<span class="token environment constant">JOB</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//设置Reducer
		TableMapReduceUtil.initTableReducerJob<span class="token punctuation">(</span><span class="token string">"fruit_mr"</span>, WriteFruitMRReducer.class, job<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//设置Reduce数量，最少1个
		job.setNumReduceTasks<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		boolean isSuccess <span class="token operator">=</span> job.waitForCompletion<span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
		if<span class="token punctuation">(</span><span class="token operator">!</span>isSuccess<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			throw new IOException<span class="token punctuation">(</span><span class="token string">"Job running with error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token builtin class-name">return</span> isSuccess ? <span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>4．主函数中调用运行该Job任务</p> 
<pre><code class="prism language-bash">public static void main<span class="token punctuation">(</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span> throws Exception<span class="token punctuation">{<!-- --></span>
Configuration conf <span class="token operator">=</span> HBaseConfiguration.create<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
int status <span class="token operator">=</span> ToolRunner.run<span class="token punctuation">(</span>conf, new Fruit2FruitMRRunner<span class="token punctuation">(</span><span class="token punctuation">)</span>, args<span class="token punctuation">)</span><span class="token punctuation">;</span>
System.exit<span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>5．打包运行任务</p> 
<pre><code class="prism language-bash">$ /opt/module/hadoop-2.7.2/bin/yarn jar ~/softwares/jars/hbase-0.0.1-SNAPSHOT.jar
 com.z.hbase.mr1.Fruit2FruitMRRunner
</code></pre> 
<p>提示：运行任务前，如果待数据导入的表不存在，则需要提前创建。<br> 提示：maven打包命令：-P local clean package或-P dev clean package install（将第三方jar包一同打包，需要插件：maven-shade-plugin）</p> 
<h5><a id="633_HBaseMapReduce2_739"></a>6.3.3 自定义HBase-MapReduce2</h5> 
<p>目标：实现将HDFS中的数据写入到HBase表中。<br> 分步实现：<br> 1．构建ReadFruitFromHDFSMapper于读取HDFS中的文件数据</p> 
<pre><code class="prism language-bash">package com.atguigu<span class="token punctuation">;</span>

<span class="token function">import</span> java.io.IOException<span class="token punctuation">;</span>

<span class="token function">import</span> org.apache.hadoop.hbase.client.Put<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.io.ImmutableBytesWritable<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.util.Bytes<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.io.LongWritable<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.io.Text<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.mapreduce.Mapper<span class="token punctuation">;</span>

public class ReadFruitFromHDFSMapper extends Mapper<span class="token operator">&lt;</span>LongWritable, Text, ImmutableBytesWritable, Put<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
	@Override
	protected void map<span class="token punctuation">(</span>LongWritable key, Text value, Context context<span class="token punctuation">)</span> throws IOException, InterruptedException <span class="token punctuation">{<!-- --></span>
		//从HDFS中读取的数据
		String lineValue <span class="token operator">=</span> value.toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		//读取出来的每行数据使用<span class="token punctuation">\</span>t进行分割，存于String数组
		String<span class="token punctuation">[</span><span class="token punctuation">]</span> values <span class="token operator">=</span> lineValue.split<span class="token punctuation">(</span><span class="token string">"<span class="token entity" title="\t">\t</span>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		//根据数据中值的含义取值
		String rowKey <span class="token operator">=</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		String name <span class="token operator">=</span> values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		String color <span class="token operator">=</span> values<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		
		//初始化rowKey
		ImmutableBytesWritable rowKeyWritable <span class="token operator">=</span> new ImmutableBytesWritable<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>rowKey<span class="token punctuation">))</span><span class="token punctuation">;</span>
		
		//初始化put对象
		Put put <span class="token operator">=</span> new Put<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>rowKey<span class="token punctuation">))</span><span class="token punctuation">;</span>
		
		//参数分别:列族、列、值  
        put.add<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span>,  Bytes.toBytes<span class="token punctuation">(</span>name<span class="token punctuation">))</span><span class="token punctuation">;</span> 
        put.add<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"color"</span><span class="token punctuation">)</span>,  Bytes.toBytes<span class="token punctuation">(</span>color<span class="token punctuation">))</span><span class="token punctuation">;</span> 
        
        context.write<span class="token punctuation">(</span>rowKeyWritable, put<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2．构建WriteFruitMRFromTxtReducer类</p> 
<pre><code class="prism language-bash">package com.z.hbase.mr2<span class="token punctuation">;</span>

<span class="token function">import</span> java.io.IOException<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.client.Put<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.io.ImmutableBytesWritable<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.hbase.mapreduce.TableReducer<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.hadoop.io.NullWritable<span class="token punctuation">;</span>

public class WriteFruitMRFromTxtReducer extends TableReducer<span class="token operator">&lt;</span>ImmutableBytesWritable, Put, NullWritable<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
	@Override
	protected void reduce<span class="token punctuation">(</span>ImmutableBytesWritable key, Iterable<span class="token operator">&lt;</span>Put<span class="token operator">&gt;</span> values, Context context<span class="token punctuation">)</span> throws IOException, InterruptedException <span class="token punctuation">{<!-- --></span>
		//读出来的每一行数据写入到fruit_hdfs表中
		for<span class="token punctuation">(</span>Put put: values<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			context.write<span class="token punctuation">(</span>NullWritable.get<span class="token punctuation">(</span><span class="token punctuation">)</span>, put<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3．创建Txt2FruitRunner组装Job</p> 
<pre><code class="prism language-bash">public int run<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
//得到Configuration
Configuration conf <span class="token operator">=</span> this.getConf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

//创建Job任务
Job job <span class="token operator">=</span> Job.getInstance<span class="token punctuation">(</span>conf, this.getClass<span class="token punctuation">(</span><span class="token punctuation">)</span>.getSimpleName<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
job.setJarByClass<span class="token punctuation">(</span>Txt2FruitRunner.class<span class="token punctuation">)</span><span class="token punctuation">;</span>
Path inPath <span class="token operator">=</span> new Path<span class="token punctuation">(</span><span class="token string">"hdfs://hadoop102:9000/input_fruit/fruit.tsv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
FileInputFormat.addInputPath<span class="token punctuation">(</span>job, inPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

//设置Mapper
job.setMapperClass<span class="token punctuation">(</span>ReadFruitFromHDFSMapper.class<span class="token punctuation">)</span><span class="token punctuation">;</span>
job.setMapOutputKeyClass<span class="token punctuation">(</span>ImmutableBytesWritable.class<span class="token punctuation">)</span><span class="token punctuation">;</span>
job.setMapOutputValueClass<span class="token punctuation">(</span>Put.class<span class="token punctuation">)</span><span class="token punctuation">;</span>

//设置Reducer
TableMapReduceUtil.initTableReducerJob<span class="token punctuation">(</span><span class="token string">"fruit_mr"</span>, WriteFruitMRFromTxtReducer.class, job<span class="token punctuation">)</span><span class="token punctuation">;</span>

//设置Reduce数量，最少1个
job.setNumReduceTasks<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

boolean isSuccess <span class="token operator">=</span> job.waitForCompletion<span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
if<span class="token punctuation">(</span><span class="token operator">!</span>isSuccess<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
throw new IOException<span class="token punctuation">(</span><span class="token string">"Job running with error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token builtin class-name">return</span> isSuccess ? <span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4．调用执行Job</p> 
<pre><code class="prism language-bash">public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
		Configuration conf <span class="token operator">=</span> HBaseConfiguration.create<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    int status <span class="token operator">=</span> ToolRunner.run<span class="token punctuation">(</span>conf, new Txt2FruitRunner<span class="token punctuation">(</span><span class="token punctuation">)</span>, args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    System.exit<span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>5．打包运行</p> 
<pre><code class="prism language-bash">$ /opt/module/hadoop-2.7.2/bin/yarn jar hbase-0.0.1-SNAPSHOT.jar com.atguigu.hbase.mr2.Txt2FruitRunner
</code></pre> 
<p>提示：运行任务前，如果待数据导入的表不存在，则需要提前创建之。<br> 提示：maven打包命令：-P local clean package或-P dev clean package install（将第三方jar包一同打包，需要插件：maven-shade-plugin）</p> 
<h5><a id="64_Hive_858"></a>6.4 与Hive的集成</h5> 
<h5><a id="641_HBaseHive_859"></a>6.4.1 HBase与Hive的对比</h5> 
<p>1．Hive<br> (1) 数据仓库<br> Hive的本质其实就相当于将HDFS中已经存储的文件在Mysql中做了一个双射关系，以方便使用HQL去管理查询。<br> (2) 用于数据分析、清洗<br> Hive适用于离线的数据分析和清洗，延迟较高。<br> (3) 基于HDFS、MapReduce<br> Hive存储的数据依旧在DataNode上，编写的HQL语句终将是转换为MapReduce代码执行。<br> 2．HBase<br> (1) 数据库<br> 是一种面向列存储的非关系型数据库。<br> (2) 用于存储结构化和非结构化的数据<br> 适用于单表非关系型数据的存储，不适合做关联查询，类似JOIN等操作。<br> (3) 基于HDFS<br> 数据持久化存储的体现形式是Hfile，存放于DataNode中，被ResionServer以region的形式进行管理。<br> (4) 延迟较低，接入在线业务使用<br> 面对大量的企业数据，HBase可以直线单表大量数据的存储，同时提供了高效的数据访问速度。</p> 
<h5><a id="642_HBaseHive_876"></a>6.4.2 HBase与Hive集成使用</h5> 
<p>尖叫提示：HBase与Hive的集成在最新的两个版本中无法兼容。所以，我们只能含着泪勇敢的重新编译：hive-hbase-handler-1.2.2.jar！！好气！！<br> 环境准备<br> 因为我们后续可能会在操作Hive的同时对HBase也会产生影响，所以Hive需要持有操作HBase的Jar，那么接下来拷贝Hive所依赖的Jar包（或者使用软连接的形式）。</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">HBASE_HOME</span><span class="token operator">=</span>/opt/module/hbase
<span class="token builtin class-name">export</span> <span class="token assign-left variable">HIVE_HOME</span><span class="token operator">=</span>/opt/module/hive
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">ln</span> -s <span class="token variable">$HBASE_HOME</span>/lib/hbase-common-1.3.1.jar  <span class="token variable">$HIVE_HOME</span>/lib/hbase-common-1.3.1.jar
<span class="token function">ln</span> -s <span class="token variable">$HBASE_HOME</span>/lib/hbase-server-1.3.1.jar <span class="token variable">$HIVE_HOME</span>/lib/hbase-server-1.3.1.jar
<span class="token function">ln</span> -s <span class="token variable">$HBASE_HOME</span>/lib/hbase-client-1.3.1.jar <span class="token variable">$HIVE_HOME</span>/lib/hbase-client-1.3.1.jar
<span class="token function">ln</span> -s <span class="token variable">$HBASE_HOME</span>/lib/hbase-protocol-1.3.1.jar <span class="token variable">$HIVE_HOME</span>/lib/hbase-protocol-1.3.1.jar
<span class="token function">ln</span> -s <span class="token variable">$HBASE_HOME</span>/lib/hbase-it-1.3.1.jar <span class="token variable">$HIVE_HOME</span>/lib/hbase-it-1.3.1.jar
<span class="token function">ln</span> -s <span class="token variable">$HBASE_HOME</span>/lib/htrace-core-3.1.0-incubating.jar <span class="token variable">$HIVE_HOME</span>/lib/htrace-core-3.1.0-incubating.jar
<span class="token function">ln</span> -s <span class="token variable">$HBASE_HOME</span>/lib/hbase-hadoop2-compat-1.3.1.jar <span class="token variable">$HIVE_HOME</span>/lib/hbase-hadoop2-compat-1.3.1.jar
<span class="token function">ln</span> -s <span class="token variable">$HBASE_HOME</span>/lib/hbase-hadoop-compat-1.3.1.jar <span class="token variable">$HIVE_HOME</span>/lib/hbase-hadoop-compat-1.3.1.jar
</code></pre> 
<p>同时在hive-site.xml中修改zookeeper的属性，如下：</p> 
<pre><code class="prism language-bash"><span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>hive.zookeeper.quorum<span class="token operator">&lt;</span>/name<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span>hadoop102,hadoop103,hadoop10<span class="token operator"><span class="token file-descriptor important">4</span>&lt;</span>/value<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>description<span class="token operator">&gt;</span>The list of ZooKeeper servers to talk to. This is only needed <span class="token keyword">for</span> read/write locks.<span class="token operator">&lt;</span>/description<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/property<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>property<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>name<span class="token operator">&gt;</span>hive.zookeeper.client.port<span class="token operator">&lt;</span>/name<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span><span class="token number">218</span><span class="token operator"><span class="token file-descriptor important">1</span>&lt;</span>/value<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>description<span class="token operator">&gt;</span>The port of ZooKeeper servers to talk to. This is only needed <span class="token keyword">for</span> read/write locks.<span class="token operator">&lt;</span>/description<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/property<span class="token operator">&gt;</span>
</code></pre> 
<p>1．案例一<br> 目标：建立Hive表，关联HBase表，插入数据到Hive表的同时能够影响HBase表。<br> 分步实现：<br> (1) 在Hive中创建表同时关联HBase</p> 
<pre><code class="prism language-bash">CREATE TABLE hive_hbase_emp_table<span class="token punctuation">(</span>
empno int,
ename string,
job string,
mgr int,
hiredate string,
sal double,
<span class="token function">comm</span> double,
deptno int<span class="token punctuation">)</span>
STORED BY <span class="token string">'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span>
WITH SERDEPROPERTIES <span class="token punctuation">(</span><span class="token string">"hbase.columns.mapping"</span> <span class="token operator">=</span> <span class="token string">":key,info:ename,info:job,info:mgr,info:hiredate,info:sal,info:comm,info:deptno"</span><span class="token punctuation">)</span>
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"hbase.table.name"</span> <span class="token operator">=</span> <span class="token string">"hbase_emp_table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>提示：完成之后，可以分别进入Hive和HBase查看，都生成了对应的表<br> (2) 在Hive中创建临时中间表，用于load文件中的数据<br> 提示：不能将数据直接load进Hive所关联HBase的那张表中</p> 
<pre><code class="prism language-bash">CREATE TABLE emp<span class="token punctuation">(</span>
empno int,
ename string,
job string,
mgr int,
hiredate string,
sal double,
<span class="token function">comm</span> double,
deptno int<span class="token punctuation">)</span>
row <span class="token function">format</span> delimited fields terminated by <span class="token string">'\t'</span><span class="token punctuation">;</span>
</code></pre> 
<p>(3) 向Hive中间表中load数据</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> load data <span class="token builtin class-name">local</span> inpath <span class="token string">'/home/admin/softwares/data/emp.txt'</span> into table emp<span class="token punctuation">;</span>
</code></pre> 
<p>(4) 通过insert命令将中间表中的数据导入到Hive关联HBase的那张表中</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> insert into table hive_hbase_emp_table <span class="token keyword">select</span> * from emp<span class="token punctuation">;</span>
</code></pre> 
<p>(5) 查看Hive以及关联的HBase表中是否已经成功的同步插入了数据<br> Hive：</p> 
<pre><code class="prism language-bash">hive<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from hive_hbase_emp_table<span class="token punctuation">;</span>
</code></pre> 
<p>HBase：</p> 
<pre><code class="prism language-bash">hbase<span class="token operator">&gt;</span> scan ‘hbase_emp_table’
</code></pre> 
<p>2．案例二<br> 目标：在HBase中已经存储了某一张表hbase_emp_table，然后在Hive中创建一个外部表来关联HBase中的hbase_emp_table这张表，使之可以借助Hive来分析HBase这张表中的数据。<br> 注：该案例2紧跟案例1的脚步，所以完成此案例前，请先完成案例1。<br> 分步实现：<br> (1) 在Hive中创建外部表</p> 
<pre><code class="prism language-bash">CREATE EXTERNAL TABLE relevance_hbase_emp<span class="token punctuation">(</span>
empno int,
ename string,
job string,
mgr int,
hiredate string,
sal double,
<span class="token function">comm</span> double,
deptno int<span class="token punctuation">)</span>
STORED BY 
<span class="token string">'org.apache.hadoop.hive.hbase.HBaseStorageHandler'</span>
WITH SERDEPROPERTIES <span class="token punctuation">(</span><span class="token string">"hbase.columns.mapping"</span> <span class="token operator">=</span> 
<span class="token string">":key,info:ename,info:job,info:mgr,info:hiredate,info:sal,info:comm,info:deptno"</span><span class="token punctuation">)</span> 
TBLPROPERTIES <span class="token punctuation">(</span><span class="token string">"hbase.table.name"</span> <span class="token operator">=</span> <span class="token string">"hbase_emp_table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>(2) 关联后就可以使用Hive函数进行一些分析操作了</p> 
<pre><code class="prism language-bash">hive <span class="token punctuation">(</span>default<span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> * from relevance_hbase_emp<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="7_HBase_1003"></a>第7章 HBase优化</h4> 
<h5><a id="71__1004"></a>7.1 高可用</h5> 
<p>在HBase中Hmaster负责监控RegionServer的生命周期，均衡RegionServer的负载，如果Hmaster挂掉了，那么整个HBase集群将陷入不健康的状态，并且此时的工作状态并不会维持太久。所以HBase支持对Hmaster的高可用配置。<br> 1．关闭HBase集群（如果没有开启则跳过此步）</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 hbase<span class="token punctuation">]</span>$ bin/stop-hbase.sh
</code></pre> 
<p>2．在conf目录下创建backup-masters文件</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 hbase<span class="token punctuation">]</span>$ <span class="token function">touch</span> conf/backup-masters
</code></pre> 
<p>3．在backup-masters文件中配置高可用HMaster节点</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 hbase<span class="token punctuation">]</span>$ <span class="token builtin class-name">echo</span> hadoop103 <span class="token operator">&gt;</span> conf/backup-masters
</code></pre> 
<p>4．将整个conf目录scp到其他节点</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 hbase<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r conf/ hadoop103:/opt/module/hbase/
</code></pre> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>atguigu@hadoop102 hbase<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r conf/ hadoop104:/opt/module/hbase/
</code></pre> 
<p>5．打开页面测试查看</p> 
<pre><code class="prism language-bash">http://hadooo102:16010 
</code></pre> 
<h5><a id="72__1040"></a>7.2 预分区</h5> 
<p>每一个region维护着startRow与endRowKey，如果加入的数据符合某个region维护的rowKey范围，则该数据交给这个region维护。那么依照这个原则，我们可以将数据所要投放的分区提前大致的规划好，以提高HBase性能。<br> 1．手动设定预分区</p> 
<pre><code class="prism language-bash">hbase<span class="token operator">&gt;</span> create <span class="token string">'staff1'</span>,<span class="token string">'info'</span>,<span class="token string">'partition1'</span>,SPLITS <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token string">'1000'</span>,<span class="token string">'2000'</span>,<span class="token string">'3000'</span>,<span class="token string">'4000'</span><span class="token punctuation">]</span>
</code></pre> 
<p>2．生成16进制序列预分区</p> 
<pre><code class="prism language-bash">create <span class="token string">'staff2'</span>,<span class="token string">'info'</span>,<span class="token string">'partition2'</span>,<span class="token punctuation">{<!-- --></span>NUMREGIONS <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">15</span>, SPLITALGO <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'HexStringSplit'</span><span class="token punctuation">}</span>
</code></pre> 
<p>3．按照文件中设置的规则预分区<br> 创建splits.txt文件内容如下：</p> 
<pre><code class="prism language-bash">aaaa
bbbb
cccc
dddd
</code></pre> 
<p>然后执行：</p> 
<pre><code class="prism language-bash">create <span class="token string">'staff3'</span>,<span class="token string">'partition3'</span>,SPLITS_FILE <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">'splits.txt'</span>
</code></pre> 
<p>4．使用JavaAPI创建预分区<br> //自定义算法，产生一系列Hash散列值存储在二维数组中<br> byte[][] splitKeys = 某个散列值函数<br> //创建HBaseAdmin实例<br> HBaseAdmin hAdmin = new HBaseAdmin(HBaseConfiguration.create());<br> //创建HTableDescriptor实例<br> HTableDescriptor tableDesc = new HTableDescriptor(tableName);<br> //通过HTableDescriptor实例和散列值二维数组创建带有预分区的HBase表<br> hAdmin.createTable(tableDesc, splitKeys);</p> 
<h5><a id="73_RowKey_1079"></a>7.3 RowKey设计</h5> 
<p>一条数据的唯一标识就是rowkey，那么这条数据存储于哪个分区，取决于rowkey处于哪个一个预分区的区间内，设计rowkey的主要目的 ，就是让数据均匀的分布于所有的region中，在一定程度上防止数据倾斜。接下来我们就谈一谈rowkey常用的设计方案。<br> 1．生成随机数、hash、散列值<br> 比如：<br> 原本rowKey为1001的，SHA1后变成：dd01903921ea24941c26a48f2cec24e0bb0e8cc7<br> 原本rowKey为3001的，SHA1后变成：49042c54de64a1e9bf0b33e00245660ef92dc7bd<br> 原本rowKey为5001的，SHA1后变成：7b61dec07e02c188790670af43e717f0f46e8913<br> 在做此操作之前，一般我们会选择从数据集中抽取样本，来决定什么样的rowKey来Hash后作为每个分区的临界值。<br> 2．字符串反转<br> 20170524000001转成10000042507102<br> 20170524000002转成20000042507102<br> 这样也可以在一定程度上散列逐步put进来的数据。<br> 3．字符串拼接<br> 20170524000001_a12e<br> 20170524000001_93i7</p> 
<h5><a id="74__1094"></a>7.4 内存优化</h5> 
<p>HBase操作过程中需要大量的内存开销，毕竟Table是可以缓存在内存中的，一般会分配整个可用内存的70%给HBase的Java堆。但是不建议分配非常大的堆内存，因为GC过程持续太久会导致RegionServer处于长期不可用状态，一般16~48G内存就可以了，如果因为框架占用内存过高导致系统内存不足，框架一样会被系统服务拖死。</p> 
<h5><a id="75__1096"></a>7.5 基础优化</h5> 
<p>1．允许在HDFS的文件中追加内容<br> hdfs-site.xml、hbase-site.xml<br> 属性：dfs.support.append<br> 解释：开启HDFS追加同步，可以优秀的配合HBase的数据同步和持久化。默认值为true。<br> 2．优化DataNode允许的最大文件打开数<br> hdfs-site.xml<br> 属性：dfs.datanode.max.transfer.threads<br> 解释：HBase一般都会同一时间操作大量的文件，根据集群的数量和规模以及数据动作，设置为4096或者更高。默认值：4096<br> 3．优化延迟高的数据操作的等待时间<br> hdfs-site.xml<br> 属性：dfs.image.transfer.timeout<br> 解释：如果对于某一次数据操作来讲，延迟非常高，socket需要等待更长的时间，建议把该值设置为更大的值（默认60000毫秒），以确保socket不会被timeout掉。<br> 4．优化数据的写入效率<br> mapred-site.xml<br> 属性：<br> mapreduce.map.output.compress<br> mapreduce.map.output.compress.codec<br> 解释：开启这两个数据可以大大提高文件的写入效率，减少写入时间。第一个属性值修改为true，第二个属性值修改为：org.apache.hadoop.io.compress.GzipCodec或者其他压缩方式。<br> 5．设置RPC监听数量<br> hbase-site.xml<br> 属性：hbase.regionserver.handler.count<br> 解释：默认值为30，用于指定RPC监听的数量，可以根据客户端的请求数进行调整，读写请求较多时，增加此值。<br> 6．优化HStore文件大小<br> hbase-site.xml<br> 属性：hbase.hregion.max.filesize<br> 解释：默认值10737418240（10GB），如果需要运行HBase的MR任务，可以减小此值，因为一个region对应一个map任务，如果单个region过大，会导致map任务执行时间过长。该值的意思就是，如果HFile的大小达到这个数值，则这个region会被切分为两个Hfile。<br> 7．优化hbase客户端缓存<br> hbase-site.xml<br> 属性：hbase.client.write.buffer<br> 解释：用于指定HBase客户端缓存，增大该值可以减少RPC调用次数，但是会消耗更多内存，反之则反之。一般我们需要设定一定的缓存大小，以达到减少RPC次数的目的。<br> 8．指定scan.next扫描HBase所获取的行数<br> hbase-site.xml<br> 属性：hbase.client.scanner.caching<br> 解释：用于指定scan.next方法获取的默认行数，值越大，消耗内存越大。<br> 9．flush、compact、split机制<br> 当MemStore达到阈值，将Memstore中的数据Flush进Storefile；compact机制则是把flush出来的小文件合并成大的Storefile文件。split则是当Region达到阈值，会把过大的Region一分为二。<br> 涉及属性：<br> 即：128M就是Memstore的默认阈值<br> hbase.hregion.memstore.flush.size：134217728<br> 即：这个参数的作用是当单个HRegion内所有的Memstore大小总和超过指定值时，flush该HRegion的所有memstore。RegionServer的flush是通过将请求添加一个队列，模拟生产消费模型来异步处理的。那这里就有一个问题，当队列来不及消费，产生大量积压请求时，可能会导致内存陡增，最坏的情况是触发OOM。<br> hbase.regionserver.global.memstore.upperLimit：0.4<br> hbase.regionserver.global.memstore.lowerLimit：0.38<br> 即：当MemStore使用内存总量达到hbase.regionserver.global.memstore.upperLimit指定值时，将会有多个MemStores flush到文件中，MemStore flush 顺序是按照大小降序执行的，直到刷新到MemStore使用内存略小于lowerLimit</p> 
<h4><a id="8_HBase_1140"></a>第8章 HBase实战之谷粒微博</h4> 
<h5><a id="81__1141"></a>8.1 需求分析</h5> 
<ol><li>微博内容的浏览，数据库表设计</li><li>用户社交体现：关注用户，取关用户</li><li>拉取关注的人的微博内容<br> 8.2 代码实现<br> 8.2.1 代码设计总览：</li><li>创建命名空间以及表名的定义</li><li>创建微博内容表</li><li>创建用户关系表</li><li>创建用户微博内容接收邮件表</li><li>发布微博内容</li><li>添加关注用户</li><li>移除（取关）用户</li><li>获取关注的人的微博内容</li><li>测试</li></ol> 
<h5><a id="822__1156"></a>8.2.2 创建命名空间以及表名的定义</h5> 
<pre><code class="prism language-bash">//获取配置conf
private Configuration conf <span class="token operator">=</span> HBaseConfiguration.create<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

//微博内容表的表名
private static final byte<span class="token punctuation">[</span><span class="token punctuation">]</span> TABLE_CONTENT <span class="token operator">=</span> Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"weibo:content"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//用户关系表的表名
private static final byte<span class="token punctuation">[</span><span class="token punctuation">]</span> TABLE_RELATIONS <span class="token operator">=</span> Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"weibo:relations"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
//微博收件箱表的表名
private static final byte<span class="token punctuation">[</span><span class="token punctuation">]</span> TABLE_RECEIVE_CONTENT_EMAIL <span class="token operator">=</span> Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"weibo:receive_content_email"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
public void <span class="token function-name function">initNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	HBaseAdmin admin <span class="token operator">=</span> null<span class="token punctuation">;</span>
	try <span class="token punctuation">{<!-- --></span>
		admin <span class="token operator">=</span> new HBaseAdmin<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//命名空间类似于关系型数据库中的schema，可以想象成文件夹
		NamespaceDescriptor weibo <span class="token operator">=</span> NamespaceDescriptor
				.create<span class="token punctuation">(</span><span class="token string">"weibo"</span><span class="token punctuation">)</span>
				.addConfiguration<span class="token punctuation">(</span><span class="token string">"creator"</span>, <span class="token string">"Jinji"</span><span class="token punctuation">)</span>
				.addConfiguration<span class="token punctuation">(</span><span class="token string">"create_time"</span>, System.currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span> + <span class="token string">""</span><span class="token punctuation">)</span>
				.build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		admin.createNamespace<span class="token punctuation">(</span>weibo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>MasterNotRunningException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>ZooKeeperConnectionException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>finally<span class="token punctuation">{<!-- --></span>
		if<span class="token punctuation">(</span>null <span class="token operator">!=</span> admin<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			try <span class="token punctuation">{<!-- --></span>
				admin.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="823__1197"></a>8.2.3 创建微博内容表</h5> 
<p>表结构：<br> 方法名 creatTableeContent<br> Table Name weibo:content<br> RowKey 用户ID_时间戳<br> ColumnFamily info<br> ColumnLabel 标题,内容,图片<br> Version 1个版本<br> 代码：</p> 
<pre><code class="prism language-bash">/**
 * 创建微博内容表
 * Table Name:weibo:content
 * RowKey:用户ID_时间戳
 * ColumnFamily:info
 * ColumnLabel:标题	内容		图片URL
 * Version:1个版本
 */
public void <span class="token function-name function">createTableContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	HBaseAdmin admin <span class="token operator">=</span> null<span class="token punctuation">;</span>
	try <span class="token punctuation">{<!-- --></span>
		admin <span class="token operator">=</span> new HBaseAdmin<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//创建表表述
		HTableDescriptor content <span class="token operator">=</span> new HTableDescriptor<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_CONTENT<span class="token punctuation">))</span><span class="token punctuation">;</span>
		//创建列族描述
		HColumnDescriptor info <span class="token operator">=</span> new HColumnDescriptor<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
		//设置块缓存
		info.setBlockCacheEnabled<span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//设置块缓存大小
		info.setBlocksize<span class="token punctuation">(</span><span class="token number">2097152</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		//设置压缩方式
//			info.setCompressionType<span class="token punctuation">(</span>Algorithm.SNAPPY<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//设置版本确界
		info.setMaxVersions<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		info.setMinVersions<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		content.addFamily<span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
		admin.createTable<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>MasterNotRunningException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>ZooKeeperConnectionException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>finally<span class="token punctuation">{<!-- --></span>
		if<span class="token punctuation">(</span>null <span class="token operator">!=</span> admin<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			try <span class="token punctuation">{<!-- --></span>
				admin.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="824__1255"></a>8.2.4 创建用户关系表</h5> 
<p>表结构：<br> 方法名 createTableRelations<br> Table Name weibo:relations<br> RowKey 用户ID<br> ColumnFamily attends、fans<br> ColumnLabel 关注用户ID，粉丝用户ID<br> ColumnValue 用户ID<br> Version 1个版本<br> 代码：</p> 
<pre><code class="prism language-bash">/**
 * 用户关系表
 * Table Name:weibo:relations
 * RowKey:用户ID
 * ColumnFamily:attends,fans
 * ColumnLabel:关注用户ID，粉丝用户ID
 * ColumnValue:用户ID
 * Version：1个版本
 */
public void <span class="token function-name function">createTableRelations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	HBaseAdmin admin <span class="token operator">=</span> null<span class="token punctuation">;</span>
	try <span class="token punctuation">{<!-- --></span>
		admin <span class="token operator">=</span> new HBaseAdmin<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		HTableDescriptor relations <span class="token operator">=</span> new HTableDescriptor<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_RELATIONS<span class="token punctuation">))</span><span class="token punctuation">;</span>
		
		//关注的人的列族
		HColumnDescriptor attends <span class="token operator">=</span> new HColumnDescriptor<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"attends"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
		//设置块缓存
		attends.setBlockCacheEnabled<span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//设置块缓存大小
		attends.setBlocksize<span class="token punctuation">(</span><span class="token number">2097152</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		//设置压缩方式
//			info.setCompressionType<span class="token punctuation">(</span>Algorithm.SNAPPY<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//设置版本确界
		attends.setMaxVersions<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		attends.setMinVersions<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		//粉丝列族
		HColumnDescriptor fans <span class="token operator">=</span> new HColumnDescriptor<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"fans"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
		fans.setBlockCacheEnabled<span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
		fans.setBlocksize<span class="token punctuation">(</span><span class="token number">2097152</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		fans.setMaxVersions<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		fans.setMinVersions<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		
		relations.addFamily<span class="token punctuation">(</span>attends<span class="token punctuation">)</span><span class="token punctuation">;</span>
		relations.addFamily<span class="token punctuation">(</span>fans<span class="token punctuation">)</span><span class="token punctuation">;</span>
		admin.createTable<span class="token punctuation">(</span>relations<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>MasterNotRunningException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>ZooKeeperConnectionException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>finally<span class="token punctuation">{<!-- --></span>
		if<span class="token punctuation">(</span>null <span class="token operator">!=</span> admin<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			try <span class="token punctuation">{<!-- --></span>
				admin.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="825__1324"></a>8.2.5 创建微博收件箱表</h5> 
<p>表结构：<br> 方法名 createTableReceiveContentEmails<br> Table Name weibo:receive_content_email<br> RowKey 用户ID<br> ColumnFamily info<br> ColumnLabel 用户ID<br> ColumnValue 取微博内容的RowKey<br> Version 1000<br> 代码：</p> 
<pre><code class="prism language-bash">/**
 * 创建微博收件箱表
 * Table Name: weibo:receive_content_email
 * RowKey:用户ID
 * ColumnFamily:info
 * ColumnLabel:用户ID-发布微博的人的用户ID
 * ColumnValue:关注的人的微博的RowKey
 * Version:1000
 */
public void <span class="token function-name function">createTableReceiveContentEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	HBaseAdmin admin <span class="token operator">=</span> null<span class="token punctuation">;</span>
	try <span class="token punctuation">{<!-- --></span>
		admin <span class="token operator">=</span> new HBaseAdmin<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		HTableDescriptor receive_content_email <span class="token operator">=</span> new HTableDescriptor<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_RECEIVE_CONTENT_EMAIL<span class="token punctuation">))</span><span class="token punctuation">;</span>
		HColumnDescriptor info <span class="token operator">=</span> new HColumnDescriptor<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
		
		info.setBlockCacheEnabled<span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
		info.setBlocksize<span class="token punctuation">(</span><span class="token number">2097152</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		info.setMaxVersions<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		info.setMinVersions<span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		receive_content_email.addFamily<span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
		admin.createTable<span class="token punctuation">(</span>receive_content_email<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>MasterNotRunningException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>ZooKeeperConnectionException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>finally<span class="token punctuation">{<!-- --></span>
		if<span class="token punctuation">(</span>null <span class="token operator">!=</span> admin<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			try <span class="token punctuation">{<!-- --></span>
				admin.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token number">8.2</span>.6 发布微博内容
a、微博内容表中添加1条数据
b、微博收件箱表对所有粉丝用户添加数据
代码：Message.java
package com.atguigu.weibo<span class="token punctuation">;</span>

public class Message <span class="token punctuation">{<!-- --></span>
	private String uid<span class="token punctuation">;</span>
	private String timestamp<span class="token punctuation">;</span>
	private String content<span class="token punctuation">;</span>
	
	public String <span class="token function-name function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token builtin class-name">return</span> uid<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	public void setUid<span class="token punctuation">(</span>String uid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		this.uid <span class="token operator">=</span> uid<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	public String <span class="token function-name function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token builtin class-name">return</span> timestamp<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	public void setTimestamp<span class="token punctuation">(</span>String timestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		this.timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	public String <span class="token function-name function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token builtin class-name">return</span> content<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	public void setContent<span class="token punctuation">(</span>String content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		this.content <span class="token operator">=</span> content<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	@Override
	public String <span class="token function-name function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token builtin class-name">return</span> <span class="token string">"Message [uid="</span> + uid + <span class="token string">", timestamp="</span> + timestamp + <span class="token string">", content="</span> + content + <span class="token string">"]"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
代码：public void publishContent<span class="token punctuation">(</span>String uid, String content<span class="token punctuation">)</span>
/**
 * 发布微博
 * a、微博内容表中数据+1
 * b、向微博收件箱表中加入微博的Rowkey
 */
public void publishContent<span class="token punctuation">(</span>String uid, String content<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	HConnection connection <span class="token operator">=</span> null<span class="token punctuation">;</span>
	try <span class="token punctuation">{<!-- --></span>
		connection <span class="token operator">=</span> HConnectionManager.createConnection<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//a、微博内容表中添加1条数据，首先获取微博内容表描述
		HTableInterface contentTBL <span class="token operator">=</span> connection.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_CONTENT<span class="token punctuation">))</span><span class="token punctuation">;</span>
		//组装Rowkey
		long timestamp <span class="token operator">=</span> System.currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		String rowKey <span class="token operator">=</span> uid + <span class="token string">"_"</span> + timestamp<span class="token punctuation">;</span>
		
		Put put <span class="token operator">=</span> new Put<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>rowKey<span class="token punctuation">))</span><span class="token punctuation">;</span>
		put.add<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"content"</span><span class="token punctuation">)</span>, timestamp, Bytes.toBytes<span class="token punctuation">(</span>content<span class="token punctuation">))</span><span class="token punctuation">;</span>
		
		contentTBL.put<span class="token punctuation">(</span>put<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		//b、向微博收件箱表中加入发布的Rowkey
		//b.1、查询用户关系表，得到当前用户有哪些粉丝
		HTableInterface relationsTBL <span class="token operator">=</span> connection.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_RELATIONS<span class="token punctuation">))</span><span class="token punctuation">;</span>
		//b.2、取出目标数据
		Get get <span class="token operator">=</span> new Get<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>uid<span class="token punctuation">))</span><span class="token punctuation">;</span>
		get.addFamily<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"fans"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
		
		Result result <span class="token operator">=</span> relationsTBL.get<span class="token punctuation">(</span>get<span class="token punctuation">)</span><span class="token punctuation">;</span>
		List<span class="token operator">&lt;</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> fans <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		//遍历取出当前发布微博的用户的所有粉丝数据
		for<span class="token punctuation">(</span>Cell cell <span class="token builtin class-name">:</span> result.rawCells<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
			fans.add<span class="token punctuation">(</span>CellUtil.cloneQualifier<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		//如果该用户没有粉丝，则直接return
		if<span class="token punctuation">(</span>fans.size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token builtin class-name">return</span><span class="token punctuation">;</span>
		//开始操作收件箱表
		HTableInterface recTBL <span class="token operator">=</span> connection.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_RECEIVE_CONTENT_EMAIL<span class="token punctuation">))</span><span class="token punctuation">;</span>
		List<span class="token operator">&lt;</span>Put<span class="token operator">&gt;</span> puts <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span>Put<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		for<span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> fan <span class="token builtin class-name">:</span> fans<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			Put fanPut <span class="token operator">=</span> new Put<span class="token punctuation">(</span>fan<span class="token punctuation">)</span><span class="token punctuation">;</span>
			fanPut.add<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>uid<span class="token punctuation">)</span>, timestamp, Bytes.toBytes<span class="token punctuation">(</span>rowKey<span class="token punctuation">))</span><span class="token punctuation">;</span>
			puts.add<span class="token punctuation">(</span>fanPut<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		recTBL.put<span class="token punctuation">(</span>puts<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>finally<span class="token punctuation">{<!-- --></span>
		if<span class="token punctuation">(</span>null <span class="token operator">!=</span> connection<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			try <span class="token punctuation">{<!-- --></span>
				connection.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="827__1469"></a>8.2.7 添加关注用户</h5> 
<p>a、在微博用户关系表中，对当前主动操作的用户添加新关注的好友<br> b、在微博用户关系表中，对被关注的用户添加新的粉丝<br> c、微博收件箱表中添加所关注的用户发布的微博<br> 代码实现：</p> 
<pre><code class="prism language-bash">public void addAttends<span class="token punctuation">(</span>String uid, String<span class="token punctuation">..</span>. attends<span class="token punctuation">)</span>
/**
 * 关注用户逻辑
 * a、在微博用户关系表中，对当前主动操作的用户添加新的关注的好友
 * b、在微博用户关系表中，对被关注的用户添加粉丝（当前操作的用户）
 * c、当前操作用户的微博收件箱添加所关注的用户发布的微博rowkey
 */
public void addAttends<span class="token punctuation">(</span>String uid, String<span class="token punctuation">..</span>. attends<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	//参数过滤
	if<span class="token punctuation">(</span>attends <span class="token operator">==</span> null <span class="token operator">||</span> attends.length <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> uid <span class="token operator">==</span> null <span class="token operator">||</span> uid.length<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token builtin class-name">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	HConnection connection <span class="token operator">=</span> null<span class="token punctuation">;</span>
	try <span class="token punctuation">{<!-- --></span>
		connection <span class="token operator">=</span> HConnectionManager.createConnection<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//用户关系表操作对象（连接到用户关系表）
		HTableInterface relationsTBL <span class="token operator">=</span> connection.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_RELATIONS<span class="token punctuation">))</span><span class="token punctuation">;</span>
		List<span class="token operator">&lt;</span>Put<span class="token operator">&gt;</span> puts <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span>Put<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		//a、在微博用户关系表中，添加新关注的好友
		Put attendPut <span class="token operator">=</span> new Put<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>uid<span class="token punctuation">))</span><span class="token punctuation">;</span>
		for<span class="token punctuation">(</span>String attend <span class="token builtin class-name">:</span> attends<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			//为当前用户添加关注的人
			attendPut.add<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"attends"</span><span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>attend<span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>attend<span class="token punctuation">))</span><span class="token punctuation">;</span>
			//b、为被关注的人，添加粉丝
			Put fansPut <span class="token operator">=</span> new Put<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>attend<span class="token punctuation">))</span><span class="token punctuation">;</span>
			fansPut.add<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"fans"</span><span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>uid<span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>uid<span class="token punctuation">))</span><span class="token punctuation">;</span>
			//将所有关注的人一个一个的添加到puts（List）集合中
			puts.add<span class="token punctuation">(</span>fansPut<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		puts.add<span class="token punctuation">(</span>attendPut<span class="token punctuation">)</span><span class="token punctuation">;</span>
		relationsTBL.put<span class="token punctuation">(</span>puts<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		//c.1、微博收件箱添加关注的用户发布的微博内容（content）的rowkey
		HTableInterface contentTBL <span class="token operator">=</span> connection.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_CONTENT<span class="token punctuation">))</span><span class="token punctuation">;</span>
		Scan scan <span class="token operator">=</span> new Scan<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		//用于存放取出来的关注的人所发布的微博的rowkey
		List<span class="token operator">&lt;</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> rowkeys <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		for<span class="token punctuation">(</span>String attend <span class="token builtin class-name">:</span> attends<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			//过滤扫描rowkey，即：前置位匹配被关注的人的uid_
			RowFilter filter <span class="token operator">=</span> new RowFilter<span class="token punctuation">(</span>CompareFilter.CompareOp.EQUAL, new SubstringComparator<span class="token punctuation">(</span>attend + <span class="token string">"_"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
			//为扫描对象指定过滤规则
			scan.setFilter<span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
			//通过扫描对象得到scanner
			ResultScanner result <span class="token operator">=</span> contentTBL.getScanner<span class="token punctuation">(</span>scan<span class="token punctuation">)</span><span class="token punctuation">;</span>
			//迭代器遍历扫描出来的结果集
			Iterator<span class="token operator">&lt;</span>Result<span class="token operator">&gt;</span> iterator <span class="token operator">=</span> result.iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			while<span class="token punctuation">(</span>iterator.hasNext<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
				//取出每一个符合扫描结果的那一行数据
				Result r <span class="token operator">=</span> iterator.next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				for<span class="token punctuation">(</span>Cell cell <span class="token builtin class-name">:</span> r.rawCells<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
					//将得到的rowkey放置于集合容器中
					rowkeys.add<span class="token punctuation">(</span>CellUtil.cloneRow<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		
		//c.2、将取出的微博rowkey放置于当前操作用户的收件箱中
		if<span class="token punctuation">(</span>rowkeys.size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token builtin class-name">return</span><span class="token punctuation">;</span>
		//得到微博收件箱表的操作对象
		HTableInterface recTBL <span class="token operator">=</span> connection.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_RECEIVE_CONTENT_EMAIL<span class="token punctuation">))</span><span class="token punctuation">;</span>
		//用于存放多个关注的用户的发布的多条微博rowkey信息
		List<span class="token operator">&lt;</span>Put<span class="token operator">&gt;</span> recPuts <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span>Put<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		for<span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> rk <span class="token builtin class-name">:</span> rowkeys<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			Put put <span class="token operator">=</span> new Put<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>uid<span class="token punctuation">))</span><span class="token punctuation">;</span>
			//uid_timestamp
			String rowKey <span class="token operator">=</span> Bytes.toString<span class="token punctuation">(</span>rk<span class="token punctuation">)</span><span class="token punctuation">;</span>
			//借取uid
			String attendUID <span class="token operator">=</span> rowKey.substring<span class="token punctuation">(</span><span class="token number">0</span>, rowKey.indexOf<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
			long timestamp <span class="token operator">=</span> Long.parseLong<span class="token punctuation">(</span>rowKey.substring<span class="token punctuation">(</span>rowKey.indexOf<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span> + <span class="token number">1</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
			//将微博rowkey添加到指定单元格中
			put.add<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>attendUID<span class="token punctuation">)</span>, timestamp, rk<span class="token punctuation">)</span><span class="token punctuation">;</span>
			recPuts.add<span class="token punctuation">(</span>put<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		recTBL.put<span class="token punctuation">(</span>recPuts<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>finally<span class="token punctuation">{<!-- --></span>
		if<span class="token punctuation">(</span>null <span class="token operator">!=</span> connection<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			try <span class="token punctuation">{<!-- --></span>
				connection.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				// TODO Auto-generated catch block
				e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="828__1569"></a>8.2.8 移除（取关）用户</h5> 
<p>a、在微博用户关系表中，对当前主动操作的用户移除取关的好友(attends)<br> b、在微博用户关系表中，对被取关的用户移除粉丝<br> c、微博收件箱中删除取关的用户发布的微博<br> 代码：</p> 
<pre><code class="prism language-bash">public void removeAttends<span class="token punctuation">(</span>String uid, String<span class="token punctuation">..</span>. attends<span class="token punctuation">)</span>
/**
 * 取消关注（remove<span class="token punctuation">)</span>
 * a、在微博用户关系表中，对当前主动操作的用户删除对应取关的好友
 * b、在微博用户关系表中，对被取消关注的人删除粉丝（当前操作人）
 * c、从收件箱中，删除取关的人的微博的rowkey
 */
public void removeAttends<span class="token punctuation">(</span>String uid, String<span class="token punctuation">..</span>. attends<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	//过滤数据
	if<span class="token punctuation">(</span>uid <span class="token operator">==</span> null <span class="token operator">||</span> uid.length<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> attends <span class="token operator">==</span> null <span class="token operator">||</span> attends.length <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token builtin class-name">return</span><span class="token punctuation">;</span>
	HConnection connection <span class="token operator">=</span> null<span class="token punctuation">;</span>
	
	try <span class="token punctuation">{<!-- --></span>
		connection <span class="token operator">=</span> HConnectionManager.createConnection<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		//a、在微博用户关系表中，删除已关注的好友
		HTableInterface relationsTBL <span class="token operator">=</span> connection.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_RELATIONS<span class="token punctuation">))</span><span class="token punctuation">;</span>
		
		//待删除的用户关系表中的所有数据
		List<span class="token operator">&lt;</span>Delete<span class="token operator">&gt;</span> deletes <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span>Delete<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		//当前取关操作者的uid对应的Delete对象
		Delete attendDelete <span class="token operator">=</span> new Delete<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>uid<span class="token punctuation">))</span><span class="token punctuation">;</span>
		//遍历取关，同时每次取关都要将被取关的人的粉丝-1
		for<span class="token punctuation">(</span>String attend <span class="token builtin class-name">:</span> attends<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			attendDelete.deleteColumn<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"attends"</span><span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>attend<span class="token punctuation">))</span><span class="token punctuation">;</span>
			//b
			Delete fansDelete <span class="token operator">=</span> new Delete<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>attend<span class="token punctuation">))</span><span class="token punctuation">;</span>
			fansDelete.deleteColumn<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"fans"</span><span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>uid<span class="token punctuation">))</span><span class="token punctuation">;</span>
			deletes.add<span class="token punctuation">(</span>fansDelete<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		deletes.add<span class="token punctuation">(</span>attendDelete<span class="token punctuation">)</span><span class="token punctuation">;</span>
		relationsTBL.delete<span class="token punctuation">(</span>deletes<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		//c、删除取关的人的微博rowkey 从 收件箱表中
		HTableInterface recTBL <span class="token operator">=</span> connection.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_RECEIVE_CONTENT_EMAIL<span class="token punctuation">))</span><span class="token punctuation">;</span>
		
		Delete recDelete <span class="token operator">=</span> new Delete<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>uid<span class="token punctuation">))</span><span class="token punctuation">;</span>
		for<span class="token punctuation">(</span>String attend <span class="token builtin class-name">:</span> attends<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			recDelete.deleteColumn<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">)</span>, Bytes.toBytes<span class="token punctuation">(</span>attend<span class="token punctuation">))</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		recTBL.delete<span class="token punctuation">(</span>recDelete<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token number">8.2</span>.9 获取关注的人的微博内容
a、从微博收件箱中获取所关注的用户的微博RowKey 
b、根据获取的RowKey，得到微博内容
代码实现：public List<span class="token operator">&lt;</span>Message<span class="token operator">&gt;</span> getAttendsContent<span class="token punctuation">(</span>String uid<span class="token punctuation">)</span>
/**
 * 获取微博实际内容
 * a、从微博收件箱中获取所有关注的人的发布的微博的rowkey
 * b、根据得到的rowkey去微博内容表中得到数据
 * c、将得到的数据封装到Message对象中
 */
public List<span class="token operator">&lt;</span>Message<span class="token operator">&gt;</span> getAttendsContent<span class="token punctuation">(</span>String uid<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	HConnection connection <span class="token operator">=</span> null<span class="token punctuation">;</span>
	try <span class="token punctuation">{<!-- --></span>
		connection <span class="token operator">=</span> HConnectionManager.createConnection<span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		HTableInterface recTBL <span class="token operator">=</span> connection.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_RECEIVE_CONTENT_EMAIL<span class="token punctuation">))</span><span class="token punctuation">;</span>
		//a、从收件箱中取得微博rowKey
		Get get <span class="token operator">=</span> new Get<span class="token punctuation">(</span>Bytes.toBytes<span class="token punctuation">(</span>uid<span class="token punctuation">))</span><span class="token punctuation">;</span>
		//设置最大版本号
		get.setMaxVersions<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		List<span class="token operator">&lt;</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> rowkeys <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		Result result <span class="token operator">=</span> recTBL.get<span class="token punctuation">(</span>get<span class="token punctuation">)</span><span class="token punctuation">;</span>
		for<span class="token punctuation">(</span>Cell cell <span class="token builtin class-name">:</span> result.rawCells<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
			rowkeys.add<span class="token punctuation">(</span>CellUtil.cloneValue<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		//b、根据取出的所有rowkey去微博内容表中检索数据
		HTableInterface contentTBL <span class="token operator">=</span> connection.getTable<span class="token punctuation">(</span>TableName.valueOf<span class="token punctuation">(</span>TABLE_CONTENT<span class="token punctuation">))</span><span class="token punctuation">;</span>
		List<span class="token operator">&lt;</span>Get<span class="token operator">&gt;</span> gets <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span>Get<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		//根据rowkey取出对应微博的具体内容
		for<span class="token punctuation">(</span>byte<span class="token punctuation">[</span><span class="token punctuation">]</span> rk <span class="token builtin class-name">:</span> rowkeys<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			Get g <span class="token operator">=</span> new Get<span class="token punctuation">(</span>rk<span class="token punctuation">)</span><span class="token punctuation">;</span>
			gets.add<span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		//得到所有的微博内容的result对象
		Result<span class="token punctuation">[</span><span class="token punctuation">]</span> results <span class="token operator">=</span> contentTBL.get<span class="token punctuation">(</span>gets<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		List<span class="token operator">&lt;</span>Message<span class="token operator">&gt;</span> messages <span class="token operator">=</span> new ArrayList<span class="token operator">&lt;</span>Message<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		for<span class="token punctuation">(</span>Result res <span class="token builtin class-name">:</span> results<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			for<span class="token punctuation">(</span>Cell cell <span class="token builtin class-name">:</span> res.rawCells<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">{<!-- --></span>
				Message message <span class="token operator">=</span> new Message<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				String rowKey <span class="token operator">=</span> Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneRow<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">;</span>
				String userid <span class="token operator">=</span> rowKey.substring<span class="token punctuation">(</span><span class="token number">0</span>, rowKey.indexOf<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
				String timestamp <span class="token operator">=</span> rowKey.substring<span class="token punctuation">(</span>rowKey.indexOf<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span> + <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				String content <span class="token operator">=</span> Bytes.toString<span class="token punctuation">(</span>CellUtil.cloneValue<span class="token punctuation">(</span>cell<span class="token punctuation">))</span><span class="token punctuation">;</span>
				
				message.setContent<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
				message.setTimestamp<span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
				message.setUid<span class="token punctuation">(</span>userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
				
				messages.add<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token builtin class-name">return</span> messages<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>finally<span class="token punctuation">{<!-- --></span>
		try <span class="token punctuation">{<!-- --></span>
			connection.close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token builtin class-name">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="8210__1687"></a>8.2.10 测试</h5> 
<pre><code class="prism language-bash">-- 测试发布微博内容 
public void testPublishContent<span class="token punctuation">(</span>WeiBo wb<span class="token punctuation">)</span>
-- 测试添加关注
public void testAddAttend<span class="token punctuation">(</span>WeiBo wb<span class="token punctuation">)</span>
-- 测试取消关注
public void testRemoveAttend<span class="token punctuation">(</span>WeiBo wb<span class="token punctuation">)</span>
-- 测试展示内容
public void testShowMessage<span class="token punctuation">(</span>WeiBo wb<span class="token punctuation">)</span>	
</code></pre> 
<p>代码：</p> 
<pre><code class="prism language-bash">/**
 * 发布微博内容
 * 添加关注
 * 取消关注
 * 展示内容
 */
public void testPublishContent<span class="token punctuation">(</span>WeiBo wb<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	wb.publishContent<span class="token punctuation">(</span><span class="token string">"0001"</span>, <span class="token string">"今天买了一包空气，送了点薯片，非常开心！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	wb.publishContent<span class="token punctuation">(</span><span class="token string">"0001"</span>, <span class="token string">"今天天气不错。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

public void testAddAttend<span class="token punctuation">(</span>WeiBo wb<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	wb.publishContent<span class="token punctuation">(</span><span class="token string">"0008"</span>, <span class="token string">"准备下课！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	wb.publishContent<span class="token punctuation">(</span><span class="token string">"0009"</span>, <span class="token string">"准备关机！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	wb.addAttends<span class="token punctuation">(</span><span class="token string">"0001"</span>, <span class="token string">"0008"</span>, <span class="token string">"0009"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

public void testRemoveAttend<span class="token punctuation">(</span>WeiBo wb<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	wb.removeAttends<span class="token punctuation">(</span><span class="token string">"0001"</span>, <span class="token string">"0008"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

public void testShowMessage<span class="token punctuation">(</span>WeiBo wb<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	List<span class="token operator">&lt;</span>Message<span class="token operator">&gt;</span> messages <span class="token operator">=</span> wb.getAttendsContent<span class="token punctuation">(</span><span class="token string">"0001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	for<span class="token punctuation">(</span>Message message <span class="token builtin class-name">:</span> messages<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		System.out.println<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-bash">public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	WeiBo weibo <span class="token operator">=</span> new WeiBo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	weibo.initTable<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	weibo.testPublishContent<span class="token punctuation">(</span>weibo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	weibo.testAddAttend<span class="token punctuation">(</span>weibo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	weibo.testShowMessage<span class="token punctuation">(</span>weibo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	weibo.testRemoveAttend<span class="token punctuation">(</span>weibo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	weibo.testShowMessage<span class="token punctuation">(</span>weibo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="9__1744"></a>第9章 扩展</h4> 
<h5><a id="91_HBase_1745"></a>9.1 HBase在商业项目中的能力</h5> 
<p>每天：</p> 
<ol><li>消息量：发送和接收的消息数超过60亿</li><li>将近1000亿条数据的读写</li><li>高峰期每秒150万左右操作</li><li>整体读取数据占有约55%，写入占有45%</li><li>超过2PB的数据，涉及冗余共6PB数据</li><li>数据每月大概增长300千兆字节。</li></ol> 
<h5><a id="92__1753"></a>9.2 布隆过滤器</h5> 
<p>在日常生活中，包括在设计计算机软件时，我们经常要判断一个元素是否在一个集合中。比如在字处理软件中，需要检查一个英语单词是否拼写正确（也就是要判断它是否在已知的字典中）；在 FBI，一个嫌疑人的名字是否已经在嫌疑名单上；在网络爬虫里，一个网址是否被访问过等等。最直接的方法就是将集合中全部的元素存在计算机中，遇到一个新元素时，将它和集合中的元素直接比较即可。一般来讲，计算机中的集合是用哈希表（hash table）来存储的。它的好处是快速准确，缺点是费存储空间。当集合比较小时，这个问题不显著，但是当集合巨大时，哈希表存储效率低的问题就显现出来了。比如说，一个像 Yahoo,Hotmail 和 Gmai 那样的公众电子邮件（email）提供商，总是需要过滤来自发送垃圾邮件的人（spamer）的垃圾邮件。一个办法就是记录下那些发垃圾邮件的 email 地址。由于那些发送者不停地在注册新的地址，全世界少说也有几十亿个发垃圾邮件的地址，将他们都存起来则需要大量的网络服务器。如果用哈希表，每存储一亿个 email 地址， 就需要 1.6GB 的内存（用哈希表实现的具体办法是将每一个 email 地址对应成一个八字节的信息指纹googlechinablog.com/2006/08/blog-post.html，然后将这些信息指纹存入哈希表，由于哈希表的存储效率一般只有 50%，因此一个 email 地址需要占用十六个字节。一亿个地址大约要 1.6GB， 即十六亿字节的内存）。因此存贮几十亿个邮件地址可能需要上百 GB 的内存。除非是超级计算机，一般服务器是无法存储的。<br> 布隆过滤器只需要哈希表 1/8 到 1/4 的大小就能解决同样的问题。<br> Bloom Filter是一种空间效率很高的随机数据结构，它利用位数组很简洁地表示一个集合，并能判断一个元素是否属于这个集合。Bloom Filter的这种高效是有一定代价的：在判断一个元素是否属于某个集合时，有可能会把不属于这个集合的元素误认为属于这个集合（false positive）。因此，Bloom Filter不适合那些“零错误”的应用场合。而在能容忍低错误率的应用场合下，Bloom Filter通过极少的错误换取了存储空间的极大节省。</p> 
<h5><a id="92_HBase20_1757"></a>9.2 HBase2.0新特性</h5> 
<p>2017年8月22日凌晨2点左右，HBase发布了2.0.0 alpha-2，相比于上一个版本，修复了500个补丁，我们来了解一下2.0版本的HBase新特性。<br> 最新文档：<br> <a href="http://hbase.apache.org/book.html#ttl" rel="nofollow">http://hbase.apache.org/book.html#ttl</a><br> 官方发布主页：<br> <a href="http://mail-archives.apache.org/mod_mbox/www-announce/201708.mbox/%3CCADcMMgFzmX0xYYso-UAYbU7V8z-Obk1J4pxzbGkRzbP5Hps+iA@mail.gmail.com" rel="nofollow">http://mail-archives.apache.org/mod_mbox/www-announce/201708.mbox/&lt;CADcMMgFzmX0xYYso-UAYbU7V8z-Obk1J4pxzbGkRzbP5Hps+iA@mail.gmail.com</a><br> 举例：</p> 
<ol><li>region进行了多份冗余<br> 主region负责读写，从region维护在其他HregionServer中，负责读以及同步主region中的信息，如果同步不及时，是有可能出现client在从region中读到了脏数据（主region还没来得及把memstore中的变动的内容flush）。</li><li>更多变动可以去看：<br> <a href="https://issues.apache.org/jira/secure/ReleaseNote.jspa?version=12340859&amp;styleName=&amp;projectId=12310753&amp;Create=Create&amp;atl_token=A5KQ-2QAV-T4JA-FDED%7Ce6f233490acdf4785b697d4b457f7adb0a72b69f%7Clout" rel="nofollow">https://issues.apache.org/jira/secure/ReleaseNote.jspa?version=12340859&amp;styleName=&amp;projectId=12310753&amp;Create=Create&amp;atl_token=A5KQ-2QAV-T4JA-FDED%7Ce6f233490acdf4785b697d4b457f7adb0a72b69f%7Clout</a></li></ol> 
<p>最近有点忙，我发现自己感觉到累的时候，能学到很多，发现很多问题，这个感觉就对了，有压力才有动力，找出问题不断进步。<br> 想起了毛泽东同志的一句名言：“我们的同志要在困难的时候，要看到成绩，要看到光明，要提高我们的勇气”。<br> 兄弟们一起加油，一起变强！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2f286795f2cd17674a324ba7b1ef35b2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android studio中如何导入jar包（详细教程）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f2e29f1597f95a93ab5b6f9b0eaea70b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LSTM时间序列预测MATLAB代码模板（无需调试）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>