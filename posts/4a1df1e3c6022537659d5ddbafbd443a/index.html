<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Oracle-查询表空间使用率很慢 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/4a1df1e3c6022537659d5ddbafbd443a/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Oracle-查询表空间使用率很慢">
  <meta property="og:description" content="近期发现，因数据库监控指标采集比较频繁，甚至触发等待。
解决方案如下：
1、调整采集周期。现行的10S采集频率太高。
2、优化表空间查询语句。
3、考虑回收站原因： 3.1：查询回收站大小：
SYS@evansdb2&gt; SELECT count(*) FROM dba_recyclebin;
COUNT(*)
----------
127
SYS@evansdb2&gt; SELECT value FROM v$parameter WHERE name = &#39;recyclebin&#39;;
VALUE
---------------
OFF
3.3：清空全库回收站
SYS@evansdb2&gt; purge DBA_RECYCLEBIN;
DBA Recyclebin purged.
3.4 再次查询回收站大小：
SYS@evansdb2&gt; SELECT count(*) FROM dba_recyclebin;
COUNT(*)
----------
0
3.5 再次查询回收站大小：
SYS@evansdb2&gt; SELECT count(*) FROM dba_recyclebin;
COUNT(*)
----------
0
3.6 收集统计信息：
SYS@evansdb2&gt; exec dbms_stats.gather_table_stats(ownname =&gt; &#39;SYS&#39;,tabname =&gt; &#39;RECYCLEBIN$&#39;, estimate_percent =&gt; 100, method_opt=&gt; &#39;for all indexed columns&#39;,degree=&gt;8);">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-08T10:57:47+08:00">
    <meta property="article:modified_time" content="2024-07-08T10:57:47+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Oracle-查询表空间使用率很慢</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>近期发现，因数据库监控指标采集比较频繁，甚至触发等待。</p> 
<p>解决方案如下：</p> 
<p>1、调整采集周期。现行的10S采集频率太高。</p> 
<p>2、优化表空间查询语句。</p> 
<p>3、考虑回收站原因：  </p> 
<blockquote> 
 <p> 3.1：查询回收站大小：<br> SYS@evansdb2&gt; SELECT count(*) FROM dba_recyclebin;<br>   COUNT(*)<br> ----------<br>        127</p> 
 <p>SYS@evansdb2&gt; SELECT value FROM v$parameter WHERE name = 'recyclebin';<br> VALUE<br> ---------------<br> OFF</p> 
 <p>3.3：清空全库回收站<br> SYS@evansdb2&gt; purge DBA_RECYCLEBIN;<br> DBA Recyclebin purged.</p> 
 <p>3.4 再次查询回收站大小：<br> SYS@evansdb2&gt; SELECT count(*) FROM dba_recyclebin;<br>   COUNT(*)<br> ----------<br>          0</p> 
 <p>3.5 再次查询回收站大小：<br> SYS@evansdb2&gt; SELECT count(*) FROM dba_recyclebin;<br>   COUNT(*)<br> ----------<br>          0</p> 
 <p>3.6 收集统计信息：<br> SYS@evansdb2&gt; exec dbms_stats.gather_table_stats(ownname =&gt; 'SYS',tabname =&gt;  'RECYCLEBIN$', estimate_percent =&gt; 100, method_opt=&gt; 'for all indexed columns',degree=&gt;8);<br> PL/SQL procedure successfully completed.<br> 3.7 重新查询表空间使用率<br> SYS@evansdb2&gt; set linesize 200 pagesize 999  long 20000 <br> set timi on ti on<br> col name format a30   <br> col contents format a9   <br> col extent_management format a8   <br> col size_mb format a12   <br> col Used_MB format a12   <br> col free_mb format a12   <br> col "Used%" format a8   <br> col dt format a20   </p> 
 <p>SELECT d.tablespace_name Name, <br>        d.status, <br>        d.contents, <br>        d.extent_management, <br>        d.segment_space_management, <br>        a.file_cnt, <br>        TO_CHAR(NVL(a.bytes/1048576, 0), '999G999G999') SIZE_MB, <br>        TO_CHAR(DECODE(d.contents,'UNDO',NVL(u.bytes, 0)/1048576,NVL(a.bytes - NVL(f.bytes, 0), 0)/1048576),'999G999G999') Used_MB, <br>        TO_CHAR(DECODE(d.contents,'UNDO',NVL(a.bytes - NVL(u.bytes, 0), 0)/1048576,NVL(f.bytes, 0)/1048576), '999G999G999') FREE_MB, <br>        TO_CHAR(DECODE(d.contents,'UNDO',NVL(u.bytes/a.bytes * 100, 0),NVL((a.bytes - NVL(f.bytes, 0))/a.bytes * 100, 0)),'990D00') "Used%", <br>        TO_CHAR(sysdate, 'yyyy-mm-dd hh24:mi:ss') dt <br>   FROM sys.dba_tablespaces d, <br>        (SELECT tablespace_name, SUM(bytes) bytes, COUNT(file_id) file_cnt <br>           from dba_data_files <br>          GROUP BY tablespace_name) a, <br>        (select tablespace_name, sum(bytes) bytes <br>           from dba_free_space <br>          group by tablespace_name) f, <br>        (SELECT tablespace_name, SUM(bytes) bytes <br>           FROM (SELECT tablespace_name, sum(bytes) bytes, status <br>                   from dba_undo_extents <br>                  WHERE status = 'ACTIVE' <br>                  group by tablespace_name, status <br>                 UNION ALL <br>                 SELECT tablespace_name, sum(bytes) bytes, status <br>                   from dba_undo_extents <br>                  WHERE status = 'UNEXPIRED' <br>                  group by tablespace_name, status) <br>          group by tablespace_name) u <br>  WHERE d.tablespace_name = a.tablespace_name(+) <br>    AND d.tablespace_name = f.tablespace_name(+) <br>    AND d.tablespace_name = u.tablespace_name(+) <br>    AND NOT (d.extent_management = 'LOCAL' AND d.contents = 'TEMPORARY') <br> UNION ALL <br> SELECT d.tablespace_name, <br>        d.status, <br>        d.contents, <br>        d.extent_management, <br>        d.segment_space_management, <br>        a.file_cnt, <br>        TO_CHAR(NVL(a.bytes/1048576, 0), '999G999G999') SIZE_MB, <br>        TO_CHAR(NVL(t.bytes, 0)/1048576, '999G999G999') Used_MB, <br>        TO_CHAR((NVL(a.bytes, 0)/1048576 - NVL(t.bytes, 0)/1048576),'999G999G999') FREE_MB, <br>        TO_CHAR(NVL(t.bytes/a.bytes * 100, 0), '990D00') "Used%", <br>        TO_CHAR(sysdate, 'yyyy-mm-dd hh24:mi:ss') dt <br>   FROM sys.dba_tablespaces d, <br>        (select tablespace_name, sum(bytes) bytes, count(file_id) file_cnt <br>           from dba_temp_files <br>          group by tablespace_name) a, <br>        (select ss.tablespace_name, <br>                sum((ss.used_blocks * ts.blocksize)) bytes <br>           from gv$sort_segment ss, sys.ts$ ts <br>          where ss.tablespace_name = ts.name <br>          group by ss.tablespace_name) t <br>  WHERE d.tablespace_name = a.tablespace_name(+) <br>    AND d.tablespace_name = t.tablespace_name(+) <br>    AND d.extent_management = 'LOCAL' <br>    AND d.contents = 'TEMPORARY' <br>  ORDER BY "Used%"; </p> 
 <p></p> 
</blockquote> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0a77a79e05cc1c1aafa6c25500d21ea0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ios的info.plist 配置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6c8d98d5672495ecf2273efeb70b4397/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【QT】多元素控件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>