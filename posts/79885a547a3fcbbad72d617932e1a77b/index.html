<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FastAPI &#43; NGINX &#43; Gunicorn：一步一步教你部署一个高性能的Python网页应用 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/79885a547a3fcbbad72d617932e1a77b/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="FastAPI &#43; NGINX &#43; Gunicorn：一步一步教你部署一个高性能的Python网页应用">
  <meta property="og:description" content="一、前言 部署一个 FastAPI 应用到你的服务器是一项复杂的任务。如果你对NGINX、Gunicorn和 Uvicorn 这些技术不熟悉，可能会浪费大量的时间。如果你是刚接触 Python 语言不久或者希望利用 Python 构建自己的Web应用程序，本文的内容可能会让你第一次部署时更节省时间。
FastAPI 是用于开发API应用最受欢迎的Python库之一，用于开发API。它以其出色的性能和易用性而闻名。如果你在网页应用中使用机器学习模型，那么它很可能是你首选的工具。
NGINX、Gunicorn 和 Uvicorn 都是经过实践验证的技术，常被用作反向代理和ASGI服务器来部署Python网页应用。如果你熟悉 Django 或 Flask，你可能之前听说过它们中的一些。
接下来，我将展示如何结合这些工具来部署一个 FastAPI 网页应用。以下是主要内容：
介绍FastAPI、NGINX、Gunicorn和Uvicorn的基础知识。
配置Gunicorn &#43; Uvicorn作为ASGI服务器。
设置NGINX作为反向代理服务器。
使用Let&#39;s Encrypt生成免费SSL证书。
二、技术框架介绍 2.1、FastAPI FastAPI 是一个现代的、高性能的 Web 框架，用于使用 Python 构建 API，并基于标准类型提示。
它具有以下主要特点：
高效运行：借助 Starlette 和 pydantic，FastAPI 提供了与 NodeJS 和 Go 类似的出色性能。FastAPI比Flask快得多，它实际上是Python最快的Web框架之一。唯一比 FastAPI 更快的框架是 Starlette（FastAPI 实际上是基于 Starlette 构建的）。
快速开发：它可以显著提高开发速度。
减少错误：减少了人为错误的可能性。
直观易用：支持强大的编辑器功能、自动补全和更少的调试时间。
简单易学：设计简单明了，您可以花更少时间阅读文档。
减少重复代码量：最大限度地减少了代码重复。
健壮可靠：提供生产就绪的代码和自动生成交互式文档功能。
基于标准化：遵循 API、OpenAPI 和 JSON 模式等开放标准。
该框架旨在优化开发人员体验，使您能够以简洁的代码构建具备最佳实践且适合生产环境使用的 API。
2.2、Gunicorn Gunicorn是用于Python应用程序的WSGI服务器的一种实现。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-09-05T17:17:20+08:00">
    <meta property="article:modified_time" content="2023-09-05T17:17:20+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">FastAPI &#43; NGINX &#43; Gunicorn：一步一步教你部署一个高性能的Python网页应用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>一、前言</h3> 
<p>部署一个 <strong><em>FastAPI</em></strong> 应用到你的服务器是一项复杂的任务。如果你对<strong><em>NGINX</em></strong>、<strong><em>Gunicorn</em></strong>和 <strong><em>Uvicorn</em></strong> 这些技术不熟悉，可能会浪费大量的时间。如果你是刚接触 Python 语言不久或者希望利用 Python 构建自己的Web应用程序，本文的内容可能会让你第一次部署时更节省时间。</p> 
<p>FastAPI 是用于开发API应用最受欢迎的Python库之一，用于开发API。它以其出色的性能和易用性而闻名。如果你在网页应用中使用机器学习模型，那么它很可能是你首选的工具。</p> 
<p>NGINX、Gunicorn 和 Uvicorn 都是经过实践验证的技术，常被用作反向代理和ASGI服务器来部署Python网页应用。如果你熟悉 Django 或 Flask，你可能之前听说过它们中的一些。</p> 
<p><img alt="" height="312" src="https://images2.imgbox.com/91/83/jjPCnsPp_o.png" width="652"></p> 
<p>接下来，我将展示如何结合这些工具来部署一个 FastAPI 网页应用。以下是主要内容：</p> 
<ul><li> <p>介绍FastAPI、NGINX、Gunicorn和Uvicorn的基础知识。</p> </li><li> <p>配置Gunicorn + Uvicorn作为ASGI服务器。</p> </li><li> <p>设置NGINX作为反向代理服务器。</p> </li><li> <p>使用Let's Encrypt生成免费SSL证书。</p> </li></ul> 
<h3 id="-1">二、技术框架介绍</h3> 
<h4 id="21fastapi">2.1、FastAPI</h4> 
<p>FastAPI 是一个现代的、高性能的 Web 框架，用于使用 Python 构建 API，并基于标准类型提示。</p> 
<p><img alt="" height="1050" src="https://images2.imgbox.com/8c/37/pGgcEZRH_o.png" width="1200"></p> 
<p><strong>它具有以下主要特点：</strong></p> 
<ul><li> <p><strong><em>高效运行</em></strong>：借助 Starlette 和 pydantic，FastAPI 提供了与 NodeJS 和 Go 类似的出色性能。FastAPI比Flask快得多，它实际上是Python最快的Web框架之一。唯一比 FastAPI 更快的框架是 Starlette（FastAPI 实际上是基于 Starlette 构建的）。</p> </li><li> <p><strong><em>快速开发</em></strong>：它可以显著提高开发速度。</p> </li><li> <p><strong><em>减少错误</em></strong>：减少了人为错误的可能性。</p> </li><li> <p><strong><em>直观易用</em></strong>：支持强大的编辑器功能、自动补全和更少的调试时间。</p> </li><li> <p><strong><em>简单易学</em></strong>：设计简单明了，您可以花更少时间阅读文档。</p> </li><li> <p><strong><em>减少重复代码量</em></strong>：最大限度地减少了代码重复。</p> </li><li> <p><strong><em>健壮可靠</em></strong>：提供生产就绪的代码和自动生成交互式文档功能。</p> </li><li> <p><strong><em>基于标准化</em></strong>：遵循 API、OpenAPI 和 JSON 模式等开放标准。</p> </li></ul> 
<p>该框架旨在优化开发人员体验，使您能够以简洁的代码构建具备最佳实践且适合生产环境使用的 API。</p> 
<h4 id="22gunicorn">2.2、Gunicorn</h4> 
<p><strong>Gunicorn</strong>是用于Python应用程序的WSGI服务器的一种实现。</p> 
<p><strong>Gunicorn</strong>是一个符合<strong>WSGI</strong>标准的Web服务器，用于Python应用程序，它接收从<strong>客户端</strong>发送到Web<strong>服务器</strong>的请求，并将其转发到Python应用程序或<strong>Web框架</strong>（如Flask或Django）上，以便为请求运行适当的<strong>应用程序</strong>代码。</p> 
<p><img alt="" height="388" src="https://images2.imgbox.com/36/98/vKTT8I1Q_o.png" width="1200"></p> 
<h4 id="23uvicorn">2.3、Uvicorn</h4> 
<p>与Flask框架不同，FastAPI不包含任何内置的开发服务器。因此，我们需要<strong>Uvicorn</strong>。它实施<strong>ASGI</strong>标准，速度快如闪电。ASGI 代表 <strong>异步服务器网关接口</strong>。</p> 
<ul><li> <p>Uvicorn是Python的ASGI Web服务器实现。</p> </li><li> <p>Uvicorn目前支持HTTP / 1.1和WebSockets。</p> </li></ul> 
<h4 id="24nginx">2.4、Nginx</h4> 
<p>Nginx 是一个异步框架的 Web 服务器，也可以用作反向代理，负载平衡器 和 HTTP 缓存。该软件由 <a href="https://zh.wikipedia.org/wiki/%E4%BC%8A%E6%88%88%E7%88%BE%C2%B7%E8%B3%BD%E7%B4%A2%E8%80%B6%E5%A4%AB" rel="nofollow" title="Igor Sysoev">Igor Sysoev</a> 创建，并于2004年首次公开发布。同名公司成立于2011年，以提供支持。Nginx 是一款免费的开源软件，根据类 BSD 许可证的条款发布。一大部分Web服务器使用 Nginx ，通常作为负载均衡器。</p> 
<p><img alt="" height="359" src="https://images2.imgbox.com/47/db/D7EnISmG_o.png" width="638"></p> 
<p>Nginx 具备以下特点：</p> 
<ul><li> <p><strong><em>更快</em></strong>：单次请求会得到更快的响应；在高并发环境下，Nginx 比其他 WEB 服务器有更快的响应。</p> </li><li> <p><strong><em>高扩展性</em></strong>：Nginx 是基于模块化设计，由多个耦合度极低的模块组成，因此具有很高的扩展性。许多高流量的网站都倾向于开发符合自己业务特性的定制模块。</p> </li><li> <p><strong><em>高可靠性</em></strong>：Nginx 的可靠性来自于其核心框架代码的优秀设计，模块设计的简单性。另外，官方提供的常用模块都非常稳定，每个 worker 进程相对独立，master 进程在一个 worker 进程出错时可以快速拉起新的 worker 子进程提供服务。</p> </li><li> <p><strong><em>低内存消耗</em></strong>：一般情况下，10000个非活跃的 <code>HTTP Keep-Alive</code> 连接在 Nginx 中仅消耗 <code>2.5MB</code> 的内存，这是 Nginx 支持高并发连接的基础；单机支持10万以上的并发连接：理论上，Nginx 支持的并发连接上限取决于内存，10万远未封顶。</p> </li><li> <p><strong><em>热部署</em></strong>：master 进程与 worker 进程的分离设计，使得 Nginx 能够提供热部署功能，即在 7x24 小时不间断服务的前提下，升级 Nginx 的可执行文件。当然，它也支持不停止服务就更新配置项，更换日志文件等功能。</p> </li><li> <p><strong><em>最自由的 BSD 许可协议</em></strong>：这是 Nginx 可以快速发展的强大动力。BSD 许可协议不只是允许用户免费使用 Nginx ，它还允许用户在自己的项目中直接使用或修改 Nginx 源码，然后发布。</p> </li></ul> 
<h3 id="-2">三、服务器安全设置</h3> 
<p>如果你的应用部署在局域网，你可能暂时不需要关注这块，但如果你的应用是部署在云服务器或者VPS，为了保障你的应用安全性，建议还是需要对服务器做一些必要性的安全设置，避免被攻击。</p> 
<h4 id="31" style="background-color:transparent;">3.1、启用自动更新</h4> 
<p>首先，确保您的服务器拥有最新的软件：</p> 
<pre><code class="language-bash">sudo apt update &amp;&amp; sudo apt upgrade -y
</code></pre> 
<p>以下是在使用基于Debian的服务器时会看到的常见命令：</p> 
<ol><li> <p>使用命令<strong><em><code>sudo apt update</code></em></strong>来更新系统上的软件包列表索引。</p> </li><li> <p>使用命令<strong><em><code>sudo apt upgrade -y</code></em></strong>将已安装的软件包升级到最新版本。使用<strong><em><code>-y</code></em></strong>标志可以跳过确认步骤，直接进行安装。</p> </li></ol> 
<p>接下来，设置自动安全更新，这样就不必手动执行更新。为此，您需要安装并启用<strong><em><code>unnattended-upgrades</code></em></strong>：</p> 
<pre><code class="language-bash">sudo apt install unattended-upgrades
</code></pre> 
<p>安装完成后，编辑文件 <strong><em><code>/etc/apt/apt.conf.d/20auto-upgrades</code></em></strong> 并按照以下配置进行设置：</p> 
<pre><code>APT::Periodic::Update-Package-Lists "1";  # 每天自动更新软件包列表
APT::Periodic::Unattended-Upgrade "1";    # 系统将自动升级到最新版本的软件包
APT::Periodic::AutocleanInterval "7";     # 每周运行一次自动清理操作，删除旧的和不必要的包文件
</code></pre> 
<p>最后，在文件 <strong><em><code>/etc/apt/apt.conf.d/50unattended-upgrades</code></em></strong> 中进行编辑，以确保系统在需要内核更新时自动重新启动：</p> 
<pre><code>Unattended-Upgrade::Automatic-Reboot "true";
</code></pre> 
<p>完成以上步骤后，您的系统将自动执行安全更新，并在需要时重新启动以应用内核更新。</p> 
<h4 id="32root">3.2、创建非root用户</h4> 
<p>为了减少黑客攻击造成的损害，创建非root用户是必要的。以下是一些命令来创建非root用户和设置SSH密钥登录：</p> 
<ul><li>创建一个新的非root用户：</li></ul> 
<pre><code>sudo adduser fastapi-user # 将fastapi-user替换为您喜欢的用户名
</code></pre> 
<ul><li>将该用户添加到sudo组以获得管理员权限：</li></ul> 
<pre><code>sudo usermod -aG sudo fastapi-user # 将fastapi-user替换为您创建的用户名
</code></pre> 
<ul><li>使用新创建的用户登录服务器：</li></ul> 
<pre><code>su - fastapi-user # 使用新用户登录，将fastapi-user替换为您创建的用户名
</code></pre> 
<ol><li>设置使用SSH密钥进行身份验证：</li></ol> 
<p>如果您还没有SSH密钥，请在本地计算机上打开终端并运行以下命令（请注意将your-email-replace-with-your-email替换为您的实际电子邮件）：</p> 
<pre><code>ssh-keygen -t ed25519 -C "your-email-replace-with-your-email"
</code></pre> 
<p>这将生成一对SSH密钥。</p> 
<p>复制公共SSH密钥并将其粘贴到远程服务器上（请注意将your-public-key-replace-with-your-public-key替换为实际公共密钥）：</p> 
<pre><code>echo "your-public-key-replace-with-your-public-key" &gt;&gt; ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
</code></pre> 
<ul><li>禁用root登录和密码身份验证：</li></ul> 
<p>使用sudo权限编辑<strong><em><code>/etc/ssh/sshd_config</code></em></strong>文件（例如使用<strong><em><code>sudo vim /etc/ssh/sshd_config</code></em></strong>命令）。</p> 
<p>将以下行的值更改为所示：</p> 
<pre><code>PermitRootLogin no
PasswordAuthentication no
</code></pre> 
<p>这将禁止root用户登录和使用密码进行SSH身份验证。</p> 
<ul><li>保存并关闭文件后，重新启动SSH服务以使更改生效：</li></ul> 
<pre><code>sudo service ssh restart
</code></pre> 
<p>一旦完成上述步骤，请使用新创建的非root用户和SSH密钥进行登录，并确保禁用了root登录和密码身份验证。</p> 
<h4 id="33">3.3、其他安全措施</h4> 
<p>大多数云提供商都提供防火墙服务。如果您的云提供商不提供防火墙服务，您可以手动配置防火墙来限制传入流量只能到达必要的端口，例如<strong>80</strong>、<strong>443</strong>和<strong>22</strong>端口。</p> 
<p>另外，您还可以安装并配置<strong><em>fail2ban</em></strong>来预防暴力身份验证攻击。<strong><em>Fail2ban</em></strong>是一个用于保护Linux服务器免受恶意登录尝试的工具。它监视系统日志文件，并根据设定的规则自动禁止源IP地址。</p> 
<p>如果您想了解更多关于保护Linux服务器的最佳实践，请查看Linode提供的相关指南。这些指南将为您提供有关如何设置和增强服务器安全性的详细信息。</p> 
<h3>四、安装软件工具</h3> 
<p>为了安装必要的软件工具，请按照以下步骤执行：</p> 
<h4 id="41python">4.1、安装Python：</h4> 
<pre><code>sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update
sudo apt install python3.11 python3.11-venv -y
</code></pre> 
<h4 id="42supervisornginx">4.2、安装Supervisor和NGINX：</h4> 
<pre><code>sudo apt install supervisor nginx -y
</code></pre> 
<p><strong><em>Supervisor</em></strong> 是一个用于类Unix操作系统（包括Linux）的进程控制系统，它用于监视和管理程序的进程。NGINX是一种常用的多功能软件，通常用作反向代理来部署Web应用程序。</p> 
<h4 id="43supervisor">4.3、启用并启动Supervisor：</h4> 
<pre><code>sudo systemctl enable supervisor
sudo systemctl start supervisor
</code></pre> 
<p>使用<strong><em><code>enable</code></em></strong>命令将确保 Supervisor 在启动时自动启动，并使用<strong><em><code>start</code></em></strong>命令立即启动 Supervisor 服务。</p> 
<p>完成上述步骤后，您已成功安装 Python、Supervisor 和 NGINX，并已启用并启动了 Supervisor 服务。</p> 
<h3 id="fastapi">五、设置 FastAPI 应用程序</h3> 
<p>首先，将示例应用程序克隆到<strong><em><code>/home/fastapi-user</code></em></strong>目录下：</p> 
<pre><code>git clone https://github.com/dylanjcastillo/fastapi-nginx-gunicorn
</code></pre> 
<p>这将从公共存储库克隆代码。如果您要部署私有GitHub存储库中的应用程序，请设置GitHub部署密钥并使用该密钥克隆存储库。</p> 
<p>接下来，创建一个虚拟环境并激活它：</p> 
<pre><code>cd /home/fastapi-user/fastapi-nginx-gunicorn
python3.11 -m venv .venv
source .venv/bin/activate
</code></pre> 
<p>这些命令将使您进入项目目录，并在其中创建一个虚拟环境并激活它。一旦成功激活，您的命令行提示符前面应显示<strong><em><code>.venv</code></em></strong>。</p> 
<p>现在，使用 <strong><em>requirements.txt</em></strong> 文件中指定的依赖项安装所需的软件包：</p> 
<pre><code>pip install -r requirements.txt
</code></pre> 
<p>这将在当前虚拟环境中安装<strong><em>fastapi</em></strong>、<strong><em>gunicorn</em></strong>和<strong><em>uvicorn</em></strong>等软件包。</p> 
<p>为了验证一切是否顺利，运行应用程序：</p> 
<pre><code>uvicorn main:app
</code></pre> 
<p>运行此命令时不应出现任何错误。您还可以打开新终端窗口，并连接到服务器，然后使用以下命令发出请求来验证它是否正常工作：</p> 
<pre><code>curl http://localhost:8000
</code></pre> 
<p>您应该会收到以下响应：</p> 
<pre><code>{"message":"It's working!"}
</code></pre> 
<p>现在您已经成功运行了FastAPI应用程序，接下来将配置Gunicorn作为WSGI服务器。</p> 
<h3 id="gunicorn">六、配置Gunicorn</h3> 
<p>配置Gunicorn有两个步骤。首先，明确指定 <strong><em>Gunicorn</em></strong> 的配置要求。其次，设置Supervisor程序来运行Gunicorn。</p> 
<h4 id="61gunicorn">6.1 设置Gunicorn</h4> 
<p>首先，在项目目录中创建一个名为 <strong><em>gunicorn_start</em></strong> 的文件：</p> 
<pre><code>vim gunicorn_start
</code></pre> 
<p>然后，将以下内容添加到文件中：</p> 
<pre><code class="language-bash">#!/bin/bash

NAME=fastapi-app
DIR=/home/fastapi-user/fastapi-nginx-gunicorn
USER=fastapi-user
GROUP=fastapi-user
WORKERS=3
WORKER_CLASS=uvicorn.workers.UvicornWorker
VENV=$DIR/.venv/bin/activate
BIND=unix:$DIR/run/gunicorn.sock
LOG_LEVEL=error

cd $DIR
source $VENV

exec gunicorn main:app \
  --name $NAME \
  --workers $WORKERS \
  --worker-class $WORKER_CLASS \
  --user=$USER \
  --group=$GROUP \
  --bind=$BIND \
  --log-level=$LOG_LEVEL \
  --log-file=-
</code></pre> 
<p>这是您的设定解释：</p> 
<ul><li> <p>第1行表示此脚本将由bash shell执行。</p> </li><li> <p>第3行至第11行指定您将传递给Gunicorn的配置选项。大多数参数都是直观的，除了 <strong><em>WORKERS</em></strong>、<strong><em>WORKER_CLASS</em></strong> 和 <strong><em>BIND</em></strong> ：</p> </li><li> <p><strong><em>WORKERS</em></strong>：定义要使用的工作进程数量，通常建议使用CPU核心数+1。</p> </li><li> <p><strong><em>WORKER_CLASS</em></strong>：指定要使用的工作进程类型。在此示例中，您指定Uvicorn Worker作为ASGI服务器。</p> </li><li> <p><strong><em>BIND</em></strong>：指定Gunicorn绑定到的 <strong><em>server socket</em></strong>。</p> </li><li> <p>第13行和第14行将当前位置更改为项目目录并激活虚拟环境。</p> </li><li> <p>第16行至第24行使用指定的参数运行Gunicorn。</p> </li></ul> 
<p>保存并关闭文件。然后，通过运行以下命令使其可执行：</p> 
<pre><code>chmod u+x gunicorn_start
</code></pre> 
<p>最后，在项目目录中创建一个文件夹 <strong><em>run</em></strong> ，用于存储您在参数中定义的Unix套接字文件BIND：</p> 
<pre><code>mkdir run
</code></pre> 
<h4 id="62supervisor">6.2 配置Supervisor</h4> 
<p>首先，在项目目录中创建一个名为 <strong><em>logs</em></strong> 的目录，用于存储应用程序的错误日志：</p> 
<pre><code>mkdir logs
</code></pre> 
<p>接下来，通过运行以下命令创建Supervisor的配置文件：</p> 
<pre><code>sudo vim /etc/supervisor/conf.d/fastapi-app.conf
</code></pre> 
<p>复制并粘贴以下内容到文件中：</p> 
<pre><code class="language-bash">[program:fastapi-app]
command=/home/fastapi-user/fastapi-nginx-gunicorn/gunicorn_start
user=fastapi-user
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/home/fastapi-user/fastapi-nginx-gunicorn/logs/gunicorn-error.log
</code></pre> 
<p>此配置文件指定了之前创建的 <strong><em>gunicorn_start</em></strong> 脚本，并设置了 <strong><em>fastapi-user</em></strong> 作为用户。Supervisor 将在服务器启动时启动应用程序，并在应用程序失败时重新启动它。错误日志将记录在项目目录下 <strong><em>logs/gunicorn-error.log</em></strong> 文件中。</p> 
<p>重新加载Supervisor配置并重启服务，通过运行以下命令：</p> 
<pre><code>sudo supervisorctl reread
sudo supervisorctl update
</code></pre> 
<p>最后，您可以通过运行以下命令检查程序的状态：</p> 
<pre><code>sudo supervisorctl status fastapi-app
</code></pre> 
<p>如果一切顺利，<strong><em>fastapi-app</em></strong> 服务的状态应显示为 <strong><em>RUNNING</em></strong>。</p> 
<p>您还可以通过打开新的终端窗口，连接到服务器，并使用以下命令发出GET请求来测试它：</p> 
<pre><code>curl --unix-socket /home/fastapi-user/fastapi-nginx-gunicorn/run/gunicorn.sock localhost
</code></pre> 
<p>您应该会看到以下输出：</p> 
<pre><code>{"message":"It's working!"
</code></pre> 
<p>最后，如果您对代码进行了更改，可以通过运行以下命令重新启动服务以应用更改：</p> 
<pre><code>sudo supervisorctl restart fastapi-app
</code></pre> 
<p>现在您已经拥有一个使用Gunicorn和Uvicorn作为ASGI服务器的应用程序。接下来，您将使用NGINX设置反向代理服务器。</p> 
<h3 id="nginx">七、配置NGINX</h3> 
<p>为您的项目创建一个新的 <strong><em>NGINX</em></strong> 配置文件：</p> 
<pre><code>sudo vim /etc/nginx/sites-available/fastapi-app
</code></pre> 
<p>打开NGINX配置文件并粘贴以下内容：</p> 
<pre><code class="language-bash">upstream app_server {
    server unix:/home/fastapi-user/fastapi-nginx-gunicorn/run/gunicorn.sock fail_timeout=0;
}

server {
    listen 80;

    # add here the ip address of your server
    # or a domain pointing to that ip (like example.com or www.example.com)
    server_name XXXX;

    keepalive_timeout 5;
    client_max_body_size 4G;

    access_log /home/fastapi-user/fastapi-nginx-gunicorn/logs/nginx-access.log;
    error_log /home/fastapi-user/fastapi-nginx-gunicorn/logs/nginx-error.log;

    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $http_host;
        proxy_redirect off;

        if (!-f $request_filename) {
            proxy_pass http://app_server;
            break;
        }
        }
}
</code></pre> 
<p>这是 NGINX 配置文件。它的工作原理如下：</p> 
<ul><li> <p><strong>第 1 行到第 3 行<em><code>app_server</code><strong><em>定义了一个称为NGINX 将代理请求的服务器集群。请求被重定向到位于 的 Unix socket file <code>/home/fastapi-user/fastapi-nginx-gunicorn/run/gunicorn.sock</code>。设置</em></strong><code>fail_timeout=0</code></em></strong>告诉 NGINX 不要将服务器视为失败，即使它没有响应。</p> </li><li> <p><strong>第 1 行到第 5 行</strong>定义了 NGINX 将用于处理请求的虚拟服务器的配置。在本例中，它侦听端口 80。将 XXXX 替换为 IP 或站点名称。</p> </li><li> <p><strong>第 12 行和第 13 行</strong>指定<strong><em><code>keepalive_timeout</code></em></strong>设置客户端可以保持持久连接打开的最长时间，并<strong><em><code>client_max_body_size</code></em></strong>设置 NGINX 允许的客户端请求正文的大小限制。</p> </li><li> <p><strong>第 15 行和第 16 行</strong>指定 NGINX 将写入其访问和错误日志的位置。</p> </li><li> <p><strong>第 18 至 27 行</strong>定义了 NGINX 将如何处理对根目录的请求<code>/</code>。您提供一些规范来处理标头，并设置一个指令来将请求代理到您<strong><em><code>app_server</code></em></strong>之前定义的。</p> </li></ul> 
<p>通过运行以下命令从文件创建符号链接来启用站点配置<strong><em><code>sites-available</code></em></strong>：<strong><em><code>sites-enabled</code></em></strong></p> 
<pre><code>sudo ln -s /etc/nginx/sites-available/fastapi-app /etc/nginx/sites-enabled/
</code></pre> 
<p>测试配置文件是否正常并重启NGINX：</p> 
<pre><code>sudo nginx -tsudo systemctl restart nginx
</code></pre> 
<p>如果一切顺利，现在您应该能够从浏览器或使用<code>curl</code>. 您应该再次看到以下输出：</p> 
<pre><code>{"message":"It's working!"}
</code></pre> 
<p>您现在应该已经运行了 FastAPI 应用程序，并且 Gunicorn+Uvicorn 作为 ASGI 服务器，NGINX 在它们前面作为反向代理。</p> 
<h4 id="71">7.1、权限错误</h4> 
<p>如果出现权限错误，表示NGINX无法访问Unix socket，您可以将用户 <strong><em>www-data</em></strong>（通常是NGINX进程运行的用户）添加到fastapi-user组中。您可以使用以下命令：</p> 
<pre><code>sudo usermod -aG fastapi-user www-data
</code></pre> 
<p>如果您还没有为API应用购买域名，则不需要往下阅读了。如果您已经有域名，请继续执行下一步以获取SSL证书并启用HTTPS。</p> 
<h3 id="certbotssl">八、使用 Certbot 获取免费 SSL 证书</h3> 
<p>这仅适用于您希望为其获取SSL证书的域名。如果您使用的是<strong><em>Ubuntu</em></strong>，则可以跳过此步骤。否则，您首先需要安装<strong><em>snapd</em></strong>：</p> 
<pre><code>sudo apt install snapd
</code></pre> 
<p>接下来，确保您拥有最新可用版本：</p> 
<pre><code>sudo snap install core; sudo snap refresh core
</code></pre> 
<p>安装Certbot并确保<code>certbot</code>命令可执行：</p> 
<pre><code>sudo snap install --classic certbot
sudo ln -s /snap/bin/certbot /usr/bin/certbot
</code></pre> 
<p>接下来，通过以交互方式运行以下命令为您的域名生成证书：</p> 
<pre><code>sudo certbot --nginx
</code></pre> 
<p>最后，Certbot将自动处理您证书的续订。要测试它是否有效，请运行以下命令：</p> 
<pre><code>sudo certbot renew --dry-run
</code></pre> 
<p>如果一切顺利，您应该会看到 <strong><em>Congratulations, all simulated renewals succeeded…</em></strong> 消息。</p> 
<p>现在，您应该能够通过HTTPS成功发送请求。</p> 
<h3>九、结论</h3> 
<p>本篇文章介绍了如何使用 <strong><em>NGINX</em></strong>、<strong><em>Gunicorn</em></strong> 和 <strong><em>Uvicorn</em></strong> 来部署 FastAPI 应用程序。FastAPI 是最流行的 Python Web 框架之一。它已成为部署机器学习驱动的 Web 应用程序的首选，因此你希望持续关注AI领域，并希望能做一定的应用开发实践，熟悉它还是挺有帮助的。</p> 
<p>在这篇文章中您了解到：</p> 
<ul><li> <p>为什么以及<strong><em>何时应该使用 FastAPI、NGINX、Gunicorn 和 Uvicorn</em></strong>。</p> </li><li> <p>如何<strong><em>设置 Gunicorn+Uvicorn 作为 ASGI 服务器</em></strong>。</p> </li><li> <p>如何<strong><em>使用Supervisor来运行Gunicorn</em>。</strong></p> </li><li> <p>如何<strong><em>使用 certbot 配置 NGINX 并生成免费的 SSL 证书</em>。</strong></p> </li></ul> 
<p></p> 
<blockquote> 
 <p><strong>如果你对这篇文章感兴趣，而且你想要了解更多关于AI领域的实战技巧，可以<span style="color:#fe2c24;"><u>关注「技术狂潮AI」公众号</u></span>。在这里，你可以看到最新最热的AIGC领域的干货文章和案例实战教程。</strong></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/301c1ddce1042eafe3d21de0bf12be36/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Sql server 连接 Oracle数据库</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5b82d5c214f9d960a75df952a1808d3c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue &#43; Element UI 前端篇（六）：更换皮肤主题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>