<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android WLAN 直连（对等连接或 P2P） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/66369188d6d11cf73b17bfe70a1cbf69/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android WLAN 直连（对等连接或 P2P）">
  <meta property="og:description" content="概念 Wi-Fi Direct®支持Wi-Fi设备相互直接连接，并非Android设备独有的，是WIfi联盟提供的一种设备与设备之间直接联网通讯的技术，实现点对点的连接，我们常说的Wifi P2P连接。
最大的特点和优势就是无需接入网络就可连接设备
有了Wi-Fi Direct，手机、摄像头、打印机、个人电脑和游戏设备无需互联网连接，就能够建立自己的Wi-Fi网络。Wi-Fi Direct设备相互连接后，通过设备设置，就可快速简便地传送或显示内容、玩游戏以及分享应用。这些设备可以一对一地连接，或者几个设备形成的一组设备可以同时连接。由于无需接入点或互联网连接，因此设备在哪里，哪里就有Wi-Fi Direct网络。设备之间建立的Wi-Fi Direct连接对包括Miracast®在内的很多应用而言属于底层技术。诸如智能手机、摄像头、打印机、电视机、个人电脑、游戏机等成千上万的设备均已通过认证。
随时随地建立连接
即使附近没有Wi-Fi网络可用，Wi-Fi Direct设备之间也可以随时随地建立连接。Wi-Fi Direct设备向同一区域内的其他设备发送信号，让这些设备知道可以建立连接。用户可以查看可用设备并请求连接，也可以接收另一台设备发出的连接邀请。两个或更多个经过Wi-Fi Direct认证的设备直接连接时，会使用Wi-Fi Protected Setup™形成一个Wi-Fi Direct设备组。
Android设备如何使用WLAN P2P Android API 概览
WifiP2pManager 类提供的方法使您可以在设备上与 WLAN 硬件交互，以执行发现和连接对等设备等操作。可执行的操作如下：
initialize()通过 WLAN 框架注册应用。必须先调用此方法，然后再调用任何其他 WLAN P2P 方法。connect()启动与具有指定配置的设备的对等连接。cancelConnect()取消任何正在进行的对等群组协商。requestConnectInfo()请求设备连接信息。createGroup()以群组所有者的身份，使用当前设备创建对等群组。removeGroup()移除当前对等群组。requestGroupInfo()请求对等群组信息。discoverPeers()启动对等设备发现requestPeers()请求已发现对等设备的当前列表。 WifiP2pManager 方法使您可以在侦听器中进行传递，以便 WLAN P2P 框架可以向您的 Activity 通知通话状态。下表介绍可用的侦听器接口和使用侦听器的相应 WifiP2pManager 方法调用：
侦听器接口相关操作WifiP2pManager.ActionListenerconnect()、cancelConnect()、createGroup()、removeGroup() 和 discoverPeers()WifiP2pManager.ChannelListenerinitialize()WifiP2pManager.ConnectionInfoListenerrequestConnectInfo()WifiP2pManager.GroupInfoListenerrequestGroupInfo()WifiP2pManager.PeerListListenerrequestPeers() WLAN P2P API 定义当发生特定 WLAN P2P 事件时会广播的 Intent，例如发现新的对等设备时，或设备的 WLAN 状态更改时。您可以通过创建处理这些 Intent 的广播接收器，在应用中注册接收这些 Intent：
Intent说明WIFI_P2P_CONNECTION_CHANGED_ACTION当设备的 WLAN 连接状态更改时广播。WIFI_P2P_PEERS_CHANGED_ACTION当您调用 discoverPeers() 时广播。如果您在应用中处理此 Intent，则通常需要调用 requestPeers() 以获取对等设备的更新列表。WIFI_P2P_STATE_CHANGED_ACTION当 WLAN P2P 在设备上启用或停用时广播。WIFI_P2P_THIS_DEVICE_CHANGED_ACTION当设备的详细信息（例如设备名称）更改时广播。 创建 WLAN P2P 应用 创建 WLAN P2P 应用涉及为应用创建并注册广播接收器、发现对等设备，连接到对等设备，以及将数据传输到对等设备。以下部分将介绍如何完成此操作。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-18T14:05:20+08:00">
    <meta property="article:modified_time" content="2024-01-18T14:05:20+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android WLAN 直连（对等连接或 P2P）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>概念</h3> 
<p>Wi-Fi Direct®支持Wi-Fi设备相互直接连接，并非Android设备独有的，是WIfi联盟提供的一种设备与设备之间直接联网通讯的技术，实现点对点的连接，我们常说的Wifi P2P连接。</p> 
<p><strong>最大的特点和优势就是无需接入网络就可连接设备</strong><br> 有了Wi-Fi Direct，手机、摄像头、打印机、个人电脑和游戏设备无需互联网连接，就能够建立自己的Wi-Fi网络。Wi-Fi Direct设备相互连接后，通过设备设置，就可快速简便地传送或显示内容、玩游戏以及分享应用。这些设备可以一对一地连接，或者几个设备形成的一组设备可以同时连接。由于无需接入点或互联网连接，因此设备在哪里，哪里就有Wi-Fi Direct网络。设备之间建立的Wi-Fi Direct连接对包括Miracast®在内的很多应用而言属于底层技术。诸如智能手机、摄像头、打印机、电视机、个人电脑、游戏机等成千上万的设备均已通过认证。<br> <strong>随时随地建立连接</strong><br> 即使附近没有Wi-Fi网络可用，Wi-Fi Direct设备之间也可以随时随地建立连接。Wi-Fi Direct设备向同一区域内的其他设备发送信号，让这些设备知道可以建立连接。用户可以查看可用设备并请求连接，也可以接收另一台设备发出的连接邀请。两个或更多个经过Wi-Fi Direct认证的设备直接连接时，会使用Wi-Fi Protected Setup™形成一个Wi-Fi Direct设备组。</p> 
<h3><a id="AndroidWLAN_P2P_9"></a>Android设备如何使用WLAN P2P</h3> 
<p>Android API 概览<br> WifiP2pManager 类提供的方法使您可以在设备上与 WLAN 硬件交互，以执行发现和连接对等设备等操作。可执行的操作如下：</p> 
<table><thead><tr><th><a href="https://developer.android.google.cn/reference/android/net/wifi/p2p/WifiP2pManager?hl=zh-cn#initialize%28android.content.Context,%20android.os.Looper,%20android.net.wifi.p2p.WifiP2pManager.ChannelListener%29" rel="nofollow">initialize</a>()</th><th>通过 WLAN 框架注册应用。必须先调用此方法，然后再调用任何其他 WLAN P2P 方法。</th></tr></thead><tbody><tr><td><a href="https://developer.android.google.cn/reference/android/net/wifi/p2p/WifiP2pManager?hl=zh-cn#connect%28android.net.wifi.p2p.WifiP2pManager.Channel,%20android.net.wifi.p2p.WifiP2pConfig,%20android.net.wifi.p2p.WifiP2pManager.ActionListener%29" rel="nofollow">connect</a>()</td><td>启动与具有指定配置的设备的对等连接。</td></tr><tr><td><a href="https://developer.android.google.cn/reference/android/net/wifi/p2p/WifiP2pManager?hl=zh-cn#cancelConnect%28android.net.wifi.p2p.WifiP2pManager.Channel,%20android.net.wifi.p2p.WifiP2pManager.ActionListener%29" rel="nofollow">cancelConnect</a>()</td><td>取消任何正在进行的对等群组协商。</td></tr><tr><td><a href="https://developer.android.google.cn/reference/android/net/wifi/p2p/WifiP2pManager?hl=zh-cn#requestConnectionInfo%28android.net.wifi.p2p.WifiP2pManager.Channel,%20android.net.wifi.p2p.WifiP2pManager.ConnectionInfoListener%29" rel="nofollow">requestConnectInfo</a>()</td><td>请求设备连接信息。</td></tr><tr><td><a href="https://developer.android.google.cn/reference/android/net/wifi/p2p/WifiP2pManager?hl=zh-cn#createGroup%28android.net.wifi.p2p.WifiP2pManager.Channel,%20android.net.wifi.p2p.WifiP2pManager.ActionListener%29" rel="nofollow">createGroup</a>()</td><td>以群组所有者的身份，使用当前设备创建对等群组。</td></tr><tr><td><a href="https://developer.android.google.cn/reference/android/net/wifi/p2p/WifiP2pManager?hl=zh-cn#removeGroup%28android.net.wifi.p2p.WifiP2pManager.Channel,%20android.net.wifi.p2p.WifiP2pManager.ActionListener%29" rel="nofollow">removeGroup</a>()</td><td>移除当前对等群组。</td></tr><tr><td><a href="https://developer.android.google.cn/reference/android/net/wifi/p2p/WifiP2pManager?hl=zh-cn#requestGroupInfo%28android.net.wifi.p2p.WifiP2pManager.Channel,%20android.net.wifi.p2p.WifiP2pManager.GroupInfoListener%29" rel="nofollow">requestGroupInfo</a>()</td><td>请求对等群组信息。</td></tr><tr><td><a href="https://developer.android.google.cn/reference/android/net/wifi/p2p/WifiP2pManager?hl=zh-cn#discoverPeers%28android.net.wifi.p2p.WifiP2pManager.Channel,%20android.net.wifi.p2p.WifiP2pManager.ActionListener%29" rel="nofollow">discoverPeers</a>()</td><td>启动对等设备发现</td></tr><tr><td><a href="https://developer.android.google.cn/reference/android/net/wifi/p2p/WifiP2pManager?hl=zh-cn#requestPeers%28android.net.wifi.p2p.WifiP2pManager.Channel,%20android.net.wifi.p2p.WifiP2pManager.PeerListListener%29" rel="nofollow">requestPeers</a>()</td><td>请求已发现对等设备的当前列表。</td></tr></tbody></table> 
<p>WifiP2pManager 方法使您可以在侦听器中进行传递，以便 WLAN P2P 框架可以向您的 Activity 通知通话状态。下表介绍可用的侦听器接口和使用侦听器的相应 WifiP2pManager 方法调用：</p> 
<table><thead><tr><th>侦听器接口</th><th>相关操作</th></tr></thead><tbody><tr><td>WifiP2pManager.ActionListener</td><td>connect()、cancelConnect()、createGroup()、removeGroup() 和 discoverPeers()</td></tr><tr><td>WifiP2pManager.ChannelListener</td><td>initialize()</td></tr><tr><td>WifiP2pManager.ConnectionInfoListener</td><td>requestConnectInfo()</td></tr><tr><td>WifiP2pManager.GroupInfoListener</td><td>requestGroupInfo()</td></tr><tr><td>WifiP2pManager.PeerListListener</td><td>requestPeers()</td></tr></tbody></table> 
<p>WLAN P2P API 定义当发生特定 WLAN P2P 事件时会广播的 Intent，例如发现新的对等设备时，或设备的 WLAN 状态更改时。您可以通过创建处理这些 Intent 的广播接收器，在应用中注册接收这些 Intent：</p> 
<table><thead><tr><th>Intent</th><th>说明</th></tr></thead><tbody><tr><td>WIFI_P2P_CONNECTION_CHANGED_ACTION</td><td>当设备的 WLAN 连接状态更改时广播。</td></tr><tr><td>WIFI_P2P_PEERS_CHANGED_ACTION</td><td>当您调用 discoverPeers() 时广播。如果您在应用中处理此 Intent，则通常需要调用 requestPeers() 以获取对等设备的更新列表。</td></tr><tr><td>WIFI_P2P_STATE_CHANGED_ACTION</td><td>当 WLAN P2P 在设备上启用或停用时广播。</td></tr><tr><td>WIFI_P2P_THIS_DEVICE_CHANGED_ACTION</td><td>当设备的详细信息（例如设备名称）更改时广播。</td></tr></tbody></table> 
<h3><a id="_WLAN_P2P__40"></a>创建 WLAN P2P 应用</h3> 
<p>创建 WLAN P2P 应用涉及为应用创建并注册广播接收器、发现对等设备，连接到对等设备，以及将数据传输到对等设备。以下部分将介绍如何完成此操作。</p> 
<p><strong>初始设置</strong><br> 在使用 WLAN P2P API 之前，您必须确保您的应用可以访问硬件，并且设备支持 WLAN P2P API 协议。如果设备支持 WLAN P2P，您可以获得 WifiP2pManager 的实例，创建并注册广播接收器，然后开始使用 WLAN P2P API。</p> 
<p>请求在设备上使用 WLAN 硬件的权限，同时声明您的应用在 Android 清单中具有正确的最低 SDK 版本：</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>sdk android<span class="token operator">:</span>minSdkVersion<span class="token operator">=</span><span class="token string">"14"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_WIFI_STATE"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.CHANGE_WIFI_STATE"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_FINE_LOCATION"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.CHANGE_NETWORK_STATE"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.INTERNET"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token keyword">uses</span><span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> 
<p><strong>检查 WLAN P2P 是否开启并受支持。您可以在广播接收器收到</strong> WIFI_P2P_STATE_CHANGED_ACTION Intent 时，在接收器中检查此项。向您的 Activity 通知 WLAN P2P 的状态，并作出相应回应：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name">String</span> action <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">WIFI_P2P_STATE_CHANGED_ACTION</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> state <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">EXTRA_WIFI_STATE</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">WIFI_P2P_STATE_ENABLED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Wifi P2P is enabled</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Wi-Fi P2P is not enabled</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>获取和初始化P2P资源</strong><br> 获取 WifiP2pManager 的实例，并通过调用 initialize()，在 WLAN P2P 框架中注册您的应用。此方法会返回 WifiP2pManager.Channel，用于将您的应用连接到 WLAN P2P 框架。此外，您还应该通过 WifiP2pManager 和 WifiP2pManager.Channel 对象以及对 Activity 的引用，创建广播接收器实例。这样广播接收器便可通知 Activity 感兴趣的事件并进行相应更新。此外，您还可以操纵设备的 WLAN 状态（如有必要）：</p> 
<pre><code class="prism language-java"><span class="token class-name">WifiP2pManager</span> manager<span class="token punctuation">;</span>
<span class="token class-name">Channel</span> channel<span class="token punctuation">;</span>
<span class="token class-name">BroadcastReceiver</span> receiver<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    manager <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">WIFI_P2P_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    channel <span class="token operator">=</span> manager<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    receiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WiFiDirectBroadcastReceiver</span><span class="token punctuation">(</span>manager<span class="token punctuation">,</span> mChannel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>创建 Intent 过滤器，然后添加与广播接收器检查内容相同的 Intent：</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">IntentFilter</span> intentFilter<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token class-name">Bundle</span> savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    intentFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">WIFI_P2P_STATE_CHANGED_ACTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">WIFI_P2P_PEERS_CHANGED_ACTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">WIFI_P2P_CONNECTION_CHANGED_ACTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    intentFilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">WIFI_P2P_THIS_DEVICE_CHANGED_ACTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 Activity 的 onResume() 方法中注册广播接收器，然后在 Activity 的onPause() 方法中取消注册该接收器：</p> 
<pre><code class="prism language-java"><span class="token comment">/* register the broadcast receiver with the intent values to be matched */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">registerReceiver</span><span class="token punctuation">(</span>mReceiver<span class="token punctuation">,</span> intentFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* unregister the broadcast receiver */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unregisterReceiver</span><span class="token punctuation">(</span>mReceiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_125"></a>发现对等设备</h3> 
<p>如要发现可连接的对等设备，请调用 discoverPeers()，以检测范围内的可用对等设备。对此功能的调用为异步操作，如果您已创建 WifiP2pManager.ActionListener，则系统会通过 onSuccess() 和 onFailure() 告知应用成功与否。onSuccess() 方法仅会通知您发现进程已成功，但不会提供有关其发现的实际对等设备（如有）的任何信息：</p> 
<pre><code class="prism language-java">manager<span class="token punctuation">.</span><span class="token function">discoverPeers</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WifiP2pManager<span class="token punctuation">.</span>ActionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token keyword">int</span> reasonCode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>如果发现进程成功并检测到对等设备，则系统会广播 WIFI_P2P_PEERS_CHANGED_ACTION Intent，您可以在广播接收器中侦听该 Intent，以获取对等设备列表。当应用接收到 WIFI_P2P_PEERS_CHANGED_ACTION Intent 时，您可以通过 requestPeers() 请求已发现对等设备的列表。以下代码展示如何完成此项设置：</p> 
<pre><code class="prism language-java"><span class="token class-name">PeerListListener</span> myPeerListListener<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">WIFI_P2P_PEERS_CHANGED_ACTION</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// request available peers from the wifi p2p manager. This is an</span>
    <span class="token comment">// asynchronous call and the calling activity is notified with a</span>
    <span class="token comment">// callback on PeerListListener.onPeersAvailable()</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>manager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        manager<span class="token punctuation">.</span><span class="token function">requestPeers</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> myPeerListListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>requestPeers() 方法也为异步操作，并可在对等设备列表可用时通过 onPeersAvailable()（定义见 WifiP2pManager.PeerListListener 接口）通知您的 Activity。onPeersAvailable() 方法为您提供 WifiP2pDeviceList，您可对其进行迭代以查找希望连接的对等设备。</p> 
<h3><a id="_158"></a>连接到对等设备</h3> 
<p>获取可能对等设备的列表，且已确定您要连接的设备后，调用connect() 方法即可连接到相应设备。调用此方法需要使用 WifiP2pConfig 对象，其中包含要连接的设备的信息。您可以通过 WifiP2pManager.ActionListener 获知连接是否成功。以下代码展示如何创建与所需设备的连接：</p> 
<pre><code class="prism language-java"><span class="token comment">//obtain a peer from the WifiP2pDeviceList</span>
<span class="token class-name">WifiP2pDevice</span> device<span class="token punctuation">;</span>
<span class="token class-name">WifiP2pConfig</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WifiP2pConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
config<span class="token punctuation">.</span>deviceAddress <span class="token operator">=</span> device<span class="token punctuation">.</span>deviceAddress<span class="token punctuation">;</span>
manager<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ActionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//success logic</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token keyword">int</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//failure logic</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_179"></a>建立网络连接</h3> 
<p>当P2P连接完成后，IP地址是由DHCPServer分配的，一般是Group Owner所在的设备开启DHCPServer给自己和对端（GC端）分贝IP地址。<br> 如果当前设置是GC(Group Client),那么可通过WifiP2pManager.WIFI_P2P_CONNECTION_CHANGED_ACTION广播直接拿到GO端的IP地址</p> 
<pre><code class="prism language-java">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">WIFI_P2P_CONNECTION_CHANGED_ACTION</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">NetworkInfo</span> networkInfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">NetworkInfo</span><span class="token punctuation">)</span> intent
                    <span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">EXTRA_NETWORK_INFO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WifiP2pInfo</span> p2pInfo <span class="token operator">=</span>
                    <span class="token punctuation">(</span><span class="token class-name">WifiP2pInfo</span><span class="token punctuation">)</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">EXTRA_WIFI_P2P_INFO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WifiP2pGroup</span> p2pGroup <span class="token operator">=</span>
                    <span class="token punctuation">(</span><span class="token class-name">WifiP2pGroup</span><span class="token punctuation">)</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token class-name">WifiP2pManager</span><span class="token punctuation">.</span><span class="token constant">EXTRA_WIFI_P2P_GROUP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>networkInfo<span class="token punctuation">.</span><span class="token function">isConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                device_addr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> p2pInfo<span class="token punctuation">.</span>groupOwnerAddress<span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mController<span class="token punctuation">.</span><span class="token function">setGroupModule</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">WifiP2pDevice</span> device <span class="token operator">=</span> p2pGroup<span class="token punctuation">.</span><span class="token function">getOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>device <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> device<span class="token punctuation">.</span><span class="token function">getWfdInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    mPort <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>device<span class="token punctuation">.</span><span class="token function">getWfdInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getControlPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mIp <span class="token operator">=</span> p2pInfo<span class="token punctuation">.</span>groupOwnerAddress<span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"device or device wfdInfo is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
</code></pre> 
<p>如果当前设备是GO(Group Owner)那么就需要用其他方法获取到对端IP地址了，Android 原生未提供直接获取GC IP的方法<br> 如果可以修改AOSP源码的话，可以通过DHCPServer给GC分配IP地址时，把地址给到当前的程序：<br> Android 源码：packages/modules/NetworkStack/src/android/net/dhcp/DhcpServer.java<br> transmitAck方法中添加以下code<br> private boolean transmitAck(@NonNull DhcpPacket packet, @NonNull DhcpLease lease, @NonNull MacAddress clientMac)</p> 
<pre><code class="prism language-java"><span class="token class-name">Intent</span> notifyMiracast <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token constant">WIFI_P2P_IP_ADDR_CHANGED_ACTION</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
notifyMiracast<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token constant">WIFI_P2P_PEER_IP_EXTRA</span><span class="token punctuation">,</span>lease<span class="token punctuation">.</span><span class="token function">getNetAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
notifyMiracast<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token constant">WIFI_P2P_PEER_MAC_EXTRA</span><span class="token punctuation">,</span>lease<span class="token punctuation">.</span><span class="token function">getHwAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"sendBroadcast IP "</span> <span class="token operator">+</span> notifyMiracast<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span><span class="token constant">WIFI_P2P_PEER_IP_EXTRA</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">"MAC "</span> <span class="token operator">+</span> notifyMiracast<span class="token punctuation">.</span><span class="token function">getStringExtra</span><span class="token punctuation">(</span><span class="token constant">WIFI_P2P_PEER_MAC_EXTRA</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mContext<span class="token punctuation">.</span><span class="token function">sendBroadcast</span><span class="token punctuation">(</span>notifyMiracast<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>也可以读取ARP方法来获取IP</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">macAddressFromRoute</span><span class="token punctuation">(</span><span class="token class-name">String</span> macAddress<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token class-name">String</span> ipAddress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token string">"/proc/net/arp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Skip over the line bearing column titles</span>
		<span class="token class-name">String</span> line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokens <span class="token operator">=</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"[ ]+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>tokens<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token comment">// ARP column format is</span>
			<span class="token comment">// Address HWType HWAddress Flags Mask IFace</span>
			<span class="token class-name">String</span> ip <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> mac <span class="token operator">=</span> tokens<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mac<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>macAddress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				ipAddress <span class="token operator">=</span> ip<span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ipAddress <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">loge</span><span class="token punctuation">(</span><span class="token string">"Did not find remoteAddress {"</span> <span class="token operator">+</span> macAddress<span class="token operator">+</span> <span class="token string">"} in /proc/net/arp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">loge</span><span class="token punctuation">(</span><span class="token string">"Could not open /proc/net/arp to lookup mac address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">loge</span><span class="token punctuation">(</span><span class="token string">"Could not read /proc/net/arp to lookup mac address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>reader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				reader<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Do nothing</span>
		<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">return</span> ipAddress<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3e2d2330a6c8040b2c2c7922d4203bfa/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C语言课设--航班订票系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/539fd5e14d2455cbd827fb72880db830/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">opencv python 实现Canny检测后不连续不封闭轮廓的闭合</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>