<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python 版分布式消息队列 Kafka 实现图片数据传输 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/d8279fa451c3d31d00357ab7b182d003/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Python 版分布式消息队列 Kafka 实现图片数据传输">
  <meta property="og:description" content="1、Kafka 介绍 在使用 Kafka 之前，通常需要先安装和配置 ZooKeeper。ZooKeeper 是 Kafka 的依赖项之一，它用于协调和管理 Kafka 集群的状态。
ZooKeeper 是一个开源的分布式协调服务，它提供了可靠的数据存储和协调机制，用于协调分布式系统中的各个节点。Kafka 使用 ZooKeeper 来存储和管理集群的元数据、配置信息和状态。
2、Kafka 环境搭建 环境：
Windows11Java 1.8 及以上AnacondaPython10Kafka 2.0.2 (kafka-python) 2.1、安装 Python 版本 Kafka pip install kafka-python -i https://pypi.tuna.tsinghua.edu.cn/simple 至此，Windows 环境下还不能运行 Kafka，一般情况下，程序会提示超时(60ms)等报错。原因是，还需要启动 Kafka 服务。
2.2、启动 Kafka 服务 从 Kafka 官网下下载对应的文件：Apache Kafka 官网下载地址
下载红色箭头所指向的文件到本地并解压。
注意：
从 Kafka 官网上下载的 kafka_2.12-3.2.1 文件需要放置在路径较浅文件夹下解压，一旦放置的路径较深，会报错：
输入行太长。 命令语法不正确。 本案例放在 E 盘下。
2.2.1、启动 Zookeeper 服务 在上图路径下打开 cmd 命令窗口，执行如下命令：
.\bin\windows\zookeeper-server-start.bat .\config\zookeeper.properties 出现如下信息，表示 Zookeeper 服务启动成功：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-12T16:08:58+08:00">
    <meta property="article:modified_time" content="2024-04-12T16:08:58+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python 版分布式消息队列 Kafka 实现图片数据传输</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="1Kafka__0"></a>1、Kafka 介绍</h4> 
<p>在使用 Kafka 之前，通常需要先安装和配置 ZooKeeper。ZooKeeper 是 Kafka 的依赖项之一，它用于协调和管理 Kafka 集群的状态。</p> 
<p>ZooKeeper 是一个开源的分布式协调服务，它提供了可靠的数据存储和协调机制，用于协调分布式系统中的各个节点。Kafka 使用 ZooKeeper 来存储和管理集群的元数据、配置信息和状态。</p> 
<h4><a id="2Kafka__8"></a>2、Kafka 环境搭建</h4> 
<p><strong>环境：</strong></p> 
<ul><li>Windows11</li><li>Java 1.8 及以上</li><li>Anaconda</li><li>Python10</li><li>Kafka 2.0.2 (kafka-python)</li></ul> 
<h5><a id="21_Python__Kafka_18"></a>2.1、安装 Python 版本 Kafka</h5> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> kafka-python <span class="token parameter variable">-i</span> https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre> 
<p>至此，Windows 环境下还不能运行 Kafka，一般情况下，程序会提示超时(60ms)等报错。原因是，还需要启动 Kafka 服务。</p> 
<h5><a id="22_Kafka__28"></a>2.2、启动 Kafka 服务</h5> 
<p>从 Kafka 官网下下载对应的文件：<a href="https://kafka.apache.org/downloads.html" rel="nofollow">Apache Kafka 官网下载地址</a></p> 
<p><img src="https://images2.imgbox.com/16/61/1dXRhHaV_o.png" alt="在这里插入图片描述"></p> 
<p>下载红色箭头所指向的文件到本地并解压。</p> 
<p><img src="https://images2.imgbox.com/b8/4b/Phv5cKKG_o.png" alt="在这里插入图片描述"></p> 
<p><strong>注意：</strong></p> 
<p>从 Kafka 官网上下载的 <code>kafka_2.12-3.2.1</code> 文件需要放置在路径较浅文件夹下解压，一旦放置的路径较深，会报错：</p> 
<p><img src="https://images2.imgbox.com/26/1f/u74icDJW_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash">输入行太长。
命令语法不正确。
</code></pre> 
<p><strong>本案例放在 E 盘下。</strong></p> 
<h6><a id="221_Zookeeper__57"></a>2.2.1、启动 Zookeeper 服务</h6> 
<p>在上图路径下打开 cmd 命令窗口，执行如下命令：</p> 
<pre><code class="prism language-bash">.<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>windows<span class="token punctuation">\</span>zookeeper-server-start.bat .<span class="token punctuation">\</span>config<span class="token punctuation">\</span>zookeeper.properties
</code></pre> 
<p><img src="https://images2.imgbox.com/14/64/CafCeA1L_o.png" alt="在这里插入图片描述"></p> 
<p>出现如下信息，表示 Zookeeper 服务启动成功：</p> 
<p><img src="https://images2.imgbox.com/ff/c9/36S9tySz_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="222_Kafka__75"></a>2.2.2、启动 Kafka 服务</h6> 
<p>在上图路径下打开 cmd 命令窗口，执行如下命令：</p> 
<pre><code class="prism language-bash">.<span class="token punctuation">\</span>bin<span class="token punctuation">\</span>windows<span class="token punctuation">\</span>kafka-server-start.bat .<span class="token punctuation">\</span>config<span class="token punctuation">\</span>server.properties
</code></pre> 
<p><img src="https://images2.imgbox.com/51/6d/L1OW1aFI_o.png" alt=""></p> 
<p>出现如下信息，表示 Kafka 服务启动成功：</p> 
<p><img src="https://images2.imgbox.com/62/dd/Q6Bz9yNT_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3_92"></a>3、构建图片传输队列</h4> 
<p><img src="https://images2.imgbox.com/66/28/OoRidRWj_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="31_99"></a>3.1、配置文件</h5> 
<p><strong>Properties/config.yaml：</strong></p> 
<pre><code class="prism language-yaml"><span class="token key atrule">kafka</span><span class="token punctuation">:</span>
 <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span>
 <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9092</span>
 <span class="token key atrule">parameter</span><span class="token punctuation">:</span>
   <span class="token key atrule">bootstrap_servers</span><span class="token punctuation">:</span> <span class="token string">'127.0.0.1:9092'</span>
   <span class="token key atrule">api_version</span><span class="token punctuation">:</span> <span class="token string">"2.5.0"</span>
   <span class="token key atrule">log_path</span><span class="token punctuation">:</span> <span class="token string">"KafkaLog/log.txt"</span>
<span class="token key atrule">workspace</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"E:/harrytsz-workspace/harrytsz-python/DistributedSystemDemo00"</span>
<span class="token key atrule">input</span><span class="token punctuation">:</span>
  <span class="token key atrule">images_path</span><span class="token punctuation">:</span> <span class="token string">"DataSource/Images"</span>
<span class="token key atrule">output</span><span class="token punctuation">:</span>
  <span class="token key atrule">output_path</span><span class="token punctuation">:</span> <span class="token string">"DataSource/Output"</span>
</code></pre> 
<h5><a id="32Kafka__121"></a>3.2、Kafka 创建分区</h5> 
<p><strong>KafkaModule/ProducerConsumer/KafkaClient.py：</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> kafka<span class="token punctuation">.</span>admin <span class="token keyword">import</span> KafkaAdminClient<span class="token punctuation">,</span> NewPartitions


client <span class="token operator">=</span> KafkaAdminClient<span class="token punctuation">(</span>bootstrap_servers<span class="token operator">=</span><span class="token string">"127.0.0.1:9092"</span><span class="token punctuation">)</span>

<span class="token comment"># 在已有的 topic 中创建分区</span>
new_partitions <span class="token operator">=</span> NewPartitions<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
client<span class="token punctuation">.</span>create_partitions<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"kafka_demo"</span><span class="token punctuation">:</span> new_partitions<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="33_138"></a>3.3、生产者、消费者(单线程版)</h5> 
<p><strong>生产者：</strong></p> 
<p><strong>KafkaModule/ProducerConsumer/KafkaDemoProducer.py：</strong></p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> json
<span class="token keyword">import</span> yaml
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> random
<span class="token keyword">import</span> traceback
<span class="token keyword">from</span> kafka<span class="token punctuation">.</span>errors <span class="token keyword">import</span> kafka_errors
<span class="token keyword">from</span> kafka <span class="token keyword">import</span> KafkaProducer

<span class="token keyword">def</span> <span class="token function">producer_demo</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :param cfg:
    :return:
    """</span>
    <span class="token comment"># 假设生产的消息为键值对（不是一定要键值对），且序列化方式为json</span>
    producer <span class="token operator">=</span> KafkaProducer<span class="token punctuation">(</span>bootstrap_servers<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'bootstrap_servers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                             key_serializer<span class="token operator">=</span><span class="token keyword">lambda</span> k<span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             value_serializer<span class="token operator">=</span><span class="token keyword">lambda</span> v<span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Kafka Producer Starting"</span><span class="token punctuation">)</span>
    images_path <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'input'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'images_path'</span><span class="token punctuation">]</span>
    workspace_path <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'workspace'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> img <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>workspace_path<span class="token punctuation">,</span> images_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"img: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        workspace_path <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'workspace'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span>
        image_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>workspace_path<span class="token punctuation">,</span> images_path<span class="token punctuation">,</span> img<span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> image_file<span class="token punctuation">:</span>
            image_data <span class="token operator">=</span> image_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        encode_image <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>image_data<span class="token punctuation">)</span>
        json_data <span class="token operator">=</span> encode_image<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        json_string <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json_data<span class="token punctuation">)</span>

        future <span class="token operator">=</span> producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'kafka_demo'</span><span class="token punctuation">,</span>
                               key<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 同一个key值，会被送至同一个分区</span>
                               value<span class="token operator">=</span>json_string<span class="token punctuation">,</span>
                               partition<span class="token operator">=</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 向分区1发送消息</span>
        producer<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Send {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            future<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># 监控是否发送成功</span>
        <span class="token keyword">except</span> kafka_errors<span class="token punctuation">:</span>  <span class="token comment"># 发送失败抛出 kafka_errors</span>
            traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>expanduser<span class="token punctuation">(</span><span class="token string">"E:/harrytsz-workspace/harrytsz-python/DistributedSystemDemo00/"</span>
                                 <span class="token string">"Properties/config.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> config<span class="token punctuation">:</span>
        cfg <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'log_path'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s - %(funcName)s'</span><span class="token punctuation">,</span>
                        level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
    producer_demo<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    process<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>消费者：</strong></p> 
<p><strong>KafkaModule/ProducerConsumer/KafkaDemoConsumer.py：</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> yaml
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path
<span class="token keyword">from</span> kafka <span class="token keyword">import</span> KafkaConsumer

<span class="token keyword">def</span> <span class="token function">consumer_demo0</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :param cfg:
    :return:
    """</span>
    consumer <span class="token operator">=</span> KafkaConsumer<span class="token punctuation">(</span><span class="token string">'kafka_demo'</span><span class="token punctuation">,</span>
                             bootstrap_servers<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'bootstrap_servers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                             api_version<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'api_version'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                             group_id<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"consumer_demo0 starting"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> message <span class="token keyword">in</span> consumer<span class="token punctuation">:</span>
        key_json_string <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">.</span>key<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        value_json_string <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">.</span>value<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        name_data <span class="token operator">=</span> <span class="token string">"test0"</span> <span class="token operator">+</span> key_json_string <span class="token operator">+</span> <span class="token string">".jpg"</span>
        image_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>value_json_string<span class="token punctuation">)</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Receiving </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name_data<span class="token punctuation">}</span></span><span class="token string"> data."</span></span><span class="token punctuation">)</span>
        workspace_path <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'workspace'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span>
        output_path <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'output_path'</span><span class="token punctuation">]</span>
        image_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>workspace_path<span class="token punctuation">,</span> output_path<span class="token punctuation">,</span> name_data<span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> jpg_file<span class="token punctuation">:</span>
            jpg_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>image_data<span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Save </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name_data<span class="token punctuation">}</span></span><span class="token string"> data finished."</span></span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :return:
    """</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>expanduser<span class="token punctuation">(</span><span class="token string">"E:/harrytsz-workspace/harrytsz-python/DistributedSystemDemo00/"</span>
                                 <span class="token string">"Properties/config.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> config<span class="token punctuation">:</span>
        cfg <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'log_path'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s - %(funcName)s'</span><span class="token punctuation">,</span>
                        level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
    consumer_demo0<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    process<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="34_255"></a>3.4、生产者、消费者(线程池版)</h5> 
<p><strong>生产者：</strong></p> 
<p><strong>KafkaModule/ProducerConsumer/KafkaDemoProducerMultiThread.py：</strong></p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> json
<span class="token keyword">import</span> yaml
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> random
<span class="token keyword">import</span> traceback
<span class="token keyword">from</span> kafka<span class="token punctuation">.</span>errors <span class="token keyword">import</span> kafka_errors
<span class="token keyword">from</span> kafka <span class="token keyword">import</span> KafkaProducer

<span class="token keyword">def</span> <span class="token function">producer_demo</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :param cfg:
    :return:
    """</span>
    <span class="token comment"># 假设生产的消息为键值对（不是一定要键值对），且序列化方式为json</span>
    producer <span class="token operator">=</span> KafkaProducer<span class="token punctuation">(</span>bootstrap_servers<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'bootstrap_servers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                             key_serializer<span class="token operator">=</span><span class="token keyword">lambda</span> k<span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             value_serializer<span class="token operator">=</span><span class="token keyword">lambda</span> v<span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Kafka Producer Starting"</span><span class="token punctuation">)</span>

    images_path <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'input'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'images_path'</span><span class="token punctuation">]</span>
    workspace_path <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'workspace'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> i<span class="token punctuation">,</span> img <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>workspace_path<span class="token punctuation">,</span> images_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"img: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        workspace_path <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'workspace'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span>
        image_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>workspace_path<span class="token punctuation">,</span> images_path<span class="token punctuation">,</span> img<span class="token punctuation">)</span>

        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> image_file<span class="token punctuation">:</span>
            image_data <span class="token operator">=</span> image_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

        encode_image <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>image_data<span class="token punctuation">)</span>
        json_data <span class="token operator">=</span> encode_image<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        json_string <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>json_data<span class="token punctuation">)</span>

        future <span class="token operator">=</span> producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'kafka_demo'</span><span class="token punctuation">,</span>
                               key<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 同一个key值，会被送至同一个分区</span>
                               value<span class="token operator">=</span>json_string<span class="token punctuation">,</span>
                               partition<span class="token operator">=</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 向分区1发送消息</span>
        producer<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Send {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            future<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># 监控是否发送成功</span>
        <span class="token keyword">except</span> kafka_errors<span class="token punctuation">:</span>  <span class="token comment"># 发送失败抛出 kafka_errors</span>
            traceback<span class="token punctuation">.</span>format_exc<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>expanduser<span class="token punctuation">(</span><span class="token string">"E:/harrytsz-workspace/harrytsz-python/DistributedSystemDemo00/"</span>
                                 <span class="token string">"Properties/config.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> config<span class="token punctuation">:</span>
        cfg <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>config<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'log_path'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s - %(funcName)s'</span><span class="token punctuation">,</span>
                        level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
    producer_demo<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    process<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>消费者：</strong></p> 
<p><strong>KafkaModule/ProducerConsumer/KafkaDemoConsumerMultiThread.py：</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">import</span> yaml
<span class="token keyword">import</span> base64
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> os<span class="token punctuation">.</span>path
<span class="token keyword">from</span> kafka <span class="token keyword">import</span> KafkaConsumer
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor<span class="token punctuation">,</span> as_completed

<span class="token keyword">def</span> <span class="token function">consumer_demo0</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> thread_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" 线程池版的消费者
    :param cfg: 配置文件
    :param thread_id: 线程序号
    :return:
    """</span>
    consumer <span class="token operator">=</span> KafkaConsumer<span class="token punctuation">(</span><span class="token string">'kafka_demo'</span><span class="token punctuation">,</span>
                             bootstrap_servers<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'bootstrap_servers'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                             api_version<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'api_version'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                             group_id<span class="token operator">=</span><span class="token string">'test'</span><span class="token punctuation">)</span>

    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"consumer_demo0 starting"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> message <span class="token keyword">in</span> consumer<span class="token punctuation">:</span>
        key_json_string <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">.</span>key<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        value_json_string <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">.</span>value<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        name_data <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"test_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>thread_id<span class="token punctuation">}</span></span><span class="token string">_"</span></span> <span class="token operator">+</span> key_json_string <span class="token operator">+</span> <span class="token string">".jpg"</span>
        image_data <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>value_json_string<span class="token punctuation">)</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Receiving </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name_data<span class="token punctuation">}</span></span><span class="token string"> data."</span></span><span class="token punctuation">)</span>
        workspace_path <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'workspace'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span>
        output_path <span class="token operator">=</span> cfg<span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'output_path'</span><span class="token punctuation">]</span>
        image_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>workspace_path<span class="token punctuation">,</span> output_path<span class="token punctuation">,</span> name_data<span class="token punctuation">)</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> jpg_file<span class="token punctuation">:</span>
            jpg_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>image_data<span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Save </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name_data<span class="token punctuation">}</span></span><span class="token string"> data finished."</span></span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :return:
    """</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>expanduser<span class="token punctuation">(</span><span class="token string">"E:/harrytsz-workspace/harrytsz-python/DistributedSystemDemo00/"</span>
                                 <span class="token string">"Properties/config.yaml"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> config<span class="token punctuation">:</span>
        cfg <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>config<span class="token punctuation">)</span>

    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span>cfg<span class="token punctuation">[</span><span class="token string">'kafka'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'parameter'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'log_path'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s - %(funcName)s'</span><span class="token punctuation">,</span>
                        level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
    <span class="token comment"># 线程池</span>
    thread_pool_executor <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> thread_name_prefix<span class="token operator">=</span><span class="token string">"thread_test_"</span><span class="token punctuation">)</span>

    all_task <span class="token operator">=</span> <span class="token punctuation">[</span>thread_pool_executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>consumer_demo0<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> as_completed<span class="token punctuation">(</span>all_task<span class="token punctuation">)</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"res"</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
    thread_pool_executor<span class="token punctuation">.</span>shutdown<span class="token punctuation">(</span>wait<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    process<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>运行顺序：</strong></p> 
<ul><li>首先运行 <code>KafkaDemoConsumer.py</code> 或者 <code>KafkaDemoConsumerMultiThread.py</code></li><li>然后运行 <code>KafkaDemoProducer.py</code> 或者 <code>KafkaDemoProducerMultiThread.py</code></li><li><code>DataSource/Output</code> 中会接受生产者发送的图片数据，<code>ProducerConsumer/KafkaLog</code> 路径也会产生运行日志。</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c2043540159afd72ae207992fed7ffec/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">EasyExcel 自定义通用转换器</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b0ac6b36bc22e9dd2e38f1235e3a5492/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">突破编程_前端_SVG（circle 圆形）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>