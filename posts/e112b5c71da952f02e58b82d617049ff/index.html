<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>阿里 P7 三面凉凉，kafka Borker 日志持久化没答上来 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/e112b5c71da952f02e58b82d617049ff/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="阿里 P7 三面凉凉，kafka Borker 日志持久化没答上来">
  <meta property="og:description" content="👏作者简介：大家好，我是爱敲代码的小黄，阿里巴巴淘天Java开发工程师，CSDN博客专家📕系列专栏：Spring源码、Netty源码、Kafka源码、JUC源码、dubbo源码系列🔥如果感觉博主的文章还不错的话，请👍三连支持👍一下博主哦🍂博主正在努力完成2023计划中：以梦为马，扬帆起航，2023追梦人📝联系方式：hls1793929520，加我进群，大家一起学习，一起进步，一起对抗互联网寒冬👀 文章目录 阿里 P7 三面凉凉，kafka Borker 日志持久化没答上来一、引言二、日志原理介绍二、日志源码1、授权校验2、消息添加2.1 获取 Partition2.2 向 Leader 追加日志2.2.1 是否创建 segment2.2.2 创建 segment2.2.2.1 文件路径校验2.2.2.2 segment 参数2.2.2.3 生成 segment 2.2.3 向 segment 添加日志2.2.3.1 稀疏索引2.2.3.2 偏移量索引2.2.3.3 时间戳索引2.2.3.4 索引总结 2.2.4 flush刷新 2.3 Follow 获取日志 三、流程图四、总结 Kafka从成神到成仙系列
【Kafka从成神到升仙系列 一】Kafka源码环境搭建【Kafka从成神到升仙系列 二】生产者如何将消息放入到内存缓冲区【Kafka从成神到升仙系列 三】你真的了解 Kafka 的元数据嘛【Kafka从成神到升仙系列 四】你真的了解 Kafka 的缓存池机制嘛【Kafka从成神到升仙系列 五】面试官问我 Kafka 生产者的网络架构，我直接开始从源码背起…【Kafka从成神到升仙系列 六】kafka 不能失去网络通信，就像西方不能失去耶路撒冷 阿里 P7 三面凉凉，kafka Borker 日志持久化没答上来 一、引言 前段时间有个朋友，去面了阿里集团的P7岗位，很遗憾的是三面没有过
其中有一个 kafka Borker 日志如何持久化的问题没有答上来
今天正好写一篇源码文章给朋友复盘一下
虽然现在是互联网寒冬，但乾坤未定，你我皆是黑马！
废话不多说，发车！
二、日志原理介绍 在讲 Kafka 日志源码之前，我们要先对 Kafka 日志有一个大体的认识">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-17T12:12:29+08:00">
    <meta property="article:modified_time" content="2023-12-17T12:12:29+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">阿里 P7 三面凉凉，kafka Borker 日志持久化没答上来</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <ul><li>👏作者简介：大家好，我是爱敲代码的小黄，阿里巴巴淘天Java开发工程师，CSDN博客专家</li><li>📕系列专栏：Spring源码、Netty源码、Kafka源码、JUC源码、dubbo源码系列</li><li>🔥如果感觉博主的文章还不错的话，请👍三连支持👍一下博主哦</li><li>🍂博主正在努力完成2023计划中：<a href="https://juejin.cn/post/7184081730767159356" rel="nofollow">以梦为马，扬帆起航，2023追梦人</a></li><li>📝联系方式：hls1793929520，加我进群，大家一起学习，一起进步，一起对抗互联网寒冬👀</li></ul> 
</blockquote> 
<p><img src="https://images2.imgbox.com/d1/da/6NRDDhzX_o.jpg" alt="在这里插入图片描述"></p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_P7_kafka_Borker__21" rel="nofollow">阿里 P7 三面凉凉，kafka Borker 日志持久化没答上来</a></li><li><a href="#_23" rel="nofollow">一、引言</a></li><li><a href="#_35" rel="nofollow">二、日志原理介绍</a></li><li><a href="#_71" rel="nofollow">二、日志源码</a></li><li><ul><li><a href="#1_81" rel="nofollow">1、授权校验</a></li><li><a href="#2_107" rel="nofollow">2、消息添加</a></li><li><ul><li><a href="#21__Partition_160" rel="nofollow">2.1 获取 Partition</a></li><li><a href="#22__Leader__189" rel="nofollow">2.2 向 Leader 追加日志</a></li><li><ul><li><a href="#221__segment_205" rel="nofollow">2.2.1 是否创建 segment</a></li><li><a href="#222__segment_256" rel="nofollow">2.2.2 创建 segment</a></li><li><ul><li><a href="#2221__267" rel="nofollow">2.2.2.1 文件路径校验</a></li><li><a href="#2222_segment__290" rel="nofollow">2.2.2.2 segment 参数</a></li><li><a href="#2223__segment_311" rel="nofollow">2.2.2.3 生成 segment</a></li></ul> 
     </li><li><a href="#223__segment__349" rel="nofollow">2.2.3 向 segment 添加日志</a></li><li><ul><li><a href="#2231__383" rel="nofollow">2.2.3.1 稀疏索引</a></li><li><a href="#2232__415" rel="nofollow">2.2.3.2 偏移量索引</a></li><li><a href="#2233__437" rel="nofollow">2.2.3.3 时间戳索引</a></li><li><a href="#2234__456" rel="nofollow">2.2.3.4 索引总结</a></li></ul> 
     </li><li><a href="#224_flush_475" rel="nofollow">2.2.4 flush刷新</a></li></ul> 
    </li><li><a href="#23_Follow__499" rel="nofollow">2.3 Follow 获取日志</a></li></ul> 
   </li><li><a href="#_506" rel="nofollow">三、流程图</a></li><li><a href="#_511" rel="nofollow">四、总结</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<blockquote> 
 <p><strong>Kafka从成神到成仙系列</strong></p> 
 <ul><li><a href="https://xiaohuang.blog.csdn.net/article/details/123808733" rel="nofollow">【Kafka从成神到升仙系列 一】Kafka源码环境搭建</a></li><li><a href="https://xiaohuang.blog.csdn.net/article/details/123886917" rel="nofollow">【Kafka从成神到升仙系列 二】生产者如何将消息放入到内存缓冲区</a></li><li><a href="https://xiaohuang.blog.csdn.net/article/details/127856698" rel="nofollow">【Kafka从成神到升仙系列 三】你真的了解 Kafka 的元数据嘛</a></li><li><a href="https://xiaohuang.blog.csdn.net/article/details/127950274" rel="nofollow">【Kafka从成神到升仙系列 四】你真的了解 Kafka 的缓存池机制嘛</a></li><li><a href="https://xiaohuang.blog.csdn.net/article/details/128277388" rel="nofollow">【Kafka从成神到升仙系列 五】面试官问我 Kafka 生产者的网络架构，我直接开始从源码背起…</a></li><li><a href="https://xiaohuang.blog.csdn.net/article/details/128909086" rel="nofollow">【Kafka从成神到升仙系列 六】kafka 不能失去网络通信，就像西方不能失去耶路撒冷</a></li></ul> 
</blockquote> 
<hr> 
<h2><a id="_P7_kafka_Borker__21"></a>阿里 P7 三面凉凉，kafka Borker 日志持久化没答上来</h2> 
<h2><a id="_23"></a>一、引言</h2> 
<p>前段时间有个朋友，去面了阿里集团的P7岗位，很遗憾的是三面没有过</p> 
<p>其中有一个 <code>kafka</code> <code>Borker</code> 日志如何持久化的问题没有答上来</p> 
<p>今天正好写一篇源码文章给朋友复盘一下</p> 
<p><strong>虽然现在是互联网寒冬，但乾坤未定，你我皆是黑马！</strong></p> 
<p>废话不多说，发车！</p> 
<h2><a id="_35"></a>二、日志原理介绍</h2> 
<p>在讲 <code>Kafka</code> 日志源码之前，我们要先对 <code>Kafka</code> 日志有一个大体的认识</p> 
<p>这也是阅读源码的关键，一步一步来</p> 
<p>前面我们聊到了 <code>Kafka</code> 的生产端的整体架构</p> 
<p><img src="https://images2.imgbox.com/9c/dc/MonKfEsy_o.png" alt="image.png"></p> 
<p>可以看到，我们每一个 <code>Topic</code> 都可以分为多个 <code>Partition</code> ，而每一个 <code>Partition</code> 对应着一个 <code>Log</code></p> 
<p>但这里会存在两个问题，如果我们的数据过大</p> 
<ul><li>一个 <code>Log</code> 能装下吗？</li><li>就算能装下，插入/查询速度怎么保证？</li></ul> 
<p>所以，<code>Kafka</code> 在这里引入了日志分段（<code>LogSegment</code> ）的概念，将一个 <code>Log</code> 切割成多个 <code>LogSegment</code> 进行存储</p> 
<p>实际上，这里的 <code>Log</code> 和 <code>LogSegment</code> 并不是纯粹的物理意义上的概念</p> 
<ul><li><code>Log</code> 对应的文件夹</li><li><code>LogSegment</code> 对应磁盘上的一个日志文件和两个索引文件 
  <ul><li>日志文件：以 <code>.log</code> 为文件后缀</li><li>两个索引文件： 
    <ul><li>偏移量索引文件（以 <code>.index</code>为文件后缀）</li><li>时间戳索引文件（以<code>.timeindex</code>为文件后缀）</li></ul> </li></ul> </li></ul> 
<p>这里有个重点要记一下：<strong>每个 <code>LogSegment</code> 都有一个基准偏移量 <code>baseOffset</code>，用来表示当前 <code>LogSegment</code> 第一条消息的 <code>offset</code></strong></p> 
<p>日志和索引文件命名都是按照基准偏移量进行命名，所以日志整体架构如下：</p> 
<p><img src="https://images2.imgbox.com/db/c8/ijJ5xiSY_o.png" alt="image.png"></p> 
<p>这里我们简单介绍下这个日志是怎么搜索的，后面会深入源码细聊</p> 
<h2><a id="_71"></a>二、日志源码</h2> 
<p>我们回顾一下上篇文章的整体流程图：</p> 
<p><img src="https://images2.imgbox.com/7a/ab/4HjMYwJB_o.png" alt="在这里插入图片描述"></p> 
<p>我们可以看到，消息的处理是通过 <code>KafkaApis</code> 来进行的，日志持久化通过 <code>case ApiKeys.PRODUCE =&gt; handleProduceRequest(request)</code></p> 
<p>本篇我们也围绕这个方法展开</p> 
<h3><a id="1_81"></a>1、授权校验</h3> 
<pre><code class="prism language-scala"><span class="token keyword">def</span> handleProduceRequest<span class="token punctuation">(</span>request<span class="token operator">:</span> RequestChannel<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  <span class="token comment">// authorizedRequestInfo：存储通过授权验证的主题分区和对应的内存记录。</span>
  <span class="token keyword">val</span> authorizedRequestInfo <span class="token operator">=</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span>TopicPartition<span class="token punctuation">,</span> MemoryRecords<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> memoryRecords<span class="token punctuation">)</span> <span class="token keyword">&lt;-</span> produceRequest<span class="token punctuation">.</span>partitionRecordsOrFail<span class="token punctuation">.</span>asScala<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>authorize<span class="token punctuation">(</span>request<span class="token punctuation">.</span>session<span class="token punctuation">,</span> Write<span class="token punctuation">,</span> Resource<span class="token punctuation">(</span>Topic<span class="token punctuation">,</span> topicPartition<span class="token punctuation">.</span>topic<span class="token punctuation">,</span> LITERAL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    		<span class="token comment">// 未授权的</span>
        unauthorizedTopicResponses <span class="token operator">+=</span> topicPartition <span class="token operator">-&gt;</span> <span class="token keyword">new</span> PartitionResponse<span class="token punctuation">(</span>Errors<span class="token punctuation">.</span>TOPIC_AUTHORIZATION_FAILED<span class="token punctuation">)</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metadataCache<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>topicPartition<span class="token punctuation">)</span><span class="token punctuation">)</span>
        nonExistingTopicResponses <span class="token operator">+=</span> topicPartition <span class="token operator">-&gt;</span> <span class="token keyword">new</span> PartitionResponse<span class="token punctuation">(</span>Errors<span class="token punctuation">.</span>UNKNOWN_TOPIC_OR_PARTITION<span class="token punctuation">)</span>
      <span class="token keyword">else</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 授权的</span>
          ProduceRequest<span class="token punctuation">.</span>validateRecords<span class="token punctuation">(</span>request<span class="token punctuation">.</span>header<span class="token punctuation">.</span>apiVersion<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memoryRecords<span class="token punctuation">)</span>
          authorizedRequestInfo <span class="token operator">+=</span> <span class="token punctuation">(</span>topicPartition <span class="token operator">-&gt;</span> memoryRecords<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">case</span> e<span class="token operator">:</span> ApiException <span class="token keyword">=&gt;</span>
            invalidRequestResponses <span class="token operator">+=</span> topicPartition <span class="token operator">-&gt;</span> <span class="token keyword">new</span> PartitionResponse<span class="token punctuation">(</span>Errors<span class="token punctuation">.</span>forException<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2_107"></a>2、消息添加</h3> 
<ul><li>【重点】timeout：超时时间</li><li>【重点】requiredAcks：指定了在记录追加到副本后需要多少个副本进行确认，才认为写操作成功 
  <ul><li><code>0</code>: 不需要任何副本的确认</li><li><code>1</code>: 只需要主副本确认</li><li><code>-1</code> 或 <code>all</code>: 需要所有副本的确认</li></ul> </li><li><code>internalTopicsAllowed</code>：是否允许将记录追加到内部主题</li><li><code>isFromClient</code>：请求是否来自客户端</li><li>【重点】<code>entriesPerPartition</code>：包含了通过授权验证的主题分区和对应的内存记录</li><li><code>responseCallback</code>：回调函数，在记录追加完成后，会调用该回调函数发送响应给客户端。</li><li><code>recordConversionStatsCallback</code>：处理记录转换统计信息的逻辑</li></ul> 
<pre><code class="prism language-java">replicaManager<span class="token punctuation">.</span><span class="token function">appendRecords</span><span class="token punctuation">(</span>
        timeout <span class="token operator">=</span> produceRequest<span class="token punctuation">.</span>timeout<span class="token punctuation">.</span>toLong<span class="token punctuation">,</span>
        requiredAcks <span class="token operator">=</span> produceRequest<span class="token punctuation">.</span>acks<span class="token punctuation">,</span>
        internalTopicsAllowed <span class="token operator">=</span> internalTopicsAllowed<span class="token punctuation">,</span>
        isFromClient <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        entriesPerPartition <span class="token operator">=</span> authorizedRequestInfo<span class="token punctuation">,</span>
        responseCallback <span class="token operator">=</span> sendResponseCallback<span class="token punctuation">,</span>
        recordConversionStatsCallback <span class="token operator">=</span> processingStatsCallback<span class="token punctuation">)</span>
</code></pre> 
<p>我们主要关心这三个参数即可：<code>timeout</code>、<code>requiredAcks</code>、<code>entriesPerPartition</code>，其余的目前不太重要</p> 
<pre><code class="prism language-java">def <span class="token function">appendRecords</span><span class="token punctuation">(</span>timeout<span class="token operator">:</span> <span class="token class-name">Long</span><span class="token punctuation">,</span>
                  requiredAcks<span class="token operator">:</span> <span class="token class-name">Short</span><span class="token punctuation">,</span>
                  internalTopicsAllowed<span class="token operator">:</span> <span class="token class-name">Boolean</span><span class="token punctuation">,</span>
                  isFromClient<span class="token operator">:</span> <span class="token class-name">Boolean</span><span class="token punctuation">,</span>
                  entriesPerPartition<span class="token operator">:</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">MemoryRecords</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                  responseCallback<span class="token operator">:</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">PartitionResponse</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Unit</span><span class="token punctuation">,</span>
                  delayedProduceLock<span class="token operator">:</span> <span class="token class-name">Option</span><span class="token punctuation">[</span><span class="token class-name">Lock</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                  recordConversionStatsCallback<span class="token operator">:</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">RecordConversionStats</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token class-name">Unit</span> <span class="token operator">=</span> _ <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">// 校验当前的ACK</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidRequiredAcks</span><span class="token punctuation">(</span>requiredAcks<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 记录起始时间</span>
      val sTime <span class="token operator">=</span> time<span class="token punctuation">.</span>milliseconds
      <span class="token comment">// 追加本地日志</span>
      val localProduceResults <span class="token operator">=</span> <span class="token function">appendToLocalLog</span><span class="token punctuation">(</span>internalTopicsAllowed <span class="token operator">=</span> internalTopicsAllowed<span class="token punctuation">,</span>
        isFromClient <span class="token operator">=</span> isFromClient<span class="token punctuation">,</span> entriesPerPartition<span class="token punctuation">,</span> requiredAcks<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 允许当前的ACK为1、0、-1</span>
<span class="token keyword">private</span> def <span class="token function">isValidRequiredAcks</span><span class="token punctuation">(</span>requiredAcks<span class="token operator">:</span> <span class="token class-name">Short</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Boolean</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  requiredAcks <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> requiredAcks <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> requiredAcks <span class="token operator">==</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里的追加本地日志就是我们本篇的重点</p> 
<h4><a id="21__Partition_160"></a>2.1 获取 Partition</h4> 
<pre><code class="prism language-java"><span class="token keyword">private</span> def <span class="token function">appendToLocalLog</span><span class="token punctuation">(</span>internalTopicsAllowed<span class="token operator">:</span> <span class="token class-name">Boolean</span><span class="token punctuation">,</span>
                             isFromClient<span class="token operator">:</span> <span class="token class-name">Boolean</span><span class="token punctuation">,</span>
                             entriesPerPartition<span class="token operator">:</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">MemoryRecords</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                             requiredAcks<span class="token operator">:</span> <span class="token class-name">Short</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Map</span><span class="token punctuation">[</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">LogAppendResult</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  val partition <span class="token operator">=</span> <span class="token function">getPartitionOrException</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> expectLeader <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 根据给定的主题分区获取对应的分区对象</span>
def <span class="token function">getPartitionOrException</span><span class="token punctuation">(</span>topicPartition<span class="token operator">:</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> expectLeader<span class="token operator">:</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token class-name">Partition</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
   	<span class="token comment">// 获取Partition并匹配</span>
    <span class="token function">getPartition</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">)</span> match <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>partition<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>partition eq <span class="token class-name">ReplicaManager<span class="token punctuation">.</span>OfflinePartition</span><span class="token punctuation">)</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaStorageException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span>
          partition
      <span class="token keyword">case</span> <span class="token class-name">None</span> <span class="token keyword">if</span> metadataCache<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expectLeader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NotLeaderForPartitionException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReplicaNotAvailableException</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="22__Leader__189"></a>2.2 向 Leader 追加日志</h4> 
<pre><code class="prism language-Java">val info = partition.appendRecordsToLeader(records, isFromClient, requiredAcks);

def appendRecordsToLeader(records: MemoryRecords, isFromClient: Boolean, requiredAcks: Int = 0): LogAppendInfo = {
     val info = log.appendAsLeader(records, leaderEpoch = this.leaderEpoch, isFromClient,
            interBrokerProtocolVersion)
}

def appendAsLeader(records: MemoryRecords, leaderEpoch: Int, isFromClient: Boolean = true,
                     interBrokerProtocolVersion: ApiVersion = ApiVersion.latestVersion): LogAppendInfo = {
    append(records, isFromClient, interBrokerProtocolVersion, assignOffsets = true, leaderEpoch)
  }
</code></pre> 
<h5><a id="221__segment_205"></a>2.2.1 是否创建 segment</h5> 
<p>这里就到了我们一开始图中的 <code>LogSegment</code></p> 
<pre><code class="prism language-Java"> val segment = maybeRoll(validRecords.sizeInBytes, appendInfo);

 private def maybeRoll(messagesSize: Int, appendInfo: LogAppendInfo): LogSegment = {
   	// 如果应该滚动，创建一个新的segment
    // 反之，则返回当前的segment
    if (segment.shouldRoll(RollParams(config, appendInfo, messagesSize, now))) {
      appendInfo.firstOffset match {
        case Some(firstOffset) =&gt; roll(Some(firstOffset))
        case None =&gt; roll(Some(maxOffsetInMessages - Integer.MAX_VALUE))
      }
    } else {
      segment
    }
 }
</code></pre> 
<p>一共有六个条件，触发这六个条件，就会重新创建一个 <code>segment</code></p> 
<ul><li><code>timeWaitedForRoll(rollParams.now, rollParams.maxTimestampInMessages) &gt; rollParams.maxSegmentMs - rollJitterMs</code> ：判断时间等待是不是超时</li><li><code>size &gt; rollParams.maxSegmentBytes - rollParams.messagesSize</code>：当前 <code>segment</code> 是否有充足的空间存储当前信息</li><li><code>size &gt; 0 &amp;&amp; reachedRollMs</code> ：当前日志段的大小大于0，并且达到了进行日志分段的时间条件<code>reachedRollMs</code></li><li><code>offsetIndex.isFull</code> ：偏移索引满了</li><li><code>timeIndex.isFull</code>：时间戳索引满了</li><li><code>!canConvertToRelativeOffset(rollParams.maxOffsetInMessages)</code>：无法进行相对偏移的转换操作</li></ul> 
<pre><code class="prism language-scala"><span class="token keyword">class</span> LogSegment <span class="token keyword">private</span><span class="token punctuation">[</span>log<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token keyword">val</span> log<span class="token operator">:</span> FileRecords<span class="token punctuation">,</span>
                               <span class="token keyword">val</span> offsetIndex<span class="token operator">:</span> OffsetIndex<span class="token punctuation">,</span>
                               <span class="token keyword">val</span> timeIndex<span class="token operator">:</span> TimeIndex<span class="token punctuation">,</span>
                               <span class="token keyword">val</span> txnIndex<span class="token operator">:</span> TransactionIndex<span class="token punctuation">,</span>
                               <span class="token keyword">val</span> baseOffset<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span>
                               <span class="token keyword">val</span> indexIntervalBytes<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span>
                               <span class="token keyword">val</span> rollJitterMs<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span>
                               <span class="token keyword">val</span> time<span class="token operator">:</span> Time<span class="token punctuation">)</span> <span class="token keyword">extends</span> Logging <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> shouldRoll<span class="token punctuation">(</span>rollParams<span class="token operator">:</span> RollParams<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> reachedRollMs <span class="token operator">=</span> 
    timeWaitedForRoll<span class="token punctuation">(</span>rollParams<span class="token punctuation">.</span>now<span class="token punctuation">,</span> rollParams<span class="token punctuation">.</span>maxTimestampInMessages<span class="token punctuation">)</span> <span class="token operator">&gt;</span>    rollParams<span class="token punctuation">.</span>maxSegmentMs <span class="token operator">-</span> rollJitterMs
    size <span class="token operator">&gt;</span> rollParams<span class="token punctuation">.</span>maxSegmentBytes <span class="token operator">-</span> rollParams<span class="token punctuation">.</span>messagesSize <span class="token operator">||</span>
      <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> reachedRollMs<span class="token punctuation">)</span> <span class="token operator">||</span>
      offsetIndex<span class="token punctuation">.</span>isFull <span class="token operator">||</span> timeIndex<span class="token punctuation">.</span>isFull <span class="token operator">||</span> <span class="token operator">!</span>canConvertToRelativeOffset<span class="token punctuation">(</span>rollParams<span class="token punctuation">.</span>maxOffsetInMessages<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>整体来看，六个条件也比较简单，我们继续往后看</p> 
<h5><a id="222__segment_256"></a>2.2.2 创建 segment</h5> 
<pre><code class="prism language-scala">appendInfo<span class="token punctuation">.</span>firstOffset <span class="token keyword">match</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 存在第一个偏移量</span>
  <span class="token keyword">case</span> Some<span class="token punctuation">(</span>firstOffset<span class="token punctuation">)</span> <span class="token keyword">=&gt;</span> roll<span class="token punctuation">(</span>Some<span class="token punctuation">(</span>firstOffset<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment">// 不存在第一个偏移量</span>
  <span class="token keyword">case</span> None <span class="token keyword">=&gt;</span> roll<span class="token punctuation">(</span>Some<span class="token punctuation">(</span>maxOffsetInMessages <span class="token operator">-</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2221__267"></a>2.2.2.1 文件路径校验</h6> 
<pre><code class="prism language-scala"><span class="token keyword">def</span> roll<span class="token punctuation">(</span>expectedNextOffset<span class="token operator">:</span> Option<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">]</span> <span class="token operator">=</span> None<span class="token punctuation">)</span><span class="token operator">:</span> LogSegment <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  
  <span class="token comment">// 获取最新的offset</span>
  <span class="token keyword">val</span> newOffset <span class="token operator">=</span> math<span class="token punctuation">.</span>max<span class="token punctuation">(</span>expectedNextOffset<span class="token punctuation">.</span>getOrElse<span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logEndOffset<span class="token punctuation">)</span>
  <span class="token comment">// 获取日志文件路径</span>
  <span class="token keyword">val</span> logFile <span class="token operator">=</span> Log<span class="token punctuation">.</span>logFile<span class="token punctuation">(</span>dir<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span>
  <span class="token comment">// 获取偏移量索引文件路径</span>
  <span class="token keyword">val</span> offsetIdxFile <span class="token operator">=</span> offsetIndexFile<span class="token punctuation">(</span>dir<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span>
  <span class="token comment">// 获取时间戳索引文件路径</span>
  <span class="token keyword">val</span> timeIdxFile <span class="token operator">=</span> timeIndexFile<span class="token punctuation">(</span>dir<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span>
  <span class="token comment">// 获取事务索引文件路径</span>
  <span class="token keyword">val</span> txnIdxFile <span class="token operator">=</span> transactionIndexFile<span class="token punctuation">(</span>dir<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span>
  
  <span class="token comment">// 对路径列表进行遍历，如果文件存在，则将其删除。</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>file <span class="token keyword">&lt;-</span> List<span class="token punctuation">(</span>logFile<span class="token punctuation">,</span> offsetIdxFile<span class="token punctuation">,</span> timeIdxFile<span class="token punctuation">,</span> txnIdxFile<span class="token punctuation">)</span> <span class="token keyword">if</span> file<span class="token punctuation">.</span>exists<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Files<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>file<span class="token punctuation">.</span>toPath<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2222_segment__290"></a>2.2.2.2 segment 参数</h6> 
<ul><li>dir：日志段所在的目录</li><li>baseOffset：日志段的基准偏移量</li><li>config：日志的配置信息</li><li>time：时间对象，用于处理时间相关的操作。</li><li>fileAlreadyExists：指示日志文件是否已经存在</li><li>initFileSize：初始文件大小</li><li>preallocate：是否预分配文件空间</li><li>fileSuffix：文件后缀</li></ul> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> segment <span class="token operator">=</span> LogSegment<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span>
  baseOffset <span class="token operator">=</span> newOffset<span class="token punctuation">,</span>
  config<span class="token punctuation">,</span>
  time <span class="token operator">=</span> time<span class="token punctuation">,</span>
  fileAlreadyExists <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  initFileSize <span class="token operator">=</span> initFileSize<span class="token punctuation">,</span>
  preallocate <span class="token operator">=</span> config<span class="token punctuation">.</span>preallocate<span class="token punctuation">)</span>
</code></pre> 
<h6><a id="2223__segment_311"></a>2.2.2.3 生成 segment</h6> 
<pre><code class="prism language-scala"><span class="token keyword">new</span> LogSegment<span class="token punctuation">(</span>
  <span class="token comment">// 生成日志文件</span>
  FileRecords<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span>Log<span class="token punctuation">.</span>logFile<span class="token punctuation">(</span>dir<span class="token punctuation">,</span> baseOffset<span class="token punctuation">,</span> fileSuffix<span class="token punctuation">)</span><span class="token punctuation">,</span> fileAlreadyExists<span class="token punctuation">,</span> initFileSize<span class="token punctuation">,</span> preallocate<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 生成偏移量索引</span>
  <span class="token keyword">new</span> OffsetIndex<span class="token punctuation">(</span>Log<span class="token punctuation">.</span>offsetIndexFile<span class="token punctuation">(</span>dir<span class="token punctuation">,</span> baseOffset<span class="token punctuation">,</span> fileSuffix<span class="token punctuation">)</span><span class="token punctuation">,</span> baseOffset <span class="token operator">=</span> baseOffset<span class="token punctuation">,</span> maxIndexSize <span class="token operator">=</span> maxIndexSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 生成时间戳索引</span>
  <span class="token keyword">new</span> TimeIndex<span class="token punctuation">(</span>Log<span class="token punctuation">.</span>timeIndexFile<span class="token punctuation">(</span>dir<span class="token punctuation">,</span> baseOffset<span class="token punctuation">,</span> fileSuffix<span class="token punctuation">)</span><span class="token punctuation">,</span> baseOffset <span class="token operator">=</span> baseOffset<span class="token punctuation">,</span> maxIndexSize <span class="token operator">=</span> maxIndexSize<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 生成事务索引</span>
  <span class="token keyword">new</span> TransactionIndex<span class="token punctuation">(</span>baseOffset<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>transactionIndexFile<span class="token punctuation">(</span>dir<span class="token punctuation">,</span> baseOffset<span class="token punctuation">,</span> fileSuffix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// 基准偏移量</span>
  baseOffset<span class="token punctuation">,</span>
  indexIntervalBytes <span class="token operator">=</span> config<span class="token punctuation">.</span>indexInterval<span class="token punctuation">,</span>
  rollJitterMs <span class="token operator">=</span> config<span class="token punctuation">.</span>randomSegmentJitter<span class="token punctuation">,</span>
  time<span class="token punctuation">)</span>
</code></pre> 
<p>这里有一个重点需要关注一下，那就是 <code>mmap</code> 的零拷贝</p> 
<p><code>OffsetIndex</code> 和 <code>TimeIndex</code> 他们继承 <code>AbstractIndex</code> ，而 <code>AbstractIndex</code> 中使用 <code>mmp</code> 作为 <code>buffer </code></p> 
<pre><code class="prism language-scala"><span class="token keyword">class</span> OffsetIndex<span class="token punctuation">(</span>_file<span class="token operator">:</span> File<span class="token punctuation">,</span> baseOffset<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> maxIndexSize<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> writable<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> AbstractIndex<span class="token punctuation">[</span><span class="token builtin">Long</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">]</span><span class="token punctuation">(</span>_file<span class="token punctuation">,</span> baseOffset<span class="token punctuation">,</span> maxIndexSize<span class="token punctuation">,</span> writable<span class="token punctuation">)</span> 
    

<span class="token keyword">abstract</span> <span class="token keyword">class</span> AbstractIndex<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">protected</span> <span class="token keyword">var</span> mmap<span class="token operator">:</span> MappedByteBuffer <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>另外，这里先提一个知识点，后面会专门写一篇文章来分析一下</p> 
<p><strong>我们索引在查询的时候，采用的是二分查找的方式，这会导致 缺页中断，于是 <code>kafka</code> 将二分查找进行改进，将索引区分为 冷区 和 热区，分别搜索，尽可能保证热区的页在 <code>Page Cache</code> 里面，从而避免缺页中断。</strong></p> 
<p>当我们的 <code>segment</code> 生成完之后，就返回了</p> 
<h5><a id="223__segment__349"></a>2.2.3 向 segment 添加日志</h5> 
<pre><code class="prism language-scala">segment<span class="token punctuation">.</span>append<span class="token punctuation">(</span>largestOffset <span class="token operator">=</span> appendInfo<span class="token punctuation">.</span>lastOffset<span class="token punctuation">,</span>
          largestTimestamp <span class="token operator">=</span> appendInfo<span class="token punctuation">.</span>maxTimestamp<span class="token punctuation">,</span>
          shallowOffsetOfMaxTimestamp <span class="token operator">=</span> appendInfo<span class="token punctuation">.</span>offsetOfMaxTimestamp<span class="token punctuation">,</span>
          records <span class="token operator">=</span> validRecords<span class="token punctuation">)</span>

<span class="token keyword">def</span> append<span class="token punctuation">(</span>largestOffset<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span>
             largestTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span>
             shallowOffsetOfMaxTimestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span>
             records<span class="token operator">:</span> MemoryRecords<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>records<span class="token punctuation">.</span>sizeInBytes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 添加日志</span>
      <span class="token keyword">val</span> appendedBytes <span class="token operator">=</span> log<span class="token punctuation">.</span>append<span class="token punctuation">(</span>records<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 当累加超过多少时，才会进行索引的写入</span>
  <span class="token comment">// indexIntervalBytes 默认 1048576 字节（1MB）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesSinceLastIndexEntry <span class="token operator">&gt;</span> indexIntervalBytes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 添加偏移量索引</span>
    offsetIndex<span class="token punctuation">.</span>append<span class="token punctuation">(</span>largestOffset<span class="token punctuation">,</span> physicalPosition<span class="token punctuation">)</span>
    <span class="token comment">// 添加时间戳索引</span>
    timeIndex<span class="token punctuation">.</span>maybeAppend<span class="token punctuation">(</span>maxTimestampSoFar<span class="token punctuation">,</span> offsetOfMaxTimestamp<span class="token punctuation">)</span>
    <span class="token comment">// 归0</span>
    bytesSinceLastIndexEntry <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 累加</span>
  bytesSinceLastIndexEntry <span class="token operator">+=</span> records<span class="token punctuation">.</span>sizeInBytes
<span class="token punctuation">}</span>

<span class="token comment">// lastOffset + 1</span>
updateLogEndOffset<span class="token punctuation">(</span>appendInfo<span class="token punctuation">.</span>lastOffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<h6><a id="2231__383"></a>2.2.3.1 稀疏索引</h6> 
<p><code>kafka</code> 中的偏移量索引和时间戳索引都属于稀疏索引</p> 
<p>何为稀疏索引？</p> 
<p>正常来说，我们会为每一个日志都创建一个索引，比如：</p> 
<pre><code class="prism language-xml">日志  索引
1     1
2     2
3     3
4     4
</code></pre> 
<p>但这种方式比较浪费，于是采用稀疏索引，如下：</p> 
<pre><code class="prism language-xml">日志  索引
1     1
2			
3			
4			
5     2
6
7
8
</code></pre> 
<p>当我们根据偏移量索引查询 <code>1</code> 时，可以查询到日志为 <code>1</code> 的，然后往下遍历搜索想要的即可。</p> 
<h6><a id="2232__415"></a>2.2.3.2 偏移量索引</h6> 
<pre><code class="prism language-scala">offsetIndex<span class="token punctuation">.</span>append<span class="token punctuation">(</span>largestOffset<span class="token punctuation">,</span> physicalPosition<span class="token punctuation">)</span>
 
<span class="token keyword">def</span> append<span class="token punctuation">(</span>offset<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> position<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  inLock<span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 索引位置</span>
    mmap<span class="token punctuation">.</span>putInt<span class="token punctuation">(</span>relativeOffset<span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 日志位置</span>
    mmap<span class="token punctuation">.</span>putInt<span class="token punctuation">(</span>position<span class="token punctuation">)</span>
    _entries <span class="token operator">+=</span> <span class="token number">1</span>
    _lastOffset <span class="token operator">=</span> offset
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 用当前offset减去基准offset</span>
<span class="token keyword">def</span> relativeOffset<span class="token punctuation">(</span>offset<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">val</span> relativeOffset <span class="token operator">=</span> offset <span class="token operator">-</span> baseOffset
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2233__437"></a>2.2.3.3 时间戳索引</h6> 
<pre><code class="prism language-scala">timeIndex<span class="token punctuation">.</span>maybeAppend<span class="token punctuation">(</span>maxTimestampSoFar<span class="token punctuation">,</span> offsetOfMaxTimestamp<span class="token punctuation">)</span>

<span class="token keyword">def</span> maybeAppend<span class="token punctuation">(</span>timestamp<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token builtin">Long</span><span class="token punctuation">,</span> skipFullCheck<span class="token operator">:</span> <span class="token builtin">Boolean</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    inLock<span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&gt;</span> lastEntry<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 添加时间戳</span>
        mmap<span class="token punctuation">.</span>putLong<span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span>
        <span class="token comment">// 添加相对位移(偏移量索引)</span>
        mmap<span class="token punctuation">.</span>putInt<span class="token punctuation">(</span>relativeOffset<span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">)</span>
        _entries <span class="token operator">+=</span> <span class="token number">1</span>
        _lastEntry <span class="token operator">=</span> TimestampOffset<span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> offset<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2234__456"></a>2.2.3.4 索引总结</h6> 
<p>我们的偏移量索引如图下所示：</p> 
<ul><li>当我们查询一个消息时，比如消息位移为 <code>23</code> 的 
  <ul><li>根据二分查找找到偏移量索引下标 <code>22</code></li><li>利用上述我们偏移量 <code>Map</code> 的存储，得到其日志位置 <code>RecordBatch:firstOffset=23 position=762</code></li><li>再根据日志位置，找到真正存储日志的地方</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/63/f0/gHmkbDbi_o.png" alt="image.png"></p> 
<p>我们的时间戳索引如图下所示：</p> 
<ul><li>基本和我们的偏移量索引类似，只是增加了一层二分查找</li></ul> 
<p><img src="https://images2.imgbox.com/4e/de/aM7aScAn_o.png" alt="image.png"></p> 
<h5><a id="224_flush_475"></a>2.2.4 flush刷新</h5> 
<p>在我们前面添加完之后，我们的数据仅仅是写到 <code>PageCache</code> 里面，需要进行 <code>flush</code> 将其刷新到磁盘中</p> 
<pre><code class="prism language-scala"><span class="token comment">// 未刷新消息数（unflushedMessages）超过配置的刷新间隔（flushInterval）</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>unflushedMessages <span class="token operator">&gt;=</span> config<span class="token punctuation">.</span>flushInterval<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">def</span> flush<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    LogFlushStats<span class="token punctuation">.</span>logFlushTimer<span class="token punctuation">.</span>time <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 日志刷新</span>
      log<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 偏移量索引刷新</span>
      offsetIndex<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 时间戳索引刷新</span>
      timeIndex<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 事务索引刷新</span>
      txnIndex<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="23_Follow__499"></a>2.3 Follow 获取日志</h4> 
<p>同样，我们的 <code>Follow</code> 在获取日志时，和我们 <code>Leader</code> 添加日志时一样的方法</p> 
<p><img src="https://images2.imgbox.com/77/0a/oh6Lc36n_o.png" alt="image.png"></p> 
<h3><a id="_506"></a>三、流程图</h3> 
<p><img src="https://images2.imgbox.com/3a/3f/yGTjSNbB_o.png" alt="image.png"></p> 
<h3><a id="_511"></a>四、总结</h3> 
<p>这一篇我们介绍了 <code>Kafka</code> 中日志时如何持久化的以及 <code>Kafka</code> 日志中包括什么数据</p> 
<p>鲁迅先生曾说：独行难，众行易，和志同道合的人一起进步。彼此毫无保留的分享经验，才是对抗互联网寒冬的最佳选择。</p> 
<p>其实很多时候，并不是我们不够努力，很可能就是自己努力的方向不对，如果有一个人能稍微指点你一下，你真的可能会少走几年弯路。</p> 
<p>如果你也对 <strong>后端架构</strong> 和 <strong>中间件源码</strong> 有兴趣，欢迎添加博主微信：hls1793929520，一起学习，一起成长</p> 
<p>我是爱敲代码的小黄，阿里巴巴淘天集团Java开发工程师，双非二本，培训班出身</p> 
<p>通过两年努力，成功拿下阿里、百度、美团、滴滴等大厂，想通过自己的事迹告诉大家，努力是会有收获的！</p> 
<p><a href="https://juejin.cn/post/7291193866132275254" rel="nofollow">双非本两年经验，我是如何拿下阿里、百度、美团、滴滴、快手、拼多多等大厂offer的？</a></p> 
<p>我们下期再见。</p> 
<blockquote> 
 <p>从清晨走过，也拥抱夜晚的星辰，人生没有捷径，你我皆平凡，你好，陌生人，一起共勉。</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/849741e4b32a7352641f8966abac990f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">FAILED: HiveException java.lang.RuntimeException: Unable to instantiate org.apache.hadoop.hive.ql.me</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/41fa281ceea02449aef085e40143ce07/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mac只有键盘怎么连接蓝牙鼠标</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>