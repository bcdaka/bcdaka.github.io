<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>瑞芯微RK3568/RK3588平台YOLOV5实时视频算法的部署小白教程 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/7317b9240dc4aebe13bcfd6dd58035be/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="瑞芯微RK3568/RK3588平台YOLOV5实时视频算法的部署小白教程">
  <meta property="og:description" content="瑞芯微平台YOLOV5算法的部署 本文实现整体的部署流程比较小白，首先在PC上分别实现工程中的模型仿真推理、yolov5-pytorch仿真推理、自己训练yolov5模型仿真推理，完成仿真之后再在板端分别实现rk提供模型的板端推理、yolov5-pytorch板端推理、自己训练的yolov5模型板端推理，最后实现自己训练的yolov5模型实时视频算法部署，整个过程从仿真到板端，从图片到视频，过程较为繁琐，各位大佬们可以根据自己的情况选择跳过某些章节。接下来我们就一块开始部署之旅吧！
一. 部署概述 环境：Ubuntu20.04、python3.8
芯片：RK3568
芯片系统：buildroot
开发板：RP-RK3568-B
依赖：Qt &#43; opencv &#43; rknn &#43; rga实现视频流采集缩放识别到输出显示，支持USB摄像头、mipi摄像头等，输出支持mipi、hdmi
开发主要参考文档：《Rockchip_Quick_Start_RKNN_Toolkit2_CN-1.4.0.pdf》、《Rockchip_User_Guide_RKNN_Toolkit2_CN-1.4.0.pdf》
二.yolov5模型训练 训练过程网上的博客已经非常完善，不过要注意一下下面提到的yolov5版本，简单记录一下步骤。
2.1创建conda环境 PC机：win10
CUDA：11.7
# 创建conda环境 conda create -n rkyolov5 python=3.8 # 激活conda环境 conda activate rkyolov5 # 删除所有镜像源 conda config --remove-key channels # 安装pytoch conda install pytorch torchvision torchaudio pytorch-cuda=11.7 -c pytorch -c nvidia 安装pytorch到官网下载对应的CUDA版本。
2.2训练yolov5 对应版本的yolov5链接：https://github.com/ultralytics/yolov5/tree/c5360f6e7009eb4d05f14d1cc9dae0963e949213
此版本为v5.0，相应的权重文件可对应从官网下载；
将yolov5的激活函数由silu改为relu，会损失精度但能带来性能的提升。
以下QA记录训练时的报错信息。
Q：UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-09-07T14:44:28+08:00">
    <meta property="article:modified_time" content="2023-09-07T14:44:28+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">瑞芯微RK3568/RK3588平台YOLOV5实时视频算法的部署小白教程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="YOLOV5_0"></a>瑞芯微平台YOLOV5算法的部署</h2> 
<p>本文实现整体的部署流程比较小白，首先在PC上分别实现工程中的模型仿真推理、yolov5-pytorch仿真推理、自己训练yolov5模型仿真推理，完成仿真之后再在板端分别实现rk提供模型的板端推理、yolov5-pytorch板端推理、自己训练的yolov5模型板端推理，最后实现自己训练的yolov5模型实时视频算法部署，整个过程从仿真到板端，从图片到视频，过程较为繁琐，各位大佬们可以根据自己的情况选择跳过某些章节。接下来我们就一块开始部署之旅吧！</p> 
<h3><a id="__2"></a>一. 部署概述</h3> 
<p>环境：Ubuntu20.04、python3.8</p> 
<p>芯片：RK3568</p> 
<p>芯片系统：buildroot</p> 
<p>开发板：RP-RK3568-B</p> 
<p>依赖：Qt + opencv + rknn + rga实现视频流采集缩放识别到输出显示，支持USB摄像头、mipi摄像头等，输出支持mipi、hdmi</p> 
<p>开发主要参考文档：《Rockchip_Quick_Start_RKNN_Toolkit2_CN-1.4.0.pdf》、《Rockchip_User_Guide_RKNN_Toolkit2_CN-1.4.0.pdf》</p> 
<h3><a id="yolov5_18"></a>二.yolov5模型训练</h3> 
<p>训练过程网上的博客已经非常完善，不过要注意一下下面提到的yolov5版本，简单记录一下步骤。</p> 
<h4><a id="21conda_20"></a>2.1创建conda环境</h4> 
<p>PC机：win10</p> 
<p>CUDA：11.7</p> 
<pre><code class="prism language-shell"><span class="token comment"># 创建conda环境</span>
conda create <span class="token parameter variable">-n</span> rkyolov5 <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.8</span>
<span class="token comment"># 激活conda环境</span>
conda activate rkyolov5
<span class="token comment"># 删除所有镜像源</span>
conda config --remove-key channels
<span class="token comment"># 安装pytoch</span>
conda <span class="token function">install</span> pytorch torchvision torchaudio pytorch-cuda<span class="token operator">=</span><span class="token number">11.7</span> <span class="token parameter variable">-c</span> pytorch <span class="token parameter variable">-c</span> nvidia
</code></pre> 
<p>安装pytorch到<a href="https://pytorch.org/" rel="nofollow">官网</a>下载对应的CUDA版本。</p> 
<h4><a id="22yolov5_39"></a>2.2训练yolov5</h4> 
<p>对应版本的yolov5链接：https://github.com/ultralytics/yolov5/tree/c5360f6e7009eb4d05f14d1cc9dae0963e949213</p> 
<p>此版本为v5.0，相应的权重文件可对应从官网下载；</p> 
<p>将yolov5的激活函数由silu改为relu，会损失精度但能带来性能的提升。</p> 
<p>以下QA记录训练时的报错信息。</p> 
<p>Q：UserWarning: torch.meshgrid: in an upcoming release, it will be required to pass the indexing argument. (Triggered internally at TensorShape.cpp:2228.) return _VF.meshgrid(tensors, **kwargs) # type: ignore[attr-defined]</p> 
<p>A：functional.py文件中，将 return _VF.meshgrid(tensors, **kwargs）改为 return _VF.meshgrid(tensors, **kwargs,indexing=‘ij’)</p> 
<p>Q：RuntimeError: result type Float can‘t be cast to the desired output type __int64</p> 
<p>A：loss.py文件中修改</p> 
<ul><li> <p>anchors = self.anchors[i] 为anchors, shape = self.anchors[i], p[i].shape</p> </li><li> <p>indices.append((b, a, gj.clamp_(0, gain[3] - 1), gi.clamp_(0, gain[2] - 1))) # image, anchor, grid indices<br> 为<br> indices.append((b, a, gj.clamp_(0, shape[2] - 1), gi.clamp_(0, shape[3] - 1))) # image, anchor, grid</p> </li></ul> 
<h3><a id="Ubuntu_67"></a>三.Ubuntu环境搭建</h3> 
<p>根据文档中所写，RK官方提供了两种环境搭建方法：一是通过 Python 包安装与管理工具 pip 进行安装；二是运行带完整 RKNN-Toolkit2 工具包的 docker 镜像。<br> <img src="https://images2.imgbox.com/6f/01/5aJQyYS3_o.png" alt="文档描述"></p> 
<p>建议采用通过Docker镜像安装的方式，后续不用担心因环境搭建引起的问题。其中包含docker镜像的安装包在<a href="https://github.com/rockchip-linux/rknn-toolkit2">瑞芯微github项目主页提供的百度企业网盘链接</a>中，从网盘下载的rknn-toolkit2和github拉取的区别在于是否包含docker镜像，rknn-npu2项目可以直接从<a href="https://github.com/rockchip-linux/rknpu2">github/rockchip-linux/rknpu2</a>拉取最新代码。</p> 
<p>下面给出在项目中常用到的docker命令：</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> images // 列出docker中的镜像
<span class="token operator">&lt;</span>ctrl + D<span class="token operator">&gt;</span> // 退出容器
<span class="token function">docker</span> <span class="token function">ps</span> // 列出正在运行的容器
<span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span> // 列出所有的容器
<span class="token function">docker</span> start <span class="token parameter variable">-i</span> <span class="token operator">&lt;</span>id of image<span class="token operator">&gt;</span> // 启动容器
</code></pre> 
<p>docker安装后执行如下命令：</p> 
<pre><code class="prism language-shell"><span class="token comment"># 加载镜像</span>
rockchip@rockchip-virtual-machine:~/NPU/rknn-toolkit2-1.4.0/docker$ <span class="token function">docker</span> load <span class="token parameter variable">--input</span> rknn-toolkit2-1.4.0-cp38-docker.tar.gz 
feef05f055c9: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">75</span>.13MB/75.13MB
27a0fcbed699: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">3</span>.584kB/3.584kB
f62852363a2c: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>    424MB/424MB
d3193fc26692: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">4</span>.608kB/4.608kB
85943b0adcca: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">9</span>.397MB/9.397MB
0bec62724c1a: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">9</span>.303MB/9.303MB
e71db98f482d: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">262</span>.1MB/262.1MB
bde01abfb33a: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">4</span>.498MB/4.498MB
da9eed9f1e11: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">5</span>.228GB/5.228GB
85893de9b3b8: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">106</span>.7MB/106.7MB
0c9ec6e0b723: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">106</span>.7MB/106.7MB
d16b85c303bc: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>  <span class="token number">106</span>.7MB/106.7MB
Loaded image: rknn-toolkit2:1.4.0-cp38

<span class="token comment"># 检查镜像</span>
rockchip@rockchip-virtual-machine:~/NPU/rknn-toolkit2-1.4.0/docker$ <span class="token function">docker</span> images
REPOSITORY      TAG          IMAGE ID       CREATED         SIZE
rknn-toolkit2   <span class="token number">1.4</span>.0-cp38   afab63ce3679   <span class="token number">7</span> months ago    <span class="token number">6</span>.29GB
hello-world     latest       feb5d9fea6a5   <span class="token number">19</span> months ago   <span class="token number">13</span>.3kB

<span class="token comment"># 运行镜像并将examples映射到镜像空间。根据自己路径修改命令中的路径。</span>
rockchip@rockchip-virtual-machine:~/NPU/rknn-toolkit2-1.4.0/docker$ <span class="token function">docker</span> run <span class="token parameter variable">-t</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">--privileged</span> <span class="token parameter variable">-v</span> /dev/bus/usb:/dev/bus/usb <span class="token parameter variable">-v</span> /home/rockchip/NPU/rknn-toolkit2-1.4.0/examples/:/examples rknn-toolkit2:1.4.0-cp38 /bin/bash
root@129da9263f1e:/<span class="token comment"># </span>
root@129da9263f1e:/<span class="token comment"># </span>
root@129da9263f1e:/<span class="token comment"># </span>
root@129da9263f1e:/<span class="token comment"># ls</span>
bin  boot  dev  etc  examples  home  lib  lib32  lib64  libx32  media  mnt  opt  packages  proc  root  run  sbin  srv  sys  tmp  usr  var

<span class="token comment"># 运行demo</span>
root@129da9263f1e:/examples/tflite/mobilenet_v1<span class="token comment"># python3 test.py </span>
W __init__: rknn-toolkit2 version: <span class="token number">1.4</span>.0-22dcfef4
--<span class="token operator">&gt;</span> Config model
W config: <span class="token string">'target_platform'</span> is None, use rk3566 as default, Please <span class="token builtin class-name">set</span> according to the actual platform<span class="token operator">!</span>
<span class="token keyword">done</span>
--<span class="token operator">&gt;</span> Loading model
<span class="token number">2023</span>-04-20 <span class="token number">15</span>:21:12.334160: W tensorflow/stream_executor/platform/default/dso_loader.cc:64<span class="token punctuation">]</span> Could not load dynamic library <span class="token string">'libcudart.so.11.0'</span><span class="token punctuation">;</span> dlerror: libcudart.so.11.0: cannot <span class="token function">open</span> shared object file: No such <span class="token function">file</span> or directory<span class="token punctuation">;</span> LD_LIBRARY_PATH: /usr/local/lib/python3.8/dist-packages/cv2/<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/lib64:
<span class="token number">2023</span>-04-20 <span class="token number">15</span>:21:12.334291: I tensorflow/stream_executor/cuda/cudart_stub.cc:29<span class="token punctuation">]</span> Ignore above cudart dlerror <span class="token keyword">if</span> you <span class="token keyword">do</span> not have a GPU <span class="token builtin class-name">set</span> up on your machine.
<span class="token keyword">done</span>
--<span class="token operator">&gt;</span> Building model
I base_optimize <span class="token punctuation">..</span>.
I base_optimize done.
I …………………………………………
D RKNN: <span class="token punctuation">[</span><span class="token number">15</span>:21:23.735<span class="token punctuation">]</span> ----------------------------------------
D RKNN: <span class="token punctuation">[</span><span class="token number">15</span>:21:23.735<span class="token punctuation">]</span> Total Weight Memory Size: <span class="token number">4365632</span>
D RKNN: <span class="token punctuation">[</span><span class="token number">15</span>:21:23.735<span class="token punctuation">]</span> Total Internal Memory Size: <span class="token number">1756160</span>
D RKNN: <span class="token punctuation">[</span><span class="token number">15</span>:21:23.735<span class="token punctuation">]</span> Predict Internal Memory RW Amount: <span class="token number">10331296</span>
D RKNN: <span class="token punctuation">[</span><span class="token number">15</span>:21:23.735<span class="token punctuation">]</span> Predict Weight Memory RW Amount: <span class="token number">4365552</span>
D RKNN: <span class="token punctuation">[</span><span class="token number">15</span>:21:23.735<span class="token punctuation">]</span> ----------------------------------------
D RKNN: <span class="token punctuation">[</span><span class="token number">15</span>:21:23.735<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;&lt;</span><span class="token operator">&lt;&lt;&lt;</span><span class="token operator">&lt;&lt;</span> end: N4rknn21RKNNMemStatisticsPassE
I rknn buiding <span class="token keyword">done</span>
<span class="token keyword">done</span>
--<span class="token operator">&gt;</span> Export rknn model
<span class="token keyword">done</span>
--<span class="token operator">&gt;</span> Init runtime environment
W init_runtime: Target is None, use simulator<span class="token operator">!</span>
<span class="token keyword">done</span>
--<span class="token operator">&gt;</span> Running model
Analysing <span class="token builtin class-name">:</span> <span class="token number">100</span>%<span class="token operator">|</span>█████████████████████████████████████████████████<span class="token operator">|</span> <span class="token number">60</span>/60 <span class="token punctuation">[</span>00:0<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>00:00, <span class="token number">1236</span>.81it/s<span class="token punctuation">]</span>
Preparing <span class="token builtin class-name">:</span> <span class="token number">100</span>%<span class="token operator">|</span>██████████████████████████████████████████████████<span class="token operator">|</span> <span class="token number">60</span>/60 <span class="token punctuation">[</span>00:0<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>00:00, <span class="token number">448</span>.14it/s<span class="token punctuation">]</span>
mobilenet_v1
-----TOP <span class="token number">5</span>-----
<span class="token punctuation">[</span><span class="token number">156</span><span class="token punctuation">]</span>: <span class="token number">0.9345703125</span>
<span class="token punctuation">[</span><span class="token number">155</span><span class="token punctuation">]</span>: <span class="token number">0.0570068359375</span>
<span class="token punctuation">[</span><span class="token number">205</span><span class="token punctuation">]</span>: <span class="token number">0.00429534912109375</span>
<span class="token punctuation">[</span><span class="token number">284</span><span class="token punctuation">]</span>: <span class="token number">0.003116607666015625</span>
<span class="token punctuation">[</span><span class="token number">285</span><span class="token punctuation">]</span>: <span class="token number">0.00017178058624267578</span>

<span class="token keyword">done</span>

</code></pre> 
<p>到此环境已全部配置完成。</p> 
<h3><a id="rkyolov5sonnx_161"></a>四.测试rk官方提供的yolov5s.onnx</h3> 
<p>进入目录<code>/NPU/rknn-toolkit2-1.4.0/examples/onnx/yolov5</code>，执行</p> 
<pre><code class="prism language-shell"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> python3 test.py
class: person, score: <span class="token number">0.8223356008529663</span>
box coordinate left,top,right,down: <span class="token punctuation">[</span><span class="token number">473.26745200157166</span>, <span class="token number">231.93780636787415</span>, <span class="token number">562.1268351078033</span>, <span class="token number">519.7597033977509</span><span class="token punctuation">]</span>
class: person, score: <span class="token number">0.817978024482727</span>
box coordinate left,top,right,down: <span class="token punctuation">[</span><span class="token number">211.9896697998047</span>, <span class="token number">245.0290389060974</span>, <span class="token number">283.70787048339844</span>, <span class="token number">513.9374527931213</span><span class="token punctuation">]</span>
class: person, score: <span class="token number">0.7971192598342896</span>
box coordinate left,top,right,down: <span class="token punctuation">[</span><span class="token number">115.24964022636414</span>, <span class="token number">232.44154334068298</span>, <span class="token number">207.7837154865265</span>, <span class="token number">546.1097872257233</span><span class="token punctuation">]</span>
class: person, score: <span class="token number">0.4627230763435364</span>
box coordinate left,top,right,down: <span class="token punctuation">[</span><span class="token number">79.09242534637451</span>, <span class="token number">339.18042743206024</span>, <span class="token number">121.60038471221924</span>, <span class="token number">514.234916806221</span><span class="token punctuation">]</span>
class: bus , score: <span class="token number">0.7545359134674072</span>
box coordinate left,top,right,down: <span class="token punctuation">[</span><span class="token number">86.41703361272812</span>, <span class="token number">134.41848754882812</span>, <span class="token number">558.1083570122719</span>, <span class="token number">460.4184875488281</span><span class="token punctuation">]</span>
</code></pre> 
<p>执行完在此路径下可以看到生成了一张result.jpg，打开可以看到预测结果图。</p> 
<h3><a id="yolov5sPytorch_181"></a>五.转换yolov5s-Pytorch模型并测试推理</h3> 
<h4><a id="51ptonnx_183"></a>5.1pt转onnx</h4> 
<p>各个软件包都要<strong>注意版本！注意版本！注意版本！</strong></p> 
<pre><code>pytorch==1.7.1 torchvision==0.8.2 torchaudio==0.7.2 cudatoolkit=11.0 
pillow==8.4.0
protobuf==3.20
onnx==1.9.0
opset version:12
</code></pre> 
<p>转换步骤：</p> 
<ul><li> <p>修改<code>models/yolo.py</code>，修改<code>class Detect(nn.Module):</code>的<code>forward</code>函数，<mark><strong>注意！！！仅在转换时修改，在训练时改回原状态！再训练时不要忘记哦！</strong></mark></p> <pre><code class="prism language-python">	<span class="token comment"># def forward(self, x):</span>
    <span class="token comment">#     z = []  # inference output</span>
    <span class="token comment">#     for i in range(self.nl):</span>
    <span class="token comment">#         x[i] = self.m[i](x[i])  # conv</span>
    <span class="token comment">#         bs, _, ny, nx = x[i].shape  # x(bs,255,20,20) to x(bs,3,20,20,85)</span>
    <span class="token comment">#         x[i] = x[i].view(bs, self.na, self.no, ny, nx).permute(0, 1, 3, 4, 2).contiguous()</span>
    <span class="token comment">#</span>
    <span class="token comment">#         if not self.training:  # inference</span>
    <span class="token comment">#             if self.grid[i].shape[2:4] != x[i].shape[2:4] or self.onnx_dynamic:</span>
    <span class="token comment">#                 self.grid[i] = self._make_grid(nx, ny).to(x[i].device)</span>
    <span class="token comment">#</span>
    <span class="token comment">#             y = x[i].sigmoid()</span>
    <span class="token comment">#             if self.inplace:</span>
    <span class="token comment">#                 y[..., 0:2] = (y[..., 0:2] * 2. - 0.5 + self.grid[i]) * self.stride[i]  # xy</span>
    <span class="token comment">#                 y[..., 2:4] = (y[..., 2:4] * 2) ** 2 * self.anchor_grid[i]  # wh</span>
    <span class="token comment">#             else:  # for YOLOv5 on AWS Inferentia https://github.com/ultralytics/yolov5/pull/2953</span>
    <span class="token comment">#                 xy = (y[..., 0:2] * 2. - 0.5 + self.grid[i]) * self.stride[i]  # xy</span>
    <span class="token comment">#                 wh = (y[..., 2:4] * 2) ** 2 * self.anchor_grid[i].view(1, self.na, 1, 1, 2)  # wh</span>
    <span class="token comment">#                 y = torch.cat((xy, wh, y[..., 4:]), -1)</span>
    <span class="token comment">#             z.append(y.view(bs, -1, self.no))</span>
    <span class="token comment">#</span>
    <span class="token comment">#     return x if self.training else (torch.cat(z, 1), x)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        z <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># inference output</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
            x<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>m<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># conv</span>

        <span class="token keyword">return</span> x
</code></pre> </li><li> <p>修改<code>export.py</code>函数的<code>--opset</code>为12</p> </li><li> <p>运行<code>export.py</code></p> </li><li> <p>简化模型</p> <pre><code class="prism language-python">python <span class="token operator">-</span>m onnxsim weights<span class="token operator">/</span>yolov5s<span class="token punctuation">.</span>onnx weights<span class="token operator">/</span>yolov5s<span class="token operator">-</span>sim<span class="token punctuation">.</span>onnx
</code></pre> </li></ul> 
<h4><a id="52onnxrknnPC_241"></a>5.2onnx转rknn并在PC上仿真测试</h4> 
<p>与<a href="#4.%E6%B5%8B%E8%AF%95rk%E5%AE%98%E6%96%B9%E6%8F%90%E4%BE%9B%E7%9A%84yolov5s.onnx" rel="nofollow">第四节</a>转换步骤相同，重新复制yolov5文件夹为myolov5，放入5.1节得到的yolov5s-sim模型，重命名为yolov5s.onnx，再运行<code>test.py</code>，推理结果如下：</p> 
<p><img src="https://images2.imgbox.com/99/9c/P9bsYvny_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_248"></a>六.转换自训练模型并测试推理</h3> 
<p>作者用自己的数据集训练了一个简单的模型用来测试，模型的类别数为4。</p> 
<h4><a id="61ptonnx_252"></a>6.1pt转onnx</h4> 
<p>此转换步骤与<a href="#5.1pt%E8%BD%AConnx" rel="nofollow">5.1节</a>转换步骤相同。</p> 
<h4><a id="62onnxrknnPC_256"></a>6.2onnx转rknn并在PC上仿真测试</h4> 
<p>修改<code>examples/onnx/myolov5/test.py</code>文件</p> 
<ul><li>修改onnx路径</li><li>修改rknn保存路径</li><li>修改img测试图片路径</li><li>修改类别数</li></ul> 
<p><img src="https://images2.imgbox.com/7e/10/S2bvP8hz_o.png" alt="在这里插入图片描述"><br> 修改完成后运行脚本，获得推理坐标值和rknn模型文件，推理结果如下：<br> <img src="https://images2.imgbox.com/df/cb/9lmjq72v_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="rk_269"></a>七.rk官方提供模型板端推理</h3> 
<p>运行前准备：</p> 
<ul><li> <p>确保PC上已配置交叉编译工具链</p> </li><li> <p>开发板刷入Linux系统，本次刷入builtroot系统测试</p> </li></ul> 
<p>进入<code>/NPU/rknpu2/examples/rknn_yolov5_demo_v5/convert_rknn_demo</code>复制一份重命名为<code>yolov5_3568</code>，进入目录，修改<code>onnx2rknn.py</code>，运行脚本，将onnx转为rknn；</p> 
<p>进入<code>rockchip/NPU/rknpu2/examples/rknn_yolov5_demo</code>目录，运行脚本编译程序：</p> 
<pre><code class="prism language-shell"><span class="token function">bash</span> ./build-linux_RK356X.sh
</code></pre> 
<p>编译成功会生成一个<code>install/和build/</code>文件夹，</p> 
<p><img src="https://images2.imgbox.com/0f/2c/PIrditTM_o.png" alt="在这里插入图片描述"></p> 
<p>将<code>install</code>文件夹下的文件全部复制到开发板中，进入开发板中运行程序测试推理：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@RK356X:/mnt/rknn_yolov5_demo_Linux<span class="token punctuation">]</span><span class="token comment"># ./rknn_yolov5_demo ./model/RK356X/yolov5s-640-640.rknn ./model/bus.jpg</span>
post process config: box_conf_threshold <span class="token operator">=</span> <span class="token number">0.25</span>, nms_threshold <span class="token operator">=</span> <span class="token number">0.45</span>
Read ./model/bus.jpg <span class="token punctuation">..</span>.
img width <span class="token operator">=</span> <span class="token number">640</span>, img height <span class="token operator">=</span> <span class="token number">640</span>
Loading mode<span class="token punctuation">..</span>.
sdk version: <span class="token number">1.4</span>.0 <span class="token punctuation">(</span>a10f100eb@2022-09-09T09:07:14<span class="token punctuation">)</span> driver version: <span class="token number">0.4</span>.2
model input num: <span class="token number">1</span>, output num: <span class="token number">3</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span>images, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">640</span>, <span class="token number">640</span>, <span class="token number">3</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">1228800</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">1228800</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NHWC, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span>-128, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.003922</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token number">334</span>, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">255</span>, <span class="token number">80</span>, <span class="token number">80</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">1632000</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">1632000</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NCHW, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span><span class="token number">77</span>, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.080445</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token number">353</span>, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">255</span>, <span class="token number">40</span>, <span class="token number">40</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">408000</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">408000</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NCHW, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span><span class="token number">56</span>, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.080794</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token number">372</span>, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">255</span>, <span class="token number">20</span>, <span class="token number">20</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">102000</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">102000</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NCHW, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span><span class="token number">69</span>, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.081305</span>
model is NHWC input <span class="token function">fmt</span>
model input <span class="token assign-left variable">height</span><span class="token operator">=</span><span class="token number">640</span>, <span class="token assign-left variable">width</span><span class="token operator">=</span><span class="token number">640</span>, <span class="token assign-left variable">channel</span><span class="token operator">=</span><span class="token number">3</span>
once run use <span class="token number">61.952000</span> ms
loadLabelName ./model/coco_80_labels_list.txt
person @ <span class="token punctuation">(</span><span class="token number">114</span> <span class="token number">235</span> <span class="token number">212</span> <span class="token number">527</span><span class="token punctuation">)</span> <span class="token number">0.819099</span>
person @ <span class="token punctuation">(</span><span class="token number">210</span> <span class="token number">242</span> <span class="token number">284</span> <span class="token number">509</span><span class="token punctuation">)</span> <span class="token number">0.814970</span>
person @ <span class="token punctuation">(</span><span class="token number">479</span> <span class="token number">235</span> <span class="token number">561</span> <span class="token number">520</span><span class="token punctuation">)</span> <span class="token number">0.790311</span>
bus @ <span class="token punctuation">(</span><span class="token number">99</span> <span class="token number">141</span> <span class="token number">557</span> <span class="token number">445</span><span class="token punctuation">)</span> <span class="token number">0.693320</span>
person @ <span class="token punctuation">(</span><span class="token number">78</span> <span class="token number">338</span> <span class="token number">122</span> <span class="token number">520</span><span class="token punctuation">)</span> <span class="token number">0.404960</span>
loop count <span class="token operator">=</span> <span class="token number">10</span> , average run  <span class="token number">60.485800</span> ms
</code></pre> 
<p>推理结果如下：<br> <img src="https://images2.imgbox.com/b1/87/27n65N5K_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="yolov5sPytorch_322"></a>八.yolov5s-Pytorch模型板端推理</h3> 
<p>进入<code>rockchip/NPU/rknpu2/examples/rknn_yolov5_demo_v5/convert_rknn_demo/yolov5</code>目录，修改<code>onnx2rknn.py</code>：<br> <img src="https://images2.imgbox.com/f0/f8/NkPb5aao_o.png" alt="在这里插入图片描述"></p> 
<p>运行<code>onnx2rknn.py</code>：</p> 
<p><img src="https://images2.imgbox.com/96/fc/3xKAyS5f_o.png" alt="在这里插入图片描述"></p> 
<p>复制model到<code>rockchip/NPU/rknpu2/examples/rknn_yolov5_demo_v5/model/RK356X</code>中，运行<code>build-linux_RK356X.sh</code>，编译成功会生成一个<code>install/和build/</code>文件夹，<br> <img src="https://images2.imgbox.com/1e/bb/BKl5gpkN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c0/8c/SeWzzZCT_o.png" alt="在这里插入图片描述"></p> 
<p>通过SD卡等方式将install文件夹整个复制到开发板的<code>/mnt</code>目录，赋予<code>rknn_yolov5_demo</code>可执行权限，运行程序获取推理结果：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@RK356X:/mnt/rknn_yolov5_demo_Linux<span class="token punctuation">]</span><span class="token comment"># ./rknn_yolov5_demo ./model/RK356X/yolov5s-640-640.rknn ./model/bus.jpg</span>
post process config: box_conf_threshold <span class="token operator">=</span> <span class="token number">0.25</span>, nms_threshold <span class="token operator">=</span> <span class="token number">0.45</span>
Read ./model/bus.jpg <span class="token punctuation">..</span>.
img width <span class="token operator">=</span> <span class="token number">640</span>, img height <span class="token operator">=</span> <span class="token number">640</span>
Loading mode<span class="token punctuation">..</span>.
sdk version: <span class="token number">1.4</span>.0 <span class="token punctuation">(</span>a10f100eb@2022-09-09T09:07:14<span class="token punctuation">)</span> driver version: <span class="token number">0.4</span>.2
model input num: <span class="token number">1</span>, output num: <span class="token number">3</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span>images, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">640</span>, <span class="token number">640</span>, <span class="token number">3</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">1228800</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">1228800</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NHWC, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span>-128, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.003922</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token number">334</span>, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">255</span>, <span class="token number">80</span>, <span class="token number">80</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">1632000</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">1632000</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NCHW, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span><span class="token number">77</span>, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.080445</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token number">353</span>, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">255</span>, <span class="token number">40</span>, <span class="token number">40</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">408000</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">408000</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NCHW, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span><span class="token number">56</span>, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.080794</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token number">372</span>, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">255</span>, <span class="token number">20</span>, <span class="token number">20</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">102000</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">102000</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NCHW, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span><span class="token number">69</span>, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.081305</span>
model is NHWC input <span class="token function">fmt</span>
model input <span class="token assign-left variable">height</span><span class="token operator">=</span><span class="token number">640</span>, <span class="token assign-left variable">width</span><span class="token operator">=</span><span class="token number">640</span>, <span class="token assign-left variable">channel</span><span class="token operator">=</span><span class="token number">3</span>
once run use <span class="token number">62.407000</span> ms
loadLabelName ./model/coco_80_labels_list.txt
person @ <span class="token punctuation">(</span><span class="token number">114</span> <span class="token number">235</span> <span class="token number">212</span> <span class="token number">527</span><span class="token punctuation">)</span> <span class="token number">0.819099</span>
person @ <span class="token punctuation">(</span><span class="token number">210</span> <span class="token number">242</span> <span class="token number">284</span> <span class="token number">509</span><span class="token punctuation">)</span> <span class="token number">0.814970</span>
person @ <span class="token punctuation">(</span><span class="token number">479</span> <span class="token number">235</span> <span class="token number">561</span> <span class="token number">520</span><span class="token punctuation">)</span> <span class="token number">0.790311</span>
bus @ <span class="token punctuation">(</span><span class="token number">99</span> <span class="token number">141</span> <span class="token number">557</span> <span class="token number">445</span><span class="token punctuation">)</span> <span class="token number">0.693320</span>
person @ <span class="token punctuation">(</span><span class="token number">78</span> <span class="token number">338</span> <span class="token number">122</span> <span class="token number">520</span><span class="token punctuation">)</span> <span class="token number">0.404960</span>
loop count <span class="token operator">=</span> <span class="token number">10</span> , average run  <span class="token number">77.491700</span> ms

</code></pre> 
<p>图像推理结果：<br> <img src="https://images2.imgbox.com/56/fe/hPW5WOBZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_367"></a>九.用自己数据集训练的模型板端推理</h3> 
<ol><li>进入<code>rockchip/NPU/rknpu2/examples/rknn_yolov5_demo_v5/convert_rknn_demo/yolov5</code>目录，修改<code>onnx2rknn.py</code>：<br> <img src="https://images2.imgbox.com/f4/4c/L0BiH4Zj_o.png" alt="在这里插入图片描述"></li></ol> 
<p><img src="https://images2.imgbox.com/ca/03/TkOEpK1s_o.png" alt="在这里插入图片描述"></p> 
<ol start="2"><li>修改<code>dataset.txt</code>：</li></ol> 
<p><img src="https://images2.imgbox.com/0e/77/U5Zp5eWR_o.png" alt="在这里插入图片描述"></p> 
<ol start="3"><li> <p>运行<code>onnx2rknn.py</code>：<br> <img src="https://images2.imgbox.com/2a/a8/oE5d8HhQ_o.png" alt="在这里插入图片描述"></p> </li><li> <p>复制rknn模型到<code>rockchip/NPU/rknpu2/examples/rknn_yolov5_demo_c4/model/RK356X</code></p> </li><li> <p>进入<code> rockchip/NPU/rknpu2/examples/rknn_yolov5_demo_c4/model</code>目录，修改<code>coco_80_labels_list.txt</code>：<br> <img src="https://images2.imgbox.com/a5/c1/yF4VJEQ1_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<p>6.修改<code>rockchip/NPU/rknpu2/examples/rknn_yolov5_demo_c4/include/postprocess.h</code>，修改类别数和置信度阈值：</p> 
<p><img src="https://images2.imgbox.com/35/76/m5Qsp22U_o.png" alt="在这里插入图片描述"></p> 
<p>7.运行<code>build-linux_RK356X.sh</code>，编译成功会生成一个<code>install/和build/</code>文件夹：</p> 
<p><img src="https://images2.imgbox.com/5e/13/2l4NZIKL_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/32/f4/gWjW2zRa_o.png" alt="在这里插入图片描述"></p> 
<p>8.通过SD卡等方式将install文件夹整个复制到开发板的<code>/mnt</code>目录，赋予<code>rknn_yolov5_demo</code>可执行权限，运行程序获取推理结果：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@RK356X:/mnt/rknn_yolov5_demo_Linux_c4<span class="token punctuation">]</span><span class="token comment"># chmod a+x rknn_yolov5_demo</span>
<span class="token punctuation">[</span>root@RK356X:/mnt/rknn_yolov5_demo_Linux_c4<span class="token punctuation">]</span><span class="token comment"># ./rknn_yolov5_demo ./model/RK356X/best-sim.rknn ./model/per_car.jpg</span>
post process config: box_conf_threshold <span class="token operator">=</span> <span class="token number">0.25</span>, nms_threshold <span class="token operator">=</span> <span class="token number">0.25</span>
Read ./model/per_car.jpg <span class="token punctuation">..</span>.
img width <span class="token operator">=</span> <span class="token number">640</span>, img height <span class="token operator">=</span> <span class="token number">640</span>
Loading mode<span class="token punctuation">..</span>.
sdk version: <span class="token number">1.4</span>.0 <span class="token punctuation">(</span>a10f100eb@2022-09-09T09:07:14<span class="token punctuation">)</span> driver version: <span class="token number">0.4</span>.2
model input num: <span class="token number">1</span>, output num: <span class="token number">3</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span>images, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">640</span>, <span class="token number">640</span>, <span class="token number">3</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">1228800</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">1228800</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NHWC, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span>-128, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.003922</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span>output, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">27</span>, <span class="token number">80</span>, <span class="token number">80</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">172800</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">172800</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NCHW, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span><span class="token number">64</span>, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.122568</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token number">320</span>, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">27</span>, <span class="token number">40</span>, <span class="token number">40</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">43200</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">43200</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NCHW, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span><span class="token number">38</span>, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.110903</span>
  <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token number">321</span>, <span class="token assign-left variable">n_dims</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dims</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span>, <span class="token number">27</span>, <span class="token number">20</span>, <span class="token number">20</span><span class="token punctuation">]</span>, <span class="token assign-left variable">n_elems</span><span class="token operator">=</span><span class="token number">10800</span>, <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">10800</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>NCHW, <span class="token assign-left variable">type</span><span class="token operator">=</span>INT8, <span class="token assign-left variable">qnt_type</span><span class="token operator">=</span>AFFINE, <span class="token assign-left variable">zp</span><span class="token operator">=</span><span class="token number">36</span>, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.099831</span>
model is NHWC input <span class="token function">fmt</span>
model input <span class="token assign-left variable">height</span><span class="token operator">=</span><span class="token number">640</span>, <span class="token assign-left variable">width</span><span class="token operator">=</span><span class="token number">640</span>, <span class="token assign-left variable">channel</span><span class="token operator">=</span><span class="token number">3</span>
once run use <span class="token number">86.341000</span> ms
loadLabelName ./model/coco_80_labels_list.txt
person @ <span class="token punctuation">(</span><span class="token number">61</span> <span class="token number">190</span> <span class="token number">284</span> <span class="token number">520</span><span class="token punctuation">)</span> <span class="token number">0.907933</span>
car @ <span class="token punctuation">(</span><span class="token number">381</span> <span class="token number">370</span> <span class="token number">604</span> <span class="token number">446</span><span class="token punctuation">)</span> <span class="token number">0.897453</span>
car @ <span class="token punctuation">(</span><span class="token number">343</span> <span class="token number">366</span> <span class="token number">412</span> <span class="token number">394</span><span class="token punctuation">)</span> <span class="token number">0.873785</span>
car @ <span class="token punctuation">(</span><span class="token number">404</span> <span class="token number">367</span> <span class="token number">429</span> <span class="token number">388</span><span class="token punctuation">)</span> <span class="token number">0.628984</span>
car @ <span class="token punctuation">(</span><span class="token number">425</span> <span class="token number">361</span> <span class="token number">494</span> <span class="token number">388</span><span class="token punctuation">)</span> <span class="token number">0.365345</span>
loop count <span class="token operator">=</span> <span class="token number">10</span> , average run  <span class="token number">96.655700</span> ms
</code></pre> 
<p>推理效果如下：<br> <img src="https://images2.imgbox.com/1e/e6/hbWr8DFG_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_435"></a>十.用自己数据集训练的模型板端实时视频推理</h3> 
<h4><a id="101__437"></a>10.1 视频输入输出调试</h4> 
<p>此步骤原本想采用rockit框架去进行视频采集到输出和Qt获取图像的方式，此框架API对于有海思平台开发经验的人来说容易上手，但在调试时发现对于3588平台可以使用rockit采集到输出，在3568平台一直卡在打开摄像头这一步，如果你使用的是RK3588/RK3588S可以使用rockit框架完成原始视频数据的采集，作者最终使用了opencv去获取摄像头图像并送显。</p> 
<h4><a id="102Qt_441"></a>10.2测试Qt框架采集图像</h4> 
<p>使用Qt框架采集图像需依赖于opencv，可以参考网上的博客完成opencv的交叉编译。</p> 
<p>QImages经过opencv转为Mat，Mat送入RKNN进行推理并画框，Mat再转为QImages到QPixmap输出显示。</p> 
<p>集成Qt的视频采集显示程序以及官方yolo检测程序，经调试程序已实现yolov5实时识别，完整工程代码已在Github开源，<a href="https://github.com/PkkaiP/work_rk_yolov5.git">代码路径</a>。<br> 效果如下：<br> <img src="https://images2.imgbox.com/b7/d3/Wvylq5NN_o.gif" alt="在这里插入图片描述"></p> 
<h2><a id="PSRKCPU_GPU_NPU_DDR_452"></a>PS：RK平台CPU GPU NPU DDR定频和性能模式设置方法</h2> 
<p>要想发挥芯片的最大性能，可以进行如下操作对CPU、NPU等硬件进行调频。</p> 
<p>查看NPU可设置频率：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@RK356X:/<span class="token punctuation">]</span><span class="token comment"># cat /sys/class/devfreq/fde40000.npu/available_frequencies</span>
<span class="token number">200000000</span> <span class="token number">297000000</span> <span class="token number">400000000</span> <span class="token number">600000000</span> <span class="token number">700000000</span> <span class="token number">800000000</span> <span class="token number">900000000</span>
</code></pre> 
<p>查看NPU当前频率：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@RK356X:/<span class="token punctuation">]</span><span class="token comment"># cat /sys/class/devfreq/fde40000.npu/cur_freq</span>
<span class="token number">600000000</span>
</code></pre> 
<p>设置NPU频率：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@RK356X:/<span class="token punctuation">]</span><span class="token comment"># echo 900000000 &gt; /sys/class/devfreq/fde40000.npu/userspace/set_freq</span>
<span class="token punctuation">[</span>root@RK356X:/<span class="token punctuation">]</span><span class="token comment"># cat /sys/class/devfreq/fde40000.npu/cur_freq</span>
<span class="token number">900000000</span>
</code></pre> 
<p>再次运行rknn推理单张图片耗时减少10ms，若要发挥最大性能，将CPU、DDR、GPU频率均设置为最高频率。测试速度在rk3568上最快为70ms。</p> 
<p>另一个提速方式，将silu改为relu，根据网上测试表现单张图片可达到40ms，有兴趣的小伙伴可以尝试。</p> 
<p>参考网址：https://www.yii666.com/blog/354522.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e569b3a146e7c4ee69b1b8605eac12ed/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据结构：栈和队列</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6e734edc2ff2cfa2e39436e38758506d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Qt实现图书管理系统(C&#43;&#43;)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>