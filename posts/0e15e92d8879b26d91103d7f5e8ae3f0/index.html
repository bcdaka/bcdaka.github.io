<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>数据分析：微生物数据的荟萃分析框架 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/0e15e92d8879b26d91103d7f5e8ae3f0/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="数据分析：微生物数据的荟萃分析框架">
  <meta property="og:description" content="介绍 Meta-analysis of fecal metagenomes reveals global microbial signatures that are specific for colorectal cancer提供了一种荟萃分析的框架，它主要基于常用的Wilcoxon rank-sum test和Blocked Wilcoxon rank-sum test 方法计算显著性，再使用分位数计算分组间的倍数变化，最后通过AUC判断物种的区分分组的能力。最后通过热图和森林图展示筛选到的在不同研究和荟萃分析均有差异的物种。
该框架可用于同类型的微生物荟萃分析。
加载R包 #| warning: false #| message: false library(tidyverse) library(readr) library(coin) library(pROC) library(RColorBrewer) library(cowplot) # rm(list = ls()) options(stringsAsFactors = F) options(future.globals.maxSize = 1000 * 1024^2) 导入数据 数据下载百度云盘链接: https://pan.baidu.com/s/1VS6S8p5s20vwZ6FyILYoaQ
提取码: g4y3
物种表达谱数据
样本分组信息
#| warning: false #| message: false feat.all &lt;- read.table(&#34;./data/meta-CRC-2019/feat_rel_crc.tsv&#34;, sep=&#39;\t&#39;, header=TRUE, stringsAsFactors = FALSE, check.names = FALSE, quote=&#39;&#39;) %&gt;% as.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-23T15:42:32+08:00">
    <meta property="article:modified_time" content="2024-07-23T15:42:32+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">数据分析：微生物数据的荟萃分析框架</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>介绍</h3> 
<p><strong>Meta-analysis of fecal metagenomes reveals global microbial signatures that are specific for colorectal cancer</strong>提供了一种荟萃分析的框架，它主要基于常用的<em>Wilcoxon rank-sum test</em>和Blocked Wilcoxon rank-sum test 方法计算显著性，再使用分位数计算分组间的倍数变化，最后通过AUC判断物种的区分分组的能力。最后通过热图和森林图展示筛选到的在不同研究和荟萃分析均有差异的物种。</p> 
<p>该框架可用于同类型的微生物荟萃分析。</p> 
<p><img src="https://images2.imgbox.com/4e/a5/drJl1Ann_o.png" alt=""></p> 
<h3><a id="R_9"></a>加载R包</h3> 
<pre><code class="prism language-{r}">#| warning: false
#| message: false

library(tidyverse)
library(readr)
library(coin)
library(pROC)
library(RColorBrewer)
library(cowplot)

# rm(list = ls())
options(stringsAsFactors = F)
options(future.globals.maxSize = 1000 * 1024^2)
</code></pre> 
<h3><a id="_28"></a>导入数据</h3> 
<p>数据下载百度云盘链接: https://pan.baidu.com/s/1VS6S8p5s20vwZ6FyILYoaQ</p> 
<p>提取码: g4y3</p> 
<ul><li> <p>物种表达谱数据</p> </li><li> <p>样本分组信息</p> </li></ul> 
<pre><code class="prism language-{r}">#| warning: false
#| message: false

feat.all &lt;- read.table("./data/meta-CRC-2019/feat_rel_crc.tsv", 
                       sep='\t', header=TRUE, 
                       stringsAsFactors = FALSE, 
                       check.names = FALSE, quote='') %&gt;%
  as.matrix()

meta &lt;- read_tsv('./data/meta-CRC-2019/meta_crc.tsv', show_col_types = FALSE)
</code></pre> 
<ul><li>其他参数（过滤和检验结果）</li></ul> 
<pre><code class="prism language-{r}">#| warning: false
#| message: false

alpha.meta &lt;- 1e-05
alpha.single.study &lt;- 0.005
mult.corr &lt;- 'fdr'
pr.cutoff &lt;- 0.05
log.n0 &lt;- 1e-05
log.n0.func &lt;- 1e-08
study.cols &lt;- c('#2FBFBF', '#177254', '#F2CC30', '#74B347', '#8265CC')
</code></pre> 
<h3><a id="_67"></a>数据预处理</h3> 
<ul><li> <p>提出研究名称<code>studies</code></p> </li><li> <p>设置<code>block</code>分组，用于后续检验</p> </li></ul> 
<pre><code class="prism language-{r}">#| warning: false
#| message: false

studies &lt;- meta %&gt;% 
  dplyr::pull(Study) %&gt;% 
  unique

# block for colonoscopy and study as well
meta &lt;- meta %&gt;%
  dplyr::filter(!is.na(Sampling_rel_to_colonoscopy)) %&gt;%
  dplyr::mutate(block = ifelse(Study != 'CN-CRC', Study, 
        paste0(Study, '_', Sampling_rel_to_colonoscopy)))

feat.all &lt;- feat.all[, meta$Sample_ID]
</code></pre> 
<h3><a id="_90"></a>荟萃分析</h3> 
<p>荟萃分析采用了<em>Wilcoxon rank-sum test</em>和Blocked Wilcoxon rank-sum test 两种方法对单个研究和合并所有研究做显著性检验。本次需要计<code>Foldchange(FC)</code>，<code>单个研究的pvalue + 所有研究的pvalue(p.val)</code>和<code>单个研究和所有研究的AUC(aucs)</code>，以下是该代码的计算过程：</p> 
<ul><li> <p>先使用<strong>Wilcoxon rank-sum test</strong>计算每个研究的每个物种在case/control之间的显著性检验结果；</p> </li><li> <p>再通过<strong>roc</strong>函数计算每个研究的每个物种在case/control之间的判别效果；</p> </li><li> <p>接着通过分位数<strong>quantile</strong>计算每个研究的每个物种在case/control之间的倍数变化；</p> </li><li> <p>然后通过<strong>Blocked Wilcoxon rank-sum test</strong>计算所有研究的荟萃差异检验结果；</p> </li><li> <p>最后计算所有研究的平均倍数变化作为整体倍数变化和通过<strong>roc</strong>函数计算每个物种在case/control之间的判别效果。</p> </li></ul> 
<pre><code class="prism language-{r}">#| warning: false
#| message: false

p.val &lt;- matrix(NA, nrow = nrow(feat.all), ncol = length(studies)+1, 
                dimnames = list(row.names(feat.all), c(studies, 'all')))
fc &lt;- p.val
aucs.mat &lt;- p.val
aucs.all &lt;- vector('list', nrow(feat.all))

cat("Calculating effect size for every feature...\n")
pb &lt;- txtProgressBar(max = nrow(feat.all), style = 3)

# caluclate wilcoxon test and effect size for each feature and study
for (f in row.names(feat.all)) {
  
  # for each study
  for (s in studies) {
    
    x &lt;- feat.all[f, meta %&gt;% dplyr::filter(Study == s) %&gt;% 
                    dplyr::filter(Group=='CRC') %&gt;% dplyr::pull(Sample_ID)]
    y &lt;- feat.all[f, meta %&gt;% dplyr::filter(Study==s) %&gt;% 
                    dplyr::filter(Group=='CTR') %&gt;% dplyr::pull(Sample_ID)]
    
    # Wilcoxon: 对单个研究的单个物种检验
    p.val[f, s] &lt;- wilcox.test(x, y, exact=FALSE)$p.value
    
    # AUC：评估每个物种区分分组的能力
    aucs.all[[f]][[s]] &lt;- c(roc(controls=y, cases=x, 
                                direction='&lt;', ci=TRUE, auc=TRUE)$ci)
    aucs.mat[f, s] &lt;- c(roc(controls=y, cases=x, 
                           direction='&lt;', ci=TRUE, auc=TRUE)$ci)[2]
    
    # FC：使用10分位数计算每个物种的相对丰度再计算Foldchange结果
    q.p &lt;- quantile(log10(x+log.n0), probs = seq(.1, .9, .05))
    q.n &lt;- quantile(log10(y+log.n0), probs = seq(.1, .9, .05))
    fc[f, s] &lt;- sum(q.p - q.n)/length(q.p)
  }
  
  # calculate effect size for all studies combined
  # Wilcoxon + blocking factor：计算所有研究混合在一起的检验结果
  d &lt;- data.frame(y = feat.all[f,], 
                  x = meta$Group, 
                  block = meta$block) %&gt;%
    dplyr::mutate(x = factor(x),
                  block = factor(block))
  p.val[f, 'all'] &lt;- coin::pvalue(wilcox_test(y ~ x | block, data = d))
  # other metrics
  x &lt;- feat.all[f, meta %&gt;% dplyr::filter(Group=='CRC') %&gt;% dplyr::pull(Sample_ID)]
  y &lt;- feat.all[f, meta %&gt;% dplyr::filter(Group=='CTR') %&gt;% dplyr::pull(Sample_ID)]
  # FC: 取所有样本的平均FC结果
  fc[f, 'all'] &lt;- mean(fc[f, studies])
  # AUC：合并数据集每个物种区分不同分组样本的能力
  aucs.mat[f, 'all'] &lt;- c(roc(controls=y, cases=x, 
                             direction='&lt;', ci=TRUE, auc=TRUE)$ci)[2]
  
  # progressbar
  setTxtProgressBar(pb, (pb$getVal()+1))
}
cat('\n')

# multiple hypothesis correction
p.adj &lt;- data.frame(apply(p.val, MARGIN=2, FUN=p.adjust, method=mult.corr),
                    check.names = FALSE)
</code></pre> 
<h3><a id="_172"></a>查看结果</h3> 
<p>查看上述荟萃分析的结果</p> 
<pre><code class="prism language-{r}">#| warning: false
#| message: false

head(p.adj)

head(aucs.mat)

head(fc)
</code></pre> 
<p><img src="https://images2.imgbox.com/24/ca/cxDnXCwi_o.png" alt=""></p> 
<h3><a id="_189"></a>画图</h3> 
<p>文章给出的图分成两部分，上部分是热图形式，下半部是森林图。</p> 
<ul><li>热图: 展示不同研究显著差异的物种</li></ul> 
<pre><code class="prism language-{r}">#| warning: false
#| message: false

species.heatmap &lt;- rownames(p.adj)[which(p.adj$all &lt; alpha.single.study)]

fc.sign &lt;- sign(fc)
fc.sign[fc.sign == 0] &lt;- 1

p.val.signed &lt;- -log10(p.adj[species.heatmap,"all", drop=FALSE]) * 
  fc.sign[species.heatmap, 'all']

top.markers &lt;- rownames(p.val.signed[is.infinite(p.val.signed$all) , , drop=FALSE])
p.val.signed[top.markers, 'all'] &lt;- 100 + aucs.mat[top.markers, 'all']

species.heatmap.orderd &lt;- rownames(p.val.signed[order(p.val.signed$all), , drop=FALSE])

# take only those
fc.mat.plot &lt;- fc[species.heatmap.orderd, ] %&gt;% as.data.frame()
p.vals.plot &lt;- p.adj[species.heatmap.orderd, ]

# ##############################################################################
# prepare plotting

# colorscheme for fc heatmap 
mx &lt;- max(abs(range(fc.mat.plot, na.rm=TRUE)))
mx &lt;- ifelse(round(mx, digits = 1) &lt; mx, 
             round(mx, digits = 1) + 0.1, 
             round(mx, digits = 1))
brs &lt;- seq(-mx, mx, by=0.05)
num.col.steps &lt;- length(brs) - 1
n &lt;- floor(0.45*num.col.steps)
col.hm &lt;- c(rev(colorRampPalette(brewer.pal(9, 'Blues'))(n)),
           rep('#FFFFFF', num.col.steps-2*n),
           colorRampPalette(brewer.pal(9, 'Reds'))(n))
# color scheme for pval heatmap
alpha.breaks &lt;- c(1e-06, 1e-05, 1e-04, 1e-03, 1e-02, 1e-01)
p.vals.bin &lt;- data.frame(apply(p.vals.plot, 2, FUN=.bincode, 
                               breaks = c(0, alpha.breaks, 1), 
                               include.lowest = TRUE),
                         check.names = FALSE)
p.val.greys &lt;- c(paste0('grey', 
                         round(seq(from=10, to=80, 
                                   length.out = length(alpha.breaks)))), 
                  'white')
names(p.val.greys) &lt;- as.character(1:7)

# function to plot both into a grid
plot.single.study.heatmap &lt;- function(x) {
  
  # x = "FR-CRC"
  
  df.plot &lt;- tibble(species = factor(rownames(p.vals.plot), 
                                   levels = rev(rownames(p.vals.plot))),
                    p.vals = as.factor(p.vals.bin[[x]]),
                    fc = fc.mat.plot[[x]])
  
  g1 &lt;- df.plot %&gt;% 
    ggplot(aes(x = species, y = 1, fill = fc)) + 
      geom_tile() + theme_minimal() + 
      theme(axis.text = element_blank(),
            axis.ticks = element_blank(),
            axis.title = element_blank(), 
            panel.grid = element_blank(),
            panel.background = element_rect(fill=NULL, colour='black'),
            plot.margin = unit(c(0, 0, 0, 0), 'cm')) + 
      scale_y_continuous(expand = c(0, 0)) + 
      scale_fill_gradientn(colours=col.hm, limits=c(-mx, mx), guide=FALSE)
  
  g2 &lt;- df.plot %&gt;% 
    ggplot(aes(x=species, y=1, fill=p.vals)) +
      geom_tile() + theme_minimal() + 
      theme(axis.text = element_blank(),
            axis.ticks = element_blank(),
            axis.title = element_blank(), 
            panel.grid = element_blank(),
            panel.background = element_rect(fill=NULL, colour='black'),
            plot.margin = unit(c(0, 0, 0, 0), 'cm')) + 
      scale_y_continuous(expand = c(0, 0)) + 
      scale_fill_manual(values=p.val.greys, na.value='white', guide=FALSE)
  
  g.return &lt;- plot_grid(g2, g1, ncol = 1, rel_heights = c(0.25, 0.75))
  
  return(g.return)
}

# ##############################################################################
# plot

# p.value histogram
g1 &lt;- tibble(species = factor(rownames(p.vals.plot), 
                            levels = rev(rownames(p.vals.plot))),
             p.vals = -log10(p.vals.plot$all),
             colour = p.vals &gt; 5) %&gt;% 
  ggplot(aes(x = species, y = p.vals, fill = colour)) + 
    geom_bar(stat = 'identity') + 
    theme_classic() + 
    xlab('Gut microbial species') + 
    ylab('-log10(q-value)') + 
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          panel.background = element_rect(fill = NULL, color = 'black')) + 
    scale_y_continuous(limits = c(0, 15), expand = c(0, 0)) + 
    scale_x_discrete(position = 'top') + 
    scale_fill_manual(values = c('lightgrey', 'darkgrey'), guide = FALSE)

g.lst &lt;- lapply(studies, plot.single.study.heatmap)

pl1 &lt;- plot_grid(g1, g.lst[[1]], g.lst[[2]], 
          g.lst[[3]], g.lst[[4]],g.lst[[5]], 
          ncol = 1, align = 'v', 
          rel_heights = c(0.3, rep(0.12, 5)))

pl1
</code></pre> 
<p><img src="https://images2.imgbox.com/af/d2/9qzuFwjV_o.png" alt=""></p> 
<p><strong>结果</strong>：差异物种在不同研究和整合数据的倍数变化和显著性结果</p> 
<ul><li> <p>最上图是物种在<strong>整合数据</strong>的显著性结果（adjustedPvalue）;</p> </li><li> <p>接下来的热图是物种在<strong>单个研究</strong>的显著性结果（上半部）和倍数变化（下半部：红色是富集在CRC，蓝色是CTRL）;</p> </li><li> <p>森林图: 不同物种在每个研究区分case/control的能力 (通过alpha.meta更严格筛选)</p> </li></ul> 
<pre><code class="prism language-{r}">#| warning: false
#| message: false

# select and order
marker.set &lt;- rownames(p.val.signed)[
  abs(p.val.signed$all) &gt; -log10(alpha.meta)]
p.val.signed.red &lt;- p.val.signed[marker.set, ,drop=FALSE]
marker.set.orderd &lt;- rev(rownames(p.val.signed.red[order(p.val.signed.red$all),,
                                               drop=FALSE]))

# extract those from the auc list
df.plot &lt;- tibble()
for (i in marker.set.orderd){
  for (s in studies){
    temp &lt;- aucs.all[[i]][[s]]
    df.plot &lt;- bind_rows(df.plot, tibble(
      species=i, study=s,
      low=temp[1], auc=temp[2], high=temp[3]
    ))
  }
}

df.plot &lt;- df.plot %&gt;% 
  dplyr::mutate(species = factor(species, levels = marker.set.orderd)) %&gt;% 
  dplyr::mutate(study = factor(study, levels = studies))

# plot everything
pl2 &lt;- df.plot %&gt;% 
  ggplot(aes(x = study, y = auc)) + 
    geom_linerange(aes(ymin = low, ymax = high), color = 'lightgrey') + 
    geom_point(pch = 23, aes(fill = study)) + 
    facet_grid(~species, scales = 'free_x', space = 'free') + 
    theme_minimal() + 
    scale_y_continuous(limits=c(0, 1)) + 
    theme(panel.grid.major.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.x = element_blank(),
          strip.text = element_text(angle=90, hjust=0)) + 
    scale_fill_manual(values = study.cols, 
                      guide = FALSE) + 
    ylab('AUROC') + xlab('Gut microbial species')

pl2
</code></pre> 
<p><img src="https://images2.imgbox.com/32/1d/e3R2RUU2_o.png" alt=""></p> 
<ul><li>合并图: 最后文章呈现的图是经过修改的</li></ul> 
<pre><code class="prism language-{r}">#| warning: false
#| message: false

cowplot::plot_grid(pl1, pl2, ncol = 1)
</code></pre> 
<p><img src="https://images2.imgbox.com/d2/bb/PWdRB3zK_o.png" alt=""></p> 
<h3><a id="_384"></a>总结</h3> 
<p>在进行荟萃分析时，本研究采用了一种特定的统计方法——Blocked Wilcoxon rank-sum test，以评估和整合不同研究中的case/control物种的显著性结果。该方法特别适用于处理微生物数据这类稀疏性数据集，因为它能够在计算两组之间的倍数变化时有效避免零值过多的问题。通过使用分位数方法，研究者能够更准确地估计和比较不同组之间的差异，从而提高了分析结果的可靠性和有效性。</p> 
<p>对于类似类型的研究，研究者可以采用与本研究相似的分析框架进行荟萃分析。这包括以下几个关键步骤：</p> 
<ul><li>数据的收集与整理：确保收集到的数据是高质量的，并且适合进行荟萃分析。</li><li>选择合适的统计方法：根据数据的特点选择合适的统计检验方法，如Blocked Wilcoxon rank-sum test，以确保分析的准确性。</li><li>数据处理：对于稀疏数据，采用分位数方法来处理零值过多的问题，以提高分析的稳健性。</li><li>结果的整合与解释：将不同研究的结果进行整合，并采用适当的统计方法来评估整体的显著性。</li></ul> 
<p>通过遵循这样的框架，研究者可以对类似主题的研究进行系统性地分析和比较，从而为该领域的研究提供更深入的见解。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4e44683f47918219dd8a5129026d5a67/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu24.04 LTS配置java&#43;maven&#43;tomcat</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1c5ddc3bddee58216bd2b60aa03907ae/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">高效工作流：用Mermaid绘制你的专属流程图；如何在Vue3中导入mermaid绘制流程图</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>