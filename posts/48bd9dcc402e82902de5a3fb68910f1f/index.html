<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>全文检索-ElasticSearch - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/48bd9dcc402e82902de5a3fb68910f1f/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="全文检索-ElasticSearch">
  <meta property="og:description" content="1.基本概念 1.Index索引 动词：相当于MySQL中的insert；
名词：相当于MySQL中的DataBase；
2.Type（类型） 在Index（索引）中，可以定义一个或多个类型
类似于MySQL中的Table;每一种类型的数据放在一起
3.Document(文档) 保存在某个索引(index)下，某种类型(Type) 的一个数据(Document),文档是JSON格式的，Document就像是MySQL 中的某个Table里面的内容 类似一行数据
4.倒排索引 2.Docker 安装ElasticSearch 2.1 拉取镜像 docker pull elasticsearch:7.4.2 docker pull kibana:7.4.2 2.2 创建实例 2.2.1 创建挂载目录 mkdir ./config mkdir ./data 记得授予权限
chmod -R 777 ./elasticsearch 2.2.2 使容器外任何地址都能够访问 elasticsearch echo &#34;http.host: 0.0.0.0&#34;&gt;&gt;./config/elasticsearch.yml elasticsearch.yml
http.host: 0.0.0.0 2.2.3 docker 启动 docker run --name elasticsearch -p 9200:9200 -p9300:9300 \ -e &#34;discovery.type=single-node&#34; \ -e ES_JAVA_OPTS=&#34;-Xms512m -Xmx1024m&#34; \ -v ./config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \ -v ./data:/usr/share/elasticsearch/data \ -v .">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-02T11:05:26+08:00">
    <meta property="article:modified_time" content="2024-06-02T11:05:26+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">全文检索-ElasticSearch</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><img alt="" height="1200" src="https://images2.imgbox.com/24/94/eslOEv8r_o.png" width="1200"><img alt="" height="421" src="https://images2.imgbox.com/7e/88/gvC08otb_o.png" width="1200"></p> 
<h2>1.基本概念</h2> 
<h3>1.Index索引</h3> 
<p>动词：相当于MySQL中的insert；</p> 
<p>名词：相当于MySQL中的DataBase；</p> 
<h3>2.Type（类型）</h3> 
<p>在Index（索引）中，可以定义一个或多个类型</p> 
<p>类似于MySQL中的Table;每一种类型的数据放在一起</p> 
<h3>3.Document(文档)</h3> 
<p>保存在某个索引(index)下，某种类型(Type) 的一个数据(Document),文档是JSON格式的，Document就像是MySQL 中的某个Table里面的内容 类似一行数据</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/e9/10/hdb6q3iy_o.png" width="1200"></p> 
<h3>4.倒排索引</h3> 
<p><img alt="" height="1143" src="https://images2.imgbox.com/43/6a/cgw9we1m_o.png" width="1200"></p> 
<h2>2.Docker 安装ElasticSearch</h2> 
<h3>2.1 拉取镜像</h3> 
<pre><code class="language-bash">docker pull elasticsearch:7.4.2</code></pre> 
<pre><code class="language-bash">docker pull kibana:7.4.2</code></pre> 
<h3>2.2 创建实例</h3> 
<h4>2.2.1 创建挂载目录</h4> 
<pre><code class="language-bash">mkdir  ./config</code></pre> 
<pre><code class="language-bash">mkdir ./data</code></pre> 
<p> 记得授予权限</p> 
<pre><code class="language-bash">chmod -R 777 ./elasticsearch</code></pre> 
<h4>2.2.2 使容器外任何地址都能够访问 elasticsearch</h4> 
<pre><code class="language-bash">echo "http.host: 0.0.0.0"&gt;&gt;./config/elasticsearch.yml</code></pre> 
<p>elasticsearch.yml</p> 
<pre><code class="language-XML">http.host: 0.0.0.0
</code></pre> 
<p></p> 
<h4>2.2.3 docker 启动</h4> 
<pre><code class="language-bash">docker run --name elasticsearch -p 9200:9200 -p9300:9300 \
-e "discovery.type=single-node" \
-e ES_JAVA_OPTS="-Xms512m -Xmx1024m" \
-v ./config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \
-v ./data:/usr/share/elasticsearch/data \
-v ./plugins:/usr/share/elasticsearch/plugins \
-d elasticsearch:7.4.2</code></pre> 
<p><img alt="" height="501" src="https://images2.imgbox.com/53/4a/Bjt4eM1f_o.png" width="625"></p> 
<h5>2.3 安装Kibana</h5> 
<pre><code class="language-bash">docker run --name kibana -e ELASTICSEARCH_HOSTS=http://192.168.232.209:9200 -p 5601:5601 \
-d kibana:7.4.2</code></pre> 
<p><img alt="" height="709" src="https://images2.imgbox.com/47/c5/OReMNfYS_o.png" width="1200"></p> 
<h2> 3.初步检索</h2> 
<h3>3.1 _cat </h3> 
<h4>查看节点信息</h4> 
<pre><code class="language-bash">http://192.168.232.209:9200/_cat/nodes</code></pre> 
<h4>查看elasticsearch的健康状态</h4> 
<pre><code class="language-bash">http://192.168.232.209:9200/_cat/health</code></pre> 
<h4>查看elasticsearch的主节点信息</h4> 
<pre><code class="language-bash">http://192.168.232.209:9200/_cat/master</code></pre> 
<h4>查看所有索引</h4> 
<pre><code class="language-bash">http://192.168.232.209:9200/_cat/indices</code></pre> 
<h3>3.2 索引一个文档（保存或修改一条记录）</h3> 
<p>保存一个数据，保存在那个索引的哪个类型下，指定用哪个唯一标识</p> 
<pre><code class="language-bash">http://192.168.232.209:9200/customer/external/1</code></pre> 
<p><img alt="" height="406" src="https://images2.imgbox.com/65/b9/lqSypqEK_o.png" width="1200"></p> 
<h3> 3.3 查询文档 </h3> 
<pre><code class="language-bash">http://192.168.232.209:9200/customer/external/1</code></pre> 
<h3>3.4 更新文档 </h3> 
<p><img alt="" height="1181" src="https://images2.imgbox.com/3f/bf/MqP3RwJj_o.png" width="1200"></p> 
<h4>3.4.1 _update</h4> 
<p>这个操作如果修改文档的值和原来一样，则不会更新版本。</p> 
<h4>3.4.2 </h4> 
<p><img alt="" height="575" src="https://images2.imgbox.com/e2/5f/k1JKwhbU_o.png" width="1200"></p> 
<h3>3.5 删除文档</h3> 
<p><img alt="" height="178" src="https://images2.imgbox.com/e0/ff/68C91Zp8_o.png" width="1200"></p> 
<h3>3.6 bulk 批量 API</h3> 
<p><img alt="" height="1175" src="https://images2.imgbox.com/5e/7e/oFZX6Zbm_o.png" width="1200"><img alt="" height="418" src="https://images2.imgbox.com/6c/1b/UHp4Zjc6_o.png" width="1200"></p> 
<h4>批量操作 </h4> 
<p>从这个网站复制</p> 
<pre><code class="language-bash">https://gitee.com/xlh_blog/common_content/blob/master/es%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE.json#</code></pre> 
<p>执行 /_bluk </p> 
<p><img alt="" height="126" src="https://images2.imgbox.com/4f/5f/Yxa0m5HJ_o.png" width="1200"></p> 
<h2> 4.进阶检索</h2> 
<h3>1.searchAPI</h3> 
<p>ES支持两种基本方式检索:</p> 
<ul><li>一个是通过使用REST request URI 发送搜索参数(uri + 检索参数)</li><li>另一个是通过使用REST request body 来发送它们 (uri + 请求体)</li></ul> 
<pre><code class="language-bash">GET /bank/_search?q=*&amp;sort=account_number:asc</code></pre> 
<p>q=* 查询所有</p> 
<p>sort 跟据 account_number 升序</p> 
<h3>2.QueryDSL</h3> 
<p><img alt="" height="275" src="https://images2.imgbox.com/52/f2/DEZglzxG_o.png" width="1200"></p> 
<p><img alt="" height="461" src="https://images2.imgbox.com/86/b2/uOLfmPxo_o.png" width="1200"></p> 
<pre><code class="language-bash">GET /bank/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "account_number":  "asc"
    },
    {
      "balance": "desc"
    }
  ]
}</code></pre> 
<h3>3.部分检索</h3> 
<pre><code class="language-bash">GET /bank/_search
{
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "account_number":  "desc"
    },
    {
      "balance": "desc"
    }
  ],
  "from": 0,
  "size": 20,
  "_source": ["balance","account_number"]
  
}</code></pre> 
<h3>4. match[匹配查询]</h3> 
<pre><code class="language-bash">GET /bank/_search
{
  "query": {
    "match": {
      "account_number": 20
    }
  }
  
}</code></pre> 
<pre><code class="language-bash">GET /bank/_search
{
  "query": {
    "match": {
      "address": "mill lane"
    }
  }
  
}</code></pre> 
<p>全文检索按照评分进行排序</p> 
<h3>5.match_phrase [短语匹配]</h3> 
<p>将需要匹配的值当成一个整体单词(不分词)进行检索</p> 
<pre><code class="language-bash">GET /bank/_search
{
  "query": {
    "match_phrase": {
      "address": "mill lane"
    }
  }
  
}</code></pre> 
<h3>6.multi_match [多字段匹配]</h3> 
<p>这是或，只要一个字段满足，就返回</p> 
<pre><code class="language-bash">
GET /bank/_search
{
  "query": {
    "multi_match": {
      "query": "mill",
      "fields": ["state","address"]
    }
  }
  
}</code></pre> 
<p>能够正常分词 </p> 
<pre><code class="language-bash">GET /bank/_search
{
  "query": {
    "multi_match": {
      "query": "mill Movico",
      "fields": ["city","address"]
    }
  }
  
}
</code></pre> 
<h3>7.bool复杂查询</h3> 
<p>bool用来做复杂查询：</p> 
<p>复合语句可以合并 任何 其他查询语句，包括复合语句，了解这一点是很重要的。这就意味着，复合语句之间可以相互嵌套，可以表达非常复杂的逻辑。</p> 
<h4>must: 必须达到must列举所有条件 也就是相当于 AND</h4> 
<h4>must_not: 且不满足里面的条件</h4> 
<h4>should: 不是or 就是匹配上面有加分项</h4> 
<pre><code class="language-bash">
GET /bank/_search
{
  
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "gender": "m"
          }
        },
        {
          "match": {
            "address": "Mill"
          }
        }
      ],
      "must_not": [
        {
          "match": {
            "age": 28 
          }
        }
      ],
      "should": [
        {
          "match": {
            "lastname": "v"
          }
        }
      ]
      
      
    }
  }
  
  
}</code></pre> 
<h3>8.filter [结果过滤]</h3> 
<p>并不是所有的查询都需要产生分数，特别是那些仅用于 "filtering" (过滤) 的文档。为了不计算分数Elasticsearch 会自动检查场景并且优化查询的执行。</p> 
<pre><code class="language-bash">GET /bank/_search
{
  
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "gender": "m"
          }
        },
        {
          "match": {
            "address": "Mill"
          }
        }
      ],
      "must_not": [
        {
          "match": {
            "age": 18 
          }
        }
      ],
      "should": [
        {
          "match": {
            "lastname": "Wallace"
          }
        }
      ],
      "filter": {
        "range": {
          "age": {
            "gte": 18,
            "lte": 20
          }
        }
      }
    }
  }
}</code></pre> 
<h3>9.term</h3> 
<p>和match一样。匹配某个属性的值。全文检索字段用match，其他非text 字段匹配用term</p> 
<p>不用全文检索的时候用term 比如数字 年龄</p> 
<pre><code class="language-bash">GET /bank/_search
{
"query": {
  "term": {
    "age": {
      "value": "28"
    }
  }
}
}</code></pre> 
<pre><code class="language-bash">GET /bank/_search
{
"query": {
  "match": {
    "email.keyword": "margueritewall@aquoavo.com"
  }
}
}</code></pre> 
<p>address.keyword 和 match_phrase 区别：</p> 
<p>前者 就是精确匹配 ，后者包含这个短语 就行</p> 
<p></p> 
<p>非文本字段 用 term</p> 
<p>文本字段用 match</p> 
<h3>10. aggregations (执行聚合)</h3> 
<p>聚合提供了从数据中分组和提取数据的能力。最简单的聚合方法大致等于 SQL GROUP BY 和 SQL 的聚合函数 。在Elasticsearch 中， 您有执行搜索返回 hits (命中结果) ，并且同时返回聚合结果，把一个响应中的所有hits (命中结果) 分隔开的能力 。 这是非常强大且有效，您可以执行查询和多个聚合，并且在一次使用中得到各自 的（任何一个的） 返回结果，使用一次简化和简化的API 来避免网络往返。</p> 
<p><strong>搜索 address 中包含mill 的所有人的年龄分布以及平均年龄，但不显示这些人的详情。</strong></p> 
<pre><code class="language-bash">GET /bank/_search
{
  "query": {
    "match": {
      "address": "mill"
    }
  },
  "aggs": {
    "ageAgg": {
      "terms": {
        "field": "age",
        "size": 10
      }
    },
    "ageAvg":{
    "avg": {
      "field": "age"
    }
    },
    "blanceAvg":{
      "avg": {
        "field": "balance"
      }
    }
  },
  "size": 0
}</code></pre> 
<p>复杂：</p> 
<p>按照年龄聚合，并且请求这些年龄段的这些人的平均薪资</p> 
<pre><code class="language-bash">
##按照年龄聚合，并且请求这些年龄段的这些人的平均薪资
GET /bank/_search
{
  "query": {
    "match_all": {}
  },
  "aggs": {
    "aggAgg": {
      "terms": {
        "field": "age",
        "size": 100
      },
      "aggs": {
        "aggAvg": {
          "avg": {
            "field": "balance"
          }
        }
      }
    }
  }
  
  
}
</code></pre> 
<p>复杂2：</p> 
<p>查出所有年龄分布，并且这些年龄段中M的平均薪资和F的平均薪资以及这个年龄段的总体平均薪资.</p> 
<pre><code class="language-bash">##查出所有年龄分布，并且这些年龄段中M的平均薪资和F的平均薪资以及这个年龄段的总体平均薪资

GET /bank/_search
{
  "query": {
    "match_all": {}
  },
  "aggs": {
    "aggAggs": {
      "terms": {
        "field": "age",
        "size": 100
      }
      ,
    "aggs": {
      "avgBalanceAll":{
        "avg": {
        "field": "balance"
      }
      }
      ,
       "genderAgg": {
          "terms": {
            "field": "gender.keyword",
            "size": 2
          },
          "aggs": {
            "avgBlance": {
              "avg": {
                "field": "balance"
              }
            }
          }
        }
    }
    }
  }
}</code></pre> 
<h3>11.mapping(映射)</h3> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/7e/a7/1fs319d2_o.png" width="1200">所有数据类型</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/73/a9/RD6hqYS5_o.png" width="1200"></p> 
<h4>创建一个有类型定义的索引</h4> 
<pre><code class="language-bash">PUT /my_index
{
  "mappings": {
    "properties": {
      "age":{"type": "integer"  },
      "email":{"type": "keyword"},
      "name":{"type": "text"}
    }
  }
}</code></pre> 
<h4> 添加映射字段</h4> 
<pre><code class="language-bash">PUT /my_index/_mapping
{
  
  "properties": {
      "employee-id":{
        "type":"keyword",
        "index":false 
      }
    }
}</code></pre> 
<p>index =false 代表不参与索引，是搜索不到他的，相当于冗余存储字段，通过其他字段查出来</p> 
<h4>迁移数据</h4> 
<p>创建新索引</p> 
<pre><code class="language-bash">PUT /newbank
{
  "mappings": {
    "properties": {
      "account_number": {
        "type": "long"
      },
      "address": {
        "type": "text"
      },
      "age": {
        "type": "integer"
      },
      "balance": {
        "type": "long"
      },
      "city": {
        "type": "keyword"
      },
      "email": {
        "type": "keyword"
      },
      "employer": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "firstname": {
        "type": "text"
      },
      "gender": {
        "type": "keyword"
      },
      "lastname": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "state": {
        "type": "keyword"
      }
    }
  }
}
</code></pre> 
<p><img alt="" height="1171" src="https://images2.imgbox.com/b5/99/MsgHsMnL_o.png" width="1200"></p> 
<p>上面是6.0以后不用类型保存的迁移方法</p> 
<p>下面是6.0之前</p> 
<p> <img alt="" height="1200" src="https://images2.imgbox.com/30/3d/wBmhNmJV_o.png" width="1200"></p> 
<pre><code class="language-bash">POST _reindex
{
  "source": {
    "index": "bank",
    "type": "account"
  },
  "dest": {
    "index": "newbank"
  }
}</code></pre> 
<h2> 5.分词</h2> 
<p><img alt="" height="672" src="https://images2.imgbox.com/4d/f6/n4NQGsS4_o.png" width="1200"></p> 
<pre><code class="language-bash">POST _analyze
{
  "analyzer": "standard",
  "text": "The 2 QUICK Brown_Foxes jumped over the lazy dog's bone."
}</code></pre> 
<h3> 1.安装ik分词器</h3> 
<p>注意：不能用默认elastics-plugin install xx.zip 进行自动安装</p> 
<p>进入这个网址下</p> 
<p><a href="https://release.infinilabs.com/analysis-ik/stable/" rel="nofollow" title="Index of: analysis-ik/stable/ (infinilabs.com)">Index of: analysis-ik/stable/ (infinilabs.com)</a></p> 
<p>进入es 容器·内部 plugins 目录</p> 
<pre><code class="language-bash">docker exec -it 容器id /bin/bash</code></pre> 
<p><img alt="" height="1165" src="https://images2.imgbox.com/f9/e0/nCqW3ofs_o.png" width="1200"></p> 
<pre><code class="language-bash">POST _analyze
{
  "analyzer": "ik_smart",
  "text": "我是中国人"
}




POST _analyze
{
  "analyzer": "ik_max_word",
  "text": "鸡你太美"
}
</code></pre> 
<p> 安装方法和我上一篇文章一样</p> 
<p><a href="https://blog.csdn.net/qq_53374893/article/details/132909671" title="ElasticSearch-CSDN博客">ElasticSearch-CSDN博客</a></p> 
<h4>vagrant ssh密码登录  122集</h4> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/44/3c/k3i7Hj2q_o.png" width="1200"></p> 
<h3>2.自定义分词器</h3> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/45/35/RyNkXT1J_o.png" width="1200"><img alt="" height="1200" src="https://images2.imgbox.com/35/f9/zrZ7hspV_o.png" width="1200"></p> 
<h4>1.重新安装nginx</h4> 
<p>命令</p> 
<p>在nginx文件夹下,执行</p> 
<pre><code class="language-bash">docker run -p 80:80 --name nginx \
-v ./html:/usr/share/nginx/html \
-v ./logs:/var/log/nginx \
-v ./conf:/etc/nginx  \
-d nginx:1.10</code></pre> 
<h4> 2. 创建分词文件</h4> 
<p>/opt/nginx/html/es/fenci.txt</p> 
<pre><code class="language-bash">尚硅谷
乔碧螺</code></pre> 
<h4>3.在es插件，路径下找到xml文件对应的分词库路径，保存位置进行修改</h4> 
<p>"/opt/elasticearch/plugins/ik/config/IKAnalyzer.cfg.xml"</p> 
<pre><code class="language-bash">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd"&gt;
&lt;properties&gt;
	&lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;
	&lt;!--用户可以在这里配置自己的扩展字典 --&gt;
	&lt;entry key="ext_dict"&gt;&lt;/entry&gt;
	 &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;
	&lt;entry key="ext_stopwords"&gt;&lt;/entry&gt;
	&lt;!--用户可以在这里配置远程扩展字典 --&gt;
	 &lt;entry key="remote_ext_dict"&gt;http://虚拟机地址:80/es/fenci.txt&lt;/entry&gt;
	&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;
	&lt;!-- &lt;entry key="remote_ext_stopwords"&gt;words_location&lt;/entry&gt; --&gt;
&lt;/properties&gt;
</code></pre> 
<h4>4.修改以后重启restart es容器</h4> 
<p>docker restart elasticsearch</p> 
<p></p> 
<h2>6.Elasticsearch整合Spirngboot使用</h2> 
<h3>1.Elasticsearch-Rest-Client 官方 RestClient ，封装类ES操作，API层次分明，上手简单。</h3> 
<p>最终选择Elasticsearch-Rest-Client (elasticsearch-rest-high-level-client)</p> 
<pre><code class="language-bash">https://www.elastic.co/guid/en/elasticsearch/client/java-rest/current/java-rest-high.html</code></pre> 
<pre><code class="language-bash">&lt;!--        导入ES高阶API--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.elasticsearch.client&lt;/groupId&gt;
            &lt;artifactId&gt;elasticsearch-rest-high-level-client&lt;/artifactId&gt;
            &lt;version&gt;${elasticsearch.version}&lt;/version&gt;
        &lt;/dependency&gt;</code></pre> 
<pre><code class="language-java">package com.jmj.gulimall.search.config;

import org.apache.http.HttpHost;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestHighLevelClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * 导入依赖
 * 编写配置 给容器中注入一个 RestHighLevelClient
 * 参照官方API 操作就可以了 https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.4/java-rest-high-getting-started-initialization.html
 */
@Configuration
public class GulimallElasticSearchConfig {


    @Bean
    public RestHighLevelClient esRestClient() {
        RestHighLevelClient client = new RestHighLevelClient(
                RestClient.builder(
                        new HttpHost("192.168.232.209", 9200, "http")));
        return client;
    }

}
</code></pre> 
<h3>2.RequestOption</h3> 
<p>请求选项：比如安全验证，带token 请求头</p> 
<pre><code class="language-java">package com.jmj.gulimall.search.config;

import org.apache.http.HttpHost;
import org.elasticsearch.client.RequestOptions;
import org.elasticsearch.client.RestClient;
import org.elasticsearch.client.RestHighLevelClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * 导入依赖
 * 编写配置 给容器中注入一个 RestHighLevelClient
 * 参照官方API 操作就可以了 https://www.elastic.co/guide/en/elasticsearch/client/java-rest/7.4/java-rest-high-getting-started-initialization.html
 */
@Configuration
public class GulimallElasticSearchConfig {

    public static final RequestOptions COMMON_OPTIONS;
    static {
        RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();
//        builder.addHeader("Authorization", "Bearer " + TOKEN);
//        builder.setHttpAsyncResponseConsumerFactory(
//                new HttpAsyncResponseConsumerFactory
//                        .HeapBufferedResponseConsumerFactory(30 * 1024 * 1024 * 1024));
        COMMON_OPTIONS = builder.build();
    }

    @Bean
    public RestHighLevelClient esRestClient() {
        RestHighLevelClient client = new RestHighLevelClient(
                RestClient.builder(
                        new HttpHost("192.168.232.209", 9200, "http")));
        return client;
    }

}
</code></pre> 
<h3>3.Index API</h3> 
<p>第一种</p> 
<p><img alt="" height="603" src="https://images2.imgbox.com/ca/b7/D7LuVL3e_o.png" width="898"></p> 
<p> 第二种</p> 
<p><img alt="" height="396" src="https://images2.imgbox.com/d1/21/MfK37Rxy_o.png" width="897"></p> 
<p>第三种</p> 
<p><img alt="" height="409" src="https://images2.imgbox.com/b9/22/yENEEYa6_o.png" width="929"></p> 
<p>第四种</p> 
<p><img alt="" height="327" src="https://images2.imgbox.com/a5/3d/Of68tble_o.png" width="929"></p> 
<pre><code class="language-java">   /**
     * 测试存储数据到ES
     * 更新也可以
     */
    @Test
    void indexData() throws IOException {
        //index索引 users
        IndexRequest indexRequest = new IndexRequest("users");
        //设置document id ，不设置就会默认生成
        /**
         * 若是同样的id重复执行，就是更新操作 乐观锁控制版本
         */
        indexRequest.id("1");
        //1. key value  pair
//        indexRequest.source("userName","zhangsan","age",18,"gender","男");
        //2，JSON

        User user = new User("zhangsan", "男", 18);
        String json = new ObjectMapper().writeValueAsString(user);

        //一秒超时时间
        indexRequest.timeout(TimeValue.timeValueSeconds(1));


        indexRequest.source(json, XContentType.JSON);//要保存的内容
        //执行操作
        IndexResponse index = client.index(indexRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);
        //提取有用的响应数据
        System.out.println(index);

    }</code></pre> 
<h3>4.查询API</h3> 
<pre><code class="language-java"> @Data
    public static class Account{
        private int account_number;
        private String firstname;
        private String address;
        private int balance;
        private String gender;
        private String city;
        private String employer;
        private String state;
        private int age;
        private String email;
        private String lastname;

    }

    /**
     * search检索
     */
    @Test
    void searchData() throws IOException {
        //1、创建检索请求
        SearchRequest searchRequest = new SearchRequest();
        //2、指定索引
        searchRequest.indices("bank");
        //3、检索条件DSL
        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();

//        sourceBuilder.query();
//        sourceBuilder.from();
//        sourceBuilder.size();
//        sourceBuilder.aggregations();

//        sourceBuilder.query(QueryBuilders.matchAllQuery());
        sourceBuilder.query(QueryBuilders.matchQuery("address","mill"));

        //按照年龄进行分组
        TermsAggregationBuilder ageAgg = AggregationBuilders.terms("ageAgg").field("age").size(10);
        sourceBuilder.aggregation(ageAgg);
        //计算平均薪资
        AvgAggregationBuilder balanceAge = AggregationBuilders.avg("balanceAvg").field("balance");
        sourceBuilder.aggregation(balanceAge);



        System.out.println("检索条件:"+sourceBuilder);
        searchRequest.source(sourceBuilder);
        //4、执行检索
        SearchResponse response = client.search(searchRequest, GulimallElasticSearchConfig.COMMON_OPTIONS);
        //5、响应 分析结果
//        System.out.println(response.toString());

        SearchHits hits = response.getHits();
        SearchHit[] hits1 = hits.getHits();
        for (SearchHit documentFields : hits1) {
            String sourceAsString = documentFields.getSourceAsString();
            Account account = new ObjectMapper().readValue(sourceAsString, Account.class);
            System.out.println(account);
        }

        //获取分析数据
        Aggregations aggregations = response.getAggregations();
        Terms ageAgg1 = aggregations.get("ageAgg");
        for (Terms.Bucket bucket : ageAgg1.getBuckets()) {
            String keyAsString = bucket.getKeyAsString();
            System.out.println("年龄:"+keyAsString+"=&gt;"+bucket.getDocCount());
        }
        Avg balanceAvg = aggregations.get("balanceAvg");
        System.out.println("平均薪资:"+balanceAvg.getValue());


    }
</code></pre> 
<h2>7.SKU 在es种存储的模型 </h2> 
<p><strong>其中，库存信息的标题使用了ik分词器，图片信息，品牌名，品牌id等信息均不可检索。商品的规格参数等信息以nested类型，即嵌入属性存储。相关的细节这里不再赘述。</strong></p> 
<pre><code class="language-bash">PUT product
{
  "mappings": {
    "properties": {
      "skuId": {
        "type": "long"
      },
      "spuId": {
        "type": "long"
      },
      "skuTitle": {
        "type": "text",
        "analyzer": "ik_smart"
      },
      "skuPrice": {
        "type": "keyword"
      },
      "skuImg": {
        "type": "keyword",
        "index": false,
        "doc_values": false
      },
      "saleCount": {
        "type": "long"
      },
      "hosStock": {
        "type": "boolean"
      },
      "hotScore": {
        "type": "long"
      },
      "brandId": {
        "type": "long"
      },
      "catalogId": {
        "type": "long"
      },
      "brandName": {
        "type": "keyword",
        "index": false,
        "doc_values": false
      },
      "brandImg": {
        "type": "keyword",
        "index": false,
        "doc_values": false
      },
      "catalogName": {
        "type": "keyword",
        "index": false,
        "doc_values": false
      },
      "attrs": {
        "type": "nested",
        "properties": {
          "attrId": {
            "type": "long"
          },
          "attrName": {
            "type": "keyword",
            "index": false,
            "doc_values": false
          },
          "attrValue": {
            "type": "keyword"
          }
        }
      }
    }
  }
}
</code></pre> 
<h2 style="background-color:transparent;">8.ES扁平化处理</h2> 
<pre><code class="language-bash">PUT my_index/_doc/1
{
  "group":"fans",
  "user":[
    {
      "first":"John",
      "last":"Smith"
    },
    {
      "first":"Alice",
      "last":"White"
    }
  ]
}</code></pre> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/da/0b/hkowUF9B_o.png" width="1200"></p> 
<p></p> 
<pre><code class="language-bash">GET my_index/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "user.first": "Alice"
          }
        },
        {
          "match": {
            "user.first": "Alice"
          }
        }
      ]
    }
  }
}</code></pre> 
<p><img alt="" height="703" src="https://images2.imgbox.com/4d/98/Z9aaExeJ_o.png" width="692"></p> 
<h3> 取消扁平化处理 </h3> 
<pre><code class="language-bash">PUT my_index
{
  "mappings": {
    "properties": {
      "user":{
        "type": "nested"
      }
    }
  }
}</code></pre> 
<p>再次查询</p> 
<p><img alt="" height="343" src="https://images2.imgbox.com/af/46/6O6DgXQ5_o.png" width="444"></p> 
<h2>9. 商城上架</h2> 
<pre><code class="language-java"> @Override
    @Transactional(rollbackFor = Exception.class)
    public void up(Long spuId) {


        //组装需要的数据
        //1. 查出当前 spuid 对应的所有sku 信息，品牌 的名字。
        List&lt;SkuInfoEntity&gt; skuInfoEntityList = skuInfoService.getSkusBySpuId(spuId);

        //TODO 查询当前sku的所有可以用来检索的属性
        List&lt;ProductAttrValueEntity&gt; baseAttrs = productAttrValueService.baseAttrlistforspu(spuId);
        List&lt;Long&gt; attrIds = baseAttrs.stream().map(a -&gt; a.getAttrId()).collect(Collectors.toList());

        List&lt;Long&gt; searchAttrIds = attrService.selectSearchAtts(attrIds);

        List&lt;SkuEsModel.Attrs&gt; attrsList = baseAttrs.stream().filter(item -&gt; searchAttrIds.contains(item.getAttrId()))
                .map(item -&gt; {
                    SkuEsModel.Attrs attrs1 = new SkuEsModel.Attrs();
                    BeanUtils.copyProperties(item, attrs1);
                    return attrs1;
                })
                .collect(Collectors.toList());

        //TODO 发送远程调用 库存系统查询是否有库存
        List&lt;Long&gt; skuIds = skuInfoEntityList.stream().map(s -&gt; s.getSkuId()).distinct().collect(Collectors.toList());

        List&lt;SkuHasStockVo&gt; skusHasStock = wareFeignService.getSkusHasStock(skuIds);

        Map&lt;Long, Boolean&gt; stockMap = skusHasStock.stream().collect(Collectors.toMap(s -&gt; s.getSkuId(), s -&gt; s.getHasStock()));

        //2.封装每个SKU 的信息
        List&lt;SkuEsModel&gt; upProducts = skuInfoEntityList.stream().map(sku -&gt; {
            SkuEsModel esModel = new SkuEsModel();
            BeanUtils.copyProperties(sku, esModel);
            esModel.setSkuPrice(sku.getPrice());
            esModel.setSkuImg(sku.getSkuDefaultImg());

            Long skuId = esModel.getSkuId();
            Boolean aBoolean = stockMap.get(skuId);
            if (aBoolean!=null){
                esModel.setHasStock(aBoolean);
            }else {
                esModel.setHasStock(false);
            }



            //TODO 热度评分
            esModel.setHotScore(0L);
            //TODO 查询品牌和分类的名字信息
            BrandEntity brand = brandService.getById(esModel.getBrandId());
            esModel.setBrandName(brand.getName());
            esModel.setBrandImg(brand.getLogo());

            CategoryEntity category = categoryService.getById(esModel.getCatalogId());
            esModel.setCatalogName(category.getName());

            //设置检索属性
            esModel.setAttrs(attrsList);

            return esModel;
        }).collect(Collectors.toList());

        //TODO 将数据发送给es进行保存
        searchFeignService.productStatusUp(upProducts);

        //TODO 修改状态
        this.update(new UpdateWrapper&lt;SpuInfoEntity&gt;()
                .set("publish_status", ProductConstant.StatusEnum.SPU_UP.getCode())
                        .set("update_taime",new Date())
                .eq("id",spuId));

        //Feign调用流程
        /**
         * 1、构造请求数据,将对象转为json
         * 2、发送请求进行执行(执行成功会解码响应数据)
         * 3、执行请求会有重试机制
         * //默认重试机制是关闭状态
         * while(true){
         *    
         * }
         */
    }</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8b22213c90afd7d039f4cb506bd0369f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C&#43;&#43;】：vector容器的底层模拟实现&amp;&amp;迭代器失效&amp;&amp;隐藏的浅拷贝</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c7fc028862aea35a85a41656329858b2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于MingGW64 GCC编译Windows平台上的 libuvc</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>