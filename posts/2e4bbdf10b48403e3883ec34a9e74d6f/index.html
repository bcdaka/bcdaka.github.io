<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL主从复制与读写分离 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/2e4bbdf10b48403e3883ec34a9e74d6f/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="MySQL主从复制与读写分离">
  <meta property="og:description" content="MySQL 主从复制（Master-Slave Replication） 概念 MySQL 主从复制是一种将一台 MySQL 服务器（主服务器，Master）的变更自动复制到另一台或多台 MySQL 服务器（从服务器，Slave）的机制。主服务器负责处理写操作，从服务器主要用于处理读操作。
工作原理 主服务器记录变更：
主服务器在执行写操作（如 INSERT、UPDATE、DELETE）时，将这些操作记录到二进制日志（binlog）中。binlog 是一种记录所有更改数据库内容的日志文件。 从服务器读取日志：
从服务器有一个 I/O 线程，负责连接到主服务器并读取主服务器的 binlog，然后将其保存到从服务器的中继日志（relay log）中。 从服务器重放日志：
从服务器有一个 SQL 线程，负责读取中继日志并执行日志中的变更操作。这使得从服务器的数据与主服务器保持一致。 配置步骤 在主服务器上启用二进制日志：
[mysqld] log-bin=mysql-bin server-id=1 在从服务器上配置复制参数：
[mysqld] server-id=2 relay-log=relay-log 创建复制用户并授予权限：
CREATE USER &#39;replica&#39;@&#39;%&#39; IDENTIFIED BY &#39;password&#39;; GRANT REPLICATION SLAVE ON *.* TO &#39;replica&#39;@&#39;%&#39;; FLUSH PRIVILEGES; 在从服务器上启动复制：
CHANGE MASTER TO MASTER_HOST=&#39;master_host&#39;, MASTER_USER=&#39;replica&#39;, MASTER_PASSWORD=&#39;password&#39;, MASTER_LOG_FILE=&#39;mysql-bin.000001&#39;, MASTER_LOG_POS= 4; START SLAVE; 优缺点 优点：
提高读性能：通过增加从服务器，可以分担主服务器的读负载。数据备份：从服务器可以作为数据的实时备份，提高数据的可用性。 缺点：
数据延迟：由于复制过程需要时间，从服务器的数据可能会比主服务器稍有延迟。单点故障：如果主服务器出现故障，需要手动或自动将其中一台从服务器提升为主服务器。 MySQL 读写分离（Read-Write Splitting） 概念 读写分离是将数据库的读操作和写操作分离到不同的数据库实例上进行的策略。通常结合主从复制使用，即主服务器处理写操作，从服务器处理读操作。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-01T18:43:56+08:00">
    <meta property="article:modified_time" content="2024-07-01T18:43:56+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL主从复制与读写分离</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>MySQL 主从复制（Master-Slave Replication）</h4> 
<h5>概念</h5> 
<p>MySQL 主从复制是一种将一台 MySQL 服务器（主服务器，Master）的变更自动复制到另一台或多台 MySQL 服务器（从服务器，Slave）的机制。主服务器负责处理写操作，从服务器主要用于处理读操作。</p> 
<h5>工作原理</h5> 
<ol><li> <p><strong>主服务器记录变更</strong>：</p> 
  <ul><li>主服务器在执行写操作（如 INSERT、UPDATE、DELETE）时，将这些操作记录到二进制日志（binlog）中。binlog 是一种记录所有更改数据库内容的日志文件。</li></ul></li><li> <p><strong>从服务器读取日志</strong>：</p> 
  <ul><li>从服务器有一个 I/O 线程，负责连接到主服务器并读取主服务器的 binlog，然后将其保存到从服务器的中继日志（relay log）中。</li></ul></li><li> <p><strong>从服务器重放日志</strong>：</p> 
  <ul><li>从服务器有一个 SQL 线程，负责读取中继日志并执行日志中的变更操作。这使得从服务器的数据与主服务器保持一致。</li></ul></li></ol> 
<h5>配置步骤</h5> 
<ol><li> <p><strong>在主服务器上启用二进制日志</strong>：</p> <pre><span style="color:#b7b1a8;font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif, SimHei, SimSun;font-size:16px;">[mysqld] log-bin=mysql-bin server-id=1</span>
</pre> </li><li> <p><strong>在从服务器上配置复制参数</strong>：</p> <pre><span style="color:#b7b1a8;font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif, SimHei, SimSun;font-size:16px;">[mysqld] server-id=2 relay-log=relay-log</span>
</pre> </li><li> <p><strong>创建复制用户并授予权限</strong>：</p> <pre><span style="color:#b7b1a8;font-family:'-apple-system', 'SF UI Text', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'WenQuanYi Micro Hei', sans-serif, SimHei, SimSun;font-size:16px;">CREATE USER 'replica'@'%' IDENTIFIED BY 'password'; GRANT REPLICATION SLAVE ON *.* TO 'replica'@'%'; FLUSH PRIVILEGES;</span>
</pre> </li><li> <p><strong>在从服务器上启动复制</strong>：</p> <p><code>CHANGE MASTER TO MASTER_HOST='master_host', MASTER_USER='replica', MASTER_PASSWORD='password', MASTER_LOG_FILE='mysql-bin.000001', MASTER_LOG_POS= 4; START SLAVE; </code></p> </li></ol> 
<h5>优缺点</h5> 
<p><strong>优点</strong>：</p> 
<ul><li><strong>提高读性能</strong>：通过增加从服务器，可以分担主服务器的读负载。</li><li><strong>数据备份</strong>：从服务器可以作为数据的实时备份，提高数据的可用性。</li></ul> 
<p><strong>缺点</strong>：</p> 
<ul><li><strong>数据延迟</strong>：由于复制过程需要时间，从服务器的数据可能会比主服务器稍有延迟。</li><li><strong>单点故障</strong>：如果主服务器出现故障，需要手动或自动将其中一台从服务器提升为主服务器。</li></ul> 
<h4>MySQL 读写分离（Read-Write Splitting）</h4> 
<h5>概念</h5> 
<p>读写分离是将数据库的读操作和写操作分离到不同的数据库实例上进行的策略。通常结合主从复制使用，即主服务器处理写操作，从服务器处理读操作。</p> 
<h5>工作原理</h5> 
<ol><li> <p><strong>应用程序在执行数据库操作时，通过负载均衡组件或逻辑判断，将写操作发送到主服务器，读操作发送到从服务器</strong>：</p> 
  <ul><li>应用程序可以使用中间件（如 MySQL Proxy、MaxScale）或代码层的逻辑来实现读写分离。</li></ul></li><li> <p><strong>从服务器通过主从复制机制，从主服务器同步最新的数据</strong>：</p> 
  <ul><li>确保从服务器的数据尽量与主服务器保持同步，尽管会有一定的延迟。</li></ul></li></ol> 
<h5>配置步骤</h5> 
<ol><li><strong>确保已经配置好主从复制</strong>。</li><li><strong>在应用程序中实现读写分离逻辑</strong>： 
  <ul><li>例如，在 Java 应用中，可以通过配置多个数据源，一个用于写操作（指向主服务器），一个用于读操作（指向从服务器）。</li></ul></li></ol> 
<h5>优缺点</h5> 
<p><strong>优点</strong>：</p> 
<ul><li><strong>提高性能</strong>：通过将读操作分散到多个从服务器，可以显著提高读性能。</li><li><strong>减少主服务器压力</strong>：主服务器专注于处理写操作，从而提高写性能。</li></ul> 
<p><strong>缺点</strong>：</p> 
<ul><li><strong>一致性问题</strong>：由于复制的延迟，读操作有可能读到延迟的数据，导致数据一致性问题。</li><li><strong>复杂性增加</strong>：需要在应用层或中间层实现读写分离的逻辑，增加了系统的复杂性。</li></ul> 
<h4>具体案例演示如下</h4> 
<p style="margin-left:0;text-align:justify;"><span style="color:#FF0000;">master</span><span style="color:#FF0000;">：192.168.10.101</span></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#FF0000;">slave1:192.168.10.102</span></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#FF0000;">slave2:192.168.10.103</span></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#FF0000;">amoeba</span><span style="color:#FF0000;">：192.168.10.104</span></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#FF0000;">client</span><span style="color:#FF0000;">：192.168.10.105</span></p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;">1：关闭所有服务器的firewalld</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# setenforce 0</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# systemctl stop firewalld</p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;">2：建立时间同步环境</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# yum -y install ntp</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# vi /etc/ntp.conf</p> 
<p style="margin-left:0;text-align:justify;">添加：</p> 
<p style="margin-left:0;text-align:justify;">server 127.127.1.0</p> 
<p style="margin-left:0;text-align:justify;">fudge 127.127.1.0 stratum 8</p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# systemctl restart ntpd</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# systemctl enable ntpd</p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;">在从节点上进行时间同步</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# yum -y install ntp</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# ntpdate 192.168.10.102</p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;">在所有服务器上安装mysql数据库</p> 
<p style="margin-left:0;text-align:justify;">步骤略</p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;">配置mysql master主服务器</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# vi /etc/my.cnf</p> 
<p style="margin-left:0;text-align:justify;">在[mysqld]模块中修改或添加：</p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:left;">server-id=11           ##修改</p> 
<p style="margin-left:0;text-align:left;">log-bin=master-bin      ##修改</p> 
<p style="margin-left:0;text-align:left;">log-slave-updates=true    ##添加    （可不用添加）</p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#FF0000;">binlog-format = MIXED</span></p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:left;">注释：</p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#595959;">系统默认采用基于语句的复制类型</span></p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#595959;">基于语句的复制。</span> <span style="color:#595959;">在主服务器上执行的</span><span style="color:#595959;"> SQL </span><span style="color:#595959;">语句，在从服务器上执行同样的语句。配置：</span></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#FF0000;">binlog_format = STATEMENT</span></p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#595959;">基于行的复制。把改变的内容复制过去，而不是把命令在从服务器上执行一遍，从</span><span style="color:#595959;"> MySQL 5.0</span><span style="color:#595959;">开始支持，配置：</span></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#FF0000;">binlog_format = ROW</span></p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#595959;">混合类型的复制。默认采用基于语句的复制，一旦发现基于语句的无法精确的复制时，就会采用基于行的复制</span><span style="color:#595959;">,</span><span style="color:#595959;">配置：</span><span style="color:#FF0000;">binlog_format = MIXED</span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#595959;">log-slave-updates=true     #Slave</span><span style="color:#595959;">可以是其他</span><span style="color:#595959;"> Slave </span><span style="color:#595959;">的</span><span style="color:#595959;"> Master</span><span style="color:#595959;">，从而扩散</span><span style="color:#595959;"> Master </span><span style="color:#595959;">的更新</span></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#595959;">binlog-ignore-db=test      #</span><span style="color:#595959;">不记录指定的数据库的二进制日志</span><span style="color:#595959;"> <br> replicate-ignore-db=test    #</span><span style="color:#595959;">设置不需要同步的库</span><br><span style="color:#595959;">binlog_cache_size = 1M    #</span><span style="color:#595959;">日志缓存的大小</span><br><span style="color:#595959;">expire_logs_days=3       #</span><span style="color:#595959;">自动过期清理日志的天数</span></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#595959;">以上参数在</span><span style="color:#595959;">[mysqld]</span><span style="color:#595959;">模块中设置</span></p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# systemctl restart mysqld</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# mysql -u root -p</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; grant replication slave on *.* to 'myslave'@'192.168.10.%' identified by '123456' ;</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; flush privileges;</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; show master status;</p> 
<p style="margin-left:0;text-align:left;">+-------------------+----------+--------------+------------------+</p> 
<p style="margin-left:0;text-align:left;">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB |</p> 
<p style="margin-left:0;text-align:left;">+-------------------+----------+--------------+------------------+</p> 
<p style="margin-left:0;text-align:left;">| <span style="color:#FF0000;">master-bin.000001 </span>|     <span style="color:#FF0000;"> 337</span> |              |                  |</p> 
<p style="margin-left:0;text-align:left;">+-------------------+----------+--------------+------------------+</p> 
<p style="margin-left:0;text-align:left;">1 row in set (0.01 sec)</p> 
<p style="margin-left:0;text-align:justify;"></p> 
<p style="margin-left:0;text-align:justify;">从服务器的配置</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# vi /etc/my.cnf</p> 
<p style="margin-left:0;text-align:left;">在[mysqld]模块中修改或添加：</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">server-id       = 22            ##修改，值不能和其他mysql服务器重复</p> 
<p style="margin-left:0;text-align:left;">relay-log=relay-log-bin            ##添加（可不指定）</p> 
<p style="margin-left:0;text-align:left;">relay-log-index=slave-relay-bin.index    ##添加（可不指定）</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">注释：</p> 
<p style="margin-left:0;text-align:left;"><span style="color:#404040;">--relay-log=name    </span><span style="color:#404040;">中继日志的文件的名字</span><br><span style="color:#404040;"> --relay-log-index=name      MySQL slave </span><span style="color:#404040;">在启动时需要检查</span><span style="color:#404040;">relay log index </span><span style="color:#404040;">文件中的</span><span style="color:#404040;">relay log</span><span style="color:#404040;">信息，此处定义该索引文件的名字</span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">[root@localhost ~]# systemctl restart mysqld</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# mysql -u root -p</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; change master to master_host='192.168.10.101',master_user='myslave',master_password='123456',master_log_file=<span style="color:#FF0000;">'master-bin.000001',</span>master_log_pos=<span style="color:#FF0000;">337;</span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:justify;"><span style="color:#595959;">注释：</span><span style="color:#595959;"> Slave </span><span style="color:#595959;">的</span><span style="color:#595959;"> IO </span><span style="color:#595959;">线程接收到信息后，将接收到的日志内容依次写入到</span><span style="color:#595959;"> Slave </span><span style="color:#595959;">端的</span><span style="color:#595959;">Relay Log</span><span style="color:#595959;">文件</span><span style="color:#595959;">(relay-log-bin.xxxxxx)</span><span style="color:#595959;">的最末端，并将读取到的</span><span style="color:#595959;">Master</span><span style="color:#595959;">端的</span><span style="color:#595959;">master-bin</span><span style="color:#595959;">的文件名和位置记录到</span><span style="color:#595959;">master- info</span><span style="color:#595959;">文件中，以便在下一次读取的时候能够清楚的告诉</span><span style="color:#595959;">Master</span><span style="color:#595959;">“我需要从某个</span><span style="color:#595959;">master-bin</span><span style="color:#595959;">的哪个位置开始往后的日志内容，请发给我</span></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">mysql&gt; start slave;</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; show slave status\G           ##注意后面不要加分号</p> 
<p style="margin-left:0;text-align:left;">*************************** 1. row ***************************</p> 
<p style="margin-left:0;text-align:left;">               Slave_IO_State: Waiting for master to send event</p> 
<p style="margin-left:0;text-align:left;">                  Master_Host: 192.168.10.102</p> 
<p style="margin-left:0;text-align:left;">                  Master_User: myslave</p> 
<p style="margin-left:0;text-align:left;">                  Master_Port: 3306</p> 
<p style="margin-left:0;text-align:left;">                Connect_Retry: 60</p> 
<p style="margin-left:0;text-align:left;">              Master_Log_File: master-bin.000001</p> 
<p style="margin-left:0;text-align:left;">          Read_Master_Log_Pos: 411</p> 
<p style="margin-left:0;text-align:left;">               Relay_Log_File: localhost-relay-bin.000002</p> 
<p style="margin-left:0;text-align:left;">                Relay_Log_Pos: 284</p> 
<p style="margin-left:0;text-align:left;">        Relay_Master_Log_File: master-bin.000001</p> 
<p style="margin-left:0;text-align:left;"><span style="color:#FF0000;">             Slave_IO_Running: Yes</span></p> 
<p style="margin-left:0;text-align:left;"><span style="color:#FF0000;">            Slave_SQL_Running: Yes</span></p> 
<p style="margin-left:0;text-align:left;">              Replicate_Do_DB:</p> 
<p style="margin-left:0;text-align:left;">          Replicate_Ignore_DB:</p> 
<p style="margin-left:0;text-align:left;">           Replicate_Do_Table:</p> 
<p style="margin-left:0;text-align:left;">       Replicate_Ignore_Table:</p> 
<p style="margin-left:0;text-align:left;">      Replicate_Wild_Do_Table:</p> 
<p style="margin-left:0;text-align:left;">  Replicate_Wild_Ignore_Table:</p> 
<p style="margin-left:0;text-align:left;">                   Last_Errno: 0</p> 
<p style="margin-left:0;text-align:left;">                   Last_Error:</p> 
<p style="margin-left:0;text-align:left;">                 Skip_Counter: 0</p> 
<p style="margin-left:0;text-align:left;">          Exec_Master_Log_Pos: 411</p> 
<p style="margin-left:0;text-align:left;">              Relay_Log_Space: 461</p> 
<p style="margin-left:0;text-align:left;">              Until_Condition: None</p> 
<p style="margin-left:0;text-align:left;">               Until_Log_File:</p> 
<p style="margin-left:0;text-align:left;">                Until_Log_Pos: 0</p> 
<p style="margin-left:0;text-align:left;">           Master_SSL_Allowed: No</p> 
<p style="margin-left:0;text-align:left;">           Master_SSL_CA_File:</p> 
<p style="margin-left:0;text-align:left;">           Master_SSL_CA_Path:</p> 
<p style="margin-left:0;text-align:left;">              Master_SSL_Cert:</p> 
<p style="margin-left:0;text-align:left;">            Master_SSL_Cipher:</p> 
<p style="margin-left:0;text-align:left;">               Master_SSL_Key:</p> 
<p style="margin-left:0;text-align:left;">        Seconds_Behind_Master: 0</p> 
<p style="margin-left:0;text-align:left;">Master_SSL_Verify_Server_Cert: No</p> 
<p style="margin-left:0;text-align:left;">                Last_IO_Errno: 0</p> 
<p style="margin-left:0;text-align:left;">                Last_IO_Error:</p> 
<p style="margin-left:0;text-align:left;">               Last_SQL_Errno: 0</p> 
<p style="margin-left:0;text-align:left;">               Last_SQL_Error:</p> 
<p style="margin-left:0;text-align:left;">  Replicate_Ignore_Server_Ids:</p> 
<p style="margin-left:0;text-align:left;">             Master_Server_Id: 11</p> 
<p style="margin-left:0;text-align:left;">                  Master_UUID: 167be460-3d4d-11e8-ad42-000c29ae7f64</p> 
<p style="margin-left:0;text-align:left;">             Master_Info_File: /usr/local/mysql/data/master.info</p> 
<p style="margin-left:0;text-align:left;">                    SQL_Delay: 0</p> 
<p style="margin-left:0;text-align:left;">          SQL_Remaining_Delay: NULL</p> 
<p style="margin-left:0;text-align:left;">      Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it</p> 
<p style="margin-left:0;text-align:left;">           Master_Retry_Count: 86400</p> 
<p style="margin-left:0;text-align:left;">                  Master_Bind:</p> 
<p style="margin-left:0;text-align:left;">      Last_IO_Error_Timestamp:</p> 
<p style="margin-left:0;text-align:left;">     Last_SQL_Error_Timestamp:</p> 
<p style="margin-left:0;text-align:left;">               Master_SSL_Crl:</p> 
<p style="margin-left:0;text-align:left;">           Master_SSL_Crlpath:</p> 
<p style="margin-left:0;text-align:left;">           Retrieved_Gtid_Set:</p> 
<p style="margin-left:0;text-align:left;">            Executed_Gtid_Set:</p> 
<p style="margin-left:0;text-align:left;">                Auto_Position: 0</p> 
<p style="margin-left:0;text-align:left;">1 row in set (0.00 sec)</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">备注：如果后面加了分号，显示的最后一行会提示ERROR: No query specified</p> 
<p style="margin-left:0;text-align:left;">，当然，这没有任何影响。只是看起来不爽。</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">验证主从复制</p> 
<p style="margin-left:0;text-align:left;">在主从服务器上分别查询数据库</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; show databases;</p> 
<p style="margin-left:0;text-align:left;">+--------------------+</p> 
<p style="margin-left:0;text-align:left;">| Database           |</p> 
<p style="margin-left:0;text-align:left;">+--------------------+</p> 
<p style="margin-left:0;text-align:left;">| information_schema |</p> 
<p style="margin-left:0;text-align:left;">| mysql              |</p> 
<p style="margin-left:0;text-align:left;">| performance_schema |</p> 
<p style="margin-left:0;text-align:left;">| test               |</p> 
<p style="margin-left:0;text-align:left;">+--------------------+</p> 
<p style="margin-left:0;text-align:left;">4 rows in set (0.00 sec)</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">在主服务器上创建数据库</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; create database db_test;</p> 
<p style="margin-left:0;text-align:left;">Query OK, 1 row affected (0.00 sec)</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">mysql&gt; show databases;</p> 
<p style="margin-left:0;text-align:left;">+--------------------+</p> 
<p style="margin-left:0;text-align:left;">| Database           |</p> 
<p style="margin-left:0;text-align:left;">+--------------------+</p> 
<p style="margin-left:0;text-align:left;">| information_schema |</p> 
<p style="margin-left:0;text-align:left;">| db_test            |</p> 
<p style="margin-left:0;text-align:left;">| mysql              |</p> 
<p style="margin-left:0;text-align:left;">| performance_schema |</p> 
<p style="margin-left:0;text-align:left;">| test               |</p> 
<p style="margin-left:0;text-align:left;">+--------------------+</p> 
<p style="margin-left:0;text-align:left;">5 rows in set (0.00 sec)</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">在从服务器上再次查询数据库，可以看到从服务器上也有了db_test数据库了</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; show databases;</p> 
<p style="margin-left:0;text-align:left;">+--------------------+</p> 
<p style="margin-left:0;text-align:left;">| Database           |</p> 
<p style="margin-left:0;text-align:left;">+--------------------+</p> 
<p style="margin-left:0;text-align:left;">| information_schema |</p> 
<p style="margin-left:0;text-align:left;">| db_test            |</p> 
<p style="margin-left:0;text-align:left;">| mysql              |</p> 
<p style="margin-left:0;text-align:left;">| performance_schema |</p> 
<p style="margin-left:0;text-align:left;">| test               |</p> 
<p style="margin-left:0;text-align:left;">+--------------------+</p> 
<p style="margin-left:0;text-align:left;">5 rows in set (0.00 sec)</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"></p> 
<h2 style="margin-left:0;text-align:justify;">扩展：主主复制</h2> 
<p style="margin-left:0;text-align:left;">如果需要将一个slave1服务器作为另一台slave2的master，</p> 
<p style="margin-left:0;text-align:left;">在slave1上修改my.cnf，在[mysqld]模块添加</p> 
<p style="margin-left:0;text-align:left;">server-id=11</p> 
<p style="margin-left:0;text-align:left;">log-bin=master-bin</p> 
<p style="margin-left:0;text-align:left;"><span style="color:#FF0000;">log-slave-updates=true</span></p> 
<p style="margin-left:0;text-align:left;">并重启mysql</p> 
<p style="margin-left:0;text-align:left;">在slave1上执行以下命令创建一个授权用户，用于在slave2上链接slave1</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; grant replication slave on *.* to 'myslave'@'192.168.10.%' identified by '123456' ;</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; flush privileges;</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; show master status;</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">show出来的信息做为slave2上连接slave1时的参数</p> 
<p style="margin-left:0;text-align:left;">重启Mysql服务不会影响主从关系</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h3 style="margin-left:0px;text-align:justify;">搭建Mysql读写分离</h3> 
<h4 style="margin-left:0px;text-align:left;">在主机amoeba上安装java环境</h4> 
<p style="margin-left:0;text-align:left;">[root@localhost ~]# chmod +x jdk-6u14-linux-x64.bin</p> 
<p style="margin-left:0;text-align:left;">[root@localhost ~]# ./jdk-6u14-linux-x64.bin</p> 
<p style="margin-left:0;text-align:left;">[root@localhost ~]# mv jdk1.6.0_14/ /usr/local/jdk1.6</p> 
<p style="margin-left:0;text-align:left;">[root@localhost ~]# vi /etc/profile</p> 
<h4 style="margin-left:0px;text-align:left;">添加到最末尾：</h4> 
<p style="margin-left:0;text-align:left;">export JAVA_HOME=/usr/local/jdk1.6</p> 
<p style="margin-left:0;text-align:left;">export CLASSPATH=$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/jre/lib</p> 
<p style="margin-left:0;text-align:left;">export PATH=$JAVA_HOME/lib:$JAVA_HOME/jre/bin:$PATH:$JAVA_HOME/bin</p> 
<p style="margin-left:0;text-align:left;">export AMOEBA_HOME=/usr/local/amoeba/</p> 
<p style="margin-left:0;text-align:left;">export PATH=$PATH:$AMOEBA_HOME/bin</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">[root@localhost local]# source /etc/profile</p> 
<p style="margin-left:0;text-align:left;">[root@localhost local]# java -version            ##查询版本，确定java安装成功</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"></p> 
<h4 style="margin-left:0px;text-align:left;">安装并配置amoeba</h4> 
<p style="margin-left:0;text-align:left;">[root@localhost local]# mkdir /usr/local/amoeba</p> 
<p style="margin-left:0;text-align:left;">[root@localhost ~]# tar zxf amoeba-mysql-binary-2.2.0.tar.gz -C /usr/local/amoeba/</p> 
<p style="margin-left:0;text-align:left;">[root@localhost ~]# chmod -R 755 /usr/local/amoeba/</p> 
<p style="margin-left:0;text-align:left;">[root@localhost ~]# /usr/local/amoeba/bin/amoeba</p> 
<p style="margin-left:0;text-align:left;">amoeba start|stop       ##有此提示表示成功</p> 
<h3 style="margin-left:0px;text-align:left;">配置amoeba读写分离</h3> 
<h5 style="margin-left:0px;text-align:left;">（1）在三个mysql服务器中开放权限给amoeba访问（只在master中即可，会复制到slave中）</h5> 
<p style="margin-left:0;text-align:left;">mysql&gt; grant all on *.* to test@'192.168.10.%' identified by '123.com';</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（2）在amoeba上配置amoeba.xml文件</h5> 
<p style="margin-left:0;text-align:left;">[root@localhost amoeba]# systemctl stop firewalld</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">[root@localhost ~]# cd /usr/local/amoeba/conf</p> 
<p style="margin-left:0;text-align:left;">[root@localhost conf]# vi amoeba.xml</p> 
<p style="margin-left:0;text-align:left;">修改红色部分，此处设置的是mysql客户端连接amoeba时用的账号和密码</p> 
<p style="margin-left:0;text-align:left;">&lt;property name="authenticator"&gt;</p> 
<p style="margin-left:0;text-align:left;">        &lt;bean class="com.meidusa.amoeba.mysql.server.MysqlClientAuthenticator"&gt;</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">             &lt;property name="user"&gt;<span style="color:#FF0000;">amoeba</span>&lt;/property&gt;                 ##30行</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">             &lt;property name="password"&gt;<span style="color:#FF0000;">123456</span>&lt;/property&gt;               ##32行</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">             &lt;property name="filter"&gt;</p> 
<p style="margin-left:0;text-align:left;">                       &lt;bean class="com.meidusa.amoeba.server.IPAccessController"&gt;</p> 
<p style="margin-left:0;text-align:left;">             &lt;property name="ipFile"&gt;${amoeba.home}/conf/access_list.conf&lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;">                       &lt;/bean&gt;</p> 
<p style="margin-left:0;text-align:left;">             &lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;">                       &lt;/bean&gt;</p> 
<p style="margin-left:0;text-align:left;">         &lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">                 。。。。。。。。略。。。。。。。</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">&lt;queryRouter class="com.meidusa.amoeba.mysql.parser.MysqlQueryRouter"&gt;</p> 
<p style="margin-left:0;text-align:left;">        &lt;property name="ruleLoader"&gt;</p> 
<p style="margin-left:0;text-align:left;">             &lt;bean class="com.meidusa.amoeba.route.TableRuleFileLoader"&gt;</p> 
<p style="margin-left:0;text-align:left;">                          &lt;property name="ruleFile"&gt;${amoeba.home}/conf/rule.xml&lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;">                &lt;property name="functionFile"&gt;${amoeba.home}/conf/ruleFunctionMap.xml&lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;">             &lt;/bean&gt;</p> 
<p style="margin-left:0;text-align:left;">                &lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;">                &lt;property name="sqlFunctionFile"&gt;${amoeba.home}/conf/functionMap.xml&lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;">                &lt;property name="LRUMapSize"&gt;1500&lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;">                &lt;property name="defaultPool"&gt;<span style="color:#FF0000;">master</span>&lt;/property&gt;             ##115行</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">              </p> 
<p style="margin-left:0;text-align:left;">                &lt;property name="writePool"&gt;<span style="color:#FF0000;">master</span>&lt;/property&gt;             ##118行</p> 
<p style="margin-left:0;text-align:left;">                &lt;property name="readPool"&gt;<span style="color:#FF0000;">slaves</span>&lt;/property&gt;    ##119行此处的注释去掉</p> 
<p style="margin-left:0;text-align:left;">              </p> 
<p style="margin-left:0;text-align:left;">                &lt;property name="needParse"&gt;true&lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;">        &lt;/queryRouter&gt;</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（3）编辑dbServer.xml文件</h5> 
<p style="margin-left:0;text-align:left;">[root@localhost conf]# vi dbServers.xml</p> 
<p style="margin-left:0;text-align:left;">修改（注意去掉注释），slave2的复制一个slave1</p> 
<p style="margin-left:0;text-align:left;">     &lt;!-- mysql user --&gt;</p> 
<p style="margin-left:0;text-align:left;">                  &lt;property name="user"&gt;<span style="color:#FF0000;">test</span>&lt;/property&gt;         ##26行</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">                       </p> 
<p style="margin-left:0;text-align:left;">                  &lt;property name="password"&gt;<span style="color:#FF0000;">123.com</span>&lt;/property&gt;  ##29行，去掉注释符</p> 
<p style="margin-left:0;text-align:left;">                       </p> 
<p style="margin-left:0;text-align:left;">                &lt;/factoryConfig&gt;</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">                       。。。。。。。。。略。。。。。。。。。。</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">  &lt;dbServer name="<span style="color:#FF0000;">master</span>"  parent="abstractServer"&gt;         ##45行</p> 
<p style="margin-left:0;text-align:left;">                &lt;factoryConfig&gt;</p> 
<p style="margin-left:0;text-align:left;">                        &lt;!-- mysql ip --&gt;</p> 
<p style="margin-left:0;text-align:left;">                        &lt;property name="ipAddress"&gt;<span style="color:#FF0000;">192.168.1.101</span>&lt;/property&gt;            ##48行</p> 
<p style="margin-left:0;text-align:left;">                &lt;/factoryConfig&gt;</p> 
<p style="margin-left:0;text-align:left;">        &lt;/dbServer&gt;</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">        &lt;dbServer name="<span style="color:#FF0000;">slave1</span>"  parent="abstractServer"&gt;              ##52行</p> 
<p style="margin-left:0;text-align:left;">                &lt;factoryConfig&gt;</p> 
<p style="margin-left:0;text-align:left;">                        &lt;!-- mysql ip --&gt;</p> 
<p style="margin-left:0;text-align:left;">                        &lt;property name="ipAddress"&gt;<span style="color:#FF0000;">192.168.1.102</span>&lt;/property&gt;               ##55行</p> 
<p style="margin-left:0;text-align:left;">                &lt;/factoryConfig&gt;</p> 
<p style="margin-left:0;text-align:left;">        &lt;/dbServer&gt;</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">        &lt;dbServer name="<span style="color:#FF0000;">slave2</span>"  parent="abstractServer"&gt;</p> 
<p style="margin-left:0;text-align:left;">                &lt;factoryConfig&gt;</p> 
<p style="margin-left:0;text-align:left;">                        &lt;!-- mysql ip --&gt;</p> 
<p style="margin-left:0;text-align:left;">                        &lt;property name="ipAddress"&gt;<span style="color:#FF0000;">192.168.1.103</span>&lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;">                &lt;/factoryConfig&gt;</p> 
<p style="margin-left:0;text-align:left;">        &lt;/dbServer&gt;</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">        &lt;dbServer name="<span style="color:#FF0000;">slaves</span>" virtual="true"&gt;                    ##59行</p> 
<p style="margin-left:0;text-align:left;">                &lt;poolConfig class="com.meidusa.amoeba.server.MultipleServerPool"&gt;</p> 
<p style="margin-left:0;text-align:left;">                        &lt;!-- Load balancing strategy: 1=ROUNDROBIN , 2=WEIGHTBASED , 3=HA--&gt;</p> 
<p style="margin-left:0;text-align:left;">                        &lt;property name="loadbalance"&gt;1&lt;/property&gt;</p> 
<p style="margin-left:0;text-align:left;">                        &lt;!-- Separated by commas,such as: server1,server2,server1 --&gt;</p> 
<p style="margin-left:0;text-align:left;">                        &lt;property name="poolNames"&gt;<span style="color:#FF0000;">slave1,slave2</span>&lt;/property&gt;          ##65行</p> 
<p style="margin-left:0;text-align:left;">                &lt;/poolConfig&gt;</p> 
<p style="margin-left:0;text-align:left;">        &lt;/dbServer&gt;</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（4）启动amoeba软件</h5> 
<p style="margin-left:0;text-align:left;">[root@localhost ~]# cd /usr/local/amoeba/</p> 
<p style="margin-left:0;text-align:left;">[root@localhost amoeba]# bin/amoeba start&amp;</p> 
<p style="margin-left:0;text-align:justify;">注：当在前台运行某个作业时,终端被该作业占据;而在后台运行作业时,它不会占据终端。可以使用&amp;命令把作业放到后台执行</p> 
<p style="margin-left:0;text-align:left;">[root@localhost amoeba]# netstat -anpt | grep java</p> 
<p style="margin-left:0;text-align:left;">如果能看到8066和3306两个端口号，证明amoeba是正常开启的。</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h4 style="margin-left:0px;text-align:left;">测试</h4> 
<h5 style="margin-left:0px;text-align:left;">（1）：在client上</h5> 
<p style="margin-left:0;text-align:left;">[root@localhost yum.repos.d]# yum -y install mariadb</p> 
<p style="margin-left:0;text-align:left;">[root@localhost yum.repos.d]# mysql -u amoeba -p 123456 -h 192.168.10.104 -P 8066</p> 
<p style="margin-left:0;text-align:left;">Enter password:            ##密码：123456</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（2）：在master服务器上创建表</h5> 
<p style="margin-left:0;text-align:left;">mysql&gt; stop slave;</p> 
<p style="margin-left:0;text-align:left;">MySQL [test]&gt; use auth</p> 
<p style="margin-left:0;text-align:left;">MySQL [auth]&gt; create table users (id int(10),name char(20));</p> 
<h5 style="margin-left:0px;text-align:left;">（3）：在两个slave服务器上</h5> 
<p style="margin-left:0;text-align:left;">mysql&gt; stop slave;</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（4）：在master服务器上</h5> 
<p style="margin-left:0;text-align:left;">mysql&gt; insert into users values ('1','zhangsan');</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（5）：在slave1上</h5> 
<p style="margin-left:0;text-align:left;">mysql&gt; use auth;</p> 
<p style="margin-left:0;text-align:left;">mysql&gt;insert into zang values ('2','zhangsan');</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（6）：在slave2上</h5> 
<p style="margin-left:0;text-align:left;">mysql&gt; use auth;</p> 
<p style="margin-left:0;text-align:left;">mysql&gt;insert into zang values ('3','zhangsan);</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（7）：在client上查询三次</h5> 
<p style="margin-left:0;text-align:left;">mysql&gt; use auth;</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; select * from users;</p> 
<p style="margin-left:0;text-align:left;">对比三次的输出，验证读操作，发现没有在master写入的数据，而slave上写的能查到</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（8）：在client上</h5> 
<p style="margin-left:0;text-align:left;">mysql&gt; use auth;</p> 
<p style="margin-left:0;text-align:left;">mysql&gt;insert into users values ('4','zhangsan');</p> 
<p style="margin-left:0;text-align:left;">mysql&gt; select * from users;      ##发现在client上查询不到自己写的数据</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（9）：在master上</h5> 
<p style="margin-left:0;text-align:left;">mysql&gt; select * from users;      ##能查到在client上写入的数据，说明写操作在master上</p> 
<p style="margin-left:0;text-align:left;"></p> 
<h5 style="margin-left:0px;text-align:left;">（10）：在slave上</h5> 
<p style="margin-left:0;text-align:left;">mysql&gt; select * from users;       ##发现没有数据，说明写入的操作是在master上</p> 
<p style="margin-left:0;text-align:left;"></p> 
<p style="margin-left:0;text-align:left;">导出导入数据库：</p> 
<p style="margin-left:0;text-align:justify;">[root@localhost ~]# mysqldump -u root -p --database auth &gt; /opt/auth.sql      </p> 
<p style="margin-left:0;text-align:justify;">[root@localhost data]# mysql -u root -p &lt; /opt/ auth.sql</p> 
<h5></h5>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9cec4cba8b36b0838e2d493de78b79c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ollama，springAi实现自然语言处理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9fb8a3ae8123fc8af9add3230785d27d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">怎样把热门抖音短视频下载保存到手机相册?</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>