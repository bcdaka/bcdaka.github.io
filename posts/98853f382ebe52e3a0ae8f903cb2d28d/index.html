<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【安全】Java幂等性校验解决重复点击（6种实现方式） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/98853f382ebe52e3a0ae8f903cb2d28d/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【安全】Java幂等性校验解决重复点击（6种实现方式）">
  <meta property="og:description" content="目录 一、简介1.1 什么是幂等？1.2 为什么需要幂等性？1.3 接口超时，应该如何处理？1.4 幂等性对系统的影响 二、Restful API 接口的幂等性三、实现方式3.1 数据库层面，主键/唯一索引冲突3.2 数据库层面，乐观锁3.3 数据库层面，悲观锁（select for update）【不推荐】3.4 数据库层面，状态机3.5 应用层面，token令牌【不推荐】3.6 应用层面，分布式锁【推荐】 四、Java 代码实现4.1 @NotRepeat 注解4.2 AOP 切面4.3 RedisUtils 工具类4.4 测试类4.5 测试结果 一、简介 1.1 什么是幂等？ 幂等 是一个数学与计算机科学概念，英文 idempotent [aɪˈdempətənt]。
在数学中，幂等用函数表达式就是：f(x) = f(f(x))。比如 求绝对值 的函数，就是幂等的，abs(x) = abs(abs(x))。计算机科学中，幂等表示一次和多次请求某一个资源应该具有同样的作用。 满足幂等条件的性能叫做 幂等性。
1.2 为什么需要幂等性？ 我们开发一个转账功能，假设我们调用下游接口 超时 了。一般情况下，超时可能是网络传输丢包的问题，也可能是请求时没送到，还有可能是请求到了，返回结果却丢了。这时候我们是否可以 重试 呢？如果重试的话，是否会多赚了一笔钱呢？
在我们日常开发中，会存在各种不同系统之间的相互远程调用。调用远程服务会有三个状态：成功、失败、超时。
前两者都是明确的状态，但超时则是 未知状态。我们转账 超时 的时候，如果下游转账系统做好 幂等性校验，我们判断超时后直接发起重试，既可以保证转账正常进行，又可以保证不会多转一笔。
日常开发中，需要考虑幂等性的场景：
前端重复提交：比如提交 form 表单时，如果快速点击提交按钮，就可能产生两条一样的数据。用户恶意刷单：例如在用户投票这种功能时，如果用户针对一个用户进行重复提交投票，这样会导致接口接收到用户重复提交的投票信息，会使投票结果与事实严重不符。接口超时重复提交：很多时候 HTTP 客户端工具都默认开启超时重试的机制，尤其是第三方调用接口的时候，为了防止网络波动等造成的请求失败，都会添加重试机制，导致一个请求提交多次。MQ重复消费：消费者读取消息时，有可能会读取到重复消息。 1.3 接口超时，应该如何处理？ 如果我们调用下游接口超时了，我们应该如何处理？其实从生产者和消费者两个角度来看，有两种方案处理：
方案一：消费者角度。在接口超时后，调用下游接口检查数据状态： 如果查询到是成功，就走成功流程；如果是失败，就按失败处理（重新请求）。 方案二：生产者角度。下游接口支持幂等，上有系统如果调用超时，发起重试即可。 两种方案都是可以的，但如果是 MQ重复消费的场景，方案一处理并不是很妥当，所以我们还是要求下游系统 对外接口支持幂等。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-11-04T15:14:00+08:00">
    <meta property="article:modified_time" content="2023-11-04T15:14:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【安全】Java幂等性校验解决重复点击（6种实现方式）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">一、简介</a></li><li><ul><li><a href="#11__3" rel="nofollow">1.1 什么是幂等？</a></li><li><a href="#12__12" rel="nofollow">1.2 为什么需要幂等性？</a></li><li><a href="#13__30" rel="nofollow">1.3 接口超时，应该如何处理？</a></li><li><a href="#14__48" rel="nofollow">1.4 幂等性对系统的影响</a></li></ul> 
   </li><li><a href="#Restful_API__57" rel="nofollow">二、Restful API 接口的幂等性</a></li><li><a href="#_72" rel="nofollow">三、实现方式</a></li><li><ul><li><a href="#31__74" rel="nofollow">3.1 数据库层面，主键/唯一索引冲突</a></li><li><a href="#32__109" rel="nofollow">3.2 数据库层面，乐观锁</a></li><li><a href="#33_select_for_update_140" rel="nofollow">3.3 数据库层面，悲观锁（select for update）【不推荐】</a></li><li><a href="#34__167" rel="nofollow">3.4 数据库层面，状态机</a></li><li><a href="#35_token_210" rel="nofollow">3.5 应用层面，token令牌【不推荐】</a></li><li><a href="#36__232" rel="nofollow">3.6 应用层面，分布式锁【推荐】</a></li></ul> 
   </li><li><a href="#Java__247" rel="nofollow">四、Java 代码实现</a></li><li><ul><li><a href="#41_NotRepeat__249" rel="nofollow">4.1 @NotRepeat 注解</a></li><li><a href="#42_AOP__269" rel="nofollow">4.2 AOP 切面</a></li><li><a href="#43_RedisUtils__360" rel="nofollow">4.3 RedisUtils 工具类</a></li><li><a href="#44__406" rel="nofollow">4.4 测试类</a></li><li><a href="#45__436" rel="nofollow">4.5 测试结果</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>一、简介</h3> 
<h4><a id="11__3"></a>1.1 什么是幂等？</h4> 
<p><code>幂等</code> 是一个数学与计算机科学概念，英文 idempotent [aɪˈdempətənt]。</p> 
<ul><li>在数学中，幂等用函数表达式就是：<code>f(x) = f(f(x))</code>。比如 <font color="blue">求绝对值</font> 的函数，就是幂等的，abs(x) = abs(abs(x))。</li><li>计算机科学中，幂等表示<font color="red">一次和多次请求某一个资源应该具有同样的作用</font>。</li></ul> 
<p>满足幂等条件的性能叫做 <code>幂等性</code>。</p> 
<h4><a id="12__12"></a>1.2 为什么需要幂等性？</h4> 
<blockquote> 
 <p>我们开发一个转账功能，假设我们调用下游接口 <strong>超时</strong> 了。一般情况下，超时可能是网络传输丢包的问题，也可能是请求时没送到，还有可能是请求到了，<strong>返回结果却丢了</strong>。这时候我们是否可以 <strong>重试</strong> 呢？如果重试的话，是否会多赚了一笔钱呢？</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/e2/a6/LKimvRG0_o.png" alt="在这里插入图片描述"></p> 
<p>在我们日常开发中，会存在各种不同系统之间的相互远程调用。调用远程服务会有三个状态：<code>成功</code>、<code>失败</code>、<code>超时</code>。</p> 
<p>前两者都是明确的状态，但超时则是 <strong>未知状态</strong>。我们转账 <strong>超时</strong> 的时候，如果下游转账系统做好 <strong>幂等性校验</strong>，我们判断超时后直接发起重试，<strong>既可以保证转账正常进行，又可以保证不会多转一笔</strong>。</p> 
<p><strong>日常开发中，需要考虑幂等性的场景：</strong></p> 
<ul><li><code>前端重复提交</code>：比如提交 form 表单时，如果快速点击提交按钮，就可能产生两条一样的数据。</li><li><code>用户恶意刷单</code>：例如在用户投票这种功能时，如果用户针对一个用户进行重复提交投票，这样会导致接口接收到用户重复提交的投票信息，会使投票结果与事实严重不符。</li><li><code>接口超时重复提交</code>：很多时候 HTTP 客户端工具都默认开启超时重试的机制，尤其是第三方调用接口的时候，为了防止网络波动等造成的请求失败，都会添加重试机制，导致一个请求提交多次。</li><li><code>MQ重复消费</code>：消费者读取消息时，有可能会读取到重复消息。</li></ul> 
<h4><a id="13__30"></a>1.3 接口超时，应该如何处理？</h4> 
<p>如果我们调用下游接口超时了，我们应该如何处理？其实从生产者和消费者两个角度来看，有两种方案处理：</p> 
<ul><li>方案一：消费者角度。在接口超时后，<strong>调用下游接口检查数据状态</strong>： 
  <ul><li>如果查询到是成功，就走成功流程；</li><li>如果是失败，就按失败处理（重新请求）。</li></ul> </li></ul> 
<p><img src="https://images2.imgbox.com/31/85/6FGG6d1c_o.png" alt="在这里插入图片描述"></p> 
<ul><li>方案二：生产者角度。<strong>下游接口支持幂等</strong>，上有系统如果调用超时，发起重试即可。</li></ul> 
<p><img src="https://images2.imgbox.com/05/cd/VZ7BUX8j_o.png" alt="在这里插入图片描述"></p> 
<p>两种方案都是可以的，但如果是 <strong>MQ重复消费的场景</strong>，方案一处理并不是很妥当，所以我们还是要求下游系统 <strong>对外接口支持幂等</strong>。</p> 
<h4><a id="14__48"></a>1.4 幂等性对系统的影响</h4> 
<p>幂等性是为了简化客户端逻辑处理，能防止重复提交等操作，但却增加了服务端的逻辑复杂性和成本，其主要是：</p> 
<ul><li>把并行执行的功能改为串行执行，降低了执行效率。</li><li>增加了额外控制幂等的业务逻辑，复杂化了业务功能。</li></ul> 
<p>在使用前，需要根据实际业务场景具体分析，除了业务上的特殊要求外，一般情况下不需要引入接口的幂等性。</p> 
<h3><a id="Restful_API__57"></a>二、Restful API 接口的幂等性</h3> 
<p>Restful 推荐的几种 HTTP 接口方法中，不同的请求对幂等性的要求不同：</p> 
<table><thead><tr><th>请求类型</th><th>是否幂等</th><th>描述</th></tr></thead><tbody><tr><td><strong>GET</strong></td><td><code>是</code></td><td>GET 方法用于获取资源。一般不会也不应当对系统资源进行改变，所以是幂等的。</td></tr><tr><td><strong>POST</strong></td><td><code>否</code></td><td>POST 方法用于创建新的资源。每次执行都会新增数据，所以不是幂等的。</td></tr><tr><td><strong>PUT</strong></td><td><code>不一定</code></td><td>PUT 方法一般用于修改资源。该操作分情况判断是否满足幂等，更新中直接根据某个值进行更新，也能保持幂等。不过执行累加操作的更新是非幂等的。</td></tr><tr><td><strong>DELETE</strong></td><td><code>不一定</code></td><td>DELETE 方法一般用于删除资源。该操作分情况判断是否满足幂等，当根据唯一值进行删除时，满足幂等；但是带查询条件的删除则不一定满足。例如：根据条件删除一批数据后，又有新增数据满足该条件，再执行就会将新增数据删除，需要根据业务判断是否校验幂等。</td></tr></tbody></table> 
<hr> 
<h3><a id="_72"></a>三、实现方式</h3> 
<h4><a id="31__74"></a>3.1 数据库层面，主键/唯一索引冲突</h4> 
<p>日常开发中，为了实现接口幂等性校验，可以这样实现：</p> 
<ol><li>提前在数据库中为唯一存在的字段（如：<strong>唯一流水号</strong> bizSeq 字段）添加唯一索引，或者直接设置为主键。</li><li>请求过来，直接将数据插入、更新到数据库中，并进行 <code>try-catch</code> 捕获。</li><li><strong>如果抛出异常，说明为重复请求</strong>，可以直接返回成功，或提示请求重复。</li></ol> 
<blockquote> 
 <p><strong>补充：</strong> 也可以新建一张 <strong>防止重复点击表</strong>，将唯一标识放到表中，存为主键或唯一索引，然后配合 tra-catch 对重复点击的请求进行处理。</p> 
</blockquote> 
<p>伪代码如下：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * 幂等处理
 */</span>
<span class="token class-name">Rsp</span> idempotent（<span class="token class-name">Request</span> req）<span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">insert</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DuplicateKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//拦截是重复请求，直接返回成功</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"主键冲突，是重复请求，直接返回成功，流水号：{}"</span><span class="token punctuation">,</span>bizSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//正常处理请求</span>
    <span class="token function">dealRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="32__109"></a>3.2 数据库层面，乐观锁</h4> 
<p><code>乐观锁</code>：乐观锁在操作数据时，非常乐观，认为别人不会同时在修改数据。因此乐观锁不会上锁，只是在执行更新的时候判断一下，在此期间是否有人修改了数据。</p> 
<p><strong>乐观锁的实现：</strong></p> 
<p>就是给表多加一列 version 版本号，每次更新数据前，先查出来确认下是不是刚刚的版本号，没有改动再去执行更新，并升级 version（version=version+1）。</p> 
<p>比如，我们更新前，先查一下数据，查出来的版本号是 version=1。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> order_id，version <span class="token keyword">from</span> <span class="token keyword">order</span> <span class="token keyword">where</span> order_id<span class="token operator">=</span><span class="token string">'666'</span>；
</code></pre> 
<p>然后使用 version=1 和 订单ID 一起作为条件，再去更新：</p> 
<pre><code class="prism language-sql"><span class="token keyword">update</span> <span class="token keyword">order</span> <span class="token keyword">set</span> version <span class="token operator">=</span> version <span class="token operator">+</span><span class="token number">1</span>，<span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'P'</span> <span class="token keyword">where</span>  order_id<span class="token operator">=</span><span class="token string">'666'</span> <span class="token operator">and</span> version <span class="token operator">=</span><span class="token number">1</span>
</code></pre> 
<p>最后，更新成功才可以处理业务逻辑，如果更新失败，默认为重复请求，直接返回。</p> 
<p><strong>流程图如下：</strong></p> 
<img src="https://images2.imgbox.com/83/22/A3H7rPYy_o.png" width="60%"> 
<p><strong>为什么版本号建议自增呢？</strong></p> 
<blockquote> 
 <p>因为乐观锁存在 ABA 的问题，如果 version 版本一直是自增的就不会出现 ABA 的情况。</p> 
</blockquote> 
<h4><a id="33_select_for_update_140"></a>3.3 数据库层面，悲观锁（select for update）【不推荐】</h4> 
<p><code>悲观锁</code>：通俗点讲就是很悲观，每次去操作数据时，都觉得别人中途会修改，所以每次在拿数据的时候都会上锁。官方点讲就是，共享资源每次只给一个线程使用，其他线程阻塞，用完后再把资源转让给其它资源。</p> 
<p><strong>悲观锁的实现：</strong></p> 
<blockquote> 
 <p>在订单业务场景中，假设先查询出订单，如果查到的是处理中状态，就处理完业务，然后再更新订单状态为完成。如果查到订单，并且不是处理中的状态，则直接返回。</p> 
</blockquote> 
<p>可以使用数据库悲观锁（select … for update）解决这个问题：</p> 
<pre><code class="prism language-sql"><span class="token keyword">begin</span><span class="token punctuation">;</span>  <span class="token comment"># 1.开始事务</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">order</span> <span class="token keyword">where</span> order_id<span class="token operator">=</span><span class="token string">'666'</span> <span class="token keyword">for</span> <span class="token keyword">update</span> <span class="token comment"># 查询订单，判断状态,锁住这条记录</span>
<span class="token keyword">if</span>（<span class="token keyword">status</span> <span class="token operator">!=</span>处理中）{
   <span class="token comment">//非处理中状态，直接返回；</span>
   <span class="token keyword">return</span> <span class="token punctuation">;</span>
}
<span class="token comment">## 处理业务逻辑</span>
<span class="token keyword">update</span> <span class="token keyword">order</span> <span class="token keyword">set</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token string">'完成'</span> <span class="token keyword">where</span> order_id<span class="token operator">=</span><span class="token string">'666'</span> <span class="token comment"># 更新完成</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span> <span class="token comment"># 5.提交事务</span>
</code></pre> 
<p>注意：</p> 
<ul><li><font color="red">这里的 order_id 需要是主键或索引，只用行级锁锁住这条数据即可，如果不是主键或索引，会锁住整张表。</font></li><li>悲观锁在同一事务操作过程中，锁住了一行数据。这样 <strong>别的请求过来只能等待</strong>，如果当前事务耗时比较长，就很影响接口性能。所以一般 <strong>不建议用悲观锁的实现方式</strong>。</li></ul> 
<h4><a id="34__167"></a>3.4 数据库层面，状态机</h4> 
<p>很多业务表，都是由状态的，比如：转账流水表，就会有 0-待处理，1-处理中，2-成功，3-失败的状态。转账流水更新的时候，都会涉及流水状态更新，即涉及 <strong>状态机（即状态变更图）</strong>。我们可以利用状态机来实现幂等性校验。</p> 
<p><strong>状态机的实现：</strong></p> 
<p>比如：转账成功后，把 <strong>处理中</strong> 的转账流水更新为成功的状态，SQL 如下：</p> 
<pre><code class="prism language-sql"><span class="token keyword">update</span> transfor_flow <span class="token keyword">set</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">where</span> biz_seq<span class="token operator">=</span><span class="token string">'666'</span> <span class="token operator">and</span> <span class="token keyword">status</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>流程图如下：</strong></p> 
<p><img src="https://images2.imgbox.com/4e/24/YZaQ5pCb_o.png" alt="在这里插入图片描述"></p> 
<ul><li>第1次请求来时，bizSeq 流水号是 666，该流水的状态是处理中，值是 1，要更新为 2-成功的状态，所以该 update 语句可以正常更新数据，sql 执行结果的影响行数是 1，流水状态最后变成了 2。</li><li>第2次请求也过来了，如果它的流水号还是 666，因为该流水状态已经变为 2-成功的状态，所以更新结果是0，不会再处理业务逻辑，接口直接返回。</li></ul> 
<p><strong>伪代码实现如下：</strong></p> 
<pre><code class="prism language-java"><span class="token class-name">Rsp</span> idempotentTransfer（<span class="token class-name">Request</span> req）<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> bizSeq <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getBizSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rows<span class="token operator">=</span> <span class="token string">"update transfr_flow set status=2 where biz_seq=#{bizSeq} and status=1;"</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rows<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>“更新成功<span class="token punctuation">,</span>可以处理该请求”<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//其他业务逻辑处理</span>
        <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>rows <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>“更新不成功，不处理该请求”<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//不处理，直接返回</span>
        <span class="token keyword">return</span> rsp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"数据异常"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> rsp：
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="35_token_210"></a>3.5 应用层面，token令牌【不推荐】</h4> 
<p>token 唯一令牌方案一般包括两个请求阶段：</p> 
<ol><li>客户端请求申请获取请求接口用的token，服务端生成token返回；</li><li>客户端带着token请求，服务端校验token。</li></ol> 
<p><strong>流程图如下：</strong></p> 
<p><img src="https://images2.imgbox.com/30/26/QE5m36JJ_o.png" alt="在这里插入图片描述"></p> 
<ol><li>客户端发送请求，申请获取 token。</li><li>服务端生成全局唯一的 token，保存到 redis 中（一般会设置一个过期时间），然后返回给客户端。</li><li>客户端带着 token，发起请求。</li><li>服务端去 redis 确认 token 是否存在，一般用 <code>redis.del(token)</code> 的方式，如果存在会删除成功，即处理业务逻辑，如果删除失败，则直接返回结果。</li></ol> 
<blockquote> 
 <p><strong>补充：</strong> 这种方式个人不推荐，说两方面原因：</p> 
 <ol><li>需要前后端联调才能实现，存在沟通成本，最终效果可能与设想不一致。</li><li>如果前端多次获取多个 token，还是可以重复请求的，如果再在获取 token 处加分布式锁控制，就不如直接用分布式锁来控制幂等性了，即下面这种解决方式。</li></ol> 
</blockquote> 
<h4><a id="36__232"></a>3.6 应用层面，分布式锁【推荐】</h4> 
<p><code>分布式锁</code> 实现幂等性的逻辑就是，请求过来时，先去尝试获取分布式锁，如果获取成功，就执行业务逻辑，反之获取失败的话，就舍弃请求直接返回成功。</p> 
<p><strong>流程图如下：</strong></p> 
<img src="https://images2.imgbox.com/79/52/YlvKhSC5_o.png" width="60%"> 
<ul><li>分布式锁可以使用 Redis，也可以使用 Zookeeper，不过 Redis 相对好点，比较轻量级。</li><li>Redis 分布式锁，可以使用 <code>setIfAbsent()</code> 来实现，<font color="red">注意分布式锁的 key 必须为业务的唯一标识</font>。</li><li>Redis 执行设置 key 的动作时，要设置过期时间，防止释放锁失败。这个过期时间不能太短，太短拦截不了重复请求，也不能设置太长，请求量多的话会占用存储空间。</li></ul> 
<hr> 
<h3><a id="Java__247"></a>四、Java 代码实现</h3> 
<h4><a id="41_NotRepeat__249"></a>4.1 @NotRepeat 注解</h4> 
<p>@NotRepeat 注解用于修饰需要进行幂等性校验的类。</p> 
<p><strong>NotRepeat.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 幂等性校验注解
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">NotRepeat</span> <span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="42_AOP__269"></a>4.2 AOP 切面</h4> 
<p>AOP切面监控被 @Idempotent 注解修饰的方法调用，实现幂等性校验逻辑。</p> 
<p><strong>IdempotentAOP.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">RedisUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">JoinPoint</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">After</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Aspect</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Before</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>aspectj<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Pointcut</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 重复点击校验
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentAOP</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">/** Redis前缀 */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token constant">API_IDEMPOTENT_CHECK</span> <span class="token operator">=</span> <span class="token string">"API_IDEMPOTENT_CHECK:"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisUtils</span> redisUtils<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 定义切面
     */</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"@annotation(com.demo.annotation.NotRepeat)"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notRepeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 在接口原有的方法执行前，将会首先执行此处的代码
     */</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">"notRepeat()"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doBefore</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 登录后才做校验</span>
        <span class="token class-name">UserInfo</span> loginUser <span class="token operator">=</span> <span class="token class-name">AuthUtil</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">assert</span> uri <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> uri<span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 【IDEMPOTENT】开始幂等性校验，加锁，account: {}，uri: {}"</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 加分布式锁</span>
            <span class="token keyword">boolean</span> lockSuccess <span class="token operator">=</span> redisUtils<span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token constant">API_IDEMPOTENT_CHECK</span> <span class="token operator">+</span> key<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 【IDEMPOTENT】分布式锁是否加锁成功:{}"</span><span class="token punctuation">,</span> lockSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lockSuccess<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"contract/saveDraftContract"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 【IDEMPOTENT】文件保存中，请稍后"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"文件保存中，请稍后"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>uri<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"contract/saveContract"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 【IDEMPOTENT】文件发起中，请稍后"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"文件发起中，请稍后"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 在接口原有的方法执行后，都会执行此处的代码（final）
     */</span>
    <span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">"notRepeat()"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAfter</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 释放锁</span>
        <span class="token class-name">String</span> uri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> uri <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">UserInfo</span> loginUser <span class="token operator">=</span> <span class="token class-name">SysUserUtil</span><span class="token punctuation">.</span><span class="token function">getloginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> uri<span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 【IDEMPOTENT】幂等性校验结束，释放锁，account: {}，uri: {}"</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getAccount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
            redisUtils<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token constant">API_IDEMPOTENT_CHECK</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="43_RedisUtils__360"></a>4.3 RedisUtils 工具类</h4> 
<p><strong>RedisUtils.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>


<span class="token comment">/**
 * redis工具类
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisUtils</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 默认RedisObjectSerializer序列化
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 加分布式锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 释放锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keys <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> keys<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//将参数key转为集合</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="44__406"></a>4.4 测试类</h4> 
<p><strong>OrderController.java</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">NotRepeat</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 幂等性校验测试类
 */</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/order"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@NotRepeat</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/orderList"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">orderList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 查询列表</span>
        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"Order_A"</span><span class="token punctuation">,</span> <span class="token string">"Order_B"</span><span class="token punctuation">,</span> <span class="token string">"Order_C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// throw new RuntimeException("参数错误");</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="45__436"></a>4.5 测试结果</h4> 
<p>请求地址：http://localhost:8080/order/orderList</p> 
<p>日志信息如下：</p> 
<p><img src="https://images2.imgbox.com/20/31/OUS9S6Wr_o.png" alt="在这里插入图片描述"></p> 
<p>经测试，加锁后，正常处理业务、抛出异常都可以正常释放锁。</p> 
<p>整理完毕，完结撒花~ 🌻</p> 
<p><br><br><br><br></p> 
<p>参考地址：</p> 
<p>1.实战，实现幂等的8种方案！https://blog.csdn.net/sufu1065/article/details/122335349</p> 
<p>2.Java中的幂等性，https://blog.csdn.net/JewaveOxford/article/details/103578372</p> 
<p>3.Spring Boot 实现接口幂等性的 4 种方案！还有谁不会？https://blog.csdn.net/youanyyou/article/details/114464708</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/55b7925d6cd94fb2dc514ec602db6a58/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">地理信息系统原理-空间数据结构（7）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1a2073f18db297f9183908d0e4dc640e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在hive插入数据时出现“Execution Error, return code 2 from org.apache.hadoop.hive.ql.exec.mr.MapRedTask”报错</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>