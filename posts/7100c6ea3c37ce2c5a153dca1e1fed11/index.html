<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nginx之正向代理配置示例和说明 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/7100c6ea3c37ce2c5a153dca1e1fed11/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Nginx之正向代理配置示例和说明">
  <meta property="og:description" content="一、NGINX正向代理功能简介 Nginx的正向代理功能允许局域网中的客户端通过代理服务器访问Internet资源。具体来说，Nginx作为一种流行的Web服务器和反向代理服务器，在正向代理方面的应用也相当实用。以下是其正向代理功能的几个关键点：
访问外部资源：在正向代理的配置下，Nginx作为代理服务器，帮助内部网络的用户访问外部互联网上的资源。安全性：通过正向代理，可以对内部用户的上网行为进行监控和管理，提高网络安全性。配置简便：客户端需要配置代理服务器的信息，以便通过Nginx访问指定网站。提高访问速度：代理服务器可以缓存经常访问的资源，从而提高后续请求的响应速度。隐藏客户端信息：正向代理可以隐藏客户端的真实IP地址，增加匿名性。负载均衡：虽然不直接属于正向代理的功能，但Nginx还可以用作负载均衡器，分散到多个服务器上，提高网站的可用性和稳定性。 博主将通过实验介绍nginx正向代理的配置和应用，实验环境说明如下：
操作系统：centos7.6nginx版本：1.26.0 二、NGINX正向代理配置 1、实验环境规划 实验环境规划如下，client和nginx server位于同一个局域网内，client无法之间访问外网，通过nginx server提供的正向代理访问互联网。
2、nginx server主机安装nginx [root@s76 yum.repos.d]# yum install -y nginx
…
[root@s76 yum.repos.d]# nginx -Version
nginx version: nginx/1.26.0
3、添加百度网站正向代理配置 [root@s76 conf.d]# cat test.conf server { listen 8888; # 监听端口 server_name localhost; #设置DNS解析器的地址为114.114.114.114，并且设置了解析器的缓存时间为300秒（这样每隔300s就会重新解析一次） resolver 114.114.114.114 valid=300 ipv6=off; resolver_timeout 3s; # 设置解析DNS的超时时间为3秒 proxy_read_timeout 30s;	#设置代理服务器读取超时时间，默认60s proxy_send_timeout 30s;	#该参数用于设置向后端服务器发送数据时的超时时间，默认60s proxy_connect_timeout 30s; #该参数用于设置与后端服务器建立连接时的超时时间，默认60s set $url &#34;www.baidu.com&#34;; #这里设置url变量指向百度 location / { proxy_pass http://$url; # 将请求转发到由 $url 变量表示的地址，如果目标网站服务是特定断开，可以使用http://$url:port方式 proxy_buffers 256 4K; # 设置用于缓存后端响应的缓冲区大小为256个，每个大小为4K。 proxy_max_temp_file_size 0; # 设置Nginx暂存响应数据的最大临时文件大小为0，即不使用临时文件。 proxy_cache_valid 200 302 1m; # 针对状态码为200和302的响应，设置缓存有效期为1分钟。 proxy_cache_valid 301 1h; # 针对状态码为301的响应，设置缓存有效期为1小时。 proxy_cache_valid any 1m; # 对于其他任何响应状态码，设置缓存有效期为1分钟。 } } 4、热加载nginx配置 [root@s76 conf.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-10T23:12:37+08:00">
    <meta property="article:modified_time" content="2024-06-10T23:12:37+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nginx之正向代理配置示例和说明</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="NGINX_0"></a>一、NGINX正向代理功能简介</h2> 
<p>  Nginx的正向代理功能<strong>允许局域网中的客户端通过代理服务器访问Internet资源</strong>。具体来说，Nginx作为一种流行的Web服务器和反向代理服务器，在正向代理方面的应用也相当实用。以下是其正向代理功能的几个关键点：</p> 
<ol><li><strong>访问外部资源</strong>：在正向代理的配置下，Nginx作为代理服务器，帮助内部网络的用户访问外部互联网上的资源。</li><li><strong>安全性</strong>：通过正向代理，可以对内部用户的上网行为进行监控和管理，提高网络安全性。</li><li><strong>配置简便</strong>：客户端需要配置代理服务器的信息，以便通过Nginx访问指定网站。</li><li><strong>提高访问速度</strong>：代理服务器可以缓存经常访问的资源，从而提高后续请求的响应速度。</li><li><strong>隐藏客户端信息</strong>：正向代理可以隐藏客户端的真实IP地址，增加匿名性。</li><li><strong>负载均衡</strong>：虽然不直接属于正向代理的功能，但Nginx还可以用作负载均衡器，分散到多个服务器上，提高网站的可用性和稳定性。</li></ol> 
<p>  博主将通过实验介绍nginx正向代理的配置和应用，实验环境说明如下：</p> 
<ul><li>操作系统：centos7.6</li><li>nginx版本：1.26.0</li></ul> 
<h2><a id="NGINX_13"></a>二、NGINX正向代理配置</h2> 
<h3><a id="1_14"></a>1、实验环境规划</h3> 
<p>  实验环境规划如下，client和nginx server位于同一个局域网内，client无法之间访问外网，通过nginx server提供的正向代理访问互联网。<br> <img src="https://images2.imgbox.com/87/78/D1kF57qx_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2nginx_servernginx_17"></a>2、nginx server主机安装nginx</h3> 
<blockquote> 
 <p>[root@s76 yum.repos.d]# yum install -y nginx<br> …<br> [root@s76 yum.repos.d]# nginx -Version<br> nginx version: nginx/1.26.0</p> 
</blockquote> 
<h3><a id="3_22"></a>3、添加百度网站正向代理配置</h3> 
<pre><code>[root@s76 conf.d]# cat test.conf
server {
        listen 8888;   # 监听端口
        server_name localhost;

        #设置DNS解析器的地址为114.114.114.114，并且设置了解析器的缓存时间为300秒（这样每隔300s就会重新解析一次）
        resolver 114.114.114.114 valid=300 ipv6=off;
        resolver_timeout 3s;    # 设置解析DNS的超时时间为3秒

        proxy_read_timeout 30s;		#设置代理服务器读取超时时间，默认60s
        proxy_send_timeout 30s;		#该参数用于设置向后端服务器发送数据时的超时时间，默认60s
        proxy_connect_timeout 30s;  #该参数用于设置与后端服务器建立连接时的超时时间，默认60s

        set $url "www.baidu.com";       #这里设置url变量指向百度
        location / {
                proxy_pass http://$url; # 将请求转发到由 $url 变量表示的地址，如果目标网站服务是特定断开，可以使用http://$url:port方式
                proxy_buffers 256 4K;           # 设置用于缓存后端响应的缓冲区大小为256个，每个大小为4K。
                proxy_max_temp_file_size 0;     # 设置Nginx暂存响应数据的最大临时文件大小为0，即不使用临时文件。
                proxy_cache_valid 200 302 1m;   # 针对状态码为200和302的响应，设置缓存有效期为1分钟。
                proxy_cache_valid 301 1h;       # 针对状态码为301的响应，设置缓存有效期为1小时。
                proxy_cache_valid any 1m;       # 对于其他任何响应状态码，设置缓存有效期为1分钟。
         }
}
</code></pre> 
<h3><a id="4nginx_48"></a>4、热加载nginx配置</h3> 
<blockquote> 
 <p>[root@s76 conf.d]# nginx -t<br> nginx: the configuration file /etc/nginx/nginx.conf syntax is ok<br> nginx: configuration file /etc/nginx/nginx.conf test is successful<br> [root@s76 conf.d]# nginx -s reload</p> 
</blockquote> 
<h3><a id="5client_53"></a>5、禁止client访问外网</h3> 
<p>  博主这里采用的是去掉DNS参数配置，模拟client主机无法访问互联网网站。</p> 
<blockquote> 
 <p>[root@localhost]~# vim /etc/resolv.conf<br> [root@localhost]~# ping www.baidu.com<br> ping: unknown host www.baidu.com<br> [root@localhost]~# curl -I http://www.baidu.com<br> curl: (6) Couldn’t resolve host ‘www.baidu.com’</p> 
</blockquote> 
<h3><a id="6clientnginx_60"></a>6、client通过nginx正向代理访问百度</h3> 
<p>  如下验证结果所示，client终端本来无法访问百度，通过局域网nginx正向代理地址实现了访问百度网站的需求。<br> <img src="https://images2.imgbox.com/47/38/zYZcYyOk_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="7_63"></a>7、添加访问日志记录</h3> 
<p>  添加access_log参数，记录访问日志，重新热加载配置，访问记录日志就会被记录下来。这就是nginx正向代理的主要用途，用于严格管控和审计需要严格限制访问外网的终端用户。但是这种方式有一个大弊端，就是如果有多个网站都需要单独配置，配置就多而繁琐。对于https访问支持也不友好。</p> 
<blockquote> 
 <p>[root@s76 conf.d]# cat test.conf<br> …<br> access_log /var/log/nginx/test.access.log;<br> …<br> <img src="https://images2.imgbox.com/73/0f/2QEGlAzU_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f4/98/CiCfy6zm_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h2><a id="NGINX_72"></a>二、NGINX正向代理插件安装和使用</h2> 
<h3><a id="1nginx_73"></a>1、下载nginx源码文件</h3> 
<p>  我们已经通过yum安装了nginx，安装正向代理插件ngx_http_proxy_connect_module模块，我们需要下载源码文件，将插件模块通过编译添加到nginx中。下载并解压软件包。该插件最新支持版本为1.25.x，所以我们下周上一个稳定版本。</p> 
<blockquote> 
 <p>[root@s76 opt]# wget https://nginx.org/download/nginx-1.25.5.tar.gz<br> …<br> [root@s76 opt]# tar -zxvf nginx-1.25.5.tar.gz</p> 
</blockquote> 
<h3><a id="2ngx_http_proxy_connect_module_78"></a>2、下载ngx_http_proxy_connect_module模块</h3> 
<blockquote> 
 <p>[root@s76 opt]# wget --no-check-certificate https://github.com/chobits/ngx_http_proxy_connect_module/archive/refs/heads/master.zip<br> …<br> [root@s76 opt]# unzip master.zip<br> …</p> 
</blockquote> 
<h3><a id="3_83"></a>3、打补丁</h3> 
<blockquote> 
 <p>[root@s76 nginx-1.25.5]# patch -p1 &lt; /opt/ngx_http_proxy_connect_module-master/patch/proxy_connect.patch<br> …</p> 
</blockquote> 
<h3><a id="4_86"></a>4、安装依赖包</h3> 
<blockquote> 
 <p>[root@s76 nginx-1.25.5]# yum install -y pcre pcre-devel openssl-devel</p> 
</blockquote> 
<h3><a id="5configure_88"></a>5、执行configure</h3> 
<pre><code>[root@s76 nginx-1.25.5]# ./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC' --with-ld-opt='-Wl,-z,relro -Wl,-z,now -pie' --add-dynamic-module='/opt/ngx_http_proxy_connect_module'
</code></pre> 
<h3><a id="6make_92"></a>6、执行make</h3> 
<blockquote> 
 <p>[root@s76 nginx-1.25.5]# make<br> …<br> make[1]: Leaving directory `/opt/nginx-1.25.5’</p> 
</blockquote> 
<h3><a id="7nginx_96"></a>7、验证nginx版本</h3> 
<p><img src="https://images2.imgbox.com/b9/5a/crvAl1az_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="8nginx_98"></a>8、替换nginx二进制文件</h3> 
<blockquote> 
 <p>[root@s76 nginx-1.25.5]# make install<br> …</p> 
</blockquote> 
<h3><a id="9nginx_101"></a>9、重新启动nginx</h3> 
<blockquote> 
 <p>[root@s76 nginx-1.25.5]# systemctl start nginx</p> 
</blockquote> 
<h3><a id="10nginx_103"></a>10、nginx配置文件加载正向代理插件模块</h3> 
<p>  我们可以通过nginx -V查看modules的文件路径，这里博主实验证明需要make install才会生成.so文件，有些博文说的替换二进制文件的时候modules目录下是空的。make install的时候在日志记录中可以看到生成文件目录位置信息。</p> 
<blockquote> 
 <p>[root@s76 conf.d]# ll /usr/lib64/nginx/modules/<br> total 176<br> -rwxr-xr-x. 1 root root 178736 May 13 09:22 ngx_http_proxy_connect_module.so<br> [root@s76 conf.d]# cat /etc/nginx/nginx.conf<br> #配置文件最外层添加如下行<br> load_module /usr/lib64/nginx/modules/ngx_http_proxy_connect_module.so;</p> 
</blockquote> 
<h3><a id="11_111"></a>11、添加正向代理配置</h3> 
<pre><code>[root@s76 conf.d]# cat zxdl.conf 
# 参考https://github.com/chobits/ngx_http_proxy_connect_module
server {
     listen 9090;
     resolver 114.114.114.114 valid=60s ipv6=off;
     resolver_timeout 30s;
     proxy_connect ;
     proxy_connect_allow            443 80;
     proxy_connect_connect_timeout  10s;
     proxy_connect_read_timeout     10s;
     proxy_connect_send_timeout     10s;
     location / {
         proxy_pass $scheme://$http_host$request_uri;
         proxy_set_header Host $host;
         proxy_http_version  1.1;
         proxy_ssl_server_name on;
     }
}
</code></pre> 
<h3><a id="12nginx_132"></a>12、验证配置并重新加载nginx配置</h3> 
<blockquote> 
 <p>[root@s76 conf.d]# nginx -t<br> nginx: the configuration file /etc/nginx/nginx.conf syntax is ok<br> nginx: configuration file /etc/nginx/nginx.conf test is successful<br> [root@s76 conf.d]# nginx -s reload</p> 
</blockquote> 
<h3><a id="13http_137"></a>13、客户端设置http代理</h3> 
<blockquote> 
 <p>[root@localhost]~# export http_proxy=‘192.168.10.76:9090’<br> [root@localhost]~# export https_proxy=‘192.168.10.76:9090’</p> 
</blockquote> 
<h3><a id="14_140"></a>14、代理上网验证</h3> 
<p>  如下图所示该终端本来是无法访问互联网的，通过nginx的正向代理就实现了代理上网的需求。通过这个代理插件不仅可以访问百度还可以访问任意http和https网站。博主这里是通过取消DNS配置模拟无法上网，这种情况下yum安装是无法正常使用的，但是在配置了http_proxy之后我们就可以通过nginx的正向代理正常使用yum安装软件包了。<br> <img src="https://images2.imgbox.com/bf/16/Or1XlqEH_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="QA_143"></a>四、QA</h2> 
<h3><a id="1configure_144"></a>1、执行configure的时候报错</h3> 
<ul><li>报错信息：./configure: error: no =/opt/ngx_http_proxy_connect_module/config was found</li><li>报错原因：命令中多了一个“=”符号</li><li>解决方案：修改参数为–add-dynamic-module=‘/opt/ngx_http_proxy_connect_module’</li></ul> 
<h3><a id="2configure_148"></a>2、执行configure的时候报错</h3> 
<ul><li>报错信息：./configure: error: the HTTP rewrite module requires the PCRE library.</li><li>报错原因：系统未安装pcre依赖包</li><li>解决方案：执行yum install -y pcre pcre-devel安装pcre依赖包</li></ul> 
<h3><a id="3configure_152"></a>3、执行configure的时候报错</h3> 
<ul><li>报错信息：./configure: error: SSL modules require the OpenSSL library.</li><li>报错原因：未安装openssl库</li><li>解决方案：执行yum install -y openssl-devel安装openssl库</li></ul> 
<h2><a id="_157"></a>五、总结</h2> 
<p>  其实不管是正向代理还是反向代理，代理的都是浏览器和真实服务器之间的流量，正向代理代理的是内部服务器出去的流量，客户端或者浏览器都通过nginx这个中间节点后访问互联网上真实服务器，这就是正向代理。互联网的终端或者浏览器通过nginx这个中间节点流量转发和访问控制确定最终访问的内部服务这就是反向代理。白话文来说正向代理和反向代理就是一个流量方向的不同，正向代理是出向的流量代理，反向代理是入向的流量代理。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bc43ee7c4fc6160947e482922a5d7fbe/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C语言详解（文件操作）1</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1b1bea6af0ffe2b9539787ced756621e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">用人工智能写2024年高考作文</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>