<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>rabbitmq高可用集群搭建 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/e860cf2cefeba8b6cc4521177fa5f15e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="rabbitmq高可用集群搭建">
  <meta property="og:description" content="需求分析基本情况 在进行RabbitMQ搭建时，我们基于现有的连接数据和业务需求进行了深入分析。目前的统计数据显示，连接数为631，队列数为80418。为了确保业务需求的顺利满足，我们需要在云产品和自建RabbitMQ消息队列服务之间做出选择。
经过比较发现，即使选择腾讯云的最高规格配置，其Queue数也难以满足我们的需求，并且成本相对较高。因此，我们决定搭建自建服务。为此，计划使用三台配置为8核 16GB 100GB 5Mbps / 标准型SA5的服务器节点，构建一个高可靠性集群，以确保系统的稳定性和可靠性。
腾讯云:
节点规格2核4G4核12G8核24G16核32G消息 TPS(生产&#43;消费)600~10002100~35004200~70009000~15000最大queue数量100200300800最大连接数500250040008000费用/月20283537693013434 自建服务:
序号节点1节点2节点3费用/月业务新选型8核 16GB 100GB 5Mbps /标准型SA58核 16GB 100GB 5Mbps /标准型SA58核 16GB 100GB 5Mbps /标准型SA52485.2 需求变动:
前期功能业务体谅小基于目前的现状考虑，并且不影响未来的扩容的情况下的方案节点规格收容 4核8G内150GB硬(50G系统盘&#43;100G数据盘)/标准型SA5,以及搭建实现和优化需求：
1、 集群建设
2、 实现高可用
3、 节点只运行rabbitmq,所以内存阀值调制总在比的70%
rabbimtmq集群搭建 系统均使用CentOS7.9
节点名称节点IPrabbitmq版本docker/compose规格数据盘pos_rabbitmq_1172.17.80.273.8-manageme18.03.1/1.29.24核8G50GB100GBpos_rabbitmq_2172.17.80.323.8-manageme18.03.1/1.29.24核8G50GB100GBpos_rabbitmq_1172.17.80.63.8-manageme18.03.1/1.29.24核8G50GB100GB 腾讯云申请三台实例节点 初始化三台实例主机 hostnamectl set-hostname POS_Rabbitmq_1 bash init.sh init.sh 脚步内容,腾讯云内置了自己的yum源,可以不需要替换
yum clean all &amp;&amp; yum makecache yum install telnet curl wget lrzsz net-tools vim unzip zip htop tree -y echo &#34;=====系统环境初始化脚本=====&#34; echo &#34;1.关闭防火墙与SELinux&#34; systemctl stop firewalld systemctl disable firewalld setenforce 0 sed -i &#39;/SELINUX/{s/enforcing/disabled/}&#39; /etc/selinux/config echo &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-03T15:41:26+08:00">
    <meta property="article:modified_time" content="2024-09-03T15:41:26+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">rabbitmq高可用集群搭建</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_0"></a><strong>需求分析基本情况</strong></h4> 
<p>在进行RabbitMQ搭建时，我们基于现有的连接数据和业务需求进行了深入分析。目前的统计数据显示，连接数为631，队列数为80418。为了确保业务需求的顺利满足，我们需要在云产品和自建RabbitMQ消息队列服务之间做出选择。</p> 
<p>经过比较发现，即使选择腾讯云的最高规格配置，其Queue数也难以满足我们的需求，并且成本相对较高。因此，我们决定搭建自建服务。为此，计划使用三台配置为<code>8核 16GB 100GB 5Mbps / 标准型SA5</code>的服务器节点，构建一个高可靠性集群，以确保系统的稳定性和可靠性。<br> 腾讯云:</p> 
<table><thead><tr><th>节点规格</th><th>2核4G</th><th>4核12G</th><th>8核24G</th><th>16核32G</th></tr></thead><tbody><tr><td>消息 TPS(生产+消费)</td><td>600~1000</td><td>2100~3500</td><td>4200~7000</td><td>9000~15000</td></tr><tr><td>最大queue数量</td><td>100</td><td>200</td><td>300</td><td>800</td></tr><tr><td>最大连接数</td><td>500</td><td>2500</td><td>4000</td><td>8000</td></tr><tr><td>费用/月</td><td>2028</td><td>3537</td><td>6930</td><td>13434</td></tr></tbody></table> 
<p>自建服务:</p> 
<table><thead><tr><th>序号</th><th>节点1</th><th>节点2</th><th>节点3</th><th>费用/月</th></tr></thead><tbody><tr><td>业务新选型</td><td>8核 16GB 100GB 5Mbps /标准型SA5</td><td>8核 16GB 100GB 5Mbps /标准型SA5</td><td>8核 16GB 100GB 5Mbps /标准型SA5</td><td>2485.2</td></tr></tbody></table> 
<p>需求变动:<br> 前期功能业务体谅小基于目前的现状考虑，并且不影响未来的扩容的情况下的方案节点规格收容 <code>4核8G内150GB硬(50G系统盘+100G数据盘)/标准型SA5</code>,以及搭建实现和优化需求：<br> 1、 集群建设<br> 2、 实现高可用<br> 3、 节点只运行rabbitmq,所以内存阀值调制总在比的70%</p> 
<h4><a id="rabbimtmq_25"></a><strong>rabbimtmq集群搭建</strong></h4> 
<p>系统均使用CentOS7.9</p> 
<table><thead><tr><th>节点名称</th><th>节点IP</th><th>rabbitmq版本</th><th>docker/compose</th><th>规格</th><th>数据盘</th></tr></thead><tbody><tr><td>pos_rabbitmq_1</td><td>172.17.80.27</td><td>3.8-manageme</td><td>18.03.1/1.29.2</td><td>4核8G50GB</td><td>100GB</td></tr><tr><td>pos_rabbitmq_2</td><td>172.17.80.32</td><td>3.8-manageme</td><td>18.03.1/1.29.2</td><td>4核8G50GB</td><td>100GB</td></tr><tr><td>pos_rabbitmq_1</td><td>172.17.80.6</td><td>3.8-manageme</td><td>18.03.1/1.29.2</td><td>4核8G50GB</td><td>100GB</td></tr></tbody></table> 
<h5><a id="_33"></a>腾讯云申请三台实例节点</h5> 
<p><img src="https://images2.imgbox.com/0d/d5/naIrJSsF_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b4/ca/tCG9uYEO_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_38"></a>初始化三台实例主机</h5> 
<pre><code class="prism language-shell">hostnamectl set-hostname POS_Rabbitmq_1
<span class="token function">bash</span> init.sh
</code></pre> 
<p><a href="https://init.sh" rel="nofollow">init.sh</a> 脚步内容,腾讯云内置了自己的yum源,可以不需要替换</p> 
<pre><code class="prism language-shell">yum clean all <span class="token operator">&amp;&amp;</span> yum makecache
yum <span class="token function">install</span>  telnet <span class="token function">curl</span> <span class="token function">wget</span> lrzsz net-tools <span class="token function">vim</span> <span class="token function">unzip</span> <span class="token function">zip</span>  <span class="token function">htop</span> tree <span class="token parameter variable">-y</span> 

<span class="token builtin class-name">echo</span> <span class="token string">"=====系统环境初始化脚本====="</span>
<span class="token builtin class-name">echo</span> <span class="token string">"1.关闭防火墙与SELinux"</span>
systemctl stop firewalld
systemctl disable firewalld
setenforce <span class="token number">0</span>
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'/SELINUX/{s/enforcing/disabled/}'</span> /etc/selinux/config

<span class="token builtin class-name">echo</span> <span class="token string">"2.设置系统最大打开文件数"</span>
<span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">grep</span> <span class="token string">"* soft nofile 65535"</span> /etc/security/limits.conf <span class="token operator">&amp;&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/security/limits.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
* soft nofile 65535   #软限制
* hard nofile 65535   #硬限制
EOF</span>
<span class="token keyword">fi</span>

<span class="token builtin class-name">echo</span> <span class="token string">"3.系统内核优化"</span>
<span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
net.ipv4.tcp_syncookies = 1             #防范SYN洪水攻击，0为关闭
net.ipv4.tcp_max_tw_buckets = 20480     #此项参数可以控制TIME_WAIT套接字的最大数量，避免Squid服务器被大量的TIME_WAIT套接字拖死
net.ipv4.tcp_max_syn_backlog = 20480    #表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数
net.core.netdev_max_backlog = 262144    #每个网络接口 接受数据包的速率比内核处理这些包的速率快时，允许发送到队列的数据包的最大数目
net.ipv4.tcp_fin_timeout = 20           #FIN-WAIT-2状态的超时时间，避免内核崩溃
EOF</span>

<span class="token builtin class-name">echo</span> <span class="token string">"4.减少SWAP使用"</span>
<span class="token builtin class-name">echo</span> <span class="token string">"0"</span> <span class="token operator">&gt;</span> /proc/sys/vm/swappiness

<span class="token builtin class-name">echo</span> <span class="token string">"5.安装系统性能分析工具及其他"</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> gcc <span class="token function">make</span> autoconf <span class="token function">vim</span> sysstat net-tools iostat  lrzsz
</code></pre> 
<h5><a id="_81"></a>格式化数据磁盘</h5> 
<p>数据盘默认给的是一个空盘需要直接格式化在挂载,在对安全数据要求比较严苛的环境中可以组RAID,这里直接格式化挂载</p> 
<pre><code class="prism language-shell">mkfs.ext4 /dev/vdb 
<span class="token function">mount</span> /dev/vdb /data
<span class="token builtin class-name">echo</span> <span class="token string">"/dev/vdb /data ext4 defaults 0 0"</span> <span class="token operator">&gt;&gt;</span> /etc/fstab
<span class="token function">mount</span> <span class="token parameter variable">-a</span>

<span class="token function">mkdir</span> <span class="token parameter variable">-p</span>   /data/<span class="token punctuation">{<!-- --></span>apd,logs,prog,setup,backup,www<span class="token punctuation">}</span>
<span class="token function">tee</span>  /data/README.md <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
/data/
|-- apd         数据目录入口
|-- backup      数据缓存目录
|-- logs        日志目录
|-- prog        应用程序目录
|-- setup       程序下载目录
|-- www         网站的存放目录
EOF</span>
</code></pre> 
<h5><a id="dockercompose_103"></a>安装docker,compose</h5> 
<p>三台实例主机安装docker、docker-compose 版本18.03.1、1.29.2</p> 
<pre><code class="prism language-shell"><span class="token comment"># step 1: 安装必要的一些系统工具</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2 <span class="token function">git</span> <span class="token function">htop</span>

<span class="token comment"># Step 2: 添加软件源信息</span>
<span class="token function">sudo</span> yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

<span class="token comment"># Step 3</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s+download.docker.com+mirrors.aliyun.com/docker-ce+'</span> /etc/yum.repos.d/docker-ce.repo

<span class="token comment"># Step 4: 更新并安装Docker-CE</span>
<span class="token function">sudo</span> yum makecache fast
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> docker-ce-18.03.1.ce

<span class="token comment"># 安装指定版本的Docker-CE:</span>
<span class="token comment"># Step 1: 查找Docker-CE的版本:</span>
<span class="token comment"># yum list docker-ce.x86_64 --showduplicates | sort -r</span>
<span class="token comment"># Step2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.0.ce.1-1.el7.centos)</span>
<span class="token comment"># sudo yum -y install docker-ce-[VERSION]</span>

<span class="token comment"># Step 5: 设置开机自启并且启动docker服务</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> <span class="token function">docker</span>
</code></pre> 
<p>配置docker镜像加速器</p> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker
<span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
{
  "registry-mirrors": ["https://rbmo5xql.mirror.aliyuncs.com"],
  "log-driver":"json-file",
  "bip": "192.168.1.5/24",
  "log-opts": { "max-size": "50m", "max-file": "1" }
}
EOF</span>
 
systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl restart <span class="token function">docker</span>
</code></pre> 
<p>下载docker-compose</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> /data/setup

<span class="token function">wget</span> <span class="token parameter variable">-O</span>  https://github.com/docker/compose/releases/download/1.29.2/docker-compose-Linux-x86_64

<span class="token function">mv</span> docker-compose-Linux-x86_64  <span class="token function">docker-compose</span>

<span class="token function">chmod</span> +x <span class="token function">docker-compose</span> 

<span class="token function">cp</span> /data/setup/docker-compose /usr/local/bin/

<span class="token function">ln</span> <span class="token parameter variable">-sf</span> /usr/local/bin/docker-compose /usr/bin/docker-compose

<span class="token function">docker-compose</span> <span class="token parameter variable">-v</span>
<span class="token comment"># docker-compose version 1.29.2, build 5becea4c</span>
</code></pre> 
<h5><a id="rabbitmq_166"></a>部署rabbitmq集群</h5> 
<p>使用rabbitmq:3.8-management镜像,rabbitmq:3.8-management-apline包有高危漏洞<code>[hub.docker.com官网查询](https://hub.docker.com/_/rabbitmq/tags?page=&amp;page_size=&amp;ordering=&amp;name=3.8-managemen)</code><br> <img src="https://images2.imgbox.com/aa/41/HTRcgQnC_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="Step1_rabbitmq_171"></a>Step1 三台主机拉取rabbitmq镜像</h6> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@pos_rabbitmq_1 /data/setup/public/rabbitmq/mq_1<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">172.17</span>.80.27
<span class="token comment"># docker pull rabbitmq:3.8-management</span>

<span class="token punctuation">[</span>root@pos_rabbitmq_2 /data/setup/public/rabbitmq/mq_2<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">172.17</span>.80.32
<span class="token comment"># docker pull rabbitmq:3.8-management</span>

<span class="token punctuation">[</span>root@pos_rabbitmq_3 /data/setup/public/rabbitmq/mq_3<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">172.17</span>.80.6
<span class="token comment"># docker pull rabbitmq:3.8-management</span>
</code></pre> 
<h6><a id="Step2_cookie_184"></a>Step2 获取cookie</h6> 
<p>之前cookie可以在获取后写入<code>docker-comose_env</code>中定义,但是被该方法以被弃用,所以使用挂载的方式</p> 
<pre><code class="prism language-shell"><span class="token comment"># Step 2: 获取cookie</span>
<span class="token punctuation">[</span>root@pos_rabbitmq_3 /data/setup/public/rabbitmq/mq_3<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">172.17</span>.80.6
<span class="token comment"># cat &gt; rabbitmq-cookie.sh &lt;&lt; eof</span>
<span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> mq rabbitmq:3.8-management
<span class="token function">sleep</span> <span class="token number">10</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mq <span class="token function">cat</span> /var/lib/rabbitmq/.erlang.cookie <span class="token operator">&gt;</span> .erlang.cookie
<span class="token function">chmod</span> <span class="token number">600</span> .erlang.cookie
<span class="token function">docker</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> mq
<span class="token function">docker</span> volume prune
eof

<span class="token punctuation">[</span>root@pos_rabbitmq_3 /data/setup/public/rabbitmq/mq_3<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">172.17</span>.80.6
<span class="token comment"># sh rabbitmq-cookie.sh</span>
</code></pre> 
<h6><a id="Step3_rabbitmq_204"></a>Step3 rabbitmq搭建集群配置文件</h6> 
<p>不适用guest用户,使用节点模式加入集群,<code>rabbit@pos_rabbitmq_1</code>,在docker- compose中必须定义pos_rabbitmq_1映射IP,否则无法解析找不到节点</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@pos_rabbitmq_3 /data/setup/public/rabbitmq/mq_3<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">172.17</span>.80.6
<span class="token comment"># cat &gt; rabbitmq.conf &lt;&lt; eof</span>
loopback_users.guest <span class="token operator">=</span> <span class="token boolean">false</span>
listeners.tcp.default <span class="token operator">=</span> <span class="token number">5672</span>
cluster_formation.peer_discovery_backend <span class="token operator">=</span> rabbit_peer_discovery_classic_config
cluster_formation.classic_config.nodes.1 <span class="token operator">=</span> rabbit@pos_rabbitmq_1
cluster_formation.classic_config.nodes.2 <span class="token operator">=</span> rabbit@pos_rabbitmq_2
cluster_formation.classic_config.nodes.3 <span class="token operator">=</span> rabbit@pos_rabbitmq_3
eof
</code></pre> 
<h6><a id="Step4_dockercompose_220"></a>Step4 docker-compose</h6> 
<p>rabbitmq内存使用率默认占比总内存的<code>40%</code>,这里需要修改为<code>70%</code>,env中使用<code> RABBITMQ_VM_MEMORY_HIGH_WATERMARK</code>定义设置</p> 
<p>pos_rabbitmq_1 中docker-compose.yaml文件</p> 
<pre><code class="prism language-shell">version: <span class="token string">"3.6"</span>
services:
 pos_rabbitmq_1:
    image: rabbitmq:3.8-management
    restart: always
    container_name: pos_rabbitmq_1  <span class="token comment">#每个节点名称修改即可</span>
    network_mode: <span class="token function">host</span>
    extra_hosts:
      - <span class="token string">"pos_rabbitmq_1:172.17.80.27"</span>
      - <span class="token string">"pos_rabbitmq_2:172.17.80.32"</span>
      - <span class="token string">"pos_rabbitmq_3:172.17.80.6"</span>
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /data/apd/rabbitmq:/var/lib/rabbitmq
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - .erlang.cookie:/var/lib/rabbitmq/.erlang.cookie
      - <span class="token punctuation">..</span>/enabled_plugins:/etc/rabbitmq/enabled_plugins 
      - /data/logs/rabbitmq:/var/log/rabbitmq
    environment:
      - <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8
      - <span class="token assign-left variable">RABBITMQ_DEFAULT_USER</span><span class="token operator">=</span>root
      - <span class="token assign-left variable">RABBITMQ_DEFAULT_PASS</span><span class="token operator">=</span>xxxxxx
      - <span class="token assign-left variable">RABBITMQ_VM_MEMORY_HIGH_WATERMARK</span><span class="token operator">=</span><span class="token number">0.7</span> <span class="token comment">#内存默认阀值设置</span>
</code></pre> 
<p>pos_rabbitmq_2 中docker-compose.yaml文件</p> 
<pre><code class="prism language-shell">version: <span class="token string">"3.6"</span>
services:
 pos_rabbitmq_1:
    image: rabbitmq:3.8-management
    restart: always
    container_name: pos_rabbitmq_2  <span class="token comment">#每个节点名称修改即可</span>
    network_mode: <span class="token function">host</span>
    extra_hosts:
      - <span class="token string">"pos_rabbitmq_1:172.17.80.27"</span>
      - <span class="token string">"pos_rabbitmq_2:172.17.80.32"</span>
      - <span class="token string">"pos_rabbitmq_3:172.17.80.6"</span>
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /data/apd/rabbitmq:/var/lib/rabbitmq
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - .erlang.cookie:/var/lib/rabbitmq/.erlang.cookie
      - <span class="token punctuation">..</span>/enabled_plugins:/etc/rabbitmq/enabled_plugins 
      - /data/logs/rabbitmq:/var/log/rabbitmq
    environment:
      - <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8
      - <span class="token assign-left variable">RABBITMQ_DEFAULT_USER</span><span class="token operator">=</span>root
      - <span class="token assign-left variable">RABBITMQ_DEFAULT_PASS</span><span class="token operator">=</span>xxxxxx
      - <span class="token assign-left variable">RABBITMQ_VM_MEMORY_HIGH_WATERMARK</span><span class="token operator">=</span><span class="token number">0.7</span>
</code></pre> 
<p>pos_rabbitmq_3 中docker-compose.yaml文件</p> 
<pre><code class="prism language-shell">version: <span class="token string">"3.6"</span>
services:
 pos_rabbitmq_1:
    image: rabbitmq:3.8-management
    restart: always
    container_name: pos_rabbitmq_3  <span class="token comment">#每个节点名称修改即可</span>
    network_mode: <span class="token function">host</span>
    extra_hosts:
      - <span class="token string">"pos_rabbitmq_1:172.17.80.27"</span>
      - <span class="token string">"pos_rabbitmq_2:172.17.80.32"</span>
      - <span class="token string">"pos_rabbitmq_3:172.17.80.6"</span>
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /data/apd/rabbitmq:/var/lib/rabbitmq
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - .erlang.cookie:/var/lib/rabbitmq/.erlang.cookie
      - <span class="token punctuation">..</span>/enabled_plugins:/etc/rabbitmq/enabled_plugins 
      - /data/logs/rabbitmq:/var/log/rabbitmq
    environment:
      - <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8
      - <span class="token assign-left variable">RABBITMQ_DEFAULT_USER</span><span class="token operator">=</span>root
      - <span class="token assign-left variable">RABBITMQ_DEFAULT_PASS</span><span class="token operator">=</span>xxxxxx
      - <span class="token assign-left variable">RABBITMQ_VM_MEMORY_HIGH_WATERMARK</span><span class="token operator">=</span><span class="token number">0.7</span>
</code></pre> 
<h6><a id="Step5_mq2mq3_308"></a>Step5 启动集群,启动完成后逐步启动过mq2,mq3</h6> 
<pre><code class="prism language-shell"><span class="token comment"># Step 4: 启动集群,启动完成后逐步启动过mq2,mq3</span>
<span class="token punctuation">[</span>root@pos_rabbitmq_1 /data/setup/public/rabbitmq/mq_1<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">172.17</span>.80.27
<span class="token comment"># docker-compose up -d</span>
Creating pos_rabbitmq_1 <span class="token punctuation">..</span>. <span class="token keyword">done</span>


<span class="token punctuation">[</span>root@pos_rabbitmq_1 /data/setup/public/rabbitmq/mq_1<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">172.17</span>.80.27
<span class="token comment"># docker logs pos_rabbitmq_1 -f</span>
<span class="token number">2024</span>-07-30 <span class="token number">10</span>:57:54.440 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> <span class="token operator">&lt;</span><span class="token number">0.596</span>.<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> Server startup complete<span class="token punctuation">;</span> <span class="token number">9</span> plugins started.
 * rabbitmq_federation_management
 * rabbitmq_federation
 * rabbitmq_web_stomp
 * rabbitmq_stomp
 * rabbitmq_web_mqtt
 * rabbitmq_mqtt
 * rabbitmq_management
 * rabbitmq_web_dispatch
 * rabbitmq_management_agent
 completed with <span class="token number">9</span> plugins.
<span class="token number">2024</span>-07-30 <span class="token number">10</span>:57:54.440 <span class="token punctuation">[</span>info<span class="token punctuation">]</span> <span class="token operator">&lt;</span><span class="token number">0.596</span>.<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> Resetting <span class="token function">node</span> maintenance status
</code></pre> 
<h6><a id="Step6_ha_333"></a>Step6 集群高可用镜像ha,任意节点执行</h6> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@pos_rabbitmq_1 /data/setup/public/rabbitmq/mq_1<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">172.17</span>.80.27
<span class="token comment"># docker exec -it pos_rabbitmq_1 /bin/bash</span>
root@pos_rabbitmq_1:/<span class="token comment"># rabbitmqctl set_policy ha-all "^" '{"ha-mode":"all"}'</span>
Setting policy <span class="token string">"ha-all"</span> <span class="token keyword">for</span> pattern <span class="token string">"^"</span> to <span class="token string">"{"</span>ha-mode<span class="token string">":"</span>all<span class="token string">"}"</span> with priority <span class="token string">"0"</span> <span class="token keyword">for</span> vhost <span class="token string">"/"</span> <span class="token punctuation">..</span>.
root@pos_rabbitmq_1:/<span class="token comment"># exit</span>
<span class="token builtin class-name">exit</span>
</code></pre> 
<p>每个节点目录结构及其enabled_plugins安装插件情况如下:</p> 
<pre><code class="prism language-shell">目录结构
<span class="token punctuation">[</span>root@pos_rabbitmq_1 /data/setup/public/rabbitmq<span class="token punctuation">]</span> eth0 <span class="token operator">=</span> <span class="token number">172.17</span>.80.27
<span class="token comment"># tree -a</span>
<span class="token builtin class-name">.</span>
<span class="token operator">|</span>-- enabled_plugins
<span class="token operator">|</span>-- mq_1
<span class="token operator">|</span>   <span class="token operator">|</span>-- docker-compose.yml
<span class="token operator">|</span>   <span class="token operator">|</span>-- .erlang.cookie
<span class="token operator">|</span>   <span class="token operator">|</span>-- .rabbitmq.conf
<span class="token operator">|</span>   <span class="token variable"><span class="token variable">`</span>-- rabbitmq.conf
<span class="token operator">|</span>-- mq_2
<span class="token operator">|</span>   <span class="token operator">|</span>-- docker-compose.yml
<span class="token operator">|</span>   <span class="token operator">|</span>-- .erlang.cookie
<span class="token operator">|</span>   <span class="token variable">`</span></span>-- rabbitmq.conf
<span class="token operator">|</span>-- mq_3
<span class="token operator">|</span>   <span class="token operator">|</span>-- docker-compose.yml
<span class="token operator">|</span>   <span class="token operator">|</span>-- .erlang.cookie
<span class="token operator">|</span>   <span class="token variable"><span class="token variable">`</span>-- rabbitmq.conf
<span class="token variable">`</span></span>-- README.md

<span class="token comment"># cat enabled_plugins</span>
<span class="token punctuation">[</span>rabbitmq_federation_management,rabbitmq_management,rabbitmq_mqtt,rabbitmq_web_mqtt,rabbitmq_stomp,rabbitmq_web_stomp<span class="token punctuation">]</span>.
</code></pre> 
<h4><a id="_371"></a>测试</h4> 
<h5><a id="1_372"></a>1.集群建设</h5> 
<p>pos_rabbitmq_1、pos_rabbitmq_2、pos_rabbitmq_3以组成集群<br> <img src="https://images2.imgbox.com/87/f7/NrZuf9Sn_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6b/cb/prILnjWR_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2_377"></a>2.实现高可用</h5> 
<p>集群实现ha镜像高可用,创建队列,镜像备份mq2,mq3<br> <img src="https://images2.imgbox.com/15/1d/z48UAQq0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0b/69/iTHm0Tn8_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d8/03/Ibu5qkPH_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3rabbitmq70_384"></a>3.节点只运行rabbitmq,所以内存阀值调制总在比的70%</h5> 
<p>总运行内存8G,占比70% 可用5.2GB<br> <img src="https://images2.imgbox.com/c1/a5/JKs6rKsE_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4098edd79ab89776c8b0198a8b6c1954/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Faiss向量数据库</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/86f0846243bd55464f390b7d898261b7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">从手控到声控，NRK3502离线语音芯片赋能智能风扇解决方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>