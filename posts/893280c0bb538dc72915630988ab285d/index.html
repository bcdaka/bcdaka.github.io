<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>20分钟，使用Amazon SageMaker快速搭建属于自己的AIGC应用 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/893280c0bb538dc72915630988ab285d/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="20分钟，使用Amazon SageMaker快速搭建属于自己的AIGC应用">
  <meta property="og:description" content="真火！
作为最近一段时间人工智能领域内的顶流之一，AIGC（AI-Generated Content）早已火爆出圈，频登各大互联网平台热搜。
cite: 微软亚洲研究院官方微博
这段时间以来，基于深度学习的内容生成在图像、视频、语音、音乐、文本等生成领域都取得了令人瞩目的成果，也越来越多的身边人在讨论AIGC。但你知道AIGC背后的有哪些技术支持吗？
实际上，最早引爆AIGC话题的是AI作图，它是以Stable Diffusion技术为基础实现的。以前，AI 作图还只是简单的风格迁移、头像生成、磨皮、P图等功能应用，直到Stable Diffusion模型的降临，AI 作图发生了质的变化，人们第一次见识到了生产力AI的力量：画家、设计师不用再绞尽脑汁思考色彩、构图，只要告诉 Stable Diffusion 模型自己想要什么，就能言出法随般地生成高质量图片。
那么我能不能自己实现一个以Stable Diffusion模型为基础的AIGC作画应用呢？
答案是可以的！最近我恰好受邀参与了亚马逊云科技【云上探索实验室】活动，利用Amazon的SageMaker平台搭建了自己的 AIGC 应用，整个过程只用了不到20分钟。
使用 Amazon SageMaker 基于Stable Diffusion模型搭建的AIGC应用
总体而言，在Amazon SageMaker上搭建AIGC应用的体验十分出色，不仅仅是流程清晰，简单易实现。使用者可以直接从Hugging Face上提取预训练的模型，参考Amazon提供的简明教程，使得SageMaker可以很容易地将模型转化为Web应用。
下面是一些图像生成的结果：
感觉还不错，现在我们就来复盘一些怎么利用亚马逊云服务使用Amazon SageMaker在20分钟内搭建一个属于自己的AIGC应用。
我将首先简单说明AIGC是什么以及讲解Stable Diffusion的技术原理。然后介绍Amazon SageMaker是做什么的。之后将基于Amazon SageMaker搭建AIGC应用的整体流程复盘一遍。最后对该应用进行测试和功能评价。
文章目录 1. 什么是Stable Diffusion？1.1. 人工智能自动生成内容：AIGC介绍1.2. Stable Diffusion原理解析 2. 什么是Amazon SageMaker？3. 通过Amazon SageMaker搭建基于Stable Diffusion模型的AIGC应用3.1. 创建Notebook3.2. 利用Hugging Face克隆模型3.3. 了解模型的超参数3.4. 配置和微调Stable Diffusion模型3.5. 部署和使用训练好的模型3.6. 清理资源3.7. 整体流程的视频介绍 4. 对Stable Diffusion模型的评估4.1. CPU和GPU对生成速度的影响4.2. 超参数对模型性能的影响 5. 总结5.1. 基于Amazon SageMaker搭建的AIGC应用的功能评价5.2. 对开发过程有帮助的产品文档汇总 1. 什么是Stable Diffusion？ 1.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-04-24T09:14:00+08:00">
    <meta property="article:modified_time" content="2023-04-24T09:14:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">20分钟，使用Amazon SageMaker快速搭建属于自己的AIGC应用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>真火！</p> 
<p>作为最近一段时间人工智能领域内的顶流之一，AIGC（AI-Generated Content）早已火爆出圈，频登各大互联网平台热搜。<br> <img src="https://images2.imgbox.com/3c/72/8h1Vgisk_o.png" alt="在这里插入图片描述" width="400" height="300"></p> 
<blockquote> 
 <p>cite: 微软亚洲研究院官方微博</p> 
</blockquote> 
<p>这段时间以来，基于深度学习的内容生成在图像、视频、语音、音乐、文本等生成领域都取得了令人瞩目的成果，也越来越多的身边人在讨论AIGC。但你知道AIGC背后的有哪些技术支持吗？</p> 
<p>实际上，最早引爆AIGC话题的是AI作图，它是以Stable Diffusion技术为基础实现的。以前，AI 作图还只是简单的风格迁移、头像生成、磨皮、P图等功能应用，直到Stable Diffusion模型的降临，AI 作图发生了质的变化，人们第一次见识到了生产力AI的力量：画家、设计师不用再绞尽脑汁思考色彩、构图，只要告诉 Stable Diffusion 模型自己想要什么，就能言出法随般地生成高质量图片。</p> 
<p>那么我能不能自己实现一个以Stable Diffusion模型为基础的AIGC作画应用呢？</p> 
<p>答案是可以的！<strong>最近我恰好受邀参与了亚马逊云科技【云上探索实验室】活动，利用Amazon的SageMaker平台搭建了自己的 AIGC 应用，整个过程只用了不到20分钟。</strong></p> 
<p><img src="https://images2.imgbox.com/3b/5f/BrJ0TDm6_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>使用 Amazon SageMaker 基于Stable Diffusion模型搭建的AIGC应用</p> 
</blockquote> 
<p>总体而言，在Amazon SageMaker上搭建AIGC应用的体验十分出色，不仅仅是流程清晰，简单易实现。使用者可以直接从Hugging Face上提取预训练的模型，参考Amazon提供的简明教程，使得SageMaker可以很容易地将模型转化为Web应用。</p> 
<p>下面是一些图像生成的结果：<br> <img src="https://images2.imgbox.com/40/bc/mqXHUvwd_o.jpg" alt="在这里插入图片描述"></p> 
<p>感觉还不错，现在我们就来复盘一些怎么利用亚马逊云服务使用Amazon SageMaker在20分钟内搭建一个属于自己的AIGC应用。</p> 
<p>我将首先简单说明AIGC是什么以及讲解Stable Diffusion的技术原理。然后介绍Amazon SageMaker是做什么的。之后将基于Amazon SageMaker搭建AIGC应用的整体流程复盘一遍。最后对该应用进行测试和功能评价。</p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#1_Stable_Diffusion_29" rel="nofollow">1. 什么是Stable Diffusion？</a></li><li><ul><li><a href="#11_AIGC_30" rel="nofollow">1.1. 人工智能自动生成内容：AIGC介绍</a></li><li><a href="#12_Stable_Diffusion_36" rel="nofollow">1.2. Stable Diffusion原理解析</a></li></ul> 
   </li><li><a href="#2_Amazon_SageMaker_61" rel="nofollow">2. 什么是Amazon SageMaker？</a></li><li><a href="#3_Amazon_SageMakerStable_DiffusionAIGC_65" rel="nofollow">3. 通过Amazon SageMaker搭建基于Stable Diffusion模型的AIGC应用</a></li><li><ul><li><a href="#31_Notebook_69" rel="nofollow">3.1. 创建Notebook</a></li><li><a href="#32_Hugging_Face_95" rel="nofollow">3.2. 利用Hugging Face克隆模型</a></li><li><a href="#33__110" rel="nofollow">3.3. 了解模型的超参数</a></li><li><a href="#34_Stable_Diffusion_131" rel="nofollow">3.4. 配置和微调Stable Diffusion模型</a></li><li><a href="#35__174" rel="nofollow">3.5. 部署和使用训练好的模型</a></li><li><a href="#36__309" rel="nofollow">3.6. 清理资源</a></li><li><a href="#37__311" rel="nofollow">3.7. 整体流程的视频介绍</a></li></ul> 
   </li><li><a href="#4_Stable_Diffusion_320" rel="nofollow">4. 对Stable Diffusion模型的评估</a></li><li><ul><li><a href="#41_CPUGPU_322" rel="nofollow">4.1. CPU和GPU对生成速度的影响</a></li><li><a href="#42__331" rel="nofollow">4.2. 超参数对模型性能的影响</a></li></ul> 
   </li><li><a href="#5__349" rel="nofollow">5. 总结</a></li><li><ul><li><a href="#51_Amazon_SageMakerAIGC_350" rel="nofollow">5.1. 基于Amazon SageMaker搭建的AIGC应用的功能评价</a></li><li><a href="#52__372" rel="nofollow">5.2. 对开发过程有帮助的产品文档汇总</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1_Stable_Diffusion_29"></a>1. 什么是Stable Diffusion？</h3> 
<h4><a id="11_AIGC_30"></a>1.1. 人工智能自动生成内容：AIGC介绍</h4> 
<p>人工智能自动生成内容（AIGC）是一种基于人工智能（AI）技术的内容创作方法，旨在快速、高效地生成高质量、有创意的文本、图像、音频或视频等多种形式的内容。借助先进的深度学习和自然语言处理技术，AIGC能够理解和学习人类语言、语境、知识和创意，从而根据用户需求生成各种类型的内容。这其中尤其以<a href="https://stablediffusion.fr/" rel="nofollow">Stable Diffusion</a>为代表性技术和应用，它用于从自然语言描述生成数字图像。</p> 
<p><img src="https://images2.imgbox.com/cb/7e/5GEqZHr3_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="12_Stable_Diffusion_36"></a>1.2. Stable Diffusion原理解析</h4> 
<p>Stable Diffusion是一个基于Latent Diffusion Models（潜在扩散模型，LDMs）的文图生成（text-to-image）模型。<br> <img src="https://images2.imgbox.com/58/d8/bzXqjRWw_o.png" alt="在这里插入图片描述"><br> 它包含三个模块：感知压缩、扩散模型和条件机制。</p> 
<p><strong>（1） 图像感知压缩（Perceptual Image Compression）</strong><br> 图像感知压缩通过VAE自编码模型对原图进行处理，忽略掉原图中的高频细节信息，只保留一些重要、基础的特征。该模块并非必要，但是它的加入能够大幅降低训练和采样的计算成本，大大降低了图文生成任务的实现门槛。</p> 
<p>基于感知压缩的扩散模型的训练过程有两个阶段：（1）训练一个自编码器；（2）训练扩散模型。在训练自编码器时，为了避免潜在表示空间出现高度的异化，作者使用了两种正则化方法，一种是KL-reg，另一种是VQ-reg，因此在官方发布的一阶段预训练模型中，会看到KL和VQ两种实现。在Stable Diffusion中主要采用AutoencoderKL这种正则化实现。</p> 
<p>具体来说，图像感知压缩模型的训练过程如下：给定图像<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
         ∈ 
        
        
        
          R 
         
         
         
           H 
          
         
           × 
          
         
           W 
          
         
           × 
          
         
           3 
          
         
        
       
      
        x\in \mathbb{R}^{H\times W\times 3} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em; vertical-align: -0.0391em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8413em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0813em;">H</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">W</span><span class="mbin mtight">×</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></span></span>，我们先利用一个编码器<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ε 
        
       
      
        \varepsilon 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">ε</span></span></span></span></span>来将图像从原图编码到潜在表示空间（即提取图像的特征）<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         z 
        
       
         = 
        
       
         ε 
        
       
         ( 
        
       
         x 
        
       
         ) 
        
       
      
        z=\varepsilon(x) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ε</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>，其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         z 
        
       
         ∈ 
        
        
        
          R 
         
         
         
           h 
          
         
           × 
          
         
           w 
          
         
           × 
          
         
           c 
          
         
        
       
      
        z\in \mathbb{R}^{h\times w\times c} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5782em; vertical-align: -0.0391em;"></span><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8491em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right: 0.0269em;">w</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight">c</span></span></span></span></span></span></span></span></span></span></span></span></span>。然后，用解码器从潜在表示空间重建图片<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
        
          ~ 
         
        
       
         = 
        
       
         D 
        
       
         ( 
        
       
         z 
        
       
         ) 
        
       
         = 
        
       
         D 
        
       
         ( 
        
       
         ε 
        
       
         ( 
        
       
         x 
        
       
         ) 
        
       
         ) 
        
       
      
        \widetilde{x}=\mathcal{D}(z)=\mathcal{D}(\varepsilon(x)) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6906em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6906em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">x</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4306em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
           <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
            <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
           </svg></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathcal" style="margin-right: 0.0278em;">D</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathcal" style="margin-right: 0.0278em;">D</span><span class="mopen">(</span><span class="mord mathnormal">ε</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span></span>。训练的目标是使<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
         = 
        
        
        
          x 
         
        
          ~ 
         
        
       
      
        x=\widetilde{x} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6906em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6906em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mathnormal">x</span></span><span class="svg-align" style="width: calc(100% - 0.0556em); margin-left: 0.0556em; top: -3.4306em;"><span class="pstrut" style="height: 3em;"></span><span class="" style="height: 0.26em;"> 
           <svg width="100%" height="0.26em" viewbox="0 0 600 260" preserveaspectratio="none"> 
            <path d="M200 55.538c-77 0-168 73.953-177 73.953-3 0-7
-2.175-9-5.437L2 97c-1-2-2-4-2-6 0-4 2-7 5-9l20-12C116 12 171 0 207 0c86 0
 114 68 191 68 78 0 168-68 177-68 4 0 7 2 9 5l12 19c1 2.175 2 4.35 2 6.525 0
 4.35-2 7.613-5 9.788l-19 13.05c-92 63.077-116.937 75.308-183 76.128
-68.267.847-113-73.952-191-73.952z"></path> 
           </svg></span></span></span></span></span></span></span></span></span></span>。</p> 
<p><strong>（2） 隐扩散模型（Latent Diffusion Models）</strong><br> <img src="https://images2.imgbox.com/db/ff/IZMfNgsi_o.png" alt="在这里插入图片描述"></p> 
<p><a href="https://nn.labml.ai/diffusion/ddpm/index.html" rel="nofollow">扩散模型（DM）</a>从本质上来说，是一个基于马尔科夫过程的去噪器。其反向去噪过程的目标是根据输入的图像<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
        
          t 
         
        
       
      
        x_t 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>去预测一个对应去噪后的图像<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
         
         
           t 
          
         
           + 
          
         
           1 
          
         
        
       
      
        x_{t+1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，即 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
         
         
           t 
          
         
           + 
          
         
           1 
          
         
        
       
         = 
        
        
        
          ϵ 
         
        
          t 
         
        
       
         ( 
        
        
        
          x 
         
        
          t 
         
        
       
         , 
        
       
         t 
        
       
         ) 
        
       
         , 
        
       
           
        
       
         t 
        
       
         = 
        
       
         1 
        
       
         , 
        
       
         . 
        
       
         . 
        
       
         . 
        
       
         , 
        
       
         T 
        
       
      
        x_{t+1}=\epsilon_t(x_t,t),\ t=1,...,T 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span></span></span></span></span>。相应的目标函数可以写成如下形式：<span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           L 
          
          
          
            D 
           
          
            M 
           
          
         
        
          = 
         
         
         
           E 
          
          
          
            x 
           
          
            , 
           
          
            ϵ 
           
          
            ∼ 
           
           
           
             N 
            
           
             ( 
            
           
             0 
            
           
             , 
            
           
             1 
            
           
             ) 
            
           
             , 
            
           
             t 
            
           
          
         
        
          = 
         
        
          [ 
         
        
          ∣ 
         
        
          ∣ 
         
        
          ϵ 
         
        
          − 
         
         
         
           ϵ 
          
         
           θ 
          
         
        
          ( 
         
         
         
           x 
          
         
           t 
          
         
        
          , 
         
        
          t 
         
        
          ) 
         
        
          ∣ 
         
         
         
           ∣ 
          
         
           2 
          
         
           2 
          
         
        
          ] 
         
        
       
         L_{DM}=\mathbb{E}_{x,\epsilon\sim\mathcal{N(0,1),t}}=[||\epsilon-\epsilon_\theta(x_t,t)||_{2}^{2}] 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span><span class="mord mathnormal mtight" style="margin-right: 0.109em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.0441em; vertical-align: -0.3552em;"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">ϵ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right: 0.1474em;">N</span><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord">∣∣</span><span class="mord mathnormal">ϵ</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1141em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></span>这里默认噪声的分布是高斯分布<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         N 
        
       
         ( 
        
       
         0 
        
       
         , 
        
       
         1 
        
       
         ) 
        
       
      
        \mathcal{N(0,1)} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathcal" style="margin-right: 0.1474em;">N</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></span>，这是因为高斯分布可以应用重参数化技巧简化计算；此处的<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
      
        x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span>指的是原图。</p> 
<p>而在潜在扩散模型中（LDM），引入了预训练的感知压缩模型，它包括一个编码器 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ε 
        
       
      
        \varepsilon 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">ε</span></span></span></span></span> 和一个解码器 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         D 
        
       
      
        \mathcal{D} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathcal" style="margin-right: 0.0278em;">D</span></span></span></span></span>。这样在训练时就可以利用编码器得到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          z 
         
        
          t 
         
        
       
         = 
        
       
         ε 
        
       
         ( 
        
        
        
          x 
         
        
          t 
         
        
       
         ) 
        
       
      
        z_t=\varepsilon(x_t) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ε</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，从而让模型在潜在表示空间中学习，相应的目标函数可以写成如下形式：<span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           L 
          
          
          
            L 
           
          
            D 
           
          
            M 
           
          
         
        
          = 
         
         
         
           E 
          
          
          
            ε 
           
          
            ( 
           
          
            x 
           
          
            ) 
           
          
            , 
           
          
            ϵ 
           
          
            ∼ 
           
           
           
             N 
            
           
             ( 
            
           
             0 
            
           
             , 
            
           
             1 
            
           
             ) 
            
           
             , 
            
           
             t 
            
           
          
         
        
          = 
         
        
          [ 
         
        
          ∣ 
         
        
          ∣ 
         
        
          ϵ 
         
        
          − 
         
         
         
           ϵ 
          
         
           θ 
          
         
        
          ( 
         
         
         
           z 
          
         
           t 
          
         
        
          , 
         
        
          t 
         
        
          ) 
         
        
          ∣ 
         
         
         
           ∣ 
          
         
           2 
          
         
           2 
          
         
        
          ] 
         
        
       
         L_{LDM}=\mathbb{E}_{\varepsilon(x),\epsilon\sim\mathcal{N(0,1),t}}=[||\epsilon-\epsilon_\theta(z_t,t)||_{2}^{2}] 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span><span class="mord mathnormal mtight" style="margin-right: 0.109em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.0441em; vertical-align: -0.3552em;"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ε</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">ϵ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right: 0.1474em;">N</span><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord">∣∣</span><span class="mord mathnormal">ϵ</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1141em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></span></p> 
<p><strong>（3） 条件机制（Conditioning Mechanisms）</strong><br> 条件机制，指的是通过输入某些参数来控制图像的生成结果。这主要是通过拓展得到一个条件时序去噪自编码器（Conditional Denoising Autoencoder，CDA）<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          ϵ 
         
        
          θ 
         
        
       
         ( 
        
        
        
          z 
         
        
          t 
         
        
       
         , 
        
       
         t 
        
       
         , 
        
       
         y 
        
       
         ) 
        
       
      
        \epsilon_\theta(z_t,t,y) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mclose">)</span></span></span></span></span>来实现的，这样一来我们就可通过输入参数<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         y 
        
       
      
        y 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span> 来控制图像生成的过程。</p> 
<p>具体来说，论文通过在UNet主干网络上增加cross-attention机制来实现CDA，选用UNet网络是因为实践中Diffusion在UNet网络上效果最好。为了能够从多个不同的模态预处理参数<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         y 
        
       
      
        y 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span>，论文引入了一个领域专用编码器（Domain Specific Encoder） <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          τ 
         
        
          θ 
         
        
       
      
        \tau_\theta 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: -0.1132em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，它将<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         y 
        
       
      
        y 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span>映射为一个中间表示 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          τ 
         
        
          θ 
         
        
       
         ( 
        
       
         y 
        
       
         ) 
        
       
         ∈ 
        
        
        
          R 
         
         
         
           M 
          
         
           × 
          
          
          
            d 
           
          
            r 
           
          
         
        
       
      
        \tau_\theta(y)\in\mathbb{R}^{M\times d_r} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: -0.1132em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8491em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">M</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1645em;"><span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.143em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>，这样我们就可以很方便的将<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         y 
        
       
      
        y 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span>设置为各种模态的条件（文本、类别等等）。最终模型就可以通过一个cross-attention层映射将控制信息融入到UNet的中间层，cross-attention层的实现如下：<span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          A 
         
        
          t 
         
        
          t 
         
        
          e 
         
        
          n 
         
        
          t 
         
        
          i 
         
        
          o 
         
        
          n 
         
        
          ( 
         
        
          Q 
         
        
          , 
         
        
          K 
         
        
          , 
         
        
          V 
         
        
          ) 
         
        
          = 
         
        
          s 
         
        
          o 
         
        
          f 
         
        
          t 
         
        
          m 
         
        
          a 
         
        
          x 
         
        
          ( 
         
         
          
          
            Q 
           
           
           
             K 
            
           
             ⊤ 
            
           
          
          
          
            d 
           
          
         
        
          ) 
         
        
          ⋅ 
         
        
          V 
         
        
       
         Attention(Q,K,V)=softmax(\frac{QK^\top}{\sqrt{d}})\cdot V 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.2222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.4561em; vertical-align: -0.93em;"></span><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.5261em;"><span class="" style="top: -2.1778em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9322em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord mathnormal">d</span></span></span><span class="" style="top: -2.8922em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
                   <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                    <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
                   </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1078em;"><span class=""></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8491em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.93em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.2222em;">V</span></span></span></span></span></span><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          Q 
         
        
          = 
         
         
         
           W 
          
         
           Q 
          
          
          
            ( 
           
          
            i 
           
          
            ) 
           
          
         
        
          ⋅ 
         
         
         
           φ 
          
         
           i 
          
         
        
          ( 
         
         
         
           z 
          
         
           t 
          
         
        
          ) 
         
        
          , 
         
         
        
          K 
         
        
          = 
         
         
         
           W 
          
         
           K 
          
          
          
            ( 
           
          
            i 
           
          
            ) 
           
          
         
        
          ⋅ 
         
         
         
           τ 
          
         
           θ 
          
         
        
          ( 
         
        
          y 
         
        
          ) 
         
        
          , 
         
         
        
          V 
         
        
          = 
         
         
         
           W 
          
         
           V 
          
          
          
            ( 
           
          
            i 
           
          
            ) 
           
          
         
        
          ⋅ 
         
         
         
           τ 
          
         
           θ 
          
         
        
          ( 
         
        
          y 
         
        
          ) 
         
        
       
         Q=W_{Q}^{(i)}\cdot \varphi_i(z_t),\quad K=W_{K}^{(i)}\cdot \tau_\theta(y),\quad V=W_{V}^{(i)}\cdot \tau_\theta(y) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.4744em; vertical-align: -0.4296em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em;"><span class="" style="top: -2.4065em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="" style="top: -3.2198em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4296em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 1em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.3383em; vertical-align: -0.2935em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em;"><span class="" style="top: -2.4065em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">K</span></span></span></span><span class="" style="top: -3.2198em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2935em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: -0.1132em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 1em;"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.2222em;">V</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.3383em; vertical-align: -0.2935em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em;"><span class="" style="top: -2.4065em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.2222em;">V</span></span></span></span><span class="" style="top: -3.2198em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2935em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: -0.1132em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mclose">)</span></span></span></span></span></span>其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          φ 
         
        
          i 
         
        
       
         ( 
        
        
        
          z 
         
        
          t 
         
        
       
         ) 
        
       
         ∈ 
        
        
        
          R 
         
         
         
           N 
          
         
           × 
          
          
          
            d 
           
          
            ϵ 
           
          
            i 
           
          
         
        
       
      
        \varphi_i(z_t)\in \mathbb{R}^{N\times d_{\epsilon}^{i}} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.9945em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.9945em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.109em;">N</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9021em;"><span class="" style="top: -2.214em; margin-left: 0em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ϵ</span></span></span></span><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.286em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 是UNet的一个中间表征；<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          W 
         
        
          Q 
         
         
         
           ( 
          
         
           i 
          
         
           ) 
          
         
        
       
      
        W_{Q}^{(i)} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.4744em; vertical-align: -0.4296em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em;"><span class="" style="top: -2.4065em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="" style="top: -3.2198em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4296em;"><span class=""></span></span></span></span></span></span></span></span></span></span>、<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          W 
         
        
          K 
         
         
         
           ( 
          
         
           i 
          
         
           ) 
          
         
        
       
      
        W_{K}^{(i)} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.3383em; vertical-align: -0.2935em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em;"><span class="" style="top: -2.4065em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">K</span></span></span></span><span class="" style="top: -3.2198em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2935em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          W 
         
        
          V 
         
         
         
           ( 
          
         
           i 
          
         
           ) 
          
         
        
       
      
        W_{V}^{(i)} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.3383em; vertical-align: -0.2935em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0448em;"><span class="" style="top: -2.4065em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.2222em;">V</span></span></span></span><span class="" style="top: -3.2198em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2935em;"><span class=""></span></span></span></span></span></span></span></span></span></span>分别是三个权重矩阵。此时，带有条件机制的隐扩散模型的目标函数可以写成如下形式：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           L 
          
          
          
            L 
           
          
            D 
           
          
            M 
           
          
         
        
          = 
         
         
         
           E 
          
          
          
            ε 
           
          
            ( 
           
          
            x 
           
          
            ) 
           
          
            , 
           
          
              
           
          
            y 
           
          
            , 
           
          
              
           
          
            ϵ 
           
          
            ∼ 
           
           
           
             N 
            
           
             ( 
            
           
             0 
            
           
             , 
            
           
             1 
            
           
             ) 
            
           
             , 
            
           
               
            
           
             t 
            
           
          
         
        
          = 
         
        
          [ 
         
        
          ∣ 
         
        
          ∣ 
         
        
          ϵ 
         
        
          − 
         
         
         
           ϵ 
          
         
           θ 
          
         
        
          ( 
         
         
         
           z 
          
         
           t 
          
         
        
          , 
         
        
            
         
        
          t 
         
        
          , 
         
        
            
         
         
         
           τ 
          
         
           θ 
          
         
        
          ( 
         
        
          y 
         
        
          ) 
         
        
          ) 
         
        
          ∣ 
         
         
         
           ∣ 
          
         
           2 
          
         
           2 
          
         
        
          ] 
         
        
       
         L_{LDM}=\mathbb{E}_{\varepsilon(x),\ y,\ \epsilon\sim\mathcal{N(0,1),\ t}}=[||\epsilon-\epsilon_\theta(z_t,\ t,\ \tau_\theta(y))||_{2}^{2}] 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">L</span><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">D</span><span class="mord mathnormal mtight" style="margin-right: 0.109em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.0441em; vertical-align: -0.3552em;"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ε</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mspace mtight"><span class="mtight"> </span></span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span><span class="mpunct mtight">,</span><span class="mspace mtight"><span class="mtight"> </span></span><span class="mord mathnormal mtight">ϵ</span><span class="mrel mtight">∼</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right: 0.1474em;">N</span><span class="mopen mtight">(</span><span class="mord mtight">0</span><span class="mpunct mtight">,</span><span class="mord mtight">1</span><span class="mclose mtight">)</span><span class="mpunct mtight">,</span><span class="mspace mtight"><span class="mtight"> </span></span><span class="mord mathnormal mtight">t</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.3552em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord">∣∣</span><span class="mord mathnormal">ϵ</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.1141em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1132em;">τ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: -0.1132em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0278em;">θ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mclose">))</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.247em;"><span class=""></span></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></span></p> 
<h3><a id="2_Amazon_SageMaker_61"></a>2. 什么是Amazon SageMaker？</h3> 
<p>Amazon SageMaker 是一种完全托管式的机器学习服务，旨在帮助开发者和数据科学家快速、轻松地构建、训练和部署机器学习模型。Amazon SageMaker 提供了一个集成的开发环境，降低了创建机器学习解决方案的复杂性和成本。Amazon云服务提供了三层架构，即框架和基础架构服务-机器学习服务-人工智能服务相结合的服务架构，其中Amazon SageMaker是中间层服务的支撑平台，为机器学习提供自定义训练和部署服务。<br> <img src="https://images2.imgbox.com/c9/71/qby3HXfp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_Amazon_SageMakerStable_DiffusionAIGC_65"></a>3. 通过Amazon SageMaker搭建基于Stable Diffusion模型的AIGC应用</h3> 
<p><img src="https://images2.imgbox.com/68/4b/YhtuetYc_o.png" alt="在这里插入图片描述" width="600" height="400"><br> 在我们开始部署Stable Diffusion模型之前，先来了解一下整体的实验架构。整体流程分为两大部分，首先是在Amazon SageMaker Notebook中加载并准备AIGC模型，模型已经在机器学习开源社区Hugging Face中准备好了，我们需要把它加载到Notebook中。然后将模型上传并部署该模型到Endpoint上，创建属于自己的AIGC应用。</p> 
<h4><a id="31_Notebook_69"></a>3.1. 创建Notebook</h4> 
<p>为了部署和使用我们的AIGC模型，我们采用Amazon SageMaker Notebook来编写代码和训练模型。</p> 
<p>首先我们进入到自己的 <strong>控制台主页(AWS Management Console)</strong>，在最上方的搜索栏中搜索“Amazon SageMaker”，点击进入即可。<br> <img src="https://images2.imgbox.com/2c/65/BC3nbrwV_o.png" alt="在这里插入图片描述"><br> 然后，我们在左侧的目录中选择“笔记本”-“笔记本实例”，进入到笔记本实例控制页。在这里，我们点击“创建笔记本实例”来创建一个新的实例。<br> <img src="https://images2.imgbox.com/9c/48/Jis8fleE_o.png" alt="在这里插入图片描述"><br> 之后在创建笔记本实例详情页中配置笔记本实例的基本信息。主要配置以下4部分信息：（1）笔记本实例名称；（2）笔记本实例类型；（3）平台标识符（操作系统及Jupyter Notebook版本）；（4）实例存储大小（卷大小）。<br> <img src="https://images2.imgbox.com/49/8f/ORD3Zcgb_o.png" alt="在这里插入图片描述"><br> 如果遇到无“IAM 角色”的问题，那就采用默认配置创建一个新角色即可。<br> <img src="https://images2.imgbox.com/41/e9/mUeUsJ4b_o.png" alt="在这里插入图片描述"><br> 以上步骤完成之后点击“创建笔记本实例”就可以了，点击之后，需要等待一段时间（约5分钟）才能完成创建。<br> <img src="https://images2.imgbox.com/bd/b0/uqWuyKrb_o.png" alt="在这里插入图片描述"></p> 
<p>这里已经为大家准备好了相关的代码，打开<a href="https://static.us-east-1.prod.workshops.aws/public/73ea3a9f-37c8-4d01-ae4e-07cf6313adac/static/code/notebook-stable-diffusion-ssh-inference.ipynb" rel="nofollow">链接</a>（https://static.us-east-1.prod.workshops.aws/public/73ea3a9f-37c8-4d01-ae4e-07cf6313adac/static/code/notebook-stable-diffusion-ssh-inference.ipynb），下载保存Notebook代码文件。</p> 
<p>下载好代码（ipynb）文件之后，我们在笔记本实例页面点击“打开Jupyter”，然后上传代码。<br> <img src="https://images2.imgbox.com/d7/ca/GYqfOttT_o.png" alt="在这里插入图片描述"><br> 选择好文件后，点击蓝色的“Upload”按键，即可完成上传。然后我们打开刚刚上传的notebook，可以看到该文件就是一个完整的Stable Diffusion训练代码，这里我们的run kernel选择<code>conda_pytorch_38</code>或<code>conda_pytorch_39</code>，因为机器学习代码是用pytorch写的。<br> <img src="https://images2.imgbox.com/16/b0/IC5GH535_o.png" alt="在这里插入图片描述"><br> 在这里，我们首先使用<code>Shift+Enter</code>运行<code>1.1安装及环境配置工作</code>中的两段代码，为接下来的实验配置好环境。</p> 
<p>以下是一些使用Jupyter Notebook的快捷键汇总。<br> <img src="https://images2.imgbox.com/f3/d6/Fa1klxdB_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="32_Hugging_Face_95"></a>3.2. 利用Hugging Face克隆模型</h4> 
<p>Hugging Face是一个人工智能/机器学习的开源社区和平台，在Hugging Face上有Stable Diffusion V1.4和Stable Diffusion V2.1两个版本，无论使用V1.4版本还是V2.1版本，我们都要把模型下载下来。</p> 
<pre><code class="prism language-python"><span class="token comment"># Clone the Stable Diffusion model from HuggingFace</span>

<span class="token comment">#### Stable Diffusion V1</span>
SD_SPACE<span class="token operator">=</span><span class="token string">"CompVis/"</span>
SD_MODEL <span class="token operator">=</span> <span class="token string">"stable-diffusion-v1-4"</span>

<span class="token comment">#### Stable Diffusion V2</span>
<span class="token comment"># SD_SPACE="stabilityai/"</span>
<span class="token comment"># SD_MODEL = "stable-diffusion-2-1"</span>
</code></pre> 
<p>之后克隆模型仓库，等待模型下载完毕。</p> 
<h4><a id="33__110"></a>3.3. 了解模型的超参数</h4> 
<p>在正式训练模型之前，我们来了解一下模型的超参数设置以及它们的含义。</p> 
<ul><li><strong>prompt</strong> (str or List[str]):<br> 引导图像生成的文本提示或文本列表</li><li><strong>height</strong> (int, optional, 默认为 V1模型可支持到512像素，V2模型可支持到768像素):<br> 生成图像的高度（以像素为单位）</li><li><strong>width</strong> (int, optional, 默认为 V1模型可支持到512像素，V2模型可支持到768像素):<br> 生成图像的宽度（以像素为单位）</li><li><strong>num_inference_steps</strong> (int, optional, defaults to 50):<br> 降噪步数。更多的去噪步骤通常会以较慢的推理为代价获得更高质量的图像</li><li><strong>guidance_scale</strong> (float, optional, defaults to 7.5):<br> 较高的指导比例会导致图像与提示密切相关，但会牺牲图像质量。 如果指定，它必须是一个浮点数。 guidance_scale&lt;=1 被忽略。</li><li><strong>negative_prompt</strong> (str or List[str], optional):<br> 不引导图像生成的文本或文本列表。不使用时忽略，必须与prompt类型一致（不应小于等于1.0）</li><li><strong>num_images_per_prompt</strong> (int, optional, defaults to 1):<br> 每个提示生成的图像数量</li></ul> 
<p>在这其中，height、width和num_images_per_prompt会直接影响到GPU的内存开销。height、width和num_images_per_prompt越大，所需要的GPU开销就越大。</p> 
<p>以上是主要要考虑的超参数，如果想进行更精细的调整，可以参考 <a href="https://github.com/huggingface/diffusers/blob/main/src/diffusers/pipelines/stable_diffusion/pipeline_stable_diffusion.py">pipeline_stable_diffusion.py</a>，539-593行。</p> 
<h4><a id="34_Stable_Diffusion_131"></a>3.4. 配置和微调Stable Diffusion模型</h4> 
<p>在确定好超参数之后，我们就可以配置并使用刚才微调的模型了。首先使用<code>stableDiffusionPipeline</code>加载stable-diffusion-v1-4（或stable-diffusion-v2-1），即<code>SD_MODEL=stable-diffusion-v1-4</code></p> 
<p>接下来，通过输入prompts和调整超参数，我们就可以用Stable Diffusion模型来生成图像了，例如：</p> 
<pre><code class="prism language-python"><span class="token comment"># move Model to the GPU</span>
torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>empty_cache<span class="token punctuation">(</span><span class="token punctuation">)</span>
pipe <span class="token operator">=</span> pipe<span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span>

<span class="token comment"># V1 Max-H:512,Max-W:512</span>
<span class="token comment"># V2 Max-H:768,Max-W:768</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 提示词，一句话或者多句话</span>
prompts <span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token string">"An eagle flying in the water"</span><span class="token punctuation">,</span>
    <span class="token string">"A pig kite flying in the sky"</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
generated_images <span class="token operator">=</span> pipe<span class="token punctuation">(</span>
    prompt<span class="token operator">=</span>prompts<span class="token punctuation">,</span>
    height<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token comment"># 生成图像的高度</span>
    width<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token comment"># 生成图像的宽度</span>
    num_images_per_prompt<span class="token operator">=</span><span class="token number">1</span> <span class="token comment"># 每个提示词生成多少个图像</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span>images  <span class="token comment"># image here is in [PIL format](https://pillow.readthedocs.io/en/stable/)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Prompts: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>prompts<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> image <span class="token keyword">in</span> generated_images<span class="token punctuation">:</span>
    display<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
</code></pre> 
<p>在这里，我们设置了两个提示词：</p> 
<ul><li>An eagle flying under the water<br> 一只在水里翱翔的老鹰</li><li>A pig kite flying in the sky<br> 一只在天上飞翔的风筝猪</li></ul> 
<p>生成的结果如下：<br> <img src="https://images2.imgbox.com/c7/95/NDrEgKsy_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="35__174"></a>3.5. 部署和使用训练好的模型</h4> 
<p>在确定模型可以正常使用之后，我们可以将模型部署到终端节点（Endpoint），这个过程分为两个阶段：</p> 
<ul><li>创建Stable Diffusion模型的推理节点</li><li>将模型部署到Cloud 9中作为Web应用</li></ul> 
<p>Amazon SageMaker 可以让我们将模型构建成自定义的推理脚本，该推理脚本可以直接接收json格式的输入，然后返回生成的图像数据。</p> 
<pre><code class="prism language-python"><span class="token comment"># 提交json数据，接收生成的图像数据</span>
response <span class="token operator">=</span> predictor<span class="token punctuation">[</span>SD_MODEL<span class="token punctuation">]</span><span class="token punctuation">.</span>predict<span class="token punctuation">(</span>data<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">"prompt"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"An eagle flying in the water"</span><span class="token punctuation">,</span>
    <span class="token comment">#   "A pig kite flying in the sky",</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"height"</span> <span class="token punctuation">:</span> <span class="token number">512</span><span class="token punctuation">,</span>
    <span class="token string">"width"</span> <span class="token punctuation">:</span> <span class="token number">512</span><span class="token punctuation">,</span>
    <span class="token string">"num_images_per_prompt"</span><span class="token punctuation">:</span><span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment"># 解码生成的图像</span>
decoded_images <span class="token operator">=</span> <span class="token punctuation">[</span>decode_base64_image<span class="token punctuation">(</span>image<span class="token punctuation">)</span> <span class="token keyword">for</span> image <span class="token keyword">in</span> response<span class="token punctuation">[</span><span class="token string">"generated_images"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

<span class="token comment">#visualize generation</span>
<span class="token keyword">for</span> image <span class="token keyword">in</span> decoded_images<span class="token punctuation">:</span>
    display<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
</code></pre> 
<p>我们构建的推理脚本将模型的功能解耦成两个函数，实际上就是读取模型以及读取超参数和prompts：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">model_fn</span><span class="token punctuation">(</span>model_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Load stable diffusion and move it to the GPU</span>
    pipe <span class="token operator">=</span> StableDiffusionPipeline<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>model_dir<span class="token punctuation">,</span> torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">)</span>
    pipe <span class="token operator">=</span> pipe<span class="token punctuation">.</span>to<span class="token punctuation">(</span><span class="token string">"cuda"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pipe

<span class="token keyword">def</span> <span class="token function">predict_fn</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> pipe<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># get prompt &amp; parameters</span>
    prompt <span class="token operator">=</span> data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"prompt"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token comment"># set valid HP for stable diffusion</span>
    height <span class="token operator">=</span> data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"height"</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    width <span class="token operator">=</span> data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"width"</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>
    num_inference_steps <span class="token operator">=</span> data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"num_inference_steps"</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>
    guidance_scale <span class="token operator">=</span> data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"guidance_scale"</span><span class="token punctuation">,</span> <span class="token number">7.5</span><span class="token punctuation">)</span>
    num_images_per_prompt <span class="token operator">=</span> data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"num_images_per_prompt"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># run generation with parameters</span>
    generated_images <span class="token operator">=</span> pipe<span class="token punctuation">(</span>
        prompt<span class="token operator">=</span>prompt<span class="token punctuation">,</span>
        height<span class="token operator">=</span>height<span class="token punctuation">,</span>
        width<span class="token operator">=</span>width<span class="token punctuation">,</span>
        num_inference_steps<span class="token operator">=</span>num_inference_steps<span class="token punctuation">,</span>
        guidance_scale<span class="token operator">=</span>guidance_scale<span class="token punctuation">,</span>
        num_images_per_prompt<span class="token operator">=</span>num_images_per_prompt<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"images"</span><span class="token punctuation">]</span>

    <span class="token comment"># create response</span>
    encoded_images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> image <span class="token keyword">in</span> generated_images<span class="token punctuation">:</span>
        buffered <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>
        image<span class="token punctuation">.</span>save<span class="token punctuation">(</span>buffered<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"JPEG"</span><span class="token punctuation">)</span>
        encoded_images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>buffered<span class="token punctuation">.</span>getvalue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># create response</span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"generated_images"</span><span class="token punctuation">:</span> encoded_images<span class="token punctuation">}</span>
</code></pre> 
<p>在这之后，我们要使用Hugging Face将stable-diffusion-v1-4模型上传到 Amazon S3桶。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sagemaker<span class="token punctuation">.</span>s3 <span class="token keyword">import</span> S3Uploader

sd_model_uri<span class="token operator">=</span>S3Uploader<span class="token punctuation">.</span>upload<span class="token punctuation">(</span>local_path<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>SD_MODEL<span class="token punctuation">}</span></span><span class="token string">.tar.gz"</span></span><span class="token punctuation">,</span> desired_s3_uri<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"s3://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>sess<span class="token punctuation">.</span>default_bucket<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">/stable-diffusion"</span></span><span class="token punctuation">)</span>

<span class="token comment">#init variables</span>
huggingface_model <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
predictor <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">from</span> sagemaker<span class="token punctuation">.</span>huggingface<span class="token punctuation">.</span>model <span class="token keyword">import</span> HuggingFaceModel
<span class="token comment"># create Hugging Face Model Class</span>
huggingface_model<span class="token punctuation">[</span>SD_MODEL<span class="token punctuation">]</span> <span class="token operator">=</span> HuggingFaceModel<span class="token punctuation">(</span>
    model_data<span class="token operator">=</span>sd_model_uri<span class="token punctuation">,</span> <span class="token comment"># path to your model and script</span>
    role<span class="token operator">=</span>role<span class="token punctuation">,</span> <span class="token comment"># iam role with permissions to create an Endpoint</span>
    transformers_version<span class="token operator">=</span><span class="token string">"4.17"</span><span class="token punctuation">,</span> <span class="token comment"># transformers version used</span>
    pytorch_version<span class="token operator">=</span><span class="token string">"1.10"</span><span class="token punctuation">,</span> <span class="token comment"># pytorch version used</span>
    py_version<span class="token operator">=</span><span class="token string">'py38'</span><span class="token punctuation">,</span> <span class="token comment"># python version used</span>
<span class="token punctuation">)</span>

<span class="token comment"># deploy the endpoint endpoint, Estimated time to spend 5min(V1), 8min(V2)</span>
predictor<span class="token punctuation">[</span>SD_MODEL<span class="token punctuation">]</span> <span class="token operator">=</span> huggingface_model<span class="token punctuation">[</span>SD_MODEL<span class="token punctuation">]</span><span class="token punctuation">.</span>deploy<span class="token punctuation">(</span>
    initial_instance_count<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
    instance_type<span class="token operator">=</span><span class="token string">"ml.g4dn.xlarge"</span><span class="token punctuation">,</span>
    endpoint_name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>SD_MODEL<span class="token punctuation">}</span></span><span class="token string">-endpoint"</span></span>
<span class="token punctuation">)</span>
</code></pre> 
<p>到这里为止，我们就已经创建好了Stable Diffusion模型的推理节点。然后我们在 AWS Cloud9 中为模型创建Web应用。</p> 
<p>回到控制台主页，在搜索栏搜索Cloud9，并点击进入服务。<br> <img src="https://images2.imgbox.com/b4/9c/qaS6qNP1_o.png" alt="在这里插入图片描述"><br> 然后点击“Create environment”创建 AWS Cloud9 环境，我们只需要设置环境实例的名称即可，其余保持默认。有几个可调整选项：</p> 
<ul><li><code>lnstance type</code>是实例的硬件类型，其中t2.micro是免费的类型。</li><li><code>Platform</code>是操作系统类型。</li><li><code>Timeout</code>是实例休眠时间，如果长时间没有访问，它会自动通知服务，防止持续计费。</li></ul> 
<p>设置好自己的实例属性之后，点击Create即可创建Cloud9环境实例。等待实例创建成功，即可点击“Open”打开实例IDE。</p> 
<p>之后我们在控制台中输入以下命令：</p> 
<pre><code class="prism language-python">cd <span class="token operator">~</span><span class="token operator">/</span>environment
wget https<span class="token punctuation">:</span><span class="token operator">//</span>static<span class="token punctuation">.</span>us<span class="token operator">-</span>east<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">.</span>prod<span class="token punctuation">.</span>workshops<span class="token punctuation">.</span>aws<span class="token operator">/</span>public<span class="token operator">/</span>73ea3a9f<span class="token operator">-</span>37c8<span class="token operator">-</span>4d01<span class="token operator">-</span>ae4e<span class="token operator">-</span>07cf6313adac<span class="token operator">/</span>static<span class="token operator">/</span>code<span class="token operator">/</span>SampleWebApp<span class="token punctuation">.</span><span class="token builtin">zip</span>
unzip SampleWebApp<span class="token punctuation">.</span><span class="token builtin">zip</span>
</code></pre> 
<p>这是一套简单的Web程序框架，包含：</p> 
<ul><li>后端代码 app.py：接收前端请求并调用 SageMaker Endpoint 将文字生成图片。</li><li>两个前端html文件 image.html 和 index.html。</li></ul> 
<p><img src="https://images2.imgbox.com/27/02/h7nFYNmh_o.png" alt="在这里插入图片描述"><br> 然后，在控制台中输入命令安装 Flask和boto3。</p> 
<pre><code class="prism language-python">pip3 install Flask
pip3 install boto3
</code></pre> 
<p><img src="https://images2.imgbox.com/00/b5/uV4djE1a_o.png" alt="在这里插入图片描述"></p> 
<p>之后在左侧项目文件夹中打开 app.py，运行它。<br> <img src="https://images2.imgbox.com/ef/4b/oeBSeaAW_o.png" alt="在这里插入图片描述"><br> 然后我们点击 Run 按钮左侧的 “Preview”，选择“Preview Running Application”，就可以预览页面啦。在这个页面上输入prompt和width、length，会返回对应生成的图像。<br> <img src="https://images2.imgbox.com/1b/64/i7NsRudH_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="36__309"></a>3.6. 清理资源</h4> 
<p>完成实验的运行之后，一定要停止并删除自己创建的Notebook和Cloud9的所有资源，以确保不会继续计费。当然这一点在 <a href="https://static.us-east-1.prod.workshops.aws/public/73ea3a9f-37c8-4d01-ae4e-07cf6313adac/static/code/notebook-stable-diffusion-ssh-inference.ipynb" rel="nofollow">Notebook的代码</a> 中也提到了，这里再次强调。</p> 
<h4><a id="37__311"></a>3.7. 整体流程的视频介绍</h4> 
<p>（1）创建Amazon SageMaker Notebook来编写代码和使用模型。</p> 
<p></p> 
<div class="csdn-video-box"> 
 <iframe id="LtCiW88d-1680759388418" frameborder="0" src="https://player.bilibili.com/player.html?aid=951719383" allowfullscreen="true" data-mediaembed="bilibili"></iframe> 
 <p>【亚马逊云科技】如何使用SageMaker Notebook搭建自己的Stable Diffusion模型？</p> 
</div> 
<p></p> 
<p>（2）在 AWS Cloud9 中为模型创建Web应用</p> 
<p></p> 
<div class="csdn-video-box"> 
 <iframe id="uAXT9RTr-1680759409928" frameborder="0" src="https://player.bilibili.com/player.html?aid=439189313" allowfullscreen="true" data-mediaembed="bilibili"></iframe> 
 <p>【亚马逊云科技】教你用Cloud9搭建自己的Stable Diffusion服务</p> 
</div> 
<p></p> 
<h3><a id="4_Stable_Diffusion_320"></a>4. 对Stable Diffusion模型的评估</h3> 
<p>由于本次实验不涉及模型的训练，因此超参数或者训练步数对模型性能、过拟合效应的影响无法被反映出来。为了评估模型的性能，我在这里设计了两个实验探究模型在不同情况下的效率区别。</p> 
<h4><a id="41_CPUGPU_322"></a>4.1. CPU和GPU对生成速度的影响</h4> 
<p>我们选用ml.t3.medium(2CPU+4G内存)和ml.g4dn.xlarge(4CPU+16G内存+16G显存)来探究不同设备情况下生成图像速度的区别。对于每一种stable diffusion模型，我将height和width设为最大，num_images_per_prompt设为1。</p> 
<table><thead><tr><th>设备</th><th>stable-diffusion-v1-4</th><th>stable-diffusion-v2-1</th></tr></thead><tbody><tr><td>ml.t3.medium</td><td>9s</td><td>11s</td></tr><tr><td>ml.g4dn.xlarge</td><td>8s</td><td>9s</td></tr></tbody></table> 
<p>可以观察到，stable-diffusion-v2-1的图像生成速度相对于v1-4略慢，GPU的图像生成速度相对于CPU要快。</p> 
<h4><a id="42__331"></a>4.2. 超参数对模型性能的影响</h4> 
<p>在上文中我们已经提到，height、width和num_images_per_prompt会直接影响到GPU的内存开销。我们在这里选用<code>ml.g4dn.xlarge</code>设备来探究超参数变化对<code>stable-diffusion-v1-4</code>模型的图像生成速度会带来怎么样的影响。</p> 
<table><thead><tr><th>超参数</th><th>配置1</th><th>配置2</th><th>配置3</th><th>配置4</th></tr></thead><tbody><tr><td>height&amp;width</td><td>512</td><td>256</td><td>128</td><td>64</td></tr><tr><td>num_images_per_prompt</td><td>1</td><td>1</td><td>1</td><td>1</td></tr><tr><td>用时</td><td>8s</td><td>5s</td><td>4s</td><td>4s</td></tr></tbody></table> 
<p>可以观察到，随着生成图像的height&amp;width减小，生成图像的用时也在减少，但减少的幅度并非是线性的，可以预见的是，当图像小于128时，继续减小对图像的生成速度不会再有显著的影响。</p> 
<table><thead><tr><th>超参数</th><th>配置1</th><th>配置2</th><th>配置3</th><th>配置4</th></tr></thead><tbody><tr><td>height&amp;width</td><td>512</td><td>512</td><td>512</td><td>512</td></tr><tr><td>num_images_per_prompt</td><td>4</td><td>3</td><td>2</td><td>1</td></tr><tr><td>用时</td><td>24s</td><td>20s</td><td>17s</td><td>8s</td></tr></tbody></table> 
<p>可以观察到，随着一次性生成图像数量的增加，生成所需要的时间也会同步增加，两者之间近似成正比关系。</p> 
<h3><a id="5__349"></a>5. 总结</h3> 
<h4><a id="51_Amazon_SageMakerAIGC_350"></a>5.1. 基于Amazon SageMaker搭建的AIGC应用的功能评价</h4> 
<p>我认为，可以从以下五个方面对Amazon SageMaker的功能进行评价：</p> 
<ul><li><strong>模型训练功能</strong><br> 在Amazon SageMaker Notebook中，我们可以直接从Hugging Face下载所需要的预训练模型。在本次体验中，我们可以很容易地获取Stable Diffusion V1.4和V2.1两个版本，并且在使用的过程中，可以很方便地参考文档来理解各个超参数的含义和作用，快速实现模型的微调。</li><li><strong>模型部署功能</strong><br> 训练好的模型不仅可以很方便地进行使用和微调，Amazon SageMaker也提供了多种部署教程，例如将模型打包成推理节点，以及使用Cloud9服务搭建带有UI的Web应用。</li><li><strong>速度与易用性</strong><br> Amazon SageMaker提供了多种实例类型供用户选择，对于不同的实例设备，可能会有使用体验上的差别，但毫无疑问的是，实例的初始化和使用是十分快捷方便的。</li><li><strong>生态丰富度</strong><br> 虽然本次体验只带大家完成了AIGC应用的搭建，但Amazon SageMaker还包括了一系列机器学习和人工智能应用以及相对应的IDE，例如还可以基于Amazon SageMaker构建细粒度情感分析应用、使用Amazon SageMaker构建机器学习应用等等。</li><li><strong>可视化能力</strong><br> Amazon SageMaker提供了Jupyter Notebook的全部功能，也就具备了实时对表格、图像输出进行可视化的能力。此外在Cloud9服务中，也可以对部署的Web应用进行快速预览。对于JumpStart的训练过程，Amazon SageMaker也提供了监控终端节点的功能。</li></ul> 
<p>然而，Stable Diffusion模型本身并不完美，尽管在生成图像方面具有令人印象深刻的性能，但它也存在一些明显的局限性，包括但不限于：</p> 
<ul><li>分辨率不够，尽管v2.1版本相对于v1.4版本在分辨率上有了巨大的提升，但仍然不够，想要生成高质量的图片，需要很长的时间和足够的调试耐心。</li><li>仅适用英文，如果能加入中文或多语言数据进行训练，会有更广泛的应用场景。</li><li>对细节的处理不足，所生成的图像第一眼看过去是很惊艳的，但如果放大观察细节部分，会出现很多错位、扭曲的现象。</li></ul> 
<h4><a id="52__372"></a>5.2. 对开发过程有帮助的产品文档汇总</h4> 
<p>以上提到的内容的相关介绍以及有关文档可参考：</p> 
<ul><li><strong>Amazon SageMaker 入门教程</strong>：https://aws.amazon.com/cn/sagemaker/getting-started/</li><li><strong>Amazon SageMaker产品介绍</strong>：https://aws.amazon.com/cn/sagemaker/</li><li><strong>Amazon SageMaker产品文档</strong>：https://docs.aws.amazon.com/zh_cn/sagemaker/index.html</li><li><strong>Stable Diffusion 模型文档(HuggingFace)</strong>：https://huggingface.co/spaces/stabilityai/stable-diffusion</li><li><strong>Stable Diffusion 模型文档(StabilityAI)</strong>：https://stability.ai/blog/stable-diffusion-public-release</li></ul> 
<p>通过云上探索实验室，开发者可以学习实践云上技术，用技术实验、产品体验、案例应用等方式，亲身感受最新、最热门的亚马逊云科技开发者工具与服务。发挥自己的想象和创造，以文章、视频、代码 Demo 等形式将自己的技术心得分享给其他开发者小伙伴。一同创造分享，互助启发，玩转云上技术。云上探索实验室不仅是体验的空间，更是分享的平台。</p> 
<p>本次亚马逊云科技举办的活动「云上探索实验室」，活动的主题是<em>从实践中探索机器学习边界</em>。一共有三个可体验的教程，分别是：使用 Amazon SageMaker 构建机器学习应用、基于 Amazon SageMaker构建细粒度情感分析应用、使用 Amazon SageMaker基于Stable Diffusion模型，快速搭建你的第一个AIGC应用。开启<strong>云上探索实验室</strong><sup class="footnote-ref"><a href="#fn1" rel="nofollow" id="fnref1">1</a></sup>，和我来一起体验Amazon SageMaker吧。</p> 
<p><img src="https://images2.imgbox.com/f4/76/0VUBgQ30_o.png" alt="在这里插入图片描述"></p> 
<hr class="footnotes-sep"> 
<section class="footnotes"> 
 <ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>https://dev.amazoncloud.cn/experience?trk=cndc-detail&amp;sc_medium=corecontent&amp;sc_campaign=product&amp;sc_channel=csdn <a href="#fnref1" rel="nofollow" class="footnote-backref">↩︎</a></p> </li></ol> 
</section>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b0476ae6765e99dd9653b8592c632f44/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">宝塔面板安装配置MySQL，轻松管理数据库【公网远程访问】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/aa83349768f12ef8fda3a71b07aeba52/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Echart图表 之 X轴（xAxis）与 Y轴（yAxis）配置项大全</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>