<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mac M1：通过docker安装RocketMQ、RocketMQ-Dashboard - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/e4c5ed2584b642bc9562d0a7e89eb14d/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Mac M1：通过docker安装RocketMQ、RocketMQ-Dashboard">
  <meta property="og:description" content="0. 引言 最近本地启动以前docker安装的rocketmq发现报错了，因为是从老mac迁移过来的，发现支持的芯片还是amd的，于是重新在docker下安装rocketmq，并记录下步骤，方便大家后续参考。
1. 步骤 1、先下载项目源码
git clone https://github.com/apache/rocketmq-docker.git 2、在官方项目rocketmq-docker中已经说明了docker安装rocketmq的步骤，因此我们只需要根据官方的提示执行即可
2、生成镜像
# 进入刚才下载的源码文件夹，然后进入image-build路径 cd image-build # 这里RMQ-VERSION换成你想要安装的版本，比如我这里是4.8.0 sh build-image.sh 4.8.0 BASE-IMAGE 3、因为是arm芯片，执行这一步会报如下错误：
ERROR: failed to solve: eclipse-temurin:8-jdk-alpine: no match for platform in manifest 其原因就是因为这里编译时官方指定的jdk版本是x86的，也就是amd芯片的，很明显和arm芯片不符合，在github中也有该问题的详细解释和解决之法：https://github.com/apache/rocketmq-docker/issues/89
具体的原因大家有兴趣可以详细查看，这里我们直接讲解决的办法，就是在编译的时候，执行系统为centos，让其选择安装为适配了arm的jdk，指令如下：
sh build-image.sh 4.8.0 centos 这里耐心等待下载完成
4、下载完成后，执行docker image可以查看镜像，如下最新的一个就是我们刚刚编译的镜像，我这里底下的就是之前amd架构的镜像，已经不能适用
5、接下来我们继续编译rocketmq管理后台的镜像，当然如果你不需要可以跳过这步，早期版本管理后台是在rocketmq项目中的rocketmq-console模块，现在已经单独提取出来，叫rocketmq-dashboard项目。项目地址：https://github.com/apache/rocketmq-dashboard
该项目简介中也告诉我们docker的安装方法了，但官方编译的镜像也是基于amd版的jdk的，需要我们单独编译
6、下载源码到本地
git clone https://github.com/apache/rocketmq-dashboard.git 7、修改项目src/main/docker下的Dockerfile文件，将其中的java调整为支持arm芯片的版本openjdk:8
#FROM java:8 FROM openjdk:8 VOLUME /tmp ADD rocketmq-dashboard-*.jar rocketmq-dashboard.jar RUN sh -c &#39;touch /rocketmq-dashboard.jar&#39; ENV JAVA_OPTS=&#34;&#34; ENTRYPOINT [ &#34;sh&#34;, &#34;-c&#34;, &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-14T16:34:21+08:00">
    <meta property="article:modified_time" content="2024-06-14T16:34:21+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mac M1：通过docker安装RocketMQ、RocketMQ-Dashboard</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="0__0"></a>0. 引言</h2> 
<p>最近本地启动以前docker安装的rocketmq发现报错了，因为是从老mac迁移过来的，发现支持的芯片还是amd的，于是重新在docker下安装rocketmq，并记录下步骤，方便大家后续参考。</p> 
<h2><a id="1__3"></a>1. 步骤</h2> 
<p>1、先下载项目源码</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://github.com/apache/rocketmq-docker.git
</code></pre> 
<p>2、在官方项目<a href="https://github.com/apache/rocketmq-docker">rocketmq-docker</a>中已经说明了docker安装rocketmq的步骤，因此我们只需要根据官方的提示执行即可<br> <img src="https://images2.imgbox.com/de/1c/fZs0hFky_o.png" alt="在这里插入图片描述"></p> 
<p>2、生成镜像</p> 
<pre><code class="prism language-shell"><span class="token comment"># 进入刚才下载的源码文件夹，然后进入image-build路径</span>
<span class="token builtin class-name">cd</span> image-build
<span class="token comment"># 这里RMQ-VERSION换成你想要安装的版本，比如我这里是4.8.0</span>
<span class="token function">sh</span> build-image.sh <span class="token number">4.8</span>.0 BASE-IMAGE
</code></pre> 
<p>3、因为是arm芯片，执行这一步会报如下错误：<br> <code>ERROR: failed to solve: eclipse-temurin:8-jdk-alpine: no match for platform in manifest </code></p> 
<p><img src="https://images2.imgbox.com/f2/b3/3RR0Dp1A_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>其原因就是因为这里编译时官方指定的jdk版本是x86的，也就是amd芯片的，很明显和arm芯片不符合，在github中也有该问题的详细解释和解决之法：<a href="https://github.com/apache/rocketmq-docker/issues/89">https://github.com/apache/rocketmq-docker/issues/89</a></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/18/48/LdlSVBbI_o.png" alt="在这里插入图片描述"><br> 具体的原因大家有兴趣可以详细查看，这里我们直接讲解决的办法，就是在编译的时候，执行系统为centos，让其选择安装为适配了arm的jdk，指令如下：</p> 
<pre><code class="prism language-shell"><span class="token function">sh</span> build-image.sh <span class="token number">4.8</span>.0 centos
</code></pre> 
<p>这里耐心等待下载完成<br> <img src="https://images2.imgbox.com/32/ce/DZZgiLfV_o.png" alt="在这里插入图片描述"></p> 
<p>4、下载完成后，执行<code>docker image</code>可以查看镜像，如下最新的一个就是我们刚刚编译的镜像，我这里底下的就是之前amd架构的镜像，已经不能适用<br> <img src="https://images2.imgbox.com/ed/a5/zyusE2Zt_o.png" alt="在这里插入图片描述"><br> 5、接下来我们继续编译rocketmq管理后台的镜像，当然如果你不需要可以跳过这步，早期版本管理后台是在rocketmq项目中的rocketmq-console模块，现在已经单独提取出来，叫rocketmq-dashboard项目。项目地址：<a href="https://github.com/apache/rocketmq-dashboard">https://github.com/apache/rocketmq-dashboard</a></p> 
<p>该项目简介中也告诉我们docker的安装方法了，但官方编译的镜像也是基于amd版的jdk的，需要我们单独编译</p> 
<p><img src="https://images2.imgbox.com/b8/9a/wokOBeJ9_o.png" alt="在这里插入图片描述"><br> 6、下载源码到本地</p> 
<pre><code class="prism language-shell"><span class="token function">git</span> clone https://github.com/apache/rocketmq-dashboard.git
</code></pre> 
<p>7、修改项目<code>src/main/docker</code>下的Dockerfile文件，将其中的java调整为支持arm芯片的版本openjdk:8</p> 
<pre><code class="prism language-yml"><span class="token comment">#FROM java:8</span>
FROM openjdk<span class="token punctuation">:</span><span class="token number">8</span>
VOLUME /tmp
ADD rocketmq<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span><span class="token important">*.jar</span> rocketmq<span class="token punctuation">-</span>dashboard.jar
RUN sh <span class="token punctuation">-</span>c 'touch /rocketmq<span class="token punctuation">-</span>dashboard.jar'
ENV JAVA_OPTS=""
ENTRYPOINT <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"java $JAVA_OPTS -jar /rocketmq-dashboard.jar"</span> <span class="token punctuation">]</span>
</code></pre> 
<p>8、因为项目是maven项目，我们通过maven指令打包项目，并通过docker build将其打包镜像</p> 
<pre><code class="prism language-shell">mvn clean package <span class="token parameter variable">-Dmaven.test.skip</span><span class="token operator">=</span>true docker:build
</code></pre> 
<p><img src="https://images2.imgbox.com/57/1b/JFqcjjtP_o.png" alt="在这里插入图片描述"></p> 
<p>11、查看镜像</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> images
</code></pre> 
<p><img src="https://images2.imgbox.com/ae/9b/BR8YbB0A_o.png" alt="在这里插入图片描述"></p> 
<p>12、本地创建broker.conf配置文件，我们映射到容器中，方便后续调整，这里如果你需要配置其他的配置项，也可以添加，这里我们再添加一个namesrv.conf配置文件，内容暂时为空，方便后续添加namesrv配置</p> 
<pre><code>brokerClusterName = DefaultCluster
brokerName = broker
brokerId = 0
deleteWhen = 04
fileReservedTime = 48
brokerRole = ASYNC_MASTER
flushDiskType = ASYNC_FLUSH
# 你的本机ip, 注意不要写localhost,127.0.0.1等，因为这是放到docker容器中的，我们需要指向mac本机
brokerIP1 = 192.168.244.1
</code></pre> 
<p>13、创建<code>docker-compose.yml</code>配置文件，用于生成容器</p> 
<pre><code class="prism language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">namesrv</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> apache/rocketmq<span class="token punctuation">:</span>4.8.0
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>namesrv
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 9876<span class="token punctuation">:</span><span class="token number">9876</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /Library/software/dockerdata/rocketmq_arm/namesrv.conf<span class="token punctuation">:</span>/home/rocketmq/rocketmq<span class="token punctuation">-</span>4.8.0/conf/namesrv.conf
    <span class="token key atrule">command</span><span class="token punctuation">:</span> sh mqnamesrv <span class="token punctuation">-</span>c /home/rocketmq/rocketmq<span class="token punctuation">-</span>4.8.0/conf/namesrv.conf
  <span class="token key atrule">broker</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> apache/rocketmq<span class="token punctuation">:</span>4.8.0
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>broker
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 10909<span class="token punctuation">:</span><span class="token number">10909</span>
      <span class="token punctuation">-</span> 10911<span class="token punctuation">:</span><span class="token number">10911</span>
      <span class="token punctuation">-</span> 10912<span class="token punctuation">:</span><span class="token number">10912</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token comment"># 这里的broker.conf路径就是上一步你本机创建的文件路径</span>
    <span class="token punctuation">-</span> /Library/software/dockerdata/rocketmq_arm/broker.conf<span class="token punctuation">:</span>/home/rocketmq/rocketmq<span class="token punctuation">-</span>4.8.0/conf/broker.conf
    <span class="token key atrule">command</span><span class="token punctuation">:</span> sh mqbroker <span class="token punctuation">-</span>n namesrv<span class="token punctuation">:</span>9876 <span class="token punctuation">-</span>c /home/rocketmq/rocketmq<span class="token punctuation">-</span>4.8.0/conf/broker.conf
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> namesrv
  <span class="token key atrule">mqdashboard</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> apacherocketmq/rocketmq<span class="token punctuation">-</span>dashboard<span class="token punctuation">:</span>latest
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> rocketmq<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 8180<span class="token punctuation">:</span><span class="token number">8080</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">JAVA_OPTS</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>Drocketmq.config.namesrvAddrs=namesrv<span class="token punctuation">:</span>9876 <span class="token punctuation">-</span>Drocketmq.config.isVIPChannel=false
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> namesrv
</code></pre> 
<p>13、执行docker-compose生成容器</p> 
<pre><code class="prism language-shell"><span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker-compose.yml up <span class="token parameter variable">-d</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0d/f6/9VLBG3Ks_o.png" alt="在这里插入图片描述"></p> 
<p>14、docker中可以看到3个容器启动成功<br> <img src="https://images2.imgbox.com/ec/f2/NTVmZ2Xg_o.png" alt="在这里插入图片描述"></p> 
<p>15、访问：localhost:8180, 这里端口和你上述docker-compose中配置的映射端口保持一致<br> <img src="https://images2.imgbox.com/e1/18/fl1Tt44V_o.png" alt="在这里插入图片描述"><br> 安装完成</p> 
<h2><a id="2__137"></a>2. 测试</h2> 
<p>最后发送几条消息进行测试一下</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">MQBrokerException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">MQClientException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">DefaultMQProducer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">SendResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>common<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span><span class="token class-name">Message</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>rocketmq<span class="token punctuation">.</span>remoting<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">RemotingException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>


<span class="token comment">/**
 * @author benjamin_5
 * @Description
 * @date 2024/2/25
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerDemo</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span><span class="token punctuation">,</span> <span class="token class-name">MQBrokerException</span><span class="token punctuation">,</span> <span class="token class-name">RemotingException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">DefaultMQProducer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"group_test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"localhost:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setVipChannelEnabled</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 启动实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"topic_test"</span><span class="token punctuation">,</span> <span class="token string">"tag_test"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"hello "</span><span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SendResult</span> send <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>send<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>如果出现连接超时的问题<code>invokSync call timeout</code>，先检查下broker.conf中配置的ip是否是本机ip</p> 
<p>确认无误后mac执行如下指令，重新设置一下本机本地hostname</p> 
<pre><code class="prism language-shell">scutil <span class="token parameter variable">--set</span> HostName <span class="token variable"><span class="token variable">$(</span>scutil <span class="token parameter variable">--get</span> LocalHostName<span class="token variable">)</span></span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e7/02/JJFyR9pe_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/15fffdf11c2449b97d6a1ec404505468/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">新手怎么使用GitHub?</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1a50319e687168fe9e23d03b1231d1aa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CB5309高集成国产2.4 GHz射频前端放大器功放芯片</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>