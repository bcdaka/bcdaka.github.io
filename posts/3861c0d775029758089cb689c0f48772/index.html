<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Unity2021通过aar调用Android方法 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3861c0d775029758089cb689c0f48772/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Unity2021通过aar调用Android方法">
  <meta property="og:description" content="开发环境：Android Studio Dolphin | 2021.3.1 Patch 1、Unity2021.3.35f1
本方法无需复制Unity的class.jar到Android Studio工程，java代码也无需获取UnityActivity。
可参见油管上的教学视频
一、Android Studio中创建aar 打开Android Studio，新建工程
新建模块
新建Java类
在PluginInstance.java中输入代码
package com.example.libforunity; import android.app.Activity; import android.widget.Toast; public class PluginInstance { public int Add(int i,int j){ return i&#43;j; } private static Activity unityActivity; public static void receiveUnityActivity(Activity tActivity){ unityActivity = tActivity; } public void Toast(String msg) { Toast.makeText(unityActivity,msg,Toast.LENGTH_SHORT).show(); } } 编译Library
可看到生成的aar文件了
二、在Unity中调用aar中的方法 打开Unity，新建工程
在Assets下新建Plugins/Android文件夹，并将生成的aar复制到该文件夹下
创建两个按钮和一个文本框
创建脚本PluginInit，编写代码
using System.Collections; using System.Collections.Generic; using UnityEngine; using UnityEngine.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-17T17:54:37+08:00">
    <meta property="article:modified_time" content="2024-05-17T17:54:37+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Unity2021通过aar调用Android方法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>开发环境：Android Studio Dolphin | 2021.3.1 Patch 1、Unity2021.3.35f1</p> 
<p><strong><span style="color:#fe2c24;">本方法无需复制Unity的class.jar到Android Studio工程，java代码也无需获取UnityActivity。</span></strong></p> 
<p><a class="link-info" href="https://www.youtube.com/watch?v=6u7FV-e6nUc" rel="nofollow" title="可参见油管上的教学视频">可参见油管上的教学视频</a></p> 
<h2>一、Android Studio中创建aar</h2> 
<p>打开Android Studio，新建工程</p> 
<p><img alt="" height="654" src="https://images2.imgbox.com/d2/1e/MbKKMgCt_o.png" width="905"></p> 
<p><img alt="" height="656" src="https://images2.imgbox.com/a5/8d/7KEKszee_o.png" width="907"></p> 
<p><img alt="" height="606" src="https://images2.imgbox.com/83/cf/LHpeZtZu_o.png" width="940"></p> 
<p>新建模块</p> 
<p><img alt="" height="250" src="https://images2.imgbox.com/af/73/PQmXA3BI_o.png" width="581"></p> 
<p><img alt="" height="535" src="https://images2.imgbox.com/23/ba/OwuBzf7t_o.png" width="731"></p> 
<p><img alt="" height="605" src="https://images2.imgbox.com/16/52/CIt5yhdK_o.png" width="942"></p> 
<p>新建Java类</p> 
<p><img alt="" height="611" src="https://images2.imgbox.com/89/1e/iv4lwq1p_o.png" width="950"></p> 
<p><img alt="" height="157" src="https://images2.imgbox.com/89/d0/aYs4iPLZ_o.png" width="331"></p> 
<p>在PluginInstance.java中输入代码</p> 
<pre><code class="language-java">package com.example.libforunity;

import android.app.Activity;
import android.widget.Toast;

public class PluginInstance {
    public int Add(int i,int j){
        return i+j;
    }

    private static Activity unityActivity;
    public  static  void receiveUnityActivity(Activity tActivity){
        unityActivity = tActivity;
    }

    public void Toast(String msg)
    {
        Toast.makeText(unityActivity,msg,Toast.LENGTH_SHORT).show();
    }
}
</code></pre> 
<p>编译Library<img alt="" height="611" src="https://images2.imgbox.com/0a/58/mkn5hIDj_o.png" width="1095"></p> 
<p><img alt="" height="277" src="https://images2.imgbox.com/08/80/dxhEgaS1_o.png" width="1089"></p> 
<p>可看到生成的aar文件了</p> 
<p><img alt="" height="682" src="https://images2.imgbox.com/83/b1/G3IiLOMl_o.png" width="1085"></p> 
<h2>二、在Unity中调用aar中的方法</h2> 
<p>打开Unity，新建工程</p> 
<p><img alt="" height="630" src="https://images2.imgbox.com/95/9e/3MZC3qLA_o.png" width="1090"></p> 
<p>在Assets下新建Plugins/Android文件夹，并将生成的aar复制到该文件夹下</p> 
<p><img alt="" height="271" src="https://images2.imgbox.com/99/04/8u60enga_o.png" width="921"></p> 
<p>创建两个按钮和一个文本框</p> 
<p><img alt="" height="285" src="https://images2.imgbox.com/c7/35/8FoHnUsv_o.png" width="654"></p> 
<p>创建脚本PluginInit，编写代码</p> 
<pre><code class="language-java">using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class PluginInit : MonoBehaviour
{
    public Button btnAdd;
    public Button btnToast;
    public Text textPrompt;

    AndroidJavaClass unityClass;
    AndroidJavaObject unityActivity;
    AndroidJavaObject _pluginInstance;
    // Start is called before the first frame update
    void Start()
    {
        btnAdd.onClick.AddListener(Add);
        btnToast.onClick.AddListener(Toast);
        InitializePlugin("com.example.libforunity.PluginInstance");
    }

    void InitializePlugin(string pluginName)
    {
        unityClass = new AndroidJavaClass("com.unity3d.player.UnityPlayer");
        unityActivity = unityClass.GetStatic&lt;AndroidJavaObject&gt;("currentActivity");
        _pluginInstance = new AndroidJavaObject(pluginName);
        if(_pluginInstance == null)
        {
            Debug.Log("Plugin Instance Error");
        }
        _pluginInstance.CallStatic("receiveUnityActivity", unityActivity);
    }

    public void Add()
    {
        if(_pluginInstance != null)
        {
            int result = _pluginInstance.Call&lt;int&gt;("Add", 5, 6);
            textPrompt.text = string.Format("Add Result from unity:{0}", result);
        }
    }

    public void Toast()
    {
        if (_pluginInstance != null)
        {
            _pluginInstance.Call("Toast", "Hi,from Unity");
        }
    }
}
</code></pre> 
<p></p> 
<p><img alt="" height="570" src="https://images2.imgbox.com/27/8f/dAeUAXiA_o.png" width="1200">给脚本赋值，发布APK，运行</p> 
<p><img alt="" height="485" src="https://images2.imgbox.com/e8/fd/XR3JLfsj_o.png" width="295"></p> 
<h2>三、在aar中引用第三方aar插件</h2> 
<p>这里我们以一个USB小票打印插件（autoreplyprint.aar）为例，主要参考了其官方提供的安卓工程，需要将相关功能移植到Unity环境下。</p> 
<p>复制autoreplyprint.aar和res/xml/device_filter.xml到工程中（<span style="color:#fe2c24;">res下的文件也将自动打包到aar中</span>）</p> 
<p><img alt="" height="304" src="https://images2.imgbox.com/77/c9/le2j8WoJ_o.png" width="448"></p> 
<p>在PluginInstance.java中加入两个方法和一个变量</p> 
<p><img alt="" height="574" src="https://images2.imgbox.com/35/95/bkxEPkv3_o.png" width="965"></p> 
<pre><code class="language-java">public  String EnumUsb()
    {
        String result = "";
        String[] devicePaths = AutoReplyPrint.CP_Port_EnumUsb_Helper.EnumUsb();
        if (devicePaths != null) {
            for (int i = 0; i &lt; devicePaths.length; ++i) {
                String name = devicePaths[i];
                result += name;
                result += "|";
            }
        }

        return result;
    }

    public void OpenUSB(String usbName)
    {
        new Thread(new Runnable() {
            @Override
            public void run() {
                h = AutoReplyPrint.INSTANCE.CP_Port_OpenUsb(usbName, 1);
                AutoReplyPrint.INSTANCE.CP_Pos_SetMultiByteMode(h);
                AutoReplyPrint.INSTANCE.CP_Pos_SetMultiByteEncoding(h, AutoReplyPrint.CP_MultiByteEncoding_UTF8);
                AutoReplyPrint.INSTANCE.CP_Pos_SetTextBold(h, 0);
            }
        }).start();
    }</code></pre> 
<pre><code class="language-java">private Pointer h = Pointer.NULL;</code></pre> 
<p>接下来会发现当使用autoreplyprint.aar中的类时提示没有定义</p> 
<p><img alt="" height="765" src="https://images2.imgbox.com/60/2c/AZV9L4MT_o.png" width="1162"></p> 
<p>  在build.gradle的dependencies中添加依赖项，然后点击Sync(大象图标)，进行同步</p> 
<pre><code class="language-java">compileOnly files('./libs/autoreplyprint.aar')</code></pre> 
<p><img alt="" height="850" src="https://images2.imgbox.com/56/c5/vvD8XXcW_o.png" width="1200"></p> 
<p>鼠标再移到未定义类上就会现【Import class】，点击它就可自动引用了，再次生成aar</p> 
<p><img alt="" height="227" src="https://images2.imgbox.com/09/7d/dcN2l8Ge_o.png" width="350"></p> 
<p>复制生成的aar和<span style="color:#fe2c24;">autoreplyprint.aar（不要忘了）</span>到unity，新增两个按钮EnumUSB、OpenUSB和一个下拉列表，下拉列表用于显示发现的USB串口</p> 
<p><img alt="" height="339" src="https://images2.imgbox.com/ee/f2/PldwriDv_o.png" width="351"></p> 
<pre><code class="language-java">    public Button btnEnumUSB;
    public Button btnOpenUSB;
    public Dropdown usbList;

......
    btnEnumUSB.onClick.AddListener(EnumUsb);
    btnOpenUSB.onClick.AddListener(OpenUsb);
......

public void EnumUsb()
    {
        if (_pluginInstance != null)
        {
            string result = _pluginInstance.Call&lt;string&gt;("EnumUsb");
            string[] usbArray = result.Split(new char[] { '|' });
            usbList.AddOptions(usbArray.ToList());

            Debug.Log(string.Format("EnumUsb result={0}", result));
        }
    }

    public void OpenUsb()
    {
        if (_pluginInstance != null)
        {
            string usb = usbList.options[usbList.value].ToString();
            _pluginInstance.Call("OpenUSB", usb);
        }
    }</code></pre> 
<p>打包运行，发现无法识别USB串口，原因是在AndroidManifest.xml中没有添加USB权限</p> 
<p><span style="color:#fe2c24;"><strong>为避免多个AndroidManifest.xml合并时的冲突，先将Unity工程导出为Android 工程，再编辑保存。</strong></span></p> 
<p>将Unity工程导出为Android 工程，打开导出工程中的unityLibrary\src\main\AndroidManifest.xml，添加USB相关权根</p> 
<p><img alt="" height="516" src="https://images2.imgbox.com/73/64/1Js3uErQ_o.png" width="1200"></p> 
<pre><code class="language-java">&lt;action android:name="android.hardware.usb.action.USB_DEVICE_ATTACHED"/&gt;</code></pre> 
<pre><code class="language-java">&lt;meta-data android:name="android.hardware.usb.action.USB_DEVICE_ATTACHED" android:resource="@xml/device_filter"/&gt;</code></pre> 
<p> 然后另存为到Assets\Plugins\Android 目录下，保存后再次打开确认一下是否真的修改了。</p> 
<p><img alt="" height="261" src="https://images2.imgbox.com/9e/7b/evaw46ur_o.png" width="824"></p> 
<p>再次打包运行， 发现这次可以正确识别USB了。</p> 
<p><img alt="" height="590" src="https://images2.imgbox.com/81/f6/55pJGern_o.jpg" width="442"></p> 
<p><img alt="" height="619" src="https://images2.imgbox.com/36/4e/nbjQYkOR_o.jpg" width="464"></p> 
<p>全文完。写作不易，请收藏点赞，谢谢！！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/384b1077c7766bb6b672f4fc25001d08/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Windws MySQL 8.4 LTS的安装（保姆级教程）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2073266bbdc7c1ef187748041106c3c0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">全网最详细的 Midjourney教程：品牌 Logo生成</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>