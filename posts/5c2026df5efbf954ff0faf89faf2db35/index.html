<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ASP.NET前后端分离，WebApi。Vue3&#43;ElementPlus&#43;Axios&#43;Pinia全流程教程 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/5c2026df5efbf954ff0faf89faf2db35/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="ASP.NET前后端分离，WebApi。Vue3&#43;ElementPlus&#43;Axios&#43;Pinia全流程教程">
  <meta property="og:description" content="文章目录 前言1、.net core 执行过程2、中间件的执行过程3、AOP切面编程 Swagger添加Swagger注释 JWT1、解析2、配置JWT 配置SqlSugar0、引入`SqlSugarCore`包1、编写`Context`类2、配置实体类3、创建`Service`服务类进行数据库的CRUD4、配置Controller进行路由 依赖注入与IOCIOC依赖注入DIAutofac轻量容器的使用使用Autofac完成AOP日志 使用扩展进行服务注册Webapi的操作返回值和方法参数返回值ActionResult操作方法的参数URLQueryString请求报文体总结 VUE项目结构主要文件项目运行流程添加Element-ui、AXIOS Axios与piniaAXIOS使用npm等包管理工具下载axios创建axios实例、封装get、post请求方法封装api接口调用方法在页面中调用api pinia使用使用npm下载pinia创建Store文件进行状态存储在页面组件中实例化状态并赋值 前言 1、.net core 执行过程 2、中间件的执行过程 3、AOP切面编程 Swagger 添加Swagger注释 1、右击项目-&gt;选择属性-&gt;点击生成-&gt;输出，选中文档文件
2、配置服务
在program.cs 文件里配置SwaggerUI
//增加项一 builder.Services.AddSwaggerGen(c=&gt; { c.SwaggerDoc(&#34;v1&#34;, new OpenApiInfo { Title = &#34;Web API&#34;, Version = &#34;v1&#34; }); var xmlFile = $&#34;{Assembly.GetEntryAssembly().GetName().Name}.xml&#34;; var xmlPath = Path.Combine(AppContext.BaseDirectory, xmlFile); c.IncludeXmlComments(xmlPath); }); //增加项二 if (app.Environment.IsDevelopment()) { app.UseSwagger(); app.UseSwaggerUI(c =&gt; { c.SwaggerEndpoint(&#34;/swagger/v1/swagger.json&#34;, &#34;My API V1&#34;); }); } 3、在控制器的方法上加上注释即可在swagger网页上看到注释
4、添加实体类的Swagger注释
JWT 1、解析 1）客户端向授权服务系统发起请求，申请获取“令牌”。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-12T18:51:31+08:00">
    <meta property="article:modified_time" content="2024-08-12T18:51:31+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ASP.NET前后端分离，WebApi。Vue3&#43;ElementPlus&#43;Axios&#43;Pinia全流程教程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><ul><li><a href="#1net_core__3" rel="nofollow">1、.net core 执行过程</a></li><li><a href="#2_7" rel="nofollow">2、中间件的执行过程</a></li><li><a href="#3AOP_11" rel="nofollow">3、AOP切面编程</a></li></ul> 
  </li><li><a href="#Swagger_17" rel="nofollow">Swagger</a></li><li><ul><li><a href="#Swagger_19" rel="nofollow">添加Swagger注释</a></li></ul> 
  </li><li><a href="#JWT_65" rel="nofollow">JWT</a></li><li><ul><li><a href="#1_67" rel="nofollow">1、解析</a></li><li><a href="#2JWT_75" rel="nofollow">2、配置JWT</a></li></ul> 
  </li><li><a href="#SqlSugar_444" rel="nofollow">配置SqlSugar</a></li><li><ul><li><a href="#0SqlSugarCore_446" rel="nofollow">0、引入`SqlSugarCore`包</a></li><li><a href="#1Context_448" rel="nofollow">1、编写`Context`类</a></li><li><a href="#2_461" rel="nofollow">2、配置实体类</a></li><li><a href="#3ServiceCRUD_485" rel="nofollow">3、创建`Service`服务类进行数据库的CRUD</a></li><li><a href="#4Controller_534" rel="nofollow">4、配置Controller进行路由</a></li></ul> 
  </li><li><a href="#IOC_605" rel="nofollow">依赖注入与IOC</a></li><li><ul><li><a href="#IOC_607" rel="nofollow">IOC</a></li><li><a href="#DI_615" rel="nofollow">依赖注入DI</a></li><li><a href="#Autofac_661" rel="nofollow">Autofac轻量容器的使用</a></li><li><a href="#AutofacAOP_739" rel="nofollow">使用Autofac完成AOP日志</a></li></ul> 
  </li><li><a href="#_953" rel="nofollow">使用扩展进行服务注册</a></li><li><a href="#Webapi_1174" rel="nofollow">Webapi的操作返回值和方法参数</a></li><li><ul><li><a href="#ActionResult_1176" rel="nofollow">返回值ActionResult</a></li><li><a href="#_1193" rel="nofollow">操作方法的参数</a></li><li><ul><li><a href="#URL_1197" rel="nofollow">URL</a></li><li><a href="#QueryString_1207" rel="nofollow">QueryString</a></li><li><a href="#_1225" rel="nofollow">请求报文体</a></li><li><a href="#_1234" rel="nofollow">总结</a></li></ul> 
  </li></ul> 
  </li><li><a href="#VUE_1238" rel="nofollow">VUE项目结构</a></li><li><ul><li><a href="#_1290" rel="nofollow">主要文件</a></li><li><a href="#_1297" rel="nofollow">项目运行流程</a></li><li><a href="#ElementuiAXIOS_1307" rel="nofollow">添加Element-ui、AXIOS</a></li></ul> 
  </li><li><a href="#Axiospinia_1315" rel="nofollow">Axios与pinia</a></li><li><ul><li><a href="#AXIOS_1317" rel="nofollow">AXIOS</a></li><li><ul><li><a href="#npmaxios_1321" rel="nofollow">使用npm等包管理工具下载axios</a></li><li><a href="#axiosgetpost_1325" rel="nofollow">创建axios实例、封装get、post请求方法</a></li><li><a href="#api_1422" rel="nofollow">封装api接口调用方法</a></li><li><a href="#api_1436" rel="nofollow">在页面中调用api</a></li></ul> 
   </li><li><a href="#pinia_1460" rel="nofollow">pinia使用</a></li><li><ul><li><a href="#npmpinia_1462" rel="nofollow">使用npm下载pinia</a></li><li><a href="#Store_1466" rel="nofollow">创建Store文件进行状态存储</a></li><li><a href="#_1482" rel="nofollow">在页面组件中实例化状态并赋值</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<h3><a id="1net_core__3"></a>1、.net core 执行过程</h3> 
<p><img src="https://images2.imgbox.com/9b/08/B1VsgLva_o.png" alt="img"></p> 
<h3><a id="2_7"></a>2、中间件的执行过程</h3> 
<p><img src="https://images2.imgbox.com/63/8c/R4pJ9Dai_o.png" alt="img"></p> 
<h3><a id="3AOP_11"></a>3、AOP切面编程</h3> 
<p><img src="https://images2.imgbox.com/d7/e3/12AHw9k8_o.png" alt="img"></p> 
<p><img src="https://images2.imgbox.com/77/46/5CyGXpvz_o.png" alt="img"></p> 
<h2><a id="Swagger_17"></a>Swagger</h2> 
<h3><a id="Swagger_19"></a>添加Swagger注释</h3> 
<p>1、右击项目-&gt;选择属性-&gt;点击生成-&gt;输出，选中文档文件<br> <img src="https://images2.imgbox.com/9c/29/YyO1otU6_o.png" alt="在这里插入图片描述"></p> 
<p>2、配置服务</p> 
<p>在<code>program.cs</code> 文件里配置<code>SwaggerUI</code></p> 
<pre><code class="prism language-cs"><span class="token comment">//增加项一</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSwaggerGen</span><span class="token punctuation">(</span>c<span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    c<span class="token punctuation">.</span><span class="token function">SwaggerDoc</span><span class="token punctuation">(</span><span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiInfo</span> <span class="token punctuation">{<!-- --></span> Title <span class="token operator">=</span> <span class="token string">"Web API"</span><span class="token punctuation">,</span> Version <span class="token operator">=</span> <span class="token string">"v1"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> xmlFile <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Assembly<span class="token punctuation">.</span><span class="token function">GetEntryAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">.xml"</span></span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> xmlPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>AppContext<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">,</span> xmlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    c<span class="token punctuation">.</span><span class="token function">IncludeXmlComments</span><span class="token punctuation">(</span>xmlPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//增加项二</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>Environment<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    app<span class="token punctuation">.</span><span class="token function">UseSwagger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">UseSwaggerUI</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        c<span class="token punctuation">.</span><span class="token function">SwaggerEndpoint</span><span class="token punctuation">(</span><span class="token string">"/swagger/v1/swagger.json"</span><span class="token punctuation">,</span> <span class="token string">"My API V1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>3、在控制器的方法上加上注释即可在swagger网页上看到注释</p> 
<p><img src="https://images2.imgbox.com/ad/6e/UY8jtnyG_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/3f/e5/CFv1tkhg_o.png" alt="在这里插入图片描述"></p> 
<p>4、添加实体类的Swagger注释</p> 
<p><img src="https://images2.imgbox.com/78/20/alK4lmHm_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/2a/98/e50dDnAy_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="JWT_65"></a>JWT</h2> 
<h3><a id="1_67"></a>1、解析</h3> 
<blockquote> 
 <p>1）客户端向授权服务系统发起请求，申请获取“令牌”。</p> 
 <p>2）授权服务根据用户身份，生成一张专属“令牌”，并将该“令牌”以JWT规范返回给客户端</p> 
 <p>3）客户端将获取到的“令牌”放到http请求的headers中后，向主服务系统发起请求。主服务系统收到请求后会从headers中获取“令牌”，并从“令牌”中解析出该用户的身份权限，然后做出相应的处理（同意或拒绝返回资源）</p> 
</blockquote> 
<h3><a id="2JWT_75"></a>2、配置JWT</h3> 
<p>1、添加NuGet包<code>Microsoft.AspNetCore.Authentication.JwtBearer</code></p> 
<p>2、在<code>appsettings.json</code>中添加JWT配置节点</p> 
<pre><code class="prism language-json">   <span class="token string-property property">"JWT"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"SecKey"</span><span class="token operator">:</span> <span class="token string">"Jamin1127!#@$%@%^^&amp;*(~Czmjklneafguvioszb%yuv&amp;*6WVDf5dw#5dfw6f5w6faW%FW^f5wa65f^AWf56"</span><span class="token punctuation">,</span> <span class="token comment">//密钥</span>
    <span class="token string-property property">"Issuer"</span><span class="token operator">:</span> <span class="token string">"Jamin"</span><span class="token punctuation">,</span>  <span class="token comment">//发行者</span>
    <span class="token string-property property">"ExpireSeconds"</span><span class="token operator">:</span> <span class="token number">7200</span> <span class="token comment">//过期时间</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>3、在Program类里进行服务注册</p> 
<pre><code class="prism language-cs"><span class="token preprocessor property">#<span class="token directive keyword">region</span> JWT服务</span>
<span class="token comment">// 注册JWT服务</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtHelper</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{<!-- --></span>
    options<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ValidateIssuer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否验证Issuer</span>
        ValidIssuer <span class="token operator">=</span> builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">[</span><span class="token string">"Jwt:Issuer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//发行人Issuer</span>
        ValidateAudience <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//是否验证Audience      </span>
        ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否验证SecurityKey</span>
        IssuerSigningKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">[</span><span class="token string">"Jwt:SecKey"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//SecurityKey</span>
        ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否验证失效时间</span>
        ClockSkew <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//过期时间容错值，解决服务器端时间不同步问题（秒）</span>
        RequireExpirationTime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">/***    "Client" 策略要求用户必须拥有 "Client" 角色才能访问相关资源。
"Admin" 策略要求用户必须拥有 "Admin" 角色才能访问相关资源。
"SystemOrAdmin" 策略要求用户必须拥有 "Admin" 或者 "System" 角色之一才能访问相关资源。***/</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"Client"</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">"Client"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"Admin"</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">"Admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"SystemOrAdmin"</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">"Admin"</span><span class="token punctuation">,</span> <span class="token string">"System"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
<span class="token comment">//swagger里添加JWT授权</span>
    builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSwaggerGen</span><span class="token punctuation">(</span>c<span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    c<span class="token punctuation">.</span><span class="token function">SwaggerDoc</span><span class="token punctuation">(</span><span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiInfo</span> <span class="token punctuation">{<!-- --></span> Title <span class="token operator">=</span> <span class="token string">"Web API"</span><span class="token punctuation">,</span> Version <span class="token operator">=</span> <span class="token string">"v1"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//开启注释</span>
    <span class="token class-name"><span class="token keyword">var</span></span> xmlFile <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Assembly<span class="token punctuation">.</span><span class="token function">GetEntryAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">.xml"</span></span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> xmlPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>AppContext<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">,</span> xmlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    c<span class="token punctuation">.</span><span class="token function">IncludeXmlComments</span><span class="token punctuation">(</span>xmlPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 配置 JWT Bearer 授权</span>
    c<span class="token punctuation">.</span><span class="token function">AddSecurityDefinition</span><span class="token punctuation">(</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
    <span class="token punctuation">{<!-- --></span>
        Description <span class="token operator">=</span> <span class="token string">"JWT Authorization header using the Bearer scheme"</span><span class="token punctuation">,</span>
        Name <span class="token operator">=</span> <span class="token string">"Authorization"</span><span class="token punctuation">,</span>
        In <span class="token operator">=</span> ParameterLocation<span class="token punctuation">.</span>Header<span class="token punctuation">,</span>
        Type <span class="token operator">=</span> SecuritySchemeType<span class="token punctuation">.</span>Http<span class="token punctuation">,</span>
        Scheme <span class="token operator">=</span> <span class="token string">"bearer"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> securityScheme <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
    <span class="token punctuation">{<!-- --></span>
        Reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiReference</span> <span class="token punctuation">{<!-- --></span> Type <span class="token operator">=</span> ReferenceType<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">,</span> Id <span class="token operator">=</span> <span class="token string">"Bearer"</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> securityRequirement <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityRequirement</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">{<!-- --></span> securityScheme<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    c<span class="token punctuation">.</span><span class="token function">AddSecurityRequirement</span><span class="token punctuation">(</span>securityRequirement<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//启用验证中间件</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>4、创建JWT类进行Token配置</p> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Diagnostics</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>Jwt</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Common<span class="token punctuation">.</span>Auth</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 授权JWT类</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtHelper</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IConfiguration</span> _configuration<span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// Token配置</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="configuration"&gt;&lt;/param&gt;</span>
        <span class="token keyword">public</span> <span class="token function">JwtHelper</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 创建Token 这里面可以保存自己想要的信息</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="username"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="mobile"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">CreateToken</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> username<span class="token punctuation">,</span> <span class="token keyword">string</span> mobile，<span class="token class-name"><span class="token keyword">string</span></span> role<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 1. 定义需要使用到的Claims</span>
                <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"mobile"</span><span class="token punctuation">,</span> mobile<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span> role<span class="token punctuation">)</span> <span class="token comment">// 添加用户角色</span>
                    <span class="token comment">/* 可以保存自己想要信息，传参进来即可
                    new Claim("sex", "sex"),
                    new Claim("limit", "limit"),
                    new Claim("head_url", "xxxxx")
                    */</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token comment">// 2. 从 appsettings.json 中读取SecretKey</span>
                <span class="token class-name"><span class="token keyword">var</span></span> secretKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>_configuration<span class="token punctuation">[</span><span class="token string">"Jwt:SecKey"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 3. 选择加密算法</span>
                <span class="token class-name"><span class="token keyword">var</span></span> algorithm <span class="token operator">=</span> SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256<span class="token punctuation">;</span>

                <span class="token comment">// 4. 生成Credentials</span>
                <span class="token class-name"><span class="token keyword">var</span></span> signingCredentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SigningCredentials</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">,</span> algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 5. 根据以上，生成token</span>
                <span class="token class-name"><span class="token keyword">var</span></span> jwtSecurityToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>
                    _configuration<span class="token punctuation">[</span><span class="token string">"Jwt:Issuer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">//Issuer</span>
                    _configuration<span class="token punctuation">[</span><span class="token string">"Jwt:ExpireSeconds"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">//ExpireSeconds</span>
                    claims<span class="token punctuation">,</span>                          <span class="token comment">//Claims,</span>
                    DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">,</span>                    <span class="token comment">//notBefore</span>
                    DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">//expires</span>
                    signingCredentials               <span class="token comment">//Credentials</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 6. 将token变为string</span>
                <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>jwtSecurityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">return</span> token<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>

                <span class="token keyword">throw</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
           
        <span class="token punctuation">}</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 获取信息</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="jwt"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ReaderToken</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> jwt<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> str <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty<span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//获取Token的三种方式</span>
                <span class="token comment">//第一种直接用JwtSecurityTokenHandler提供的read方法</span>
                <span class="token class-name"><span class="token keyword">var</span></span> jwtHander <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">JwtSecurityToken</span> jwtSecurityToken <span class="token operator">=</span> jwtHander<span class="token punctuation">.</span><span class="token function">ReadJwtToken</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                str <span class="token operator">=</span> jwtSecurityToken<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Debug<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> str<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 解密jwt</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="jwt"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">JwtDecrypt</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> jwt<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
           
            <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">JwtSecurityTokenHandler</span> tokenHandler <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">TokenValidationParameters</span> valParam <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> securityKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>_configuration<span class="token punctuation">[</span><span class="token string">"Jwt:SecKey"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                valParam<span class="token punctuation">.</span>IssuerSigningKey <span class="token operator">=</span> securityKey<span class="token punctuation">;</span>
                valParam<span class="token punctuation">.</span>ValidateIssuer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                valParam<span class="token punctuation">.</span>ValidateAudience <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment">//解密</span>
                <span class="token class-name">ClaimsPrincipal</span> claimsPrincipal <span class="token operator">=</span> tokenHandler<span class="token punctuation">.</span><span class="token function">ValidateToken</span><span class="token punctuation">(</span>jwt<span class="token punctuation">,</span>
                        valParam<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">SecurityToken</span> secToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> claim <span class="token keyword">in</span> claimsPrincipal<span class="token punctuation">.</span>Claims<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    sb<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">claim<span class="token punctuation">.</span>Type</span><span class="token punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">claim<span class="token punctuation">.</span>Value</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Debug<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p>5、创建用户实体，进行用户密码的接收</p> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>ComponentModel<span class="token punctuation">.</span>DataAnnotations</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Models</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 其中 [Required] 表示非空判断,其他自己研究百度</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token punctuation">[</span>Required<span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> UserName <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Password <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Required</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> PhoneNumber <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>6、创建控制器，进行JWT的APi调用</p> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Common<span class="token punctuation">.</span>Auth</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authorization</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Controllers</span>
<span class="token punctuation">{<!-- --></span>
   
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"[controller]/[action]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">JwtHelper</span> _jwt<span class="token punctuation">;</span>

            <span class="token comment">/// &lt;summary&gt;</span>
            <span class="token comment">/// 初始化</span>
            <span class="token comment">/// &lt;/summary&gt;</span>
            <span class="token comment">/// &lt;param name="jwtHelper"&gt;&lt;/param&gt;</span>
            <span class="token keyword">public</span> <span class="token function">UserController</span><span class="token punctuation">(</span><span class="token class-name">JwtHelper</span> jwtHelper<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _jwt <span class="token operator">=</span> jwtHelper<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">/// &lt;summary&gt;</span>
            <span class="token comment">/// 获取Token</span>
            <span class="token comment">/// &lt;/summary&gt;</span>
            <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
            <span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
            <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">GetToken</span><span class="token punctuation">(</span><span class="token class-name">UserInfo</span> user<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//参数验证等等....</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrEmpty</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>UserName<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token string">"参数异常！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//这里可以连接mysql数据库做账号密码验证</span>


                <span class="token comment">//这里可以做Redis缓存验证等等</span>


                <span class="token comment">//这里获取Token，当然，这里也可以选择传结构体过去</span>
                <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> _jwt<span class="token punctuation">.</span><span class="token function">CreateToken</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>UserName<span class="token punctuation">,</span> user<span class="token punctuation">.</span>PhoneNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token comment">//解密后的Token</span>
                  <span class="token class-name"><span class="token keyword">var</span></span> PWToken <span class="token operator">=</span> _jwt<span class="token punctuation">.</span><span class="token function">JwtDecrypt</span><span class="token punctuation">(</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span>token<span class="token operator">+</span><span class="token string">"解密后："</span><span class="token operator">+</span>PWToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
            <span class="token punctuation">}</span>

            <span class="token comment">/// &lt;summary&gt;</span>
            <span class="token comment">/// 获取自己的详细信息，其中 [Authorize] 就表示要带Token才行</span>
            <span class="token comment">/// &lt;/summary&gt;</span>
            <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
            <span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
            <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span></span><span class="token punctuation">]</span>
            <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">GetSelfInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//执行到这里，就表示已经验证授权通过了</span>
                <span class="token comment">/*
                 * 这里返回个人信息有两种方式
                 * 第一种：从Header中的Token信息反向解析出用户账号，再从数据库中查找返回
                 * 第二种：从Header中的Token信息反向解析出用户账号信息直接返回，当然，在前面创建        Token时，要保存进使用到的Claims中。
                */</span>
                <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token string">"授权通过了！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>

</code></pre> 
<p>7、用来验证权限的控制器</p> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authorization</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Controllers</span>
<span class="token punctuation">{<!-- --></span>
   
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"[controller]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span><span class="token string">"Admin"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span><span class="token string">"User"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><span class="token comment">//增加权限验证</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> Summaries <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Freezing"</span><span class="token punctuation">,</span> <span class="token string">"Bracing"</span><span class="token punctuation">,</span> <span class="token string">"Chilly"</span><span class="token punctuation">,</span> <span class="token string">"Cool"</span><span class="token punctuation">,</span> <span class="token string">"Mild"</span><span class="token punctuation">,</span> <span class="token string">"Warm"</span><span class="token punctuation">,</span> <span class="token string">"Balmy"</span><span class="token punctuation">,</span> <span class="token string">"Hot"</span><span class="token punctuation">,</span> <span class="token string">"Sweltering"</span><span class="token punctuation">,</span> <span class="token string">"Scorching"</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger<span class="token punctuation">&lt;</span>WeatherForecastController<span class="token punctuation">&gt;</span></span> _logger<span class="token punctuation">;</span>    
        <span class="token keyword">public</span> <span class="token function">WeatherForecastController</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>WeatherForecastController<span class="token punctuation">&gt;</span></span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 天气</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;remark&gt;&lt;/remark&gt;</span>
        <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>WeatherForecast<span class="token punctuation">&gt;</span></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>index <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WeatherForecast</span>
            <span class="token punctuation">{<!-- --></span>
                Date <span class="token operator">=</span> DateOnly<span class="token punctuation">.</span><span class="token function">FromDateTime</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                TemperatureC <span class="token operator">=</span> Random<span class="token punctuation">.</span>Shared<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Summary <span class="token operator">=</span> Summaries<span class="token punctuation">[</span>Random<span class="token punctuation">.</span>Shared<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>Summaries<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
       
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/79/8b/soFthAX1_o.png" alt="在这里插入图片描述"></p> 
<p>**注：获取Token后在Swagger上输入token的value就可以进行接口的调用了 **</p> 
<p><img src="https://images2.imgbox.com/b5/33/bjC2mtxD_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="SqlSugar_444"></a>配置SqlSugar</h2> 
<h3><a id="0SqlSugarCore_446"></a>0、引入<code>SqlSugarCore</code>包</h3> 
<h3><a id="1Context_448"></a>1、编写<code>Context</code>类</h3> 
<pre><code class="prism language-cs">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SqlSugarClient</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SqlSugarClient</span><span class="token punctuation">(</span>
                  <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConnectionConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">{<!-- --></span>
                      ConnectionString <span class="token operator">=</span> <span class="token string">"server = 127.0.0.1; Database = test; Uid = root; Pwd = root; AllowLoadLocalInfile = true;"</span><span class="token punctuation">,</span>
                      DbType <span class="token operator">=</span> DbType<span class="token punctuation">.</span>MySql<span class="token punctuation">,</span><span class="token comment">//设置数据库类型</span>
                      IsAutoCloseConnection <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">//自动释放数据务，如果存在事务，在事务结束后释放</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h3><a id="2_461"></a>2、配置实体类</h3> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">SqlSugar</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Model<span class="token punctuation">.</span>Models</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SugarTable</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token named-parameter punctuation">tableName</span><span class="token punctuation">:</span> <span class="token string">"Person"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">SugarColumn</span><span class="token attribute-arguments"><span class="token punctuation">(</span>IsPrimaryKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> IsIdentity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Id <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Age <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> Name <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3ServiceCRUD_485"></a>3、创建<code>Service</code>服务类进行数据库的CRUD</h3> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>core<span class="token punctuation">.</span>IRepository</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Model<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">static</span> <span class="token class-name">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Common<span class="token punctuation">.</span>DbContext</span><span class="token punctuation">;</span>
<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Repository</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRepository</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IUserRepository</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span>  <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> line <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">Insertable</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> line<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Delete</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> UserId<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> line <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deleteable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">User</span>
            <span class="token punctuation">{<!-- --></span>
                Id <span class="token operator">=</span> UserId
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> line<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">GetUsers</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> Id<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List<span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> users<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Id <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                users <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Queryable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>it <span class="token operator">=&gt;</span> it<span class="token punctuation">.</span>Id <span class="token operator">==</span> Id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                users <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Queryable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> users<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">Update</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> res <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Updateable</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ExecuteCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="4Controller_534"></a>4、配置Controller进行路由</h3> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Auth</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>IServices</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Model<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authorization</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Services</span><span class="token punctuation">;</span>
<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Controllers</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"[controller]/[action]"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
        <span class="token punctuation">{<!-- --></span>

            <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUserService</span> _userService<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token function">UserController</span><span class="token punctuation">(</span> <span class="token class-name">IUserService</span> userService<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    _userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">/// &lt;summary&gt;</span>
                <span class="token comment">/// 增加</span>
                <span class="token comment">/// &lt;/summary&gt;</span>
                <span class="token comment">/// &lt;param name="user"&gt;&lt;/param&gt;</span>
                <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
                <span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
                <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">AddUser</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// User user = new User() { Id = 2024325, Name = "Czm", Age = 20 };</span>

                    <span class="token keyword">return</span> _userService<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/// &lt;summary&gt;</span>
                <span class="token comment">/// 删除</span>
                <span class="token comment">/// &lt;/summary&gt;</span>
                <span class="token comment">/// &lt;param name="id"&gt;&lt;/param&gt;</span>
                <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
                <span class="token punctuation">[</span>HttpDelete<span class="token punctuation">]</span>
                <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">DeleteUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> _userService<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/// &lt;summary&gt;</span>
                <span class="token comment">/// 更新</span>
                <span class="token comment">/// &lt;/summary&gt;</span>
                <span class="token comment">/// &lt;param name="user"&gt;&lt;/param&gt;</span>
                <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
                <span class="token punctuation">[</span>HttpPut<span class="token punctuation">]</span>
                <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> <span class="token function">UpdateUsre</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> _userService<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">/// &lt;summary&gt;</span>
                <span class="token comment">/// 获取数据</span>
                <span class="token comment">/// &lt;/summary&gt;</span>
                <span class="token comment">/// &lt;param name="id"&gt;&lt;/param&gt;</span>
                <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
                <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
                <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> <span class="token function">GetUser</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> _userService<span class="token punctuation">.</span><span class="token function">GetUsers</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h2><a id="IOC_605"></a>依赖注入与IOC</h2> 
<h3><a id="IOC_607"></a>IOC</h3> 
<blockquote> 
 <p>IOC 是 Inversion of Control（控制反转）的缩写。在软件开发中，IOC 是一种设计模式，它改变了传统的程序设计流程，使得对象之间的依赖关系由代码本身控制变为由外部容器控制。</p> 
 <p>而采用IOC 设计模式后，对象之间的依赖关系由外部容器来管理和注入，对象本身不需要关心依赖的具体实现，只需要定义自己的接口或抽象类，并在外部容器中配置依赖关系。这样可以降低代码的耦合度，提高代码的灵活性、可维护性和可扩展性。</p> 
 <p>常见的IOC 容器包括 Spring Framework 中的 Spring IoC ，dotnet中的autofoc，它通过依赖注入（Dependency Injection）的方式来实现控制反转。通过IOC 容器，可以将对象之间的依赖关系集中管理，实现了代码的松耦合，使得程序更易于理解、扩展和维护。</p> 
</blockquote> 
<h3><a id="DI_615"></a>依赖注入DI</h3> 
<p>1、继承接口并实现构造方法</p> 
<pre><code class="prism language-cs"> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IUserService</span></span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">private</span>  <span class="token class-name">IUserRepository</span> _userService <span class="token punctuation">;</span>

     <span class="token keyword">public</span> <span class="token function">UserService</span><span class="token punctuation">(</span><span class="token class-name">IUserRepository</span> userService<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         _userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>2、在program里加上</p> 
<pre><code class="prism language-cs">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddTransient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IUserRepository<span class="token punctuation">,</span> UserRepository<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddTransient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IUserService<span class="token punctuation">,</span> UserService<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>.net提供了三种生命周期的容器</p> 
 <p>builder.Services.AddTransient&lt;IOperationTransient, Operation&gt;(); builder.Services.AddScoped&lt;IOperationScoped, Operation&gt;(); builder.Services.AddSingleton&lt;IOperationSingleton, Operation&gt;();</p> 
 <ul><li>暂时性对象始终不同。 <code>IndexModel</code> 和中间件中的临时 <code>OperationId</code> 值不同。</li><li>范围内对象对给定请求而言是相同的，但在每个新请求之间不同。</li><li>单一实例对象对于每个请求是相同的。</li></ul> 
</blockquote> 
<p>3、Controller层使用</p> 
<pre><code class="prism language-cs"> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
 <span class="token punctuation">{<!-- --></span>

     <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUserService</span> _userService <span class="token punctuation">;</span>

     <span class="token keyword">public</span> <span class="token function">UserController</span><span class="token punctuation">(</span><span class="token class-name">IUserService</span> userService<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         _userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="Autofac_661"></a>Autofac轻量容器的使用</h3> 
<p>1、安装Nuget包<code>Autofac.Extensions.DependencyInjection</code>和<code>Autofac.Extras.DynamicProxy</code></p> 
<p>2、使用程序集注册，通过Model注册（这里只列这一种Auto官方文档<a href="https://autofac.readthedocs.io/en/latest/register/scanning.html#scanning-for-modules" rel="nofollow">Assembly Scanning — Autofac 7.0.0 documentation</a>）</p> 
<p>**创建Model类 **</p> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Autofac</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>IServices</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyModel</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Runtime<span class="token punctuation">.</span>Loader</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>AutoModule</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceModel</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Autofac<span class="token punctuation">.</span>Module</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token class-name">ContainerBuilder</span> builder<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 自动对集成 IDependency 接口的类进行注册</span>
            <span class="token class-name">Type</span> baseType <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">IUserService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> compilationLibrary <span class="token operator">=</span> DependencyContext<span class="token punctuation">.</span>Default<span class="token punctuation">.</span>CompileLibraries<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> <span class="token operator">!</span>x<span class="token punctuation">.</span>Serviceable <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">"project"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">List<span class="token punctuation">&lt;</span>Assembly<span class="token punctuation">&gt;</span></span> assemblyList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Assembly<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> _compilation <span class="token keyword">in</span> compilationLibrary<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span>
                <span class="token punctuation">{<!-- --></span>
                    assemblyList<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>AssemblyLoadContext<span class="token punctuation">.</span>Default<span class="token punctuation">.</span><span class="token function">LoadFromAssemblyName</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AssemblyName</span><span class="token punctuation">(</span>_compilation<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>_compilation<span class="token punctuation">.</span>Name <span class="token operator">+</span> ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            builder<span class="token punctuation">.</span><span class="token function">RegisterAssemblyTypes</span><span class="token punctuation">(</span>assemblyList<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>type <span class="token operator">=&gt;</span> baseType<span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>type<span class="token punctuation">.</span>IsAbstract<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AsSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AsImplementedInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">PropertiesAutowired</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">InstancePerLifetimeScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> controllersTypesInAssembly <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Program</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">.</span><span class="token function">GetExportedTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>type <span class="token operator">=&gt;</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ControllerBase</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            builder<span class="token punctuation">.</span><span class="token function">RegisterTypes</span><span class="token punctuation">(</span>controllersTypesInAssembly<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PropertiesAutowired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>**在program.cs中解析Model **</p> 
<pre><code class="prism language-cs">builder<span class="token punctuation">.</span>Host<span class="token punctuation">.</span><span class="token function">UseServiceProviderFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutofacServiceProviderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Host<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureContainer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ContainerBuilder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterModule</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ServiceModel<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddControllersAsServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>在Controller中使用</strong></p> 
<pre><code class="prism language-cs"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUserService</span> _userService <span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">UserController</span><span class="token punctuation">(</span><span class="token class-name">IUserService</span> userService<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="AutofacAOP_739"></a>使用Autofac完成AOP日志</h3> 
<p>1、编写AOP类</p> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Castle<span class="token punctuation">.</span>DynamicProxy</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Newtonsoft<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">StackExchange<span class="token punctuation">.</span>Profiling</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>AOP</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 拦截器BlogLogAOP 继承IInterceptor接口</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlogLogAOP</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IInterceptor</span></span>
    <span class="token punctuation">{<!-- --></span> 

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 实例化IInterceptor唯一方法</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="invocation"&gt;包含被拦截方法的信息&lt;/param&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Intercept</span><span class="token punctuation">(</span><span class="token class-name">IInvocation</span> invocation<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">string</span></span> UserName <span class="token operator">=</span> <span class="token string">"Jamin"</span><span class="token punctuation">;</span>

            <span class="token comment">//记录被拦截方法信息的日志信息</span>
            <span class="token class-name"><span class="token keyword">var</span></span> dataIntercept <span class="token operator">=</span> <span class="token string">""</span> <span class="token operator">+</span>
                <span class="token interpolation-string"><span class="token string">$"【当前操作用户】：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">UserName</span><span class="token punctuation">}</span></span><span class="token string"> \r\n"</span></span> <span class="token operator">+</span>
                <span class="token interpolation-string"><span class="token string">$"【当前执行方法】：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">invocation<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string"> \r\n"</span></span> <span class="token operator">+</span>
                <span class="token interpolation-string"><span class="token string">$"【携带的参数有】： </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">,</span> invocation<span class="token punctuation">.</span>Arguments<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>a <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>a <span class="token operator">??</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> \r\n"</span></span><span class="token punctuation">;</span>

            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                MiniProfiler<span class="token punctuation">.</span>Current<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"执行Service方法：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">invocation<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">() -&gt; "</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//在被拦截的方法执行完毕后 继续执行当前方法，注意是被拦截的是异步的</span>
                invocation<span class="token punctuation">.</span><span class="token function">Proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


                <span class="token comment">// 异步获取异常，先执行</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IsAsyncMethod</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>

                    <span class="token comment">//Wait task execution and modify return value</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>invocation<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>ReturnType <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Task</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        invocation<span class="token punctuation">.</span>ReturnValue <span class="token operator">=</span> InternalAsyncHelper<span class="token punctuation">.</span><span class="token function">AwaitTaskWithPostActionAndFinally</span><span class="token punctuation">(</span>
                            <span class="token punctuation">(</span>Task<span class="token punctuation">)</span>invocation<span class="token punctuation">.</span>ReturnValue<span class="token punctuation">,</span>
                            ex <span class="token operator">=&gt;</span>
                            <span class="token punctuation">{<!-- --></span>
                                <span class="token function">LogEx</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token keyword">ref</span> dataIntercept<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token comment">//Task&lt;TResult&gt;</span>
                    <span class="token punctuation">{<!-- --></span>
                        invocation<span class="token punctuation">.</span>ReturnValue <span class="token operator">=</span> InternalAsyncHelper<span class="token punctuation">.</span><span class="token function">CallAwaitTaskWithPostActionAndFinallyAndGetResult</span><span class="token punctuation">(</span>
                         invocation<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>ReturnType<span class="token punctuation">.</span>GenericTypeArguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                         invocation<span class="token punctuation">.</span>ReturnValue<span class="token punctuation">,</span>
                         ex <span class="token operator">=&gt;</span>
                         <span class="token punctuation">{<!-- --></span>
                             <span class="token function">LogEx</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token keyword">ref</span> dataIntercept<span class="token punctuation">)</span><span class="token punctuation">;</span>
                         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span><span class="token comment">// 同步1           </span>
                 
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span><span class="token comment">// 同步2</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">LogEx</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token keyword">ref</span> dataIntercept<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>

            <span class="token class-name"><span class="token keyword">var</span></span> type <span class="token operator">=</span> invocation<span class="token punctuation">.</span>Method<span class="token punctuation">.</span>ReturnType<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Task</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsAssignableFrom</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name"><span class="token keyword">var</span></span> resultProperty <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"Result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                dataIntercept <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"【执行完成结果】：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">JsonConvert<span class="token punctuation">.</span><span class="token function">SerializeObject</span><span class="token punctuation">(</span>resultProperty<span class="token punctuation">.</span><span class="token function">GetValue</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span>ReturnValue<span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                dataIntercept <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"【执行完成结果】：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">invocation<span class="token punctuation">.</span>ReturnValue</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 你的日志记录 比如log4</span>
            <span class="token preprocessor property">#<span class="token directive keyword">region</span> 输出到当前项目日志</span>
            <span class="token class-name"><span class="token keyword">var</span></span> path <span class="token operator">=</span> Directory<span class="token punctuation">.</span><span class="token function">GetCurrentDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">@"\Log"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Directory<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Directory<span class="token punctuation">.</span><span class="token function">CreateDirectory</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name"><span class="token keyword">string</span></span> fileName <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token interpolation-string"><span class="token string">$@"\InterceptLog-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"yyyyMMddHHmmss"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">.log"</span></span><span class="token punctuation">;</span>

            <span class="token class-name">StreamWriter</span> sw <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">AppendText</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sw<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>dataIntercept<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sw<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LogEx</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">,</span> <span class="token keyword">ref</span> <span class="token class-name"><span class="token keyword">string</span></span> dataIntercept<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//执行的 service 中，收录异常</span>
                MiniProfiler<span class="token punctuation">.</span>Current<span class="token punctuation">.</span><span class="token function">CustomTiming</span><span class="token punctuation">(</span><span class="token string">"Errors："</span><span class="token punctuation">,</span> ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//执行的 service 中，捕获异常</span>
                dataIntercept <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"方法执行中出现异常：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ex<span class="token punctuation">.</span>Message <span class="token operator">+</span> ex<span class="token punctuation">.</span>InnerException</span><span class="token punctuation">}</span></span><span class="token string">\r\n"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">IsAsyncMethod</span><span class="token punctuation">(</span><span class="token class-name">MethodInfo</span> method<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>
                method<span class="token punctuation">.</span>ReturnType <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Task</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                <span class="token punctuation">(</span>method<span class="token punctuation">.</span>ReturnType<span class="token punctuation">.</span>IsGenericType <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span>ReturnType<span class="token punctuation">.</span><span class="token function">GetGenericTypeDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Task<span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InternalAsyncHelper</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">AwaitTaskWithPostActionAndFinally</span><span class="token punctuation">(</span><span class="token class-name">Task</span> actualReturnValue<span class="token punctuation">,</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span>Exception<span class="token punctuation">&gt;</span></span> finalAction<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Exception</span> exception <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">await</span> actualReturnValue<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                exception <span class="token operator">=</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">finalAction</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token generic-method"><span class="token function">AwaitTaskWithPostActionAndFinallyAndGetResult</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">Task<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> actualReturnValue<span class="token punctuation">,</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&gt;</span></span> postAction<span class="token punctuation">,</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span>Exception<span class="token punctuation">&gt;</span></span> finalAction<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Exception</span> exception <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> actualReturnValue<span class="token punctuation">;</span>
                <span class="token keyword">await</span> <span class="token function">postAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                exception <span class="token operator">=</span> ex<span class="token punctuation">;</span>
                <span class="token keyword">throw</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">finalAction</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> <span class="token function">CallAwaitTaskWithPostActionAndFinallyAndGetResult</span><span class="token punctuation">(</span><span class="token class-name">Type</span> taskReturnType<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span></span> actualReturnValue<span class="token punctuation">,</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span>Exception<span class="token punctuation">&gt;</span></span> finalAction<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">InternalAsyncHelper</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span><span class="token string">"AwaitTaskWithPostActionAndFinallyAndGetResult"</span><span class="token punctuation">,</span> BindingFlags<span class="token punctuation">.</span>Public <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>Static<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">MakeGenericMethod</span><span class="token punctuation">(</span>taskReturnType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">actualReturnValue</span><span class="token punctuation">,</span> <span class="token class-name">finalAction</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>2、进行服务注册</p> 
<pre><code class="prism language-cs"><span class="token class-name"><span class="token keyword">var</span></span> basePath <span class="token operator">=</span> AppContext<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> servicesDllFile <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> <span class="token string">"Blog.Core.Services.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//服务层</span>
<span class="token class-name"><span class="token keyword">var</span></span> repositoryDllFile <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> <span class="token string">"Blog.Core.Repository.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//仓储层</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>servicesDllFile<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>repositoryDllFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"Repository.dll和service.dll 丢失，因为项目解耦了，所以需要先F6编译，再F5运行，请检查 bin 文件夹，并拷贝。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
builder<span class="token punctuation">.</span>Host<span class="token punctuation">.</span><span class="token function">UseServiceProviderFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutofacServiceProviderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Host<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureContainer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ContainerBuilder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>build <span class="token operator">=&gt;</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// AOP </span>
    <span class="token class-name"><span class="token keyword">var</span></span> cacheType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Type<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    build<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BlogLogAOP<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    cacheType<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">BlogLogAOP</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取 Service.dll 程序集服务，并注册</span>
    <span class="token class-name"><span class="token keyword">var</span></span> assemblysServices <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">LoadFrom</span><span class="token punctuation">(</span>servicesDllFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    build<span class="token punctuation">.</span><span class="token function">RegisterAssemblyTypes</span><span class="token punctuation">(</span>assemblysServices<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">AsImplementedInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">InstancePerDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">EnableInterfaceInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//引用Autofac.Extras.DynamicProxy;</span>
                <span class="token punctuation">.</span><span class="token function">InterceptedBy</span><span class="token punctuation">(</span>cacheType<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//允许将拦截器服务的列表分配给注册。</span>

    <span class="token comment">// 获取 Repository.dll 程序集服务，并注册</span>
    <span class="token class-name"><span class="token keyword">var</span></span> assemblysRepository <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">LoadFrom</span><span class="token punctuation">(</span>repositoryDllFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    build<span class="token punctuation">.</span><span class="token function">RegisterAssemblyTypes</span><span class="token punctuation">(</span>assemblysRepository<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">AsImplementedInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">InstancePerDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h2><a id="_953"></a>使用扩展进行服务注册</h2> 
<p>1、创建<code>utils</code>文件夹</p> 
<p>2、创建Swagger、AOP、JWT的类</p> 
<p><code>Swagger</code></p> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>OpenApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Helper</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SwaggerExt</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddSwagger</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            services<span class="token punctuation">.</span><span class="token function">AddSwaggerGen</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                c<span class="token punctuation">.</span><span class="token function">SwaggerDoc</span><span class="token punctuation">(</span><span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiInfo</span> <span class="token punctuation">{<!-- --></span> Title <span class="token operator">=</span> <span class="token string">"Web API"</span><span class="token punctuation">,</span> Version <span class="token operator">=</span> <span class="token string">"v1"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//开启注释</span>
                <span class="token class-name"><span class="token keyword">var</span></span> xmlFile <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Assembly<span class="token punctuation">.</span><span class="token function">GetEntryAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">.xml"</span></span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> xmlPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>AppContext<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">,</span> xmlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span><span class="token function">IncludeXmlComments</span><span class="token punctuation">(</span>xmlPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 配置 JWT Bearer 授权</span>
                c<span class="token punctuation">.</span><span class="token function">AddSecurityDefinition</span><span class="token punctuation">(</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
                <span class="token punctuation">{<!-- --></span>
                    Description <span class="token operator">=</span> <span class="token string">"JWT Authorization header using the Bearer scheme"</span><span class="token punctuation">,</span>
                    Name <span class="token operator">=</span> <span class="token string">"Authorization"</span><span class="token punctuation">,</span>
                    In <span class="token operator">=</span> ParameterLocation<span class="token punctuation">.</span>Header<span class="token punctuation">,</span>
                    Type <span class="token operator">=</span> SecuritySchemeType<span class="token punctuation">.</span>Http<span class="token punctuation">,</span>
                    Scheme <span class="token operator">=</span> <span class="token string">"bearer"</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> securityScheme <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
                <span class="token punctuation">{<!-- --></span>
                    Reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiReference</span> <span class="token punctuation">{<!-- --></span> Type <span class="token operator">=</span> ReferenceType<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">,</span> Id <span class="token operator">=</span> <span class="token string">"Bearer"</span> <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> securityRequirement <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityRequirement</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">{<!-- --></span> securityScheme<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
                c<span class="token punctuation">.</span><span class="token function">AddSecurityRequirement</span><span class="token punctuation">(</span>securityRequirement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UseSwagger</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">WebApplication</span> application<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            application<span class="token punctuation">.</span><span class="token function">UseSwagger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            application<span class="token punctuation">.</span><span class="token function">UseSwaggerUI</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                c<span class="token punctuation">.</span><span class="token function">SwaggerEndpoint</span><span class="token punctuation">(</span><span class="token string">"/swagger/v1/swagger.json"</span><span class="token punctuation">,</span> <span class="token string">"My API V1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><code>AOP</code></p> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Autofac<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Autofac</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>AOP</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Autofac<span class="token punctuation">.</span>Extras<span class="token punctuation">.</span>DynamicProxy</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Helper</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AOPAndIOCExt</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddAOP</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">WebApplicationBuilder</span> builder<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//IOC</span>
            <span class="token comment">//builder.Services.AddTransient&lt;IUserRepository, UserRepository&gt;();</span>
            <span class="token comment">//builder.Services.AddTransient&lt;IUserService, UserService&gt;();</span>

            <span class="token class-name"><span class="token keyword">var</span></span> basePath <span class="token operator">=</span> AppContext<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> servicesDllFile <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> <span class="token string">"Blog.Core.Services.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//服务层</span>
            <span class="token class-name"><span class="token keyword">var</span></span> repositoryDllFile <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>basePath<span class="token punctuation">,</span> <span class="token string">"Blog.Core.Repository.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//仓储层</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>servicesDllFile<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>repositoryDllFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"Repository.dll和service.dll 丢失，因为项目解耦了，所以需要先F6编译，再F5运行，请检查 bin 文件夹，并拷贝。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            builder<span class="token punctuation">.</span>Host<span class="token punctuation">.</span><span class="token function">UseServiceProviderFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">AutofacServiceProviderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span>Host<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConfigureContainer</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ContainerBuilder<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>build <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// AOP </span>
                <span class="token class-name"><span class="token keyword">var</span></span> cacheType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Type<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                build<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RegisterType</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BlogLogAOP<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cacheType<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">BlogLogAOP</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 获取 Service.dll 程序集服务，并注册</span>
                <span class="token class-name"><span class="token keyword">var</span></span> assemblysServices <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">LoadFrom</span><span class="token punctuation">(</span>servicesDllFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                build<span class="token punctuation">.</span><span class="token function">RegisterAssemblyTypes</span><span class="token punctuation">(</span>assemblysServices<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">AsImplementedInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">InstancePerDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">EnableInterfaceInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//引用Autofac.Extras.DynamicProxy;</span>
                            <span class="token punctuation">.</span><span class="token function">InterceptedBy</span><span class="token punctuation">(</span>cacheType<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//允许将拦截器服务的列表分配给注册。</span>

                <span class="token comment">// 获取 Repository.dll 程序集服务，并注册</span>
                <span class="token class-name"><span class="token keyword">var</span></span> assemblysRepository <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">LoadFrom</span><span class="token punctuation">(</span>repositoryDllFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                build<span class="token punctuation">.</span><span class="token function">RegisterAssemblyTypes</span><span class="token punctuation">(</span>assemblysRepository<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">AsImplementedInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">InstancePerDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><code>JWT</code></p> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Helper</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">JWTExt</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddJWT</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">WebApplicationBuilder</span> builder<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Auth<span class="token punctuation">.</span>JwtHelper</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    ValidateIssuer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否验证Issuer</span>
                    ValidIssuer <span class="token operator">=</span> builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">[</span><span class="token string">"Jwt:Issuer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//发行人Issuer</span>
                    ValidateAudience <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//是否验证Audience      </span>
                    ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否验证SecurityKey</span>
                    IssuerSigningKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">[</span><span class="token string">"Jwt:SecKey"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//SecurityKey</span>
                    ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否验证失效时间</span>
                    ClockSkew <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">//过期时间容错值，解决服务器端时间不同步问题（秒）</span>
                    RequireExpirationTime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">/***    "Client" 策略要求用户必须拥有 "Client" 角色才能访问相关资源。
                "Admin" 策略要求用户必须拥有 "Admin" 角色才能访问相关资源。
                "SystemOrAdmin" 策略要求用户必须拥有 "Admin" 或者 "System" 角色之一才能访问相关资源。***/</span>
                options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"Client"</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">"Client"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"Admin"</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">"Admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">"System"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"SystemOrAdmin"</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">"Admin"</span><span class="token punctuation">,</span> <span class="token string">"System"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"ClientOrAdmin"</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span> policy<span class="token punctuation">.</span><span class="token function">RequireRole</span><span class="token punctuation">(</span><span class="token string">"Admin"</span><span class="token punctuation">,</span> <span class="token string">"Client"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>3、在<code>program</code>类里进行 调用</p> 
<pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">Autofac</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Autofac<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Autofac<span class="token punctuation">.</span>Extras<span class="token punctuation">.</span>DynamicProxy</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>AOP</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Auth</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Blog<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Helper</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>OpenApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Add services to the container.</span>

builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddMemoryCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span>
<span class="token preprocessor property">#<span class="token directive keyword">region</span> JWT服务</span>
builder<span class="token punctuation">.</span><span class="token function">AddJWT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

<span class="token preprocessor property">#<span class="token directive keyword">region</span> </span><span class="token return-type class-name">Swagger</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddEndpointsApiExplorer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSwagger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

<span class="token preprocessor property">#<span class="token directive keyword">region</span> </span><span class="token return-type class-name">AOPAndIOC</span>
builder<span class="token punctuation">.</span><span class="token function">AddAOP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
<span class="token comment">//跨域</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddCors</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
<span class="token punctuation">{<!-- --></span>
    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"CorsPolicy"</span><span class="token punctuation">,</span> opt <span class="token operator">=&gt;</span> opt<span class="token punctuation">.</span><span class="token function">AllowAnyOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllowAnyHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllowAnyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WithExposedHeaders</span><span class="token punctuation">(</span><span class="token string">"X-Pagination"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseCors</span><span class="token punctuation">(</span><span class="token string">"CorsPolicy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Configure the HTTP request pipeline.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>Environment<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    app<span class="token punctuation">.</span><span class="token function">UseSwagger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//启用验证中间件</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h2><a id="Webapi_1174"></a>Webapi的操作返回值和方法参数</h2> 
<h3><a id="ActionResult_1176"></a>返回值ActionResult</h3> 
<blockquote> 
 <p>ASP.NET Core Web API中的操作方法的返回值如果是普通数据类型，那么返回值就会默认被序列化为JSON格式的响应报文体返回。</p> 
</blockquote> 
<pre><code class="prism language-cs"><span class="token number">1</span>  <span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{id}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
<span class="token number">2</span>  <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span>Person<span class="token punctuation">&gt;</span></span> <span class="token function">GetPerson</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> id<span class="token punctuation">)</span> 
<span class="token number">3</span>  <span class="token punctuation">{<!-- --></span> 
<span class="token number">4</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> 
<span class="token number">5</span>     <span class="token keyword">return</span> person<span class="token punctuation">;</span>
<span class="token number">10</span>    <span class="token keyword">else</span> 
<span class="token number">11</span>       <span class="token keyword">return</span> <span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ErrorInfo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"人员不存在"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token number">12</span> <span class="token punctuation">}</span>
</code></pre> 
<p>**注：**一般是创建一个ResInfo类{code，message}作为返回的实体。符合Restful开发</p> 
<h3><a id="_1193"></a>操作方法的参数</h3> 
<blockquote> 
 <p>我们在给服务器端传递参数的时候，有URL、QueryString、请求报文体3种方式。</p> 
</blockquote> 
<h4><a id="URL_1197"></a>URL</h4> 
<blockquote> 
 <p>如果GetAll方法的参数中有同名的参数，那么这个参数就会被自动赋值。如果捕捉的占位符的名字和参数名一致，那么我们就不需要为参数添加[FromRoute]；如果占位符的名字和参数名不一致，我们就需要为参数添加[FromRoute]，并且通过[FromRoute]的Name属性来设置匹配的占位符的名字，比如一个名字为classNum的参数要想获得占位符中{classNo}的值，那么我们就要为classNum参数添加[FromRoute(Name=“classNo”)]</p> 
</blockquote> 
<pre><code class="prism language-cs"><span class="token number">1</span>  <span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"school/{schoolName}/class/{classNo}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
<span class="token number">2</span>  <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span>Student<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetAll</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> schoolName<span class="token punctuation">,</span> 
<span class="token number">3</span>                       <span class="token punctuation">[</span><span class="token function">FromRoute</span><span class="token punctuation">(</span>Name <span class="token operator">=</span><span class="token string">"classNo"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">string</span></span> classNum<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="QueryString_1207"></a>QueryString</h4> 
<blockquote> 
 <p>对于通过QueryString传递的参数，我们使用[FromQuery]来获取值。如果操作方法的参数的名字和我们要获取的QueryString的名字一致，我们只要为参数添加[FromQuery]即可；如果操作方法的参数的名字和要获取的QueryString的名字不一致，我们就要为设定【FromQuery】的Name属性指定和QueryString中一样的名字。</p> 
</blockquote> 
<pre><code class="prism language-cs"><span class="token number">1</span>  <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span>Student<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetAll</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromQuery</span></span><span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">string</span></span> pageNum<span class="token punctuation">,</span> 
<span class="token number">2</span>                             <span class="token punctuation">[</span><span class="token function">FromQuery</span><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">"pSize"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">int</span></span> pageSize<span class="token punctuation">)</span>
</code></pre> 
<p><strong>URL和QueryString混用</strong></p> 
<pre><code class="prism language-cs"><span class="token number">1</span>  <span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"school/{schoolName}/class/{classNo}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
<span class="token number">2</span>  <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult<span class="token punctuation">&lt;</span>Student<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetAll</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> schoolName<span class="token punctuation">,</span> 
<span class="token number">3</span>          <span class="token punctuation">[</span><span class="token function">FromRoute</span><span class="token punctuation">(</span>Name <span class="token operator">=</span><span class="token string">"classNo"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">string</span></span> classNum<span class="token punctuation">,</span> 
<span class="token number">4</span>           <span class="token punctuation">[</span>FromQuery<span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">string</span></span> pageNum<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromQuery</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">"pSize"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span><span class="token class-name"><span class="token keyword">int</span></span> pageSize<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_1225"></a>请求报文体</h4> 
<blockquote> 
 <p>参数为实体类，在请求报文体（Body）里发送相应的Json数据就可以直接接收</p> 
</blockquote> 
<pre><code class="prism language-cs"><span class="token number">1</span>  <span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span> 
<span class="token number">2</span>  <span class="token keyword">public</span> <span class="token return-type class-name">ActionResult</span> <span class="token function">AddNew</span><span class="token punctuation">(</span><span class="token class-name">Student</span> s<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="_1234"></a>总结</h4> 
<blockquote> 
 <p>对于GET、DELETE等请求，我们尽量从URL或者QueryString中获取数据；对于PUT、POST等请求，我们尽量通过JSON格式的报文体获取数据，当然我们一定要设定请求报文头中的Content-Type的值为application/json。</p> 
</blockquote> 
<h2><a id="VUE_1238"></a>VUE项目结构</h2> 
<pre><code class="prism language-cs">project<span class="token operator">-</span>name<span class="token operator">/</span>
│
├── <span class="token keyword">public</span><span class="token operator">/</span>
│   ├── index<span class="token punctuation">.</span>html         # 主HTML文件
│   └── <span class="token range operator">..</span><span class="token punctuation">.</span>
│
├── src<span class="token operator">/</span>
│   ├── assets<span class="token operator">/</span>            # 静态资源，如图片、字体等
│   ├── components<span class="token operator">/</span>        # Vue组件
│   ├── views<span class="token operator">/</span>             # 页面级组件
│   ├── router<span class="token operator">/</span>            # 路由配置
│   ├── store<span class="token operator">/</span>             # Vuex状态管理相关文件
│   ├── utils<span class="token operator">/</span>             # 工具函数、帮助类等
│   ├── styles<span class="token operator">/</span>            # 全局样式文件
│   ├── App<span class="token punctuation">.</span>vue            # 根组件
│   └── main<span class="token punctuation">.</span>js            # 入口文件
│
├── tests<span class="token operator">/</span>                 # 测试文件夹
│
├── node_modules<span class="token operator">/</span>          # 依赖的第三方包
│
├── <span class="token punctuation">.</span>gitignore             # Git忽略文件配置
├── babel<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js        # Babel配置文件
├── package<span class="token punctuation">.</span>json           # 项目配置及依赖管理文件
└── README<span class="token punctuation">.</span>md              # 项目说明文件
    

</code></pre> 
<pre><code class="prism language-markdown">public 目录包含了静态资源，例如 HTML 入口文件和网站图标。
src 目录是主要的工作目录，包含了所有的源代码。
assets 存放应用中使用的静态资源，例如图片、字体等。
components 包含了应用中的 Vue 组件。
views 包含了页面级别的 Vue 组件。
router 包含了 Vue Router 的路由配置。
store 包含了 Vuex 的状态管理相关文件。
styles 包含了全局样式文件。
utils 包含了应用中可能用到的工具函数。
App.vue 是根组件，通常包含应用的整体结构和布局。
main.js 是应用的入口文件，用于初始化 Vue 实例和加载其他组件。
tests 目录包含应用的测试文件。
.gitignore 是 Git 忽略文件配置，指定不需要被版本控制的文件和目录。
babel.config.js 是 Babel 的配置文件，用于指定 JavaScript 代码的转换规则。
package.json 是项目的配置文件，包含了项目的依赖和一些脚本命令。
README.md 是项目的说明文件，通常包含了项目的介绍、安装方法和使用说明等。
vue.config.js 是 Vue CLI 的配置文件，用于配置构建工具的行为，如 webpack、babel 等（这是可选的，只有在需要自定义配置时才添加）。
</code></pre> 
<h3><a id="_1290"></a>主要文件</h3> 
<ul><li>main.ts : 进行vue的注入、路由的注入、ui组件的注入</li><li>App.vue ： 项目的主界面，其他组件进行插入到这个界面显示视图</li><li>router/index.ts ：进行页面路由</li><li>components ： 其他页面的视图，用来插入到App.vue中</li></ul> 
<h3><a id="_1297"></a>项目运行流程</h3> 
<blockquote> 
 <p>vite 项目的运行流程<br> 在工程化的项目中，vue 要做的事情很单纯：通过 main.js 把 App.vue 渲染到 index.html 的指定区域中<br> 其中：<br> ① App.vue 用来编写待渲染的 模板结构<br> ② index.html 中需要预留一个 el 区域<br> ③ main.js 把 App.vue 渲染到了 index.html 所预留的区域中</p> 
</blockquote> 
<h3><a id="ElementuiAXIOS_1307"></a>添加Element-ui、AXIOS</h3> 
<blockquote> 
 <p><strong>注：elementui在VUE3进行了更改 <code>npm i element-plus</code></strong></p> 
 <p><strong>Axios：<code>npm install --save axios</code></strong></p> 
</blockquote> 
<p>**注：**Nodejs下载完成后需要换源<code>npm config set registry https://registry.npm.taobao.org</code></p> 
<h2><a id="Axiospinia_1315"></a>Axios与pinia</h2> 
<h3><a id="AXIOS_1317"></a>AXIOS</h3> 
<blockquote> 
 <p>Axios 是一个基于 <em><a href="https://javascript.info/promise-basics" rel="nofollow">promise</a></em> 网络请求库，作用于<a href="https://nodejs.org/" rel="nofollow"><code>node.js</code></a> 和浏览器中。 它是 <em><a href="https://www.lullabot.com/articles/what-is-an-isomorphic-application" rel="nofollow">isomorphic</a></em> 的(即同一套代码可以运行在浏览器和node.js中)。在服务端它使用原生 node.js <code>http</code> 模块, 而在客户端 (浏览端) 则使用 XMLHttpRequests。</p> 
</blockquote> 
<h4><a id="npmaxios_1321"></a>使用npm等包管理工具下载axios</h4> 
<p><code>npm i axios</code></p> 
<h4><a id="axiosgetpost_1325"></a>创建axios实例、封装get、post请求方法</h4> 
<pre><code class="prism language-ts"><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">"axios"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> user <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/store/Store"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> requestUrl <span class="token operator">=</span> <span class="token string">"http://localhost:5250"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> userStore <span class="token operator">=</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建实例</span>
<span class="token keyword">const</span> axiosInstance <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  baseURL<span class="token operator">:</span> requestUrl<span class="token punctuation">,</span>
  <span class="token comment">// timeout: 3000,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//请求拦截器,请求前</span>
axiosInstance<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>userStore<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// console.log("请求头toekn=====&gt;", userStore.data.token);</span>
      <span class="token comment">// 设置请求头</span>
      <span class="token comment">// config.headers['token'] = useToken.token;</span>
      config<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>Authorization <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>userStore<span class="token punctuation">.</span>data<span class="token punctuation">.</span>token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> config<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//请求拦截器，请求后</span>
axiosInstance<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span> response<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> status<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> <span class="token number">404</span><span class="token operator">:</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"资源不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">401</span><span class="token operator">:</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"没有权限"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">500</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token number">501</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token number">502</span><span class="token operator">:</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"没有权限"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">400</span><span class="token operator">:</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>response<span class="token punctuation">.</span>data<span class="token punctuation">.</span>msg <span class="token operator">+</span> <span class="token string">"参数错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"无法识别"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">ActionResult<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  data<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  msg<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  error<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  code<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//get请求</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> get <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  params<span class="token operator">?</span><span class="token operator">:</span> Object
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ActionResult<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> axiosInstance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> params <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//post请求</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> post <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  data<span class="token operator">?</span><span class="token operator">:</span> Object
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ActionResult<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> axiosInstance<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//put请求</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> put <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  data<span class="token operator">?</span><span class="token operator">:</span> Object
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ActionResult<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> axiosInstance<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//delete请求</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> delete1 <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  params<span class="token operator">?</span><span class="token operator">:</span> Object
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>ActionResult<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> axiosInstance<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> params <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<h4><a id="api_1422"></a>封装api接口调用方法</h4> 
<pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> get<span class="token punctuation">,</span> post<span class="token punctuation">,</span> delete1<span class="token punctuation">,</span> put <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./request"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> user <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/types/index"</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">loginApi</span> <span class="token operator">=</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> user<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">post</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/api/Login/login"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getUserInfo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token constant">ID</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"/api/Index/UserInfo"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token constant">ID</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<h4><a id="api_1436"></a>在页面中调用api</h4> 
<pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> loginApi <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/common/api"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">emailLoginApi</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  phoneLoding<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loginApi</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token constant">EMAIL</span><span class="token operator">:</span> emailNumber<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      <span class="token constant">PASSWORD</span><span class="token operator">:</span> PassWard<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// localStorage.setItem("userInfo", JSON.stringify(res.data.token));</span>
    <span class="token comment">// Cookies.set("token", res.data.token);</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    userStore<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userStore<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    $router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"/index"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    phoneLoding<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    phoneLoding<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="pinia_1460"></a>pinia使用</h3> 
<h4><a id="npmpinia_1462"></a>使用npm下载pinia</h4> 
<p><code>npm i pinia</code></p> 
<h4><a id="Store_1466"></a>创建Store文件进行状态存储</h4> 
<pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> defineStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"pinia"</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">defineStore</span><span class="token punctuation">(</span><span class="token string">"userInfo"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    data<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> id<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> Name<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> token<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> Email<span class="token operator">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  actions<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">setData</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> payload<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_1482"></a>在页面组件中实例化状态并赋值</h4> 
<pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> user <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@/store/Store"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> userStore <span class="token operator">=</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实例化 store</span>
userStore<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fde68c277861338926206d603aec9d4f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">WordPress原创插件：Download-block-plugin下载按钮图标美化</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/496ea4bb094821dc572e030621a4ae93/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;刷LeetCode常用容器和函数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>