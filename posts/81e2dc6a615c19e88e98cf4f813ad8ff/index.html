<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Spring AI】05. 向量数据库-Redis - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/81e2dc6a615c19e88e98cf4f813ad8ff/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Spring AI】05. 向量数据库-Redis">
  <meta property="og:description" content="文章目录 Redis什么是 Redis？Redis 向量搜索是什么？先决条件依赖项用法元数据过滤 Redis 本节将指导您设置RedisVectorStore，作为文档存储向量数据库，并执行相似性搜索。
什么是 Redis？ Redis 是一个开源（BSD 许可证），用作数据库、缓存、消息代理和流引擎的内存数据结构存储。Redis支持多种数据结构，包括字符串、哈希、列表、集合、带范围查询的有序集合、位图、hyperloglogs、地理空间索引和流。
Redis 向量搜索是什么？ Redis Search and Query 扩展了 Redis OSS 的核心功能，使您可以将 Redis 用作矢量数据库：
在哈希或 JSON 文档中存储向量和相关元数据检索向量执行向量搜索 先决条件 EmbeddingClient实例，来计算文档嵌入向量。有几种选项可用： Transformers Embedding- 在您的本地环境中计算嵌入向量。请按照 ONNX Transformers Embedding 说明操作。OpenAI Embedding- 使用 OpenAI 嵌入端点。您需要在 OpenAI 注册并在 API Keys 生成 api-key 令牌。您也可以使用Azure OpenAI Embedding。 一个 Redis Stack 实例
a. Redis Cloud (推荐)
b. Docker 镜像 redis/redis-stack:latest 依赖项 将这些依赖项添加到您的项目中：
Embedding Client boot starter ，用于计算嵌入。
Transformers Embedding（本地），并按照 ONNX Transformers 嵌入向量说明操作。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-29T11:03:11+08:00">
    <meta property="article:modified_time" content="2024-04-29T11:03:11+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Spring AI】05. 向量数据库-Redis</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Redis_2" rel="nofollow">Redis</a></li><li><ul><li><a href="#_Redis_6" rel="nofollow">什么是 Redis？</a></li><li><a href="#Redis__13" rel="nofollow">Redis 向量搜索是什么？</a></li><li><a href="#_23" rel="nofollow">先决条件</a></li><li><a href="#_35" rel="nofollow">依赖项</a></li><li><a href="#_79" rel="nofollow">用法</a></li><li><ul><li><a href="#_124" rel="nofollow">元数据过滤</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Redis_2"></a>Redis</h2> 
<p>本节将指导您设置RedisVectorStore，作为文档存储向量数据库，并执行相似性搜索。</p> 
<h3><a id="_Redis_6"></a>什么是 Redis？</h3> 
<hr> 
<p>Redis 是一个开源（BSD 许可证），用作数据库、缓存、消息代理和流引擎的内存数据结构存储。Redis支持多种数据结构，包括字符串、哈希、列表、集合、带范围查询的有序集合、位图、hyperloglogs、地理空间索引和流。</p> 
<hr> 
<h3><a id="Redis__13"></a>Redis 向量搜索是什么？</h3> 
<hr> 
<p><a href="https://redis.io/docs/interact/search-and-query/" rel="nofollow">Redis Search and Query</a> 扩展了 Redis OSS 的核心功能，使您可以将 Redis 用作矢量数据库：</p> 
<ul><li>在哈希或 JSON 文档中存储向量和相关元数据</li><li>检索向量</li><li>执行向量搜索</li></ul> 
<hr> 
<h3><a id="_23"></a>先决条件</h3> 
<ol><li>EmbeddingClient实例，来计算文档嵌入向量。有几种选项可用：</li></ol> 
<ul><li>Transformers Embedding- 在您的本地环境中计算嵌入向量。请按照 ONNX Transformers Embedding 说明操作。</li><li>OpenAI Embedding- 使用 OpenAI 嵌入端点。您需要在 OpenAI 注册并在 API Keys 生成 api-key 令牌。</li><li>您也可以使用Azure OpenAI Embedding。</li></ul> 
<ol start="2"><li>一个 Redis Stack 实例<br> a. <a href="https://app.redislabs.com/#/" rel="nofollow">Redis Cloud</a> (推荐)<br> b. <a href="https://hub.docker.com/r/redis/redis-stack" rel="nofollow">Docker 镜像</a> redis/redis-stack:latest</li></ol> 
<hr> 
<h3><a id="_35"></a>依赖项</h3> 
<p>将这些依赖项添加到您的项目中：</p> 
<ul><li> <p>Embedding Client boot starter ，用于计算嵌入。</p> </li><li> <p>Transformers Embedding（本地），并按照 ONNX Transformers 嵌入向量说明操作。</p> <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-ai-transformers-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <p>或使用 OpenAI（云）</p> <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-ai-openai-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
  <blockquote> 
   <p><strong>请参阅 03. 开始章节 的 Dependency Management 部分，将 Spring AI BOM 添加到构建文件中</strong></p> 
  </blockquote> <p>您需要提供您的 OpenAI API 密钥。将其设置为环境变量，如下所示：</p> <pre><code class="prism language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable">SPRING_AI_OPENAI_API_KEY</span><span class="token operator">=</span><span class="token string">'Your_OpenAI_API_Key'</span>
</code></pre> </li><li> <p>添加 Redis Vector Store 和 Jedis 依赖项</p> <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.ai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-ai-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> </li></ul> 
<blockquote> 
 <p><strong>请参阅 03. 开始章节 的 Dependency Management 部分，将 Spring AI BOM 添加到构建文件中</strong></p> 
</blockquote> 
<hr> 
<h3><a id="_79"></a>用法</h3> 
<hr> 
<p>创建一个连接到您的 Redis 数据库的 RedisVectorStore 实例：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">VectorStore</span> <span class="token function">vectorStore</span><span class="token punctuation">(</span><span class="token class-name">EmbeddingClient</span> embeddingClient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">RedisVectorStoreConfig</span> config <span class="token operator">=</span> <span class="token class-name">RedisVectorStoreConfig</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">withURI</span><span class="token punctuation">(</span><span class="token string">"redis://localhost:6379"</span><span class="token punctuation">)</span>
     <span class="token comment">// Define the metadata fields to be used</span>
     <span class="token comment">// in the similarity search filters.</span>
     <span class="token punctuation">.</span><span class="token function">withMetadataFields</span><span class="token punctuation">(</span>
        <span class="token class-name">MetadataField</span><span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span><span class="token string">"country"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">MetadataField</span><span class="token punctuation">.</span><span class="token function">numeric</span><span class="token punctuation">(</span><span class="token string">"year"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RedisVectorStore</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> embeddingClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><strong>更方便和推荐的做法是将 RedisVectorStore 创建为一个 Bean。但如果您决定手动创建它，则必须在设置属性之后并在使用客户端之前调用 RedisVectorStore#afterPropertiesSet() 。</strong></p> 
</blockquote> 
<blockquote> 
 <p><strong>您必须明确列出所有元数据字段名称和类型（ TAG ， TEXT 或 NUMERIC ），用于过滤表达式中使用的任何元数据字段。上面的 withMetadataFields 注册可过滤的元数据字段：类型为 TAG 的 country ，类型为 NUMERIC 的 year 。</strong></p> 
</blockquote> 
<p>然后在您的主代码中，创建一些文档：</p> 
<pre><code class="prism language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> documents <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
   <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token string">"Spring AI rocks!! Spring AI rocks!! Spring AI rocks!! Spring AI rocks!! Spring AI rocks!!"</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"country"</span><span class="token punctuation">,</span> <span class="token string">"UK"</span><span class="token punctuation">,</span> <span class="token string">"year"</span><span class="token punctuation">,</span> <span class="token number">2020</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token string">"The World is Big and Salvation Lurks Around the Corner"</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token keyword">new</span> <span class="token class-name">Document</span><span class="token punctuation">(</span><span class="token string">"You walk forward facing the past and you turn back toward the future."</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"country"</span><span class="token punctuation">,</span> <span class="token string">"NL"</span><span class="token punctuation">,</span> <span class="token string">"year"</span><span class="token punctuation">,</span> <span class="token number">2023</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>现在将文档添加到您的向量存储中：</p> 
<pre><code class="prism language-java">vectorStore<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>最后，检索与查询相似的文档：</p> 
<pre><code class="prism language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Document</span><span class="token punctuation">&gt;</span></span> results <span class="token operator">=</span> vectorStore<span class="token punctuation">.</span><span class="token function">similaritySearch</span><span class="token punctuation">(</span>
   <span class="token class-name">SearchRequest</span>
      <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"Spring"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withTopK</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>如果一切顺利，您应该能够检索包含文本“Spring AI rocks!!”的文档。</p> 
<h4><a id="_124"></a>元数据过滤</h4> 
<p>您也可以利用通用、可移植的元数据过滤器与 RedisVectorStore。<br> 例如，您可以使用文本表达语言：</p> 
<pre><code class="prism language-java">vectorStore<span class="token punctuation">.</span><span class="token function">similaritySearch</span><span class="token punctuation">(</span>
   <span class="token class-name">SearchRequest</span>
      <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"The World"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withTopK</span><span class="token punctuation">(</span><span class="token constant">TOP_K</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withSimilarityThreshold</span><span class="token punctuation">(</span><span class="token constant">SIMILARITY_THRESHOLD</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withFilterExpression</span><span class="token punctuation">(</span><span class="token string">"country in ['UK', 'NL'] &amp;&amp; year &gt;= 2020"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>或者使用表达式 DSL 进行编程：</p> 
<pre><code class="prism language-java"><span class="token class-name">FilterExpressionBuilder</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterExpressionBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vectorStore<span class="token punctuation">.</span><span class="token function">similaritySearch</span><span class="token punctuation">(</span>
   <span class="token class-name">SearchRequest</span>
      <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"The World"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withTopK</span><span class="token punctuation">(</span><span class="token constant">TOP_K</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withSimilarityThreshold</span><span class="token punctuation">(</span><span class="token constant">SIMILARITY_THRESHOLD</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">withFilterExpression</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>
         b<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token string">"country"</span><span class="token punctuation">,</span> <span class="token string">"UK"</span><span class="token punctuation">,</span> <span class="token string">"NL"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         b<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token string">"year"</span><span class="token punctuation">,</span> <span class="token number">2020</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>可移植的过滤表达式会自动转换为 Redis 搜索查询。例如，以下可移植的过滤表达式：</p> 
<pre><code class="prism language-text">country in ['UK', 'NL'] &amp;&amp; year &gt;= 2020
</code></pre> 
<p>被转换为 Redis 查询：</p> 
<pre><code class="prism language-text">@country:{UK | NL} @year:[2020 inf]
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cc19045444fa16b0fde515f496ec63ad/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python传递参数的5种方式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/09d5a989bb3e7be0dc5710bcf93483c3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Stable Diffusion AI绘画：绘画参数与原理全攻略参上！千万别错过！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>