<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>LVS原理及相关配置 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/37ff02077c98ca6776c5f39529fdc7ff/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="LVS原理及相关配置">
  <meta property="og:description" content="1. 描述以及工作原理 1. 什么是 LVS linux virtural server 的简称，也就是 linxu 虚拟机服务器，这是一个 由章文嵩博士发起的开源项目，官网是 http://www.linuxvirtualserver.org,现在 lvs 已经是 linux 内核标 准的一部分，使用lvs 可以达到的技术目标是：通过 linux 达到负载均衡技术和linux 操作系统实现一个高性能高可用的 linux 服务器集群，他具有良好的可靠性，可延展性和可操作性，从而以低廉的成本实现最优的性能，Lvs 是一个实现负载均衡集群开源软件项目，lvs 从逻辑上可以分为调度层，server集群层，和共享存储 免费，开源，四层负载均衡 2. LVS 调度算法 1. 静态调度算法 Fixed Scheduling Method 1. 轮询 RR 轮询 ** 调度器通过 &#34; 轮叫 &#34; 调度算法将外部请求按顺序轮流分配到集群中的真 实服务器上，它均等地对待每一台服务器，而不管服务器上实际的连接数和系统负载。 2. 加权轮询 WRR 加权轮询 ** 调度器通过 &#34; 加权轮叫 &#34; 调度算法根据真实服务器的不同处理能力来调度访问请求。 这样可以保证处理能力强的服务器处理更多的访问流量。调度器 可以自动问询真实服务器的负载情况，并动态地调整其权值 3. 目标地址 hash DH 目标地址 hash** 算法也是针对目标 IP 地址的负载均衡，但它是一种静态映射算法，通过一个散列（Hash ）函数将一个目标 IP 地址映射到一台服务器。目标地址散列调度算法先根据请求的目标IP 地址，作为散列键 （Hash Key ）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。 4.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-13T16:24:13+08:00">
    <meta property="article:modified_time" content="2024-08-13T16:24:13+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">LVS原理及相关配置</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div> 
 <span style="color:#333333;"><strong>1.</strong></span> 
 <span style="color:#333333;"><strong>描述以及工作原理 </strong></span> 
</div> 
<div> 
 <span style="color:#333333;">1. </span> 
 <span style="color:#333333;">什么是</span> 
 <span style="color:#333333;">LVS</span> 
</div> 
<div> 
 <div> 
  <span style="color:#333333;">        linux virtural server</span> 
  <span style="color:#333333;">的简称，也就是</span> 
  <span style="color:#333333;">linxu</span> 
  <span style="color:#333333;">虚拟机服务器，这是一个 由章文嵩博士发起的开源项目，官网是 http://www.linuxvirtualserver.org,现在</span> 
  <span style="color:#333333;">lvs</span> 
  <span style="color:#333333;">已经是</span> 
  <span style="color:#333333;">linux</span> 
  <span style="color:#333333;">内核标 准的一部分，使用lvs</span> 
  <span style="color:#333333;">可以达到的技术目标是：通过</span> 
  <span style="color:#333333;">linux</span> 
  <span style="color:#333333;">达到负载均衡技术和linux</span> 
  <span style="color:#333333;">操作系统实现一个高性能高可用的</span> 
  <span style="color:#333333;">linux</span> 
  <span style="color:#333333;">服务器集群，他具有良好的可靠性，可延展性和可操作性，从而以低廉的成本实现最优的性能，Lvs</span> 
  <span style="color:#333333;">是一个实现负载均衡集群开源软件项目，lvs</span> 
  <span style="color:#333333;">从逻辑上可以分为调度层，server集群层，和共享存储 </span> 
 </div> 
 <div> 
  <span style="color:#333333;">      免费，开源，四层负载均衡</span> 
 </div> 
 <div> 
  <div> 
   <span style="color:#333333;">2. LVS</span> 
   <span style="color:#333333;">调度算法 </span> 
  </div> 
  <div> 
   <span style="color:#333333;">1. </span> 
   <span style="color:#333333;">静态调度算法</span> 
   <span style="color:#333333;"> Fixed Scheduling Method </span> 
  </div> 
  <div> 
   <span style="color:#333333;">1. </span> 
   <span style="color:#333333;">轮询</span> 
  </div> 
  <div> 
   <div> 
    <span style="color:#333333;">RR </span> 
    <span style="color:#333333;">轮询</span> 
    <span style="color:#333333;">** </span> 
   </div> 
   <div> 
    <span style="color:#333333;">      调度器通过</span> 
    <span style="color:#333333;">"</span> 
    <span style="color:#333333;">轮叫</span> 
    <span style="color:#333333;">"</span> 
    <span style="color:#333333;">调度算法将外部请求按顺序轮流分配到集群中的真 实服务器上，它均等地对待每一台服务器，而不管服务器上实际的连接数和系统负载。</span> 
   </div> 
   <div> 
    <span style="color:#333333;">2. </span> 
    <span style="color:#333333;">加权轮询</span> 
   </div> 
   <div> 
    <div> 
     <span style="color:#333333;">WRR </span> 
     <span style="color:#333333;">加权轮询</span> 
     <span style="color:#333333;">** </span> 
    </div> 
    <div> 
     <span style="color:#333333;">      调度器通过</span> 
     <span style="color:#333333;">"</span> 
     <span style="color:#333333;">加权轮叫</span> 
     <span style="color:#333333;">"</span> 
     <span style="color:#333333;">调度算法根据真实服务器的不同处理能力来调度访问请求。 这样可以保证处理能力强的服务器处理更多的访问流量。调度器 可以自动问询真实服务器的负载情况，并动态地调整其权值</span> 
    </div> 
    <div> 
     <span style="color:#333333;">3. </span> 
     <span style="color:#333333;">目标地址</span> 
     <span style="color:#333333;">hash</span> 
    </div> 
    <div> 
     <div> 
      <span style="color:#333333;">DH </span> 
      <span style="color:#333333;">目标地址</span> 
      <span style="color:#333333;">hash** </span> 
     </div> 
     <div> 
      <span style="color:#333333;">算法也是针对目标</span> 
      <span style="color:#333333;">IP</span> 
      <span style="color:#333333;">地址的负载均衡，但它是一种静态映射算法，通过一个散列（Hash</span> 
      <span style="color:#333333;">）函数将一个目标</span> 
      <span style="color:#333333;">IP</span> 
      <span style="color:#333333;">地址映射到一台服务器。目标地址散列调度算法先根据请求的目标IP</span> 
      <span style="color:#333333;">地址，作为散列键 （Hash Key</span> 
      <span style="color:#333333;">）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。 </span> 
     </div> 
     <div> 
      <span style="color:#333333;">4.</span> 
      <span style="color:#333333;">源地址</span> 
      <span style="color:#333333;">hash</span> 
      <div> 
       <span style="color:#333333;">SH </span> 
       <span style="color:#333333;">源地址</span> 
       <span style="color:#333333;">hash** </span> 
      </div> 
      <div> 
       <span style="color:#333333;">    算法正好与目标地址散列调度算法相反，它根据请求的源</span> 
       <span style="color:#333333;">IP</span> 
       <span style="color:#333333;">地址，作 为散列键（Hash Key</span> 
       <span style="color:#333333;">）从静态分配的散列表找出对应的服务器，若该服务器是 可用的且未超载，将请求发送到该服务器，否则返回空。 </span> 
      </div> 
      <div> 
       <span style="color:#333333;">     它采用的散列函数与目标地址散列调度算法的相同。除了将请求的目标IP</span> 
       <span style="color:#333333;">地址换成请求的源</span> 
       <span style="color:#333333;">IP</span> 
       <span style="color:#333333;">地址外，它的算法流程与目标地址散列调度算法的基本相似。在实际应用中，源地址散列调度和目标地址散列调度可以结合使用在防火墙集群中，它们可以保证整个系统的唯一出 入口。 </span> 
      </div> 
      <div> 
       <span style="color:#333333;">2. </span> 
       <span style="color:#333333;">动态调度算法</span> 
       <span style="color:#333333;"> Dynamic Scheduling Method </span> 
       <span style="color:#333333;">动态调度方法 </span> 
      </div> 
      <div> 
       <span style="color:#333333;">1. Lc</span> 
       <span style="color:#333333;">最少链接 </span> 
      </div> 
      <div> 
       <span style="color:#333333;">     调度器通过</span> 
       <span style="color:#333333;">"</span> 
       <span style="color:#333333;">最少连接</span> 
       <span style="color:#333333;">"</span> 
       <span style="color:#333333;">调度算法动态地将网络请求调度到已建立的链接数最少的服务器上。 如果集群系统的真实服务器具有相近的系统性能，采用"</span> 
       <span style="color:#333333;">最小连接</span> 
       <span style="color:#333333;">"</span> 
       <span style="color:#333333;">调度算法可以较好地均衡负载。、</span> 
      </div> 
      <div> 
       <div> 
        <span style="color:#333333;">2. wlc</span> 
        <span style="color:#333333;">加权最少链接、 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">     在集群系统中的服务器性能差异较大的情况下，调度器采用</span> 
        <span style="color:#333333;">"</span> 
        <span style="color:#333333;">加权最少链接"</span> 
        <span style="color:#333333;">调度算法优化负载均衡性能，具有较高权值的服务器将承受较大比例的活动连接负载。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</span> 
       </div> 
       <div> 
        <div> 
         <span style="color:#333333;">3. sed</span> 
         <span style="color:#333333;">最少期望延迟 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">     基于</span> 
         <span style="color:#333333;">wlc</span> 
         <span style="color:#333333;">算法，举例说明：</span> 
         <span style="color:#333333;">ABC</span> 
         <span style="color:#333333;">三台机器分别权重</span> 
         <span style="color:#333333;">123</span> 
         <span style="color:#333333;">，连接数也分别是123</span> 
         <span style="color:#333333;">，</span> 
         <span style="color:#333333;">name</span> 
         <span style="color:#333333;">如果使用</span> 
         <span style="color:#333333;">WLC</span> 
         <span style="color:#333333;">算法的话一个新请求 进入时他可能会分给ABC</span> 
         <span style="color:#333333;">中任意一个，使用</span> 
         <span style="color:#333333;">SED</span> 
         <span style="color:#333333;">算法后会进行这样一个运算 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">A:(1+1)/2 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">B:(1+2)/2 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">C:(1+3)/3 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">根据运算结果，把连接交给</span> 
         <span style="color:#333333;">C </span> 
        </div> 
        <div> 
         <span style="color:#333333;">4. nq</span> 
         <span style="color:#333333;">从不排队调度算法 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">    无需列队，如果有台</span> 
         <span style="color:#333333;">realserver</span> 
         <span style="color:#333333;">的连接数</span> 
         <span style="color:#333333;">=0 </span> 
         <span style="color:#333333;">就直接分配过去，不需要进行sed</span> 
         <span style="color:#333333;">运算 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">5. lblc</span> 
         <span style="color:#333333;">基于本地最少链接 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">     "</span> 
         <span style="color:#333333;">基于局部性的最少链接</span> 
         <span style="color:#333333;">" </span> 
         <span style="color:#333333;">调度算法是针对目标</span> 
         <span style="color:#333333;">IP</span> 
         <span style="color:#333333;">地址的负载均衡，目前主要用于Cache</span> 
         <span style="color:#333333;">集群系统。该算法根据请求的目标IP</span> 
         <span style="color:#333333;">地址找出该 目标</span> 
         <span style="color:#333333;">IP</span> 
         <span style="color:#333333;">地址最近使用的服务器，若该服务器 是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用"</span> 
         <span style="color:#333333;">最少链接</span> 
         <span style="color:#333333;">"</span> 
         <span style="color:#333333;">的原则选出一个可用的服务器，将请求发送到该服务器。 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">6. lblcr</span> 
         <span style="color:#333333;">带复制的基于本地的最少链接</span> 
        </div> 
       </div> 
      </div> 
      <div> 
       <div> 
        <span style="color:#333333;">      "</span> 
        <span style="color:#333333;">带复制的基于局部性最少链接</span> 
        <span style="color:#333333;">"</span> 
        <span style="color:#333333;">调度算法也是针对目标</span> 
        <span style="color:#333333;">IP</span> 
        <span style="color:#333333;">地址的负载均衡，目前主要用于Cache</span> 
        <span style="color:#333333;">集群系统。它与LBLC</span> 
        <span style="color:#333333;">算法的不同 之处是它要维护从一个 目标</span> 
        <span style="color:#333333;">IP</span> 
        <span style="color:#333333;">地址到一组服 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">务器的映射，而</span> 
        <span style="color:#333333;">LBLC</span> 
        <span style="color:#333333;">算法维护从一个目标</span> 
        <span style="color:#333333;">IP</span> 
        <span style="color:#333333;">地址到一台服务器的映射。该算法根据请求的目标IP</span> 
        <span style="color:#333333;">地址找出该目标</span> 
        <span style="color:#333333;">IP</span> 
        <span style="color:#333333;">地址对应的服务器组，按"</span> 
        <span style="color:#333333;">最小连接</span> 
        <span style="color:#333333;">"</span> 
        <span style="color:#333333;">原则从服务器组中选出一台服务器， 若服务器没有超载，将请求发送到该服务器；若服务器超载，则按"</span> 
        <span style="color:#333333;">最小连接</span> 
        <span style="color:#333333;">"</span> 
        <span style="color:#333333;">原则从这个集群中选出一 台服务器 ，将该服务器加入到服务器组中，将请求发送到该服务器。同时，当该服务器组有一段时间没有被修改， 将最忙的服务器从服务器组中删除，以降低复制的程度。 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">3. LVS</span> 
        <span style="color:#333333;">的工作原理</span> 
       </div> 
       <div> 
        <img alt="" height="290" src="https://images2.imgbox.com/f6/0a/lQSlEEPH_o.png" width="560"> 
       </div> 
      </div> 
      <div> 
       <div> 
        <span style="color:#333333;">1. </span> 
        <span style="color:#333333;">当用户向负载均衡调度器（</span> 
        <span style="color:#333333;">director server</span> 
        <span style="color:#333333;">）发起请求，调度器将请求发往内核空间 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">2. prerouting</span> 
        <span style="color:#333333;">链首先会接受到用户请求，判断目标</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">确定是本机</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">，将数据包发往input</span> 
        <span style="color:#333333;">链 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">3. IPVS</span> 
        <span style="color:#333333;">是工作在</span> 
        <span style="color:#333333;">input</span> 
        <span style="color:#333333;">链上的，当用户请求到达</span> 
        <span style="color:#333333;">input</span> 
        <span style="color:#333333;">时，</span> 
        <span style="color:#333333;">ipvs</span> 
        <span style="color:#333333;">会将用户请求和自己定义好的集群服务器进行比对，如果用户请求就是定义的集群服务，那么此时ipvs</span> 
        <span style="color:#333333;">会强行修改数据包里的目标</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">地址以及端口，并将新的数据包发往POSTROUTING</span> 
        <span style="color:#333333;">链， </span> 
       </div> 
       <div> 
        <span style="color:#333333;">4. POSTROUTING</span> 
        <span style="color:#333333;">链接收到数据包后，发现目标</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">地址刚好是自己的后端服务器，那么通过选路，将数据包最终发送给后端服务器</span> 
       </div> 
       <div> 
        <span style="color:#333333;"><strong>2.</strong></span> 
        <span style="color:#333333;"><strong>组成以及相关术语</strong></span> 
       </div> 
       <div> 
        <div> 
         <span style="color:#333333;">1.</span> 
         <span style="color:#333333;">组成 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">1. ipvs</span> 
         <pre><code class="hljs">ip virtual server,一段代码工作在内核空间，ipvs，是真正生效实现
调度的代码（累死nginx中的proxy_pass），</code></pre> 
         <div> 
          <span style="color:#333333;">2. ipvsadm </span> 
         </div> 
        </div> 
       </div> 
      </div> 
      <div> 
       <pre><code class="hljs">另一段是工作在用户空间，ipvsadm，负责为ipvs内核框架编写规则，定义
谁是集群服务，谁是后端真正的服务器（real server）类似nginx中的
upstrean</code></pre> 
       <div> 
        <span style="color:#333333;">3. lvs</span> 
        <span style="color:#333333;">组成</span> 
        <span style="color:#333333;">=ipvsipv(</span> 
        <span style="color:#333333;">内核，负载均衡调度代码</span> 
        <span style="color:#333333;">)+sadm</span> 
        <span style="color:#333333;">（</span> 
        <span style="color:#333333;">ipvs</span> 
        <span style="color:#333333;">管理器，负责均衡提供集群后端服务等信息） </span> 
       </div> 
       <div> 
        <span style="color:#333333;">2.术语</span> 
       </div> 
       <div> 
        <img alt="" height="287" src="https://images2.imgbox.com/ac/b7/gJWjKaTQ_o.png" width="597"> 
       </div> 
      </div> 
      <div></div> 
      <div> 
       <div> 
        <span style="color:#333333;">1. DS DIrector Server </span> 
        <span style="color:#333333;">前端负责均衡节点（负载均衡服务器） </span> 
       </div> 
       <div> 
        <span style="color:#333333;">2. RS real server </span> 
        <span style="color:#333333;">后端真实工作服务器（</span> 
        <span style="color:#333333;">web</span> 
        <span style="color:#333333;">服务器） </span> 
       </div> 
      </div> 
      <div> 
       <div> 
        <span style="color:#333333;">3. vip</span> 
        <span style="color:#333333;">向外部直接面向用户请求，作为用户请求的目标</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">地址（负载均衡的ip地址，提供给用户） </span> 
       </div> 
       <div> 
        <span style="color:#333333;">4. DIP Director Server Ip </span> 
        <span style="color:#333333;">和内部主机通讯的</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">地址（负责与</span> 
        <span style="color:#333333;">Real Server</span> 
        <span style="color:#333333;">交互的内部Ip</span> 
        <span style="color:#333333;">） </span> 
       </div> 
       <div> 
        <span style="color:#333333;">5. RIP Real Server Ip </span> 
        <span style="color:#333333;">后端服务器</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">地址 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">6. CIP client IP </span> 
        <span style="color:#333333;">访问客户端</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">地址</span> 
       </div> 
       <div> 
        <div> 
         <span style="color:#333333;"><strong>3.</strong></span> 
         <span style="color:#333333;"><strong>三种工作模式 </strong></span> 
        </div> 
        <div> 
         <span style="color:#333333;">1. *LVS-NAT</span> 
         <span style="color:#333333;">模式 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">2. *LVS-DR</span> 
         <span style="color:#333333;">模式 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">3. Lvs-Tun</span> 
         <span style="color:#333333;">模式（隧道模式） </span> 
        </div> 
        <div> 
         <span style="color:#333333;"><strong>4.NAT</strong></span> 
         <span style="color:#333333;"><strong>模式的工作原理</strong></span> 
        </div> 
       </div> 
      </div> 
      <div> 
       <img alt="" height="294" src="https://images2.imgbox.com/21/f4/BuJAAogu_o.png" width="588"> 
      </div> 
      <div> 
       <img alt="" height="255" src="https://images2.imgbox.com/1c/95/mxuJsjJe_o.png" width="591"> 
      </div> 
      <div> 
       <div> 
        <span style="color:#333333;">1. </span> 
        <span style="color:#333333;">用户请求</span> 
        <span style="color:#333333;">ds</span> 
        <span style="color:#333333;">，此时请求的报文会先到内核空间</span> 
        <span style="color:#333333;">prerouting</span> 
        <span style="color:#333333;">链，此时报文 ip为</span> 
        <span style="color:#333333;">cip</span> 
        <span style="color:#333333;">，目标</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">为</span> 
        <span style="color:#333333;">vip </span> 
       </div> 
       <div> 
        <span style="color:#333333;">2. prerouting</span> 
        <span style="color:#333333;">检测发现数据包目标</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">是本机，将数据包送到</span> 
        <span style="color:#333333;">input</span> 
        <span style="color:#333333;">链 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">3. ipvs</span> 
        <span style="color:#333333;">对比数据包请求的服务是否为集群服务，如果是，修改数据包的目标ip</span> 
        <span style="color:#333333;">地址为后端服务器的</span> 
        <span style="color:#333333;">IP</span> 
        <span style="color:#333333;">地址，然后将数据包发送给</span> 
        <span style="color:#333333;">POSTROUTING链，此时报文ip</span> 
        <span style="color:#333333;">为</span> 
        <span style="color:#333333;">cip</span> 
        <span style="color:#333333;">，目标</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">为</span> 
        <span style="color:#333333;">rip </span> 
       </div> 
       <div> 
        <span style="color:#333333;">4. POSTROUTING</span> 
        <span style="color:#333333;">通过选路，将数据发送给</span> 
        <span style="color:#333333;">Real Server </span> 
       </div> 
       <div> 
        <span style="color:#333333;">5. RealServer</span> 
        <span style="color:#333333;">对比发现目标</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">为自己的</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">，开始构建响应报文发回给Director Server此时报文的源</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">为</span> 
        <span style="color:#333333;">RIP</span> 
        <span style="color:#333333;">，目标</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">为</span> 
        <span style="color:#333333;">CIP </span> 
       </div> 
       <div> 
        <span style="color:#333333;">6. Derector Server</span> 
        <span style="color:#333333;">在响应客户端前，会将源</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">地址修改为自己的</span> 
        <span style="color:#333333;">VIP</span> 
        <span style="color:#333333;">，然后响应给客户端，目标ip</span> 
        <span style="color:#333333;">为</span> 
        <span style="color:#333333;">cip</span> 
        <span style="color:#333333;">，此时报文源</span> 
        <span style="color:#333333;">IP</span> 
        <span style="color:#333333;">为</span> 
        <span style="color:#333333;">VIP</span> 
        <span style="color:#333333;">，目标</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">为</span> 
        <span style="color:#333333;">cipNAT模型的特性 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">1. Rs</span> 
        <span style="color:#333333;">应该是私有地址，</span> 
        <span style="color:#333333;">Rs</span> 
        <span style="color:#333333;">网关必须指向</span> 
        <span style="color:#333333;">DIP </span> 
       </div> 
       <div> 
        <span style="color:#333333;">2. DIP</span> 
        <span style="color:#333333;">和</span> 
        <span style="color:#333333;">RIP</span> 
        <span style="color:#333333;">必须在同一个网段内 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">3. </span> 
        <span style="color:#333333;">请求和响应报文都应该经过</span> 
        <span style="color:#333333;">Director Server</span> 
        <span style="color:#333333;">，高负载场景中</span> 
        <span style="color:#333333;">DirectorServer容易成为性能瓶颈 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">4. </span> 
        <span style="color:#333333;">支持端口映射 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">5. Rs</span> 
        <span style="color:#333333;">可是使用任意操作系统 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">6. </span> 
        <span style="color:#333333;">缺陷，对</span> 
        <span style="color:#333333;">Ds</span> 
        <span style="color:#333333;">压力会比较大，请求和响应都需要经过</span> 
        <span style="color:#333333;">ds</span> 
        <span style="color:#333333;">， </span> 
       </div> 
      </div> 
      <div> 
       <div> 
        <span style="color:#333333;"><strong>5.NAT</strong></span> 
        <span style="color:#333333;"><strong>模式实战</strong></span> 
        <span style="color:#333333;"><strong>-</strong></span> 
        <span style="color:#333333;"><strong>环境准备</strong></span> 
       </div> 
      </div> 
      <div></div> 
      <div> 
       <img alt="" height="232" src="https://images2.imgbox.com/ba/bb/xbe22H9j_o.png" width="580"> 
      </div> 
      <div> 
       <img alt="" height="273" src="https://images2.imgbox.com/d1/90/pbmXSGA8_o.png" width="599"> 
      </div> 
      <div></div> 
      <div> 
       <div> 
        <span style="color:#333333;">2. </span> 
        <span style="color:#333333;">给</span> 
        <span style="color:#333333;">NAT</span> 
        <span style="color:#333333;">主机增加一张网卡，命名为</span> 
        <span style="color:#333333;">ens37</span> 
        <span style="color:#333333;">，自动或者手工获取</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">均可，理论上nat</span> 
        <span style="color:#333333;">对应</span> 
        <span style="color:#333333;">ds</span> 
        <span style="color:#333333;">服务器应该有两张网卡（</span> 
        <span style="color:#333333;">vip</span> 
        <span style="color:#333333;">，</span> 
        <span style="color:#333333;">dip</span> 
        <span style="color:#333333;">）</span> 
        <span style="color:#333333;">vip</span> 
        <span style="color:#333333;">对外服务，需要使用公网ip</span> 
        <span style="color:#333333;">，</span> 
        <span style="color:#333333;">dip</span> 
        <span style="color:#333333;">内网局域网，使用虚拟机使用仅主机模式，也可以用桥接模式和nat</span> 
        <span style="color:#333333;">模式都可以 </span> 
       </div> 
       <div> 
        <p><span style="color:#333333;">3. </span><span style="color:#333333;">步骤 1. 配置两个网卡和两个</span><span style="color:#333333;">ip</span><span style="color:#333333;">地址，正常来说应该配置两个不同的网段的ip，一个对外的</span><span style="color:#333333;">vip</span><span style="color:#333333;">，一个对内的</span><span style="color:#333333;">dip</span><span style="color:#333333;">，现在主要使用</span><span style="color:#333333;">nat</span><span style="color:#333333;">的网络模式，可以配置桥接模式对外，Nat</span><span style="color:#333333;">对内，教师机不方便配置桥接模式，所以都是配置的nat</span><span style="color:#333333;">模式，但是一定要分清楚哪个</span><span style="color:#333333;">ip</span><span style="color:#333333;">是</span><span style="color:#333333;">vip</span><span style="color:#333333;">，哪个ip是dip，在物理主机上都要能够</span><span style="color:#333333;">ping</span><span style="color:#333333;">通。 </span></p> 
        <p><span style="color:#333333;">2. 克隆主机，生成</span><span style="color:#333333;">net</span><span style="color:#333333;">模式的机器 </span></p> 
        <div> 
         <span style="color:#333333;">3. </span> 
         <span style="color:#333333;">设置主机名称</span> 
         <span style="color:#333333;"><strong>nat.yuanyu.zhangmin</strong></span> 
        </div> 
        <pre><code class="hljs">[root@nat ~]# hostname
nat.yuanyu.zhangmin</code></pre> 
       </div> 
      </div> 
      <div> 
       <span style="color:#333333;">4. </span> 
       <span style="color:#333333;">更改</span> 
       <span style="color:#333333;">ip</span> 
       <span style="color:#333333;">地址</span> 
       <pre><code class="hljs">vim /etc/sysconfig/network-scripts/ifcfg-ens33
DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
IPV6_ADDR_GEN_MODE="stable-privacy"
NAME="ens33"
UUID="7a2bb575-3b9c-4206-9dd7-e87372b68952"
DEVICE="ens33"
ONBOOT="yes"
IPADDR=10.1.1.100
NETMASK=255.255.255.0
GATEWAY=10.1.1.2
DNS1=8.8.8.8
DNS2=114.114.114.114</code></pre> 
       <div> 
        <span style="color:#333333;">5. </span> 
        <span style="color:#333333;">额外添加一张网卡，选择对外提供服务的桥接模式或者</span> 
        <span style="color:#333333;">nat</span> 
        <span style="color:#333333;">模式，选 </span> 
       </div> 
       <div> 
        <span style="color:#333333;">择桥接模式（</span> 
        <span style="color:#333333;">ip</span> 
        <span style="color:#333333;">不同）</span> 
       </div> 
       <div> 
        <img alt="" height="475" src="https://images2.imgbox.com/3b/0a/7qeu11p1_o.png" width="519"> 
       </div> 
       <div> 
        <img alt="" height="437" src="https://images2.imgbox.com/2f/64/hRmIQadI_o.png" width="528"> 
       </div> 
       <div></div> 
       <div> 
        <div> 
         <span style="color:#333333;">6. </span> 
         <span style="color:#333333;">查看所有网卡</span> 
        </div> 
       </div> 
       <div></div> 
       <div> 
        <pre><code class="hljs">[root@nat ~]# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc
noqueue state UNKNOWN group default qlen 1000
link/loopback 00:00:00:00:00:00 brd
00:00:00:00:00:00
inet 127.0.0.1/8 scope host lo
valid_lft forever preferred_lft forever
inet6 ::1/128 scope host
valid_lft forever preferred_lft forever
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500
qdisc pfifo_fast state UP group default qlen 1000
link/ether 00:0c:29:6f:6e:0a brd
ff:ff:ff:ff:ff:ff
inet 10.1.1.100/24 brd 10.1.1.255 scope global
ens33
valid_lft forever preferred_lft forever
inet6 fe80::20c:29ff:fe6f:6e0a/64 scope link
valid_lft forever preferred_lft forever
3: ens36: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500
qdisc pfifo_fast state UP group default qlen 1000
link/ether 00:0c:29:6f:6e:14 brd
ff:ff:ff:ff:ff:ff
inet 192.168.0.100/24 brd 192.168.0.255 scope
global ens36
valid_lft forever preferred_lft forever
inet6 240e:878:8fa:6069:20c:29ff:fe6f:6e14/64
scope global mngtmpaddr dynamic
valid_lft forever preferred_lft forever
inet6 fe80::20c:29ff:fe6f:6e14/64 scope link
valid_lft forever preferred_lft forever
</code></pre> 
        <p>7. 修改网卡配置文件</p> 
        <pre><code class="hljs">[root@nat ~]# vim /etc/sysconfig/networkscripts/ifcfg-ens36
TYPE="Ethernet"
BOOTPROTO="none"
NAME="ens36"
UUID="606c3bb5-ae86-42fa-95e1-d9766c3d4ab9"
DEVICE="ens36"
ONBOOT="yes"
IPADDR=192.168.0.100
NETMASK=255.255.255.0</code></pre> 
        <div> 
         <span style="color:#333333;">8. </span> 
         <span style="color:#333333;">时间同步 </span> 
         <pre><code class="hljs">[root@nat ~]# yum -y install ntpdate
[root@nat ~]# yum -y install ntp
[root@nat ~]# ntpdate cn.ntp.org.cn
[root@nat ~]# systemctl start ntpd
[root@nat ~]# systemctl enable ntpd</code></pre> 
         <div> 
          <span style="color:#333333;">9. </span> 
          <span style="color:#333333;">停用其他服务</span> 
          <pre><code class="hljs"># 停用selinux
setenforce 0
sed -i '/SELINUX=enforcing/cSELINUX=disabled'
/etc/selinux/config
#停用防火墙
systemctl stop firewalld
systemctl disable firewalld &amp;&gt;/dev/null
# 停用NetworkManage
systemctl stop NetworkManager
systemctl disable NetworkManager &amp;&gt;/dev/null</code></pre> 
          <div> 
           <span style="color:#333333;">10. </span> 
           <span style="color:#333333;">添加</span> 
           <span style="color:#333333;">web</span> 
           <span style="color:#333333;">服务器（</span> 
           <span style="color:#333333;">web01 10.1.1.200</span> 
           <span style="color:#333333;">，</span> 
           <span style="color:#333333;">web02 10.1.1.201</span> 
           <span style="color:#333333;">）</span> 
           <pre><code class="hljs"># 设置主机名称
# 关闭防火墙
# 固定ip地址
# 关闭SELinux
# 关闭NetworkManager
# 安装nginx
# 修改index.html文件
# 时间同步
# 启动服务</code></pre> 
           <div> 
            <span style="color:#333333;">11. </span> 
            <span style="color:#333333;">配置</span> 
            <span style="color:#333333;">dns</span> 
            <span style="color:#333333;">服务器 </span> 
           </div> 
           <div> 
            <span style="color:#333333;">1. yuanyu.zhangmin </span> 
           </div> 
           <div> 
            <span style="color:#333333;">web01.yuanyu.zhangmin x.x.x.200 </span> 
           </div> 
           <div> 
            <span style="color:#333333;">Web02.yuanyu.zhangmin x.x.x.201 </span> 
           </div> 
           <div> 
            <span style="color:#333333;">nat.yuanyu.zhangmin </span> 
           </div> 
           <div> 
            <span style="color:#333333;">x.x.x.100 </span> 
           </div> 
           <div> 
            <span style="color:#333333;">Ds.yuanyu.zhangmin </span> 
           </div> 
           <div> 
            <span style="color:#333333;">x.x.x.110 </span> 
            <pre><code class="hljs"># 修改主机名称
# 固定ip
# 关闭防火墙
# 关闭SELinux
# 关闭NetManager
# 安装bind的
yum -y install bind
# 配置主配置文件
vim /etc/named.conf
# 配置zones文件
vim /etc/named.rfc...zones
# 配置zone文件
vim /var/named/...zone
# 同步时间
# 启动服务</code></pre> 
            <div> 
             <span style="color:#333333;">12. </span> 
             <span style="color:#333333;">配置</span> 
             <span style="color:#333333;">client</span> 
             <span style="color:#333333;">客户测试机</span> 
             <pre><code class="hljs"># 临时指定dns服务器
# 永久指定dns服务器</code></pre> 
             <p><img alt="" height="408" src="https://images2.imgbox.com/f2/8b/TVJG0nXm_o.png" width="573"></p> 
            </div> 
           </div> 
          </div> 
         </div> 
        </div> 
       </div> 
       <div> 
        <div> 
         <span style="color:#333333;"><strong>6.NAT</strong></span> 
         <span style="color:#333333;"><strong>模式搭建实战 </strong></span> 
        </div> 
        <div> 
         <span style="color:#333333;">1. nat</span> 
         <span style="color:#333333;">服务器配置 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">1. Itvs. Ip vartual server </span> 
         <span style="color:#333333;">已经是内核应用，无法修改 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">2. ipvsadm</span> 
         <span style="color:#333333;">这个工具管理服务 </span> 
         <pre><code class="hljs"># 安装ipvsadm
[root@nat ~]# yum -y install ipvsadm
# 清空以往的规则
[root@nat ~]# ipvsadm -C
# 查看规则
[root@nat ~]# ipvsadm -L -n
# 新增规则
[root@nat ~]# ipvsadm -A -t 192.168.0.100:80 -s rr
# 添加主机
[root@nat ~]# ipvsadm -a -t 192.168.0.100:80 -r
10.1.1.200:80 -m
[root@nat ~]# ipvsadm -a -t 192.168.0.100:80 -r
10.1.1.201:80 -m
# 设置ip转发
[root@nat ~]# vim /etc/sysctl.conf
============================================
net.ipv4.ip_forward=1
============================================
# 设置生效
[root@nat ~]# sysctl -p
net.ipv4.ip_forward = 1</code></pre> 
         <div> 
          <span style="color:#333333;">2. web</span> 
          <span style="color:#333333;">服务器网关配置</span> 
          <pre><code class="hljs">[root@web01 ~]# route del default
[root@web01 ~]# route add default gw 10.1.1.100
[root@web02 ~]# route del default
[root@web02 ~]# route add default gw 10.1.1.100</code></pre> 
          <div> 
           <span style="color:#333333;"><strong>7.DR</strong></span> 
           <span style="color:#333333;"><strong>模式的搭建实战 </strong></span> 
          </div> 
          <div> 
           <span style="color:#333333;"><strong>配置</strong></span> 
           <span style="color:#333333;"><strong>vip</strong></span> 
           <span style="color:#333333;"><strong>网卡 </strong></span> 
          </div> 
          <div> 
           <span style="color:#333333;">1. </span> 
           <span style="color:#333333;">在编辑虚拟网络中创建桥接模式的网卡，并且桥接到有网的适配器上 </span> 
          </div> 
          <div> 
           <span style="color:#333333;">2. </span> 
           <span style="color:#333333;">在</span> 
           <span style="color:#333333;">vmware</span> 
           <span style="color:#333333;">的虚拟主机资源管理器找到虚拟主机，右键菜单，设置 </span> 
          </div> 
          <div> 
           <span style="color:#333333;">3. </span> 
           <span style="color:#333333;">添加新的网卡，自定义为刚才创建的桥接模式网卡 </span> 
          </div> 
          <div> 
           <span style="color:#333333;">4. </span> 
           <span style="color:#333333;">此时在虚拟主机中使用</span> 
           <span style="color:#333333;">ifconfig</span> 
           <span style="color:#333333;">无法找到新的网卡 </span> 
          </div> 
          <div> 
           <span style="color:#333333;">5. ip a</span> 
           <span style="color:#333333;">能够查看到新的</span> 
           <span style="color:#333333;">ens36</span> 
           <span style="color:#333333;">网卡，没有路由 </span> 
          </div> 
          <div> 
           <span style="color:#333333;">6. </span> 
           <span style="color:#333333;">编辑网卡配置</span> 
          </div> 
         </div> 
        </div> 
       </div> 
       <div> 
        <pre><code class="hljs">TYPE="Ethernet"
BOOTPROTO="none"
NAME="ens36"
UUID="fdbcb12c-33b6-4d7d-93bb-3b5380c4fb30"
DEVICE="ens36"
ONBOOT="yes"
IPADDR=192.168.10.100</code></pre> 
        <div> 
         <span style="color:#333333;">7. </span> 
         <span style="color:#333333;">重启</span> 
         <span style="color:#333333;">network</span> 
         <span style="color:#333333;">服务</span> 
         <pre><code class="hljs">[root@ds01 ~]# systemctl restart network</code></pre> 
         <div> 
          <span style="color:#333333;"><strong>添加规则</strong></span> 
          <pre><code class="hljs">[root@ds01 ~]# # 配置ipvs规则
[root@ds01 ~]# ipvsadm -A -t 192.168.10.100:80 -s rr
[root@ds01 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-&gt; RemoteAddress:Port Forward Weight
ActiveConn InActConn
TCP 192.168.10.100:80 rr
[root@ds01 ~]# # 添加rs web01 web02 添加规则
[root@ds01 ~]# ipvsadm -a -t 192.168.10.100:80 -r
10.1.1.200:80 -m
[root@ds01 ~]# ipvsadm -a -t 192.168.10.100:80 -r
10.1.1.201:80 -m
[root@ds01 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
-&gt; RemoteAddress:Port Forward Weight
ActiveConn InActConn
TCP 192.168.10.100:80 rr
-&gt; 10.1.1.200:80 Masq 1 0
0
-&gt; 10.1.1.201:80 Masq 1 0
0</code></pre> 
          <div> 
           <span style="color:#333333;"><strong>ip</strong></span> 
           <span style="color:#333333;"><strong>转发 </strong></span> 
           <pre><code class="hljs">[root@ds01 ~]# vim /etc/sysctl.conf
##########################################
net.ipv4.ip_forward=1
#############################################
[root@ds01 ~]# sysctl -p
net.ipv4.ip_forward = 1</code></pre> 
           <div> 
            <span style="color:#333333;"><strong>临时修改</strong></span> 
            <span style="color:#333333;"><strong>web01</strong></span> 
            <span style="color:#333333;"><strong>和</strong></span> 
            <span style="color:#333333;"><strong>web02</strong></span> 
            <span style="color:#333333;"><strong>的网</strong></span> 
            <span style="color:#333333;"><strong>关</strong></span> 
            <span style="color:#333333;"><strong>,</strong></span> 
            <span style="color:#333333;"><strong>网关必须指向</strong></span> 
            <span style="color:#333333;"><strong>dip</strong></span> 
            <span style="color:#333333;"><strong>（调度服务</strong></span> 
            <span style="color:#333333;"><strong>器的对内的</strong></span> 
            <span style="color:#333333;"><strong>ip</strong></span> 
            <span style="color:#333333;"><strong>）</strong></span> 
           </div> 
          </div> 
         </div> 
        </div> 
       </div> 
       <div> 
        <pre><code class="hljs">[root@web01 ~]# route del default
[root@web01 ~]# route add default gw 10.1.1.100
[root@web01 ~]# # 临时修改网关
# 这也要求了rs ip和 dip要在同一个网段，因为dip是要作为网关存在的</code></pre> 
        <div> 
         <span style="color:#333333;">vs-nat</span> 
         <span style="color:#333333;">模式的优点配置简单，缺点是请求和响应都必须经过</span> 
         <span style="color:#333333;">ds</span> 
         <span style="color:#333333;">，容易称为性能瓶颈 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">希望有这样的模式，请求的时候使用</span> 
         <span style="color:#333333;">input</span> 
         <span style="color:#333333;">链进行负载均衡，响应的时候就不要经过ds</span> 
         <span style="color:#333333;">，直接由</span> 
         <span style="color:#333333;">rs</span> 
         <span style="color:#333333;">响应给客户端 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">在</span> 
         <span style="color:#333333;">nat</span> 
         <span style="color:#333333;">模式的时候，请求</span> 
         <span style="color:#333333;">vip</span> 
         <span style="color:#333333;">，接收</span> 
         <span style="color:#333333;">vip</span> 
         <span style="color:#333333;">的响应 </span> 
        </div> 
        <div> 
         <span style="color:#333333;">构想 请求</span> 
         <span style="color:#333333;">vip</span> 
         <span style="color:#333333;">，接受</span> 
         <span style="color:#333333;">rip</span> 
         <span style="color:#333333;">响应，这是不允许</span> 
         <span style="color:#333333;"> lvs-dr</span> 
         <span style="color:#333333;">模式 </span> 
        </div> 
        <div> 
         <div> 
          <span style="color:#333333;">vip </span> 
          <span style="color:#333333;">请求</span> 
          <span style="color:#333333;"> rip</span> 
          <span style="color:#333333;">响应 </span> 
         </div> 
         <div> 
          <span style="color:#333333;"><strong>NAT</strong></span> 
          <span style="color:#333333;"><strong>脚本</strong></span> 
          <pre><code class="hljs"># ds脚本
#!/bin/bash
#配置网卡
echo TYPE="Ethernet" &gt;&gt; /etc/sysconfig/networkscripts/ifcfg-ens36
echo BOOTPROTO="none" &gt;&gt; /etc/sysconfig/networkscripts/ifcfg-ens36
read -p "router name:" router_name
echo NAME='"$rount_name"' &gt;&gt; /etc/sysconfig/networkscripts/ifcfg-ens36
uuidkey=$( uuidgen )
echo UUID='"$uuidkey"' &gt;&gt; /etc/sysconfig/networkscripts/ifcfg-ens36 &gt;&gt; /etc/sysconfig/networkscripts/ifcfg-ens36
echo DEVICE='"$rount_name"' &gt;&gt; /etc/sysconfig/networkscripts/ifcfg-ens36
echo ONBOOT="yes" &gt;&gt; /etc/sysconfig/network-scripts/ifcfgens36
echo IPADDR=192.168.10.100 &gt;&gt; /etc/sysconfig/networkscripts/ifcfg-ens36
systemctl restart network
#安装ipvsadm
yum list installed|grep ipvsadm
if[ $? -ne 0 ];then
yum -y install ipvsadm
fi
#配置规则
read -p "vip:" vip
read -p "port:" port
read -p "rule:" s
ipvsadm -A -t $vip:$port -s $s
# ip forward
echo "net.ipv4.ip_forward=1" &gt;/etc/sysctl.conf
sysctl -p
# rs脚本
#!/bin/bash
read -p "dip:" dip
# 设置网关
route del default
route add defualt gw $dip</code></pre> 
          <div> 
           <span style="color:#333333;">DR</span> 
           <span style="color:#333333;">模式 </span> 
          </div> 
          <div> 
           <span style="color:#333333;">1.</span> 
           <span style="color:#333333;">性能更优，回路不再经过</span> 
           <span style="color:#333333;">ds </span> 
          </div> 
          <div> 
           <span style="color:#333333;">2.ds</span> 
           <span style="color:#333333;">和</span> 
           <span style="color:#333333;">rs</span> 
           <span style="color:#333333;">为了保证用户响应，都要求配置统一的</span> 
           <span style="color:#333333;">vip</span> 
          </div> 
          <div> 
           <span style="color:#333333;">3.</span> 
           <span style="color:#333333;">由于</span> 
           <span style="color:#333333;">rs</span> 
           <span style="color:#333333;">是直接响应</span> 
           <span style="color:#333333;">client</span> 
           <span style="color:#333333;">，网关一定不能设置</span> 
           <span style="color:#333333;">ds </span> 
           <span style="color:#333333;">的</span> 
           <span style="color:#333333;">dip </span> 
          </div> 
          <div> 
           <span style="color:#333333;">4.</span> 
           <span style="color:#333333;">对</span> 
           <span style="color:#333333;">rs</span> 
           <span style="color:#333333;">的</span> 
           <span style="color:#333333;">vip</span> 
           <span style="color:#333333;">进行抑制，让</span> 
           <span style="color:#333333;">ds</span> 
           <span style="color:#333333;">的</span> 
           <span style="color:#333333;">vip</span> 
           <span style="color:#333333;">接收请求，</span> 
           <span style="color:#333333;">rs</span> 
           <span style="color:#333333;">的</span> 
           <span style="color:#333333;">vip</span> 
           <span style="color:#333333;">不接受请求 </span> 
          </div> 
          <div> 
           <span style="color:#333333;">5.rs</span> 
           <span style="color:#333333;">的</span> 
           <span style="color:#333333;">vip</span> 
           <span style="color:#333333;">绑定点</span> 
           <span style="color:#333333;">lo</span> 
           <span style="color:#333333;">回路网卡上 </span> 
          </div> 
          <div> 
           <span style="color:#333333;">1.</span> 
           <span style="color:#333333;">在</span> 
           <span style="color:#333333;">ds</span> 
           <span style="color:#333333;">的</span> 
           <span style="color:#333333;">ens33</span> 
           <span style="color:#333333;">上挂一个</span> 
           <span style="color:#333333;">vip 10.1.1.102</span> 
           <pre><code class="hljs">[root@dr03 ~]# ifconfig
ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu
1500
inet 10.1.1.101 netmask 255.255.255.0 broadcast
10.1.1.255
inet6 fe80::20c:29ff:fe38:97fb prefixlen 64
scopeid 0x20&lt;link&gt;
ether 00:0c:29:38:97:fb txqueuelen 1000
(Ethernet)
RX packets 153 bytes 16165 (15.7 KiB)
RX errors 0 dropped 0 overruns 0 frame 0
TX packets 144 bytes 15826 (15.4 KiB)
TX errors 0 dropped 0 overruns 0 carrier 0
collisions 0
lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt; mtu 65536
inet 127.0.0.1 netmask 255.0.0.0
inet6 ::1 prefixlen 128 scopeid 0x10&lt;host&gt;
loop txqueuelen 1000 (Local Loopback)
RX packets 64 bytes 5568 (5.4 KiB)
RX errors 0 dropped 0 overruns 0 frame 0
TX packets 64 bytes 5568 (5.4 KiB)
TX errors 0 dropped 0 overruns 0 carrier 0
collisions 0
[root@dr03 ~]# ifconfig ens33:0 10.1.1.102 broadcat
10.1.1.102 netmask 255.255.255.255 up
broadcat: 未知的主机
ifconfig: `--help' gives usage information.
[root@dr03 ~]# ifconfig ens33:0 10.1.1.102 broadcast
10.1.1.102 netmask 255.255.255.255 up
[root@dr03 ~]# ifconfig
ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu
1500
inet 10.1.1.101 netmask 255.255.255.0 broadcast
10.1.1.255
inet6 fe80::20c:29ff:fe38:97fb prefixlen 64
scopeid 0x20&lt;link&gt;
ether 00:0c:29:38:97:fb txqueuelen 1000
(Ethernet)
RX packets 399 bytes 38090 (37.1 KiB)
RX errors 0 dropped 0 overruns 0 frame 0
TX packets 300 bytes 32758 (31.9 KiB)
TX errors 0 dropped 0 overruns 0 carrier 0
collisions 0
ens33:0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu
1500
inet 10.1.1.102 netmask 255.255.255.255
broadcast 10.1.1.102
ether 00:0c:29:38:97:fb txqueuelen 1000
(Ethernet)
lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt; mtu 65536
inet 127.0.0.1 netmask 255.0.0.0
inet6 ::1 prefixlen 128 scopeid 0x10&lt;host&gt;
loop txqueuelen 1000 (Local Loopback)
RX packets 64 bytes 5568 (5.4 KiB)
RX errors 0 dropped 0 overruns 0 frame 0
TX packets 64 bytes 5568 (5.4 KiB)
TX errors 0 dropped 0 overruns 0 carrier 0
collisions 0
[root@dr03 ~]# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue
state UNKNOWN group default qlen 1000
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
inet 127.0.0.1/8 scope host lo
valid_lft forever preferred_lft forever
inet6 ::1/128 scope host
valid_lft forever preferred_lft forever
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc
pfifo_fast state UP group default qlen 1000
link/ether 00:0c:29:38:97:fb brd ff:ff:ff:ff:ff:ff
inet 10.1.1.101/24 brd 10.1.1.255 scope global ens33
valid_lft forever preferred_lft forever
inet 10.1.1.102/32 brd 10.1.1.102 scope global ens33:0
valid_lft forever preferred_lft forever
inet6 fe80::20c:29ff:fe38:97fb/64 scope link
valid_lft forever preferred_lft forever
[root@dr03 ~]# route add -host 10.1.1.102 dev ens33:0
# 10.1.1.101 dip
# 10.1.1.102 vip 在rs上的vip和这个vip相同</code></pre> 
           <div> 
            <span style="color:#333333;">2.</span> 
            <span style="color:#333333;">设置规范</span> 
           </div> 
          </div> 
         </div> 
        </div> 
       </div> 
       <div> 
        <pre><code class="hljs"># 安装ipvsadm
yum -y install ipvsadm
$ 设置规则
ipvsadm -A -t 10.1.1.102:80 -s rr
ipvsadm -a -t 10.1.1.102:80 -r 10.1.1.200 -g
ipvsadm -a -t 10.1.1.102:80 -r 10.1.1.201 -g
# rs不在需要指定端口，dr不支持端口映射，vip上是80端口，最终就是80端
口
# -m nat -g gateway</code></pre> 
        <div> 
         <span style="color:#333333;"><strong>设置</strong></span> 
         <span style="color:#333333;"><strong>rs</strong></span> 
         <span style="color:#333333;"><strong>主机 </strong></span> 
        </div> 
        <div> 
         <span style="color:#333333;">1.</span> 
         <span style="color:#333333;">在</span> 
         <span style="color:#333333;">lo</span> 
         <span style="color:#333333;">接口上绑定</span> 
         <span style="color:#333333;">vip </span> 
         <pre><code class="hljs">[root@web01 ~]# ifconfig lo:0 10.1.1.102 broadcast
10.1.1.102 netmask 255.255.255.255 up</code></pre> 
         <div> 
          <span style="color:#333333;">2.</span> 
          <span style="color:#333333;">设置主机路由 </span> 
          <pre><code class="hljs">[root@web01 ~]# route add -host 10.1.1.102 dev lo:0</code></pre> 
          <div> 
           <span style="color:#333333;">3.</span> 
           <span style="color:#333333;">抑制</span> 
           <span style="color:#333333;">rs</span> 
           <span style="color:#333333;">接收请求</span> 
           <pre><code class="hljs">echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore
echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce
echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore
echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</code></pre> 
           <div> 
            <span style="color:#333333;">4.</span> 
            <span style="color:#333333;">生成脚本，对</span> 
            <span style="color:#333333;">web02</span> 
            <span style="color:#333333;">使用 </span> 
            <pre><code class="hljs">ifconfig lo:0 10.1.1.102 broadcast 10.1.1.102 netmask
255.255.255.255 up
route add -host 10.1.1.102 dev lo:0
echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore
echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce
echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore
echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</code></pre> 
            <div> 
             <span style="color:#333333;">5.</span> 
             <span style="color:#333333;">测试使用，查看状态 </span> 
            </div> 
           </div> 
          </div> 
         </div> 
        </div> 
       </div> 
      </div> 
      <div> 
       <pre><code class="hljs">[root@dr03 ~]# ipvsadm -Ln --stats
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Conns InPkts
OutPkts InBytes OutBytes
-&gt; RemoteAddress:Port
TCP 10.1.1.102:80 1 6
0 360 0
-&gt; 10.1.1.200:80 0 0
0 0 0
-&gt; 10.1.1.201:80 1 6
0 360 0
[root@dr03 ~]#</code></pre> 
       <div> 
        <span style="color:#333333;"><strong>dr</strong></span> 
        <span style="color:#333333;"><strong>模式的脚本 </strong></span> 
       </div> 
       <div> 
        <span style="color:#333333;">ds</span> 
        <span style="color:#333333;">脚本</span> 
       </div> 
      </div> 
      <div></div> 
      <div> 
       <pre><code class="hljs">#!/bin/bash
#在ens33上挂载一个ip地址
read -p "vip:" vip
read -p "mac:" mac
read -p "num" num
ifconfig $mac:$num $vip broadcast $vip netmask
255.255.255.255
# 主机路由
route add -host $vip dev $mac:$num
#安装ipvsadm
yum list installed|grep ipvsadm
if [ $? -ne 0 ] ; then
yum -y install ipvsadm
fi
#配置规则（不需要设置ip_forword）
ipvsadm -C
read -p "rule:" rule
read -p "port:" port
ipvsadm -A -t $vip:$port -s $rule
read -p "rip1:" rip1
ipvsadm -a -t $vip:$port -r $rip1 -g
read -p "rip2:" rip2
ipvsadm -a -t $vip:$port -r $rip2 -g</code></pre> 
       <div> 
        <span style="color:#333333;">rs</span> 
        <span style="color:#333333;">脚本</span> 
        <pre><code class="hljs">#!/bin/bash
#在ens33上挂载一个ip地址
read -p "vip:" vip
read -p "mac:" mac
read -p "num" num
ifconfig $mac:$num $vip broadcast $vip netmask
255.255.255.255
# 主机路由
route add -host $vip dev $mac:$num
echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore
echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce
echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore
echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce</code></pre> 
        <p></p> 
       </div> 
      </div> 
      <div></div> 
      <div></div> 
      <div></div> 
      <div></div> 
      <div></div> 
      <div></div> 
     </div> 
    </div> 
   </div> 
  </div> 
 </div> 
</div>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3a4467c2874ff63c75e52e29d202eb73/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">EMQX Platform &amp; Snowflake：构建可再生分布式能源的智慧未来</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2ab798cc6aabe4dab48aac217e95dd7a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">html&#43;css&#43;js网页制作 自定义电商10个页面</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>