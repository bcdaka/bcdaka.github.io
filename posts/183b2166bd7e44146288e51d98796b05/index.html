<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AI大模型探索之路-实战篇16：优化决策流程：Agent智能数据分析平台中Planning功能实践 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/183b2166bd7e44146288e51d98796b05/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="AI大模型探索之路-实战篇16：优化决策流程：Agent智能数据分析平台中Planning功能实践">
  <meta property="og:description" content="系列篇章💥 AI大模型探索之路-实战篇4：深入DB-GPT数据应用开发框架调研
AI大模型探索之路-实战篇5：探索Open Interpreter开放代码解释器调研
AI大模型探索之路-实战篇6：掌握Function Calling的详细流程
AI大模型探索之路-实战篇7：Function Calling技术实战自动生成函数
AI大模型探索之路-实战篇8：多轮对话与Function Calling技术应用
AI大模型探索之路-实战篇9：探究Agent智能数据分析平台的架构与功能
AI大模型探索之路-实战篇10：数据预处理的艺术：构建Agent智能数据分析平台的基础
AI大模型探索之路-实战篇11： Function Calling技术整合：强化Agent智能数据分析平台功能
AI大模型探索之路-实战篇12： 构建互动式Agent智能数据分析平台：实现多轮对话控制
AI大模型探索之路-实战篇13： 从对话到报告：打造能记录和分析的Agent智能数据分析平台
AI大模型探索之路-实战篇14： 集成本地Python代码解释器：强化Agent智能数据分析平台
AI大模型探索之路-实战篇15： Agent智能数据分析平台之整合封装Tools和Memory功能代码
目录 系列篇章💥一、前言二、人类意图挖掘三、增加Few-SHOT和COT思维链能力1、增加few-shot提示词2、添加思维链模版 四、大模型首次交互逻辑封装1、基本问答效果测试2、function call功能测试3、专家模式测试4、开发者模式测试5、专家模式下下用户意图探究能力测试6、开发者模式下下用户意图探究能力测试 五、function call执行结果消息封装六、完成用户一次的完整交互1、一次完整交互函数2、外层调用函数3、响应结果检查函数4、文本内容检查函数5、普通调用测试6、对比开发者模式7、带有Function Calling调用8、复杂问题拆解9、测试对比有代码调用的Function Calling10、测试开发者模式(不涉及代码执行)11、测试专家模式12、Agent对话封装调用 七、结语 一、前言 在前面篇章中我们实现了Agent智能数据分析平台中的Tools和Memory两大块，本文中我们将实现Agent智能数据分析平台中最核心的模块Plan，发掘探索人类意图，优化整个决策流程。
二、人类意图挖掘 msg_error_test = MessageManager(system_content_list=[data_dictionary], question=&#34;分析iquery数据库中的这四张表，帮我梳理一个数据分析的基本思路&#34;) second_response = client.chat.completions.create( model=&#39;gpt-3.5-turbo&#39;, messages=msg_error_test.messages, tools=af.functions, tool_choice=&#34;auto&#34; ) second_response 输出：
ChatCompletion(id=&#39;chatcmpl-rtFBgtNzSwoMmJONpYdGjHIWTLmXE&#39;, choices=[Choice(finish_reason=&#39;tool_calls&#39;, index=0, logprobs=None, message=ChatCompletionMessage(content=&#39;&#39;, role=&#39;assistant&#39;, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id=&#39;call_nu8zFoKl61VDF6yaCnWFRhpY&#39;, function=Function(arguments=&#39;{&#34;g&#34;: &#34;test&#34;, &#34;sql_query&#34;: &#34;DESC user_demographics;&#34;}&#39;, name=&#39;sql_inter&#39;), type=&#39;function&#39;), ChatCompletionMessageToolCall(id=&#39;call_RaTHPfo93K3DWByG9n4gW7w1&#39;, function=Function(arguments=&#39;{&#34;g&#34;: &#34;test&#34;, &#34;sql_query&#34;: &#34;DESC user_services;&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-10T20:04:17+08:00">
    <meta property="article:modified_time" content="2024-06-10T20:04:17+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">AI大模型探索之路-实战篇16：优化决策流程：Agent智能数据分析平台中Planning功能实践</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>系列篇章💥</h2> 
<p><a href="https://xundaomalu.blog.csdn.net/article/details/139169884" rel="nofollow">AI大模型探索之路-实战篇4：深入DB-GPT数据应用开发框架调研</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139190028" rel="nofollow">AI大模型探索之路-实战篇5：探索Open Interpreter开放代码解释器调研</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139186663" rel="nofollow">AI大模型探索之路-实战篇6：掌握Function Calling的详细流程</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139193382" rel="nofollow">AI大模型探索之路-实战篇7：Function Calling技术实战自动生成函数</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139194151" rel="nofollow">AI大模型探索之路-实战篇8：多轮对话与Function Calling技术应用</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139205615" rel="nofollow">AI大模型探索之路-实战篇9：探究Agent智能数据分析平台的架构与功能</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139216544" rel="nofollow">AI大模型探索之路-实战篇10：数据预处理的艺术：构建Agent智能数据分析平台的基础</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139216752" rel="nofollow">AI大模型探索之路-实战篇11： Function Calling技术整合：强化Agent智能数据分析平台功能</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139372376" rel="nofollow">AI大模型探索之路-实战篇12： 构建互动式Agent智能数据分析平台：实现多轮对话控制</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139391333?spm=1001.2014.3001.5502" rel="nofollow">AI大模型探索之路-实战篇13： 从对话到报告：打造能记录和分析的Agent智能数据分析平台</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139399366" rel="nofollow">AI大模型探索之路-实战篇14： 集成本地Python代码解释器：强化Agent智能数据分析平台</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139428677" rel="nofollow">AI大模型探索之路-实战篇15： Agent智能数据分析平台之整合封装Tools和Memory功能代码</a></p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">系列篇章💥</a></li><li><a href="#_23" rel="nofollow">一、前言</a></li><li><a href="#_25" rel="nofollow">二、人类意图挖掘</a></li><li><a href="#FewSHOTCOT_106" rel="nofollow">三、增加Few-SHOT和COT思维链能力</a></li><li><ul><li><a href="#1fewshot_107" rel="nofollow">1、增加few-shot提示词</a></li><li><a href="#2_211" rel="nofollow">2、添加思维链模版</a></li></ul> 
  </li><li><a href="#_306" rel="nofollow">四、大模型首次交互逻辑封装</a></li><li><ul><li><a href="#1_436" rel="nofollow">1、基本问答效果测试</a></li><li><a href="#2function_call_451" rel="nofollow">2、function call功能测试</a></li><li><a href="#3_469" rel="nofollow">3、专家模式测试</a></li><li><a href="#4_485" rel="nofollow">4、开发者模式测试</a></li><li><a href="#5_500" rel="nofollow">5、专家模式下下用户意图探究能力测试</a></li><li><a href="#6_513" rel="nofollow">6、开发者模式下下用户意图探究能力测试</a></li></ul> 
  </li><li><a href="#function_call_528" rel="nofollow">五、function call执行结果消息封装</a></li><li><a href="#_595" rel="nofollow">六、完成用户一次的完整交互</a></li><li><ul><li><a href="#1_596" rel="nofollow">1、一次完整交互函数</a></li><li><a href="#2_700" rel="nofollow">2、外层调用函数</a></li><li><a href="#3_823" rel="nofollow">3、响应结果检查函数</a></li><li><a href="#4_925" rel="nofollow">4、文本内容检查函数</a></li><li><a href="#5_1053" rel="nofollow">5、普通调用测试</a></li><li><a href="#6_1066" rel="nofollow">6、对比开发者模式</a></li><li><a href="#7Function_Calling_1079" rel="nofollow">7、带有Function Calling调用</a></li><li><a href="#8_1092" rel="nofollow">8、复杂问题拆解</a></li><li><a href="#9Function_Calling_1104" rel="nofollow">9、测试对比有代码调用的Function Calling</a></li><li><a href="#10_1116" rel="nofollow">10、测试开发者模式(不涉及代码执行)</a></li><li><a href="#11_1129" rel="nofollow">11、测试专家模式</a></li><li><a href="#12Agent_1141" rel="nofollow">12、Agent对话封装调用</a></li></ul> 
  </li><li><a href="#_1275" rel="nofollow">七、结语</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_23"></a>一、前言</h2> 
<p>在前面篇章中我们实现了Agent智能数据分析平台中的Tools和Memory两大块，本文中我们将实现Agent智能数据分析平台中最核心的模块Plan，发掘探索人类意图，优化整个决策流程。</p> 
<h2><a id="_25"></a>二、人类意图挖掘</h2> 
<pre><code class="prism language-python">msg_error_test <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"分析iquery数据库中的这四张表，帮我梳理一个数据分析的基本思路"</span><span class="token punctuation">)</span>

second_response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                        model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span>
                        messages<span class="token operator">=</span>msg_error_test<span class="token punctuation">.</span>messages<span class="token punctuation">,</span> 
                        tools<span class="token operator">=</span>af<span class="token punctuation">.</span>functions<span class="token punctuation">,</span> 
                        tool_choice<span class="token operator">=</span><span class="token string">"auto"</span>
                        <span class="token punctuation">)</span> 
second_response
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python">ChatCompletion<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'chatcmpl-rtFBgtNzSwoMmJONpYdGjHIWTLmXE'</span><span class="token punctuation">,</span> choices<span class="token operator">=</span><span class="token punctuation">[</span>Choice<span class="token punctuation">(</span>finish_reason<span class="token operator">=</span><span class="token string">'tool_calls'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> logprobs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> message<span class="token operator">=</span>ChatCompletionMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">'assistant'</span><span class="token punctuation">,</span> function_call<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> tool_calls<span class="token operator">=</span><span class="token punctuation">[</span>ChatCompletionMessageToolCall<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'call_nu8zFoKl61VDF6yaCnWFRhpY'</span><span class="token punctuation">,</span> function<span class="token operator">=</span>Function<span class="token punctuation">(</span>arguments<span class="token operator">=</span><span class="token string">'{"g": "test", "sql_query": "DESC user_demographics;"}'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sql_inter'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ChatCompletionMessageToolCall<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'call_RaTHPfo93K3DWByG9n4gW7w1'</span><span class="token punctuation">,</span> function<span class="token operator">=</span>Function<span class="token punctuation">(</span>arguments<span class="token operator">=</span><span class="token string">'{"g": "test", "sql_query": "DESC user_services;"}'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sql_inter'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ChatCompletionMessageToolCall<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'call_8lpOxl8fp7HZzurhQMbrBT4u'</span><span class="token punctuation">,</span> function<span class="token operator">=</span>Function<span class="token punctuation">(</span>arguments<span class="token operator">=</span><span class="token string">'{"g": "test", "sql_query": "DESC user_payments;"}'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sql_inter'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ChatCompletionMessageToolCall<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">'call_L1KekwoNcrc2oELyiAWPjnbR'</span><span class="token punctuation">,</span> function<span class="token operator">=</span>Function<span class="token punctuation">(</span>arguments<span class="token operator">=</span><span class="token string">'{"g": "test", "sql_query": "DESC user_churn;"}'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sql_inter'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> created<span class="token operator">=</span><span class="token number">1710948365</span><span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> <span class="token builtin">object</span><span class="token operator">=</span><span class="token string">'chat.completion'</span><span class="token punctuation">,</span> system_fingerprint<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> usage<span class="token operator">=</span>CompletionUsage<span class="token punctuation">(</span>completion_tokens<span class="token operator">=</span><span class="token number">105</span><span class="token punctuation">,</span> prompt_tokens<span class="token operator">=</span><span class="token number">1948</span><span class="token punctuation">,</span> total_tokens<span class="token operator">=</span><span class="token number">2053</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>异常分析捕获处理</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> openai <span class="token keyword">import</span>  APIConnectionError<span class="token punctuation">,</span>AuthenticationError
<span class="token comment">#%%</span>
messages <span class="token operator">=</span> msg_error_test<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                            model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span>
                            messages<span class="token operator">=</span>messages<span class="token punctuation">.</span>messages<span class="token punctuation">,</span> 
                            tools<span class="token operator">=</span>af<span class="token punctuation">.</span>functions<span class="token punctuation">,</span> 
                            tool_choice<span class="token operator">=</span>af<span class="token punctuation">.</span>function_call
                            <span class="token punctuation">)</span> 
<span class="token comment">#1. 问的问题比较泛</span>
<span class="token comment">#2. key不稳定</span>
<span class="token comment">#3. token不够</span>
<span class="token comment">#4. 低版本的大模型</span>
<span class="token comment">#5. 大家也可以收集自己平时开发遇到的报错（不同版本的openai报错还不一样）</span>
<span class="token keyword">except</span> AuthenticationError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token comment"># APIConnectionError默认是用户需求不清导致无法返回结果</span>
    msg_temp <span class="token operator">=</span> messages<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 获取用户问题</span>
    question <span class="token operator">=</span> msg_temp<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>
    <span class="token comment"># 提醒用户修改提问的提示模板</span>
    new_prompt <span class="token operator">=</span> "以下是用户提问：<span class="token operator">%</span>s。该问题有些复杂，且用户意图并不清晰。\
                请编写一段话，来引导用户重新提问。" <span class="token operator">%</span> question
    <span class="token comment"># 修改msg_temp并重新提问</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        msg_temp<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_prompt
        <span class="token comment"># 修改用户问题并直接提问</span>
        
        response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                        model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span>
                        messages<span class="token operator">=</span>msg_temp<span class="token punctuation">.</span>messages<span class="token punctuation">,</span> 
                        tools<span class="token operator">=</span>af<span class="token punctuation">.</span>functions<span class="token punctuation">,</span> 
                        tool_choice<span class="token operator">=</span>af<span class="token punctuation">.</span>function_call
                        <span class="token punctuation">)</span>
        
                    
        <span class="token comment"># 打印gpt返回的提示修改原问题的描述语句</span>
        display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span>response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>     
        user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"请重新输入问题，输入“退出”可以退出当前对话"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> user_input <span class="token operator">!=</span> <span class="token string">"退出"</span><span class="token punctuation">:</span>
            messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_input
            response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                            model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span>
                            messages<span class="token operator">=</span>messages<span class="token punctuation">.</span>messages<span class="token punctuation">,</span> 
                            tools<span class="token operator">=</span>af<span class="token punctuation">.</span>functions<span class="token punctuation">,</span> 
                            tool_choice<span class="token operator">=</span>af<span class="token punctuation">.</span>function_call
                            <span class="token punctuation">)</span> 

                        
    <span class="token comment"># 若在提示用户修改原问题时遇到链接错误，则直接暂停1分钟后继续执行While循环</span>
    <span class="token keyword">except</span> AuthenticationError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"当前遇到了一个链接问题: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"由于Limit Rate限制，即将等待1分钟后继续运行..."</span><span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>  <span class="token comment"># 等待1分钟</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"已等待60秒，即将开始重新调用模型并进行回答..."</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="FewSHOTCOT_106"></a>三、增加Few-SHOT和COT思维链能力</h2> 
<h3><a id="1fewshot_107"></a>1、增加few-shot提示词</h3> 
<p>给few-shot例子，遇到复杂问题，进行步骤拆解； 主要提示大模型复杂问题处理能力</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">add_task_decomposition_prompt</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">"""
    当开启增强模式时，任何问题首次尝试作答时都会调用本函数，创建一个包含任务拆解Few-shot的新的message。
    :param model: 必要参数，表示调用的大模型名称
    :param messages: 必要参数，ChatMessages类型对象，用于存储对话消息
    :param available_functions: 可选参数，AvailableFunctions类型对象，用于表示开启对话时外部函数基本情况。\
    默认值为None，表示不存在外部函数。
    :return: task_decomp_few_shot，一个包含任务拆解Few-shot提示示例的message
    """</span>
    
    <span class="token comment"># 任务拆解Few-shot</span>
    <span class="token comment"># 第一个提示示例</span>
    user_question1 <span class="token operator">=</span> <span class="token string">'请问什么是机器学习？'</span>
    user_message1_content <span class="token operator">=</span> "现有用户问题如下：“<span class="token operator">%</span>s”。为了回答这个问题，总共需要分几步来执行呢？\
    若无需拆分执行步骤，请直接回答原始问题。" <span class="token operator">%</span> user_question1
    assistant_message1_content <span class="token operator">=</span> '机器学习是一种人工智能（AI）的形式，它允许计算机自主学习和改进，而不需要被明确编程。\
    在机器学习过程中，计算机发现如何执行任务，主要是通过学习数据模式和使数据驱动决策。这可能涉及在大量数据中寻找和识别模式，然后根据这些信息进行预测，或者通过反复执行和调整来优化特定任务的性能。。\
    机器学习可以分为监督学习、无监督学习和强化学习等类型。。\
    机器学习在许多领域都有应用，包括自然语言处理、计算机视觉、推荐系统、医疗诊断、金融市场预测等等。'

    <span class="token comment"># 第二个提示示例</span>
    user_question2 <span class="token operator">=</span> <span class="token string">'请帮我介绍下OpenAI。'</span>
    user_message2_content <span class="token operator">=</span> "现有用户问题如下：“<span class="token operator">%</span>s”。为了回答这个问题，总共需要分几步来执行呢？\
    若无需拆分执行步骤，请直接回答原始问题。" <span class="token operator">%</span> user_question2
    assistant_message2_content <span class="token operator">=</span> 'OpenAI是一家开发和应用友好人工智能的公司，\
    它的目标是确保人工通用智能（AGI）对所有人都有益，以及随着AGI部署，尽可能多的人都能受益。\
    OpenAI致力在商业利益和人类福祉之间做出正确的平衡，本质上是一家人道主义公司。\
    OpenAI开发了诸如GPT<span class="token operator">-</span><span class="token number">3</span>这样的先进模型，在自然语言处理等诸多领域表现出色。'

    <span class="token comment"># 第三个提示示例</span>
    user_question3 <span class="token operator">=</span> <span class="token string">'围绕数据库中的user_payments表，我想要检查该表是否存在缺失值'</span>
    user_message3_content <span class="token operator">=</span> "现有用户问题如下：“<span class="token operator">%</span>s”。为了回答这个问题，总共需要分几步来执行呢？\
    若无需拆分执行步骤，请直接回答原始问题。" <span class="token operator">%</span> user_question3
    assistant_message3_content <span class="token operator">=</span> '为了检查user_payments数据集是否存在缺失值，我们将执行如下步骤：\
    \n\n步骤<span class="token number">1</span>：使用`extract_data`函数将user_payments数据表读取到当前的Python环境中。\
    \n\n步骤<span class="token number">2</span>：使用`python_inter`函数执行Python代码检查数据集的缺失值。'

    <span class="token comment"># 第四个提示示例</span>
    user_question4 <span class="token operator">=</span>  <span class="token string">'我想寻找合适的缺失值填补方法，来填补user_payments数据集中的缺失值。'</span>
    user_message4_content <span class="token operator">=</span> "现有用户问题如下：“<span class="token operator">%</span>s”。为了回答这个问题，总共需要分几步来执行呢？\
    若无需拆分执行步骤，请直接回答原始问题。" <span class="token operator">%</span> user_question4
    assistant_message4_content <span class="token operator">=</span> '为了找到合适的缺失值填充方法，我们需要执行以下三步：\
    \n\n步骤<span class="token number">1</span>：分析user_payments数据集中的缺失值情况。通过查看各字段的缺失率和观察缺失值分布，了解其缺失幅度和模式。\
    \n\n步骤<span class="token number">2</span>：确定值填补策略。基于观察结果和特定字段的性质确定恰当的填补策略，例如使用众数、中位数、均值或建立模型进行填补等。\
    \n\n步骤<span class="token number">3</span>：进行缺失值填补。根据确定的填补策略，执行填补操作，然后验证填补效果。'
    
    <span class="token comment"># 在保留原始问题的情况下加入Few-shot</span>
    task_decomp_few_shot <span class="token operator">=</span> messages<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    task_decomp_few_shot<span class="token punctuation">.</span>messages_pop<span class="token punctuation">(</span>manual<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    task_decomp_few_shot<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> user_message1_content<span class="token punctuation">}</span><span class="token punctuation">)</span>
    task_decomp_few_shot<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> assistant_message1_content<span class="token punctuation">}</span><span class="token punctuation">)</span>
    task_decomp_few_shot<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> user_message2_content<span class="token punctuation">}</span><span class="token punctuation">)</span>
    task_decomp_few_shot<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> assistant_message2_content<span class="token punctuation">}</span><span class="token punctuation">)</span>
    task_decomp_few_shot<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> user_message3_content<span class="token punctuation">}</span><span class="token punctuation">)</span>
    task_decomp_few_shot<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> assistant_message3_content<span class="token punctuation">}</span><span class="token punctuation">)</span>
    task_decomp_few_shot<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> user_message4_content<span class="token punctuation">}</span><span class="token punctuation">)</span>
    task_decomp_few_shot<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> assistant_message4_content<span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    user_question <span class="token operator">=</span> messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>

    new_question <span class="token operator">=</span> "现有用户问题如下：“<span class="token operator">%</span>s”。为了回答这个问题，总共需要分几步来执行呢？\
    若无需拆分执行步骤，请直接回答原始问题。" <span class="token operator">%</span> user_question
    question_message <span class="token operator">=</span> messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    question_message<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_question
    task_decomp_few_shot<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>question_message<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> task_decomp_few_shot
</code></pre> 
<pre><code class="prism language-python">msg1 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我查看user_demographics数据表中总共有多少条数据？"</span><span class="token punctuation">)</span>
msg2<span class="token operator">=</span> msg1<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
msg1_get_decomposition <span class="token operator">=</span> add_task_decomposition_prompt<span class="token punctuation">(</span>messages<span class="token operator">=</span>msg1<span class="token punctuation">)</span>
msg1_get_decomposition<span class="token punctuation">.</span>history_messages
</code></pre> 
<p>输出</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
  <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'现有用户问题如下：“请什么是机器学习？”。为了回答这个问题，总共需要分几步来执行呢？    若无需拆分执行步骤，请直接回答原始问题。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'assistant'</span><span class="token punctuation">,</span>
  <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'机器学习是一种人工智能（AI）的形式，它允许计算机自主学习和改进，而不需要被明确编程。    在机器学习过程中，计算机发现如何执行任务，主要是通过学习数据模式和使数据驱动决策。这可能涉及在大量数据中寻找和识别模式，然后根据这些信息进行预测，或者通过反复执行和调整来优化特定任务的性能。。    机器学习可以分为监督学习、无监督学习和强化学习等类型。。    机器学习在许多领域都有应用，包括自然语言处理、计算机视觉、推荐系统、医疗诊断、金融市场预测等等。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
  <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'现有用户问题如下：“请帮我介绍下OpenAI。”。为了回答这个问题，总共需要分几步来执行呢？    若无需拆分执行步骤，请直接回答原始问题。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'assistant'</span><span class="token punctuation">,</span>
  <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'OpenAI是一家开发和应用友好人工智能的公司，    它的目标是确保人工通用智能（AGI）对所有人都有益，以及随着AGI部署，尽可能多的人都能受益。    OpenAI致力在商业利益和人类福祉之间做出正确的平衡，本质上是一家人道主义公司。    OpenAI开发了诸如GPT-3这样的先进模型，在自然语言处理等诸多领域表现出色。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
  <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'现有用户问题如下：“围绕数据库中的user_payments表，我想要检查该表是否存在缺失值”。为了回答这个问题，总共需要分几步来执行呢？    若无需拆分执行步骤，请直接回答原始问题。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'assistant'</span><span class="token punctuation">,</span>
  <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'为了检查user_payments数据集是否存在缺失值，我们将执行如下步骤：    \n\n步骤1：使用`extract_data`函数将user_payments数据表读取到当前的Python环境中。    \n\n步骤2：使用`python_inter`函数执行Python代码检查数据集的缺失值。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
  <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'现有用户问题如下：“我想寻找合适的缺失值填补方法，来填补user_payments数据集中的缺失值。”。为了回答这个问题，总共需要分几步来执行呢？    若无需拆分执行步骤，请直接回答原始问题。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'assistant'</span><span class="token punctuation">,</span>
  <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'为了找到合适的缺失值填充方法，我们需要执行以下三步：    \n\n步骤1：分析user_payments数据集中的缺失值情况。通过查看各字段的缺失率和观察缺失值分布，了解其缺失幅度和模式。    \n\n步骤2：确定值填补策略。基于观察结果和特定字段的性质确定恰当的填补策略，例如使用众数、中位数、均值或建立模型进行填补等。    \n\n步骤3：进行缺失值填补。根据确定的填补策略，执行填补操作，然后验证填补效果。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
  <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'现有用户问题如下：“请帮我查看user_demographics数据表中总共有多少条数据？”。为了回答这个问题，总共需要分几步来执行呢？    若无需拆分执行步骤，请直接回答原始问题。'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="2_211"></a>2、添加思维链模版</h3> 
<p>开发者模式下，让提示词增加思维链</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">modify_prompt</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'add'</span><span class="token punctuation">,</span> enable_md_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> enable_COT<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    当开启开发者模式时，会让用户选择是否添加COT提示模板或其他提示模板，并创建一个经过修改的新的message。
    :param messages: 必要参数，MessageManager类型对象，用于存储对话消息
    :param action: 'add' 或 'remove'，决定是添加还是移除提示
    :param enable_md_output: 是否启用 markdown 格式输出
    :param enable_COT: 是否启用 COT 提示
    :return: messages，一个经过提示词修改的message
    """</span>
    
    <span class="token comment"># 思考链提示词模板</span>
    cot_prompt <span class="token operator">=</span> <span class="token string">"请一步步思考并得出结论。"</span>
    
    <span class="token comment"># 输出markdown提示词模板</span>
    md_prompt <span class="token operator">=</span> <span class="token string">"任何回答都请以markdown格式进行输出。"</span>
    <span class="token comment"># 如果是添加提示词</span>
    <span class="token keyword">if</span> action <span class="token operator">==</span> <span class="token string">'add'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> enable_COT<span class="token punctuation">:</span>
            <span class="token comment">## openai.types.chat.chat_completion_message.ChatCompletionMessage</span>
            <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">is</span> openai<span class="token punctuation">.</span>types<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chat_completion_message<span class="token punctuation">.</span>ChatCompletionMessage<span class="token punctuation">:</span>    
                messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">+=</span> cot_prompt
                messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">+=</span> cot_prompt
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> cot_prompt
                messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> cot_prompt

        <span class="token keyword">if</span> enable_md_output<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">is</span> openai<span class="token punctuation">.</span>types<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chat_completion_message<span class="token punctuation">.</span>ChatCompletionMessage<span class="token punctuation">:</span>
                messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">+=</span> md_prompt
                messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">+=</span> md_prompt
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> md_prompt
                messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> md_prompt
       
    <span class="token comment"># 如果是将指定提示词删除</span>
    <span class="token keyword">elif</span> action <span class="token operator">==</span> <span class="token string">'remove'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> enable_md_output<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">is</span> openai<span class="token punctuation">.</span>types<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chat_completion_message<span class="token punctuation">.</span>ChatCompletionMessage<span class="token punctuation">:</span>
                messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">=</span> messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>md_prompt<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
                messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">=</span> messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>md_prompt<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>md_prompt<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
                messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>md_prompt<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> enable_COT<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">is</span> openai<span class="token punctuation">.</span>types<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chat_completion_message<span class="token punctuation">.</span>ChatCompletionMessage<span class="token punctuation">:</span>
                messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">=</span> messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>cot_prompt<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
                messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content <span class="token operator">=</span> messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content<span class="token punctuation">.</span>replace<span class="token punctuation">(</span>cot_prompt<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>cot_prompt<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
                messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span>cot_prompt<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> messages
</code></pre> 
<p>测试</p> 
<pre><code class="prism language-python">msg2<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/36/58/GYKNck9b_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">msg2_COT <span class="token operator">=</span> modify_prompt<span class="token punctuation">(</span>messages<span class="token operator">=</span>msg2<span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'add'</span><span class="token punctuation">,</span> enable_md_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> enable_COT<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
msg2_COT<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/a1/32/k0BsJXNL_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">msg2_COT<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/27/40/DUpCOc71_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">msg2_COT<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/81/b6/UqDalhGQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">msg2 <span class="token operator">=</span> modify_prompt<span class="token punctuation">(</span>messages<span class="token operator">=</span>msg2_COT<span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'remove'</span><span class="token punctuation">,</span> enable_md_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> enable_COT<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
msg2<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/6c/a4/rzr6YrIm_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">msg2 <span class="token operator">=</span> modify_prompt<span class="token punctuation">(</span>messages<span class="token operator">=</span>msg2_COT<span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'add'</span><span class="token punctuation">,</span> enable_md_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> enable_COT<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
msg2_COT<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/76/77/Cdc1sLz3_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_306"></a>四、大模型首次交互逻辑封装</h2> 
<p>第一次跟GPT模型进行交互，然后看他返回来的结果<br> 解析结果有两种可能：</p> 
<ol><li>返回来调用的外部函数</li><li>返回来调用的直接的结果</li></ol> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_first_response</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> 
                     messages<span class="token punctuation">,</span> 
                     available_functions<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                     is_developer_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                     is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">"""
    负责调用Chat模型并获得模型回答函数，并且当在调用GPT模型时遇到Rate limit时可以选择暂时休眠1分钟后再运行。\
    同时对于意图不清的问题，会提示用户修改输入的prompt，以获得更好的模型运行结果。
    :param model: 必要参数，表示调用的大模型名称
    :param messages: 必要参数，MessageManager类型对象，用于存储对话消息
    :param available_functions: 可选参数，AvailableFunctions类型对象，用于表示开启对话时外部函数基本情况。\
    默认为None，表示没有外部函数
    :param is_developer_mode: 表示是否开启开发者模式，默认为False。\
    开启开发者模式时，会自动添加提示词模板，并且会在每次执行代码前、以及返回结果之后询问用户意见，并会根据用户意见进行修改。
    :param is_expert_mode: 可选参数，表示是否开启专家模式，默认为False。\
    开启增强模式时，会自动启动复杂任务拆解流程，并且在进行代码debug时会自动执行deep debug。
    :return: 返回模型返回的response message
    """</span>
    
    <span class="token comment"># 如果开启开发者模式，则进行提示词修改，首次运行是增加提示词</span>
    <span class="token keyword">if</span> is_developer_mode<span class="token punctuation">:</span>
        messages <span class="token operator">=</span> modify_prompt<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'add'</span><span class="token punctuation">)</span>
        
    <span class="token comment"># 如果是专家模式，则增加复杂任务拆解流程</span>
    <span class="token keyword">if</span> is_expert_mode<span class="token punctuation">:</span>
        messages <span class="token operator">=</span> add_task_decomposition_prompt<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>

    <span class="token comment"># 考虑到可能存在通信报错问题，因此循环调用Chat模型进行执行</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 若不存在外部函数</span>
            <span class="token keyword">if</span> available_functions <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                    model<span class="token operator">=</span>model<span class="token punctuation">,</span>
                    messages<span class="token operator">=</span>messages<span class="token punctuation">.</span>messages<span class="token punctuation">)</span>   
                
            <span class="token comment"># 若存在外部函数，此时functions和function_call参数信息都从AvailableFunctions对象中获取</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment">#print("这儿我也测试一下,调用cleint之前的messages长什么样----")</span>
                <span class="token comment">#print(messages.messages)</span>
                response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                    model<span class="token operator">=</span>model<span class="token punctuation">,</span>
                    messages<span class="token operator">=</span>messages<span class="token punctuation">.</span>messages<span class="token punctuation">,</span> 
                    tools<span class="token operator">=</span>available_functions<span class="token punctuation">.</span>functions<span class="token punctuation">,</span> 
                    tool_choice<span class="token operator">=</span>available_functions<span class="token punctuation">.</span>function_call
                    <span class="token punctuation">)</span>   
            <span class="token keyword">break</span>  <span class="token comment"># 如果成功获取响应，退出循环</span>
            
        <span class="token keyword">except</span> AuthenticationError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># APIConnectionError默认是用户需求不清导致无法返回结果</span>
            <span class="token comment"># 若开启专家模式，此时提示用户重新输入需求</span>
            <span class="token keyword">if</span> is_expert_mode<span class="token punctuation">:</span>
                <span class="token comment"># 创建临时消息列表</span>
                msg_temp <span class="token operator">=</span> messages<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment"># 获取用户问题</span>
                question <span class="token operator">=</span> msg_temp<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>
                <span class="token comment"># 提醒用户修改提问的提示模板</span>
                new_prompt <span class="token operator">=</span> "以下是用户提问：<span class="token operator">%</span>s。该问题有些复杂，且用户意图并不清晰。\
                请编写一段话，来引导用户重新提问。" <span class="token operator">%</span> question
                <span class="token comment"># 修改msg_temp并重新提问</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    msg_temp<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_prompt
                    <span class="token comment"># 修改用户问题并直接提问</span>
                    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                        model<span class="token operator">=</span>model<span class="token punctuation">,</span>
                        messages<span class="token operator">=</span>msg_temp<span class="token punctuation">.</span>messages<span class="token punctuation">)</span>
                    
                    <span class="token comment"># 打印gpt返回的提示修改原问题的描述语句</span>
                    display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span>response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment"># 引导用户重新输入问题或者退出</span>
                    user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"请重新输入问题，输入“退出”可以退出当前对话"</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> user_input <span class="token operator">==</span> <span class="token string">"退出"</span><span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"当前模型无法返回结果，已经退出"</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> <span class="token boolean">None</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token comment"># 修改原始问题</span>
                        messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> user_input
                        
                        <span class="token comment"># 再次进行提问</span>
                        response_message <span class="token operator">=</span> get_first_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                                            messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                                            available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                                            is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                                            is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">)</span>
                        
                        <span class="token keyword">return</span> response_message
                <span class="token comment"># 若在提示用户修改原问题时遇到链接错误，则直接暂停1分钟后继续执行While循环</span>
                <span class="token keyword">except</span> AuthenticationError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"当前遇到了一个链接问题: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"由于Limit Rate限制，即将等待1分钟后继续运行..."</span><span class="token punctuation">)</span>
                    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>  <span class="token comment"># 等待1分钟</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"已等待60秒，即将开始重新调用模型并进行回答..."</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 若未开启增强模式       </span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>        
                <span class="token comment"># 打印错误的核心信息</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"当前遇到了一个链接问题: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                <span class="token comment"># 如果是开发者模式</span>
                <span class="token keyword">if</span> is_developer_mode<span class="token punctuation">:</span>
                    <span class="token comment"># 选择等待、更改模型或者直接报错退出</span>
                    user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"请选择等待1分钟（1），或者更换模型（2），或者报错退出（3）"</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> user_input <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"好的，将等待1分钟后继续运行..."</span><span class="token punctuation">)</span>
                        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>  <span class="token comment"># 等待1分钟</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"已等待60秒，即将开始新的一轮问答..."</span><span class="token punctuation">)</span>
                    <span class="token keyword">elif</span> user_input <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
                        model <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"好的，请输出新模型名称"</span><span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        <span class="token keyword">raise</span> e  <span class="token comment"># 如果用户选择退出，恢复提示并抛出异常</span>
                <span class="token comment"># 如果不是开发者模式</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"由于Limit Rate限制，即将等待1分钟后继续运行..."</span><span class="token punctuation">)</span>
                    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span>  <span class="token comment"># 等待1分钟</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"已等待60秒，即将开始重新调用模型并进行回答..."</span><span class="token punctuation">)</span>

    <span class="token comment"># 还原原始的message对象</span>
    <span class="token keyword">if</span> is_developer_mode<span class="token punctuation">:</span>
        messages <span class="token operator">=</span> modify_prompt<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'remove'</span><span class="token punctuation">)</span>
        
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message
</code></pre> 
<h3><a id="1_436"></a>1、基本问答效果测试</h3> 
<pre><code class="prism language-python">msg1 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我简单介绍下iquery数据库中的这四张表"</span><span class="token punctuation">)</span>
msg1_response <span class="token operator">=</span> get_first_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                 messages<span class="token operator">=</span>msg1<span class="token punctuation">,</span> 
                                 available_functions<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                                 is_developer_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                                 is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
msg1_response
</code></pre> 
<p>输出<br> <img src="https://images2.imgbox.com/28/33/jxsA4DOP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2function_call_451"></a>2、function call功能测试</h3> 
<pre><code class="prism language-python">msg2 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我查看user_demographics数据表中总共有多少条数据。"</span><span class="token punctuation">)</span>
af<span class="token punctuation">.</span>functions
</code></pre> 
<p><img src="https://images2.imgbox.com/d0/79/gwtrSoFp_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">msg2_response <span class="token operator">=</span> get_first_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                 messages<span class="token operator">=</span>msg2<span class="token punctuation">,</span> 
                                 available_functions<span class="token operator">=</span>af<span class="token punctuation">,</span>
                                 is_developer_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                                 is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
msg2_response
</code></pre> 
<p><img src="https://images2.imgbox.com/a6/2d/Dm7J8XAe_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_469"></a>3、专家模式测试</h3> 
<pre><code class="prism language-python">msg3 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我查看user_demographics数据表中缺失值情况。"</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
msg3_response <span class="token operator">=</span> get_first_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                 messages<span class="token operator">=</span>msg3<span class="token punctuation">,</span> 
                                 available_functions<span class="token operator">=</span>af<span class="token punctuation">,</span>
                                 is_developer_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                                 is_expert_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
msg3_response
</code></pre> 
<p><img src="https://images2.imgbox.com/24/f9/ShxqtGyt_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_485"></a>4、开发者模式测试</h3> 
<pre><code class="prism language-python">msg4 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我查看iquery数据库中user_demographics数据表中缺失值情况。"</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
msg4_response <span class="token operator">=</span> get_first_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                 messages<span class="token operator">=</span>msg4<span class="token punctuation">,</span> 
                                 available_functions<span class="token operator">=</span>af<span class="token punctuation">,</span>
                                 is_developer_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                 is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
msg4_response
</code></pre> 
<p><img src="https://images2.imgbox.com/c1/1f/2mf16kBo_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_500"></a>5、专家模式下下用户意图探究能力测试</h3> 
<pre><code class="prism language-python">msg5 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"分析iquery数据库中的这四张表，帮我梳理一个数据分析的基本思路"</span><span class="token punctuation">)</span>
msg5_response <span class="token operator">=</span> get_first_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                 messages<span class="token operator">=</span>msg5<span class="token punctuation">,</span> 
                                 available_functions<span class="token operator">=</span>af<span class="token punctuation">,</span>
                                 is_developer_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                                 is_expert_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
msg5_response
</code></pre> 
<p><img src="https://images2.imgbox.com/f8/e3/YCmw5Smv_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6_513"></a>6、开发者模式下下用户意图探究能力测试</h3> 
<p>开发者模型最大的特点就是可以让用户选择，可以选择等1分钟，也可以选择退出</p> 
<pre><code class="prism language-python">msg6 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"分析iquery数据库中的这四张表，帮我梳理一个数据分析的基本思路"</span><span class="token punctuation">)</span>
msg6_response <span class="token operator">=</span> get_first_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                 messages<span class="token operator">=</span>msg6<span class="token punctuation">,</span> 
                                 available_functions<span class="token operator">=</span>af<span class="token punctuation">,</span>
                                 is_developer_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                 is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
msg6_response
</code></pre> 
<p><img src="https://images2.imgbox.com/4e/9a/AnCD60aq_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="function_call_528"></a>五、function call执行结果消息封装</h2> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">function_to_call</span><span class="token punctuation">(</span>available_functions<span class="token punctuation">,</span> function_call_message<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    根据一条函数调用消息function_call_message，返回一条函数运行结果消息function_response_messages。
    :param available_functions: 必要参数，要求输入一个AvailableFunctions对象，以说明当前外部函数基本情况
    :param function_call_message: 必要参数，要求输入一条外部函数调用的message
    :return: function_response_messages，输出又外部函数运行结果所组成的message
    """</span>
    
    <span class="token comment"># 获取调用外部函数的函数名称</span>
    tool_call <span class="token operator">=</span> function_call_message<span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    function_name <span class="token operator">=</span> tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>name
    
    <span class="token comment"># 根据函数名称获取对应的外部函数对象</span>
    fuction_to_call <span class="token operator">=</span> available_functions<span class="token punctuation">.</span>functions_dic<span class="token punctuation">[</span>function_name<span class="token punctuation">]</span>
    
    <span class="token comment"># 提取function_call_message中调用外部函数的函数参数</span>
    <span class="token comment"># 即大模型编写的SQL或者Python代码</span>
    function_args <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span>
    
    <span class="token comment"># 将参数带入到外部函数中并运行</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 将当前操作空间中的全局变量添加到外部函数中</span>
        function_args<span class="token punctuation">[</span><span class="token string">'g'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 运行外部函数</span>
        function_response <span class="token operator">=</span> fuction_to_call<span class="token punctuation">(</span><span class="token operator">**</span>function_args<span class="token punctuation">)</span>
      
    <span class="token comment"># 若外部函数运行报错，则提取报错信息</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        function_response <span class="token operator">=</span> <span class="token string">"函数运行报错如下:"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        
    <span class="token comment"># 创建function_response_messages</span>
    <span class="token comment"># 该message包含外部函数顺利运行或报错信息</span>
    
    function_response_messages <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"tool_call_id"</span><span class="token punctuation">:</span> tool_call<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
        <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"tool"</span><span class="token punctuation">,</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> function_name<span class="token punctuation">,</span>
        <span class="token string">"content"</span><span class="token punctuation">:</span> function_response<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> function_response_messages
</code></pre> 
<p>结果查看</p> 
<pre><code class="prism language-python">msg <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我查看user_demographics数据表中总共有多少条数据。"</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
msg_response <span class="token operator">=</span> get_first_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                 messages<span class="token operator">=</span>msg<span class="token punctuation">,</span> 
                                 available_functions<span class="token operator">=</span>af<span class="token punctuation">)</span>
msg_response
</code></pre> 
<p><img src="https://images2.imgbox.com/a1/d2/ST2Pt4oQ_o.png" alt="在这里插入图片描述"></p> 
<p>封装函数调用测试</p> 
<pre><code class="prism language-python">function_response_messages <span class="token operator">=</span> function_to_call<span class="token punctuation">(</span>available_functions<span class="token operator">=</span>af<span class="token punctuation">,</span> function_call_message<span class="token operator">=</span>msg_response<span class="token punctuation">)</span>
function_response_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/6e/0c/w0io8iJN_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_595"></a>六、完成用户一次的完整交互</h2> 
<h3><a id="1_596"></a>1、一次完整交互函数</h3> 
<p>负责完整执行一次对话的最高层函数，需要注意的是，一次对话中可能会多次调用大模型，而本函数则是完成一次对话的主函数。要求输入的messages中最后一条消息必须是能正常发起对话的消息。该函数通过调用get_gpt_response来获取模型输出结果，并且会根据返回结果的不同，例如是文本结果还是代码结果，灵活调用不同函数对模型输出结果进行后处理。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">one_chat_response</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> 
                      messages<span class="token punctuation">,</span> 
                      available_functions<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                      is_developer_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                      is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> 
                      delete_some_messages<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> 
                      is_task_decomposition<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">"""
    负责完整执行一次对话的最高层函数，需要注意的是，一次对话中可能会多次调用大模型，而本函数则是完成一次对话的主函数。\
    要求输入的messages中最后一条消息必须是能正常发起对话的消息。\
    该函数通过调用get_gpt_response来获取模型输出结果，并且会根据返回结果的不同，例如是文本结果还是代码结果，\
    灵活调用不同函数对模型输出结果进行后处理。\
    :param model: 必要参数，表示调用的大模型名称
    :param messages: 必要参数，ChatMessages类型对象，用于存储对话消息
    :param available_functions: 可选参数，AvailableFunctions类型对象，用于表示开启对话时外部函数基本情况。\
    默认为None，表示没有外部函数
    :param is_developer_mode: 表示是否开启开发者模式，默认为False。\
    开启开发者模式时，会自动添加提示词模板，并且会在每次执行代码前、以及返回结果之后询问用户意见，并会根据用户意见进行修改。
    :param is_expert_mode: 可选参数，表示是否开启专家模式，默认为False。\
    开启增强模式时，会自动启动复杂任务拆解流程，并且在进行代码debug时会自动执行deep debug。
    :param delete_some_messages: 可选参数，表示在拼接messages时是否删除中间若干条消息，默认为Fasle。
    :param is_task_decomposition: 可选参数，是否是当前执行任务是否是审查任务拆解结果，默认为False。
    :return: 拼接本次问答最终结果的messages
    """</span>
    
    <span class="token comment"># 当且仅当围绕复杂任务拆解结果进行修改时，才会出现is_task_decomposition=True的情况</span>
    <span class="token comment"># 当is_task_decomposition=True时，不再重新创建response_message</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> is_task_decomposition<span class="token punctuation">:</span>
        <span class="token comment"># 先获取单次大模型调用结果</span>
        <span class="token comment"># 此时response_message是大模型调用返回的message</span>
        response_message <span class="token operator">=</span> get_first_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                            messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                            available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                            is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                            is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">)</span>
    
    <span class="token comment"># 复杂条件判断，若is_task_decomposition = True，</span>
    <span class="token comment"># 或者是专家模式且是执行function response任务时</span>
    <span class="token comment"># （需要注意的是，当is_task_decomposition = True时，并不存在response_message对象）</span>
    <span class="token keyword">if</span> is_task_decomposition <span class="token keyword">or</span> <span class="token punctuation">(</span>is_expert_mode <span class="token keyword">and</span> response_message<span class="token punctuation">.</span>tool_calls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 将is_task_decomposition修改为True，表示当前执行任务为复杂任务拆解</span>
        <span class="token comment">#print("&gt;&gt;这儿")</span>
        is_task_decomposition <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token comment"># 在拆解任务时，将增加了任务拆解的few-shot-message命名为text_response_messages</span>
        task_decomp_few_shot <span class="token operator">=</span> add_task_decomposition_prompt<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
        <span class="token comment"># print("正在进行任务分解，请稍后...")</span>
        <span class="token comment"># 同时更新response_message，此时response_message就是任务拆解之后的response</span>
        response_message <span class="token operator">=</span> get_first_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                            messages<span class="token operator">=</span>task_decomp_few_shot<span class="token punctuation">,</span> 
                                            available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                            is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                            is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">)</span>
        <span class="token comment"># 若拆分任务的提示无效，此时response_message有可能会再次创建一个function call message</span>
        <span class="token keyword">if</span> response_message<span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"当前任务无需拆解，可以直接运行。"</span><span class="token punctuation">)</span>

    <span class="token comment"># 若本次调用是由修改对话需求产生，则按照参数设置删除原始message中的若干条消息</span>
    <span class="token comment"># 需要注意的是，删除中间若干条消息，必须在创建完新的response_message之后再执行</span>
    <span class="token keyword">if</span> delete_some_messages<span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>delete_some_messages<span class="token punctuation">)</span><span class="token punctuation">:</span>
            messages<span class="token punctuation">.</span>messages_pop<span class="token punctuation">(</span>manual<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 注意，执行到此处时，一定会有一个response_message</span>
    <span class="token comment"># 接下来分response_message不同类型，执行不同流程</span>
    <span class="token comment"># 若是文本响应类任务（包括普通文本响应和和复杂任务拆解审查两种情况，都可以使用相同代码）</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> response_message<span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span>
        <span class="token comment"># 将message保存为text_answer_message</span>
        text_answer_message <span class="token operator">=</span> response_message 
        <span class="token comment"># 并带入is_text_response_valid对文本内容进行审查</span>
        messages <span class="token operator">=</span> handle_text_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                          messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                          text_answer_message<span class="token operator">=</span>text_answer_message<span class="token punctuation">,</span>
                                          available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                          is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                          is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">,</span> 
                                          delete_some_messages<span class="token operator">=</span>delete_some_messages<span class="token punctuation">,</span>
                                          is_task_decomposition<span class="token operator">=</span>is_task_decomposition<span class="token punctuation">)</span>
    
    
    
    <span class="token comment"># 若是function response任务</span>
    <span class="token keyword">elif</span> response_message<span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span>
        <span class="token comment"># 创建调用外部函数的function_call_message</span>
        <span class="token comment"># 在当前Agent中，function_call_message是一个包含SQL代码或者Python代码的JSON对象</span>
        function_call_message <span class="token operator">=</span> response_message 
        <span class="token comment"># 将function_call_message带入代码审查和运行函数is_code_response_valid</span>
        <span class="token comment"># 并最终获得外部函数运行之后的问答结果</span>
        messages <span class="token operator">=</span> handle_code_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                          messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                          function_call_message<span class="token operator">=</span>function_call_message<span class="token punctuation">,</span>
                                          available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                          is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                          is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">,</span> 
                                          delete_some_messages<span class="token operator">=</span>delete_some_messages<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> messages    
</code></pre> 
<h3><a id="2_700"></a>2、外层调用函数</h3> 
<p>负责完整执行一次外部函数调用的最高层函数，要求输入的msg最后一条消息必须是包含function call的消息。<br> 函数的最终任务是将function call的消息中的代码带入外部函数并完成代码运行，并且支持交互式代码编写或自动代码编写运行不同模式。当函数运行得到一条包含外部函数运行结果的function message之后，会继续将其带入check_get_final_function_response函数，最终将function message转化为assistant message，并完成本次对话。</p> 
<pre><code class="prism language-python"><span class="token comment"># 判断代码输出结果是否符合要求，输入function call message，输出function response message</span>
<span class="token keyword">def</span> <span class="token function">handle_code_response</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> 
                           messages<span class="token punctuation">,</span> 
                           function_call_message<span class="token punctuation">,</span>
                           available_functions<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                           is_developer_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                           is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> 
                           delete_some_messages<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    
    <span class="token triple-quoted-string string">"""
    负责完整执行一次外部函数调用的最高层函数，要求输入的msg最后一条消息必须是包含function call的消息。\
    函数的最终任务是将function call的消息中的代码带入外部函数并完成代码运行，并且支持交互式代码编写或自动代码编写运行不同模式。\
    当函数运行得到一条包含外部函数运行结果的function message之后，会继续将其带入check_get_final_function_response函数，\
    用于最终将function message转化为assistant message，并完成本次对话。
    :param model: 必要参数，表示调用的大模型名称
    :param messages: 必要参数，ChatMessages类型对象，用于存储对话消息
    :param function_call_message: 必要参数，用于表示上层函数创建的一条包含function call消息的message
    :param available_functions: 可选参数，AvailableFunctions类型对象，用于表示开启对话时外部函数基本情况。\
    默认为None，表示没有外部函数
    :param is_developer_mode: 表示是否开启开发者模式，默认为False。\
    开启开发者模式时，会自动添加提示词模板，并且会在每次执行代码前、以及返回结果之后询问用户意见，并会根据用户意见进行修改。
    :param is_expert_mode: 可选参数，表示是否开启专家模式，默认为False。\
    开启增强模式时，会自动启动复杂任务拆解流程，并且在进行代码debug时会自动执行deep debug。
    :param delete_some_messages: 可选参数，表示在拼接messages时是否删除中间若干条消息，默认为Fasle。
    :return: message，拼接了最新大模型回答结果的message
    """</span>
    
    <span class="token comment"># 为打印代码和修改代码（增加创建图像对家部分代码）做准备</span>
    <span class="token comment"># 创建字符串类型json格式的message对象</span>
    code_json_str <span class="token operator">=</span> function_call_message<span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments
    <span class="token comment"># print("========这儿可能有问题======")</span>
    <span class="token comment"># print(function_call_message)</span>
    <span class="token comment"># print(function_call_message.tool_calls[0].function.arguments)</span>
    <span class="token comment"># 将json转化为字典</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        code_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>code_json_str<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"json字符解析错误，正在重新创建代码..."</span><span class="token punctuation">)</span>
        <span class="token comment"># 递归调用上层函数get_chat_response，并返回最终message结果</span>
        <span class="token comment"># 需要注意的是，如果上层函数再次创建了function_call_message</span>
        <span class="token comment"># 则会再次调用is_code_response_valid，而无需在当前函数中再次执行</span>
        messages <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                     messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                     available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                     is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                     is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">,</span> 
                                     delete_some_messages<span class="token operator">=</span>delete_some_messages<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> messages
        
    <span class="token comment"># 若顺利将json转化为字典，则继续执行以下代码</span>
    <span class="token comment"># 创建convert_to_markdown内部函数，用于辅助打印代码结果</span>
    <span class="token keyword">def</span> <span class="token function">convert_to_markdown</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> language<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"```</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>language<span class="token punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>code<span class="token punctuation">}</span></span><span class="token string">\n```"</span></span>

    <span class="token comment"># 提取代码部分参数</span>
    <span class="token comment"># 如果是SQL，则按照Markdown中SQL格式打印代码</span>
    <span class="token keyword">if</span> code_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'sql_query'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> code_dict<span class="token punctuation">[</span><span class="token string">'sql_query'</span><span class="token punctuation">]</span> 
        markdown_code <span class="token operator">=</span> convert_to_markdown<span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">'sql'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"即将执行以下代码："</span><span class="token punctuation">)</span>
        
    <span class="token comment"># 如果是Python，则按照Markdown中Python格式打印代码</span>
    <span class="token keyword">elif</span> code_dict<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'py_code'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        code <span class="token operator">=</span> code_dict<span class="token punctuation">[</span><span class="token string">'py_code'</span><span class="token punctuation">]</span>
        markdown_code <span class="token operator">=</span> convert_to_markdown<span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">'python'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"即将执行以下代码："</span><span class="token punctuation">)</span>
        
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        markdown_code <span class="token operator">=</span> code_dict
        
    display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span>markdown_code<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
      
    <span class="token comment"># 若是开发者模式，则提示用户先对代码进行审查然后再运行</span>
    <span class="token keyword">if</span> is_developer_mode<span class="token punctuation">:</span>         
        user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"是直接运行代码（1），还是反馈修改意见，并让模型对代码进行修改后再运行（2）"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> user_input <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"好的，正在运行代码，请稍后..."</span><span class="token punctuation">)</span>
                
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            modify_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"好的，请输入修改意见："</span><span class="token punctuation">)</span>
            <span class="token comment"># 记录模型当前创建的代码</span>
            messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>function_call_message<span class="token punctuation">)</span>
            <span class="token comment"># 记录修改意见</span>
            messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> modify_input<span class="token punctuation">}</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 调用get_chat_response函数并重新获取回答结果</span>
            <span class="token comment"># 需要注意，此时需要设置delete_some_messages=2，删除中间对话结果以节省token</span>
            messages <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                         messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                         available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                         is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                         is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">,</span> 
                                         delete_some_messages<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
            
            <span class="token keyword">return</span> messages
                
    <span class="token comment"># 若不是开发者模式，或者开发者模式下user_input == '1'</span>
    <span class="token comment"># 则调用function_to_call函数，并获取最终外部函数运行结果</span>
    <span class="token comment"># 在当前Agent中，外部函数运行结果就是SQL或者Python运行结果，或代码运行报错结果</span>
    function_response_message <span class="token operator">=</span> function_to_call<span class="token punctuation">(</span>available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span> 
                                                 function_call_message<span class="token operator">=</span>function_call_message<span class="token punctuation">)</span>  
    
    <span class="token comment"># 将function_response_message带入check_get_final_function_response进行审查</span>
    messages <span class="token operator">=</span> check_function_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                                 messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                                 function_call_message<span class="token operator">=</span>function_call_message<span class="token punctuation">,</span>
                                                 function_response_message<span class="token operator">=</span>function_response_message<span class="token punctuation">,</span>
                                                 available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                                 is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                                 is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">,</span> 
                                                 delete_some_messages<span class="token operator">=</span>delete_some_messages<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> messages
</code></pre> 
<h3><a id="3_823"></a>3、响应结果检查函数</h3> 
<p>负责执行外部函数运行结果审查工作。若外部函数运行结果消息function_response_message并不存在报错信息，则将其拼接入message中，并将其带入get_chat_response函数并获取下一轮对话结果。而如果function_response_message中存在报错信息，则开启自动debug模式。本函数将借助类似Autogen的模式，复制多个Agent，并通过彼此对话的方式来完成debug。</p> 
<pre><code class="prism language-python"><span class="token comment"># 判断代码输出结果是否符合要求，输入function response message，输出基于外部函数运行结果的message</span>
<span class="token keyword">def</span> <span class="token function">check_function_response</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> 
                            messages<span class="token punctuation">,</span> 
                            function_call_message<span class="token punctuation">,</span>
                            function_response_message<span class="token punctuation">,</span>
                            available_functions<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                            is_developer_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                            is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> 
                            delete_some_messages<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">"""
    负责执行外部函数运行结果审查工作。若外部函数运行结果消息function_response_message并不存在报错信息，\
    则将其拼接入message中，并将其带入get_chat_response函数并获取下一轮对话结果。而如果function_response_message中存在报错信息，\
    则开启自动debug模式。本函数将借助类似Autogen的模式，复制多个Agent，并通过彼此对话的方式来完成debug。
    :param model: 必要参数，表示调用的大模型名称
    :param messages: 必要参数，ChatMessages类型对象，用于存储对话消息
    :param function_call_message: 必要参数，用于表示上层函数创建的一条包含function call消息的message
    :param function_response_message: 必要参数，用于表示上层函数创建的一条包含外部函数运行结果的message
    :param available_functions: 可选参数，AvailableFunctions类型对象，用于表示开启对话时外部函数基本情况。\
    默认为None，表示没有外部函数
    :param is_developer_mode: 表示是否开启开发者模式，默认为False。\
    开启开发者模式时，会自动添加提示词模板，并且会在每次执行代码前、以及返回结果之后询问用户意见，并会根据用户意见进行修改。
    :param is_expert_mode: 可选参数，表示是否开启专家模式，默认为False。\
    开启增强模式时，会自动启动复杂任务拆解流程，并且在进行代码debug时会自动执行deep debug。
    :param delete_some_messages: 可选参数，表示在拼接messages时是否删除中间若干条消息，默认为Fasle。
    :return: message，拼接了最新大模型回答结果的message
    """</span>    
    
    <span class="token comment"># 获取外部函数运行结果内容</span>
    fun_res_content <span class="token operator">=</span> function_response_message<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>
    
    <span class="token comment"># 若function_response中包含错误</span>
    <span class="token keyword">if</span> <span class="token string">"报错"</span> <span class="token keyword">in</span> fun_res_content<span class="token punctuation">:</span>
        <span class="token comment"># 打印报错信息</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>fun_res_content<span class="token punctuation">)</span>
        
        <span class="token comment"># 根据是否是增强模式，选择执行高效debug或深度debug</span>
        <span class="token comment"># 高效debug和深度debug区别只在于提示内容和提示流程的不同</span>
        <span class="token comment"># 高效debug只包含一条提示，只调用一次大模型即可完成自动debug工作</span>
        <span class="token comment"># 而深度debug则包含三次提示，需要调用三次大模型进行深度总结并完成debug工作</span>
        <span class="token comment"># 先创建不同模式bubug的不同提示词</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> is_expert_mode<span class="token punctuation">:</span>
            <span class="token comment"># 执行高效debug</span>
            display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span><span class="token string">"**即将执行高效debug，正在实例化Efficient Debug Agent...**"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            debug_prompt_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'你编写的代码报错了，请根据报错信息修改代码并重新执行。'</span><span class="token punctuation">]</span>
            
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 执行深度debug</span>
            display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span><span class="token string">"**即将执行深度debug，该debug过程将自动执行多轮对话，请耐心等待。正在实例化Deep Debug Agent...**"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span><span class="token string">"**正在实例化deep debug Agent...**"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            debug_prompt_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"之前执行的代码报错了，你觉得代码哪里编写错了？"</span><span class="token punctuation">,</span> 
                                 <span class="token string">"好的。那么根据你的分析，为了解决这个错误，从理论上来说，应该如何操作呢？"</span><span class="token punctuation">,</span> 
                                 <span class="token string">"非常好，接下来请按照你的逻辑编写相应代码并运行。"</span><span class="token punctuation">]</span>
        
        <span class="token comment"># 复制msg，相当于创建一个新的Agent进行debug</span>
        <span class="token comment"># 需要注意的是，此时msg最后一条消息是user message，而不是任何函数调用相关message</span>
        msg_debug <span class="token operator">=</span> messages<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>        
        <span class="token comment"># 追加function_call_message</span>
        <span class="token comment"># 当前function_call_message中包含编错的代码</span>
        msg_debug<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>function_call_message<span class="token punctuation">)</span>
        <span class="token comment"># 追加function_response_message</span>
        <span class="token comment"># 当前function_response_message包含错误代码的运行报错信息</span>
        msg_debug<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>function_response_message<span class="token punctuation">)</span>        
        
        <span class="token comment"># 依次输入debug的prompt，来引导大模型完成debug</span>
        <span class="token keyword">for</span> debug_prompt <span class="token keyword">in</span> debug_prompt_list<span class="token punctuation">:</span>
            msg_debug<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> debug_prompt<span class="token punctuation">}</span><span class="token punctuation">)</span>
            display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span><span class="token string">"**From Debug iQuery Agent:**"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span>debug_prompt<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 再次调用get_chat_response，在当前debug的prompt下，get_chat_response会返回修改意见或修改之后的代码</span>
            <span class="token comment"># 打印提示信息</span>
            display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span><span class="token string">"**From iQuery Agent:**"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            msg_debug <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                          messages<span class="token operator">=</span>msg_debug<span class="token punctuation">,</span> 
                                          available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                          is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                          is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> 
                                          delete_some_messages<span class="token operator">=</span>delete_some_messages<span class="token punctuation">)</span>
        
        messages <span class="token operator">=</span> msg_debug<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>     
                 
    <span class="token comment"># 若function message不包含报错信息    </span>
    <span class="token comment"># 需要将function message传递给模型</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"外部函数已执行完毕，正在解析运行结果..."</span><span class="token punctuation">)</span>
        messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>function_call_message<span class="token punctuation">)</span>
        messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>function_response_message<span class="token punctuation">)</span>
        messages <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                     messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                     available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                     is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                     is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">,</span> 
                                     delete_some_messages<span class="token operator">=</span>delete_some_messages<span class="token punctuation">)</span>
        
    <span class="token keyword">return</span> messages
</code></pre> 
<h3><a id="4_925"></a>4、文本内容检查函数</h3> 
<p>负责执行文本内容创建审查工作。运行模式可分为快速模式和人工审查模式。在快速模式下，模型将迅速创建文本并保存至msg对象中，而如果是人工审查模式，则需要先经过人工确认，函数才会保存大模型创建的文本内容，并且在这个过程中，也可以选择让模型根据用户输入的修改意见重新修改文本</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">handle_text_response</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> 
                           messages<span class="token punctuation">,</span> 
                           text_answer_message<span class="token punctuation">,</span>
                           available_functions<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                           is_developer_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                           is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> 
                           delete_some_messages<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                           is_task_decomposition<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    <span class="token triple-quoted-string string">"""
    负责执行文本内容创建审查工作。运行模式可分为快速模式和人工审查模式。在快速模式下，模型将迅速创建文本并保存至msg对象中，\
    而如果是人工审查模式，则需要先经过人工确认，函数才会保存大模型创建的文本内容，并且在这个过程中，\
    也可以选择让模型根据用户输入的修改意见重新修改文本。
    :param model: 必要参数，表示调用的大模型名称
    :param messages: 必要参数，ChatMessages类型对象，用于存储对话消息
    :param text_answer_message: 必要参数，用于表示上层函数创建的一条包含文本内容的message
    :param available_functions: 可选参数，AvailableFunctions类型对象，用于表示开启对话时外部函数基本情况。\
    默认为None，表示没有外部函数
    :param is_developer_mode: 表示是否开启开发者模式，默认为False。\
    开启开发者模式时，会自动添加提示词模板，并且会在每次执行代码前、以及返回结果之后询问用户意见，并会根据用户意见进行修改。
    :param is_expert_mode: 可选参数，表示是否开启专家模式，默认为False。\
    开启增强模式时，会自动启动复杂任务拆解流程，并且在进行代码debug时会自动执行deep debug。
    :param delete_some_messages: 可选参数，表示在拼接messages时是否删除中间若干条消息，默认为Fasle。
    :param is_task_decomposition: 可选参数，是否是当前执行任务是否是审查任务拆解结果，默认为False。
    :return: message，拼接了最新大模型回答结果的message
    """</span>    
    
    <span class="token comment"># 从text_answer_message中获取模型回答结果并打印</span>
    answer_content <span class="token operator">=</span> text_answer_message<span class="token punctuation">.</span>content
    <span class="token comment"># print("看看这个值is_task_decomposition")</span>
    <span class="token comment"># print(is_task_decomposition)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"模型回答：\n"</span><span class="token punctuation">)</span>
    display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span>answer_content<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 创建指示变量user_input，用于记录用户修改意见，默认为None</span>
    user_input <span class="token operator">=</span> <span class="token boolean">None</span>
    
    <span class="token comment"># 若是开发者模式，或者是增强模式下任务拆解结果，则引导用户对其进行审查</span>
    <span class="token comment"># 若是开发者模式而非任务拆解</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> is_task_decomposition <span class="token keyword">and</span> is_developer_mode<span class="token punctuation">:</span>
        user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>"请问是否记录回答结果（<span class="token number">1</span>），\
        或者对当前结果提出修改意见（<span class="token number">2</span>），\
        或者重新进行提问（<span class="token number">3</span>），\
        或者直接退出对话（<span class="token number">4</span>）"<span class="token punctuation">)</span>
        <span class="token keyword">if</span> user_input <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
            <span class="token comment"># 若记录回答结果，则将其添加入msg对象中</span>
            messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>text_answer_message<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"本次对话结果已保存"</span><span class="token punctuation">)</span>
    
    <span class="token comment">## 添加了一个逻辑，如果是任务拆解，或者是专家模式（专家模式里都有任务拆解）</span>
    <span class="token comment"># 若是任务拆解</span>
    <span class="token keyword">elif</span> is_task_decomposition <span class="token keyword">or</span> is_expert_mode<span class="token punctuation">:</span>
        user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>"请问是否按照该流程执行任务（<span class="token number">1</span>），\
        或者对当前执行流程提出修改意见（<span class="token number">2</span>），\
        或者重新进行提问（<span class="token number">3</span>），\
        或者直接退出对话（<span class="token number">4</span>）"<span class="token punctuation">)</span>
        <span class="token keyword">if</span> user_input <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
            <span class="token comment"># 任务拆解中，如果选择执行该流程</span>
            messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>text_answer_message<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"好的，即将逐步执行上述流程"</span><span class="token punctuation">)</span>
            messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"非常好，请按照该流程逐步执行。"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            is_task_decomposition <span class="token operator">=</span> <span class="token boolean">False</span>
            is_expert_mode <span class="token operator">=</span> <span class="token boolean">False</span>
            messages <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                         messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                         available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                         is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                         is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">,</span> 
                                         delete_some_messages<span class="token operator">=</span>delete_some_messages<span class="token punctuation">,</span> 
                                         is_task_decomposition<span class="token operator">=</span>is_task_decomposition<span class="token punctuation">)</span>
            
       
    <span class="token keyword">if</span> user_input <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> user_input <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>
            <span class="token keyword">pass</span>
        <span class="token keyword">elif</span> user_input <span class="token operator">==</span> <span class="token string">'2'</span><span class="token punctuation">:</span>
            new_user_content <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"好的，输入对模型结果的修改意见："</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"好的，正在进行修改。"</span><span class="token punctuation">)</span>
            <span class="token comment"># 在messages中暂时记录上一轮回答的内容</span>
            messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>text_answer_message<span class="token punctuation">)</span>
            <span class="token comment"># 记录用户提出的修改意见</span>
            messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> new_user_content<span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token comment"># 再次调用主函数进行回答，为了节省token，可以删除用户修改意见和第一版模型回答结果</span>
            <span class="token comment"># 因此这里可以设置delete_some_messages=2</span>
            <span class="token comment"># 此外，这里需要设置is_task_decomposition=is_task_decomposition</span>
            <span class="token comment"># 当需要修改复杂任务拆解结果时，会自动带入is_task_decomposition=True</span>
            messages <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                         messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                         available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                         is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                         is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">,</span> 
                                         delete_some_messages<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> 
                                         is_task_decomposition<span class="token operator">=</span>is_task_decomposition<span class="token punctuation">)</span>

        <span class="token keyword">elif</span> user_input <span class="token operator">==</span> <span class="token string">'3'</span><span class="token punctuation">:</span>
            new_user_content <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"好的，请重新提出问题："</span><span class="token punctuation">)</span>
            <span class="token comment"># 修改问题</span>
            messages<span class="token punctuation">.</span>messages<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_user_content
            <span class="token comment"># 再次调用主函数进行回答</span>
            messages <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">,</span> 
                                         messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> 
                                         available_functions<span class="token operator">=</span>available_functions<span class="token punctuation">,</span>
                                         is_developer_mode<span class="token operator">=</span>is_developer_mode<span class="token punctuation">,</span>
                                         is_expert_mode<span class="token operator">=</span>is_expert_mode<span class="token punctuation">,</span> 
                                         delete_some_messages<span class="token operator">=</span>delete_some_messages<span class="token punctuation">,</span> 
                                         is_task_decomposition<span class="token operator">=</span>is_task_decomposition<span class="token punctuation">)</span>

        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"好的，已退出当前对话"</span><span class="token punctuation">)</span>
        
    <span class="token comment"># 若不是开发者模式</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 记录返回消息</span>
        messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>text_answer_message<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> messages
</code></pre> 
<pre><code class="prism language-python">data_dictionary
</code></pre> 
<p><img src="https://images2.imgbox.com/f6/c5/XHrcGLGL_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_1053"></a>5、普通调用测试</h3> 
<pre><code class="prism language-python">mm1 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我简单介绍iquery数据库基本情况。"</span><span class="token punctuation">)</span>
<span class="token comment">#调用</span>
mm_response1 <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                  messages<span class="token operator">=</span>mm1<span class="token punctuation">)</span>
<span class="token comment">#输出响应消息</span>
mm_response1<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/74/a1/auyUJQV0_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6_1066"></a>6、对比开发者模式</h3> 
<pre><code class="prism language-python">mm2 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我简单介绍iquery数据库基本情况。"</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
mm_response2 <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                  messages<span class="token operator">=</span>mm2<span class="token punctuation">,</span> 
                                  is_developer_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
mm_response2<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/ff/fa/reNch9jA_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="7Function_Calling_1079"></a>7、带有Function Calling调用</h3> 
<pre><code class="prism language-python">mm3 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我统计user_demographics总共有多少条数据？"</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
mm_response3 <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                  messages<span class="token operator">=</span>mm3<span class="token punctuation">,</span> 
                                  available_functions<span class="token operator">=</span>af<span class="token punctuation">)</span>
mm_response3<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/92/13/xYi2pN9B_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="8_1092"></a>8、复杂问题拆解</h3> 
<pre><code class="prism language-python">mm4 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我查询iquery数据库中四张表数据量是否一致。"</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
mm_response4 <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo-16k'</span><span class="token punctuation">,</span> 
                                  messages<span class="token operator">=</span>mm4<span class="token punctuation">,</span> 
                                  available_functions<span class="token operator">=</span>af<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/08/a0/Sl882tk4_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="9Function_Calling_1104"></a>9、测试对比有代码调用的Function Calling</h3> 
<pre><code class="prism language-python">mm6 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我将user_services数据表读取到Python环境中，并进行缺失值查找。"</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
mm_response6 <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo'</span><span class="token punctuation">,</span> 
                                  messages<span class="token operator">=</span>mm6<span class="token punctuation">,</span> 
                                  available_functions<span class="token operator">=</span>af<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ed/23/fdKndx43_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="10_1116"></a>10、测试开发者模式(不涉及代码执行)</h3> 
<pre><code class="prism language-python">mm8 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"给我介绍一下iquery数据库"</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
mm_response8 <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo-16k'</span><span class="token punctuation">,</span> 
                                  messages<span class="token operator">=</span>mm8<span class="token punctuation">,</span> 
                                  available_functions<span class="token operator">=</span>af<span class="token punctuation">,</span> 
                                  is_developer_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3d/e4/qwI1O7eA_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="11_1129"></a>11、测试专家模式</h3> 
<pre><code class="prism language-python">mm9 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token string">"请帮我到数据库中查询user_demographics表，并用可视化的方法分析其中gender字段的取值分布。并给出结果"</span><span class="token punctuation">)</span>
<span class="token comment">#%%</span>
mm_response9 <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo-16k'</span><span class="token punctuation">,</span> 
                                   messages<span class="token operator">=</span>mm9<span class="token punctuation">,</span> 
                                   available_functions<span class="token operator">=</span>af<span class="token punctuation">,</span> 
                                   is_expert_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/85/32/nrFUQMQw_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12Agent_1141"></a>12、Agent对话封装调用</h3> 
<pre><code class="prism language-python"><span class="token comment"># from memory.MessageManager import MessageManager</span>
<span class="token comment"># from planning.Planning import *</span>

<span class="token keyword">class</span> <span class="token class-name">iQueryAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>
                 api_key<span class="token punctuation">,</span>
                 model<span class="token operator">=</span><span class="token string">'gpt-3.5-turbo-16k'</span><span class="token punctuation">,</span>
                 system_content_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                 project<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 messages<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 available_functions<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                 is_expert_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 is_developer_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        初始参数解释：
        api_key：必选参数，表示调用OpenAI模型所必须的字符串密钥，没有默认取值，需要用户提前设置才可使用MateGen；
        model：可选参数，表示当前选择的Chat模型类型，默认为gpt-3.5-turbo-16k，具体当前OpenAI账户可以调用哪些模型，可以参考官网Limit链接：https://platform.openai.com/account/limits ；
        system_content_list：可选参数，表示输入的系统消息或者外部文档，默认为空列表，表示不输入外部文档；
        project：可选参数，表示当前对话所归属的项目名称，需要输入CloudFile类对象，用于表示当前对话的本地存储方法，默认为None，表示不进行本地保存；
        messages：可选参数，表示当前对话所继承的Messages，需要是MessageManager对象、或者是字典所构成的list，默认为None，表示不继承Messages；
        available_functions：可选参数，表示当前对话的外部工具，需要是AvailableFunction对象，默认为None，表示当前对话没有外部函数；
        is_expert_mode：可选参数，表示当前对话是否开启专家模式，专家模式下会自动开启复杂任务拆解流程以及深度debug功能，会需要耗费更多的计算时间和金额，不过会换来Agent整体性能提升，默认为False；
        is_developer_mode：可选参数，表示当前对话是否开启开发者模式，在开发者模式下，模型会先和用户确认文本或者代码是否正确，再选择是否进行保存或者执行，对于开发者来说借助开发者模式可以极大程度提升模型可用性，但并不推荐新人使用，默认为False；
        """</span>

        self<span class="token punctuation">.</span>api_key <span class="token operator">=</span> api_key
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> model
        self<span class="token punctuation">.</span>project <span class="token operator">=</span> project
        self<span class="token punctuation">.</span>system_content_list <span class="token operator">=</span> system_content_list
        tokens_thr <span class="token operator">=</span> <span class="token boolean">None</span>

        <span class="token comment"># 计算tokens_thr</span>
        <span class="token keyword">if</span> <span class="token string">'1106'</span> <span class="token keyword">in</span> model<span class="token punctuation">:</span>
            tokens_thr <span class="token operator">=</span> <span class="token number">110000</span>
        <span class="token keyword">elif</span> <span class="token string">'16k'</span> <span class="token keyword">in</span> model<span class="token punctuation">:</span>
            tokens_thr <span class="token operator">=</span> <span class="token number">12000</span>
        <span class="token keyword">elif</span> <span class="token string">'gpt-4-0613'</span> <span class="token keyword">in</span> model<span class="token punctuation">:</span>
            tokens_thr <span class="token operator">=</span> <span class="token number">7000</span>
        <span class="token keyword">elif</span> <span class="token string">'gpt-4-turbo-preview'</span> <span class="token keyword">in</span> model<span class="token punctuation">:</span>
            tokens_thr <span class="token operator">=</span> <span class="token number">110000</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            tokens_thr <span class="token operator">=</span> <span class="token number">3000</span>

        self<span class="token punctuation">.</span>tokens_thr <span class="token operator">=</span> tokens_thr

        <span class="token comment"># 创建self.messages属性</span>
        self<span class="token punctuation">.</span>messages <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span>system_content_list<span class="token punctuation">,</span>
                                     tokens_thr<span class="token operator">=</span>tokens_thr<span class="token punctuation">)</span>

        <span class="token comment"># 若初始参数messages不为None，则将其加入self.messages中</span>
        <span class="token keyword">if</span> messages <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>available_functions <span class="token operator">=</span> available_functions
        self<span class="token punctuation">.</span>is_expert_mode <span class="token operator">=</span> is_expert_mode
        self<span class="token punctuation">.</span>is_developer_mode <span class="token operator">=</span> is_developer_mode
        
        title<span class="token operator">=</span><span class="token string">"【===================欢迎使用iQuery Agent 智能数据分析平台================================】"</span>
        display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span>title<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">chat</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> question<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        iQueryAgent类主方法，支持单次对话和多轮对话两种模式，当用户没有输入question时开启多轮对话，反之则开启单轮对话。\
        无论开启单论对话或多轮对话，对话结果将会保存在self.messages中，便于下次调用
        """</span>
       
        head_str <span class="token operator">=</span> <span class="token string">"▌ Model set to %s"</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>model
        display<span class="token punctuation">(</span>Markdown<span class="token punctuation">(</span>head_str<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> question <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> question<span class="token punctuation">}</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>messages <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
                                              messages<span class="token operator">=</span>self<span class="token punctuation">.</span>messages<span class="token punctuation">,</span>
                                              available_functions<span class="token operator">=</span>self<span class="token punctuation">.</span>available_functions<span class="token punctuation">,</span>
                                              is_developer_mode<span class="token operator">=</span>self<span class="token punctuation">.</span>is_developer_mode<span class="token punctuation">,</span>
                                              is_expert_mode<span class="token operator">=</span>self<span class="token punctuation">.</span>is_expert_mode<span class="token punctuation">)</span>

        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>messages <span class="token operator">=</span> one_chat_response<span class="token punctuation">(</span>model<span class="token operator">=</span>self<span class="token punctuation">.</span>model<span class="token punctuation">,</span>
                                                  messages<span class="token operator">=</span>self<span class="token punctuation">.</span>messages<span class="token punctuation">,</span>
                                                  available_functions<span class="token operator">=</span>self<span class="token punctuation">.</span>available_functions<span class="token punctuation">,</span>
                                                  is_developer_mode<span class="token operator">=</span>self<span class="token punctuation">.</span>is_developer_mode<span class="token punctuation">,</span>
                                                  is_expert_mode<span class="token operator">=</span>self<span class="token punctuation">.</span>is_expert_mode<span class="token punctuation">)</span>

                user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"您还有其他问题吗？(输入退出以结束对话): "</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> user_input <span class="token operator">==</span> <span class="token string">"退出"</span><span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> user_input<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        重置当前iQuery Agent对象的messages
        """</span>
        self<span class="token punctuation">.</span>messages <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span>self<span class="token punctuation">.</span>system_content_list<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">upload_messages</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        将当前messages上传至project项目中
        """</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>project <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"需要先输入project参数（需要是一个CloudFile对象），才可上传messages"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>project<span class="token punctuation">.</span>append_doc_content<span class="token punctuation">(</span>content<span class="token operator">=</span>self<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>history_messages<span class="token punctuation">)</span>
<span class="token comment">#iquery = iQueryAgent(api_key="",model="gpt-3.5-turbo-16k")</span>
<span class="token comment">#iquery.chat('请帮我介绍下什么是机器学习？')</span>
<span class="token comment">#iquery.chat("请问你上次回答的问题是什么？")</span>
</code></pre> 
<p>对话测试</p> 
<pre><code class="prism language-python">iquery <span class="token operator">=</span> iQueryAgent<span class="token punctuation">(</span>api_key<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo-16k"</span><span class="token punctuation">,</span> 
                       available_functions<span class="token operator">=</span>af<span class="token punctuation">)</span>
iquery<span class="token punctuation">.</span>chat<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6e/a0/Y1gwdtHK_o.png" alt="在这里插入图片描述"></p> 
<p>对话测试</p> 
<pre><code class="prism language-python">iquery <span class="token operator">=</span> iQueryAgent<span class="token punctuation">(</span>api_key<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo-16k"</span><span class="token punctuation">,</span> 
                     system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">]</span><span class="token punctuation">,</span>
                       available_functions<span class="token operator">=</span>af<span class="token punctuation">)</span>
iquery<span class="token punctuation">.</span>chat<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/34/37/qDMyzh3A_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_1275"></a>七、结语</h2> 
<p>截至目前，Agent智能数据分析平台的开发工作已接近尾声。从最初的开源调研，到架构设计分析，再到代码的具体落地实施，整个开发过程已经基本完成。接下来的任务是将已有的成果整合到平台的各个功能模块中，确保平台的完整性和稳定性。</p> 
<p><img src="https://images2.imgbox.com/d7/b1/daSgUmRS_o.png" alt="在这里插入图片描述"></p> 
<p>🎯🔖更多专栏系列文章：<a href="https://blog.csdn.net/xiaobing259/category_12628007.html?spm=1001.2014.3001.5482"><strong>AIGC-AI大模型探索之路</strong></a></p> 
<blockquote> 
 <p>😎 <strong>作者介绍</strong>：我是寻道AI小兵，资深程序老猿，从业10年+、互联网系统架构师，目前专注于AIGC的探索。<br> 📖 <strong>技术交流</strong>：建立有技术交流群，可以扫码👇 加入社群，500本各类编程书籍、AI教程、AI工具等你领取！<br> <strong>如果文章内容对您有所触动，别忘了<font color="red"><strong>点赞、⭐关注，收藏</strong></font>！加入我，让我们携手同行AI的探索之旅，一起开启智能时代的大门！</strong></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5f37861452f19d8910acd3e1f7c57777/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">函数递归（C语言）（详细过程！）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9d4c6b4cda047a5dd220f1a0216e035c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C&#43;&#43;进阶】深入STL之 栈与队列：数据结构探索之旅</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>