<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kafka事务是怎么实现的？Kafka事务消息原理详解（文末送书） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/e843eef7751ba885e1a7415891a8c0a8/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Kafka事务是怎么实现的？Kafka事务消息原理详解（文末送书）">
  <meta property="og:description" content="目录 一、Kafka事务性消息1.1 介绍Kafka事务性消息1.2 事务性消息的应用场景1.3 Kafka事务性消息的优势 二、Kafka事务性消息的使用2.1 配置Kafka以支持事务性消息生产者配置消费者配置 2.2 生产者：发送事务性消息创建Kafka生产者开始事务发送消息提交或中止事务 2.3 消费者：处理事务性消息创建 Kafka 消费者订阅主题处理消息提交位移 三、事务性消息的最佳实践3.1 保障消息的一次交付3.1.1 生产者幂等性3.1.2 消费者去重 3.2 事务性消息的监控和故障排查3.2.1 监控工具3.2.2 故障排查 3.3 事务性消息的性能考量3.3.1 性能调整3.3.2 吞吐量优化 四、示例：生产和消费Kafka事务性消息4.1 示例1：生产事务性消息示例1代码：生产者代码说明: 4.2 示例2：消费事务性消息示例2代码：消费者代码说明: 五、总结六、Spring Boot 3核心技术与最佳实践1、内容介绍2、作者简介3、参与方式 大家好，我是哪吒。
前两天，有个朋友去面试，被问到Kafka事务的问题。
她的第一反应是：
我是来面试Java的，怎么问我大数据的Kafka？
文末送5本《Spring Boot 3核心技术与最佳实践》
不过Kafka确实是Java程序员必备的中间件技术了，这点是毋庸置疑的。
Kafka几乎是当今时代背景下数据管道的首选，无论你是做后端开发、还是大数据开发，对它可能都不陌生。开源软件Kafka的应用越来越广泛。
面对Kafka的普及和学习热潮，哪吒想分享一下自己多年的开发经验，带领读者比较轻松地掌握Kafka的相关知识
上一节我们说到了解密Kafka主题的分区策略：提升实时数据处理的关键，今天系统的说一下Kafka的事务，实现步步为营，逐个击破，拿下Kafka。
在当今大数据时代，数据的可靠性和一致性变得至关重要。Kafka作为一个分布式流数据平台，强调了实时数据的高吞吐量传输，而Kafka事务性消息则在这个过程中发挥了至关重要的作用。
本文将详细介绍Kafka事务性消息，探究它们如何确保数据一致性，以及在各种应用场景中的应用。
一、Kafka事务性消息 1.1 介绍Kafka事务性消息 Kafka事务性消息是一项关键的功能，为确保数据一致性提供了重要的支持。在本部分，我们将深入了解Kafka事务性消息的基本概念。
Kafka事务性消息的概念
Kafka事务性消息是一种机制，用于确保消息的可靠性传递和处理。与非事务性消息相比，它们在数据处理中提供了额外的保证。一旦消息被写入Kafka集群，它们将被认为是已经处理，无论发生了什么。
为什么需要事务性消息？
事务性消息对于确保数据一致性至关重要。在某些应用程序中，消息的完整性和可靠性至关重要。如果在消息处理期间发生故障，如何保证消息不会丢失或重复是一个复杂的问题。Kafka事务性消息提供了解决这些问题的方式，使得消息处理更加可控和可靠。
事务性消息的特性
Kafka事务性消息具有以下关键特性：
原子性：事务性消息要么完全成功，要么完全失败。这确保了消息不会被部分处理。
可靠性：一旦消息被写入Kafka，它们将被视为已经处理，即使发生了应用程序或系统故障。
顺序性：事务性消息在单个分区内保持顺序。这对于需要按顺序处理的应用程序至关重要。 幂等性：Kafka生产者可以配置为幂等，确保相同的消息不会被重复发送。
Exactly Once语义：事务性消息支持&#34;仅一次&#34;语义，即消息要么完全到达一次，要么不到达。
本节的目标是帮助您理解Kafka事务性消息的核心概念。接下来，我们将探讨它们的应用场景以及相对于非事务性消息的优势。
1.2 事务性消息的应用场景 事务性消息在多种应用场景中发挥着关键作用。以下是一些常见的应用场景，其中事务性消息特别有用：
金融交易处理：在金融领域，每笔交易都必须具备原子性，确保不发生不一致或重复的交易。事务性消息可用于记录和处理金融交易，保证交易的完整性。
订单处理：在电子商务平台上，订单处理必须是可靠的，以确保订单的创建、支付和发货不会出现问题。事务性消息可用于跟踪和处理订单的不同阶段，从而确保订单流程的一致性。
库存管理：对于企业，库存管理是至关重要的。事务性消息可用于跟踪库存的变化，以确保库存的准确性和可靠性。
日志记录：在大数据和日志记录应用中，日志的完整性是至关重要的。事务性消息可用于确保日志的完整性，即使在日志处理集群发生故障时也能保持一致性。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-19T10:51:34+08:00">
    <meta property="article:modified_time" content="2023-12-19T10:51:34+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kafka事务是怎么实现的？Kafka事务消息原理详解（文末送书）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/b5/e8/O5T7sllQ_o.gif" alt="在这里插入图片描述"></p> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><a href="#Kafka_32" rel="nofollow">一、Kafka事务性消息</a></li><li><ul><li><a href="#11_Kafka_34" rel="nofollow">1.1 介绍Kafka事务性消息</a></li><li><a href="#12__77" rel="nofollow">1.2 事务性消息的应用场景</a></li><li><a href="#13_Kafka_91" rel="nofollow">1.3 Kafka事务性消息的优势</a></li></ul> 
   </li><li><a href="#Kafka_109" rel="nofollow">二、Kafka事务性消息的使用</a></li><li><ul><li><a href="#21_Kafka_113" rel="nofollow">2.1 配置Kafka以支持事务性消息</a></li><li><ul><li><a href="#_117" rel="nofollow">生产者配置</a></li><li><a href="#_135" rel="nofollow">消费者配置</a></li></ul> 
    </li><li><a href="#22__152" rel="nofollow">2.2 生产者：发送事务性消息</a></li><li><ul><li><a href="#Kafka_156" rel="nofollow">创建Kafka生产者</a></li><li><a href="#_181" rel="nofollow">开始事务</a></li><li><a href="#_189" rel="nofollow">发送消息</a></li><li><a href="#_198" rel="nofollow">提交或中止事务</a></li></ul> 
    </li><li><a href="#23__216" rel="nofollow">2.3 消费者：处理事务性消息</a></li><li><ul><li><a href="#_Kafka__220" rel="nofollow">创建 Kafka 消费者</a></li><li><a href="#_248" rel="nofollow">订阅主题</a></li><li><a href="#_256" rel="nofollow">处理消息</a></li><li><a href="#_269" rel="nofollow">提交位移</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_283" rel="nofollow">三、事务性消息的最佳实践</a></li><li><ul><li><a href="#31__287" rel="nofollow">3.1 保障消息的一次交付</a></li><li><ul><li><a href="#311__289" rel="nofollow">3.1.1 生产者幂等性</a></li><li><a href="#312__301" rel="nofollow">3.1.2 消费者去重</a></li></ul> 
    </li><li><a href="#32__315" rel="nofollow">3.2 事务性消息的监控和故障排查</a></li><li><ul><li><a href="#321__317" rel="nofollow">3.2.1 监控工具</a></li><li><a href="#322__327" rel="nofollow">3.2.2 故障排查</a></li></ul> 
    </li><li><a href="#33__337" rel="nofollow">3.3 事务性消息的性能考量</a></li><li><ul><li><a href="#331__341" rel="nofollow">3.3.1 性能调整</a></li><li><a href="#332__347" rel="nofollow">3.3.2 吞吐量优化</a></li></ul> 
   </li></ul> 
   </li><li><a href="#Kafka_361" rel="nofollow">四、示例：生产和消费Kafka事务性消息</a></li><li><ul><li><a href="#41_1_365" rel="nofollow">4.1 示例1：生产事务性消息</a></li><li><ul><li><a href="#1_367" rel="nofollow">示例1代码：生产者</a></li><li><a href="#_408" rel="nofollow">代码说明:</a></li></ul> 
    </li><li><a href="#42_2_415" rel="nofollow">4.2 示例2：消费事务性消息</a></li><li><ul><li><a href="#2_417" rel="nofollow">示例2代码：消费者</a></li><li><a href="#_450" rel="nofollow">代码说明:</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_456" rel="nofollow">五、总结</a></li><li><a href="#Spring_Boot_3_468" rel="nofollow">六、Spring Boot 3核心技术与最佳实践</a></li><li><ul><li><a href="#1_472" rel="nofollow">1、内容介绍</a></li><li><a href="#2_482" rel="nofollow">2、作者简介</a></li><li><a href="#3_486" rel="nofollow">3、参与方式</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>大家好，我是哪吒。</p> 
<p>前两天，有个朋友去面试，被问到Kafka事务的问题。</p> 
<p>她的第一反应是：</p> 
<p>我是来面试Java的，怎么问我大数据的Kafka？</p> 
<p><font face="楷体" size="5" color="#dd0000">文末送5本《Spring Boot 3核心技术与最佳实践》</font></p> 
<p><img src="https://images2.imgbox.com/4c/45/lIcsnDd7_o.png" alt="在这里插入图片描述"></p> 
<p>不过Kafka确实是Java程序员必备的中间件技术了，这点是毋庸置疑的。</p> 
<p><img src="https://images2.imgbox.com/3e/9d/SnCAXbQU_o.png" alt="在这里插入图片描述"></p> 
<p>Kafka几乎是当今时代背景下数据管道的首选，无论你是做后端开发、还是大数据开发，对它可能都不陌生。开源软件Kafka的应用越来越广泛。</p> 
<p>面对Kafka的普及和学习热潮，哪吒想分享一下自己多年的开发经验，带领读者比较轻松地掌握Kafka的相关知识</p> 
<p>上一节我们说到了<a href="https://blog.csdn.net/guorui_java/article/details/134522836">解密Kafka主题的分区策略：提升实时数据处理的关键</a>，今天系统的说一下Kafka的事务，实现步步为营，逐个击破，拿下Kafka。</p> 
<p>在当今大数据时代，数据的可靠性和一致性变得至关重要。Kafka作为一个分布式流数据平台，强调了实时数据的高吞吐量传输，而Kafka事务性消息则在这个过程中发挥了至关重要的作用。</p> 
<p>本文将详细介绍Kafka事务性消息，探究它们如何确保数据一致性，以及在各种应用场景中的应用。</p> 
<h3><a id="Kafka_32"></a>一、Kafka事务性消息</h3> 
<h4><a id="11_Kafka_34"></a>1.1 介绍Kafka事务性消息</h4> 
<p>Kafka事务性消息是一项关键的功能，为确保数据一致性提供了重要的支持。在本部分，我们将深入了解Kafka事务性消息的基本概念。</p> 
<p><strong>Kafka事务性消息的概念</strong></p> 
<p><img src="https://images2.imgbox.com/09/1c/8Y9PhYEw_o.png" alt="在这里插入图片描述"></p> 
<p>Kafka事务性消息是一种机制，用于确保消息的可靠性传递和处理。与非事务性消息相比，它们在数据处理中提供了额外的保证。一旦消息被写入Kafka集群，它们将被认为是已经处理，无论发生了什么。</p> 
<p><strong>为什么需要事务性消息？</strong></p> 
<p><img src="https://images2.imgbox.com/21/dd/kM2xAWrg_o.png" alt="在这里插入图片描述"></p> 
<p>事务性消息对于确保数据一致性至关重要。在某些应用程序中，消息的完整性和可靠性至关重要。如果在消息处理期间发生故障，如何保证消息不会丢失或重复是一个复杂的问题。Kafka事务性消息提供了解决这些问题的方式，使得消息处理更加可控和可靠。</p> 
<p><strong>事务性消息的特性</strong></p> 
<p>Kafka事务性消息具有以下关键特性：</p> 
<p><img src="https://images2.imgbox.com/0b/1f/XX1mDjdq_o.png" alt="在这里插入图片描述"></p> 
<ul><li> <p><strong>原子性</strong>：事务性消息要么完全成功，要么完全失败。这确保了消息不会被部分处理。</p> </li><li> <p><strong>可靠性</strong>：一旦消息被写入Kafka，它们将被视为已经处理，即使发生了应用程序或系统故障。</p> </li></ul> 
<p><img src="https://images2.imgbox.com/22/cc/GXDyEzDg_o.png" alt=""></p> 
<ul><li><strong>顺序性</strong>：事务性消息在单个分区内保持顺序。这对于需要按顺序处理的应用程序至关重要。</li></ul> 
<p><img src="https://images2.imgbox.com/fc/b3/0jFeaoax_o.png" alt=""></p> 
<ul><li> <p><strong>幂等性</strong>：Kafka生产者可以配置为幂等，确保相同的消息不会被重复发送。</p> </li><li> <p><strong>Exactly Once语义</strong>：事务性消息支持"仅一次"语义，即消息要么完全到达一次，要么不到达。</p> </li></ul> 
<p>本节的目标是帮助您理解Kafka事务性消息的核心概念。接下来，我们将探讨它们的应用场景以及相对于非事务性消息的优势。</p> 
<h4><a id="12__77"></a>1.2 事务性消息的应用场景</h4> 
<p>事务性消息在多种应用场景中发挥着关键作用。以下是一些常见的应用场景，其中事务性消息特别有用：</p> 
<p><strong>金融交易处理</strong>：在金融领域，每笔交易都必须具备原子性，确保不发生不一致或重复的交易。事务性消息可用于记录和处理金融交易，保证交易的完整性。</p> 
<p><strong>订单处理</strong>：在电子商务平台上，订单处理必须是可靠的，以确保订单的创建、支付和发货不会出现问题。事务性消息可用于跟踪和处理订单的不同阶段，从而确保订单流程的一致性。</p> 
<p><strong>库存管理</strong>：对于企业，库存管理是至关重要的。事务性消息可用于跟踪库存的变化，以确保库存的准确性和可靠性。</p> 
<p><strong>日志记录</strong>：在大数据和日志记录应用中，日志的完整性是至关重要的。事务性消息可用于确保日志的完整性，即使在日志处理集群发生故障时也能保持一致性。</p> 
<p><strong>系统通知</strong>：对于需要向用户发送通知或提醒的应用程序，确保通知的可靠发送至关重要。事务性消息可用于实现这一目标。</p> 
<h4><a id="13_Kafka_91"></a>1.3 Kafka事务性消息的优势</h4> 
<p>相对于非事务性消息，Kafka事务性消息具有明显的优势，特别是在需要数据一致性的应用场景中。以下是Kafka事务性消息的优势：</p> 
<p><strong>数据一致性</strong>：事务性消息可确保消息要么被完全处理，要么不被处理。这消除了数据处理中的不一致性，有助于维护数据一致性。</p> 
<p><strong>可靠性</strong>：一旦消息被写入Kafka，它们将被视为已经处理，即使发生了应用程序或系统故障。这确保了消息的可靠传递。</p> 
<p><strong>幂等性</strong>：Kafka生产者可以配置为幂等，这意味着相同的消息不会被重复发送。这有助于减少不必要的消息传递，避免数据重复。</p> 
<p><strong>Exactly Once语义</strong>：事务性消息支持"仅一次"语义，即消息要么完全到达一次，要么不到达。这是某些应用程序所需的高级语义。</p> 
<p><strong>错误处理</strong>：事务性消息提供了一种处理错误的机制，以确保消息可以被恢复或重试，而不会丢失。</p> 
<p><img src="https://images2.imgbox.com/cd/67/fhzMnacg_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="Kafka_109"></a>二、Kafka事务性消息的使用</h3> 
<p>在这一部分，我们将深入研究如何使用Kafka事务性消息来确保数据的一致性。</p> 
<h4><a id="21_Kafka_113"></a>2.1 配置Kafka以支持事务性消息</h4> 
<p>配置Kafka以支持事务性消息对于确保消息在传递和处理过程中的一致性非常重要。在本节中，我们将详细讨论如何配置Kafka以支持事务性消息，包括生产者和消费者的设置。</p> 
<h5><a id="_117"></a>生产者配置</h5> 
<p>在生产者端，需要进行一些特定的配置以启用事务性消息。以下是一些关键的配置参数：</p> 
<ul><li> <p><code>acks</code>：这是有关生产者接收到确认之后才认为消息发送成功的设置。对于事务性消息，通常将其设置为<code>acks=all</code>，以确保消息仅在事务完全提交后才被视为成功发送。</p> </li><li> <p><code>transactional.id</code>：这是用于标识生产者实例的唯一ID。在配置文件中设置<code>transactional.id</code>是启用事务性消息的关键步骤。</p> </li><li> <p><code>enable.idempotence</code>：幂等性是指相同的消息不会被重复发送。对于事务性消息，通常将其设置为<code>enable.idempotence=true</code>，以确保消息不会重复发送。</p> </li></ul> 
<p>配置示例：</p> 
<pre><code class="prism language-properties">acks=all
transactional.id=my-transactional-id
enable.idempotence=true
</code></pre> 
<h5><a id="_135"></a>消费者配置</h5> 
<p>在消费者端，同样需要进行适当的配置以确保正确处理事务性消息。以下是一些消费者的重要配置参数：</p> 
<ul><li> <p><code>isolation.level</code>：这是用于控制消费者的隔离级别的设置。对于事务性消息，通常将其设置为<code>isolation.level=read_committed</code>，以确保只读取已经提交的事务消息。</p> </li><li> <p><code>auto.offset.reset</code>：这是消费者启动时从哪里开始读取消息的设置。通常将其设置为<code>auto.offset.reset=earliest</code>，以确保不会错过任何已提交的消息。</p> </li></ul> 
<p>配置示例：</p> 
<pre><code class="prism language-properties">isolation.level=read_committed
auto.offset.reset=earliest
</code></pre> 
<p>配置Kafka以支持事务性消息是确保消息可靠传递和处理的关键步骤。这些配置设置可以确保在生产和消费事务性消息时的正确行为。</p> 
<h4><a id="22__152"></a>2.2 生产者：发送事务性消息</h4> 
<p>在这一部分，我们将深入研究如何使用Kafka生产者来发送事务性消息。发送事务性消息是确保数据一致性的关键步骤，需要特别小心。以下是详细的步骤和示例：</p> 
<h5><a id="Kafka_156"></a>创建Kafka生产者</h5> 
<p>首先，我们需要创建一个 Kafka 生产者的实例。这个生产者实例将负责将消息发送到 Kafka 主题。创建生产者需要配置参数，包括 Kafka 集群的地址、消息的键和值的序列化器、事务ID 等。</p> 
<p>下面是一个创建 Kafka 生产者的示例：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">Producer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyKafkaProducer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">createProducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_SERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span><span class="token constant">TRANSACTIONAL_ID_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"my-transactional-id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_181"></a>开始事务</h5> 
<p>在准备发送事务性消息之前，我们需要明确地开始一个事务。这通过调用 <code>beginTransaction</code> 方法来实现。一旦事务开始，所有后续的消息发送将包含在这个事务中。</p> 
<pre><code class="prism language-java">producer<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_189"></a>发送消息</h5> 
<p>在事务内，我们可以开始发送消息。这些消息将被包含在事务中，只有在事务成功提交时才会真正写入 Kafka 主题。</p> 
<pre><code class="prism language-java">producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"my-topic"</span><span class="token punctuation">,</span> <span class="token string">"key1"</span><span class="token punctuation">,</span> <span class="token string">"value1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"my-topic"</span><span class="token punctuation">,</span> <span class="token string">"key2"</span><span class="token punctuation">,</span> <span class="token string">"value2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_198"></a>提交或中止事务</h5> 
<p>事务性消息的一个关键特性是它们要么完全成功，要么完全失败。因此，在消息发送后，我们需要根据消息的处理结果来决定是提交事务还是中止事务。这可以通过调用 <code>commitTransaction</code> 或 <code>abortTransaction</code> 方法来实现。</p> 
<pre><code class="prism language-java"><span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    producer<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProducerFencedException</span> <span class="token operator">|</span> <span class="token class-name">OutOfOrderSequenceException</span> <span class="token operator">|</span> <span class="token class-name">AuthorizationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 处理异常，通常中止事务并重试</span>
    producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CommitFailedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 事务提交失败，通常中止事务并重试</span>
    producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述步骤提供了一个基本的示例，演示如何使用 Kafka 生产者发送事务性消息。事务性消息的发送确保了消息的可靠性和一致性，尤其在需要原子性保证的情况下非常有用。</p> 
<h4><a id="23__216"></a>2.3 消费者：处理事务性消息</h4> 
<p>在这一部分，我们将深入研究如何使用 Kafka 消费者来处理事务性消息。正确处理事务性消息对于保证数据一致性至关重要。以下是详细的步骤和示例：</p> 
<h5><a id="_Kafka__220"></a>创建 Kafka 消费者</h5> 
<p>首先，我们需要创建一个 Kafka 消费者的实例。这个消费者实例将负责从 Kafka 主题中读取消息。创建消费者需要配置参数，包括 Kafka 集群的地址、消息的键和值的反序列化器、消费者组 ID 等。</p> 
<p>下面是一个创建 Kafka 消费者的示例：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">Consumer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">ConsumerRecords</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token class-name">KafkaConsumer</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyKafkaConsumer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">createConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">GROUP_ID_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"my-consumer-group"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_DESERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_DESERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_248"></a>订阅主题</h5> 
<p>消费者需要明确地订阅包含事务性消息的主题。这通过调用 <code>subscribe</code> 方法来实现。一旦订阅，消费者将开始接收该主题上的消息。</p> 
<pre><code class="prism language-java">consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"my-topic"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_256"></a>处理消息</h5> 
<p>一旦事务性消息到达，消费者需要确保消息被正确处理。这通常涉及到处理消息的逻辑，确保数据的一致性。处理消息的逻辑将根据具体的应用和需求而异。</p> 
<pre><code class="prism language-java"><span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> key <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> value <span class="token operator">=</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 处理消息的逻辑</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_269"></a>提交位移</h5> 
<p>消费者需要负责提交消息的位移，以便正确跟踪已处理的消息。这通过调用 <code>commitSync</code> 或 <code>commitAsync</code> 方法来实现。位移的提交确保了消息不会被重复处理。</p> 
<pre><code class="prism language-java">consumer<span class="token punctuation">.</span><span class="token function">commitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>上述步骤提供了一个基本的示例，演示了如何使用 Kafka 消费者处理事务性消息。消费者的正确配置和消息处理确保了消息的可靠性和一致性。在实际应用中，处理消息的逻辑将更加复杂，以满足特定的需求。</p> 
<p><img src="https://images2.imgbox.com/49/52/a89gEbPr_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_283"></a>三、事务性消息的最佳实践</h3> 
<p>在这一节，我们将提供一些关于如何使用Kafka事务性消息的最佳实践。这包括如何确保消息的一次交付、监控和故障排查以及性能优化。</p> 
<h4><a id="31__287"></a>3.1 保障消息的一次交付</h4> 
<h5><a id="311__289"></a>3.1.1 生产者幂等性</h5> 
<p>确保生产者的幂等性是关键，以防止消息被重复发送。以下是一些关键策略和实践，可用于确保生产者的幂等性：</p> 
<p><strong>1. 分配唯一消息ID：</strong> 为每条消息分配一个唯一的消息ID。这可以是全局唯一的，也可以是特定于主题的唯一。在发送消息之前，生产者可以检查已经发送的消息记录，以确保当前消息的ID不重复。</p> 
<p><strong>2. 使用幂等性API：</strong> Kafka 提供了幂等性的生产者 API。你可以在生产者配置中启用幂等性，设置 <code>enable.idempotence=true</code>，以确保消息在发送时不会被重复处理。</p> 
<p><strong>3. 实现自定义幂等性：</strong> 在一些情况下，自定义实现幂等性逻辑可能是必要的。这可以涉及到在消息处理端的数据库或存储中跟踪已处理消息的状态，以确保消息不会被重复处理。</p> 
<p><strong>4. 设置适当的重试机制：</strong> 如果消息发送失败，生产者应该具备适当的重试机制，以确保消息最终被成功发送。重试机制需要在生产者的配置中进行设置。</p> 
<h5><a id="312__301"></a>3.1.2 消费者去重</h5> 
<p>保障消息不会被重复处理同样至关重要。以下是一些策略和最佳实践，可用于实现消费者的去重：</p> 
<p><strong>1. 幂等性消息处理逻辑：</strong> 消费者的消息处理逻辑应该是幂等的。这意味着无论消息被处理多少次，其结果都应该是相同的。这通常需要在应用程序代码中进行实施。</p> 
<p><strong>2. 消息唯一标识：</strong> 为每条消息分配一个唯一的标识符，如消息ID。在处理消息前，消费者可以维护一个记录已处理消息的数据结构，以确保消息不会被重复处理。</p> 
<p><strong>3. 消费者去重过程：</strong> 消费者在处理消息前，可以查询已处理消息的记录，如果消息已存在于记录中，可以选择跳过处理或进行进一步处理。这可以防止消息的重复处理。</p> 
<p><strong>4. 消费者库支持：</strong> 一些消息队列处理库提供了内置的去重机制，你可以利用这些库来简化去重处理。</p> 
<p>以上内容提供了详细的策略和最佳实践，以确保消息的一次交付。这是保障数据一致性的关键步骤，特别适用于事务性消息的处理。这些实践可以根据具体的应用和需求进行定制化。</p> 
<h4><a id="32__315"></a>3.2 事务性消息的监控和故障排查</h4> 
<h5><a id="321__317"></a>3.2.1 监控工具</h5> 
<p>监控Kafka事务性消息是确保系统的可靠性的重要部分。以下是一些监控工具和策略：</p> 
<ul><li> <p><strong>Kafka内置指标</strong>：Kafka提供了一组内置指标，用于监控事务性消息的性能和状态。你可以使用这些指标来跟踪消息的处理情况。</p> </li><li> <p><strong>日志文件</strong>：Kafka的日志文件包含了详细的事件信息，可以用于故障排查和性能分析。定期检查日志文件，以查找潜在的问题。</p> </li><li> <p><strong>监控系统</strong>：使用专业的监控系统，如Prometheus和Grafana，来建立实时监控和警报。这些系统可以帮助你及时发现问题并采取措施。</p> </li></ul> 
<h5><a id="322__327"></a>3.2.2 故障排查</h5> 
<p>当事务性消息出现问题时，需要能够排查和解决这些问题。以下是一些故障排查策略：</p> 
<ul><li> <p><strong>日志分析</strong>：定期分析Kafka的日志文件，查找异常和错误信息。这可以帮助你及早发现问题并采取措施。</p> </li><li> <p><strong>监控警报</strong>：建立监控警报，以便在出现问题时立即收到通知。这有助于快速响应问题。</p> </li><li> <p><strong>版本和配置管理</strong>：确保Kafka和应用程序的版本和配置得到正确管理。不同版本或配置的不一致可能导致问题。</p> </li></ul> 
<h4><a id="33__337"></a>3.3 事务性消息的性能考量</h4> 
<p>性能是任何消息系统的关键指标，特别是对于高吞吐量和低延迟的需求。以下是一些性能考量和优化策略：</p> 
<h5><a id="331__341"></a>3.3.1 性能调整</h5> 
<ul><li> <p><strong>生产者性能调整</strong>：通过调整生产者的配置参数，如<code>batch.size</code>、<code>acks</code>等，可以优化消息发送性能。</p> </li><li> <p><strong>消费者性能调整</strong>：消费者的性能也可以通过配置参数，如<code>max.poll.records</code>、<code>fetch.min.bytes</code>等进行调整。</p> </li></ul> 
<h5><a id="332__347"></a>3.3.2 吞吐量优化</h5> 
<ul><li><strong>分区和并</strong></li></ul> 
<p>行度**：合理地选择分区数量和消费者的并行度，以确保系统能够处理大量事务性消息。</p> 
<ul><li> <p><strong>水平扩展</strong>：如果系统负载增加，考虑进行水平扩展，增加Kafka代理和消费者实例，以提高吞吐量。</p> </li><li> <p><strong>网络和存储优化</strong>：确保网络和存储基础设施足够快，以支持高吞吐量的消息传递。</p> </li></ul> 
<p>上述最佳实践策略和性能优化建议可以帮助你更好地使用Kafka事务性消息，确保消息的可靠传递和一致性处理，同时满足性能需求。通过仔细的配置、监控和故障排查，你可以建立一个可靠和高性能的消息处理系统。</p> 
<h3><a id="Kafka_361"></a>四、示例：生产和消费Kafka事务性消息</h3> 
<p>在这一节，我们将提供两个示例，详细展示如何生产和消费Kafka事务性消息。</p> 
<h4><a id="41_1_365"></a>4.1 示例1：生产事务性消息</h4> 
<h5><a id="1_367"></a>示例1代码：生产者</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionalProducerExample</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> bootstrapServers <span class="token operator">=</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">"my-transactional-topic"</span><span class="token punctuation">;</span>

        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> bootstrapServers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"acks"</span><span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"enable.idempotence"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"transactional.id"</span><span class="token punctuation">,</span> <span class="token string">"my-transactional-id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        producer<span class="token punctuation">.</span><span class="token function">initTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            producer<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProducerFencedException</span> <span class="token operator">|</span> <span class="token class-name">OutOfOrderSequenceException</span> <span class="token operator">|</span> <span class="token class-name">AuthorizationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Fenced, sequence issue, or authorization exception</span>
            producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KafkaException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Handle other exceptions</span>
            producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_408"></a>代码说明:</h5> 
<ul><li>这个示例演示了如何创建一个Kafka生产者，配置它以支持事务性消息，并生产一条事务性消息。</li><li><code>transactional.id</code>是一个用于标识生产者事务的唯一ID。它确保了事务性消息的一致性。</li><li>在<code>try</code>块中，我们使用<code>producer.beginTransaction()</code>来启动一个事务，然后发送一条消息，最后使用<code>producer.commitTransaction()</code>来提交事务。</li><li>如果在事务期间发生异常，我们在<code>catch</code>块中处理异常并关闭生产者。</li></ul> 
<h4><a id="42_2_415"></a>4.2 示例2：消费事务性消息</h4> 
<h5><a id="2_417"></a>示例2代码：消费者</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionalConsumerExample</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> bootstrapServers <span class="token operator">=</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> groupId <span class="token operator">=</span> <span class="token string">"my-consumer-group"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">"my-transactional-topic"</span><span class="token punctuation">;</span>

        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> bootstrapServers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumed record with key %s and value %s%n"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_450"></a>代码说明:</h5> 
<ul><li>这个示例演示了如何创建一个Kafka消费者，订阅一个主题，并消费事务性消息。</li><li>消费者将持续轮询主题以获取新的消息。</li><li>每当有新消息可用时，它将打印出消息的键和值。</li></ul> 
<h3><a id="_456"></a>五、总结</h3> 
<p>本文深入探讨了Kafka事务性消息的关键概念、应用场景、优势、配置、使用以及最佳实践。在总结中，让我们再次强调一些关键要点，并展望Kafka事务性消息的未来。</p> 
<ul><li><strong>Kafka事务性消息</strong>是一种机制，用于确保消息的可靠性传递和处理。它们提供了额外的保证，确保消息要么完全成功，要么完全失败。</li><li><strong>应用场景</strong>：Kafka事务性消息在金融交易、库存管理、订单处理等需要高可靠性和数据一致性的应用中发挥关键作用。</li><li><strong>优势</strong>：事务性消息相对于非事务性消息提供了更高的数据一致性和可靠性，支持原子性、幂等性和"仅一次"语义。</li><li><strong>配置</strong>：配置Kafka以支持事务性消息包括生产者和消费者的设置，如<code>transactional.id</code>、<code>enable.idempotence</code>等。</li><li><strong>生产事务性消息</strong>：使用Kafka生产者，需要初始化事务、发送消息，然后提交或中止事务，以确保消息的一致性。</li><li><strong>消费事务性消息</strong>：使用Kafka消费者，需要订阅主题并持续轮询以获取消息，然后确保消息被正确处理。</li><li><strong>最佳实践</strong>：最佳实践包括保障消息的一次交付、监控和故障排查以及性能考量，以确保系统的稳定性和高性能。</li></ul> 
<h3><a id="Spring_Boot_3_468"></a>六、Spring Boot 3核心技术与最佳实践</h3> 
<p><img src="https://images2.imgbox.com/1b/9b/ufNwjQzd_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1_472"></a>1、内容介绍</h4> 
<p>京东购买链接：<a href="https://item.jd.com/13710445.html" rel="nofollow">Spring Boot 3核心技术与最佳实践</a></p> 
<p>本书是一本针对Java开发人员的图书，旨在帮助Java开发人员掌握Spring Boot的基本使用，以及深入了解Spring Boot的应用及原理。</p> 
<p>本书内容由浅入深、循序渐进，第1～5章介绍Spring Boot的基础知识（基础入门、配置管理、Starter、自动配置、启动过程与扩展应用、日志管理），第6～9章介绍Spring Boot的综合应用（Web、数据访问、计划任务、缓存、消息队列），第10～12章介绍Spring Boot应用的附加能力（调试、单元测试、打包、部署、监控、报警），全面覆盖了Spring Boot的核心知识要点。</p> 
<p>本书涵盖了笔者多年的研究和实践经验，从中提炼出了核心知识要点，从Spring Boot的基本概念和基础实践入手，再通过大量的知识点分析及代码实践，详细介绍如何利用Spring Boot简化开发过程，提高开发效率。</p> 
<h4><a id="2_482"></a>2、作者简介</h4> 
<p>周红亮（英文名为John），具有多年编程开发和系统架构经验，在大型互联网公司担任过Java高发开发工程师、开发主管、系统架构师等职位。负责并参与过多个大型分布式系统的设计和研发、改造等，从中积累了大量的微服务系统架构经验。</p> 
<h4><a id="3_486"></a>3、参与方式</h4> 
<p>图书数量：本次送出 5 本《Spring Boot 3核心技术与最佳实践》 ！！！</p> 
<p>活动时间：截止到 2023-12-18 21:00:00</p> 
<p>🏆抽奖方式：</p> 
<p>⭐️⭐️<strong>点击下方名片，回复1218，即可参与</strong>⭐️⭐️</p> 
<p>🏆哪吒会在朋友圈公布中奖名单。</p> 
<p>名单公布时间：2023-12-18 21:10:00</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8cb92918d31cc43ed9ed7ef3f9404d5d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">DDSP-SVC-3.0完全指南：一步步教你用AI声音开启音乐之旅</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/56ad44a7169959b02b39ce38ea89cafd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">oracle与gbase8s迁移数据类型对照</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>