<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot中定时任务踩坑，@Scheduled重复执行问题排查（看完直接破防） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/0a57b19868321818245d80739d76de21/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="SpringBoot中定时任务踩坑，@Scheduled重复执行问题排查（看完直接破防）">
  <meta property="og:description" content="前言 今天再开发业务需求的过程中，需要用到定时任务，原本定的是每10分钟推送一次，可是当每次十分钟到的时候，定时任务就会推送多条！但是非常奇怪的是，本地调试的时候不会有问题，只有当你部署到到服务器上的时候才会暴露这个问题！！！！
如图：
这些消息都是一次性推送出来的，本来他们应该只有一条被推送出来的，可是现在他们却全都出来了，难道真是“一家人就要整整齐齐”吗？
解决思路 这种本地无法重现的问题解决起来最恼火了，于是乎我去网上寻找答案，看看有没有人遇到类似的情况！
其中两篇是这么说的:
文章连接：生产问题：@Scheduled Spring定时任务每次执行两次原因分析以及解决方案
文章连接：spring定时任务执行两次的原因与解决方法
他们的大概的意思就是因为他的配置到导致他的配置类被重复加载了两次，进而导致定时任务重复执行多次！
于是我就类比了一下，看到在我的项目中，确实使用了@EnableScheduling两次
第一次：
第二次：
于是我赶紧把启动类上的@EnableScheduling注解去掉，并祈祷能有用！
结果如我所料，果然没什么用！
于是我继续搜索，看到这样一篇文章：
当我看到这句话的时候，我甚至以为我已经接近真理了！
springboot关于定时任务执行多次的问题
但是当我看到他写的这些太乱了，而且一个简答的定时任务，被他搞得这么复杂，我果断放弃了。
头痛砍头？？？？ 我于是乎又接着找，我发现了这样一篇文章，特别逆天！！！
Springboot 使用 @Scheduled 定时任务生产环境执行两次
好家伙，你这好比你去医院看病，你和医生说：”医生我头痛，我该怎么办？“，医生说：”没事的哈，一会去把把头砍了，砍了就不痛了哈！“
接近真理 时间在一分一秒的过去，我却毫无紧张，甚至已经开始汗流浃背了，从未感到如此巨大之强度，于是乎我便去到了stackoverflow上搜索一下看看！
哎！你说好巧不巧，还真就让我找到问题了！
看到这样一条问题：
这不就是我遇到的问题吗？
他是这么说的：
I have a service which has to run a job to get and refresh it&#39;s data from another service. The job has to be run on startup and every couple of hours/days. I was looking into the behavior of the scheduled job and it seems to be called two times consecutively according to the logs (see below).">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-10T18:49:02+08:00">
    <meta property="article:modified_time" content="2024-04-10T18:49:02+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot中定时任务踩坑，@Scheduled重复执行问题排查（看完直接破防）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/ed/f7/FXdr1yaz_o.gif" alt="在这里插入图片描述"></p> 
<h3><a id="_2"></a>前言</h3> 
<p>今天再开发业务需求的过程中，需要用到定时任务，原本定的是每10分钟推送一次，可是当每次十分钟到的时候，定时任务就会推送多条！但是非常奇怪的是，本地调试的时候不会有问题，只有当你部署到到服务器上的时候才会暴露这个问题！！！！</p> 
<p>如图：<br> <img src="https://images2.imgbox.com/e2/e5/5mT2PbKc_o.png" alt=""><br> 这些消息都是一次性推送出来的，本来他们应该只有一条被推送出来的，可是现在他们却全都出来了，难道真是“一家人就要整整齐齐”吗？</p> 
<h3><a id="_11"></a>解决思路</h3> 
<p>这种本地无法重现的问题解决起来最恼火了，于是乎我去网上寻找答案，看看有没有人遇到类似的情况！<br> 其中两篇是这么说的:</p> 
<p><img src="https://images2.imgbox.com/00/8c/ae1eIytJ_o.png" alt=""></p> 
<p>文章连接：<a href="https://blog.csdn.net/u010886217/article/details/107429853">生产问题：@Scheduled Spring定时任务每次执行两次原因分析以及解决方案</a></p> 
<p><img src="https://images2.imgbox.com/af/17/k84p6NPg_o.png" alt=""></p> 
<p>文章连接：<a href="https://blog.csdn.net/qq_40606932/article/details/83617968">spring定时任务执行两次的原因与解决方法</a></p> 
<p>他们的大概的意思就是因为他的配置到导致他的配置类被重复加载了两次，进而导致定时任务重复执行多次！</p> 
<p>于是我就类比了一下，看到在我的项目中，确实使用了@EnableScheduling两次</p> 
<p>第一次：<br> <img src="https://images2.imgbox.com/10/1e/WqVXKQsN_o.png" alt=""></p> 
<p>第二次：</p> 
<p><img src="https://images2.imgbox.com/6d/56/RA3MaPjo_o.png" alt=""></p> 
<p>于是我赶紧把启动类上的@EnableScheduling注解去掉，并祈祷能有用！</p> 
<p>结果如我所料，果然没什么用！</p> 
<p>于是我继续搜索，看到这样一篇文章：</p> 
<p><img src="https://images2.imgbox.com/d4/68/KMHKaNw4_o.png" alt=""><br> 当我看到这句话的时候，我甚至以为我已经接近真理了！<br> <a href="https://blog.csdn.net/weixin_46243369/article/details/130945027">springboot关于定时任务执行多次的问题</a><br> 但是当我看到他写的这些太乱了，而且一个简答的定时任务，被他搞得这么复杂，我果断放弃了。</p> 
<h3><a id="_46"></a>头痛砍头？？？？</h3> 
<p>我于是乎又接着找，我发现了这样一篇文章，特别逆天！！！</p> 
<p><img src="https://images2.imgbox.com/73/99/a7mHpvca_o.png" alt=""><br> <a href="https://blog.csdn.net/OriginalSword/article/details/135392377">Springboot 使用 @Scheduled 定时任务生产环境执行两次</a></p> 
<p><img src="https://images2.imgbox.com/7d/7d/2i9Z79QV_o.png" alt=""></p> 
<p>好家伙，你这好比你去医院看病，你和医生说：”医生我头痛，我该怎么办？“，医生说：”没事的哈，一会去把把头砍了，砍了就不痛了哈！“</p> 
<p><img src="https://images2.imgbox.com/be/89/U7moPwIh_o.png" alt=""></p> 
<h3><a id="_60"></a>接近真理</h3> 
<p>时间在一分一秒的过去，我却毫无紧张，甚至已经开始汗流浃背了，从未感到如此巨大之强度，于是乎我便去到了<a href="https://stackoverflow.com/questions/62700643/scheduling-in-spring-schedule-and-enablescheduling-lead-to-multiple-calls-of" rel="nofollow">stackoverflow</a>上搜索一下看看！</p> 
<p>哎！你说好巧不巧，还真就让我找到问题了！<br> 看到这样一条问题：</p> 
<p><img src="https://images2.imgbox.com/69/8b/A3b58m23_o.png" alt=""><br> 这不就是我遇到的问题吗？<br> <img src="https://images2.imgbox.com/1c/e4/Psk0h2rF_o.gif" alt=""></p> 
<p>他是这么说的：</p> 
<p><code>I have a service which has to run a job to get and refresh it's data from another service. The job has to be run on startup and every couple of hours/days. I was looking into the behavior of the scheduled job and it seems to be called two times consecutively according to the logs (see below).</code></p> 
<p>我们来看他给的代码：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ServiceInterface</span> <span class="token punctuation">{<!-- --></span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">FetchService</span> fetchService<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">int</span> timesCalled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token class-name">Data</span> data<span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostConstruct</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    data <span class="token operator">=</span> fetchService<span class="token punctuation">.</span><span class="token function">getAndUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"* */5 * * * *"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>appContext<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"This object: "</span> <span class="token operator">+</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Times called: "</span> <span class="token operator">+</span>  timesCalled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timesCalled<span class="token operator">++</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> fetchService<span class="token punctuation">.</span><span class="token function">getAndUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>日志信息：</p> 
<pre><code>2020-07-02 17:30:00.006  INFO 30416 --- [   scheduling-1] c.d.p.d.service.ServiceImpl  : org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext@6db9cae5
2020-07-02 17:30:00.006  INFO 30416 --- [   scheduling-1] c.d.p.d.serice.ServiceImpl  : This object: 357813323
2020-07-02 17:30:00.006  INFO 30416 --- [   scheduling-1] c.d.p.d.service.ServiceImpl  : Times called: 1
....
2020-07-02 17:30:32.001  INFO 30416 --- [   scheduling-1] c.d.p.d.service.ServiceImpl  : org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext@6db9cae5
2020-07-02 17:30:32.001  INFO 30416 --- [   scheduling-1] c.d.p.d.service.ServiceImpl  : This object: 357813323
2020-07-02 17:30:32.001  INFO 30416 --- [   scheduling-1] c.d.p.d.service.ServiceImpl  : Times called: 2
</code></pre> 
<p>然后就有网友给他解释道：正如你所写的，你的cron表达式是 <code>* */5 * * * * </code>，这意味着，根据Spring指南，它将每隔5分钟运行一次：</p> 
<p>你写的代码不就是下面这样吗？</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"* */5 * * * *"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Times called: "</span> <span class="token operator">+</span>  timesCalled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timesCalled<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们来测试一下吧：</p> 
<pre><code>14:20:13.001  INFO 8980 --- [   sch-1] com.example.demo.Sched   : Times called: 13
14:20:14.001  INFO 8980 --- [   sch-1] com.example.demo.Sched   : Times called: 14
14:20:15.003  INFO 8980 --- [   sch-1] com.example.demo.Sched   : Times called: 15
14:20:59.002  INFO 8980 --- [   sch-1] com.example.demo.Sched   : Times called: 59
14:25:00.000  INFO 8980 --- [   sch-1] com.example.demo.Sched   : Times called: 60
14:25:01.000  INFO 8980 --- [   sch-1] com.example.demo.Sched   : Times called: 61
14:25:02.001  INFO 8980 --- [   sch-1] com.example.demo.Sched   : Times called: 62
14:25:03.002  INFO 8980 --- [   sch-1] com.example.demo.Sched   : Times called: 63
</code></pre> 
<p>从日志我们可以看出，他确实是在每五分钟执行一次，可是执行完了，他在第五分钟内还将重复执行！所以我们会看到业务代码被执行了很多次！如果你想每五分钟只执行一次的话，你应该这样写：<code>@Scheduled(cron = "0 */5 * * * *")</code></p> 
<h3><a id="_134"></a>成功解救</h3> 
<p>我一看我的代码也是这样写的：</p> 
<p><img src="https://images2.imgbox.com/cb/8a/0mDPFzY3_o.png" alt=""><br> 赶紧改过来，问题就解决了！这下对spring的corn表达式理解又加深了！同时有问题可去stackoverflow上搜一下，很有用！！</p> 
<h3><a id="_140"></a>最后的疑问</h3> 
<p>为什么本地调试我<code>0 */5 * * * *</code>这样写和<code>* */5 * * * *</code>都只执行一次，而到线上的时候就会执行多次，有谁能知道这是为什么？</p> 
<p><img src="https://images2.imgbox.com/0c/69/HfN6cCiy_o.gif" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/63a1a1095a7c6e925bafc4a7cd6d6209/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JS中的JSON（秒懂如何操作JSON）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e2512d0bcf699958ac1f891d433a4bc4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">讯飞星火等10个生成式AI平台对比分析 附网址 全部免费 [ 讯飞星火、智谱清言、天工 AI、Kimi AI、通义千问、文心一言、腾讯混元、豆包 AI、海螺 AI、360智脑 ]</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>