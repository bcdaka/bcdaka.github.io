<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>阿里云上kubesphere安装配置 - 使用阿里云负载均衡 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/a66d1d5d89914ac785188e856c668a60/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="阿里云上kubesphere安装配置 - 使用阿里云负载均衡">
  <meta property="og:description" content="教程参考 https://www.kubesphere.io/zh/docs/v3.3/installing-on-linux/public-cloud/install-kubesphere-on-ali-ecs/
环境配置 关闭防火墙关闭selinux关闭swap分区时间同步hosts解析内核参数设置检查DNS安装ipvs安装依赖组件安装、设置docker 每台机器都需要操作
#安装工具 yum -y install net-tools # 如果下载不行，设置一个repo # sed -i &#39;s/mirrorlist/#mirrorlist/g&#39; /etc/yum.repos.d/CentOS-* # sed -i &#39;s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g&#39; /etc/yum.repos.d/CentOS-* ##关闭防火墙 systemctl stop firewalld.service systemctl disable firewalld.service ##时间同步 yum install ntpdate -y ntpdate pool.ntp.org timedatectl set-timezone Asia/Shanghai # 将 SELinux 设置为 permissive 模式（相当于将其禁用） sudo setenforce 0 sudo sed -i &#39;s/^SELINUX=enforcing$/SELINUX=permissive/&#39; /etc/selinux/config #关闭swap swapoff -a sed -ri &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab #允许 iptables 检查桥接流量 cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf br_netfilter EOF cat &lt;&lt;EOF | sudo tee /etc/sysctl.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-09T15:59:37+08:00">
    <meta property="article:modified_time" content="2024-07-09T15:59:37+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">阿里云上kubesphere安装配置 - 使用阿里云负载均衡</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>教程参考</h3> 
<p>https://www.kubesphere.io/zh/docs/v3.3/installing-on-linux/public-cloud/install-kubesphere-on-ali-ecs/</p> 
<h4><a id="_3"></a>环境配置</h4> 
<ul><li>关闭防火墙</li><li>关闭selinux</li><li>关闭swap分区</li><li>时间同步</li><li>hosts解析</li><li>内核参数设置</li><li>检查DNS</li><li>安装ipvs</li><li>安装依赖组件</li><li>安装、设置docker</li></ul> 
<blockquote> 
 <p>每台机器都需要操作</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment">#安装工具</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> net-tools

<span class="token comment"># 如果下载不行，设置一个repo</span>
<span class="token comment"># sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*</span>
<span class="token comment"># sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*</span>


<span class="token comment">##关闭防火墙</span>
systemctl   stop     firewalld.service
systemctl   disable   firewalld.service


<span class="token comment">##时间同步</span>
yum <span class="token function">install</span> ntpdate <span class="token parameter variable">-y</span>
ntpdate  pool.ntp.org
timedatectl set-timezone Asia/Shanghai


<span class="token comment"># 将 SELinux 设置为 permissive 模式（相当于将其禁用）</span>
<span class="token function">sudo</span> setenforce <span class="token number">0</span>
<span class="token function">sudo</span> <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/^SELINUX=enforcing$/SELINUX=permissive/'</span> /etc/selinux/config


<span class="token comment">#关闭swap</span>
swapoff <span class="token parameter variable">-a</span>  
<span class="token function">sed</span> <span class="token parameter variable">-ri</span> <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab


<span class="token comment">#允许 iptables 检查桥接流量</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/k8s.conf</span>
br_netfilter
EOF</span>


<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/k8s.conf</span>
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF</span>
<span class="token function">sudo</span> <span class="token function">sysctl</span> <span class="token parameter variable">--system</span>
</code></pre> 
<h5><a id="Docker_62"></a>安装Docker</h5> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> yum remove docker*
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils


<span class="token comment">#配置docker的yum地址</span>
<span class="token function">sudo</span> yum-config-manager <span class="token punctuation">\</span>
--add-repo <span class="token punctuation">\</span>
http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo



<span class="token comment">#安装指定版本</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> docker-ce-20.10.7 docker-ce-cli-20.10.7 containerd.io-1.4.6


<span class="token comment">#安装 </span>
<span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> socat conntrack nfs-utils


<span class="token comment"># 启动&amp;开机启动docker</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span> <span class="token parameter variable">--now</span>


<span class="token comment"># docker加速配置</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/docker
<span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
{
  "registry-mirrors": ["https://m7qysq7c.mirror.aliyuncs.com"],
  "exec-opts": ["native.cgroupdriver=systemd"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m"
  },
  "storage-driver": "overlay2"
}
EOF</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>
</code></pre> 
<p>完成后可以制作镜像</p> 
<blockquote> 
 <p>安装实例选择 k8s_base_image_2，已经完成部分设置<br> <img src="https://images2.imgbox.com/db/99/qt4AVXja_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h4><a id="master_109"></a>首次安装-选取一台master</h4> 
<pre><code class="prism language-shell"><span class="token builtin class-name">export</span> <span class="token assign-left variable">KKZONE</span><span class="token operator">=</span>cn
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get-kk.kubesphere.io <span class="token operator">|</span> <span class="token assign-left variable">VERSION</span><span class="token operator">=</span>v3.0.7 <span class="token function">sh</span> -
<span class="token function">chmod</span> +x kk
./kk create config --with-kubesphere v3.3.2 --with-kubernetes v1.22.12 <span class="token parameter variable">-f</span> config-sample.yaml
</code></pre> 
<p>修改部分配置</p> 
<h4><a id="configyaml_117"></a>config.yaml</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubekey.kubesphere.io/v1alpha2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Cluster
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> sample
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">name</span><span class="token punctuation">:</span> master1<span class="token punctuation">,</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> 172.31.0.239<span class="token punctuation">,</span> <span class="token key atrule">internalAddress</span><span class="token punctuation">:</span> 172.31.0.239<span class="token punctuation">,</span> <span class="token key atrule">user</span><span class="token punctuation">:</span> root<span class="token punctuation">,</span> <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"Hailiao$123"</span><span class="token punctuation">}</span>
  <span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">name</span><span class="token punctuation">:</span> master2<span class="token punctuation">,</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> 172.31.0.237<span class="token punctuation">,</span> <span class="token key atrule">internalAddress</span><span class="token punctuation">:</span> 172.31.0.237<span class="token punctuation">,</span> <span class="token key atrule">user</span><span class="token punctuation">:</span> root<span class="token punctuation">,</span> <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"Hailiao$123"</span><span class="token punctuation">}</span>
  <span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">name</span><span class="token punctuation">:</span> master3<span class="token punctuation">,</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> 172.31.0.238<span class="token punctuation">,</span> <span class="token key atrule">internalAddress</span><span class="token punctuation">:</span> 172.31.0.238<span class="token punctuation">,</span> <span class="token key atrule">user</span><span class="token punctuation">:</span> root<span class="token punctuation">,</span> <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"Hailiao$123"</span><span class="token punctuation">}</span>
  <span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span><span class="token key atrule">name</span><span class="token punctuation">:</span> node1<span class="token punctuation">,</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> 172.31.0.243<span class="token punctuation">,</span> <span class="token key atrule">internalAddress</span><span class="token punctuation">:</span> 172.31.0.243<span class="token punctuation">,</span> <span class="token key atrule">user</span><span class="token punctuation">:</span> root<span class="token punctuation">,</span> <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"Hailiao$123"</span><span class="token punctuation">}</span>
  <span class="token key atrule">roleGroups</span><span class="token punctuation">:</span>
    <span class="token key atrule">etcd</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master1
    <span class="token punctuation">-</span> master2
    <span class="token punctuation">-</span> master3
    <span class="token key atrule">control-plane</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> master1
    <span class="token punctuation">-</span> master2
    <span class="token punctuation">-</span> master3
    <span class="token key atrule">worker</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> node1
  <span class="token key atrule">controlPlaneEndpoint</span><span class="token punctuation">:</span>
    <span class="token comment">## Internal loadbalancer for apiservers </span>
    <span class="token comment">## internalLoadbalancer: haproxy</span>
	<span class="token comment"># 阿里云的负载均衡</span>
    <span class="token key atrule">domain</span><span class="token punctuation">:</span> lb.kubesphere.local
    <span class="token key atrule">address</span><span class="token punctuation">:</span> <span class="token string">"1xx.xx.xx.xx"</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6443</span>
  <span class="token key atrule">kubernetes</span><span class="token punctuation">:</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.22.12
    <span class="token key atrule">clusterName</span><span class="token punctuation">:</span> cluster.local
    <span class="token key atrule">autoRenewCerts</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">containerManager</span><span class="token punctuation">:</span> docker
  <span class="token key atrule">etcd</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> kubekey
  <span class="token key atrule">network</span><span class="token punctuation">:</span>
    <span class="token key atrule">plugin</span><span class="token punctuation">:</span> calico
    <span class="token key atrule">kubePodsCIDR</span><span class="token punctuation">:</span> 10.233.64.0/18
    <span class="token key atrule">kubeServiceCIDR</span><span class="token punctuation">:</span> 10.233.0.0/18
    <span class="token comment">## multus support. https://github.com/k8snetworkplumbingwg/multus-cni</span>
    <span class="token key atrule">multusCNI</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">privateRegistry</span><span class="token punctuation">:</span> <span class="token string">""</span>
    <span class="token key atrule">namespaceOverride</span><span class="token punctuation">:</span> <span class="token string">""</span>
    <span class="token key atrule">registryMirrors</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">insecureRegistries</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token key atrule">addons</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
    <span class="token key atrule">sources</span><span class="token punctuation">:</span>
      <span class="token key atrule">chart</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
        <span class="token key atrule">repo</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//charts.kubesphere.io/main
        <span class="token key atrule">valuesFile</span><span class="token punctuation">:</span> /root/nfs<span class="token punctuation">-</span>client.yaml
</code></pre> 
<blockquote> 
 <p>没有全部复制，主要是完成了nfs初始化使用nas</p> 
</blockquote> 
<h4><a id="nfsclientyaml_177"></a>nfs-client.yaml</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">nfs</span><span class="token punctuation">:</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span> <span class="token string">"xxx.nas.aliyuncs.com"</span>    <span class="token comment"># 阿里云Nas地址.</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/new_ks_data"</span>    <span class="token comment"># Replace the exported directory with your own.</span>
<span class="token key atrule">storageClass</span><span class="token punctuation">:</span>
  <span class="token key atrule">defaultClass</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> 
<h3><a id="_186"></a>运行安装</h3> 
<pre><code>./kk create cluster -f config.yaml
</code></pre> 
<h4><a id="hostnamehosts_191"></a>选择这个镜像后，只需要设置hostname和hosts</h4> 
<p>每台机器使用内网ip互通</p> 
<p>每台机器配置自己的hostname 每个机器分别执行 hostnamectl set-hostname xxx （node1～6）</p> 
<pre><code class="prism language-shell">hostnamectl set-hostname node1  <span class="token comment"># node1 就是对应的主机名称</span>

<span class="token function">vim</span> /etc/hosts

<span class="token comment"># 添加hosts信息</span>
<span class="token number">172.31</span>.0.239   master1
<span class="token number">172.31</span>.0.237   master2
<span class="token number">172.31</span>.0.238   master3
<span class="token number">172.31</span>.0.243   node1
<span class="token comment"># 对应添加更多node主机名称</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/89e830b30b2e489c00720dc137fc29e5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringBoot报错：The field file exceeds its maximum permitted size of 1048576 bytes</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3bca887f85a99890ef255ab6b27e934d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">苹果电脑玩游戏咋样 苹果电脑能玩什么游戏 mac支持的steam游戏 好玩的苹果电脑游戏推荐</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>