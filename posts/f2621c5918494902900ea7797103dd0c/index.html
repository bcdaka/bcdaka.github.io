<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>奇怪的Excel单元格字体颜色格式 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/f2621c5918494902900ea7797103dd0c/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="奇怪的Excel单元格字体颜色格式">
  <meta property="og:description" content="使用VBA代码修改单元格全部字符字体颜色是个很简单的任务，例如设置A1单元格字体颜色为红色。
Range(&#34;A1&#34;).Font.Color = RGB(255, 0, 0) 有时需要修改部分字符的颜色，如下图所示，将红色字符字体颜色修改为蓝色。代码将会稍许复杂，需要使用Characters设置逐个字符的字体颜色。
先使用代码来读取单元格的字体颜色。
Sub CheckFontColor() Dim c As Range, i As Long Set c = Range(&#34;A1&#34;) For i = 1 To Len(c.Value) With c.Characters(i, 1).Font Debug.Print i, .Color End With Next End Sub 输出如下所示，前5个字符和最后两个字符为红色。
1 255 2 255 3 255 4 255 5 255 6 0 7 0 8 255 9 255 略加修改，逐个字符判断字体颜色，修改红色字符为蓝色。
Sub ChangeColor1() Dim c As Range, i As Long, ColS As Long, ColE As Long Range(&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-24T21:15:16+08:00">
    <meta property="article:modified_time" content="2024-07-24T21:15:16+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">奇怪的Excel单元格字体颜色格式</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>使用VBA代码修改单元格全部字符字体颜色是个很简单的任务，例如设置A1单元格字体颜色为红色。</p> 
<pre><code class="prism language-vb">Range("A1").Font.Color = RGB(255, 0, 0)
</code></pre> 
<p>有时需要修改部分字符的颜色，如下图所示，将红色字符字体颜色修改为蓝色。代码将会稍许复杂，需要使用<code>Characters</code>设置逐个字符的字体颜色。</p> 
<p><img src="https://images2.imgbox.com/cb/9d/UKfPgI7b_o.png" alt="在这里插入图片描述"></p> 
<p>先使用代码来读取单元格的字体颜色。</p> 
<pre><code class="prism language-vb">Sub CheckFontColor()
    Dim c As Range, i As Long
    Set c = Range("A1")
    For i = 1 To Len(c.Value)
        With c.Characters(i, 1).Font
            Debug.Print i, .Color
        End With
    Next
End Sub
</code></pre> 
<p>输出如下所示，前5个字符和最后两个字符为红色。</p> 
<pre><code> 1             255 
 2             255 
 3             255 
 4             255 
 5             255 
 6             0 
 7             0 
 8             255 
 9             255 
</code></pre> 
<p>略加修改，逐个字符判断字体颜色，修改红色字符为蓝色。</p> 
<pre><code class="prism language-vb">Sub ChangeColor1()
    Dim c As Range, i As Long, ColS As Long, ColE As Long
    Range("A1").Copy Range("A2")
    ColS = RGB(255, 0, 0)
    ColE = RGB(0, 0, 255)
    Set c = Range("A2")
    For i = 1 To Len(c.Value)
        With c.Characters(i, 1).Font
            If .Color = ColS Then
                .Color = ColE
            End If
        End With
    Next
End Sub
</code></pre> 
<p>运行代码过程ChangeColor1，结果和想象的并不相同，如下所示。前5个字符的删除线消失了，最后两个字符的颜色仍然是红色。</p> 
<p><img src="https://images2.imgbox.com/0b/e3/WSWvt5AN_o.png" alt="在这里插入图片描述"></p> 
<p>为什么会出现这个奇怪的结果呢？增加部分代码来看一下执行过程。</p> 
<pre><code class="prism language-vb">Sub ChangeColor2()
    Dim c As Range, i As Long, ColS As Long, ColE As Long
    Range("A1").Copy Range("A2")
    ColS = RGB(255, 0, 0)
    ColE = RGB(0, 0, 255)
    Set c = Range("A2")
    Debug.Print "before change color"
    Call CheckColor
    For i = 1 To Len(c.Value)
        With c.Characters(i, 1).Font
            If .Color = ColS Then
                .Color = ColE
            End If
        End With
        Debug.Print i
        Call CheckColor
    Next
End Sub

Sub CheckColor()
    Debug.Print Range("A1").Characters(11, 1).Font.Color, Range("A2").Characters(11, 1).Font.Color
    Debug.Print Range("A1").Characters(12, 1).Font.Color, Range("A2").Characters(12, 1).Font.Color
End Sub
</code></pre> 
<p>部分输出结果如下：</p> 
<pre><code class="prism language-vb">before change color
 255           255 
 255           255 
 1 
 255           16711680 
 255           16711680 
 2 
 255           16711680 
 255           16711680 
 3 
 255           16711680 
 255           16711680 
</code></pre> 
<p>执行For循环之前，A1和A2单元格内容完全相同，最后两个字符的颜色均为红色，然而执行循环第一次之后，也就是第一个字符修改为蓝色，此时最后两个字符的颜色被修改为了16711680（即RGB(0,0,255)），但是此时单元格中的最后两个字符仍然显示为红色，这个应该是Excel的BUG.</p> 
<p>执行循环第一次之后，第一个字符有删除线格式，后面几个字符的删除线已经消失，执行第二次循环之后，第二字符字体颜色被修改为蓝色，但是第一个字符的删除线格式消失了。由于最后两个字符的Font.Color的返回值不再是255，因此后续代码不会更新那两个字符的字体颜色，最终仍然为红色字符。</p> 
<p><img src="https://images2.imgbox.com/53/83/zqDU4qLG_o.png" alt="在这里插入图片描述"></p> 
<p>VBA处理这种复合字体格式（单元格中的字符具备多种不同的字体格式）会出现这种诡异的现象，但是也是有变通方法可以实现这个需求的。</p> 
<pre><code class="prism language-vb">Type FontStyle
    Color As Long
    Strikethrough As Boolean
End Type
Sub ChangeColor3()
    Dim c As Range, i As Long, ColS As Long, ColE As Long
    Dim CellFont() As FontStyle
    ColS = RGB(255, 0, 0)
    ColE = RGB(0, 0, 255)
    Range("A1").Copy Range("A2")
    Set c = Range("A2")
    ReDim CellFont(1 To Len(c.Value))
    For i = 1 To Len(c.Value)
        With c.Characters(i, 1).Font
            CellFont(i).Color = .Color
            CellFont(i).Strikethrough = .Strikethrough
        End With
    Next
    For i = 1 To Len(c.Value)
        With c.Characters(i, 1).Font
            If CellFont(i).Color = ColS Then
                .Color = ColE
            Else
                .Color = CellFont(i).Color
            End If
            .Strikethrough = CellFont(i).Strikethrough
        End With
    Next
End Sub
</code></pre> 
<p>【代码解析】<br> 第1~4行代码声明自定义数据结构。<br> 第13~18行代码将每个字符的字体属性保存在数组CellFont中。<br> 第19~28行代码循环遍历每个字符。<br> 第21行代码判断字符颜色，如果颜色匹配，第22行代码更新字符的字体颜色，否则第24行代码恢复字符的原字体颜色。<br> 此处使用CellFont(i).Color，避免更新字符字体格式对于其他字符格式的影响。<br> 第26行代码恢复字符的删除线格式。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/10209430ad6e105d50b5a6587519425a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">{Spring Boot 原理篇} Spring Boot自动装配原理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4825f70f0d0641da95db014dc47b282f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Hive基础知识大全</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>