<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Node.js身份验证实践：Express-JWT和JSON Web Token的用法 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/b99777c9b3e34b20cde999282f800480/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Node.js身份验证实践：Express-JWT和JSON Web Token的用法">
  <meta property="og:description" content="目录
🎉前言
🎉准备工作
🎉实现生成token
🎉配置token校验
🎉完成获取用户信息接口
🎉配置校验错误的中间件
🎉总结
🎉前言 在构建Node.js应用时，安全性是一个至关重要的方面。本博客旨在解决如何在Express框架中实现令牌生成的问题，使用express-jwt和jsonwebtoken这两个流行的库来确保你的应用程序在身份验证方面具有强大的安全性。
token的作用
身份验证（Authentication）：
证明身份： Token 用于证明用户的身份。当用户通过用户名和密码进行登录后，服务器会颁发一个 Token 给客户端。客户端在后续的请求中携带这个 Token，服务器通过验证 Token 来确认用户的身份，而不需要再次提供用户名和密码。这种方式避免了在每个请求中传输敏感的用户名和密码。无状态性： Tokens 可以使系统实现无状态的身份验证，因为每次请求都包含了足够的信息（Token）来识别和验证用户，而不需要在服务器端保存用户的登录状态。 授权（Authorization）：
访问控制： Token 用于授权用户对特定资源的访问权限。服务器在验证用户身份后，生成包含权限信息的 Token，并将其返回给客户端。客户端在后续请求中携带 Token，服务器通过解析 Token 中的权限信息来确定用户是否被授权访问请求的资源。减轻服务器压力： 使用 Token 进行授权可以减轻服务器的负担，因为服务器无需在每个请求中都重新验证用户的身份和权限，而只需验证 Token 的有效性。 总的来说，Token在身份验证和授权方面提供了一种安全、高效的机制。通过使用 Token，可以实现无状态的身份验证、提高系统的安全性，同时减轻服务器的压力，提高系统的性能。
🎉准备工作 构建express应用，安装需要用到的库
npm i express npm i express-jwt npm i jsonwebtoken express-jwt 是用于在 Express 应用程序中验证 JSON Web Tokens (JWT) 的中间件。它可以帮助你确保只有经过身份验证的用户才能访问受保护的路由或资源。
jsonwebtoken 是用来生成客户端需要的token
搭建出基本的express应用
const express = require(&#39;express&#39;) const app = express() app.listen(3000, console.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-31T05:00:00+08:00">
    <meta property="article:modified_time" content="2024-01-31T05:00:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Node.js身份验证实践：Express-JWT和JSON Web Token的用法</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%F0%9F%8E%89%E5%89%8D%E8%A8%80-toc" style="margin-left:0px;"><a href="#%F0%9F%8E%89%E5%89%8D%E8%A8%80" rel="nofollow">🎉前言</a></p> 
<p id="%F0%9F%8E%89%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-toc" style="margin-left:0px;"><a href="#%F0%9F%8E%89%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C" rel="nofollow">🎉准备工作</a></p> 
<p id="%F0%9F%8E%89%E5%AE%9E%E7%8E%B0%E7%94%9F%E6%88%90token-toc" style="margin-left:0px;"><a href="#%F0%9F%8E%89%E5%AE%9E%E7%8E%B0%E7%94%9F%E6%88%90token" rel="nofollow">🎉实现生成token</a></p> 
<p id="%F0%9F%8E%89%E9%85%8D%E7%BD%AEtoken%E6%A0%A1%E9%AA%8C-toc" style="margin-left:0px;"><a href="#%F0%9F%8E%89%E9%85%8D%E7%BD%AEtoken%E6%A0%A1%E9%AA%8C" rel="nofollow">🎉配置token校验</a></p> 
<p id="%F0%9F%8E%89%E5%AE%8C%E6%88%90%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E6%8E%A5%E5%8F%A3-toc" style="margin-left:0px;"><a href="#%F0%9F%8E%89%E5%AE%8C%E6%88%90%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E6%8E%A5%E5%8F%A3" rel="nofollow">🎉完成获取用户信息接口</a></p> 
<p id="%F0%9F%8E%89%E9%85%8D%E7%BD%AE%E6%A0%A1%E9%AA%8C%E9%94%99%E8%AF%AF%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6-toc" style="margin-left:0px;"><a href="#%F0%9F%8E%89%E9%85%8D%E7%BD%AE%E6%A0%A1%E9%AA%8C%E9%94%99%E8%AF%AF%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6" rel="nofollow">🎉配置校验错误的中间件</a></p> 
<p id="%F0%9F%8E%89%E6%80%BB%E7%BB%93-toc" style="margin-left:0px;"><a href="#%F0%9F%8E%89%E6%80%BB%E7%BB%93" rel="nofollow">🎉总结</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%F0%9F%8E%89%E5%89%8D%E8%A8%80">🎉前言</h2> 
<blockquote> 
 <p>在构建Node.js应用时，安全性是一个至关重要的方面。本博客旨在解决如何在Express框架中实现令牌生成的问题，使用express-jwt和jsonwebtoken这两个流行的库来确保你的应用程序在身份验证方面具有强大的安全性。</p> 
</blockquote> 
<p id="token%E7%9A%84%E4%BD%9C%E7%94%A8"><strong>token的作用</strong></p> 
<p><strong>身份验证（Authentication）：</strong></p> 
<ul><li><strong>证明身份：</strong> Token 用于证明用户的身份。当用户通过用户名和密码进行登录后，服务器会颁发一个 Token 给客户端。客户端在后续的请求中携带这个 Token，服务器通过验证 Token 来确认用户的身份，而不需要再次提供用户名和密码。这种方式避免了在每个请求中传输敏感的用户名和密码。</li><li><strong>无状态性：</strong> Tokens 可以使系统实现无状态的身份验证，因为每次请求都包含了足够的信息（Token）来识别和验证用户，而不需要在服务器端保存用户的登录状态。</li></ul> 
<p><strong>授权（Authorization）：</strong></p> 
<ul><li><strong>访问控制：</strong> Token 用于授权用户对特定资源的访问权限。服务器在验证用户身份后，生成包含权限信息的 Token，并将其返回给客户端。客户端在后续请求中携带 Token，服务器通过解析 Token 中的权限信息来确定用户是否被授权访问请求的资源。</li><li><strong>减轻服务器压力：</strong> 使用 Token 进行授权可以减轻服务器的负担，因为服务器无需在每个请求中都重新验证用户的身份和权限，而只需验证 Token 的有效性。</li></ul> 
<blockquote> 
 <p>总的来说，Token在身份验证和授权方面提供了一种安全、高效的机制。通过使用 Token，可以实现无状态的身份验证、提高系统的安全性，同时减轻服务器的压力，提高系统的性能。</p> 
</blockquote> 
<h2 id="%F0%9F%8E%89%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">🎉准备工作</h2> 
<p> 构建express应用，安装需要用到的库</p> 
<pre><code class="hljs">npm i express
npm i express-jwt
npm i jsonwebtoken</code></pre> 
<p><strong>express-jwt</strong> 是用于在 Express 应用程序中验证 JSON Web Tokens (JWT) 的中间件。它可以帮助你确保只有经过身份验证的用户才能访问受保护的路由或资源。</p> 
<p><strong>jsonwebtoken </strong>是用来生成客户端需要的token</p> 
<p>搭建出基本的express应用</p> 
<pre><code class="language-javascript">const express = require('express')
const app = express()


app.listen(3000, console.log('server is running on port 3000'))
</code></pre> 
<p>只是做一个案例</p> 
<p>可以新建这样的三个文件</p> 
<p><img alt="" height="163" src="https://images2.imgbox.com/91/52/GZsco0SU_o.png" width="435"></p> 
<p><strong>config.js</strong></p> 
<pre><code class="language-javascript">module.exports = {
  jwtSecretKey: 'mima', // jwt加密的密钥
  expiresIn: '1h' // token过期时间
}
</code></pre> 
<h2 id="%F0%9F%8E%89%E5%AE%9E%E7%8E%B0%E7%94%9F%E6%88%90token">🎉实现生成token</h2> 
<p>首先看登录接口中生成token</p> 
<pre><code class="language-javascript">const express = require('express')
const jwt = require('jsonwebtoken')
const config = require('./config')
//路由
const router = express.Router()

//路由中间件
router.get('/login', (req, res) =&gt; {
  //生成token
  const user = {
    id: '1',
    username: 'zhangsan',
    password: '123'
  }
  //这里的user对象会被传递给jwt.sign方法中，
  //生成的token中会包含id和username，password三个属性，后面不需要用户传入也能在token中获取到这些信息
  const token = jwt.sign(user, config.jwtSecretKey, {
    expiresIn: config.expiresIn
  })
  res.send({
    code: 200,
    msg: '登录成功',
    token: 'Bearer ' + token
  })
})

module.exports = router
</code></pre> 
<blockquote> 
 <p>注意这里的user对象一般情况下是从数据库拿来的，这里只是模拟一下，生成的token中会包含id和username，password三个属性，后面不需要用户传入也能在token中获取到这些信息，等会在获取用户信息的接口中会看到。</p> 
</blockquote> 
<p>这里为什么要在生成的token前加上Bearer，Bearer 是一种身份验证方案类型（Authentication Scheme）。Bearer 作为一个字符串附加到 Token 前面，构成了一种规范的表示方式，即 Bearer Token。 即是一种统一的标准规范。</p> 
<p>记住需要在app.js中注册路由</p> 
<pre><code class="language-javascript">const loginRouter = require('./loginRouter')
app.use('/api', loginRouter)</code></pre> 
<p>我这里使用postman测试了</p> 
<p><img alt="" height="881" src="https://images2.imgbox.com/09/5b/KXvb1bDp_o.png" width="1200"></p> 
<p>可以看到token已经生成了</p> 
<h2 id="%F0%9F%8E%89%E9%85%8D%E7%BD%AEtoken%E6%A0%A1%E9%AA%8C">🎉配置token校验</h2> 
<pre><code class="language-javascript">const express = require('express')
const app = express()
const expressJWT = require('express-jwt')
const config = require('./config')
//配置jwt中间件
app.use(expressJWT({ secret: config.jwtSecretKey }).unless({ path: [/^\/api/] }))
//unless({ path: [/^\/api/] }) 
//意思就是除了/api开头的请求都验证，其他请求都需要验证token
const loginRouter = require('./loginRouter')
app.use('/api', loginRouter)


app.listen(3000, console.log('server is running on port 3000'))
</code></pre> 
<p>注意后面的unless，意思就是除了/api开头的请求都验证，其他请求都需要验证token。</p> 
<p>这时候我们可以将/api改成其他的<img alt="" height="91" src="https://images2.imgbox.com/dc/97/gPuPytr8_o.png" width="769"></p> 
<p>这样登录接口就会出现问题，没有token会被拦截</p> 
<p><img alt="" height="881" src="https://images2.imgbox.com/bb/24/syu0URXe_o.png" width="1200"> </p> 
<p> 这时候我们就需要拿着之前生成的token填入到headers中，才能调用接口</p> 
<h2 id="%F0%9F%8E%89%E5%AE%8C%E6%88%90%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E6%8E%A5%E5%8F%A3">🎉完成获取用户信息接口</h2> 
<pre><code class="language-javascript">const express = require('express')
const router = express.Router()

router.get('/getUser', (req, res) =&gt; {
  const { username, id, password } = req.user
  res.send({
    code: 200,
    msg: '获取用户成功',
    data: {
      username,
      id,
      password
    }
  })
})

module.exports = router
</code></pre> 
<blockquote> 
 <p>因为在生成token时，将user对象一起加进去了，所以在生成的token中会携带这些信息，我们可以在req.user中拿到这些信息。</p> 
</blockquote> 
<p>记得在app.js中注册路由</p> 
<pre><code class="language-javascript">const userRouter = require('./getUserRouter')
app.use('/user', userRouter)
</code></pre> 
<p>测试接口</p> 
<p>如果没有携带token，就会这样</p> 
<p><img alt="" height="881" src="https://images2.imgbox.com/01/6a/uJ6eWGmJ_o.png" width="1200"></p> 
<p>在headers中携带token</p> 
<p><img alt="" height="881" src="https://images2.imgbox.com/35/a9/5CtzUdVc_o.png" width="1200"></p> 
<h2 id="%F0%9F%8E%89%E9%85%8D%E7%BD%AE%E6%A0%A1%E9%AA%8C%E9%94%99%E8%AF%AF%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6">🎉配置校验错误的中间件</h2> 
<p>如果没有携带token，或者是token过期了，我们都得将错误信息相应给客户端，而不是直接报错，这样会影响我们整个程序的运行。</p> 
<pre><code class="language-javascript">//配置验证错误中间件
app.use(function (err, req, res, next) {
  console.log(err)
})</code></pre> 
<p>我们可以先测试二种情况得到的err有什么不一样</p> 
<p><strong>无效的token</strong></p> 
<p><img alt="" height="236" src="https://images2.imgbox.com/ea/4a/0NK6R47k_o.png" width="351"></p> 
<p><strong>token过期</strong></p> 
<p><img alt="" height="213" src="https://images2.imgbox.com/ea/a3/GwL2Ka9D_o.png" width="434"></p> 
<p>如果想要简单点可以直接这样</p> 
<pre><code class="language-javascript">app.use(function (err, req, res, next) {
  if (err.name === 'UnauthorizedError') {
    res.status(401).send(err.message)
  }
})</code></pre> 
<p>如果想要中文的相应可以这样</p> 
<pre><code class="language-javascript">app.use(function (err, req, res, next) {
   if (err.name === 'UnauthorizedError' &amp;&amp; err.message === 'invalid token') {
     res.status(401).send('无效的token')
   }
   if (err.name === 'UnauthorizedError' &amp;&amp; err.message === 'jwt expired') {
     res.status(401).send('token过期')
   }
})</code></pre> 
<p>这样整个程序就不会被打断了</p> 
<h2 id="%F0%9F%8E%89%E6%80%BB%E7%BB%93">🎉总结</h2> 
<ol><li> <p><strong>JWT 的作用：</strong> JSON Web Token（JWT）在应用程序中充当了身份验证和授权的关键工具。它通过在生成的令牌中携带用户信息，实现了无状态的身份验证，避免了传输敏感信息，同时提高了应用的安全性。</p> </li><li> <p><strong>express-jwt 的核心功能：</strong> <code>express-jwt</code> 主要用于验证从客户端发送的包含 JWT 的请求头。它帮助我们确认用户的身份是否有效，并在认证成功后将用户信息附加到请求对象上，方便后续处理。</p> </li><li> <p><strong>生成和使用 Token：</strong> 我们学习了如何使用 <code>jsonwebtoken</code> 库生成 JWT，并将其发送给客户端。客户端在后续请求中携带 Token，而服务器通过 <code>express-jwt</code> 验证 Token 的合法性，实现了用户的无缝身份认证。</p> </li><li> <p><strong>授权机制：</strong> 除了认证外，<code>express-jwt</code> 还可用于实现基于角色或权限的授权。通过配置额外的中间件或在路由处理函数中进行检查，我们可以确保用户具有访问特定资源或执行特定操作的权限。</p> </li></ol> 
<p><span style="color:#38d8f0;"><strong>😊完整代码可以在主页资源中下载😊</strong></span></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/94b0469c11c8c9b4dbfbe82144e58182/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python 因果推断（下）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7686e9daf485afe13fb5473d865fdbc9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python 标准库random生成随机数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>