<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mysql慢日志、慢SQL - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/4af8f88fdaef9abd15f3e4fb5abcc165/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Mysql慢日志、慢SQL">
  <meta property="og:description" content="慢查询日志 查看执行慢的SQL语句，需要先开启慢查询日志。
MySQL 的慢查询日志，记录在 MySQL 中响应时间超过阀值的语句（具体指运行时间超过 long_query_time 值的SQL。long_query_time 的默认值为10，意思是运行10秒以上(不含10秒)的语句）。
目的：发现执行时间特别长的SQL查询，进行优化。
默认情况下，MySQL数据库没有开启慢查询日志，需要我们手动来设置这个参数。
慢日志常用配置项 1
2
3
4
5
6
7
8
slow_query_log 是否启用慢查询日志，默认为0，可设置为0、1，1表示开启。
slow_query_log_file 指定慢查询日志位置及名称，默认值为host_name-slow.log，可指定绝对路径。
long_query_time 慢查询执行时间阈值，超过此时间会记录，默认为10，单位为s。
log_output 慢查询日志输出目标，默认为file，即输出到文件。
log_timestamps 主要是控制 error log、slow log、genera log 日志文件中的显示时区，默认使用UTC时区，建议改为 SYSTEM 系统时区。
log_queries_not_using_indexes 是否记录所有未使用索引的查询语句，默认为off。
min_examined_row_limit 对于查询扫描行数小于此参数的SQL，将不会记录到慢查询日志中，默认为0。
log_slow_admin_statements 慢速管理语句是否写入慢日志中，管理语句包含 alter table、create index 等，默认为 off 即不写入
一般情况下，我们只需开启慢日志记录，配置下阈值时间，其余参数可按默认配置。对于阈值时间，可灵活调整，比如说可以设置为 1s 或 3s 。
查看是否开启慢查询日志 1
show variables like &#39;%slow_query_log%&#39;;
开启慢查询（临时,当前会话有效） 1
set global slow_query_log=&#39;ON&#39;;
查看慢查询日志存放文件位置 1
show variables like &#39;%slow_query_log_file%&#39;;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-04T13:08:47+08:00">
    <meta property="article:modified_time" content="2024-07-04T13:08:47+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mysql慢日志、慢SQL</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>慢查询日志</h3> 
<p>查看执行慢的SQL语句，需要先开启慢查询日志。<br> MySQL 的慢查询日志，记录在 MySQL 中响应时间超过阀值的语句（具体指运行时间超过 <code>long_query_time</code> 值的SQL。long_query_time 的默认值为10，意思是运行10秒以上(不含10秒)的语句）。</p> 
<p>目的：发现执行时间特别长的SQL查询，进行优化。</p> 
<p>默认情况下，MySQL数据库没有开启慢查询日志，需要我们手动来设置这个参数。</p> 
<p><a name="_lab2_0_0"></a></p> 
<h4>慢日志常用配置项</h4> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> <p>3</p> <p>4</p> <p>5</p> <p>6</p> <p>7</p> <p>8</p> </td><td> <p><code>slow_query_log       是否启用慢查询日志，默认为0，可设置为0、1，1表示开启。</code></p> <p><code>slow_query_log_file  指定慢查询日志位置及名称，默认值为host_name-slow.log，可指定绝对路径。</code></p> <p><code>long_query_time      慢查询执行时间阈值，超过此时间会记录，默认为10，单位为s。</code></p> <p><code>log_output           慢查询日志输出目标，默认为file，即输出到文件。</code></p> <p><code>log_timestamps       主要是控制 error log、slow log、genera log 日志文件中的显示时区，默认使用UTC时区，建议改为 SYSTEM 系统时区。</code></p> <p><code>log_queries_not_using_indexes    是否记录所有未使用索引的查询语句，默认为off。</code></p> <p><code>min_examined_row_limit           对于查询扫描行数小于此参数的SQL，将不会记录到慢查询日志中，默认为0。</code></p> <p><code>log_slow_admin_statements        慢速管理语句是否写入慢日志中，管理语句包含 alter table、create index 等，默认为 off 即不写入</code></p> </td></tr></tbody></table> 
<p>一般情况下，我们只需开启慢日志记录，配置下阈值时间，其余参数可按默认配置。对于阈值时间，可灵活调整，比如说可以设置为 1s 或 3s 。</p> 
<p><a name="_lab2_0_1"></a></p> 
<h4>查看是否开启慢查询日志</h4> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>show variables </code><code>like</code> <code>'%slow_query_log%'</code><code>;</code></p> </td></tr></tbody></table> 
<p><a name="_lab2_0_2"></a></p> 
<h4>开启慢查询（临时,当前会话有效）</h4> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>set</code> <code>global</code> <code>slow_query_log=</code><code>'ON'</code><code>;</code></p> </td></tr></tbody></table> 
<p><a name="_lab2_0_3"></a></p> 
<h4>查看慢查询日志存放文件位置</h4> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>show variables </code><code>like</code> <code>'%slow_query_log_file%'</code><code>;</code></p> </td></tr></tbody></table> 
<p><a name="_lab2_0_4"></a></p> 
<h4>查看long_query_time阈值</h4> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>show variables </code><code>like</code> <code>'%long_query_time%'</code><code>;</code></p> </td></tr></tbody></table> 
<p><a name="_lab2_0_5"></a></p> 
<h4>设置long_query_time阈值（临时,当前会话有效）</h4> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>set</code> <code>global</code> <code>long_query_time=3</code></p> </td></tr></tbody></table> 
<p><a name="_lab2_0_6"></a></p> 
<h4>直接修改配置文件（全局，需要重启服务，慎重）</h4> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> <p>3</p> <p>4</p> <p>5</p> <p>6</p> <p>7</p> <p>8</p> <p>9</p> <p>10</p> <p>11</p> <p>12</p> <p>13</p> <p>14</p> <p>15</p> <p>16</p> </td><td> <p><code>#编辑配置文件</code></p> <p><code>vim /etc/my.cnf</code></p> <p></p> <p><code># 修改配置项（如果没有就加上）</code></p> <p><code>[mysqld]</code></p> <p><code>slow_query_log = </code><code>ON</code></p> <p><code>slow_query_log_file = /var/lib/mysql/my-slow.log</code></p> <p><code>long_query_time = 1</code></p> <p><code>log_timestamps = SYSTEM</code></p> <p><code>log_output = FILE</code></p> <p></p> <p><code># 重启mysqld服务</code></p> <p><code>systemctl restart mysqld</code></p> <p></p> <p><code># 查看mysqld服务</code></p> <p><code>systemctl status mysqld</code></p> </td></tr></tbody></table> 
<p><a name="_label1"></a></p> 
<h3>测试</h3> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> </td><td> <p><code>select</code> <code>sleep(5);</code></p> <p><code>ls /var/lib/mysql/xxx-slow.log</code></p> </td></tr></tbody></table> 
<p><a name="_label2"></a></p> 
<h3>慢查询日志文件分析</h3> 
<p><a name="_lab2_2_7"></a></p> 
<h4>单条记录结构</h4> 
<p>单条记录结构：</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> <p>3</p> <p>4</p> <p>5</p> </td><td> <p><code># </code><code>Time</code><code>: 2024-03-01T17:12:40.156488+08:00</code></p> <p><code># </code><code>User</code><code>@Host: panda[panda] @  [192.168.72.1]  Id:     8</code></p> <p><code># Query_time: 5.000688  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 1</code></p> <p><code>SET</code> <code>timestamp</code><code>=1709284355;</code></p> <p><code>select</code> <code>sleep(5);</code></p> </td></tr></tbody></table> 
<p>字段说明：<br> 慢查询日志以#作为起始符。<br> Time:查询的时间。<br> User@Host：表示用户 和 慢查询查询的ip地址。<br> 如上所述，表示 root用户 localhost地址。<br> Query_time: 表示SQL查询持续时间， 单位 (秒)。<br> Lock_time: 表示获取锁的时间， 单位(秒)。<br> Rows_sent: 表示发送给客户端的行数。<br> Rows_examined: 表示：服务器层检查的行数。<br> set timestamp ：表示 慢SQL 记录时的时间戳。<br> 最后 select sleep(5) 则表示慢SQL语句。</p> 
<p><a name="_lab2_2_8"></a></p> 
<h4>慢查询日志分析-mysqldumpslow</h4> 
<p>MySQL自带了一个慢查询分析工具mysqldumpslow。<br> 试了下不太好使。可以试试：<br> Navicat Monitor、signoz、hertzbeat 这些性能监测工具。</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> <p>3</p> <p>4</p> </td><td> <p><code>mysqldumpslow ­s c ­t 10 /var/run/mysqld/mysqld­slow.log # 取出使用最多的10条慢查询</code></p> <p><code>mysqldumpslow ­s t ­t 3 /var/run/mysqld/mysqld­slow.log # 取出查询时间最慢的3条慢查询</code></p> <p><code>mysqldumpslow ­s t ­t 10 ­g “left join” /database/mysql/slow­log #得到按照时间排序的前10条里面含有左连接的查询语句</code></p> <p><code>mysqldumpslow ­s r ­t 10 ­g 'left join' /var/run/mysqld/mysqldslow.log # 按照扫描行数最多的</code></p> </td></tr></tbody></table> 
<p><a name="_lab2_2_9"></a></p> 
<h4>慢查询日志分析-Navicat Monitor</h4> 
<p>官网下载就行了。跟着指引配置即可。<br> 很舒服，还可以自动提供一些运维建议。</p> 
<p></p> 
<p class="img-center"><img alt="" height="1200" src="https://images2.imgbox.com/c3/56/fSLrtyGR_o.png" width="1200"></p> 
<p>查询分析</p> 
<p></p> 
<p class="img-center"><img alt="" height="1200" src="https://images2.imgbox.com/b0/15/ItfZBkoU_o.png" width="1200"></p> 
<p><a name="_label3"></a></p> 
<h3>其他细节</h3> 
<p><a name="_lab2_3_10"></a></p> 
<h4>记录管理语句</h4> 
<p>在 MySQL 中，慢查询日志中默认不记录管理语句，如：</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>alter</code> <code>table</code><code>, analyze </code><code>table</code><code>，</code><code>check</code> <code>table</code></p> </td></tr></tbody></table> 
<p>不过可通过以下属性进行设置：</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>mysql&gt; </code><code>set</code> <code>global</code> <code>log_slow_admin_statements = </code><code>"ON"</code><code>;</code></p> </td></tr></tbody></table> 
<p><a name="_lab2_3_11"></a></p> 
<h4>记录未走索引的SQL语句</h4> 
<p>在 MySQL 中，还可以设置将未走索引的SQL语句记录在慢日志查询文件中(默认为关闭状态)。通过下述属性即可进行设置：</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> <p>2</p> </td><td> <p><code>mysql&gt; </code><code>set</code> <code>global</code> <code>log_queries_not_using_indexes = </code><code>"ON"</code><code>;</code></p> <p><code>Query OK, 0 </code><code>rows</code> <code>affected (0.00 sec)</code></p> </td></tr></tbody></table> 
<p>SQL 复制 全屏</p> 
<p><a name="_lab2_3_12"></a></p> 
<h4>慢查询日志输出位置</h4> 
<p>在MySQL中，日志输出格式有支持：FILE(默认)，TABLE 两种，可进行组合使用。如下所示:</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>set</code> <code>global</code> <code>log_output = </code><code>"FILE,TABLE"</code><code>;</code></p> </td></tr></tbody></table> 
<p>这样设置会同时在 FILE, mysql库中的slow_log表中同时写入。</p> 
<table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td> <p>1</p> </td><td> <p><code>select</code> <code>* </code><code>from</code> <code>mysql.slow_log;</code></p> </td></tr></tbody></table>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0031bfde852d06b0689bc0a63a16eae9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据结构——树的基础概念</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/06d81afcc42f653b6b9e910ec20928d3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Mac本地部署大模型-单机运行</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>