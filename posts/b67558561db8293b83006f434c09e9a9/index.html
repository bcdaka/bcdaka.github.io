<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用 nginx 搭建代理服务器（正向代理 https 网站）指南 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/b67558561db8293b83006f434c09e9a9/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="使用 nginx 搭建代理服务器（正向代理 https 网站）指南">
  <meta property="og:description" content="写在前面
前些天发现了一个巨牛的人工智能学习网站，通俗易懂，风趣幽默，忍不住分享一下给大家。点击跳转到网站
文章目录 简介正向代理 简介ngx_http_proxy_connect_module 介绍 详细步骤包准备Linux 编译并安装 nginx修改 nginx 配置文件nginx 启动与测试 拓展设置 nginx 开机自启动 简介 正向代理 简介 在企业开发环境中，局域网内的设备通常需要通过正向代理服务器访问互联网。正向代理服务器充当中介，帮助客户端请求外部资源并返回结果。局域网内也就是俗称的内网，局域网外的互联网就是外网，在一些特殊场景内，例如：医院。而局域网中的客户端要访问这些资源时，就需要通过代理服务器。这种通过代理服务器访问外部网络资源的方式，就是正向代理。正向代理不仅用于提升访问速度，还能提高网络安全性、管理访问权限和优化网络流量。
原生 nginx 可以作为 http 的正向代理服务器，但是不能用做 https 的正向代理服务器。因为 http 正向代理使用的是 get 请求，但是 https 使用的确实 connect 请求，而原生 nginx 不支持 connect 请求。所以需要第三方模块 ngx_http_proxy_connect_module 来支持 https 的正向代理，使用这个插件，意味着需要重新编译 nginx，在编译的过程中，将插件添加进去。本次编译以目前稳定版 1.24.0 为例。
ngx_http_proxy_connect_module 介绍 ngx_http_proxy_connect_module 项目地址：传送门（注：目标地址为 github，打不开则请科学上网）
ngx_http_proxy_connect_module 是 Nginx 的一个扩展模块，主要功能是允许 Nginx 作为代理服务器处理 CONNECT 方法。通过该模块，可以将 Nginx 作为 HTTP/HTTPS 代理服务器，甚至可以直接用作 WebSocket 服务器。
注：在 HTTP 协议中，CONNECT 方法主要用于建立隧道（即建立到远程服务器的端到端的加密连接），通常在代理服务器后面的客户端需要通过代理服务器与目标服务器建立安全连接，比如 WebSocket 连接和 HTTPS 的中间人代理。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-15T10:22:39+08:00">
    <meta property="article:modified_time" content="2024-08-15T10:22:39+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用 nginx 搭建代理服务器（正向代理 https 网站）指南</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>写在前面</strong><br> 前些天发现了一个巨牛的人工智能学习网站，通俗易懂，风趣幽默，忍不住分享一下给大家。<a href="https://www.captainbed.cn/laputa" rel="nofollow">点击跳转到网站</a></p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_4" rel="nofollow">简介</a></li><li><ul><li><a href="#__6" rel="nofollow">正向代理 简介</a></li><li><a href="#ngx_http_proxy_connect_module__14" rel="nofollow">ngx_http_proxy_connect_module 介绍</a></li></ul> 
  </li><li><a href="#_24" rel="nofollow">详细步骤</a></li><li><ul><li><a href="#_26" rel="nofollow">包准备</a></li><li><a href="#Linux__nginx_53" rel="nofollow">Linux 编译并安装 nginx</a></li><li><a href="#_nginx__93" rel="nofollow">修改 nginx 配置文件</a></li><li><a href="#nginx__135" rel="nofollow">nginx 启动与测试</a></li></ul> 
  </li><li><a href="#_158" rel="nofollow">拓展</a></li><li><ul><li><a href="#_nginx__160" rel="nofollow">设置 nginx 开机自启动</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_4"></a>简介</h2> 
<h3><a id="__6"></a>正向代理 简介</h3> 
<p>在企业开发环境中，局域网内的设备通常需要通过正向代理服务器访问互联网。正向代理服务器充当中介，帮助客户端请求外部资源并返回结果。局域网内也就是俗称的内网，局域网外的互联网就是外网，在一些特殊场景内，例如：医院。而局域网中的客户端要访问这些资源时，就需要通过代理服务器。这种通过代理服务器访问外部网络资源的方式，就是正向代理。正向代理不仅用于提升访问速度，还能提高网络安全性、管理访问权限和优化网络流量。</p> 
<p>原生 nginx 可以作为 http 的正向代理服务器，但是不能用做 https 的正向代理服务器。因为 http 正向代理使用的是 get 请求，但是 https 使用的确实 connect 请求，而原生 nginx 不支持 connect 请求。所以需要第三方模块 ngx_http_proxy_connect_module 来支持 https 的正向代理，使用这个插件，意味着需要重新编译 nginx，在编译的过程中，将插件添加进去。本次编译以目前稳定版 1.24.0 为例。</p> 
<br> 
<h3><a id="ngx_http_proxy_connect_module__14"></a>ngx_http_proxy_connect_module 介绍</h3> 
<ul><li> <p>ngx_http_proxy_connect_module 项目地址：<a href="https://github.com/chobits/ngx_http_proxy_connect_module">传送门</a>（注：目标地址为 github，打不开则请科学上网）</p> </li><li> <p>ngx_http_proxy_connect_module 是 Nginx 的一个扩展模块，主要功能是允许 Nginx 作为代理服务器处理 CONNECT 方法。通过该模块，可以将 Nginx 作为 HTTP/HTTPS 代理服务器，甚至可以直接用作 WebSocket 服务器。</p> <p>注：在 HTTP 协议中，CONNECT 方法主要用于建立隧道（即建立到远程服务器的端到端的加密连接），通常在代理服务器后面的客户端需要通过代理服务器与目标服务器建立安全连接，比如 WebSocket 连接和 HTTPS 的中间人代理。</p> </li></ul> 
<br> 
<h2><a id="_24"></a>详细步骤</h2> 
<h3><a id="_26"></a>包准备</h3> 
<ul><li> <p><strong>从 nginx 官网下载 <a href="https://nginx.org/download/nginx-1.24.0.tar.gz" rel="nofollow">nginx 源码包</a></strong></p> <p>注：也可以直接在 Linux 主机上下载：</p> <pre><code class="prism language-sh"><span class="token function">wget</span> http://nginx.org/download/nginx-1.24.0.tar.gz
</code></pre> </li><li> <p><strong>从 github 下载 <a href="https://github.com/chobits/ngx_http_proxy_connect_module">ngx_http_proxy_connect_module 源码</a></strong></p> <p><img src="https://images2.imgbox.com/8d/b2/eVH7CIn8_o.png" alt="在这里插入图片描述"></p> </li><li> <p><strong>从 github 下载 ngx_http_proxy_connect_module 模块的 <a href="https://github.com/chobits/ngx_http_proxy_connect_module">nginx 内核补丁</a></strong></p> <p>注：</p> 
  <ul><li>请严格按照下图安装和 nginx 版本匹配的 nginx 内核补丁，否则会导致 https 代理不生效。</li><li>ngx_http_proxy_connect_module 源码压缩包内（ngx_http_proxy_connect_module-master/patch/）可能已包含 nginx 内核补丁，这种情况确认即可，无需再下载补丁。</li></ul> <p><img src="https://images2.imgbox.com/93/ff/SkehurXg_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<br> 
<h3><a id="Linux__nginx_53"></a>Linux 编译并安装 nginx</h3> 
<pre><code class="prism language-sh"><span class="token comment"># 使用yum包管理工具安装相关编译环境及相关依赖</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel openssl-libs pcre2
<span class="token comment"># 或使用dnf包管理工具安装</span>
<span class="token comment">#dnf -y install gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel</span>

<span class="token comment"># 将安装包放于/root目录，可自定义</span>
<span class="token builtin class-name">cd</span> /root
<span class="token comment"># 上传nginx安装包并解压</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> nginx-1.24.0.tar.gz
<span class="token comment"># 进入nginx安装包解压目录并创建modules源码包存放目录</span>
<span class="token builtin class-name">cd</span> nginx-1.24.0
<span class="token function">mkdir</span> ./modules <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> ./modules
<span class="token comment"># 上传 ngx_http_proxy_connect_module 源码包并解压</span>
<span class="token function">unzip</span> ngx_http_proxy_connect_module-master.zip

<span class="token comment"># 进入nginx安装包解压目录根路径</span>
<span class="token builtin class-name">cd</span> /root/nginx-1.24.0
<span class="token comment"># 对nginx内核打补丁</span>
patch <span class="token parameter variable">-p1</span> <span class="token operator">&lt;</span> modules/ngx_http_proxy_connect_module-master/patch/proxy_connect_rewrite_102101.patch

<span class="token comment"># 配置编译参数编译前确认pcre、zlib、openssl的库是否已经正常安装</span>
./configure <span class="token punctuation">\</span>
<span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/nginx <span class="token punctuation">\</span>
--with-http_ssl_module <span class="token punctuation">\</span>
--with-http_realip_module <span class="token punctuation">\</span>
--with-stream <span class="token punctuation">\</span>
--with-stream_ssl_module <span class="token punctuation">\</span>
--add-module<span class="token operator">=</span>/root/nginx-1.24.0/modules/ngx_http_proxy_connect_module-master
	<span class="token comment"># --prefix ：指定需要安装的目录，可自定义</span>
	<span class="token comment"># --add-module ：ngx_http_proxy_connect_module-master模块源码路径，根据实际路径修改</span>
	
<span class="token comment"># 编译并安装nginx</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre> 
<br> 
<h3><a id="_nginx__93"></a>修改 nginx 配置文件</h3> 
<ul><li> <p>编辑配置文件</p> <pre><code class="prism language-sh"><span class="token function">vi</span> /usr/local/nginx/conf/nginx.conf
</code></pre> </li><li> <p>增加如下配置：</p> <pre><code class="prism language-nginx">    server {
        # 对外服务端口
        listen 80;
        server_name  localhost;
        # 域名解析服务器并禁用ipv6
    	# 注：若不禁用ipv6，会由于当前互联网对IPv6支持不完整，导致在DNS解析时偶发超时问题（502）
        resolver 114.114.114.114 valid=60s ipv6=off;
        # 解析超时时间
        resolver_timeout 30s;
        # 开启porxy connect功能（代理）
        proxy_connect;
        # 设置允许代理的目标端口和范围的列表
        proxy_connect_allow            80 443 563;
        # 定义客户端与代理服务器建立连接的超时时间
        proxy_connect_connect_timeout  20s;
        # 定义客户端从代理服务器读取响应的超时时间
        proxy_connect_read_timeout     20s;
        # 设置客户端将请求传输到代理服务器的超时时间
        proxy_connect_send_timeout     20s;

        location / {
            # 正向代理配置，根据请求地址自动解析出目标网站地址并进行代理
            proxy_pass $scheme://$host$request_uri;
            # 发送到被代理网站的请求需要添加Host请求头
            proxy_set_header Host $host;
        }
    }
</code></pre> </li></ul> 
<br> 
<h3><a id="nginx__135"></a>nginx 启动与测试</h3> 
<ul><li> <p>启动</p> <pre><code class="prism language-sh"><span class="token comment"># 启动nginx</span>
/usr/local/nginx/sbin/nginx

<span class="token comment"># 重新加载nginx配置</span>
/usr/local/nginx/sbin/nginx <span class="token parameter variable">-s</span> reload

<span class="token comment"># 停止nginx</span>
/usr/local/nginx/sbin/nginx <span class="token parameter variable">-s</span> stop
</code></pre> </li><li> <p>测试 nginx 代理功能了</p> <pre><code class="prism language-sh"><span class="token function">curl</span> https://www.baidu.com <span class="token parameter variable">-v</span> <span class="token parameter variable">-x</span> <span class="token number">127.0</span>.0.1:80
</code></pre> </li></ul> 
<br> 
<h2><a id="_158"></a>拓展</h2> 
<h3><a id="_nginx__160"></a>设置 nginx 开机自启动</h3> 
<ul><li> <p><strong>创建开机自启脚本</strong></p> <pre><code class="prism language-sh"><span class="token function">vim</span> /etc/systemd/system/nginx.service
</code></pre> <p><strong>脚本内容：</strong></p> <pre><code class="prism language-properties"># 仅修改 /usr/local/nginx/sbin/nginx 这个路径即可（修改为实际的nginx路径）

[Unit]
Description=nginx service
After=network.target

[Service]
Type=forking
ExecStart=/usr/local/nginx/sbin/nginx
ExecReload=/usr/local/nginx/sbin/nginx -s reload
ExecStop=/usr/local/nginx/sbin/nginx -s quit
PrivateTmp=true

[Install]
WantedBy=multi-user.target
</code></pre> </li><li> <p><strong>设置文件权限</strong></p> <pre><code class="prism language-sh"><span class="token function">chmod</span> <span class="token number">755</span> /etc/systemd/system/nginx.service
</code></pre> </li><li> <p><strong>设置开机自启动</strong></p> <pre><code class="prism language-sh">systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> nginx
</code></pre> </li><li> <p><strong>验证</strong></p> <pre><code class="prism language-sh"><span class="token comment"># nginx启动</span>
systemctl start nginx 
<span class="token comment"># nginx停止</span>
systemctl stop nginx 

<span class="token comment"># 直接重启服务器即可（nginx就自动重启了）</span>
<span class="token function">reboot</span>	
</code></pre> </li><li> <p><strong>常用命令</strong></p> <pre><code class="prism language-sh"><span class="token comment"># 启动nginx服务</span>
systemctl start nginx
<span class="token comment"># 重新启动nginx服务</span>
systemctl restart nginx
<span class="token comment"># 查看nginx服务当前状态</span>
systemctl status nginx
<span class="token comment"># 停止开机自启动</span>
systemctl disable nginx
</code></pre> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/927f597bd33bd51367abc33f29486c1c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">屏幕适配方案——详细完整版</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cb66907416381a9d4e38c7acbe00e02a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Godot4自学手册】第四十五节用着色器（shader）制作水中效果</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>