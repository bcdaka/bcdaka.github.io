<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python编写BC260Y TCP数据收发压力测试脚本 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/97e1152dc76871984c344b526f315f75/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Python编写BC260Y TCP数据收发压力测试脚本">
  <meta property="og:description" content="Python编写BC260Y TCP数据收发压力测试脚本 使用BC260Y的TCP AT命令发送数据时，能够在数据中带有’\r\n’（回车换行），而其他模组会将’\r\n’当做AT命令处理的结束符，例如EC800E，为了验证TCP数据中带有’\r\n’时数据发收的稳定性，决定进行压力测试。
编写一个Python脚本周期向TCP服务器发送1024字节数据（数据中带有不止一个’\r\n’），在超时时间内判断是否发送成功和接收成功。TCP服务器同样以’\r\n’为结束符，收到结束符后将收到的所有数据原封不动回发。所有的数据收发log保存到文件，便于出错后分析。
使用串口工具测试步骤如下：
编写Python脚本：
######################################### ## AT测试脚本：根据BC260Y模组TCP模块编写TCP压力测试脚本，模组使用直吐模式连接TCP服务器，每隔5s向服务器发送1024字节数据，服务器以&#39;\r\n&#39;（回车换行）作为数据接结束标志，将接收到的数据返回 ## pyhton版本：3.6.5 ## 需要安装的第三方库：pip install pyserial ######################################### ## -- coding: utf-8 -- import os import sys import threading import time import datetime import msvcrt import serial import logging import signal import json import hmac import base64 from hashlib import sha256 ############# 宏定义(开始) #################### ATCOM = &#39;COM38&#39; ATBaud = 9600 LOGNamePrefix = &#39;LOG-NAME&#39; g_ExitFlag = 0 ## 0--未退出；1--退出 g_RecvResult = 0 ## 0--未接收；1--接收成功 g_RecvData = &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-27T18:02:55+08:00">
    <meta property="article:modified_time" content="2024-08-27T18:02:55+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python编写BC260Y TCP数据收发压力测试脚本</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="PythonBC260Y_TCP_0"></a>Python编写BC260Y TCP数据收发压力测试脚本</h2> 
<blockquote> 
 <p>使用BC260Y的TCP AT命令发送数据时，能够在数据中带有’\r\n’（回车换行），而其他模组会将’\r\n’当做AT命令处理的结束符，例如EC800E，为了验证TCP数据中带有’\r\n’时数据发收的稳定性，决定进行压力测试。</p> 
</blockquote> 
<ul><li>编写一个Python脚本周期向TCP服务器发送1024字节数据（数据中带有不止一个’\r\n’），在超时时间内判断是否发送成功和接收成功。</li><li>TCP服务器同样以’\r\n’为结束符，收到结束符后将收到的所有数据原封不动回发。</li><li>所有的数据收发log保存到文件，便于出错后分析。<br> <em>使用串口工具测试步骤如下：</em><br> <img src="https://images2.imgbox.com/c3/b3/bA0eccHs_o.png" alt="在这里插入图片描述"></li></ul> 
<p><strong>编写Python脚本：</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#########################################</span>
<span class="token comment">## AT测试脚本：根据BC260Y模组TCP模块编写TCP压力测试脚本，模组使用直吐模式连接TCP服务器，每隔5s向服务器发送1024字节数据，服务器以'\r\n'（回车换行）作为数据接结束标志，将接收到的数据返回</span>
<span class="token comment">## pyhton版本：3.6.5 </span>
<span class="token comment">## 需要安装的第三方库：pip install pyserial</span>
<span class="token comment">#########################################</span>
<span class="token comment">## -- coding: utf-8 --</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> time
<span class="token keyword">import</span> datetime 
<span class="token keyword">import</span> msvcrt
<span class="token keyword">import</span> serial
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> signal
<span class="token keyword">import</span> json
<span class="token keyword">import</span> hmac
<span class="token keyword">import</span> base64
<span class="token keyword">from</span> hashlib <span class="token keyword">import</span> sha256

<span class="token comment">############# 宏定义(开始) ####################</span>
ATCOM         <span class="token operator">=</span> <span class="token string">'COM38'</span>
ATBaud        <span class="token operator">=</span> <span class="token number">9600</span>
LOGNamePrefix <span class="token operator">=</span> <span class="token string">'LOG-NAME'</span>
g_ExitFlag <span class="token operator">=</span> <span class="token number">0</span>                  <span class="token comment">## 0--未退出；1--退出</span>
g_RecvResult <span class="token operator">=</span> <span class="token number">0</span>                <span class="token comment">## 0--未接收；1--接收成功</span>
g_RecvData <span class="token operator">=</span> <span class="token string">""</span>                 <span class="token comment">## 接收数据缓存</span>
g_SendSuccCount <span class="token operator">=</span> <span class="token number">0</span>             <span class="token comment">## 成功次数</span>
g_SendFailCount <span class="token operator">=</span> <span class="token number">0</span>             <span class="token comment">## 失败次数</span>
g_SendTotleCount <span class="token operator">=</span> <span class="token number">0</span>            <span class="token comment">## 测试总次数</span>
g_TimeOut <span class="token operator">=</span> <span class="token number">0</span>                   <span class="token comment">## 0--未超时；1--超时</span>
g_Cereg <span class="token operator">=</span> <span class="token number">0</span>                     <span class="token comment">## 0--未驻网；1--已驻网</span>
<span class="token comment">############# 宏定义(结束) ####################</span>

<span class="token comment">###******************************************************************************</span>
<span class="token comment">## 日志格式，输出到文件，同时输出到屏幕</span>
<span class="token keyword">def</span> <span class="token function">logInit</span><span class="token punctuation">(</span>log_dir<span class="token punctuation">,</span> logFileName<span class="token punctuation">)</span> <span class="token punctuation">:</span>
    <span class="token comment">## 日志格式，输出到log_dir路径下logFileName文件</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>log_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>log_dir<span class="token punctuation">)</span>    
    
    log_file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>log_dir<span class="token punctuation">,</span> logFileName<span class="token punctuation">)</span>

    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>
        level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">,</span>
        <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'[%(asctime)s][%(levelname)s]: %(message)s'</span><span class="token punctuation">,</span>
        filename<span class="token operator">=</span>log_file_path<span class="token punctuation">,</span>
        <span class="token comment">## 写入模式，覆盖现有的日志文件，如果文件已经存在，它的内容将被清空</span>
        filemode<span class="token operator">=</span><span class="token string">'w'</span>
    <span class="token punctuation">)</span>

    <span class="token comment">## 日志格式，输出到屏幕</span>
    console <span class="token operator">=</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>
    <span class="token comment">## %(asctime)s：表示日志事件发生的时间。默认格式为YYYY-MM-DD HH:MM:SS,mmm，其中mmm表示毫秒。</span>
    <span class="token comment">## %(levelname)s：表示日志记录的级别，如DEBUG, INFO, WARNING, ERROR, CRITICAL等。</span>
    <span class="token comment">## %(message)s：表示日志记录的消息内容。</span>
    formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'[%(asctime)s][%(levelname)s]: %(message)s'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>console<span class="token punctuation">)</span>

<span class="token comment">###******************************************************************************</span>
<span class="token comment">## 打开串口</span>
<span class="token comment">## 端口，GNU/Linux上的/dev/ttyUSB0等 或 Windows上的COM3等</span>
<span class="token comment">## 波特率，标准值之一：50,75,110,134,150,200,300,600,1200,1800,2400,4800,9600,19200,38400,57600,115200</span>
<span class="token comment">## 超时设置，None：永远等待操作，0为立即返回请求结果，其他值为等待超时时间(单位为秒）</span>
<span class="token keyword">def</span> <span class="token function">openComPort</span><span class="token punctuation">(</span>portx<span class="token punctuation">,</span> bps<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ret <span class="token operator">=</span> <span class="token boolean">False</span>
    ser <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        ser <span class="token operator">=</span> serial<span class="token punctuation">.</span>Serial<span class="token punctuation">(</span>portx<span class="token punctuation">,</span> bps<span class="token punctuation">,</span> timeout<span class="token operator">=</span>timeout<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ser<span class="token punctuation">.</span>is_open<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ret <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"openComPort faild:"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ser<span class="token punctuation">,</span>ret

<span class="token comment">###******************************************************************************</span>
<span class="token comment">## 关闭串口</span>
<span class="token keyword">def</span> <span class="token function">closeComPort</span><span class="token punctuation">(</span>ser<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ser<span class="token punctuation">.</span>is_open<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ser<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>

<span class="token comment">###******************************************************************************</span>
<span class="token comment">## 串口发送AT命令并接收返回值</span>
<span class="token keyword">def</span> <span class="token function">ATSend</span><span class="token punctuation">(</span>atcmd<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> g_RecvData

    <span class="token comment">## 发送AT命令前先将接收缓存g_RecvData清空</span>
    g_RecvData <span class="token operator">=</span> <span class="token string">""</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>atcmd<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;Send AT cmd:[%s]"</span> <span class="token operator">%</span><span class="token punctuation">(</span>atcmd<span class="token operator">+</span><span class="token string">'\r\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        bytes_written  <span class="token operator">=</span> ser<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">(</span>atcmd<span class="token operator">+</span><span class="token string">'\r\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> bytes_written 

<span class="token comment">###******************************************************************************</span>
<span class="token comment">## 接收数据线程</span>
<span class="token keyword">def</span> <span class="token function">threadFunComRecv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> g_RecvResult<span class="token punctuation">,</span> g_RecvData
    rxDataTmp <span class="token operator">=</span> <span class="token string">""</span>
    rxData <span class="token operator">=</span> <span class="token string">""</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> g_ExitFlag<span class="token punctuation">)</span><span class="token punctuation">:</span>
        count <span class="token operator">=</span> ser<span class="token punctuation">.</span>inWaiting<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            tmp <span class="token operator">=</span> ser<span class="token punctuation">.</span>read<span class="token punctuation">(</span>ser<span class="token punctuation">.</span>in_waiting<span class="token punctuation">)</span>
            
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                rxDataTmp <span class="token operator">=</span> tmp<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                rxData <span class="token operator">=</span> rxData <span class="token operator">+</span> rxDataTmp
                <span class="token keyword">if</span><span class="token punctuation">(</span>ser<span class="token punctuation">.</span>in_waiting <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">continue</span>
                
                <span class="token comment">## 以'\n'为结束符将数据存入接收缓存g_RecvResult</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">'\n'</span> <span class="token operator">==</span> rxData<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    g_RecvData <span class="token operator">=</span> g_RecvData <span class="token operator">+</span> rxData
                    rxData <span class="token operator">=</span> <span class="token string">""</span>
                    rxDataTmp <span class="token operator">=</span> <span class="token string">""</span>
                    <span class="token comment">## 将接收标志为置位</span>
                    g_RecvResult <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">###******************************************************************************</span>
<span class="token comment">## 按键终止</span>
<span class="token keyword">def</span> <span class="token function">signal_Handler</span><span class="token punctuation">(</span>sig<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> g_ExitFlag

    g_ExitFlag <span class="token operator">=</span> <span class="token number">1</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"!!!Exit!!!"</span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">###******************************************************************************</span>
<span class="token comment">## 定时器超时函数</span>
<span class="token keyword">def</span> <span class="token function">timeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> g_TimeOut

    g_TimeOut <span class="token operator">=</span> <span class="token number">1</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"!!!ERROR:Time out!!!\r\n"</span><span class="token punctuation">)</span>

<span class="token comment">###******************************************************************************</span>
<span class="token comment">## 开启定时器</span>
<span class="token keyword">def</span> <span class="token function">start_timer</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">:</span>

    timer <span class="token operator">=</span> threading<span class="token punctuation">.</span>Timer<span class="token punctuation">(</span>delay<span class="token punctuation">,</span> timeOut<span class="token punctuation">)</span>  
    timer<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>  

    <span class="token keyword">return</span> timer

<span class="token comment">###******************************************************************************</span>
<span class="token comment">## 检查接收数据函数</span>
<span class="token keyword">def</span> <span class="token function">checkRecvData</span><span class="token punctuation">(</span>strings<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> g_TimeOut

    <span class="token comment">## 启动定时器，在超时时间timeout内判断是否接收到指定数据strings</span>
    timer <span class="token operator">=</span> start_timer<span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">!=</span> g_TimeOut<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>g_RecvData<span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span>strings<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            g_TimeOut <span class="token operator">=</span> <span class="token number">0</span>
            timer<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">## 波特率9600时，1024字节数据传输需要1.06s，加2s延时确保在收到指定数据strings后的其他数据都能接收完全</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"&lt;&lt;&lt;&lt;&lt;&lt;g_RecvData:[%s] \r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>g_RecvData<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> <span class="token number">1</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> g_TimeOut<span class="token punctuation">)</span><span class="token punctuation">:</span>
            g_TimeOut <span class="token operator">=</span> <span class="token number">0</span>
            timer<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"!!!ERROR: Time out!!!"</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
    

<span class="token comment">###******************************************************************************</span>
<span class="token comment">## 主函数</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token comment">## 将当前本地时间格式化为'%Y%m%d%H%M%S'这样的格式</span>
    t <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d%H%M%S'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    logFileName <span class="token operator">=</span> <span class="token string">"%s-%s.log"</span> <span class="token operator">%</span><span class="token punctuation">(</span>LOGNamePrefix<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
    log_dir <span class="token operator">=</span> <span class="token string">".\\log"</span>
    <span class="token comment"># log_dir = "C:\\Users\\Administrator\\Desktop\\TCPRecvTest\\log"</span>

    <span class="token comment">## 初始化log输出</span>
    logInit<span class="token punctuation">(</span>log_dir<span class="token punctuation">,</span> logFileName<span class="token punctuation">)</span>

    <span class="token comment">## ctrl+c终止程序</span>
    signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">,</span> signal_Handler<span class="token punctuation">)</span>
    signal<span class="token punctuation">.</span>signal<span class="token punctuation">(</span>signal<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> signal_Handler<span class="token punctuation">)</span>

    <span class="token comment">## 打开串口</span>
    ser<span class="token punctuation">,</span>ret <span class="token operator">=</span> openComPort<span class="token punctuation">(</span>ATCOM<span class="token punctuation">,</span> ATBaud<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token boolean">False</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span><span class="token punctuation">:</span>
        exit
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"ATCOM:%s Open Success!"</span> <span class="token operator">%</span>ATCOM<span class="token punctuation">)</span>
    
    <span class="token comment">## 开启接收线程</span>
    trdComRecv <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>threadFunComRecv<span class="token punctuation">)</span>
    trdComRecv<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">## 唤醒模组，模组在睡眠模式中时，第一条命令会唤醒模组，但是无法响应该AT命令，因此先发一条AT命令唤醒模组</span>
    ser<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'AT\r\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Wake up module!"</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">## 退出睡眠模式 AT+QSCLK=0</span>
    ATCMD <span class="token operator">=</span> <span class="token string">"AT+QSCLK=0"</span>
    bytes_written <span class="token operator">=</span> ATSend<span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span>
    <span class="token comment">## 长度加2是因为多了'\r\n'</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_written <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">## 5s内检查是否收到'OK'</span>
        ret <span class="token operator">=</span> checkRecvData<span class="token punctuation">(</span><span class="token string">"OK"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span><span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;[%s] OK \r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;[%s] ERROR \r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"!!!Exit!!!"</span><span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">## 等待模组驻网 AT+CEREG?</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> g_Cereg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ATCMD <span class="token operator">=</span> <span class="token string">"AT+CEREG?"</span>
        bytes_written <span class="token operator">=</span> ATSend<span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_written <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">## 5s内检查是否收到'+CEREG: 0,1'</span>
            ret <span class="token operator">=</span> checkRecvData<span class="token punctuation">(</span><span class="token string">"+CEREG: 0,1"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span><span class="token punctuation">:</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;[%s] OK \r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span><span class="token punctuation">)</span>
                g_Cereg <span class="token operator">=</span> <span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;[%s] ERROR \r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span><span class="token punctuation">)</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"!!!Exit!!!"</span><span class="token punctuation">)</span>
                sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">## 连接TCP服务器 AT+QIOPEN=0,0,"TCP","112.91.141.248",8000,0,1</span>
    ATCMD <span class="token operator">=</span> <span class="token string">"AT+QIOPEN=0,0,\"TCP\",\"112.91.141.248\",8000,0,1"</span>
    bytes_written <span class="token operator">=</span> ATSend<span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_written <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">## 5s内检查是否收到'+QIOPEN: 0'</span>
        ret <span class="token operator">=</span> checkRecvData<span class="token punctuation">(</span><span class="token string">"+QIOPEN: 0,"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">## 模组上电第一次连接TCP服务器时返回+QIOPEN: 0,0</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>g_RecvData<span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"+QIOPEN: 0,0"</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;[%s] OK Firts connection \r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">## 若该TCP连接已存在则回复+QIOPEN: 0,563</span>
            <span class="token keyword">elif</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>g_RecvData<span class="token punctuation">)</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">"+QIOPEN: 0,563"</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;[%s] OK  Existing connection \r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;[%s] ERROR \r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span><span class="token punctuation">)</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"!!!Exit!!!"</span><span class="token punctuation">)</span>
                sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt;[%s] ERROR \r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span><span class="token punctuation">)</span>
            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"!!!Exit!!!"</span><span class="token punctuation">)</span>
            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">## 主线程</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> g_ExitFlag<span class="token punctuation">)</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

        <span class="token comment">## 退出睡眠模式 AT+QISEND=0,1024,"0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789A\r\nA456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234B\r\nB9012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901C\r\nC678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123D\r\nD89012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456E\r\nE12345678901234567890123456789012345678901234567890123456789012345678901\r\n"</span>
        ATCMD<span class="token operator">=</span><span class="token string">"AT+QISEND=0,1024,\"0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789A\r\nA456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234B\r\nB9012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901C\r\nC678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123D\r\nD89012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456E\r\nE12345678901234567890123456789012345678901234567890123456789012345678901\r\n\""</span>
        bytes_written <span class="token operator">=</span> ATSend<span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>bytes_written <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ATCMD<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">## 5s内检查是否收到'"recv"'，表示模组接收到TCP服务器回复的数据</span>
            ret <span class="token operator">=</span> checkRecvData<span class="token punctuation">(</span><span class="token string">"+QIURC: \"recv\","</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
            <span class="token comment">## 记录测试测试、成功次数、失败次数</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> ret<span class="token punctuation">)</span><span class="token punctuation">:</span>
                g_SendSuccCount <span class="token operator">=</span> g_SendSuccCount <span class="token operator">+</span> <span class="token number">1</span>
                g_SendTotleCount <span class="token operator">=</span> g_SendTotleCount <span class="token operator">+</span> <span class="token number">1</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"######SEND SUCC! TOTAL COUNT:%d PASS COUNT:%d FAIL COUNT:%d\r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>g_SendTotleCount<span class="token punctuation">,</span> g_SendSuccCount<span class="token punctuation">,</span> g_SendFailCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                g_SendFailCount <span class="token operator">=</span> g_SendFailCount <span class="token operator">+</span> <span class="token number">1</span>
                g_SendTotleCount <span class="token operator">=</span> g_SendTotleCount <span class="token operator">+</span> <span class="token number">1</span>
                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"######SEND SUCC! TOTAL COUNT:%d PASS COUNT:%d FAIL COUNT:%d\r\n"</span> <span class="token operator">%</span><span class="token punctuation">(</span>g_SendTotleCount<span class="token punctuation">,</span> g_SendSuccCount<span class="token punctuation">,</span> g_SendFailCount<span class="token punctuation">)</span><span class="token punctuation">)</span>

            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

</code></pre> 
<p><strong>使用Python脚本测试：</strong><br> <img src="https://images2.imgbox.com/72/3c/0m9nJblS_o.png" alt="在这里插入图片描述"></p> 
<p><strong>保存的log：</strong><br> <img src="https://images2.imgbox.com/3b/17/tn6pmYGY_o.png" alt="在这里插入图片描述"></p> 
<p><a href="https://download.csdn.net/download/studyingdda/89682638">VScode包（包含运行时环境配置）</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8d936b84882ec5c449d4367016c5ae87/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python自动化脚本：让工作自动化起来</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6019a80f6991f355215c8daccad61d60/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AI文案新纪元：用ChatGPT构建你的文案创作系统</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>