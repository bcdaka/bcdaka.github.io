<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>前端下载文件流，设置返回值类型responseType:‘blob‘无效的问题 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/d905c62caccc20a3a2ef426f71a0130a/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="前端下载文件流，设置返回值类型responseType:‘blob‘无效的问题">
  <meta property="og:description" content="前言： 本是一个非常简单的请求，即是下载文件。通常的做法如下：
1.前端通过Vue Axios向后端请求，同时在请求中设置响应体为Blob格式。
2.后端相应前端的请求，同时返回Blob格式的文件给到前端（如果没有步骤1设置响应体，则后端返回的是一个文件流，前端）
3.前端创建a标签进行下载
提示：如果后端返回的是文件的地址，那么前端可以直接通过window.location.href加文件路径即可下载文件。但是如果后台返回的是文件流，那么前端就需要做一些处理。处理的核心也是将文件流转成文件，然后使用a标签模拟点击下载。
找出问题 &amp;&amp; 解决问题 我遇到的问题也是我想写篇文章记录一下的原因，因为下载文件这样的需求我都写烂了都，觉得这是得心应手的事情，在跟后端对接的时候，我非常坚定是后台返回流有问题（后面打脸了...）
这里我贴上我下载文件实现代码：
1.请求API
重点设置： responseType: &#39;blob&#39; 2.封装的异步请求
3.调用接口，拿到返回值，模拟超链接点击下载文件
以上步骤似乎感觉是妥妥的了，但是我在自测的时候，一整个人蒙住，文件直接是打不开
然后我看控制台的输出，一看，不对劲啊，经过转换应该返回正常的blob格式才对，却是如下：
正式因为如此，导致下载下来的是一个无效的文件。
然后开始进一步的排查，代码都被我看烂了，也没看出来哪里会不对劲，各种百度也都试了，就是没有发现有什么问题。最后也是很突然的，我看到有个博主的文章，真的起到醍醐灌顶的作用，文章其中一句“mock模块会影响原生的ajax请求，使得服务器返回的blob类型变成乱码”，我才惊愕，因为我在项目中却是用到了mock，打开控制台发现，mockjs初始化的时候给拦截响应设置了responseType:&#39;&#39;，证据如下：
终于找到原因了，同时把mock注释掉就可以了。真的是怎么也没有想到是mock模块影响了，可是花了好长一段时间去排查这个问题呢，解决了就好呀！！
下面是正常后拿到的数据格式：
优化 tip：我们可以把模拟a标签下载文件这个逻辑封装起来，如果后面又下载文件的需求的时候，可以直接拿来用即可。
1.封装：获取文件流转成文件，并模拟点击该文件，实现下载
​​​​​​​
2.使用">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-16T11:01:37+08:00">
    <meta property="article:modified_time" content="2024-01-16T11:01:37+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">前端下载文件流，设置返回值类型responseType:‘blob‘无效的问题</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>前言：</h2> 
<p>本是一个非常简单的请求，即是下载文件。通常的做法如下：</p> 
<p>1.前端通过Vue Axios向后端请求，同时在请求中设置响应体为Blob格式。</p> 
<p>2.后端相应前端的请求，同时返回Blob格式的文件给到前端（如果没有步骤1设置响应体，则后端返回的是一个文件流，前端）</p> 
<p>3.前端创建a标签进行下载</p> 
<p><strong>提示：</strong>如果后端返回的是文件的地址，那么前端可以直接通过<span style="color:#faa572;">window.location.href</span>加文件路径即可下载文件。但是如果后台返回的是文件流，那么前端就需要做一些处理。处理的核心也是将文件流转成文件，然后使用a标签模拟点击下载。</p> 
<p><img alt="" height="361" src="https://images2.imgbox.com/15/2b/BtNGVa6G_o.png" width="667"></p> 
<p></p> 
<h2>找出问题 &amp;&amp; 解决问题</h2> 
<p>我遇到的问题也是我想写篇文章记录一下的原因，因为下载文件这样的需求我都写烂了都，觉得这是得心应手的事情，在跟后端对接的时候，我非常坚定是后台返回流有问题（后面打脸了...）</p> 
<p>这里我贴上我下载文件实现代码：</p> 
<p>1.请求API</p> 
<p><img alt="" height="179" src="https://images2.imgbox.com/9f/65/0wSnYJpL_o.png" width="475"></p> 
<p><em>重点设置：</em><span style="color:#ff9900;"><strong> <code>responseType: 'blob'</code></strong></span> </p> 
<p>2.封装的异步请求</p> 
<p><img alt="" height="221" src="https://images2.imgbox.com/12/ca/dPwbFgk0_o.png" width="531"></p> 
<p>3.调用接口，拿到返回值，模拟超链接点击下载文件</p> 
<p><img alt="" height="540" src="https://images2.imgbox.com/66/d7/g11Ig6Po_o.png" width="956"></p> 
<p>以上步骤似乎感觉是妥妥的了，但是我在自测的时候，一整个人蒙住，文件直接是打不开</p> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/db/6b/0S8Wrcuh_o.png" width="1200"></p> 
<p>然后我看控制台的输出，一看，不对劲啊，经过转换应该返回正常的blob格式才对，却是如下：</p> 
<p><img alt="" height="176" src="https://images2.imgbox.com/ec/c2/17NRVWVz_o.png" width="1200">正式因为如此，导致下载下来的是一个无效的文件。</p> 
<p>然后开始进一步的排查，代码都被我看烂了，也没看出来哪里会不对劲，各种百度也都试了，就是没有发现有什么问题。最后也是很突然的，我看到有个博主的文章，真的起到醍醐灌顶的作用，文章其中一句“<strong><code>mock模块会影响原生的ajax请求，使得服务器返回的blob类型变成乱码</code></strong>”，我才惊愕，因为我在项目中却是用到了mock，打开控制台发现，mockjs初始化的时候给拦截响应设置了<code>responseType:''，证据如下：</code></p> 
<p><img alt="" height="448" src="https://images2.imgbox.com/70/51/NqqpMU75_o.png" width="646"></p> 
<p><img alt="" height="649" src="https://images2.imgbox.com/f4/34/JbuOgKld_o.png" width="1200"></p> 
<p> 终于找到原因了，同时把mock注释掉就可以了。真的是怎么也没有想到是mock模块影响了，可是花了好长一段时间去排查这个问题呢，解决了就好呀！！</p> 
<p>下面是正常后拿到的数据格式：</p> 
<p><img alt="" height="272" src="https://images2.imgbox.com/a7/60/Apn31O5a_o.png" width="504"></p> 
<h2>优化</h2> 
<p><span style="color:#ff9900;"><strong>tip</strong></span>：我们可以把模拟a标签下载文件这个逻辑封装起来，如果后面又下载文件的需求的时候，可以直接拿来用即可。</p> 
<p>1.封装：获取文件流转成文件，并模拟点击该文件，实现下载</p> 
<p>​​​​​​​<img alt="" height="511" src="https://images2.imgbox.com/d0/1b/hCLUwoLx_o.png" width="890"></p> 
<p>2.使用</p> 
<p><img alt="" height="360" src="https://images2.imgbox.com/36/4a/qzlgYziX_o.png" width="704"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6e0a1960c3dc9144a833bd47ce3c1009/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MacOS系统 安装ZooKeeper 和常见问题解决</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/526dad2d4f5e721f63334dc10ea24ec5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【SpringBoot3】Spring Boot 3.0 介绍以及新特性</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>