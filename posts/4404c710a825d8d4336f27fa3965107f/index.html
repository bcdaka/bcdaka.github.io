<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C&#43;&#43;的MQTT开发：使用Paho的C&#43;&#43;接口实现消息发布、订阅、连接RabbitMQ - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/4404c710a825d8d4336f27fa3965107f/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="C&#43;&#43;的MQTT开发：使用Paho的C&#43;&#43;接口实现消息发布、订阅、连接RabbitMQ">
  <meta property="og:description" content="C&#43;&#43; Paho实现MQTT消息发布功能 要使用paho的cpp接口实现发布MQTT消息的功能，需要进行以下步骤：
安装paho库：首先从paho官方网站下载并安装paho的C&#43;&#43;库。可以从https://www.eclipse.org/paho/clients/cpp/ 下载适合操作系统的版本。
创建MQTT客户端：可以使用mqtt::client类来创建一个客户端，如下所示：
mqtt::client client(&#34;tcp://broker.example.com:1883&#34;, &#34;clientId&#34;); 在上面的代码中，broker.example.com是您的MQTT代理服务器的地址，1883是MQTT代理服务器的默认端口。clientId是客户端的唯一标识符，可以自己选择一个适合的名字。
设置连接选项：创建客户端后可以设置一些连接选项，例如设置用户名和密码，设置遗嘱消息等。以下是示例代码： mqtt::connect_options connOpts; connOpts.set_user_name(&#34;username&#34;); connOpts.set_password(&#34;password&#34;); connOpts.set_will(mqtt::message(&#34;topic&#34;, &#34;offline&#34;, 1, true)); 在上面的代码中，username和password是您的MQTT代理服务器的登录凭据。topic是遗嘱消息的主题，offline是遗嘱消息的内容，1是遗嘱消息的QoS级别（Quality of Service），true表示遗嘱消息是保留的。
连接到MQTT代理服务器：使用mqtt::client对象的connect方法连接到MQTT代理服务器，如下所示： client.connect(connOpts); 发布消息：使用mqtt::client对象的publish方法发布消息。以下是一个示例代码： std::string payload = &#34;Hello, MQTT!&#34;; client.publish(&#34;topic&#34;, payload.c_str(), payload.length()); 在上面的代码中，topic是消息的主题，payload是消息的内容。您可以根据需要修改这些值。
断开连接：在完成消息发布后，您可以使用mqtt::client对象的disconnect方法断开与MQTT代理服务器的连接，如下所示： client.disconnect(); 这是使用paho的cpp接口发布MQTT消息的基本步骤，实际应用中可能需要处理更多的错误和异常情况。参考paho的官方文档和示例代码来进一步了解和掌握paho的cpp接口的使用。
完整的C&#43;&#43; Paho消息发布的代码演示 #include &lt;iostream&gt; #include &lt;cstring&gt; #include &#34;mqtt/async_client.h&#34; const std::string SERVER_ADDRESS(&#34;tcp://broker.example.com:1883&#34;); const std::string CLIENT_ID(&#34;clientId&#34;); const std::string TOPIC(&#34;topic&#34;); class mqtt_callback : public virtual mqtt::callback { void connection_lost(const std::string&amp; cause) override { std::cout &lt;&lt; &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-02T10:00:35+08:00">
    <meta property="article:modified_time" content="2024-06-02T10:00:35+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C&#43;&#43;的MQTT开发：使用Paho的C&#43;&#43;接口实现消息发布、订阅、连接RabbitMQ</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="C_PahoMQTT_0"></a>C++ Paho实现MQTT消息发布功能</h3> 
<p>要使用paho的cpp接口实现发布MQTT消息的功能，需要进行以下步骤：</p> 
<ol><li> <p>安装paho库：首先从paho官方网站下载并安装paho的C++库。可以从https://www.eclipse.org/paho/clients/cpp/ 下载适合操作系统的版本。</p> </li><li> <p>创建MQTT客户端：可以使用<code>mqtt::client</code>类来创建一个客户端，如下所示：</p> </li></ol> 
<pre><code class="prism language-cpp">mqtt<span class="token double-colon punctuation">::</span>client <span class="token function">client</span><span class="token punctuation">(</span><span class="token string">"tcp://broker.example.com:1883"</span><span class="token punctuation">,</span> <span class="token string">"clientId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在上面的代码中，<code>broker.example.com</code>是您的MQTT代理服务器的地址，<code>1883</code>是MQTT代理服务器的默认端口。<code>clientId</code>是客户端的唯一标识符，可以自己选择一个适合的名字。</p> 
<ol start="3"><li>设置连接选项：创建客户端后可以设置一些连接选项，例如设置用户名和密码，设置遗嘱消息等。以下是示例代码：</li></ol> 
<pre><code class="prism language-cpp">mqtt<span class="token double-colon punctuation">::</span>connect_options connOpts<span class="token punctuation">;</span>
connOpts<span class="token punctuation">.</span><span class="token function">set_user_name</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connOpts<span class="token punctuation">.</span><span class="token function">set_password</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connOpts<span class="token punctuation">.</span><span class="token function">set_will</span><span class="token punctuation">(</span>mqtt<span class="token double-colon punctuation">::</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token string">"offline"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在上面的代码中，<code>username</code>和<code>password</code>是您的MQTT代理服务器的登录凭据。<code>topic</code>是遗嘱消息的主题，<code>offline</code>是遗嘱消息的内容，<code>1</code>是遗嘱消息的QoS级别（Quality of Service），<code>true</code>表示遗嘱消息是保留的。</p> 
<ol start="4"><li>连接到MQTT代理服务器：使用<code>mqtt::client</code>对象的<code>connect</code>方法连接到MQTT代理服务器，如下所示：</li></ol> 
<pre><code class="prism language-cpp">client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>connOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="5"><li>发布消息：使用<code>mqtt::client</code>对象的<code>publish</code>方法发布消息。以下是一个示例代码：</li></ol> 
<pre><code class="prism language-cpp">std<span class="token double-colon punctuation">::</span>string payload <span class="token operator">=</span> <span class="token string">"Hello, MQTT!"</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> payload<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> payload<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在上面的代码中，<code>topic</code>是消息的主题，<code>payload</code>是消息的内容。您可以根据需要修改这些值。</p> 
<ol start="6"><li>断开连接：在完成消息发布后，您可以使用<code>mqtt::client</code>对象的<code>disconnect</code>方法断开与MQTT代理服务器的连接，如下所示：</li></ol> 
<pre><code class="prism language-cpp">client<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这是使用paho的cpp接口发布MQTT消息的基本步骤，实际应用中可能需要处理更多的错误和异常情况。参考paho的官方文档和示例代码来进一步了解和掌握paho的cpp接口的使用。</p> 
<h4><a id="C_Paho_48"></a>完整的C++ Paho消息发布的代码演示</h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mqtt/async_client.h"</span></span>

<span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token function">SERVER_ADDRESS</span><span class="token punctuation">(</span><span class="token string">"tcp://broker.example.com:1883"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token function">CLIENT_ID</span><span class="token punctuation">(</span><span class="token string">"clientId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token function">TOPIC</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">mqtt_callback</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token keyword">virtual</span> mqtt<span class="token double-colon punctuation">::</span><span class="token class-name">callback</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span> <span class="token function">connection_lost</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> cause<span class="token punctuation">)</span> <span class="token keyword">override</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\nConnection lost! Cause: "</span> <span class="token operator">&lt;&lt;</span> cause <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">delivery_complete</span><span class="token punctuation">(</span>mqtt<span class="token double-colon punctuation">::</span>delivery_token_ptr token<span class="token punctuation">)</span> <span class="token keyword">override</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Message delivery complete!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{<!-- --></span>
        mqtt<span class="token double-colon punctuation">::</span>async_client <span class="token function">client</span><span class="token punctuation">(</span>SERVER_ADDRESS<span class="token punctuation">,</span> CLIENT_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mqtt<span class="token double-colon punctuation">::</span>connect_options conn_opts<span class="token punctuation">;</span>
        mqtt_callback cb<span class="token punctuation">;</span>

        client<span class="token punctuation">.</span><span class="token function">set_callback</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>conn_opts<span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>string payload <span class="token operator">=</span> <span class="token string">"Hello, MQTT!"</span><span class="token punctuation">;</span>
        mqtt<span class="token double-colon punctuation">::</span>message_ptr pubmsg <span class="token operator">=</span> mqtt<span class="token double-colon punctuation">::</span><span class="token function">make_message</span><span class="token punctuation">(</span>TOPIC<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>pubmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        client<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> mqtt<span class="token double-colon punctuation">::</span>exception<span class="token operator">&amp;</span> exc<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error: "</span> <span class="token operator">&lt;&lt;</span> exc<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这段代码中，我们包含了必要的头文件，并定义了MQTT服务器地址、客户端ID和主题。我们还定义了一个自定义的回调类<code>mqtt_callback</code>，它继承自<code>mqtt::callback</code>，用于处理连接丢失和消息传递完成事件。</p> 
<p>在<code>main()</code>函数内部创建了一个带有服务器地址和客户端ID的<code>mqtt::async_client</code>对象。我们还创建了一个<code>mqtt::connect_options</code>对象来指定连接选项。使用<code>client.set_callback(cb)</code>为客户端设置回调函数，其中<code>cb</code>是<code>mqtt_callback</code>类的一个实例。</p> 
<p>我们使用<code>client.connect(conn_opts)</code>建立与MQTT服务器的连接。如果连接成功，我们使用<code>mqtt::make_message()</code>创建一个带有所需负载和主题的MQTT消息。</p> 
<p>最后，使用<code>client.publish(pubmsg)</code>发布消息，并使用<code>client.disconnect()</code>断开与MQTT服务器的连接。</p> 
<h3><a id="C_Paho_MQTT_109"></a>客户端：C++ Paho实现 MQTT的客户端</h3> 
<h4><a id="mqttclient_111"></a>同步客户端：mqtt::client</h4> 
<p>在paho库中，<code>mqtt::client</code>和<code>mqtt::async_client</code>是MQTT客户端的两种不同实现方式。</p> 
<p><code>mqtt::client</code>是同步的客户端实现，它在发送和接收消息时会阻塞当前线程，直到操作完成或发生超时。这意味着您需要手动管理线程和处理并发操作。使用<code>mqtt::client</code>可以更容易地编写简单的同步代码，特别适用于简单的MQTT应用程序或在没有并发需求的情况下。</p> 
<p>以下是使用<code>mqtt::client</code>的示例代码：</p> 
<pre><code class="prism language-cpp">mqtt<span class="token double-colon punctuation">::</span>client <span class="token function">client</span><span class="token punctuation">(</span><span class="token string">"tcp://broker.example.com:1883"</span><span class="token punctuation">,</span> <span class="token string">"clientId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Connect to the MQTT broker</span>
client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Publish a message</span>
client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token string">"Hello, MQTT!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Subscribe to a topic</span>
client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Wait for incoming messages</span>
mqtt<span class="token double-colon punctuation">::</span>message_ptr msg <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">consume_message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Disconnect from the MQTT broker</span>
client<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="mqttasync_client_137"></a>异步客户端：mqtt::async_client</h4> 
<p>另一方面，<code>mqtt::async_client</code>是异步的客户端实现，它使用了异步操作和回调函数来处理发送和接收消息，不会阻塞当前线程。这意味着您可以在一个线程中同时处理多个操作，包括异步地发送和接收消息。使用<code>mqtt::async_client</code>可以更好地处理并发操作和复杂的MQTT应用程序。</p> 
<p>以下是使用<code>mqtt::async_client</code>的示例代码：</p> 
<pre><code class="prism language-cpp">mqtt<span class="token double-colon punctuation">::</span>async_client <span class="token function">client</span><span class="token punctuation">(</span><span class="token string">"tcp://broker.example.com:1883"</span><span class="token punctuation">,</span> <span class="token string">"clientId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Connect to the MQTT broker</span>
mqtt<span class="token double-colon punctuation">::</span>token_ptr conntok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
conntok<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Publish a message</span>
mqtt<span class="token double-colon punctuation">::</span>token_ptr pubtok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token string">"Hello, MQTT!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pubtok<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Subscribe to a topic</span>
mqtt<span class="token double-colon punctuation">::</span>token_ptr subtok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
subtok<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Wait for incoming messages</span>
client<span class="token punctuation">.</span><span class="token function">start_consuming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Disconnect from the MQTT broker</span>
mqtt<span class="token double-colon punctuation">::</span>token_ptr disctok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
disctok<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>虽然<code>mqtt::async_client</code>提供了更强大的功能和更好的并发性能，但它需要更多的代码和处理异步回调函数。如果应用程序需要处理大量的并发操作或实现复杂的MQTT逻辑，推荐使用<code>mqtt::async_client</code>。但如果只需要简单的同步操作或在单线程环境中运行较简单的MQTT应用程序，那么使用<code>mqtt::client</code>可能更合适。应该根据您的具体需求和应用程序的复杂性选择适合的客户端实现方式。</p> 
<h3><a id="C_Pahorabbitmq_168"></a>使用C++ Paho连接rabbitmq</h3> 
<p>下面是一个简单的示例代码，演示了如何使用Paho C++库连接到RabbitMQ并发布和订阅消息：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mqtt/async_client.h&gt;</span></span>

<span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token function">SERVER_ADDRESS</span><span class="token punctuation">(</span><span class="token string">"tcp://localhost:1883"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token function">CLIENT_ID</span><span class="token punctuation">(</span><span class="token string">"paho_cpp_async"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token function">TOPIC</span><span class="token punctuation">(</span><span class="token string">"test_topic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">callback</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token keyword">virtual</span> mqtt<span class="token double-colon punctuation">::</span><span class="token class-name">callback</span><span class="token punctuation">,</span> <span class="token keyword">public</span> <span class="token keyword">virtual</span> mqtt<span class="token double-colon punctuation">::</span><span class="token class-name">iaction_listener</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    mqtt<span class="token double-colon punctuation">::</span>async_client<span class="token operator">&amp;</span> client_<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>mqtt<span class="token double-colon punctuation">::</span>async_client<span class="token operator">&amp;</span> client<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">client_</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">connection_lost</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> cause<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\nConnection lost"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cause<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\tcause: "</span> <span class="token operator">&lt;&lt;</span> cause <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">delivery_complete</span><span class="token punctuation">(</span>mqtt<span class="token double-colon punctuation">::</span>delivery_token_ptr token<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">message_arrived</span><span class="token punctuation">(</span><span class="token keyword">const</span> mqtt<span class="token double-colon punctuation">::</span>const_message_ptr msg<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Message arrived: "</span> <span class="token operator">&lt;&lt;</span> msg<span class="token operator">-&gt;</span><span class="token function">get_payload_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">on_failure</span><span class="token punctuation">(</span><span class="token keyword">const</span> mqtt<span class="token double-colon punctuation">::</span>token<span class="token operator">&amp;</span> tok<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Connection attempt failed"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">on_success</span><span class="token punctuation">(</span><span class="token keyword">const</span> mqtt<span class="token double-colon punctuation">::</span>token<span class="token operator">&amp;</span> tok<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Connection attempt successful"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

        <span class="token comment">// 发布消息</span>
        mqtt<span class="token double-colon punctuation">::</span>message_ptr pubmsg <span class="token operator">=</span> mqtt<span class="token double-colon punctuation">::</span><span class="token function">make_message</span><span class="token punctuation">(</span>TOPIC<span class="token punctuation">,</span> <span class="token string">"Hello from Paho C++"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pubmsg<span class="token operator">-&gt;</span><span class="token function">set_qos</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        client_<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>pubmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    mqtt<span class="token double-colon punctuation">::</span>async_client <span class="token function">client</span><span class="token punctuation">(</span>SERVER_ADDRESS<span class="token punctuation">,</span> CLIENT_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

    callback <span class="token function">cb</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">set_callback</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mqtt<span class="token double-colon punctuation">::</span>connect_options connOpts<span class="token punctuation">;</span>
    connOpts<span class="token punctuation">.</span><span class="token function">set_clean_session</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Connecting to the MQTT server..."</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        mqtt<span class="token double-colon punctuation">::</span>token_ptr conntok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>connOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        conntok<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Connected!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

        <span class="token comment">// 订阅消息</span>
        client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>TOPIC<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 持续监听消息</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> mqtt<span class="token double-colon punctuation">::</span>exception<span class="token operator">&amp;</span> exc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error: "</span> <span class="token operator">&lt;&lt;</span> exc<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个示例代码创建了一个异步的MQTT客户端，并连接到RabbitMQ服务器。它使用一个回调类来处理与连接、消息到达等事件相关的回调。在<code>on_success</code>回调中，它发布一条消息。在<code>message_arrived</code>回调中，它处理接收到的消息。</p> 
<ol start="3"><li>编译和运行代码：使用适当的编译器和选项，将代码编译为可执行文件。确保已经安装了Paho C++库，并在编译时链接到该库。然后运行可执行文件。</li></ol> 
<p>这样就可以使用Paho C++库连接到RabbitMQ并进行消息发布和订阅操作了。</p> 
<p>本示例代码仅提供了一个基本的框架，需要根据自己的需求进行更多的自定义和错误处理。此外，确保已正确配置RabbitMQ服务器的连接参数，如服务器地址、端口和认证信息等。</p> 
<h3><a id="_258"></a>补充说明</h3> 
<h4><a id="_259"></a>连续发送消息的注意事项</h4> 
<p>在连续发送多条消息时避免频繁断开和重连MQTT客户端。频繁的断开和重连会增加网络开销和延迟，并且可能会对MQTT服务器造成不必要的负担。保持MQTT客户端的持久连接，并在需要时使用同一连接发送多条消息。</p> 
<p>以下示例展示如何保持MQTT客户端的持久连接，并连续发送多条消息：</p> 
<pre><code class="prism language-cpp">mqtt<span class="token double-colon punctuation">::</span>async_client <span class="token function">client</span><span class="token punctuation">(</span><span class="token string">"tcp://broker.example.com:1883"</span><span class="token punctuation">,</span> <span class="token string">"clientId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Connect to the MQTT broker</span>
mqtt<span class="token double-colon punctuation">::</span>connect_options connOpts<span class="token punctuation">;</span>
connOpts<span class="token punctuation">.</span><span class="token function">set_keep_alive_interval</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 设置心跳间隔为60秒</span>
connOpts<span class="token punctuation">.</span><span class="token function">set_clean_session</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 设置为非清理会话模式</span>
mqtt<span class="token double-colon punctuation">::</span>token_ptr conntok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>connOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
conntok<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Publish multiple messages</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string topic <span class="token operator">=</span> <span class="token string">"topic"</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string payload <span class="token operator">=</span> <span class="token string">"Message "</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mqtt<span class="token double-colon punctuation">::</span>message_ptr pubmsg <span class="token operator">=</span> mqtt<span class="token double-colon punctuation">::</span><span class="token function">make_message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mqtt<span class="token double-colon punctuation">::</span>token_ptr pubtok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>pubmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pubtok<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Disconnect from the MQTT broker</span>
mqtt<span class="token double-colon punctuation">::</span>token_ptr disctok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
disctok<span class="token operator">-&gt;</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在上述示例中，使用<code>set_keep_alive_interval()</code>方法设置了心跳间隔为60秒，这样可以确保MQTT客户端与服务器保持持久连接。我们还使用<code>set_clean_session(false)</code>将客户端设置为非清理会话模式，这样即使客户端断开连接，会话状态也会保留。</p> 
<p>然后，我们使用一个循环来连续发布多条消息。每次循环中，我们创建一个新的消息并使用<code>client.publish()</code>发送。通过保持持久连接，我们可以在同一连接上连续发送多条消息，而不需要频繁断开和重连。</p> 
<p>最后，使用<code>client.disconnect()</code>来断开与MQTT服务器的连接。</p> 
<p>具体的MQTT应用程序可能会有不同的需求和限制。如果应用程序需要在发送消息之间有较长的时间间隔，或者需要处理长时间的非活动状态，那么可以考虑在一段时间后断开连接，并在需要时重新连接。为了连续发送多条消息，建议保持MQTT客户端的持久连接，避免频繁断开和重连。这样可以减少网络开销并提高性能。</p> 
<h4><a id="wait_298"></a>如果无需同步，是否需要wait</h4> 
<p>如果不需要等待异步操作完成，那么在使用<code>mqtt::token</code>对象的时候可以选择不调用<code>wait</code>方法。<code>wait</code>方法会阻塞当前线程，直到操作完成或发生超时。如果您不调用<code>wait</code>方法，程序将继续执行下一行代码，而不会等待操作完成。</p> 
<p>以下是一个不调用<code>wait</code>方法的情况：</p> 
<pre><code class="prism language-cpp">mqtt<span class="token double-colon punctuation">::</span>async_client <span class="token function">client</span><span class="token punctuation">(</span><span class="token string">"tcp://broker.example.com:1883"</span><span class="token punctuation">,</span> <span class="token string">"clientId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Connect to the MQTT broker</span>
mqtt<span class="token double-colon punctuation">::</span>token_ptr conntok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 不调用wait方法，程序继续执行下一行代码</span>

<span class="token comment">// Publish a message</span>
mqtt<span class="token double-colon punctuation">::</span>token_ptr pubtok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token string">"Hello, MQTT!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 不调用wait方法，程序继续执行下一行代码</span>

<span class="token comment">// Subscribe to a topic</span>
mqtt<span class="token double-colon punctuation">::</span>token_ptr subtok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 不调用wait方法，程序继续执行下一行代码</span>

<span class="token comment">// Wait for incoming messages</span>
client<span class="token punctuation">.</span><span class="token function">start_consuming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Disconnect from the MQTT broker</span>
mqtt<span class="token double-colon punctuation">::</span>token_ptr disctok <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 不调用wait方法，程序继续执行下一行代码</span>
</code></pre> 
<p>上述示例创建了一个<code>mqtt::async_client</code>对象，并进行了连接、发布消息、订阅主题和断开连接的操作。但是我们没有调用<code>wait</code>方法等待操作完成。这意味着程序将继续执行下一行代码，而不会等待操作完成。</p> 
<p>请注意，如果不调用<code>wait</code>方法，将无法确定操作是否成功完成。如果需要获取操作的结果或处理操作的回调函数，可能需要调用<code>wait_for_completion</code>方法或使用其他适当的方式来处理异步操作的结果。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a30b03decf40c336814f38738f74b845/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL学习——从命令行调用MySQL 程序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fa95d2294ac18689acb6e67e2a397995/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C&#43;&#43;】：string类底层的模拟实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>