<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>AI大模型探索之路-实战篇15： Agent智能数据分析平台之整合封装Tools和Memory功能代码 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/6187384159e26e62e5b11cd87da54788/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="AI大模型探索之路-实战篇15： Agent智能数据分析平台之整合封装Tools和Memory功能代码">
  <meta property="og:description" content="系列篇章💥 AI大模型探索之路-实战篇4：深入DB-GPT数据应用开发框架调研
AI大模型探索之路-实战篇5：探索Open Interpreter开放代码解释器调研
AI大模型探索之路-实战篇6：掌握Function Calling的详细流程
AI大模型探索之路-实战篇7：Function Calling技术实战自动生成函数
AI大模型探索之路-实战篇8：多轮对话与Function Calling技术应用
AI大模型探索之路-实战篇9：探究Agent智能数据分析平台的架构与功能
AI大模型探索之路-实战篇10：数据预处理的艺术：构建Agent智能数据分析平台的基础
AI大模型探索之路-实战篇11： Function Calling技术整合：强化Agent智能数据分析平台功能
AI大模型探索之路-实战篇12： 构建互动式Agent智能数据分析平台：实现多轮对话控制
AI大模型探索之路-实战篇13： 从对话到报告：打造能记录和分析的Agent智能数据分析平台
AI大模型探索之路-实战篇14： 集成本地Python代码解释器：强化Agent智能数据分析平台
目录 系列篇章💥一、前言二、Memory功能实现之在线云盘类封装1、创建OpenAi客户端2、定义本地云盘文件目录创建方法3、定义doc文档创建方法4、定义文件内容追加方法5、定义获取文件内容的方法6、定义清理文件内容的方法7、定义获取文件列表的方法8、定义文件重命名的方法9、定义删除文件的方法10、定义追加图片的方法11、定义一个云盘文件操作类 三、Memory功能实现之消息工具类封装1、定义消息管理类2、测试-查看消息管理器3、测试-追加消息4、测试-删除消息5、添加背景知识 四、Tools功能之函数封装1、获取表结构基本信息（工具函数）2、提取SQL数据到python变量（辅助函数）3、python代码解释器（工具函数）4、function函数信息生成器（辅助函数）5、function函数调用辅助类 三、结语 一、前言 在前面篇章中我们实现了Agent智能数据分析平台中的Tools和Memory相关代码落地实践，本文中我们将对这两大块功能代码进行整合封装。
二、Memory功能实现之在线云盘类封装 1、创建OpenAi客户端 ## 导入依赖 import openai import os import numpy as np import pandas as pd import json import io from openai import OpenAI import inspect import pymysql import tiktoken from docx import Document import matplotlib.pyplot as plt import seaborn as sns import tempfile import ast from IPython.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-04T07:46:00+08:00">
    <meta property="article:modified_time" content="2024-06-04T07:46:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">AI大模型探索之路-实战篇15： Agent智能数据分析平台之整合封装Tools和Memory功能代码</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_1"></a>系列篇章💥</h2> 
<p><a href="https://xundaomalu.blog.csdn.net/article/details/139169884" rel="nofollow">AI大模型探索之路-实战篇4：深入DB-GPT数据应用开发框架调研</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139190028" rel="nofollow">AI大模型探索之路-实战篇5：探索Open Interpreter开放代码解释器调研</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139186663" rel="nofollow">AI大模型探索之路-实战篇6：掌握Function Calling的详细流程</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139193382" rel="nofollow">AI大模型探索之路-实战篇7：Function Calling技术实战自动生成函数</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139194151" rel="nofollow">AI大模型探索之路-实战篇8：多轮对话与Function Calling技术应用</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139205615" rel="nofollow">AI大模型探索之路-实战篇9：探究Agent智能数据分析平台的架构与功能</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139216544" rel="nofollow">AI大模型探索之路-实战篇10：数据预处理的艺术：构建Agent智能数据分析平台的基础</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139216752" rel="nofollow">AI大模型探索之路-实战篇11： Function Calling技术整合：强化Agent智能数据分析平台功能</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139372376" rel="nofollow">AI大模型探索之路-实战篇12： 构建互动式Agent智能数据分析平台：实现多轮对话控制</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139391333?spm=1001.2014.3001.5502" rel="nofollow">AI大模型探索之路-实战篇13： 从对话到报告：打造能记录和分析的Agent智能数据分析平台</a><br> <a href="https://xundaomalu.blog.csdn.net/article/details/139399366" rel="nofollow">AI大模型探索之路-实战篇14： 集成本地Python代码解释器：强化Agent智能数据分析平台</a></p> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">系列篇章💥</a></li><li><a href="#_21" rel="nofollow">一、前言</a></li><li><a href="#Memory_23" rel="nofollow">二、Memory功能实现之在线云盘类封装</a></li><li><ul><li><a href="#1OpenAi_24" rel="nofollow">1、创建OpenAi客户端</a></li><li><a href="#2_53" rel="nofollow">2、定义本地云盘文件目录创建方法</a></li><li><a href="#3doc_78" rel="nofollow">3、定义doc文档创建方法</a></li><li><a href="#4_112" rel="nofollow">4、定义文件内容追加方法</a></li><li><a href="#5_151" rel="nofollow">5、定义获取文件内容的方法</a></li><li><a href="#6_193" rel="nofollow">6、定义清理文件内容的方法</a></li><li><a href="#7_218" rel="nofollow">7、定义获取文件列表的方法</a></li><li><a href="#8_237" rel="nofollow">8、定义文件重命名的方法</a></li><li><a href="#9_258" rel="nofollow">9、定义删除文件的方法</a></li><li><a href="#10_288" rel="nofollow">10、定义追加图片的方法</a></li><li><a href="#11_348" rel="nofollow">11、定义一个云盘文件操作类</a></li></ul> 
  </li><li><a href="#Memory_433" rel="nofollow">三、Memory功能实现之消息工具类封装</a></li><li><ul><li><a href="#1_434" rel="nofollow">1、定义消息管理类</a></li><li><a href="#2_648" rel="nofollow">2、测试-查看消息管理器</a></li><li><a href="#3_656" rel="nofollow">3、测试-追加消息</a></li><li><a href="#4_669" rel="nofollow">4、测试-删除消息</a></li><li><a href="#5_677" rel="nofollow">5、添加背景知识</a></li></ul> 
  </li><li><a href="#Tools_698" rel="nofollow">四、Tools功能之函数封装</a></li><li><ul><li><a href="#1_699" rel="nofollow">1、获取表结构基本信息（工具函数）</a></li><li><a href="#2SQLpython_744" rel="nofollow">2、提取SQL数据到python变量（辅助函数）</a></li><li><a href="#3python_787" rel="nofollow">3、python代码解释器（工具函数）</a></li><li><a href="#4function_916" rel="nofollow">4、function函数信息生成器（辅助函数）</a></li><li><a href="#5function_975" rel="nofollow">5、function函数调用辅助类</a></li></ul> 
  </li><li><a href="#_1062" rel="nofollow">三、结语</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_21"></a>一、前言</h2> 
<p>在前面篇章中我们实现了Agent智能数据分析平台中的Tools和Memory相关代码落地实践，本文中我们将对这两大块功能代码进行整合封装。</p> 
<h2><a id="Memory_23"></a>二、Memory功能实现之在线云盘类封装</h2> 
<h3><a id="1OpenAi_24"></a>1、创建OpenAi客户端</h3> 
<pre><code class="prism language-python"><span class="token comment">## 导入依赖</span>
<span class="token keyword">import</span> openai
<span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> json
<span class="token keyword">import</span> io
<span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI
<span class="token keyword">import</span> inspect
<span class="token keyword">import</span> pymysql
<span class="token keyword">import</span> tiktoken
<span class="token keyword">from</span> docx <span class="token keyword">import</span> Document
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> seaborn <span class="token keyword">as</span> sns
<span class="token keyword">import</span> tempfile
<span class="token keyword">import</span> ast
<span class="token keyword">from</span> IPython<span class="token punctuation">.</span>display <span class="token keyword">import</span> display<span class="token punctuation">,</span> Markdown<span class="token punctuation">,</span> Code
<span class="token keyword">import</span> shutil
<span class="token keyword">import</span> copy
<span class="token keyword">from</span> openai <span class="token keyword">import</span>  APIConnectionError<span class="token punctuation">,</span>AuthenticationError

openai<span class="token punctuation">.</span>api_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span>

client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>api_key<span class="token operator">=</span>openai<span class="token punctuation">.</span>api_key<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2_53"></a>2、定义本地云盘文件目录创建方法</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os

<span class="token keyword">def</span> <span class="token function">create_or_get_folder</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    根据项目创建云盘目录
    """</span>
    base_path <span class="token operator">=</span> <span class="token string">"/root/autodl-tmp/iquery项目/iquery云盘"</span>
    full_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_path<span class="token punctuation">,</span> folder_name<span class="token punctuation">)</span>
    <span class="token comment"># 如果目录不存在，则创建它</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>full_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>full_path<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"目录 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>folder_name<span class="token punctuation">}</span></span><span class="token string"> 创建成功"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"目录 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>folder_name<span class="token punctuation">}</span></span><span class="token string"> 已存在"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> full_path
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>create_or_get_folder<span class="token punctuation">(</span>folder_name <span class="token operator">=</span> <span class="token string">"测试函数"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/60/38/mCV3at7F_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3doc_78"></a>3、定义doc文档创建方法</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">create_or_get_doc</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">,</span> doc_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    创建或获取文件路径
    """</span>
    base_path <span class="token operator">=</span> <span class="token string">"/root/autodl-tmp/iquery项目/iquery云盘"</span>
    full_path_folder<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_path<span class="token punctuation">,</span>folder_name<span class="token punctuation">)</span>
    file_path_doc <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_path<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>folder_name<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>doc_name<span class="token punctuation">}</span></span><span class="token string">.doc'</span></span><span class="token punctuation">)</span>
    
    
     <span class="token comment"># 检查目录是否存在，如果不存在则创建</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>full_path_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>full_path_folder<span class="token punctuation">)</span>
    
    <span class="token comment"># 检查文件是否存在</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_path_doc<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 文件存在，打开并追加内容</span>
        document <span class="token operator">=</span> Document<span class="token punctuation">(</span>file_path_doc<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 文件不存在，创建一个新的文档对象</span>
        document <span class="token operator">=</span> Document<span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token comment"># 保存文档</span>
    document<span class="token punctuation">.</span>save<span class="token punctuation">(</span>file_path_doc<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> file_path_doc
</code></pre> 
<pre><code class="prism language-python">create_or_get_doc<span class="token punctuation">(</span>folder_name<span class="token operator">=</span><span class="token string">"测试函数"</span><span class="token punctuation">,</span>doc_name<span class="token operator">=</span><span class="token string">"数据分析"</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8e/75/a9PI3Wce_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_112"></a>4、定义文件内容追加方法</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">append_content_in_doc</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">,</span> doc_name<span class="token punctuation">,</span> qa_string<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""""
    往文件里追加内容
    @param folder_name=目录名，doc_name=文件名，qa_string=追加的内容
    """</span>
    base_path <span class="token operator">=</span> <span class="token string">"/root/autodl-tmp/iquery项目/iquery云盘"</span>
    <span class="token comment">## 目录地址</span>
    full_path_folder<span class="token operator">=</span>base_path<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>folder_name
    <span class="token comment">## 文件地址</span>
    full_path_doc <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>full_path_folder<span class="token punctuation">,</span> doc_name<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".doc"</span>  

    <span class="token comment"># 检查目录是否存在，如果不存在则创建</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>full_path_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>full_path_folder<span class="token punctuation">)</span>
    
    <span class="token comment"># 检查文件是否存在</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>full_path_doc<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 文件存在，打开并追加内容</span>
        document <span class="token operator">=</span> Document<span class="token punctuation">(</span>full_path_doc<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 文件不存在，创建一个新的文档对象</span>
        document <span class="token operator">=</span> Document<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 追加内容</span>
    document<span class="token punctuation">.</span>add_paragraph<span class="token punctuation">(</span>qa_string<span class="token punctuation">)</span>
    <span class="token comment"># 保存文档</span>
    document<span class="token punctuation">.</span>save<span class="token punctuation">(</span>full_path_doc<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"内容已追加到 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>doc_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

</code></pre> 
<p>测试</p> 
<pre><code class="prism language-python">my_dict <span class="token operator">=</span> <span class="token string">"天青色等烟雨，而我在等你"</span>
append_content_in_doc<span class="token punctuation">(</span>folder_name<span class="token operator">=</span><span class="token string">"测试函数"</span><span class="token punctuation">,</span>doc_name<span class="token operator">=</span><span class="token string">"数据分析"</span><span class="token punctuation">,</span>qa_string<span class="token operator">=</span>my_dict<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/44/ee/9JfdSSPS_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_151"></a>5、定义获取文件内容的方法</h3> 
<pre><code class="prism language-python"><span class="token comment">## 实现根据项目和文件获取文件内容的方法</span>

<span class="token keyword">from</span> docx <span class="token keyword">import</span> Document
<span class="token keyword">import</span> os

<span class="token keyword">def</span> <span class="token function">get_file_content</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">,</span> doc_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    实现根据项目名和文件名获取文件内容的方法
    @param project_name:项目名，file_name：文件名
    @return 文件内容
    """</span>
    <span class="token comment"># 构建文件的完整路径</span>
    base_path <span class="token operator">=</span> <span class="token string">"/root/autodl-tmp/iquery项目/iquery云盘"</span>
    file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>folder_name<span class="token punctuation">,</span> doc_name<span class="token punctuation">)</span>
    full_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_path<span class="token punctuation">,</span> file_path<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".doc"</span>
 
    <span class="token comment"># 确保文件存在</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>full_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"文件不存在"</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 加载文档</span>
        doc <span class="token operator">=</span> Document<span class="token punctuation">(</span>full_path<span class="token punctuation">)</span>
        content <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        
        <span class="token comment"># 遍历文档中的每个段落，并收集文本</span>
        <span class="token keyword">for</span> para <span class="token keyword">in</span> doc<span class="token punctuation">.</span>paragraphs<span class="token punctuation">:</span>
            content<span class="token punctuation">.</span>append<span class="token punctuation">(</span>para<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
        
        <span class="token comment"># 将所有段落文本合并成一个字符串返回</span>
        <span class="token keyword">return</span> <span class="token string">'\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>content<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"读取文件时发生错误: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</code></pre> 
<p>测试</p> 
<pre><code class="prism language-python">get_file_content<span class="token punctuation">(</span>folder_name<span class="token operator">=</span><span class="token string">"测试函数"</span><span class="token punctuation">,</span>doc_name<span class="token operator">=</span><span class="token string">"数据分析"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="6_193"></a>6、定义清理文件内容的方法</h3> 
<pre><code class="prism language-python"><span class="token keyword">from</span> docx <span class="token keyword">import</span> Document

<span class="token keyword">def</span> <span class="token function">clear_content_in_doc</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">,</span> doc_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 打开文档</span>
    base_path <span class="token operator">=</span> <span class="token string">"/root/autodl-tmp/iquery项目/iquery云盘"</span>
    file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_path<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>folder_name<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>doc_name<span class="token punctuation">}</span></span><span class="token string">.doc'</span></span><span class="token punctuation">)</span>
    doc <span class="token operator">=</span> Document<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>

    <span class="token comment"># 遍历每一个段落，设置其文本为空字符串</span>
    <span class="token keyword">for</span> p <span class="token keyword">in</span> doc<span class="token punctuation">.</span>paragraphs<span class="token punctuation">:</span>
        <span class="token keyword">for</span> run <span class="token keyword">in</span> p<span class="token punctuation">.</span>runs<span class="token punctuation">:</span>
            run<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token string">''</span>

    <span class="token comment"># 保存修改后的文档</span>
    doc<span class="token punctuation">.</span>save<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"文档内容清除完毕"</span><span class="token punctuation">)</span>
</code></pre> 
<p>测试</p> 
<pre><code class="prism language-python">clear_content_in_doc<span class="token punctuation">(</span>folder_name<span class="token operator">=</span><span class="token string">"测试函数"</span><span class="token punctuation">,</span>doc_name<span class="token operator">=</span><span class="token string">"数据分析"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="7_218"></a>7、定义获取文件列表的方法</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">list_files_in_folder</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    列举当前文件夹的全部文件
    """</span>
    base_path <span class="token operator">=</span> <span class="token string">"/root/autodl-tmp/iquery项目/iquery云盘"</span>
    full_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_path<span class="token punctuation">,</span>folder_name <span class="token punctuation">)</span>
    file_names <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>full_path<span class="token punctuation">)</span> <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>full_path<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        
    <span class="token keyword">return</span> file_names
</code></pre> 
<p>测试</p> 
<pre><code class="prism language-python">list_files_in_folder<span class="token punctuation">(</span>folder_name<span class="token operator">=</span><span class="token string">"测试函数"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="8_237"></a>8、定义文件重命名的方法</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">rename_doc</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">,</span> doc_name<span class="token punctuation">,</span> new_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    修改指定的文档名称
    """</span>
    base_path <span class="token operator">=</span> <span class="token string">"/root/autodl-tmp/iquery项目/iquery云盘"</span>
    file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_path<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>folder_name<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>doc_name<span class="token punctuation">}</span></span><span class="token string">.doc'</span></span><span class="token punctuation">)</span>
    new_file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_path<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>folder_name<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>new_name<span class="token punctuation">}</span></span><span class="token string">.doc'</span></span><span class="token punctuation">)</span>
    <span class="token comment"># 重命名文件</span>
    os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> new_file_path<span class="token punctuation">)</span>
      
    <span class="token keyword">return</span> new_name
</code></pre> 
<p>测试</p> 
<pre><code class="prism language-python">rename_doc<span class="token punctuation">(</span>folder_name<span class="token operator">=</span><span class="token string">"测试函数"</span><span class="token punctuation">,</span>doc_name<span class="token operator">=</span><span class="token string">"数据分析"</span><span class="token punctuation">,</span>new_name<span class="token operator">=</span><span class="token string">"数据可视化分析报告"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="9_258"></a>9、定义删除文件的方法</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">delete_all_files_in_folder</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    删除某文件夹内全部文件
    """</span>
    <span class="token comment"># 定义要删除的目录路径</span>
    base_path <span class="token operator">=</span> <span class="token string">"/root/autodl-tmp/iquery项目/iquery云盘"</span>
    full_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>base_path<span class="token punctuation">,</span>folder_name<span class="token punctuation">)</span>
    <span class="token comment"># 遍历整个目录</span>
    <span class="token keyword">for</span> filename <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>full_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 构造文件或者文件夹的绝对路径</span>
        file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>full_path<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># 如果是文件，则删除文件</span>
            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token keyword">or</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>islink<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
                os<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
            <span class="token comment"># 如果是文件夹，则删除文件夹</span>
            <span class="token keyword">elif</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
                shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"文件已清除完毕"</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Failed to delete %s. Reason: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>测试</p> 
<pre><code class="prism language-python">delete_all_files_in_folder<span class="token punctuation">(</span>folder_name <span class="token operator">=</span> <span class="token string">"测试函数"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="10_288"></a>10、定义追加图片的方法</h3> 
<pre><code class="prism language-python">	<span class="token keyword">from</span> docx <span class="token keyword">import</span> Document
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> os
<span class="token keyword">import</span> tempfile

<span class="token keyword">def</span> <span class="token function">append_img_in_doc</span><span class="token punctuation">(</span>folder_name<span class="token punctuation">,</span> doc_name<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""""
    往文件里追加图片
    @param folder_name=目录名，doc_name=文件名，img=图片对象，数据类型为matplotlib.figure.Figure对象
    """</span>
    base_path <span class="token operator">=</span> <span class="token string">"/root/autodl-tmp/iquery项目/iquery云盘"</span>
    <span class="token comment">## 目录地址</span>
    full_path_folder<span class="token operator">=</span>base_path<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>folder_name
    <span class="token comment">## 文件地址</span>
    full_path_doc <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>full_path_folder<span class="token punctuation">,</span> doc_name<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">".doc"</span>
    

    <span class="token comment"># 检查目录是否存在，如果不存在则创建</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>full_path_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>full_path_folder<span class="token punctuation">)</span>
    
    <span class="token comment"># 检查文件是否存在</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>full_path_doc<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>full_path_doc<span class="token punctuation">)</span>
        <span class="token comment"># 文件存在，打开并追加内容</span>
        document <span class="token operator">=</span> Document<span class="token punctuation">(</span>full_path_doc<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># 文件不存在，创建一个新的文档对象</span>
        document <span class="token operator">=</span> Document<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 追加图片</span>
    <span class="token comment"># 将matplotlib的Figure对象保存为临时图片文件</span>
    <span class="token keyword">with</span> tempfile<span class="token punctuation">.</span>NamedTemporaryFile<span class="token punctuation">(</span>delete<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> suffix<span class="token operator">=</span><span class="token string">'.png'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tmpfile<span class="token punctuation">:</span>
        img<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span>tmpfile<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'png'</span><span class="token punctuation">)</span>
        <span class="token comment"># 将图片插入到.docx文档中</span>
        document<span class="token punctuation">.</span>add_picture<span class="token punctuation">(</span>tmpfile<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    
    <span class="token comment"># 保存文档</span>
    document<span class="token punctuation">.</span>save<span class="token punctuation">(</span>full_path_doc<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"图片已追加到 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>doc_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token comment"># 创建一个图形</span>
fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token punctuation">)</span>
ax<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a5/8c/w79whhV2_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">append_img_in_doc<span class="token punctuation">(</span>folder_name<span class="token operator">=</span><span class="token string">"测试函数"</span><span class="token punctuation">,</span>doc_name<span class="token operator">=</span><span class="token string">"数据分析"</span><span class="token punctuation">,</span>img<span class="token operator">=</span>fig<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/0b/dc/xjnpujfT_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="11_348"></a>11、定义一个云盘文件操作类</h3> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CloudFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    用于操作云盘文件
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> 
                 project_name<span class="token punctuation">,</span> 
                 part_name<span class="token punctuation">,</span> 
                 doc_content <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 项目名称，即项目文件夹名称</span>
        self<span class="token punctuation">.</span>project_name <span class="token operator">=</span> project_name
        <span class="token comment"># 项目某部分名称，即项目文件名称</span>
        self<span class="token punctuation">.</span>part_name <span class="token operator">=</span> part_name
         <span class="token comment"># 项目文件夹ID</span>
        <span class="token comment"># 若项目文件夹ID为空，则获取项目文件夹ID</span>
        
        folder_path<span class="token operator">=</span>create_or_get_folder<span class="token punctuation">(</span>folder_name<span class="token operator">=</span>project_name<span class="token punctuation">)</span>
         
        <span class="token comment"># 创建时获取当前项目中其他文件名称列表</span>
        self<span class="token punctuation">.</span>doc_list <span class="token operator">=</span> list_files_in_folder<span class="token punctuation">(</span>folder_name<span class="token operator">=</span>project_name<span class="token punctuation">)</span>
        

        file_path <span class="token operator">=</span> create_or_get_doc<span class="token punctuation">(</span>folder_name<span class="token operator">=</span>project_name<span class="token punctuation">,</span> 
                                       doc_name<span class="token operator">=</span>part_name<span class="token punctuation">)</span>
        
        <span class="token comment"># 项目文件具体内容，相当于多轮对话内容</span>
        self<span class="token punctuation">.</span>doc_content <span class="token operator">=</span> doc_content
        <span class="token comment"># 若初始content不为空，则将其追加入文档内</span>
        <span class="token keyword">if</span> doc_content <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            append_content_in_doc<span class="token punctuation">(</span>folder_name<span class="token operator">=</span>project_name<span class="token punctuation">,</span> 
                                  doc_name<span class="token operator">=</span>part_name<span class="token punctuation">,</span> 
                                  dict_list<span class="token operator">=</span>doc_content<span class="token punctuation">)</span>
            

    <span class="token keyword">def</span> <span class="token function">get_doc_content</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        根据项目某文件的文件ID，获取对应的文件内容
        """</span>     
        self<span class="token punctuation">.</span>doc_content <span class="token operator">=</span> get_file_content<span class="token punctuation">(</span>folder_name<span class="token operator">=</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">,</span> doc_name<span class="token operator">=</span>self<span class="token punctuation">.</span>part_name<span class="token punctuation">)</span>

        <span class="token keyword">return</span> self<span class="token punctuation">.</span>doc_content

    <span class="token keyword">def</span> <span class="token function">append_doc_content</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        根据项目某文件的文件ID，追加文件内容
        """</span>  
        append_content_in_doc<span class="token punctuation">(</span>folder_name<span class="token operator">=</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">,</span>
                                  doc_name<span class="token operator">=</span>self<span class="token punctuation">.</span>part_name<span class="token punctuation">,</span> 
                                  dict_list<span class="token operator">=</span>content<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">clear_content</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        清空某文件内的全部内容
        """</span>  
        clear_content_in_doc<span class="token punctuation">(</span>folder_name<span class="token operator">=</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">,</span> doc_name<span class="token operator">=</span>self<span class="token punctuation">.</span>part_name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">delete_all_files</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        删除当前项目文件夹内的全部文件
        """</span>  
        delete_all_files_in_folder<span class="token punctuation">(</span>folder_name<span class="token operator">=</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">update_doc_list</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        更新当前项目文件夹内的全部文件名称
        """</span>
        self<span class="token punctuation">.</span>doc_list <span class="token operator">=</span> list_files_in_folder<span class="token punctuation">(</span>folder_name<span class="token operator">=</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">rename_doc</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> new_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        修改当前文件名称
        """</span>
        self<span class="token punctuation">.</span>part_name <span class="token operator">=</span> rename_doc_in_drive<span class="token punctuation">(</span>folder_name<span class="token operator">=</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">,</span> doc_name<span class="token operator">=</span>self<span class="token punctuation">.</span>part_name<span class="token punctuation">,</span> 
                                                 new_name<span class="token operator">=</span>new_name<span class="token punctuation">)</span>
</code></pre> 
<p>本地存储测试</p> 
<pre><code class="prism language-python">c1 <span class="token operator">=</span> CloudFile<span class="token punctuation">(</span>project_name<span class="token operator">=</span><span class="token string">'测试项目'</span><span class="token punctuation">,</span> part_name<span class="token operator">=</span><span class="token string">'测试文档1'</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c4/a0/5sU0mXxO_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Memory_433"></a>三、Memory功能实现之消息工具类封装</h2> 
<h3><a id="1_434"></a>1、定义消息管理类</h3> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MessageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    MessageManager，用于创建Chat模型能够接收和解读的messages对象。该对象是原始Chat模型接收的\
    messages对象的更高级表现形式，MessageManager类对象将字典类型的list作为其属性之一，同时还能\
    能区分系统消息和历史对话消息，并且能够自行计算当前对话的token量，并执能够在append的同时删\
    减最早对话消息，从而能够更加顺畅的输入大模型并完成多轮对话需求。
    """</span>
    
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> 
                 system_content_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                 question<span class="token operator">=</span><span class="token string">'你好。'</span><span class="token punctuation">,</span>
                 tokens_thr<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> 
                 project<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>system_content_list <span class="token operator">=</span> system_content_list
        <span class="token comment"># 系统消息文档列表，相当于外部输入文档列表</span>
        system_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 除系统消息外历史对话消息</span>
        history_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 用于保存全部消息的list</span>
        messages_all <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 系统消息字符串</span>
        system_content <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token comment"># 历史消息字符串，此时为用户输入信息</span>
        history_content <span class="token operator">=</span> question
        <span class="token comment"># 系统消息+历史消息字符串</span>
        content_all <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token comment"># 输入到messages中系统消息个数，初始情况为0</span>
        num_of_system_messages <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment"># 全部信息的token数量</span>
        all_tokens_count <span class="token operator">=</span> <span class="token number">0</span>
        
        encoding <span class="token operator">=</span> tiktoken<span class="token punctuation">.</span>encoding_for_model<span class="token punctuation">(</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 将外部输入文档列表依次保存为系统消息</span>
        <span class="token keyword">if</span> system_content_list <span class="token operator">!=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>      
            <span class="token keyword">for</span> content <span class="token keyword">in</span> system_content_list<span class="token punctuation">:</span>
                system_messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> content<span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token comment"># 同时进行全文档拼接</span>
                system_content <span class="token operator">+=</span> content
                
            <span class="token comment"># 计算系统消息token</span>
            system_tokens_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>system_content<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment"># 拼接系统消息</span>
            messages_all <span class="token operator">+=</span> system_messages
            <span class="token comment"># 计算系统消息个数</span>
            num_of_system_messages <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>system_content_list<span class="token punctuation">)</span>
                
            <span class="token comment"># 若存在最大token数量限制</span>
            <span class="token keyword">if</span> tokens_thr <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># 若系统消息超出限制</span>
                <span class="token keyword">if</span> system_tokens_count <span class="token operator">&gt;=</span> tokens_thr<span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"system_messages的tokens数量超出限制，当前系统消息将不会被输入模型"</span><span class="token punctuation">)</span>            
                    <span class="token comment"># 删除系统消息</span>
                    system_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                    messages_all <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                    <span class="token comment"># 系统消息个数清零</span>
                    num_of_system_messages <span class="token operator">=</span> <span class="token number">0</span>
                    <span class="token comment"># 系统消息token数清零</span>
                    system_tokens_count <span class="token operator">=</span> <span class="token number">0</span>
                    
            all_tokens_count <span class="token operator">+=</span> system_tokens_count
        
        <span class="token comment"># 创建首次对话消息</span>
        history_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> question<span class="token punctuation">}</span><span class="token punctuation">]</span>
        <span class="token comment"># 创建全部消息列表</span>
        messages_all <span class="token operator">+=</span> history_messages
        
        <span class="token comment"># 计算用户问题token</span>
        user_tokens_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>encoding<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 计算总token数</span>
        all_tokens_count <span class="token operator">+=</span> user_tokens_count
        
        <span class="token comment"># 若存在最大token限制</span>
        <span class="token keyword">if</span> tokens_thr <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># 若超出最大token限制</span>
            <span class="token keyword">if</span> all_tokens_count <span class="token operator">&gt;=</span> tokens_thr<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"当前用户问题的tokens数量超出限制，该消息无法被输入到模型中"</span><span class="token punctuation">)</span>  
                <span class="token comment"># 同时清空系统消息和用户消息</span>
                history_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                system_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                messages_all <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                num_of_system_messages <span class="token operator">=</span> <span class="token number">0</span>
                all_tokens_count <span class="token operator">=</span> <span class="token number">0</span>
        
        <span class="token comment"># 全部messages信息</span>
        self<span class="token punctuation">.</span>messages <span class="token operator">=</span> messages_all
        <span class="token comment"># system_messages信息</span>
        self<span class="token punctuation">.</span>system_messages <span class="token operator">=</span> system_messages
        <span class="token comment"># user_messages信息</span>
        self<span class="token punctuation">.</span>history_messages <span class="token operator">=</span> history_messages
        <span class="token comment"># messages信息中全部content的token数量</span>
        self<span class="token punctuation">.</span>tokens_count <span class="token operator">=</span> all_tokens_count
        <span class="token comment"># 系统信息数量</span>
        self<span class="token punctuation">.</span>num_of_system_messages <span class="token operator">=</span> num_of_system_messages
        <span class="token comment"># 最大token数量阈值</span>
        self<span class="token punctuation">.</span>tokens_thr <span class="token operator">=</span> tokens_thr
        <span class="token comment"># token数计算编码方式</span>
        self<span class="token punctuation">.</span>encoding <span class="token operator">=</span> tiktoken<span class="token punctuation">.</span>encoding_for_model<span class="token punctuation">(</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">)</span>
        <span class="token comment"># message挂靠的项目</span>
        self<span class="token punctuation">.</span>project <span class="token operator">=</span> project
     
    <span class="token comment"># 删除部分对话信息</span>
    <span class="token keyword">def</span> <span class="token function">messages_pop</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> manual<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">reduce_tokens</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
            drop_message <span class="token operator">=</span> self<span class="token punctuation">.</span>history_messages<span class="token punctuation">.</span>pop<span class="token punctuation">(</span>index<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>tokens_count <span class="token operator">-=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>encoding<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>drop_message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>tokens_thr <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">while</span> self<span class="token punctuation">.</span>tokens_count <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>tokens_thr<span class="token punctuation">:</span>
                reduce_tokens<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> manual<span class="token punctuation">:</span>
            <span class="token keyword">if</span> index <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                reduce_tokens<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> index <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>history_messages<span class="token punctuation">)</span> <span class="token keyword">or</span> index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
                reduce_tokens<span class="token punctuation">(</span>index<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Invalid index value: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 更新messages</span>
        self<span class="token punctuation">.</span>messages <span class="token operator">=</span> self<span class="token punctuation">.</span>system_messages <span class="token operator">+</span> self<span class="token punctuation">.</span>history_messages
       
    <span class="token comment"># 增加部分对话信息</span>
    <span class="token keyword">def</span> <span class="token function">messages_append</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> new_messages<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        <span class="token comment"># 若是单独一个字典，或JSON格式字典</span>
        <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>new_messages<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token builtin">dict</span> <span class="token keyword">or</span> <span class="token builtin">type</span><span class="token punctuation">(</span>new_messages<span class="token punctuation">)</span> <span class="token keyword">is</span> openai<span class="token punctuation">.</span>types<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>chat_completion_message<span class="token punctuation">.</span>ChatCompletionMessage<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_messages<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>tokens_count <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>encoding<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>new_messages<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            
        <span class="token comment"># 若新消息也是MessageManager对象</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>new_messages<span class="token punctuation">,</span> MessageManager<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>messages <span class="token operator">+=</span> new_messages<span class="token punctuation">.</span>messages
            self<span class="token punctuation">.</span>tokens_count <span class="token operator">+=</span> new_messages<span class="token punctuation">.</span>tokens_count

        <span class="token comment"># 重新更新history_messages</span>
        self<span class="token punctuation">.</span>history_messages <span class="token operator">=</span> self<span class="token punctuation">.</span>messages<span class="token punctuation">[</span>self<span class="token punctuation">.</span>num_of_system_messages<span class="token punctuation">:</span> <span class="token punctuation">]</span>
        
        <span class="token comment"># 再执行pop，若有需要，则会删除部分历史消息</span>
        self<span class="token punctuation">.</span>messages_pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
      
    <span class="token comment"># 复制信息</span>
    <span class="token keyword">def</span> <span class="token function">copy</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 创建一个新的 MessageManager 对象，复制所有重要的属性</span>
        system_content_str_list <span class="token operator">=</span> <span class="token punctuation">[</span>message<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token keyword">for</span> message <span class="token keyword">in</span> self<span class="token punctuation">.</span>system_messages<span class="token punctuation">]</span>
        new_obj <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>
            system_content_list<span class="token operator">=</span>copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>system_content_str_list<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 使用深复制来复制系统消息</span>
            question<span class="token operator">=</span>self<span class="token punctuation">.</span>history_messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>history_messages <span class="token keyword">else</span> <span class="token string">''</span><span class="token punctuation">,</span>
            tokens_thr<span class="token operator">=</span>self<span class="token punctuation">.</span>tokens_thr
        <span class="token punctuation">)</span>
        <span class="token comment"># 复制任何其他需要复制的属性</span>
        new_obj<span class="token punctuation">.</span>history_messages <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>history_messages<span class="token punctuation">)</span>  <span class="token comment"># 使用深复制来复制历史消息</span>
        new_obj<span class="token punctuation">.</span>messages <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>self<span class="token punctuation">.</span>messages<span class="token punctuation">)</span>  <span class="token comment"># 使用深复制来复制所有消息</span>
        new_obj<span class="token punctuation">.</span>tokens_count <span class="token operator">=</span> self<span class="token punctuation">.</span>tokens_count
        new_obj<span class="token punctuation">.</span>num_of_system_messages <span class="token operator">=</span> self<span class="token punctuation">.</span>num_of_system_messages
        
        <span class="token keyword">return</span> new_obj
    
    <span class="token comment"># 增加系统消息</span>
    <span class="token keyword">def</span> <span class="token function">add_system_messages</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> new_system_content<span class="token punctuation">)</span><span class="token punctuation">:</span>
        system_content_list <span class="token operator">=</span> self<span class="token punctuation">.</span>system_content_list
        system_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 若是字符串，则将其转化为list</span>
        <span class="token keyword">if</span> <span class="token builtin">type</span><span class="token punctuation">(</span>new_system_content<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
            new_system_content <span class="token operator">=</span> <span class="token punctuation">[</span>new_system_content<span class="token punctuation">]</span>
            
        system_content_list<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>new_system_content<span class="token punctuation">)</span>
        new_system_content_str <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token keyword">for</span> content <span class="token keyword">in</span> new_system_content<span class="token punctuation">:</span>
            new_system_content_str <span class="token operator">+=</span> content
        new_token_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>encoding<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>new_system_content_str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tokens_count <span class="token operator">+=</span> new_token_count
        self<span class="token punctuation">.</span>system_content_list <span class="token operator">=</span> system_content_list
        <span class="token keyword">for</span> message <span class="token keyword">in</span> system_content_list<span class="token punctuation">:</span>
            system_messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> message<span class="token punctuation">}</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>system_messages <span class="token operator">=</span> system_messages
        self<span class="token punctuation">.</span>num_of_system_messages <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>system_content_list<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>messages <span class="token operator">=</span> system_messages <span class="token operator">+</span> self<span class="token punctuation">.</span>history_messages
        
        <span class="token comment"># 再执行pop，若有需要，则会删除部分历史消息</span>
        self<span class="token punctuation">.</span>messages_pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        
    <span class="token comment"># 删除系统消息</span>
    <span class="token keyword">def</span> <span class="token function">delete_system_messages</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        system_content_list <span class="token operator">=</span> self<span class="token punctuation">.</span>system_content_list
        <span class="token keyword">if</span> system_content_list <span class="token operator">!=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            system_content_str <span class="token operator">=</span> <span class="token string">''</span>
            <span class="token keyword">for</span> content <span class="token keyword">in</span> system_content_list<span class="token punctuation">:</span>
                system_content_str <span class="token operator">+=</span> content
            delete_token_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>encoding<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>system_content_str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>tokens_count <span class="token operator">-=</span> delete_token_count
            self<span class="token punctuation">.</span>num_of_system_messages <span class="token operator">=</span> <span class="token number">0</span>
            self<span class="token punctuation">.</span>system_content_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>system_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>messages <span class="token operator">=</span> self<span class="token punctuation">.</span>history_messages
     
    <span class="token comment"># 清除对话消息中的function消息</span>
    <span class="token keyword">def</span> <span class="token function">delete_function_messages</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 用于删除外部函数消息</span>
        history_messages <span class="token operator">=</span> self<span class="token punctuation">.</span>history_messages
        <span class="token comment"># 从后向前迭代列表</span>
        <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>history_messages<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            message <span class="token operator">=</span> history_messages<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
            <span class="token comment">## 这儿估计有问题</span>
            <span class="token keyword">if</span> message<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"function_call"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> message<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"function"</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>messages_pop<span class="token punctuation">(</span>manual<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span>index<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2_648"></a>2、测试-查看消息管理器</h3> 
<pre><code class="prism language-python">msg1 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
msg1<span class="token punctuation">.</span>system_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/d6/2e/DonvF5df_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_656"></a>3、测试-追加消息</h3> 
<pre><code class="prism language-python">msg1<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/17/8a/WtTI3z6p_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">msg1<span class="token punctuation">.</span>messages_append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"你好，有什么可以帮你？"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
msg1<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/41/45/opAURyXx_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_669"></a>4、测试-删除消息</h3> 
<pre><code class="prism language-python">msg1<span class="token punctuation">.</span>messages_pop<span class="token punctuation">(</span>manual<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
msg1<span class="token punctuation">.</span>history_messages
</code></pre> 
<p><img src="https://images2.imgbox.com/60/9d/BJyw4IgL_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_677"></a>5、添加背景知识</h3> 
<pre><code class="prism language-python"><span class="token comment"># 数据字典文件</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/root/autodl-tmp/iquery项目/data/数据字典/iquery数据字典.md'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    data_dictionary <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 数据分析报告编写专家文档</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/root/autodl-tmp/iquery项目/data/业务知识/本公司数据分析师业务介绍.md'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    da_instruct <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">msg2 <span class="token operator">=</span> MessageManager<span class="token punctuation">(</span>system_content_list<span class="token operator">=</span><span class="token punctuation">[</span>data_dictionary<span class="token punctuation">,</span> da_instruct<span class="token punctuation">]</span><span class="token punctuation">)</span>
msg2<span class="token punctuation">.</span>system_messages
</code></pre> 
<p>输出<br> <img src="https://images2.imgbox.com/20/89/GsLwYLQ9_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Tools_698"></a>四、Tools功能之函数封装</h2> 
<h3><a id="1_699"></a>1、获取表结构基本信息（工具函数）</h3> 
<p>定义一个SQL工具函数，用于获取表结构信息，作为大模型生成SQL的背景知识</p> 
<pre><code class="prism language-python"><span class="token comment">## mysql hive sparksql</span>
<span class="token keyword">def</span> <span class="token function">sql_inter</span><span class="token punctuation">(</span>sql_query<span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token string">'globals()'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    用于获取iquery数据库中各张表的有关相关信息，\
    核心功能是将输入的SQL代码传输至iquery数据库所在的MySQL环境中进行运行，\
    并最终返回SQL代码运行结果。需要注意的是，本函数是借助pymysql来连接MySQL数据库。
    :param sql_query: 字符串形式的SQL查询语句，用于执行对MySQL中iquery数据库中各张表进行查询，并获得各表中的各类相关信息
    :param g: g，字符串形式变量，表示环境变量，无需设置，保持默认参数即可
    :return：sql_query在MySQL中的运行结果。
    """</span>
    
    mysql_pw <span class="token operator">=</span> <span class="token string">"iquery_agent"</span>
    
    connection <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
            host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库地址</span>
            user<span class="token operator">=</span><span class="token string">'iquery_agent'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库用户名</span>
            passwd<span class="token operator">=</span>mysql_pw<span class="token punctuation">,</span>  <span class="token comment"># 数据库密码</span>
            db<span class="token operator">=</span><span class="token string">'iquery'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库名</span>
            charset<span class="token operator">=</span><span class="token string">'utf8'</span>  <span class="token comment"># 字符集选择utf8</span>
        <span class="token punctuation">)</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> connection<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cursor<span class="token punctuation">:</span>
            <span class="token comment"># SQL查询语句</span>
            sql <span class="token operator">=</span> sql_query
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>

            <span class="token comment"># 获取查询结果</span>
            results <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        connection<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    
    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">sql_inter<span class="token punctuation">(</span>sql_query<span class="token operator">=</span><span class="token string">'SELECT COUNT(*) FROM user_demographics;'</span><span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2SQLpython_744"></a>2、提取SQL数据到python变量（辅助函数）</h3> 
<p>定义一个辅助函数，用于将查询到的记录提取保存到本地python变量中</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">extract_data</span><span class="token punctuation">(</span>sql_query<span class="token punctuation">,</span>df_name<span class="token punctuation">,</span>g<span class="token operator">=</span><span class="token string">'globals()'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    用于借助pymysql，将MySQL中的iquery数据库中的表读取并保存到本地Python环境中。
    :param sql_query: 字符串形式的SQL查询语句，用于提取MySQL中iquery数据库中的某张表。
    :param df_name: 将MySQL数据库中提取的表格进行本地保存时的变量名，以字符串形式表示。
    :param g: g，字符串形式变量，表示环境变量，无需设置，保持默认参数即可
    :return：表格读取和保存结果
    """</span>
    
    mysql_pw <span class="token operator">=</span> <span class="token string">"iquery_agent"</span>
    
    connection <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>
            host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库地址</span>
            user<span class="token operator">=</span><span class="token string">'iquery_agent'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库用户名</span>
            passwd<span class="token operator">=</span>mysql_pw<span class="token punctuation">,</span>  <span class="token comment"># 数据库密码</span>
            db<span class="token operator">=</span><span class="token string">'iquery'</span><span class="token punctuation">,</span>  <span class="token comment"># 数据库名</span>
            charset<span class="token operator">=</span><span class="token string">'utf8'</span>  <span class="token comment"># 字符集选择utf8</span>
        <span class="token punctuation">)</span>
    
    
    <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>df_name<span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>sql_query<span class="token punctuation">,</span> connection<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token string">"已成功完成%s变量创建"</span> <span class="token operator">%</span> df_name
</code></pre> 
<pre><code class="prism language-python">extract_data<span class="token punctuation">(</span>sql_query <span class="token operator">=</span> <span class="token string">'SELECT * FROM user_demographics;'</span><span class="token punctuation">,</span> 
             df_name <span class="token operator">=</span> <span class="token string">'user_demographics_df'</span><span class="token punctuation">,</span> 
             g <span class="token operator">=</span> <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/09/9d/XQUrgMl6_o.png" alt="在这里插入图片描述"></p> 
<p>从python变量中取出数据查看</p> 
<pre><code class="prism language-python">user_demographics_df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ec/d0/OsiIX8Qw_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3python_787"></a>3、python代码解释器（工具函数）</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">python_inter</span><span class="token punctuation">(</span>py_code<span class="token punctuation">,</span>g<span class="token operator">=</span><span class="token string">'globals()'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    用于对iquery数据库中各张数据表进行查询和处理，并获取最终查询或处理结果。
    :param py_code: 字符串形式的Python代码，用于执行对iquery数据库中各张数据表进行操作
    :param g: g，字符串形式变量，表示环境变量，无需设置，保持默认参数即可
    :return：代码运行的最终结果
    """</span>    
    <span class="token comment"># 添加图片对象，如果存在绘图代码，则创建fig对象</span>
    py_code <span class="token operator">=</span> insert_fig_object<span class="token punctuation">(</span>py_code<span class="token punctuation">)</span>
    global_vars_before <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">exec</span><span class="token punctuation">(</span>py_code<span class="token punctuation">,</span> <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    global_vars_after <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    new_vars <span class="token operator">=</span> global_vars_after <span class="token operator">-</span> global_vars_before
    <span class="token keyword">if</span> new_vars<span class="token punctuation">:</span>
        result <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>var<span class="token punctuation">:</span> <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>var<span class="token punctuation">]</span> <span class="token keyword">for</span> var <span class="token keyword">in</span> new_vars<span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>py_code<span class="token punctuation">,</span> <span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string">"已经顺利执行代码"</span>
</code></pre> 
<p>检查图形对象，赋值给fig（方便通过全局变量fig进行统一的绘图对象操作）</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">insert_fig_object</span><span class="token punctuation">(</span>code_str<span class="token punctuation">,</span>g<span class="token operator">=</span><span class="token string">'globals()'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    为图片创建fig对象
    :param g: g，字符串形式变量，表示环境变量，无需设置，保持默认参数即可
    """</span>
    <span class="token comment">#print("开始画图了")</span>
    <span class="token keyword">global</span> fig
    <span class="token comment"># 检查是否已存在 fig 对象的创建</span>
    <span class="token keyword">if</span> <span class="token string">'fig = plt.figure'</span> <span class="token keyword">in</span> code_str <span class="token keyword">or</span> <span class="token string">'fig, ax = plt.subplots()'</span> <span class="token keyword">in</span> code_str<span class="token punctuation">:</span>
        <span class="token keyword">return</span> code_str  <span class="token comment"># 如果存在，则返回原始代码字符串</span>

    <span class="token comment"># 定义可能的库别名和全名</span>
    plot_aliases <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'plt.'</span><span class="token punctuation">,</span> <span class="token string">'matplotlib.pyplot.'</span><span class="token punctuation">,</span><span class="token string">'plot'</span><span class="token punctuation">]</span>
    sns_aliases <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'sns.'</span><span class="token punctuation">,</span> <span class="token string">'seaborn.'</span><span class="token punctuation">]</span>

    <span class="token comment"># 寻找第一次出现绘图相关代码的位置</span>
    first_plot_occurrence <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span>code_str<span class="token punctuation">.</span>find<span class="token punctuation">(</span>alias<span class="token punctuation">)</span> <span class="token keyword">for</span> alias <span class="token keyword">in</span> plot_aliases <span class="token operator">+</span> sns_aliases <span class="token keyword">if</span> code_str<span class="token punctuation">.</span>find<span class="token punctuation">(</span>alias<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
 
    <span class="token comment"># 如果找到绘图代码，则在该位置之前插入 fig 对象的创建</span>
    <span class="token keyword">if</span> first_plot_occurrence <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        plt_figure_index <span class="token operator">=</span> code_str<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'plt.figure'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> plt_figure_index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token comment"># 寻找 plt.figure 后的括号位置，以确定是否有参数</span>
            closing_bracket_index <span class="token operator">=</span> code_str<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">,</span> plt_figure_index<span class="token punctuation">)</span>
            <span class="token comment"># 如果找到了 plt.figure()，则替换为 fig = plt.figure()</span>
            modified_str <span class="token operator">=</span> code_str<span class="token punctuation">[</span><span class="token punctuation">:</span>plt_figure_index<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'fig = '</span> <span class="token operator">+</span> code_str<span class="token punctuation">[</span>plt_figure_index<span class="token punctuation">:</span>closing_bracket_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> code_str<span class="token punctuation">[</span>closing_bracket_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            modified_str <span class="token operator">=</span> code_str<span class="token punctuation">[</span><span class="token punctuation">:</span>first_plot_occurrence<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'fig = plt.figure()\n'</span> <span class="token operator">+</span> code_str<span class="token punctuation">[</span>first_plot_occurrence<span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> modified_str
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> code_str  <span class="token comment"># 如果没有找到绘图代码，则返回原始代码字符串</span>
</code></pre> 
<p>图形绘制代码测试</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token comment"># 数据</span>
categories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'Category 1'</span><span class="token punctuation">,</span> <span class="token string">'Category 2'</span><span class="token punctuation">,</span> <span class="token string">'Category 3'</span><span class="token punctuation">,</span> <span class="token string">'Category 4'</span><span class="token punctuation">]</span>
values <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span>

<span class="token comment"># 创建 Figure 对象</span>
fig<span class="token punctuation">,</span> ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplots<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 在 Axes 对象 ax 上创建条形图</span>
ax<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>categories<span class="token punctuation">,</span> values<span class="token punctuation">)</span>

<span class="token comment"># 添加标题和标签</span>
ax<span class="token punctuation">.</span>set_title<span class="token punctuation">(</span><span class="token string">'Bar Chart Example'</span><span class="token punctuation">)</span>
ax<span class="token punctuation">.</span>set_xlabel<span class="token punctuation">(</span><span class="token string">'Categories'</span><span class="token punctuation">)</span>
ax<span class="token punctuation">.</span>set_ylabel<span class="token punctuation">(</span><span class="token string">'Values'</span><span class="token punctuation">)</span>

<span class="token comment"># 显示图表</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e9/29/pcEQejGP_o.png" alt="在这里插入图片描述"></p> 
<p>insert_fig_object方法测试</p> 
<pre><code class="prism language-python">code_string <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
import matplotlib.pyplot as plt
# 数据
categories = ['Category 1', 'Category 2', 'Category 3', 'Category 4']
values = [4, 7, 1, 8]

# 创建 Figure 对象
fig, ax = plt.subplots()

# 在 Axes 对象 ax 上创建条形图
ax.bar(categories, values)

# 添加标题和标签
ax.set_title('Bar Chart Example')
ax.set_xlabel('Categories')
ax.set_ylabel('Values')

# 显示图表
plt.show()
"""</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>insert_fig_object<span class="token punctuation">(</span>code_str <span class="token operator">=</span> code_string<span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/87/4e/WLdAcOOL_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">python_inter<span class="token punctuation">(</span>py_code <span class="token operator">=</span> code_string<span class="token punctuation">,</span> g<span class="token operator">=</span><span class="token builtin">globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/06/b9/dXNPWUHT_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">查看fig对象
</code></pre> 
<p><img src="https://images2.imgbox.com/ce/d8/78Cu1g6E_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4function_916"></a>4、function函数信息生成器（辅助函数）</h3> 
<p>定义一个用于生成function calling 函数信息的，辅助函数（为了保证稳定性，实践使用是最好手工编写，避免大模型生成的结构体不太稳定）</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">auto_functions</span><span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Chat模型的functions参数编写函数
    :param functions_list: 包含一个或者多个函数对象的列表；
    :return：满足Chat模型functions参数要求的functions对象
    """</span>
    <span class="token keyword">def</span> <span class="token function">functions_generate</span><span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 创建空列表，用于保存每个函数的描述字典</span>
        functions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment"># 对每个外部函数进行循环</span>
        <span class="token keyword">for</span> function <span class="token keyword">in</span> functions_list<span class="token punctuation">:</span>
            <span class="token comment"># 读取函数对象的函数说明</span>
            function_description <span class="token operator">=</span> inspect<span class="token punctuation">.</span>getdoc<span class="token punctuation">(</span>function<span class="token punctuation">)</span>
            <span class="token comment"># 读取函数的函数名字符串</span>
            function_name <span class="token operator">=</span> function<span class="token punctuation">.</span>__name__

            system_prompt <span class="token operator">=</span> <span class="token string">'以下是某的函数说明：%s'</span> <span class="token operator">%</span> function_description
            user_prompt <span class="token operator">=</span> '根据这个函数的函数说明，请帮我创建一个JSON格式的字典，这个字典有如下<span class="token number">5</span>点要求：\
                           <span class="token number">1.</span>字典总共有三个键值对；\
                           <span class="token number">2.</span>第一个键值对的Key是字符串name，value是该函数的名字：<span class="token operator">%</span>s，也是字符串；\
                           <span class="token number">3.</span>第二个键值对的Key是字符串description，value是该函数的函数的功能说明，也是字符串；\
                           <span class="token number">4.</span>第三个键值对的Key是字符串parameters，value是一个JSON Schema对象，用于说明该函数的参数输入规范。\
                           <span class="token number">5.</span>输出结果必须是一个JSON格式的字典，只输出这个字典即可，前后不需要任何前后修饰或说明的语句' <span class="token operator">%</span> function_name

            response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
                              model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span>
                              messages<span class="token operator">=</span><span class="token punctuation">[</span>
                                <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system_prompt<span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> user_prompt<span class="token punctuation">}</span>
                              <span class="token punctuation">]</span>
                            <span class="token punctuation">)</span>
            json_function_description<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"```"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            json_str<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span><span class="token string">"function"</span><span class="token punctuation">:</span>json_function_description<span class="token punctuation">}</span>
            functions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span>
        <span class="token keyword">return</span> functions
    
    max_attempts <span class="token operator">=</span> <span class="token number">4</span>
    attempts <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">while</span> attempts <span class="token operator">&lt;</span> max_attempts<span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            functions <span class="token operator">=</span> functions_generate<span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span>
            <span class="token keyword">break</span>  <span class="token comment"># 如果代码成功执行，跳出循环</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            attempts <span class="token operator">+=</span> <span class="token number">1</span>  <span class="token comment"># 增加尝试次数</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"发生错误："</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
            <span class="token keyword">if</span> attempts <span class="token operator">==</span> max_attempts<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"已达到最大尝试次数，程序终止。"</span><span class="token punctuation">)</span>
                <span class="token keyword">raise</span>  <span class="token comment"># 重新引发最后一个异常</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正在重新运行..."</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> functions
</code></pre> 
<h3><a id="5function_975"></a>5、function函数调用辅助类</h3> 
<p>负责承接外部函数调用时相关功能支持。<br> 类属性包括外部函数列表、外部函数参数说明列表、以及调用方式说明三项。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">AvailableFunctions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    外部函数类，主要负责承接外部函数调用时相关功能支持。类属性包括外部函数列表、外部函数参数说明列表、以及调用方式说明三项。
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> functions_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> functions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> function_call<span class="token operator">=</span><span class="token string">"auto"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>functions_list <span class="token operator">=</span> functions_list
        self<span class="token punctuation">.</span>functions <span class="token operator">=</span> functions
        self<span class="token punctuation">.</span>functions_dic <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>function_call <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token comment"># 当外部函数列表不为空、且外部函数参数解释为空时，调用auto_functions创建外部函数解释列表</span>
        <span class="token keyword">if</span> functions_list <span class="token operator">!=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>functions_dic <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>func<span class="token punctuation">.</span>__name__<span class="token punctuation">:</span> func <span class="token keyword">for</span> func <span class="token keyword">in</span> functions_list<span class="token punctuation">}</span>
            self<span class="token punctuation">.</span>function_call <span class="token operator">=</span> function_call
            <span class="token keyword">if</span> functions <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>functions <span class="token operator">=</span> auto_functions<span class="token punctuation">(</span>functions_list<span class="token punctuation">)</span>
       
    <span class="token comment"># 增加外部函数方法，并且同时可以更换外部函数调用规则</span>
    <span class="token keyword">def</span> <span class="token function">add_function</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> new_function<span class="token punctuation">,</span> function_description<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> function_call_update<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>functions_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_function<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>functions_dic<span class="token punctuation">[</span>new_function<span class="token punctuation">.</span>__name__<span class="token punctuation">]</span> <span class="token operator">=</span> new_function
        <span class="token keyword">if</span> function_description <span class="token operator">==</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            new_function_description <span class="token operator">=</span> auto_functions<span class="token punctuation">(</span><span class="token punctuation">[</span>new_function<span class="token punctuation">]</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_function_description<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>function_description<span class="token punctuation">)</span>
        <span class="token keyword">if</span> function_call_update <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>function_call <span class="token operator">=</span> function_call_update
</code></pre> 
<pre><code class="prism language-python">af <span class="token operator">=</span> AvailableFunctions<span class="token punctuation">(</span>functions_list<span class="token operator">=</span><span class="token punctuation">[</span>sql_inter<span class="token punctuation">,</span> extract_data<span class="token punctuation">,</span> python_inter<span class="token punctuation">]</span><span class="token punctuation">)</span>
af<span class="token punctuation">.</span>functions_list
</code></pre> 
<p><img src="https://images2.imgbox.com/e6/f2/NRWmCHeu_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">af<span class="token punctuation">.</span>functions_dic
</code></pre> 
<p><img src="https://images2.imgbox.com/10/ff/pn75FNM5_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">af<span class="token punctuation">.</span>function_call
</code></pre> 
<p><img src="https://images2.imgbox.com/ac/b4/T0bwDg1I_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">af<span class="token punctuation">.</span>functions
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python"><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'function'</span><span class="token punctuation">,</span>
  <span class="token string">'function'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'sql_inter'</span><span class="token punctuation">,</span>
   <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">'用于获取iquery数据库中各张表的有关相关信息，核心功能是将输入的SQL代码传输至iquery数据库所在的MySQL环境中进行运行，并最终返回SQL代码运行结果。'</span><span class="token punctuation">,</span>
   <span class="token string">'parameters'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
    <span class="token string">'properties'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'sql_query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
      <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">'字符串形式的SQL查询语句，用于执行对MySQL中iquery数据库中各张表进行查询，并获得各表中的各类相关信息。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string">'g'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
      <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">'g，字符串形式变量，表示环境变量，无需设置，保持默认参数即可。'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sql_query'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'function'</span><span class="token punctuation">,</span>
  <span class="token string">'function'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'extract_data'</span><span class="token punctuation">,</span>
   <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">'用于借助pymysql，将MySQL中的iquery数据库中的表读取并保存到本地Python环境中。'</span><span class="token punctuation">,</span>
   <span class="token string">'parameters'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
    <span class="token string">'properties'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'sql_query'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
      <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">'字符串形式的SQL查询语句，用于提取MySQL中iquery数据库中的某张表。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string">'df_name'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
      <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">'将MySQL数据库中提取的表格进行本地保存时的变量名，以字符串形式表示。'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string">'g'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">'g，字符串形式变量，表示环境变量，无需设置，保持默认参数即可'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sql_query'</span><span class="token punctuation">,</span> <span class="token string">'df_name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'function'</span><span class="token punctuation">,</span>
  <span class="token string">'function'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'python_inter'</span><span class="token punctuation">,</span>
   <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">'用于对iquery数据库中各张数据表进行查询和处理，并获取最终查询或处理结果。'</span><span class="token punctuation">,</span>
   <span class="token string">'parameters'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'$schema'</span><span class="token punctuation">:</span> <span class="token string">'http://-schema.org/draft-07/schema#'</span><span class="token punctuation">,</span>
    <span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'object'</span><span class="token punctuation">,</span>
    <span class="token string">'properties'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'py_code'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span>
      <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">'字符串形式的Python代码，用于执行对iquery数据库中各张数据表进行操作'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token string">'g'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'string'</span><span class="token punctuation">,</span> <span class="token string">'description'</span><span class="token punctuation">:</span> <span class="token string">'g，字符串形式变量，表示环境变量，无需设置，保持默认参数即可'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'required'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'py_code'</span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> 
<h2><a id="_1062"></a>三、结语</h2> 
<p>本文中我们封装落地了Agent智能数据分析平台中的Tools和Memory相关代码，下一篇章中我将落地实践Agent智能数据分析平台的核心模块Plan，探索发掘人类意图，优化整个决策流程。</p> 
<p><img src="https://images2.imgbox.com/79/98/wuBjWCuw_o.png" alt="在这里插入图片描述"></p> 
<p>🎯🔖更多专栏系列文章：<a href="https://blog.csdn.net/xiaobing259/category_12628007.html?spm=1001.2014.3001.5482"><strong>AIGC-AI大模型探索之路</strong></a></p> 
<blockquote> 
 <p>😎 <strong>作者介绍</strong>：我是寻道AI小兵，资深程序老猿，从业10年+、互联网系统架构师，目前专注于AIGC的探索。<br> 📖 <strong>技术交流</strong>：建立有技术交流群，可以扫码👇 加入社群，500本各类编程书籍、AI教程、AI工具等你领取！<br> <strong>如果文章内容对您有所触动，别忘了<font color="red"><strong>点赞、⭐关注，收藏</strong></font>！加入我，让我们携手同行AI的探索之旅，一起开启智能时代的大门！</strong></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3d50bb8591107bf3750f0178fda8557c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">IDEA连接SQL server数据库(保姆级详细且必坑，包括防火墙、 SQL Server 网络配置等问题解决）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6f12df46f16a96fd9b6e47403849a2b5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">一篇文章讲透数据结构之树and二叉树</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>