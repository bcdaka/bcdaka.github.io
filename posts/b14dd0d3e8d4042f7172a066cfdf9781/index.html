<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>web前端之关闭浏览器标签页后自动退出登录、踩坑之浏览器关闭或刷新前发送可靠的请求、页面卸载的生命周期、监听的不同写法、页面可见性、可视区域、事件、beforeunload、unmounted - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/b14dd0d3e8d4042f7172a066cfdf9781/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="web前端之关闭浏览器标签页后自动退出登录、踩坑之浏览器关闭或刷新前发送可靠的请求、页面卸载的生命周期、监听的不同写法、页面可见性、可视区域、事件、beforeunload、unmounted">
  <meta property="og:description" content="MENU 初版前言(重要)代码解析功能概括数据属性mounted生命周期钩子unmounted生命周期钩子方法 总结 完整版前言浏览器刷新或关闭时的顺序简易判断Chrome(谷歌浏览器)关闭或刷新行为的方法发送请求总结 结束语 初版 前言(重要) beforeunload和unload之间的时间关系，也是实现关闭标签自动退出登录的关键。
1、当页面刷新的时候beforeunload和unload之间的时间间隔比较长，亲测时是10毫秒以上。这不是绝对值，要看电脑配置和网络状态是否良好，网上建议5毫秒，但是亲测不行；
2、当页面关闭时，beforeunload和unload之间的时间间隔非常短，具体是多少没有做过测试，反正远远小于10毫秒；
3、所以本案例并不完美，慎用，希望有完美案例的博主可以分享给大家使用。
代码 data() { return { beforeUnload_time: 0, }; }, mounted() { // 页面(浏览器标签页)关闭前 window.addEventListener(&#34;beforeunload&#34;, (e) =&gt; this.runBefor(e)); // 页面(浏览器标签页)关闭后 window.addEventListener(&#34;unload&#34;, (e) =&gt; this.runUnload(e)); // 页面可视时刷新(会加载整个页面，用户体验不是很好，视情况使用) // document.addEventListener(&#34;visibilitychange&#34;, this.runVisibilitychange); }, unmounted() { window.removeEventListener(&#34;beforeunload&#34;, (e) =&gt; this.runBefor(e)); window.removeEventListener(&#34;unload&#34;, (e) =&gt; this.runUnload(e)); // document.removeEventListener(&#34;visibilitychange&#34;, this.runVisibilitychange); }, methods: { logout() { // 退出登录 // 跳转到登录页面 }, runVisibilitychange() { if (!document.hidden) location.reload(); }, runBefor() { this.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-22T08:56:11+08:00">
    <meta property="article:modified_time" content="2024-07-22T08:56:11+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">web前端之关闭浏览器标签页后自动退出登录、踩坑之浏览器关闭或刷新前发送可靠的请求、页面卸载的生命周期、监听的不同写法、页面可见性、可视区域、事件、beforeunload、unmounted</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>MENU</h4> 
 <ul><li><a href="#_3" rel="nofollow">初版</a></li><li><ul><li><a href="#_4" rel="nofollow">前言(重要)</a></li><li><a href="#_11" rel="nofollow">代码</a></li><li><a href="#_51" rel="nofollow">解析</a></li><li><ul><li><a href="#_52" rel="nofollow">功能概括</a></li><li><a href="#_56" rel="nofollow">数据属性</a></li><li><a href="#mounted_67" rel="nofollow">mounted生命周期钩子</a></li><li><a href="#unmounted_84" rel="nofollow">unmounted生命周期钩子</a></li><li><a href="#_97" rel="nofollow">方法</a></li></ul> 
   </li><li><a href="#_123" rel="nofollow">总结</a></li></ul> 
  </li><li><a href="#_130" rel="nofollow">完整版</a></li><li><ul><li><a href="#_131" rel="nofollow">前言</a></li><li><a href="#_137" rel="nofollow">浏览器刷新或关闭时的顺序</a></li><li><a href="#Chrome_146" rel="nofollow">简易判断Chrome(谷歌浏览器)关闭或刷新行为的方法</a></li><li><a href="#_194" rel="nofollow">发送请求</a></li><li><a href="#_220" rel="nofollow">总结</a></li></ul> 
  </li><li><a href="#_294" rel="nofollow">结束语</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_3"></a>初版</h2> 
<h3><a id="_4"></a>前言(重要)</h3> 
<blockquote> 
 <p><strong><code>beforeunload</code>和<code>unload</code>之间的时间关系，也是实现关闭标签自动退出登录的关键。<br> 1、当页面刷新的时候<code>beforeunload</code>和<code>unload</code>之间的时间间隔比较长，亲测时是10毫秒以上。这不是绝对值，要看电脑配置和网络状态是否良好，网上建议5毫秒，但是亲测不行；<br> 2、当页面关闭时，<code>beforeunload</code>和<code>unload</code>之间的时间间隔非常短，具体是多少没有做过测试，反正远远小于10毫秒；<br> 3、所以本案例并不完美，慎用，希望有完美案例的博主可以分享给大家使用。</strong></p> 
</blockquote> 
<hr> 
<h3><a id="_11"></a>代码</h3> 
<pre><code class="prism language-javascript"><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">beforeUnload_time</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 页面(浏览器标签页)关闭前</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"beforeunload"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runBefor</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 页面(浏览器标签页)关闭后</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"unload"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runUnload</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 页面可视时刷新(会加载整个页面，用户体验不是很好，视情况使用)</span>
  <span class="token comment">// document.addEventListener("visibilitychange", this.runVisibilitychange);</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function">unmounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"beforeunload"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runBefor</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"unload"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runUnload</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// document.removeEventListener("visibilitychange", this.runVisibilitychange);</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 退出登录</span>
    <span class="token comment">// 跳转到登录页面</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">runVisibilitychange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>document<span class="token punctuation">.</span>hidden<span class="token punctuation">)</span> location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">runBefor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeUnload_time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">runUnload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beforeUnload_time<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<h3><a id="_51"></a>解析</h3> 
<h4><a id="_52"></a>功能概括</h4> 
<blockquote> 
 <p><strong>这是一段Vue.js组件的代码，管理与网页生命周期相关的事件，特别是用户与浏览器标签页窗口的交互。</strong></p> 
</blockquote> 
<hr> 
<h4><a id="_56"></a>数据属性</h4> 
<blockquote> 
 <pre><code class="prism language-javascript"><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">beforeUnload_time</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
 <p><strong>beforeUnload_time用于存储触发beforeunload事件时的时间戳。</strong></p> 
</blockquote> 
<hr> 
<h4><a id="mounted_67"></a>mounted生命周期钩子</h4> 
<blockquote> 
 <pre><code class="prism language-javascript"><span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 页面(浏览器标签页)关闭前</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"beforeunload"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runBefor</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 页面(浏览器标签页)关闭后</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"unload"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runUnload</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 页面可视时刷新(会加载整个页面，用户体验不是很好，视情况使用)</span>
  <span class="token comment">// document.addEventListener("visibilitychange", this.runVisibilitychange);</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre> 
 <p><strong>mounted生命周期钩子在组件插入DOM时调用。<br> beforeunload添加事件监听器，捕获用户尝试关闭或刷新标签页窗口时的事件，触发runBefor方法。<br> unload添加事件监听器，捕获标签页窗口实际关闭时的事件，触发runUnload方法。<br> visibilitychange(已注释掉)用于检测页面可见性变化的事件监听器。如果取消注释，会触发runVisibilitychange方法。</strong></p> 
</blockquote> 
<hr> 
<h4><a id="unmounted_84"></a>unmounted生命周期钩子</h4> 
<blockquote> 
 <pre><code class="prism language-javascript"><span class="token function">unmounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"beforeunload"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runBefor</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"unload"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runUnload</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// document.removeEventListener("visibilitychange", this.runVisibilitychange);</span>
<span class="token punctuation">}</span>
</code></pre> 
 <p><strong>unmounted生命周期钩子在组件从DOM中移除时调用。<br> 移除在mounted中添加的beforeunload和unload事件监听器。<br> 如果visibilitychange事件监听器已添加，也会在这里移除。</strong></p> 
</blockquote> 
<hr> 
<h4><a id="_97"></a>方法</h4> 
<blockquote> 
 <pre><code class="prism language-javascript"><span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 退出登录</span>
    <span class="token comment">// 跳转到登录页面</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">runVisibilitychange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>document<span class="token punctuation">.</span>hidden<span class="token punctuation">)</span> location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">runBefor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>beforeUnload_time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">runUnload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beforeUnload_time<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
 <p><strong><code>logout</code>方法用于处理用户退出登录的逻辑，可能包括清除会话数据和重定向用户到登录页面。<br> <code>runVisibilitychange</code>方法在文档可见时重新加载页面。这个方法被注释掉，可能是因为重新加载整个页面会影响用户体验。<br> <code>runBefor</code>在触发beforeunload事件时，将当前时间戳设置为beforeUnload_time。<br> <code>runUnload</code>计算unload和beforeunload事件之间的时间差。如果这个差值小于或等于10毫秒，则触发logout方法。这表明快速从beforeunload到unload的过渡通常发生在用户快速关闭标签页的情况下。</strong></p> 
</blockquote> 
<hr> 
<h3><a id="_123"></a>总结</h3> 
<blockquote> 
 <p><strong>事件监听器中的beforeunload和unload用于捕获用户尝试离开页面和页面实际卸载时的事件。<br> 退出登录逻辑，如果beforeunload和unload之间的时间非常短(&lt;= 10毫秒)，则触发退出登录流程。<br> 页面可见性变化时重新加载一个被注释掉的方法，用于在页面变得可见时重新加载整个页面，当前未使用，可能是因为用户体验问题。<br> 清理，在unmounted生命周期钩子中正确清理事件监听器，以防止内存泄漏。</strong></p> 
</blockquote> 
<hr> 
<h2><a id="_130"></a>完整版</h2> 
<h3><a id="_131"></a>前言</h3> 
<blockquote> 
 <p><strong>目前市面上没有任何浏览器可以准确的、通用的和可靠的区分用户关闭或刷新操作。<br> 如果只是单纯想在用户关闭(浏览器或标签页)时发送请求，那么没有任何完美的解决方案；<br> 如果只是想在Chrome(谷歌浏览器)或360浏览器的急速模式和其他基于Chrome(谷歌浏览器)套皮浏览器上实现，那么下面提供一个简单的方法，但是Edge浏览器不支持该方法。<s>Edge是真牛啊，青出于蓝胜于蓝？</s></strong></p> 
</blockquote> 
<hr> 
<h3><a id="_137"></a>浏览器刷新或关闭时的顺序</h3> 
<blockquote> 
 <p><strong>浏览器在关闭或刷新页面时，固定了<code>onbeforeunload</code>和<code>onunload</code>事件的执行顺序。</strong></p> 
 <hr> 
 <p><strong>1、当用户关闭浏览器标签、窗口或输入新的URL地址时，首先会触发<code>onbeforeunload</code>事件；<br> 2、在<code>onbeforeunload</code>事件处理完成后，如果用户选择离开页面(关闭或刷新)，则会触发<code>onunload</code>事件。</strong></p> 
 <hr> 
 <p><strong><code>onbeforeunload</code>事件在用户决定离开页面之前执行，而<code>onunload</code>事件在用户离开页面之后执行。这两个事件提供用户在离开页面前后执行代码的机会，可以用于执行清理操作或者提示用户确认离开等操作。通过对比两个事件的执行时间差，就可以简单判断浏览器的关闭或刷新行为。</strong></p> 
</blockquote> 
<hr> 
<h3><a id="Chrome_146"></a>简易判断Chrome(谷歌浏览器)关闭或刷新行为的方法</h3> 
<blockquote> 
 <pre><code class="prism language-javascript"><span class="token keyword">let</span> beforeTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  leaveTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  
<span class="token comment">// 获取浏览器onbeforeunload时期的时间戳</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  beforeTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onunload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 对比onunload时期和onbeforeunload时期的时间差值</span>
  leaveTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beforeTime<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>leaveTime <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果小于5就是关闭</span>
    <span class="token comment">// 发送请求... ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果大于5就是刷新</span>
    <span class="token comment">// 发送请求... ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
 <p><strong><a href="https://juejin.cn/post/7315846825344647194" rel="nofollow">掘金</a>博主经过测试，该方法仅支持Chrome(谷歌浏览器)其套皮谷歌的浏览器，Edge浏览器无论是关闭还是刷新，时间戳差均小于5ms，而Chrome(谷歌浏览器)的时间戳差均大于5ms，为7ms-8ms内。环境不同亦有可能导致结果不同。</strong></p> 
 <hr> 
 <p><em><strong>不同浏览器测试(别人的测试结果)</strong></em></p> 
 <table><thead><tr><th align="left">浏览器</th><th>关闭/刷新</th><th>onbeforeunload</th><th>onunload</th><th>时间间隔</th></tr></thead><tbody><tr><td align="left">Chrome52</td><td>关闭</td><td>[x]</td><td>[x]</td><td>&lt; 5ms</td></tr><tr><td align="left">Chrome52</td><td>刷新</td><td>[x]</td><td>[x]</td><td>&gt; 20ms</td></tr><tr><td align="left">Firefox46</td><td>关闭</td><td>[x]</td><td>[x]</td><td>&gt; 200ms</td></tr><tr><td align="left">Firefox46</td><td>刷新</td><td>[x]</td><td>[x]</td><td>10ms~100ms</td></tr><tr><td align="left">Edge13</td><td>关闭</td><td>[x]</td><td>[]</td><td>N/A</td></tr><tr><td align="left">Edge13</td><td>刷新</td><td>[x]</td><td>[x]</td><td>&lt; 5ms</td></tr><tr><td align="left">IE11</td><td>关闭</td><td>[x]</td><td>[x]</td><td>&gt; 10ms</td></tr><tr><td align="left">IE11</td><td>刷新</td><td>[x]</td><td>[x]</td><td>&lt; 5ms</td></tr></tbody></table> 
 <hr> 
 <p><em><strong>同浏览器不同项目测试(本人的测试结果)</strong></em></p> 
 <table><thead><tr><th align="left">类型</th><th>项目一</th><th>项目二</th></tr></thead><tbody><tr><td align="left">关闭</td><td>[10 6 8 8 10 9 7 8 7 7 10 4 8 7 5 11 5 6 6 15 6 8 5 9 4 7 6 8 9] (最小时间是4毫秒，最大时间是15毫秒)</td><td>[4 5 7 4 8 8 4 9 5 7 9 8 7 4 5 7 6 6 5] (最小时间是4毫秒，最大时间是9毫秒)</td></tr><tr><td align="left">刷新</td><td>[20 20 333 22 21 22 25 20 343 19 20 20 23 19 21 331 25 20 20 20 336 19 21 330 391 22 22 19 21 26 31 25 19 24 19] (最小时间是19毫秒，最大时间是391毫秒)</td><td>[22 323 334 337 20 335 339 333 336 323 21 18 19 19 17 20 20 25 22 20 323 339 335 333 329 321 19] (最小时间是17毫秒，最大时间是339毫秒)</td></tr></tbody></table> 
 <p><strong>根据以上表格，按照需求选择一个合适的分割点来判断浏览器的关闭或刷新操作。<br> 不同网络或不同电脑也会有不同的时间差。<br> <code>经测试未发现能100%判断清楚关闭或刷新操作，会有误操作，请酌情使用。</code></strong></p> 
</blockquote> 
<hr> 
<h3><a id="_194"></a>发送请求</h3> 
<blockquote> 
 <p><strong>既然已经区分了Chrome(谷歌浏览器)的关闭和刷新行为，那么该如何发送请求呢？</strong></p> 
 <hr> 
 <p><em><strong>1、使用Navigator.sendBeacon()发送请求</strong></em><br> <strong>该方法主要用于将统计数据发送到Web服务器，同时避免使用传统技术，如XMLHttpRequest所导致的各种问题。</strong></p> 
 <pre><code class="prism language-javascript"><span class="token comment">// url参数表明data将要被发送到的网络地址</span>
<span class="token comment">// data(可选)参数是将要发送的ArrayBuffer、ArrayBufferView、Blob、DOMString、FormData或URLSearchParams类型的数据。</span>
<span class="token comment">// 当用户代理成功把数据加入传输队列时，sendBeacon()方法将会返回true，否则返回false。</span>
navigator<span class="token punctuation">.</span><span class="token function">sendBeacon</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
 <p><strong>简简单单一行代码即可实现发送可靠的异步请求，同时不会延迟页面的卸载或影响下一导航的载入性能，<code>仅支持POST请求发送数据</code>。</strong></p> 
 <hr> 
 <p><em><strong>2、使用fetch+keepalive发送请求</strong></em><br> <strong>该方法用于发起获取资源的请求，返回的是一个promise。支持POST或GET方法，配合<code>keepalive</code>参数，可以实现浏览器关闭或刷新行为前发送请求。<code>keepalive</code>可用于超过页面的请求。<code>keepalive</code>就是<code>Navigator.sendBeacon()</code>的替代品。</strong></p> 
 <pre><code class="prism language-javascript"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">keepalive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
 <hr> 
 <p><em><strong>3、直接发送异步请求</strong></em><br> <strong>由于从Chrome83开始，<code>onunload</code>里面不允许执行同步的XHR，所以同步请求无法实现，但是异步请求可以实现。异步请求能发送到服务器的成功率并非百分之百，因此不推荐使用。</strong></p> 
</blockquote> 
<hr> 
<h3><a id="_220"></a>总结</h3> 
<p><strong>JavaScript代码</strong></p> 
<blockquote> 
 <p><strong>以上便是浏览器关闭或刷新前发送请求的几种方法，本文采用<code>fetch</code>+<code>keepalive</code>尝试简单实现浏览器仅关闭时发送请求，以便让后端知道用户关闭了浏览器，从而转为登出状态。</strong></p> 
 <pre><code class="prism language-javascript"><span class="token keyword">let</span> beforeTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
  leaveTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  beforeTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onunload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  leaveTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beforeTime<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>leaveTime <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"/api/user/logout"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">keepalive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
 <p><strong>使用该方法对于各浏览器的测试结果</strong></p> 
 <table><thead><tr><th align="left">浏览器/测试方法</th><th>关闭tab页</th><th>关闭浏览器</th><th>任务管理器关闭</th><th>刷新</th></tr></thead><tbody><tr><td align="left">Chrome</td><td>登出</td><td>登出</td><td>登出</td><td>未登出</td></tr><tr><td align="left">Edge</td><td>登出</td><td>未登出</td><td>登出</td><td>登出</td></tr><tr><td align="left">360急速模式</td><td>登出</td><td>登出</td><td>登出</td><td>未登出</td></tr><tr><td align="left">360兼容模式</td><td>白屏</td><td>白屏</td><td>白屏</td><td>白屏</td></tr><tr><td align="left">IE</td><td>白屏</td><td>白屏</td><td>白屏</td><td>白屏</td></tr></tbody></table> 
 <hr> 
 <table><thead><tr><th align="left">浏览器器/测试方法</th><th>关闭tab页</th><th>关闭浏览器</th><th>任务管理器关闭</th><th>刷新</th></tr></thead><tbody><tr><td align="left">Chrome</td><td>√</td><td>√</td><td>√</td><td>√</td></tr><tr><td align="left">Edge</td><td>√</td><td>×</td><td>√</td><td>×</td></tr><tr><td align="left">360急速模式</td><td>√</td><td>√</td><td>√</td><td>√</td></tr><tr><td align="left">360兼容模式</td><td>×</td><td>×</td><td>×</td><td>×</td></tr><tr><td align="left">IE</td><td>×</td><td>×</td><td>×</td><td>×</td></tr></tbody></table> 
</blockquote> 
<hr> 
<p><strong>vue3代码</strong></p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref<span class="token punctuation">,</span> Ref<span class="token punctuation">,</span> onMounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> <span class="token literal-property property">beforeUnload_time</span><span class="token operator">:</span> Ref<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  window<span class="token punctuation">.</span><span class="token function-variable function">onbeforeunload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    beforeUnload_time<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      event<span class="token punctuation">.</span>returnValue <span class="token operator">=</span> <span class="token string">"此操作将自动退出登录，确定要离开吗？"</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token string">"此操作将自动退出登录，确定要离开吗？"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token string">"请使用现代浏览器"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  window<span class="token punctuation">.</span><span class="token function-variable function">onunload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    time <span class="token operator">=</span> time <span class="token operator">-</span> beforeUnload_time<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 在vue中不需要写完整路径</span>
      <span class="token comment">// 把/api及后面的路径写上即可</span>
      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">"you_url"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>
        <span class="token literal-property property">keepalive</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<hr> 
<h2><a id="_294"></a>结束语</h2> 
<blockquote> 
 <p><strong><code>后端感知web退出本就不推荐由前端来处理，更优解为持续ping或者后端心跳机制发包来检测。</code><br> 既然设备那边提出了这个请求，web这也就努力挣扎一下，把测试结果发给评审人员评审一下吧！</strong></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/064be7c1dddeeff60843a11e89ba85d0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">双向链表＜数据结构 C版＞</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1cf91e6aae47c5b78ddab4fb71b94d02/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LLama Factory微调模型全流程，与peft库调用训练的adapter</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>