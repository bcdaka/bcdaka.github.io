<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Golang】定时任务Cron指南-毫秒级任务支持 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/45b1ed843423160ddc2a516181fba64b/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Golang】定时任务Cron指南-毫秒级任务支持">
  <meta property="og:description" content="文章目录 CronCron快速使用时间表达式最小分钟级任务最小秒级任务预定义的时间表 时区Job选项Job 包装器WithLogger 支持毫秒级任务 Cron 版本：v3.0.0
仓库：https://github.com/robfig/cron
cron是golang实现定时任务比较好的库, 这个库提供了一个简单而强大的接口，用于创建和管理基于cron表达式的定时任务。cron库的主要特点有：
基于cron表达式的任务调度多任务支持容错和错误处理可靠性易用的API灵活性并发安全 Cron快速使用 package main import ( &#34;fmt&#34; &#34;github.com/robfig/cron/v3&#34; ) func main() { job := cron.New() job.AddFunc(&#34;@every 1s&#34;, func() { fmt.Println(&#34;hello world&#34;) }) job.Start() select {} } 上述简单的示例表示，每秒钟执行一次hello world打印。其中容易让人产生困惑的是&#34;@every 1s&#34;的含义，这是一条描述定时任务执行的时间表达式，下面将会具体介绍。
时间表达式 cron库支持用 6 个空格分隔的域来表示时间（在v3版本中新增了对秒级任务的支持）：
# ┌────────────── second (0–59) # │ ┌───────────── minute (0–59) # │ │ ┌───────────── hour (0–23) # │ │ │ ┌───────────── day of the month (1–31) # │ │ │ │ ┌───────────── month (1–12) # │ │ │ │ │ ┌───────────── day of the week (0–6) (Sunday to Saturday; # │ │ │ │ │ │ 7 is also Sunday on some systems) # │ │ │ │ │ │ # │ │ │ │ │ │ # * * * * * * &lt;command to execute&gt; Field name | Mandatory?">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-20T16:56:14+08:00">
    <meta property="article:modified_time" content="2024-02-20T16:56:14+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Golang】定时任务Cron指南-毫秒级任务支持</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Cron_1" rel="nofollow">Cron</a></li><li><ul><li><a href="#Cron_14" rel="nofollow">Cron快速使用</a></li><li><a href="#_36" rel="nofollow">时间表达式</a></li><li><ul><li><a href="#_66" rel="nofollow">最小分钟级任务</a></li><li><a href="#_90" rel="nofollow">最小秒级任务</a></li><li><a href="#_114" rel="nofollow">预定义的时间表</a></li></ul> 
   </li><li><a href="#_159" rel="nofollow">时区</a></li><li><a href="#Job_174" rel="nofollow">Job</a></li><li><a href="#_220" rel="nofollow">选项</a></li><li><ul><li><a href="#Job__226" rel="nofollow">Job 包装器</a></li><li><a href="#WithLogger_234" rel="nofollow">WithLogger</a></li></ul> 
   </li><li><a href="#_269" rel="nofollow">支持毫秒级任务</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Cron_1"></a>Cron</h2> 
<blockquote> 
 <p>版本：v3.0.0<br> 仓库：https://github.com/robfig/cron</p> 
</blockquote> 
<p>cron是golang实现定时任务比较好的库, 这个库提供了一个简单而强大的接口，用于创建和管理基于cron表达式的定时任务。cron库的主要特点有：</p> 
<ul><li>基于cron表达式的任务调度</li><li>多任务支持</li><li>容错和错误处理</li><li>可靠性</li><li>易用的API</li><li>灵活性</li><li>并发安全</li></ul> 
<h3><a id="Cron_14"></a>Cron快速使用</h3> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>

	<span class="token string">"github.com/robfig/cron/v3"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	job <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	job<span class="token punctuation">.</span><span class="token function">AddFunc</span><span class="token punctuation">(</span><span class="token string">"@every 1s"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	job<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述简单的示例表示，每秒钟执行一次<em>hello world</em>打印。其中容易让人产生困惑的是<code>"@every 1s"</code>的含义，这是一条描述定时任务执行的<code>时间表达式</code>，下面将会具体介绍。</p> 
<h3><a id="_36"></a>时间表达式</h3> 
<p>cron库支持用 6 个空格分隔的域来表示时间（在v3版本中新增了对秒级任务的支持）：</p> 
<pre><code># ┌────────────── second (0–59)
# │ ┌───────────── minute (0–59)
# │ │ ┌───────────── hour (0–23)
# │ │ │ ┌───────────── day of the month (1–31)
# │ │ │ │ ┌───────────── month (1–12)
# │ │ │ │ │ ┌───────────── day of the week (0–6) (Sunday to Saturday;
# │ │ │ │ │ │                                   7 is also Sunday on some systems)
# │ │ │ │ │ │
# │ │ │ │ │ │
# * * * * * * &lt;command to execute&gt;
</code></pre> 
<pre><code>Field name   | Mandatory? | Allowed values  | Allowed special characters
----------   | ---------- | --------------  | --------------------------
Seconds      | Yes        | 0-59            | * / , -
Minutes      | Yes        | 0-59            | * / , -
Hours        | Yes        | 0-23            | * / , -
Day of month | Yes        | 1-31            | * / , - ?
Month        | Yes        | 1-12 or JAN-DEC | * / , -
Day of week  | Yes        | 0-6 or SUN-SAT  | * / , - ?
</code></pre> 
<ul><li>星号 (<code>*</code>)：星号表示 cron 表达式将匹配该字段的所有值；例如，在第 5 个字段（月份）中使用星号将表示每个月。</li><li>斜杠 (<code>/</code>)：斜杠用于描述范围的步长。例如，第2个字段（分钟）中的 3-59/15 表示该小时的第 3 分钟以及此后每 15 分钟一次。</li><li>逗号 (<code>,</code>)：逗号用于分隔列表中的项目。例如，在第 6 个字段（星期几）中使用“MON,WED,FRI”将表示星期一、星期三和星期五。</li><li>连字符 (<code>-</code>)：连字符用于定义范围。例如，在第 3 个字段（小时）9-17 表示上午 9 点到下午 5 点之间的每小时（含）。</li><li>问号(<code>?</code>)：只能用在月和周的域中，用来代替<code>*</code>，表示每月/周的任意一天。</li></ul> 
<h4><a id="_66"></a>最小分钟级任务</h4> 
<p>使用这种<code>以空格分隔的域来表示时间</code>的方式默认情况下只能支持到分钟级任务：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>

	<span class="token string">"github.com/robfig/cron/v3"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	job <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	job<span class="token punctuation">.</span><span class="token function">AddFunc</span><span class="token punctuation">(</span><span class="token string">"* * * * *"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	job<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>表示每分钟执行一次<br> 注意：实测在<code>v3.0.1</code>版本6个<code>*</code>是不会执行任务的。<br> 查看表达是是否正确：<code>https://crontab.guru/</code></p> 
<h4><a id="_90"></a>最小秒级任务</h4> 
<p>如果想要支持<code>秒级</code>任务，则需添加<code>cron.WithSeconds</code>选项：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>

	<span class="token string">"github.com/robfig/cron/v3"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	job <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	job<span class="token punctuation">.</span><span class="token function">AddFunc</span><span class="token punctuation">(</span><span class="token string">"* * * * * *"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	job<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>表示每秒执行一次<br> 注意：添加了<code>cron.WithSeconds</code>后6个<code>*</code>可以正确执行。</p> 
<h4><a id="_114"></a>预定义的时间表</h4> 
<p>可以使用几个预定义计划之一来代替 cron 表达式。</p> 
<pre><code>Entry                  | Description                                | Equivalent To
-----                  | -----------                                | -------------
@yearly (or @annually) | Run once a year, midnight, Jan. 1st        | 0 0 0 1 1 *
@monthly               | Run once a month, midnight, first of month | 0 0 0 1 * *
@weekly                | Run once a week, midnight between Sat/Sun  | 0 0 0 * * 0
@daily (or @midnight)  | Run once a day, midnight                   | 0 0 0 * * *
@hourly                | Run once an hour, beginning of hour        | 0 0 * * * *
</code></pre> 
<p>还可以安排作业以固定的时间间隔执行，从添加作业或运行 cron 时开始。这是通过格式化 cron 规范来支持的，如下所示：</p> 
<pre><code>@every &lt;duration&gt;
</code></pre> 
<p>其中<code>“duration”</code>是 <code>time.ParseDuration</code> 接受的字符串（http://golang.org/pkg/time/#ParseDuration）<br> 例子：</p> 
<pre><code class="prism language-go">c <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
c<span class="token punctuation">.</span><span class="token function">AddFunc</span><span class="token punctuation">(</span><span class="token string">"@hourly"</span><span class="token punctuation">,</span>      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Every hour"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
c<span class="token punctuation">.</span><span class="token function">AddFunc</span><span class="token punctuation">(</span><span class="token string">"@every 1h30m"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Every hour thirty"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
c<span class="token punctuation">.</span><span class="token function">AddFunc</span><span class="token punctuation">(</span><span class="token string">"@every 1s"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Every seconds"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
c<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>cron还提供了<code>cron.Every</code>方法，用于直接接收<code>time.Duration</code>来设置任务间隔：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/robfig/cron/v3"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	job <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>cron<span class="token punctuation">.</span><span class="token function">WithSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	job<span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span>cron<span class="token punctuation">.</span><span class="token function">Every</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">,</span> cron<span class="token punctuation">.</span><span class="token function">FuncJob</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	job<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_159"></a>时区</h3> 
<p>默认情况下任务是基于当前时区的，cron也可以设置不同的时区:</p> 
<pre><code class="prism language-go">loLosAngeles<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">LoadLocation</span><span class="token punctuation">(</span><span class="token string">"America/Los_Angeles"</span><span class="token punctuation">)</span>
job <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>cron<span class="token punctuation">.</span><span class="token function">WithLocation</span><span class="token punctuation">(</span>loLosAngeles<span class="token punctuation">)</span><span class="token punctuation">)</span>
job<span class="token punctuation">.</span><span class="token function">AddFunc</span><span class="token punctuation">(</span><span class="token string">"0 6 * * ?"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Every 6 o'clock at Los Angeles"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>或者：</p> 
<pre><code class="prism language-go">job<span class="token punctuation">.</span><span class="token function">AddFunc</span><span class="token punctuation">(</span><span class="token string">"CRON_TZ=Asia/Tokyo 0 6 * * ?"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Every 6 o'clock at Tokyo"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="Job_174"></a>Job</h3> 
<p>除了使用无参的回调方式，cron还提供了实现<code>job</code>接口的方式：</p> 
<pre><code class="prism language-go"><span class="token keyword">type</span> Job <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>实现<code>job</code>接口</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/robfig/cron/v3"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	job <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>cron<span class="token punctuation">.</span><span class="token function">WithSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	j <span class="token operator">:=</span> <span class="token operator">&amp;</span>myJob<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	job<span class="token punctuation">.</span><span class="token function">AddJob</span><span class="token punctuation">(</span><span class="token string">"@every 1s"</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>
	job<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> myJob <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	i <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j <span class="token operator">*</span>myJob<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	j<span class="token punctuation">.</span>i<span class="token operator">++</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello world:"</span><span class="token punctuation">,</span> j<span class="token punctuation">.</span>i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>执行结果：</p> 
<pre><code class="prism language-shell">hello world: <span class="token number">1</span>
hello world: <span class="token number">2</span>
hello world: <span class="token number">3</span>
hello world: <span class="token number">4</span>
hello world: <span class="token number">5</span>
hello world: <span class="token number">6</span>
</code></pre> 
<h3><a id="_220"></a>选项</h3> 
<ul><li><code>WithLocation</code>：指定时区</li><li><code>WithParser</code>：使用自定义的解析器</li><li><code>WithSeconds</code>：让时间格式支持秒</li><li><code>WithLogger</code>：自定义日志</li><li><code>WithChain</code>：Job 包装器</li></ul> 
<h4><a id="Job__226"></a>Job 包装器</h4> 
<blockquote> 
 <p>Job 包装器可以在执行实际的Job前后添加一些逻辑</p> 
</blockquote> 
<p>cron库提供了一些常用的包装器：</p> 
<ul><li>cron.DelayIfStillRunning: 如果上周期的任务还在执行，则<strong>延迟</strong>此次并产生一条Info日志</li><li>cron.SkipIfStillRunning：如果上周期的任务还在执行，则<strong>跳过</strong>此次并产生一条Info日志</li><li>cron.Recover：捕获任务异常，并产生error日志</li></ul> 
<h4><a id="WithLogger_234"></a>WithLogger</h4> 
<p>cron提供默认的标准输出日志打印<code>cron.DefaultLogger</code>和丢弃日志<code>cron.DiscardLogger</code>两种：</p> 
<pre><code class="prism language-go"><span class="token comment">// DefaultLogger is used by Cron if none is specified.</span>
<span class="token keyword">var</span> DefaultLogger Logger <span class="token operator">=</span> <span class="token function">PrintfLogger</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">"cron: "</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span>LstdFlags<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// DiscardLogger can be used by callers to discard all log messages.</span>
<span class="token keyword">var</span> DiscardLogger Logger <span class="token operator">=</span> <span class="token function">PrintfLogger</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>ioutil<span class="token punctuation">.</span>Discard<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>也可是使用<code>cron.PrintfLogger</code>和<code>cron.VerbosePrintfLogger</code>包装：</p> 
<ul><li>cron.PrintfLogger: 只打印错误日志</li><li>cron.VerbosePrintfLogger：打印详细日志</li></ul> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>

	<span class="token string">"github.com/robfig/cron/v3"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	job <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
		cron<span class="token punctuation">.</span><span class="token function">WithLogger</span><span class="token punctuation">(</span>cron<span class="token punctuation">.</span><span class="token function">VerbosePrintfLogger</span><span class="token punctuation">(</span>
			log<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">"cron: "</span><span class="token punctuation">,</span> log<span class="token punctuation">.</span>LstdFlags<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>

	job<span class="token punctuation">.</span><span class="token function">AddFunc</span><span class="token punctuation">(</span><span class="token string">"@every 1s"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	job<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_269"></a>支持毫秒级任务</h3> 
<p>cron库给出的方法最小只能支持到秒级任务，如果想要精确到毫秒级任务，则需要重新实现<code>Schedule</code>接口</p> 
<pre><code class="prism language-go"><span class="token comment">// Schedule describes a job's duty cycle.</span>
<span class="token keyword">type</span> Schedule <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Next returns the next activation time, later than the given time.</span>
	<span class="token comment">// Next is invoked initially, and then each time the job is run.</span>
	<span class="token function">Next</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>
</code></pre> 
<p>自定义一个<code>ConstantDelaySchedule</code>结构体，并给出<code>Every</code>方法（这边我限制最小到200ms）</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> cron

<span class="token keyword">import</span> <span class="token string">"time"</span>

<span class="token comment">// ConstantDelaySchedule represents a simple recurring duty cycle, e.g. "Every 5 minutes".</span>
<span class="token comment">// It does not support jobs more frequent than once a second.</span>
<span class="token keyword">type</span> ConstantDelaySchedule <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Delay time<span class="token punctuation">.</span>Duration
<span class="token punctuation">}</span>

<span class="token comment">// Every returns a crontab Schedule that activates once every duration.</span>
<span class="token comment">// Delays of less than a second are not supported (will round up to 1 second).</span>
<span class="token comment">// Any fields less than a Second are truncated.</span>
<span class="token keyword">func</span> <span class="token function">Every</span><span class="token punctuation">(</span>duration time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> ConstantDelaySchedule <span class="token punctuation">{<!-- --></span>
	min <span class="token operator">:=</span> <span class="token number">200</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond
	<span class="token keyword">if</span> duration <span class="token operator">&lt;</span> min <span class="token punctuation">{<!-- --></span>
		duration <span class="token operator">=</span> min
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ConstantDelaySchedule<span class="token punctuation">{<!-- --></span>
		Delay<span class="token punctuation">:</span> duration<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Next returns the next time this should be run.</span>
<span class="token comment">// This rounds so that the next activation time will be on the second.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>schedule ConstantDelaySchedule<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span>t time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> time<span class="token punctuation">.</span>Time <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>schedule<span class="token punctuation">.</span>Delay<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>调用：</p> 
<pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/robfig/cron/v3"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	job <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>cron<span class="token punctuation">.</span><span class="token function">WithSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	j <span class="token operator">:=</span> <span class="token operator">&amp;</span>myJob<span class="token punctuation">{<!-- --></span>
		t<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	job<span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span><span class="token function">Every</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span>
	job<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> myJob <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	i <span class="token builtin">int</span>
	t time<span class="token punctuation">.</span>Time
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>j <span class="token operator">*</span>myJob<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	j<span class="token punctuation">.</span>i<span class="token operator">++</span>
	now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	sub <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t<span class="token punctuation">)</span>
	j<span class="token punctuation">.</span>t <span class="token operator">=</span> now

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"hello world: %d, duraction : %d ms \n"</span><span class="token punctuation">,</span> j<span class="token punctuation">.</span>i<span class="token punctuation">,</span> sub<span class="token punctuation">.</span><span class="token function">Milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果：</p> 
<pre><code class="prism language-shell">hello world: <span class="token number">1</span>, duraction <span class="token builtin class-name">:</span> <span class="token number">201</span> ms 
hello world: <span class="token number">2</span>, duraction <span class="token builtin class-name">:</span> <span class="token number">201</span> ms 
hello world: <span class="token number">3</span>, duraction <span class="token builtin class-name">:</span> <span class="token number">201</span> ms 
hello world: <span class="token number">4</span>, duraction <span class="token builtin class-name">:</span> <span class="token number">201</span> ms 
hello world: <span class="token number">5</span>, duraction <span class="token builtin class-name">:</span> <span class="token number">201</span> ms 
hello world: <span class="token number">6</span>, duraction <span class="token builtin class-name">:</span> <span class="token number">200</span> ms 
hello world: <span class="token number">7</span>, duraction <span class="token builtin class-name">:</span> <span class="token number">201</span> ms 
hello world: <span class="token number">8</span>, duraction <span class="token builtin class-name">:</span> <span class="token number">201</span> ms 
hello world: <span class="token number">9</span>, duraction <span class="token builtin class-name">:</span> <span class="token number">201</span> ms 
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e7e5c3ad84d5c7b5a34babb824ef00d0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android的Compose</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2facbf8b592ade7c5e471865f8784684/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SQL Server 2019安装详细教程(图文详解，非常靠谱)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>