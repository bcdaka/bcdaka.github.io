<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL学习（17）：SQL编程：存储过程 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/f3037c183075934699c60aaaae9b9bd6/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="MySQL学习（17）：SQL编程：存储过程">
  <meta property="og:description" content="1.什么是存储过程 存储过程是事先经过编译并存储在数据库中的一段 SQL语句的集合。
存储过程的特点：
（1）封装，复用
（2）可以接收参数，可以返回数据
2.存储过程语法 2.1创建 create procedure 存储过程名([参数列表]) #小括号必须要有，参数列表可以没有 begin SQL语句 end; 2.2调用 call 存储过程名([参数列表]); 2.3查询 （1）查询指定数据库的存储过程及状态信息
select * from information_schema.routines where routine_schema=&#39;数据库名&#39;; （2）查询某个存储过程的定义
show create procedure 存储过程名; 查询结果出现的root是创建存储过程的用户
2.4删除 drop procedure 存储过程名; 2.5结束符号问题 在存储过程的SQL语句部分中，需要分号切分语句，而分号是mysql识别一条命令完结的标识，所以会造成使用分号后，SQL语句直接执行，无法创建存储过程。
要解决此问题，可以通过delimiter命令更改结束符，来规避此问题：
delimiter $$ #属于这条命令后，mysql所有语句的结束符就由分号变为$$了 #$$不是固定的，可以自行设置结束符 使用实例如下图：
创建完存储过程后，还可以再用delimiter命令把结束标志改回分号
3.存储过程变量 3.1系统变量 系统变量是mysql服务器提供的，分为全局变量（global）、会话变量（session）
（1）查看系统变量
show [global] variables; #查看所有变量 #不写global是检索当前会话的变量，写global是检索mysql全局的变量 show [global] variables like &#39;匹配内容&#39;; #通过like模糊匹配查找变量，_匹配单字符，%匹配多字符 select @@[global] 系统变量名; #查看指定变量 （2）设置系统变量
set [global] 系统变量名=值； 或 set @@[global]系统变量名=值； 变量值设置完后（无论是全局还是会话），只要重启数据库，系统变量名就都会恢复成默认值。如果想永久更改，需要在配置文件/etc/my.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-02T10:43:54+08:00">
    <meta property="article:modified_time" content="2024-08-02T10:43:54+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL学习（17）：SQL编程：存储过程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>1.什么是存储过程</h2> 
<p>存储过程是事先经过编译并存储在数据库中的一段 SQL语句的集合。</p> 
<p>存储过程的特点：</p> 
<p><span style="color:#4da8ee;">（1）</span>封装，复用</p> 
<p><span style="color:#4da8ee;">（2）</span>可以接收参数，可以返回数据</p> 
<p></p> 
<h2>2.存储过程语法</h2> 
<h3><strong>2.1创建</strong></h3> 
<pre><code>create procedure 存储过程名([参数列表])
#小括号必须要有，参数列表可以没有
begin
SQL语句
end;</code></pre> 
<h3>2.2调用</h3> 
<pre><code>call 存储过程名([参数列表]);</code></pre> 
<p><img alt="" height="196" src="https://images2.imgbox.com/44/01/cmui9qSN_o.png" width="273"></p> 
<h3><strong>2.3查询</strong></h3> 
<p><span style="color:#4da8ee;">（1）</span>查询指定数据库的存储过程及状态信息</p> 
<pre><code>select * from information_schema.routines where routine_schema='数据库名';</code></pre> 
<p><span style="color:#4da8ee;">（2）</span>查询某个存储过程的定义</p> 
<pre><code>show create procedure 存储过程名;</code></pre> 
<p><img alt="" height="104" src="https://images2.imgbox.com/2f/21/KiBmM9je_o.png" width="364"></p> 
<p>查询结果出现的root是创建存储过程的用户</p> 
<h3><strong>2.4删除</strong></h3> 
<pre><code>drop procedure 存储过程名;</code></pre> 
<h3>2.5结束符号问题</h3> 
<p>在存储过程的SQL语句部分中，需要分号切分语句，而分号是mysql识别一条命令完结的标识，所以会造成使用分号后，SQL语句直接执行，无法创建存储过程。</p> 
<p>要解决此问题，可以通过delimiter命令更改结束符，来规避此问题：</p> 
<pre><code>delimiter $$
#属于这条命令后，mysql所有语句的结束符就由分号变为$$了
#$$不是固定的，可以自行设置结束符</code></pre> 
<p>使用实例如下图：</p> 
<p><img alt="" height="151" src="https://images2.imgbox.com/ad/c7/MCK8W81U_o.png" width="363"></p> 
<p>创建完存储过程后，还可以再用delimiter命令把结束标志改回分号</p> 
<p></p> 
<h2>3.存储过程变量</h2> 
<h3>3.1系统变量</h3> 
<p>系统变量是mysql服务器提供的，分为全局变量（global）、会话变量（session）</p> 
<p><span style="color:#4da8ee;">（1）</span>查看系统变量</p> 
<pre><code>show [global] variables;
#查看所有变量
#不写global是检索当前会话的变量，写global是检索mysql全局的变量

show [global] variables like '匹配内容';
#通过like模糊匹配查找变量，_匹配单字符，%匹配多字符

select @@[global] 系统变量名;
#查看指定变量</code></pre> 
<p><span style="color:#4da8ee;">（2）</span>设置系统变量</p> 
<pre><code>set [global] 系统变量名=值；
或
set @@[global]系统变量名=值；
</code></pre> 
<p>变量值设置完后（无论是全局还是会话），只要重启数据库，系统变量名就都会恢复成默认值。如果想永久更改，需要在配置文件/etc/my.cnf中配置</p> 
<h3>3.2用户变量</h3> 
<p>用户可以自定义变量，<strong>不需提前声明</strong>。</p> 
<pre><code>#赋值语句
set @变量名=值;
或
select @变量名=值;

select 字段名 into @变量名 from 表名；
#直接把表内字段的数据作为变量的值

select @变量名;
#查看变量的值</code></pre> 
<p><img alt="" height="76" src="https://images2.imgbox.com/31/7f/szN97n9l_o.png" width="347"></p> 
<p><img alt="" height="181" src="https://images2.imgbox.com/7a/d6/v4F9BvaL_o.png" width="421"></p> 
<p>用户变量的使用只限于当前会话</p> 
<h3>3.3局部变量</h3> 
<p>局部变量需要declare声明，其范围是在一个存储过程的begin到end之间</p> 
<p><span style="color:#4da8ee;">（1）</span>声明：</p> 
<pre><code>declare 变量名 变量类型[default 默认值];
#在声明的时候可以直接设置一个默认值
#变量类型就是int、char、varchar等等</code></pre> 
<p><span style="color:#4da8ee;">（2）</span>赋值：</p> 
<p>跟用户变量的赋值方式相同</p> 
<pre><code>#赋值语句
set @变量名=值;
或
select @变量名=值;

select 字段名 into @变量名 from 表名；
#直接把表内字段的数据作为变量的值</code></pre> 
<p><img alt="" height="167" src="https://images2.imgbox.com/3b/65/JTMoc3cU_o.png" width="324"></p> 
<p></p> 
<h2>4.存储过程参数与流程控制语句</h2> 
<h3>4.1参数</h3> 
<p>存储过程的参数是在创建时设置的，作为输入、输出的对象使用。</p> 
<p>存储过程的参数有以下3种：</p> 
<p><img alt="" height="263" src="https://images2.imgbox.com/b1/27/SLWLvTBs_o.png" width="1200"></p> 
<p>使用方法如下：</p> 
<p><img alt="" height="105" src="https://images2.imgbox.com/63/39/SASnTjHQ_o.png" width="407"></p> 
<p><span style="color:#4da8ee;">（1）</span>实例1</p> 
<p><img alt="" height="305" src="https://images2.imgbox.com/fb/fa/BF650JVr_o.png" width="377"></p> 
<p>调用及显示方法如下：</p> 
<p><img alt="" height="45" src="https://images2.imgbox.com/49/5e/y0PQjhGh_o.png" width="222"></p> 
<p><span style="color:#ff9900;">*</span>@result是一个未经声明的用户变量，只是用来接收存储过程结果的</p> 
<p><span style="color:#98c091;">图中灰色字段是软件工具自动提示出来的，不需要敲</span></p> 
<p><span style="color:#4da8ee;">（2）</span>实例2</p> 
<p><img alt="" height="194" src="https://images2.imgbox.com/80/a7/q31U1JBu_o.png" width="458"></p> 
<p>该例中，需要设置一个同时负责传入数据与传出数据的用户变量@score</p> 
<h3>4.2if else语句</h3> 
<p>if判断是在begin与end间使用</p> 
<p><img alt="" height="157" src="https://images2.imgbox.com/10/69/6VitBdJy_o.png" width="239"></p> 
<p>条件1成立，执行第一个then后的语句，否则判断条件2；条件2成立，执行第二个then后的语句，否则判断条件3......</p> 
<p>end if是固定的结尾标识</p> 
<h3>4.3case语句</h3> 
<p><span style="color:#4da8ee;">（1）</span>语法一</p> 
<pre><code>case 值
when 值1 then 语句1
when 值2 then 语句2
[else 语句3]
end else;
#case后的值是值1就执行语句1，是值2就执行语句2</code></pre> 
<p><span style="color:#4da8ee;">（2）</span>语法二</p> 
<pre><code>case
when 条件表达式1 then 语句1
when 条件表达式2 then 语句2
[else 语句3]
end else;
#条件表达式1为true就执行语句1，条件表达式2为true就执行语句2，否则执行语句3</code></pre> 
<h3>4.4while循环语句</h3> 
<p><img alt="" height="113" src="https://images2.imgbox.com/f4/77/YiZsZ1bb_o.png" width="384"></p> 
<p>实例如下：</p> 
<p><img alt="" height="302" src="https://images2.imgbox.com/bf/27/LhDqu2A3_o.png" width="384"></p> 
<h3>4.5repeat循环语句</h3> 
<p>与while语句的区别是：while是符合条件才进行循环，repeat是满足条件才跳出循环</p> 
<p><img alt="" height="150" src="https://images2.imgbox.com/eb/f5/nEBVNqHY_o.png" width="581"></p> 
<p>使用repeat写上面的while实例如下：</p> 
<p><img alt="" height="299" src="https://images2.imgbox.com/ed/41/IhW3j8Ic_o.png" width="254"></p> 
<h3>4.6loop循环语句</h3> 
<p>loop可实现简单的循环，如果不在SQL逻辑中增加退出循环的条件，可以实现简单的死循环。</p> 
<p>一个普通的loop循环如下：</p> 
<pre><code>[自定义开始标志:]loop
SQL语句
end loop[自定义结束标志];
#开始标志后的冒号不能少</code></pre> 
<p>loop循环本身是没有退出条件，需要自行添加退出语句：</p> 
<p><span style="color:#4da8ee;">（1）</span>leave：配合循环使用，退出循环。</p> 
<p><span style="color:#4da8ee;">（2）</span>iterate：必须用在循环中，作用是跳过当前循环剩下的语句，直接进入下一次循环。</p> 
<p>使用实例如下（还是前例）：</p> 
<p><img alt="" height="352" src="https://images2.imgbox.com/ee/61/VSBl92mR_o.png" width="244"></p> 
<h3>4.7游标cursor</h3> 
<p>游标是用来存储查询结果集的数据类型，在存储过程和函数中可以使用游标对结果集进行循环的处理。</p> 
<p>游标的使用包括游标游标(CURSOR)的声明、OPEN、FETCH和 CLOSE，其语法如下：</p> 
<pre><code>DECLARE 游标名称 CURSOR FOR 查询语句;
#声明游标

OPEN 游标名称;
#打开游标

FETCH 游标名称 INTO 变量,变量...;
#获取游标记录

CLOSE 游标名称;
#关闭游标</code></pre> 
<p>使用实例如下：</p> 
<p><img alt="" height="89" src="https://images2.imgbox.com/98/dc/7esEiYnu_o.png" width="1200"></p> 
<p><img alt="" height="175" src="https://images2.imgbox.com/20/79/rvN4FEMC_o.png" width="217"></p> 
<p><img alt="" height="459" src="https://images2.imgbox.com/ba/20/XG4phXwW_o.png" width="1039"></p> 
<p><img alt="" height="199" src="https://images2.imgbox.com/f9/5f/A1cJxsy4_o.png" width="471"></p> 
<p>上述程序虽然可以顺利执行，但存在一个while语句死循环的问题，要解决这个问题，可以使用handler（条件处理程序）</p> 
<h3>4.8条件处理程序handler</h3> 
<p>handler可以用来定义在流程执行中遇到问题时的处理步骤。分为继续、停止2种。其语法如下：</p> 
<pre><code>declare continue handler for 状态1,状态2... SQL语句;
#当出现语句中的状态时，继续执行当前程序

declare exit handler for 状态1,状态2... SQL语句;
#当出现语句中的状态时，停止执行当前程序</code></pre> 
<p>语句中的状态有4种：</p> 
<p><span style="color:#4da8ee;">（1）</span>sqlstate 状态码</p> 
<p>状态码比如02000，代表没得到数据</p> 
<p><span style="color:#4da8ee;">（2）</span>sqlwaring：所有以01开头的状态码</p> 
<p><span style="color:#4da8ee;">（3）</span>not found：所有以02开头的状态码</p> 
<p><span style="color:#4da8ee;">（4）</span>sqlexception：01、02开头以外的其他状态码</p> 
<p>使用handler解决前述while语句死循环的方法如下：</p> 
<p><img alt="" height="311" src="https://images2.imgbox.com/3a/d0/MyPdlQxx_o.png" width="647"></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2d772498708a6efd04be0693b4695639/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">第三届Apache Flink 极客挑战赛暨AAIG CUP比赛攻略_大浪813团队</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/84aecee618e4f524b74a4dd6a2220a62/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【海贼王航海日志：前端技术探索】HTML你学会了吗？(二)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>