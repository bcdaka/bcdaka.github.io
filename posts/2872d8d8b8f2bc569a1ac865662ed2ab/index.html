<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【MySQL】窗口函数详解（概念&#43;练习&#43;实战） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/2872d8d8b8f2bc569a1ac865662ed2ab/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【MySQL】窗口函数详解（概念&#43;练习&#43;实战）">
  <meta property="og:description" content="文章目录 前言1. SQL窗口函数1.1 窗口函数概念1.2 窗口函数语法1.3 常见窗口函数1.3.1 聚合窗口函数1.3.2 专用窗口函数 1.4 窗口函数性能比较 2. LeetCode 例题2.1 LeetCode SQL 178：分数排名2.2 LeetCode SQL 184：最高工资2.3 LeetCode SQL 185：前三工资 3. 项目实战3.1 需求描述3.2 SQL 实战 4. 补充与总结4.1 `ROWS BETWEEN`子句常见关键字含义4.2 如何理解窗口函数的“窗口”？4.3 总结 参考资料 牛逼的兄弟两个月前教了我一招...... 前言 2023年12月下旬，广东终于冷了！回想直到12月15那天，依然穿着短袖上班，吹着风扇空调睡觉… 哈哈，这是截至发文时的一些感受与题外话。天气是冷了，但心中依然热情似火，一是工作业务上又有稍微复杂的业务，有挑战；二是虽然有挑战，但想起牛逼的兄弟@CaptinKoo两个月前教了我一招：SQL窗口函数，业务难题迎刃而解！趁着这次解决难题的热度，将本次学到的窗口函数知识点以及项目实战记录下来，供各位分享。
我个人学习窗口函数主要有两个用处：一是对现有SQL知识的拓展，二是能使用窗口函数对一些特定场景做SQL简化，解决复杂问题。
但在正式开始之前，得事先说明一个前提：
前提
窗口函数是 Mysql 8 的新特性。本文的学习与演示，都基于Mysql 8学习窗口函数，建议有一定的SQL基础 学习目标
学习并了解SQL窗口函数相关概念能使用SQL窗口函数解决部分业务场景题目，项目实战若实际业务用得少，那上述知识了解一下即可，建议收藏本文，用到的时候可以翻出来参考 下面我们开始！
1. SQL窗口函数 这一小节我们介绍窗口函数的一些概念。
1.1 窗口函数概念 概念
窗口函数，也叫OLAP函数（Online Anallytical Processing，联机分析处理），可以对数据库数据进行实时分析处理。
窗口函数在MySQL 8中引入，是Mysql 8的新特性。是一种主要用于数据分析、特定字段分组等的一种特殊的函数。
常见使用场景
数据分析，如排名、排序、分组统计、计算、前后值比较等对某些分组场景简化SQL，提升效率常用于子查询，将一些复杂条件简化 1.2 窗口函数语法 窗口函数的语法如下：
窗口函数([参数]) OVER ( [PARTITION BY &lt;分组列&gt;] [ORDER BY &lt;排序列 ASC/DESC&gt;] [ROWS BETWEEN 开始行 AND 结束行] ) PARTITION BY 子句用于指定分组列，关键字：PARTITION BY 。ORDER BY 子句用于指定排序列，关键字ORDER BY 。ROWS BETWEEN 子句用于指定窗口的范围，关键字ROWS BETWEEN 即[开始行]、[结束行]（这部分在“补充与总结”小节中作补充详细说明）。 其中，ROWS BETWEEN 子句在实际中可能用得相对少一些，因此有部分参考资料的语法描述省略了ROWS BETWEEN 子句，主要侧重于PARTITION BY分组与ORDER BY排序：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-19T10:00:00+08:00">
    <meta property="article:modified_time" content="2023-12-19T10:00:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【MySQL】窗口函数详解（概念&#43;练习&#43;实战）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_3" rel="nofollow">前言</a></li><li><a href="#1_SQL_22" rel="nofollow">1. SQL窗口函数</a></li><li><ul><li><a href="#11__26" rel="nofollow">1.1 窗口函数概念</a></li><li><a href="#12__38" rel="nofollow">1.2 窗口函数语法</a></li><li><a href="#13__69" rel="nofollow">1.3 常见窗口函数</a></li><li><ul><li><a href="#131__109" rel="nofollow">1.3.1 聚合窗口函数</a></li><li><a href="#132__149" rel="nofollow">1.3.2 专用窗口函数</a></li></ul> 
   </li><li><a href="#14__179" rel="nofollow">1.4 窗口函数性能比较</a></li></ul> 
  </li><li><a href="#2_LeetCode__193" rel="nofollow">2. LeetCode 例题</a></li><li><ul><li><a href="#21_LeetCode_SQL_178_198" rel="nofollow">2.1 LeetCode SQL 178：分数排名</a></li><li><a href="#22_LeetCode_SQL_184_220" rel="nofollow">2.2 LeetCode SQL 184：最高工资</a></li><li><a href="#23_LeetCode_SQL_185_253" rel="nofollow">2.3 LeetCode SQL 185：前三工资</a></li></ul> 
  </li><li><a href="#3__287" rel="nofollow">3. 项目实战</a></li><li><ul><li><a href="#31__291" rel="nofollow">3.1 需求描述</a></li><li><a href="#32_SQL__305" rel="nofollow">3.2 SQL 实战</a></li></ul> 
  </li><li><a href="#4__332" rel="nofollow">4. 补充与总结</a></li><li><ul><li><a href="#41_ROWS_BETWEEN_334" rel="nofollow">4.1 `ROWS BETWEEN`子句常见关键字含义</a></li><li><a href="#42__356" rel="nofollow">4.2 如何理解窗口函数的“窗口”？</a></li><li><a href="#43__370" rel="nofollow">4.3 总结</a></li></ul> 
  </li><li><a href="#_380" rel="nofollow">参考资料</a></li></ul> 
</div> 
<p></p> 
<h4 align="center"> 牛逼的兄弟两个月前教了我一招...... </h4> 
<h2><a id="_3"></a>前言</h2> 
<p>2023年12月下旬，广东终于冷了！回想直到12月15那天，依然穿着短袖上班，吹着风扇空调睡觉… 哈哈，这是截至发文时的一些感受与题外话。天气是冷了，但心中依然热情似火，一是工作业务上又有稍微复杂的业务，有挑战；二是虽然有挑战，但想起牛逼的兄弟@CaptinKoo两个月前教了我一招：SQL窗口函数，业务难题迎刃而解！趁着这次解决难题的热度，将本次学到的窗口函数知识点以及项目实战记录下来，供各位分享。</p> 
<p>我个人学习窗口函数主要有两个用处：一是对现有SQL知识的拓展，二是能使用窗口函数对一些特定场景做SQL简化，解决复杂问题。</p> 
<p>但在正式开始之前，得事先说明一个前提：<br> <strong>前提</strong></p> 
<ul><li>窗口函数是 Mysql 8 的新特性。本文的学习与演示，都基于Mysql 8</li><li>学习窗口函数，建议有一定的SQL基础</li></ul> 
<p><strong>学习目标</strong></p> 
<ul><li>学习并了解SQL窗口函数相关概念</li><li>能使用SQL窗口函数解决部分业务场景题目，项目实战</li><li>若实际业务用得少，那上述知识了解一下即可，建议收藏本文，用到的时候可以翻出来参考</li></ul> 
<p>下面我们开始！</p> 
<h2><a id="1_SQL_22"></a>1. SQL窗口函数</h2> 
<p>这一小节我们介绍窗口函数的一些概念。</p> 
<h3><a id="11__26"></a>1.1 窗口函数概念</h3> 
<p><strong>概念</strong><br> 窗口函数，也叫OLAP函数（Online Anallytical Processing，联机分析处理），可以对数据库数据进行实时分析处理。</p> 
<p>窗口函数在MySQL 8中引入，是Mysql 8的新特性。是一种主要用于数据分析、特定字段分组等的一种特殊的函数。</p> 
<p><strong>常见使用场景</strong></p> 
<ul><li>数据分析，如排名、排序、分组统计、计算、前后值比较等</li><li>对某些分组场景简化SQL，提升效率</li><li>常用于子查询，将一些复杂条件简化</li></ul> 
<h3><a id="12__38"></a>1.2 窗口函数语法</h3> 
<p>窗口函数的语法如下：</p> 
<pre><code>窗口函数([参数]) OVER (
  [PARTITION BY &lt;分组列&gt;] 
  [ORDER BY &lt;排序列 ASC/DESC&gt;]
  [ROWS BETWEEN 开始行 AND 结束行]
)
</code></pre> 
<ul><li><code>PARTITION BY</code> 子句用于指定分组列，关键字：<code>PARTITION BY</code> 。</li><li><code>ORDER BY</code> 子句用于指定排序列，关键字<code>ORDER BY</code> 。</li><li><code>ROWS BETWEEN</code> 子句用于指定窗口的范围，关键字<code>ROWS BETWEEN</code> 即[开始行]、[结束行]（这部分在“补充与总结”小节中作补充详细说明）。</li></ul> 
<p>其中，<code>ROWS BETWEEN</code> 子句在实际中可能用得相对少一些，因此有部分参考资料的语法描述省略了<code>ROWS BETWEEN</code> 子句，主要侧重于<code>PARTITION BY</code>分组与<code>ORDER BY</code>排序：</p> 
<pre><code>窗口函数([参数]) OVER (
  [PARTITION BY &lt;分组列&gt;] 
  [ORDER BY &lt;排序列 ASC/DESC&gt;]
</code></pre> 
<p>也正因此，本文将<code>ROWS BETWEEN</code> 子句相关关键字知识点将会以补充的形式说明，而侧重常用窗口函数的学习与练习，侧重<code>PARTITION BY</code> 子句与<code>ORDER BY</code>子句的使用。</p> 
<p>语法举例，设有Order表，查询销售数量总和及其当前行前两行和后两行的销售数量总和：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> order_date<span class="token punctuation">,</span> quantity<span class="token punctuation">,</span>
       <span class="token function">SUM</span><span class="token punctuation">(</span>quantity<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> product_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> order_date <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token number">2</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token number">2</span> <span class="token keyword">FOLLOWING</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> sum_surrounding_quantities
<span class="token keyword">FROM</span> orders
</code></pre> 
<p>这个例子暂时看不懂个没关系，接下来，我们会详细介绍常见窗口函数，并在介绍的过程中举例。之后，上述例子就很好理解了。</p> 
<h3><a id="13__69"></a>1.3 常见窗口函数</h3> 
<p>本小节介绍常见窗口函数。</p> 
<p>若要跟着本文进行练习，则可以参考着创建如下表，本文的例子均基于下表：</p> 
<p>设计一个销售数据表。该表包含以下字段：</p> 
<ul><li>id ：销售记录的唯一标识符（主键）</li><li>product ：产品名称</li><li>category ：产品类别</li><li>sale_date ：销售日期</li><li>quantity ：销售数量</li><li>revenue ：销售收入</li></ul> 
<p>以下是创建表的<code>DDL</code>以及 插入模拟数据的<code>DML</code></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> sales <span class="token punctuation">(</span>
  id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  product <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  category <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  sale_date <span class="token keyword">DATE</span><span class="token punctuation">,</span>
  quantity <span class="token keyword">INT</span><span class="token punctuation">,</span>
  revenue <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> sales <span class="token punctuation">(</span>id<span class="token punctuation">,</span> product<span class="token punctuation">,</span> category<span class="token punctuation">,</span> sale_date<span class="token punctuation">,</span> quantity<span class="token punctuation">,</span> revenue<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span>
  <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Product A'</span><span class="token punctuation">,</span> <span class="token string">'Category 1'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-01'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">100.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'Product B'</span><span class="token punctuation">,</span> <span class="token string">'Category 1'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-01'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">50.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Product A'</span><span class="token punctuation">,</span> <span class="token string">'Category 2'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-02'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">80.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'Product B'</span><span class="token punctuation">,</span> <span class="token string">'Category 2'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-02'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">30.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">'Product A'</span><span class="token punctuation">,</span> <span class="token string">'Category 1'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-03'</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">120.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'Product B'</span><span class="token punctuation">,</span> <span class="token string">'Category 1'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-03'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">70.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'Product A'</span><span class="token punctuation">,</span> <span class="token string">'Category 2'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-04'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">60.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'Product B'</span><span class="token punctuation">,</span> <span class="token string">'Category 2'</span><span class="token punctuation">,</span> <span class="token string">'2022-01-04'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">40.00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>好的，准备工作完成，下面我们一边学习具体窗口函数并练习吧！</p> 
<h4><a id="131__109"></a>1.3.1 聚合窗口函数</h4> 
<p>许多窗口函数的教程，通常将常用的窗口函数分为两大类：聚合窗口函数 与 专用窗口函数。聚合窗口函数的函数名与普通常用聚合函数一致，功能也一致。从使用的角度来讲，与普通聚合函数的区别在于提供了窗口函数的专属子句，来使得数据的分析与获取更简便。主要有如下几个：</p> 
<table><thead><tr><th>函数名</th><th>作用</th></tr></thead><tbody><tr><td>SUM</td><td>求和</td></tr><tr><td>AVG</td><td>求平均值</td></tr><tr><td>COUNT</td><td>求数量</td></tr><tr><td>MAX</td><td>求最大值</td></tr><tr><td>MIN</td><td>求最小值</td></tr></tbody></table> 
<p><strong>区别</strong><br> 这个例子演示与普通聚合函数的区别。设我们要求使用一条查询语句，在sales表每行最后一列都加上这一行的产品类别 <code>category</code>的 平均 销售收入<code>revenue</code>，并且以<code>category</code>顺序排序，即如下图所示：<br> <img src="https://images2.imgbox.com/f2/f0/AsNtdkt3_o.png" alt="00"></p> 
<ul><li>普通聚合函数的一种解法：</li></ul> 
<pre><code class="prism language-sql">  <span class="token keyword">SELECT</span> 
	t1<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> 
	t2<span class="token punctuation">.</span>avg_revenue <span class="token keyword">FROM</span> sales t1 
  <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
		<span class="token keyword">SELECT</span> category<span class="token punctuation">,</span> <span class="token function">AVG</span><span class="token punctuation">(</span>revenue<span class="token punctuation">)</span> <span class="token keyword">AS</span> avg_revenue 
		<span class="token keyword">FROM</span> sales  
		<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> category
  <span class="token punctuation">)</span> t2 <span class="token keyword">ON</span> t1<span class="token punctuation">.</span>category <span class="token operator">=</span> t2<span class="token punctuation">.</span>category <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> t1<span class="token punctuation">.</span>category
</code></pre> 
<ul><li>聚合窗口函数:</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span>
  sales<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
  <span class="token function">AVG</span><span class="token punctuation">(</span> revenue <span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span> <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> category <span class="token punctuation">)</span> <span class="token keyword">AS</span> avg_revenue 
<span class="token keyword">FROM</span>
	sales
</code></pre> 
<p>这么一对比，窗口聚合函数简单不少！</p> 
<h4><a id="132__149"></a>1.3.2 专用窗口函数</h4> 
<p>常见的专用窗口函数</p> 
<table><thead><tr><th>函数名</th><th>分类</th><th>说明</th></tr></thead><tbody><tr><td>RANK</td><td>排序函数</td><td>类似于排名，并列的结果序号可以重复，序号不连续</td></tr><tr><td>DENSE_RANK</td><td>排序函数</td><td>类似于排名，并列的结果序号可以重复，序号连续</td></tr><tr><td>ROW_NUMBER</td><td>排序函数</td><td>对该分组下的所有结果作一个排序，基于该分组给一个行数</td></tr><tr><td>PERCENT_RANK</td><td>分布函数</td><td>每行按照公式 <code>(rank-1) / (rows-1)</code> 进行计算</td></tr><tr><td>CUME_DIST</td><td>分布函数</td><td>分组内小于、等于当前 rank 值的行数 / 分组内总行数</td></tr></tbody></table> 
<p><strong>练习</strong><br> 分别对上述表格常见的专用窗口函数进行调用，查看结果。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
	<span class="token operator">*</span><span class="token punctuation">,</span>
	RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> category <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> quantity <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>quantity_rank<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
	DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> category <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> product <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>product_dense_rank<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
	ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> category <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> product <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>product_row_number<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
	PERCENT_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> category <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> quantity <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>quantity_percent_rank<span class="token punctuation">`</span></span><span class="token punctuation">,</span>
	CUME_DIST<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> category <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> quantity <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>quantity_cume_dist<span class="token punctuation">`</span></span>
<span class="token keyword">FROM</span> sales
</code></pre> 
<p><img src="https://images2.imgbox.com/ee/a2/ZJcQ5vGB_o.png" alt="01"></p> 
<p>至于其它专用窗口函数，请读者自行查阅其它资料做拓展。</p> 
<h3><a id="14__179"></a>1.4 窗口函数性能比较</h3> 
<p>通过对上面我们对窗口函数的学习与练习，我们一来明白了窗口函数的相关概念、常见窗口函数的使用以及这些窗口函数的作用与效果。也通过窗口函数与一般函数子查询作了一个简单的对比，体现了窗口函数在一些特定需求的强大。那么既然窗口函数如此强大，那么窗口函数的性能对比传统函数、传统子查询与分组的性能相比如何呢？</p> 
<p>窗口函数的性能和其它SQL语句一样，受数据量大小、分区复杂度情况等影响。同等数量级的一般情况下：</p> 
<ul><li>窗口函数本身内嵌分组，相当于把条件先筛了一遍，可减少部分子查询。减少的子查询部分相当于降低了子查询本身的连接消耗。</li><li>窗口函数窗口大小限制，可减少部分行数结果返回消耗。</li><li>窗口函数可用于子查询，简化部分语句。但又因为用在了子查询，还是有一定连接开销。</li><li>窗口聚合函数在窗口函数原有分区、排序的基础上增加了聚合，且因不会影响行数的关系，比原有分组行数要多，其开销比一般聚合函数开销要大一些，因此窗口聚合函数一般情况下会比普通聚合函数性能差一些。</li></ul> 
<p>当然，上述只是理论上的性能初步分析，实际还得视具体的情况而定。<br> 至于窗口函数优化方案，可以以影响窗口函数性能的原因为切入点由因到果进行优化，例如缩小窗口大小限制。篇幅有限，不作详解。详情可参考文末推荐的优秀参考文章。</p> 
<h2><a id="2_LeetCode__193"></a>2. LeetCode 例题</h2> 
<p>上一小节，我们学习了 SQL 窗口函数的概念，从本小节开始，就是做题练习与实战了！</p> 
<p>接下来要列举例题，是 @CaptinKoo 两个月前教我们窗口函数时提供的练习题。让我们跟随 @CaptinKoo 老师的脚步，进行窗口函数练习吧！</p> 
<h3><a id="21_LeetCode_SQL_178_198"></a>2.1 LeetCode SQL 178：分数排名</h3> 
<p><strong>题目链接</strong><br> <a href="https://leetcode.cn/problems/rank-scores/" rel="nofollow">LeetCode-SQL178分数排名链接</a></p> 
<p><strong>题目描述</strong><br> <img src="https://images2.imgbox.com/0e/50/SgMNbnfM_o.png" alt="05"></p> 
<p><img src="https://images2.imgbox.com/38/db/GB95BO5B_o.png" alt="06"></p> 
<p><strong>题解</strong><br> 根据题目描述，我们得知，返回结果序号可重复，连续，因此我们使用DENSE_RANK()函数。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
    score<span class="token punctuation">,</span>
    DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>rank<span class="token punctuation">`</span></span>
<span class="token keyword">FROM</span> Scores 
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> score <span class="token keyword">DESC</span>
</code></pre> 
<h3><a id="22_LeetCode_SQL_184_220"></a>2.2 LeetCode SQL 184：最高工资</h3> 
<p><strong>题目链接</strong><br> <a href="https://leetcode.cn/problems/department-highest-salary/" rel="nofollow">LeetCode-SQL184部门工资最高的员工</a></p> 
<p><strong>题目描述</strong></p> 
<p><img src="https://images2.imgbox.com/77/8f/JCz9pq1P_o.png" alt="07"><br> <img src="https://images2.imgbox.com/7a/c2/Y6NftAk3_o.png" alt="08"></p> 
<p><strong>题解</strong><br> 根据描述，我们可以通过 RANK 窗口函数对 Employee 表进行排序，获取 rank 值为1 的 员工并关联到部门表。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
    d<span class="token punctuation">.</span>name <span class="token keyword">AS</span> Department<span class="token punctuation">,</span>
    e<span class="token punctuation">.</span>name <span class="token keyword">AS</span> Employee<span class="token punctuation">,</span>
    e<span class="token punctuation">.</span>salary <span class="token keyword">AS</span> Salary
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> 
    name<span class="token punctuation">,</span> 
    salary<span class="token punctuation">,</span>
    departmentId<span class="token punctuation">,</span> 
    RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> departmentId <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>rank<span class="token punctuation">`</span></span>
    <span class="token keyword">FROM</span> Employee
<span class="token punctuation">)</span> e 
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> Department d 
    <span class="token keyword">ON</span> e<span class="token punctuation">.</span>departmentId <span class="token operator">=</span> d<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>rank<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<h3><a id="23_LeetCode_SQL_185_253"></a>2.3 LeetCode SQL 185：前三工资</h3> 
<p><strong>题目链接</strong><br> <a href="https://leetcode.cn/problems/department-top-three-salaries/" rel="nofollow">LeetCode-SQL185部门工资前三高的所有员工</a></p> 
<p><strong>题目描述</strong></p> 
<p><img src="https://images2.imgbox.com/f2/97/8nRgdDXK_o.png" alt="03"></p> 
<p><img src="https://images2.imgbox.com/ee/96/d2ia82Q1_o.png" alt="04"></p> 
<p><strong>题解</strong><br> 有了上面两道题的解题练习，这道题也迎刃而解：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> 
    d<span class="token punctuation">.</span>name <span class="token keyword">AS</span> Department<span class="token punctuation">,</span>
    e<span class="token punctuation">.</span>name <span class="token keyword">AS</span> Employee<span class="token punctuation">,</span>
    e<span class="token punctuation">.</span>salary <span class="token keyword">AS</span> Salary
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> 
    name<span class="token punctuation">,</span> 
    salary<span class="token punctuation">,</span>
    departmentId<span class="token punctuation">,</span> 
    DENSE_RANK<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> departmentId <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary <span class="token keyword">DESC</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token identifier"><span class="token punctuation">`</span>rank<span class="token punctuation">`</span></span>
    <span class="token keyword">FROM</span> Employee
<span class="token punctuation">)</span> e 
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> Department d 
    <span class="token keyword">ON</span> e<span class="token punctuation">.</span>departmentId <span class="token operator">=</span> d<span class="token punctuation">.</span>id
<span class="token keyword">WHERE</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>rank<span class="token punctuation">`</span></span> <span class="token operator">&lt;=</span> <span class="token number">3</span>
</code></pre> 
<p>太棒了！我们一下就完成了三道包括中等、困难难度的LeetCode题目，接下来，我们可以将我们学习并练习过的知识点用于项目实战了！</p> 
<h2><a id="3__287"></a>3. 项目实战</h2> 
<p>本小节是我个人用窗口函数解决实际工作问题的实战记录。涉及的表、字段均已做描述更换，脱敏处理。</p> 
<h3><a id="31__291"></a>3.1 需求描述</h3> 
<p>已知用户订单评价表<code>order_evaluate</code>有如下字段：</p> 
<table><thead><tr><th>字段名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>id</td><td>bigint</td><td>评价表主键id</td></tr><tr><td>evaluate</td><td>text</td><td>评价内容</td></tr><tr><td>user_id</td><td>bigint</td><td>用户id</td></tr><tr><td>update_time</td><td>datetime</td><td>更新时间</td></tr><tr><td>order_id</td><td>bigint</td><td>订单id</td></tr></tbody></table> 
<p>其中，每个订单可以有多个评价，每个评价都可以修改。业务需要，需要获取当前用户所有订单最近一次评价内容，并返回订单id、最近一次评价的内容。</p> 
<h3><a id="32_SQL__305"></a>3.2 SQL 实战</h3> 
<p>此次实战业务需要根据<code>update_time</code>获取最近一次评论并根据<code>order_id</code>进行分组。</p> 
<p>在尚未系统学习窗口函数时，我们第一时间会想到的是传统子查询。</p> 
<p>但毕竟实际业务远比这里的脱敏描述要复杂，一时间难以实现，于是我第一时间回顾了@CaptinKoo大佬教我的窗口函数并解决：</p> 
<pre><code class="prism language-sql"><span class="token comment"># 毕竟是Demo，忽略 user_id 条件，实际业务会补充齐全其它条件</span>
<span class="token keyword">SELECT</span>
	t1<span class="token punctuation">.</span>order_id<span class="token punctuation">,</span>
	evaluate
<span class="token keyword">FROM</span>
	order_evaluate t1
	<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span> 
		<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> 
		order_id<span class="token punctuation">,</span> 
		ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span> <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> order_id <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> update_time <span class="token keyword">DESC</span> <span class="token punctuation">)</span> <span class="token keyword">AS</span> row_num <span class="token keyword">FROM</span> order_evaluate<span class="token punctuation">)</span> t2 <span class="token keyword">ON</span> t1<span class="token punctuation">.</span>id <span class="token operator">=</span> t2<span class="token punctuation">.</span>id 
<span class="token keyword">WHERE</span>
	t2<span class="token punctuation">.</span>row_num <span class="token operator">=</span> <span class="token number">1</span>
</code></pre> 
<p>这条SQL是通过ROW_NUM()函数将工单评价表根据工单分组，更新时间倒序并给它一个行序号。行序号1的就是我们要求的结果。</p> 
<p>你能想到用传统子查询实现相同功能的SQL吗？</p> 
<h2><a id="4__332"></a>4. 补充与总结</h2> 
<h3><a id="41_ROWS_BETWEEN_334"></a>4.1 <code>ROWS BETWEEN</code>子句常见关键字含义</h3> 
<p><strong>关键字及其含义表</strong></p> 
<table><thead><tr><th>关键字</th><th>含义</th></tr></thead><tbody><tr><td>PRECEDING</td><td>当前行数往前</td></tr><tr><td>FOLLOWING</td><td>当前行数往后</td></tr><tr><td>CURRENT ROW</td><td>当前行</td></tr><tr><td>UNBOUNDED</td><td>起点（一般结合PRECEDING，FOLLOWING使用）</td></tr><tr><td>UNBOUNDED PRECEDING</td><td>表示该窗口最前面的行（起点）</td></tr><tr><td>UNBOUNDED FOLLOWING</td><td>表示该窗口最后面的行（终点）</td></tr></tbody></table> 
<p><em>此表的知识内容来自于参考文章</em></p> 
<p>根据这个关键字含义表，读者可以理解文初提到的例子了吗？</p> 
<p><strong>可选挑战题目</strong><br> 这里提供一题可选的挑战题目链接，是LeetCode困难题目，依然来自@CaptinKoo大佬的推荐，此题的一种解法用到<code>ROWS BETWEEN</code>子句。</p> 
<p><a href="https://leetcode.cn/problems/human-traffic-of-stadium/" rel="nofollow">LeetCode-601体育馆的人流量</a></p> 
<h3><a id="42__356"></a>4.2 如何理解窗口函数的“窗口”？</h3> 
<p>既然这种函数叫"窗口函数"，那么它应该可以像"窗口"一样，通过滚动的方式，获取一定范围内的视图。</p> 
<p>而滚动的方式恰恰就是<code>ROWS BETWEEN</code>子句。通过<code>ROWS BETWEEN</code>子句，获取窗口函数结果的范围，从而有给用户"窗口"的感觉。</p> 
<p>用术语表达，则是：通过定义帧，决定窗口的大小。<br> 窗口函数定义帧通常有两种方式：<code>RANGE</code>和<code>ROWS</code>, 两者决定窗口帧的边界如何计算。</p> 
<ul><li>RANGE 基于排序列的值定义帧</li><li>ROWS 基于行数定义帧，不考虑排序列</li></ul> 
<p>由于两者用法相似，且一般<code>ROWS BETWEEN</code> 子句会用得多一些，因此本文的语法概述忽略了<code>RANGE</code>子句。此处作为补充，供读者参考。</p> 
<h3><a id="43__370"></a>4.3 总结</h3> 
<p>本文借由好兄弟@CaptinKoo两个月前教过我的窗口函数知识，截至发文日期顺利解决一个相对比较复杂的业务的故事，记录我从CaptinKoo学到的窗口函数相关知识，以及CaptinKoo大佬推荐的相关习题，以及我个人本次实战的脱敏描述。</p> 
<p>通过本文，我们学习到了：</p> 
<ul><li>Mysql 窗口函数相关概念：其中，语法结构是重点；</li><li>常见窗口函数：聚合窗口函数、专用窗口函数（排序函数、分布函数等）</li><li>相关习题与练习</li><li>一个实际的练习供大佬们参考</li><li>窗口函数“窗口”的体现，<code>ROWS BETWEEN</code>子句相关补充知识点</li></ul> 
<h2><a id="_380"></a>参考资料</h2> 
<ul><li><a href="https://zhuanlan.zhihu.com/p/629460362" rel="nofollow">知乎-窗口函数优秀参考文章1</a></li><li><a href="https://zhuanlan.zhihu.com/p/637159855" rel="nofollow">知乎-窗口函数优秀参考文章2</a></li><li><a href="https://blog.csdn.net/weixin_44852067/article/details/119570082">CSDN-窗口函数优秀参考文章1</a></li><li><a href="https://blog.csdn.net/be_racle/article/details/125181320">CSDN-窗口函数优秀参考文章2</a></li></ul> 
<p>再次感谢@CaptinKoo的指导！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/10db253c81ea390b738363e8b0f84c21/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Hadoop3.x完全分布式模式下slaveDataNode节点未启动调整</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c1d8eaa80b86be47e19e81a88e52d516/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python中的定时器用法：Timer定时器和schedule库</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>