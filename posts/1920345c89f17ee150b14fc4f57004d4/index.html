<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenCV 入门（六） —— Android 下的人脸识别 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/1920345c89f17ee150b14fc4f57004d4/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="OpenCV 入门（六） —— Android 下的人脸识别">
  <meta property="og:description" content="OpenCV 入门系列：
OpenCV 入门（一）—— OpenCV 基础
OpenCV 入门（二）—— 车牌定位
OpenCV 入门（三）—— 车牌筛选
OpenCV 入门（四）—— 车牌号识别
OpenCV 入门（五）—— 人脸识别模型训练与 Windows 下的人脸识别
OpenCV 入门（六）—— Android 下的人脸识别
OpenCV 入门（七）—— 身份证识别
本篇我们来介绍在 Android 下如何实现人脸识别。
上一篇我们介绍了如何在 Windows 下通过 OpenCV 实现人脸识别，实际上，在 Android 下的实现的核心原理是非常相似的，因为 OpenCV 部分的代码改动不大，绝大部分代码可以直接移植到 Android 上。最主要的区别是，Android 摄像头采集图像的代码要复杂一些，而 Windows 下几行代码就搞定了。
目前有四种方式来使用 Android Camera：
Camera1：虽然被 @Deprecated 了，但是很多产品中仍然在使用它，比如一些推流 SDKCamera2：比 Camera1 更灵活，可定制性更强，但是用起来有些麻烦CameraX：Jetpack 组件，封装了 Camera2，通过提供一致且易用的 API 接口来简化相机应用的开发工作NDKCamera：无法兼容低版本 我们会介绍 Camera1 和 CameraX 两种方式。
1、使用 Camera1 进行人脸识别 1.1 开启摄像头 我们将 Camera1 的相关操作封装到 CameraHelper 中：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-06T16:50:22+08:00">
    <meta property="article:modified_time" content="2024-05-06T16:50:22+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenCV 入门（六） —— Android 下的人脸识别</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>OpenCV 入门系列：</p> 
<blockquote> 
 <p><a href="https://blog.csdn.net/tmacfrank/article/details/138391492">OpenCV 入门（一）—— OpenCV 基础</a><br> <a href="https://blog.csdn.net/tmacfrank/article/details/138391552">OpenCV 入门（二）—— 车牌定位</a><br> <a href="https://blog.csdn.net/tmacfrank/article/details/138412701">OpenCV 入门（三）—— 车牌筛选</a><br> <a href="https://blog.csdn.net/tmacfrank/article/details/138413284">OpenCV 入门（四）—— 车牌号识别</a><br> <a href="https://blog.csdn.net/tmacfrank/article/details/138438648">OpenCV 入门（五）—— 人脸识别模型训练与 Windows 下的人脸识别</a><br> <a href="https://blog.csdn.net/tmacfrank/article/details/138452707">OpenCV 入门（六）—— Android 下的人脸识别</a><br> <a href="https://blog.csdn.net/tmacfrank/article/details/138499399">OpenCV 入门（七）—— 身份证识别</a></p> 
</blockquote> 
<p>本篇我们来介绍在 Android 下如何实现人脸识别。</p> 
<p>上一篇我们介绍了如何在 Windows 下通过 OpenCV 实现人脸识别，实际上，在 Android 下的实现的核心原理是非常相似的，因为 OpenCV 部分的代码改动不大，绝大部分代码可以直接移植到 Android 上。最主要的区别是，Android 摄像头采集图像的代码要复杂一些，而 Windows 下几行代码就搞定了。</p> 
<p>目前有四种方式来使用 Android Camera：</p> 
<ul><li>Camera1：虽然被 @Deprecated 了，但是很多产品中仍然在使用它，比如一些推流 SDK</li><li>Camera2：比 Camera1 更灵活，可定制性更强，但是用起来有些麻烦</li><li>CameraX：Jetpack 组件，封装了 Camera2，通过提供一致且易用的 API 接口来简化相机应用的开发工作</li><li>NDKCamera：无法兼容低版本</li></ul> 
<p>我们会介绍 Camera1 和 CameraX 两种方式。</p> 
<h2><a id="1_Camera1__22"></a>1、使用 Camera1 进行人脸识别</h2> 
<h3><a id="11__26"></a>1.1 开启摄像头</h3> 
<p>我们将 Camera1 的相关操作封装到 CameraHelper 中：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">CameraHelper</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mCameraId<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mHeight<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mWidth<span class="token operator">:</span> Int
<span class="token punctuation">)</span> <span class="token operator">:</span> Camera<span class="token punctuation">.</span><span class="token function">PreviewCallback</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> mCamera<span class="token operator">:</span> Camera<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mBuffer<span class="token operator">:</span> ByteArray
    <span class="token keyword">private</span> <span class="token keyword">var</span> mPreviewCallback<span class="token operator">:</span> Camera<span class="token punctuation">.</span>PreviewCallback<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">fun</span> <span class="token function">startPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 开启摄像头，获取 Camera 对象</span>
        mCamera <span class="token operator">=</span> Camera<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>mCameraId<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mCamera <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"Open camera failed."</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 配置 Camera 参数</span>
        <span class="token keyword">val</span> cameraParams <span class="token operator">=</span> mCamera<span class="token operator">?</span><span class="token punctuation">.</span>parameters
        <span class="token comment">// 设置预览数据格式为 NV21</span>
        cameraParams<span class="token operator">?</span><span class="token punctuation">.</span>previewFormat <span class="token operator">=</span> ImageFormat<span class="token punctuation">.</span>NV21
        <span class="token comment">// 设置摄像头宽高</span>
        cameraParams<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">setPreviewSize</span><span class="token punctuation">(</span>mWidth<span class="token punctuation">,</span>mHeight<span class="token punctuation">)</span>
        <span class="token comment">// 更新 Camera 参数</span>
        mCamera<span class="token operator">?</span><span class="token punctuation">.</span>parameters <span class="token operator">=</span> cameraParams
        <span class="token comment">// 摄像头采集的是 YUV NV21 格式的数据，mBuffer 承载预览数据</span>
        mBuffer <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span>mWidth <span class="token operator">*</span> mHeight <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token comment">// 设置预览的回调以及缓冲区</span>
        <span class="token comment">// 将摄像头获取的数据放入 mBuffer</span>
        mCamera<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addCallbackBuffer</span><span class="token punctuation">(</span>mBuffer<span class="token punctuation">)</span>
        mCamera<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">setPreviewCallbackWithBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token comment">// 设置预览画面</span>
        mCamera<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">setPreviewTexture</span><span class="token punctuation">(</span><span class="token function">SurfaceTexture</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        mCamera<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">startPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">stopPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mCamera<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">setPreviewCallback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        mCamera<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">stopPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mCamera<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mCamera <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onPreviewFrame</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">:</span> ByteArray<span class="token operator">?</span><span class="token punctuation">,</span> camera<span class="token operator">:</span> Camera<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"onPreviewFrame: data 为空，直接返回"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 注意回调给外界的图像是横向的</span>
        mPreviewCallback<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onPreviewFrame</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">,</span> camera<span class="token punctuation">)</span>
        mCamera<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addCallbackBuffer</span><span class="token punctuation">(</span>mBuffer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">switchCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 切换摄像头 ID 再重启预览</span>
        mCameraId <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mCameraId <span class="token operator">==</span> Camera<span class="token punctuation">.</span>CameraInfo<span class="token punctuation">.</span>CAMERA_FACING_FRONT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Camera<span class="token punctuation">.</span>CameraInfo<span class="token punctuation">.</span>CAMERA_FACING_BACK
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            Camera<span class="token punctuation">.</span>CameraInfo<span class="token punctuation">.</span>CAMERA_FACING_FRONT
        <span class="token punctuation">}</span>
        <span class="token function">stopPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">startPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setPreviewCallback</span><span class="token punctuation">(</span>previewCallback<span class="token operator">:</span> Camera<span class="token punctuation">.</span>PreviewCallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mPreviewCallback <span class="token operator">=</span> previewCallback
    <span class="token punctuation">}</span>
	<span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>需要特别注意 startPreview() 内设置预览画面要设置给 SurfaceTexture 而不是 SurfaceHolder。因为 SurfaceHolder 是会对 SurfaceView.SurfaceHolder.getSurface() 获取到的 Surface 对象的生命周期和渲染进行直接管理的，这就导致我们在 Native 层获取由该 Surface 创建的 ANativeWindow 的锁，即调用 ANativeWindow_lock() 会一直失败，进而无法渲染。</p> 
<p>由于我们需要在 Native 层将 OpenCV 识别的人脸范围用矩形框画出来，所以预览就交给 SurfaceTexture。</p> 
<p>接下来由 Activity 控制 CameraHelper 开启预览：</p> 
<pre><code class="prism language-kotlin">	<span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mOpenCVJNI<span class="token operator">:</span> OpenCVJNI
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mCameraHelper<span class="token operator">:</span> CameraHelper
    <span class="token keyword">private</span> <span class="token keyword">var</span> mCameraId <span class="token operator">=</span> Camera<span class="token punctuation">.</span>CameraInfo<span class="token punctuation">.</span>CAMERA_FACING_FRONT

	<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>

        <span class="token keyword">val</span> binding <span class="token operator">=</span> ActivityMainBinding<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>layoutInflater<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>root<span class="token punctuation">)</span>

        binding<span class="token punctuation">.</span>surfaceView<span class="token punctuation">.</span>holder<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        binding<span class="token punctuation">.</span>btnSwitchCamera<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
            mCameraHelper<span class="token punctuation">.</span><span class="token function">switchCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            mCameraId <span class="token operator">=</span> mCameraHelper<span class="token punctuation">.</span><span class="token function">getCameraId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        mOpenCVJNI <span class="token operator">=</span> <span class="token function">OpenCVJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mCameraHelper <span class="token operator">=</span> <span class="token function">CameraHelper</span><span class="token punctuation">(</span>mCameraId<span class="token punctuation">,</span> <span class="token number">480</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span>
        mCameraHelper<span class="token punctuation">.</span><span class="token function">setPreviewCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>

        <span class="token comment">// 将 assets 下的 lbpcascade_frontalface.xml 拷贝到手机同名文件中</span>
        Utils<span class="token punctuation">.</span><span class="token function">copyAssets</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"lbpcascade_frontalface.xml"</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 开启摄像头预览</span>
        mCameraHelper<span class="token punctuation">.</span><span class="token function">startPreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 初始化 OpenCV</span>
        <span class="token keyword">val</span> path <span class="token operator">=</span> <span class="token function">File</span><span class="token punctuation">(</span>
            Environment<span class="token punctuation">.</span><span class="token function">getExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string-literal singleline"><span class="token string">"lbpcascade_frontalface.xml"</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>absolutePath
        mOpenCVJNI<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这样我们就可以在页面中看到摄像头采集到的预览画面了。</p> 
<h3><a id="12__152"></a>1.2 其余初始化工作</h3> 
<p>开启摄像头的代码中，有涉及到创建以及初始化 OpenCVJNI 对象，该对象就是上层与 Native 层 OpenCV API 交互的桥梁：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> OpenCVJNI <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">fun</span> <span class="token keyword">init</span><span class="token punctuation">(</span>path<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">nativeInit</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">postData</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">:</span> ByteArray<span class="token punctuation">,</span> width<span class="token operator">:</span> Int<span class="token punctuation">,</span> height<span class="token operator">:</span> Int<span class="token punctuation">,</span> cameraId<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">nativePostData</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> cameraId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setSurface</span><span class="token punctuation">(</span>surface<span class="token operator">:</span> Surface<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">nativeSetSurface</span><span class="token punctuation">(</span>surface<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">nativeInit</span><span class="token punctuation">(</span>path<span class="token operator">:</span> String<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">nativePostData</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">:</span> ByteArray<span class="token punctuation">,</span> width<span class="token operator">:</span> Int<span class="token punctuation">,</span> height<span class="token operator">:</span> Int<span class="token punctuation">,</span> cameraId<span class="token operator">:</span> Int<span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">nativeSetSurface</span><span class="token punctuation">(</span>surface<span class="token operator">:</span> Surface<span class="token punctuation">)</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">init</span> <span class="token punctuation">{<!-- --></span>
            System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"opencv"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于 Windows Demo 中我们使用的是 HAAR 级联分类器，所以 Android Demo 我们换一个，使用 LBP 级联分类器。将 OpenCV-android-sdk\sdk\etc\lbpcascades\lbpcascade_frontalface.xml 拷贝到项目的 /src/main/assets/ 目录下。并通过 copyAssets() 将文件拷贝到手机中：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> Utils <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">/**
         * 将 assets 目录下的文件 path 的内容复制到手机的 path 文件中
         */</span>
        <span class="token keyword">fun</span> <span class="token function">copyAssets</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> path<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> file <span class="token operator">=</span> <span class="token function">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getExternalStorageDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">var</span> fileOutputStream<span class="token operator">:</span> FileOutputStream<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
            <span class="token keyword">var</span> inputStream<span class="token operator">:</span> InputStream<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                fileOutputStream <span class="token operator">=</span> <span class="token function">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
                inputStream <span class="token operator">=</span> context<span class="token punctuation">.</span>assets<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>

                <span class="token keyword">val</span> buffer <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>
                <span class="token keyword">var</span> length <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    fileOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span>
                    length <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                fileOutputStream<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                inputStream<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上层代码基本就这样了，接下来就是看上层如何调用 OpenCV 的 Native API 实现人脸识别了。</p> 
<h3><a id="13_Native__226"></a>1.3 Native 层实现</h3> 
<p>Native 层实现主要包括三方面：</p> 
<ol><li>OpenCV 的初始化</li><li>负责底层绘制的 ANativeWindow 初始化</li><li>接收上层传递的图像数据进行识别</li></ol> 
<p>OpenCV 的初始化是通过 OpenCVJNI 的 init() 调用 Native 方法 nativeInit() 实现的：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/opencv.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;android/native_window_jni.h&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

DetectionBasedTracker <span class="token operator">*</span>tracker <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CascadeDetectorAdapter</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> DetectionBasedTracker<span class="token double-colon punctuation">::</span><span class="token class-name">IDetector</span></span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CascadeDetectorAdapter</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span>Ptr<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CascadeClassifier<span class="token operator">&gt;</span> detector<span class="token punctuation">)</span> <span class="token operator">:</span>
            <span class="token function">IDetector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">Detector</span><span class="token punctuation">(</span>detector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检测人脸的函数，Mat 相当于 Android 的一张 Bitmap。一张图片有几个人脸就会调用本方法几次</span>
    <span class="token keyword">void</span> <span class="token function">detect</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat <span class="token operator">&amp;</span>Image<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Rect<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>objects<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Detector<span class="token operator">-&gt;</span><span class="token function">detectMultiScale</span><span class="token punctuation">(</span>Image<span class="token punctuation">,</span> objects<span class="token punctuation">,</span> scaleFactor<span class="token punctuation">,</span>
                                   minNeighbours<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> minObjSize<span class="token punctuation">,</span> maxObjSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">CascadeDetectorAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token function">CascadeDetectorAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cv<span class="token double-colon punctuation">::</span>Ptr<span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>CascadeClassifier<span class="token operator">&gt;</span> Detector<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">Java_com_face_recognition1_OpenCVJNI_nativeInit</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jstring path_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>path_<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建检测器</span>
    Ptr<span class="token operator">&lt;</span>CascadeClassifier<span class="token operator">&gt;</span> detectorClassifier <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>CascadeClassifier<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>CascadeDetectorAdapter<span class="token operator">&gt;</span> mainDetector <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>CascadeDetectorAdapter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>detectorClassifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建跟踪器</span>
    Ptr<span class="token operator">&lt;</span>CascadeClassifier<span class="token operator">&gt;</span> trackerClassifier <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>CascadeClassifier<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>CascadeDetectorAdapter<span class="token operator">&gt;</span> trackingDetector <span class="token operator">=</span> <span class="token generic-function"><span class="token function">makePtr</span><span class="token generic class-name"><span class="token operator">&lt;</span>CascadeDetectorAdapter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
            trackerClassifier<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建 DetectionBasedTracker</span>
    DetectionBasedTracker<span class="token double-colon punctuation">::</span>Parameters detectionParams<span class="token punctuation">;</span>
    tracker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">DetectionBasedTracker</span><span class="token punctuation">(</span>mainDetector<span class="token punctuation">,</span> trackingDetector<span class="token punctuation">,</span> detectionParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// run() 会开启维护死循环的线程，当开启摄像头预览调用 tracker-&gt;process() </span>
    <span class="token comment">// 传入人脸数据时，线程会返回一个包含人脸结构的 face 集合给你</span>
    tracker<span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    env<span class="token operator">-&gt;</span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>path_<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>与 Windows 几乎相同，创建 DetectionBasedTracker 需要主检测器 mainDetector 和跟踪器 trackingDetector，创建两个适配器所需的 CascadeDetectorAdapter 还是来自 OpenCV 的官方 Sample 代码。</p> 
<p>然后是底层绘制窗口 ANativeWindow 的初始化。它的初始化由 Activity 的 SurfaceView 的创建/变化触发：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Camera<span class="token punctuation">.</span>PreviewCallback<span class="token punctuation">,</span> SurfaceHolder<span class="token punctuation">.</span><span class="token function">Callback</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// SurfaceHolder.Callback start</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">surfaceCreated</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> SurfaceHolder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">surfaceChanged</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> SurfaceHolder<span class="token punctuation">,</span> format<span class="token operator">:</span> Int<span class="token punctuation">,</span> width<span class="token operator">:</span> Int<span class="token punctuation">,</span> height<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mOpenCVJNI<span class="token punctuation">.</span><span class="token function">setSurface</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span>surface<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">surfaceDestroyed</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> SurfaceHolder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token comment">// SurfaceHolder.Callback end</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>进入到 Native 层，需要先释放原有的 ANativeWindow 对象重新分配：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">Java_com_face_recognition1_OpenCVJNI_nativeSetSurface</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jobject surface<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ANativeWindow_release</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
        window <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    window <span class="token operator">=</span> <span class="token function">ANativeWindow_fromSurface</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后就是通过 ANativeWindow 绘制了，绘制的数据来自于上层 Camera 的回调数据：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Camera<span class="token punctuation">.</span>PreviewCallback<span class="token punctuation">,</span> SurfaceHolder<span class="token punctuation">.</span><span class="token function">Callback</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onPreviewFrame</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token operator">:</span> ByteArray<span class="token operator">?</span><span class="token punctuation">,</span> camera<span class="token operator">:</span> Camera<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">data</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        mOpenCVJNI<span class="token punctuation">.</span><span class="token function">postData</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">,</span> mCameraHelper<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mCameraHelper<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mCameraId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Native 层拿到 data 先用 OpenCV 进行人脸识别，在识别出来的人脸区域画一个矩形：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/**
 * 中间过程可以通过 imwrite(String,Mat) 将 Mat 图片输出到手机
 * 指定路径查看中间效果以验证编程是否正确
 */</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">Java_com_face_recognition1_OpenCVJNI_nativePostData</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jbyteArray data_<span class="token punctuation">,</span>
                                                    jint width<span class="token punctuation">,</span> jint height<span class="token punctuation">,</span> jint camera_id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    jbyte <span class="token operator">*</span>data <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetByteArrayElements</span><span class="token punctuation">(</span>data_<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建一个 Mat 对象，Mat 相当于一张 Bitmap，由于传入的是 YUV 数据，因此高度是像素高度的 3/2</span>
    Mat <span class="token function">src</span><span class="token punctuation">(</span>height <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> CV_8UC1<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 src 内的 NV21 数据转换为 RGBA 数据后再赋值给 src</span>
    <span class="token function">cvtColor</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src<span class="token punctuation">,</span> COLOR_YUV2RGBA_NV21<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对原始摄像头图像进行旋转调正</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>camera_id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 前置摄像头需要逆时针旋转 90°</span>
        <span class="token function">rotate</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src<span class="token punctuation">,</span> ROTATE_90_COUNTERCLOCKWISE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 前置还需要取一个水平方向的镜像，如果传 0 就是竖直方向</span>
        <span class="token function">flip</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 后置摄像头需要顺时针旋转 90°</span>
        <span class="token function">rotate</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src<span class="token punctuation">,</span> ROTATE_90_CLOCKWISE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 图片调整后开始进行识别，首先要将图片转换为灰度图，可以减少杂色增加识别几率</span>
    Mat gray<span class="token punctuation">;</span>
    <span class="token function">cvtColor</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> gray<span class="token punctuation">,</span> COLOR_RGBA2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 增强对比度，目的是增强轮廓（因为识别是对轮廓进行识别）</span>
    <span class="token function">equalizeHist</span><span class="token punctuation">(</span>gray<span class="token punctuation">,</span> gray<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测人脸，结果保存到 faces 中</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> faces<span class="token punctuation">;</span>
    tracker<span class="token operator">-&gt;</span><span class="token function">process</span><span class="token punctuation">(</span>gray<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tracker<span class="token operator">-&gt;</span><span class="token function">getObjects</span><span class="token punctuation">(</span>faces<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历检测到的人脸（一张图片内可能有多个人脸）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Rect <span class="token operator">&amp;</span>face<span class="token operator">:</span> faces<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 画个方框</span>
        <span class="token function">rectangle</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> face<span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果需要获取训练素材，就将人脸图像转换成 24 * 24 的灰度图保存到手机指定目录中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>needTraining<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 拷贝人脸数据（获取正样本）</span>
            Mat m<span class="token punctuation">;</span>
            <span class="token function">src</span><span class="token punctuation">(</span>face<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将大小调整为 24x24 的，并且设置为灰度图，然后拷贝到手机的指定目录下</span>
            <span class="token function">resize</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">cvtColor</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m<span class="token punctuation">,</span> COLOR_BGR2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> p<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">// 注意如果路径不存在需要手动先创建文件夹，否则不会自动生成目录</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">"/storage/emulated/0/FaceTest/%d.jpg"</span><span class="token punctuation">,</span> index<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">imwrite</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ANativeWindow_setBuffersGeometry</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> src<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> src<span class="token punctuation">.</span>rows<span class="token punctuation">,</span> WINDOW_FORMAT_RGBA_8888<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ANativeWindow_Buffer window_buffer<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果上锁失败就直接 break</span>
            <span class="token comment">// 起初一直上锁失败，原因是 CameraHelper 中使用 SurfaceHolder 进行预览而不是 SurfaceTexture</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ANativeWindow_lock</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token operator">&amp;</span>window_buffer<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">ANativeWindow_release</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
                window <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 画图，将 Mat 的 data 指针指向的像素数据逐行拷贝到 window_buffer.bits 中</span>
            <span class="token keyword">auto</span> dst_data <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>window_buffer<span class="token punctuation">.</span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> dst_line_size <span class="token operator">=</span> window_buffer<span class="token punctuation">.</span>stride <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> window_buffer<span class="token punctuation">.</span>height<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Mat 内的数据是 RGBA，因此计算每行首地址时，要在后面乘以 4，表示 RGBA8888 各占 1 个字节</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>dst_data <span class="token operator">+</span> i <span class="token operator">*</span> dst_line_size<span class="token punctuation">,</span> src<span class="token punctuation">.</span>data <span class="token operator">+</span> i <span class="token operator">*</span> src<span class="token punctuation">.</span>cols <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> dst_line_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 提交刷新</span>
            <span class="token function">ANativeWindow_unlockAndPost</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    src<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gray<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    env<span class="token operator">-&gt;</span><span class="token function">ReleaseByteArrayElements</span><span class="token punctuation">(</span>data_<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主要步骤，包括获取人脸训练素材的步骤都与 Windows 基本一致，区别在于 Android 需要将摄像头采集的图像旋转 90° 调正，并且需要将图像数据拷贝到 ANativeWindow 的缓冲区以实现图像渲染。</p> 
<p>使用 Android 后置摄像头进行人脸识别的效果如下：</p> 
<p><img src="https://images2.imgbox.com/10/21/V8gRdFwD_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="2_CameraX__437"></a>2、使用 CameraX 进行人脸识别</h2> 
<h3><a id="21__441"></a>2.1 初始化</h3> 
<p>首先引入 CameraX 的依赖，完整的引入内容如下，但是本 Demo 只用到了 core、camera2 和 lifecycle 三项：</p> 
<pre><code class="prism language-groovy">dependencies <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> camerax_version <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">"1.0.0"</span></span>
  <span class="token comment">// The following line is optional, as the core library is included indirectly by camera-camera2</span>
  implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-core:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
  implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-camera2:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
  <span class="token comment">// If you want to additionally use the CameraX Lifecycle library</span>
  implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-lifecycle:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
  <span class="token comment">// If you want to additionally use the CameraX View class</span>
  implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-view:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
  <span class="token comment">// If you want to additionally use the CameraX Extensions library</span>
  implementation <span class="token interpolation-string"><span class="token string">"androidx.camera:camera-extensions:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">camerax_version</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于 CameraX 已经对 Camera2 进行了封装，因此我们可以直接使用，而无需像前面的例子那样自己封装一个 CameraHelper 了。</p> 
<p>首先我们在 Activity 的 onCreate() 中进行初始化工作：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> RecognitionActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SurfaceHolder<span class="token punctuation">.</span>Callback<span class="token punctuation">,</span> ImageAnalysis<span class="token punctuation">.</span><span class="token function">Analyzer</span> <span class="token punctuation">{<!-- --></span>
    
	<span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mCameraProviderFuture<span class="token operator">:</span> ListenableFuture<span class="token operator">&lt;</span>ProcessCameraProvider<span class="token operator">&gt;</span>
    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> mFaceTracker<span class="token operator">:</span> FaceTracker

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>

        <span class="token keyword">val</span> binding <span class="token operator">=</span> ActivityRecognitionBinding<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>layoutInflater<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>binding<span class="token punctuation">.</span>root<span class="token punctuation">)</span>

        <span class="token comment">// 权限申请</span>
        ActivityCompat<span class="token punctuation">.</span><span class="token function">requestPermissions</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span>
            <span class="token function">arrayOf</span><span class="token punctuation">(</span>Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>CAMERA<span class="token punctuation">,</span> Manifest<span class="token punctuation">.</span>permission<span class="token punctuation">.</span>WRITE_EXTERNAL_STORAGE<span class="token punctuation">)</span><span class="token punctuation">,</span>
            REQUEST_CODE
        <span class="token punctuation">)</span>

        <span class="token comment">// 为 SurfaceHolder 设置回调接口</span>
        binding<span class="token punctuation">.</span>surfaceView<span class="token punctuation">.</span>holder<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>

        <span class="token comment">// CameraX 初始化，异步获取 CameraProvider 对象</span>
        mCameraProviderFuture <span class="token operator">=</span> ProcessCameraProvider<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        mCameraProviderFuture<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">val</span> cameraProvider <span class="token operator">=</span> mCameraProviderFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">bindAnalysis</span><span class="token punctuation">(</span>cameraProvider<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// 将识别模型拷贝到手机中</span>
        <span class="token keyword">val</span> modelPath <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">copyAsset2Dir</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"lbpcascade_frontalface.xml"</span></span><span class="token punctuation">)</span>

        <span class="token comment">// 初始化 FaceTracker 开启人脸检测</span>
        mFaceTracker <span class="token operator">=</span> <span class="token function">FaceTracker</span><span class="token punctuation">(</span>modelPath<span class="token punctuation">)</span>
        mFaceTracker<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="CameraX_509"></a>CameraX</h4> 
<p>对 CameraX 进行异步初始化，先通过 ProcessCameraProvider.getInstance() 获取到 <code>ListenableFuture&lt;ProcessCameraProvider&gt;</code>：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	* Futures.transform() 的三个参数：
	* CameraX.getOrCreateInstance() 会返回一个包含已经初始化的 CameraX 对象的 ListenableFuture
	* cameraX -&gt; {} 是一个函数，参数 cameraX 是第一个参数的泛型对象，即 CameraX
	* CameraXExecutors.directExecutor() 会返回主调线程中缓存的会直接执行任务的 Executor
	* 会在指定的 Executor 中异步执行函数
	*/</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ListenableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessCameraProvider</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInstance</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Preconditions</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Futures</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">CameraX</span><span class="token punctuation">.</span><span class="token function">getOrCreateInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span> cameraX <span class="token operator">-&gt;</span>  <span class="token punctuation">{<!-- --></span>
            sAppInstance<span class="token punctuation">.</span><span class="token function">setCameraX</span><span class="token punctuation">(</span>cameraX<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sAppInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">CameraXExecutors</span><span class="token punctuation">.</span><span class="token function">directExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>随后为 mCameraProviderFuture 设置监听，异步获取到 CameraProvider 对象，并将其与生命周期绑定：</p> 
<pre><code class="prism language-kotlin">	<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">bindAnalysis</span><span class="token punctuation">(</span>cameraProvider<span class="token operator">:</span> ProcessCameraProvider<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cameraProvider <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * 图片分析：得到摄像头图像数据
         * STRATEGY_KEEP_ONLY_LATEST:非阻塞模式，每次获得最新帧
         * STRATEGY_BLOCK_PRODUCER:阻塞模式，会得到每一张图片，处理不及时会导致帧率降低
         */</span>
        <span class="token keyword">val</span> imageAnalysis <span class="token operator">=</span> ImageAnalysis<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// CameraX 会根据传入尺寸选择最佳的预览尺寸</span>
            <span class="token punctuation">.</span><span class="token function">setTargetResolution</span><span class="token punctuation">(</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">480</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setBackpressureStrategy</span><span class="token punctuation">(</span>ImageAnalysis<span class="token punctuation">.</span>STRATEGY_KEEP_ONLY_LATEST<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 设置分析器，指定回调所发生的线程（池）</span>
        imageAnalysis<span class="token punctuation">.</span><span class="token function">setAnalyzer</span><span class="token punctuation">(</span>ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>

        <span class="token comment">// 绑定生命周期</span>
        cameraProvider<span class="token punctuation">.</span><span class="token function">unbindAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        cameraProvider<span class="token punctuation">.</span><span class="token function">bindToLifecycle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CameraSelector<span class="token punctuation">.</span>DEFAULT_FRONT_CAMERA<span class="token punctuation">,</span> imageAnalysis<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="FaceTracker_561"></a>FaceTracker</h4> 
<p>FaceTracker 是上层与 Native 交互的类：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">FaceTracker</span><span class="token punctuation">(</span>modelPath<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 实际上是将上层的 FaceTracker 与 Native 的 FaceTracker 绑定</span>
    <span class="token comment">// 上层以 Native 对象地址的形式持有 Native 对象，这样做的目的是</span>
    <span class="token comment">// 让上层持有 C++ 对象，当上层将地址传回给 Native 层时，C++ 可以</span>
    <span class="token comment">// 将地址强转回成一个 C++ 对象并操作该对象，这样能实现多对多的绑定</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> mFaceTracker <span class="token operator">=</span> <span class="token number">0L</span>

    <span class="token keyword">init</span> <span class="token punctuation">{<!-- --></span>
        mFaceTracker <span class="token operator">=</span> <span class="token function">nativeInit</span><span class="token punctuation">(</span>modelPath<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">setSurface</span><span class="token punctuation">(</span>surface<span class="token operator">:</span> Surface<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">nativeSetSurface</span><span class="token punctuation">(</span>mFaceTracker<span class="token punctuation">,</span> surface<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">detect</span><span class="token punctuation">(</span>bytes<span class="token operator">:</span> ByteArray<span class="token punctuation">,</span> width<span class="token operator">:</span> Int<span class="token punctuation">,</span> height<span class="token operator">:</span> Int<span class="token punctuation">,</span> rotationDegrees<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">nativeDetect</span><span class="token punctuation">(</span>mFaceTracker<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> rotationDegrees<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">nativeStart</span><span class="token punctuation">(</span>mFaceTracker<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">nativeStop</span><span class="token punctuation">(</span>mFaceTracker<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fun</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">nativeRelease</span><span class="token punctuation">(</span>mFaceTracker<span class="token punctuation">)</span>
        mFaceTracker <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">nativeInit</span><span class="token punctuation">(</span>modelPath<span class="token operator">:</span> String<span class="token punctuation">)</span><span class="token operator">:</span> Long

    <span class="token keyword">private</span> <span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">nativeSetSurface</span><span class="token punctuation">(</span>faceTracker<span class="token operator">:</span> Long<span class="token punctuation">,</span> surface<span class="token operator">:</span> Surface<span class="token operator">?</span><span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">nativeDetect</span><span class="token punctuation">(</span>
        faceTracker<span class="token operator">:</span> Long<span class="token punctuation">,</span>
        bytes<span class="token operator">:</span> ByteArray<span class="token punctuation">,</span>
        width<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        height<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        rotationDegrees<span class="token operator">:</span> Int
    <span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">nativeStart</span><span class="token punctuation">(</span>faceTracker<span class="token operator">:</span> Long<span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">nativeStop</span><span class="token punctuation">(</span>faceTracker<span class="token operator">:</span> Long<span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">nativeRelease</span><span class="token punctuation">(</span>faceTracker<span class="token operator">:</span> Long<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>nativeInit() 就是创建一个 Native 的 FaceTracker 对象，然后将该对象的地址返回给上层：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span>
JNIEXPORT jlong JNICALL
<span class="token function">Java_com_face_recognition_FaceTracker_nativeInit</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jstring model_path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化FaceTracker对象</span>
    <span class="token keyword">auto</span> <span class="token operator">*</span>tracker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">FaceTracker</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    env<span class="token operator">-&gt;</span><span class="token function">ReleaseStringUTFChars</span><span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>jlong<span class="token punctuation">)</span> tracker<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此外，在布局中的 SurfaceView 的 SurfaceHolder 添加 SurfaceHolder.Callback 的回调方法中，需要通过 FaceTracker 将 Surface 传给 Native 层：</p> 
<pre><code class="prism language-kotlin">	<span class="token comment">// SurfaceHolder.Callback start</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">surfaceCreated</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> SurfaceHolder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">surfaceChanged</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> SurfaceHolder<span class="token punctuation">,</span> format<span class="token operator">:</span> Int<span class="token punctuation">,</span> width<span class="token operator">:</span> Int<span class="token punctuation">,</span> height<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mFaceTracker<span class="token punctuation">.</span><span class="token function">setSurface</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span>surface<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">surfaceDestroyed</span><span class="token punctuation">(</span>holder<span class="token operator">:</span> SurfaceHolder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mFaceTracker<span class="token punctuation">.</span><span class="token function">setSurface</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// SurfaceHolder.Callback end</span>
</code></pre> 
<p>nativeSetSurface() 会通过上层传来的 Surface 创建 Native 层的 ANativeWindow 对象：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">Java_com_face_recognition_FaceTracker_nativeSetSurface</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span>
                                                       jlong face_tracker<span class="token punctuation">,</span> jobject surface<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>face_tracker <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> <span class="token operator">*</span>tracker <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>FaceTracker <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>face_tracker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ANativeWindow_release</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
            window <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        window <span class="token operator">=</span> <span class="token function">ANativeWindow_fromSurface</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> surface<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tracker<span class="token operator">-&gt;</span><span class="token function">setNativeWindow</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22__676"></a>2.2 人脸识别</h3> 
<p>初始化 CameraX 时在 bindAnalysis() 中设置了分析器：</p> 
<pre><code class="prism language-kotlin">		<span class="token comment">// 设置分析器，指定回调所发生的线程（池）</span>
        imageAnalysis<span class="token punctuation">.</span><span class="token function">setAnalyzer</span><span class="token punctuation">(</span>ContextCompat<span class="token punctuation">.</span><span class="token function">getMainExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
</code></pre> 
<p>第二个参数是 ImageAnalysis.Analyzer 接口，我们在 Activity 中实现它，接收摄像头采集到的数据：</p> 
<pre><code class="prism language-kotlin">	<span class="token comment">// ImageAnalysis.Analyzer</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">analyze</span><span class="token punctuation">(</span>image<span class="token operator">:</span> ImageProxy<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> bytes <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">getDataFromImage</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        mFaceTracker<span class="token punctuation">.</span><span class="token function">detect</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> image<span class="token punctuation">.</span>width<span class="token punctuation">,</span> image<span class="token punctuation">.</span>height<span class="token punctuation">,</span> image<span class="token punctuation">.</span>imageInfo<span class="token punctuation">.</span>rotationDegrees<span class="token punctuation">)</span>
        image<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>先从 ImageProxy 中提取出图像数据的 Byte 数组：</p> 
<pre><code class="prism language-kotlin">		<span class="token keyword">fun</span> <span class="token function">getDataFromImage</span><span class="token punctuation">(</span>image<span class="token operator">:</span> ImageProxy<span class="token punctuation">)</span><span class="token operator">:</span> ByteArray <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1.获取图像的宽高以及格式，计算出图片大小字节数</span>
            <span class="token keyword">val</span> rect <span class="token operator">=</span> image<span class="token punctuation">.</span>cropRect
            <span class="token keyword">val</span> imageWidth <span class="token operator">=</span> rect<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> imageHeight <span class="token operator">=</span> rect<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">val</span> format <span class="token operator">=</span> image<span class="token punctuation">.</span>format
            <span class="token keyword">val</span> size <span class="token operator">=</span> imageWidth <span class="token operator">*</span> imageHeight <span class="token operator">*</span> ImageFormat<span class="token punctuation">.</span><span class="token function">getBitsPerPixel</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8</span>

            <span class="token comment">// 2.为 data 和 rowData 分配内存</span>
            <span class="token keyword">val</span> <span class="token keyword">data</span> <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>

            <span class="token comment">// planes 是一个数组，每个元素是一个 ImageProxy.Plane 对象，</span>
            <span class="token comment">// Y、U、V 每种像素对应一个平面，分别是 planes[0]、planes[1]、</span>
            <span class="token comment">// planes[2]，每个 Plane 包含该平面图像数据的 ByteBuffer 对象</span>
            <span class="token keyword">val</span> planes <span class="token operator">=</span> image<span class="token punctuation">.</span>planes
            <span class="token keyword">val</span> rowData <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span>planes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rowStride<span class="token punctuation">)</span>

            <span class="token comment">// 3.将 image 图像数据拷贝到 data 中，拷贝时按照 Y、U、V</span>
            <span class="token comment">// 三个平面分开拷贝</span>
            <span class="token keyword">var</span> channelOffset<span class="token operator">:</span> Int
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> planes<span class="token punctuation">.</span>indices<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                channelOffset <span class="token operator">=</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// y 从 0 开始</span>
                    <span class="token number">0</span> <span class="token operator">-&gt;</span> <span class="token number">0</span>
                    <span class="token comment">// u 从 y 之后开始</span>
                    <span class="token number">1</span> <span class="token operator">-&gt;</span> imageWidth <span class="token operator">*</span> imageHeight
                    <span class="token comment">// v 从 u 之后开始，u 的数据长度为 width * height / 4</span>
                    <span class="token number">2</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>imageWidth <span class="token operator">*</span> imageHeight <span class="token operator">*</span> <span class="token number">1.25</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">else</span> <span class="token operator">-&gt;</span> <span class="token keyword">throw</span> <span class="token function">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"Unexpected number of image planes"</span></span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 这一个平面的数据缓冲区</span>
                <span class="token keyword">val</span> buffer <span class="token operator">=</span> planes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>buffer
                <span class="token comment">// 行跨度，一行的步长，即这一行有像素数据所占用的字节数</span>
                <span class="token keyword">val</span> rowStride <span class="token operator">=</span> planes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>rowStride
                <span class="token comment">// 像素跨度，即每一个像素占用的字节数，例如 RGB 就为 3</span>
                <span class="token keyword">val</span> pixelStride <span class="token operator">=</span> planes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pixelStride

                <span class="token comment">// UV 只有一半，因此要右移 1 位</span>
                <span class="token keyword">val</span> shift <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">1</span>
                <span class="token keyword">val</span> width <span class="token operator">=</span> imageWidth <span class="token operator">shr</span> shift
                <span class="token keyword">val</span> height <span class="token operator">=</span> imageHeight <span class="token operator">shr</span> shift

                <span class="token comment">// 移动到每个平面在 buffer 中的起始位置，准备读取该平面的数据</span>
                buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>rowStride <span class="token operator">*</span> <span class="token punctuation">(</span>rect<span class="token punctuation">.</span>top <span class="token operator">shr</span> shift<span class="token punctuation">)</span> <span class="token operator">+</span> pixelStride <span class="token operator">*</span> <span class="token punctuation">(</span>rect<span class="token punctuation">.</span>left <span class="token operator">shr</span> shift<span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token keyword">var</span> length<span class="token operator">:</span> Int
                <span class="token keyword">for</span> <span class="token punctuation">(</span>row <span class="token keyword">in</span> <span class="token number">0</span> until height<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pixelStride <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        length <span class="token operator">=</span> width
                        buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">,</span> channelOffset<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
                        channelOffset <span class="token operator">+=</span> length
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        length <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> pixelStride <span class="token operator">+</span> <span class="token number">1</span>
                        buffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rowData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>col <span class="token keyword">in</span> <span class="token number">0</span> until width<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">data</span><span class="token punctuation">[</span>channelOffset<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> rowData<span class="token punctuation">[</span>col <span class="token operator">*</span> pixelStride<span class="token punctuation">]</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>row <span class="token operator">&lt;</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rowStride <span class="token operator">-</span> length<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">data</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>然后将像素数据、图片宽高和旋转角度通过 FaceTracker 传递到 Native 层进行人脸检测：</p> 
<pre><code class="prism language-kotlin">	<span class="token keyword">fun</span> <span class="token function">detect</span><span class="token punctuation">(</span>bytes<span class="token operator">:</span> ByteArray<span class="token punctuation">,</span> width<span class="token operator">:</span> Int<span class="token punctuation">,</span> height<span class="token operator">:</span> Int<span class="token punctuation">,</span> rotationDegrees<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">nativeDetect</span><span class="token punctuation">(</span>mFaceTracker<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> rotationDegrees<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">external</span> <span class="token keyword">fun</span> <span class="token function">nativeDetect</span><span class="token punctuation">(</span>
        faceTracker<span class="token operator">:</span> Long<span class="token punctuation">,</span>
        bytes<span class="token operator">:</span> ByteArray<span class="token punctuation">,</span>
        width<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        height<span class="token operator">:</span> Int<span class="token punctuation">,</span>
        rotationDegrees<span class="token operator">:</span> Int
    <span class="token punctuation">)</span>
</code></pre> 
<p>来到 Native 层，将检测请求转发给 FaceTracker：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">Java_com_face_recognition_FaceTracker_nativeDetect</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jlong face_tracker<span class="token punctuation">,</span>
                                                   jbyteArray bytes<span class="token punctuation">,</span> jint width<span class="token punctuation">,</span> jint height<span class="token punctuation">,</span>
                                                   jint rotation_degrees<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>face_tracker <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        jbyte <span class="token operator">*</span>data <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetByteArrayElements</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> <span class="token operator">*</span>tracker <span class="token operator">=</span> <span class="token punctuation">(</span>FaceTracker <span class="token operator">*</span><span class="token punctuation">)</span> face_tracker<span class="token punctuation">;</span>
        <span class="token comment">// 声明时将 detect() 的 data 的 jbyte 改为 int8_t，两个类型是一回事但是 cpp 中最好不要用 JNI 类型</span>
        tracker<span class="token operator">-&gt;</span><span class="token function">detect</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> rotation_degrees<span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-&gt;</span><span class="token function">ReleaseByteArrayElements</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>FaceTracker 收到图像数据后，先创建 OpenCV 的图像对象 Mat，将其转换成 RGBA 格式再旋转为正向，然后开始灰度化、直方图等人脸识别过程：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">FaceTracker</span><span class="token double-colon punctuation">::</span><span class="token function">detect</span><span class="token punctuation">(</span><span class="token keyword">int8_t</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> <span class="token keyword">int</span> rotation_degrees<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// src 接收的是 YUV I420 的数据，因此高度应该是 height 的 1.5 倍</span>
    Mat <span class="token function">src</span><span class="token punctuation">(</span>height <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> CV_8UC1<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 YUV I420 格式的 src 转换为 RGBA 格式</span>
    <span class="token function">cvtColor</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src<span class="token punctuation">,</span> COLOR_YUV2RGBA_I420<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调整图像，将其旋转为正向</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rotation_degrees <span class="token operator">==</span> <span class="token number">90</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">rotate</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src<span class="token punctuation">,</span> ROTATE_90_CLOCKWISE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rotation_degrees <span class="token operator">==</span> <span class="token number">270</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">rotate</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src<span class="token punctuation">,</span> ROTATE_90_COUNTERCLOCKWISE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 水平翻转</span>
        <span class="token function">flip</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> src<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 灰度化、增强对比度</span>
    Mat gray<span class="token punctuation">;</span>
    <span class="token function">cvtColor</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> gray<span class="token punctuation">,</span> COLOR_RGBA2GRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">equalizeHist</span><span class="token punctuation">(</span>gray<span class="token punctuation">,</span> gray<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检测</span>
    tracker<span class="token operator">-&gt;</span><span class="token function">process</span><span class="token punctuation">(</span>gray<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取检测结果</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Rect<span class="token operator">&gt;</span> faces<span class="token punctuation">;</span>
    tracker<span class="token operator">-&gt;</span><span class="token function">getObjects</span><span class="token punctuation">(</span>faces<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 画矩形</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Rect <span class="token operator">&amp;</span>face<span class="token operator">:</span> faces<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">rectangle</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> face<span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绘制 src</span>
    <span class="token function">draw</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 释放</span>
    src<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gray<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后在 draw() 中将画了矩形人脸框的 Mat 对象绘制到 ANativeWindow 上：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">FaceTracker</span><span class="token double-colon punctuation">::</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// do-while(false) 是为了进行流程控制，在不满足条件时直接退出</span>
    <span class="token comment">// 循环执行解锁操作，否则需要写多次解锁代码</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 设置 Window Buffer 的格式与大小</span>
        <span class="token function">ANativeWindow_setBuffersGeometry</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> img<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> img<span class="token punctuation">.</span>rows<span class="token punctuation">,</span> WINDOW_FORMAT_RGBA_8888<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ANativeWindow_Buffer buffer<span class="token punctuation">;</span>

        <span class="token comment">// 上锁，目的是为了拿到 buffer</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ANativeWindow_lock</span><span class="token punctuation">(</span>window<span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ANativeWindow_release</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
            window <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取 buffer 保存实际数据的地址以及步长</span>
        <span class="token keyword">auto</span> dstData <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dstLineSize <span class="token operator">=</span> buffer<span class="token punctuation">.</span>stride <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取图片数据的起始地址与步长</span>
        <span class="token keyword">uint8_t</span> <span class="token operator">*</span>srcData <span class="token operator">=</span> img<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token keyword">int</span> srcLineSize <span class="token operator">=</span> img<span class="token punctuation">.</span>cols <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>

        <span class="token comment">// 逐行拷贝图像数据到 buffer.bits</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>height<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>dstData <span class="token operator">+</span> i <span class="token operator">*</span> dstLineSize<span class="token punctuation">,</span> srcData <span class="token operator">+</span> i <span class="token operator">*</span> srcLineSize<span class="token punctuation">,</span> srcLineSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">ANativeWindow_unlockAndPost</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>至此，Android 实现人脸识别的两个例子讲解完毕。</p> 
<p>参考资料：</p> 
<p>CameraX 的<a href="https://developer.android.google.cn/jetpack/androidx/releases/camera?hl=zh-cn" rel="nofollow">版本历史</a>、<a href="https://developer.android.google.cn/media/camera/camerax?hl=zh-cn" rel="nofollow">使用指南</a>、<a href="https://github.com/android/camera-samples">代码示例</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b64e2b1c2d68e001a588098836c29f1e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Yarn的安装和使用详细教程(Mac/Window)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b9590fefe8ca648fa9fe410d0cfdaf5b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Mac本地部署LLama3&#43;AnythingLLM&#43;Docker方式的本地知识库</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>