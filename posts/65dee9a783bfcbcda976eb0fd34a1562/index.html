<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Echarts横坐标时间轴，并缩放数据 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/65dee9a783bfcbcda976eb0fd34a1562/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Echarts横坐标时间轴，并缩放数据">
  <meta property="og:description" content="本文中Echarts的版本为5.5.0
首先说一下我们的项目背景，就是需要一个横坐标为时间轴的折线型数据。折线分为数值类型和枚举类型，也就是说Y坐标为数值型或者枚举型的数据；然后数据的缩放是这样的，把请求到的数据，一次性的全部显示在折线中，并且需要支持鼠标滚轮和鼠标拖拽式，缩放查看局部的数据。效果如图所示：
项目中的难点主要是三部分。1、查询的到的数据，比如查询的是今天的数据，但是今天的话，只有在10点和11点有数据，其他的时间没有数据；2、横坐标下面的显示的当前缩放完成之后的时间范围；3、需要线断开连接，具体的规则是，当数据中有flage:start的时候，就认为这是一个新的曲线了，需要和前面的数据断开显示；
1、正确显示数据 配置dataZoom 针对于第一个问题，采用的是dataZoom中配置，startValue和endValue，而不是配置start和end；
dataZoom: [ { type: &#34;inside&#34;, // start: 50, // 不能使用百分比，因为搜索的时间和数据的时间不一定能对应上 // end: 100, startValue: zoomStartValue, endValue: zoomEndValue, filterMode: &#34;filter&#34;, }, ], 其中zoomStartValue和zoomEndValue就是第一条数据和最后一条数据的时间；例如刚刚说的上面的例子。搜索今天的全部数据，但是只有10点和11点之间是有数据。那么zoomStartvalue=&#34;2024-04-10 10:00:00&#34;，则zoomEndValue可能就是&#34;2024-04-10 11:30:00&#34;。这里不需要使用时间戳，直接使用字符串类型的时间就可以；但是因为搜索的是今天，所以在用户拖动的时候，应该是能拖动到今天的0点的。结束时间应该是查询的时候的时间。所以这个时候的x轴需要单独的配置；
配置xAxis 在xAxis中，需要配置min和max两个参数，用于让x轴能滑动到今天的0点的时刻，虽然那个时间点并没有数据；
xAxis: { type: &#34;time&#34;, // 这里需要明确为“time” min: searchBeginTime, max: searchEndTime, axisLine: { show: true, lineStyle: { color: &#34;#C0C0C0&#34;, } }, axisTick: { show: true }, axisLabel: { color: &#34;#676767&#34; }, data: xdata, // 这里比较关键，需要传个数据，要不然直接靠server得到的数据，缩放有问题 }, 其中的min和max对应的数据，就是搜索传给后台的数据。比如我搜索的今天的数据，那么searchBeginTime应该是&#34;2024-04-10 00:00:00&#34;，searchEndTime应该是当前的搜索的结束时间：&#34;2024-4-10 11:49:02&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-10T11:50:31+08:00">
    <meta property="article:modified_time" content="2024-04-10T11:50:31+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Echarts横坐标时间轴，并缩放数据</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p>本文中Echarts的版本为5.5.0</p> 
</blockquote> 
<p>        首先说一下我们的项目背景，就是需要一个横坐标为<strong>时间轴</strong>的<strong>折线型</strong>数据。折线分为数值类型和枚举类型，也就是说Y坐标为数值型或者枚举型的数据；然后数据的缩放是这样的，把请求到的数据，一次性的全部显示在折线中，并且需要支持鼠标滚轮和鼠标拖拽式，缩放查看局部的数据。效果如图所示：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/41/40/c5bW771M_o.gif"></p> 
<p>        项目中的难点主要是三部分。1、查询的到的数据，比如查询的是今天的数据，但是今天的话，只有在10点和11点有数据，其他的时间没有数据；2、横坐标下面的显示的当前缩放完成之后的时间范围；3、需要线断开连接，具体的规则是，当数据中有flage:start的时候，就认为这是一个新的曲线了，需要和前面的数据断开显示；</p> 
<h2>1、正确显示数据</h2> 
<h3>配置dataZoom</h3> 
<p>        针对于第一个问题，采用的是dataZoom中配置，startValue和endValue，而不是配置start和end；</p> 
<pre><code class="language-javascript">    dataZoom: [
      {
        type: "inside",
        // start: 50, // 不能使用百分比，因为搜索的时间和数据的时间不一定能对应上
        // end: 100,
        startValue: zoomStartValue,
        endValue: zoomEndValue,
        filterMode: "filter",
      },
    ],</code></pre> 
<p>        其中zoomStartValue和zoomEndValue就是第一条数据和最后一条数据的时间；例如刚刚说的上面的例子。搜索今天的全部数据，但是只有10点和11点之间是有数据。那么zoomStartvalue="2024-04-10 10:00:00"，则zoomEndValue可能就是"2024-04-10 11:30:00"。这里不需要使用时间戳，直接使用字符串类型的时间就可以；但是因为搜索的是今天，所以在用户拖动的时候，应该是能拖动到今天的0点的。结束时间应该是查询的时候的时间。所以这个时候的x轴需要单独的配置；</p> 
<h3>配置xAxis</h3> 
<p>        在xAxis中，需要配置min和max两个参数，用于让x轴能滑动到今天的0点的时刻，虽然那个时间点并没有数据；</p> 
<pre><code class="language-javascript">    xAxis: {
      type: "time", // 这里需要明确为“time”
      min: searchBeginTime,
      max: searchEndTime,
      axisLine: {
        show: true,
        lineStyle: {
          color: "#C0C0C0",
        }
      },
      axisTick: {
        show: true
      },
      axisLabel: {
        color: "#676767"
      },
      data: xdata, //  这里比较关键，需要传个数据，要不然直接靠server得到的数据，缩放有问题
    },</code></pre> 
<p>        其中的min和max对应的数据，就是搜索传给后台的数据。比如我搜索的今天的数据，那么searchBeginTime应该是"2024-04-10 00:00:00"，searchEndTime应该是当前的搜索的结束时间："2024-4-10 11:49:02"；</p> 
<p>        其中还有一个问题是我在实际开发中发现的。就是xAxis中的data数据也是需要传递的。要不然直接靠server中的横坐标的数据，下面缩放以后获取到的时间就有问题了。xdata的数据，就是后台给的数据中，所有数据的时间的数组：['2024-04-10 10:00:00','2024-04-10 10:15:00',2024-04-10 10:30:00,'2024-04-10 10:45:00',……'2024-04-10 11:30:00']</p> 
<h2>2、缩放显示当前的时间区间</h2> 
<h3>监听dataZoom事件</h3> 
<p>        使用on("dataZoom")的方法，来监听Echats进行了缩放，而且这里面会有对应的，当前缩放的横坐标开始的百分比，和结束的百分比；</p> 
<p>        具体的方法如下：</p> 
<pre><code class="language-javascript">  myChart.off("dataZoom");
  myChart.on("dataZoom", (params) =&gt; {
    var optionData = myChart.getOption();
    var min = optionData.xAxis[0].min;
    var max = optionData.xAxis[0].max;
    var minT = new Date(min).getTime();
    var maxT = new Date(max).getTime();
    var len = maxT - minT;// 计算出时间的差额。使用的是时间戳计算~
    var start = params.batch[0].start; // 横坐标左侧的百分比
    var end = params.batch[0].end; // 横坐标右侧的百分比
    var startIndex = Math.round((len * start) / 100);
    var endIndex = Math.round((len * end) / 100);
    var xTextContent = `${moment(minT + startIndex).format("YYYY-MM-DD HH:mm:ss")} -- ${moment(minT + endIndex).format("YYYY-MM-DD HH:mm:ss")}`; // 使用moment插件，格式化成具体的时间
    xText.value = xTextContent;
  });</code></pre> 
<p>其中，start和end就是Echats缩放之后，获取的开始百分比和结束百分比；start的最小值为0，end的最大值为100。然后根据横坐标的min和max获取到整体的时间戳。然后计算出来差额，再根据百分比就能获取到当前的横坐标显示的时间了。</p> 
<h2>3、断开曲线</h2> 
<p>        项目中需要把数据中，含有flags:true的，就认为是一个新的曲线。当时我们想到的断开方法是给一个数据，只传时间，然后对应的值传空，这样就能断开了。但是由于我们的数据横坐标对应都是有值的。上面的方法就不可用了。所以我们采用的了第二种方法，就是在Echats中绘制了两条曲线，这两条曲线互不干扰。</p> 
<p>        首先说一下，我们的数据：</p> 
<pre><code class="language-javascript">var chartRowData = [{
  timestamp: "2024-4-10 11:20:00",
  value: 12,
  status: "null",
  flags: true,
},{
  timestamp: "2024-4-10 11:21:00",
  value: 19,
  status: "ok",
},{
  timestamp: "2024-4-10 11:22:00",
  value: 20,
  status: "alarm",
},{
  timestamp: "2024-4-10 11:23:00",
  value: 22,
  status: "ok",
},{
  timestamp: "2024-4-10 11:24:00",
  value: 8,
  status: "ok",
  flags: true,
},{
  timestamp: "2024-4-10 11:25:00",
  value: 15,
  status: "ok",
},{
  timestamp: "2024-4-10 11:26:00",
  value: 12,
  status: "ok",
},{
  timestamp: "2024-4-10 11:27:00",
  value: 14,
  status: "ok",
}]</code></pre> 
<p>        所以我采用下面的方法整理数据</p> 
<pre><code class="language-javascript">var xdata = [], seriesData = [], seriesArr=[]; // 横坐标；一段横线的小数组；全部数据的数组
  var chartRowDataLength = chartRowData.length;
  chartRowData.forEach((item, i) =&gt; {
    xdata.push(item.timestamp);
    // 如果是flags的值为start的话，就重新添加一条线
    if(item.hasOwnProperty("flags") &amp;&amp; item.flags == "start" &amp;&amp; seriesData.length) {
      seriesArr.push({
        name: historyName,
        data: seriesData.slice(0),
        type: "line",
        smooth: true,
        showSymbol: false,
        emphasis: { // 关闭鼠标高亮
          disabled: true
        }
      })
      seriesData.splice(0);
    }
    seriesData.push([item.timestamp, item.value, item.status]);
    if (i == 0) {
      zoomStartValue = item.timestamp;
    }
    if (i == chartRowDataLength - 1) {
      zoomEndValue = item.timestamp;
      // 数据最后一条，也要添加到大数组中。
      seriesArr.push({
        name: historyName,
        data: seriesData.slice(0),
        type: "line",
        smooth: true,
        showSymbol: false,
        emphasis: { // 关闭鼠标高亮
          disabled: true
        }
      })
    }
  })</code></pre> 
<h2>4、其他的小问题</h2> 
<h3>设置语言</h3> 
<p>        做完了发现时间显示的有问题。就是不是按照咱们写的年月日时分秒显示的。所以需要在初始化Echats的时候，指定一下语言；</p> 
<pre><code class="language-javascript">var chartDom = document.getElementById("chartDom");
myChart = echarts.init(chartDom, null, { locale: "ZH" });</code></pre> 
<h3>一天中仅有一条数据</h3> 
<p>        测试提出，如果查询今天只有一条数据的话，就会发现，缩放有问题；经过查询代码发现，是因为zoomStartValue和zoomEndValue相等，导致了出现了横坐标显示的不是今天的数据。所以有了以下的一个判断：</p> 
<pre><code class="language-javascript">    // 如果之有一个数据的话，zoomStartValue和zoomEndValue的值是一样的。这样Echarts的zoom就有问题了~
    // 所以需要单独处理一下
    if(chartRowData.length == 1) { 
      zoomStartValue = searchBeginTime;
      zoomEndValue = searchEndTime;
    }</code></pre> 
<p>        如有需要，可以查看资源。里面的代码可以直接运行，因为没有请求，所以里面很多内容都是直接写死的。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/825cb237dc9e65e3d401737fbef586b7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">深度探索：机器学习梯度提升决策树（GBDT）算法原理及其应用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/982578e12ff098870afd2fbbe997f798/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Whisper（语音识别，语音转文本）本地部署</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>