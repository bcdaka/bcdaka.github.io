<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C#中多线程Task详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/d260538620bdaae518caf9b765046f0a/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="C#中多线程Task详解">
  <meta property="og:description" content="C#中多线程Task详解 1.常用多线程创建方式比较1.1Thread方式1.2ThreadPool方式1.3 Task方式1.4 Task方式介绍1.5 什么时候使用多线程 2.Task创建任务的几种方式2.1 Task task = new Task2.2 Task task1 = Task.Run最常用2.3 Task task2 = Task.Factory.StartNew 实例化工厂2.4 Task有返回值的创建方式 3.委托方式与lambda方式4.Task常用的API4.1 实例方法.wait()4.2 实例方法.ContinueWith()4.3 静态方法，Task.WaitAll4.4 静态方法Task.WaitAny4.4 任务工厂Task.Factory.ContinueWhenAll4.4 任务工厂Task.Factory.ContinueWhenAny4.5 Thread.Sleep与Task.Delay的区别 5.Task任务取消5.1 任务取消常见方式5.2 延时取消5.3 任务取消触发回调函数5.4 多个任务共同取消 6.线程同步、异步6.1 线程同步6.1.1 lock方法6.1.2 monitor类 6.2 线程异步6.2.1 控制台应用async和await6.2.2 Winfrom界面async和await 6.3 异步并发 7.线程调试方法7.1 多线程界面调试方法7.2 多线程界面调试实操 8.多线程异常处理8.1 单线程异常与多线程异常比对8.2 单线程与多线程案列8.3 多线程异常捕捉与处理8.4 多线程中多个异常捕获 8.总结 参考文章： 一文带你搞懂C#多线程的5种写法
C# 中的多线程实现方式
C# Task的各种用法和详解(推荐,精)
C# Task和async/await详解
C#多线程和异步（二）——Task和async/await详解
多线程之Task（任务）
C#中的多线程Task
async/await异步和Task多线程您真的明白了吗？
谈谈C#多线程开发：并行、并发与异步编程
c#： 异步代码是如何解决高并发问题的？async/await、Task、IOCP/epoll
C#多线程调试">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-23T20:18:39+08:00">
    <meta property="article:modified_time" content="2024-05-23T20:18:39+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C#中多线程Task详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>C#中多线程Task详解</h4> 
 <ul><li><ul><li><a href="#1_16" rel="nofollow">1.常用多线程创建方式比较</a></li><li><ul><li><a href="#11Thread_17" rel="nofollow">1.1Thread方式</a></li><li><a href="#12ThreadPool_19" rel="nofollow">1.2ThreadPool方式</a></li><li><a href="#13_Task_22" rel="nofollow">1.3 Task方式</a></li><li><a href="#14_Task_24" rel="nofollow">1.4 Task方式介绍</a></li><li><a href="#15__27" rel="nofollow">1.5 什么时候使用多线程</a></li></ul> 
   </li><li><a href="#2Task_37" rel="nofollow">2.Task创建任务的几种方式</a></li><li><ul><li><a href="#21_Task_task__new_Task_38" rel="nofollow">2.1 Task task = new Task</a></li><li><a href="#22_Task_task1__TaskRun_50" rel="nofollow">2.2 Task task1 = Task.Run最常用</a></li><li><a href="#23_Task_task2__TaskFactoryStartNew___60" rel="nofollow">2.3 Task task2 = Task.Factory.StartNew 实例化工厂</a></li><li><a href="#24_Task_78" rel="nofollow">2.4 Task有返回值的创建方式</a></li></ul> 
   </li><li><a href="#3lambda_112" rel="nofollow">3.委托方式与lambda方式</a></li><li><a href="#4TaskAPI_166" rel="nofollow">4.Task常用的API</a></li><li><ul><li><a href="#41_wait_212" rel="nofollow">4.1 实例方法.wait()</a></li><li><a href="#42_ContinueWith_256" rel="nofollow">4.2 实例方法.ContinueWith()</a></li><li><a href="#43_TaskWaitAll_301" rel="nofollow">4.3 静态方法，Task.WaitAll</a></li><li><a href="#44_TaskWaitAny_344" rel="nofollow">4.4 静态方法Task.WaitAny</a></li><li><a href="#44_TaskFactoryContinueWhenAll_348" rel="nofollow">4.4 任务工厂Task.Factory.ContinueWhenAll</a></li><li><a href="#44_TaskFactoryContinueWhenAny_394" rel="nofollow">4.4 任务工厂Task.Factory.ContinueWhenAny</a></li><li><a href="#45_ThreadSleepTaskDelay_399" rel="nofollow">4.5 Thread.Sleep与Task.Delay的区别</a></li></ul> 
   </li><li><a href="#5Task_401" rel="nofollow">5.Task任务取消</a></li><li><ul><li><a href="#51__414" rel="nofollow">5.1 任务取消常见方式</a></li><li><a href="#52__448" rel="nofollow">5.2 延时取消</a></li><li><a href="#53__482" rel="nofollow">5.3 任务取消触发回调函数</a></li><li><a href="#54__484" rel="nofollow">5.4 多个任务共同取消</a></li></ul> 
   </li><li><a href="#6_526" rel="nofollow">6.线程同步、异步</a></li><li><ul><li><a href="#61__527" rel="nofollow">6.1 线程同步</a></li><li><ul><li><a href="#611_lock_540" rel="nofollow">6.1.1 lock方法</a></li><li><a href="#612_monitor_591" rel="nofollow">6.1.2 monitor类</a></li></ul> 
    </li><li><a href="#62__611" rel="nofollow">6.2 线程异步</a></li><li><ul><li><a href="#621_asyncawait_617" rel="nofollow">6.2.1 控制台应用async和await</a></li><li><a href="#622_Winfromasyncawait_692" rel="nofollow">6.2.2 Winfrom界面async和await</a></li></ul> 
    </li><li><a href="#63__872" rel="nofollow">6.3 异步并发</a></li></ul> 
   </li><li><a href="#7_875" rel="nofollow">7.线程调试方法</a></li><li><ul><li><a href="#71__879" rel="nofollow">7.1 多线程界面调试方法</a></li><li><a href="#72__886" rel="nofollow">7.2 多线程界面调试实操</a></li></ul> 
   </li><li><a href="#8_916" rel="nofollow">8.多线程异常处理</a></li><li><ul><li><a href="#81__917" rel="nofollow">8.1 单线程异常与多线程异常比对</a></li><li><a href="#82__937" rel="nofollow">8.2 单线程与多线程案列</a></li><li><a href="#83__1010" rel="nofollow">8.3 多线程异常捕捉与处理</a></li><li><a href="#84__1055" rel="nofollow">8.4 多线程中多个异常捕获</a></li></ul> 
   </li><li><a href="#8_1062" rel="nofollow">8.总结</a></li></ul> 
 </li></ul> 
</div> 
<br> 参考文章： 
<p></p> 
<p><a href="https://blog.csdn.net/qq_44705559/article/details/117382445">一文带你搞懂C#多线程的5种写法</a><br> <a href="https://blog.csdn.net/Upgrader/article/details/107774139">C# 中的多线程实现方式</a><br> <a href="https://blog.csdn.net/hezhixiang/article/details/102741495">C# Task的各种用法和详解(推荐,精)</a><br> <a href="https://blog.csdn.net/btfireknight/article/details/97766193">C# Task和async/await详解</a><br> <a href="https://www.cnblogs.com/wyy1234/p/9172467.html" rel="nofollow">C#多线程和异步（二）——Task和async/await详解</a><br> <a href="https://blog.csdn.net/qq_41885871/article/details/83901318">多线程之Task（任务）</a><br> <a href="https://www.cnblogs.com/shuzhongke/p/14197531.html" rel="nofollow">C#中的多线程Task</a><br> <a href="https://blog.csdn.net/qq_42799562/article/details/115035702">async/await异步和Task多线程您真的明白了吗？</a><br> <a href="https://www.cnblogs.com/seabluescn/p/12973936.html#task" rel="nofollow">谈谈C#多线程开发：并行、并发与异步编程</a><br> <a href="https://blog.csdn.net/u010476739/article/details/119341731">c#： 异步代码是如何解决高并发问题的？async/await、Task、IOCP/epoll</a><br> <a href="https://zhuanlan.zhihu.com/p/509198857" rel="nofollow">C#多线程调试</a><br> <a href="https://www.cnblogs.com/yilang/p/12487588.html" rel="nofollow">Visual Studio调试器指南—多线程应用程序调试(一）</a></p> 
<h3><a id="1_16"></a>1.常用多线程创建方式比较</h3> 
<h4><a id="11Thread_17"></a>1.1Thread方式</h4> 
<p>缺点：频繁的创建和消耗比较好资源；提供操作线程的API不是马上响应(线程是操作系统统一管理，收到指令之后，具体还得操作系统真实处理，而操作系统收到指令之后并非马上执行相关指令)；</p> 
<h4><a id="12ThreadPool_19"></a>1.2ThreadPool方式</h4> 
<p>优点：池化线程进行管理，需要使用就从池中获取就行，避免频繁创建和销毁线程；从而可以达到线程的复用；<br> 缺点：提供的API太少，线程等待顺序控制比较弱；从而在一些业务情况下操作不方便；</p> 
<h4><a id="13_Task_22"></a>1.3 Task方式</h4> 
<p>在ThreadPool的思想进行了封装，继承了ThreadPool的优点；提供了丰富的线程控制API，从而方便了开发；</p> 
<h4><a id="14_Task_24"></a>1.4 Task方式介绍</h4> 
<p>Task可以简单看作相当于Thead+TheadPool，其性能比直接使用Thread要更好，在工作中更多的是使用Task来处理多线程任务<br> net4.0在ThreadPool的基础上推出了Task类，微软极力推荐使用Task来执行异步任务，现在C#类库中的异步方法基本都用到了Task；net5.0推出了async/await，让异步编程更为方便。</p> 
<h4><a id="15__27"></a>1.5 什么时候使用多线程</h4> 
<p>1.可以并发执行<br> 例子：查询数据—可能查询接口、可能查询数据、可能查询缓存，开启3个线程，同时执行。大型项目中需要经常打开关闭数据库，且可能有多个界面同时调用数据库，会耗费大量时间。</p> 
<p>例子：查询数据—查询一个结果后，需要使用这个结果作为条件，再进行下一次查询，还需要查询结果继续查询------不能使用多线程</p> 
<p>例子：列表数据----可能来自数据库—可能来自缓存—可能来自第三方接口<br> 传统方法：一个一个查询再去判断<br> 多线程：同时启用3个线程查询，等待其中一个线程结束，判断是否找到结果，有一个找到结果，另外2个线程可以不用再管 //task.waitany //continuewhenany</p> 
<h3><a id="2Task_37"></a>2.Task创建任务的几种方式</h3> 
<h4><a id="21_Task_task__new_Task_38"></a>2.1 Task task = new Task</h4> 
<pre><code class="prism language-csharp">		<span class="token class-name">Task</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//开启任务</span>
            task<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>new方式实例化一个Task，需要通过Start方法启动</p> 
<h4><a id="22_Task_task1__TaskRun_50"></a>2.2 Task task1 = Task.Run最常用</h4> 
<pre><code class="prism language-csharp"><span class="token class-name">Task</span> task1 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
   <span class="token punctuation">{<!-- --></span>
       Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Task.Run(Action action)将任务放在线程池队列，返回并启动一个Task</p> 
<h4><a id="23_Task_task2__TaskFactoryStartNew___60"></a>2.3 Task task2 = Task.Factory.StartNew 实例化工厂</h4> 
<pre><code class="prism language-csharp"><span class="token comment">//task静态属性获取Factory</span>
<span class="token class-name">Task</span> task2 <span class="token operator">=</span> Task<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//TaskFactory 工厂实例化，二者概念不一样</span>
<span class="token class-name">TaskFactory</span> taskFactory1<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            taskFactory1<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Task.Factory.StartNew(Action action)创建和启动一个Task</p> 
<h4><a id="24_Task_78"></a>2.4 Task有返回值的创建方式</h4> 
<p>有返回值的创建方式用法与上面3种常见的方式一样，代码示例如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">1.new方式实例化一个Task，需要通过Start方法启动</span>
            <span class="token class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token interpolation-string"><span class="token string">$"hello, task1的ID为</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            task<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">2.Task.Factory.StartNew(Func func)创建和启动一个Task</span>
            <span class="token class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> task2 <span class="token operator">=</span> Task<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">StartNew</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token interpolation-string"><span class="token string">$"hello, task2的ID为</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">3.Task.Run(Func func)将任务放在线程池队列，返回并启动一个Task</span>
            <span class="token class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> task3 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Run</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token interpolation-string"><span class="token string">$"hello, task3的ID为</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"执行主线程！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>task2<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>task3<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p><em><strong>task.Resut获取结果时会阻塞线程，即如果task没有执行完成，会等待task执行完成获取到Result，然后再执行后边的代码</strong></em>，程序运行结果如下：<br> <img src="https://images2.imgbox.com/69/c0/yRCIosH6_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3lambda_112"></a>3.委托方式与lambda方式</h3> 
<p>线程创建好之后，需要用线程执行方法实现想要的功能，可通过委托的方式或labmda方式执行，上述task任务3种创建方式均为lambda，lambda方式与函数方式是一致的，以下多一个简单的对比。<br> lambda方式代码例子：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ContinueWithTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> task1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"task0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">"task1"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> task2 <span class="token operator">=</span> task1<span class="token punctuation">.</span><span class="token function">ContinueWith</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//task1执行完后执行task2里面的逻辑，所以</span>
                <span class="token comment">//一定能在该语句里面拿到task1的返回值即t.Result,且与主线程异步</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">"task2"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            task1<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>委托方式调用函数代码例子：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ContinueWithTest1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// Func&lt;string&gt; func = new Func&lt;string&gt;(DoTask1);</span>

             <span class="token comment">//或Func&lt;string&gt; func=DoTask1</span>
            <span class="token comment">// Task&lt;string&gt; task1 = new Task&lt;string&gt;(func);写成这样也是与下面要实现的功能一样</span>

            <span class="token class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> task1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>DoTask1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> task2 <span class="token operator">=</span> task1<span class="token punctuation">.</span><span class="token function">ContinueWith</span><span class="token punctuation">(</span>DoTask2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            task1<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">DoTask1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"task0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"task1"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">DoTask2</span><span class="token punctuation">(</span><span class="token class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> t<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token string">"task2"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>上述两种方式执行的结果是一致的</p> 
<h3><a id="4TaskAPI_166"></a>4.Task常用的API</h3> 
<p>当一个进程中出现多个线程时，线程执行的先后顺序常常是不规律的，例如执行完线程1，会紧接着执行线程6，而不是按顺序执行线程2，即整个执行过程会<strong>跳来跳去</strong>，这也导致当线程过多时，程序执行变得不可控，产生莫名其妙的BUG，加大了调试代码的难度，同时执行的最终结果可能会偏离预期。因此需要对线程加一些约束。<br> 常用的API函数主要包括：实例方法.Wait()、实例方法.ContinueWith()、Task.WaitAll、Task.WaitAny、Task.Factory.ContinueWhenAll、Task.Factory.ContinueWhenAny等，以下分别对每种API函数详解。</p> 
<p><strong>Wait/WaitAny/WaitAll方法返回值为void，这些方法单纯的实现阻塞线程</strong>。现在想让所有task执行完毕(或者任一task执行完毕)后，开始执行后续操作，怎么实现呢？这时就可以用到<strong>WhenAny/WhenAll方法了，这些方法执行完成返回一个task实例</strong>。 task.WhenAll(Task[] tasks) 表示所有的task都执行完毕后再去执行后续的操作， task.WhenAny(Task[] tasks) 表示任一task执行完毕后就开始执行后续操作</p> 
<p>先不采用约束，看一下线程执行的常规流程；</p> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"主线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">开启"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task1 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task1 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task2 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task2 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> task3 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task3 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task4 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task4 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"主线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">完成"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>第一次执行结果如下图1所示：<br> <img src="https://images2.imgbox.com/d8/8a/RuKCCLcJ_o.png" alt="在这里插入图片描述"></p> 
<p>第二次执行结果如下图2所示：<br> <img src="https://images2.imgbox.com/09/3d/JqN40VXi_o.png" alt="在这里插入图片描述"><br> “主线程1开启”、“主线程1完成”是并行执行的，task1、task2、task3、task4任务没有规律，如上图1、图2所示，两次执行的程序代码相同，但线程执行的先后顺序不一致，为了约束线程执行过程，采用API。</p> 
<h4><a id="41_wait_212"></a>4.1 实例方法.wait()</h4> 
<p>.Wait() 等待执行调用任务完成，然后执行下一步； 即阻塞了主线程；<br> 在常规流程中加入wait方法，如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"主线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">开启"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task1 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task1 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            task1<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task2 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task2 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            task2<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task3 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task3 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            task3<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> task4 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task4 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            task4<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"主线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">完成"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>执行结果如下图3所示，此时线程按代码顺序执行，同时阻塞线程，任务1完成之后，执行任务2、任务3、任务4，异步线程变为同步线程，整个线程执行时间t=10000+5000+500+2000<br> <img src="https://images2.imgbox.com/66/bb/jNf1GO9D_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="42_ContinueWith_256"></a>4.2 实例方法.ContinueWith()</h4> 
<p>ContinueWith() 等调用者结束之后才进行调用里面的相关业务，由线程池分配线程进行处理接下来的业务，不阻塞主线程，但却能控制业务之间的先后顺序；<br> 常规流程中加入代码，如下所示：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"主线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">开启"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task1 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task1 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task2 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task2 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           
            <span class="token class-name"><span class="token keyword">var</span></span> task3 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task3 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            task3<span class="token punctuation">.</span><span class="token function">ContinueWith</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task3 后续执行</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task4 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task4 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"主线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">完成"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>执行结果如下所示，不论执行多少次，“Task3 后续执行”永远在“Task3 开启线程”之后，即等待“Task3 开启线程”完成之后，才会处理“Task3 后续执行”，并不会阻塞其他线程。<br> <img src="https://images2.imgbox.com/6c/49/zzvnMC4C_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="43_TaskWaitAll_301"></a>4.3 静态方法，Task.WaitAll</h4> 
<p>Task.WaitAll等到所有任务都完成之后，才进行主线程的下一步操作，即阻塞主线程；<br> 代码如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"主线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">开启"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task1 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task1 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task2 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task2 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           
            <span class="token class-name"><span class="token keyword">var</span></span> task3 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task3 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task4 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task4 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&gt;</span></span> list1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span> task1<span class="token punctuation">,</span>task2<span class="token punctuation">,</span>task3<span class="token punctuation">,</span>task4<span class="token punctuation">}</span><span class="token punctuation">;</span>
            Task<span class="token punctuation">.</span><span class="token function">WaitAll</span><span class="token punctuation">(</span>list1<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"主线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">完成"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>执行结果如下图所示，主线程之前的task1、task2、、task3、、task4执行多次顺序会不同，即线程之间是无序的，但是等4个线程即所有任务都完成之后，才会执行“主线程1完成”。<br> <img src="https://images2.imgbox.com/36/d9/IbpJSywO_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="44_TaskWaitAny_344"></a>4.4 静态方法Task.WaitAny</h4> 
<p>同Task.WaitAll，等待任何一个任务完成就继续向下执行，将上面的代码WaitAll替换为WaitAny<br> 即当task,task2,task3…N任意一个任务都执行完成之后就会往下执行代码，<br> task.WaitAny等到其中一个任务完成之后，才进行主线程的下一步操作，其中任务没有完成之前也阻塞主线程；</p> 
<h4><a id="44_TaskFactoryContinueWhenAll_348"></a>4.4 任务工厂Task.Factory.ContinueWhenAll</h4> 
<p>当ContinueWhenAll中所有任务都完成时执行回调方法，<em><strong>不阻塞主线程</strong></em>，<br> 代码如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"主线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">开启"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task1 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task1 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task2 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task2 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           
            <span class="token class-name"><span class="token keyword">var</span></span> task3 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task3 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> task4 <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Task4 开启线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">处理业务"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&gt;</span></span> list1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>task1<span class="token punctuation">,</span>task2<span class="token punctuation">,</span>task3<span class="token punctuation">,</span>task4<span class="token punctuation">}</span><span class="token punctuation">;</span>
            Task<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">ContinueWhenAll</span><span class="token punctuation">(</span>list1<span class="token punctuation">.</span>ToArray <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>tasks <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"任务执行结束"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"主线程</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">完成"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>执行结果如下：<br> <img src="https://images2.imgbox.com/14/e0/DXtVqgNs_o.png" alt="在这里插入图片描述"><br> 不阻塞主线程， 当封装在所有list中的任务全部执行完成之后，再进行后续的处理，其中后续处理的业务的参数是上一完成任务的列表！！！</p> 
<h4><a id="44_TaskFactoryContinueWhenAny_394"></a>4.4 任务工厂Task.Factory.ContinueWhenAny</h4> 
<p>当参数中的任务有一个完成之后就进行回调，执行下一个任务。<br> Task.Factory.ContinueWhenAny方法等其中的任务有一项完成之后就立即返回，调用后续业务，<em><strong>不阻塞主线程</strong></em>；<br> <em><strong>实际开发中建议使用ContinueWhenAny、ContinueWhenAll　不阻塞线程，尤其是在UI界面开发中</strong></em></p> 
<h4><a id="45_ThreadSleepTaskDelay_399"></a>4.5 Thread.Sleep与Task.Delay的区别</h4> 
<p>这两个函数，实际工程中也经常用到，都表示延期执行某个功能，但是 <em><strong>Thread.Sleep在延期时间内会阻塞主线程</strong></em>，例如： <code>Thread.Sleep(5000)</code>，在UI界面中会卡顿界面5秒，界面无法执行其他操作，原因是Thread属性IsBackground默认为前台线程，<em><strong>Task.Delay(5000)延时期间不会阻塞主线程</strong></em></p> 
<h3><a id="5Task_401"></a>5.Task任务取消</h3> 
<p>线程在执行过程中难免会出错，或者执行相当长一段时间仍未执行完成，这就需要取消线程。<br> 如下例子：首页包含很多信息，数据来自不同渠道，多块信息展示<br> 传统方法：主线程一个一个查询，然后返回<br> 多线程：开启多个线程同时查询，等待所有结果返回 //task.waitall //continuewhenall<br> 如果一个模块的信息获取失败，必须重新获取，数据不能使用，另外获取数据的几个线程还在执行，则另外几个线程是否还有必要执行？需要做线程的取消</p> 
<p>1.线程不能从外部取消，只能自己取消自己（对外抛出异常）<br> 2.定义信号量，如果有线程执行出错，通知信号量，如果信号量被改变，则直接取消自己<br> 3.定义布尔变量做信号量，不推荐<br> 4.标准实现：CancellationTokenSource</p> 
<p>C# 使用 CancellationTokenSource 终止线程，取消线程不是影响线程内部的执行(线程内部的执行根据系统内存资源自动分配)，而是外部对Task的控制，如取消、定时取消。</p> 
<h4><a id="51__414"></a>5.1 任务取消常见方式</h4> 
<p>如下代码：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">class</span> <span class="token class-name">Program</span>
     <span class="token punctuation">{<!-- --></span> 

        <span class="token keyword">static</span> <span class="token class-name">CancellationTokenSource</span> cancelTokenSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Task<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span>MyTask<span class="token punctuation">,</span> cancelTokenSource<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"请按回车键(Enter)停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            cancelTokenSource<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"已停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//判断是否取消任务</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>cancelTokenSource<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>执行结果如下图所示，当线程未取消，即未按下“ENTER”键，线程执行委托方法MyTask，代码cancelTokenSource.Cancel();及后面的代码是不会执行的，当按下“enter”键，才会执行后面的代码。<br> <img src="https://images2.imgbox.com/29/1f/hxTwU5qV_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="52__448"></a>5.2 延时取消</h4> 
<p>也可以使用定时取消的方式，当任务超过了我们设定的时间，取消任务</p> 
<pre><code class="prism language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> cancelTokenSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>或者采用如下代码方式：source.CancelAfter(5000);</p> 
<pre><code class="prism language-csharp"><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">CancellationTokenSource</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//注册任务取消的事件</span>
            source<span class="token punctuation">.</span>Token<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"任务被取消后执行xx操作！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">int</span></span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">//开启一个task执行任务</span>
            <span class="token class-name">Task</span> task1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
              <span class="token punctuation">{<!-- --></span>
                  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span>
                  <span class="token punctuation">{<!-- --></span>
                      Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token operator">++</span>index</span><span class="token punctuation">}</span></span><span class="token string">次执行，线程运行中..."</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            task1<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//延时取消，效果等同于Thread.Sleep(5000);source.Cancel();</span>
            source<span class="token punctuation">.</span><span class="token function">CancelAfter</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="53__482"></a>5.3 任务取消触发回调函数</h4> 
<p>如前所述在Task的API函数中，当线程执行完毕后，可以调用Continuewith等做某一线程执行完成的后续处理工作，任务取消也可触发此类回调函数。对应方法：<strong>source.Token.Register(Action action)注册取消任务触发的回调函数</strong>，即当某一任务被取消时，通过Register执行任务取消的后续操作。代码例子如5.2延时取消。</p> 
<h4><a id="54__484"></a>5.4 多个任务共同取消</h4> 
<p>多个任务共同取消，在有多个CancellationTokenSource需要一起并行管理的时候，比如任意一个任务取消 则取消所有任务。我们不必去一个一个的去关闭，只需要将需要一起并行关闭的CancellationTokenSource组合起来就行了<br> 代码如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//声明CancellationTokenSource对象</span>
        <span class="token keyword">static</span> <span class="token class-name">CancellationTokenSource</span> c1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token class-name">CancellationTokenSource</span> c2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token class-name">CancellationTokenSource</span> c3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancellationTokenSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//使用多个CancellationTokenSource进行复合管理</span>
        <span class="token keyword">static</span> <span class="token class-name">CancellationTokenSource</span> compositeCancel <span class="token operator">=</span> CancellationTokenSource<span class="token punctuation">.</span><span class="token function">CreateLinkedTokenSource</span><span class="token punctuation">(</span>c1<span class="token punctuation">.</span>Token<span class="token punctuation">,</span> c2<span class="token punctuation">.</span>Token<span class="token punctuation">,</span> c3<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//程序入口</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Task<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">StartNew</span><span class="token punctuation">(</span>MyTask<span class="token punctuation">,</span> compositeCancel<span class="token punctuation">.</span>Token<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"请按回车键(Enter)停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//任意一个 CancellationTokenSource 取消任务，那么所有任务都会被取消。</span>
            c1<span class="token punctuation">.</span><span class="token function">Cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"已停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//测试方法</span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">MyTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//判断是否取消任务</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>compositeCancel<span class="token punctuation">.</span>IsCancellationRequested<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6_526"></a>6.线程同步、异步</h3> 
<h4><a id="61__527"></a>6.1 线程同步</h4> 
<p>常见例子：我们吃饭用手机点菜的时候，多个人同时点菜，在最后结账的时候，如果大家都争着买单，那如果没有同步信息，就会造成多个人都买单成功。这就是线程同步的问题之一。</p> 
<p>所谓的同步，即按照代码的顺序执行，也就是用同一个线程来执行所有的操作，或者多个线程按顺序执行，例如***4.1 实例方法.wait()***中的部分，多个线程按顺序执行。<br> <strong>有序性</strong>：主要针对程序的执行顺序来说.比如单线程编程中，A();B(); ，必须等待A方法执行完了，B方法才可以执行.再比如,lock(sync){A();},无论多少个线程调用这段代码，A方法在同一个时刻只允许一个线程调用，其它线程必须等待<br> <strong>一致性</strong>：主要针对数据来说.我们必须确保对临界区数据的变更不会影响其它线程.比如说，A线程和B线程在某一段时间都对data进行修改，<em><strong>线程之间共享变量可能会造成死锁的现象</strong></em>，为避免出现两个线程同时修改，后者的修改将前者的修改覆盖掉，我们对data的修改进行加锁,这样data一次只会允许一个线程进行修改.也就保证了数据的一致性.</p> 
<p><em><strong>线程安全：多线程执行结果与单线程一致，线程安全<br> 线程不安全：多线程同时修改一个变量；或者一个线程修改，一个线程读取，则可能出现BUG</strong></em></p> 
<p><em><strong>在多线程问题的处理上，我们是在异步中谋求同步的目的，以确保程序的安全</strong></em></p> 
<p>线程同步的方法常见的主要有锁 SpinLock 、Mutex、Monitor、lock。以下仅介绍最常用的Monitor、lock方法</p> 
<h5><a id="611_lock_540"></a>6.1.1 lock方法</h5> 
<p>1、lock锁定的是一个引用类型，值类型不能被lock<br> 2、避免lock一个string，因为程序中任何跟锁定的string的字符串是一样的都会被锁定。<br> 模拟售票系统代码如下：</p> 
<pre><code class="prism language-csharp"> <span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">int</span></span> num <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ticket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token comment">//无线循环</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">lock</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>     <span class="token comment">//锁定代码快，以便线程同步</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>Name <span class="token operator">+</span> <span class="token string">"------票数"</span> <span class="token operator">+</span> num<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Program</span> p<span class="token operator">=</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Program</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> ta <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Thread</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ta<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"线程一"</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> tb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Thread</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tb<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"线程二"</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> tc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Thread</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tc<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"线程三"</span><span class="token punctuation">;</span>
            <span class="token class-name">Thread</span> td <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Thread</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            td<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"线程四"</span><span class="token punctuation">;</span>
            ta<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tb<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tc<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            td<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>执行结果如下图所示：<br> <img src="https://images2.imgbox.com/a6/95/gIFncHE3_o.png" alt="在这里插入图片描述"></p> 
<p>说明：4个线程调用的是同一个函数，<strong>同一时间，一次只允许一个线程进入</strong>，每次执行将票数减一，线程执行的顺序尽管是无序的，但是执行的“票数”都是在上一次的结果上减1。<br> 倘若注释同步代码，即<code>//lock (this) //锁定代码快，以便线程同步</code>，执行结果如下图所示，同一时间，多个线程进入同一函数，<strong>线程顺序无序，执行结果也无序</strong>，“票数3”同时被“线程四”和“线程一”执行。<br> 现实情况中，当不考虑退票时，票数应该是越卖越少，且不会出现多人购买同一张票都成功的现象。如果不使用线程同步的写法，得不到想要的功能。<br> <img src="https://images2.imgbox.com/1f/ea/KwD7M45t_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="612_monitor_591"></a>6.1.2 monitor类</h5> 
<p>Monitor类提供了与lock类似的功能,<strong>不过与lock不同的是,它能更好的控制同步块</strong>,当<strong>调用了Monitor的Enter(Object o)方法时,会获取o的独占权,直到调用Exit(Object o)方法时,才会释放对o的独占权</strong>。<br> 可以使用 TryEnter() 方法可以给它传送一个超时值，决定等待获得对象锁的最长时间，该方法能在指定的毫秒数内结束线程，这样能避免线程之间的死锁现象。</p> 
<pre><code class="prism language-csharp"><span class="token class-name"><span class="token keyword">bool</span></span> lockTaken<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
            Monitor<span class="token punctuation">.</span><span class="token function">TryEnter</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token keyword">ref</span> lockTaken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>lockTaken<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//Synchronized part</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">finally</span>
                <span class="token punctuation">{<!-- --></span>
                    Monitor<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//don't aquire the lock, excute other parts</span>
            <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="62__611"></a>6.2 线程异步</h4> 
<p>异步与同步概念：<em><strong>当一个方法被调用时，调用者需要等待该方法执行完毕并返回才能继续执行，我们称这个方法是同步方法；当一个方法被调用时立即返回，并获取一个线程执行该方法内部的业务，调用者不用等待该方法执行完毕，我们称这个方法为异步方法</strong></em><br> 异步方法的优点：异步线程最大的好处在于<em><strong>非阻塞</strong></em>，即各线程之间执行任务时，互不干扰，当任务完成之后就可立即响应，不需等待其他任务是否执行完成。异步编程中最好用的便是 async和await 。<br> 在C#5.0中出现的 async和await ，让异步编程变得更简单，<em><strong>用同步的写法写异步</strong></em>，<em><strong>同步代码的逻辑结构</strong></em></p> 
<p>线程异步与多任务执行关系：<em><strong>异步是同时执行多个任务，而Task则是允许多个任务可以在线程内同时进行，多任务的同时进行，则是由异步来进行，而异步方法，必须为Task</strong></em></p> 
<h5><a id="621_asyncawait_617"></a>6.2.1 控制台应用async和await</h5> 
<p>不加await修饰代码如下，即为多线程常规流程执行方式</p> 
<pre><code class="prism language-csharp"><span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"开始"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"T "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"S "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>执行结果如下：<br> <img src="https://images2.imgbox.com/5e/27/sviiI8gj_o.png" alt="在这里插入图片描述"><br> 或者<img src="https://images2.imgbox.com/0b/29/7EMt4HVa_o.png" alt="在这里插入图片描述"><br> 如上的执行结果，未阻塞主线程，两次执行结果，S在上或者T在上，这是任务内部无序执行的结果，具体情况与***## 4.Task常用的API***常规流程方式一致</p> 
<p>加await修饰代码如下：</p> 
<pre><code class="prism language-csharp"> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"开始"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"T "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"S "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>执行结果如下图所示：<br> <img src="https://images2.imgbox.com/68/da/OFyf6s3c_o.png" alt="在这里插入图片描述"><br> 如上图所示，未阻塞主线程执行，而在task内部，<em><strong>函数执行变得有序起来</strong></em>，不论执行多少次，T永远在S上面，通过异步之间的await进程等待，避免不必要的资源占用和浪费。有点类似于上述API函数中介绍的方法，但是API函数中的方法会阻塞主线程。</p> 
<h5><a id="622_Winfromasyncawait_692"></a>6.2.2 Winfrom界面async和await</h5> 
<p>例子实现功能：当点击button1启动按钮时，运行一个任务，任务结束时要报告是否成功，如果成功button2就显示绿色图标、如果失败就显示红色图标，1秒后图标颜色恢复为白色；任务运行期间启动按钮要不可用，<br> 界面布局如图所示：<br> <img src="https://images2.imgbox.com/74/b2/q2I815CS_o.png" alt="在这里插入图片描述"></p> 
<p>常规代码实现方式：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Form1</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Form</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">btnStart_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>btnStart<span class="token punctuation">.</span>Enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>Green<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>Red<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           
            <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>White<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>btnStart<span class="token punctuation">.</span>Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>运行情况：启动程序，此时程序界面是可以拖动的，点击按钮1，程序界面被阻塞，无法拖动，此时开始执行<code>DoSomething</code>方法，返回结果为true，进入判断执行<code>this.picShow.BackColor = Color.Green</code>，立即执行<code>this.picShow.BackColor = Color.White;</code>，此时无法看到界面按钮2变为绿色，想要功能无法实现。<br> 问题分析：<br> 1、运行期间UI线程阻塞了，用户界面没有响应；<br> 2、根本不能实现需求，点击启动后，程序卡死6秒种，也没有看到颜色变化，因为UI线程已经阻塞，当重新获得句柄时图标已经是白色了。<br> 以下采用多任务实现具体需求，代码如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Form1</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Form</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token function">Form1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">btnStart_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>btnStart<span class="token punctuation">.</span>Enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> 
            <span class="token punctuation">{<!-- --></span>  
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>Green<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>Red<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   
                <span class="token punctuation">}</span>

                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Action</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>btnStart<span class="token punctuation">.</span>Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>White<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">DoSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>代码特点：将颜色变化功能统一放置task中执行，同一个任务中，<em><strong>代码按顺序执行</strong></em>，执行顺序<code>this.picShow.BackColor = Color.Green;</code>–<code>Thread.Sleep(1000);</code>–<code>this.picShow.BackColor = Color.White;</code>因此可看到颜色变化。<br> 功能基本可以实现，但存在以下问题：<br> 1、主线程的btnStart_Click方法除了启动一个任务以外，啥事也没干，线程是在后台执行的。<br> 2、由于非UI线程不能访问UI控件，代码里有很多Invoke，比较丑陋；<br> 3、<em><strong>界面逻辑和业务逻辑掺和在一起，使得代码难以理解。</strong></em></p> 
<p>以下采用async和await 异步编程的方式解决上述问题，代码如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Form1</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Form</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token function">Form1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">btnStart_ClickAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>btnStart<span class="token punctuation">.</span>Enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>Green<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>Red<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>White<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>btnStart<span class="token punctuation">.</span>Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>代码特点：<code>DoSomethingAsync</code>函数带有返回值，此函数中添加async和await ，代码执行顺序<code>DoSomethingAsync</code>–<code>this.picShow.BackColor = Color.Green</code>–<code>await Task.Delay(1000)</code>–<code>this.picShow.BackColor = Color.White</code>，和上述功能正常程序一致，但是添加async和await，让程序按照一定顺序执行，即执行完DoSomethingAsync之后，才会执行后续任务。思维模式：<em><strong>以编写同步代码的方式编写异步</strong></em><br> 为加深理解，将上述代码去掉async和await，改写成如下形式：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Form1</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Form</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">bool</span></span> a <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">Form1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span>  <span class="token return-type class-name"><span class="token keyword">void</span></span>  <span class="token function">btnStart_ClickAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>btnStart<span class="token punctuation">.</span>Enabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>btnStart<span class="token punctuation">.</span>Visible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

             <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>Green<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>Red<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

             Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>picShow<span class="token punctuation">.</span>BackColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>White<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>btnStart<span class="token punctuation">.</span>Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>btnStart<span class="token punctuation">.</span>Visible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span>  <span class="token return-type class-name"><span class="token keyword">void</span></span>  <span class="token function">DoSomethingAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
             Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                a <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>执行结果：按钮1一直处于可见状态，DoSomethingAsync函数相当于没有执行，按钮2变为红色的瞬间变为白色，是看不到颜色变化的，Task.Delay是在后台运行，整个程序相当于什么也没有执行。<br> 这里如果还不是很清除加与不加async和await的区别，请参考<a href="https://learn.microsoft.com/zh-cn/dotnet/csharp/asynchronous-programming/task-asynchronous-programming-model" rel="nofollow">添加链接描述</a></p> 
<h4><a id="63__872"></a>6.3 异步并发</h4> 
<p>并行：两队人，进入一个门，每队每次轮流进一个，这称之为并发<br> 并发：两队人，分别进入两个门，各进各的，这称之为并行.</p> 
<h3><a id="7_875"></a>7.线程调试方法</h3> 
<p>线程是系统后台分配内存空间执行相应任务，当线程创建的越多，后台执行越容易出现莫名其妙的BUG，达不到想要的功能。例如后台执行100个线程，传入共同参数X，所有线程执行完，得到结果Y，而实际想要得到的结果为Z，100个线程在后台执行的先后是无序的，即线程执行会<em><strong>跳来跳去</strong></em>。<br> 常用的调试方法打断点是行不通的，因为断点的焦点会在线程之间“反复横跳”，根本无法集中跟踪某一个线程的操作链路，打断点也不是按顺序执行，不可能100个线程每个入口都打上断点，如何确认是在哪一个线程或多个线程执行环节出现问题？除了上述***## 4.task中常用API***函数外，以下简介其他方式调试多线程。<br> <a href="https://learn.microsoft.com/zh-cn/visualstudio/debugger/get-started-debugging-multithreaded-apps?view=vs-2022&amp;tabs=csharp" rel="nofollow">添加链接描述</a></p> 
<h4><a id="71__879"></a>7.1 多线程界面调试方法</h4> 
<p>1.以***## 4.Task常用的API***常规流程为例，断点处右击选择条件，如下图所示，条件文本框中可编写调试条件。<br> <img src="https://images2.imgbox.com/e9/19/DuWjV6Ln_o.png" alt="在这里插入图片描述"><br> 2.debug模式下启动程序，点击“调试-窗体-线程”，如下图所示。<br> <img src="https://images2.imgbox.com/66/c7/IYjtxCY4_o.png" alt="在这里插入图片描述"><br> 3.运行后，执行到断点处，如下图所示，进程处会显示当前线程ID。<br> <img src="https://images2.imgbox.com/19/4b/RpbtGg70_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="72__886"></a>7.2 多线程界面调试实操</h4> 
<p>如上所述，多线程运行时，线程之间无序，常规断点方式也无法进行，最主要的原因在于<em><strong>无法锁定某一个线程</strong></em>，因此我们需要想办法<em><strong>锁定某一个线程，让这个线程一直运行下去，查看锁定的线程是否有问题</strong></em><br> 简单案例代码如下，<code>for (int i = 0; i &lt; 100; i++)</code>处打断点，</p> 
<pre><code class="prism language-csharp"><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Task<span class="token punctuation">[</span><span class="token punctuation">]</span></span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Task</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> task<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                task<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>Do<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Task<span class="token punctuation">.</span><span class="token function">WaitAll</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">int</span></span> x <span class="token operator">=</span> Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId<span class="token punctuation">;</span>
            <span class="token comment">//循环调试</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>具体操作见如下视频：<br> <a href="https://member.bilibili.com/platform/upload-manager/article?group=is_pubing&amp;page=1" rel="nofollow">添加链接描述</a></p> 
<h3><a id="8_916"></a>8.多线程异常处理</h3> 
<h4><a id="81__917"></a>8.1 单线程异常与多线程异常比对</h4> 
<p>单线程处理：try-catch，catch中进行异常处理，捕捉异常----处理异常</p> 
<pre><code class="prism language-csharp">			<span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//捕捉异常</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span><span class="token punctuation">;</span>
                    <span class="token comment">//处理异常</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
</code></pre> 
<p>多线程处理：无法直接用try-catch包裹</p> 
<h4><a id="82__937"></a>8.2 单线程与多线程案列</h4> 
<p>界面布局如下图：<br> <img src="https://images2.imgbox.com/00/10/SwvdyPlz_o.png" alt="在这里插入图片描述"><br> 单线程异常处理代码：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">button1_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> 
                <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name"><span class="token keyword">string</span></span> k <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"button2_Click</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">i</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"button2_Click8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"k==button2_Click8异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"button2_Click10"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"k==button2_Click10异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"button2_Click15"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"k==button2_Click15异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> 
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>将程序断点打在catch 处，运行时，会进入点内的内容，如下图所示<br> <img src="https://images2.imgbox.com/b2/54/4s4o6syG_o.png" alt="在这里插入图片描述"><br> 多线程异常处理先仿照单线程方式，代码如下：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">button2_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name"><span class="token keyword">string</span></span> k <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"button2_Click</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">i</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
                    Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"button2_Click2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"k==button2_Click8异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"button2_Click10"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"k==button2_Click10异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"button2_Click15"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"k==button2_Click15异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>断点分别打在3个异常处及catch处，运行程序如下图所示<br> <img src="https://images2.imgbox.com/4d/ef/Sxj221BD_o.png" alt="在这里插入图片描述"><br> 断点可以进入异常处，<em><strong>无法进入catch处，即程序确实有异常发生，被捕捉到了，但是无法处理异常</strong></em>，异常被<em><strong>吞掉了</strong></em><br> 综上所述，<em><strong>常规单线程处理异常的方式无法在多线程使用，即无法直接用try-catch包裹代码，捕获异常、处理异常</strong></em></p> 
<h4><a id="83__1010"></a>8.3 多线程异常捕捉与处理</h4> 
<p>那么多线程内部发生的异常如何捕捉？需实现以下2大条件<br> 1.<em><strong>需要做线程的等待</strong></em>,例如task.waitall，<em><strong>即阻塞主线程</strong></em><br> 2.<em><strong>try-catch包裹</strong></em><br> 将上述多线程的代码改写成如下形式：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">button2_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&gt;</span></span> list1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Task<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name"><span class="token keyword">string</span></span> k <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"button2_Click</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">i</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">;</span>
                    <span class="token comment">//线程列表</span>
                    list1<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"button2_Click2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"k==button2_Click8异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"button2_Click10"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"k==button2_Click10异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token string">"button2_Click15"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"k==button2_Click15异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Task<span class="token punctuation">.</span><span class="token function">WaitAll</span><span class="token punctuation">(</span>list1<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//等待线程完成</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>主要增加代码内容为：将所有线程放在线程列表中，添加<code>Task.WaitAll(list1.ToArray());</code><em><strong>阻塞线程</strong></em>。<br> 断点分别打在3个异常处及catch处，异常可进去，也可以捕获。<br> 捕获异常详细情况如下图所示：<br> <img src="https://images2.imgbox.com/c5/de/vjQIe6C1_o.png" alt="在这里插入图片描述"><br> 捕获的3个异常恰为发生异常，点击“快速监视”，查看“ex”的类型，如下图所示：<br> <img src="https://images2.imgbox.com/c5/4b/JSAUDGuO_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="84__1055"></a>8.4 多线程中多个异常捕获</h4> 
<p>上述例子中多线程出现3个异常，只用了一个“try-catch”结构，集中显示异常情况，对于异常查看并不方便，解决上述问题，采用如下方式。<br> <em><strong>1.一个try可以对应多个catch<br> 2.AggregateException捕获异常，多线程特有异常捕获，AggregateException继承至Exception，Exception子类，AggregateException内部包含多线程集合</strong></em><br> 上述多线程例子中try-catch部分换成如下情况，<br> <img src="https://images2.imgbox.com/6b/04/v1mEjaB8_o.png" alt="在这里插入图片描述"><br> 会弹出3此提示框，告知出现的异常情况，3个异常不仅能够捕获，也可显示。</p> 
<h3><a id="8_1062"></a>8.总结</h3> 
<p>C#多线程最常用的方式就是Task，本文主要针对task做了详细的描述，较全面的总结了多线程使用的方式，文中资料与代码实例参考引用文献较多。文章目的不为赚米，只为学习C#中多线程做笔记，加深对线程理解与使用。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fe2bb48e5f58577ae5eff7d7553043c3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python筑基之旅-MySQL数据库(一)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80d45b581ccb2f44bf5a953b384b77c6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Midjourney 参数列表 --no&amp;--q&amp;--r&amp;--seed&amp;--style raw</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>