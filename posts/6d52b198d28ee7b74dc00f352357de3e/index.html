<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Java面试——Tomcat - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/6d52b198d28ee7b74dc00f352357de3e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Java面试——Tomcat">
  <meta property="og:description" content="优质博文：IT_BLOG_CN
一、Tomcat 顶层架构 Tomcat中最顶层的容器是Server，代表着整个服务器，从上图中可以看出，一个Server可以包含至少一个Service，用于具体提供服务。Service主要包含两个部分：Connector和Container。从上图中可以看出Tomcat的心脏就是这两个组件，他们的作用如下：
【1】Connector用于处理连接相关的事情，并提供Socket与Request和 Response相关的转化；
【2】Container用于封装和管理Servlet，以及具体处理Request请求；
一个Tomcat中只有一个Server，一个Server可以包含多个Service，一个 Service只有一个Container，但是可以有多个Connectors，这是因为一个服务可以有多个连接，如同时提供Http和Https链接，也可以提供向相同协议不同端口的连接，示意图如下（Engine、Host、Context下边会说到）：
多个Connector和一个Container就形成了一个Service，有了Service就可以对外提供服务了，但是Service还要一个生存的环境，必须要有人能够给她生命、掌握其生死大权，那就非Server莫属了！所以整个Tomcat的生命周期由 Server控制。另外，上述的包含关系或者说是父子关系，都可以在tomcat的 conf目录下的 server.xml 配置文件中看出。
二、简要解释下 server.xml 配置文件的信息 server.xml是Tomcat中最重要的配置文件，server.xml的每个元素都对应了 Tomcat中的一个组件；通过对xml文件中元素的配置，可以实现对Tomcat中各个组件的控制。
&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;Server port=&#34;8005&#34; shutdown=&#34;SHUTDOWN&#34;&gt; &lt;Listener className=&#34;org.apache.catalina.startup.VersionLoggerListener&#34;/&gt; &lt;Listener SSLEngine=&#34;on&#34; className=&#34;org.apache.catalina.core.AprLifecycleListener&#34;/&gt; &lt;Listener className=&#34;org.apache.catalina.core.JasperListener&#34;/&gt; &lt;Listener className=&#34;org.apache.catalina.core.JreMemoryLeakPreventionListener&#34;/&gt; &lt;Listener className=&#34;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&#34;/&gt; &lt;Listener className=&#34;org.apache.catalina.core.ThreadLocalLeakPreventionListener&#34;/&gt; &lt;GlobalNamingResources&gt; &lt;Resource auth=&#34;Container&#34; description=&#34;User database that can be updated and saved&#34; factory=&#34;org.apache.catalina.users.MemoryUserDatabaseFactory&#34; name=&#34;UserDatabase&#34; pathname=&#34;conf/tomcat-users.xml&#34; type=&#34;org.apache.catalina.UserDatabase&#34;/&gt; &lt;/GlobalNamingResources&gt; &lt;Service name=&#34;Catalina&#34;&gt; &lt;Connector port=&#34;8080&#34; protocol=&#34;HTTP/1.1&#34; connectionTimeOut=&#34;20000&#34; redirectPort=&#34;8443&#34;/&gt; &lt;Connector port=&#34;8009&#34; protocol=&#34;AJP/1.3&#34; redirectPort=&#34;8443&#34;/&gt; &lt;Engine defaultHost=&#34;localhost&#34; name=&#34;Catalina&#34;&gt; &lt;Realm className=&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-31T10:26:15+08:00">
    <meta property="article:modified_time" content="2024-07-31T10:26:15+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Java面试——Tomcat</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>优质博文：<a href="https://it-blog-cn.com/blogs/interview/tomcat.html" rel="nofollow">IT_BLOG_CN</a></p> 
<h3><a id="Tomcat__1"></a>一、Tomcat 顶层架构</h3> 
<p><img src="https://images2.imgbox.com/87/03/0o2ChVi2_o.png" alt="img"></p> 
<p><code>Tomcat</code>中最顶层的容器是<code>Server</code>，代表着整个服务器，从上图中可以看出，一个<code>Server</code>可以包含至少一个<code>Service</code>，用于具体提供服务。<code>Service</code>主要包含两个部分：<code>Connector</code>和<code>Container</code>。从上图中可以看出<code>Tomcat</code>的心脏就是这两个组件，他们的作用如下：<br> 【1】<code>Connector</code>用于处理连接相关的事情，并提供<code>Socket</code>与<code>Request</code>和 <code>Response</code>相关的转化；<br> 【2】<code>Container</code>用于封装和管理<code>Servlet</code>，以及具体处理<code>Request</code>请求；</p> 
<p>一个<code>Tomcat</code>中只有一个<code>Server</code>，一个<code>Server</code>可以包含多个<code>Service</code>，一个 <code>Service</code>只有一个<code>Container</code>，但是可以有多个<code>Connectors</code>，这是因为一个服务可以有多个连接，如同时提供<code>Http</code>和<code>Https</code>链接，也可以提供向相同协议不同端口的连接，示意图如下（<code>Engine</code>、<code>Host</code>、<code>Context</code>下边会说到）：<br> <img src="https://images2.imgbox.com/40/93/4pQrWTap_o.png" alt="img"></p> 
<p>多个<code>Connector</code>和一个<code>Container</code>就形成了一个<code>Service</code>，有了<code>Service</code>就可以对外提供服务了，但是<code>Service</code>还要一个生存的环境，必须要有人能够给她生命、掌握其生死大权，那就非<code>Server</code>莫属了！所以整个<code>Tomcat</code>的生命周期由 <code>Server</code>控制。另外，上述的包含关系或者说是父子关系，都可以在<code>tomcat</code>的 <code>conf</code>目录下的<code> server.xml</code> 配置文件中看出。</p> 
<h3><a id="_serverxml__13"></a>二、简要解释下 server.xml 配置文件的信息</h3> 
<p><code>server.xml</code>是<code>Tomcat</code>中最重要的配置文件，<code>server.xml</code>的每个元素都对应了 <code>Tomcat</code>中的一个组件；通过对<code>xml</code>文件中元素的配置，可以实现对<code>Tomcat</code>中各个组件的控制。</p> 
<pre><code class="prism language-html"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8005<span class="token punctuation">"</span></span> <span class="token attr-name">shutdown</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SHUTDOWN<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.startup.VersionLoggerListener<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">SSLEngine</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>on<span class="token punctuation">"</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.core.AprLifecycleListener<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.core.JasperListener<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.core.JreMemoryLeakPreventionListener<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.mbeans.GlobalResourcesLifecycleListener<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Listener</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.core.ThreadLocalLeakPreventionListener<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>GlobalNamingResources</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Resource</span> <span class="token attr-name">auth</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Container<span class="token punctuation">"</span></span> 
              <span class="token attr-name">description</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>User database that can be updated and saved<span class="token punctuation">"</span></span>  
              <span class="token attr-name">factory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.users.MemoryUserDatabaseFactory<span class="token punctuation">"</span></span> 
              <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserDatabase<span class="token punctuation">"</span></span> <span class="token attr-name">pathname</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>conf/tomcat-users.xml<span class="token punctuation">"</span></span> 
              <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.UserDatabase<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>GlobalNamingResources</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Service</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8080<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HTTP/1.1<span class="token punctuation">"</span></span> 
               <span class="token attr-name">connectionTimeOut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20000<span class="token punctuation">"</span></span> 
               <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8009<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AJP/1.3<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Engine</span> <span class="token attr-name">defaultHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Realm</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.realm.LockOutRealm<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Realm</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.realm.UserDatabaseRealm<span class="token punctuation">"</span></span> <span class="token attr-name">resourceName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserDatabase<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Realm</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Host</span> <span class="token attr-name">appBase</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>webapps<span class="token punctuation">"</span></span> <span class="token attr-name">autoDeploy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span> <span class="token attr-name">unpackWARs</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Valve</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.apache.catalina.valves.AccessLogValve<span class="token punctuation">"</span></span> <span class="token attr-name">directory</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logs<span class="token punctuation">"</span></span> <span class="token attr-name">pattern</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>%h %l %u %t <span class="token entity named-entity" title='"'>&amp;quot;</span>%r<span class="token entity named-entity" title='"'>&amp;quot;</span> %s %b<span class="token punctuation">"</span></span> <span class="token attr-name">prefix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost_access_log.<span class="token punctuation">"</span></span> <span class="token attr-name">suffix</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.txt<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span> <span class="token attr-name">docBase</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cas-server-webapp<span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/cas<span class="token punctuation">"</span></span> <span class="token attr-name">reloadable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> 
                 <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.eclipse.jst.j2ee.server:cas-server-webapp<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span> <span class="token attr-name">docBase</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>portal<span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/portal<span class="token punctuation">"</span></span> <span class="token attr-name">reloadable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> 
                 <span class="token attr-name">source</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.eclipse.jst.jee.server:portal<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Host</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Engine</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Service</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><code>server.xml</code>的整体架构（简洁版）：</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Service</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Engine</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Host</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span> <span class="token punctuation">/&gt;</span></span><span class="token comment">&lt;!-- 现在常常使用自动部署，不推荐配置Context元素，Context小节有详细说明 --&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Host</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Engine</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Service</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>【1】<strong>顶层元素：</strong>元素是整个配置文件的根元素，元素代表一个<code>Engine</code>元素以及一组与之相连的<code>Connector</code>元素。<br> 【2】<strong>连接器：</strong> 代表了外部客户端发送请求到特定<code>Service</code>的接口；同时也是外部客户端从特定<code>Service</code>接收响应的接口。<br> 【3】<strong>容器：</strong>容器的功能是处理<code>Connector</code>接收进来的请求，并产生对应的响应。<code>Engine</code>包含<code>Host</code>，<code>Host</code>包含<code>Context</code>。一个 <code>Engine</code>组件可以处理<code>Service</code>中的所有请求，一个<code>Host</code>组件可以处理发向一个特定虚拟主机的所有请求，一个<code>Context</code>组件可以处理一个特定<code>Web</code>应用的所有请求。</p> 
<h3><a id="Tomcat__73"></a>三、Tomcat 都有哪些核心组件</h3> 
<p>【1】<strong><code>Server</code>：</strong><code>Server</code>元素在最顶层，代表整个 <code>Tomcat</code>容器，因此他必须是<code>server.xml</code>中唯一一个最外层的元素。一个<code>Server</code>元素可以有一个或多个<code>Service</code>元素。</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8005<span class="token punctuation">"</span></span> <span class="token attr-name">shutdown</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SHUTDOWN<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>可以看到，最外层有一个 元素，<code>shutdown</code>属性表示关闭<code>Server</code>的指令；<code>port</code>属性表示<code>Server</code>接收<code>shutdown</code>指令的端口号，设置为<code>-1</code>可以禁掉该端口。Server 的主要任务，就是提供一个接口让客户端能够访问到这个 Service集合，同时维护它所包含的所有的 Service的生命周期，包含如何初始化，如何结束服务，如何找到客户端要访问的 Service。<br> 【2】<strong><code>Service</code>：</strong>在<code>Connector</code>和<code>Engine</code>外面包一层，把它们组合在一起，对外提供服务。一个<code>Service</code>可以包含多个<code>Connector</code>，但是只能包含一个<code>Engine</code>；其中<code>Connector</code>的作用是从客户端接收请求，<code>Engine</code>的作用是处理接收进来的请求。</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8005<span class="token punctuation">"</span></span> <span class="token attr-name">shutdown</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SHUTDOWN<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Service</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Service</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>如上图，<code>Server</code>中包含一个名称为<code>Catalina</code>的<code>Service</code>。实际上，<code>Tomcat</code>可以提供多个<code>Service</code>，不同的<code>Service</code>监听不同的端口。<br> 【3】<strong><code>Connector</code>：</strong>接收连接请求，创建<code>Request</code>和 <code>Response</code>对象用于和请求端交换数据；然后分配线程让<code>Engine</code>来处理这个请求，并把产生的<code>Request</code>和<code>Response</code>对象传给<code>Engine</code>。通过配置 <code>Connector</code>，可以控制请求 Service的协议及端口号。</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8005<span class="token punctuation">"</span></span> <span class="token attr-name">shutdown</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SHUTDOWN<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Service</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8080<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HTTP/1.1<span class="token punctuation">"</span></span> <span class="token attr-name">connectionTimeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20000<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8009<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AJP/1.3<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Service</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>通过配置第一个<code>Connector</code>，客户端可以通过<code>8080</code>端口号协议访问<code>Tomcat</code>。其中，<code>protocol</code>属性规定了请求的协议，<code>port</code>规定了请求的端口号，<code>redirectPort</code>表示当强制要求<code>https</code>而请求是 http时，重定向至端口号为<code>8443</code>的<code>Connector</code>，<code>connectionTimeout</code>表示连接的超时时间。</p> 
<p>在这个例子中，<code>Tomcat</code>监听<code>Http</code>请求，使用的是<code>8080</code>端口，而不是正式的 <code>80</code>端口；实际上，在正式的生产环境中，<code>Tomcat</code>也常常监听<code>8080</code>端口。而不是<code>80</code>端口。这是因为在生产环境中，很少讲<code>Tomcat</code>直接对外开放接收请求，而是在<code>Tomcat</code>和客户端之间加一层代理服务器（如<code>Nginx</code>），用于请求的转发、负载均衡、处理静态文件等；通过代理服务器访问<code>Tomcat</code>时，是在局域网中，因为一般仍使用<code>8080</code>端口。</p> 
<p>第二个配置<code>Connector</code>，客户端可以通过<code>8009</code>端口使用<code>AJP</code>协议访问 <code>Tomcat</code>。<code>AJP</code>协议负责和其他的<code>Http</code>服务器（如<code>Apache</code>）建立连接；在把 <code>Tomcat</code>与其他服务器集成时，就需要用到这个<strong>连接器</strong>，之所以使用 <code>Tomcat</code>和其他服务器集成，是因为<code>Tomcat</code>可以用作<code>Servlet/JSP</code>容器，但是对静态资源处理速度较慢，不如<code>Apache</code>和<code>IIS</code>等<code>HTTP</code>服务器；因此常常将 <code>Tomcat</code>和<code>Apache</code>等集成，前者做<code>Servlet</code>容器，后者处理静态资源，而<code>AJP</code>协议便负责<code>Tomcat</code>与<code>Apache</code>的连接。<code>Tomcat</code>和<code>Apache</code>等集成的原理如下图：<br> <img src="https://images2.imgbox.com/1c/46/yWoza30K_o.png" alt="img"><br> 【4】<strong><code>Engine</code>：</strong>Engine 组件在<code>Service</code>组件有且只有一个；<code>Engine</code>是<code>Service</code>组件中的请求处理组件。<code>Engine</code>组件从一个或多个<code>Connector</code>中接收并处理，并将完成的响应返回给<code>Connector</code>，最终传递给客户端。前面说到，<code>Engine</code>、<code>Host</code>和<code>Context</code>都是容器，但是它们不是平行关系，而是父子关系：<code>Engine</code>包含<code>Host</code>，<code>Host</code>包含<code>Context</code>。</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8005<span class="token punctuation">"</span></span> <span class="token attr-name">shutdown</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SHUTDOWN<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Service</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8080<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HTTP/1.1<span class="token punctuation">"</span></span> <span class="token attr-name">connectionTimeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20000<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8009<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AJP/1.3<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Engine</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span> <span class="token attr-name">defaultHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Engine</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Service</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>其中<code>name</code>属性用于日志和错误信息，在整个<code>Server</code>中应该是唯一的。<code>defalutHost</code>属性指定了默认的<code>host</code>名称，当发往本机的请求指定的<code>host</code>名称不存在时，一律使用<code>defaultHost</code>指定的<code>host</code>进行处理；因此<code>defaulthost</code>的值，必须与<code>Engine</code>中的一个<code>Host</code>组件的<code>name</code>属性值匹配。<br> 【5】<strong><code>Engine</code>和<code>Host</code>：</strong><code>Host</code>是<code>Engine</code>的子容器。<code>Engine</code>组件中可以内嵌<code>1</code>个或者多个<code>Host</code>组件，每个<code>Host</code>组件代表<code>Engine</code>中的一个虚拟主机。<code>Host</code>组件至少有一个，且其中一个的<code>name</code>必须与 <code>Engine</code>组件中的<code>defaultHost</code>属性相匹配。<br> 【6】<strong><code>Host</code>的作用：</strong><code>Host</code>虚拟主机的作用，是运行多个<code>Web</code>应用（一个<code>Context</code>代表一个<code>Web</code>应用），并负责安装、展开、启动、结束每个<code>Web</code>应用。<code>Host</code>组件代表的虚拟主机，对应服务器中一个网络名实体（如<code>www.test.com](https://links.jianshu.com/go?to=http%3A%2F%2Fwww.test.com)"或IP地址"116.25.25.25</code>）；为了使用户可以通过网络名连接<code>Tomcat</code>服务器，这个名字应该在<code>DNS</code>服务器上注册。</p> 
<p>客户端通常使用主机名来标识它们希望连接的服务器，该主机名也会包含在 <code>HTTP</code>请求头中，<code>Tomcat</code>从<code>HTTP</code>头中提取出主机名，寻找名字匹配的主机。如果没有匹配，请求会发送至默认的主机。因此默认主机不需要再<code>DNS</code>服务器中注册网络名，因为任何与所有<code>Host</code>名称不匹配的请求，都会路由至默认主机。<br> 【7】<strong><code>Host</code>的配置：</strong><code>name</code>属性指定虚拟主机的主机名，一个<code>Engine</code>有且只有一个<code>Host</code>组件的<code>name</code>属性和<code>Engine</code>组件的 <code>defaultHost</code>属性相匹配；一般情况下，主机名需要是在<code>DNS</code>服务器中注册网络名，但是<code>Engine</code>指定的<code>defaultHost</code>不需要。</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Server</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8005<span class="token punctuation">"</span></span> <span class="token attr-name">shutdown</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SHUTDOWN<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Service</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8080<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>HTTP/1.1<span class="token punctuation">"</span></span> <span class="token attr-name">connectionTimeout</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20000<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Connector</span> <span class="token attr-name">port</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8009<span class="token punctuation">"</span></span> <span class="token attr-name">protocol</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>AJP/1.3<span class="token punctuation">"</span></span> <span class="token attr-name">redirectPort</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8443<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Engine</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Catalina<span class="token punctuation">"</span></span> <span class="token attr-name">defaultHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Host</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost<span class="token punctuation">"</span></span> <span class="token attr-name">appBase</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>webapps<span class="token punctuation">"</span></span> <span class="token attr-name">unpackWARs</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">autoDeploy</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Host</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Engine</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Service</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Server</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><code>unpackWARs</code>指定了是否将代表<code>Web</code>应用的<code>WAR</code>文件解压；如果是<code>true</code>，通过解压后的文件结构运行该<code>Web</code>应用，如果是<code>false</code>，直接使用<code>WAR</code>文件运行<code>Web</code>应用。<br> 【8】<strong><code>Context</code>：</strong><code>Context</code>元素代表在虚拟主机上运行的一个<code>Web</code>应用。在后文中，提到<code>Context</code>、应用或<code>Web</code>应用，他们都代指<code>Web</code>应用，每个<code>Web</code>应用基于<code>WAR</code>文件，或<code>WAR</code>文件解压后对应的目录（这里称为应用目录）<code>Context</code>是<code>Host</code>的子容器，每个<code>Host</code>都可以定义任意多的<code>Context</code>元素。元素的配置：<code>Context</code>元素最重要的属性是 <code>docBase</code>和<code>path</code>，此外<code>reloadable</code>属性也比较常用。</p> 
<p><code>docBase</code>指定了该<code>Web</code>应用使用<code>war</code>包路径，或应用目录。需要注意的是：在自动部署场景下（配置文件位于<code>xmlBase</code>中），<code>docBase</code>不在<code>appBase</code>目录中，才需要指定；如果<code>docBase</code>指定的<code>war</code>包或应用目录就在<code>appBase</code>中，则不需要指定。因为<code>Tomcat</code>会自动扫描<code>appBase</code>中的<code>war</code>包和应用目录，制定了反而造成问题。</p> 
<p><code>path</code>指定了访问该<code>Web</code>应用上下文路径，当请求到来时，<code>Tomcat</code>根据<code>Web</code>应用的<code>path</code>属性与 URL匹配程度来选择<code>Web</code>应用处理相应请求。例如：<code>Web</code> 应用<code>app1</code>的<code>path</code>属性是<code>/app1</code>，<code>Web</code>应用<code>app2</code>的<code>path</code>属性是"/app2"，那么请求<code>/app1/index.html</code>会交由<code>app1</code>来处理；而请求<code>/app2/index.html</code>会交由 <code>app2</code>来处理。如果一个<code>Context</code>元素的<code>path</code>属性为""，那么这个<code>Context</code>是虚拟主机的默认的<code>Web</code>应用；当请求的<code>uri</code>与所有的<code>path</code>都不匹配时，使用该默认<code>Web</code>应用来处理。</p> 
<p>但是，需要注意的是，在自动部署场景（配置文件位于<code>xmlBase</code>中），不能指定path属性，<code>path</code>属性由配置的文件的文件名，<code>WAR</code>文件的文件名或应用目录的名称自动推导出来。如扫描<code>Web</code>应该时，发现<code>xmlBase</code>目录下的<code>app1.xml</code>，或<code>appBase</code>目录下的<code>app1.WAR</code>或<code>app1</code>应用目录，则该Web用于的<code>path</code>属性是<code>app1</code>。如果名称不是<code>app1</code>而是<code>ROOT</code>，则该Web应用时虚拟主机默认的<code>Web</code>应用，此时<code>path</code>属性推导为""。</p> 
<p><code>reloadable</code>属性指示<code>tomcat</code>是否在运行时监控在<code>WEB-INF/classes</code>和<code>WEB-INF/lib</code>目录下<code>class</code>文件的改动。如果值为<code>true</code>，那么当<code>class</code>文件改动时，会重新<code>web</code>应用的重新加载。在开发环境下，<code>reloadable</code>设置为<code>ture</code>便于调试；但是在生产环境中设置为<code>true</code>会给服务器带来性能压力，因此<code>reloadable</code>参数的默认值为<code>false</code>。在该例子中，<code>docBase</code>位于<code>Host</code>的<code>appBase</code>目录之外；<code>path</code>属性没有指定，而是根据<code>app1.xml</code>自动推导为<code>app1</code>。</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Context</span> <span class="token attr-name">docBase</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>D:\Program Files\app1.war<span class="token punctuation">"</span></span> <span class="token attr-name">reloadable</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Context</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>若是自动部署（即<code>autoDeploy="true"</code>），那么<code>server.xml</code>配置文件中没有<code>Context</code>元素的配置。这是因为<code>Tomcat</code>开启了自动部署，<code>Web</code>应用没有在 <code>server.xml</code>中配置静态部署，而是由<code>Tomcat</code>通过特定的规则自动部署。</p> 
<h3><a id="Web__164"></a>四、Web 的自动部署</h3> 
<p>要开启<code>Web</code>应用的自动部署，需要配置所在的虚拟主机；配置的方式就是在配置<code>Host</code>元素的 <code>deployOnStartup</code>和<code>autoDeploy</code>属性。如果<code>deployOnStartup</code>和<code>autoDeploy</code>设置为<code>true</code>，则<code>tomcat</code>启动自动部署：当检测到新的<code>Web</code>应用或<code>Web</code>应用更新时，会触发应用的部署（或重新部署）。</p> 
<p>二者的主要区别在于<br> 【1】<code>deployeOnStartup</code>为<code>true</code>时，<code>Tomcat</code>在启动时检查<code>Web</code>应用，且检测到所有的<code>Web</code>应用都试做新应用；<br> 【2】<code>autoDeploy</code>为<code>true</code>时，<code>Tomcat</code>在运行时定期检查新的<code>Web</code>应用或<code>Web</code>应用的更新；</p> 
<blockquote> 
 <p>通过配置<code>deployOnStartup</code>和<code>autoDeploy</code>可以开启虚拟主机自动部署<code>Web</code>应用；实际上，自动部署依赖于检查是否有新的或更改过的<code>Web</code>应用，而<code>Host</code>元素中的<code>appBase</code>和<code>xml</code>配置设置了检查<code>Web</code>应用更新的目录。</p> 
</blockquote> 
<p>其中，<code>appBase</code>属性指定<code>Web</code>应用所在的目录，默认值是<code>webapps</code>，这是一个相对路径，代表 <code>Tomcat</code>根目录下的<code>webapps</code>文件夹。<code>xmlBase</code>属性指定<code>Web</code>应用的<code>XML</code>配置文件所在的目录，默认值为<code>conf/&lt;engine_name&gt;&lt;engine_name&gt;</code>，例如上面例子中，主机<code>localhost</code>的<code>xmlBase</code>的默认值是<code>$TOMCAT_HOME/conf/Catalina/localhost</code>。</p> 
<h3><a id="appBase__docBase_174"></a>五、appBase 和 docBase的区别</h3> 
<p>【1】<strong><code>appBase</code>：</strong>这个目录下面的子目录将自动被部署为应用，且<code>war</code>文件将被自动解压缩并部署为应用，默认为<code>tomcat</code>下<code>webapps</code>目录。<br> 【2】<strong><code>docBase</code>：</strong>指定需要关联的项目自动解压并部署到<code>appBase</code>目录下。项目的名称由<code>path</code>属性决定。<br> 先部署 需要注意，<code>docBase</code>所在的文件或者<code>war</code>包必须存在。否则项目启动找不到对应的目录。此时文件解压到<code>appBase</code>目录下，根据<code>path</code>属性，决定解压后的文件名。<br> 若采用了<code>&lt;Host name="localhost" appBase="webapp" autoDeploy="true"&gt; </code>配置，那么<code>appBase</code>目录下的应用目录将会再次部署。此时项目是部署了两遍。解决办法，设置<code>autoDeploy="false"</code>。</p> 
<h3><a id="Tomcat__180"></a>六、Tomcat 顶层架构小结</h3> 
<p>【1】<code>Tomcat</code>中只有一个<code>Server</code>，一个<code>Server</code>可以有多个<code>Service</code>，一个<code>Service</code>可以有多个 <code>Connector</code>和一个<code>Container</code>；<br> 【2】<code>Server</code>掌管着整个<code>Tomcat</code>的生死大权；<br> 【3】<code>Service</code>是对外提供服务的；<br> 【4】<code>Connector</code>用于接受请求并将请求封装成<code>Request</code>和<code>Response</code>来具体处理；<br> 【5】<code>Container</code>用于封装和管理<code>Servlet</code>，以及具体处理<code>Request</code>请求；</p> 
<p>知道了整个<code>Tomcat</code>顶层的分层架构和各个组件之间的关系以及作用，对于绝大多数的开发人员来说 <code>Server</code>和<code>Service</code>对我们来说确实很远，而我们开发中绝大部分进行配置的内容是属于<code>Connector</code>和 <code>Container</code>的，所以接下来介绍一下<code>Connector</code>和<code>Container</code>。</p> 
<h3><a id="Connector__Container_189"></a>七、Connector 和 Container的微妙关系</h3> 
<p>由上述内容我们大致可以知道一个请求发送到<code>Tomcat</code>之后，首先经过<code>Service</code>然后会交给我们的 <code>Connector</code>，<code>Connector</code>用于接收请求并将接收的请求封装为<code>Request</code>和<code>Response</code>来具体处理，<code>Request</code>和<code>Response</code>封装完之后再交由<code>Container</code>进行处理，<code>Container</code>处理完请求之后再返回给 <code>Connector</code>，最后在由<code>Connector</code>通过<code>Socket</code>将处理的结果返回给客户端，这样整个请求的就处理完了！</p> 
<p><code>Connector</code>最底层使用的是<code>Socket</code>来进行连接的，<code>Request</code>和<code>Response</code>是按照<code>HTTP</code>协议来封装的，所以<code>Connector</code>同时需要实现<code>TCP/IP</code>协议和<code>HTTP</code>协议。<code>Tomcat</code>既然处理请求，那么肯定需要先接收到这个请求，接收请求这个东西我们首先就需要看一下<code>Connector</code>。</p> 
<h3><a id="Container__194"></a>八、Container 架构分析</h3> 
<p><code>Container</code>用于封装和管理<code>Servlet</code>，以及具体处理<code>Request</code>请求，在<code>Connector</code>内部包含了<code>4</code>个子容器，结构图如下：<br> <img src="https://images2.imgbox.com/2c/77/E6T5vRVr_o.png" alt="img"><br> 4个子容器的作用分别是：<br> 【1】<code>Engine</code>：引擎，用来管理多个站点，一个<code>Service</code>最多只能有一个<code>Engine</code>；<br> 【2】<code>Host</code>：代表一个站点，也可以叫虚拟主机，通过配置<code>Host</code>就可以添加站点；<br> 【3】<code>Context</code>：代表一个应用程序，对应着平时开发的一套程序，或者一个<code>WEB-INF</code>目录以及下面的<code>web.xml</code>文件；<br> 【4】<code>Wrapper</code>：每一<code>Wrapper</code>封装着一个<code>Servlet</code>；</p> 
<p>下面找一个<code>Tomcat</code>的文件目录对照一下，如下图所示：<br> <img src="https://images2.imgbox.com/58/cd/VnVKYrAs_o.png" alt="img"></p> 
<p><code>Context</code>和<code>Host</code>的区别是<code>Context</code>表示一个应用，我们的<code>Tomcat</code>中默认的配置下<code>webapps</code>下的每一个文件夹目录都是一个<code>Context</code>，其中<code>ROOT</code>目录中存放着主应用，其他目录存放着子应用，而整个 webapps就是一个 Host站点。我们访问应用<code>Context</code>的时候，如果是<code>ROOT</code>下的则直接使用域名就可以访问，例如：<a href="https://links.jianshu.com/go?to=http%3A%2F%2Fwww.ledouit.com" rel="nofollow">www.ledouit.com</a>，如果是<code>Host（webapps）</code>下的其他应用，则可以使用 <a href="https://links.jianshu.com/go?to=http%3A%2F%2Fwww.ledouit.com%2Fdocs" rel="nofollow">www.ledouit.com/docs</a> 进行访问，当然默认指定的根应用<code>ROOT</code>是可以进行设定的，只不过<code>Host</code>站点下默认的主营用是<code>ROOT</code>目录下的。</p> 
<p>看到这里我们知道<code>Container</code>是什么，但是还是不知道<code>Container</code>是如何进行处理的以及处理完之后是如何将处理完的结果返回给<code>Connector</code>的。</p> 
<h3><a id="Container__210"></a>十、Container 如何处理请求的</h3> 
<p><code>Container</code>处理请求是使用<code>Pipeline-Valve</code>管道来处理的！（<code>Valve</code>是阀门之意）<code>Pipeline-Valve</code>是责任链模式，责任链模式是指在一个请求处理的过程中有很多处理者依次对请求进行处理，每个处理者负责做自己相应的处理，处理完之后将处理后的请求返回，再让下一个处理着继续处理。<br> <img src="https://images2.imgbox.com/95/9b/ub3gUqnd_o.png" alt="img"></p> 
<p>但是！<code>Pipeline-Valve</code>使用的责任链模式和普通的责任链模式有些不同！区别主要有以下两点：<br> 【1】每个<code>Pipeline</code>都有特定的<code>Valve</code>，而且是在管道的最后一个执行，这个<code>Valve</code>叫做<code>BaseValve</code>，<code>BaseValve</code>是不可删除的；<br> 【2】在上层容器的管道的<code>BaseValve</code>中会调用下层容器的管道。</p> 
<p>我们知道<code>Container</code>包含四个子容器，而这四个子容器对应的<code>BaseValve</code>分别在：<code>StandardEngineValve</code>、<code>StandardHostValve</code>、<code>StandardContextValve</code>、<code>StandardWrapperValve</code>。<code>Pipeline</code>的处理流程图如下：<br> <img src="https://images2.imgbox.com/3d/c7/xD5sCeBh_o.png" alt="img"></p> 
<p>【1】<code>Connector</code>在接收到请求后会首先调用最顶层容器的<code>Pipeline</code>来处理，这里的最顶层容器的 <code>Pipeline</code>就是<code>EnginePipeline</code>（<code>Engine</code>的管道）；<br> 【2】在<code>Engine</code>的管道中依次会执行<code>EngineValve1</code>、<code>EngineValve2</code>等等，最后会执行 <code>StandardEngineValve</code>，在<code>StandardEngineValve</code>中会调用<code>Host</code>管道，然后再依次执行<code>Host</code>的 <code>HostValve1</code>、<code>HostValve2</code>等，最后在执行<code>StandardHostValve</code>，然后再依次调用<code>Context</code>的管道和 <code>Wrapper</code>的管道，最后执行到<code>StandardWrapperValve</code>。<br> 【3】当执行到<code>StandardWrapperValve</code>的时候，会在<code>StandardWrapperValve</code>中创建<code>FilterChain</code>，并调用其 <code>doFilter</code>方法来处理请求，这个<code>FilterChain</code>包含着我们配置的与请求相匹配的<code>Filter</code>和<code>Servlet</code>，其 <code>doFilter</code>方法会依次调用所有的<code>Filter</code>的<code>doFilter</code>方法和<code>Servlet</code>的<code>service</code>方法，这样请求就得到了处理！<br> 【4】当所有的<code>Pipeline-Valve</code>都执行完之后，并且处理完了具体的请求，这个时候就可以将返回的结果交给<code>Connector</code>了，<code>Connector</code>在通过<code>Socket</code>的方式将结果返回给客户端。</p> 
<h3><a id="tomcat__servlet_226"></a>十一、tomcat 容器是如何创建 servlet类实例？用到了什么原理？</h3> 
<p>当容器启动时，会读取在<code>webapps</code>目录下所有的<code>web</code>应用中的<code>web.xml</code>文件，然后对<code>xml</code>文件进行解析，并读取<code>servlet</code>注册信息。然后，将每个应用中注册的<code>servlet</code>类都进行加载，并通过反射的方式实例化。（有时候也是在第一次请求时实例化）在<code>servlet</code>注册时加上如果为正数，则在一开始就实例化，如果不写或为负数，则第一次请求实例化。</p> 
<h3><a id="_session_229"></a>十二、共享 session处理</h3> 
<p>目前的处理方式有如下几种：<br> 【1】使用<code>Tomcat</code>本身的<code>Session</code>复制功能。参考<code>http://ajita.iteye.com/blog/1715312</code>（<code>Session</code>复制的配置）方案的有点是配置简单，缺点是当集群数量较多时，<code>Session</code>复制的时间会比较长，影响响应的效率；<br> 【2】使用第三方来存放共享<code>Session</code>：目前用的较多的是使用<code>memcached</code>来管理共享<code>Session</code>，借助于<code>memcached-sesson-manager</code>来进行<code>Tomcat</code>的<code>Session</code>管理。参考<code>http://ajita.iteye.com/blog/1716320</code>（使用<code>MSM</code>管理<code>Tomcat</code>集群<code>session</code>）<br> 【3】使用黏性<code>session</code>的策略：对于会话要求不太强（不涉及到计费，失败了允许重新请求下等）的场合，同一个用户的<code>session</code>可以由<code>nginx</code>或者<code>apache</code>交给同一个<code>Tomcat</code>来处理，这就是所谓的 <code>session sticky</code>策略，目前应用也比较多。参考：<code>http://ajita.iteye.com/blog/1848665（tomcat session sticky）Nginx</code>默认不包含<code>session sticky</code>模块，需要重新编译才行（<code>windows</code>下我也不知道怎么重新编译）优点是处理效率高多了，缺点是强会话要求的场合不合适。</p> 
<h3><a id="_Tomcat__session_235"></a>十三、关于 Tomcat 的 session数目</h3> 
<p>这个可以直接从<code>Tomcat</code>的<code>web</code>管理界面去查看即可，或者借助于第三方工具<code>Lambda Probe</code>来查看，它相对于<code>Tomcat</code>自带的管理稍微多了点功能，但也不多 ；</p> 
<h3><a id="Tomcat__239"></a>十四、Tomcat 一个请求的完整过程</h3> 
<p>首先<code>DNS</code>解析机器，一般是<code>ng</code>服务器<code>ip</code>地址，然后<code>ng</code>根据<code>server</code>的配置，寻找路径为<code>yy/</code>的机器列表，<code>ip</code>和端口。最后 选择其中一台机器进行访问。下面为详细过程：<br> 【1】请求被发送到本机端口<code>8080</code>，被在那里侦听的<code>Coyote HTTP/1.1 Connector</code>获得；<br> 【2】<code>Connector</code>把该请求交给它所在的<code>Service</code>的<code>Engine</code>来处理，并等待来自<code>Engine</code>的回应；<br> 【3】<code>Engine</code>获得请求<code>localhost/yy/index.jsp</code>，匹配它所拥有的所有虚拟主机<code>Host</code>；<br> 【4】<code>Engine</code>匹配到名为 localhost 的 Host（即使匹配不到也把请求交给该 Host处理，因为该Host被定义为该 Engine的默认主机）；<br> 【5】<code>localhost Host</code>获得请求<code>/yy/index.jsp</code>，匹配它所拥有的所有<code>Context</code>；<br> 【6】<code>Host</code>匹配到路径为<code>/yy</code>的<code>Context</code>（如果匹配不到就把该请求交给路径名为”“的<code>Context</code>去处理）；<br> 【7】<code>path=”/yy”</code>的<code>Context</code>获得请求<code>/index.jsp</code>，在它的<code>mapping table</code>中寻找对应的<code>servlet</code>；<br> 【8】<code>Context</code>匹配到<code>URL PATTERN</code>为<code>*.jsp</code>的<code>servlet</code>，对应于<code>JspServlet</code>类；<br> 【9】构造<code>HttpServletRequest</code>对象和<code>HttpServletResponse</code>对象，作为参数调用<code>JspServlet</code>的<code>doGet</code>或 <code>doPost</code>方法；<br> 【10】<code>Context</code>把执行完了之后的<code>HttpServletResponse</code>对象返回给<code>Host</code>；<br> 【11】<code>Host</code>把<code>HttpServletResponse</code>对象返回给<code>Engine</code>；<br> 【12】<code>Engine</code>把<code>HttpServletResponse</code>对象返回给<code>Connector</code>；<br> 【13】<code>Connector</code>把<code>HttpServletResponse</code>对象返回给客户<code>browser</code>；</p> 
<h3><a id="Tomcat__256"></a>十五、Tomcat 工作模式</h3> 
<p><code>Tomcat</code>是一个<code>JSP/Servlet</code>容器。其作为<code>Servlet</code>容器，有三种工作模式：独立的<code>Servlet</code>容器、进程内的<code>Servlet</code>容器和进程外的<code>Servlet</code>容器。进入<code>Tomcat</code>的请求可以根据<code>Tomcat</code>的工作模式分为如下两类：<br> 【1】<code>Tomcat</code>作为应用程序服务器：请求来自于前端的<code>web</code>服务器，这可能是<code>Apache</code>, <code>IIS</code>, <code>Nginx</code>等；<br> 【2】<code>Tomcat</code>作为独立服务器：请求来自于<code>web</code>浏览器；</p> 
<p><code>Tomcat</code>的工作一般分为三种：<br> 【1】<strong><code>bio</code>：</strong> 传统的<code>Java I/O</code>操作，同步且阻塞<code>I/O</code>，一个线程处理一个请求，并发量高时，线程数较多，浪费资源；（已经很少有人在使用）<br> 【2】<strong><code>nio</code>：</strong> <code>JDK1.4</code>开始支持，同步阻塞或同步非阻塞<code>IO</code>，可以通过少量的线程来处理大量的请求；（从<code>Tomcat 8</code>版本开始默认就是这种模式）<br> 【3】<strong><code>apr</code>：</strong> 以<code>JNI</code>的形式调用<code>Apache HTTP</code>服务器的核心动态链接库来处理文件读取或网络传输操作，从而大大地提高<code>Tomcat</code>对静态文件的处理性能；（企业中使用较多）</p> 
<h3><a id="_Tomcat__266"></a>十六、如何对 Tomcat 进行优化</h3> 
<p>【1】关闭<code>Manager</code>管理页面；（默认已经关闭）<br> 【2】关闭<code>host-mangent</code>管理页面；（默认已经关闭）<br> 【3】对<code>Tomcat</code>日志进行分割；<br> 【4】定义<code>Tomcat 404</code>错误返回的页面；<br> 【5】对<code>JVM</code>进行优化；<br> 【6】对<code>Tomcat</code>线程池进行优化；</p> 
<h3><a id="_Tomcat__274"></a>十七、如何对 Tomcat 进行优化</h3> 
<p>【1】关闭<code>Manager</code>管理页面；（默认已经关闭）<br> 【2】关闭<code>host-mangent</code>管理页面；（默认已经关闭）<br> 【3】对<code>Tomcat</code>日志进行分割；<br> 【4】定义<code>Tomcat 404</code>错误返回的页面；<br> 【5】对<code>JVM</code>进行优化；<br> 【6】对<code>Tomcat</code>线程池进行优化；<br> 【7】更改<code>Tomcat</code>的工作的模式；</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0e02e854b68988005576291bce3242df/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">智源发布三款BGE新模型，再次刷新向量检索最佳水平</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e1e2b11de5f49168a95797ac0073de49/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">springboot3.x集成nacos 并实现多环境配置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>