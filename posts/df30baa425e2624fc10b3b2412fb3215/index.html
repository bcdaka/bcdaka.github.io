<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>YOLOv8测试3：在Python中将YOLOv8模型封装成API接口使用（上传测试图片并返回识别结果，附测试代码） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/df30baa425e2624fc10b3b2412fb3215/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="YOLOv8测试3：在Python中将YOLOv8模型封装成API接口使用（上传测试图片并返回识别结果，附测试代码）">
  <meta property="og:description" content="一、概述 记录时间 [2024-4-4]
本文讲述的是在Windows系统（Python&#43;PyTorch&#43;Conda&#43;cpu）中YOLOv8模型的简单应用。这里附带上YOLOv8官方文档，里面记载了详细的使用方法，如果觉得看文档比较麻烦的话，可以直接看文章，需要用到的部分已经在文章中进行了摘录。
经过了前几次的尝试，我们不仅能使用CLI的方式运行yolov8n.pt模型，对图像和视频进行目标识别，并得到结果。
参考文章：YOLOv8模型的简单测试，Windows环境下安装部署（Python&#43;PyTorch&#43;Conda&#43;cpu&#43;CLI）
也可以在PyCharm集成开发环境中编写简单的python文件，以python的方式对YOLOv8模型进行简单的测试。
参考文章：YOLOv8模型的简单测试2，PyCharm集成开发环境安装使用（Windows&#43;Python&#43;PyTorch&#43;Conda&#43;cpu）
同时也了解了在Python中使用Flask封装网络接口的方法，能实现文件的上传。
参考文章：API接口简单使用（二）：Python中使用Flask（接口封装整理版，含文件上传接口的详细实现）
接下来，本文将介绍在Python中将YOLOv8模型封装成API接口使用的方法，然后通过调用封装好的API接口，我们可以上传自定义的测试图片，并返回识别结果。识别结果有两种：一种是完成识别后的图片；另一种是识别目标的类型，以及它们在图片中的坐标、大小，以文本形式返回。
二、思路整理 想要实现在Python中将YOLOv8模型封装成API接口使用，首先整理下思路：
（服务端）使用Flask框架编写一个简单的测试实例，可以实现文件上传（客户端）通过API接口，以文件形式上传自定义的测试图片（服务端）获取图片名称和类型，然后保存到指定路径（服务端）下载并使用YOLOv8模型进行图片预测/识别（服务端）保存图片目标识别的结果（服务端）返回目标识别的结果（客户端）得到服务端返回的识别结果 三、过程实现 此处主要讲述这个案例的实现过程，想要直接上手的朋友可以在文章下半部分获取详细完整版的测试代码哦。
1. 编写测试实例 （服务端）使用Flask框架编写一个简单的测试实例，可以实现文件上传
简单了解 简单的测试实例如下：
from flask import Flask, request app = Flask(__name__) @app.route(&#39;/...&#39;) def hanshu(): # 这里是写接口函数的地方 if __name__ == &#39;__main__&#39;: app.run() 文件上传功能的网络接口参考这个：（简单看一下即可）
@app.post(&#39;/upload&#39;) def upload(): # 文件作为参数传递，其 id为 file # 如果没有接收到这个请求，返回 No file part if &#39;file&#39; not in request.files: return &#34;No file part&#34; # 获取上传的文件 file = request.files[&#39;file&#39;] # 获取文件名 if file.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-04T16:38:12+08:00">
    <meta property="article:modified_time" content="2024-04-04T16:38:12+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">YOLOv8测试3：在Python中将YOLOv8模型封装成API接口使用（上传测试图片并返回识别结果，附测试代码）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>一、概述</h2> 
<blockquote> 
 <p>记录时间 [2024-4-4]</p> 
</blockquote> 
<br> 
<p>本文讲述的是在<code>Windows</code>系统（<code>Python</code>+<code>PyTorch</code>+<code>Conda</code>+<code>cpu</code>）中<code>YOLOv8</code>模型的简单应用。这里附带上<code>YOLOv8</code><a href="https://docs.ultralytics.com/zh/" rel="nofollow">官方文档</a>，里面记载了详细的使用方法，如果觉得看文档比较麻烦的话，可以直接看文章，需要用到的部分已经在文章中进行了摘录。</p> 
<br> 
<p>经过了前几次的尝试，我们不仅能使用<code>CLI</code>的方式运行<code>yolov8n.pt</code>模型，对图像和视频进行目标识别，并得到结果。<br> 参考文章：<a href="https://blog.csdn.net/Sareur_1879/article/details/137203261">YOLOv8模型的简单测试，Windows环境下安装部署（Python+PyTorch+Conda+cpu+CLI）</a></p> 
<br> 
<p>也可以在<code>PyCharm</code>集成开发环境中编写简单的<code>python</code>文件，以<code>python</code>的方式对<code>YOLOv8</code>模型进行简单的测试。<br> 参考文章：<a href="https://blog.csdn.net/Sareur_1879/article/details/137230918">YOLOv8模型的简单测试2，PyCharm集成开发环境安装使用（Windows+Python+PyTorch+Conda+cpu）</a></p> 
<br> 
<p>同时也了解了在<code>Python</code>中使用<code>Flask</code>封装网络接口的方法，能实现文件的上传。<br> 参考文章：<a href="https://blog.csdn.net/Sareur_1879/article/details/137330298">API接口简单使用（二）：Python中使用Flask（接口封装整理版，含文件上传接口的详细实现）</a></p> 
<br> 
<p><strong>接下来，本文将介绍在<code>Python</code>中将<code>YOLOv8</code>模型封装成<code>API</code>接口使用的方法，然后通过调用封装好的<code>API</code>接口，我们可以上传自定义的测试图片，并返回识别结果。识别结果有两种：一种是完成识别后的图片；另一种是识别目标的类型，以及它们在图片中的坐标、大小，以文本形式返回。</strong></p> 
<br> 
<h2><a id="_39"></a>二、思路整理</h2> 
<br> 
<p>想要实现在<code>Python</code>中将<code>YOLOv8</code>模型封装成<code>API</code>接口使用，首先整理下思路：</p> 
<ul><li>（服务端）使用<code>Flask</code>框架编写一个简单的测试实例，可以实现文件上传</li><li>（客户端）通过<code>API</code>接口，以文件形式上传自定义的测试图片</li><li>（服务端）获取图片名称和类型，然后保存到指定路径</li><li>（服务端）下载并使用<code>YOLOv8</code>模型进行图片预测/识别</li><li>（服务端）保存图片目标识别的结果</li><li>（服务端）返回目标识别的结果</li><li>（客户端）得到服务端返回的识别结果</li></ul> 
<br> 
<h2><a id="_60"></a>三、过程实现</h2> 
<blockquote> 
 <p>此处主要讲述这个案例的实现过程，<strong>想要直接上手的朋友可以在文章下半部分获取详细完整版的测试代码哦。</strong></p> 
</blockquote> 
<br> 
<h3><a id="1__67"></a>1. 编写测试实例</h3> 
<blockquote> 
 <p>（服务端）使用<code>Flask</code>框架编写一个简单的测试实例，可以实现文件上传</p> 
</blockquote> 
<br> 
<h4><a id="_76"></a>简单了解</h4> 
<br> 
<p>简单的测试实例如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/...'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hanshu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 这里是写接口函数的地方</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<br> 
<p>文件上传功能的网络接口参考这个：（简单看一下即可）</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 文件作为参数传递，其 id为 file</span>
    <span class="token comment"># 如果没有接收到这个请求，返回 No file part</span>
    <span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"No file part"</span>

    <span class="token comment"># 获取上传的文件</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>

    <span class="token comment"># 获取文件名</span>
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"No selected file"</span>

    <span class="token comment"># file_format 获取文件类型，并返回</span>
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
        filename <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename
        file_format <span class="token operator">=</span> filename<span class="token punctuation">.</span>rsplit<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token string">"File format is: "</span> <span class="token operator">+</span> file_format<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<br> 
<h4><a id="_132"></a>创建测试文件</h4> 
<br> 
<p>然后，开始动手操作。</p> 
<p>使用<code>PyCharm</code>打开我们之前从<a href="https://github.com/ultralytics/ultralytics">仓库</a>下载的<code>YOLOv8</code>项目<code>ultralytics-main</code>，找到<code>tests</code>目录，在该目录下新建<code>image_test.py</code>文件。</p> 
<br> 
<h4><a id="_145"></a>导入依赖</h4> 
<br> 
<p>导入<code>YOLOv8</code>项目运行所需的依赖和配置：</p> 
<pre><code class="prism language-python"><span class="token comment"># Ultralytics YOLO 🚀, AGPL-3.0 license</span>

<span class="token keyword">import</span> contextlib
<span class="token keyword">from</span> copy <span class="token keyword">import</span> copy
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path

<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pytest
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> yaml
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> ToTensor

<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> RTDETR<span class="token punctuation">,</span> YOLO
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>cfg <span class="token keyword">import</span> TASK2DATA
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>data<span class="token punctuation">.</span>build <span class="token keyword">import</span> load_inference_source
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>utils <span class="token keyword">import</span> <span class="token punctuation">(</span>
    ASSETS<span class="token punctuation">,</span>
    DEFAULT_CFG<span class="token punctuation">,</span>
    DEFAULT_CFG_PATH<span class="token punctuation">,</span>
    LINUX<span class="token punctuation">,</span>
    MACOS<span class="token punctuation">,</span>
    ONLINE<span class="token punctuation">,</span>
    ROOT<span class="token punctuation">,</span>
    WEIGHTS_DIR<span class="token punctuation">,</span>
    WINDOWS<span class="token punctuation">,</span>
    Retry<span class="token punctuation">,</span>
    checks<span class="token punctuation">,</span>
    is_dir_writeable<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>downloads <span class="token keyword">import</span> download
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>torch_utils <span class="token keyword">import</span> TORCH_1_9<span class="token punctuation">,</span> TORCH_1_13

MODEL <span class="token operator">=</span> WEIGHTS_DIR <span class="token operator">/</span> <span class="token string">"path with spaces"</span> <span class="token operator">/</span> <span class="token string">"yolov8n.pt"</span>  <span class="token comment"># test spaces in path</span>
CFG <span class="token operator">=</span> <span class="token string">"yolov8n.yaml"</span>
SOURCE <span class="token operator">=</span> ASSETS <span class="token operator">/</span> <span class="token string">"bus.jpg"</span>
TMP <span class="token operator">=</span> <span class="token punctuation">(</span>ROOT <span class="token operator">/</span> <span class="token string">"../tests/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># temp directory for test files</span>
IS_TMP_WRITEABLE <span class="token operator">=</span> is_dir_writeable<span class="token punctuation">(</span>TMP<span class="token punctuation">)</span>
</code></pre> 
<br> 
<p>导入<code>Flask</code>框架使用所需依赖：（如果<code>Flask</code>依赖报错，说明没有导入成功，重新导入一下即可。）</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> send_file
</code></pre> 
<br> 
<h4><a id="_209"></a>编写文件上传接口</h4> 
<br> 
<pre><code class="prism language-python">app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">'/image'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">return_image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"Succeed"</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5001</span><span class="token punctuation">)</span>
</code></pre> 
<p>大家可以自行测试下这个接口可不可用，后面我们在<code>return_image()</code>函数中编写内容。</p> 
<br> 
<h4><a id="_236"></a>创建上传目录</h4> 
<br> 
<p>在<code>ultralytics-main/tests/tmp/</code>目录下新建<code>upload</code>文件夹，用来存放我们上传的文件。</p> 
<br> 
<h3><a id="2__248"></a>2. 上传测试图片</h3> 
<blockquote> 
 <p>（客户端）通过<code>API</code>接口，以文件形式上传自定义的测试图片</p> 
</blockquote> 
<br> 
<p>这里简单写一个<code>HTML</code>文件用于测试即可：</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>文件上传<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!--action中写入请求的URL--&gt;</span>
    <span class="token comment">&lt;!--method中写入请求的方法，如 get/post...--&gt;</span>
    
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://127.0.0.1:5001/image<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>multipart/form-data<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>上传<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<br> 
<h3><a id="3__289"></a>3. 获取图片信息并保存</h3> 
<blockquote> 
 <p>（服务端）获取图片名称和类型，然后保存到指定路径</p> 
</blockquote> 
<br> 
<p>在<code>return_image()</code>函数中编写内容：</p> 
<pre><code class="prism language-python"><span class="token comment"># 1. 获取上传的图片资源</span>

<span class="token comment"># 文件作为参数传递，其 id为 file</span>
<span class="token comment"># 如果没有接收到这个请求，返回 No file part</span>
<span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"No file part"</span>

<span class="token comment"># 获取图片文件</span>
<span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>

<span class="token comment"># 获取文件名</span>
<span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"No selected file"</span>

filename <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename

<span class="token comment"># 2. 保存到指定位置</span>
<span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>TMP <span class="token operator">/</span> <span class="token string">'upload'</span> <span class="token operator">/</span> filename<span class="token punctuation">)</span>
</code></pre> 
<br> 
<h3><a id="4__325"></a>4. 进行图片预测</h3> 
<blockquote> 
 <p>（服务端）下载并使用<code>YOLOv8</code>模型进行图片预测/识别</p> 
</blockquote> 
<br> 
<p>在<code>return_image()</code>函数中编写内容：</p> 
<pre><code class="prism language-python"><span class="token comment"># 3. 使用 YOLOv8模型对该图片进行预测</span>
model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>MODEL<span class="token punctuation">)</span>

<span class="token comment"># Define path to the image file</span>
source <span class="token operator">=</span> TMP <span class="token operator">/</span> <span class="token string">'upload'</span> <span class="token operator">/</span> filename

<span class="token comment"># 具体要在 predict中添加一些参数</span>
model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>source<span class="token punctuation">)</span>
</code></pre> 
<br> 
<h3><a id="5__352"></a>5. 保存图片目标识别的结果</h3> 
<blockquote> 
 <p>（服务端）保存图片目标识别的结果</p> 
</blockquote> 
<br> 
<h4><a id="_360"></a>图片结果</h4> 
<br> 
<p>我们要保存<strong>识别后的图片结果</strong>，主要使用的参数是<code>save</code>，我们设置<code>save=True</code>即可。</p> 
<pre><code class="prism language-python"><span class="token comment"># 4. 保存结果</span>
results <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>source<span class="token punctuation">,</span> save<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">320</span><span class="token punctuation">,</span> conf<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
</code></pre> 
<br> 
<h4><a id="_376"></a>文本结果</h4> 
<br> 
<p>如果要保存<strong>识别目标的类型，以及它们在图片中的坐标、大小，以文本形式返回</strong></p> 
<p>则使用参数<code>save_txt</code>，设置为<code>True</code>：</p> 
<pre><code class="prism language-python">results <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>source<span class="token punctuation">,</span> save_txt<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>结果会以<code>txt</code>文件的形式保存在<code>tests\tmp\runs\detect\predict[i]\labels</code>目录下。</strong></p> 
<br> 
<h3><a id="6__398"></a>6. 返回目标识别的结果</h3> 
<blockquote> 
 <p>（服务端）返回目标识别的结果</p> 
</blockquote> 
<br> 
<h4><a id="_406"></a>图片结果</h4> 
<br> 
<p><code>send_file(image_path)</code>是直接将返回的结果在浏览器中进行预览，</p> 
<p><strong>如果想要下载图片，就添加<code>as_attachment=True</code>参数。</strong></p> 
<pre><code class="prism language-python"><span class="token comment"># 获取文件保存的路径</span>
save_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>save_dir<span class="token punctuation">)</span>
image_path <span class="token operator">=</span> save_path <span class="token operator">/</span> filename

<span class="token comment"># 5. 返回结果</span>
<span class="token keyword">return</span> send_file<span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>
<span class="token comment"># 下载版</span>
<span class="token keyword">return</span> send_file<span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> as_attachment<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<br> 
<h4><a id="_432"></a>文本结果</h4> 
<br> 
<p>想要获取<strong>识别目标的类型，以及它们在图片中的坐标、大小</strong>的信息，</p> 
<p>我们需要读取<code>tests\tmp\runs\detect\predict[i]\labels</code>目录中的<code>txt</code>文件</p> 
<pre><code class="prism language-python"><span class="token comment"># 获取文件保存的路径</span>
save_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>save_dir<span class="token punctuation">)</span>

<span class="token comment"># 获取label标签文件</span>
<span class="token keyword">for</span> r <span class="token keyword">in</span> results<span class="token punctuation">:</span>
    im_name <span class="token operator">=</span> Path<span class="token punctuation">(</span>r<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>stem
    labels <span class="token operator">=</span> save_path <span class="token operator">/</span> <span class="token string-interpolation"><span class="token string">f"labels/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>im_name<span class="token punctuation">}</span></span><span class="token string">.txt"</span></span>

<span class="token comment"># 读取标签文件中的内容</span>
txt_file <span class="token operator">=</span> labels
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    content <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 返回结果</span>
<span class="token keyword">return</span> content
</code></pre> 
<br> 
<h3><a id="7__465"></a>7. 得到返回结果</h3> 
<blockquote> 
 <p>（客户端）得到服务端返回的识别结果</p> 
</blockquote> 
<br> 
<h4><a id="_473"></a>图片结果</h4> 
<br> 
<p><strong>我们可以用上面写的<code>HTML</code>文件来进行测试，双击运行，选择文件，然后上传即可。</strong></p> 
<p>这里为了呈现结果更加直观，所以使用了<code>Postman</code>来测试，如图所示。</p> 
<br> 
<p><strong>注意：测试图片素材来源于网络，仅用于测试演示。</strong></p> 
<p><img src="https://images2.imgbox.com/26/57/KCVIh6Vu_o.png" alt="在这里插入图片描述" width="700"></p> 
<br> 
<h4><a id="_494"></a>文本结果</h4> 
<br> 
<p>如图所示，返回识别目标的类型，以及它们在图片中的坐标、大小等信息。</p> 
<p><img src="https://images2.imgbox.com/81/c0/xzRU3h8r_o.png" alt="在这里插入图片描述" width="700"></p> 
<br> 
<p><strong>下面对<code>YOLOv8</code>标签文件<code>label</code>中的内容进行解释：</strong></p> 
<ul><li>如图，在项目中打开一个模型训练文件进行查看</li><li>以第一行标签为例，首个数字<code>5</code>代表的是<code>names</code>中的第五类，即<code>bus</code></li><li>后面的四个参数分别是<code>bus</code>在图片中的纵横坐标，以及它的长宽</li><li>通过这些参数，我们就可以确定识别目标的类型，以及它在图片中的位置啦</li></ul> 
<br> 
<p><img src="https://images2.imgbox.com/09/eb/Z91Ab1fO_o.png" alt="在这里插入图片描述" width="700"></p> 
<br> 
<h2><a id="_526"></a>四、详细完整版测试代码</h2> 
<br> 
<h3><a id="1__532"></a>1. 得到图片目标版本</h3> 
<br> 
<p><code>image_test.py</code></p> 
<pre><code class="prism language-python"><span class="token comment"># Ultralytics YOLO 🚀, AGPL-3.0 license</span>

<span class="token keyword">import</span> contextlib
<span class="token keyword">from</span> copy <span class="token keyword">import</span> copy
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path

<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pytest
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> yaml
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> ToTensor

<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> RTDETR<span class="token punctuation">,</span> YOLO
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>cfg <span class="token keyword">import</span> TASK2DATA
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>data<span class="token punctuation">.</span>build <span class="token keyword">import</span> load_inference_source
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>utils <span class="token keyword">import</span> <span class="token punctuation">(</span>
    ASSETS<span class="token punctuation">,</span>
    DEFAULT_CFG<span class="token punctuation">,</span>
    DEFAULT_CFG_PATH<span class="token punctuation">,</span>
    LINUX<span class="token punctuation">,</span>
    MACOS<span class="token punctuation">,</span>
    ONLINE<span class="token punctuation">,</span>
    ROOT<span class="token punctuation">,</span>
    WEIGHTS_DIR<span class="token punctuation">,</span>
    WINDOWS<span class="token punctuation">,</span>
    Retry<span class="token punctuation">,</span>
    checks<span class="token punctuation">,</span>
    is_dir_writeable<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>downloads <span class="token keyword">import</span> download
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>torch_utils <span class="token keyword">import</span> TORCH_1_9<span class="token punctuation">,</span> TORCH_1_13

<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> send_file

MODEL <span class="token operator">=</span> WEIGHTS_DIR <span class="token operator">/</span> <span class="token string">"path with spaces"</span> <span class="token operator">/</span> <span class="token string">"yolov8n.pt"</span>  <span class="token comment"># test spaces in path</span>
CFG <span class="token operator">=</span> <span class="token string">"yolov8n.yaml"</span>
SOURCE <span class="token operator">=</span> ASSETS <span class="token operator">/</span> <span class="token string">"bus.jpg"</span>
TMP <span class="token operator">=</span> <span class="token punctuation">(</span>ROOT <span class="token operator">/</span> <span class="token string">"../tests/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># temp directory for test files</span>
IS_TMP_WRITEABLE <span class="token operator">=</span> is_dir_writeable<span class="token punctuation">(</span>TMP<span class="token punctuation">)</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">'/image'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">return_image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. 获取上传的图片资源</span>

    <span class="token comment"># 文件作为参数传递，其 id为 file</span>
    <span class="token comment"># 如果没有接收到这个请求，返回 No file part</span>
    <span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"No file part"</span>

    <span class="token comment"># 获取图片文件</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>

    <span class="token comment"># 获取文件名</span>
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"No selected file"</span>

    filename <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename

    <span class="token comment"># 2. 保存到指定位置</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>TMP <span class="token operator">/</span> <span class="token string">'upload'</span> <span class="token operator">/</span> filename<span class="token punctuation">)</span>

    <span class="token comment"># 3. 使用 YOLOv8模型对该图片进行预测</span>
    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>MODEL<span class="token punctuation">)</span>

    <span class="token comment"># Define path to the image file</span>
    source <span class="token operator">=</span> TMP <span class="token operator">/</span> <span class="token string">'upload'</span> <span class="token operator">/</span> filename

    <span class="token comment"># 4. 保存结果</span>
    results <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>source<span class="token punctuation">,</span> save<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> imgsz<span class="token operator">=</span><span class="token number">320</span><span class="token punctuation">,</span> conf<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>

    <span class="token comment"># 获取文件保存的路径</span>
    save_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>save_dir<span class="token punctuation">)</span>
    image_path <span class="token operator">=</span> save_path <span class="token operator">/</span> filename

    <span class="token comment"># 5. 返回结果</span>
    <span class="token keyword">return</span> send_file<span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5001</span><span class="token punctuation">)</span>
</code></pre> 
<br> 
<h3><a id="2__632"></a>2. 得到文本参数版本</h3> 
<br> 
<p><code>text_test.py</code></p> 
<pre><code class="prism language-python"><span class="token comment"># Ultralytics YOLO 🚀, AGPL-3.0 license</span>

<span class="token keyword">import</span> contextlib
<span class="token keyword">from</span> copy <span class="token keyword">import</span> copy
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path

<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pytest
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> yaml
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> ToTensor

<span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> RTDETR<span class="token punctuation">,</span> YOLO
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>cfg <span class="token keyword">import</span> TASK2DATA
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>data<span class="token punctuation">.</span>build <span class="token keyword">import</span> load_inference_source
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>utils <span class="token keyword">import</span> <span class="token punctuation">(</span>
    ASSETS<span class="token punctuation">,</span>
    DEFAULT_CFG<span class="token punctuation">,</span>
    DEFAULT_CFG_PATH<span class="token punctuation">,</span>
    LINUX<span class="token punctuation">,</span>
    MACOS<span class="token punctuation">,</span>
    ONLINE<span class="token punctuation">,</span>
    ROOT<span class="token punctuation">,</span>
    WEIGHTS_DIR<span class="token punctuation">,</span>
    WINDOWS<span class="token punctuation">,</span>
    Retry<span class="token punctuation">,</span>
    checks<span class="token punctuation">,</span>
    is_dir_writeable<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>downloads <span class="token keyword">import</span> download
<span class="token keyword">from</span> ultralytics<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>torch_utils <span class="token keyword">import</span> TORCH_1_9<span class="token punctuation">,</span> TORCH_1_13

<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> send_file

MODEL <span class="token operator">=</span> WEIGHTS_DIR <span class="token operator">/</span> <span class="token string">"path with spaces"</span> <span class="token operator">/</span> <span class="token string">"yolov8n.pt"</span>  <span class="token comment"># test spaces in path</span>
CFG <span class="token operator">=</span> <span class="token string">"yolov8n.yaml"</span>
SOURCE <span class="token operator">=</span> ASSETS <span class="token operator">/</span> <span class="token string">"bus.jpg"</span>
TMP <span class="token operator">=</span> <span class="token punctuation">(</span>ROOT <span class="token operator">/</span> <span class="token string">"../tests/tmp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># temp directory for test files</span>
IS_TMP_WRITEABLE <span class="token operator">=</span> is_dir_writeable<span class="token punctuation">(</span>TMP<span class="token punctuation">)</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">'/text'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">return_text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. 获取上传的图片资源</span>

    <span class="token comment"># 文件作为参数传递，其 id为 file</span>
    <span class="token comment"># 如果没有接收到这个请求，返回 No file part</span>
    <span class="token keyword">if</span> <span class="token string">'file'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> request<span class="token punctuation">.</span>files<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"No file part"</span>

    <span class="token comment"># 获取图片文件</span>
    <span class="token builtin">file</span> <span class="token operator">=</span> request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token string">'file'</span><span class="token punctuation">]</span>

    <span class="token comment"># 获取文件名</span>
    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"No selected file"</span>

    filename <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename

    <span class="token comment"># 2. 保存到指定位置</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span>TMP <span class="token operator">/</span> <span class="token string">'upload'</span> <span class="token operator">/</span> filename<span class="token punctuation">)</span>

    <span class="token comment"># 3. 使用 YOLOv8模型对该图片进行预测</span>
    model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>MODEL<span class="token punctuation">)</span>

    <span class="token comment"># Define path to the image file</span>
    source <span class="token operator">=</span> TMP <span class="token operator">/</span> <span class="token string">'upload'</span> <span class="token operator">/</span> filename

    <span class="token comment"># 4. 保存结果</span>
    results <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>source<span class="token punctuation">,</span> save_txt<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># 获取文件保存的路径</span>
    save_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>save_dir<span class="token punctuation">)</span>

    <span class="token comment"># 获取label标签文件</span>
    <span class="token keyword">for</span> r <span class="token keyword">in</span> results<span class="token punctuation">:</span>
        im_name <span class="token operator">=</span> Path<span class="token punctuation">(</span>r<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>stem
        labels <span class="token operator">=</span> save_path <span class="token operator">/</span> <span class="token string-interpolation"><span class="token string">f"labels/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>im_name<span class="token punctuation">}</span></span><span class="token string">.txt"</span></span>

    <span class="token comment"># 读取标签文件中的内容</span>
    txt_file <span class="token operator">=</span> labels
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
        content <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 5. 返回结果</span>
    <span class="token keyword">return</span> content

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5001</span><span class="token punctuation">)</span>
</code></pre> 
<br> 
<h2><a id="_742"></a>五、总结</h2> 
<br> 
<p>本文在<code>Python</code>中将<code>YOLOv8</code>模型封装成<code>API</code>接口进行使用，通过调用封装好的<code>API</code>接口来实现自定义测试图片的上传，并返回识别结果。识别结果有两种：一种是完成识别后的图片；另一种是识别目标的类型，以及它们在图片中的坐标、大小，以文本形式返回。</p> 
<br> 
<p><strong>一些参考资料</strong></p> 
<p><code>YOLOv8</code>官方文档：https://docs.ultralytics.com/zh/</p> 
<p><code>YOLOv8</code>模型仓库地址：https://github.com/ultralytics/ultralytics</p> 
<p><code>PyCharm</code>官网：https://www.jetbrains.com/pycharm/download/?section=windows</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3f759bc11e455c0c9c50abe0efcd7a7a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【2024】springboot支付宝沙箱支付详细步骤（一篇搞定）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/360ae062585406db221c52ab992a11fb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">手把手教你Paragon NTFS for Mac v15.9.314破解版下载</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>