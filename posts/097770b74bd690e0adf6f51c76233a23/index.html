<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HIVE调优-数据倾斜优化（详细版） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/097770b74bd690e0adf6f51c76233a23/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="HIVE调优-数据倾斜优化（详细版）">
  <meta property="og:description" content="HIVE调优-数据倾斜优化 目录
HIVE调优-数据倾斜优化
1.排序优化
1）order by 2）distribute by &#43; sort by 3）cluster by语句：
2.数据倾斜优化
1）原因：
2）表现：
3）创建表格（查看一下具体效果）
4) 如果想展示数据倾斜效果：
5) 解决方法：
1.排序优化 1）order by 全局排序操作, 只有一个Reduce任务去对数据进行排序，会造成全部的数据堆积在一个Reduce任务中进行处理
经常会出现OOM异常？ 一个Reduce任务的内存是有限的，承载不了太多数据
2）distribute by &#43; sort by distribute by：是指我们的分区操作
sort by： 跟上distribute by 之后可以实现在分区内进行排序，
如果当前的Reduce数量为1，那么也没有优化的效果，可以通过设置reduce的数量对不同分区中的数据进行拆分排序
通过 set mapreduce.job.reduces = N; 设置Reduce数量，默认参数值为-1 即根据资源及查询语句情况进行分配reduce,
3）cluster by语句： 如果分区字段和排序字段是同一个字段，那么和 distribute by &#43; sort by 效果一致
2.数据倾斜优化 1）原因： 1.Key分布不均,导致某一些Key在做Reduce端处理时，执行较慢
2.数据重复，在关联时，会产生笛卡尔积，致使数据膨胀，严重的可能会导致集群挂掉 2）表现： 任务进度长时间维持在99%（或100%），
查看任务监控页面，发现只有少量（1个或几个）reduce子任务未完成。因为其处理的数据量和其他reduce差异过大
3）创建表格（查看一下具体效果） 1.创建带有部分NULL的学生表和成绩表
1.创建带有部分NULL的学生表和成绩表 DROP TABLE learn4.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-14T00:01:36+08:00">
    <meta property="article:modified_time" content="2024-05-14T00:01:36+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HIVE调优-数据倾斜优化（详细版）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 id="HIVE%E8%B0%83%E4%BC%98-%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E4%BC%98%E5%8C%96" style="text-align:center;">HIVE调优-数据倾斜优化</h2> 
<p></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="HIVE%E8%B0%83%E4%BC%98-%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E4%BC%98%E5%8C%96-toc" style="margin-left:0px;"><a href="#HIVE%E8%B0%83%E4%BC%98-%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E4%BC%98%E5%8C%96" rel="nofollow">HIVE调优-数据倾斜优化</a></p> 
<p id="1.%E6%8E%92%E5%BA%8F%E4%BC%98%E5%8C%96-toc" style="margin-left:80px;"><a href="#1.%E6%8E%92%E5%BA%8F%E4%BC%98%E5%8C%96" rel="nofollow">1.排序优化</a></p> 
<p id="1%EF%BC%89order%20by%C2%A0-toc" style="margin-left:120px;"><a href="#1%EF%BC%89order%20by%C2%A0" rel="nofollow">1）order by </a></p> 
<p id="2%EF%BC%89distribute%20by%20%2B%20sort%20by%C2%A0-toc" style="margin-left:120px;"><a href="#2%EF%BC%89distribute%20by%20%2B%20sort%20by%C2%A0" rel="nofollow">2）distribute by + sort by </a></p> 
<p id="3%EF%BC%89cluster%20by%E8%AF%AD%E5%8F%A5%EF%BC%9A-toc" style="margin-left:120px;"><a href="#3%EF%BC%89cluster%20by%E8%AF%AD%E5%8F%A5%EF%BC%9A" rel="nofollow">3）cluster by语句：</a></p> 
<p id="2.%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E4%BC%98%E5%8C%96-toc" style="margin-left:80px;"><a href="#2.%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E4%BC%98%E5%8C%96" rel="nofollow">2.数据倾斜优化</a></p> 
<p id="1%EF%BC%89%E5%8E%9F%E5%9B%A0%EF%BC%9A-toc" style="margin-left:120px;"><a href="#1%EF%BC%89%E5%8E%9F%E5%9B%A0%EF%BC%9A" rel="nofollow">1）原因：</a></p> 
<p id="2%EF%BC%89%E8%A1%A8%E7%8E%B0%EF%BC%9A-toc" style="margin-left:120px;"><a href="#2%EF%BC%89%E8%A1%A8%E7%8E%B0%EF%BC%9A" rel="nofollow">2）表现：</a></p> 
<p id="3%EF%BC%89%E5%88%9B%E5%BB%BA%E8%A1%A8%E6%A0%BC%EF%BC%88%E6%9F%A5%E7%9C%8B%E4%B8%80%E4%B8%8B%E5%85%B7%E4%BD%93%E6%95%88%E6%9E%9C%EF%BC%89-toc" style="margin-left:120px;"><a href="#3%EF%BC%89%E5%88%9B%E5%BB%BA%E8%A1%A8%E6%A0%BC%EF%BC%88%E6%9F%A5%E7%9C%8B%E4%B8%80%E4%B8%8B%E5%85%B7%E4%BD%93%E6%95%88%E6%9E%9C%EF%BC%89" rel="nofollow">3）创建表格（查看一下具体效果）</a></p> 
<p id="4)%C2%A0%E5%A6%82%E6%9E%9C%E6%83%B3%E5%B1%95%E7%A4%BA%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E6%95%88%E6%9E%9C%EF%BC%9A-toc" style="margin-left:120px;"><a href="#4%29%C2%A0%E5%A6%82%E6%9E%9C%E6%83%B3%E5%B1%95%E7%A4%BA%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E6%95%88%E6%9E%9C%EF%BC%9A" rel="nofollow">4) 如果想展示数据倾斜效果：</a></p> 
<p id="5)%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A-toc" style="margin-left:120px;"><a href="#5%29%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A" rel="nofollow">5) 解决方法：</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h4 id="1.%E6%8E%92%E5%BA%8F%E4%BC%98%E5%8C%96"><br> 1.排序优化</h4> 
<h5 id="1%EF%BC%89order%20by%C2%A0"><br> 1）order by </h5> 
<p><br>                 全局排序操作, 只有一个Reduce任务去对数据进行排序，会造成全部的数据堆积在一个Reduce任务中进行处理<br>                     经常会出现OOM异常？ 一个Reduce任务的内存是有限的，承载不了太多数据</p> 
<h5 id="2%EF%BC%89distribute%20by%20%2B%20sort%20by%C2%A0">2）distribute by + sort by </h5> 
<p><br>                 distribute by：是指我们的分区操作<br>                 sort by： 跟上distribute by 之后可以实现在分区内进行排序，<br>                 如果当前的Reduce数量为1，那么也没有优化的效果，可以通过设置reduce的数量对不同分区中的数据进行拆分排序<br>                  通过 set mapreduce.job.reduces = N; 设置Reduce数量，默认参数值为-1 即根据资源及查询语句情况进行分配reduce,</p> 
<h5 id="3%EF%BC%89cluster%20by%E8%AF%AD%E5%8F%A5%EF%BC%9A">3）cluster by语句：</h5> 
<p><br>                 如果分区字段和排序字段是同一个字段，那么和 distribute by + sort by 效果一致</p> 
<h4 id="2.%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E4%BC%98%E5%8C%96">2.数据倾斜优化</h4> 
<h5 id="1%EF%BC%89%E5%8E%9F%E5%9B%A0%EF%BC%9A"><br> 1）原因：</h5> 
<p><br>                 1.Key分布不均,导致某一些Key在做Reduce端处理时，执行较慢<br>                 2.数据重复，在关联时，会产生笛卡尔积，致使数据膨胀，严重的可能会导致集群挂掉 <br>             </p> 
<h5 id="2%EF%BC%89%E8%A1%A8%E7%8E%B0%EF%BC%9A">2）表现：</h5> 
<p><br>                 任务进度长时间维持在99%（或100%），<br>                 查看任务监控页面，发现只有少量（1个或几个）reduce子任务未完成。因为其处理的数据量和其他reduce差异过大<br>  </p> 
<h5 id="3%EF%BC%89%E5%88%9B%E5%BB%BA%E8%A1%A8%E6%A0%BC%EF%BC%88%E6%9F%A5%E7%9C%8B%E4%B8%80%E4%B8%8B%E5%85%B7%E4%BD%93%E6%95%88%E6%9E%9C%EF%BC%89">3）创建表格（查看一下具体效果）</h5> 
<p></p> 
<p>1.创建带有部分NULL的学生表和成绩表</p> 
<p></p> 
<pre><code class="language-java">

1.创建带有部分NULL的学生表和成绩表

DROP TABLE learn4.student_null;
CREATE EXTERNAL TABLE IF NOT EXISTS learn4.student_null(
id STRING COMMENT "学生ID",
name STRING COMMENT "学生姓名",
age int COMMENT "年龄",
gender STRING COMMENT "性别",
clazz STRING COMMENT "班级"
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ",";

load data local inpath "/usr/local/soft/hive-3.1.2/data/student_null.txt" INTO TABLE learn4.student_null;

DROP TABLE learn4.score_null;
CREATE EXTERNAL TABLE IF NOT EXISTS learn4.score_null(
id STRING COMMENT "学生ID",
subject_id STRING COMMENT "科目ID",
score int COMMENT "成绩"
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ",";

load data local inpath "/usr/local/soft/hive-3.1.2/data/score_null.txt" INTO TABLE learn4.score_null;


select * from learn4.student_null limit 10;
select * from learn4.score_null limit 10;
</code></pre> 
<p></p> 
<p><img alt="" height="521" src="https://images2.imgbox.com/dc/39/BU38NGuu_o.png" width="830"></p> 
<p><img alt="" height="521" src="https://images2.imgbox.com/19/c8/1Ewxs0nb_o.png" width="830"></p> 
<p></p> 
<p>2.大空表与小空表进行关联<br>  </p> 
<pre><code class="language-python">设置reduces =5

set mapreduce.job.reduces = 5;</code></pre> 
<p><img alt="" height="191" src="https://images2.imgbox.com/b2/f0/BRZzTWgw_o.png" width="826"></p> 
<p></p> 
<pre><code class="language-java">SELECT
T1.id
,count(*) as num
FROM learn4.student_null T1 JOIN learn4.score_null T2 ON T1.id = T2.id 
GROUP BY T1.id;
</code></pre> 
<p><img alt="" height="521" src="https://images2.imgbox.com/ba/5b/NahiWLJe_o.png" width="830"></p> 
<p></p> 
<p>我们打开master:8088  找到我们刚刚执行的命令 点击history 发现是打不开的</p> 
<p><img alt="" height="881" src="https://images2.imgbox.com/5a/3b/BsTd70bb_o.png" width="1200"></p> 
<p></p> 
<p>所以我们需要去配置一下日志文件</p> 
<pre><code class="language-java">配置文件
vim mapred-site.xml 



&lt;property&gt;
      &lt;name&gt;mapreduce.jobhistory.done-dir&lt;/name&gt;
    &lt;value&gt;${yarn.app.mapreduce.am.staging-dir}/done&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
        &lt;name&gt;mapreduce.jobhistory.intermediate-done-dir&lt;/name&gt;
        &lt;value&gt;${yarn.app.mapreduce.am.staging-dir}/done_intermediate&lt;/value&gt;
&lt;/property&gt;

&lt;property&gt;
        &lt;name&gt;yarn.app.mapreduce.am.staging-dir&lt;/name&gt;
        &lt;value&gt;/hadoop/yarn/historylog&lt;/value&gt;
&lt;/property&gt;


hdfs dfs -mkdir -p /hadoop/yarn/historylog

# 启动历史服务
mr-jobhistory-daemon.sh start historyserver</code></pre> 
<p><img alt="" height="219" src="https://images2.imgbox.com/89/57/6IlvoPJM_o.png" width="836"></p> 
<p></p> 
<h5 id="4)%C2%A0%E5%A6%82%E6%9E%9C%E6%83%B3%E5%B1%95%E7%A4%BA%E6%95%B0%E6%8D%AE%E5%80%BE%E6%96%9C%E6%95%88%E6%9E%9C%EF%BC%9A">4) 如果想展示数据倾斜效果：</h5> 
<p><br>     1.保证两张表的数据相差不大<br>     2.可以关闭MapJOIN优化，防止执行MapJOIN流程</p> 
<p>--查看具体的偏差的结果可以去 Reduce Tasks for job 历史中查看<br> -- 可以得到结论：数据倾斜之后 部分Reduce的执行时间明显比其他Reduce任务要长<br>  </p> 
<p></p> 
<h5 id="5)%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95%EF%BC%9A"><br> 5) 解决方法：</h5> 
<p><br> 1.对会产生笛卡尔积的数据进行初步过滤</p> 
<pre><code class="language-java">SELECT
T1.id
,count(*) as num
FROM learn4.student_null T1 JOIN learn4.score_null T2 ON T1.id = T2.id  
AND (T1.id != "null_student" or T2.id != "null_student")
GROUP BY T1.id;</code></pre> 
<p><br> 2.可以对Key比较集中的数据进行加随机数，然后再进行处理</p> 
<pre><code class="language-java">SELECT
T1.id
,count(*) as num
FROM learn4.student_null T1 JOIN learn4.score_null T2 ON concat(T1.id,floor((rand()*10)%5)) = concat(T2.id,floor((rand()*10)%5)) 
GROUP BY T1.id;


SELECT
substring(T.id,1,-1) as id
,sum(T.num) --对打散的ID统计过的结果进行汇总
FROM (
SELECT
T1.id 
,count(*) as num    --对打散的ID进行统计
FROM (
SELECT
concat(T1.id,floor((rand()*10)%5)) as id  --将T1表中的数据进行打散
FROM learn4.student_null) T1
JOIN 
(
SELECT
concat(T1.id,floor((rand()*10)%5)) as id  --将T2表中的数据进行打散
FROM learn4.score_null) T2 ON T1.id =T2.id
)T GROUP BY substring(T.id,1,-1);</code></pre> 
<p></p> 
<p>3.通过参数进行调整</p> 
<p><br> 设置开启Map端的聚合操作</p> 
<pre><code class="language-java">set hive.map.aggr = true</code></pre> 
<p></p> 
<p>设置groupby的检查点条数</p> 
<pre><code class="language-java">set hive.groupby.mapaggr.checkinterval = 100000</code></pre> 
<p><br> 开启GROUP BY 的负载均衡操作</p> 
<pre><code class="language-java">set hive.groupby.skewindata = true 

</code></pre> 
<p></p> 
<p>通过调整该参数，使得有倾斜的数据在Map reduce过程中 被随机的从Map端发送到Reduce端进行处理，</p> 
<p>reduce会对随机发送过来的数据进行 初步的处理，之后再进行后续的统计</p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9b2f164ff7c92c640aef8c08fcbe806f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android Studio实现美食外卖系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6e525e226cbcb911f2a65eaab8a31941/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">whisper报错：hp， ht， pid， tid = _winapi.CreateProcess [WinError 2] 系统找不到指定的文件。</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>