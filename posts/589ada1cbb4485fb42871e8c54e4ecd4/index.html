<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于星火大模型的群聊对话分角色要素提取挑战赛|#AI夏令营#Datawhale#夏令营-Lora微调与prompt构造 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/589ada1cbb4485fb42871e8c54e4ecd4/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="基于星火大模型的群聊对话分角色要素提取挑战赛|#AI夏令营#Datawhale#夏令营-Lora微调与prompt构造">
  <meta property="og:description" content="赛题连接 https://challenge.xfyun.cn/topic/info?type=role-element-extraction&amp;option=phb
Datawhale Al夏令营 零基础入门大模型技术竞赛 数据集预处理 由于赛题官方限定使用了星火大模型，所以只能调用星火大模型的API或者使用零代码微调
首先训练数据很少是有129条，其中只有chat_text和infos两个属性，chat_text是聊天文本，infos就是提取的信息也是训练集标签，他的平均长度有6000左右对于星火对于信息提取任务已经很长了，而且最长的将近30000，如果使用星火大模型进行询问肯定是要被截断的，而且微调上传的数据也是有最大长度的，我门需要对数据进行处理。
数据简单清洗 简单的导包
from dataclasses import dataclass from sparkai.llm.llm import ChatSparkLLM, ChunkPrintHandler from sparkai.core.messages import ChatMessage import pandas as pd import os import json import re import matplotlib.pyplot as plt from tqdm import tqdm from math import ceil import numpy as np from copy import deepcopy import random tqdm.pandas() plt.rcParams[&#39;font.family&#39;] = [&#39;STFangsong&#39;] plt.rcParams[&#39;axes.unicode_minus&#39;] = False 加载数据
data_dir = &#34;./data&#34; train_file = &#34;train.json&#34; test_file = &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-02T08:55:05+08:00">
    <meta property="article:modified_time" content="2024-07-02T08:55:05+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于星火大模型的群聊对话分角色要素提取挑战赛|#AI夏令营#Datawhale#夏令营-Lora微调与prompt构造</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>赛题连接</h2> 
<p><a href="https://challenge.xfyun.cn/topic/info?type=role-element-extraction&amp;option=phb" rel="nofollow">https://challenge.xfyun.cn/topic/info?type=role-element-extraction&amp;option=phb</a></p> 
<h2><a id="Datawhale_Al__2"></a>Datawhale Al夏令营 零基础入门大模型技术竞赛</h2> 
<p><img src="https://images2.imgbox.com/a2/67/IlVj8K3e_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_6"></a>数据集预处理</h2> 
<p>由于赛题官方限定使用了星火大模型，所以只能调用星火大模型的API或者使用零代码微调<br> 首先训练数据很少是有129条，其中只有<code>chat_text</code>和<code>infos</code>两个属性，<code>chat_text</code>是聊天文本，<code>infos</code>就是提取的信息也是训练集标签，他的平均长度有6000左右对于星火对于信息提取任务已经很长了，而且最长的将近30000，如果使用星火大模型进行询问肯定是要被截断的，而且微调上传的数据也是有最大长度的，我门需要对数据进行处理。<br> <img src="https://images2.imgbox.com/ac/32/9tLN67ZN_o.png" alt="请添加图片描述"></p> 
<h4><a id="_11"></a>数据简单清洗</h4> 
<p>简单的导包</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass
<span class="token keyword">from</span> sparkai<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>llm <span class="token keyword">import</span> ChatSparkLLM<span class="token punctuation">,</span> ChunkPrintHandler
<span class="token keyword">from</span> sparkai<span class="token punctuation">.</span>core<span class="token punctuation">.</span>messages <span class="token keyword">import</span> ChatMessage
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token keyword">import</span> re
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">from</span> math <span class="token keyword">import</span> ceil
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> copy <span class="token keyword">import</span> deepcopy
<span class="token keyword">import</span> random

tqdm<span class="token punctuation">.</span>pandas<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.family'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'STFangsong'</span><span class="token punctuation">]</span>
plt<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'axes.unicode_minus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre> 
<p>加载数据</p> 
<pre><code class="prism language-python">data_dir <span class="token operator">=</span> <span class="token string">"./data"</span>
train_file <span class="token operator">=</span> <span class="token string">"train.json"</span>
test_file <span class="token operator">=</span> <span class="token string">"test_data.json"</span>

train_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_json<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> train_file<span class="token punctuation">)</span><span class="token punctuation">)</span>
test_data <span class="token operator">=</span>  pd<span class="token punctuation">.</span>read_json<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> test_file<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>首先我们发现数据集中有许多<code>[图片]</code>和<code>超链接</code>，这些对数据提取作用不大，我们可以将其去掉，</p> 
<pre><code class="prism language-python"><span class="token comment"># 删除表情图片、超链接</span>
train_data<span class="token punctuation">[</span><span class="token string">'chat_text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> train_data<span class="token punctuation">[</span><span class="token string">'chat_text'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">r"\[[^\[\]]{2,10}\]"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> regex<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
train_data<span class="token punctuation">[</span><span class="token string">'chat_text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> train_data<span class="token punctuation">[</span><span class="token string">'chat_text'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"https?://\S+"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> regex<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_data<span class="token punctuation">[</span><span class="token string">'chat_text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token string">'chat_text'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">r"\[[^\[\]]{2,10}\]"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> regex<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test_data<span class="token punctuation">[</span><span class="token string">'chat_text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">[</span><span class="token string">'chat_text'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"https?://\S+"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> regex<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p>对于<code>一个人</code>连续的对话我们可以哦将其<code>合并</code>成一个对话</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_names_phones_and_emails</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">:</span>
    names <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"(?:\n)?([\u4e00-\u9fa5]+\d+)："</span><span class="token punctuation">,</span> example<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    names <span class="token operator">+=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"@([\u4e00-\u9fa5]+)\s"</span><span class="token punctuation">,</span> example<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    emails <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}"</span><span class="token punctuation">,</span> example<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># phones = re.findall(r"1[356789]\d{9}", example["chat_text"]) # 文本中的手机号并不是标准手机号</span>
    phones <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"\d{3}\s*\d{4}\s*\d{4}"</span><span class="token punctuation">,</span> example<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">set</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token punctuation">(</span>phones<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">set</span><span class="token punctuation">(</span>emails<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'names'</span><span class="token punctuation">,</span> <span class="token string">'phones'</span><span class="token punctuation">,</span> <span class="token string">'emails'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">merge_chat</span><span class="token punctuation">(</span>example<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> name <span class="token keyword">in</span> example<span class="token punctuation">[</span><span class="token string">'names'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        example<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span> <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string">："</span></span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"&lt;|sep|&gt;</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string">："</span></span><span class="token punctuation">)</span>
    chats <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;|sep|&gt;"</span><span class="token punctuation">)</span>
    
    last_name <span class="token operator">=</span> <span class="token string">"UNKNOWN"</span>
    new_chats <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> chat <span class="token keyword">in</span> chats<span class="token punctuation">:</span>
        <span class="token keyword">if</span> chat<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span>last_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
            chat <span class="token operator">=</span> chat<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
            chat <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>chat<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"："</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            new_chats<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token string">" "</span> <span class="token operator">+</span> chat
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            new_chats<span class="token punctuation">.</span>append<span class="token punctuation">(</span>chat<span class="token punctuation">)</span>
            last_name <span class="token operator">=</span> chat<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"："</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>new_chats<span class="token punctuation">)</span><span class="token punctuation">,</span> new_chats<span class="token punctuation">]</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"chats"</span><span class="token punctuation">,</span> <span class="token string">"chat_list"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 使用正则表达式获得'names', 'phones', 'emails'</span>
train_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'names'</span><span class="token punctuation">,</span> <span class="token string">'phones'</span><span class="token punctuation">,</span> <span class="token string">'emails'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> train_data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>get_names_phones_and_emails<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
test_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'names'</span><span class="token punctuation">,</span> <span class="token string">'phones'</span><span class="token punctuation">,</span> <span class="token string">'emails'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>get_names_phones_and_emails<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># 分割聊天记录， 合并连续相同人的聊天</span>
train_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"chats"</span><span class="token punctuation">,</span> <span class="token string">"chat_list"</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> train_data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>merge_chat<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
test_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"chats"</span><span class="token punctuation">,</span> <span class="token string">"chat_list"</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>merge_chat<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/cb/ce/hUrkf8kn_o.png" alt="请添加图片描述"></p> 
<h4><a id="_85"></a>补充</h4> 
<p>补充：后面我们发现数据中<code>chat_text</code>中有许多是重复多编的，我们需要把重复的也给去除掉，这样处理后的数据就会大大减小，使用暴力匹配去除<br> <img src="https://images2.imgbox.com/1a/f7/rDK17mpq_o.png" alt="请添加图片描述"></p> 
<pre><code class="prism language-py"><span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>excemple<span class="token punctuation">)</span><span class="token punctuation">:</span>
    chat_list <span class="token operator">=</span> excemple<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>

    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    s <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> s <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chat_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
        
        i<span class="token punctuation">,</span> j <span class="token operator">=</span> s<span class="token punctuation">,</span> s<span class="token operator">+</span><span class="token number">1</span>
        start_j <span class="token operator">=</span> j
        <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chat_list<span class="token punctuation">)</span> <span class="token keyword">and</span> j <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chat_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> chat_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> chat_list<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">:</span>
                i <span class="token operator">+=</span> <span class="token number">1</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> i <span class="token operator">!=</span> s<span class="token punctuation">:</span>
                    <span class="token keyword">if</span> j <span class="token operator">-</span> start_j <span class="token operator">&gt;</span><span class="token number">10</span><span class="token punctuation">:</span>
                        res <span class="token operator">+=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>start_j<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    i <span class="token operator">=</span> s
                start_j <span class="token operator">=</span> j
            j <span class="token operator">+=</span> <span class="token number">1</span>
        s <span class="token operator">+=</span> <span class="token number">1</span>
    texts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>chat_list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> i <span class="token keyword">not</span> <span class="token keyword">in</span> res<span class="token punctuation">:</span>
            texts<span class="token punctuation">.</span>append<span class="token punctuation">(</span>chat_list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>texts<span class="token punctuation">)</span>
                    

train_data<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span> <span class="token operator">=</span> train_data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
test_data<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span> <span class="token operator">=</span> test_data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> axis <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_122"></a>构造训练集</h3> 
<p>处理之后其实有些还是很长，我们可以有两种简单粗暴的方法</p> 
<ol><li>截断</li><li>分块<br> 对于构造训练数据，我们使用了第一种截断的方法，但这两种方法都有一定的缺点<br> 我们需要查看讯飞官方微调需要的训练集格式，这里我选择使用<code>JSONL</code>格式，并且其每一行是一个<code>JSON字符串</code>,格式为</li></ol> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"input"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string-property property">"target"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3b/5a/5QrgXIBm_o.png" alt="在这里插入图片描述"><br> 训练时我选用了讯飞的<code>spark pro</code>进行训练，其要求训练数据不少于<code>1500</code>条，每一个<code>input+target</code>长度不能大于<code>8000</code></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">process</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># 提示词，我们交代清楚大模型的角色、目标、注意事项，然后提供背景信息，输出格式就可以了</span>
    prompt <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""Instruction:
你是一个信息要素提取工作人员，你需要从给定的`ChatText`中提取出**客户**的`Infos`中相关信息，将提取的信息填到`Infos`中，
注意事项：
1. 没有的信息无需填写
2. 保持`Infos`的JSON格式不变，没有的信息项也要保留！！！
4. 姓名可以是聊天昵称
5. 注意是客户的信息，不是客服的信息
6. 可以有多个客户信息
ChatText:
</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">
"""</span></span>
	<span class="token comment"># 要求的输出格式</span>
    infos <span class="token operator">=</span> <span class="token triple-quoted-string string">""""
Infos:
infos": [{
    "基本信息-姓名": "",
    "基本信息-手机号码": "",
    "基本信息-邮箱": "",
    "基本信息-地区": "",
    "基本信息-详细地址": "",
    "基本信息-性别": "",
    "基本信息-年龄": "",
    "基本信息-生日": "",
    "咨询类型": [],
    "意向产品": [],
    "购买异议点": [],
    "客户预算-预算是否充足": "",
    "客户预算-总体预算金额": "",
    "客户预算-预算明细": "",
    "竞品信息": "",
    "客户是否有意向": "",
    "客户是否有卡点": "",
    "客户购买阶段": "",
    "下一步跟进计划-参与人": [],
    "下一步跟进计划-时间点": "",
    "下一步跟进计划-具体事项": ""
}]
"""</span>
	<span class="token comment"># prompt+infos是文件中的input，answer是文件中的target</span>
    answer <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>x<span class="token punctuation">[</span><span class="token string">"infos"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"""</span></span> <span class="token comment">#target</span>
    total<span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prompt <span class="token operator">+</span> infos <span class="token operator">+</span> answer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> total <span class="token operator">&gt;</span> <span class="token number">8000</span><span class="token punctuation">:</span>
        prompt <span class="token operator">=</span> prompt<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">-</span><span class="token builtin">len</span><span class="token punctuation">(</span>infos <span class="token operator">+</span> answer<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">[</span>prompt<span class="token punctuation">,</span> answer<span class="token punctuation">]</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"input"</span><span class="token punctuation">,</span> <span class="token string">"target"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

data <span class="token operator">=</span> train_data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment"># 测试集中的target并没有用可以忽略</span>
data <span class="token operator">=</span> test_data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>process<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment">#保存数据</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> <span class="token string">"my_train.jsonl"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>i<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> <span class="token string">"my_test.jsonl"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>i<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>对于训练数据不少于1500条的要求，我直接将训练集进行了多次复制，只要不少于1500条就可以训练。训练我只训练了两轮。<br> <img src="https://images2.imgbox.com/d3/6a/sW96yuoc_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_196"></a>使用官方零代码微调</h3> 
<p><img src="https://images2.imgbox.com/d6/be/oGTi8bqC_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_199"></a>测试</h3> 
<p>模型训练好后我们需要到官网将训练好的模型发布，这样才能够调用<br> <img src="https://images2.imgbox.com/dc/4b/YeRVg79f_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/81/d8/g3PvKDPM_o.png" alt="在这里插入图片描述"><br> 在我的服务中获取 <code>接口地址</code>、<code>APPID</code> 、<code>APIKey</code>、<code>APISecret</code>，不同版本会有不同</p> 
<p><img src="https://images2.imgbox.com/03/72/NDhE5O1e_o.png" alt="在这里插入图片描述"><br> 后续就可以写代码测试了，我们可以询问多轮然后进行投票，减少一次不确定性带来的误差，一轮其实已经可以达到26以上的分数了</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> sparkai<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>llm <span class="token keyword">import</span> ChatSparkLLM<span class="token punctuation">,</span> ChunkPrintHandler
<span class="token keyword">from</span> sparkai<span class="token punctuation">.</span>core<span class="token punctuation">.</span>messages <span class="token keyword">import</span> ChatMessage
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> os
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> json


spark <span class="token operator">=</span> ChatSparkLLM<span class="token punctuation">(</span>
    spark_api_url<span class="token operator">=</span><span class="token string">"wss://spark-api-n.xf-yun.com/v3.1/chat"</span><span class="token punctuation">,</span><span class="token comment">#spark pro微调的url</span>
    spark_app_id<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>
    spark_api_key<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>
    spark_api_secret<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>
    spark_llm_domain<span class="token operator">=</span><span class="token string">"patchv3"</span><span class="token punctuation">,</span> <span class="token comment">#spark pro微调的版本</span>
    streaming<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">save_result</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./data/result1.json"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token builtin">file</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>to_json<span class="token punctuation">(</span>orient<span class="token operator">=</span><span class="token string">'records'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> force_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"正在询问第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>j<span class="token punctuation">}</span></span><span class="token string">轮"</span></span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        messages <span class="token operator">=</span> <span class="token punctuation">[</span>ChatMessage<span class="token punctuation">(</span>
            role<span class="token operator">=</span><span class="token string">"user"</span><span class="token punctuation">,</span>
            content<span class="token operator">=</span>data<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"input"</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                handler <span class="token operator">=</span> ChunkPrintHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
                a <span class="token operator">=</span> spark<span class="token punctuation">.</span>generate<span class="token punctuation">(</span><span class="token punctuation">[</span>messages<span class="token punctuation">]</span><span class="token punctuation">,</span> callbacks<span class="token operator">=</span><span class="token punctuation">[</span>handler<span class="token punctuation">]</span><span class="token punctuation">)</span>
                a <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>a<span class="token punctuation">.</span>generations<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"'"</span><span class="token punctuation">,</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"出错了"</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span>
            res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    multi_res<span class="token punctuation">.</span>append<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    test_data<span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"infos_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>j<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> res
    save_result<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span>
</code></pre> 
<p>多轮投票</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Counter<span class="token punctuation">,</span> defaultdict


template_infos <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"基本信息-姓名"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"基本信息-手机号码"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"基本信息-邮箱"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"基本信息-地区"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"基本信息-详细地址"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"基本信息-性别"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"基本信息-年龄"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"基本信息-生日"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"咨询类型"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"意向产品"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"购买异议点"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"客户预算-预算是否充足"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"客户预算-总体预算金额"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"客户预算-预算明细"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"竞品信息"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"客户是否有意向"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"客户是否有卡点"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"客户购买阶段"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"下一步跟进计划-参与人"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"下一步跟进计划-时间点"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"下一步跟进计划-具体事项"</span><span class="token punctuation">:</span> <span class="token string">""</span>
<span class="token punctuation">}</span>
result_Infos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">## 这里的代码已经不是我最初始的代码了，可能会影响到效果，最初我是不管有结果个用户，只投出一个用户，其他信息也是直接全部投票，没有使用根据'基本信息-姓名'进行分开投票，可以自行尝试，投票还是可以提升一点分数的</span>
<span class="token keyword">for</span> multi_infos <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token operator">*</span>multi_res<span class="token punctuation">)</span><span class="token punctuation">:</span>
    names_info_dict <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> infos <span class="token keyword">in</span> multi_infos<span class="token punctuation">:</span>
        <span class="token keyword">for</span> info <span class="token keyword">in</span> infos<span class="token punctuation">:</span>
            names_info_dict<span class="token punctuation">[</span>info<span class="token punctuation">[</span><span class="token string">'基本信息-姓名'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>info<span class="token punctuation">)</span>
    res_infos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> name <span class="token keyword">in</span> names_info_dict<span class="token punctuation">:</span>
        l <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>names_info_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
        <span class="token keyword">if</span> l <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        infos <span class="token operator">=</span> template_infos<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
      
        <span class="token keyword">for</span> attr <span class="token keyword">in</span> template_infos<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>template_infos<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                val_freq <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token punctuation">[</span>multi_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span>attr<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token keyword">for</span> multi_info <span class="token keyword">in</span> names_info_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                top_2 <span class="token operator">=</span> val_freq<span class="token punctuation">.</span>most_common<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>top_2<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    val <span class="token operator">=</span> top_2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> top_2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">""</span> <span class="token keyword">and</span> top_2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> l<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">:</span>
                        val <span class="token operator">=</span> <span class="token string">""</span>
                    <span class="token keyword">elif</span> top_2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>
                        val <span class="token operator">=</span> top_2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        val <span class="token operator">=</span> top_2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> 
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                val_freq <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token keyword">for</span> multi_info <span class="token keyword">in</span> names_info_dict<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">:</span>
                    val_freq<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">(</span>multi_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span>attr<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                val_freq <span class="token operator">=</span> Counter<span class="token punctuation">(</span>val_freq<span class="token punctuation">)</span>
                val <span class="token operator">=</span><span class="token punctuation">[</span>val <span class="token keyword">for</span> val<span class="token punctuation">,</span> freq <span class="token keyword">in</span> val_freq<span class="token punctuation">.</span>most_common<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">if</span> freq <span class="token operator">&gt;</span> l<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">]</span>
            infos<span class="token punctuation">[</span>attr<span class="token punctuation">]</span> <span class="token operator">=</span> val
        res_infos<span class="token punctuation">.</span>append<span class="token punctuation">(</span>infos<span class="token punctuation">)</span>
        <span class="token comment"># if len(res_infos) &gt;= 2:</span>
        <span class="token comment">#     print(len(names_info_dict[name]),res_infos)</span>
    result_Infos<span class="token punctuation">.</span>append<span class="token punctuation">(</span>res_infos<span class="token punctuation">)</span>
test_data<span class="token punctuation">[</span><span class="token string">"infos"</span><span class="token punctuation">]</span> <span class="token operator">=</span> result_Infos
save_result<span class="token punctuation">(</span>test_data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"chat_text"</span><span class="token punctuation">,</span> <span class="token string">"infos"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_321"></a>总结</h2> 
<p>以上只是一个简洁的思路，如果有其他想法欢迎在评论区留言。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0d3d9a9352ad8761548f36312b1e67a8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue项目访问 域名/index.html 空页面问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e4bab9cde1b468cad9f90823fdb66e6a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【微服务】微服务之Feign 与 Ribbon</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>