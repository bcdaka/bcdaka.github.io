<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Spring Cloud】全面解析服务容错中间件 Sentinel 持久化两种模式 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/961f290acb3a49ba50d4347dbef548fc/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Spring Cloud】全面解析服务容错中间件 Sentinel 持久化两种模式">
  <meta property="og:description" content="文章目录 推送模式本地文件持久化（拉模式）配置yml编写处理类添加配置演示 配置中心持久化（推模式）修改nacos在sentinel中生效引入依赖配置文件 修改sentinel在nacos中生效下载源码更改代码演示 总结 推送模式 Sentinel 规则的推送有下面三种模式:
通过前面的讲解，我们已经知道，可以通过 Dashboard 来为每个 Sentinel 客户端设置各种各样的规则，这种属于原始模式。这种模式存在一个问题，就是这些规则默认是存放在内存中的，极不稳定，所以需要将其持久化。
为了达到持久化的目标，我们需要进行改造，改造的方案有两种：本地文件持久化（拉模式）、配置中心持久化（推模式）
本地文件持久化（拉模式） 拉模式又被称为 pull 模式，它的数据源（如本地文件、RDBMS等）一般是可写入的。本地文件数据源会定时轮询文件的变更，读取规则。这样我们既可以在应用本地直接修改文件来更新规则，也可以通过 Sentinel 控制台推送规则。以本地文件数据源为例，推送过程如下图所示：
首先 Sentinel 控制台通过API将规则推送至客户端并更新到内存中，接着注册的写数据源会将新的规则保存到本地的文件中。使用 pull模式的数据源时一般不需要对Sentinel控制台进行改造。这种实现方法好处是简单，坏处是无法保证监控数据的一致性。
配置yml #数据库配置 spring: cloud: sentinel: eager: true transport: port: 9998 #跟控制台交流的端口，随意指定一个未使用的端口即可 dashboard: localhost:8080 #指定控制台服务的地址 filter: enabled: false 编写处理类 实现 InitFunc 接口，在 init 中处理 DataSource 初始化逻辑，并利用 SPI 机制实现加载。
public class FilePersistence implements InitFunc { @Value(&#34;${spring.application.name}&#34;) private String applicationName; @Override public void init() throws Exception { //创建规则文件 String ruleDir = System.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-21T10:49:22+08:00">
    <meta property="article:modified_time" content="2024-05-21T10:49:22+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Spring Cloud】全面解析服务容错中间件 Sentinel 持久化两种模式</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">推送模式</a></li><li><a href="#_11" rel="nofollow">本地文件持久化（拉模式）</a></li><li><ul><li><a href="#yml_18" rel="nofollow">配置yml</a></li><li><a href="#_31" rel="nofollow">编写处理类</a></li><li><a href="#_106" rel="nofollow">添加配置</a></li><li><a href="#_110" rel="nofollow">演示</a></li></ul> 
  </li><li><a href="#_138" rel="nofollow">配置中心持久化（推模式）</a></li><li><ul><li><a href="#nacossentinel_143" rel="nofollow">修改nacos在sentinel中生效</a></li><li><ul><li><a href="#_144" rel="nofollow">引入依赖</a></li><li><a href="#_160" rel="nofollow">配置文件</a></li></ul> 
   </li><li><a href="#sentinelnacos_269" rel="nofollow">修改sentinel在nacos中生效</a></li><li><ul><li><a href="#_272" rel="nofollow">下载源码</a></li><li><a href="#_287" rel="nofollow">更改代码</a></li><li><a href="#_369" rel="nofollow">演示</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_377" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>推送模式</h2> 
<p>Sentinel 规则的推送有下面三种模式:<br> <img src="https://images2.imgbox.com/f5/d1/c8ULyNsQ_o.png" alt="在这里插入图片描述"></p> 
<p>通过前面的讲解，我们已经知道，可以通过 Dashboard 来为每个 Sentinel 客户端设置各种各样的规则，这种属于原始模式。这种模式存在一个问题，就是这些规则默认是存放在内存中的，极不稳定，所以需要将其持久化。</p> 
<p><img src="https://images2.imgbox.com/ff/af/8wZmBil2_o.png" alt="在这里插入图片描述"></p> 
<p>为了达到持久化的目标，我们需要进行改造，改造的方案有两种：本地文件持久化（拉模式）、配置中心持久化（推模式）</p> 
<h2><a id="_11"></a>本地文件持久化（拉模式）</h2> 
<p>拉模式又被称为 pull 模式，它的数据源（如本地文件、RDBMS等）一般是可写入的。<strong>本地文件数据源</strong>会定时轮询文件的变更，读取规则。这样我们既可以在应用本地直接修改文件来更新规则，也可以通过 Sentinel 控制台推送规则。以本地文件数据源为例，推送过程如下图所示：</p> 
<p><img src="https://images2.imgbox.com/3c/56/IPTXN2Lv_o.png" alt="在这里插入图片描述"></p> 
<p>首先 Sentinel 控制台通过API将规则推送至客户端并更新到内存中，接着注册的写数据源会将新的规则保存到本地的文件中。使用 pull模式的数据源时一般不需要对Sentinel控制台进行改造。这种实现方法好处是简单，坏处是无法保证监控数据的一致性。</p> 
<h3><a id="yml_18"></a>配置yml</h3> 
<pre><code class="prism language-yml"><span class="token comment">#数据库配置</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">eager</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9998</span> <span class="token comment">#跟控制台交流的端口，随意指定一个未使用的端口即可</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>  <span class="token comment">#指定控制台服务的地址</span>
      <span class="token key atrule">filter</span><span class="token punctuation">:</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> 
<h3><a id="_31"></a>编写处理类</h3> 
<p>实现 InitFunc 接口，在 init 中处理 DataSource 初始化逻辑，并利用 SPI 机制实现加载。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FilePersistence</span> <span class="token keyword">implements</span> <span class="token class-name">InitFunc</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${spring.application.name}"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> applicationName<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建规则文件</span>
        <span class="token class-name">String</span> ruleDir <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"user.home"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/sentinel-rules/"</span> <span class="token operator">+</span> applicationName<span class="token punctuation">;</span>
        <span class="token class-name">String</span> flowRulePath <span class="token operator">=</span> ruleDir <span class="token operator">+</span> <span class="token string">"/flow-rule.json"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> degradeRulePath <span class="token operator">=</span> ruleDir <span class="token operator">+</span> <span class="token string">"/degrade-rule.json"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> systemRulePath <span class="token operator">=</span> ruleDir <span class="token operator">+</span> <span class="token string">"/system-rule.json"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> authorityRulePath <span class="token operator">=</span> ruleDir <span class="token operator">+</span> <span class="token string">"/authority-rule.json"</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> paramFlowRulePath <span class="token operator">=</span> ruleDir <span class="token operator">+</span> <span class="token string">"/param-flow-rule.json"</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">mkdirIfNotExits</span><span class="token punctuation">(</span>ruleDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createFileIfNotExits</span><span class="token punctuation">(</span>flowRulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createFileIfNotExits</span><span class="token punctuation">(</span>degradeRulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createFileIfNotExits</span><span class="token punctuation">(</span>systemRulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createFileIfNotExits</span><span class="token punctuation">(</span>authorityRulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createFileIfNotExits</span><span class="token punctuation">(</span>paramFlowRulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//流控规则</span>
        <span class="token comment">//创建流控规则的可读数据源</span>
        <span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> flowRuleRDS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileRefreshableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>flowRulePath<span class="token punctuation">,</span>
                source <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将可读数据源注册至 FlowRuleManager,这样当规则文件发生变化时，就会更新规则到内存</span>
        <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>flowRuleRDS<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WritableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> flowRuleWDS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWritableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>flowRulePath<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">encodeJson</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将可写数据源注册至 transport 模块的 WritableDataSourceRegistry 中.</span>
        <span class="token comment">//这样收到控制台推送的规则时，Sentinel 会先更新到内存，然后将规则写入到文件中.</span>
        <span class="token class-name">WritableDataSourceRegistry</span><span class="token punctuation">.</span><span class="token function">registerFlowDataSource</span><span class="token punctuation">(</span>flowRuleWDS<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//降级规则</span>
        <span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> degradeRuleRDS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileRefreshableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>degradeRulePath<span class="token punctuation">,</span>
                source <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>degradeRuleRDS<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WritableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> degradeRuleWDS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWritableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>degradeRulePath<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">encodeJson</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WritableDataSourceRegistry</span><span class="token punctuation">.</span><span class="token function">registerDegradeDataSource</span><span class="token punctuation">(</span>degradeRuleWDS<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//系统规则</span>
        <span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SystemRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> systemRuleRDS<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileRefreshableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>systemRulePath<span class="token punctuation">,</span>
                source <span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SystemRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SystemRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>systemRuleRDS<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WritableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SystemRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> systemRuleWDS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWritableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>systemRulePath<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">encodeJson</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WritableDataSourceRegistry</span><span class="token punctuation">.</span><span class="token function">registerSystemDataSource</span><span class="token punctuation">(</span>systemRuleWDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//授权规则</span>
        <span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> authorityRuleRDS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileRefreshableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>authorityRulePath<span class="token punctuation">,</span>
                source<span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AuthorityRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>authorityRuleRDS<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WritableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">AuthorityRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> authorityRuleWDS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWritableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>authorityRulePath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">::</span><span class="token function">encodeJson</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WritableDataSourceRegistry</span><span class="token punctuation">.</span><span class="token function">registerAuthorityDataSource</span><span class="token punctuation">(</span>authorityRuleWDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//热点参数规则</span>
        <span class="token class-name">ReadableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ParamFlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> paramFlowRuleRDS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileRefreshableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>paramFlowRulePath<span class="token punctuation">,</span>
                source<span class="token operator">-&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ParamFlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ParamFlowRuleManager</span><span class="token punctuation">.</span><span class="token function">register2Property</span><span class="token punctuation">(</span>paramFlowRuleRDS<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">WritableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ParamFlowRule</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> paramFlowRuleWDS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWritableDataSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>paramFlowRulePath<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">encodeJson</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ModifyParamFlowRulesCommandHandler</span><span class="token punctuation">.</span><span class="token function">setWritableDataSource</span><span class="token punctuation">(</span>paramFlowRuleWDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>FileRefreshableDataSource：每次更新规则时自动读取持久化文件更新到map缓存。</li><li>FileWritableDataSource：写数据源，将 sentinel 控制台发送过来的规则信息写到持久化文件中。在客户端的socket接收到规则信息后，更新缓存的时候也会将规则信息写入文件中持久化。</li></ul> 
<h3><a id="_106"></a>添加配置</h3> 
<p>在resources下创建配置目录 <code>META-INF/services</code>，然后添加文件<code>com.alibaba.csp.sentinel.init.InitFunc</code>，在文件中添加配置类的全路径<code>it.aq.cheetah.config.FilePersistence</code>。</p> 
<p>这样当在 Dashboard 中修改了配置后，Dashboard 会调用客户端的接口修改客户端内存中的值，同时将配置写入文件中，这样操作的话规则是实时生效的，如果是直接修改文件中的内容，这样需要等定时任务3秒后执行才能读到最新的规则。接下来我们演示下：</p> 
<h3><a id="_110"></a>演示</h3> 
<p>编写测试类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/product2"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductController2</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"test"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"product2"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>启动项目，发现在目录下生成了空的规则文件</p> 
<p><img src="https://images2.imgbox.com/9b/60/pnvlF8AS_o.png" alt="在这里插入图片描述"><br> 在页面上增加流控规则</p> 
<p><img src="https://images2.imgbox.com/fa/59/aWYSPdJy_o.png" alt="在这里插入图片描述"></p> 
<p>然后去看文件<code>flow-rule.json</code>，发现存到了本地文件中</p> 
<p><img src="https://images2.imgbox.com/e4/2c/1vbQWvDi_o.png" alt="在这里插入图片描述"><br> 接着我们仿照该规则仿写一个熔断规则，然后查看网页数据确实生效了</p> 
<p><img src="https://images2.imgbox.com/e3/42/BdMnHTg7_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_138"></a>配置中心持久化（推模式）</h2> 
<p>推模式又叫 Push 模式，它是通过注册中心实现的，Sentinel控制台——&gt;配置中心——&gt;Sentinel数据源——&gt;Sentinel<br> <img src="https://images2.imgbox.com/54/70/IMOK7PYU_o.png" alt="在这里插入图片描述"><br> 用户不仅可以通过sentinel控制台进行更新，也可以通过nacos配置中心进行更新，所以在sentinel控制台或nacos中修改规则后，都需要通知对方刷新最新的配置。</p> 
<h3><a id="nacossentinel_143"></a>修改nacos在sentinel中生效</h3> 
<h4><a id="_144"></a>引入依赖</h4> 
<p>我们在之前项目的基础上引入新的依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--nacos配置中心--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

 <span class="token comment">&lt;!--以nacos作为sentinel数据源的依赖--&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>sentinel-datasource-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="_160"></a>配置文件</h4> 
<p>nacos 配置：因为我们用nacos作为了配置中心，我们可以将sentinel的基本配置放入到nacos中就可以了，所以当前服务的yml配置文件中只需要写一些基本的配置就可以了。</p> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yml
</code></pre> 
<p>在nacos中配置sentinel信息</p> 
<pre><code class="prism language-yml"><span class="token key atrule">spring</span><span class="token punctuation">:</span> 
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token comment"># 跟控制台交流的端口，随意指定一个未使用的端口即可</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9998</span> 
        <span class="token comment"># 指定控制台服务的地址</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span>  
      <span class="token comment"># sentinel用nacos作为数据源的配置</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span> 
        <span class="token comment">#流控管理（这个名称可以自定义）</span>
        <span class="token key atrule">flow-control</span><span class="token punctuation">:</span> 
          <span class="token comment"># 告诉sentinel用nacos作为数据源</span>
          <span class="token key atrule">nacos</span><span class="token punctuation">:</span> 
            <span class="token comment"># 配置中心里执行文件的 dataId</span>
            <span class="token key atrule">dataId</span><span class="token punctuation">:</span> shop<span class="token punctuation">-</span>product<span class="token punctuation">-</span>flow.json  
            <span class="token comment"># nacos的地址</span>
            <span class="token key atrule">serverAddr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span> 
            <span class="token comment"># 指定文件配置的是哪种规则</span>
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> flow
</code></pre> 
<blockquote> 
 <p>注意：如果使用的 namespace 不是默认的，记得配置 namespace 参数。</p> 
</blockquote> 
<ul><li>dataId：需要告诉 sentinel 读取配置中心中的哪个配置文件；</li><li>rule-type：告诉 sentinel 配置文件配置的控制规则，flow：流控、degrade：熔断、param-flow 热点参数，想看有哪些规则参数可以查看<code>com.alibaba.cloud.sentinel.datasource</code>包下的枚举类：RuleType。</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">RuleType</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * flow.
	 */</span>
	<span class="token function">FLOW</span><span class="token punctuation">(</span><span class="token string">"flow"</span><span class="token punctuation">,</span> <span class="token class-name">FlowRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token comment">/**
	 * degrade.
	 */</span>
	<span class="token function">DEGRADE</span><span class="token punctuation">(</span><span class="token string">"degrade"</span><span class="token punctuation">,</span> <span class="token class-name">DegradeRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token comment">/**
	 * param flow.
	 */</span>
	<span class="token function">PARAM_FLOW</span><span class="token punctuation">(</span><span class="token string">"param-flow"</span><span class="token punctuation">,</span> <span class="token class-name">ParamFlowRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token comment">/**
	 * system.
	 */</span>
	<span class="token function">SYSTEM</span><span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token class-name">SystemRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token comment">/**
	 * authority.
	 */</span>
	<span class="token function">AUTHORITY</span><span class="token punctuation">(</span><span class="token string">"authority"</span><span class="token punctuation">,</span> <span class="token class-name">AuthorityRule</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token comment">/**
	 * gateway flow.
	 */</span>
	<span class="token function">GW_FLOW</span><span class="token punctuation">(</span><span class="token string">"gw-flow"</span><span class="token punctuation">,</span>
			<span class="token string">"com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayFlowRule"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token comment">/**
	 * api.
	 */</span>
	<span class="token function">GW_API_GROUP</span><span class="token punctuation">(</span><span class="token string">"gw-api-group"</span><span class="token punctuation">,</span>
			<span class="token string">"com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiDefinition"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>shop-product-flow.json</code>文件中配置【流控规则】</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token string-property property">"clusterConfig"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token string-property property">"acquireRefuseStrategy"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			<span class="token string-property property">"clientOfflineTime"</span><span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
			<span class="token string-property property">"fallbackToLocalWhenFail"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			<span class="token string-property property">"resourceTimeout"</span><span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
			<span class="token string-property property">"resourceTimeoutStrategy"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			<span class="token string-property property">"sampleCount"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
			<span class="token string-property property">"strategy"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			<span class="token string-property property">"thresholdType"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
			<span class="token string-property property">"windowIntervalMs"</span><span class="token operator">:</span> <span class="token number">1000</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token string-property property">"clusterMode"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
		<span class="token string-property property">"controlBehavior"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token number">10.0</span><span class="token punctuation">,</span>
		<span class="token string-property property">"grade"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
		<span class="token string-property property">"limitApp"</span><span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
		<span class="token string-property property">"maxQueueingTimeMs"</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
		<span class="token string-property property">"resource"</span><span class="token operator">:</span> <span class="token string">"/product2/test"</span><span class="token punctuation">,</span>
		<span class="token string-property property">"strategy"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
		<span class="token string-property property">"warmUpPeriodSec"</span><span class="token operator">:</span> <span class="token number">10</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b1/bd/wOmvULJy_o.png" alt="在这里插入图片描述"></p> 
<p>然后去 dashboard 中查看，发现流控规则已经在控制中显示了</p> 
<p><img src="https://images2.imgbox.com/9f/a7/Gc5vswK1_o.png" alt="在这里插入图片描述"><br> 目前我们已经实现了在 nacos 中配置的文件直接在<code>sentinel dashboard</code>中生效，但是我们在<code>sentinel dashboard</code>中修改了配置，nacos 是不会监听到并进行修改的。接下来我们实现一下通过 sentinel 控制台设置的规则直接持久化到 nacos配置中心。</p> 
<h3><a id="sentinelnacos_269"></a>修改sentinel在nacos中生效</h3> 
<p>Sentinel 控制台提供 <code>DynamicRulePublisher</code> 和 <code>DynamicRuleProvider</code> 接口用于实现应用维度的规则推送和拉取。</p> 
<h4><a id="_272"></a>下载源码</h4> 
<p><code>https://github.com/alibaba/Sentinel/releases</code>下载dashboard的代码源码。</p> 
<p><img src="https://images2.imgbox.com/c4/32/r4dcCOlw_o.png" alt="在这里插入图片描述"></p> 
<p>解压之后打开<code>sentinel-dashboard</code>项目，将 pom.xml 文件中作用域为 test 的注释掉，注释掉后默认的作用域为 compile。</p> 
<ul><li>test：作用域表示该依赖项只在测试时有用，在编译和运行时不会被用到。</li><li>compile：作用域范围的依赖项在所有情况下都是有效的，包括编译、运行和测试。</li></ul> 
<p>把 test 包下的两个类复制过来</p> 
<p><img src="https://images2.imgbox.com/e5/f3/U7q7QRY3_o.png" alt="在这里插入图片描述"></p> 
<ul><li><code>NacosConfigUtil</code> 类主要就是 nacos 配置的规则，比如配置文件的后缀，分组Group_ID等等。因为我用的分组是默认分组，所以改为<code>DEFAULT_GROUP</code>，我之前的规则文件是<code>shop-product-flow.json</code>，所以我把规则文件后缀<code>FLOW_DATA_ID_POSTFIX</code>改为"-flow.json"。</li><li><code>NacosConfig</code>类是为了注入nacos的信息以及转换器类。</li></ul> 
<h4><a id="_287"></a>更改代码</h4> 
<p><code>application.properties </code>中增加 nacos 的配置</p> 
<pre><code class="prism language-xml"># nacos 配置
nacos.serverAddr=localhost:8848
nacos.username=nacos
nacos.password=nacos
</code></pre> 
<p><code>NacosConfig</code> 修改为从配置文件中获取nacos配置</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Bean</span>
 <span class="token keyword">public</span> <span class="token class-name">ConfigService</span> <span class="token function">nacosConfigService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
     <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//Nacos地址</span>
     properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"serverAddr"</span><span class="token punctuation">,</span> serverAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//Nacos用户名</span>
     properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//Nacos密码</span>
     properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"password"</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token class-name">ConfigFactory</span><span class="token punctuation">.</span><span class="token function">createConfigService</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>在<code>com.alibaba.csp.sentinel.dashboard.rule.FlowRuleApiPublisher#publish</code>方法中增加推送到nacos的逻辑代码</p> 
<pre><code class="prism language-java"><span class="token comment">//将规则推送到nacos</span>
configService<span class="token punctuation">.</span><span class="token function">publishConfig</span><span class="token punctuation">(</span>app <span class="token operator">+</span> <span class="token class-name">NacosConfigUtil</span><span class="token punctuation">.</span><span class="token constant">FLOW_DATA_ID_POSTFIX</span><span class="token punctuation">,</span>
       <span class="token class-name">NacosConfigUtil</span><span class="token punctuation">.</span><span class="token constant">GROUP_ID</span><span class="token punctuation">,</span> converter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在<code>com.alibaba.csp.sentinel.dashboard.rule.FlowRuleApiProvider#getRules</code>方法中修改为从nacos中读取配置的逻辑</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span></span> <span class="token function">getRules</span><span class="token punctuation">(</span><span class="token class-name">String</span> appName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> rules <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span>appName <span class="token operator">+</span> <span class="token class-name">NacosConfigUtil</span><span class="token punctuation">.</span><span class="token constant">FLOW_DATA_ID_POSTFIX</span><span class="token punctuation">,</span>
            <span class="token class-name">NacosConfigUtil</span><span class="token punctuation">.</span><span class="token constant">GROUP_ID</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> converter<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>改造流控的controller类FlowControllerV1，将配置保存到内存中的逻辑改为保存到nacos中</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"flowRuleDefaultProvider"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">DynamicRuleProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> ruleProvider<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Autowired</span>
<span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">"flowRuleDefaultPublisher"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">DynamicRulePublisher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> rulePublisher<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/rules"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AuthAction</span><span class="token punctuation">(</span><span class="token class-name">PrivilegeType</span><span class="token punctuation">.</span><span class="token constant">READ_RULE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">apiQueryMachineRules</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> app<span class="token punctuation">,</span>
                                                         <span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> ip<span class="token punctuation">,</span>
                                                         <span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Integer</span> port<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//            List&lt;FlowRuleEntity&gt; rules = sentinelApiClient.fetchFlowRuleOfMachine(app, ip, port);</span>
        <span class="token comment">//从nacos中读取规则</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> ruleProvider<span class="token punctuation">.</span><span class="token function">getRules</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rules <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">saveAll</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofSuccess</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error when querying flow rules"</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">ofThrowable</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">publishRules</span><span class="token punctuation">(</span><span class="token class-name">String</span> app<span class="token punctuation">,</span> <span class="token class-name">String</span> ip<span class="token punctuation">,</span> <span class="token class-name">Integer</span> port<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//将规则推送到nacos</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRuleEntity</span><span class="token punctuation">&gt;</span></span> rules <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">findAllByApp</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
      rulePublisher<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> rules<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        List&lt;FlowRuleEntity&gt; rules = repository.findAllByMachine(MachineInfo.of(app, ip, port));</span>
<span class="token comment">//        return sentinelApiClient.setFlowRuleOfMachineAsync(app, ip, port, rules);</span>
<span class="token punctuation">}</span>

<span class="token comment">//其余调用publishRules方法的地方做下简单调整</span>
</code></pre> 
<h4><a id="_369"></a>演示</h4> 
<p>启动当前项目，流控规则中存在我们之前在nacos中创建的文件，我们将原来的单机阈值从10改为12，然后保存。查看nacos中配置文件的数据，发现已经生效了。</p> 
<p><img src="https://images2.imgbox.com/00/21/Pz0fX4SZ_o.png" alt="在这里插入图片描述"><br> 至于其他规则，大家可以自行实现，此处就不一一实现了</p> 
<p><img src="https://images2.imgbox.com/3e/4c/FsNE4KjX_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_377"></a>总结</h2> 
<p>到这儿，服务容错中间件Sentinel的两种持久化模式就已经介绍完了。下一篇将为大家带来Feign整合容错组件 Sentinel 的文章，敬请期待吧！</p> 
<p>后续的文章，我们将继续完善我们的微服务系统，集成更多的Alibaba组件。想要了解更多JAVA后端知识，请点击文末名片与我交流吧。留下您的一键三连，让我们在这个寒冷的东西互相温暖吧！</p> 
<p>参考链接：</p> 
<ul><li>https://blog.csdn.net/weixin_36279234/article/details/130922604；</li><li>https://blog.csdn.net/u022812849/article/details/131206976；</li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/223db1939896aaf91d38f1fd4c868f5e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AI写作：kimi智能AI助手如何下载以及怎么使用？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e7842b4f8965837aa3e5184f919d9c43/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Eureka详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>