<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android9.0以后不允许HTTP访问的解决方案 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/b79fc51931399bfacf690659da66ebd6/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android9.0以后不允许HTTP访问的解决方案">
  <meta property="og:description" content="背景 自 Android 9.0 起，默认禁止使用 HTTP 进行访问。当尝试使用 HTTP 链接时，将会收到以下错误信息：
&#34;Cleartext HTTP traffic to &#34; &#43; host &#43; &#34; not permitted&#34; 为了解决这一问题，下面介绍两种破解方法：
XML布局设置 在 Android 9.0 及以上版本，需要通过以下配置允许 HTTP 访问。在 android/app/res 目录下新建 network_security_config.xml 文件，内容如下：
&lt;network-security-config&gt; &lt;base-config cleartextTrafficPermitted=&#34;true&#34;&gt; &lt;trust-anchors&gt; &lt;certificates src=&#34;system&#34; /&gt; &lt;/trust-anchors&gt; &lt;/base-config&gt; &lt;/network-security-config&gt; 然后在 android/app 目录下的 AndroidManifest.xml 文件中的 application 标签内声明文件：
android:usesCleartextTraffic=&#34;true&#34; android:networkSecurityConfig=&#34;@xml/network_security_config&#34; 其实只需在 AndroidManifest.xml 文件中的 application 标签内声明 android:usesCleartextTraffic=&#34;true&#34; 就可以了。如果还有特殊的配置，则需要配置 networkSecurityConfig 文件。另外需要说明的是，networkSecurityConfig 文件中的 cleartextTrafficPermitted 属性会优先于 application 标签内的 usesCleartextTraffic，这意味着，即使在 application 标签中设置了 android:usesCleartextTraffic=&#34;false&#34;，但在 networkSecurityConfig 文件中设置了 cleartextTrafficPermitted=&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-30T22:54:17+08:00">
    <meta property="article:modified_time" content="2024-03-30T22:54:17+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android9.0以后不允许HTTP访问的解决方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>背景</h2> 
<p>自 Android 9.0 起，默认禁止使用 HTTP 进行访问。当尝试使用 HTTP 链接时，将会收到以下错误信息：</p> 
<pre><code class="prism language-java"><span class="token string">"Cleartext HTTP traffic to "</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">" not permitted"</span>
</code></pre> 
<p>为了解决这一问题，下面介绍两种破解方法：</p> 
<h2><a id="XML_10"></a>XML布局设置</h2> 
<p>在 Android 9.0 及以上版本，需要通过以下配置允许 HTTP 访问。在 <code>android/app/res</code> 目录下新建 <code>network_security_config.xml</code> 文件，内容如下：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network-security-config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base-config</span> <span class="token attr-name">cleartextTrafficPermitted</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>trust-anchors</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>certificates</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>system<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>trust-anchors</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>base-config</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network-security-config</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>然后在 <code>android/app</code> 目录下的 <code>AndroidManifest.xml</code> 文件中的 <code>application</code> 标签内声明文件：</p> 
<pre><code class="prism language-xml">android:usesCleartextTraffic="true"
android:networkSecurityConfig="@xml/network_security_config"
</code></pre> 
<p>其实只需在 <code>AndroidManifest.xml</code> 文件中的 <code>application</code> 标签内声明 <code>android:usesCleartextTraffic="true"</code> 就可以了。如果还有特殊的配置，则需要配置 <code>networkSecurityConfig</code> 文件。另外需要说明的是，<code>networkSecurityConfig</code> 文件中的 <code>cleartextTrafficPermitted</code> 属性会优先于 <code>application</code> 标签内的 <code>usesCleartextTraffic</code>，这意味着，即使在 <code>application</code> 标签中设置了 <code>android:usesCleartextTraffic="false"</code>，但在 <code>networkSecurityConfig</code> 文件中设置了 <code>cleartextTrafficPermitted="true"</code>，仍然会开启明文传输。</p> 
<h2><a id="_31"></a>代码设置</h2> 
<p>为了验证结果，首先需要在 <code>AndroidManifest.xml</code> 文件中的 <code>application</code> 标签内声明文件：</p> 
<pre><code class="prism language-xml">android:usesCleartextTraffic="false"
</code></pre> 
<p>接下来编写反射工具类，用于调用对象的指定方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationTargetException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 反射工具类，用于调用对象的指定方法
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReflectionUtil</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">"ReflectionUtil"</span><span class="token punctuation">;</span> <span class="token comment">// 日志标签</span>

    <span class="token comment">/**
     * 调用对象的指定方法
     * 
     * @param owner      方法所属的对象实例
     * @param methodName 方法名
     * @param b          方法参数，boolean类型
     * @return 方法的返回值，如果调用失败则返回null
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">invokeMethod</span><span class="token punctuation">(</span><span class="token class-name">Object</span> owner<span class="token punctuation">,</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>owner <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> methodName <span class="token operator">+</span> <span class="token string">" not invoked, owner is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录错误日志：对象为空无法调用方法</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ownerClass <span class="token operator">=</span> owner<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取对象的类</span>
            <span class="token class-name">Method</span> method <span class="token operator">=</span> ownerClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取指定方法</span>
            method<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置方法为可访问</span>
            <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用方法</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> <span class="token operator">|</span> <span class="token class-name">IllegalAccessException</span> <span class="token operator">|</span> <span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> methodName <span class="token operator">+</span>
                <span class="token string">" not invoked, InvocationTargetException or NoSuchFieldException or IllegalAccessException: "</span> <span class="token operator">+</span>
                e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录错误日志：方法调用失败</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最后，通过以下代码设置：</p> 
<pre><code class="prism language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">.</span><span class="token constant">SDK_INT</span> <span class="token operator">&gt;=</span> <span class="token class-name">Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>M</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">boolean</span> permittedOld <span class="token operator">=</span> <span class="token class-name">NetworkSecurityPolicy</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isCleartextTrafficPermitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取旧的 cleartext 流量是否允许</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> <span class="token string">"onCreate, permittedOld: "</span> <span class="token operator">+</span> permittedOld<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录旧的 cleartext 流量是否允许的日志</span>

    <span class="token comment">// 动态设置 setCleartextTrafficPermitted 方法</span>
    <span class="token class-name">ReflectionUtil</span><span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span><span class="token class-name">NetworkSecurityPolicy</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"setCleartextTrafficPermitted"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> permittedNew <span class="token operator">=</span> <span class="token class-name">NetworkSecurityPolicy</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isCleartextTrafficPermitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取新的 cleartext 流量是否允许</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">,</span> <span class="token string">"onCreate, permittedNew: "</span> <span class="token operator">+</span> permittedNew<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 记录新的 cleartext 流量是否允许的日志</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>简而言之，通过 XML 布局和反射设置，可以绕过 Android 9.0 的 HTTP 访问限制。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aad2cda42cd726ead944c0072a1fa3d5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【前端】rtsp 与 rtmp 视频流的播放方法，最终入职阿里</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a7d8a8918b4d61ce87506fa6b5e1c1fb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[Flutter]打包IPA</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>