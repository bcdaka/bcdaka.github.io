<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>消息队列MQ - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/aad6a2d805bc037c7e269c2d8cdb51cf/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="消息队列MQ">
  <meta property="og:description" content="MQ概述 1.MQ简介 MQ，Message Queue，是一种提供消息队列服务的中间件，也称为消息中间件，是一套提供了消息生产、储、消费全过程API的软件系统。消息即数据。一般消息的体量不会很大。
2.MQ用途 限流削峰
MQ可以将系统的超量请求暂存其中，以便系统后期可以慢慢进行处理，从而避免了请求的丢失或系统被压垮。
异步解耦
上游系统对下游系统的调用若为同步调用，则会大大降低系统的吞吐量与并发度，且系统耦合度
太高。而异步调用则会解决这些问题。所以两层之间若要实现由同步到异步的转化，一般性做法就是，在这两层间添加一个MQ层。
数据收集
分布式系统会产生海量级数据流，如:业务日志、监控数据、用户行为等。针对这些数据流进行实时或批量采集汇总，然后对这些数据流进行大数据分析，这是当前互联网平台的必备技术通过MQ完成比类数据收集是最好的选择。
3.常见的MQ产品 ActiveMQ
ActiveMQ是使用Java语言开发一款MQ产品。早期很多公司与项目中都在使用。但现在的社区活跃度已经很低。现在的项目中已经很少使用了。
RabbitMQ
RabbitMQ是使用ErLang语言开发的一款MQ产品。其吞吐量较Kafka与RocketMQ要低，且由于其不是Java语言开发，所以公司内部对其实现定制化开发难度较大。
Kafka
Kafka是使用Scala/Java语言开发的一款MQ产品。其最大的特点就是高吞吐率，常用于大数据领域的实时计算、日志采集等场景。其没有遵循任何常见的MQ协议，而是使用自研协议。对于Spring CloudNetcix，其仅支持RabbitMq与Kafka.
RocketMQ
RocketMQ是使用Java语言开发的一款MQ产品。经过数年阿里双 11 的考验，性能与稳定性非常高。其没有遵循任何常见的MQ协议，而是使用自研协议。对于Spring Cloud Alibaba，其支持RabbitMQ、Kafka，但提倡使用RocketMQ.
RocketMQ的安装与启动 下载与安装 1.下载RocketMQ
https://rocketmq.apache.org/download/
2.windows下解压安装，配置环境变量ROCKETMQ_HOME
注意路径不要有中文或者空格等特殊字符
RocketMQ部署 1.启动nameserver
鼠标双击执行bin目录下的mqnamesrv.cmd 文件 或者 cmd 打开控制台，切换目录到rocket的bin目录下，执行命令：
start mqnamesrv.cmd 注：如果出现“找不到主类”的问题，需要将ROCKMQ_HOME和JAVA _HOME两个变量路径改掉，换成没有空格的路径
2.启动broker
执行bin目录下的 mqbroker.cmd 文件 或者 cmd 打开控制台，切换到bin目录下，执行命令：
start mqbroker.cmd -n 127.0.0.1:9876 autoCreateTopicEnable=true 默认端口是9876，autocreateTopicEnable=true表示允许自动创建topic
注：rocketMq运行环境中的内存不足会导致启动失败，可以修改配置文件
runserver.sh/runserver.cmd，runbroker.sh/runbroker.cmd中的配置参数
3.RocketMQ插件安装
访问 https://github.com/apache/rocketmq-externals/tags
下载rocketmq-console-1.0.0，并解压
在Eclipse中导入项目：
修改pom.xml文件中的java环境为当前环境1.8并执行compile指令
构建成功
在application.properties中设置地址namesrvAddr为localhost:9876
右键项目更新Maven
通过启动类App.java启动
在浏览器中打开">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-26T17:40:31+08:00">
    <meta property="article:modified_time" content="2024-08-26T17:40:31+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">消息队列MQ</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>MQ概述</h3> 
<h4>1.MQ简介</h4> 
<p>MQ，Message Queue，是一种提供消息队列服务的中间件，也称为消息中间件，是一套提供了消息生产、储、消费全过程API的软件系统。消息即数据。一般消息的体量不会很大。</p> 
<h4>2.MQ用途</h4> 
<p><strong>限流削峰</strong></p> 
<p><img alt="" height="221" src="https://images2.imgbox.com/23/48/5qiiKu2V_o.jpg" width="508"></p> 
<p>MQ可以<span style="color:#fe2c24;"><strong>将系统的超量请求暂存其中</strong></span>，以便系统<span style="color:#fe2c24;"><strong>后期可以慢慢进行处理</strong></span>，从而避免了请求的丢失或系统被压垮。</p> 
<p><strong>异步解耦</strong></p> 
<p><img alt="" height="217" src="https://images2.imgbox.com/36/66/apU2AZKs_o.png" width="415"></p> 
<p>上游系统对下游系统的调用若为同步调用，则会大大降低系统的<span style="color:#fe2c24;"><strong>吞吐量与并发度</strong></span>，且系统耦合度<br> 太高。而<span style="color:#fe2c24;"><strong>异步调用</strong></span>则会解决这些问题。所以两层之间若要<span style="color:#fe2c24;"><strong>实现由同步到异步的转化</strong></span>，一般性做法就是，在这两层间添加一个MQ层。</p> 
<p><strong>数据收集</strong></p> 
<p>分布式系统会产生海量级数据流，如:业务日志、监控数据、用户行为等。针对这些数据流进行实时或批量采集汇总，然后对这些数据流进行大数据分析，这是当前互联网平台的必备技术通过MQ完成比类数据收集是最好的选择。</p> 
<hr> 
<h4>3.常见的MQ产品</h4> 
<p><strong>ActiveMQ</strong></p> 
<p>ActiveMQ是使用Java语言开发一款MQ产品。早期很多公司与项目中都在使用。但现在的社区活跃度已经很低。现在的项目中已经很少使用了。</p> 
<hr> 
<p><strong>RabbitMQ</strong></p> 
<p>RabbitMQ是使用ErLang语言开发的一款MQ产品。其吞吐量较Kafka与RocketMQ要低，且由于其不是Java语言开发，所以公司内部对其实现定制化开发难度较大。</p> 
<p><img alt="" height="400" src="https://images2.imgbox.com/e0/0f/DGfkyLId_o.png" width="990"></p> 
<hr> 
<p><strong>Kafka</strong></p> 
<p>Kafka是使用Scala/Java语言开发的一款MQ产品。其最大的特点就是高吞吐率，常用于大数据领域的实时计算、日志采集等场景。其没有遵循任何常见的MQ协议，而是使用自研协议。对于Spring CloudNetcix，其仅支持RabbitMq与Kafka.</p> 
<p><img alt="" height="351" src="https://images2.imgbox.com/2d/4b/TvO36qPr_o.png" width="818"><br>  </p> 
<hr> 
<p><strong>RocketMQ</strong></p> 
<p>RocketMQ是使用Java语言开发的一款MQ产品。经过数年阿里双 11 的考验，性能与稳定性非常高。其没有遵循任何常见的MQ协议，而是使用自研协议。对于Spring Cloud Alibaba，其支持RabbitMQ、Kafka，但提倡使用RocketMQ.</p> 
<p><img alt="" height="548" src="https://images2.imgbox.com/d7/d3/6DV1Oz5p_o.png" width="1144"></p> 
<hr> 
<p><img alt="" height="185" src="https://images2.imgbox.com/3e/ae/6Qaeej28_o.jpg" width="741"></p> 
<hr> 
<h3>RocketMQ的安装与启动</h3> 
<h4>下载与安装</h4> 
<p>1.下载RocketMQ</p> 
<p><a class="link-info" href="https://rocketmq.apache.org/download/" rel="nofollow" title="https://rocketmq.apache.org/download/">https://rocketmq.apache.org/download/</a></p> 
<p><img alt="" height="570" src="https://images2.imgbox.com/ed/d4/Nf9nf3tj_o.png" width="1200"></p> 
<p>2.windows下解压安装，配置环境变量ROCKETMQ_HOME</p> 
<p><span style="color:#fe2c24;"><strong>注意路径不要有中文或者空格等特殊字符</strong></span></p> 
<p><img alt="" height="370" src="https://images2.imgbox.com/d9/69/6nI7Jy82_o.png" width="1200"></p> 
<hr> 
<h4>RocketMQ部署</h4> 
<p><strong>1.启动nameserver</strong></p> 
<p>鼠标双击执行bin目录下的mqnamesrv.cmd 文件 或者 cmd 打开控制台，切换目录到rocket的bin目录下，执行命令：</p> 
<pre><code class="hljs">start mqnamesrv.cmd</code></pre> 
<p>注：如果出现“找不到主类”的问题，需要将ROCKMQ_HOME和JAVA _HOME两个变量路径改掉，换成没有空格的路径</p> 
<p><img alt="" height="448" src="https://images2.imgbox.com/8b/74/yB3MVFW8_o.png" width="904"></p> 
<hr> 
<p><strong>2.启动broker</strong></p> 
<p>执行bin目录下的 mqbroker.cmd 文件 或者 cmd 打开控制台，切换到bin目录下，执行命令：</p> 
<pre><code class="hljs">start mqbroker.cmd -n 127.0.0.1:9876 autoCreateTopicEnable=true</code></pre> 
<p><span style="color:#fe2c24;"><strong>默认端口是9876</strong></span>，autocreateTopicEnable=true表示允许自动创建topic</p> 
<p><img alt="" height="881" src="https://images2.imgbox.com/74/36/EZqrk6Rs_o.png" width="1200"></p> 
<p>注：rocketMq运行环境中的内存不足会导致启动失败，可以修改配置文件<br> runserver.sh/runserver.cmd，runbroker.sh/runbroker.cmd中的配置参数</p> 
<hr> 
<p><strong>3.RocketMQ插件安装</strong></p> 
<p>访问 <a class="link-info" href="https://github.com/apache/rocketmq-externals/tags" title="https://github.com/apache/rocketmq-externals/tags">https://github.com/apache/rocketmq-externals/tags</a></p> 
<p><img alt="" height="101" src="https://images2.imgbox.com/0b/01/YZQbscHo_o.png" width="502"></p> 
<p>下载rocketmq-console-1.0.0，并解压</p> 
<p>在Eclipse中导入项目：</p> 
<p><img alt="" height="1120" src="https://images2.imgbox.com/bc/49/nqsTjYJp_o.png" width="1200"></p> 
<p>修改pom.xml文件中的java环境为当前环境1.8并执行compile指令</p> 
<p><img alt="" height="1095" src="https://images2.imgbox.com/19/db/1ck4tD07_o.png" width="1157"></p> 
<p><img alt="" height="1038" src="https://images2.imgbox.com/b4/cd/GeEzuULb_o.png" width="1105"></p> 
<p>构建成功</p> 
<p><img alt="" height="398" src="https://images2.imgbox.com/e2/cf/UPaxZqro_o.png" width="1200"></p> 
<p>在application.properties中设置地址namesrvAddr为<strong>localhost:9876</strong></p> 
<p><img alt="" height="600" src="https://images2.imgbox.com/d7/ec/vvrgBWg5_o.png" width="1042"></p> 
<p>右键项目更新Maven</p> 
<p><img alt="" height="389" src="https://images2.imgbox.com/5f/37/ZUwvWk0L_o.png" width="987"></p> 
<p>通过启动类App.java启动</p> 
<p><img alt="" height="767" src="https://images2.imgbox.com/e7/67/MPID2stc_o.png" width="1200"></p> 
<p>在浏览器中打开</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/cc/ca/yzggW85g_o.png" width="1200"></p> 
<hr> 
<p>这里可以通过下面的指令将项目打包为jar包，失败可以尝试使用管理员身份运行</p> 
<pre><code class="hljs">clean package -Dmaven.test.skip=true</code></pre> 
<p><img alt="" height="1038" src="https://images2.imgbox.com/01/dd/W1drPdu4_o.png" width="1104"></p> 
<p>打包成功后刷新项目可以在target文件夹下看到刚生成的jar包</p> 
<p><img alt="" height="414" src="https://images2.imgbox.com/07/6b/MJ5SGW04_o.png" width="1200"></p> 
<p><img alt="" height="217" src="https://images2.imgbox.com/6f/56/ffHYPyzi_o.png" width="486"></p> 
<p>此时复制jar包到到工作文件夹下通过cmd可以直接启动项目</p> 
<pre><code class="hljs">java -jar rocketmq-console-ng-1.0.0.jar</code></pre> 
<p><img alt="" height="360" src="https://images2.imgbox.com/39/9c/IODFtNqP_o.png" width="966"></p> 
<p>同样可以在浏览器中打开</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/de/1a/tzhmXuIP_o.png" width="1200"></p> 
<hr> 
<p>在bin目录下通过cmd输入指令mqadmin</p> 
<p>mqadmin是一个命令行工具，用于管理Apache RocketMQ消息队列系统。它提供了一组命令，用于创建、删除、查询和管理消息队列和主题，以及监控和诊断RocketMQ集群的状态和性能。</p> 
<p><img alt="" height="865" src="https://images2.imgbox.com/5f/b3/sIPTNRJ9_o.png" width="1200"></p> 
<hr> 
<h3>基本概念</h3> 
<h4>消息(Message)</h4> 
<p>消息是指，消息系统所传输信息的物理载体，生产和消费数据的最小单位，每条消息必须属于个主题。</p> 
<h4>主题(Topic)</h4> 
<p><img alt="" height="310" src="https://images2.imgbox.com/1c/3a/XVQ7FsG9_o.jpg" width="401"></p> 
<p>Topic表示一类消息的集合，每个主题包含若干条消息，每条消息只能属于一个主题，是RocketMQ进行消息订阅的基本单位。topic:message 1:n message:topic 1:1</p> 
<p>一个生产者可以同时发送多种Topic的消息；而一个消费者只对某种特定的Topic感兴趣，只可以订阅和消费一种Topic的消息。producer:topic 1:n consumer:topic 1:1</p> 
<h4>标签(Tag)</h4> 
<p>为消息设置的标签，用于同一主题下区分不同类型的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。<br><br><strong><span style="color:#fe2c24;">Topic是消息的一级分类，Tag是消息的二级分类。</span></strong></p> 
<h4>队列(Queue)</h4> 
<p>存储消息的物理实体。一个Topic中可以包含多个Queue，每个Queue中存放的就是该Topic的消息。一个Topic的Queue也被称为一个Topic中消息的分区（Partition）。</p> 
<p><img alt="" height="291" src="https://images2.imgbox.com/18/e9/0epqmMuY_o.png" width="366"></p> 
<p><span style="color:#494949;">一个Topic的Queue中的消息只能被一个消费者组中的一个消费者消费。</span><span style="color:#fe2c24;"><strong>一个Queue中的消息不允<br> 许同一个消费者组中的多个消费者同时消费</strong></span><span style="color:#494949;">。</span></p> 
<h4>消息标识(MessageId/Key)</h4> 
<p>RocketMQ中每个消息拥有唯一的MessageId，且可以携带具有业务标识的Key，以方便对消息的查询。</p> 
<p>不过需要注意的是，MessageId有两个：在生产者send()消息时会自动生成一个Messaged(msgId)，当消息到达Broker后，Broker也会自动生成一个Messageld(offsetMsgId)。</p> 
<p>msgId、offsetMsgId与key都称为消息标识。</p> 
<blockquote> 
 <ul><li>msgId：由producer端生成，其生成规则为：producerIp+进程pid+MessageClientIDSetter类的ClassLoader的hashCode +当前时间+AutomicInteger自增计数器</li><li>offsetMsgId：由broker端生成，其生成规则为：brokerIp+物理分区的offset(Queue中的偏移量)</li><li>key：由用户指定的业务相关的唯一标识</li></ul> 
</blockquote> 
<hr> 
<h3 style="background-color:transparent;">发送消息</h3> 
<h4>同步发送</h4> 
<p>1.新建Maven项目并在pom.xml中导入依赖</p> 
<pre><code class="language-XML">	&lt;!-- https://mvnrepository.com/artifact/org.apache.rocketmq/rocketmq-client --&gt;
	&lt;dependency&gt;
	    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;
	    &lt;artifactId&gt;rocketmq-client&lt;/artifactId&gt;
	    &lt;version&gt;5.3.0&lt;/version&gt;
	&lt;/dependency&gt;</code></pre> 
<p>2.创建测试类同步发送消息</p> 
<pre><code class="language-java">public class EasyA {
    public static void main(String[] args) throws MQClientException, MQBrokerException, RemotingException, InterruptedException {
        DefaultMQProducer producer = new DefaultMQProducer("easygroup");

        producer.setNamesrvAddr("127.0.0.1:9876");
        producer.start();

        //发送消息
        Message message = new Message("easytopic","rocketmq message".getBytes());
        SendResult result = producer.send(message);
        System.out.println(result);
        
        producer.shutdown();
    }
}</code></pre> 
<p><img alt="" height="450" src="https://images2.imgbox.com/62/d3/sCy2KfiV_o.png" width="1200"></p> 
<p>发送成功，在RocketMQ中，默认情况下一个Topic会创建4个队列。</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/56/ca/G8NsUR4g_o.png" width="1200"></p> 
<hr> 
<h4 style="background-color:transparent;">异步发送</h4> 
<pre><code class="language-java">public class EasyB {
    public static void main(String[] args) throws MQClientException, RemotingException, InterruptedException {
        DefaultMQProducer producer=new DefaultMQProducer("easygroup");

        producer.setNamesrvAddr("127.0.0.1:9876");

        Message message=new Message("easytopic","Helloworld".getBytes());

        producer.start();

        producer.send(message, new SendCallback() {
            @Override
            public void onSuccess(SendResult sendResult) {
                System.out.println(sendResult);
                System.out.println("OK");
            }
            @Override
            public void onException(Throwable e) {
                e.printStackTrace();
                System.out.println("Error");
            }
        });

        System.out.println("发送了一个消息");
        Thread.sleep(3000);
        producer.shutdown();
    }
}</code></pre> 
<p><img alt="" height="375" src="https://images2.imgbox.com/75/c2/j4GPGLvf_o.png" width="1200"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/df024873c1d8e872288748c2b28810f8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux-kubesphere（K8S）小白单机版搭建部署</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b622360ee844109e3632cb62987184bf/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring Cloud Stream与Kafka（一）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>