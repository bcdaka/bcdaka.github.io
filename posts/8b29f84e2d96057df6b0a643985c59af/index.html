<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nginx正则表达式 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/8b29f84e2d96057df6b0a643985c59af/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Nginx正则表达式">
  <meta property="og:description" content="目录
1.nginx常用的正则表达式
2.location
location 大致可以分为三类
location 常用的匹配规则
location 优先级
location 示例说明
优先级总结
3.rewrite
rewrite功能
rewrite跳转实现
rewrite执行顺序
语法格式
rewrite示例
实例1：
实例2：
实例3：
实例4：
1.nginx常用的正则表达式 ^ ：匹配输入字符串的起始位置$ ：匹配输入字符串的结束位置* ：匹配前面的字符零次或多次。如“ol*”能匹配“o”及“ol”、“oll”&#43; ：匹配前面的字符一次或多次。如“ol&#43;”能匹配“ol”及“oll”、“olll”，但不能匹配“o”? ：匹配前面的字符零次或一次，例如“do(es)?”能匹配“do”或者“does”，”?”等效于”{0,1}”. ：匹配除“\n”之外的任何单个字符，若要匹配包括“\n”在内的任意字符，请使用诸如“[.\n]”之类的模式\ ：将后面接着的字符标记为一个特殊字符或一个原义字符或一个向后引用。如“\n”匹配一个换行符，而“\$”则匹配“$”\d ：匹配纯数字[0-9] \s ：空白符 \w ：任意单词字符包括下划线[A-Za-z0-9_]{n} ：重复 n 次{n,} ：重复 n 次或更多次{n,m} ：重复 n 到 m 次[] ：定义匹配的字符范围[c] ：匹配单个字符 c[a-z] ：匹配 a-z 小写字母的任意一个[a-zA-Z0-9] ：匹配所有大小写字母或数字() ：表达式的开始和结束位置 | ：或运算符
2.location location 大致可以分为三类 精准匹配：location = / {...}一般匹配：location / {...} 正则匹配：location ~ / {.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-12-11T20:03:05+08:00">
    <meta property="article:modified_time" content="2023-12-11T20:03:05+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nginx正则表达式</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="1.nginx%E5%B8%B8%E7%94%A8%E7%9A%84%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F-toc" style="margin-left:0px;"><a href="#1.nginx%E5%B8%B8%E7%94%A8%E7%9A%84%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F" rel="nofollow">1.nginx常用的正则表达式</a></p> 
<p id="2.location-toc" style="margin-left:0px;"><a href="#2.location" rel="nofollow">2.location</a></p> 
<p id="location%20%E5%A4%A7%E8%87%B4%E5%8F%AF%E4%BB%A5%E5%88%86%E4%B8%BA%E4%B8%89%E7%B1%BB-toc" style="margin-left:40px;"><a href="#location%20%E5%A4%A7%E8%87%B4%E5%8F%AF%E4%BB%A5%E5%88%86%E4%B8%BA%E4%B8%89%E7%B1%BB" rel="nofollow">location 大致可以分为三类</a></p> 
<p id="location%20%E5%B8%B8%E7%94%A8%E7%9A%84%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99-toc" style="margin-left:40px;"><a href="#location%20%E5%B8%B8%E7%94%A8%E7%9A%84%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99" rel="nofollow">location 常用的匹配规则</a></p> 
<p id="location%20%E4%BC%98%E5%85%88%E7%BA%A7-toc" style="margin-left:40px;"><a href="#location%20%E4%BC%98%E5%85%88%E7%BA%A7" rel="nofollow">location 优先级</a></p> 
<p id="location%20%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E-toc" style="margin-left:40px;"><a href="#location%20%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E" rel="nofollow">location 示例说明</a></p> 
<p id="%E4%BC%98%E5%85%88%E7%BA%A7%E6%80%BB%E7%BB%93-toc" style="margin-left:40px;"><a href="#%E4%BC%98%E5%85%88%E7%BA%A7%E6%80%BB%E7%BB%93" rel="nofollow">优先级总结</a></p> 
<p id="3.rewrite-toc" style="margin-left:0px;"><a href="#3.rewrite" rel="nofollow">3.rewrite</a></p> 
<p id="rewrite%E5%8A%9F%E8%83%BD-toc" style="margin-left:40px;"><a href="#rewrite%E5%8A%9F%E8%83%BD" rel="nofollow">rewrite功能</a></p> 
<p id="rewrite%E8%B7%B3%E8%BD%AC%E5%AE%9E%E7%8E%B0-toc" style="margin-left:40px;"><a href="#rewrite%E8%B7%B3%E8%BD%AC%E5%AE%9E%E7%8E%B0" rel="nofollow">rewrite跳转实现</a></p> 
<p id="rewrite%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F-toc" style="margin-left:40px;"><a href="#rewrite%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F" rel="nofollow">rewrite执行顺序</a></p> 
<p id="%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F-toc" style="margin-left:40px;"><a href="#%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F" rel="nofollow">语法格式</a></p> 
<p id="rewrite%E7%A4%BA%E4%BE%8B-toc" style="margin-left:40px;"><a href="#rewrite%E7%A4%BA%E4%BE%8B" rel="nofollow">rewrite示例</a></p> 
<p id="%E5%AE%9E%E4%BE%8B1%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E5%AE%9E%E4%BE%8B1%EF%BC%9A" rel="nofollow">实例1：</a></p> 
<p id="%E5%AE%9E%E4%BE%8B2%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E5%AE%9E%E4%BE%8B2%EF%BC%9A" rel="nofollow">实例2：</a></p> 
<p id="%E5%AE%9E%E4%BE%8B3%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E5%AE%9E%E4%BE%8B3%EF%BC%9A" rel="nofollow">实例3：</a></p> 
<p id="%E5%AE%9E%E4%BE%8B4%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E5%AE%9E%E4%BE%8B4%EF%BC%9A" rel="nofollow">实例4：</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 style="background-color:transparent;">1.nginx常用的正则表达式</h2> 
<ul><li>^ ：匹配输入字符串的起始位置</li><li>$ ：匹配输入字符串的结束位置</li><li>* ：匹配前面的字符零次或多次。如“ol*”能匹配“o”及“ol”、“oll”</li><li>+ ：匹配前面的字符一次或多次。如“ol+”能匹配“ol”及“oll”、“olll”，但不能匹配“o”</li><li>? ：匹配前面的字符零次或一次，例如“do(es)?”能匹配“do”或者“does”，”?”等效于”{0,1}”</li><li>. ：匹配除“\n”之外的任何单个字符，若要匹配包括“\n”在内的任意字符，请使用诸如“[.\n]”之类的模式</li><li>\ ：将后面接着的字符标记为一个特殊字符或一个原义字符或一个向后引用。如“\n”匹配一个换行符，而“\$”则匹配“$”</li><li>\d ：匹配纯数字[0-9]   \s ：空白符    \w ：任意单词字符包括下划线[A-Za-z0-9_]</li><li>{n} ：重复 n 次</li><li>{n,} ：重复 n 次或更多次</li><li>{n,m} ：重复 n 到 m 次</li><li>[] ：定义匹配的字符范围</li><li>[c] ：匹配单个字符 c</li><li>[a-z] ：匹配 a-z 小写字母的任意一个</li><li>[a-zA-Z0-9] ：匹配所有大小写字母或数字</li><li>() ：表达式的开始和结束位置</li><li> <p style="background-color:transparent;">| ：或运算符</p> </li></ul> 
<h2 id="2.location" style="background-color:transparent;">2.location</h2> 
<h3 id="location%20%E5%A4%A7%E8%87%B4%E5%8F%AF%E4%BB%A5%E5%88%86%E4%B8%BA%E4%B8%89%E7%B1%BB">location 大致可以分为三类</h3> 
<ul><li>精准匹配：location = / {...}</li><li>一般匹配：location / {...} </li><li>正则匹配：location ~ / {...}</li></ul> 
<h3 id="location%20%E5%B8%B8%E7%94%A8%E7%9A%84%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99">location 常用的匹配规则</h3> 
<ul><li>= ：进行普通字符精确匹配，也就是完全匹配。</li><li>^~ ：表示普通字符匹配。使用前缀匹配。如果匹配成功，则不再匹配其它 正则匹配location。</li><li>~ ：区分大小写的匹配。</li><li>~* ：不区分大小写的匹配。</li><li>!~ ：区分大小写的匹配取非。</li><li>!~* ：不区分大小写的匹配取非。</li></ul> 
<h3 id="location%20%E4%BC%98%E5%85%88%E7%BA%A7">location 优先级</h3> 
<ul><li>首先精确匹配 =</li><li>其次前缀匹配 ^~</li><li>其次是按文件中顺序的正则匹配 ~或~*</li><li>然后匹配不带任何修饰符的一般前缀匹配</li><li>最后是交给 / 通用匹配</li></ul> 
<h3 id="location%20%E7%A4%BA%E4%BE%8B%E8%AF%B4%E6%98%8E" style="background-color:transparent;">location 示例说明</h3> 
<p><span style="color:#fe2c24;">1）location = / {}</span></p> 
<ul><li>=为精确匹配 / ，主机名后面不能带任何字符串，比如访问 / 和 /data，则 / 匹配，/data 不匹配<br> 再比如 location = /abc，则只匹配/abc ，/abc/或 /abcd不匹配。若 location  /abc，则即匹配/abc 、/abcd/ 同时也匹配 /abc/。</li></ul> 
<p><span style="color:#fe2c24;">2）location / {}</span></p> 
<ul><li>因为所有的地址都以 / 开头，所以这条规则将匹配到所有请求 比如访问 / 和 /data, 则 / 匹配， /data 也匹配，<br> 但后面前缀路径会和最长字符串优先匹配（最长匹配）</li></ul> 
<p><span style="color:#fe2c24;">3）location /documents/ {}</span></p> 
<ul><li>匹配任何以 /documents/ 开头的地址，匹配符合以后，还要继续往下搜索其它 location<br> 只有其它 location后面的前缀路径没有匹配到时，才会采用这一条</li></ul> 
<p><span style="color:#fe2c24;">4）location /documents/abc {}</span></p> 
<ul><li>匹配任何以 /documents/abc 开头的地址，匹配符合以后，还要继续往下搜索其它 location<br> 只有其它 location后面的前缀路径没有匹配到时，才会采用这一条</li></ul> 
<p><span style="color:#fe2c24;">5）location ^~ /images/ {}</span></p> 
<ul><li>匹配任何以 /images/ 开头的地址，匹配符合以后，停止往下搜索正则，采用这一条</li></ul> 
<p><span style="color:#fe2c24;">6）location ~* \.(gif|jpg|jpeg)$ {}</span></p> 
<ul><li>匹配所有以 gif、jpg或jpeg 结尾的请求<br> 然而，所有请求 /images/ 下的图片会被 location ^~ /images/ 处理，因为 ^~ 的优先级更高，所以到达不了这一条正则</li></ul> 
<p><span style="color:#fe2c24;">7）location /images/abc {}</span></p> 
<ul><li>最长字符匹配到 /images/abc，优先级最低，继续往下搜索其它 location，会发现 ^~ 和 ~ 存在</li></ul> 
<p><span style="color:#fe2c24;">8）location ~ /images/abc {}</span></p> 
<ul><li>匹配以/images/abc 开头的，优先级次之，只有去掉 location ^~ /images/ 才会采用这一条</li></ul> 
<p><span style="color:#fe2c24;">9）location /images/abc/1.html {}</span></p> 
<ul><li>匹配/images/abc/1.html 文件，如果和正则location ~ /images/abc/1.html 相比，正则优先级更高</li></ul> 
<h3 id="%E4%BC%98%E5%85%88%E7%BA%A7%E6%80%BB%E7%BB%93" style="background-color:transparent;">优先级总结</h3> 
<ul><li>(location = 完整路径) &gt; (location ^~ 路径) &gt; (location ~,~* 正则顺序) &gt; (location 部分前缀路径) &gt; (location /)</li></ul> 
<p><strong>首先看 优先级：精确= &gt; 前缀^~ &gt; 正则~,~* &gt; 一般 &gt; 通用/</strong></p> 
<blockquote> 
 <p>在没有精确匹配的时候，先看所有前缀的长度，取最长匹配的location；</p> 
 <p>如果最长的前缀匹配是带有~~的，则匹配，直接使用^~的location匹配用户的访问路径并跳转页面；如果最长的前缀匹配是不带^~的，则会继续看其它的正则匹配</p> 
 <p>前缀匹配看长度，最长的优先匹配；正则匹配看上下顺序，根据配置文件的配置由上往下依次匹配，匹配到即停止</p> 
</blockquote> 
<h2 id="3.rewrite" style="background-color:transparent;">3.rewrite</h2> 
<h3 id="rewrite%E5%8A%9F%E8%83%BD" style="background-color:transparent;">rewrite功能</h3> 
<ul><li>rewrite功能就是，使用nginx提供的全局变量或自己设置的变量，结合正则表达式和标记位实现URL重写以及重定向。</li><li>比如：更换域名后需要保持旧的域名能跳转到新的域名上、某网页发生改变需要跳转到新的页面、网站防盗链等等需求。</li><li>rewrite只能放在server{},location{},if{}中，并且默认只能对域名后边的除去传递的参数外的字符串起作用，</li><li>例如 http://www.kgc.com/abc/bbs/index.php?a=1&amp;b=2 只对/abc/bbs/index.php重写。</li></ul> 
<h3 id="rewrite%E8%B7%B3%E8%BD%AC%E5%AE%9E%E7%8E%B0">rewrite跳转实现</h3> 
<ul><li>Nginx：通过ngx_http_rewrite_module 模块支持URL重写、支持if条件判断，但不支持else</li><li>跳转：从一个 location跳转到另一个location，循环最多可以执行10次，超过后nginx将返回500错误</li><li>PCRE支持：perl兼容正则表达式的语法规则匹配</li><li>重写模块 set 指令：创建新的变量并设其值</li></ul> 
<h3 id="rewrite%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F" style="background-color:transparent;">rewrite执行顺序</h3> 
<blockquote> 
 <p>(1) 执行 server 块里面的 rewrite 指令。<br> (2) 执行 location 匹配。<br> (3) 执行选定的 location 中的 rewrite 指令</p> 
</blockquote> 
<h3 id="%E8%AF%AD%E6%B3%95%E6%A0%BC%E5%BC%8F">语法格式</h3> 
<pre><code class="language-bash">rewrite &lt;regex&gt; &lt;replacement&gt; [flag];
regex ：表示正则匹配规则。
replacement ：表示跳转后的内容。
flag ：表示 rewrite 支持的 flag 标记。

flag标记说明
last ：本条规则匹配完成后，不终止重写后的url匹配，一般用在 server 和 if 中。
break ：本条规则匹配完成即终止，终止重写后的url匹配，一般使用在 location 中。
redirect ：返回302临时重定向，浏览器地址会显示跳转后的URL地址。
permanent ：返回301永久重定向，浏览器地址栏会显示跳转后的URL地址。</code></pre> 
<h3 id="rewrite%E7%A4%BA%E4%BE%8B" style="background-color:transparent;">rewrite示例</h3> 
<h4 id="%E5%AE%9E%E4%BE%8B1%EF%BC%9A" style="background-color:transparent;">实例1：</h4> 
<ul><li>将请求http://bbs.yy.com/abc/index.html的访问跳到<a href="http://www.kgc.com/bbs/abc/index.php" rel="nofollow" title="http://www.yy.com/bbs/abc/index.html">http://www.yy.com/bbs/abc/index.html</a>保证原域名后面的url路径不变</li></ul> 
<pre><code class="language-bash">location /abc {
rewrite (.+) http://www.yy.com/bbs$1 permanent;  
}                                              #这里的$1为位置变量，代表/abc

location / {
root html;
index index.html index.htm;
}

systemctl restart nginx                        #重启nginx服务</code></pre> 
<p><img alt="" height="360" src="https://images2.imgbox.com/d9/ef/s9hcrIAL_o.png" width="1173"><img alt="" height="334" src="https://images2.imgbox.com/f6/99/WH1CFxQ9_o.png" width="1200"><img alt="" height="139" src="https://images2.imgbox.com/75/5e/4owsUSbI_o.png" width="664"><img alt="" height="219" src="https://images2.imgbox.com/30/4e/tRClSQBr_o.png" width="955"></p> 
<h4 id="%E5%AE%9E%E4%BE%8B2%EF%BC%9A" style="background-color:transparent;">实例2：</h4> 
<ul><li>将请求http://www.yy.com/bbs/index.html跳转到http://www.benet.com/bbs/index.html，保证原域名后面的url路径不变</li></ul> 
<pre><code class="language-bash">location  / {
       if ($host = 'www.yy.com'){
       rewrite ^/(.*)$ http://www.benet.com/$1 permanent;
}
       root html；
       index index.html index.htm;
}

systemctl restart nginx                        #重启nginx服务</code></pre> 
<p><img alt="" height="495" src="https://images2.imgbox.com/58/5d/R8aITIXB_o.png" width="1200"><img alt="" height="172" src="https://images2.imgbox.com/a3/b2/zojVkwjd_o.png" width="1126"><img alt="" height="189" src="https://images2.imgbox.com/8c/0a/U27qfeXz_o.png" width="1087"></p> 
<h4 id="%E5%AE%9E%E4%BE%8B3%EF%BC%9A" style="background-color:transparent;">实例3：</h4> 
<ul><li>将请求http://www.yy.com/abc/123.html 跳转到首页http://www.yy.com</li></ul> 
<pre><code class="language-bash">if ($request_uri ~ ^/abc/123.html$) {
rewrite (.+) http://www.yy.com permanent;
}

$request_uri：包含请求参数的原始URI，不包含主机名
$uri：这个变量指当前的请求URI，不包括任何参数
$document_uri：与$uri相同，这个变量指当前的请求URI，不包括任何传递参数

systemctl restart nginx                   #重启nginx服务</code></pre> 
<p><img alt="" height="331" src="https://images2.imgbox.com/ed/3f/WvI3fz3v_o.png" width="1200"><img alt="" height="204" src="https://images2.imgbox.com/5d/2e/XMqjwxKj_o.png" width="1200"><img alt="" height="532" src="https://images2.imgbox.com/a0/5a/IrZqBxH5_o.png" width="1200"></p> 
<h4 id="%E5%AE%9E%E4%BE%8B4%EF%BC%9A" style="background-color:transparent;">实例4：</h4> 
<ul><li>将对http://www.yy.com网站的所有请求跳转到自定义的维护页面</li></ul> 
<pre><code class="language-bash">set $rewrite true;                            
if ($remote_addr = "192.168.88.13") {
set $rewrite false;
}

if ($rewrite = true) {
rewrite (.+) /weihu.html;
}

location = /weihu.html {
root html;
}

#只有IP为192.168.88.13能正常访问，其他地址都是维护页面

systemctl restart nginx        #重启服务</code></pre> 
<p><img alt="" height="280" src="https://images2.imgbox.com/84/e7/lBNibbEq_o.png" width="1200"><img alt="" height="547" src="https://images2.imgbox.com/0d/54/CoENxCO9_o.png" width="1200"><img alt="" height="228" src="https://images2.imgbox.com/77/34/mCiWsaLj_o.png" width="843"></p> 
<p>自己主机可以正常访问</p> 
<p><img alt="" height="540" src="https://images2.imgbox.com/1f/76/LeIM90Wd_o.png" width="1200"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fe3a168850762ed3144de28db20b8538/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">启动zookeeper报Error: JAVA_HOME is not set and java could not be found in PATH错误处理方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f191ff6c52637a6eabaaf2c4c5d5472f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java LeetCode篇-二叉树经典解法（实现：判断平衡二叉树、找两个节点最近的祖先等）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>