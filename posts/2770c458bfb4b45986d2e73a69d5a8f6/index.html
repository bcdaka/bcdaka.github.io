<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[C&#43;&#43;]——同步异步日志系统（6） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/2770c458bfb4b45986d2e73a69d5a8f6/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="[C&#43;&#43;]——同步异步日志系统（6）">
  <meta property="og:description" content="同步异步日志系统 一、日志器模块设计1.1 同步日志器模块设计1.1.1 局部日志器建造者模式设计1.1.2 同步日志器基本功能测试 1.2 异步日志器模块设计1.2.1 单缓冲区设计1.2.2 异步工作线程的设计（双缓冲区思想）1.2.3 异步日志器设计1.2.4 异步日志器建造者模式设计1.2.5 异步日志器基本功能测试 一、日志器模块设计 功能：对前面所有功能进行整合，向外提供接口完成不同等级日志的输出。
管理的成员：
1.格式化模块对象
2.落地模块对象
3.默认的日志输出限制等级（大于等于限制输出等级的日志才能输出）
4.互斥锁（保证日志输出过程的线程安全，不会出现交叉日志）
5.日志名称（日志器的唯一标识，方便查找）
提供的操作：
debug等级日志的输出操作（分别封装日志消息LogMsg——各个接口日志等级不同）
info等级日志的输出操作
warn等级日志的输出操作
error等级日志的输出操作
fatal等级日志的输出操作
实现：
1.实现Logger基类（派生出同步日志器和异步日志器）
2.因为两种日志器的落地方式不同，需要将落地操作给抽象出来，不同的日志器调用不同的落地操作进行日志落地
3.模块关联过程中使用基类指针对子类日志器对象进行日志管理和操作
当前日志系统支持同步日志&amp;异步日志，它们的不同点在于日志的落地方式上不同：
同步日志器：直接对日志消息进行输出
异步日志器：先将日志消息放到缓冲区，然后异步线程进行输出
因此：日志器类在设计的时候，先要设计一个Logger的基类，在Logger基类的基础上，继承出同步日志器（SyncLogger）和异步日志器（AsyncLoggrr）。
1.1 同步日志器模块设计 同步日志器的设计和具体框架 /*日志器模块 1.先设计一个日志器的基类 2.根据基类派生出不同的日志器 */ #include &#34;util.hpp&#34; #include &#34;level.hpp&#34; #include &#34;sink.hpp&#34; #include &#34;format.hpp&#34; #include &lt;memory&gt; #include &lt;mutex&gt; #include &lt;atomic&gt; namespace logslearn { // 设计日志器基类 class Logger { // 公有 public: // 基类指针，用来控制继承子类的对象 using ptr = std::shared_ptr&lt;Logger&gt;; // 操作方法 // 构造日志消息对象并进行格式化，得到格式化后的日志消息字符串--然后进行落地输出，5个等级 void debug(const std::string &amp;file, size_t line, const std::string &amp;fmt, .">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-17T07:30:00+08:00">
    <meta property="article:modified_time" content="2024-07-17T07:30:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[C&#43;&#43;]——同步异步日志系统（6）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>同步异步日志系统</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、日志器模块设计</a></li><li><ul><li><a href="#11__28" rel="nofollow">1.1 同步日志器模块设计</a></li><li><ul><li><a href="#111__325" rel="nofollow">1.1.1 局部日志器建造者模式设计</a></li><li><a href="#112__454" rel="nofollow">1.1.2 同步日志器基本功能测试</a></li></ul> 
   </li><li><a href="#12__501" rel="nofollow">1.2 异步日志器模块设计</a></li><li><ul><li><a href="#121__522" rel="nofollow">1.2.1 单缓冲区设计</a></li><li><a href="#122__794" rel="nofollow">1.2.2 异步工作线程的设计（双缓冲区思想）</a></li><li><a href="#123__959" rel="nofollow">1.2.3 异步日志器设计</a></li><li><a href="#124___1006" rel="nofollow">1.2.4 异步日志器建造者模式设计</a></li><li><a href="#125__1107" rel="nofollow">1.2.5 异步日志器基本功能测试</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、日志器模块设计</h2> 
<p><strong>功能：对前面所有功能进行整合，向外提供接口完成不同等级日志的输出。</strong><br> <strong>管理的成员：</strong></p> 
<blockquote> 
 <p>1.格式化模块对象<br> 2.落地模块对象<br> 3.默认的日志输出限制等级（大于等于限制输出等级的日志才能输出）<br> 4.互斥锁（保证日志输出过程的线程安全，不会出现交叉日志）<br> 5.日志名称（日志器的唯一标识，方便查找）</p> 
</blockquote> 
<p><strong>提供的操作：</strong></p> 
<blockquote> 
 <p>debug等级日志的输出操作（分别封装日志消息LogMsg——各个接口日志等级不同）<br> info等级日志的输出操作<br> warn等级日志的输出操作<br> error等级日志的输出操作<br> fatal等级日志的输出操作</p> 
</blockquote> 
<p>实现：<br> 1.实现Logger基类（派生出同步日志器和异步日志器）<br> 2.因为两种日志器的落地方式不同，需要将落地操作给抽象出来，不同的日志器调用不同的落地操作进行日志落地<br> 3.模块关联过程中使用基类指针对子类日志器对象进行日志管理和操作</p> 
<p>当前日志系统支持<strong>同步日志</strong>&amp;<strong>异步日志</strong>，它们的不同点在于日志的落地方式上不同：<br> 同步日志器：直接对日志消息进行输出<br> 异步日志器：先将日志消息放到缓冲区，然后异步线程进行输出<br> 因此：日志器类在设计的时候，先要设计一个Logger的基类，在Logger基类的基础上，继承出同步日志器（SyncLogger）和异步日志器（AsyncLoggrr）。</p> 
<h3><a id="11__28"></a>1.1 同步日志器模块设计</h3> 
<p><img src="https://images2.imgbox.com/cf/b3/lTrCisUp_o.png" alt="在这里插入图片描述"></p> 
<ol><li>同步日志器的设计和具体框架</li></ol> 
<pre><code class="prism language-cpp"><span class="token comment">/*日志器模块
    1.先设计一个日志器的基类
    2.根据基类派生出不同的日志器
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"level.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sink.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"format.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token keyword">namespace</span> logslearn
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//  设计日志器基类</span>
    <span class="token keyword">class</span> <span class="token class-name">Logger</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 公有</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 基类指针，用来控制继承子类的对象</span>
        <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Logger<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token comment">// 操作方法</span>
        <span class="token comment">// 构造日志消息对象并进行格式化，得到格式化后的日志消息字符串--然后进行落地输出，5个等级</span>
        <span class="token keyword">void</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 日志的输出操作</span>
        <span class="token keyword">void</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 日志的输出操作</span>
        <span class="token keyword">void</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 日志的输出操作</span>
        <span class="token keyword">void</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 日志的输出操作</span>
        <span class="token keyword">void</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 日志的输出操作</span>
    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token comment">// 日志落地,抽象接口完成实际的落地输出——不同的日志器会有不同的实际落地方式</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>mutex _mutex<span class="token punctuation">;</span>                         <span class="token comment">// 互斥锁</span>
        std<span class="token double-colon punctuation">::</span>string _logger_name<span class="token punctuation">;</span>                  <span class="token comment">// 日志器的名字</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token operator">&gt;</span> _limit_level<span class="token punctuation">;</span> <span class="token comment">// 限制日志等级,atomic原子操作的意思是该操作执行过程中不能被中断，该操作要么不执行，要么全部执行，不存在执行一部分的情况。</span>
        Formatter<span class="token double-colon punctuation">::</span>ptr _formatter<span class="token punctuation">;</span>                 <span class="token comment">// 控制格式化模块的对象</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> _sliks<span class="token punctuation">;</span>          <span class="token comment">// 这是一个数组，数组里存放日志落地方式的对象</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 派生出同步日志器</span>
    <span class="token keyword">class</span> <span class="token class-name">SyncLogger</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Logger</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token comment">// 重写虚函数</span>
        <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>同步日志器的具体实现</li></ol> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M_LOGGER_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M_LOGGER_H__</span></span>
<span class="token comment">/*日志器模块
    1.先设计一个日志器的基类
    2.根据基类派生出不同的日志器
*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_GNU_SOURCE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"level.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sink.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"format.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdarg&gt;</span></span>

<span class="token keyword">namespace</span> logslearn
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//  设计日志器基类</span>
    <span class="token keyword">class</span> <span class="token class-name">Logger</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 公有</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 基类指针，用来控制继承子类的对象</span>
        <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Logger<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token comment">// 构造函数</span>
        <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>logger_name<span class="token punctuation">,</span> loglevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">,</span> Formatter<span class="token double-colon punctuation">::</span>ptr <span class="token operator">&amp;</span>formatter<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>sinks<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_logger_name</span><span class="token punctuation">(</span>logger_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_limit_level</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_formatter</span><span class="token punctuation">(</span>formatter<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_sliks</span><span class="token punctuation">(</span>sinks<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sinks<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token comment">// 操作方法</span>
           <span class="token comment">//获取日志器名称</span>
        <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> _logger_name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 构造日志消息对象并进行格式化，得到格式化后的日志消息字符串--然后进行落地输出，5个等级</span>
        <span class="token keyword">void</span> <span class="token function">debug</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span> <span class="token comment">// 日志的输出操作</span>
            <span class="token comment">// 1.判断当前的日志是否达到输出等级</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>DEBUG <span class="token operator">&lt;</span> _limit_level<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token comment">// 没有达到输出等级</span>
            <span class="token comment">// 2.对fmt格式化字符串和不定参进行字符串组织，得到日志消息的字符串</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vasprintf failed!!\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将ap指针置空</span>
            <span class="token comment">// 代码一样，可以封装成一个函数</span>
            <span class="token function">serialize</span><span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将指针释放掉</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span> <span class="token comment">// 日志的输出操作</span>
            <span class="token comment">// 1.判断当前的日志是否达到输出等级</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>INFO <span class="token operator">&lt;</span> _limit_level<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token comment">// 没有达到输出等级</span>
            <span class="token comment">// 2.对fmt格式化字符串和不定参进行字符串组织，得到日志消息的字符串</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vasprintf failed!!\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将ap指针置空</span>
            <span class="token comment">// 代码一样，可以封装成一个函数</span>
            <span class="token function">serialize</span><span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>INFO<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将指针释放掉</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span> <span class="token comment">// 日志的输出操作</span>
            <span class="token comment">// 1.判断当前的日志是否达到输出等级</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>WARN <span class="token operator">&lt;</span> _limit_level<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token comment">// 没有达到输出等级</span>
            <span class="token comment">// 2.对fmt格式化字符串和不定参进行字符串组织，得到日志消息的字符串</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vasprintf failed!!\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将ap指针置空</span>
            <span class="token comment">// 代码一样，可以封装成一个函数</span>
            <span class="token function">serialize</span><span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>WARN<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将指针释放掉</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span> <span class="token comment">// 日志的输出操作</span>
            <span class="token comment">// 1.判断当前的日志是否达到输出等级</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>ERROR <span class="token operator">&lt;</span> _limit_level<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token comment">// 没有达到输出等级</span>
            <span class="token comment">// 2.对fmt格式化字符串和不定参进行字符串组织，得到日志消息的字符串</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vasprintf failed!!\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将ap指针置空</span>
            <span class="token comment">// 代码一样，可以封装成一个函数</span>
            <span class="token function">serialize</span><span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>ERROR<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将指针释放掉</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">fatal</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span> <span class="token comment">// 日志的输出操作</span>
            <span class="token comment">// 1.判断当前的日志是否达到输出等级</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>FATAL <span class="token operator">&lt;</span> _limit_level<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token comment">// 没有达到输出等级</span>
            <span class="token comment">// 2.对fmt格式化字符串和不定参进行字符串组织，得到日志消息的字符串</span>
            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
            <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">vasprintf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"vasprintf failed!!\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将ap指针置空</span>
            <span class="token comment">// 代码一样，可以封装成一个函数</span>
            <span class="token function">serialize</span><span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>FATAL<span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">free</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将指针释放掉</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>file<span class="token punctuation">,</span> size_t line<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>str<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 3.构造LogMsg对象</span>
            LogMsg <span class="token function">msg</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> line<span class="token punctuation">,</span> file<span class="token punctuation">,</span> _logger_name<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 传入等级、行号、文件、日志器、有效信息</span>
            <span class="token comment">// 4.通过格式化工具对LogMsg进行格式化，得到格式化后的日志字符串</span>
            std<span class="token double-colon punctuation">::</span>stringstream ss<span class="token punctuation">;</span>
            _formatter<span class="token operator">-&gt;</span><span class="token function">format</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 5.进行日志落地</span>
            <span class="token function">log</span><span class="token punctuation">(</span>ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 日志字符串和长度</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 日志落地,抽象接口完成实际的落地输出——不同的日志器会有不同的实际落地方式</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>mutex _mutex<span class="token punctuation">;</span>                         <span class="token comment">// 互斥锁</span>
        std<span class="token double-colon punctuation">::</span>string _logger_name<span class="token punctuation">;</span>                  <span class="token comment">// 日志器的名字</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token operator">&gt;</span> _limit_level<span class="token punctuation">;</span> <span class="token comment">// 限制日志等级,atomic原子操作的意思是该操作执行过程中不能被中断，该操作要么不执行，要么全部执行，不存在执行一部分的情况。</span>
        Formatter<span class="token double-colon punctuation">::</span>ptr _formatter<span class="token punctuation">;</span>                 <span class="token comment">// 控制格式化模块的对象</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> _sliks<span class="token punctuation">;</span>          <span class="token comment">// 这是一个数组，数组里存放日志落地方式的对象</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 派生出同步日志器</span>
    <span class="token keyword">class</span> <span class="token class-name">SyncLogger</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Logger</span></span>
    <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 构造函数</span>
        <span class="token function">SyncLogger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>logger_name<span class="token punctuation">,</span> loglevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">,</span> Formatter<span class="token double-colon punctuation">::</span>ptr <span class="token operator">&amp;</span>formatter<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>sinks<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Logger</span><span class="token punctuation">(</span>logger_name<span class="token punctuation">,</span> level<span class="token punctuation">,</span> formatter<span class="token punctuation">,</span> sinks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token comment">// 重写虚函数,同步日志器是将日志通过落地模块句柄进行日志落地</span>
        <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 是空</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_sliks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 不是空</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>sink <span class="token operator">:</span> _sliks<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                sink<span class="token operator">-&gt;</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>完成了日志器模块抽象基类的接口实现以及日志器的实际落地功能<br> 3. 对同步日志器进行测试</p> 
<blockquote> 
 <p>测试各个接口是否可以编译成功</p> 
</blockquote> 
<pre><code class="prism language-cpp"><span class="token comment">// 测试代码</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"level.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"message.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"format.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sink.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 日志器模块：同步日志器</span>
    std<span class="token double-colon punctuation">::</span>string logger_name <span class="token operator">=</span> <span class="token string">"sync_logger"</span><span class="token punctuation">;</span>
    logslearn<span class="token double-colon punctuation">::</span>loglevel<span class="token double-colon punctuation">::</span>value limit <span class="token operator">=</span> logslearn<span class="token double-colon punctuation">::</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>WARN<span class="token punctuation">;</span>
    logslearn<span class="token double-colon punctuation">::</span>Formatter<span class="token double-colon punctuation">::</span>ptr <span class="token function">fmt</span><span class="token punctuation">(</span><span class="token keyword">new</span> logslearn<span class="token double-colon punctuation">::</span><span class="token function">Formatter</span><span class="token punctuation">(</span><span class="token string">"[%d{%H:%M:%S}][%t][%c][%f:%l][%p]%T%m%n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logslearn<span class="token double-colon punctuation">::</span>LogSink<span class="token double-colon punctuation">::</span>ptr stdout_lsp <span class="token operator">=</span> logslearn<span class="token double-colon punctuation">::</span>SinkFactory<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">create</span><span class="token generic class-name"><span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>StdoutSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">// 标准输出落地</span>
    logslearn<span class="token double-colon punctuation">::</span>LogSink<span class="token double-colon punctuation">::</span>ptr file_lsp <span class="token operator">=</span> logslearn<span class="token double-colon punctuation">::</span>SinkFactory<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">create</span><span class="token generic class-name"><span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>FileSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"./logfile/test.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">// 文件落地方式</span>
    logslearn<span class="token double-colon punctuation">::</span>LogSink<span class="token double-colon punctuation">::</span>ptr roll_lsp <span class="token operator">=</span> logslearn<span class="token double-colon punctuation">::</span>SinkFactory<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">create</span><span class="token generic class-name"><span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>RoolBySizeSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"./logfile/roll-"</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 滚动文件落地方式</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> sinks <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>stdout_lsp<span class="token punctuation">,</span> file_lsp<span class="token punctuation">,</span> roll_lsp<span class="token punctuation">}</span><span class="token punctuation">;</span>
    logslearn<span class="token double-colon punctuation">::</span>Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">logger</span><span class="token punctuation">(</span><span class="token keyword">new</span> logslearn<span class="token double-colon punctuation">::</span><span class="token function">SyncLogger</span><span class="token punctuation">(</span>logger_name<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> fmt<span class="token punctuation">,</span> sinks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    logger<span class="token operator">-&gt;</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">fatal</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    size_t cursize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    size_t count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cursize <span class="token operator">&lt;</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        logger<span class="token operator">-&gt;</span><span class="token function">fatal</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"测试日志-%d"</span><span class="token punctuation">,</span> count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cursize <span class="token operator">+=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试结果符合要求（1024<em>1024</em>10/20）<br> <img src="https://images2.imgbox.com/93/e5/MbdDiXA5_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/25/f3/WWMgHV9Z_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="111__325"></a>1.1.1 局部日志器建造者模式设计</h4> 
<ol><li>局部日志器建造者模式的设计和框架分析。（同步日志器模块）</li></ol> 
<pre><code class="prism language-cpp">    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">LoggerType</span>
    <span class="token punctuation">{<!-- --></span>
        LOGGER_SYNC<span class="token punctuation">,</span> <span class="token comment">// 同步日志器</span>
        LOGGER_ASYNC <span class="token comment">// 异步日志器</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用建造者模式来构造日志器，而不要用户直接去构造日志器，简化了用户的使用复杂度</span>
    <span class="token comment">// 1.抽象一个日志器建造者类</span>
    <span class="token comment">//   1.设置日志器类型</span>
    <span class="token comment">//   2.不同类型的日志器的创建放到同一个日志器建造者类中完成。</span>
    <span class="token keyword">class</span> <span class="token class-name">LoggerBuilder</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerType</span><span class="token punctuation">(</span>LoggerType type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerName</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerLevel</span><span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构造一个格式化器</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerFormatter</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 一个日志器可以有多个不同的落地方式</span>
        <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">SinkType</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Args<span class="token operator">&gt;</span>
        <span class="token keyword">void</span> <span class="token function">buildSink</span><span class="token punctuation">(</span>Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 完成我们的日志器构建</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// 需要管理的数据，也就是建造的零部件</span>
        LoggerType logger_type<span class="token punctuation">;</span>       <span class="token comment">// 日志器类型</span>
        std<span class="token double-colon punctuation">::</span>string _logger_name<span class="token punctuation">;</span>     <span class="token comment">// 日志器的名字</span>
        loglevel<span class="token double-colon punctuation">::</span>value _limit_level<span class="token punctuation">;</span> <span class="token comment">// 限制日志等级,atomic原子操作的意思是该操作执行过程中不能被中断，该操作要么不执行，要么全部执行，不存在执行一部分的情况。</span>
        Formatter<span class="token double-colon punctuation">::</span>ptr _formatter<span class="token punctuation">;</span>    <span class="token comment">// 控制格式化模块的对象</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> _sliks<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.派生出具体的建造者类——局部日志器的建造者 &amp; 全局日志器建造者（后边添加了全局单例管理之后，将日志器添加全局管理）</span>
    <span class="token comment">// 局部日志器的建造者</span>
    <span class="token keyword">class</span> <span class="token class-name">LocalLoggerBuilder</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LoggerBuilder</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>实现具体操作的各个接口。</li></ol> 
<pre><code class="prism language-cpp">    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">LoggerType</span>
    <span class="token punctuation">{<!-- --></span>
        LOGGER_SYNC<span class="token punctuation">,</span> <span class="token comment">// 同步日志器</span>
        LOGGER_ASYNC <span class="token comment">// 异步日志器</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用建造者模式来构造日志器，而不要用户直接去构造日志器，简化了用户的使用复杂度</span>
    <span class="token comment">// 1.抽象一个日志器建造者类</span>
    <span class="token comment">//   1.设置日志器类型</span>
    <span class="token comment">//   2.不同类型的日志器的创建放到同一个日志器建造者类中完成。</span>
    <span class="token keyword">class</span> <span class="token class-name">LoggerBuilder</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 构造函数</span>
        <span class="token function">LoggerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">logger_type</span><span class="token punctuation">(</span>LoggerType<span class="token double-colon punctuation">::</span>LOGGER_SYNC<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">_limit_level</span><span class="token punctuation">(</span>logslearn<span class="token double-colon punctuation">::</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">buildLoggerType</span><span class="token punctuation">(</span>LoggerType type<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            logger_type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerName</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _logger_name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerLevel</span><span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _limit_level <span class="token operator">=</span> level<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 构造一个格式化器</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerFormatter</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>pattern<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _formatter <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Formatter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 一个日志器可以有多个不同的落地方式</span>
        <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">SinkType</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Args<span class="token operator">&gt;</span>
        <span class="token keyword">void</span> <span class="token function">buildSink</span><span class="token punctuation">(</span>Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>arg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LogSink<span class="token double-colon punctuation">::</span>ptr psink <span class="token operator">=</span> SinkFactory<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">create</span><span class="token generic class-name"><span class="token operator">&lt;</span>SinkType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完美转发</span>
            _sliks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>psink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 完成我们的日志器构建</span>
        <span class="token keyword">virtual</span> Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token comment">// 需要管理的数据，也就是建造的零部件</span>
        LoggerType logger_type<span class="token punctuation">;</span>       <span class="token comment">// 日志器类型</span>
        std<span class="token double-colon punctuation">::</span>string _logger_name<span class="token punctuation">;</span>     <span class="token comment">// 日志器的名字</span>
        loglevel<span class="token double-colon punctuation">::</span>value _limit_level<span class="token punctuation">;</span> <span class="token comment">// 限制日志等级,atomic原子操作的意思是该操作执行过程中不能被中断，该操作要么不执行，要么全部执行，不存在执行一部分的情况。</span>
        Formatter<span class="token double-colon punctuation">::</span>ptr _formatter<span class="token punctuation">;</span>    <span class="token comment">// 控制格式化模块的对象</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> _sliks<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.派生出具体的建造者类——局部日志器的建造者 &amp; 全局日志器建造者（后边添加了全局单例管理之后，将日志器添加全局管理）</span>
    <span class="token comment">// 局部日志器的建造者</span>
    <span class="token keyword">class</span> <span class="token class-name">LocalLoggerBuilder</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LoggerBuilder</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 必须要有日志器名称</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 必须要有formatter//必须要有格式化器，没有就要创建</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_formatter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _formatter <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Formatter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果没有落地方式就给它添加一个标准输出的默认落地方式</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_sliks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token generic-function"><span class="token function">buildSink</span><span class="token generic class-name"><span class="token operator">&lt;</span>StdoutSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果类型为LOGGER_ASYNC，那么日志器为异步日志器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger_type <span class="token operator">==</span> LoggerType<span class="token double-colon punctuation">::</span>LOGGER_ASYNC<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 目前不做处理，后面在写</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 返回同步日志器的对象</span>
            <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>SyncLogger<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">,</span> _limit_level<span class="token punctuation">,</span> _formatter<span class="token punctuation">,</span> _sliks<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// r日志器名字，等级，格式化，落地方式</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="112__454"></a>1.1.2 同步日志器基本功能测试</h4> 
<blockquote> 
 <p>我们这个建造者模式没有指挥者。因为我们构造对象的零部件没有顺序的要求，只要构造就可以了，所有只有建造者。</p> 
</blockquote> 
<pre><code class="prism language-cpp"><span class="token comment">// 测试代码</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"level.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"message.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"format.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sink.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//同步日志器建造者模式的测试</span>
    <span class="token comment">//先要构造一个建造者出来</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>LoggerBuilder<span class="token operator">&gt;</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> logslearn<span class="token double-colon punctuation">::</span><span class="token function">LocalLoggerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//建造者构建零部件</span>
    builder<span class="token operator">-&gt;</span><span class="token function">buildLoggerType</span><span class="token punctuation">(</span>logslearn<span class="token double-colon punctuation">::</span>LoggerType<span class="token double-colon punctuation">::</span>LOGGER_SYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token operator">-&gt;</span><span class="token function">buildLoggerName</span><span class="token punctuation">(</span><span class="token string">"sync_logger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token operator">-&gt;</span><span class="token function">buildLoggerLevel</span><span class="token punctuation">(</span>logslearn<span class="token double-colon punctuation">::</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>WARN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token operator">-&gt;</span><span class="token function">buildLoggerFormatter</span><span class="token punctuation">(</span><span class="token string">"[%d{%H:%M:%S}][%t][%c][%f:%l][%p]%T%m%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">buildSink</span><span class="token generic class-name"><span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>StdoutSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">// 标准输出落地</span>
    builder<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">buildSink</span><span class="token generic class-name"><span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>FileSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"./logfile/test.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件落地方式</span>
    builder<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">buildSink</span><span class="token generic class-name"><span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>RoolBySizeSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"./logfile/roll-"</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 滚动文件落地方式</span>
    <span class="token comment">//零部件构建好后，用建造者建筑对象</span>
    logslearn<span class="token double-colon punctuation">::</span>Logger<span class="token double-colon punctuation">::</span>ptr logger<span class="token operator">=</span>builder<span class="token operator">-&gt;</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//测试日志打印</span>
    logger<span class="token operator">-&gt;</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">fatal</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    size_t cursize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    size_t count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cursize <span class="token operator">&lt;</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        logger<span class="token operator">-&gt;</span><span class="token function">fatal</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"测试日志-%d"</span><span class="token punctuation">,</span> count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cursize <span class="token operator">+=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>总结：同步日志器直接将日志消息进行格式化写入文件。</p> 
<h3><a id="12__501"></a>1.2 异步日志器模块设计</h3> 
<p><img src="https://images2.imgbox.com/95/c5/xy2wit05_o.png" alt="在这里插入图片描述"><br> <strong>思想</strong>：为了避免写日志的过程中阻塞，导致影响业务线程的执行效率。异步的思想就是不让业务线程进行日志的实际落地，而是将日志消息放到缓冲区（一块指定的内存）中接下来有一个专门的异步线程，去针对缓冲区中的数据进行处理（实际的落地操作）<br> <strong>实现</strong>：<br> 1.实现一个线程安全的缓冲区<br> 2.创建一个异步工作线程，专门用来负责缓冲区中日志信息的落地操作。</p> 
<p><strong>缓冲区详情设计</strong>：<br> <strong>1.使用队列缓存日志消息，逐条处理</strong><br> 要求：不能涉及空间的频繁申请与释放，否则会降低效率。<br> 结果：设计一个环形队列（提前将空间申请好，然后对空间循环利用）<br> 存在问题：这个缓冲区的操作会涉及到多线程，因此缓冲区的操作必须保证线程安全。<br> 线程安全实现：对于缓冲区的读写加锁<br> 因此写日志操作，在实际开发中，不好分配太多资源，工作线程只需要一个日志器就行<br> 涉及到的锁冲突：生产者与生产者之间的互斥&amp;生产者与消费者的互斥。</p> 
<p>问题：锁冲突较为严重，所有线程之间都存在互斥关系<br> 解决方案：双缓冲区</p> 
<p><img src="https://images2.imgbox.com/c0/73/KJg6ltyZ_o.png" alt="在这里插入图片描述"><br> 避免了空间频繁的申请与释放，释放与申请的频率，减少了生产者和消费者之间的锁冲突，提高了效率。</p> 
<h4><a id="121__522"></a>1.2.1 单缓冲区设计</h4> 
<p>设计一个缓冲区:直接存放格式化后的日志消息字符串<br> 好处:<br> 1.减少了LogMsg对象频繁的构造的消耗<br> 2.可以针对缓冲区中的日志消息，一次性进行I0操作，减少I0次数，提高效率<br> <strong>缓冲区类的设计:</strong></p> 
<blockquote> 
 <p>1.管理一个存放字符串数据的缓冲区(使用vecotor进行空间管理)<br> 2.当前的写入数据位置的指针(指向可写区域的起始位置，避免数据的写入覆盖)<br> 3.当前的读取数据位置的指针(指向可读数据区域的起始位置，当读取指针与写入指针指向相同位置表示数据取完了)</p> 
</blockquote> 
<p><strong>提供的操作：</strong></p> 
<blockquote> 
 <p>1.向缓冲区写入数据<br> 2.获取可读数据起始地址的接口<br> 3.获取可读数据长度的接口<br> 4.移动读写位置的接口<br> 5.初始化缓冲区的操作（将读写位置初始化——将一个缓冲区所有数据处理完毕之后）<br> 6.提供交换缓冲区的接口（交换空间地址，并不交换空间数据）</p> 
</blockquote> 
<ol><li>第一步，先设计类，把类的框架搭建出来</li></ol> 
<pre><code class="prism language-cpp"><span class="token comment">/*实现异步日志缓冲区*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token keyword">namespace</span> logslearn
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// 定义宏，表示缓冲区的大小</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_BUFFER_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THRESHOLD_BUFFER_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCREMENT_BUFFER_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
    <span class="token comment">// 异步缓冲区</span>
    <span class="token keyword">class</span> <span class="token class-name">Buffer</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 构造函数</span>
        <span class="token function">Buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token comment">// 1.向缓冲区写入数据</span>
        <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.返回可读数据起始地址的接口</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.返回可读数据的长度的接口；返回可写数据的长度的接口</span>
        size_t <span class="token function">readAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        size_t <span class="token function">writeAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.移动读写指针进行向后偏移的接口</span>
        <span class="token keyword">void</span> <span class="token function">moveWriter</span><span class="token punctuation">(</span>size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">moveReader</span><span class="token punctuation">(</span>size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5.重置读写位置，初始化缓冲区的操作</span>
        <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.交换缓冲区的接口</span>
        <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span> Buffer <span class="token operator">&amp;</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断缓冲区是否为空</span>
        <span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// 1.存放字符串数据的缓冲区</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">&gt;</span> _buffer<span class="token punctuation">;</span>
        <span class="token comment">// 2.当前可写数据的指针--本质是下标</span>
        size_t _reader_idx<span class="token punctuation">;</span>
        <span class="token comment">// 3.当前可读数据的指针</span>
        size_t _writer_idx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>实现类的各个功能</li></ol> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M_BUFFER_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M_BUFFER_H__</span></span>
<span class="token comment">/*实现异步日志缓冲区*/</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cassert&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span></span>
<span class="token keyword">namespace</span> logslearn
<span class="token punctuation">{<!-- --></span>
<span class="token comment">// 定义宏，表示缓冲区的大小</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEFAULT_BUFFER_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">THRESHOLD_BUFFER_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INCREMENT_BUFFER_SIZE</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span></span></span>
    <span class="token comment">// 异步缓冲区</span>
    <span class="token keyword">class</span> <span class="token class-name">Buffer</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 构造函数</span>
        <span class="token function">Buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_buffer</span><span class="token punctuation">(</span>DEFAULT_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_reader_idx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_writer_idx</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token comment">// 1.向缓冲区写入数据,容量不够就扩容（两种方式，极限测试的时候使用扩容，实际使用过程中固定空间大小，空间不够阻塞）</span>
        <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 缓冲区剩余空间不够的情况下：扩容。</span>
            <span class="token comment">// // 1.固定大小,直接返回</span>
            <span class="token comment">// if (len &gt; writeAbleSize())</span>
            <span class="token comment">//     return;</span>
            <span class="token comment">// 2.动态空间，用于极限测试--扩容</span>
            <span class="token function">ensureEnoughSize</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 2.将数据拷贝到缓冲区</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">copy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> data <span class="token operator">+</span> len<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_buffer<span class="token punctuation">[</span>_writer_idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 3.将当前写入位置向后偏移</span>
            <span class="token function">moveWriter</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 2.返回可读数据起始地址的接口</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token operator">&amp;</span>_buffer<span class="token punctuation">[</span>_reader_idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.返回可读数据的长度的接口；返回可写数据的长度的接口</span>
        size_t <span class="token function">readAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 返回可读数据的长度</span>
            <span class="token comment">// 因为当前实现的缓冲区设计思想是双缓冲区，处理完就交换，所以不存在空间循环使用</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>_writer_idx <span class="token operator">-</span> _reader_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        size_t <span class="token function">writeAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 对于扩容的思路来说，不存在可写空间大小，因为总是可写的。</span>
            <span class="token comment">// 因此这个接口只提供给固定大小缓冲区。</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>_buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> _writer_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.移动读写指针进行向后偏移的接口</span>
        <span class="token keyword">void</span> <span class="token function">moveWriter</span><span class="token punctuation">(</span>size_t len<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 移动可写指针</span>
            <span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_writer_idx <span class="token operator">+</span> len<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> _buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _writer_idx <span class="token operator">+=</span> len<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">moveReader</span><span class="token punctuation">(</span>size_t len<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 移动可读指针</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token function">readAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// len大就报错</span>
            _reader_idx <span class="token operator">+=</span> len<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 5.重置读写位置，初始化缓冲区的操作</span>
        <span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 读写位置都为零</span>
            _writer_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 缓冲区所有空间都是空闲得</span>
            _reader_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//_reader_idx与_writer_idx相等就表示没有数据可以读</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 6.交换缓冲区的接口</span>
        <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>Buffer <span class="token operator">&amp;</span>buffer<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 交换缓冲区地址</span>
            _buffer<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>_buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 读写位置的地址也要交换</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>_reader_idx<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>_reader_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>_writer_idx<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>_writer_idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断缓冲区是否为空</span>
        <span class="token keyword">bool</span> <span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>_reader_idx <span class="token operator">==</span> _writer_idx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 位置一样就是空</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// 对空间进行扩容</span>
        <span class="token keyword">void</span> <span class="token function">ensureEnoughSize</span><span class="token punctuation">(</span>size_t len<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 不需要扩容</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;=</span> <span class="token function">writeAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            size_t new_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> THRESHOLD_BUFFER_SIZE<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 小于阈值则翻倍增长</span>
                new_size <span class="token operator">=</span> _buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                new_size <span class="token operator">=</span> _buffer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> INCREMENT_BUFFER_SIZE<span class="token operator">+</span>len<span class="token punctuation">;</span> <span class="token comment">// 否则线性增长</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 重新调整空间大小</span>
            _buffer<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>new_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// 1.存放字符串数据的缓冲区</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">&gt;</span> _buffer<span class="token punctuation">;</span>
        <span class="token comment">// 2.当前可写数据的指针--本质是下标</span>
        size_t _reader_idx<span class="token punctuation">;</span>
        <span class="token comment">// 3.当前可读数据的指针</span>
        size_t _writer_idx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<ol start="3"><li>对异步缓冲区进行代码完善和功能测试</li></ol> 
<blockquote> 
 <p>测试问题：读取文件数据，一点一点写入缓冲区，最终将缓冲区数据写入文件，判断生成的新文件</p> 
</blockquote> 
<pre><code class="prism language-cpp"><span class="token comment">// 测试代码</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"level.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"message.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"format.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sink.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"buffer.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   
    <span class="token comment">// 异步日志器缓冲区测试</span>
    <span class="token comment">// 读取文件数据，一点一点写入缓冲区，最终将缓冲区数据写入文件，判断生成的新文件与源文件是否一致</span>
    std<span class="token double-colon punctuation">::</span>ifstream <span class="token function">ifs</span><span class="token punctuation">(</span><span class="token string">"./logfile/test.log"</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开一个文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ifs<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token comment">// 文件打开失败返回-1</span>
    <span class="token comment">// 让读写位置跳转到末尾</span>
    ifs<span class="token punctuation">.</span><span class="token function">seekg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取当前读写位置相对于起始位置的偏移量</span>
    size_t fsize <span class="token operator">=</span> ifs<span class="token punctuation">.</span><span class="token function">tellg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 重新让指针跳转到起始位置</span>
    ifs<span class="token punctuation">.</span><span class="token function">seekg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>beg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string body<span class="token punctuation">;</span>
    body<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>fsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ifs<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ifs<span class="token punctuation">.</span><span class="token function">good</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"read error!\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 打开文件，就要关闭文件</span>
    ifs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> fsize <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 读取文件的数据大小</span>
    logslearn<span class="token double-colon punctuation">::</span>Buffer buffer<span class="token punctuation">;</span>        <span class="token comment">// 定义一个缓冲区</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> body<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        buffer<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>body<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> buffer<span class="token punctuation">.</span><span class="token function">readAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// buffer里面可读的数据大小</span>

    std<span class="token double-colon punctuation">::</span>ofstream <span class="token function">ofs</span><span class="token punctuation">(</span><span class="token string">"./logfile/tem.log"</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>binary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// //一次性写入</span>
    <span class="token comment">// ofs.write(buffer.begin(),buffer.readAbleSize());</span>
    <span class="token comment">//错误</span>
    <span class="token comment">// for (int i = 0; i &lt; buffer.readAbleSize(); i++)</span>
    <span class="token comment">// { // readAbleSize()可读数据的长度,可读数据在减少，i在++，双休套进的过程</span>
    <span class="token comment">//     ofs.write(buffer.begin(), 1);</span>
    <span class="token comment">//     if (ofs.good() == false)</span>
    <span class="token comment">//     {<!-- --></span>
    <span class="token comment">//         std::cout &lt;&lt; "writer error!\n";</span>
    <span class="token comment">//         return -1;</span>
    <span class="token comment">//     }</span>
    <span class="token comment">//     buffer.moveReader(1);</span>
    <span class="token comment">// }</span>
    <span class="token comment">//正确</span>
    size_t rsize<span class="token operator">=</span>buffer<span class="token punctuation">.</span><span class="token function">readAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rsize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">// readAbleSize()可读数据的长度,可读数据在减少，i在++，双休套进的过程</span>
        ofs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ofs<span class="token punctuation">.</span><span class="token function">good</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"writer error!\n"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        buffer<span class="token punctuation">.</span><span class="token function">moveReader</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ofs<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭文件</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f9/d3/iiOgeM5K_o.png" alt="在这里插入图片描述"><br> md5sum 可以验证文件的完整性，tem.log和test.log文件的md5值一样，说明文件内容一模一样</p> 
<h4><a id="122__794"></a>1.2.2 异步工作线程的设计（双缓冲区思想）</h4> 
<p><strong>异步工作器:</strong><br> 1.异步工作使用双缓冲区的思想<br> 外界将任务数据，添加到输入缓冲区中<br> 异步线程对处理缓冲区中的数据进行处理，若处理缓冲区中没有数据了则交换缓冲区<br> <strong>实现:</strong><br> 管理的成员</p> 
<blockquote> 
 <p>1.双缓冲区(生产，消费)<br> 2.互斥锁 // 保证线程安全<br> 3.条件变量-生产&amp;消费(生产缓冲区没有数据，处理完消费缓冲区数据后就休眠)<br> 4.回调函数(针对缓冲区中数据的处理接口-外界传入一个函数，告诉异步工作器数据该如何处理)</p> 
</blockquote> 
<p>提供的操作：</p> 
<blockquote> 
 <p>1.停止异步工作器<br> 2.添加数据到缓冲区</p> 
</blockquote> 
<p>私有操作:</p> 
<blockquote> 
 <p>创建线程，线程入口函数中，交换缓冲区，对消费缓冲区数据使用回调函数进行处理，处理完后再次交换</p> 
</blockquote> 
<ol><li>设计异步工作器的框架，已经具体成员</li></ol> 
<pre><code class="prism language-cpp"><span class="token comment">/*
    实现异步工作器
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M_LOOPER_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M_LOOPER_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"buffer.hpp"</span>         <span class="token comment">//缓冲区</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span>             <span class="token comment">//线程库</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span>              <span class="token comment">//互斥锁</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable&gt;</span> <span class="token comment">//条件变量</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span>         <span class="token comment">//包装器</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span>             <span class="token comment">//原子类型</span></span>
<span class="token keyword">namespace</span> logslearn
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 异步工作器类</span>
    <span class="token keyword">using</span> Functor <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>Buffer <span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">class</span> <span class="token class-name">AsyncLooper</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>AsyncLooper<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token function">AsyncLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">void</span> <span class="token function">threadEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 线程入口函数</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        Functor _callBack<span class="token punctuation">;</span> <span class="token comment">// 具体对缓冲区数据进行处理的回调函数，由异步工作器使用者传入。</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// bool _stop;//工作器停止标准，如果工作器停止了，会存在线程安全问题</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> _stop<span class="token punctuation">;</span>           <span class="token comment">// 让工作器停止标准变成原子性操作，提高了线程安全</span>
        Buffer _pro_buf<span class="token punctuation">;</span>                   <span class="token comment">// 生产缓冲区</span>
        Buffer _con_buf<span class="token punctuation">;</span>                   <span class="token comment">// 消费缓冲区</span>
        std<span class="token double-colon punctuation">::</span>mutex _mutex<span class="token punctuation">;</span>                 <span class="token comment">// 互斥锁</span>
        std<span class="token double-colon punctuation">::</span>condition_variable _cond_pro<span class="token punctuation">;</span> <span class="token comment">// 两个pcb的等待队列，这是生产者，等待队列的条件变量</span>
        std<span class="token double-colon punctuation">::</span>condition_variable _cond_con<span class="token punctuation">;</span> <span class="token comment">// 这是消费者，等待队列的条件变量</span>
        std<span class="token double-colon punctuation">::</span>thread _thread<span class="token punctuation">;</span>               <span class="token comment">// 异步工作器对应的工作线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<ol start="2"><li>异步工作器的具体实现</li></ol> 
<pre><code class="prism language-cpp"><span class="token comment">/*
    实现异步工作器
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__M_LOOPER_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__M_LOOPER_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"buffer.hpp"</span>         <span class="token comment">//缓冲区</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span>             <span class="token comment">//线程库</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span>              <span class="token comment">//互斥锁</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;condition_variable&gt;</span> <span class="token comment">//条件变量</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span>         <span class="token comment">//包装器</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;atomic&gt;</span>             <span class="token comment">//原子类型</span></span>
<span class="token keyword">namespace</span> logslearn
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 异步工作器类</span>
    <span class="token keyword">using</span> Functor <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>Buffer <span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">AsyncType</span>
    <span class="token punctuation">{<!-- --></span>
        ASYNC_SAFE<span class="token punctuation">,</span>  <span class="token comment">// 安全状态，表示缓冲区满了就阻塞，避免了资源耗尽的风险</span>
        ASUNC_UNSAFE <span class="token comment">// 非安全状态，不考虑资源耗尽的情况，可以无限扩容，常用与测试</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">class</span> <span class="token class-name">AsyncLooper</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">using</span> ptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>AsyncLooper<span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token function">AsyncLooper</span><span class="token punctuation">(</span><span class="token keyword">const</span> Functor <span class="token operator">&amp;</span>cb<span class="token punctuation">,</span> AsyncType looper_type <span class="token operator">=</span> AsyncType<span class="token double-colon punctuation">::</span>ASUNC_UNSAFE<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_looper_type</span><span class="token punctuation">(</span>looper_type<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_stop</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_thread</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">thread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AsyncLooper<span class="token double-colon punctuation">::</span>threadEntry<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                          <span class="token function">_callBack</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">AsyncLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _stop <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>           <span class="token comment">// 将退出标志设置为true</span>
            _cond_con<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 唤醒所有的工作线程,工作线程只有一个</span>
            _thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待工作线程退出</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1.无限扩容-非安全（极限压力测试的情况下使用）2.固定大小</span>
            <span class="token comment">// 加个互斥锁</span>
            std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 条件变量空值，若缓冲区剩余空间大小大于数据长度，就可以添加数据</span>
            <span class="token comment">// 如果是安全状态就把这个代码加上，非安全状态就把这个代码屏蔽</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_looper_type <span class="token operator">==</span> AsyncType<span class="token double-colon punctuation">::</span>ASYNC_SAFE<span class="token punctuation">)</span>
                _cond_pro<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                               <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> _pro_buf<span class="token punctuation">.</span><span class="token function">writeAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> len<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 能够走下来代表满足了条件，可以向缓冲区添加数据</span>
            _pro_buf<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 唤醒一个消费者对缓冲区中的数据进行处理</span>
            _cond_con<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// 线程入口函数--对消费缓冲区中的数据进行处理，处理完毕后，初始化缓冲区，交换缓冲区</span>
        <span class="token keyword">void</span> <span class="token function">threadEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 要为互斥锁设置一个生命周期，将缓冲区交换完毕后就解锁(并不对数据的处理过程加锁保护)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 1.判断生产缓冲区里有没有数据，有则交换，无则阻塞</span>
                    std<span class="token double-colon punctuation">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token comment">//退出标志被设置，且生产缓冲区无数据，这时候在退出，否则有可能会造成生产缓冲区有数据，但是没有被完全处理                   </span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_stop<span class="token operator">&amp;&amp;</span>_pro_buf<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token comment">// 若退出前被唤醒，或者有数据被唤醒，则返回真，继续向下运行，否则重新陷入休眠</span>
                    _cond_con<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token operator">!</span>_pro_buf<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> _stop<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//_stop是真表示程序退出，把剩余的数据进行交换</span>

                        <span class="token comment">// 等待完毕，消费者与生产者进行地址交换</span>
                        _con_buf<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>_pro_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 2.唤醒生产者</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_looper_type <span class="token operator">==</span> AsyncType<span class="token double-colon punctuation">::</span>ASYNC_SAFE<span class="token punctuation">)</span>
                        _cond_pro<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 3.被唤醒后，对消费缓冲区进行数据处理</span>
                <span class="token function">_callBack</span><span class="token punctuation">(</span>_con_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 4.初始化消费缓冲区</span>
                _con_buf<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        Functor _callBack<span class="token punctuation">;</span> <span class="token comment">// 具体对缓冲区数据进行处理的回调函数，由异步工作器使用者传入。</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// bool _stop;//工作器停止标准，如果工作器停止了，会存在线程安全问题</span>
        AsyncType _looper_type<span class="token punctuation">;</span>            <span class="token comment">// 默认是安全模式</span>
        std<span class="token double-colon punctuation">::</span>atomic<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> _stop<span class="token punctuation">;</span>           <span class="token comment">// 让工作器停止标准变成原子性操作，提高了线程安全</span>
        Buffer _pro_buf<span class="token punctuation">;</span>                   <span class="token comment">// 生产缓冲区</span>
        Buffer _con_buf<span class="token punctuation">;</span>                   <span class="token comment">// 消费缓冲区</span>
        std<span class="token double-colon punctuation">::</span>mutex _mutex<span class="token punctuation">;</span>                 <span class="token comment">// 互斥锁</span>
        std<span class="token double-colon punctuation">::</span>condition_variable _cond_pro<span class="token punctuation">;</span> <span class="token comment">// 两个pcb的等待队列，这是生产者，等待队列的条件变量</span>
        std<span class="token double-colon punctuation">::</span>condition_variable _cond_con<span class="token punctuation">;</span> <span class="token comment">// 这是消费者，等待队列的条件变量</span>
        std<span class="token double-colon punctuation">::</span>thread _thread<span class="token punctuation">;</span>               <span class="token comment">// 异步工作器对应的工作线程</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>测试的话，需要异步日志器设计好在测试</p> 
<h4><a id="123__959"></a>1.2.3 异步日志器设计</h4> 
<p>1.继承于Logger日志器类 对于写日志操作进行函数重写（不再将数据写入文件，而是通过异步消息处理器，放到缓冲区中）<br> 2.通过异步消息处理器，进行日志数据的实际落地<br> <strong>管理的成员：</strong></p> 
<blockquote> 
 <p>1.异步工作器（异步消息处理器）<br> 完成后，完善日志器建造者，进行异步日志器安全模式的选择，提供异步日志器的创建</p> 
</blockquote> 
<ol><li>异步日志器的框架设计</li></ol> 
<pre><code class="prism language-cpp"> <span class="token comment">//派生出异步日志器</span>
    <span class="token keyword">class</span> <span class="token class-name">AsyncLogger</span><span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Logger</span></span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">AsyncLogger</span><span class="token punctuation">(</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>logger_name<span class="token punctuation">,</span> loglevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">,</span> Formatter<span class="token double-colon punctuation">::</span>ptr <span class="token operator">&amp;</span>formatter<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>sinks<span class="token punctuation">,</span>AsyncType looper_type<span class="token punctuation">)</span> <span class="token operator">:</span>
         <span class="token function">Logger</span><span class="token punctuation">(</span>logger_name<span class="token punctuation">,</span> level<span class="token punctuation">,</span> formatter<span class="token punctuation">,</span> sinks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token comment">//将数据写入缓冲区</span>
            <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>data<span class="token punctuation">,</span>size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设计一个实际落地函数（将缓冲区里的数据进行落地）</span>
            <span class="token keyword">void</span> <span class="token function">realLog</span><span class="token punctuation">(</span>Buffer <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span><span class="token operator">:</span>
           AsyncLooper<span class="token double-colon punctuation">::</span>ptr _looper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<ol start="2"><li>完成异步日志器类的功能</li></ol> 
<pre><code class="prism language-cpp">    <span class="token comment">//派生出异步日志器</span>
    <span class="token keyword">class</span> <span class="token class-name">AsyncLogger</span><span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Logger</span></span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">AsyncLogger</span><span class="token punctuation">(</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>logger_name<span class="token punctuation">,</span> loglevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">,</span> Formatter<span class="token double-colon punctuation">::</span>ptr <span class="token operator">&amp;</span>formatter<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>sinks<span class="token punctuation">,</span>AsyncType looper_type<span class="token punctuation">)</span> <span class="token operator">:</span>
         <span class="token function">Logger</span><span class="token punctuation">(</span>logger_name<span class="token punctuation">,</span> level<span class="token punctuation">,</span> formatter<span class="token punctuation">,</span> sinks<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_looper</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>AsyncLooper<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>AsyncLogger<span class="token double-colon punctuation">::</span>realLog<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span>std<span class="token double-colon punctuation">::</span>placeholders<span class="token double-colon punctuation">::</span>_1<span class="token punctuation">)</span><span class="token punctuation">,</span>looper_type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token comment">//将数据写入缓冲区</span>
            <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>data<span class="token punctuation">,</span>size_t len<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//消息入队操作，不需要加锁，已经是线程安全得了</span>
                _looper<span class="token operator">-&gt;</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//设计一个实际落地函数（将缓冲区里的数据进行落地）</span>
            <span class="token keyword">void</span> <span class="token function">realLog</span><span class="token punctuation">(</span>Buffer <span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>_sliks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token punctuation">;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>sink<span class="token operator">:</span>_sliks<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    sink<span class="token operator">-&gt;</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>buf<span class="token punctuation">.</span><span class="token function">readAbleSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">private</span><span class="token operator">:</span>
           AsyncLooper<span class="token double-colon punctuation">::</span>ptr _looper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="124___1006"></a>1.2.4 异步日志器建造者模式设计</h4> 
<p>1.本地局部的日志器建造者——异步日志器模块</p> 
<ol><li>局部日志器建造者功能的完善<br> 这个类的完善，需要在异步日志器完成之后，才能完善<br> <strong>完善部分：</strong></li></ol> 
<blockquote> 
 <p>1.首先要异步日志器完成<br> 2.建造者需要再加一个默认模式的零件，以及零部件的建造<br> 3.完善构造函数<br> 4.异步日志器对象的实例化</p> 
</blockquote> 
<pre><code class="prism language-cpp">    <span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">LoggerType</span>
    <span class="token punctuation">{<!-- --></span>
        LOGGER_SYNC<span class="token punctuation">,</span> <span class="token comment">// 同步日志器</span>
        LOGGER_ASYNC <span class="token comment">// 异步日志器</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 使用建造者模式来构造日志器，而不要用户直接去构造日志器，简化了用户的使用复杂度</span>
    <span class="token comment">// 1.抽象一个日志器建造者类</span>
    <span class="token comment">//   1.设置日志器类型</span>
    <span class="token comment">//   2.不同类型的日志器的创建放到同一个日志器建造者类中完成。</span>
    <span class="token keyword">class</span> <span class="token class-name">LoggerBuilder</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 构造函数</span>
        <span class="token function">LoggerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">logger_type</span><span class="token punctuation">(</span>LoggerType<span class="token double-colon punctuation">::</span>LOGGER_SYNC<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">_limit_level</span><span class="token punctuation">(</span>logslearn<span class="token double-colon punctuation">::</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          <span class="token function">_looper_type</span><span class="token punctuation">(</span>AsyncType<span class="token double-colon punctuation">::</span>ASYNC_SAFE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">buildEnabeUnSafeAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _looper_type <span class="token operator">=</span> AsyncType<span class="token double-colon punctuation">::</span>ASUNC_UNSAFE<span class="token punctuation">;</span> <span class="token comment">// 非安全模式</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerType</span><span class="token punctuation">(</span>LoggerType type<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            logger_type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerName</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _logger_name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerLevel</span><span class="token punctuation">(</span>loglevel<span class="token double-colon punctuation">::</span>value level<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _limit_level <span class="token operator">=</span> level<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 构造一个格式化器</span>
        <span class="token keyword">void</span> <span class="token function">buildLoggerFormatter</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>pattern<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _formatter <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Formatter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 一个日志器可以有多个不同的落地方式</span>
        <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">SinkType</span><span class="token punctuation">,</span> <span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Args<span class="token operator">&gt;</span>
        <span class="token keyword">void</span> <span class="token function">buildSink</span><span class="token punctuation">(</span>Args <span class="token operator">&amp;&amp;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>arg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            LogSink<span class="token double-colon punctuation">::</span>ptr psink <span class="token operator">=</span> SinkFactory<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">create</span><span class="token generic class-name"><span class="token operator">&lt;</span>SinkType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">forward</span><span class="token generic class-name"><span class="token operator">&lt;</span>Args<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完美转发</span>
            _sliks<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>psink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 完成我们的日志器构建</span>
        <span class="token keyword">virtual</span> Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token comment">// 需要管理的数据，也就是建造的零部件</span>
        AsyncType _looper_type<span class="token punctuation">;</span>       <span class="token comment">// 异步线程的安全模式</span>
        LoggerType logger_type<span class="token punctuation">;</span>       <span class="token comment">// 日志器类型</span>
        std<span class="token double-colon punctuation">::</span>string _logger_name<span class="token punctuation">;</span>     <span class="token comment">// 日志器的名字</span>
        loglevel<span class="token double-colon punctuation">::</span>value _limit_level<span class="token punctuation">;</span> <span class="token comment">// 限制日志等级,atomic原子操作的意思是该操作执行过程中不能被中断，该操作要么不执行，要么全部执行，不存在执行一部分的情况。</span>
        Formatter<span class="token double-colon punctuation">::</span>ptr _formatter<span class="token punctuation">;</span>    <span class="token comment">// 控制格式化模块的对象</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>LogSink<span class="token double-colon punctuation">::</span>ptr<span class="token operator">&gt;</span> _sliks<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.派生出具体的建造者类——局部日志器的建造者 &amp; 全局日志器建造者（后边添加了全局单例管理之后，将日志器添加全局管理）</span>
    <span class="token comment">// 局部日志器的建造者</span>
    <span class="token keyword">class</span> <span class="token class-name">LocalLoggerBuilder</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">LoggerBuilder</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        Logger<span class="token double-colon punctuation">::</span>ptr <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">override</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 必须要有日志器名称</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 必须要有formatter//必须要有格式化器，没有就要创建</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_formatter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                _formatter <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Formatter<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果没有落地方式就给它添加一个标准输出的默认落地方式</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_sliks<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token generic-function"><span class="token function">buildSink</span><span class="token generic class-name"><span class="token operator">&lt;</span>StdoutSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果类型为LOGGER_ASYNC，那么日志器为异步日志器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger_type <span class="token operator">==</span> LoggerType<span class="token double-colon punctuation">::</span>LOGGER_ASYNC<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 返回异步日志器对象</span>
                <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>AsyncLogger<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">,</span> _limit_level<span class="token punctuation">,</span> _formatter<span class="token punctuation">,</span> _sliks<span class="token punctuation">,</span>_looper_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 返回同步日志器的对象</span>
            <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>SyncLogger<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_logger_name<span class="token punctuation">,</span> _limit_level<span class="token punctuation">,</span> _formatter<span class="token punctuation">,</span> _sliks<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// r日志器名字，等级，格式化，落地方式</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="125__1107"></a>1.2.5 异步日志器基本功能测试</h4> 
<blockquote> 
 <p>异步工作器与异步日志器一起联调。<br> 测试：用建造者模式，构建对象，选择异步日志器，并且把10万条日志打印在文件和屏幕上<br> set nu//看文件里数据的行号</p> 
</blockquote> 
<pre><code class="prism language-cpp"><span class="token comment">// 测试代码</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"level.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"message.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"format.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sink.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"logger.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"buffer.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"looper.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 
    <span class="token comment">//异步日志器的测试</span>
    <span class="token comment">//异步日志器和异步工作器进行联调</span>
    <span class="token comment">// //先要构造一个建造者出来</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>LoggerBuilder<span class="token operator">&gt;</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> logslearn<span class="token double-colon punctuation">::</span><span class="token function">LocalLoggerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//建造者构建零部件</span>
    builder<span class="token operator">-&gt;</span><span class="token function">buildLoggerType</span><span class="token punctuation">(</span>logslearn<span class="token double-colon punctuation">::</span>LoggerType<span class="token double-colon punctuation">::</span>LOGGER_ASYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token operator">-&gt;</span><span class="token function">buildLoggerName</span><span class="token punctuation">(</span><span class="token string">"async_logger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token operator">-&gt;</span><span class="token function">buildLoggerLevel</span><span class="token punctuation">(</span>logslearn<span class="token double-colon punctuation">::</span>loglevel<span class="token double-colon punctuation">::</span>value<span class="token double-colon punctuation">::</span>WARN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token operator">-&gt;</span><span class="token function">buildLoggerFormatter</span><span class="token punctuation">(</span><span class="token string">"[%d{%H:%M:%S}][%t][%c][%f:%l][%p]%T%m%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">buildSink</span><span class="token generic class-name"><span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>StdoutSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">// 标准输出落地</span>
    builder<span class="token operator">-&gt;</span><span class="token generic-function"><span class="token function">buildSink</span><span class="token generic class-name"><span class="token operator">&lt;</span>logslearn<span class="token double-colon punctuation">::</span>FileSink<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"./logfile/async.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件落地方式</span>
    <span class="token comment">// builder-&gt;buildSink&lt;logslearn::RoolBySizeSink&gt;("./logfile/roll-", 1024 * 1024); // 滚动文件落地方式</span>
    <span class="token comment">//零部件构建好后，用建造者建筑对象</span>
    logslearn<span class="token double-colon punctuation">::</span>Logger<span class="token double-colon punctuation">::</span>ptr logger<span class="token operator">=</span>builder<span class="token operator">-&gt;</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//测试日志打印</span>
    logger<span class="token operator">-&gt;</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token operator">-&gt;</span><span class="token function">fatal</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> <span class="token string">"测试日志"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        logger<span class="token operator">-&gt;</span><span class="token function">fatal</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> <span class="token string">"测试日志-%d"</span><span class="token punctuation">,</span> count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/13/a2/W7hg2x1R_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ab237c240c40ed0dde7a973d41602962/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【C&#43;&#43;】vector的认识与使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/62c20e95dc8f7784bbbe00a5120d57ab/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【数据结构】二叉树全攻略，从实现到应用详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>