<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Flutter】App内购支付集成 Google和Apple支付和服务器验证全流程 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/94eb115bc56f1a99e4bae5386242f545/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Flutter】App内购支付集成 Google和Apple支付和服务器验证全流程">
  <meta property="og:description" content="Flutter支付集成 前言： 以谷歌内购为例，我们需要做的总共为三步
需要在谷歌市场配置商品，设置测试渠道，配置开发者账号，设置对应权限。配置完商品之后，如何在 Flutter 中获取到商品，购买指定商品，消耗商品等。购买成功之后，如何到服务器校验是否支付成功，后台服务器如何配置通行权限，谷歌市场与谷歌云的关联以及相关校验。 购买交易的生命周期
下面是一次性购买或订阅的典型购买流程：
向用户展示他们可以购买什么。启动购买流程，以便用户接受购买交易。在您的服务器上验证购买交易。向用户提供内容。确认内容已传送给用户。对于消耗型商品，用户要先消耗掉已购商品，才能再次购买。 订阅会自动续订，直到被取消。订阅可处于下面这几种状态：
有效：用户信誉良好，可享用订阅内容。已取消：用户已取消订阅，但在到期前仍可享用订阅内容。处于宽限期：用户遇到了付款问题，但仍可享用订阅内容，同时 Google 会重新尝试通过相应的付款方式扣款。暂时保留：用户遇到了付款问题，不能再享用订阅内容，同时 Google 会重新尝试通过相应的付款方式扣款。已暂停：用户暂停了其订阅，在恢复之前不能享用订阅内容。已到期：用户已取消且不能再享用订阅内容。用户在订阅到期时会被视为流失。 支付流程示意图
一 、google开发者平台配置 首先进入谷歌开发者平台
https://developers.google.com/?hl=zh-cn
进入开发者平台之后，点击google play，创建我们的APP
点击登录管理中心
创建完我们的APP之后，就可以开始配置支付的功能。需要注意的是，在进行谷歌支付测试的时候，需要先提交一个封闭测试版本及以上等级（例如公开版本）的包，然后才可以去创建应用内支付的商品，等这个包提交审核通过之后才可以开始进行谷歌支付的测试。
1.1、创建定价模板 在设置页面
找到付款概况之后，如果没有付款账号，我们填写一些信息，姓名，邮箱，账号，等等信息，创建完成之后我们就可以设置定价的模板。
如果能创建模板说明你付款账号没问题，定价模板是非必须的，可有可无，但是定义了模板之后会更加方便，到时候创建商品可以直接关联模板，账号下的每一个子应用的内购商品都能关联对应的模板，有一个统一的定价。
如何创建定价模板如下：
我们创建模板之后，就可以定义模板的价格与标题，选择的金额会有对应的汇率转换，比如我创建的新加坡币，如果用港元支付的话，会根据汇率转换为对应的港元支付。
创建完成之后，我们就能看到对应的定价模板如下图所示：
1.2、上架封闭测试App 点击创建轨道
点击创建新的发布版本
签名选择Google管理签名，然后上传aab格式的release版本的包，aab版本的包在这里生成
点开Build，选择Generate Signed Bundle/APK
然后选择app bundle
然后一路next，最后选择release版本，然后finish
然后在输出控制台的build选项卡，即可找到刚刚打出来的aab包
然后上传就可以了。
1.3、创建应用内购商品 此时就可以配置应用内商品了，点击这里进行添加配置：
添加完成后记得激活，不然即使审核通过之后测试的时候也获取不到该商品
点击这里激活商品
这个时候商品的配置就完成了。
接下来添加测试账户，进入封闭测试页面，切换到【测试用户选项卡】，然后创建测试群组，在群组里添加测试人员账户即可
当你的APP审核通过之后，这个页面下方的测试人员参与方式便会生效，如下所示：
就可以将这些链接发给测试人员，让他们去安装进行测试购买。
最后修改一下测试政策状态
选中测试群组，然后将政策状态改为LICENSED
OK，配置完成
二 、Apple开发者平台添加内购商品 首先使用苹果开发者账户登录苹果开发者平台
https://developer.apple.com/account
点击【App】
添加新的苹果内购商品
添加的时候页面的指引很清晰，就不赘述了，苹果添加内购商品比较简单，加完就可以了。
然后去创建沙盒账户用来做苹果支付测试，回到首页，点击【用户和访问】
点击沙盒，然后添加一个苹果测试账户，这个账户可以是个假的邮箱，不需要是正式的Apple id,比如你可以设置为8888888@qq.com类似之类的账户
添加完点击创建即可
OK，配置完成
三、flutter 代码集成 使用到的官方推出的应用内购插件：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-07T16:51:24+08:00">
    <meta property="article:modified_time" content="2024-05-07T16:51:24+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Flutter】App内购支付集成 Google和Apple支付和服务器验证全流程</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Flutter_1"></a>Flutter支付集成</h2> 
<h4><a id="_3"></a>前言：</h4> 
<p>以谷歌内购为例，我们需要做的总共为三步</p> 
<ol><li>需要在谷歌市场配置商品，设置测试渠道，配置开发者账号，设置对应权限。</li><li>配置完商品之后，如何在 Flutter 中获取到商品，购买指定商品，消耗商品等。</li><li>购买成功之后，如何到服务器校验是否支付成功，后台服务器如何配置通行权限，谷歌市场与谷歌云的关联以及相关校验。</li></ol> 
<p><strong>购买交易的生命周期</strong><br> 下面是一次性购买或订阅的典型购买流程：</p> 
<ol><li>向用户展示他们可以购买什么。</li><li>启动购买流程，以便用户接受购买交易。</li><li>在您的服务器上验证购买交易。</li><li>向用户提供内容。</li><li>确认内容已传送给用户。对于消耗型商品，用户要先消耗掉已购商品，才能再次购买。</li></ol> 
<p>订阅会自动续订，直到被取消。订阅可处于下面这几种状态：</p> 
<ul><li>有效：用户信誉良好，可享用订阅内容。</li><li>已取消：用户已取消订阅，但在到期前仍可享用订阅内容。</li><li>处于宽限期：用户遇到了付款问题，但仍可享用订阅内容，同时 Google 会重新尝试通过相应的付款方式扣款。</li><li>暂时保留：用户遇到了付款问题，不能再享用订阅内容，同时 Google 会重新尝试通过相应的付款方式扣款。</li><li>已暂停：用户暂停了其订阅，在恢复之前不能享用订阅内容。</li><li>已到期：用户已取消且不能再享用订阅内容。用户在订阅到期时会被视为流失。</li></ul> 
<p><strong>支付流程示意图</strong></p> 
<p><img src="https://images2.imgbox.com/9d/55/HomuFWjm_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_google_32"></a>一 、google开发者平台配置</h4> 
<p>首先进入谷歌开发者平台<br> <a href="https://developers.google.com/?hl=zh-cn" rel="nofollow">https://developers.google.com/?hl=zh-cn</a></p> 
<p>进入开发者平台之后，点击google play，创建我们的APP<br> <img src="https://images2.imgbox.com/93/da/avFsb6eg_o.png" alt="在这里插入图片描述"></p> 
<p>点击登录管理中心<br> <img src="https://images2.imgbox.com/65/02/WN5iVuHI_o.png" alt="在这里插入图片描述"></p> 
<p>创建完我们的APP之后，就可以开始配置支付的功能。<strong>需要注意的是，在进行谷歌支付测试的时候，需要先提交一个封闭测试版本及以上等级（例如公开版本）的包，然后才可以去创建应用内支付的商品，等这个包提交审核通过之后才可以开始进行谷歌支付的测试。</strong></p> 
<h6><a id="11_47"></a>1.1、创建定价模板</h6> 
<p>在设置页面<br> <img src="https://images2.imgbox.com/b8/aa/NCWQHy4k_o.png" alt="在这里插入图片描述"></p> 
<p>找到付款概况之后，如果没有付款账号，我们填写一些信息，姓名，邮箱，账号，等等信息，创建完成之后我们就可以设置定价的模板。<br> 如果能创建模板说明你付款账号没问题，定价模板是非必须的，可有可无，但是定义了模板之后会更加方便，到时候创建商品可以直接关联模板，账号下的每一个子应用的内购商品都能关联对应的模板，有一个统一的定价。<br> 如何创建定价模板如下：<br> <img src="https://images2.imgbox.com/13/2b/NnrPsHcw_o.png" alt="在这里插入图片描述"></p> 
<p>我们创建模板之后，就可以定义模板的价格与标题，选择的金额会有对应的汇率转换，比如我创建的新加坡币，如果用港元支付的话，会根据汇率转换为对应的港元支付。<br> <img src="https://images2.imgbox.com/47/fe/xscwrsUd_o.png" alt="在这里插入图片描述"></p> 
<p>创建完成之后，我们就能看到对应的定价模板如下图所示：<br> <img src="https://images2.imgbox.com/18/38/agLwA9HL_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="12App_68"></a>1.2、上架封闭测试App</h6> 
<p>点击创建轨道<br> <img src="https://images2.imgbox.com/2a/1f/vFoO2SCK_o.png" alt="在这里插入图片描述"></p> 
<p>点击创建新的发布版本<br> <img src="https://images2.imgbox.com/f4/ea/vFXJ8Rda_o.png" alt="在这里插入图片描述"></p> 
<p>签名选择Google管理签名，然后上传aab格式的release版本的包，aab版本的包在这里生成<br> 点开Build，选择Generate Signed Bundle/APK<br> <img src="https://images2.imgbox.com/1b/3a/tj7DPHmB_o.png" alt="在这里插入图片描述"></p> 
<p>然后选择app bundle<br> <img src="https://images2.imgbox.com/23/e1/NbN4Clsg_o.png" alt="在这里插入图片描述"></p> 
<p>然后一路next，最后选择release版本，然后finish<br> <img src="https://images2.imgbox.com/b7/94/2nT9TtI7_o.png" alt="在这里插入图片描述"></p> 
<p>然后在输出控制台的build选项卡，即可找到刚刚打出来的aab包<br> <img src="https://images2.imgbox.com/58/94/9h2M18Ap_o.png" alt="在这里插入图片描述"></p> 
<p>然后上传就可以了。</p> 
<h6><a id="13_97"></a>1.3、创建应用内购商品</h6> 
<p>此时就可以配置应用内商品了，点击这里进行添加配置：<br> <img src="https://images2.imgbox.com/f2/89/9UvS03rM_o.png" alt="在这里插入图片描述"></p> 
<p>添加完成后记得激活，不然即使审核通过之后测试的时候也获取不到该商品</p> 
<p>点击这里激活商品<br> <img src="https://images2.imgbox.com/01/81/K6ctpl9w_o.png" alt="在这里插入图片描述"></p> 
<p>这个时候商品的配置就完成了。</p> 
<p>接下来添加测试账户，进入封闭测试页面，切换到【测试用户选项卡】，然后创建测试群组，在群组里添加测试人员账户即可<br> <img src="https://images2.imgbox.com/9f/26/1sQp2zwz_o.png" alt="在这里插入图片描述"></p> 
<p>当你的APP审核通过之后，这个页面下方的测试人员参与方式便会生效，如下所示：<br> <img src="https://images2.imgbox.com/a5/a9/2WJtmjgb_o.png" alt="在这里插入图片描述"></p> 
<p>就可以将这些链接发给测试人员，让他们去安装进行测试购买。</p> 
<p>最后修改一下测试政策状态<br> <img src="https://images2.imgbox.com/9e/cc/vt9P75Jw_o.png" alt="在这里插入图片描述"></p> 
<p>选中测试群组，然后将政策状态改为LICENSED<br> <img src="https://images2.imgbox.com/c3/6a/wSrdsz4z_o.png" alt="在这里插入图片描述"></p> 
<p>OK，配置完成</p> 
<h4><a id="_Apple_131"></a>二 、Apple开发者平台添加内购商品</h4> 
<p>首先使用苹果开发者账户登录苹果开发者平台</p> 
<p><a href="https://developer.apple.com/account" rel="nofollow"> https://developer.apple.com/account</a></p> 
<p>点击【App】<br> <img src="https://images2.imgbox.com/ff/7f/EjdEjIjn_o.png" alt="在这里插入图片描述"></p> 
<p>添加新的苹果内购商品<br> <img src="https://images2.imgbox.com/c4/e4/BWwAZYJt_o.png" alt="在这里插入图片描述"></p> 
<p>添加的时候页面的指引很清晰，就不赘述了，苹果添加内购商品比较简单，加完就可以了。</p> 
<p>然后去创建沙盒账户用来做苹果支付测试，回到首页，点击【用户和访问】<br> <img src="https://images2.imgbox.com/08/6e/OqOfYR93_o.png" alt="在这里插入图片描述"></p> 
<p>点击沙盒，然后添加一个苹果测试账户，这个账户可以是个假的邮箱，不需要是正式的Apple id,比如你可以设置为8888888@qq.com类似之类的账户<br> <img src="https://images2.imgbox.com/45/8e/IukU59gA_o.png" alt="在这里插入图片描述"></p> 
<p>添加完点击创建即可<br> <img src="https://images2.imgbox.com/86/b6/msQaBTz6_o.png" alt="在这里插入图片描述"></p> 
<p>OK，配置完成</p> 
<h4><a id="flutter__160"></a>三、flutter 代码集成</h4> 
<p>使用到的官方推出的应用内购插件：</p> 
<pre><code class="prism language-js"><span class="token literal-property property">in_app_purchase</span><span class="token operator">:</span> <span class="token operator">^</span><span class="token number">3.2</span><span class="token number">.0</span>
</code></pre> 
<p>插件官网地址：<a href="https://pub.dev/packages/in_app_purchase" rel="nofollow">https://pub.dev/packages/in_app_purchase</a></p> 
<p>使用起来并不复杂，可以说是 Android 与 iOS 的逻辑是一样样的。</p> 
<p>将插件添加至yaml文件，然后执行flutter pub get<br> <img src="https://images2.imgbox.com/6b/29/TVF79JXs_o.png" alt="在这里插入图片描述"></p> 
<p>执行完了记得去IOS和安卓端分别执行pod install 和 gradle sync同步一下第三方插件</p> 
<p>然后在项目中新建dart文件，命名为：BuyEngine.dart</p> 
<p>然后将以下代码放入：</p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> <span class="token string">'dart:async'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'dart:io'</span><span class="token punctuation">;</span>
 
<span class="token keyword">import</span> <span class="token string">'package:in_app_purchase/in_app_purchase.dart'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'package:in_app_purchase_storekit/in_app_purchase_storekit.dart'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'package:in_app_purchase_android/in_app_purchase_android.dart'</span><span class="token punctuation">;</span>
 
<span class="token keyword">class</span> <span class="token class-name">BuyEngin</span><span class="token punctuation">{<!-- --></span>
 
  StreamSubscription<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>PurchaseDetails<span class="token operator">&gt;&gt;</span> _subscription<span class="token punctuation">;</span>
  InAppPurchase _inAppPurchase<span class="token punctuation">;</span>
  List<span class="token operator">&lt;</span>ProductDetails<span class="token operator">&gt;</span> _products<span class="token punctuation">;</span> <span class="token comment">//内购的商品对象集合</span>
 
  <span class="token comment">//初始化购买组件</span>
  <span class="token keyword">void</span> <span class="token function">initializeInAppPurchase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token comment">// 初始化in_app_purchase插件</span>
    _inAppPurchase <span class="token operator">=</span> InAppPurchase<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
 
    <span class="token comment">//监听购买的事件</span>
    final Stream<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>PurchaseDetails<span class="token operator">&gt;&gt;</span> purchaseUpdated <span class="token operator">=</span> _inAppPurchase<span class="token punctuation">.</span>purchaseStream<span class="token punctuation">;</span>
    _subscription <span class="token operator">=</span> purchaseUpdated<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>purchaseDetailsList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">_listenToPurchaseUpdated</span><span class="token punctuation">(</span>purchaseDetailsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">onDone</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      _subscription<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token literal-property property">onError</span><span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      error<span class="token punctuation">.</span><span class="token function">printError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"购买失败了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token keyword">void</span> <span class="token function">resumePurchase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    _inAppPurchase<span class="token punctuation">.</span><span class="token function">restorePurchases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token comment">/// 加载全部的商品</span>
  <span class="token keyword">void</span> <span class="token function">buyProduct</span><span class="token punctuation">(</span>String productId<span class="token punctuation">)</span> async <span class="token punctuation">{<!-- --></span>
 
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"请求商品id "</span> <span class="token operator">+</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> _outProducts <span class="token operator">=</span> <span class="token punctuation">[</span>productId<span class="token punctuation">]</span><span class="token punctuation">;</span>
 
    final bool available <span class="token operator">=</span> <span class="token keyword">await</span> _inAppPurchase<span class="token punctuation">.</span><span class="token function">isAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>available<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// ToastUtil.showToast("无法连接到商店");</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"无法连接到商店"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">//开始购买</span>
    <span class="token comment">// ToastUtil.showToast("连接成功-开始查询全部商品");</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"连接成功-开始查询全部商品"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> _kIds <span class="token operator">=</span> _outProducts<span class="token punctuation">;</span>
 
    final ProductDetailsResponse response <span class="token operator">=</span> <span class="token keyword">await</span> _inAppPurchase<span class="token punctuation">.</span><span class="token function">queryProductDetails</span><span class="token punctuation">(</span>_kIds<span class="token punctuation">.</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"商品获取结果  "</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>productDetails<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>notFoundIDs<span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// ToastUtil.showToast("无法找到指定的商品");</span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"无法找到指定的商品"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ToastUtil.showToast("无法找到指定的商品 数量 " + response.productDetails.length.toString());</span>
 
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token comment">// 处理查询到的商品列表</span>
    List<span class="token operator">&lt;</span>ProductDetails<span class="token operator">&gt;</span> products <span class="token operator">=</span> response<span class="token punctuation">.</span>productDetails<span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"products ==== "</span> <span class="token operator">+</span> products<span class="token punctuation">.</span>length<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>products<span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//赋值内购商品集合</span>
      _products <span class="token operator">=</span> products<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"全部商品加载完成了，可以启动购买了,总共商品数量为：${products.length}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token comment">//先恢复可重复购买</span>
    <span class="token comment">// await _inAppPurchase. ();</span>
 
    <span class="token function">startPurchase</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
 
  <span class="token comment">// 调用此函数以启动购买过程</span>
  <span class="token keyword">void</span> <span class="token function">startPurchase</span><span class="token punctuation">(</span>String productId<span class="token punctuation">)</span> async <span class="token punctuation">{<!-- --></span>
 
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"购买的商品id为"</span> <span class="token operator">+</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_products <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> _products<span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// ToastUtil.showToast("准备开始启动购买流程");</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        ProductDetails productDetails <span class="token operator">=</span> <span class="token function">_getProduct</span><span class="token punctuation">(</span>productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"一切正常，开始购买,信息如下：title: ${productDetails.title}  desc:${productDetails.description} "</span>
            <span class="token string">"price:${productDetails.price}  currencyCode:${productDetails.currencyCode}  currencySymbol:${productDetails.currencySymbol}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _inAppPurchase<span class="token punctuation">.</span><span class="token function">buyConsumable</span><span class="token punctuation">(</span>purchaseParam<span class="token operator">:</span> <span class="token function">PurchaseParam</span><span class="token punctuation">(</span>productDetails<span class="token operator">:</span> productDetails<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"购买失败了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"当前没有商品无法调用购买逻辑"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 
  <span class="token comment">// 根据产品ID获取产品信息</span>
  ProductDetails <span class="token function">_getProduct</span><span class="token punctuation">(</span><span class="token parameter">String productId</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _products<span class="token punctuation">.</span><span class="token function">firstWhere</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">product</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> product<span class="token punctuation">.</span>id <span class="token operator">==</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token comment">/// 内购的购买更新监听</span>
  <span class="token keyword">void</span> <span class="token function">_listenToPurchaseUpdated</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>PurchaseDetails<span class="token operator">&gt;</span> purchaseDetailsList<span class="token punctuation">)</span> async <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>PurchaseDetails purchase <span class="token keyword">in</span> purchaseDetailsList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>purchase<span class="token punctuation">.</span>status <span class="token operator">==</span> PurchaseStatus<span class="token punctuation">.</span>pending<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 等待支付完成</span>
        <span class="token function">_handlePending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>purchase<span class="token punctuation">.</span>status <span class="token operator">==</span> PurchaseStatus<span class="token punctuation">.</span>canceled<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 取消支付</span>
        <span class="token function">_handleCancel</span><span class="token punctuation">(</span>purchase<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>purchase<span class="token punctuation">.</span>status <span class="token operator">==</span> PurchaseStatus<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 购买失败</span>
        <span class="token function">_handleError</span><span class="token punctuation">(</span>purchase<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>purchase<span class="token punctuation">.</span>status <span class="token operator">==</span> PurchaseStatus<span class="token punctuation">.</span>purchased <span class="token operator">||</span> purchase<span class="token punctuation">.</span>status <span class="token operator">==</span> PurchaseStatus<span class="token punctuation">.</span>restored<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ToastUtil.showToast(DataConfig.getShowName("Pay_Success_Tip"));</span>
        <span class="token comment">//完成购买, 到服务器验证</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Platform<span class="token punctuation">.</span>isAndroid<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> googleDetail <span class="token operator">=</span> purchase <span class="token keyword">as</span> GooglePlayPurchaseDetails<span class="token punctuation">;</span>
          <span class="token function">checkAndroidPayInfo</span><span class="token punctuation">(</span>googleDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Platform<span class="token punctuation">.</span>isIOS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> appstoreDetail <span class="token operator">=</span> purchase <span class="token keyword">as</span> AppStorePurchaseDetails<span class="token punctuation">;</span>
          <span class="token function">checkApplePayInfo</span><span class="token punctuation">(</span>appstoreDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
 
  <span class="token comment">/// 购买失败</span>
  <span class="token keyword">void</span> <span class="token function">_handleError</span><span class="token punctuation">(</span><span class="token parameter">IAPError iapError</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ToastUtil.showToast("${DataConfig.getShowName("Purchase_Failed")}：${iapError?.code} message${iapError?.message}");</span>
  <span class="token punctuation">}</span>
 
  <span class="token comment">/// 等待支付</span>
  <span class="token keyword">void</span> <span class="token function">_handlePending</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"等待支付"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token comment">/// 取消支付</span>
  <span class="token keyword">void</span> <span class="token function">_handleCancel</span><span class="token punctuation">(</span><span class="token parameter">PurchaseDetails purchase</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    _inAppPurchase<span class="token punctuation">.</span><span class="token function">completePurchase</span><span class="token punctuation">(</span>purchase<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token comment">/// Android支付成功的校验</span>
  <span class="token keyword">void</span> <span class="token function">checkAndroidPayInfo</span><span class="token punctuation">(</span>GooglePlayPurchaseDetails googleDetail<span class="token punctuation">)</span> async <span class="token punctuation">{<!-- --></span>
    _inAppPurchase<span class="token punctuation">.</span><span class="token function">completePurchase</span><span class="token punctuation">(</span>googleDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"安卓支付交易ID为"</span> <span class="token operator">+</span> googleDetail<span class="token punctuation">.</span>purchaseID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"安卓支付验证收据为"</span> <span class="token operator">+</span> googleDetail<span class="token punctuation">.</span>verificationData<span class="token punctuation">.</span>serverVerificationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
  <span class="token comment">/// Apple支付成功的校验</span>
  <span class="token keyword">void</span>  <span class="token function">checkApplePayInfo</span><span class="token punctuation">(</span>AppStorePurchaseDetails appstoreDetail<span class="token punctuation">)</span> async <span class="token punctuation">{<!-- --></span>
    _inAppPurchase<span class="token punctuation">.</span><span class="token function">completePurchase</span><span class="token punctuation">(</span>appstoreDetail<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Apple支付交易ID为"</span> <span class="token operator">+</span> appstoreDetail<span class="token punctuation">.</span>purchaseID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Apple支付验证收据为"</span> <span class="token operator">+</span> appstoreDetail<span class="token punctuation">.</span>verificationData<span class="token punctuation">.</span>serverVerificationData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
 
  @override
  <span class="token keyword">void</span> <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Platform<span class="token punctuation">.</span>isIOS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      final InAppPurchaseStoreKitPlatformAddition iosPlatformAddition <span class="token operator">=</span>
      _inAppPurchase<span class="token punctuation">.</span>getPlatformAddition<span class="token operator">&lt;</span>InAppPurchaseStoreKitPlatformAddition<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      iosPlatformAddition<span class="token punctuation">.</span><span class="token function">setDelegate</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _subscription<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
 
<span class="token punctuation">}</span>
</code></pre> 
<p>至此集成完毕，开始测试谷歌支付</p> 
<h4><a id="__359"></a>三 、支付测试</h4> 
<p>在调用支付的地方提前初始化购买插件：</p> 
<pre><code class="prism language-js">BuyEngin _buyEngin <span class="token operator">=</span> <span class="token function">BuyEngin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
_buyEngin<span class="token punctuation">.</span><span class="token function">initializeInAppPurchase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>然后调用即可：</p> 
<pre><code class="prism language-js">_buyEngin<span class="token punctuation">.</span><span class="token function">buyProduct</span><span class="token punctuation">(</span><span class="token string">"应用内商品ID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>应用内商品ID就是你在google开发者中心或APP Store Connect 配置的应用内购买商品的product ID</p> 
<p>如果一切正常，则会正常唤醒谷歌或苹果支付<br> <img src="https://images2.imgbox.com/24/96/g9AfuyyC_o.png" alt="在这里插入图片描述"></p> 
<p>支付完成后可以看到可以正常获取到交易的ID和交易的验证收据，<strong>为了避免被第三方恶意刷购买接口来进行非法购买，建议将该收据上传后端服务器进行验证，验证通过之后再去更新用户的购买信息。</strong><br> <img src="https://images2.imgbox.com/f8/8f/KdReqT2J_o.png" alt="在这里插入图片描述"></p> 
<p>Ok ,集成完毕，功德+1</p> 
<h4><a id="__386"></a>四、 服务器校验相关流程</h4> 
<p>为什么要加后端校验？客户端支付成功了，服务端怎么知道，万一用接口的方式通信，如果被抓包岂不是可以无限加金币了。太不安全了，所以才有服务器校验这一步。</p> 
<p>iOS的校验不用说，很简单，拿到支付完成的票据直接发起请求即可，而 Android 的服务端校验就相对麻烦，需要配置谷歌云，以及对应的通行权限。</p> 
<p>谷歌结算文档：<a href="https://developer.android.com/google/play/billing?hl=zh-cn" rel="nofollow">https://developer.android.com/google/play/billing?hl=zh-cn</a><br> 谷歌支付校验AI：<a href="https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.products?hl=zh-cn" rel="nofollow">https://developers.google.com/android-publisher/api-ref/rest/v3/purchases.products?hl=zh-cn</a><br> 如果我们直接在API中调用校验接口，那肯定是直接报错：</p> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"error"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"code"</span><span class="token operator">:</span> <span class="token number">403</span><span class="token punctuation">,</span>
    <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"The project id used to call the Google Play Developer API has not been linked in the Google Play Developer Console."</span><span class="token punctuation">,</span>
    <span class="token string-property property">"errors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"The project id used to call the Google Play Developer API has not been linked in the Google Play Developer Console."</span><span class="token punctuation">,</span>
        <span class="token string-property property">"domain"</span><span class="token operator">:</span> <span class="token string">"androidpublisher"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"reason"</span><span class="token operator">:</span> <span class="token string">"projectNotLinked"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> 
<p>没有授权，接下来开始授权</p> 
<h6><a id="41Google_Cloud_414"></a>4.1、Google Cloud关联</h6> 
<p>首先需要配置 Google Cloud 并且配置相关的账号，对应指定的应用。<br> 点击项目的 API Access 中<br> <img src="https://images2.imgbox.com/c6/f4/3PFLwPZB_o.png" alt="在这里插入图片描述"></p> 
<p>如果这一步你没有 Google Cloud 账号，可以创建或关联已有的 Google Cloud 账号，这里我没有就直接创建了Google Cloud 账号。关联之后我们就能看到上图所示的画面。</p> 
<p>我们可以直接在谷歌市场控制台中的 API Access 中直接进入谷歌云后台，也能 直接输入网址 <a href="https://code.google.com/apis/console/" rel="nofollow">https://code.google.com/apis/console/</a> 是一样的效果。</p> 
<p>我们关联 Google Cloud 账号之后，默认就已经开通 Google Play Developer API 权限。<br> <img src="https://images2.imgbox.com/0d/83/xORKzAUw_o.png" alt="在这里插入图片描述"></p> 
<p>所以我们不需要再次去授权了。<br> <img src="https://images2.imgbox.com/43/73/cJFookFB_o.png" alt="在这里插入图片描述"></p> 
<p>如果觉得不保险，也能在里面搜索 Billing ，然后启动相关的支付服务权限</p> 
<h6><a id="42__webOAuth__434"></a>4.2 、创建 web-OAuth 授权</h6> 
<p>当我们在谷歌市场的后台关联谷歌云的时候，就已经帮我们初始化了很多配置，已经都有了<br> 我们再谷歌云后台，在APIs &amp; auth 项中找到 Credentials，直接查看即可：<br> <img src="https://images2.imgbox.com/8f/3d/0Mhuhee3_o.png" alt="在这里插入图片描述"></p> 
<p>我们点击 Web 授权进去配置相关配置。<br> 主要是配置左侧的上下两个 URI 地址，上面的配置后台域名：<br> <img src="https://images2.imgbox.com/04/80/65HDX5JA_o.png" alt="在这里插入图片描述"></p> 
<p>下面的是固定写法，callback的地址一定是可用域名 + /oauth2callback。<br> <img src="https://images2.imgbox.com/65/bf/KbQvBQBI_o.png" alt="在这里插入图片描述"></p> 
<p>创建完成之后，记得记录你的三个重要字段，client_id 和 client_secret 以及 redirect_uri ，后面会用到。<br> 通过访问一下的网页获取到一个oauth2callback：</p> 
<pre><code class="prism language-js"><span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>accounts<span class="token punctuation">.</span>google<span class="token punctuation">.</span>com<span class="token operator">/</span>o<span class="token operator">/</span>oauth2<span class="token operator">/</span>auth<span class="token operator">?</span>scope<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>googleapis<span class="token punctuation">.</span>com<span class="token operator">/</span>auth<span class="token operator">/</span>androidpublisher<span class="token operator">&amp;</span>response_type<span class="token operator">=</span>code<span class="token operator">&amp;</span>access_type<span class="token operator">=</span>offline<span class="token operator">&amp;</span>
redirect_uri<span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>whatsapp<span class="token punctuation">.</span>sg<span class="token operator">/</span>oauth2callback<span class="token operator">&amp;</span>client_id<span class="token operator">=</span><span class="token number">816630003638</span><span class="token operator">-</span>5p27m684jfpfa6sh6l9chbpreq2hg9ov<span class="token punctuation">.</span>apps<span class="token punctuation">.</span>googleusercontent<span class="token punctuation">.</span>com 

</code></pre> 
<p>返回一个code:</p> 
<pre><code class="prism language-js"><span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>whatsapp<span class="token punctuation">.</span>sg<span class="token operator">/</span>oauth2callback<span class="token operator">?</span>code<span class="token operator">=</span><span class="token number">4</span><span class="token operator">/</span>CpVOd8CljO_gxTRE1M5jtwEFwf8gRD44vrmKNDi4GSS<span class="token punctuation">.</span>kr<span class="token operator">-</span>GHuseD<span class="token operator">-</span>oZEnp6UADFXm0E0MD3FlAI
</code></pre> 
<p>拿到后面的 code 字段。</p> 
<blockquote> 
 <p>code=4/CpVOd8CljO_gxTRE1M5jtwEFwf8gRD44vrmKNDi4GSS.kr-GHuseD-oZEnp6UADFXm0E0MD3FlAI</p> 
</blockquote> 
<p>我们手动的在 postman 之类的工具上，通过固定的参数，拿到 refresh_token（重点，后期全靠它）</p> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">'grant_type'</span><span class="token operator">:</span><span class="token string">'authorization_code'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'code'</span><span class="token operator">:</span><span class="token string">'4/CpVOd8CljO_gxTRE1M5jtwEFwf8gRD44vrmKNDi4GSS.kr-GHuseD-oZEnp6UADFXm0E0MD3FlAI'</span><span class="token punctuation">,</span><span class="token comment">//上一步获取的,</span>
        <span class="token string-property property">'client_id'</span><span class="token operator">:</span><span class="token string">'816630003638-5p27m684jfpfa6sh6l9chbpreq2hg9ov.apps.googleusercontent.com'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'client_secret'</span><span class="token operator">:</span><span class="token string">'36WnPnojshgj56uhghj-xCo'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'redirect_uri'</span><span class="token operator">:</span><span class="token string">'https://api.whatsapp.sg/oauth2callback'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
    


</code></pre> 
<p>向以下的网址发起 Post 请求。</p> 
<pre><code class="prism language-js"><span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>accounts<span class="token punctuation">.</span>google<span class="token punctuation">.</span>com<span class="token operator">/</span>o<span class="token operator">/</span>oauth2<span class="token operator">/</span>token

</code></pre> 
<p>一定要保证网络畅通，只有一次机会，返回的json对象如下</p> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
<span class="token string-property property">"access_token"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token string-property property">"token_type"</span> <span class="token operator">:</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
<span class="token string-property property">"expires_in"</span> <span class="token operator">:</span> <span class="token number">3600</span><span class="token punctuation">,</span>
<span class="token string-property property">"refresh_token"</span> <span class="token operator">:</span> <span class="token string">"1/zaaHNytlC3SEBX7F2cfrHcqJEa3KoAHYeXES6nmho"</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>refresh_token 就拿到了，注意一定要保存好，只有这一次机会，如果再次调用此接口 refresh_token 就是空了，不会返回了。</p> 
<h6><a id="43webOAuth_504"></a>4.3、web-OAuth校验支付是否成功</h6> 
<p>拿到这个refresh_token就可以调用真正的校验接口了，例如我们后端调用的是否支付成功：</p> 
<pre><code class="prism language-js"><span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>androidpublisher<span class="token punctuation">.</span>googleapis<span class="token punctuation">.</span>com<span class="token operator">/</span>androidpublisher<span class="token operator">/</span>v3<span class="token operator">/</span>applications<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>packageName<span class="token punctuation">}</span><span class="token operator">/</span>purchases<span class="token operator">/</span>products<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>productId<span class="token punctuation">}</span><span class="token operator">/</span>tokens<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>purchaseToken<span class="token punctuation">}</span><span class="token operator">?</span>access_token<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>$access_token<span class="token punctuation">}</span>"


</code></pre> 
<p>这里的packageName，productId，purchaseToken 大家都很熟悉了，就是Android 支付成功之后返回给我们的，直接传递给后端即可，而access_token其实就是我们上面拿到的 refresh_token。</p> 
<p>我们需要拿到第一次返回的 refresh_token 保存起来，后续以刷新的方式来获取新的 refresh_token ，用于访问真正的API。</p> 
<p>后台调用验证接口完成之后得到的对象如下：</p> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"kind"</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token string-property property">"purchaseTimeMillis"</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token string-property property">"purchaseState"</span><span class="token operator">:</span> integer<span class="token punctuation">,</span>
  <span class="token string-property property">"consumptionState"</span><span class="token operator">:</span> integer<span class="token punctuation">,</span>
  <span class="token string-property property">"developerPayload"</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token string-property property">"orderId"</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token string-property property">"purchaseType"</span><span class="token operator">:</span> integer<span class="token punctuation">,</span>
  <span class="token string-property property">"acknowledgementState"</span><span class="token operator">:</span> integer<span class="token punctuation">,</span>
  <span class="token string-property property">"purchaseToken"</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token string-property property">"productId"</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token string-property property">"quantity"</span><span class="token operator">:</span> integer<span class="token punctuation">,</span>
  <span class="token string-property property">"obfuscatedExternalAccountId"</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token string-property property">"obfuscatedExternalProfileId"</span><span class="token operator">:</span> string<span class="token punctuation">,</span>
  <span class="token string-property property">"regionCode"</span><span class="token operator">:</span> string
<span class="token punctuation">}</span>

</code></pre> 
<p>只需要验证状态即可：</p> 
<blockquote> 
 <p>consumptionState == 0 purchaseState == 0</p> 
</blockquote> 
<p>说明这个商品已经购买了，并且也没有被消耗，那么此时就可以给移动端返回true,让移动端执行消耗操作。<br> 后端PHP的校验谷歌内购是否成功示例代码：</p> 
<pre><code class="prism language-js">   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checkGooglePay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  
         $google_public_key    <span class="token operator">=</span> <span class="token string">"你的公钥(google后台在你的应用下获取)"</span><span class="token punctuation">;</span>  
         $inapp_purchase_data  <span class="token operator">=</span> $_REQUEST<span class="token punctuation">[</span><span class="token string">'signtureTemp'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   
         $inapp_data_signature <span class="token operator">=</span> $_REQUEST<span class="token punctuation">[</span><span class="token string">'signtureDataTemp'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>   
          $key        <span class="token operator">=</span> <span class="token string">"-----BEGIN PUBLIC KEY-----\n"</span><span class="token punctuation">.</span><span class="token function">chunk_split</span><span class="token punctuation">(</span>$google_public_key<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token string">'-----END PUBLIC KEY-----'</span><span class="token punctuation">;</span>  
          $key        <span class="token operator">=</span> <span class="token function">openssl_pkey_get_public</span><span class="token punctuation">(</span>$key<span class="token punctuation">)</span><span class="token punctuation">;</span>   
          $signature  <span class="token operator">=</span> <span class="token function">base64_decode</span><span class="token punctuation">(</span>$inapp_data_signature<span class="token punctuation">)</span><span class="token punctuation">;</span>  
          $ok         <span class="token operator">=</span> <span class="token function">openssl_verify</span><span class="token punctuation">(</span>$inapp_purchase_data<span class="token punctuation">,</span>$signature<span class="token punctuation">,</span>$key<span class="token punctuation">,</span><span class="token constant">OPENSSL_ALGO_SHA1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> $ok<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
             <span class="token comment">// 支付验证成功！   </span>
             <span class="token comment">//进行二次验证，订单查询     </span>
             
           <span class="token comment">// 1.获取access_token（3600秒有效期）</span>
             $access_token_url <span class="token operator">=</span> <span class="token string">"https://accounts.google.com/o/oauth2/token"</span><span class="token punctuation">;</span>
            $data_tmp2 <span class="token operator">=</span> <span class="token function">array</span><span class="token punctuation">(</span>
                 <span class="token string">'grant_type'</span><span class="token operator">=&gt;</span><span class="token string">'refresh_token'</span><span class="token punctuation">,</span>
                 <span class="token string">'refresh_token'</span><span class="token operator">=&gt;</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token comment">//长效token</span>
                 <span class="token string">'client_id'</span><span class="token operator">=&gt;</span><span class="token string">''</span><span class="token punctuation">,</span>    <span class="token comment">//客户端id    </span>
                <span class="token string">'client_secret'</span><span class="token operator">=&gt;</span><span class="token string">''</span><span class="token punctuation">,</span><span class="token comment">//客户端密钥</span>
                 <span class="token punctuation">)</span><span class="token punctuation">;</span>
             $http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">http</span><span class="token punctuation">(</span>$access_token_url<span class="token punctuation">,</span><span class="token string">'POST'</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             $http<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setContent</span><span class="token punctuation">(</span>$data_tmp2<span class="token punctuation">)</span><span class="token punctuation">;</span>
             $result <span class="token operator">=</span> $http<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            $result <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span>$contents<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             $access_token <span class="token operator">=</span> $result<span class="token punctuation">[</span><span class="token string">'access_token'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

             <span class="token comment">//2.通过获得access_token 就可以请求谷歌的API接口，获得订单状态</span>
             $packageName<span class="token operator">=</span><span class="token string">""</span><span class="token comment">//包名</span>
            $productId<span class="token operator">=</span><span class="token string">""</span> <span class="token comment">//产品Id</span>
             $purchaseToken<span class="token operator">=</span><span class="token string">""</span>
        
              $url <span class="token operator">=</span> <span class="token string">"https://androidpublisher.googleapis.com/androidpublisher/v3/applications/{packageName}/purchases/products/{productId}/tokens/{purchaseToken}?access_token={$access_token}"</span><span class="token punctuation">;</span>
               $http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">http</span><span class="token punctuation">(</span>$url<span class="token punctuation">,</span><span class="token string">'GET'</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             $http<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setContent</span><span class="token punctuation">(</span>$data<span class="token punctuation">)</span><span class="token punctuation">;</span>
             $contents <span class="token operator">=</span> $http<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             $contents <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span>$contents<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              
            <span class="token keyword">if</span><span class="token punctuation">(</span>$contents<span class="token punctuation">[</span><span class="token string">'consumptionState'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> $contents<span class="token punctuation">[</span><span class="token string">'purchaseState'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">//验证成功  购买成功并且没有消耗  google支付中客户端如果没有进行消耗是不能再次购买该商品</span>
                 <span class="token comment">//处理游戏逻辑 发钻石，通知客户端进行消耗</span>
             <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                 <span class="token comment">//订单验证失败</span>
             <span class="token punctuation">}</span>             
         <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>  
             <span class="token comment">//签名验证失败</span>
 
         <span class="token punctuation">}</span>           
     <span class="token punctuation">}</span>

</code></pre> 
<ul><li> <p>第一步是可选的，校验APK的签名，当前应用是不是谷歌市场下载的，如果不是从谷歌市场下载的那么支付不生效。如果你想要的校验APK来源就加上，不想校验也可以。</p> </li><li> <p>第二步就是开始校验谷歌内购支付订单的状态，拿到本地长期保存的refresh_token 以及之前获取到的client_id 和 client_secret 就可以到哪授权的 access_token 。</p> </li><li> <p>第三部就是拿到 access_token 以及 客户端传递的包名，产品id,支付凭证，调用校验接口，拿到订单的当前状态。<br> 然后就是根据订单的状态判断返回给客户端是否有效，让客户端执行消耗操作。<br> 如果您觉得有必要，也可以消耗之后再次调用接口校验，是否已购买，是否已消耗。</p> </li></ul> 
<h6><a id="44_Service_Account_605"></a>4.4、 创建Service Account的授权</h6> 
<p>其实之前的之前的 Web-OAuth 的方式来进行验证不是不行，但是步骤相对比较复杂，而更推荐的方式则是创建服务的方式来进行校验。<br> 我们把视角拉回谷歌市场控制台，找到 Api Access 选项<br> <img src="https://images2.imgbox.com/df/7c/ChvkRjVA_o.png" alt="在这里插入图片描述"></p> 
<p>其实我们在下面的访问权限就可以看到 Service Account 的选项。如果你已有 Service Account 就可以看到全部的关联的 Service Account 。如果你没有此服务，那么就可以点击创建服务去谷歌云创建。当我们到谷歌云里面点击创建 Service Account：<br> <img src="https://images2.imgbox.com/58/82/eAlunA9J_o.png" alt="在这里插入图片描述"></p> 
<p>我们点击创建 Service Account 会走到创建服务的流程：<br> <img src="https://images2.imgbox.com/85/d0/4brPQ2me_o.png" alt="在这里插入图片描述"></p> 
<p>第一步随便写，关键是第二步：<br> <img src="https://images2.imgbox.com/9d/26/EjQ0i8b7_o.png" alt="在这里插入图片描述"></p> 
<p>选择角色为 Service Account Admin<br> <img src="https://images2.imgbox.com/1a/91/EUdoOvi2_o.png" alt="在这里插入图片描述"></p> 
<p>第三步不填，直接提交：<br> <img src="https://images2.imgbox.com/7a/29/9c1nfv5c_o.png" alt="在这里插入图片描述"></p> 
<p>你就能看到你创建的服务啦，接下来就是创建Key，Json的方式创建，然后下载到Json给到后台人员。<br> <img src="https://images2.imgbox.com/d1/a5/EbpWJhuz_o.png" alt="在这里插入图片描述"></p> 
<p>再下一步就回到谷歌商店控制台的 Api Access 看 Service Account 是否已经关联上了：<br> <img src="https://images2.imgbox.com/c8/bb/g4QT1R4f_o.png" alt="在这里插入图片描述"></p> 
<p>如果有这样的信息，说明关联上了，才是正确的流程，如果你创建了 Service Account，但是这里并没有展示，那么就肯定会错：</p> 
<pre><code class="prism language-js"><span class="token punctuation">{<!-- --></span>  
  <span class="token string-property property">"code"</span> <span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span>  
  <span class="token string-property property">"errors"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token string-property property">"domain"</span> <span class="token operator">:</span> <span class="token string">"androidpublisher"</span><span class="token punctuation">,</span>  
    <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token string">"The current user has insufficient permissions to perform the requested operation."</span><span class="token punctuation">,</span>  
    <span class="token string-property property">"reason"</span> <span class="token operator">:</span> <span class="token string">"permissionDenied"</span>  
  <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>  
  <span class="token string-property property">"message"</span> <span class="token operator">:</span> <span class="token string">"The current user has insufficient permissions to perform the requested operation."</span>  
<span class="token punctuation">}</span>

</code></pre> 
<p>之后正常显示了服务，说明你的服务才能访问到谷歌市场这一边，接下来就是点击授予访问权限。<br> 重点是要把财务信息的两项勾选上，这样才能访问到应用内支付校验的相关权限，如图所示：<br> <img src="https://images2.imgbox.com/e2/d6/7Lv7ElxG_o.png" alt="在这里插入图片描述"></p> 
<p>点击保存修改之后就完成了，由于我们关联账号的时候已经勾选了 Google Play Android Developer API 权限，我们现在直接就能用了。</p> 
<p>后端的用法各平台的使用方式不同，但是都是很简单的，直接集成谷歌的API，然后总共就两步，第一步设置Config属性把这个 <strong>Service Account</strong> 生成的Json文件传入，第二步直接调用 GoogleAPI 内置的校验方法即可，都是API内置了的更方便。</p> 
<p>当我们客户端把packageName ，prodectId，purchaseToken 三个字段传给后端，他们直接调用 API 就能直接校验，相比 <strong>Web-OAuth</strong> 的方式要更简单一些。<br> 校验结果如下：<br> <img src="https://images2.imgbox.com/2e/cd/pQtQn86U_o.png" alt="在这里插入图片描述"></p> 
<p>OK,两种方法 <strong>Web-OAuth</strong> 的授权方式，以及 <strong>Service Account</strong> 的授权方式，两种都可以达到效果，用哪种都可以。<br> 至此谷歌内购全部流程已结束。</p> 
<h4><a id="_672"></a>丢单问题处理</h4> 
<p>使用<br> _inAppPurchase.purchaseStream是用来监听消息队列的回调的,也就是所有订单的状态以及信息回调,in_app_purchase这个属性的文档中这么说到:</p> 
<blockquote> 
 <p>IMPORTANT! You must subscribe to this stream as soon as your app launches,<br> preferably before returning your main App Widget in main(). Otherwise you<br> will miss purchase updated made before this stream is subscribed to.<br> 重要！你必须在应用程序启动后立即订阅此流，<br> 最好在main（）中返回主应用程序小部件之前。<br> 否则你将错过订阅此流之前更新的购买。</p> 
</blockquote> 
<p>也就是说当我们的App在第一次启动的时候可以订阅此流来完成补单的操作，但是如果用户是之前丢单了，然后把App又卸载了，再次下载打开App后并没有进行登录操作，那用户的登录信息都拿不到怎么进行补单操作呢？</p> 
<h4><a id="_685"></a>补单解决方案</h4> 
<p>让后端出一个补单的接口，在补单时只需要传一个订单号即可，那App都删除了，之前的订单号客户端怎么获取呢？使用flutter_keychain来实现，flutter_keychain就是使用的iOS的钥匙串来实现的，当用户在苹果服务器下单时，在钥匙串中保存后端生成的订单号，然后再商品成功发货后删除钥匙串里面的订单号，完成一个完整的购买过程，再购买时任何一环出了问题钥匙串里面缓存的订单号都不会被清空，这样在App下一次启动时，在首页或者main函数中使用_inAppPurchase.purchaseStream 监听，在拿到flutter_keychain中保存的订单号完成补单过程。</p> 
<h4><a id="_688"></a>注意点</h4> 
<p><strong>1.在完成苹果服务器付款流程后通知到自己服务器接口也就是验单的接口返回的是成功或者不成功都要调用_inAppPurchase.completePurchase(purchaseDetails)这个方法，不然下次就掉不起苹果支付来了，当然肯定会在失败的判断里面写明白让用户自己去走苹果退款流程的文案（概率较小，但是也得考虑）</strong></p> 
<p><strong>2.商品类型如果是非消耗品的话，在下单完之后一定写一个按钮供点击调用复原的方法，要是不复原的话每次下的订单，订单号都是一样的(需要注意下)。</strong></p> 
<h4><a id="_695"></a>参考：</h4> 
<p>Flutter插件：<br> pay 2.0.0 ：<a href="https://pub.dev/packages/pay" rel="nofollow">https://pub.dev/packages/pay</a><br> in_app_purchase 3.2.0：<a href="https://pub.dev/packages/in_app_purchase" rel="nofollow">https://pub.dev/packages/in_app_purchase</a></p> 
<p>Google pay：<br> <a href="https://developers.google.com/pay/api/android/overview?hl=zh-cn" rel="nofollow">https://developers.google.com/pay/api/android/overview?hl=zh-cn</a><br> <a href="https://developer.android.com/google/play/billing" rel="nofollow">https://developer.android.com/google/play/billing</a></p> 
<p>Apple pay：<br> <a href="https://developer.apple.com/documentation/passkit_apple_pay_and_wallet/apple_pay/setting_up_apple_pay" rel="nofollow">https://developer.apple.com/documentation/passkit_apple_pay_and_wallet/apple_pay/setting_up_apple_pay</a><br> <a href="https://developer.apple.com/in-app-purchase/" rel="nofollow">https://developer.apple.com/in-app-purchase/</a></p> 
<p>教程：<br> <a href="https://juejin.cn/post/7290009513470623800" rel="nofollow">https://juejin.cn/post/7290009513470623800</a><br> <a href="https://juejin.cn/post/7020651416276434958" rel="nofollow">https://juejin.cn/post/7020651416276434958</a><br> <a href="https://blog.csdn.net/mumubumaopao/article/details/136112183">https://blog.csdn.net/mumubumaopao/article/details/136112183</a><br> <a href="https://juejin.cn/post/7233310081809760317" rel="nofollow">https://juejin.cn/post/7233310081809760317</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dd4a0512e08d56b731e4e5330fddccc9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringBoot项目中读取resource目录下的文件（六种方法）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ede653d5f48a8b62637726e5653c6e2f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java导入导出csv格式文件完整版详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>