<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>某短视频sig3算法详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3a40464826bd8dde44215098a9497002/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="某短视频sig3算法详解">
  <meta property="og:description" content="sig3是某个很火的短视频的核心加密参数,48位,主要介绍深度ollvm混淆的so层算法如何还原,除此之外,此app还有大量的花指令需要处理,这块看龙哥的就好了,非常清晰.
https://www.yuque.com/lilac-2hqvv/zfho3g/issny5?#%20%E3%80%8A%E8%8A%B1%E6%8C%87%E4%BB%A4%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%8B 前提准备: 一份去花过后的so,so和apk放123云盘了,在文章末尾.
熟悉crc32,WhiteBoxaes,sha256以及hmac算法,了解越多你能还原的可能性就越大,了解的程度不限于算法细节,特征值,以及算法的魔改方向.本章除了白盒AES不过多介绍,因为写过很多篇了,需要的翻我之前的文章,crc32和sha256以及hmac都会详细介绍.如果你只知道一个md5也没关系,看完你也能收货很多逆向技巧.
因为写文章的时候没办法完全还原我最初的思路,所以我尽可能按照第一次分析这个so的思路来写,所以如果某个地方你觉得很神奇作者tm是怎么想到的,不要奇怪,因为他踩了很多坑,但是坑有很多,没办法完全展现出来,我只能确保你跟着我的思路算法一定可以搞出来,毕竟花几天分析一个so和你一个小时看完这篇文章是截然不同的.
我创建了一个逆向技术交流群,有需要的加我w lyaoyao__i(两个_)
unidbg辅助算法分析 此so有初始化校验,需要先初始化目标函数,否则不会返回正确结果.初始化这块也不是文章的重点,所以这块不详细介绍,一切与算法还原关系不大的我都会淡化,重点介绍上面的几个算法以及unidbg辅助分析算法的技巧.
package com.ks; import com.github.unidbg.AndroidEmulator; import com.github.unidbg.Emulator; import com.github.unidbg.Module; import com.github.unidbg.file.FileResult; import com.github.unidbg.file.IOResolver; import com.github.unidbg.linux.android.AndroidEmulatorBuilder; import com.github.unidbg.linux.android.AndroidResolver; import com.github.unidbg.linux.android.dvm.*; import com.github.unidbg.linux.android.dvm.api.AssetManager; import com.github.unidbg.linux.android.dvm.array.ArrayObject; import com.github.unidbg.linux.android.dvm.wrapper.DvmBoolean; import com.github.unidbg.linux.android.dvm.wrapper.DvmInteger; import com.github.unidbg.memory.Memory; import com.github.unidbg.virtualmodule.android.AndroidModule; import com.github.unidbg.virtualmodule.android.JniGraphics; import java.io.File; import java.io.FileNotFoundException; import java.util.ArrayList; import java.util.List; public class ks2 extends AbstractJni implements IOResolver{ @Override public FileResult resolve(Emulator emulator, String pathname, int oflags) { System.out.println(&#34;file open:&#34;&#43;pathname); return null; } private final AndroidEmulator emulator; private final VM vm; private final Module module; ks2(){ emulator = AndroidEmulatorBuilder.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-13T19:23:27+08:00">
    <meta property="article:modified_time" content="2024-04-13T19:23:27+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">某短视频sig3算法详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>sig3是某个很火的短视频的核心加密参数,48位,主要介绍深度ollvm混淆的so层算法如何还原,除此之外,此app还有大量的花指令需要处理,这块看龙哥的就好了,非常清晰.</p> 
<pre><code>https://www.yuque.com/lilac-2hqvv/zfho3g/issny5?#%20%E3%80%8A%E8%8A%B1%E6%8C%87%E4%BB%A4%E5%A4%84%E7%90%86%EF%BC%88%E4%B8%80%EF%BC%89%E3%80%8B
</code></pre> 
<h2><a id="_4"></a>前提准备:</h2> 
<p>一份去花过后的so,so和apk放123云盘了,在文章末尾.<br> 熟悉crc32,WhiteBoxaes,sha256以及hmac算法,了解越多你能还原的可能性就越大,了解的程度不限于算法细节,特征值,以及算法的魔改方向.本章除了白盒AES不过多介绍,因为写过很多篇了,需要的翻我之前的文章,crc32和sha256以及hmac都会详细介绍.如果你只知道一个md5也没关系,看完你也能收货很多逆向技巧.</p> 
<p>因为写文章的时候没办法完全还原我最初的思路,所以我尽可能按照第一次分析这个so的思路来写,所以如果某个地方你觉得很神奇作者tm是怎么想到的,不要奇怪,因为他踩了很多坑,但是坑有很多,没办法完全展现出来,我只能确保你跟着我的思路算法一定可以搞出来,毕竟花几天分析一个so和你一个小时看完这篇文章是截然不同的.<br> 我创建了一个逆向技术交流群,有需要的加我w lyaoyao__i(两个_)</p> 
<h2><a id="unidbg_10"></a>unidbg辅助算法分析</h2> 
<p>此so有初始化校验,需要先初始化目标函数,否则不会返回正确结果.初始化这块也不是文章的重点,所以这块不详细介绍,一切与算法还原关系不大的我都会淡化,重点介绍上面的几个算法以及unidbg辅助分析算法的技巧.</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ks</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">Emulator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span></span><span class="token class-name">Module</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">FileResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">IOResolver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidEmulatorBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidResolver</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">AssetManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>array<span class="token punctuation">.</span></span><span class="token class-name">ArrayObject</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>wrapper<span class="token punctuation">.</span></span><span class="token class-name">DvmBoolean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>linux<span class="token punctuation">.</span>android<span class="token punctuation">.</span>dvm<span class="token punctuation">.</span>wrapper<span class="token punctuation">.</span></span><span class="token class-name">DvmInteger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>memory<span class="token punctuation">.</span></span><span class="token class-name">Memory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>virtualmodule<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">AndroidModule</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>unidbg<span class="token punctuation">.</span>virtualmodule<span class="token punctuation">.</span>android<span class="token punctuation">.</span></span><span class="token class-name">JniGraphics</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> ks2 <span class="token keyword">extends</span> <span class="token class-name">AbstractJni</span> <span class="token keyword">implements</span> <span class="token class-name">IOResolver</span><span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">FileResult</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">Emulator</span> emulator<span class="token punctuation">,</span> <span class="token class-name">String</span> pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> oflags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"file open:"</span><span class="token operator">+</span>pathname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AndroidEmulator</span> emulator<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">VM</span> vm<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Module</span> <span class="token keyword">module</span><span class="token punctuation">;</span>
    <span class="token function">ks2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        emulator <span class="token operator">=</span> <span class="token class-name">AndroidEmulatorBuilder</span><span class="token punctuation">.</span><span class="token function">for64Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取模拟器的内存操作接口</span>
        <span class="token keyword">final</span> <span class="token class-name">Memory</span> memory <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置系统类库解析</span>
        memory<span class="token punctuation">.</span><span class="token function">setLibraryResolver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AndroidResolver</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建Android虚拟机,传入APK，Unidbg可以替我们做部分签名校验的工作</span>
        vm <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">createDalvikVM</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"unidbg-android/apks/ks/ks11.420.30984.apk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置JNI</span>
        vm<span class="token punctuation">.</span><span class="token function">setJni</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 打印日志</span>
        vm<span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">JniGraphics</span><span class="token punctuation">(</span>emulator<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">AndroidModule</span><span class="token punctuation">(</span>emulator<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        emulator<span class="token punctuation">.</span><span class="token function">getSyscallHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIOResolver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//重定向io</span>
        <span class="token comment">// 加载目标SO</span>
        <span class="token class-name">DalvikModule</span> dm <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"kwsgmain"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        DalvikModule dm = vm.loadLibrary(new File("unidbg-android/apks/ks/libkwsgmain.so"), true);</span>
        <span class="token comment">//获取本SO模块的句柄,后续需要用它</span>
        <span class="token keyword">module</span> <span class="token operator">=</span> dm<span class="token punctuation">.</span><span class="token function">getModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用JNI OnLoad</span>
        dm<span class="token punctuation">.</span><span class="token function">callJNI_OnLoad</span><span class="token punctuation">(</span>emulator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callByAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getJNIEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第⼀个参数是env</span>
        <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> thiz <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"com/kuaishou/android/security/internal/dispatch/JNICLibrary"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>thiz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第⼆个参数，实例⽅法是jobject，静态⽅法是jclass，直接填0，⼀般⽤不到。</span>
        <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> context <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"com/yxcorp/gifshow/App"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// context</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10412</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//参数1</span>
        <span class="token class-name">StringObject</span> appkey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"d7b7d042-d4f2-4012-be60-d97ff2429c17"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// SO⽂件有校验</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>appkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmInteger</span> intergetobj <span class="token operator">=</span> <span class="token class-name">DvmInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>intergetobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayObject</span><span class="token punctuation">(</span>intergetobj<span class="token punctuation">,</span> appkey<span class="token punctuation">,</span> intergetobj<span class="token punctuation">,</span> intergetobj<span class="token punctuation">,</span> context<span class="token punctuation">,</span> intergetobj<span class="token punctuation">,</span> intergetobj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 直接通过地址调⽤</span>
        <span class="token class-name">Number</span> numbers <span class="token operator">=</span> <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>emulator<span class="token punctuation">,</span> <span class="token number">0x41680</span><span class="token punctuation">,</span> list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"numbers:"</span> <span class="token operator">+</span> numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> object <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>numbers<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> object<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"result:"</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">callObjectMethodV</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dvmObject<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VaList</span> vaList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token string">"com/yxcorp/gifshow/App-&gt;getPackageCodePath()Ljava/lang/String;"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"/data/app/com.smile.gifmaker-q14Fo0PSb77vTIOM1-iEqQ==/base.apk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token string">"com/yxcorp/gifshow/App-&gt;getAssets()Landroid/content/res/AssetManager;"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AssetManager</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token string">"com/yxcorp/gifshow/App-&gt;getPackageName()Ljava/lang/String;"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"com.smile.gifmaker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">case</span> <span class="token string">"com/yxcorp/gifshow/App-&gt;getPackageManager()Landroid/content/pm/PackageManager;"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">DvmClass</span> clazz <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"android/content/pm/PackageManager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> clazz<span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">callObjectMethodV</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmObject<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> vaList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">callBooleanMethodV</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dvmObject<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VaList</span> vaList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token string">"java/lang/Boolean-&gt;booleanValue()Z"</span><span class="token operator">:</span>
                <span class="token class-name">DvmBoolean</span> dvmBoolean <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DvmBoolean</span><span class="token punctuation">)</span> dvmObject<span class="token punctuation">;</span>
                <span class="token keyword">return</span> dvmBoolean<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">callBooleanMethodV</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmObject<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> vaList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">callStaticObjectMethodV</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmClass</span> dvmClass<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VaList</span> vaList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token string">"com/kuaishou/android/security/internal/common/ExceptionProxy-&gt;getProcessName(Landroid/content/Context;)Ljava/lang/String;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"com.smile.gifmaker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"com/meituan/android/common/mtguard/NBridge-&gt;getSecName()Ljava/lang/String;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"ppd_com.sankuai.meituan.xbt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"com/meituan/android/common/mtguard/NBridge-&gt;getAppContext()Landroid/content/Context;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"android/content/Context"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"com/meituan/android/common/mtguard/NBridge-&gt;getMtgVN()Ljava/lang/String;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"4.4.7.3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token string">"com/meituan/android/common/mtguard/NBridge-&gt;getDfpId()Ljava/lang/String;"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">callStaticObjectMethodV</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmClass<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> vaList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callStaticVoidMethodV</span><span class="token punctuation">(</span><span class="token class-name">BaseVM</span> vm<span class="token punctuation">,</span> <span class="token class-name">DvmClass</span> dvmClass<span class="token punctuation">,</span> <span class="token class-name">String</span> signature<span class="token punctuation">,</span> <span class="token class-name">VaList</span> vaList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token string">"com/kuaishou/android/security/internal/common/ExceptionProxy-&gt;nativeReport(ILjava/lang/String;)V"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">callStaticVoidMethodV</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> dvmClass<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> vaList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get_NS_sig3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">FileNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">getJNIEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第⼀个参数是env</span>
        <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> thiz <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"com/kuaishou/android/security/internal/dispatch/JNICLibrary"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>thiz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第⼆个参数，实例⽅法是jobject，静态⽅法是jclass，直接填0，⼀般⽤不到。</span>
        <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> context <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">resolveClass</span><span class="token punctuation">(</span><span class="token string">"com/yxcorp/gifshow/App"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newObject</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// context</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10418</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//参数1</span>
        <span class="token class-name">StringObject</span> urlObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"yangruhua"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>urlObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ArrayObject</span> arrayObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayObject</span><span class="token punctuation">(</span>urlObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringObject</span> appkey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"d7b7d042-d4f2-4012-be60-d97ff2429c17"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>appkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmInteger</span> intergetobj <span class="token operator">=</span> <span class="token class-name">DvmInteger</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>intergetobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmBoolean</span> boolobj <span class="token operator">=</span> <span class="token class-name">DvmBoolean</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>boolobj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringObject</span> appkey2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringObject</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">"7e46b28a-8c93-4940-8238-4c60e64e3c81"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span>appkey2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">addLocalObject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayObject</span><span class="token punctuation">(</span>arrayObject<span class="token punctuation">,</span> appkey<span class="token punctuation">,</span> intergetobj<span class="token punctuation">,</span> boolobj<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> boolobj<span class="token punctuation">,</span> appkey2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Number</span> numbers <span class="token operator">=</span> <span class="token keyword">module</span><span class="token punctuation">.</span><span class="token function">callFunction</span><span class="token punctuation">(</span>emulator<span class="token punctuation">,</span> <span class="token number">0x41680</span><span class="token punctuation">,</span> list<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"numbers:"</span> <span class="token operator">+</span> numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DvmObject</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> object <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span>numbers<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> object<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"result:"</span> <span class="token operator">+</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">FileNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        ks2 ks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">ks2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ks<span class="token punctuation">.</span><span class="token function">callByAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ks<span class="token punctuation">.</span><span class="token function">get_NS_sig3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>确保运行后能出结果再进行下面的操作,每运行一次结果都在变化,输入是固定的yangruhua.<br> 猜测存在时间戳或者随机数,如果能固定住他们对算法还原帮助会很大,so可以有很多方法获取时间戳和随机数,比如jni,库函数,系统调用(最常见)以及文件访问<br> <img src="https://images2.imgbox.com/5f/e8/PWjvplCr_o.png" alt="在这里插入图片描述"><br> 经过我的测试,只需要改unidbg-api/src/main/java/com/github/unidbg/unix/UnixSyscallHandler.java下的gettimeofday64函数的System.currentTimeMillis()固定即可,但是如果你的ks版本是9点几左右的可能不行,还需要固定随机数,因为我这个11版本的随机数采用了时间戳作为随机种子导致结果不变,所以只需要改这一处.后面遇到的时候还会介绍为什么会这样.我固定的时间戳是1712760339987,记住这个值,如果会影响最终结果肯定是参与了运算的.<br> <img src="https://images2.imgbox.com/4b/d4/yOhVRqA1_o.png" alt="在这里插入图片描述"><br> 运行后每次结果都是0110604391b5265849494a4b7429b2a243f7443554585640</p> 
<h2><a id="_182"></a>算法分析</h2> 
<p>结果有了也固定住了,接下来该还原算法了.<br> 看下目标函数,动态注册的,符号什么的去的很干净,几乎没办法根据字符串猜函数功能(几乎所有的).<br> <img src="https://images2.imgbox.com/93/87/CfiAJBli_o.png" alt="在这里插入图片描述"><br> 接近3000行的伪c代码,并且只是其中一个主函数,并且左边的流程图有严重的ollvm混淆,怎么看是否有ollvm混淆,看流程图或者导出函数<br> <img src="https://images2.imgbox.com/eb/62/hqwgX2qh_o.png" alt="在这里插入图片描述"><br> 这种x开头并且一大串的就是,流程图就是上面所展示的,还可以看伪c代码,有很多while循环或者分支的就是.<br> 怎么分析?<br> 思路1:从前往后看,跟着入参走<br> 思路2:从后往前推,由结果倒推算法<br> 思路1只适合比较简单的so,如果so很复杂,你压根跟踪不了入参,因为入参很多地方都会出现,而且大部分时候入参不止一个.所以思路2是比较好的,当然这也是我个人的习惯,如果你非要跟入参也不是不行,根据个人习惯就好了.</p> 
<h2><a id="trace_194"></a>trace分析</h2> 
<p>接近3000多行代码,0110604391b5265849494a4b7429b2a243f7443554585640第一次生成的位置在哪?如果只是找到了它最终返回的位置没办法定位到最初生成的位置,因为3000多行这个变量赋值来赋值去很混乱,静态分析几乎找不到,当然你时间够多也可以试试.<br> 解决方法呢?unidbg trace.trace的时机呢?最好是在调用初始化函数后,否则初始化的那个执行可能会干扰,不过关系不大.</p> 
<pre><code class="prism language-java"><span class="token class-name">String</span> traceFile <span class="token operator">=</span> <span class="token string">"unidbg-android/src/test/java/com/ks/trace.txt"</span><span class="token punctuation">;</span>
<span class="token class-name">PrintStream</span> traceStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">try</span><span class="token punctuation">{<!-- --></span>
    traceStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>traceFile<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 <span class="token comment">//核心 trace 开启代码，也可以自己指定函数地址和偏移量</span>
emulator<span class="token punctuation">.</span><span class="token function">traceCode</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">.</span>base<span class="token punctuation">,</span><span class="token keyword">module</span><span class="token punctuation">.</span>base<span class="token operator">+</span><span class="token keyword">module</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setRedirect</span><span class="token punctuation">(</span>traceStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"_NS_sig3 start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/74/f4/p6AMOx5w_o.png" alt="在这里插入图片描述"><br> 就在函数最开始的地方trace一下,大概一两分钟的时间就好了.<br> <img src="https://images2.imgbox.com/c8/9f/VNqaYqin_o.png" alt="在这里插入图片描述"><br> 最终trace的结果10万行.上面我们说了从结果往前推,结果是0110604391b5265849494a4b7429b2a243f7443554585640,这个时候搜索的技巧显得很重要了,你无法确定结果是大端续还是小端续,是一个字节拼接还是4个字节拼接,所以你都得尝试一下.<br> <img src="https://images2.imgbox.com/2f/15/PcDhCBUe_o.png" alt="在这里插入图片描述"><br> 比如你可以先搜0x0110,没结果,搜0x4360(按4个字节倒过来的)<br> <img src="https://images2.imgbox.com/f1/a7/tv9Kkg5n_o.png" alt="在这里插入图片描述"><br> 都不行,试一下搜一个字节的,估计会比较多,0110604391b5265849494a4b7429b2a243f7443554585640<br> 你不要直接搜0x01或者0x10,这个太普遍了,0x43出现的概率就很小,出现的话是我们的目标位置可能性更大.<br> <img src="https://images2.imgbox.com/e3/dd/s3QssyCu_o.png" alt="在这里插入图片描述"><br> 注意啊,从后往前搜,287个也挺多,找赋值的地方,这个位置显然不太对,ldp x20, x19, [sp, #0x50]这条指令从ldr演化过来,p是Pair,中文就是一双的意思,也就是两个,x20存高位数据,x19存低位数据,从sp偏移0x50处取,这个位置显然不对,这个0x43会被覆盖掉,往上找.<br> <img src="https://images2.imgbox.com/3a/70/RQ2wxg8t_o.png" alt="在这里插入图片描述"><br> 这个位置感觉很合适,赋值操作,搜一下[libkwsgmain.so 0x012340] [e903142a] 0x40012340: “mov w9, w20”,注意不要搜到后面的,只搜这条指令<br> <img src="https://images2.imgbox.com/a4/a7/NMCAw1qz_o.png" alt="在这里插入图片描述"><br> 最后一个0x40<img src="https://images2.imgbox.com/4c/43/n6odqRw1_o.png" alt="在这里插入图片描述"><br> 倒数第二个0x56<br> <img src="https://images2.imgbox.com/fd/e3/bnYuPpgX_o.png" alt="在这里插入图片描述"><br> 不就是0110604391b5265849494a4b7429b2a243f7443554585640从后往前的字节吗?so中的地址是12340</p> 
<p><img src="https://images2.imgbox.com/60/71/AtcnmX2m_o.png" alt="在这里插入图片描述"><br> 进来后显示在这个位置,c代码看不懂在干什么,看下汇编<br> <img src="https://images2.imgbox.com/90/77/Z1pvNcqV_o.png" alt="在这里插入图片描述"><br> w20给w9,w20没出现过,unidbg中下断看下,先看下这个位置走了多少次</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">HookByConsoleDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Debugger</span> debugger <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        debugger<span class="token punctuation">.</span><span class="token function">addBreakPoint</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">.</span>base<span class="token operator">+</span><span class="token number">0x12340</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BreakPointCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">RegisterContext</span> context <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onHit</span><span class="token punctuation">(</span><span class="token class-name">Emulator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> emulator<span class="token punctuation">,</span> <span class="token keyword">long</span> address<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            num<span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"num次:"</span><span class="token operator">+</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/50/bb/KoDRxLo9_o.png" alt="在这里插入图片描述"><br> 和trace的结果一样,接下来修改下代码在第81次调用的时候断下</p> 
<pre><code class="prism language-java"><span class="token keyword">if</span><span class="token punctuation">(</span>num<span class="token operator">&gt;</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/92/6e/i6GOWvnb_o.png" alt="在这里插入图片描述"><br> 可以看到此时x20就是0x01了就是第一个字节,我的本意是想监控谁往一块内存地址写入了0110604391b5265849494a4b7429b2a243f7443554585640,但是这个位置都是赋值操作,不是最开始的地方,所以这个位置不是很理想,再去trace的位置搜一下有没有更好的位置,没有再回过头来分析.<br> 这次我在0x43后面加了一个空格<br> <img src="https://images2.imgbox.com/57/d9/ajQj0pMg_o.png" alt="在这里插入图片描述"><br> 结果有54个,这个位置似乎挺好的ldrb w1, [x21], #1,还是ldr演变过来的,b就是byte,加载一个字节给w1,那么x21会不会存的就是那24个字节呢?试试看,还是和上面一样的操作流程.3d720处下断,也是走104次,在第81处断下.<br> <img src="https://images2.imgbox.com/ac/67/3BZgPn80_o.png" alt="在这里插入图片描述"><br> 结果出来了,就是这个位置了,先声明一下,后面的一些操作也不一定是我最开始的流程,也有可能是写文章时突发奇想出来的,因为我也记不清最开始是怎么操作的.<br> 接着这控制台输入bt(back trace),也就是看堆栈,和你js操作差不多<br> <img src="https://images2.imgbox.com/0e/35/KqQL1o1w_o.png" alt="在这里插入图片描述"><br> 每个栈都看一下,最后锁定在0x04561c<br> <img src="https://images2.imgbox.com/b4/bb/PaqbUVma_o.png" alt="在这里插入图片描述"><br> ida中就是这个位置,并且这个位置就是在最开始的那个大函数内部,接着下断看下3D5F4处调了几次<br> <img src="https://images2.imgbox.com/a6/c9/6TgI1QJj_o.png" alt="在这里插入图片描述"><br> 3次,额,不确定是有其他地方调用了还是本来在这行汇编就跑了3次,所以hook下这行汇编看看<br> 还是之前的hook代码,改下地址就好了,结果是一次,把返回的true改成false,就可以断下来<br> <img src="https://images2.imgbox.com/a2/c3/Llh4Reih_o.png" alt="在这里插入图片描述"><br> 这个时候参数已经组装好了,根据ATPCS调用约定,arm64下参数1到参数8 分别保存到 X0~X7 寄存器中 ，剩下的参数从右往左一次入栈，被调用者实现栈平衡，返回值存放在 X0 中,所以这行汇编处参数已经组装好了<br> <img src="https://images2.imgbox.com/44/9e/Njoptywc_o.png" alt="在这里插入图片描述"><br> mx0看一下,结果在函数调用前就已经生成了.<br> <img src="https://images2.imgbox.com/ff/27/Rgf3bs1x_o.png" alt="在这里插入图片描述"><br> 你可以尝试监控一下谁往x0的地址也就是0xbffff5f0写入了数据,不过这里不需要了,上面的代码就能看明白,v371来自上面的一个do while循环,直接监控也是这个位置,所以每个字节来自v371^(v287异或v290)<br> 注意,两次异或,我们在^=汇编处下断看下,稍微懂点汇编就行.<br> <img src="https://images2.imgbox.com/a7/ec/8owyYLG0_o.png" alt="在这里插入图片描述"><br> 0x45598处<br> <img src="https://images2.imgbox.com/7c/f8/C3XWnna6_o.png" alt="在这里插入图片描述"><br> 调用了23下,但是结果是24字节,把ture改成false断下来分析下</p> 
<p><img src="https://images2.imgbox.com/d4/fd/Jvoo8Q2M_o.png" alt="在这里插入图片描述"><br> x11异或x12再给x11,这个x12是0xfffff940,x11是0x41,这个x12不是地址,直接m会报错的<br> <img src="https://images2.imgbox.com/22/77/fYCHS5pI_o.png" alt="在这里插入图片描述"><br> 看下一条指令strb w11, [x8, x10],拆解下就是 str b(store byte),将w11存到x8偏移x10处,b0x4004559c,在这行汇编下个临时断点看下结果<br> <img src="https://images2.imgbox.com/ad/f0/YKaqFucD_o.png" alt="在这里插入图片描述"><br> x11变成了0xfffff901,后面两位不就是0110604391b5265849494a4b7429b2a243f7443554585640的开头吗,x12是0xfffff940,x11是0x41,他两异或就是0x40异或0x41得到0x01,后续都是这样操作<br> <img src="https://images2.imgbox.com/61/e4/yqjqEOI5_o.png" alt="在这里插入图片描述"><br> 这里真的很清晰了,概况一下就是v371处的地址先计算所有字节之和得到v287,取v287的最后一个字节进行异或,一共23轮,至于最后一个字节,一开始就已经生成了.<br> 所以重点就是来自mx8的前23个字节,这里也可以看到第24个字节0x40已经生成了,对应结果的最后一个字节<br> <img src="https://images2.imgbox.com/b2/16/Tr0xZetL_o.png" alt="在这里插入图片描述"><br> 这23个字节你有没有感觉很奇怪,中间很多00,正常来说如果是经过了什么处理肯定不会出现那么多00,应该和结果一样是16个字符比较均匀的排列,所以我怀疑这个位置离参数生成结果比较近,当然你也可以和上面的步骤一样接着跟这23个字符,去trace的文件中找.<br> 能影响入参的就两个,一共时间戳1712760339987,另一个明文yangruhua.<br> 接下来有3种情况<br> 1只改时间戳<br> 2只改明文<br> 3两个都改<br> 3种情况的输出我都打印一下,时间戳改成1712760339986,字符串改成yangruhua1<br> 第一种<br> <img src="https://images2.imgbox.com/1f/60/Dgl1turg_o.png" alt="在这里插入图片描述"><br> 第二种<br> <img src="https://images2.imgbox.com/5f/52/pnqoLvTc_o.png" alt="在这里插入图片描述"><br> 第三种<br> <img src="https://images2.imgbox.com/d0/31/YYHrV087_o.png" alt="在这里插入图片描述"><br> 总结一下,这样改动只会影响13-16字节,对比23两种情况发现,这4个字节的产生是由明文决定的,但是就算明文不变,时间戳也会影响结果,但是从1712760339987改到1712760339986结果不变,什么原因?<br> 会不会是需要秒级别以上时间戳改动才会影响结果?<br> 把1712760339987改成1712760338987<br> <img src="https://images2.imgbox.com/0d/d4/vH2OXR2f_o.png" alt="在这里插入图片描述"><br> 运行一下,第5-8和17-20字节都改变了,并且17-20字节由13 A6 16 66变成了12 A6 16 66,我只是把1712760339987改成了1712760338987,也是只改了一秒,会不会这4个字节和这个秒数有关<br> <img src="https://images2.imgbox.com/58/fa/cqkBouWr_o.png" alt="在这里插入图片描述"><br> 很明显了17-20字节数秒级时间戳的16进制的小端序,正常的就是大端序,按字节反转就是小端序.至于5-8字节也变化了,开头我们说了随机数,9版本的我试过是纯随机的,11版本的好像用了时间戳作为随机种子,时间戳固定的话,随机数也是相对固定的,还和其他因素有关,没办法由时间戳来推出这4个字节,至于是怎么发现的,本来打算trace分析一波,会走到jnionload里面去,执行时机非常早,需要在模拟器刚刚创建的时候就trace上,但是jnionload还没执行<br> <img src="https://images2.imgbox.com/5e/c2/nortst2Y_o.png" alt="在这里插入图片描述"><br> 但是篇幅太长了,所以我这里就不继续了!!!<br> 所以只需要分析第13-16字节的数据就好了,已知只和明文有关.</p> 
<h2><a id="crc32aessha256hmac_314"></a>crc32+aes+sha256+hmac</h2> 
<p>算法就是上面这几个,接下来具体分析下.先说明下sha256+hmac这两个其实是组合hmacSha256,也可以拆开来计算.接着上面追踪38 64 FC ED,输入是yangruhua<br> <img src="https://images2.imgbox.com/8b/65/iPEDhv1T_o.png" alt="在这里插入图片描述">搜了下没有结果,看看是不是小端序<br> <img src="https://images2.imgbox.com/07/6f/vT7DcizD_o.png" alt="在这里插入图片描述"><br> 是的,就3处.下面那条str是存储指令,看上面那条121d4处<br> <img src="https://images2.imgbox.com/2f/d1/NOE3sYgf_o.png" alt="在这里插入图片描述"><br> 进来就是return的位置,就是他两异或<br> 看下这个函数的入参,因为返回值就是结果,函数是120C4,这个函数处下断,先看下调用了几次,确认是1次.<br> 看下入参<br> <img src="https://images2.imgbox.com/79/17/fftZ5FB4_o.png" alt="在这里插入图片描述"><br> 3个参数 入参2是入参1的长度0x30<br> <img src="https://images2.imgbox.com/d2/d6/FZRD9KxN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8e/65/8UagS8ad_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="crc32_327"></a>crc32</h3> 
<p>这里是小端序,0x04c11db7,什么时候是大端什么时候是小端,凭感觉,0x04c11db7这个是啥?传过去一般来说不可能没用吧<br> <img src="https://images2.imgbox.com/7a/08/nXmiTpqV_o.png" alt="在这里插入图片描述"><br> crc32特征值,其实我第一次做的时候并不是直接去看这个函数的,而是跟着trace的代码往上分析,它不是异或得来的吗,一步步往上看,会发现用到了一个0xEDB88320,并且很频繁<br> <img src="https://images2.imgbox.com/44/a5/T0iqPd3e_o.png" alt="在这里插入图片描述"><br> 搜一下<br> <img src="https://images2.imgbox.com/c5/6f/m63CbAIi_o.png" alt="在这里插入图片描述"><br> 也是crc32的特征值,介绍一下crc32吧<br> CRC32 是一种流行的校验和算法，用于检测数据损坏。该算法存在多种具有相似数学特性的变体。所以这个特征值有很多,常见的有这两个<br> 以0xEDB88320为特征纯算</p> 
<pre><code class="prism language-python">CRC32_POLYNOMIAL <span class="token operator">=</span> <span class="token number">0xEDB88320</span>
<span class="token keyword">def</span> <span class="token function">calculate_crc32</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    crc <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span> <span class="token comment"># 初始值</span>
    <span class="token keyword">for</span> byte <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        crc <span class="token operator">^</span><span class="token operator">=</span> byte
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> crc <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">:</span>
                crc <span class="token operator">=</span> <span class="token punctuation">(</span>crc <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> CRC32_POLYNOMIAL
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                crc <span class="token operator">&gt;&gt;</span><span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">return</span> crc <span class="token operator">^</span> <span class="token number">0xFFFFFFFF</span> <span class="token comment"># 取反</span>
<span class="token comment"># 示例数据</span>
data <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span><span class="token string">'452585a574619ae3eee5403180b854b7188cfc945093a20d1e0a1441ed806cfbe0ed8ea4aab0c1d5f4519f8d19c4948f'</span><span class="token punctuation">)</span>
byte_array <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
crc32 <span class="token operator">=</span> calculate_crc32<span class="token punctuation">(</span>byte_array<span class="token punctuation">)</span>
<span class="token comment"># 打印结果</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"CRC32:"</span><span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token punctuation">(</span>crc32<span class="token punctuation">,</span> <span class="token string">'08X'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>以0x04c11db7为特征值的查表法实现</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">generate_crc32_table</span><span class="token punctuation">(</span>_poly<span class="token punctuation">)</span><span class="token punctuation">:</span>
    custom_crc32_table <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        c <span class="token operator">=</span> i <span class="token operator">&lt;&lt;</span> <span class="token number">24</span>
        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;</span> <span class="token number">0x80000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                c <span class="token operator">=</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> _poly
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                c <span class="token operator">=</span> c <span class="token operator">&lt;&lt;</span> <span class="token number">1</span>
        custom_crc32_table<span class="token punctuation">.</span>append<span class="token punctuation">(</span>c <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> custom_crc32_table
origin_crc32_table <span class="token operator">=</span> generate_crc32_table<span class="token punctuation">(</span><span class="token number">0x04c11db7</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">getCrc32</span><span class="token punctuation">(</span>bytes_arr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    length <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>bytes_arr<span class="token punctuation">)</span>
    <span class="token keyword">if</span> bytes_arr <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        crc <span class="token operator">=</span> <span class="token number">0xffffffff</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">:</span>
            crc <span class="token operator">=</span> <span class="token punctuation">(</span>crc <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> origin_crc32_table<span class="token punctuation">[</span><span class="token punctuation">(</span>getReverse<span class="token punctuation">(</span>bytes_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>crc <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        crc <span class="token operator">=</span> <span class="token number">0xffffffff</span>
    crc <span class="token operator">=</span> getReverse<span class="token punctuation">(</span>crc <span class="token operator">^</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> crc
<span class="token keyword">def</span> <span class="token function">getReverse</span><span class="token punctuation">(</span>tempData<span class="token punctuation">,</span> byte_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
    reverseData <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> byte_length<span class="token punctuation">)</span><span class="token punctuation">:</span>
        reverseData <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tempData<span class="token operator">&gt;&gt;</span>i<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>byte_length<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>i<span class="token punctuation">)</span>
    <span class="token keyword">return</span> reverseData
data <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span><span class="token string">'452585a574619ae3eee5403180b854b7188cfc945093a20d1e0a1441ed806cfbe0ed8ea4aab0c1d5f4519f8d19c4948f'</span><span class="token punctuation">)</span>
byte_array <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
crc32 <span class="token operator">=</span> getCrc32<span class="token punctuation">(</span>byte_array<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"CRC32:"</span><span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token punctuation">(</span>crc32<span class="token punctuation">,</span> <span class="token string">'08X'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>这两个计算的结果都是EDFC6438,转小端序就是38 64 FC ED,除此之外binascii.crc32就有crc算法,不需要上面的算法,这里贴上只是为了介绍这个算法,<br> <img src="https://images2.imgbox.com/04/44/f6D4I9iJ_o.png" alt="在这里插入图片描述"><br> 有帖子说0x04C11DB7 是正式,0xEDB88320 是反式,这里不需要管,因为它没有魔改,结果也是出来了</p> 
<p>还不懂可以参考这篇文章https://github.com/Michaelangel007/crc32</p> 
<h3><a id="wbAes_396"></a>wbAes</h3> 
<p><img src="https://images2.imgbox.com/ea/aa/nlDcR2Mv_o.png" alt="在这里插入图片描述"><br> 追踪这48字节的由来,方法有很多,比如可以这此处查看下调用栈或者直接跟上一个函数.<br> 我这里选择一个比较快的方式,跟踪0x404e4e40这块内存内存,谁往这里写入了这48个字节,那个位置离生成位置肯定是非常近的.</p> 
<pre><code class="prism language-java">emulator<span class="token punctuation">.</span><span class="token function">traceWrite</span><span class="token punctuation">(</span><span class="token number">0x404e4e40</span><span class="token punctuation">,</span><span class="token number">0x404e4e40</span><span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b1/f0/U5xXLIod_o.png" alt="在这里插入图片描述"></p> 
<p>有结果,看下pc寄存器指向的位置0x1c17c,这个pc寄存器指向了当前将要执行的指令的地址,LR寄存器指向的是结束的地址.<br> <img src="https://images2.imgbox.com/03/c5/kVXLx5jV_o.png" alt="在这里插入图片描述"><br> 这个位置视乎不太好往上找,看下lr寄存器指向的位置0x1ea10的上一条,memcpy,src拷贝到v28,长度是v41.<br> <img src="https://images2.imgbox.com/72/ed/lFb0e8rs_o.png" alt="在这里插入图片描述"><br> 如果是拷贝的话,就不是最初生成的位置,需要追踪scr的赋值位置,还是一样的道理,直接找很慢,还不一定能找到.<br> <img src="https://images2.imgbox.com/c8/20/qeOIGRRm_o.png" alt="在这里插入图片描述"></p> 
<p>0x1ea10的上一条汇编,bl会跳到memcpy,估计会跳到libc.so里面,但是在此之前参数一样组装好了,<br> 根据ATPCS调用约定,arm64下参数1到参数8 分别保存到 X0~X7 寄存器中 ，剩下的参数从右往左一次入栈，被调用者实现栈平衡，返回值存放在 X0 中,所以这行汇编处参数已经组装好了,我们要的数据就在x1中.<br> <img src="https://images2.imgbox.com/c6/4c/1zQ56AGV_o.png" alt="在这里插入图片描述"><br> 地址是0x404d3240,改下trace代码 emulator.traceWrite(0x404d3240,0x404d3240+0x30);<br> <img src="https://images2.imgbox.com/54/c8/GTWalNXB_o.png" alt="在这里插入图片描述"><br> 跳到pc寄存器指向的位置0x265fc,可以看到结果是在这里一个字节一个字节添上去的,我这里改了入参名,所以是output和input,你那里不是.<br> <img src="https://images2.imgbox.com/da/05/fWvnm2ij_o.png" alt="在这里插入图片描述"><br> hook下2636C函数<br> <img src="https://images2.imgbox.com/b2/18/neBGVHvX_o.png" alt="在这里插入图片描述"><br> 会调用3次,应该是一次16个字节,一共48个字节<br> <img src="https://images2.imgbox.com/32/46/TEXQRmJw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2f/9c/mvTuDlWz_o.png" alt="在这里插入图片描述"><br> 看下入参,这个后面有16个10,这个似乎是pkcs7填充过的,应该不会有其他的巧合,这种填充一般用于对称加密比如des和aes,但是des分组长度8字节,这个16字节,大概率是aes了.我需要验证下,但是这个位置不好验证,因为假设它真的是aes,这个位置已经填充过了,我需要在最开始调用的地方验证.<br> 监控下填充过的数据0x404d3300的赋值位置<br> <img src="https://images2.imgbox.com/d1/b1/RhATlUh9_o.png" alt="在这里插入图片描述"><br> pc寄存器是libc指向的,看lr寄存器0x25ab8<br> <img src="https://images2.imgbox.com/9a/d0/kBd357NE_o.png" alt="在这里插入图片描述"><br> 进入了259a0函数处,hook看一下.只调用一次,看下入参<br> <img src="https://images2.imgbox.com/0e/54/Y0hcpBaP_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/37/97/jVhtkEff_o.png" alt="在这里插入图片描述"><br> 入参1是未填充过的,入参2是长度0x20.<br> 接下来验证下是都是真的pkcs7填充过的,在这个位置hook把入参改了,同时监控0x2636C处入参是否改变.</p> 
<pre><code class="prism language-java">debugger<span class="token punctuation">.</span><span class="token function">addBreakPoint</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">.</span>base<span class="token operator">+</span><span class="token number">0x2636C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
debugger<span class="token punctuation">.</span><span class="token function">addBreakPoint</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">.</span>base<span class="token operator">+</span><span class="token number">0x259a0</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">BreakPointCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token class-name">RegisterContext</span> context <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onHit</span><span class="token punctuation">(</span><span class="token class-name">Emulator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> emulator<span class="token punctuation">,</span> <span class="token keyword">long</span> address<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> hexString <span class="token operator">=</span> <span class="token string">"79616e677275687561"</span><span class="token punctuation">;</span> <span class="token comment">// 十六进制字符串</span>
    <span class="token keyword">int</span> length <span class="token operator">=</span> hexString<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token class-name">MemoryBlock</span> fakeInputBlock <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">malloc</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> byteArray <span class="token operator">=</span> <span class="token class-name">DatatypeConverter</span><span class="token punctuation">.</span><span class="token function">parseHexBinary</span><span class="token punctuation">(</span>hexString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fakeInputBlock<span class="token punctuation">.</span><span class="token function">getPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 修改X1为指向新字符串的新指针</span>
    emulator<span class="token punctuation">.</span><span class="token function">getBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reg_write</span><span class="token punctuation">(</span><span class="token class-name">Arm64Const</span><span class="token punctuation">.</span><span class="token constant">UC_ARM64_REG_X0</span><span class="token punctuation">,</span>fakeInputBlock<span class="token punctuation">.</span><span class="token function">getPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    emulator<span class="token punctuation">.</span><span class="token function">getBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reg_write</span><span class="token punctuation">(</span><span class="token class-name">Arm64Const</span><span class="token punctuation">.</span><span class="token constant">UC_ARM64_REG_X1</span><span class="token punctuation">,</span> <span class="token number">0x9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    emulator<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addBreakPoint</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getLRPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>peer<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BreakPointCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onHit</span><span class="token punctuation">(</span><span class="token class-name">Emulator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> emulator<span class="token punctuation">,</span> <span class="token keyword">long</span> address<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里需要注意需要把入参的长度一并改了,否则可能会发生意想不到的错误<br> <img src="https://images2.imgbox.com/3d/e3/wGdKl8NF_o.png" alt="在这里插入图片描述"><br> 0x2636C处入参长度也变了,还记得之前是0x30对吧.<br> <img src="https://images2.imgbox.com/35/1a/WHgb2SsZ_o.png" alt="在这里插入图片描述"><br> 看吧,pkcs7,差7个字节补7个07.其实就算这样也不能确定是aes,肯定有其他对称算法也是16字节分组,不过比较少.暂时就认为他是了,你也可以用ida的插件识别下用到了哪些算法.<br> <img src="https://images2.imgbox.com/8e/f0/SAKwkYxH_o.png" alt="在这里插入图片描述"><br> 我是本着学习的时候能不用就不用,不到万不得已不用这个插件,有RijnDael_AES字眼,大概率就是aes了,有时候你会见到RijnDael,不要奇怪,最初就是叫RijnDael,后来评高级des(aes),Advanced Encryption Standard,des是Data Encryption Standard,也就变成了aes,几乎很少见到RijnDael.<br> 那首先确定下是什么模式,填充方式已经知道了,pkcs7,常见的就是cbc和ecb呗.cbc需要一个iv,这些模式其实很多对称加密算法都是通用的.<br> 怎么验证呢?传两个一样的参数就好了,看看结果是否一样.<br> 把16进制改成79616e6772756875616c6f7665796f7579616e6772756875616c6f7665796f75<br> 长度改回0x20.<br> 入参<br> <img src="https://images2.imgbox.com/ad/50/Q4YmO09v_o.png" alt="在这里插入图片描述"><br> 加密两轮后结果<br> <img src="https://images2.imgbox.com/08/67/LTDkwkhq_o.png" alt="在这里插入图片描述"><br> 结果一样是ecb,现在差最后一个不知道了,也是最重要的秘钥.<br> 看了下入参,没有秘钥,大概率是白盒了,接下来找state块,入参是个很好的选择.</p> 
<p><img src="https://images2.imgbox.com/fa/df/RuqOcqL3_o.png" alt="在这里插入图片描述"><br> 比如25938函数,还是要把之前的入参改了,这样可以减少加密的轮数,确保只有一个分组.<br> <img src="https://images2.imgbox.com/c8/e1/QqSXWOiA_o.png" alt="在这里插入图片描述"><br> 确实是10轮,看下第一轮入参是什么,注意这个入参后面返回也是在这块地址,很典型的参数当返回值.<br> 入参<br> <img src="https://images2.imgbox.com/ad/ab/drIl6U6c_o.png" alt="在这里插入图片描述"><br> blr下临时断点到函数执行完的位置,直接查看之前那块内存就好了,注意是m0x404e3000,不是mx0,虽然这里可以,但是大部分都不行.<br> <img src="https://images2.imgbox.com/95/cd/HODLxcv4_o.png" alt="在这里插入图片描述"><br> 这样看不明显,排成矩阵看一下<br> <img src="https://images2.imgbox.com/fb/c6/XPtyqwOc_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/14/07/NbHhIAmH_o.png" alt="在这里插入图片描述"><br> 这不就是循环左移了,还是之前的那个问题,第一次第一次竟然是入参,我在某幸咖啡谈到过,这里不再说原因了.那篇也是白盒aes.那就很好办了,这个位置刚好10轮,直接dfa一下.</p> 
<pre><code class="prism language-java"> debugger<span class="token punctuation">.</span><span class="token function">addBreakPoint</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">.</span>base<span class="token operator">+</span><span class="token number">0x26cb8</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">BreakPointCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token class-name">RegisterContext</span> context <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token annotation punctuation">@Override</span>
 <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onHit</span><span class="token punctuation">(</span><span class="token class-name">Emulator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> emulator<span class="token punctuation">,</span> <span class="token keyword">long</span> address<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mem_read</span><span class="token punctuation">(</span><span class="token number">0x404e3000</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">StringBuilder</span> hexString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">byte</span> b <span class="token operator">:</span> bytes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 hexString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%02X"</span><span class="token punctuation">,</span> b <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aesResult:"</span><span class="token operator">+</span>hexString<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name">String</span> filename <span class="token operator">=</span> <span class="token string">"unidbg-android/src/test/java/com/ks/dfaAes.txt"</span><span class="token punctuation">;</span> <span class="token comment">// 文件名</span>
     <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
         <span class="token class-name">FileWriter</span> writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>hexString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入字符串</span>
         writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"写入文件时出现错误："</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callDfa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Debugger</span> debugger <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        debugger<span class="token punctuation">.</span><span class="token function">addBreakPoint</span><span class="token punctuation">(</span><span class="token keyword">module</span><span class="token punctuation">.</span>base<span class="token operator">+</span><span class="token number">0x25938</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">BreakPointCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">UnidbgPointer</span> pointer<span class="token punctuation">;</span>
            <span class="token class-name">RegisterContext</span> context <span class="token operator">=</span> emulator<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onHit</span><span class="token punctuation">(</span><span class="token class-name">Emulator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> emulator<span class="token punctuation">,</span> <span class="token keyword">long</span> address<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                pointer <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getPointerArg</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>num<span class="token operator">%</span><span class="token number">9</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    pointer<span class="token punctuation">.</span><span class="token function">setByte</span><span class="token punctuation">(</span><span class="token function">randint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token function">randint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                num<span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">randint</span><span class="token punctuation">(</span><span class="token keyword">int</span> min<span class="token punctuation">,</span><span class="token keyword">int</span> max<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Random</span> rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>max<span class="token operator">-</span>min<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>min<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre> 
<p>在函数结束位置把结果输出出来,调用200下后处结果.再用phoenixAES算出第10轮秘钥E8B900********************36B72,秘钥不公开,用aes_keyschedule算出主秘钥<br> <img src="https://images2.imgbox.com/de/87/hbpH9qit_o.png" alt="在这里插入图片描述"></p> 
<p>684559*******************A5476,验证一下结果是对的.</p> 
<h3><a id="hmacSha256_542"></a>hmacSha256</h3> 
<p>剩最后一个,假设我们没通过插件找到sha256痕迹<br> 回到上面的那20个字节加密数据,20个字节你想到了什么,sha256?常见的是这个.</p> 
<p><img src="https://images2.imgbox.com/5d/f7/BK0NUZRI_o.png" alt="在这里插入图片描述"><br> 上面我们说了259a0是比较早的一个入参时机,a2来自26a14,直接下断看下a2的地址,trace这块内存.<br> <img src="https://images2.imgbox.com/57/75/24JDHFws_o.png" alt="在这里插入图片描述"></p> 
<p>来自0x404d8580<br> emulator.traceWrite(0x404d8580,0x404d8580+0x20);<br> <img src="https://images2.imgbox.com/ed/4c/00n43qd5_o.png" alt="在这里插入图片描述"><br> 看下这个位置0x1e260<br> <img src="https://images2.imgbox.com/92/08/27RE6FyH_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/84/d9/0ffZEwN8_o.png" alt="在这里插入图片描述"><br> 参数3是入参,4是长度,2是个地址,存结果.blr后按c<br> <img src="https://images2.imgbox.com/42/9e/KUzCA5VG_o.png" alt="在这里插入图片描述"><br> 结束时有结果,试一下是不是标准sha256<br> <img src="https://images2.imgbox.com/59/ee/Z02sYFc7_o.png" alt="在这里插入图片描述"><br> 结果不一样,考虑3种情况<br> 1 有盐值<br> 2 hmac算法<br> 3 魔改<br> 先验证1<br> 明文16进制79 61 6e 67 72 75 68 75 61,按照sha256的处理先填充80 00一直带56字节,再添加8字节的附加消息长度(大端序,md5是小端序)<br> 在trace的文件中4个字节一组开始搜,0x61800000<br> <img src="https://images2.imgbox.com/b8/92/wtVDxV1b_o.png" alt="在这里插入图片描述"><br> 你要说巧合的话哪会有这么多,不信的话可以改下入参,让他填充到80的时候刚好4个字节.<br> 这样的话加盐的说法就不成立了.<br> 魔改暂时不考虑,只有所有的可能都被排除的情况下才会去考虑魔改,因为这种要是魔改的话肯定就不是简单的给你改改常量那样了.<br> 也就是说hmac?<br> 这个碰到的少,很多人不了解算法细节.<br> 我总结8个字就是两次加盐，两次哈希.hmac可以有很多哈希函数作为载体.md5,sha1,sha256,sha512,等等.<br> 我下面说的对所有的都通用<br> 1秘钥扩展:秘钥转hex后填充0达到分组长度,除了sha512是1024分组,其他都是512分组<br> 2秘钥异或0x36得到扩展秘钥1,为什么是0x36,这是固定的,没那么多为什么.<br> 3异或后的数据与明文(Message)级联:简单点就是扩展后的秘钥1拼接明文<br> 4 3得到的数据哈希<br> 5秘钥异或0x5c得到扩展秘钥2<br> 6 扩展秘钥2级联4哈希的结果<br> 7 对6的结果哈希就是最终结果.<br> 所以hmac的特征值就是0x36和0x5c,不过很疑惑,trace的文件中找不到与0x36和0x5c有关的信息,注意是没有任何,我怀疑秘钥是刚好64字节,否则填充后00异或至少还有一个0x36,我这不是空穴来风,我仔细查找了trace的结果中的可能是结果的位置,没有看到有异或0x36的,以及ida的伪代码中也没有出现0x36,那就是说这个秘钥是提前处理好过的.如果能找到某个函数传了64个字节的话就比较好办了,否则的话需要去分析伪代码,就有点复杂了.<br> 接着上面的伪代码分析<br> <img src="https://images2.imgbox.com/9f/81/qKB0HHkE_o.png" alt="在这里插入图片描述"><br> sub_219FC<br> <img src="https://images2.imgbox.com/bb/74/hX3gDcgm_o.png" alt="在这里插入图片描述"><br> 1000多行很可疑,看下入参<br> <img src="https://images2.imgbox.com/ee/22/77MOuoZj_o.png" alt="在这里插入图片描述"><br> 入参5比较可疑<br> <img src="https://images2.imgbox.com/e8/76/TaZ0ACml_o.png" alt="在这里插入图片描述"><br> 这里视乎是80个字节,有没有可能是两个异或后的扩展秘钥?<br> <img src="https://images2.imgbox.com/26/1e/ANoRKSPv_o.png" alt="在这里插入图片描述"><br> 看懂了吗,这不就是扩展后的秘钥,到此,所有参数分析完毕!!!</p> 
<h2><a id="_595"></a>总结</h2> 
<p>这篇如果写的详细一点的话至少可以写5篇,unidbg,trace技巧,crc32,白盒aes,hmacSha256,我写成一篇确实有点一口吃成大胖子的感觉.可能不太适合刚入行的朋友吗,不过这个作为国内数一数二的短视频加密难度还是很可以的,有基础的可以细细品味一下.<br> 链接:https://www.123pan.com/s/4O7Zjv-gM2Bd.html</p> 
<h2><a id="_598"></a>最后</h2> 
<p>微信公众号<br> <img src="https://images2.imgbox.com/eb/a8/ece4FWJH_o.jpg" alt="在这里插入图片描述"><br> 知识星球<br> <img src="https://images2.imgbox.com/16/5a/1Or2Cpcd_o.jpg" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f884457c2c1ea88f9aac0db0cb7d8a29/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数据可视化插件echarts【前端】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ee668324c5197960166fd5dac225cc9f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java 8（ jdk1.8u321）安装教程（超详细）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>