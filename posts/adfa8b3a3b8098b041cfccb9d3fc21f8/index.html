<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Nginx实现反向代理：详细配置与代码注释 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/adfa8b3a3b8098b041cfccb9d3fc21f8/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Nginx实现反向代理：详细配置与代码注释">
  <meta property="og:description" content="Nginx是一款高性能的HTTP和反向代理服务器，常用于负载均衡、缓存、SSL终止、静态内容服务以及作为应用程序的反向代理。本文将详细介绍如何使用Nginx实现反向代理功能，包括基本配置、高级特性以及示例代码和详尽注释，以帮助您全面理解和应用Nginx的反向代理能力。
一、反向代理概念 反向代理： 反向代理位于客户端和服务器之间，接收客户端的请求，然后根据配置规则将请求透明地转发到后端服务器，并将服务器的响应返回给客户端。客户端感知不到后端服务器的存在，仿佛所有请求都是直接与反向代理交互。
二、Nginx反向代理配置 Nginx的反向代理配置主要在nginx.conf或包含的子配置文件（如sites-enabled/*.conf）中进行。配置主要包括以下部分：
HTTP服务器块 (server): 定义监听的IP地址、端口以及与之关联的域名（server_name）。
位置块 (location): 根据请求URI进行匹配，并定义在此范围内应执行的操作，如反向代理。
反向代理指令 (proxy_pass): 指定请求应被转发到的后端服务器的URL。Nginx将替换匹配到的位置块中的URI，并将其发送到指定的后端服务器。
三、基本反向代理配置示例 Nginx
http { # 基本HTTP服务器配置 server { listen 80; # 监听端口 server_name example.com; # 绑定域名 # 匹配所有请求，将它们转发到后端服务器 location / { proxy_pass http://backend-server:8080; # 后端服务器地址与端口 proxy_set_header Host $host; # 保留原始Host头 proxy_set_header X-Real-IP $remote_addr; # 传递真实客户端IP proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; # 传递请求协议（http/https） # 其他可选配置，如缓存、超时、重试等 } } } 代码注释：
listen: 指定Nginx监听的IP地址和端口，这里为标准HTTP端口80。
server_name: 设置服务器块所关联的域名，即客户端请求的域名。
location /: 匹配所有以根路径（&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-20T11:55:40+08:00">
    <meta property="article:modified_time" content="2024-04-20T11:55:40+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Nginx实现反向代理：详细配置与代码注释</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>Nginx是一款高性能的HTTP和反向代理服务器，常用于负载均衡、缓存、SSL终止、静态内容服务以及作为应用程序的反向代理。本文将详细介绍如何使用Nginx实现反向代理功能，包括基本配置、高级特性以及示例代码和详尽注释，以帮助您全面理解和应用Nginx的反向代理能力。</p> 
<h4>一、反向代理概念</h4> 
<p><strong>反向代理</strong>： 反向代理位于客户端和服务器之间，接收客户端的请求，然后根据配置规则将请求透明地转发到后端服务器，并将服务器的响应返回给客户端。客户端感知不到后端服务器的存在，仿佛所有请求都是直接与反向代理交互。</p> 
<h4>二、Nginx反向代理配置</h4> 
<p>Nginx的反向代理配置主要在<code>nginx.conf</code>或包含的子配置文件（如<code>sites-enabled/*.conf</code>）中进行。配置主要包括以下部分：</p> 
<ol><li> <p><strong>HTTP服务器块</strong> (<code>server</code>): 定义监听的IP地址、端口以及与之关联的域名（<code>server_name</code>）。</p> </li><li> <p><strong>位置块</strong> (<code>location</code>): 根据请求URI进行匹配，并定义在此范围内应执行的操作，如反向代理。</p> </li><li> <p><strong>反向代理指令</strong> (<code>proxy_pass</code>): 指定请求应被转发到的后端服务器的URL。Nginx将替换匹配到的位置块中的URI，并将其发送到指定的后端服务器。</p> </li></ol> 
<h4>三、基本反向代理配置示例</h4> 
<pre></pre> 
<p>Nginx</p> 
<pre><code>http {
    # 基本HTTP服务器配置
    server {
        listen 80;                 # 监听端口
        server_name example.com;   # 绑定域名

        # 匹配所有请求，将它们转发到后端服务器
        location / {
            proxy_pass http://backend-server:8080;  # 后端服务器地址与端口
            proxy_set_header Host $host;             # 保留原始Host头
            proxy_set_header X-Real-IP $remote_addr; # 传递真实客户端IP
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;  # 传递请求协议（http/https）

            # 其他可选配置，如缓存、超时、重试等
        }
    }
}</code></pre> 
<p><strong>代码注释</strong>：</p> 
<ul><li> <p><code>listen</code>: 指定Nginx监听的IP地址和端口，这里为标准HTTP端口80。</p> </li><li> <p><code>server_name</code>: 设置服务器块所关联的域名，即客户端请求的域名。</p> </li><li> <p><code>location /</code>: 匹配所有以根路径（"/"）开头的请求。</p> </li><li> <p><code>proxy_pass</code>: 设置后端服务器的URL。此处将所有匹配到的请求转发到<code>http://backend-server:8080</code>。</p> </li><li> <p><code>proxy_set_header</code>: 设置请求转发时要修改或添加的HTTP头部。这些指令用于保持与后端服务器的正确交互，如：</p> 
  <ul><li><code>Host</code>: 保持原请求的Host头，确保后端服务器能够正确识别请求的目的主机。</li><li><code>X-Real-IP</code>: 传递真实的客户端IP地址，防止后端服务器因反向代理而获取到Nginx服务器的IP。</li><li><code>X-Forwarded-For</code>: 传递经过代理链的客户端IP列表，多个代理时会追加。</li><li><code>X-Forwarded-Proto</code>: 传递原始请求的协议（http或https），以便后端服务器识别请求是否经过SSL加密。</li></ul></li></ul> 
<h4>四、高级反向代理配置</h4> 
<h5>1. 负载均衡</h5> 
<p>Nginx可以配置多个后端服务器，并使用不同的负载均衡算法（如轮询、最少连接、IP哈希等）进行请求分发。</p> 
<pre></pre> 
<p>Nginx</p> 
<pre><code>upstream backend {
    server backend-server1:8080;
    server backend-server2:8080;
    # ... 更多后端服务器

    # 可选的负载均衡策略，如轮询（默认）
    # least_conn;  # 最少连接
    # ip_hash;     # IP哈希
}

server {
    ...
    location / {
        proxy_pass http://backend;  # 使用定义好的上游服务器组
        ...
    }
}</code></pre> 
<h5>2. URL重写与路由</h5> 
<p>使用<code>rewrite</code>指令可以对请求的URI进行修改，实现URL重写或路由功能。</p> 
<pre></pre> 
<p>Nginx</p> 
<pre><code>location / {
    rewrite ^/old-path(.*)$ /new-path$1 permanent;  # 永久重定向
    rewrite ^/api/v1/(.*)$ /api/v2/$1 break;       # 内部重写，保持反向代理路径不变
    proxy_pass http://backend;
}</code></pre> 
<h5>3. 缓存</h5> 
<p>通过<code>proxy_cache</code>模块，Nginx可以对后端服务器的响应进行缓存，提高响应速度和减少后端压力。</p> 
<pre></pre> 
<p>Nginx</p> 
<pre><code>http {
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m inactive=60m;

    server {
        ...
        location / {
            proxy_cache my_cache;
            proxy_cache_key "$scheme$request_method$host$request_uri";
            proxy_cache_valid 200 302 1h;
            proxy_cache_valid 404 1m;
            proxy_pass http://backend;
        }
    }
}</code></pre> 
<h5>4. 错误处理与健康检查</h5> 
<p>配置<code>proxy_next_upstream</code>指令处理后端服务器故障，以及使用<code>health_check</code>模块定期检查后端服务器健康状态。</p> 
<pre></pre> 
<p>Nginx</p> 
<pre><code>location / {
    proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
}

upstream backend {
    server backend-server1:8080;
    server backend-server2:8080;

    health_check uri=/health-check;
}</code></pre> 
<h4>五、HTTPS反向代理</h4> 
<p>要配置Nginx作为HTTPS反向代理，需要额外设置SSL证书和私钥，并可能需要调整HTTP头以适应HTTPS环境。</p> 
<pre></pre> 
<p>Nginx</p> 
<pre><code>server {
    listen 443 ssl;  # 监听HTTPS端口
    server_name example.com;
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;

    # 其他SSL配置项，如CA证书、密码、加密套件等...

    location / {
        proxy_pass http://backend;
        # 保持或调整与HTTPS相关的HTTP头
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
}</code></pre> 
<p>总结来说，Nginx通过灵活的配置选项提供了强大的反向代理功能。通过上述详细配置示例与注释，您可以根据实际需求定制Nginx反向代理策略，包括基本代理、负载均衡、URL重写、缓存、错误处理以及HTTPS支持。这些配置将帮助您构建高效、可靠且易于管理的Web服务架构。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1d8e132fe1d73e45b01e5ff3612adf5a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Anaconda 中更新当前环境的 Python 版本</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/801edd558287f15ad1d9e390dfa44683/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AI日报：最强大模型Llama 3发布；Midjourney推社交新功能Room；超强AI视频自动剪辑工具Captions；手机上可以玩大模型了</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>