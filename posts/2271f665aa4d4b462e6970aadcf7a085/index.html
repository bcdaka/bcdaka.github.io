<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flink CDC详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/2271f665aa4d4b462e6970aadcf7a085/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Flink CDC详解">
  <meta property="og:description" content="文章目录 Flink CDC一 CDC简介1.1 CDC定义1.2 CDC应用场景1.3 CDC实现机制1.4 开源CDC工具对比 二 Flink CDC简介2.1 Flink CDC介绍2.2 Flink CDC Connector(连接器)2.3 Flink CDC &amp;&amp; Flink版本2.4 Flink CDC特点 三 Flink CDC发展3.1 发展历程3.2 背景Dynamic Table &amp; ChangeLog Stream 3.3 传统 CDC ETL 分析3.4 基于 Flink CDC 的 ETL 分析Flink CDC 1.x痛点Flink CDC 2.0设计Flink CDC未来规划 四 Table &amp; SQL API应用五 DataStream API应用六 Flink CDC Connector6.1 MySQL CDC 连接器6.2 如何创建 MySQL CDC 表6.3 支持的元数据6.4 动态加表 七 Flink CDC案例一7.1 基于 Flink CDC 构建 MySQL 和 Postgres 的 Streaming ETL7.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-24T15:22:04+08:00">
    <meta property="article:modified_time" content="2024-04-24T15:22:04+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flink CDC详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#Flink_CDC_1" rel="nofollow">Flink CDC</a></li><li><ul><li><a href="#_CDC_3" rel="nofollow">一 CDC简介</a></li><li><ul><li><a href="#11_CDC_5" rel="nofollow">1.1 CDC定义</a></li><li><a href="#12_CDC_9" rel="nofollow">1.2 CDC应用场景</a></li><li><a href="#13_CDC_16" rel="nofollow">1.3 CDC实现机制</a></li><li><a href="#14_CDC_28" rel="nofollow">1.4 开源CDC工具对比</a></li></ul> 
     </li><li><a href="#_Flink_CDC_47" rel="nofollow">二 Flink CDC简介</a></li><li><ul><li><a href="#21_Flink_CDC_49" rel="nofollow">2.1 Flink CDC介绍</a></li><li><a href="#22_Flink_CDC_Connector_55" rel="nofollow">2.2 Flink CDC Connector(连接器)</a></li><li><a href="#23_Flink_CDC__Flink_68" rel="nofollow">2.3 Flink CDC &amp;&amp; Flink版本</a></li><li><a href="#24_Flink_CDC_84" rel="nofollow">2.4 Flink CDC特点</a></li></ul> 
     </li><li><a href="#_Flink_CDC_94" rel="nofollow">三 Flink CDC发展</a></li><li><ul><li><a href="#31__96" rel="nofollow">3.1 发展历程</a></li><li><a href="#32__118" rel="nofollow">3.2 背景</a></li><li><ul><li><a href="#Dynamic_Table__ChangeLog_Stream_120" rel="nofollow">Dynamic Table &amp; ChangeLog Stream</a></li></ul> 
      </li><li><a href="#33__CDC_ETL__144" rel="nofollow">3.3 传统 CDC ETL 分析</a></li><li><a href="#34__Flink_CDC__ETL__159" rel="nofollow">3.4 基于 Flink CDC 的 ETL 分析</a></li><li><ul><li><a href="#Flink_CDC_1x_178" rel="nofollow">Flink CDC 1.x痛点</a></li><li><a href="#Flink_CDC_20_190" rel="nofollow">Flink CDC 2.0设计</a></li><li><a href="#Flink_CDC_208" rel="nofollow">Flink CDC未来规划</a></li></ul> 
     </li></ul> 
     </li><li><a href="#_Table__SQL_API_232" rel="nofollow">四 Table &amp; SQL API应用</a></li><li><a href="#_DataStream_API_265" rel="nofollow">五 DataStream API应用</a></li><li><a href="#_Flink_CDC_Connector_314" rel="nofollow">六 Flink CDC Connector</a></li><li><ul><li><a href="#61_MySQL_CDC__326" rel="nofollow">6.1 MySQL CDC 连接器</a></li><li><a href="#62__MySQL_CDC__372" rel="nofollow">6.2 如何创建 MySQL CDC 表</a></li><li><a href="#63__424" rel="nofollow">6.3 支持的元数据</a></li><li><a href="#64__465" rel="nofollow">6.4 动态加表</a></li></ul> 
     </li><li><a href="#_Flink_CDC_531" rel="nofollow">七 Flink CDC案例一</a></li><li><ul><li><a href="#71__Flink_CDC__MySQL__Postgres__Streaming_ETL_533" rel="nofollow">7.1 基于 Flink CDC 构建 MySQL 和 Postgres 的 Streaming ETL</a></li><li><a href="#72__Flink_SQL_CLI__Flink_DDL__541" rel="nofollow">7.2 在 Flink SQL CLI 中使用 Flink DDL 创建表</a></li><li><a href="#73__Elasticsearch__631" rel="nofollow">7.3 关联订单数据并且将其写入 Elasticsearch 中</a></li></ul> 
     </li><li><a href="#_Flink_CDC_646" rel="nofollow">八 Flink CDC案例二</a></li><li><ul><li><a href="#81__Flink_CDC__MySQL__648" rel="nofollow">8.1 基于 Flink CDC 同步 MySQL 分库分表构建实时数据湖</a></li><li><a href="#82__660" rel="nofollow">8.2 准备教程所需要的组件</a></li><li><a href="#83__752" rel="nofollow">8.3 准备数据</a></li><li><a href="#84__Flink_SQL_CLI__Flink_DDL__808" rel="nofollow">8.4 在 Flink SQL CLI 中使用 Flink DDL 创建表</a></li><li><a href="#85__Iceberg_881" rel="nofollow">8.5 流式写入 Iceberg</a></li><li><a href="#86__948" rel="nofollow">8.6 环境清理</a></li></ul> 
     </li><li><a href="#_960" rel="nofollow">参考</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="Flink_CDC_1"></a>Flink CDC</h4> 
<h5><a id="_CDC_3"></a>一 CDC简介</h5> 
<h6><a id="11_CDC_5"></a>1.1 CDC定义</h6> 
<p>CDC 的全称是 Change Data Capture ，在广义的概念上，只要是能捕获数据变更的技术，我们都可以称之为 CDC 。目前通常描述的 CDC 技术主要面向数据库的变更，是一种用于捕获数据库中数据变更的技术。</p> 
<h6><a id="12_CDC_9"></a>1.2 CDC应用场景</h6> 
<ul><li> <p>**数据同步：**用于备份，容灾；</p> </li><li> <p>**数据分发：**一个数据源分发给多个下游系统；</p> </li><li> <p>**数据采集：**面向数据仓库 / 数据湖的 ETL 数据集成，是非常重要的数据源。</p> </li></ul> 
<h6><a id="13_CDC_16"></a>1.3 CDC实现机制</h6> 
<ul><li> <p>基于查询的 CDC机制：</p> 
  <ul><li>离线调度查询作业，批处理。把一张表同步到其他系统，每次通过查询去获取表中最新的数据；</li><li>无法保障数据一致性，查的过程中有可能数据已经发生了多次变更；</li><li>不保障实时性，基于离线调度存在天然的延迟。</li></ul> </li><li> <p>基于日志的 CDC机制：</p> 
  <ul><li>实时消费日志，流处理，例如 MySQL 的 binlog 日志完整记录了数据库中的变更，可以把 binlog 文件当作流的数据源；</li><li>保障数据一致性，因为 binlog 文件包含了所有历史变更明细；</li><li>保障实时性，因为类似 binlog 的日志文件是可以流式消费的，提供的是实时数据。</li></ul> </li></ul> 
<h6><a id="14_CDC_28"></a>1.4 开源CDC工具对比</h6> 
<p><img src="https://images2.imgbox.com/77/bd/LwPfVUb7_o.png" alt="图片"></p> 
<p>从上图可知：</p> 
<ul><li> <p>基于日志的CDC机制，除Canal都可以很好的做到增量同步。</p> </li><li> <p>基于查询的CDC机制，增量和断点几乎都不支持，除Sqoop支持增量方式。</p> </li><li> <p>从全量同步维度看，除Canal不支持全量同步，其它的CDC都支持。</p> </li><li> <p>从全量+增量角度看，基于日志方式的CDC都是支持的。</p> </li><li> <p>从架构角度去看，该表将架构分为单机和分布式，这里的分布式架构不单纯体现在数据读取能力的水平扩展上，更重要的是在大数据场景下分布式系统接入能力。例如 Flink CDC 的数据入湖或者入仓的时候，下游通常是分布式的系统，如 Hive、HDFS、Iceberg、Hudi 等，那么从对接入分布式系统能力上看，Flink CDC 的架构能够很好地接入此类系统。</p> </li><li> <p>在数据转换 / 数据清洗能力上，当数据进入到 CDC 工具的时候是否能较方便的对数据做一些过滤或者清洗，甚至聚合？</p> 
  <ul><li>在 Flink CDC 上操作相当简单，可以通过 Flink SQL 去操作这些数据；</li><li>像 DataX、Debezium 等则需要通过脚本或者模板去做，所以用户的使用门槛会比较高。</li></ul> </li><li> <p>在生态方面，这里指的是下游的一些数据库或者数据源的支持。Flink CDC 下游有丰富的 Connector，例如写入到 TiDB、MySQL、Pg、HBase、Kafka、ClickHouse 等常见的一些系统，也支持各种自定义 connector。</p> </li></ul> 
<h5><a id="_Flink_CDC_47"></a>二 Flink CDC简介</h5> 
<h6><a id="21_Flink_CDC_49"></a>2.1 Flink CDC介绍</h6> 
<p>Flink CDC本质是一组数据源连接器，使用<code>更改数据捕获(CDC)</code>从不同的数据库中摄取更改。Apache Flink®的CDC连接器集成了Debezium作为捕获数据更改的引擎，所以它可以充分利用Debezium的能力。</p> 
<p><img src="https://images2.imgbox.com/9a/7e/Awznb0hg_o.png" alt="image-20230411175634843"></p> 
<h6><a id="22_Flink_CDC_Connector_55"></a>2.2 Flink CDC Connector(连接器)</h6> 
<table><thead><tr><th>Connector</th><th>Database</th><th>Driver</th></tr></thead><tbody><tr><td><a href="https://ververica.github.io/flink-cdc-connectors/master/content/connectors/mongodb-cdc.html" rel="nofollow">mongodb-cdc</a></td><td><a href="https://www.mongodb.com/" rel="nofollow">MongoDB</a>: 3.6, 4.x, 5.0</td><td>MongoDB Driver: 4.3.1</td></tr><tr><td><a href="https://ververica.github.io/flink-cdc-connectors/master/content/connectors/mysql-cdc.html" rel="nofollow">mysql-cdc</a></td><td><a href="https://dev.mysql.com/doc" rel="nofollow">MySQL</a>: 5.6, 5.7, 8.0.x<a href="https://www.aliyun.com/product/rds/mysql" rel="nofollow">RDS MySQL</a>: 5.6, 5.7, 8.0.x<a href="https://www.aliyun.com/product/polardb" rel="nofollow">PolarDB MySQL</a>: 5.6, 5.7, 8.0.x<a href="https://aws.amazon.com/cn/rds/aurora" rel="nofollow">Aurora MySQL</a>: 5.6, 5.7, 8.0.x<a href="https://mariadb.org/" rel="nofollow">MariaDB</a>: 10.x<a href="https://github.com/ApsaraDB/galaxysql">PolarDB X</a>: 2.0.1</td><td>JDBC Driver: 8.0.27</td></tr><tr><td><a href="https://ververica.github.io/flink-cdc-connectors/master/content/connectors/oceanbase-cdc.html" rel="nofollow">oceanbase-cdc</a></td><td><a href="https://open.oceanbase.com/" rel="nofollow">OceanBase CE</a>: 3.1.x<a href="https://www.oceanbase.com/product/oceanbase" rel="nofollow">OceanBase EE</a> (MySQL mode): 2.x, 3.x</td><td>JDBC Driver: 5.1.4x</td></tr><tr><td><a href="https://ververica.github.io/flink-cdc-connectors/master/content/connectors/oracle-cdc.html" rel="nofollow">oracle-cdc</a></td><td><a href="https://www.oracle.com/index.html" rel="nofollow">Oracle</a>: 11, 12, 19</td><td>Oracle Driver: 19.3.0.0</td></tr><tr><td><a href="https://ververica.github.io/flink-cdc-connectors/master/content/connectors/postgres-cdc.html" rel="nofollow">postgres-cdc</a></td><td><a href="https://www.postgresql.org/" rel="nofollow">PostgreSQL</a>: 9.6, 10, 11, 12</td><td>JDBC Driver: 42.2.12</td></tr><tr><td><a href="https://ververica.github.io/flink-cdc-connectors/master/content/connectors/sqlserver-cdc.html" rel="nofollow">sqlserver-cdc</a></td><td><a href="https://www.microsoft.com/sql-server" rel="nofollow">Sqlserver</a>: 2012, 2014, 2016, 2017, 2019</td><td>JDBC Driver: 7.2.2.jre8</td></tr><tr><td><a href="https://ververica.github.io/flink-cdc-connectors/master/content/connectors/tidb-cdc.html" rel="nofollow">tidb-cdc</a></td><td><a href="https://www.pingcap.com/" rel="nofollow">TiDB</a>: 5.1.x, 5.2.x, 5.3.x, 5.4.x, 6.0.0</td><td>JDBC Driver: 8.0.27</td></tr><tr><td><a href="https://ververica.github.io/flink-cdc-connectors/master/content/connectors/db2-cdc.html" rel="nofollow">db2-cdc</a></td><td><a href="https://www.ibm.com/products/db2" rel="nofollow">Db2</a>: 11.5</td><td>DB2 Driver: 11.5.0.0</td></tr></tbody></table> 
<h6><a id="23_Flink_CDC__Flink_68"></a>2.3 Flink CDC &amp;&amp; Flink版本</h6> 
<p>Flink®CDC Connectors与Flink®的版本配套关系如下表所示:</p> 
<table><thead><tr><th>Flink® CDC Version</th><th>Flink® Version</th></tr></thead><tbody><tr><td>1.0.0</td><td>1.11.*</td></tr><tr><td>1.1.0</td><td>1.11.*</td></tr><tr><td>1.2.0</td><td>1.12.*</td></tr><tr><td>1.3.0</td><td>1.12.*</td></tr><tr><td>1.4.0</td><td>1.13.*</td></tr><tr><td><mark>2.0.*</mark></td><td>1.13.*</td></tr><tr><td>2.1.*</td><td>1.13.*</td></tr><tr><td>2.2.*</td><td>1.13.<em>, 1.14.</em></td></tr><tr><td>2.3.*</td><td>1.13.<em>, 1.14.</em>, 1.15.*, 1.16.0</td></tr></tbody></table> 
<h6><a id="24_Flink_CDC_84"></a>2.4 Flink CDC特点</h6> 
<ul><li> <p>支持读取数据库快照，即使发生故障，也可以只读取一次binlog。</p> </li><li> <p>CDC连接器用于DataStream API，用户可以在一个作业中对多个数据库和表进行更改，而无需部署Debezium和Kafka。</p> </li><li> <p>用于表/SQL API的CDC连接器，用户可以使用SQL DDL创建CDC源来监视单个表上的更改。</p> </li></ul> 
<h5><a id="_Flink_CDC_94"></a>三 Flink CDC发展</h5> 
<h6><a id="31__96"></a>3.1 发展历程</h6> 
<ul><li> <p>2020 年 7 月由云邪提交了第一个 commit，这是基于个人兴趣孵化的项目；</p> </li><li> <p>2020 年 7 中旬支持了 MySQL-CDC；</p> </li><li> <p>2020 年 7 月末支持了 Postgres-CDC；</p> </li><li> <p>2021年2月27，release-1.2.0发布，支持Flink version to 1.12.1，同时支持Debezium version to 1.4.1.Final版本。</p> </li><li> <p>2021年5月12，release-1.4.0发布，支持Flink version to 1.13.0。</p> </li><li> <p>2021年8月11，release-2.0.0发布，支持Flink version to 1.13.1，<mark>支持MySQL-CDC 2.0，提供并行读取，无锁和检查点功能。</mark></p> </li><li> <p>2021年11月15，release-2.1.0发布，新增MongoDB-CDC和Oracle-CDC，同时吸引一大堆贡献者。</p> </li><li> <p>2022年3月27，release-2.2.0发布，<mark>兼容Flink version to 1.14</mark>，同时新增TiDB-CDC，SQL-Server CDC，oceanbase CDC等。</p> </li><li> <p>2022年11月10，release-2.3.0发布，当前最新稳定版本。</p> </li></ul> 
<h6><a id="32__118"></a>3.2 背景</h6> 
<h6><a id="Dynamic_Table__ChangeLog_Stream_120"></a>Dynamic Table &amp; ChangeLog Stream</h6> 
<p>大家都知道 Flink 有两个基础概念：Dynamic Table 和 Changelog Stream。</p> 
<p><img src="https://images2.imgbox.com/66/33/ErXTeUCI_o.jpg" alt="img"></p> 
<ul><li>Dynamic Table 就是 Flink SQL 定义的动态表，动态表和流的概念是对等的。参照上图，流可以转换成动态表，动态表也可以转换成流。</li><li>在 Flink SQL中，数据在从一个算子流向另外一个算子时都是以 Changelog Stream 的形式，任意时刻的 Changelog Stream 可以翻译为一个表，也可以翻译为一个流。</li></ul> 
<p>联想下 MySQL 中的表和 binlog 日志，就会发现：MySQL 数据库的一张表所有的变更都记录在 binlog 日志中，如果一直对表进行更新，binlog 日志流也一直会追加，数据库中的表就相当于 binlog 日志流在某个时刻点物化的结果；日志流就是将表的变更数据持续捕获的结果。这说明 Flink SQL 的 Dynamic Table 是可以非常自然地表示一张不断变化的 MySQL 数据库表。</p> 
<p><img src="https://images2.imgbox.com/db/34/qeluvIkh_o.jpg" alt="图片"></p> 
<p>在此基础上，我们调研了一些 CDC 技术，最终选择了 Debezium 作为 Flink CDC 的底层采集工具。Debezium 支持全量同步，也支持增量同步，也支持全量 + 增量的同步，非常灵活，同时基于日志的 CDC 技术使得提供 Exactly-Once 成为可能。</p> 
<p>将 Flink SQL 的内部数据结构 RowData 和 Debezium 的数据结构进行对比，可以发现两者是非常相似的。</p> 
<ul><li>每条 RowData 都有一个元数据 RowKind，包括 4 种类型， 分别是插入 (INSERT)、更新前镜像 (UPDATE_BEFORE)、更新后镜像 (UPDATE_AFTER)、删除 (DELETE)，这四种类型和数据库里面的 binlog 概念保持一致。</li><li>而 Debezium 的数据结构，也有一个类似的元数据 op 字段， op 字段的取值也有四种，分别是 c、u、d、r，各自对应 create、update、delete、read。对于代表更新操作的 u，其数据部分同时包含了前镜像 (before) 和后镜像 (after)。</li></ul> 
<p>通过分析两种数据结构，Flink 和 Debezium 两者的底层数据是可以非常方便地对接起来的，大家可以发现 Flink 做 CDC 从技术上是非常合适的。</p> 
<h6><a id="33__CDC_ETL__144"></a>3.3 传统 CDC ETL 分析</h6> 
<p>我们来看下传统 CDC 的 ETL 分析链路，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/46/20/glAPCGqe_o.jpg" alt="图片"></p> 
<p>传统的基于 CDC 的 ETL 分析中，数据采集工具是必须的，国外用户常用 Debezium，国内用户常用阿里开源的 Canal，采集工具负责采集数据库的增量数据，一些采集工具也支持同步全量数据。采集到的数据一般输出到消息中间件如 Kafka，然后 Flink 计算引擎再去消费这一部分数据写入到目的端，目的端可以是各种 DB，数据湖，实时数仓和离线数仓。</p> 
<blockquote> 
 <p>注意</p> 
 <ul><li>Flink 提供了 changelog-json format，可以将 changelog 数据写入离线数仓如 Hive / HDFS；对于实时数仓，Flink 支持将 changelog 通过 upsert-kafka connector 直接写入 Kafka。</li><li>实时通常讲究效率，缩短链路通常是效率提升的一种方式，于是将上图中虚线框中的内容合二为一，则变成了Flink CDC的最佳实现。</li></ul> 
</blockquote> 
<h6><a id="34__Flink_CDC__ETL__159"></a>3.4 基于 Flink CDC 的 ETL 分析</h6> 
<p>在使用了 Flink CDC 之后，除了组件更少，维护更方便外，另一个优势是通过 Flink SQL 极大地降低了用户使用门槛，可以看下面的例子：</p> 
<p><img src="https://images2.imgbox.com/69/5b/zJxLRkMx_o.png" alt="图片"></p> 
<p>该例子是通过 Flink CDC 去同步数据库数据并写入到 TiDB，用户直接使用 Flink SQL 创建了产品和订单的 MySQL-CDC 表，然后对数据流进行 JOIN 加工，加工后直接写入到下游数据库。通过一个 Flink SQL 作业就完成了 CDC 的数据分析，加工和同步。</p> 
<p><img src="https://images2.imgbox.com/dc/7d/t8msxgE2_o.jpg" alt="图片"></p> 
<p>大家会发现这是一个纯 SQL 作业，这意味着只要会 SQL 的 BI，业务线同学都可以完成此类工作。与此同时，用户也可以利用 Flink SQL 提供的丰富语法进行数据清洗、分析、聚合。</p> 
<p><img src="https://images2.imgbox.com/62/f9/XWqJMjcE_o.jpg" alt="图片"></p> 
<p>此外，利用 Flink SQL 双流 JOIN、维表 JOIN、UDTF 语法可以非常容易地完成数据打宽，以及各种业务逻辑加工。</p> 
<h6><a id="Flink_CDC_1x_178"></a>Flink CDC 1.x痛点</h6> 
<ul><li> <p><code>全量 + 增量读取的过程需要保证所有数据的一致性</code>：因此需要通过加锁保证，但是加锁在数据库层面上是一个十分高危的操作。底层 Debezium 在保证数据一致性时，需要对读取的库或表加锁，全局锁可能导致数据库锁住，表级锁会锁住表的读，DBA 一般不给锁权限。</p> <p>Flink CDC 1.x 可以不加锁，能够满足大部分场景，但牺牲了一定的数据准确性。<code>Flink CDC 1.x 默认加全局锁，虽然能保证数据一致性，加锁的时间不确定，但存在上述 hang 住数据的风险</code>。</p> </li><li> <p><code>不支持水平扩展</code>：因为 Flink CDC 底层是基于 Debezium，起架构是单节点，所以Flink CDC 只支持单并发。在全量阶段读取阶段，如果表非常大 (亿级别)，读取时间在小时甚至天级别，用户不能通过增加资源去提升作业速度。</p> </li><li> <p><code>全量读取阶段不支持 checkpoint</code>：CDC 读取分为两个阶段，全量读取和增量读取，目前全量读取阶段是不支持 checkpoint 的，因此会存在一个问题：当我们同步全量数据时，假设需要 5 个小时，当我们同步了 4 小时的时候作业失败，这时候就需要重新开始，再读取 5 个小时。</p> </li></ul> 
<h6><a id="Flink_CDC_20_190"></a>Flink CDC 2.0设计</h6> 
<p>2.0 的设计方案，核心要解决上述的三个问题，即支持无锁、水平扩展和Checkpoint。</p> 
<p>这篇论文里描述的无锁算法如下图所示：</p> 
<p><img src="https://images2.imgbox.com/bb/db/s31SO0t9_o.jpg" alt="图片"></p> 
<p>左边是 Chunk 的切分算法描述，Chunk 的切分算法其实和很多数据库的分库分表原理类似，通过表的主键对表中的数据进行分片。假设每个 Chunk 的步长为 10，按照这个规则进行切分，只需要把这些 Chunk 的区间做成左开右闭或者左闭右开的区间，保证衔接后的区间能够等于表的主键区间即可。</p> 
<p>右边是每个 Chunk 的无锁读算法描述，该算法的核心思想是在划分了 Chunk 后，对于每个 Chunk 的全量读取和增量读取，在不用锁的条件下完成一致性的合并。Chunk 的切分如下图所示：</p> 
<p><img src="https://images2.imgbox.com/1b/0c/8bFjg7yP_o.jpg" alt="图片"></p> 
<p>因为每个 chunk 只负责自己主键范围内的数据，不难推导，只要能够保证每个 Chunk 读取的一致性，就能保证整张表读取的一致性，这便是无锁算法的基本原理。</p> 
<h6><a id="Flink_CDC_208"></a>Flink CDC未来规划</h6> 
<p><img src="https://images2.imgbox.com/fd/06/oj0Fsi8O_o.jpg" alt="图片"></p> 
<p>关于 CDC 项目的未来规划，我们希望围绕稳定性，进阶 feature 和生态集成三个方面展开。</p> 
<ul><li> <p>稳定性</p> 
  <ul><li>通过社区的方式吸引更多的开发者，公司的开源力量提升 Flink CDC 的成熟度；</li><li>支持 Lazy Assigning。Lazy Assigning 的思路是将 chunk 先划分一批，而不是一次性进行全部划分。当前 Source Reader 对数据读取进行分片是一次性全部划分好所有 chunk，例如有 1 万个 chunk，可以先划分 1 千个 chunk，而不是一次性全部划分，在 SourceReader 读取完 1 千 chunk 后再继续划分，节约划分 chunk 的时间。</li></ul> </li><li> <p>进阶 Feature</p> 
  <ul><li>支持 Schema Evolution。这个场景是：当同步数据库的过程中，突然在表中添加了一个字段，并且希望后续同步下游系统的时候能够自动加入这个字段；</li><li>支持 Watermark Pushdown 通过 CDC 的 binlog 获取到一些心跳信息，这些心跳的信息可以作为一个 Watermark，通过这个心跳信息可以知道到这个流当前消费的一些进度；</li><li>支持 META 数据，分库分表的场景下，有可能需要元数据知道这条数据来源哪个库哪个表，在下游系统入湖入仓可以有更多的灵活操作；</li><li>整库同步：用户要同步整个数据库只需一行 SQL 语法即可完成，而不用每张表定义一个 DDL 和 query。</li></ul> </li><li> <p>生态集成</p> 
  <ul><li>集成更多上游数据库，如 Oracle，MS SqlServer。Cloudera 目前正在积极贡献 oracle-cdc connector；</li><li>在入湖层面，Hudi 和 Iceberg 写入上有一定的优化空间，例如在高 QPS 入湖的时候，数据分布有比较大的性能影响，这一点可以通过与生态打通和集成继续优化。</li></ul> </li></ul> 
<h5><a id="_Table__SQL_API_232"></a>四 Table &amp; SQL API应用</h5> 
<p>使用提供的连接器设置Flink集群需要几个步骤。</p> 
<ol><li>使用1.12+版本和Java 8+安装Flink集群。</li><li>从下载页面下载连接器SQL jar(或者自己构建)。</li><li>将下载的jar放在FLINK_HOME/lib/目录下。</li><li>重新启动Flink集群。</li></ol> 
<p>这个例子展示了如何在Flink SQL Client中创建MySQL CDC源并对其执行查询。</p> 
<pre><code class="prism language-sql"><span class="token comment">-- creates a mysql cdc table source</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mysql_binlog <span class="token punctuation">(</span>
 id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
 name STRING<span class="token punctuation">,</span>
 description STRING<span class="token punctuation">,</span>
 weight <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
 <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'mysql-cdc'</span><span class="token punctuation">,</span>
 <span class="token string">'hostname'</span> <span class="token operator">=</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
 <span class="token string">'port'</span> <span class="token operator">=</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
 <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'flinkuser'</span><span class="token punctuation">,</span>
 <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'flinkpw'</span><span class="token punctuation">,</span>
 <span class="token string">'database-name'</span> <span class="token operator">=</span> <span class="token string">'inventory'</span><span class="token punctuation">,</span>
 <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'products'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- read snapshot and binlog data from mysql, and do some transformation, and show on the client</span>
<span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> UPPER<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> description<span class="token punctuation">,</span> weight <span class="token keyword">FROM</span> mysql_binlog<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_DataStream_API_265"></a>五 DataStream API应用</h5> 
<p>包括以下Maven依赖项(可通过Maven Central获得):</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.ververica<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- add the dependency matching your database --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-mysql-cdc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- The dependency is available only for stable releases, SNAPSHOT dependency need build by yourself. --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.4-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ververica<span class="token punctuation">.</span>cdc<span class="token punctuation">.</span>debezium<span class="token punctuation">.</span></span><span class="token class-name">JsonDebeziumDeserializationSchema</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ververica<span class="token punctuation">.</span>cdc<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>source<span class="token punctuation">.</span></span><span class="token class-name">MySqlSource</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySqlBinlogSourceExample</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">MySqlSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mySqlSource <span class="token operator">=</span> <span class="token class-name">MySqlSource</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">hostname</span><span class="token punctuation">(</span><span class="token string">"yourHostname"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span>yourPort<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">databaseList</span><span class="token punctuation">(</span><span class="token string">"yourDatabaseName"</span><span class="token punctuation">)</span> <span class="token comment">// set captured database</span>
            <span class="token punctuation">.</span><span class="token function">tableList</span><span class="token punctuation">(</span><span class="token string">"yourDatabaseName.yourTableName"</span><span class="token punctuation">)</span> <span class="token comment">// set captured table</span>
            <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token string">"yourUsername"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"yourPassword"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">deserializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JsonDebeziumDeserializationSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// converts SourceRecord to JSON String</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// enable checkpoint</span>
    env<span class="token punctuation">.</span><span class="token function">enableCheckpointing</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    env
      <span class="token punctuation">.</span><span class="token function">fromSource</span><span class="token punctuation">(</span>mySqlSource<span class="token punctuation">,</span> <span class="token class-name">WatermarkStrategy</span><span class="token punctuation">.</span><span class="token function">noWatermarks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MySQL Source"</span><span class="token punctuation">)</span>
      <span class="token comment">// set 4 parallel source tasks</span>
      <span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// use parallelism 1 for sink to keep message ordering</span>
    
    env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"Print MySQL Snapshot + Binlog"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_Flink_CDC_Connector_314"></a>六 Flink CDC Connector</h5> 
<ul><li> <p><a href="https://ververica.github.io/flink-cdc-connectors/master/content/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/mysql-postgres-tutorial-zh.html" rel="nofollow">基于 Flink CDC 构建 MySQL 和 Postgres 的 Streaming ETL</a></p> </li><li> <p><a href="https://ververica.github.io/flink-cdc-connectors/master/content/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/mongodb-tutorial-zh.html" rel="nofollow">演示: MongoDB CDC 导入 Elasticsearch</a></p> </li><li> <p><a href="https://ververica.github.io/flink-cdc-connectors/master/content/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/oceanbase-tutorial-zh.html" rel="nofollow">演示: OceanBase CDC 导入 Elasticsearch</a></p> </li><li> <p><a href="https://ververica.github.io/flink-cdc-connectors/master/content/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/oracle-tutorial-zh.html" rel="nofollow">演示: Oracle CDC 导入 Elasticsearch</a></p> </li><li> <p><a href="https://ververica.github.io/flink-cdc-connectors/master/content/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/polardbx-tutorial-zh.html" rel="nofollow">演示: PolarDB-X CDC 导入 Elasticsearch</a></p> </li><li> <p><a href="https://ververica.github.io/flink-cdc-connectors/master/content/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/sqlserver-tutorial-zh.html" rel="nofollow">演示: SqlServer CDC 导入 Elasticsearch</a></p> </li><li> <p><a href="https://ververica.github.io/flink-cdc-connectors/master/content/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/tidb-tutorial-zh.html" rel="nofollow">演示: TiDB CDC 导入 Elasticsearch</a></p> </li><li> <p><a href="https://ververica.github.io/flink-cdc-connectors/master/content/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/build-real-time-data-lake-tutorial-zh.html" rel="nofollow">基于 Flink CDC 同步 MySQL 分库分表构建实时数据湖</a></p> </li></ul> 
<h6><a id="61_MySQL_CDC__326"></a>6.1 MySQL CDC 连接器</h6> 
<p>MySQL CDC 连接器允许从 MySQL 数据库读取快照数据和增量数据。如下描述了如何设置 MySQL CDC 连接器来对 MySQL 数据库运行 SQL 查询。</p> 
<p><strong>支持的数据库</strong></p> 
<table><thead><tr><th>Connector</th><th>Database</th><th>Driver</th></tr></thead><tbody><tr><td><a href="https://ververica.github.io/flink-cdc-connectors/release-2.2/content/connectors/mysql-cdc%28ZH%29.html#" rel="nofollow">mysql-cdc</a></td><td><a href="https://dev.mysql.com/doc" rel="nofollow">MySQL</a>: 5.6, 5.7, 8.0.x<a href="https://www.aliyun.com/product/rds/mysql" rel="nofollow">RDS MySQL</a>: 5.6, 5.7, 8.0.x<a href="https://www.aliyun.com/product/polardb" rel="nofollow">PolarDB MySQL</a>: 5.6, 5.7, 8.0.x<a href="https://aws.amazon.com/cn/rds/aurora" rel="nofollow">Aurora MySQL</a>: 5.6, 5.7, 8.0.x<a href="https://mariadb.org/" rel="nofollow">MariaDB</a>: 10.x<a href="https://github.com/ApsaraDB/galaxysql">PolarDB X</a>: 2.0.1</td><td>JDBC Driver: 8.0.21</td></tr></tbody></table> 
<p>为了设置 MySQL CDC 连接器，下表提供了使用构建自动化工具（如 Maven 或 SBT ）和带有 SQL JAR 包的 SQL 客户端的两个项目的依赖关系信息。</p> 
<p><strong>Maven dependency</strong></p> 
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;com.ververica&lt;/groupId&gt;
  &lt;artifactId&gt;flink-connector-mysql-cdc&lt;/artifactId&gt;
  &lt;!-- 请使用已发布的版本依赖，snapshot版本的依赖需要本地自行编译。 --&gt;
  &lt;version&gt;2.2.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> 
<p><strong>SQL Client JAR</strong></p> 
<pre><code>下载链接仅在已发布版本可用，请在文档网站左下角选择浏览已发布的版本。
</code></pre> 
<p>下载 <a href="https://repo1.maven.org/maven2/com/ververica/flink-sql-connector-mysql-cdc/2.2.1/flink-sql-connector-mysql-cdc-2.2.1.jar" rel="nofollow">flink-sql-connector-mysql-cdc-2.2.1.jar</a> 到 <code>&lt;FLINK_HOME&gt;/lib/</code> 目录下。</p> 
<blockquote> 
 <p><strong>注意:</strong></p> 
 <p>flink-sql-connector-mysql-cdc-XXX-SNAPSHOT 版本是开发分支<code>release-XXX</code>对应的快照版本，快照版本用户需要下载源代码并编译相应的 jar。用户应使用已经发布的版本，例如 <a href="https://mvnrepository.com/artifact/com.ververica/flink-sql-connector-mysql-cdc" rel="nofollow">flink-sql-connector-mysql-cdc-2.2.1.jar</a> 当前已发布的所有版本都可以在 Maven 中央仓库获取。</p> 
</blockquote> 
<p><strong>为每个 Reader 设置不同的 Server id</strong></p> 
<p>每个用于读取 binlog 的 MySQL 数据库客户端都应该有一个唯一的 id，称为 Server id。 MySQL 服务器将使用此 id 来维护网络连接和 binlog 位置。 因此，如果不同的作业共享相同的 Server id， 则可能导致从错误的 binlog 位置读取数据。 因此，建议通过为每个 Reader 设置不同的 Server id <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.11/dev/table/sql/hints.html" rel="nofollow">SQL Hints</a>, 假设 Source 并行度为 4, 我们可以使用 <code>SELECT * FROM source_table /*+ OPTIONS('server-id'='5401-5404') */ ;</code> 来为 4 个 Source readers 中的每一个分配唯一的 Server id。</p> 
<p><strong>设置 MySQL 会话超时时间</strong></p> 
<p>当为大型数据库创建初始一致快照时，你建立的连接可能会在读取表时碰到超时问题。你可以通过在 MySQL 侧配置 interactive_timeout 和 wait_timeout 来缓解此类问题。</p> 
<ul><li><code>interactive_timeout</code>: 服务器在关闭交互连接之前等待活动的秒数。 更多信息请参考 <a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_interactive_timeout" rel="nofollow">MySQL documentations</a>.</li><li><code>wait_timeout</code>: 服务器在关闭非交互连接之前等待活动的秒数。 更多信息请参考 <a href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_wait_timeout" rel="nofollow">MySQL documentations</a>.</li></ul> 
<h6><a id="62__MySQL_CDC__372"></a>6.2 如何创建 MySQL CDC 表</h6> 
<pre><code class="prism language-sh"><span class="token comment">#	启动flink集群</span>
start-cluster.sh
<span class="token comment"># 启动flink sql客户端</span>
sql-client.sh
</code></pre> 
<p>MySQL中表结构定义：</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>orders<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>order_date<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>customer_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>product_id<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>order_status<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>order_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_0900_ai_ci<span class="token punctuation">;</span>
</code></pre> 
<p>MySQL CDC 表可以定义如下：</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 每 3 秒做一次 checkpoint，用于测试，生产配置建议5到10分钟                      </span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">SET</span> <span class="token string">'execution.checkpointing.interval'</span> <span class="token operator">=</span> <span class="token string">'3s'</span><span class="token punctuation">;</span>   
<span class="token comment">-- 在 Flink SQL中注册 MySQL 表 'orders'</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orders <span class="token punctuation">(</span>
     order_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
     order_date <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     customer_name STRING<span class="token punctuation">,</span>
     price <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     product_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
     order_status <span class="token keyword">BOOLEAN</span><span class="token punctuation">,</span>
     <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>order_id<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
     <span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
     <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'mysql-cdc'</span><span class="token punctuation">,</span>
     <span class="token string">'hostname'</span> <span class="token operator">=</span> <span class="token string">'qianfeng01'</span><span class="token punctuation">,</span>
     <span class="token string">'port'</span> <span class="token operator">=</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
     <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
     <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
     <span class="token string">'database-name'</span> <span class="token operator">=</span> <span class="token string">'mydb'</span><span class="token punctuation">,</span>
     <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'orders'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token comment">-- 从订单表读取全量数据(快照)和增量数据(binlog)</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> orders<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="63__424"></a>6.3 支持的元数据</h6> 
<p>下表中的元数据可以在 DDL 中作为只读（虚拟）meta 列声明。</p> 
<table><thead><tr><th>Key</th><th>DataType</th><th>Description</th></tr></thead><tbody><tr><td>table_name</td><td>STRING NOT NULL</td><td>当前记录所属的表名称。</td></tr><tr><td>database_name</td><td>STRING NOT NULL</td><td>当前记录所属的库名称。</td></tr><tr><td>op_ts</td><td>TIMESTAMP_LTZ(3) NOT NULL</td><td>当前记录表在数据库中更新的时间。 如果从表的快照而不是 binlog 读取记录，该值将始终为0。</td></tr></tbody></table> 
<p>下述创建表示例展示元数据列的用法：</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 在 Flink SQL中注册 MySQL 表 'products'</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> products <span class="token punctuation">(</span>
    db_name STRING METADATA <span class="token keyword">FROM</span> <span class="token string">'database_name'</span> VIRTUAL<span class="token punctuation">,</span>
    table_name STRING METADATA  <span class="token keyword">FROM</span> <span class="token string">'table_name'</span> VIRTUAL<span class="token punctuation">,</span>
    operation_ts TIMESTAMP_LTZ<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> METADATA <span class="token keyword">FROM</span> <span class="token string">'op_ts'</span> VIRTUAL<span class="token punctuation">,</span>
    order_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
    order_date <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    customer_name STRING<span class="token punctuation">,</span>
    price <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    product_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
    order_status <span class="token keyword">BOOLEAN</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>order_id<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'mysql-cdc'</span><span class="token punctuation">,</span>
    <span class="token string">'hostname'</span> <span class="token operator">=</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    <span class="token string">'port'</span> <span class="token operator">=</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
    <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
    <span class="token string">'database-name'</span> <span class="token operator">=</span> <span class="token string">'mydb'</span><span class="token punctuation">,</span>
    <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'orders'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 订单状态实时分布</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">select</span> order_status<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>order_id<span class="token punctuation">)</span> <span class="token keyword">from</span> products <span class="token keyword">group</span> <span class="token keyword">by</span> order_status<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="64__465"></a>6.4 动态加表</h6> 
<p>扫描新添加的表功能使你可以添加新表到正在运行的作业中，新添加的表将首先读取其快照数据，然后自动读取其变更日志。</p> 
<p>想象一下这个场景：一开始， Flink 作业监控表 <code>[product, user, address]</code>, 但几天后，我们希望这个作业还可以监控表 <code>[order, custom]</code>，这些表包含历史数据，我们需要作业仍然可以复用作业的已有状态，动态加表功能可以优雅地解决此问题。</p> 
<p>以下操作显示了如何启用此功能来解决上述场景。 使用现有的 Flink CDC Source 作业，如下：</p> 
<pre><code class="prism language-java">    <span class="token class-name">MySqlSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mySqlSource <span class="token operator">=</span> <span class="token class-name">MySqlSource</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">hostname</span><span class="token punctuation">(</span><span class="token string">"yourHostname"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span>yourPort<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">scanNewlyAddedTableEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 启用扫描新添加的表功能</span>
        <span class="token punctuation">.</span><span class="token function">databaseList</span><span class="token punctuation">(</span><span class="token string">"db"</span><span class="token punctuation">)</span> <span class="token comment">// 设置捕获的数据库</span>
        <span class="token punctuation">.</span><span class="token function">tableList</span><span class="token punctuation">(</span><span class="token string">"db.product, db.user, db.address"</span><span class="token punctuation">)</span> <span class="token comment">// 设置捕获的表 [product, user, address]</span>
        <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token string">"yourUsername"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"yourPassword"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">deserializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JsonDebeziumDeserializationSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 将 SourceRecord 转换为 JSON 字符串</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 你的业务代码</span>
</code></pre> 
<p>如果我们想添加新表 <code>[order, custom]</code> 对于现有的 Flink 作业，只需更新 <code>tableList()</code> 将新增表 <code>[order, custom]</code> 加入并从已有的 savepoint 恢复作业。</p> 
<p><em>Step 1</em>: 使用 savepoint 停止现有的 Flink 作业。</p> 
<pre><code class="prism language-sh">$ ./bin/flink stop <span class="token variable">$Existing_Flink_JOB_ID</span>
Suspending job <span class="token string">"cca7bc1061d61cf15238e92312c2fc20"</span> with a savepoint.
Savepoint completed. Path: file:/tmp/flink-savepoints/savepoint-cca7bc-bb1e257f0dab
</code></pre> 
<p><em>Step 2</em>: 更新现有 Flink 作业的表列表选项。</p> 
<ol><li>更新 <code>tableList()</code> 参数.</li><li>编译更新后的作业，示例如下：</li></ol> 
<pre><code class="prism language-java">    <span class="token class-name">MySqlSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> mySqlSource <span class="token operator">=</span> <span class="token class-name">MySqlSource</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">hostname</span><span class="token punctuation">(</span><span class="token string">"yourHostname"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span>yourPort<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">scanNewlyAddedTableEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> 
        <span class="token punctuation">.</span><span class="token function">databaseList</span><span class="token punctuation">(</span><span class="token string">"db"</span><span class="token punctuation">)</span> 
        <span class="token punctuation">.</span><span class="token function">tableList</span><span class="token punctuation">(</span><span class="token string">"db.product, db.user, db.address, db.order, db.custom"</span><span class="token punctuation">)</span> <span class="token comment">// 设置捕获的表 [product, user, address ,order, custom]</span>
        <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token string">"yourUsername"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"yourPassword"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">deserializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JsonDebeziumDeserializationSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 将 SourceRecord 转换为 JSON 字符串</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 你的业务代码</span>
</code></pre> 
<p><em>Step 3</em>: 从 savepoint 还原更新后的 Flink 作业。</p> 
<pre><code class="prism language-sh">$ ./bin/flink run <span class="token punctuation">\</span>
      <span class="token parameter variable">--detached</span> <span class="token punctuation">\</span> 
      <span class="token parameter variable">--fromSavepoint</span> /tmp/flink-savepoints/savepoint-cca7bc-bb1e257f0dab <span class="token punctuation">\</span>
      ./FlinkCDCExample.jar
</code></pre> 
<h5><a id="_Flink_CDC_531"></a>七 Flink CDC案例一</h5> 
<h6><a id="71__Flink_CDC__MySQL__Postgres__Streaming_ETL_533"></a>7.1 基于 Flink CDC 构建 MySQL 和 Postgres 的 Streaming ETL</h6> 
<p>这篇教程将展示如何基于 Flink CDC 快速构建 MySQL 和 Postgres 的流式 ETL。本教程的演示都将在 Flink SQL CLI 中进行，只涉及 SQL，无需一行 Java/Scala 代码，也无需安装 IDE。</p> 
<p>假设我们正在经营电子商务业务，商品和订单的数据存储在 MySQL 中，订单对应的物流信息存储在 Postgres 中。 对于订单表，为了方便进行分析，我们希望让它关联上其对应的商品和物流信息，构成一张宽表，并且实时把它写到 ElasticSearch 中。</p> 
<p>接下来的内容将介绍如何使用 Flink Mysql/Postgres CDC 来实现这个需求，系统的整体架构如下图所示： <img src="https://images2.imgbox.com/7b/0d/qFYaTxnF_o.png" alt="Flink CDC Streaming ETL"></p> 
<h6><a id="72__Flink_SQL_CLI__Flink_DDL__541"></a>7.2 在 Flink SQL CLI 中使用 Flink DDL 创建表</h6> 
<p>首先，开启 checkpoint，每隔3秒做一次 checkpoint</p> 
<pre><code class="prism language-sql"><span class="token comment">-- Flink SQL                   </span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">SET</span> execution<span class="token punctuation">.</span>checkpointing<span class="token punctuation">.</span><span class="token keyword">interval</span> <span class="token operator">=</span> <span class="token number">3</span>s<span class="token punctuation">;</span>
</code></pre> 
<p>然后, 对于数据库中的表 <code>products</code>, <code>orders</code>, <code>shipments</code>， 使用 Flink SQL CLI 创建对应的表，用于同步这些底层数据库表的数据</p> 
<pre><code class="prism language-sql"><span class="token comment">-- Flink SQL</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> products <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span><span class="token punctuation">,</span>
    name STRING<span class="token punctuation">,</span>
    description STRING<span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
  <span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'mysql-cdc'</span><span class="token punctuation">,</span>
    <span class="token string">'hostname'</span> <span class="token operator">=</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    <span class="token string">'port'</span> <span class="token operator">=</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
    <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
    <span class="token string">'database-name'</span> <span class="token operator">=</span> <span class="token string">'mydb'</span><span class="token punctuation">,</span>
    <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'products'</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> orders <span class="token punctuation">(</span>
   order_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
   order_date <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   customer_name STRING<span class="token punctuation">,</span>
   price <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   product_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
   order_status <span class="token keyword">BOOLEAN</span><span class="token punctuation">,</span>
   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>order_id<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
 <span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
   <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'mysql-cdc'</span><span class="token punctuation">,</span>
   <span class="token string">'hostname'</span> <span class="token operator">=</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
   <span class="token string">'port'</span> <span class="token operator">=</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
   <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
   <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
   <span class="token string">'database-name'</span> <span class="token operator">=</span> <span class="token string">'mydb'</span><span class="token punctuation">,</span>
   <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'orders'</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>

Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> shipments <span class="token punctuation">(</span>
   shipment_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
   order_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
   origin STRING<span class="token punctuation">,</span>
   destination STRING<span class="token punctuation">,</span>
   is_arrived <span class="token keyword">BOOLEAN</span><span class="token punctuation">,</span>
   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>shipment_id<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
 <span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
   <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'postgres-cdc'</span><span class="token punctuation">,</span>
   <span class="token string">'hostname'</span> <span class="token operator">=</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
   <span class="token string">'port'</span> <span class="token operator">=</span> <span class="token string">'5432'</span><span class="token punctuation">,</span>
   <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'postgres'</span><span class="token punctuation">,</span>
   <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'postgres'</span><span class="token punctuation">,</span>
   <span class="token string">'database-name'</span> <span class="token operator">=</span> <span class="token string">'postgres'</span><span class="token punctuation">,</span>
   <span class="token string">'schema-name'</span> <span class="token operator">=</span> <span class="token string">'public'</span><span class="token punctuation">,</span>
   <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'shipments'</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>最后，创建 <code>enriched_orders</code> 表， 用来将关联后的订单数据写入 Elasticsearch 中</p> 
<pre><code class="prism language-sql"><span class="token comment">-- Flink SQL</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> enriched_orders <span class="token punctuation">(</span>
   order_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
   order_date <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   customer_name STRING<span class="token punctuation">,</span>
   price <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   product_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
   order_status <span class="token keyword">BOOLEAN</span><span class="token punctuation">,</span>
   product_name STRING<span class="token punctuation">,</span>
   product_description STRING<span class="token punctuation">,</span>
   shipment_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
   origin STRING<span class="token punctuation">,</span>
   destination STRING<span class="token punctuation">,</span>
   is_arrived <span class="token keyword">BOOLEAN</span><span class="token punctuation">,</span>
   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>order_id<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
 <span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
     <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'elasticsearch-7'</span><span class="token punctuation">,</span>
     <span class="token string">'hosts'</span> <span class="token operator">=</span> <span class="token string">'http://localhost:9200'</span><span class="token punctuation">,</span>
     <span class="token string">'index'</span> <span class="token operator">=</span> <span class="token string">'enriched_orders'</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="73__Elasticsearch__631"></a>7.3 关联订单数据并且将其写入 Elasticsearch 中</h6> 
<p>使用 Flink SQL 将订单表 <code>order</code> 与 商品表 <code>products</code>，物流信息表 <code>shipments</code> 关联，并将关联后的订单信息写入 Elasticsearch 中</p> 
<pre><code class="prism language-sql"><span class="token comment">-- Flink SQL</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> enriched_orders
 <span class="token keyword">SELECT</span> o<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> p<span class="token punctuation">.</span>description<span class="token punctuation">,</span> s<span class="token punctuation">.</span>shipment_id<span class="token punctuation">,</span> s<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> s<span class="token punctuation">.</span>destination<span class="token punctuation">,</span> s<span class="token punctuation">.</span>is_arrived
 <span class="token keyword">FROM</span> orders <span class="token keyword">AS</span> o
 <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> products <span class="token keyword">AS</span> p <span class="token keyword">ON</span> o<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>id
 <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> shipments <span class="token keyword">AS</span> s <span class="token keyword">ON</span> o<span class="token punctuation">.</span>order_id <span class="token operator">=</span> s<span class="token punctuation">.</span>order_id<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="_Flink_CDC_646"></a>八 Flink CDC案例二</h5> 
<h6><a id="81__Flink_CDC__MySQL__648"></a>8.1 基于 Flink CDC 同步 MySQL 分库分表构建实时数据湖</h6> 
<p>在 OLTP 系统中，为了解决单表数据量大的问题，通常采用分库分表的方式将单个大表进行拆分以提高系统的吞吐量。 但是为了方便数据分析，通常需要将分库分表拆分出的表在同步到数据仓库、数据湖时，再合并成一个大表。</p> 
<p>这篇教程将展示如何使用 Flink CDC 构建实时数据湖来应对这种场景，本教程的演示基于 Docker，只涉及 SQL，无需一行 Java/Scala 代码，也无需安装 IDE，你可以很方便地在自己的电脑上完成本教程的全部内容。</p> 
<p>接下来将以数据从 MySQL 同步到 <a href="https://iceberg.apache.org/" rel="nofollow">Iceberg</a> 为例展示整个流程，架构图如下所示：</p> 
<p><img src="https://images2.imgbox.com/ef/ef/L1Phx59v_o.png" alt="image-20230607220414588"></p> 
<p>你也可以使用不同的 source 比如 Oracle/Postgres 和 sink 比如 Hudi 来构建自己的 ETL 流程。</p> 
<h6><a id="82__660"></a>8.2 准备教程所需要的组件</h6> 
<p>接下来的教程将以 <code>docker-compose</code> 的方式准备所需要的组件。</p> 
<p>使用下面的内容创建一个 <code>docker-compose.yml</code> 文件：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">sql-client</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> flink<span class="token punctuation">:</span>flink
    <span class="token key atrule">image</span><span class="token punctuation">:</span> yuxialuo/flink<span class="token punctuation">-</span>sql<span class="token punctuation">-</span>client<span class="token punctuation">:</span>1.13.2.v1 
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> jobmanager
      <span class="token punctuation">-</span> mysql
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">FLINK_JOBMANAGER_HOST</span><span class="token punctuation">:</span> jobmanager
      <span class="token key atrule">MYSQL_HOST</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> shared<span class="token punctuation">-</span>tmpfs<span class="token punctuation">:</span>/tmp/iceberg
  <span class="token key atrule">jobmanager</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> flink<span class="token punctuation">:</span>flink
    <span class="token key atrule">image</span><span class="token punctuation">:</span> flink<span class="token punctuation">:</span>1.13.2<span class="token punctuation">-</span>scala_2.11
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"8081:8081"</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> jobmanager
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> shared<span class="token punctuation">-</span>tmpfs<span class="token punctuation">:</span>/tmp/iceberg
  <span class="token key atrule">taskmanager</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> flink<span class="token punctuation">:</span>flink
    <span class="token key atrule">image</span><span class="token punctuation">:</span> flink<span class="token punctuation">:</span>1.13.2<span class="token punctuation">-</span>scala_2.11
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> jobmanager
    <span class="token key atrule">command</span><span class="token punctuation">:</span> taskmanager
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 2</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> shared<span class="token punctuation">-</span>tmpfs<span class="token punctuation">:</span>/tmp/iceberg
  <span class="token key atrule">mysql</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> debezium/example<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span><span class="token number">1.1</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"3306:3306"</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> MYSQL_ROOT_PASSWORD=123456
      <span class="token punctuation">-</span> MYSQL_USER=mysqluser
      <span class="token punctuation">-</span> MYSQL_PASSWORD=mysqlpw

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">shared-tmpfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> local
    <span class="token key atrule">driver_opts</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"tmpfs"</span>
      <span class="token key atrule">device</span><span class="token punctuation">:</span> <span class="token string">"tmpfs"</span>
</code></pre> 
<p>该 Docker Compose 中包含的容器有：</p> 
<ul><li>SQL-Client: Flink SQL Client, 用来提交 SQL 查询和查看 SQL 的执行结果</li><li>Flink Cluster：包含 Flink JobManager 和 Flink TaskManager，用来执行 Flink SQL</li><li>MySQL：作为分库分表的数据源，存储本教程的 <code>user</code> 表</li></ul> 
<p><em><strong>注意：</strong></em></p> 
<ol><li> <p>为了简化整个教程，本教程需要的 jar 包都已经被打包进 SQL-Client 容器中了，镜像的构建脚本可以在 <a href="https://github.com/luoyuxia/flink-cdc-tutorial/tree/main/flink-cdc-iceberg-demo/sql-client">GitHub</a> 上找到。 如果你想要在自己的 Flink 环境运行本教程，需要下载下面列出的包并且把它们放在 Flink 所在目录的 lib 目录下，即 <code>FLINK_HOME/lib/</code>。</p> <p><strong>下载链接只对已发布的版本有效, SNAPSHOT 版本需要本地编译</strong></p> 
  <ul><li><a href="https://repo1.maven.org/maven2/com/ververica/flink-sql-connector-mysql-cdc/2.2.0/flink-sql-connector-mysql-cdc-2.2.0.jar" rel="nofollow">flink-sql-connector-mysql-cdc-2.2.0.jar</a></li><li><a href="https://repo.maven.apache.org/maven2/org/apache/flink/flink-shaded-hadoop-2-uber/2.7.5-10.0/flink-shaded-hadoop-2-uber-2.7.5-10.0.jar" rel="nofollow">flink-shaded-hadoop-2-uber-2.7.5-10.0.jar</a></li><li><a href="https://raw.githubusercontent.com/luoyuxia/flink-cdc-tutorial/main/flink-cdc-iceberg-demo/sql-client/lib/iceberg-flink-1.13-runtime-0.13.0-SNAPSHOT.jar" rel="nofollow">iceberg-flink-1.13-runtime-0.13.0-SNAPSHOT.jar</a></li></ul> <p>目前支持 Flink 1.13 的 <code>iceberg-flink-runtime</code> jar 包还没有发布，所以我们在这里提供了一个支持 Flink 1.13 的 <code>iceberg-flink-runtime</code> jar 包，这个 jar 包是基于 Iceberg 的 master 分支打包的。 当 Iceberg 0.13.0 版本发布后，你也可以在 <a href="https://repo.maven.apache.org/maven2/org/apache/iceberg/iceberg-flink-runtime/" rel="nofollow">apache official repository</a> 下载到支持 Flink 1.13 的 <code>iceberg-flink-runtime</code> jar 包。</p> </li><li> <p>本教程接下来用到的容器相关的命令都需要在 <code>docker-compose.yml</code> 所在目录下执行</p> </li></ol> 
<p>在 <code>docker-compose.yml</code> 所在目录下执行下面的命令来启动本教程需要的组件：</p> 
<pre><code>docker-compose up -d
</code></pre> 
<p>该命令将以 detached 模式自动启动 Docker Compose 配置中定义的所有容器。你可以通过 <code>docker ps</code> 来观察上述的容器是否正常启动了，也可以通过访问 <a href="http://localhost:8081//" rel="nofollow">http://localhost:8081/</a> 来查看 Flink 是否运行正常。</p> 
<p><img src="https://images2.imgbox.com/0a/e8/CyrwsJOT_o.png" alt="image-20230609103715578"></p> 
<h6><a id="83__752"></a>8.3 准备数据</h6> 
<ol><li> <p>进入 MySQL 容器中</p> <pre><code>docker-compose exec mysql mysql -uroot -p123456
</code></pre> </li><li> <p>创建数据和表，并填充数据</p> <p>创建两个不同的数据库，并在每个数据库中创建两个表，作为 <code>user</code> 表分库分表下拆分出的表。</p> <pre><code class="prism language-sql"> <span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db_1<span class="token punctuation">;</span>
 <span class="token keyword">USE</span> db_1<span class="token punctuation">;</span>
 <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_1 <span class="token punctuation">(</span>
   id <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
   name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'flink'</span><span class="token punctuation">,</span>
   address <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   phone_number <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_1 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token string">"user_110"</span><span class="token punctuation">,</span><span class="token string">"Shanghai"</span><span class="token punctuation">,</span><span class="token string">"123567891234"</span><span class="token punctuation">,</span><span class="token string">"user_110@foo.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_2 <span class="token punctuation">(</span>
   id <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
   name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'flink'</span><span class="token punctuation">,</span>
   address <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   phone_number <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_2 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token string">"user_120"</span><span class="token punctuation">,</span><span class="token string">"Shanghai"</span><span class="token punctuation">,</span><span class="token string">"123567891234"</span><span class="token punctuation">,</span><span class="token string">"user_120@foo.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> db_2<span class="token punctuation">;</span>
<span class="token keyword">USE</span> db_2<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_1 <span class="token punctuation">(</span>
  id <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'flink'</span><span class="token punctuation">,</span>
  address <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  phone_number <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_1 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token string">"user_110"</span><span class="token punctuation">,</span><span class="token string">"Shanghai"</span><span class="token punctuation">,</span><span class="token string">"123567891234"</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_2 <span class="token punctuation">(</span>
  id <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
  name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'flink'</span><span class="token punctuation">,</span>
  address <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  phone_number <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> user_2 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">220</span><span class="token punctuation">,</span><span class="token string">"user_220"</span><span class="token punctuation">,</span><span class="token string">"Shanghai"</span><span class="token punctuation">,</span><span class="token string">"123567891234"</span><span class="token punctuation">,</span><span class="token string">"user_220@foo.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li></ol> 
<h6><a id="84__Flink_SQL_CLI__Flink_DDL__808"></a>8.4 在 Flink SQL CLI 中使用 Flink DDL 创建表</h6> 
<p>首先，使用如下的命令进入 Flink SQL CLI 容器中：</p> 
<pre><code class="prism language-sh"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> sql-client ./sql-client
</code></pre> 
<p>我们可以看到如下界面：</p> 
<p><img src="https://images2.imgbox.com/78/84/u2iDmHfb_o.png" alt="image-20230609104142018"></p> 
<p>然后，进行如下步骤：</p> 
<ol><li> <p>开启 checkpoint，每隔3秒做一次 checkpoint</p> <p>Checkpoint 默认是不开启的，我们需要开启 Checkpoint 来让 Iceberg 可以提交事务。 并且，mysql-cdc 在 binlog 读取阶段开始前，需要等待一个完整的 checkpoint 来避免 binlog 记录乱序的情况。</p> <pre><code class="prism language-sql"><span class="token comment">-- Flink SQL                   </span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">SET</span> execution<span class="token punctuation">.</span>checkpointing<span class="token punctuation">.</span><span class="token keyword">interval</span> <span class="token operator">=</span> <span class="token number">3</span>s<span class="token punctuation">;</span>
</code></pre> </li><li> <p>创建 MySQL 分库分表 source 表</p> <p>创建 source 表 <code>user_source</code> 来捕获MySQL中所有 <code>user</code> 表的数据，在表的配置项 <code>database-name</code> , <code>table-name</code> 使用正则表达式来匹配这些表。 并且，<code>user_source</code> 表也定义了 metadata 列来区分数据是来自哪个数据库和表。</p> <pre><code class="prism language-sql"><span class="token comment">-- Flink SQL</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_source <span class="token punctuation">(</span>
    database_name STRING METADATA VIRTUAL<span class="token punctuation">,</span>
    table_name STRING METADATA VIRTUAL<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    name STRING<span class="token punctuation">,</span>
    address STRING<span class="token punctuation">,</span>
    phone_number STRING<span class="token punctuation">,</span>
    email STRING<span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
  <span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'mysql-cdc'</span><span class="token punctuation">,</span>
    <span class="token string">'hostname'</span> <span class="token operator">=</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
    <span class="token string">'port'</span> <span class="token operator">=</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
    <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
    <span class="token string">'database-name'</span> <span class="token operator">=</span> <span class="token string">'db_[0-9]+'</span><span class="token punctuation">,</span>
    <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'user_[0-9]+'</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>创建 Iceberg sink 表</p> <p>创建 sink 表 <code>all_users_sink</code>，用来将数据加载至 Iceberg 中。 在这个 sink 表，考虑到不同的 MySQL 数据库表的 <code>id</code> 字段的值可能相同，我们定义了复合主键 (<code>database_name</code>, <code>table_name</code>, <code>id</code>)。</p> <pre><code class="prism language-sql"><span class="token comment">-- Flink SQL</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> all_users_sink <span class="token punctuation">(</span>
    database_name STRING<span class="token punctuation">,</span>
    table_name    STRING<span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span>          <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    name          STRING<span class="token punctuation">,</span>
    address       STRING<span class="token punctuation">,</span>
    phone_number  STRING<span class="token punctuation">,</span>
    email         STRING<span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>database_name<span class="token punctuation">,</span> table_name<span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
  <span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector'</span><span class="token operator">=</span><span class="token string">'iceberg'</span><span class="token punctuation">,</span>
    <span class="token string">'catalog-name'</span><span class="token operator">=</span><span class="token string">'iceberg_catalog'</span><span class="token punctuation">,</span>
    <span class="token string">'catalog-type'</span><span class="token operator">=</span><span class="token string">'hadoop'</span><span class="token punctuation">,</span>  
    <span class="token string">'warehouse'</span><span class="token operator">=</span><span class="token string">'file:///tmp/iceberg/warehouse'</span><span class="token punctuation">,</span>
    <span class="token string">'format-version'</span><span class="token operator">=</span><span class="token string">'2'</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li></ol> 
<h6><a id="85__Iceberg_881"></a>8.5 流式写入 Iceberg</h6> 
<ol><li> <p>使用下面的 Flink SQL 语句将数据从 MySQL 写入 Iceberg 中</p> <pre><code class="prism language-sql"><span class="token comment">-- Flink SQL</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> all_users_sink <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_source<span class="token punctuation">;</span>
</code></pre> <p>上述命令将会启动一个流式作业，源源不断将 MySQL 数据库中的全量和增量数据同步到 Iceberg 中。 在 <a href="http://localhost:8081/#/job/running" rel="nofollow">Flink UI</a> 上可以看到这个运行的作业：</p> <p><img src="https://images2.imgbox.com/a6/65/Z4oeEVdE_o.png" alt="image-20230609104414829"></p> <p>然后我们就可以使用如下的命令看到 Iceberg 中的写入的文件：</p> <pre><code class="prism language-sh"><span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> sql-client tree /tmp/iceberg/warehouse/default_database/
</code></pre> <p>如下所示：</p> <p><img src="https://images2.imgbox.com/cb/09/qg7Kzafe_o.png" alt="image-20230609104555552"></p> <p>在你的运行环境中，实际的文件可能与上面的截图不相同，但是整体的目录结构应该相似。</p> </li><li> <p>使用下面的 Flink SQL 语句查询表 <code>all_users_sink</code> 中的数据</p> <pre><code class="prism language-sql"><span class="token comment">-- Flink SQL</span>
Flink <span class="token keyword">SQL</span><span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> all_users_sink<span class="token punctuation">;</span>
</code></pre> <p>在 Flink SQL CLI 中我们可以看到如下查询结果：</p> <p><img src="https://images2.imgbox.com/8e/d1/13wIyvcG_o.png" alt="image-20230609104650340"></p> </li><li> <p>修改 MySQL 中表的数据，Iceberg 中的表 <code>all_users_sink</code> 中的数据也将实时更新：</p> <p>(3.1) 在 <code>db_1.user_1</code> 表中插入新的一行</p> <pre><code class="prism language-sql"><span class="token comment">--- db_1</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> db_1<span class="token punctuation">.</span>user_1 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">,</span><span class="token string">"user_111"</span><span class="token punctuation">,</span><span class="token string">"Shanghai"</span><span class="token punctuation">,</span><span class="token string">"123567891234"</span><span class="token punctuation">,</span><span class="token string">"user_111@foo.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <p>(3.2) 更新 <code>db_1.user_2</code> 表的数据</p> <pre><code class="prism language-sql"><span class="token comment">--- db_1</span>
<span class="token keyword">UPDATE</span> db_1<span class="token punctuation">.</span>user_2 <span class="token keyword">SET</span> address<span class="token operator">=</span><span class="token string">'Beijing'</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">;</span>
</code></pre> <p>(3.3) 在 <code>db_2.user_2</code> 表中删除一行</p> <pre><code class="prism language-sql"><span class="token comment">--- db_2</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> db_2<span class="token punctuation">.</span>user_2 <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">220</span><span class="token punctuation">;</span>
</code></pre> <p>每执行一步，我们就可以在 Flink Client CLI 中使用 <code>SELECT * FROM all_users_sink</code> 查询表 <code>all_users_sink</code> 来看到数据的变化。</p> <p>最后的查询结果如下所示：</p> <p><img src="https://images2.imgbox.com/b1/0c/hIXyddmS_o.png" alt="image-20230609105124489"></p> <p>从 Iceberg 的最新结果中可以看到新增了<code>(db_1, user_1, 111)</code>的记录，<code>(db_1, user_2, 120)</code>的地址更新成了 <code>Beijing</code>，且<code>(db_2, user_2, 220)</code>的记录被删除了，与我们在 MySQL 做的数据更新完全一致。</p> </li></ol> 
<h6><a id="86__948"></a>8.6 环境清理</h6> 
<p>本教程结束后，在 <code>docker-compose.yml</code> 文件所在的目录下执行如下命令停止所有容器：</p> 
<pre><code class="prism language-sh"><span class="token function">docker-compose</span> down
</code></pre> 
<h5><a id="_960"></a>参考</h5> 
<p>阿里云云栖号：https://baijiahao.baidu.com/s?id=1708018647118048692&amp;wfr=spider&amp;for=pc</p> 
<p>Flink CDC官网：https://ververica.github.io/flink-cdc-connectors/release-2.2/content/about.html</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/41ee9e34d59127ccb5a9f7e4037bbbb8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">js的includes函数</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/74597ab69cb940c35c5172651ef952a3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何在Android Studio中创建Flutter项目</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>