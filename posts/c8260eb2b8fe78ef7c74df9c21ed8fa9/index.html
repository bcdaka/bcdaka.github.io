<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Redisson 分布式限流器 RRateLimiter 的使用及原理 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/c8260eb2b8fe78ef7c74df9c21ed8fa9/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Redisson 分布式限流器 RRateLimiter 的使用及原理">
  <meta property="og:description" content="文章目录 一、基本使用1.1 创建限流器1.2 获取令牌1.3 使用示例 二、实现原理 一、基本使用 1.1 创建限流器 /** * Returns rate limiter instance by name * * @param name of rate limiter * @return RateLimiter object */ RRateLimiter getRateLimiter(String name); /** * Initializes RateLimiter&#39;s state and stores config to Redis server. * * @param mode - rate mode * @param rate - rate * @param rateInterval - rate time interval * @param rateIntervalUnit - rate time interval unit * @return true if rate was set and false otherwise */ boolean trySetRate(RateType mode, long rate, long rateInterval, RateIntervalUnit rateIntervalUnit); trySetRate 用于设置限流参数。其中 RateType 包含 OVERALL 和 PER_CLIENT 两个枚举常量，分别表示全局限流和单机限流。后面三个参数表明了令牌的生成速率，即每 rateInterval 生成 rate 个令牌，rateIntervalUnit 为 rateInterval 的时间单位。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-16T21:12:45+08:00">
    <meta property="article:modified_time" content="2024-01-16T21:12:45+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Redisson 分布式限流器 RRateLimiter 的使用及原理</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_5" rel="nofollow">一、基本使用</a></li><li><ul><li><a href="#11__7" rel="nofollow">1.1 创建限流器</a></li><li><a href="#12__34" rel="nofollow">1.2 获取令牌</a></li><li><a href="#13__77" rel="nofollow">1.3 使用示例</a></li></ul> 
  </li><li><a href="#_124" rel="nofollow">二、实现原理</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_5"></a>一、基本使用</h2> 
<h3><a id="11__7"></a>1.1 创建限流器</h3> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Returns rate limiter instance by name
 * 
 * @param name of rate limiter
 * @return RateLimiter object
 */</span>
<span class="token class-name">RRateLimiter</span> <span class="token function">getRateLimiter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Initializes RateLimiter's state and stores config to Redis server.
 * 
 * @param mode - rate mode
 * @param rate - rate
 * @param rateInterval - rate time interval
 * @param rateIntervalUnit - rate time interval unit
 * @return true if rate was set and false otherwise
 */</span>
<span class="token keyword">boolean</span> <span class="token function">trySetRate</span><span class="token punctuation">(</span><span class="token class-name">RateType</span> mode<span class="token punctuation">,</span> <span class="token keyword">long</span> rate<span class="token punctuation">,</span> <span class="token keyword">long</span> rateInterval<span class="token punctuation">,</span> <span class="token class-name">RateIntervalUnit</span> rateIntervalUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>trySetRate</code> 用于设置限流参数。其中 RateType 包含 <code>OVERALL</code> 和 <code>PER_CLIENT</code> 两个枚举常量，分别表示全局限流和单机限流。后面三个参数表明了令牌的生成速率，即每 <code>rateInterval</code> 生成 <code>rate</code> 个令牌，<code>rateIntervalUnit</code> 为 <code>rateInterval</code> 的时间单位。</p> 
<h3><a id="12__34"></a>1.2 获取令牌</h3> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Acquires a specified permits from this RateLimiter, 
 * blocking until one is available.
 *
 * Acquires the given number of permits, if they are available 
 * and returns immediately, reducing the number of available permits 
 * by the given amount.
 * 
 * @param permits the number of permits to acquire
 */</span>
<span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">permits</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Acquires the given number of permits only if all are available
 * within the given waiting time.
 *
 * Acquires the given number of permits, if all are available and returns immediately,
 * with the value true, reducing the number of available permits by one.
 *
 * If no permit is available then the current thread becomes
 * disabled for thread scheduling purposes and lies dormant until
 * the specified waiting time elapses.
 *
 * If a permits is acquired then the value true is returned.
 *
 * If the specified waiting time elapses then the value false
 * is returned.  If the time is less than or equal to zero, the method
 * will not wait at all.
 *
 * @param permits amount
 * @param timeout the maximum time to wait for a permit
 * @param unit the time unit of the timeout argument
 * @return true if a permit was acquired and false
 *         if the waiting time elapsed before a permit was acquired
 */</span>
<span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">permits</span><span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>acquire</code> 和 <code>tryAcquire</code> 均可用于获取指定数量的令牌，不过 <code>acquire</code> 会阻塞等待，而 <code>tryAcquire</code> 会等待 <code>timeout</code> 时间，如果仍然没有获得指定数量的令牌直接返回 <code>false</code>。</p> 
<h3><a id="13__77"></a>1.3 使用示例</h3> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">RateLimiterTest</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedissonClient</span> redissonClient<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> threadCount <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RRateLimiter</span> rateLimiter <span class="token operator">=</span> redissonClient<span class="token punctuation">.</span><span class="token function">getRateLimiter</span><span class="token punctuation">(</span><span class="token string">"my_limiter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rateLimiter<span class="token punctuation">.</span><span class="token function">trySetRate</span><span class="token punctuation">(</span><span class="token class-name">RateType</span><span class="token punctuation">.</span><span class="token constant">OVERALL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">RateIntervalUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>threadCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> threadCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                rateLimiter<span class="token punctuation">.</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"latch count {}"</span><span class="token punctuation">,</span> latch<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">27</span> <span class="token constant">INFO</span>  <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">atreus<span class="token punctuation">.</span>ink<span class="token punctuation">.</span>rate<span class="token punctuation">.</span></span>RateLimiterTest</span> <span class="token operator">:</span> latch count <span class="token number">9</span>
<span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">27</span> <span class="token constant">INFO</span>  <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">atreus<span class="token punctuation">.</span>ink<span class="token punctuation">.</span>rate<span class="token punctuation">.</span></span>RateLimiterTest</span> <span class="token operator">:</span> latch count <span class="token number">8</span>
<span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">28</span> <span class="token constant">INFO</span>  <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">atreus<span class="token punctuation">.</span>ink<span class="token punctuation">.</span>rate<span class="token punctuation">.</span></span>RateLimiterTest</span> <span class="token operator">:</span> latch count <span class="token number">7</span>
<span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">29</span> <span class="token constant">INFO</span>  <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">atreus<span class="token punctuation">.</span>ink<span class="token punctuation">.</span>rate<span class="token punctuation">.</span></span>RateLimiterTest</span> <span class="token operator">:</span> latch count <span class="token number">6</span>
<span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">29</span> <span class="token constant">INFO</span>  <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">atreus<span class="token punctuation">.</span>ink<span class="token punctuation">.</span>rate<span class="token punctuation">.</span></span>RateLimiterTest</span> <span class="token operator">:</span> latch count <span class="token number">5</span>
<span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">30</span> <span class="token constant">INFO</span>  <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">atreus<span class="token punctuation">.</span>ink<span class="token punctuation">.</span>rate<span class="token punctuation">.</span></span>RateLimiterTest</span> <span class="token operator">:</span> latch count <span class="token number">4</span>
<span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">30</span> <span class="token constant">INFO</span>  <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">atreus<span class="token punctuation">.</span>ink<span class="token punctuation">.</span>rate<span class="token punctuation">.</span></span>RateLimiterTest</span> <span class="token operator">:</span> latch count <span class="token number">3</span>
<span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">30</span> <span class="token constant">INFO</span>  <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">atreus<span class="token punctuation">.</span>ink<span class="token punctuation">.</span>rate<span class="token punctuation">.</span></span>RateLimiterTest</span> <span class="token operator">:</span> latch count <span class="token number">2</span>
<span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">30</span> <span class="token constant">INFO</span>  <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">atreus<span class="token punctuation">.</span>ink<span class="token punctuation">.</span>rate<span class="token punctuation">.</span></span>RateLimiterTest</span> <span class="token operator">:</span> latch count <span class="token number">1</span>
<span class="token number">2024</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">16</span> <span class="token number">20</span><span class="token operator">:</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">30</span> <span class="token constant">INFO</span>  <span class="token punctuation">[</span><span class="token class-name">Thread</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token class-name"><span class="token namespace">atreus<span class="token punctuation">.</span>ink<span class="token punctuation">.</span>rate<span class="token punctuation">.</span></span>RateLimiterTest</span> <span class="token operator">:</span> latch count <span class="token number">0</span>
</code></pre> 
<hr> 
<h2><a id="_124"></a>二、实现原理</h2> 
<p>Redisson 的 RRateLimiter 基于令牌桶实现，令牌桶的主要特点如下：</p> 
<ul><li>令牌以固定速率生成。</li><li>生成的令牌放入令牌桶中存放，如果令牌桶满了则多余的令牌会直接丢弃，当请求到达时，会尝试从令牌桶中取令牌，取到了令牌的请求可以执行。</li><li>如果桶空了，那么尝试取令牌的请求会被直接丢弃。</li></ul> 
<p>RRateLimiter 在创建限流器时通过下面 Lua 脚本设置限流器的相关参数：</p> 
<pre><code class="prism language-lua">redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hsetnx'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'rate'</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hsetnx'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'interval'</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hsetnx'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>而获取令牌则是通过以下的 Lua 脚本实现：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 请求参数示例</span>
<span class="token comment">-- KEYS[1] my_limiter</span>
<span class="token comment">-- KEYS[2] {my_limiter}:value</span>
<span class="token comment">-- KEYS[4] {my_limiter}:permits</span>
<span class="token comment">-- ARGV[1] 3 本次请求的令牌数</span>
<span class="token comment">-- ARGV[2] 1705396021850 System.currentTimeMillis()</span>
<span class="token comment">-- ARGV[3] 6966135962453115904 ThreadLocalRandom.current().nextLong()</span>

<span class="token comment">-- 读取 RRateLimiter.trySetRate 中配置的限流器信息</span>
<span class="token keyword">local</span> rate <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hget'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'rate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">-- 10 一个时间窗口内产生的令牌数</span>
<span class="token keyword">local</span> interval <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hget'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'interval'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">-- 1000 一个时间窗口对应的毫秒数</span>
<span class="token keyword">local</span> type <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hget'</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">-- 0 全局限流</span>
<span class="token function">assert</span><span class="token punctuation">(</span>rate <span class="token operator">~=</span> <span class="token keyword">false</span> <span class="token keyword">and</span> interval <span class="token operator">~=</span> <span class="token keyword">false</span> <span class="token keyword">and</span> type <span class="token operator">~=</span> <span class="token keyword">false</span><span class="token punctuation">,</span> <span class="token string">'RateLimiter is not initialized'</span><span class="token punctuation">)</span>

<span class="token keyword">local</span> valueName <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">-- {my_limiter}:value 当前可用令牌数字符串的 key</span>
<span class="token keyword">local</span> permitsName <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">-- {my_limiter}:permits 授权记录有序集合的 key</span>

<span class="token comment">-- 单机限流配置 无需考虑</span>
<span class="token keyword">if</span> type <span class="token operator">==</span> <span class="token string">'1'</span> <span class="token keyword">then</span>
    valueName <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    permitsName <span class="token operator">=</span> KEYS<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询当前可用的令牌数 查询失败表明是首次请求令牌</span>
<span class="token keyword">local</span> currentValue <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> valueName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> currentValue <span class="token operator">==</span> <span class="token keyword">false</span> <span class="token keyword">then</span> <span class="token comment">-- 首次请求令牌</span>
    <span class="token comment">-- 单次请求的令牌数不能超过一个时间窗口内产生的令牌数</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>rate<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'Requested permits amount could not exceed defined rate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">-- 更新当前可用令牌数以及令牌授权记录 {my_limiter}:permits</span>
    <span class="token comment">-- set {my_limiter}:permits 10</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span> valueName<span class="token punctuation">,</span> rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">-- zadd {my_limiter}:permits 1705396021850 6966135962453115904_1</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'zadd'</span><span class="token punctuation">,</span> permitsName<span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> struct<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'fI'</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">-- decrby {my_limiter}:permits 3</span>
    redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'decrby'</span><span class="token punctuation">,</span> valueName<span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> <span class="token comment">-- 再次请求令牌</span>
    <span class="token comment">-- 查询可以回收的令牌对应的授权记录 即一个时间窗口前的所有授权记录且包括一个时间窗口前这一时刻</span>
    <span class="token comment">-- 旧令牌回收的本质是新令牌的加入 如果一个令牌是在一个时间窗口前被分配的 那经过一个时间窗口后这个空出的位置应该已经由新令牌填充</span>
    <span class="token comment">-- zrangebyscore {my_limiter}:permits 0 1705396020850</span>
    <span class="token keyword">local</span> expiredValues <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'zrangebyscore'</span><span class="token punctuation">,</span> permitsName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- [1936135962853113704_2, 536135765023123704_5]</span>
    
    <span class="token comment">-- 统计可以回收的令牌数</span>
    <span class="token keyword">local</span> released <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>expiredValues<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token keyword">local</span> random<span class="token punctuation">,</span> permits <span class="token operator">=</span> struct<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'fI'</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">-- released = released + 2</span>
        <span class="token comment">-- released = released + 5</span>
        released <span class="token operator">=</span> released <span class="token operator">+</span> permits<span class="token punctuation">;</span>
    <span class="token keyword">end</span><span class="token punctuation">;</span>

    <span class="token comment">-- 删除授权记录并回收令牌</span>
    <span class="token keyword">if</span> released <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
        <span class="token comment">-- zrem {my_limiter}:permits 1936135962853113704_2 536135765023123704_5</span>
        redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'zrem'</span><span class="token punctuation">,</span> permitsName<span class="token punctuation">,</span> <span class="token function">unpack</span><span class="token punctuation">(</span>expiredValues<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentValue <span class="token operator">=</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>currentValue<span class="token punctuation">)</span> <span class="token operator">+</span> released<span class="token punctuation">;</span>
        <span class="token comment">-- incrby {my_limiter}:value 7</span>
        redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'set'</span><span class="token punctuation">,</span> valueName<span class="token punctuation">,</span> currentValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>currentValue<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
        <span class="token comment">-- 如果回收后可用令牌数仍然不足 返回需要等待的时间</span>
        <span class="token comment">-- zrangebyscore {my_limiter}:permits (1705396020850 1705396021850 withscores limit 0 1</span>
        <span class="token keyword">local</span> nearest <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'zrangebyscore'</span><span class="token punctuation">,</span> permitsName<span class="token punctuation">,</span> <span class="token string">'('</span> <span class="token operator">..</span> <span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> interval<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'withscores'</span><span class="token punctuation">,</span> <span class="token string">'limit'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">local</span> random<span class="token punctuation">,</span> permits <span class="token operator">=</span> struct<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string">'fI'</span><span class="token punctuation">,</span> nearest<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">-- 1705396021650 - 1705396021850 + 1000 = 800</span>
        <span class="token keyword">return</span> <span class="token function">tonumber</span><span class="token punctuation">(</span>nearest<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token function">tonumber</span><span class="token punctuation">(</span>ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        
        redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'zadd'</span><span class="token punctuation">,</span> permitsName<span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> struct<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token string">'fI'</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'decrby'</span><span class="token punctuation">,</span> valueName<span class="token punctuation">,</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre> 
<hr> 
<p>参考：</p> 
<p><a href="https://github.com/oneone1995/blog/issues/13">https://github.com/oneone1995/blog/issues/13</a><br> <a href="https://www.infoq.cn/article/Qg2tX8fyw5Vt-f3HH673" rel="nofollow">https://www.infoq.cn/article/Qg2tX8fyw5Vt-f3HH673</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1ca97a3dd4af10f260f4b76f55efcca8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">大数据基础-测试过程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/51a91c85280bd0ec1f71bdc43c7677ed/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[ PyQt入门教程 ] Qt Designer工具的使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>