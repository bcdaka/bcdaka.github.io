<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Elasticsearch：从 ES|QL 到 PHP 对象 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/a5c9cfb12ddb2d77507ac359da22acbb/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Elasticsearch：从 ES|QL 到 PHP 对象">
  <meta property="og:description" content="作者：来自 Elastic Enrico Zimuel
从 elasticsearch-php v8.13.0 开始，你可以执行 ES|QL 查询并将结果映射到 stdClass 或自定义类的 PHP 对象。
ES|QL ES|QL 是 Elasticsearch 8.11.0 中引入的一种新的 Elasticsearch 查询语言。 目前，它在技术预览版中可用。 它提供了一种强大的方法来过滤、转换和分析存储在 Elasticsearch 中的数据。
它利用 “管道” (|) 逐步操作和转换数据。 这种方法允许用户组合一系列操作，其中一个操作的输出成为下一个操作的输入，从而实现复杂的数据转换和分析。
例如，以下查询返回 sample_data 索引的前 3 个文档（行）：
FROM sample_data | LIMIT 3 使用案例 为了说明官方 PHP 客户端中开发的 ES|QL 功能，我们在 Elasticsearch 中存储了包含 81,828 本书 (54.4 MB) 的 CSV 文件，其中包括以下信息：
Title;Descrition;Author;Year;Publisher;Ratings 我们从公开的亚马逊图书评论数据集中提取了此列表。
我们使用以下 Elasticsearch 映射创建了一个 books 索引：
&#39;mappings&#39; : { &#39;properties&#39;: { &#39;title&#39;: { &#39;type&#39;: &#39;text&#39; }, &#39;description&#39;: { &#39;type&#39;: &#39;text&#39; }, &#39;author&#39;: { &#39;type&#39;: &#39;text&#39; }, &#39;year&#39;: { &#39;type&#39;: &#39;short&#39; }, &#39;publisher&#39;: { &#39;type&#39;: &#39;keyword&#39; }, &#39;rating&#39;: { &#39;type&#39;: &#39;half_float&#39; } } } rating 值是从 2.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-11T19:03:00+08:00">
    <meta property="article:modified_time" content="2024-04-11T19:03:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Elasticsearch：从 ES|QL 到 PHP 对象</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>作者：来自 Elastic <a href="https://www.elastic.co/search-labs/author/enrico-zimuel" rel="nofollow" title="Enrico Zimuel">Enrico Zimuel</a></p> 
<p>从 elasticsearch-php <a class="link-info" href="https://github.com/elastic/elasticsearch-php/releases/tag/v8.13.0" title="v8.13.0">v8.13.0</a> 开始，你可以执行 <a class="link-info" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/esql.html" rel="nofollow" title="ES|QL">ES|QL</a> 查询并将结果映射到 <a class="link-info" href="https://www.php.net/manual/en/class.stdclass.php" rel="nofollow" title="stdClass">stdClass</a> 或自定义类的 PHP 对象。</p> 
<p></p> 
<h2>ES|QL</h2> 
<p>ES|QL 是 Elasticsearch 8.11.0 中引入的一种新的 Elasticsearch 查询语言。 目前，它在技术预览版中可用。 它提供了一种强大的方法来过滤、转换和分析存储在 Elasticsearch 中的数据。</p> 
<p>它利用 “管道” (|) 逐步操作和转换数据。 这种方法允许用户组合一系列操作，其中一个操作的输出成为下一个操作的输入，从而实现复杂的数据转换和分析。</p> 
<p>例如，以下查询返回 sample_data 索引的前 3 个文档（行）：</p> 
<pre><code>FROM sample_data
| LIMIT 3</code></pre> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/05/22/hRPRfOmL_o.png"></p> 
<p></p> 
<h2>使用案例</h2> 
<p>为了说明官方 PHP 客户端中开发的 ES|QL 功能，我们在 Elasticsearch 中存储了包含 81,828 本书 (54.4 MB) 的 <a class="link-info" href="https://github.com/elastic/elasticsearch-php-examples/blob/main/examples/ESQL/data/books.csv" title="CSV">CSV</a> 文件，其中包括以下信息：</p> 
<pre><code>Title;Descrition;Author;Year;Publisher;Ratings</code></pre> 
<p>我们从公开的<a class="link-info" href="https://www.kaggle.com/datasets/mohamedbakhet/amazon-books-reviews" rel="nofollow" title="亚马逊图书评论数据集">亚马逊图书评论数据集</a>中提取了此列表。</p> 
<p>我们使用以下 Elasticsearch 映射创建了一个 books 索引：</p> 
<pre><code>'mappings' : {
    'properties': {
        'title': {
            'type': 'text'
        },
        'description': {
            'type': 'text'
        },
        'author': {
            'type': 'text'
        },
        'year': {
            'type': 'short'
        },
        'publisher': {
            'type': 'keyword'
        },
        'rating': {
            'type': 'half_float'
        }
    }
}</code></pre> 
<p>rating 值是从 2.9 GB 的 <a class="link-info" href="https://www.kaggle.com/datasets/mohamedbakhet/amazon-books-reviews?select=Books_rating.csv" rel="nofollow" title="Books_ rating.csv">Books_ rating.csv</a> 文件中获取的排名评论的平均值。</p> 
<p>在<a class="link-info" href="https://github.com/elastic/elasticsearch-php-examples/blob/main/examples/ESQL/bulk.php" title="这里">这里</a>您可以找到我们用于批量导入 Elasticsearch 中所有书籍的 PHP 脚本。 使用 PHP 8.2.17 的批量操作需要 7 秒和 28 MB RAM。 根据建议的映射，Elasticsearch 中的索引大小约为 62 MB。</p> 
<p></p> 
<h2>映射到对象或自定义类</h2> 
<p>我们可以使用 esql()-&gt;query() 端点在 PHP 中执行 ES|QL 查询。 该查询的结果是一个表数据结构。 这是使用 columns 和 valuse 字段以 JSON 形式表示的。 在 columns 字段中，我们有 name 和 type 定义。</p> 
<p>下面是一个 ES|QL 查询示例，用于检索按用户排名评论排序的 Stephen King 撰写的前 10 本书：</p> 
<pre><code>$query = &lt;&lt;&lt;EOD
    FROM books
    | WHERE author == "Stephen King"
    | SORT rating DESC
    | LIMIT 10
EOD;

$result = $client-&gt;esql()-&gt;query([
    'body' =&gt; ['query' =&gt; $query]
]);</code></pre> 
<p>Elasticsearch 的 JSON 结果如下所示：</p> 
<pre><code>{
    "columns": [
        { "name": "author", "type": "text" },
        { "name": "description", "type": "text" },
        { "name": "publisher", "type": "keyword" },
        { "name": "rating", "type": "double" },
        { "name": "title", "type": "text" },
        { "name": "year", "type": "integer" }
    ],
    "values": [
        [
            "Stephen King",
            "The author ...",
            "Turtleback",
            5.0,
            "How writers write",
            2002
        ],
        [
            "Stephen King",
            "In Blockade Billy, a retired coach...",
            "Simon and Schuster",
            5.0,
            "Blockade",
            2010
        ],
        [
            "Stephen King",
            "A chilling collection of twenty horror stories.",
            "Signet Book",
            4.55859375,
            "Night Shift (Signet)",
            1979
        ],
        ...
    ]
}</code></pre> 
<p>在此示例中，我们有与一本书相关的 6 个属性（作者、描述、出版商、评级、标题、年份）和 10 个结果，所有书籍均由 Stephen King 撰写。</p> 
<p><a class="link-info" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/esql-limitations.html#esql-supported-types" rel="nofollow" title="此处">此处</a>报告了 ES|QL 中所有支持的类型的列表。</p> 
<p>$result 响应对象可以作为数组、字符串或对象进行访问（请参阅<a class="link-info" href="https://www.elastic.co/guide/en/elasticsearch/client/php-api/current/connecting.html#client-usage" rel="nofollow" title="此处">此处</a>了解更多信息）。</p> 
<p>使用对象接口，我们可以使用属性和索引来访问值。 例如，$result-&gt;values[0][4] 返回列表中第一本书 (0) 的标题 (4)，$result-&gt;values[1][3] 返回列表中第一本书 (0) 的排名分数 (3)第二本书（1）等 请记住，PHP 中数组的索引从零开始。</p> 
<p>这个接口对于某些用例来说已经足够好了，但大多数时候我们希望得到一个对象数组。</p> 
<p>要将结果映射到对象数组中，我们可以使用 elasticsearch-php 的新 <a class="link-info" href="https://github.com/elastic/elasticsearch-php/issues/1398" title="mapTo()">mapTo()</a> 功能。</p> 
<p>该函数可直接在<a class="link-info" href="https://github.com/elastic/elasticsearch-php/blob/main/src/Response/Elasticsearch.php" title="Elasticsearch 响应对象">Elasticsearch 响应对象</a>中使用。 这意味着你可以按如下方式访问它：</p> 
<pre><code>$books = $result-&gt;mapTo(); // Array of stdClass
foreach ($books as $book) {
    printf(
        "%s, %s, %d, Rating: %.2f\n",
        $book-&gt;author,
        $book-&gt;title,
        $book-&gt;year,
        $book-&gt;rating
    );
}</code></pre> 
<p>如果你有自定义 Book 类，则可以使用它来映射结果，如下所示：</p> 
<pre><code>class Book
{
    public string $author;
    public string $title;
    public string $description;
    public int $year;
    public float $rating;
}

$books = $result-&gt;mapTo(Book::class); // Array of Book</code></pre> 
<p>如果你的类除了 ES|QL 结果中包含的属性之外还有其他属性，那么这也将起作用。 mapTo() 函数将仅使用作为 ES|QL 结果的列返回的属性。</p> 
<p>您可以在<a class="link-info" href="https://github.com/elastic/elasticsearch-php-examples/tree/main/examples/ESQL" title="此处">此处</a>下载本文中报告的所有示例。</p> 
<p>准备好将 RAG 构建到你的应用程序中了吗？ 想要尝试使用向量数据库的不同 LLMs？<br> 在 <a class="link-info" href="https://github.com/elastic/elasticsearch-labs" title="Github">Github</a> 上查看我们的 LangChain、Cohere 等示例笔记本，并参加即将开始的 <a class="link-info" href="https://www.elastic.co/training/elasticsearch-engineer" rel="nofollow" title="Elasticsearch 工程师培训">Elasticsearch 工程师培训</a>！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bc4d227981a7c238e114ca50f7fe6881/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mac M2安装 Windows</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d8c1830aa34f634c1cae0ccdf9894091/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AI图片生成视频！Runway保姆级教程：只需三步，小白也能成大神！无门槛</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>