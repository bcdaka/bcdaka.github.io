<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android出海实战：Android14适配 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/bdc81620b980140eecb0e7905e79f23e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android出海实战：Android14适配">
  <meta property="og:description" content="写在伊始 大家都知道，每年Google Play都会要求所有上架海外的App在8月（新包）及11月（在架包）进行新系统版本的适配，今年，我们苦逼的海外开发者又必须要适配Android 14了，晚干不如早干，近期我们公司也是将Android 14适配提上了日程！
以下Android 14 实战所遇问题仅适用于我司项目，如果您所遇问题不同，欢迎留言或私信一起讨论。
开始集成Android 14 我司目前项目环境如下：
Java version ：11.0.18 Android version ：API 33, Android 13 Installation platform &amp; version ：Gradle 6.1.1 AGP ：4.0.1 首先，我们将compileSdkVersion以及targetSdkVersion升级为34，开始Build
android { compileSdkVersion 34 defaultConfig { minSdkVersion 23 targetSdkVersion 34 } } 不出意外，一堆报错。下面我们一一来看：
（1）非空类型不匹配 报错如下：
我们发现，在Android 34源码中，View的 onDraw 方法中，参数Canvas添加了注解NotNull ：
/** * Implement this to do your drawing. * * @param canvas the canvas on which the background will be drawn */ protected void onDraw(@NonNull Canvas canvas) { } 如果项目中使用了kotlin并且覆写的onDraw 方法有空安全运算符 ？，导致了上面的报错">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-28T13:44:39+08:00">
    <meta property="article:modified_time" content="2024-06-28T13:44:39+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android出海实战：Android14适配</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>写在伊始</h4> 
<p>大家都知道，每年Google Play都会要求所有上架海外的App在8月（新包）及11月（在架包）进行新系统版本的适配，今年，我们苦逼的海外开发者又必须要适配Android 14了，晚干不如早干，近期我们公司也是将Android 14适配提上了日程！</p> 
<p><strong><span style="color:#fe2c24;">以下Android 14 实战所遇问题仅适用于我司项目，如果您所遇问题不同，欢迎留言或私信一起讨论。</span></strong></p> 
<h4>开始集成Android 14</h4> 
<p>我司目前项目环境如下：</p> 
<pre><code class="language-Kotlin">Java version ：11.0.18
Android version ：API 33, Android 13
Installation platform &amp; version ：Gradle 6.1.1
AGP ：4.0.1</code></pre> 
<p>首先，我们将compileSdkVersion以及targetSdkVersion升级为34，开始Build</p> 
<pre><code class="language-Groovy">android {
    compileSdkVersion 34

    defaultConfig {

        minSdkVersion 23
        targetSdkVersion 34

    }
}</code></pre> 
<p>不出意外，一堆报错。下面我们一一来看：</p> 
<h5>（1）非空类型不匹配</h5> 
<p>报错如下：</p> 
<p><img alt="" height="144" src="https://images2.imgbox.com/1e/c7/8LMuhZns_o.png" width="1200"></p> 
<p>我们发现，在Android 34源码中，View的 onDraw 方法中，参数Canvas添加了注解NotNull ：</p> 
<pre><code class="language-java">   /**
     * Implement this to do your drawing.
     *
     * @param canvas the canvas on which the background will be drawn
     */
    protected void onDraw(@NonNull Canvas canvas) {
    }</code></pre> 
<p>如果项目中使用了kotlin并且覆写的onDraw 方法有空安全运算符 ？，导致了上面的报错</p> 
<pre><code class="language-Kotlin">override fun onDraw(canvas: Canvas?) {
    super.onDraw(canvas)
}</code></pre> 
<p>修改方式也比较简单，我们去掉空安全运算符 ？即可</p> 
<pre><code class="language-Kotlin">override fun onDraw(canvas: Canvas) {
    super.onDraw(canvas)
}</code></pre> 
<h5>（2）AAPT2异常终止</h5> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/34/53/0wvD4B9s_o.png"></p> 
<p>AAPT2 报错的具体原因在日志里面没有详细的信息的，在gradle 社区上找到如下回答，告知我这应该是Android 独有的问题，跟Gradle构建工具无关。</p> 
<p><img alt="" src="https://images2.imgbox.com/cb/1f/afjgrLcT_o.png"><br> Google 搜索相关的问题，找到了如下的回答</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/3c/53/ioiKIlkN_o.png"></p> 
<p>以此为线索，我们Demo验证，创建新的项目将targetSdkVersion 升级到34，项目是可以正常打包的，但是引入了facebook-android-sdk后就会出现aapt2异常终止报错。按照上图所示去掉legacy-support-v4就又可以正常打包。</p> 
<p>基于上述定位到的具体原因，我们傻瓜式的排查了项目所有的引用库，发现androidx.legacy:legacy-support-v4，androidx.core:core-splashscreen两个库会引发aapt2异常终止问题。移除这2个库重新构建项目就可以正常打包运行了。</p> 
<p>但是，移除库还是会影响app的部分功能，例如splashscreen库（Android 12闪屏适配）。所以我们再次研究了Android 14适配的官方文档，该文档上提到了AGP 7.0.0以上的版本适配，虽然官方没有说适配14必须将AGP升到7.0+，但是我们抱着试试的态度进行了尝试环境配置如下。经过升级后项目可以正常打包了，也没有影响splashscreen库（Android 12闪屏适配）功能。适配后环境如下：</p> 
<pre><code class="language-Kotlin">Java version ：11.0.18
Android version ：API 34, Android 14
Installation platform &amp; version ：Gradle 7.5
AGP ：7.4.2</code></pre> 
<h6>升级AGP步骤</h6> 
<p>1.使用 Android Gradle 插件升级助理</p> 
<p>google 官方文档 :<a class="link-info" href="https://developer.android.google.cn/build/agp-upgrade-assistant?hl=th" rel="nofollow" title=" 使用 Android Gradle 插件升级助理"> 使用 Android Gradle 插件升级助理</a></p> 
<p>打开Tools &gt; AGP Upgrade Assistant ，随即出现的工具窗口中会显示默认升级的详细信息，其中包括项目的当前版本 AGP 以及此版本 Android Studio 所支持的AGP下拉列表，选择7.4.2版本后点击Run selected steps。</p> 
<p style="text-align:center;"><img alt="" class="left" src="https://images2.imgbox.com/32/aa/rEovigjy_o.png"></p> 
<p><img alt="" src="https://images2.imgbox.com/25/d5/swzLYra2_o.png"></p> 
<p>经过上面的步骤，项目的build.gradle文件以及gradle-wrapper.properties文件会发生变更如下</p> 
<pre><code class="language-Kotlin">gradle版本：7.5 
gradle plugin版本：7.4.2  
kotlin版本：1.6.21</code></pre> 
<p>2.修改项目build.gradle文件</p> 
<p>修改前：</p> 
<pre><code class="language-Groovy">buildscript {
        ext.kotlin_version = '1.6.21'
        repositories {
            maven {
                url "xxx"
            }
            google()
            mavenCentral()
        }
    
        dependencies {
            classpath 'com.android.tools.build:gradle:7.4.2'
            classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
            classpath "org.jetbrains.kotlin:kotlin-android-extensions:$kotlin_version"
            ...
        }
    }
    
    allprojects {
        repositories {
            maven {
                url "xxx"
            }
            google()
            mavenCentral()
         }
    }</code></pre> 
<p>修改后：</p> 
<pre><code class="language-Groovy">buildscript {
        ext.kotlin_version = '1.6.21'
        
        dependencies {
            classpath 'com.android.tools.build:gradle:7.4.2'
            classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
            classpath "org.jetbrains.kotlin:kotlin-android-extensions:$kotlin_version"
            ...
        }
    }
    
    plugins {
        id 'com.android.application' version '7.4.2' apply false
        id 'com.android.library' version '7.4.2' apply false
        id 'org.jetbrains.kotlin.android' version '1.6.21' apply false
    }</code></pre> 
<p>3.修改项目setting.gradle文件</p> 
<p>修改前：</p> 
<pre><code class="language-Groovy">include ':app' ...</code></pre> 
<p>修改后：</p> 
<pre><code class="language-Groovy">pluginManagement {
        repositories {
            gradlePluginPortal()
            google()
            mavenCentral()
            maven { url "xxx" //如果是http 需要配置allowInsecureProtocol = true }
            ...
        }
    }
    
    dependencyResolutionManagement {
        repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
        repositories {
            google()
            mavenCentral()
            maven { url "xxx" //如果是http 需要配置allowInsecureProtocol = true }
            ...
        }
    }
    include ':app' ...</code></pre> 
<p>4.修改各个module下的build.gradle文件</p> 
<p>修改前：</p> 
<pre><code class="language-Groovy">    apply plugin: 'com.android.application'
    apply plugin: 'kotlin-android'
    apply plugin: 'kotlin-android-extensions'
    apply plugin: 'kotlin-kapt'
    ...
    
    android {
        compileSdkVersion xxx
        ...
        defaultConfig {
            minSdkVersion xxx
            targetSdkVersion xxx
            ...
         }
         repositories {
             flatDir {
                 dirs 'libs'
             }
         }
         ...
     }</code></pre> 
<p>修改后：</p> 
<pre><code class="language-Groovy">    plugins{
        id 'com.android.application'
        id 'kotlin-android'
        id 'kotlin-android-extensions'
        id 'kotlin-kapt'
        ...
    }
    android {
        compileSdk xxx
        ...
        defaultConfig {
            minSdk xxx
            targetSdk xxx
            ...
         }
         //删除repositories flatDir
         ...
     }

    dependencies {
        implementation fileTree(dir: "libs", include: [".jar", ".aar"])
        ...
    }</code></pre> 
<p>改到这里，基本就大功告成了。下面简单的谈谈其他Android 14适配中需要注意的事项，仅供参考。</p> 
<h4>适配Android 14需要注意事项，大家按需适配：</h4> 
<p><strong><span style="color:#fe2c24;">Tips：动态注册广播我想大家用到的可能性较高，大家可以重点关注下。</span></strong></p> 
<p>一.所有应用变更</p> 
<table><thead><tr><th>类别</th><th>类型</th><th>名称</th></tr></thead><tbody><tr><td>无障碍</td><td>变更（所有应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-all?hl=zh-cn#non-linear-font-scaling" rel="nofollow" title="使用非线性字体缩放测试应用">使用非线性字体缩放测试应用</a><br> 由于 Android 支持字体放大高达 200%，因此您应执行界面测试，确保您的应用可以容纳更大的字体，而不会影响易用性。</td></tr><tr><td>核心功能</td><td>变更（所有应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-all?hl=zh-cn#kill-own-background-processes" rel="nofollow" title="应用只能终止自己的后台进程">应用只能终止自己的后台进程</a><br> 当您的应用调用 <code>killBackgroundProcesses()</code> 时，API 只能终止您自己应用的后台进程。</td></tr><tr><td>核心功能</td><td>变更（所有应用）</td><td><a href="https://developer.android.com/about/versions/14/changes/schedule-exact-alarms?hl=zh-cn" rel="nofollow" title="系统在默认情况下会拒绝安排精确闹钟">系统在默认情况下会拒绝安排精确闹钟</a><br> 对于以 Android 13 及更高版本为目标平台的大多数新安装应用，系统不再预先向其授予 <code>SCHEDULE_EXACT_ALARM</code> 权限，该权限默认处于拒绝状态。</td></tr><tr><td>核心功能</td><td>变更（所有应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-all?hl=zh-cn#pending-broadcasts-queued" rel="nofollow" title="上下文注册的广播会在应用缓存期间加入队列">上下文注册的广播会在应用缓存期间加入队列</a><br> 当上下文注册的广播已加入队列以传送给处于缓存状态的应用时，系统可能会将这些广播放入队列中。</td></tr><tr><td>安全</td><td>变更（所有应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-all?hl=zh-cn#minimum-target-api-level" rel="nofollow" title="最低可安装目标 API 级别">最低可安装目标 API 级别</a><br> 用户无法安装 <code>targetSdkVersion</code> 低于 <code>23</code> 的应用。</td></tr><tr><td>安全</td><td>变更（所有应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-all?hl=zh-cn#media-owner-package-names" rel="nofollow" title="系统可能会隐去媒体所有者软件包名称">系统可能会隐去媒体所有者软件包名称</a><br> 除非应用满足特定条件，否则系统会隐去 <a href="https://developer.android.com/reference/android/provider/MediaStore.MediaColumns?hl=zh-cn#OWNER_PACKAGE_NAME" rel="nofollow" title="OWNER_PACKAGE_NAME">OWNER_PACKAGE_NAME</a> 的值。</td></tr><tr><td>用户体验</td><td>变更（所有应用）</td><td><a href="https://developer.android.com/about/versions/14/changes/partial-photo-video-access?hl=zh-cn" rel="nofollow" title="授予对照片和视频的部分访问权限">授予对照片和视频的部分访问权限</a><br> 当应用请求在 Android 13（API 级别 33）中引入的任何视觉媒体权限（<code>READ_MEDIA_IMAGES</code> 和 <code>READ_MEDIA_VIDEO</code>）时，用户可以授予其对照片和视频的部分访问权限。</td></tr><tr><td>用户体验</td><td>变更（所有应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-all?hl=zh-cn#secure-fsi" rel="nofollow" title="更新了全屏 intent 通知的权限要求">更新了全屏 intent 通知的权限要求</a><br> 在 Android 14 中，只有提供通话和闹钟的应用才能使用 <code>USE_FULL_SCREEN_INTENT</code> 权限支持全屏 intent 通知。</td></tr><tr><td>用户体验</td><td>变更（所有应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-all?hl=zh-cn#non-dismissable-notifications" rel="nofollow" title="不可关闭的通知">不可关闭的通知</a><br> 如果您的应用向用户显示不可关闭的前台通知，请注意：Android 14 已更改此行为，允许用户关闭此类通知。</td></tr><tr><td>用户体验</td><td>变更（所有应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-all?hl=zh-cn#data-safety" rel="nofollow" title="数据安全信息">数据安全信息</a><br> 现在，您的应用的数据安全信息（例如数据共享做法）会出现在某些权限理由系统对话框和系统通知中。</td></tr></tbody></table> 
<p>适配指南：</p> 
<p>1.Android14已无法安装 <code>targetSdkVersion</code> 低于 <code>23</code> 的应用</p> 
<p>2.<code><a href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#USE_FULL_SCREEN_INTENT" rel="nofollow" title="USE_FULL_SCREEN_INTENT">USE_FULL_SCREEN_INTENT</a>权限在Android14仅限于提供通话和闹钟的应用，其他应用将被收回权限。</code></p> 
<p><code>如果项目中有涉及，在升级Android14时，请检查权限：</code></p> 
<p><code>可以使用新 API <a href="https://developer.android.com/reference/android/app/NotificationManager?hl=zh-cn#canUseFullScreenIntent%28%29" rel="nofollow" title="NotificationManager.canUseFullScreenIntent">NotificationManager.canUseFullScreenIntent</a> 检查应用是否具有该权限；如果没有，应用可以使用新 intent <a href="https://developer.android.com/reference/android/provider/Settings?hl=zh-cn#ACTION_MANAGE_APP_USE_FULL_SCREEN_INTENT" rel="nofollow" title="ACTION_MANAGE_APP_USE_FULL_SCREEN_INTENT">ACTION_MANAGE_APP_USE_FULL_SCREEN_INTENT</a> 启动设置页面，在该页面中，用户可以授予权限。</code></p> 
<p>3.如新项目中/新业务中涉及闹钟，精确闹钟权限需主动申请。从 Android 14 开始，系统不再向以 Android 13 及更高版本为目标平台的大多数新安装应用预先授予 <a href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#SCHEDULE_EXACT_ALARM" rel="nofollow" title="SCHEDULE_EXACT_ALARM">SCHEDULE_EXACT_ALARM</a> 权限，该权限默认处于拒绝状态。</p> 
<p>4.android14中用户可以仅授予部分访问媒体权限。如果是使用<a href="https://developer.android.com/about/versions/13/features/photopicker?hl=zh-cn" rel="nofollow" title="照片选择器">照片选择器</a>，或者此前应用已获取到访问权限，则不受影响。</p> 
<p>如果是新安装在Android14设备中，请求细分权限如<code>READ_MEDIA_IMAGES、</code>READ_MEDIA_VIDEO等<code>，当弹框用户选择仅授予部分权限时，请求的细分权限只在应用存活期间生效，下次启动app仍需要请求权限，这可能会使用户感到惊讶，因此在申请细分权限时，加入<a href="https://developer.android.com/reference/android/Manifest.permission?hl=zh-cn#READ_MEDIA_VISUAL_USER_SELECTED" rel="nofollow" title="READ_MEDIA_VISUAL_USER_SELECTED">READ_MEDIA_VISUAL_USER_SELECTED</a>权限，这样当用户选择仅授予部分权限时，他会拒绝细分权限，而提供临时的访问权限，以便再次弹框请求细分权限。</code></p> 
<p>二.以Android14为目标平台的应用</p> 
<table><thead><tr><th>类别</th><th>类型</th><th>名称</th></tr></thead><tbody><tr><td>核心功能</td><td>变更（以 Android 14 及更高版本为目标平台的应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-14?hl=zh-cn#fgs-types" rel="nofollow" title="必须提供前台服务类型">必须提供前台服务类型</a><br> 如果应用以 Android 14 为目标平台，则必须为应用中的每个前台服务指定至少一个前台服务类型。</td></tr><tr><td>核心功能</td><td>变更（以 Android 14 及更高版本为目标平台的应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-14?hl=zh-cn#core-libraries" rel="nofollow" title="OpenJDK 17 更新">OpenJDK 17 更新</a><br> 在 OpenJDK 17 更新中，一些更改会影响应用兼容性，例如对正则表达式和 UUID 处理的更改。</td></tr><tr><td>限制非 SDK 接口</td><td>变更（以 Android 14 及更高版本为目标平台的应用）</td><td><a href="https://developer.android.com/about/versions/14/changes/non-sdk-14?hl=zh-cn" rel="nofollow" title="更新了非 SDK 接口限制">更新了非 SDK 接口限制</a><br> Android 14 包含更新后的受限制非 SDK 接口列表（基于与 Android 开发者之间的协作以及最新的内部测试）。</td></tr><tr><td>安全</td><td>变更（以 Android 14 及更高版本为目标平台的应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-14?hl=zh-cn#safer-intents" rel="nofollow" title="对隐式 intent 和待处理 intent 的限制">对隐式 intent 和待处理 intent 的限制</a><br> 对于以 Android 14 为目标平台的应用，Android 会限制应用向内部应用组件发送隐式 intent。</td></tr><tr><td>安全</td><td>变更（以 Android 14 及更高版本为目标平台的应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-14?hl=zh-cn#runtime-receivers-exported" rel="nofollow" title="运行时注册的广播接收器必须指定导出行为">运行时注册的广播接收器必须指定导出行为</a><br> 以 Android 14 为目标平台且使用上下文注册的接收器的应用和服务必须指定一个标志，以指明接收器是否应导出到设备上的所有其他应用。</td></tr><tr><td>安全</td><td>变更（以 Android 14 及更高版本为目标平台的应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-14?hl=zh-cn#safer-dynamic-code-loading" rel="nofollow" title="更安全地动态加载代码">更安全地动态加载代码</a><br> 如果应用以 Android 14 为目标平台，并且使用动态代码加载 (DCL) 功能，则必须将所有动态加载的文件标记为只读。</td></tr><tr><td>安全</td><td>变更（以 Android 14 及更高版本为目标平台的应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-14?hl=zh-cn#zip-path-traversal" rel="nofollow" title="Zip 路径遍历">Zip 路径遍历</a><br> 对于以 Android 14 为目标平台的应用，Android 通过限制 Zip 文件条目名称所含的内容来防止 Zip 路径遍历漏洞。</td></tr><tr><td>安全</td><td>变更（以 Android 14 及更高版本为目标平台的应用）</td><td><a href="https://developer.android.com/about/versions/14/behavior-changes-14?hl=zh-cn#background-activity-restrictions" rel="nofollow" title="针对从后台启动 activity 的额外限制">针对从后台启动 activity 的额外限制</a><br> 对于以 Android 14 为目标平台的应用，如果应用想要在发送其他应用的 <code>PendingIntent</code>或绑定该应用的服务时为自己的后台 activity 授予启动其他应用的特权，则必须选择启用。</td></tr></tbody></table> 
<p>适配指南：</p> 
<p>1.前台Service必须在 <a href="https://developer.android.com/guide/topics/manifest/service-element?hl=zh-cn" rel="nofollow" title="&lt;service&gt;">&lt;service&gt;</a> 指定 <code><a href="http://androidforegroundservicetype/" rel="nofollow" title="android:foregroundServiceType">android:foregroundServiceType</a></code> 属性，同时申请特定的相关权限，否则在调用 <a href="https://developer.android.com/reference/android/app/Service?hl=zh-cn#startForeground%28int,%20android.app.Notification%29" rel="nofollow" title="startForeground()">startForeground()</a> 时引发 <code>MissingForegroundServiceTypeException</code>。</p> 
<p>关于特定权限，参考<a href="https://developer.android.com/guide/components/foreground-services?hl=zh-cn" rel="nofollow" title="前台服务">前台服务</a><a href="https://developer.android.com/about/versions/14/changes/fgs-types-required?hl=zh-cn" rel="nofollow" title="至少指定一项前台服务类型">至少指定一项前台服务类型</a>。</p> 
<p>从趋势来看，service逐渐鸡肋，建议迁移使用 <a href="https://developer.android.com/topic/libraries/architecture/workmanager?hl=zh-cn" rel="nofollow" title="WorkManager">WorkManager</a> 或<a href="https://developer.android.com/about/versions/14/changes/user-initiated-data-transfers?hl=zh-cn" rel="nofollow" title="用户发起的数据传输作业">用户发起的数据传输作业</a>。</p> 
<p>2、如果使用android默认jdk17，需要关注以下三点变化：</p> 
<ul><li>对正则表达式的更改：现在，为了更严格地遵循 OpenJDK 的语义，不允许无效的组引用。您可能会看到 <a href="https://developer.android.com/reference/java/util/regex/Matcher?hl=zh-cn" rel="nofollow" title="java.util.regex.Matcher">java.util.regex.Matcher</a> 类抛出 <code>IllegalArgumentException</code> 的新情况，因此请务必测试应用中使用正则表达式的情形。</li><li> UUID 处理：现在，验证输入参数时，<a href="https://developer.android.com/reference/java/util/UUID?hl=zh-cn#fromString%28java.lang.String%29" rel="nofollow" title="java.util.UUID.fromString()">java.util.UUID.fromString()</a> 方法会执行更严格的检查，因此您可能会在反序列化期间看到 <code>IllegalArgumentException</code>。</li><li> ProGuard 问题：有时，在您尝试使用 ProGuard 缩减、混淆和优化应用时，添加 <a href="https://developer.android.com/reference/java/lang/ClassValue?hl=zh-cn" rel="nofollow" title="java.lang.ClassValue">java.lang.ClassValue</a> 类会导致问题。问题源自 Kotlin 库，该库会根据 <code>Class.forName("java.lang.ClassValue")</code> 是否会返回类更改运行时行为。如果您的应用是根据没有 <code>java.lang.ClassValue</code> 类的旧版运行时开发的，则这些优化可能会将 <code>computeValue</code> 方法从派生自 <code>java.lang.ClassValue</code> 的类中移除。</li></ul> 
<p>3.在Android14中Intent遵循以下规则：</p> 
<ul><li>隐式 intent 只能传送到导出的组件。应用必须使用显式 intent 传送到未导出的组件，或将该组件标记为已导出。</li><li>如果应用通过未指定组件或软件包的 intent 创建可变待处理 intent，系统现在会抛出异常。</li></ul> 
<pre>// Throws an exception when targeting Android 14.
context.startActivity(new Intent("com.example.action.APP_ACTION"));</pre> 
<p>因此隐式Intent需指定 android:exported="true"或者调用Intent#setPackage(String)方法指定包名，否则将抛出异常</p> 
<p>4.在Android14中，BroadcastReceiver的动态注册必须指定导出行为<code>RECEIVER_EXPORTED</code> 或 <code>RECEIVER_NOT_EXPORTED</code>，如果只接受系统广播则不需要。</p> 
<pre> 示例：context.registerReceiver(privateBroadcastReceiver, intentFilter, RECEIVER_NOT_EXPORTED);</pre> 
<p>5.动态加载jar包及其他代码文件时，需要首先设置只读模式，否则将抛出异常</p> 
<p>示例：</p> 
<pre>File jar = new File("DYNAMICALLY_LOADED_FILE.jar");
try (FileOutputStream os = new FileOutputStream(jar)) {
    // Set the file to read-only first to prevent race conditions
    jar.setReadOnly();
    // Then write the actual file content
} catch (IOException e) { ... }
PathClassLoader cl = new PathClassLoader(jar, parentClassLoader);</pre> 
<p>6.在Android14中，如果 Zip 文件条目名称包含“..”或以“/”开头，<a href="https://developer.android.com/reference/java/util/zip/ZipFile?hl=zh-cn#public-constructors" rel="nofollow" title="ZipFile(String)">ZipFile(String)</a> 和 <a href="https://developer.android.com/reference/java/util/zip/ZipInputStream?hl=zh-cn#getNextEntry%28%29" rel="nofollow" title="ZipInputStream.getNextEntry()">ZipInputStream.getNextEntry()</a> 会抛出 <a href="https://developer.android.com/reference/java/util/zip/ZipException?hl=zh-cn" rel="nofollow" title="ZipException">ZipException</a>。</p> 
<p>7.针对后台启动activity增加了更多限制：</p> 
<ul><li>现在，当应用使用 <a href="https://developer.android.com/reference/android/app/PendingIntent?hl=zh-cn#send%28android.content.Context,%20int,%20android.content.Intent,%20android.app.PendingIntent.OnFinished,%20android.os.Handler,%20java.lang.String,%20android.os.Bundle%29" rel="nofollow" title="PendingIntent#send()">PendingIntent#send()</a> 或类似方法发送 <code>PendingIntent</code> 时，如果它想要授予自己的后台 activity 启动待处理 intent 的启动特权，则必须选择启用。如需选择启用，应用应通过 <a href="https://developer.android.com/reference/android/app/ActivityOptions?hl=zh-cn#setPendingIntentBackgroundActivityStartMode%28int%29" rel="nofollow" title="setPendingIntentBackgroundActivityStartMode(MODE_BACKGROUND_ACTIVITY_START_ALLOWED)">setPendingIntentBackgroundActivityStartMode(MODE_BACKGROUND_ACTIVITY_START_ALLOWED)</a> 传递 <code>ActivityOptions</code> 软件包。</li><li>当可见应用使用 <a href="https://developer.android.com/reference/android/content/Context?hl=zh-cn#bindService%28android.content.Intent,%20android.content.Context.BindServiceFlags,%20java.util.concurrent.Executor,%20android.content.ServiceConnection%29" rel="nofollow" title="bindService()">bindService()</a> 方法绑定其他在后台应用的服务时，如果可见应用想要授予自己的后台 activity 对绑定服务的启动特权，则必须选择启用。如需选择启用，应用应在调用 <code>bindService()</code> 方法时包含 <a href="https://developer.android.com/reference/android/content/Context?hl=zh-cn#BIND_ALLOW_ACTIVITY_STARTS" rel="nofollow" title="BIND_ALLOW_ACTIVITY_STARTS">BIND_ALLOW_ACTIVITY_STARTS</a> 标志。</li></ul> 
<p>三.新功能和API</p> 
<table><thead><tr><th>类别</th><th>类型</th><th>名称</th></tr></thead><tbody><tr><td>无障碍</td><td>新功能和 API</td><td><a href="https://developer.android.com/about/versions/14/features?hl=zh-cn#non-linear-font-scaling" rel="nofollow" title="将字体放大高达 200% 的非线性字体">将字体放大高达 200% 的非线性字体</a><br> Android 支持字体放大高达 200%，为弱视用户提供了符合《网络内容无障碍指南》(WCAG) 的其他无障碍选项。</td></tr><tr><td>核心功能</td><td>新功能和 API</td><td><a href="https://developer.android.com/about/versions/14/features?hl=zh-cn#core-libraries" rel="nofollow" title="OpenJDK 17 更新">OpenJDK 17 更新</a><br> Android 14 包含一些可进一步与 OpenJDK 17 LTS 版本保持一致的功能和改进，包括面向应用开发者和平台开发者的库更新和 Java 17 语言支持。</td></tr><tr><td>国际化</td><td>新功能和 API</td><td><a href="https://developer.android.com/about/versions/14/features?hl=zh-cn#app-languages" rel="nofollow" title="各应用语言偏好设定">各应用语言偏好设定</a><br> Android 14 扩展了 Android 13（API 级别 33）中引入的按应用设定语言功能，并提供了一些额外的功能。</td></tr><tr><td>图形</td><td>新功能和 API</td><td><a href="https://developer.android.com/about/versions/14/features?hl=zh-cn#paths" rel="nofollow" title="路径现在可查询和插值">路径现在可查询和插值</a><br> 您可以查询路径以了解其内部内容，在结构完全匹配的路径中进行插值，并实现变形效果。</td></tr><tr><td>国际化</td><td>新功能和 API</td><td><a href="https://developer.android.com/about/versions/14/features/grammatical-inflection?hl=zh-cn" rel="nofollow" title="语法变化 API">语法变化 API</a><br> 借助语法变化 API，您可以更轻松地向具有语法性别的语言的用户提供支持，从而针对这些语言提供更个性化、更自然的用户体验。</td></tr><tr><td>国际化</td><td>新功能和 API</td><td><a href="https://developer.android.com/about/versions/14/features?hl=zh-cn#regional-preferences" rel="nofollow" title="地区偏好设置">地区偏好设置</a><br> 当用户更改其地区偏好设置并在应用中镜像这些偏好设置时，应用可以接收通知。</td></tr><tr><td>用户体验</td><td>新功能和 API</td><td><a href="https://developer.android.com/about/versions/14/features?hl=zh-cn#sharesheet-improvements" rel="nofollow" title="Sharesheet 自定义操作和排名改进">Sharesheet 自定义操作和排名改进</a><br> Android 14 更新了系统 Sharesheet，以便为用户提供自定义应用操作和信息更丰富的预览结果。</td></tr><tr><td>用户体验</td><td>新功能和 API</td><td><a href="https://developer.android.com/about/versions/14/features/predictive-back?hl=zh-cn" rel="nofollow" title="支持内置和自定义动画">支持内置和自定义动画</a><br> 使用新的系统返回 API 的应用可选择启用预测性返回，以自动接收应用内动画并支持自定义转换。</td></tr><tr><td>用户体验</td><td>新功能和 API</td><td><a href="https://developer.android.com/about/versions/14/features?hl=zh-cn#app-stores" rel="nofollow" title="针对应用商店的改进">针对应用商店的改进</a><br> Android 14 引入了多个新的 <code>PackageInstaller</code> API，可帮助应用商店改善其用户体验。</td></tr><tr><td>用户体验</td><td>新功能和 API</td><td><a href="https://developer.android.com/about/versions/14/features/screenshot-detection?hl=zh-cn" rel="nofollow" title="屏幕截图检测">屏幕截图检测</a><br> 我们提供了一种可保护隐私的 API，如果用户在应用 activity 可见时截取屏幕截图，该 API 会调用回调并显示消息框消息。</td></tr></tbody></table> 
<h4>Android出海实战系列</h4> 
<p>本次Android出海实战，目前规划有以下文章，大家有迫切想看的或者有其他想法的，可以关注下面公众号并联系我们，感谢您的支持。</p> 
<p><a href="https://blog.csdn.net/Jrchbxt2013/article/details/139236063" title="1.Android出海实战：Android14适配">1.Android出海实战：Android14适配</a></p> 
<p><a href="https://blog.csdn.net/Jrchbxt2013/article/details/139293130" title="2.Android出海实战：Google Play 开发者账号申请（保姆级教程）">2.Android出海实战：Google Play 开发者账号申请（保姆级教程）</a>​​​​​​​</p> 
<p>3.Android出海实战：Google Play 上架指引（保姆级教程）</p> 
<p>4.Android出海实战：Duns码（邓白氏）申请</p> 
<p>5.Android出海实战：Firebase FCM推送</p> 
<h4>出海共济</h4> 
<p>出海之路，路远且艰。更多<strong>金融出海解决方案</strong>，欢迎关注公众号<strong> 趣浪出海</strong> ，欢迎大家一起探讨更多合规问题，稳健航行世界之海。​​​​​​​</p> 
<p><img alt="" height="111" src="https://images2.imgbox.com/52/c2/1VE8wBd1_o.png" width="297"></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/874796bb17deab04c4fe00b5e03c7fc5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">2023年第十四届蓝桥杯JavaB组省赛真题及全部解析（上）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4213790346a8e47c6fa4d4d366024732/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在线编辑、预览、基于wps web office，v3版 强势来袭（已适配solon）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>