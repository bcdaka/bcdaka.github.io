<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>VPN的介绍及自建点对点的OpenVPN和使用方法：保姆级详细教程，(windou客户端版)后附脚本 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/7e3cd576060d7775abccb239a8a499b0/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="VPN的介绍及自建点对点的OpenVPN和使用方法：保姆级详细教程，(windou客户端版)后附脚本">
  <meta property="og:description" content="VPN到底是啥？ VPN即虚拟专用网，泛指通过VPN技术在公用网络上构建的虚拟专用网络。
VPN用户在此虚拟网络中传输私网流量，在不改变网络现状的情况下实现安全、可靠的连接。
1.VPN和传统的数据专网相比，优势很多： 安全：
在远端用户、驻外机构、合作伙伴、供应商与公司总部之间建立可靠的连接，保证数据传输的安全性。这对于实现电子商务或金融网络与通讯网络的融合特别重要。
廉价：
利用公共网络进行信息通讯，企业可以用更低的成本连接远程办事机构、出差人员和业务伙伴。
支持移动业务：
支持驻外VPN用户在任何时间、任何地点的移动接入，能够满足不断增长的移动业务需求。
可扩展性：
由于VPN为逻辑上的网络，物理网络中增加或修改节点，不影响VPN的部署。
公共网络又经常被称为VPN骨干网（VPN Backbone），公共网络可以是Internet，也可以是企业自建专网或运营商租赁专网。
工作在网络层和数据链路层的VPN又被称为三层VPN和二层VPN。
2.VPN关键技术：隧道技术 VPN技术的基本原理是利用隧道（Tunnel）技术，对传输报文进行封装，利用VPN骨干网建立专用数据传输通道，实现报文的安全传输。
位于隧道两端的VPN网关，通过对原始报文的“封装”和“解封装”，建立一个点到点的虚拟通信隧道。
隧道的功能就是在两个网络节点之间提供一条通路，使数据能够在这个通路上透明传输。
VPN隧道一般是指在VPN骨干网的VPN节点之间建立的用来传输VPN数据的虚拟连接。
隧道是构建VPN不可或缺的部分，用于把VPN数据从一个VPN节点透明传送到另一个上。
隧道通过隧道协议实现
目前已存在不少隧道协议，如GRE（Generic Routing Encapsulation）、L2TP（Layer 2 Tunneling Protocol）等。
隧道协议通过在隧道的一端给数据加上隧道协议头，即进行封装，使这些被封装的数据能都在某网络中传输，并且在隧道的另一端去掉该数据携带的隧道协议头，即进行解封装。
报文在隧道中传输前后都要通过封装和解封装两个过程。
部分隧道可以混合使用，如GRE Over IPSec隧道。
3.VPN关键技术：身份认证、数据加密与验证 身份认证、数据加密和认证技术可以有效保证VPN网络与数据的安全性：
身份认证：
可用于部署了远程接入VPN的场景，VPN网关对用户的身份进行认证，保证接入网络的都是合法用户而非恶意用户。也可以用于VPN网关之间对对方身份的认证。
数据加密：
将明文通过加密变成密文，使得数据即使被黑客截获，黑客也无法获取其中的信息。
数据验证：
通过数据验证技术对报文的完整性和真伪进行检查，丢弃被伪造和被篡改的报文。
4.常见VPN技术—IPSec （1） IPSec概述 IPSec（IP Security） VPN一般部署在企业出口设备之间，通过加密与验证等方式，实现了数据来源验证、数据加密、数据完整性保证和抗重放等功能。
数据来源验证：接收方验证发送方身份是否合法。
数据加密：发送方对数据进行加密，以密文的形式在Internet上传送，接收方对接收的加密数据进行解密后处理或直接转发。
数据完整性：接收方对接收的数据进行验证，以判定报文是否被篡改。
抗重放：接收方拒绝旧的或重复的数据包，防止恶意用户通过重复发送捕获到的数据包所进行的攻击。
（2） IPSec协议体系 IPSec不是一个单独的协议，它给出了IP网络上数据安全的一整套体系结构，包括AH（Authentication Header）、ESP（Encapsulating Security Payload）、IKE（Internet Key Exchange）等协议。
IPSec使用认证头AH（Authentication Header）和封装安全载荷ESP（Encapsulating Security Payload）两种安全协议来传输和封装数据，提供认证或加密等安全服务。
AH和ESP协议提供的安全功能依赖于协议采用的验证、加密算法。
AH仅支持认证功能，不支持加密功能。ESP支持认证和加密功能。
安全协议提供认证或加密等安全服务需要有秘钥的存在。
（3）秘钥交换的方式有两种 带外共享密钥：
在发送、接收设备上手工配置静态的加密、验证密钥。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-23T10:17:06+08:00">
    <meta property="article:modified_time" content="2024-02-23T10:17:06+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">VPN的介绍及自建点对点的OpenVPN和使用方法：保姆级详细教程，(windou客户端版)后附脚本</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="VPN_2"></a>VPN到底是啥？</h3> 
<p>VPN即虚拟专用网，泛指通过VPN技术在公用网络上构建的虚拟专用网络。</p> 
<p>VPN用户在此虚拟网络中传输私网流量，在不改变网络现状的情况下实现安全、可靠的连接。</p> 
<h3><a id="1VPN_8"></a>1.VPN和传统的数据专网相比，优势很多：</h3> 
<p><strong>安全：</strong><br> 在远端用户、驻外机构、合作伙伴、供应商与公司总部之间建立可靠的连接，保证数据传输的安全性。这对于实现电子商务或金融网络与通讯网络的融合特别重要。</p> 
<p><strong>廉价：</strong><br> 利用公共网络进行信息通讯，企业可以用更低的成本连接远程办事机构、出差人员和业务伙伴。</p> 
<p><strong>支持移动业务：</strong><br> 支持驻外VPN用户在任何时间、任何地点的移动接入，能够满足不断增长的移动业务需求。</p> 
<p><strong>可扩展性：</strong><br> 由于VPN为逻辑上的网络，物理网络中增加或修改节点，不影响VPN的部署。</p> 
<p>公共网络又经常被称为VPN骨干网（VPN Backbone），公共网络可以是Internet，也可以是企业自建专网或运营商租赁专网。<br> 工作在网络层和数据链路层的VPN又被称为三层VPN和二层VPN。</p> 
<h3><a id="2VPN_27"></a>2.VPN关键技术：隧道技术</h3> 
<p>VPN技术的基本原理是利用隧道（Tunnel）技术，对传输报文进行封装，利用VPN骨干网建立专用数据传输通道，实现报文的安全传输。</p> 
<p>位于隧道两端的VPN网关，通过对原始报文的“封装”和“解封装”，建立一个点到点的虚拟通信隧道。</p> 
<p>隧道的功能就是在两个网络节点之间提供一条通路，使数据能够在这个通路上透明传输。</p> 
<p>VPN隧道一般是指在VPN骨干网的VPN节点之间建立的用来传输VPN数据的虚拟连接。</p> 
<p>隧道是构建VPN不可或缺的部分，用于把VPN数据从一个VPN节点透明传送到另一个上。</p> 
<p><strong>隧道通过隧道协议实现</strong></p> 
<p>目前已存在不少隧道协议，如GRE（Generic Routing Encapsulation）、L2TP（Layer 2 Tunneling Protocol）等。</p> 
<p>隧道协议通过在隧道的一端给数据加上隧道协议头，即进行封装，使这些被封装的数据能都在某网络中传输，并且在隧道的另一端去掉该数据携带的隧道协议头，即进行解封装。</p> 
<p>报文在隧道中传输前后都要通过封装和解封装两个过程。</p> 
<p>部分隧道可以混合使用，如GRE Over IPSec隧道。</p> 
<h3><a id="3VPN_49"></a>3.VPN关键技术：身份认证、数据加密与验证</h3> 
<p>身份认证、数据加密和认证技术可以有效保证VPN网络与数据的安全性：</p> 
<p>身份认证：<br> 可用于部署了远程接入VPN的场景，VPN网关对用户的身份进行认证，保证接入网络的都是合法用户而非恶意用户。也可以用于VPN网关之间对对方身份的认证。</p> 
<p>数据加密：<br> 将明文通过加密变成密文，使得数据即使被黑客截获，黑客也无法获取其中的信息。</p> 
<p>数据验证：<br> 通过数据验证技术对报文的完整性和真伪进行检查，丢弃被伪造和被篡改的报文。</p> 
<h3><a id="4VPNIPSec_69"></a>4.常见VPN技术—IPSec</h3> 
<h4><a id="1_IPSec_72"></a>（1） IPSec概述</h4> 
<p>IPSec（IP Security） VPN一般部署在企业出口设备之间，通过加密与验证等方式，实现了数据来源验证、数据加密、数据完整性保证和抗重放等功能。</p> 
<p>数据来源验证：接收方验证发送方身份是否合法。<br> 数据加密：发送方对数据进行加密，以密文的形式在Internet上传送，接收方对接收的加密数据进行解密后处理或直接转发。<br> 数据完整性：接收方对接收的数据进行验证，以判定报文是否被篡改。<br> 抗重放：接收方拒绝旧的或重复的数据包，防止恶意用户通过重复发送捕获到的数据包所进行的攻击。</p> 
<h4><a id="2_IPSec_82"></a>（2） IPSec协议体系</h4> 
<p>IPSec不是一个单独的协议，它给出了IP网络上数据安全的一整套体系结构，包括AH（Authentication Header）、ESP（Encapsulating Security Payload）、IKE（Internet Key Exchange）等协议。</p> 
<p>IPSec使用认证头AH（Authentication Header）和封装安全载荷ESP（Encapsulating Security Payload）两种安全协议来传输和封装数据，提供认证或加密等安全服务。</p> 
<p>AH和ESP协议提供的安全功能依赖于协议采用的验证、加密算法。<br> AH仅支持认证功能，不支持加密功能。ESP支持认证和加密功能。<br> 安全协议提供认证或加密等安全服务需要有秘钥的存在。</p> 
<h4><a id="3_93"></a>（3）秘钥交换的方式有两种</h4> 
<p>带外共享密钥：<br> 在发送、接收设备上手工配置静态的加密、验证密钥。<br> 双方通过带外共享的方式（例如通过电话或邮件方式）保证密钥一致性。<br> 这种方式的缺点是可扩展性差，在点到多点组网中配置密钥的工作量成倍增加。<br> 另外，为提升网络安全性需要周期性修改密钥，这种方式下也很难实施。</p> 
<p>通过IKE协议自动协商密钥：<br> IKE建立在Internet安全联盟和密钥管理协议ISAKMP定义的框架上，采用DH（Diffie-Hellman）算法在不安全的网络上安全地分发密钥。</p> 
<p>这种方式配置简单，可扩展性好，特别是在大型动态的网络环境下此优点更加突出。</p> 
<p>同时，通信双方通过交换密钥交换材料来计算共享的密钥，即使第三方截获了双方用于计算密钥的所有交换数据，也无法计算出真正的密钥。</p> 
<h3><a id="vmkvm_111"></a>在vm中安装kvm的虚拟机测试实现</h3> 
<table><thead><tr><th>外网ip</th><th>内网ip</th></tr></thead><tbody><tr><td>192.168.121.159</td><td>192.168.122.167</td></tr></tbody></table> 
<p>开始测试实验<br> <img src="https://images2.imgbox.com/45/2a/3x6r7yjk_o.png" alt="在这里插入图片描述"><br> 首先准备好epel源，可以从阿里源下载，我的就是从阿里源下来的epel源</p> 
<pre><code class="prism language-bash"><span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo
</code></pre> 
<p>配置好安装源以后，先清理yum缓存，再重新制作缓存</p> 
<pre><code class="prism language-bash"><span class="token comment">#重新制作yum缓存</span>
yum clean all
yum makecache
</code></pre> 
<p>然后安装openvpn和制作证书工具</p> 
<pre><code class="prism language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> openvpn
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> easy-rsa
</code></pre> 
<p>然后复制服务端配置文件，这里需要注意一下openvpen的版本，因为yum源不同的话可能版本不同<br> 版本差别一般不大，就是复制的时候目录名称记得改变</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 ~<span class="token punctuation">]</span><span class="token comment"># cp /usr/share/doc/openvpn-2.4.12/sample/sample-config-files/server.conf /etc/openvpn/</span>
</code></pre> 
<p>然后复制证书签发的相关文件</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 ~<span class="token punctuation">]</span><span class="token comment"># cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server</span>
</code></pre> 
<p>准备服务端签发证书相关变量的配置文件</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 ~<span class="token punctuation">]</span><span class="token comment"># cp /usr/share/doc/easy-rsa-3.0.8/vars.example /etc/openvpn/easy-rsa-server/3/vars</span>
</code></pre> 
<p>初始化服务端PKI生成PKI相关目录和文件</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/openvpn/easy-rsa-server/3</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># ./easyrsa init-pki</span>
</code></pre> 
<p>创建CA证书</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># ./easyrsa build-ca nopass</span>
</code></pre> 
<p>生成服务端证书</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># ./easyrsa gen-req server nopass</span>
</code></pre> 
<p>签发服务端证书</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># ./easyrsa sign server server</span>
</code></pre> 
<p>创建 Diffie-Hellman 密钥（Diffie-Hellman是一种密钥交换协议，用于在公开信道上安全地共享密钥）</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># ./easyrsa gen-dh</span>
</code></pre> 
<p>编写服务端的配置文件</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/openvpn/server.conf &lt;&lt;EOF</span>
port <span class="token number">1194</span>
proto tcp
dev tun
ca  /etc/openvpn/certs/ca.crt
cert  /etc/openvpn/certs/server.crt
key  /etc/openvpn/certs/server.key  <span class="token comment"># This file should be kept secret</span>
dh  /etc/openvpn/certs/dh.pem
server <span class="token number">10.8</span>.0.0 <span class="token number">255.255</span>.255.0
push <span class="token string">"route 192.168.122.0 255.255.255.0"</span>  <span class="token comment">#内网网段</span>
keepalive <span class="token number">10</span> <span class="token number">120</span>
cipher AES-256-CBC
compress lz4-v2
push <span class="token string">"compress lz4-v2"</span>
max-clients <span class="token number">2048</span>
user openvpn
group openvpn
status  /var/log/openvpn/openvpn-status.log
log-append   /var/log/openvpn/openvpn.log
verb <span class="token number">3</span>
mute <span class="token number">20</span>
EOF
</code></pre> 
<p>配置防火墙转发规则</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># echo net.ipv4.ip_forward = 1 &gt;&gt; /etc/sysctl.conf</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># sysctl -p</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># yum install iptables-services -y</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># systemctl disable --now firewalld</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># systemctl start iptables</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># iptables -F</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># iptables -vnL -t nat</span>
</code></pre> 
<p>创建日志存放目录</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># mkdir -p /var/log/openvpn</span>
</code></pre> 
<p>拷贝相关证书认证文件</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># mkdir -p /etc/openvpn/certs</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># cp /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># cp /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># cp /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># cp /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/</span>

</code></pre> 
<p>启动openvpn看下情况，是否能启动</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># systemctl enable --now openvpn@server</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># systemctl restart openvpn@server</span>
</code></pre> 
<p>到此服务端的配置完毕，能够启动并看到1194端口启动就是没有问题<br> <img src="https://images2.imgbox.com/3b/d0/T3qHQyIf_o.png" alt="在这里插入图片描述"><br> 然后到客户端的配置，跟上面步骤差不多<br> 先创建客户端证书环境做准备</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># cp /usr/share/doc/easy-rsa-3.0.8/vars.example /etc/openvpn/easy-rsa-client/3/varsa</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># cd /etc/openvpn/easy-rsa-client/3</span>
</code></pre> 
<p>初始化pki证书目录</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># ./easyrsa init-pki</span>
</code></pre> 
<p>生成客户端证书</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># ./easyrsa gen-req yiyezhiqiu nopass</span>
</code></pre> 
<p>然后将客户端证书同步到服务端</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># cd /etc/openvpn/easy-rsa-server/3</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/yiyezhiqiu.req yiyezhiqiu</span>
</code></pre> 
<p>查看客户端信息</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># ll pki/reqs/yiyezhiqiu.req /etc/openvpn/easy-rsa-client/3/pki/reqs/yiyezhiqiu.req </span>
-rw------- <span class="token number">1</span> root root <span class="token number">887</span> Feb  <span class="token number">6</span> <span class="token number">16</span>:04 /etc/openvpn/easy-rsa-client/3/pki/reqs/yiyezhiqiu.req
-rw------- <span class="token number">1</span> root root <span class="token number">887</span> Feb  <span class="token number">6</span> <span class="token number">16</span>:04 pki/reqs/yiyezhiqiu.req

</code></pre> 
<p>然后签发客户端证书</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># ./easyrsa sign client yiyezhiqiu</span>
</code></pre> 
<p>创建客户端配置文件目录</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># mkdir -p /etc/openvpn/client/yiyezhiqiu</span>
<span class="token punctuation">[</span>root@server159 <span class="token number">3</span><span class="token punctuation">]</span><span class="token comment"># cd /etc/openvpn/client/yiyezhiqiu</span>
</code></pre> 
<p>创建客户端配置文件</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 yiyezhiqiu<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/openvpn/client/yiyezhiqiu/yiyezhiqiu.ovpn &lt;&lt;EOF</span>
client
dev tun
proto tcp
remote <span class="token number">192.168</span>.121.159 <span class="token number">1194</span> <span class="token comment"># 外网ip，在云服务上是EIP</span>
resolv-retry infinite
nobind
ca ca.crt
cert yiyezhiqiu.crt
key yiyezhiqiu.key
remote-cert-tls server
cipher AES-256-CBC
verb <span class="token number">3</span>
compress lz4-v2
EOF
</code></pre> 
<p>将认证文件拷贝到客户端目录下</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 yiyezhiqiu<span class="token punctuation">]</span><span class="token comment"># cp /etc/openvpn/easy-rsa-client/3/pki/private/yiyezhiqiu.key .</span>
<span class="token punctuation">[</span>root@server159 yiyezhiqiu<span class="token punctuation">]</span><span class="token comment"># cp /etc/openvpn/easy-rsa-server/3/pki/issued/yiyezhiqiu.crt .</span>
<span class="token punctuation">[</span>root@server159 yiyezhiqiu<span class="token punctuation">]</span><span class="token comment"># cp /etc/openvpn/easy-rsa-server/3/pki/ca.crt .</span>
</code></pre> 
<p>然后客户端配置文件就配置好了<br> 现在重启openvpn，看看是否启动成功，端口是否起来</p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server159 yiyezhiqiu<span class="token punctuation">]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token punctuation">[</span>root@server159 yiyezhiqiu<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now openvpn@server</span>
<span class="token punctuation">[</span>root@server159 yiyezhiqiu<span class="token punctuation">]</span><span class="token comment"># systemctl restart openvpn@server</span>
</code></pre> 
<p>然后到window上的设置<br> 创建一个openvpn目录存放认证文件<br> <img src="https://images2.imgbox.com/0e/1a/ngaYd8fY_o.png" alt="在这里插入图片描述"><br> 然后安装openvpn软件，在网上下载随便就可以，这个也不需要破解什么的<br> <a href="http://121.37.221.162:8080/OpenVPN-2.6.8-I001-amd64.msi" rel="nofollow">这是我用的openvpn软件，大家自行选择，链接大概会在2024年8月份过期</a><br> <img src="https://images2.imgbox.com/3e/19/uPYaQS7m_o.png" alt="在这里插入图片描述"></p> 
<p>然后点击连接vpn<br> <img src="https://images2.imgbox.com/7a/d9/9sR1oWOT_o.png" alt="在这里插入图片描述"><br> 下面这个是连接前后实验，在没有连接vpn之前ping 另一个内网网段的时候是不通的<br> 连接vpn后就可以ping通了，说明vpn隧道已经成功建立连接<br> <img src="https://images2.imgbox.com/32/db/2MS4NFKd_o.png" alt="在这里插入图片描述"><br> <strong>特别注意一下！！！</strong><br> <strong>特别注意一下！！！</strong><br> <strong>特别注意一下！！！</strong><br> 然后如果设置vpn后kvm虚拟机无法连接外网，添加一下iptable规则就可以了<br> 需要将kvm网段的转发规则设置一下<br> 如果你是按照我之前的文章来安装kvm的，那直接执行下面这条语句就可以了，注意网段和网卡名称</p> 
<pre><code class="prism language-bash">iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.122.0/24 <span class="token parameter variable">-o</span> br0 <span class="token parameter variable">-j</span> MASQUERADE
</code></pre> 
<p>如果是自己安装的，那就根据对应的设置转发规则就好了，都学习到这个程度了，大家肯定都不是小白了，按照网络问题排查网关什么的就好了</p> 
<p>实验过程大概就是这样，希望对大家理解vpn的原理有用</p> 
<h3><a id="_335"></a>下面是将上面的执行操作变为脚本</h3> 
<p>安装epel源并下载相关安装包</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#! /bin/bash</span>
<span class="token comment">#下载阿里epel源</span>
<span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo
<span class="token comment">#重新制作yEOFum缓存</span>
yum clean all
yum makecache
<span class="token comment">#然后安装openvpn和制作证书工具</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> openvpn
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> easy-rsa
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">expect</span>
</code></pre> 
<p>服务端脚本</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#! /bin/bash</span>

<span class="token comment"># 准备相关配置文件</span>
<span class="token builtin class-name">echo</span> <span class="token string">"生成服务器配置文件"</span>
<span class="token function">cp</span> /usr/share/doc/openvpn-2.4.12/sample/sample-config-files/server.conf /etc/openvpn/

<span class="token builtin class-name">echo</span> <span class="token string">"准备证书签发相关文件"</span>
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server

<span class="token builtin class-name">echo</span> <span class="token string">"准备签发证书相关变量的配置文件"</span>
<span class="token function">cp</span> /usr/share/doc/easy-rsa-3.0.8/vars.example /etc/openvpn/easy-rsa-server/3/vars


<span class="token builtin class-name">echo</span> <span class="token string">"初始化服务端PKI生成PKI相关目录和文件"</span>
<span class="token builtin class-name">cd</span> /etc/openvpn/easy-rsa-server/3
./easyrsa init-pki

<span class="token builtin class-name">echo</span> <span class="token string">"创建CA证书"</span>
<span class="token comment"># ./easyrsa build-ca nopass</span>

<span class="token function">expect</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF

spawn ./easyrsa build-ca nopass

expect {
    "Easy-RSA" {send "<span class="token entity" title="\n">\n</span>"}
}

expect eof

EOF</span>

<span class="token function">cat</span> pki/serial 

<span class="token builtin class-name">echo</span> <span class="token string">"生成服务端证书"</span>
<span class="token comment"># ./easyrsa gen-req server nopass</span>

<span class="token function">expect</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF
spawn ./easyrsa gen-req server nopass 

expect {
    "server" {send "<span class="token entity" title="\n">\n</span>"}
}
expect eof
EOF</span>


<span class="token builtin class-name">echo</span> <span class="token string">"签发服务端证书"</span>
<span class="token comment"># ./easyrsa sign server server</span>

<span class="token function">expect</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF
spawn ./easyrsa sign server server 

expect {
    "*details:" {send "yes<span class="token entity" title="\n">\n</span>"}
}
expect eof
EOF</span>

<span class="token builtin class-name">echo</span> <span class="token string">"创建 Diffie-Hellman 密钥"</span>
./easyrsa gen-dh

<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/openvpn/server.conf <span class="token operator">&lt;&lt;</span><span class="token string">EOF
port 1194
proto tcp
dev tun
ca  /etc/openvpn/certs/ca.crt
cert  /etc/openvpn/certs/server.crt
key  /etc/openvpn/certs/server.key  # This file should be kept secret
dh  /etc/openvpn/certs/dh.pem
server 10.8.0.0 255.255.255.0
push "route 192.168.122.0 255.255.255.0"
keepalive 10 120
cipher AES-256-CBC
compress lz4-v2
push "compress lz4-v2"
max-clients 2048
user openvpn
group openvpn
status  /var/log/openvpn/openvpn-status.log
log-append   /var/log/openvpn/openvpn.log
verb 3
mute 20
EOF</span>

<span class="token builtin class-name">echo</span> <span class="token string">"添加防火墙"</span>
<span class="token builtin class-name">echo</span> net.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf
<span class="token function">sysctl</span> <span class="token parameter variable">-p</span>
yum <span class="token function">install</span> iptables-services <span class="token parameter variable">-y</span>
systemctl disable <span class="token parameter variable">--now</span> firewalld
systemctl start iptables
iptables <span class="token parameter variable">-F</span>
iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> <span class="token number">10.8</span>.0.0/24 <span class="token parameter variable">-j</span> MASQUERADE
iptables <span class="token parameter variable">-vnL</span> <span class="token parameter variable">-t</span> nat

<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /var/log/openvpn

<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/openvpn/certs
<span class="token function">cp</span> /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt /etc/openvpn/certs/
<span class="token function">cp</span> /etc/openvpn/easy-rsa-server/3/pki/private/server.key /etc/openvpn/certs/
<span class="token function">cp</span> /etc/openvpn/easy-rsa-server/3/pki/ca.crt /etc/openvpn/certs/
<span class="token function">cp</span> /etc/openvpn/easy-rsa-server/3/pki/dh.pem /etc/openvpn/certs/

<span class="token builtin class-name">echo</span> <span class="token string">"重启OpenVpn"</span>
systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> openvpn@server
systemctl restart openvpn@server

</code></pre> 
<p>客户端脚本<br> 这里需要你依次输入自己定义的名字和ip</p> 
<pre><code class="prism language-bash"><span class="token shebang important">#! /bin/bash</span>

<span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"请输入用户的姓名拼音(如:<span class="token variable">${NAME}</span>): "</span> NAME
<span class="token builtin class-name">read</span> <span class="token parameter variable">-p</span> <span class="token string">"请输入VPN服务端的公网IP(如:<span class="token variable">${IP}</span>): "</span> IP

<span class="token builtin class-name">echo</span> <span class="token string">"客户端证书环境"</span>
<span class="token function">cp</span> <span class="token parameter variable">-r</span> /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client
<span class="token function">cp</span> /usr/share/doc/easy-rsa-3.0.8/vars.example /etc/openvpn/easy-rsa-client/3/varsa
<span class="token builtin class-name">cd</span> /etc/openvpn/easy-rsa-client/3

<span class="token builtin class-name">echo</span> <span class="token string">"初始化pki证书目录"</span>
<span class="token comment"># ./easyrsa init-pki</span>

<span class="token function">expect</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
spawn ./easyrsa init-pki 
expect {
    "removal" {send "yes<span class="token entity" title="\n">\n</span>"}
}
expect eof
EOF</span>

<span class="token builtin class-name">echo</span> <span class="token string">"生成客户端证书"</span>
<span class="token comment"># ./easyrsa gen-req ${NAME} nopass</span>

<span class="token function">expect</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
spawn ./easyrsa gen-req <span class="token variable">${NAME}</span> nopass 

expect {
    "<span class="token variable">${NAME}</span>" {send "<span class="token entity" title="\n">\n</span>"}
}

expect eof
EOF</span>

<span class="token builtin class-name">echo</span> <span class="token string">"将客户端证书同步到服务端"</span>
<span class="token builtin class-name">cd</span> /etc/openvpn/easy-rsa-server/3
./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="token variable">${NAME}</span>.req <span class="token variable">${NAME}</span>

<span class="token builtin class-name">echo</span> <span class="token string">"查看客户端证书"</span>
ll pki/reqs/<span class="token variable">${NAME}</span>.req /etc/openvpn/easy-rsa-client/3/pki/reqs/<span class="token variable">${NAME}</span>.req 

<span class="token builtin class-name">echo</span> <span class="token string">"签发客户端证书,请输入：yes"</span>
<span class="token comment"># ./easyrsa sign client ${NAME}</span>

<span class="token function">expect</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
spawn ./easyrsa sign client <span class="token variable">${NAME}</span> 

expect {    
	"*details" {send "yes<span class="token entity" title="\n">\n</span>"}
}

expect eof
EOF</span>

<span class="token builtin class-name">echo</span> <span class="token string">"查看证书"</span>
<span class="token function">cat</span> pki/index.txt
ll pki/certs_by_serial/
<span class="token function">cat</span> pki/issued/<span class="token variable">${NAME}</span>.crt 

<span class="token builtin class-name">echo</span> <span class="token string">"创建客户端配置文件"</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/openvpn/client/<span class="token variable">${NAME}</span>
<span class="token builtin class-name">cd</span> /etc/openvpn/client/<span class="token variable">${NAME}</span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/openvpn/client/<span class="token variable">${NAME}</span>/<span class="token variable">${NAME}</span>.ovpn <span class="token operator">&lt;&lt;</span><span class="token string">EOF
client
dev tun
proto tcp
remote <span class="token variable">${IP}</span> 1194
resolv-retry infinite
nobind
ca ca.crt
cert <span class="token variable">${NAME}</span>.crt
key <span class="token variable">${NAME}</span>.key
remote-cert-tls server
cipher AES-256-CBC
verb 3
compress lz4-v2
EOF</span>

<span class="token function">cp</span> /etc/openvpn/easy-rsa-client/3/pki/private/<span class="token variable">${NAME}</span>.key <span class="token builtin class-name">.</span>
<span class="token function">cp</span> /etc/openvpn/easy-rsa-server/3/pki/issued/<span class="token variable">${NAME}</span>.crt <span class="token builtin class-name">.</span>
<span class="token function">cp</span> /etc/openvpn/easy-rsa-server/3/pki/ca.crt <span class="token builtin class-name">.</span>

<span class="token builtin class-name">echo</span> <span class="token string">"打包用户证书"</span>
<span class="token function">tar</span> <span class="token parameter variable">-czvf</span> <span class="token variable">${NAME}</span>.tar.gz ./

<span class="token builtin class-name">echo</span> <span class="token string">"重启OpenVpn"</span>
systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> openvpn@server
systemctl restart openvpn@server

</code></pre> 
<p>然后如果设置vpn后kvm虚拟机无法连接外网，添加一下iptable规则就可以了<br> 需要将kvm网段的转发规则设置一下<br> 如果你是按照我之前的文章来安装kvm的，那直接执行下面这条语句就可以了，注意网段和网卡名称</p> 
<pre><code class="prism language-bash">iptables <span class="token parameter variable">-t</span> nat <span class="token parameter variable">-A</span> POSTROUTING <span class="token parameter variable">-s</span> <span class="token number">192.168</span>.122.0/24 <span class="token parameter variable">-o</span> br0 <span class="token parameter variable">-j</span> MASQUERADE
</code></pre> 
<p>如果是自己安装的，那就根据对应的设置转发规则就好了，都学习到这个程度了，大家肯定都不是小白了，按照网络问题排查就好了<br> 有参考一写其他人的文章，如有侵权请及时告知删除</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d413da33bec35e363943711bf0f67d24/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python 中实现优雅的 switch 操作的几种方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cf4d33763df418873d22e4087437c53f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title"># java实现学生管理系统（GUI和数据库）（思路与功能详解，文末附上源码链接）（实现了学生、课程和账号三张表）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>