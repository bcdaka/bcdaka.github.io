<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Stable Diffusion XL之使用Stable Diffusion XL训练自己的AI绘画模型 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/ba2194228bc50b49f6d060571c1a5f63/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Stable Diffusion XL之使用Stable Diffusion XL训练自己的AI绘画模型">
  <meta property="og:description" content="文章目录 一 SDXL训练基本步骤二 从0到1上手使用Stable Diffusion XL训练自己的AI绘画模型2.1 配置训练环境与训练文件2.2 SDXL训练数据集制作(1) 数据筛选与清洗(2) 使用BLIP自动标注caption(3) 使用Waifu Diffusion 1.4自动标注tag(4) 补充标注特殊tag(5) 训练数据预处理(标注文件整合) 2.3 SDXL微调（finetune）训练(1 )SDXL 微调数据集要求(2) SDXL 微调训练参数配置2.1 训练参数配置(XL_config文件夹)2.1.1 config_file.toml2.1.2 sample_prompt.toml (3) SDXL关键参数详解(4) SDXL模型开始训练 2.4 基于SDXL训练LoRA模型(1) SDXL LoRA数据集制作(2) SDXL LoRA训练参数配置2.1 训练参数讲解(XL_LoRA_config文件夹)2.1.1 config_file.toml (3) SDXL LoRA关键参数详解(4) SDXL LoRA模型训练 一 SDXL训练基本步骤 Stable Diffusion XL系列模型的训练过程主要分成以下几个步骤，
训练集制作：数据质量评估，标签梳理，数据清洗，数据标注，标签清洗，数据增强等。训练文件配置：预训练模型选择，训练环境配置，训练步数设置，其他超参数设置等。模型训练：运行SDXL模型/LoRA模型训练脚本，使用TensorBoard监控模型训练等。模型测试：将训练好的自训练SDXL模型/LoRA模型用于效果评估与消融实验 二 从0到1上手使用Stable Diffusion XL训练自己的AI绘画模型 下面是SDXL的训练资源
链接：https://pan.quark.cn/s/5664c0de758d
提取码：LRZV
2.1 配置训练环境与训练文件 1. 首先进入SDXL-Train项目中，安装SDXL训练所需的依赖库
cd SDXL-Train pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple some-package # accelerate库的版本需要重新检查一遍，需要安装accelerate==0.16.0版本才能兼容SDXL的训练 pip install accelerate==0.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-29T15:58:31+08:00">
    <meta property="article:modified_time" content="2024-03-29T15:58:31+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Stable Diffusion XL之使用Stable Diffusion XL训练自己的AI绘画模型</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_SDXL_1" rel="nofollow">一 SDXL训练基本步骤</a></li><li><a href="#_01Stable_Diffusion_XLAI_8" rel="nofollow">二 从0到1上手使用Stable Diffusion XL训练自己的AI绘画模型</a></li><li><ul><li><a href="#21__12" rel="nofollow">2.1 配置训练环境与训练文件</a></li><li><a href="#22_SDXL_89" rel="nofollow">2.2 SDXL训练数据集制作</a></li><li><ul><li><a href="#1__90" rel="nofollow">(1) 数据筛选与清洗</a></li><li><a href="#2_BLIPcaption_104" rel="nofollow">(2) 使用BLIP自动标注caption</a></li><li><a href="#3_Waifu_Diffusion_14tag_124" rel="nofollow">(3) 使用Waifu Diffusion 1.4自动标注tag</a></li><li><a href="#4_tag_152" rel="nofollow">(4) 补充标注特殊tag</a></li><li><a href="#5__253" rel="nofollow">(5) 训练数据预处理(标注文件整合)</a></li></ul> 
   </li><li><a href="#23_SDXLfinetune_284" rel="nofollow">2.3 SDXL微调（finetune）训练</a></li><li><ul><li><a href="#1_SDXL__285" rel="nofollow">(1 )SDXL 微调数据集要求</a></li><li><a href="#2_SDXL__294" rel="nofollow">(2) SDXL 微调训练参数配置</a></li><li><ul><li><a href="#21_XL_config_299" rel="nofollow">2.1 训练参数配置(XL_config文件夹)</a></li><li><ul><li><a href="#211_config_filetoml_302" rel="nofollow">2.1.1 config_file.toml</a></li><li><a href="#212_sample_prompttoml_420" rel="nofollow">2.1.2 sample_prompt.toml</a></li></ul> 
    </li></ul> 
    </li><li><a href="#3_SDXL_432" rel="nofollow">(3) SDXL关键参数详解</a></li><li><a href="#4_SDXL_466" rel="nofollow">(4) SDXL模型开始训练</a></li></ul> 
   </li><li><a href="#24_SDXLLoRA_470" rel="nofollow">2.4 基于SDXL训练LoRA模型</a></li><li><ul><li><a href="#1_SDXL_LoRA_472" rel="nofollow">(1) SDXL LoRA数据集制作</a></li><li><a href="#2_SDXL_LoRA_487" rel="nofollow">(2) SDXL LoRA训练参数配置</a></li><li><ul><li><a href="#21_XL_LoRA_config_495" rel="nofollow">2.1 训练参数讲解(XL_LoRA_config文件夹)</a></li><li><ul><li><a href="#211_config_filetoml_496" rel="nofollow">2.1.1 config_file.toml</a></li></ul> 
    </li></ul> 
    </li><li><a href="#3_SDXL_LoRA_611" rel="nofollow">(3) SDXL LoRA关键参数详解</a></li><li><a href="#4_SDXL_LoRA_639" rel="nofollow">(4) SDXL LoRA模型训练</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_SDXL_1"></a>一 SDXL训练基本步骤</h2> 
<p>Stable Diffusion XL系列模型的训练过程主要分成以下几个步骤，</p> 
<ol><li>训练集制作：数据质量评估，标签梳理，数据清洗，数据标注，标签清洗，数据增强等。</li><li>训练文件配置：预训练模型选择，训练环境配置，训练步数设置，其他超参数设置等。</li><li>模型训练：运行SDXL模型/LoRA模型训练脚本，使用TensorBoard监控模型训练等。</li><li>模型测试：将训练好的自训练SDXL模型/LoRA模型用于效果评估与消融实验</li></ol> 
<h2><a id="_01Stable_Diffusion_XLAI_8"></a>二 从0到1上手使用Stable Diffusion XL训练自己的AI绘画模型</h2> 
<p>下面是SDXL的训练资源<br> 链接：<a href="https://pan.quark.cn/s/5664c0de758d" rel="nofollow">https://pan.quark.cn/s/5664c0de758d</a><br> 提取码：LRZV</p> 
<h3><a id="21__12"></a>2.1 配置训练环境与训练文件</h3> 
<p><strong>1. 首先进入SDXL-Train项目中，安装SDXL训练所需的依赖库</strong></p> 
<pre><code>cd SDXL-Train
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple some-package

# accelerate库的版本需要重新检查一遍，需要安装accelerate==0.16.0版本才能兼容SDXL的训练
pip install accelerate==0.16.0 -i https://pypi.tuna.tsinghua.edu.cn/simple some-package

# 这里推荐大家安装2.0.1版本的Pytorch，能够兼容SDXL训练的全部流程
pip install torch==2.0.1 torchvision==0.15.2 torchaudio==2.0.2 --index-url https://download.pytorch.org/whl/cu118
或者conda
conda install pytorch==2.0.1 torchvision==0.15.2 torchaudio==2.0.2 pytorch-cuda=11.8 -c pytorch -c nvidia
</code></pre> 
<p>在完成上述的依赖库安装后，我们需要确认一下目前的Python、PyTroch、CUDA以及cuDNN的版本是否兼容，在命令行输入以下命令：</p> 
<blockquote> 
 <p># Python版本推荐3.8或者3.9，两个版本皆可<br> &gt;&gt;&gt;python<br> Python 3.9<br> # 加载PyTroch<br> &gt;&gt;&gt;import torch<br> # 查看PyTorch版本<br> &gt;&gt;&gt;print(torch.<strong>version</strong>)<br> 2.0.1<br> # 查看CUDA版本<br> &gt;&gt;&gt; print(torch.version.cuda)<br> 11.8<br> # 查看cuDNN版本<br> &gt;&gt;&gt; print(torch.backends.cudnn.version())<br> 8500<br> # 查看PyTroch、CUDA以及cuDNN的版本是否兼容，True代表兼容<br> &gt;&gt;&gt; print(torch.cuda.is_available())<br> True</p> 
</blockquote> 
<ol start="2"><li>安装和验证好所有SDXL训练所需的依赖库后，我们还需要<strong>设置一下SDXL的训练环境</strong>，我们主要是用accelerate库的能力，accelerate库能让PyTorch的训练和推理变得更加高效简洁。我们只需在命令行输入以下命令，并对每个设置逐一进行填写即可：</li></ol> 
<pre><code class="prism language-python"><span class="token comment"># 输入以下命令，开始对每个设置进行填写</span>
accelerate config

<span class="token comment"># 开始进行训练环境参数的配置</span>
In which compute environment are you running? <span class="token comment"># 选择This machine，即本机</span>
This machine

<span class="token comment"># 选择单卡或是多卡训练，如果是多卡，则选择multi-GPU，若是单卡，则选择No distributed training                                                                                                               </span>
Which <span class="token builtin">type</span> of machine are you using?                                                                                        
multi<span class="token operator">-</span>GPU

<span class="token comment"># 几台机器用于训练，一般选择1台。注意这里是指几台机器，不是几张GPU卡                                                                                                                  </span>
How many different machines will you use <span class="token punctuation">(</span>use more than <span class="token number">1</span> <span class="token keyword">for</span> multi<span class="token operator">-</span>node training<span class="token punctuation">)</span>? <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token comment"># torch dynamo，DeepSpeed，FullyShardedDataParallel，Megatron-LM等环境参数，不需要配置                          </span>
Do you wish to optimize your script <span class="token keyword">with</span> torch dynamo?<span class="token punctuation">[</span>yes<span class="token operator">/</span>NO<span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token comment"># 输入回车即可                                                           </span>
Do you want to use DeepSpeed? <span class="token punctuation">[</span>yes<span class="token operator">/</span>NO<span class="token punctuation">]</span><span class="token punctuation">:</span>  <span class="token comment"># 输入回车即可                                                                                  </span>
Do you want to use FullyShardedDataParallel? <span class="token punctuation">[</span>yes<span class="token operator">/</span>NO<span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token comment"># 输入回车即可                                                                 </span>
Do you want to use Megatron<span class="token operator">-</span>LM ? <span class="token punctuation">[</span>yes<span class="token operator">/</span>NO<span class="token punctuation">]</span><span class="token punctuation">:</span>       <span class="token comment"># 输入回车即可</span>

<span class="token comment"># 选择多少张卡投入训练                                                                          </span>
How many GPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span> should be used <span class="token keyword">for</span> distributed training? <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">2</span>

<span class="token comment"># 设置投入训练的GPU卡id，如果是全部的GPU都投入训练，则输入all即可。</span>
What GPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">(</span>by <span class="token builtin">id</span><span class="token punctuation">)</span> should be used <span class="token keyword">for</span> training on this machine <span class="token keyword">as</span> a comma<span class="token operator">-</span>seperated <span class="token builtin">list</span>? <span class="token punctuation">[</span><span class="token builtin">all</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token builtin">all</span> 

<span class="token comment"># 训练精度，可以选择fp16</span>
Do you wish to use FP16 <span class="token keyword">or</span> BF16 <span class="token punctuation">(</span>mixed precision<span class="token punctuation">)</span>? 
fp16                             

<span class="token comment"># 完成配置后，配置文件default_config.yaml会保存在/root/.cache/huggingface/accelerate下                                                                                   </span>
accelerate configuration saved at <span class="token operator">/</span>root<span class="token operator">/</span><span class="token punctuation">.</span>cache<span class="token operator">/</span>huggingface<span class="token operator">/</span>accelerate<span class="token operator">/</span>default_config<span class="token punctuation">.</span>yaml完成上述的流程后，接下来我们就可以进行SDXL训练数据的制作和训练脚本的配置流程了！
</code></pre> 
<p>后续进行SDXL与SDXL LoRA模型训练的时候，只需要加载对应的default_config.yaml配置文件即可，具体的调用方法，本文后续的章节会进行详细讲解。</p> 
<p>还有一点需要注意的是，我们进行SDXL模型的训练时，<strong>SDXL的CLIP Text Encoder会调用CLIP-ViT-bigG-14-laion2B-39B-b160k和clip-vit-large-patch14两个配置文件</strong>。一般情况下SDXL模型会从huggingface上将配置文件下载到~/.cache/huggingface/目录中，但是由于网络原因很可能会下载失败，从而导致训练的失败。</p> 
<p>所以为了让大家能更方便的训练SDXL模型，已经将CLIP-ViT-bigG-14-laion2B-39B-b160k和clip-vit-large-patch14这两个配置文件放入<strong>SDXL-Train项目的utils_json文件夹中</strong>，并且已经为大家配置好依赖路径，<strong>大家只要使用SDXL-Train项目便无需做任何修改</strong>。如果大家想要修改CLIP-ViT-bigG-14-laion2B-39B-b160k和clip-vit-large-patch14这两个依赖文件夹的调用路径，大家可以找到SDXL-Train/library/sdxl_train_util.py脚本中的第122行，将"utils_json/"部分修改成自己的本地自定义路径比如“/本地路径/utils_json/”即可。</p> 
<p>完成上述的流程后，接下来我们就可以进行SDXL训练数据的制作和训练脚本的配置流程了！</p> 
<h3><a id="22_SDXL_89"></a>2.2 SDXL训练数据集制作</h3> 
<h4><a id="1__90"></a>(1) 数据筛选与清洗</h4> 
<p>首先，我们需要对数据集进行清洗，和传统深度学习时代一样，数据清洗工作依然占据了AIGC时代模型训练70%-80%左右的时间。</p> 
<p>并且这个过程必不可少，因为数据质量决定了机器学习性能的上限，而算法和模型只是在不断逼近这个上限而已。</p> 
<ul><li> <p>我们需要筛除分辨率较低、质量较差（比如说768*768分辨率的图片&lt; 100kb）、存在破损以及和任务目标无关的数据，接着再去除数据里面可能包含的水印，干扰文字等污染特征。</p> </li><li> <p>同时，我们需要优先保证数据集的质量，在有质量的基础上再去增加数据集的数量与丰富度。</p> </li><li> <p>为了满足AI绘画生成图片时的尺寸适应度，我们可以对数据进行多尺度的增强，比如进行1:1，1:2，2:1，1:3，3:4，4:3，9:16，16:9等等尺寸的裁剪与缩放操作。但是切记不能在多尺度增强的时候将图片的主体特征裁剪掉（比如人脸，建筑等）。</p> </li></ul> 
<p>完成上述的数据筛选与清洗工作后，我们就可以开始进行数据标注了。</p> 
<p>数据标注可以分为<strong>自动标注和手动标注</strong>。自动标注主要依赖像BLIP（img2caption）和Waifu Diffusion 1.4（img2tag）等能够进行图片生成标签的模型，手动标注则依赖标注人员。</p> 
<h4><a id="2_BLIPcaption_104"></a>(2) 使用BLIP自动标注caption</h4> 
<p>我们先用<strong>BLIP对数据进行自动标注</strong>，BLIP输出的是自然语言标签，我们进入到SDXL-Train/finetune/路径下，运行以下代码即可获得自然语言标签（caption标签）：</p> 
<pre><code>cd SDXL-Train/finetune/
python make_captions.py "/数据路径" --caption_weights “../BLIP/model_large_caption.pth” --batch_size=8 --beam_search --min_length=5 --max_length=75 --debug --caption_extension=".caption" --max_data_loader_n_workers=2
</code></pre> 
<p>注意：在使用BLIP进行数据标注时需要依赖bert-base-uncased模型，已经帮大家配置好了，大家只要使用SDXL-Train项目便无需做任何修改。同时，如果大家想要修改bert-base-uncased模型的调用路径，可以找到SDXL-Train/finetune/blip/blip.py脚本的第189行，将“…/bert-base-uncased”部分修改成自己的本地自定义路径比如“/本地路径/bert-base-uncased”即可。</p> 
<p>从上面的代码可以看到，我们第一个传入的参数是训练集的路径。下面一一向大家介绍一下其余参数的意义：</p> 
<pre><code>--caption_weights：表示加载的本地BLIP模型，如果不传入本地模型路径，则默认从云端下载BLIP模型。
--batch_size：表示每次传入BLIP模型进行前向处理的数据数量。
--beam_search：设置为波束搜索，默认Nucleus采样。
--min_length：设置caption标签的最短长度。
--max_length：设置caption标签的最长长度。
--debug：如果设置，将会在BLIP前向处理过程中，打印所有的图片路径与caption标签内容，以供检查。
--caption_extension：设置caption标签的扩展名，一般为".caption"。
--max_data_loader_n_workers：设置大于等于2，加速数据处理。
</code></pre> 
<h4><a id="3_Waifu_Diffusion_14tag_124"></a>(3) 使用Waifu Diffusion 1.4自动标注tag</h4> 
<p>接下来我们可以使用Waifu Diffusion 1.4进行自动标注，Waifu Diffusion 1.4输出的是tag关键词，这里需要注意的是，调用Waifu Diffusion 1.4模型需要安装Tensorflow库，并且需要下载特定的版本（2.10.1）或者(2.10.0)，不然运行时会报“DNN library is not found“错误。我们只需要在命令行输入以下命令即可：<br> 如果是2.10.1建议不适用国内源，可能更新不完全，会报错，2.10.0可以使用国内源。</p> 
<pre><code>pip install tensorflow==2.10.1
</code></pre> 
<p>或者</p> 
<pre><code>pip install tensorflow==2.10.0 -i https://pypi.tuna.tsinghua.edu.cn/simple some-package
</code></pre> 
<p>完成上述的环境配置后，我们依然进入到SDXL-Trian/finetune/路径下，运行以下代码即可获得tag自动标注：</p> 
<pre><code>cd SDXL-Train/finetune/
python tag_images_by_wd14_tagger.py "/数据路径" --batch_size=8 --model_dir="../tag_models/wd-v1-4-moat-tagger-v2" --remove_underscore --general_threshold=0.35 --character_threshold=0.35 --caption_extension=".txt" --max_data_loader_n_workers=2 --debug --undesired_tags=""
</code></pre> 
<p>从上面的代码可以看到，</p> 
<pre><code>我们第一个传入的参数是训练集的路径。
--batch_size：表示每次传入Waifu Diffusion 1.4模型进行前向处理的数据数量。
--model_dir：表示加载的本地Waifu Diffusion 1.4模型路径。
--remove_underscore：如果开启，会将输出tag关键词中的下划线替换为空格。
--general_threshold：设置常规tag关键词的筛选置信度。
--character_threshold：设置人物特征tag关键词的筛选置信度。
--caption_extension：设置tag关键词标签的扩展名，一般为".txt"。
-max_data_loader_n_workers：设置大于等于2，加速数据处理。
--debug：如果设置，将会在Waifu Diffusion 1.4模型前向处理过程中，打印所有的图片路径与tag关键词标签内容，以供检查。
--undesired_tags：设置不需要输出的tag关键词。
</code></pre> 
<h4><a id="4_tag_152"></a>(4) 补充标注特殊tag</h4> 
<p>完成了caption和tag的自动标注之后，如果我们需要训练一些特殊标注的话，还可以进行手动的补充标注。</p> 
<p>SDXL-Trian项目中也提供了对数据进行补充标注的代码，下面代码将其进行提炼总结，方便大家直接使用。</p> 
<p>大家可以直接拷贝以下的代码，并按照代码中提供的注释进行参数修改，然后运行代码即可对数据集进行补充标注：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token comment"># 设置为本地的数据集路径</span>
train_data_dir <span class="token operator">=</span> <span class="token string">"/本地数据集路径"</span>

<span class="token comment"># 设置要补充的标注类型，包括[".txt", ".caption"]</span>
extension   <span class="token operator">=</span> <span class="token string">".txt"</span> 

<span class="token comment"># 设置要补充的特殊标注</span>
custom_tag  <span class="token operator">=</span> <span class="token string">"qclineart"</span>

<span class="token comment"># 若设置sub_folder = "--all"时，将遍历所有子文件夹中的数据；默认为""。</span>
sub_folder  <span class="token operator">=</span> <span class="token string">""</span> 

<span class="token comment"># 若append设为True，则特殊标注添加到标注文件的末尾</span>
append      <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token comment"># 若设置remove_tag为True，则会删除数据集中所有的已存在的特殊标注</span>
remove_tag  <span class="token operator">=</span> <span class="token boolean">False</span>
recursive   <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token keyword">if</span> sub_folder <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>
    image_dir <span class="token operator">=</span> train_data_dir
<span class="token keyword">elif</span> sub_folder <span class="token operator">==</span> <span class="token string">"--all"</span><span class="token punctuation">:</span>
    image_dir <span class="token operator">=</span> train_data_dir
    recursive <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token keyword">elif</span> sub_folder<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"/content"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    image_dir <span class="token operator">=</span> sub_folder
<span class="token keyword">else</span><span class="token punctuation">:</span>
    image_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>train_data_dir<span class="token punctuation">,</span> sub_folder<span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>image_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 读取标注文件的函数，不需要改动</span>
<span class="token keyword">def</span> <span class="token function">read_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        contents <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> contents

<span class="token comment"># 将特殊标注写入标注文件的函数，不需要改动</span>
<span class="token keyword">def</span> <span class="token function">write_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> contents<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>contents<span class="token punctuation">)</span>

<span class="token comment"># 将特殊标注批量添加到标注文件的主函数，不需要改动</span>
<span class="token keyword">def</span> <span class="token function">process_tags</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> custom_tag<span class="token punctuation">,</span> append<span class="token punctuation">,</span> remove_tag<span class="token punctuation">)</span><span class="token punctuation">:</span>
    contents <span class="token operator">=</span> read_file<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    tags <span class="token operator">=</span> <span class="token punctuation">[</span>tag<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> tag <span class="token keyword">in</span> contents<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    custom_tags <span class="token operator">=</span> <span class="token punctuation">[</span>tag<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> tag <span class="token keyword">in</span> custom_tag<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> custom_tag <span class="token keyword">in</span> custom_tags<span class="token punctuation">:</span>
        custom_tag <span class="token operator">=</span> custom_tag<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> remove_tag<span class="token punctuation">:</span>
            <span class="token keyword">while</span> custom_tag <span class="token keyword">in</span> tags<span class="token punctuation">:</span>
                tags<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>custom_tag<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> custom_tag <span class="token keyword">not</span> <span class="token keyword">in</span> tags<span class="token punctuation">:</span>
                <span class="token keyword">if</span> append<span class="token punctuation">:</span>
                    tags<span class="token punctuation">.</span>append<span class="token punctuation">(</span>custom_tag<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    tags<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> custom_tag<span class="token punctuation">)</span>

    contents <span class="token operator">=</span> <span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>tags<span class="token punctuation">)</span>
    write_file<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> contents<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">process_directory</span><span class="token punctuation">(</span>image_dir<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> append<span class="token punctuation">,</span> remove_tag<span class="token punctuation">,</span> recursive<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> filename <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>image_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>image_dir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span>

        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token keyword">and</span> recursive<span class="token punctuation">:</span>
            process_directory<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> append<span class="token punctuation">,</span> remove_tag<span class="token punctuation">,</span> recursive<span class="token punctuation">)</span>
        <span class="token keyword">elif</span> filename<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>extension<span class="token punctuation">)</span><span class="token punctuation">:</span>
            process_tags<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> append<span class="token punctuation">,</span> remove_tag<span class="token punctuation">)</span>

tag <span class="token operator">=</span> custom_tag

<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">any</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>filename<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>extension<span class="token punctuation">)</span> <span class="token keyword">for</span> filename <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>image_dir<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> filename <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>image_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> filename<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">".png"</span><span class="token punctuation">,</span> <span class="token string">".jpg"</span><span class="token punctuation">,</span> <span class="token string">".jpeg"</span><span class="token punctuation">,</span> <span class="token string">".webp"</span><span class="token punctuation">,</span> <span class="token string">".bmp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token builtin">open</span><span class="token punctuation">(</span>
                os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>image_dir<span class="token punctuation">,</span> filename<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> extension<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"w"</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 但我们设置好要添加的custom_tag后，开始整个代码流程</span>
<span class="token keyword">if</span> custom_tag<span class="token punctuation">:</span>
    process_directory<span class="token punctuation">(</span>image_dir<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> append<span class="token punctuation">,</span> remove_tag<span class="token punctuation">,</span> recursive<span class="token punctuation">)</span>
</code></pre> 
<p>看完了上面的完整代码流程，如果大家觉得代码太复杂，don‘t worry，大家只需要复制上面的全部代码，并将train_data_dir ="/本地数据集路径"和custom_tag ="qclineart"设置成自己数据集的本地路径和想要添加的特殊标注，然后运行代码即可，非常简单实用。</p> 
<p>大家注意，<strong>一般我们会将手动补充的特殊tag放在第一位，因为和caption标签不同，tags标签是有顺序的，最开始的tag权重最大，越靠后的tag权重越小。</strong></p> 
<h4><a id="5__253"></a>(5) 训练数据预处理(标注文件整合)</h4> 
<ul><li> <p>首先，我们需要对刚才生成的后缀为.caption和.txt的标注文件进行整合，存储成一个json格式的文件，方便后续SDXL模型训练时调取训练数据与标注。</p> </li><li> <p>我们需要进入SDXL-Train项目的finetune文件夹中，运行merge_all_to_metadata.py脚本即可：</p> </li></ul> 
<pre><code>cd SDXL-Train
python ./finetune/merge_all_to_metadata.py "/本地数据路径" "/本地数据路径/meta_clean.json"
</code></pre> 
<p>运行完merge_all_to_metadata.py脚本后，我们在数据集路径中得到一个meta_clean.json文件，打开可以看到图片名称对应的tag和caption标注都封装在了文件中。</p> 
<p>在整理好标注文件的基础上，我们接下来我们需要对数据进行分桶与保存Latent特征，并在meta_clean.json的基础上，将图片的分辨率信息也存储成json格式，并保存一个新的meta_lat.json文件。</p> 
<p>我们需要进入SDXL-Train项目的finetune文件夹中，运行prepare_buckets_latents.py脚本即可：</p> 
<pre><code>cd SDXL-Train
python ./finetune/prepare_buckets_latents.py "/本地数据路径" "/本地数据路径/meta_clean.json" "/本地数据路径/meta_lat.json" "调用的SDXL模型路径" --batch_size 4 --max_resolution "1024,1024"
</code></pre> 
<p>运行完脚本，我们即可在数据集路径中获得meta_lat.json文件，其在meta_clean.json基础上封装了图片的分辨率信息，用于SDXL训练时快速进行数据分桶。</p> 
<p>图片的Latent特征保存为了.npz文件，用于SDXL模型训练时，快速读取数据的Latent特征，加速训练过程。</p> 
<p>到目前为止，我们已经完整的进行了SDXL训练所需的数据集制作与预处理流程。总结一下，我们在一张训练图片的基础上，一共获得了以下5个不同的训练配置文件：<br> meta_clean.json<br> meta_lat.json<br> 自然语言标注（.caption）<br> 关键词tag标注（.txt）<br> 数据的Latent特征信息（.npz）<br> <img src="https://images2.imgbox.com/22/b0/lyhBD5Bw_o.png" alt="在这里插入图片描述"><br> 在完成以上所有数据处理过程后，接下来我们就可以进入SDXL训练的阶段了，我们可以对SDXL进行全参微调（finetune），也可以基于SDXL训练对应的LoRA模型。</p> 
<h3><a id="23_SDXLfinetune_284"></a>2.3 SDXL微调（finetune）训练</h3> 
<h4><a id="1_SDXL__285"></a>(1 )SDXL 微调数据集要求</h4> 
<p><strong>制作过程就是上个章节的内容</strong></p> 
<p>用于SDXL全参微调的数据集筛选要求和SDXL训练Lora不一样：</p> 
<ul><li>数据尺寸需要在512x512像素以上。</li><li>数据的大小最好大于300K。</li><li>数据种类尽量丰富，不同主题，不同画风，不同概念都要充分采集。</li><li>一个特殊tag对应的图像特征在数据集中需要一致，不然在推理过程触发这个tag时可能会生成多个特征的平均。</li><li>每个数据都要符合我们的审美和评判标准！每个数据都要符合我们的审美和评判标准！每个数据都要符合我们的审美和评判标准！</li></ul> 
<h4><a id="2_SDXL__294"></a>(2) SDXL 微调训练参数配置</h4> 
<p>本节中，主要介绍<strong>Stable Diffusion XL全参微调（finetune）训练的参数配置和训练脚本。</strong></p> 
<p>大家可以在SDXL-Trian项目的train_config文件夹中找到相应的<strong>训练参数配置（XL_config文件夹）</strong>，并且可以在SDXL-Trian项目中运行<strong>SDXL_finetune.sh脚本</strong>，进行SDXL的全参微调训练。</p> 
<h5><a id="21_XL_config_299"></a>2.1 训练参数配置(XL_config文件夹)</h5> 
<p>XL_config文件夹中有两个配置文件config_file.toml和sample_prompt.toml，他们分别存储着SDXL的<strong>训练超参数</strong>与训练中的<strong>验证prompt</strong>。</p> 
<h6><a id="211_config_filetoml_302"></a>2.1.1 config_file.toml</h6> 
<p>config_file.toml的配置信息包含了sdxl_arguments，model_arguments，dataset_arguments，training_arguments，logging_arguments，sample_prompt_arguments，saving_arguments，optimizer_arguments八个维度的参数信息。<br> <strong>1. [sdxl_arguments]</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#Stable Diffusion XL训练时需要打开，用于两个Text Encoder输出结果的缓存与融合。注：当cache_text_encoder_outputs设为true时，shuffle_caption将不起作用。</span>
cache_text_encoder_outputs <span class="token operator">=</span> true
<span class="token comment">#当此参数为true时，VAE在训练中使用float32精度；当此为false时，VAE在训练中使用fp16精度。</span>
no_half_vae <span class="token operator">=</span> true
<span class="token comment">#Stable Diffusion XL Base U-Net在训练时的最小时间步长（默认为0）。</span>
min_timestep <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">#Stable Diffusion XL Base U-Net在训练时的最大时间步长（默认为1000）。</span>
max_timestep <span class="token operator">=</span> <span class="token number">1000</span>
<span class="token comment">#当设置为true时，对训练标签进行打乱，能一定程度提高模型的泛化性。</span>
shuffle_caption <span class="token operator">=</span> false
</code></pre> 
<p><strong>2. [model_arguments]</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#读取本地Stable Diffusion XL预训练模型用于微调。</span>
pretrained_model_name_or_path <span class="token operator">=</span> <span class="token string">"/本地路径/SDXL模型文件"</span>
<span class="token comment">#读取本地VAE模型，如果不传入本参数，在训练中则会读取Stable Diffusion XL自带的VAE模型。</span>
vae  <span class="token operator">=</span> <span class="token string">"/本地路径/VAE模型文件"</span>
</code></pre> 
<p><strong>3. [dataset_arguments]</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#训练时对数据进行debug处理，不让破损数据中断训练进程。</span>
debug_dataset <span class="token operator">=</span> false
<span class="token comment">#读取数据集json文件，json文件中包含了数据名称，数据标签，数据分桶等信息。</span>
in_json <span class="token operator">=</span> <span class="token string">"/本地路径/data_meta_lat.json"</span>
<span class="token comment">#读取本地数据集存放路径。</span>
train_data_dir <span class="token operator">=</span> <span class="token string">"/本地路径/训练集"</span>
<span class="token comment">#整个数据集重复训练的次数。（经验分享：如果数据量级小于一千，可以设置为10；如果数据量级在一千与一万之前，可以设置为5；如果数据量级大于一万，可以设置为2）</span>
dataset_repeats <span class="token operator">=</span> <span class="token number">10</span>
<span class="token comment">#在训练过程中，会将txt中的tag进行随机打乱。如果将keep tokens设置为n，那前n个token的顺序在训练过程中将不会被打乱。</span>
keep_tokens <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">#设置训练时的数据输入分辨率，分别是width和height。</span>
resolution <span class="token operator">=</span> <span class="token string">"1024,1024"</span>
<span class="token comment">#针对一个数据丢弃全部标签的概率，默认为0。</span>
caption_dropout_rate <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">#针对一个数据丢弃部分标签的概率，默认为0。（类似于传统深度学习的Dropout逻辑）</span>
caption_tag_dropout_rate <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">#每训练n个epoch，将数据标签全部丢弃。</span>
caption_dropout_every_n_epochs <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">#数据颜色增强，建议不启用，其与caching latents不兼容，若启用会导致训练时间大大增加。</span>
color_aug <span class="token operator">=</span> false
<span class="token comment">#在训练一开始学习每个数据的前n个tag（标签用逗号分隔后的前n个tag，比如girl，boy，good）</span>
token_warmup_min <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#训练中学习标签数达到最大值所需的步数，默认为0，即一开始就能学习全部的标签。</span>
token_warmup_step <span class="token operator">=</span> <span class="token number">0</span>
</code></pre> 
<p><strong>4.[training_arguments]</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#模型保存的路径。</span>
output_dir <span class="token operator">=</span> <span class="token string">"/本地路径/模型权重保存地址"</span>
<span class="token comment">#模型名称。</span>
output_name <span class="token operator">=</span> <span class="token string">"sdxl_finetune_qclineart"</span>
<span class="token comment">#模型保存的精度，一共有[“None”, "float", "fp16", "bf16"]四种选择，默认为“None”，即FP32精度。</span>
save_precision <span class="token operator">=</span> <span class="token string">"fp16"</span>
<span class="token comment">#每n个steps保存一次模型权重。</span>
save_every_n_steps <span class="token operator">=</span> <span class="token number">1000</span>
<span class="token comment">#训练Batch-Size，与传统深度学习一致。</span>
train_batch_size <span class="token operator">=</span> <span class="token number">4</span>
<span class="token comment">#设置Text Encoder最大的Token数，有[None, 150, 225]三种选择，默认为“None”，即75。</span>
max_token_length <span class="token operator">=</span> <span class="token number">225</span>
<span class="token comment">#对CrossAttention模块进行轻量化，能够一定程度上加速模型训练并降低显存占用，开启mem_eff_attn后xformers失效。</span>
mem_eff_attn <span class="token operator">=</span> false
<span class="token comment">#xformers插件可以使SDXL模型在训练时显存减少一半左右。</span>
xformers <span class="token operator">=</span> true
<span class="token comment">#训练的总步数。</span>
max_train_steps <span class="token operator">=</span> <span class="token number">100000</span>
<span class="token comment">#数据加载的DataLoader worker数量，默认为8。</span>
max_data_loader_n_workers <span class="token operator">=</span> <span class="token number">8</span>
<span class="token comment">#能够让DataLoader worker持续挂载，减少训练中每个epoch之间的数据读取时间，但是会增加内存消耗。</span>
persistent_data_loader_workers <span class="token operator">=</span> true
<span class="token comment">#设为true时开启梯度检查，通过以更长的计算时间为代价，换取更少的显存占用。相比于原本需要存储所有中间变量以供反向传播使用，使用了checkpoint的部分不存储中间变量而是在反向传播过程中重新计算这些中间变量。模型中的任何部分都可以使用gradient checkpoint。</span>
gradient_checkpointing <span class="token operator">=</span> true
<span class="token comment">#如果显存不足，我们可以使用梯度累积步数，默认为1。</span>
gradient_accumulation_steps <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#训练中是否使用混合精度，一共有["no", "fp16", "bf16"]三种选择，默认为“no”。</span>
mixed_precision <span class="token operator">=</span> <span class="token string">"fp16"</span>
</code></pre> 
<p><strong>5. [logging_arguments]</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#选择训练log保存的格式，可以从["tensorboard", "wandb", "all"]三者中选择，也可以不设置。</span>
log_with <span class="token operator">=</span> <span class="token string">"tensorboard"</span>
<span class="token comment">#设置训练log保存的路径。</span>
logging_dir <span class="token operator">=</span> <span class="token string">"/本地路径/logs"</span>
<span class="token comment">#增加log文件的文件名前缀，比如sdxl_finetune_qclineart1234567890。</span>
log_prefix <span class="token operator">=</span> <span class="token string">"sdxl_finetune_qclineart"</span>
</code></pre> 
<p><strong>6. [sample_prompt_arguments]</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#在训练中每n步测试一次模型效果。</span>
sample_every_n_steps <span class="token operator">=</span> <span class="token number">100</span>
<span class="token comment">#设置训练中测试模型效果时使用的sampler，可以选择["ddim","pndm","lms","euler","euler_a","heun","dpm_2","dpm_2_a","dpmsolver","dpmsolver++","dpmsingle", "k_lms","k_euler","k_euler_a","k_dpm_2","k_dpm_2_a"]，默认是“ddim”。</span>
sample_sampler <span class="token operator">=</span> <span class="token string">"euler_a"</span>
</code></pre> 
<p><strong>7. [saving_arguments]</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#每次模型权重保存时的格式，可以选择["ckpt", "safetensors", "diffusers", "diffusers_safetensors"]，目前SD WebUI兼容"ckpt"和"safetensors"格式模型。</span>
save_model_as <span class="token operator">=</span> <span class="token string">"safetensors"</span>
</code></pre> 
<p><strong>8. [optimizer_arguments]</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#AdamW (default),Lion, SGDNesterov,AdaFactor等。</span>
optimizer_type <span class="token operator">=</span> <span class="token string">"AdaFactor"</span>
<span class="token comment">#训练学习率，单卡推荐设置2e-6，多卡推荐设置1e-7。</span>
learning_rate <span class="token operator">=</span> <span class="token number">1e-7</span>
<span class="token comment">#是否训练时微调Text Encoder。</span>
train_text_encoder <span class="token operator">=</span> false
<span class="token comment">#最大梯度范数，0表示没有clip。</span>
max_grad_norm <span class="token operator">=</span> <span class="token number">0</span>
<span class="token comment">#设置优化器额外的参数，比如"weight_decay=0.01 betas=0.9,0.999 ..."。</span>
optimizer_args <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"scale_parameter=False"</span><span class="token punctuation">,</span> <span class="token string">"relative_step=False"</span><span class="token punctuation">,</span> <span class="token string">"warmup_init=False"</span><span class="token punctuation">,</span><span class="token punctuation">]</span>
<span class="token comment">#设置学习率调度策略，可以设置成linear, cosine, cosine_with_restarts, polynomial, constant (default), constant_with_warmup, adafactor等。</span>
lr_scheduler <span class="token operator">=</span> <span class="token string">"constant_with_warmup"</span>
<span class="token comment">#在启动学习率调度策略前，先固定学习率训练的步数。</span>
lr_warmup_steps <span class="token operator">=</span> <span class="token number">100</span>
</code></pre> 
<h6><a id="212_sample_prompttoml_420"></a>2.1.2 sample_prompt.toml</h6> 
<p>主要作用是在训练中阶段性验证模型的性能，里面包含了模型生成验证图片的相关参数：</p> 
<pre><code>[prompt]
width = 1024
height = 1024
scale = 7
sample_steps = 28
[[prompt.subset]]
prompt = "1girl, aqua eyes, baseball cap, blonde hair, closed mouth, earrings, green background, hat, hoop earrings, jewelry, looking at viewer, shirt, short hair, simple background, solo, upper body, yellow shirt"
</code></pre> 
<h4><a id="3_SDXL_432"></a>(3) SDXL关键参数详解</h4> 
<ul><li><strong>1. pretrained_model_name_or_path对SDXL模型微调训练的影响</strong></li></ul> 
<p>pretrained_model_name_or_path：我们需要加载本地的SDXL模型作为训练底模型。</p> 
<p>在SDXL全参数微调训练中，<strong>底模型的选择可以说是最为重要的一环</strong>。我们需要挑选<strong>一个生成能力分布与训练数据分布近似的SDXL模型作为训练底模型</strong>（比如说我们训练二次元人物数据集，可以选择生成二次元图片能力强的SDXL模型）。SDXL在微调训练的过程中，在原有底模型的很多能力与概念上持续扩展优化学习，从而得到底模型与数据集分布的一个综合能力。</p> 
<ul><li><strong>2. xformers加速库对SDXL模型微调训练的影响</strong></li></ul> 
<p>当我们将xformers设置为true时，<strong>使用xformers加速库能对SDXL训练起到2倍左右的加速，因为其能使得训练显存占用降低2倍，这样我们就能增大我们的Batch Size数</strong>。</p> 
<p>想要启动xformers加速库，需要先安装xformers库源，这也非常简单，我们只需要在命令行输入如下命令即可：</p> 
<pre><code>pip install xformers -i https://pypi.tuna.tsinghua.edu.cn/simple some-package
</code></pre> 
<ul><li><strong>3. learning_rate对SDXL模型微调训练的影响</strong></li></ul> 
<p>SDXL训练过程对学习率的设置非常敏感，<strong>如果我们将学习率设置的过大，很有可能导致SDXL模型训练跑飞，在前向推理时生成非常差的图片；如果我们将学习率设置的过小，可能会导致模型无法跳出极小值点。</strong></p> 
<p>这里总结了相关的SDXL学习率设置经验，分享给大家。如果我们<strong>总的Batch Size（单卡Batch Size x GPU数）小于10，可以设置学习率2e-6；如果我们总的Batch Size大于10小于100，可以设置学习率1e-7。</strong></p> 
<ul><li><strong>4. 使用save_state和resume对SDXL模型训练的中断重启</strong></li></ul> 
<p>在AI绘画领域，很多时候我们需要进行大规模数据的训练优化，数据量级在10万甚至100万以上，这时候整个训练周期需要一周甚至一个月，训练中可能会出现一些通讯/NCCL超时等问题，导致训练中断。</p> 
<p>经典NCCL超时问题如下所示：</p> 
<pre><code>[E ProcessGroupNCCL.cpp:828] [Rank 0] Watchdog caught collective operation timeout: WorkNCCL(SeqNum=213, OpType=ALLREDUCE, Timeout(ms)=1800000) ran for 1809831 milliseconds before timing out.
</code></pre> 
<p>这些训练中断问题会导致我们的训练成本大大增加，为了解决这个问题，我们可以在<strong>config_file.toml中设置save_state = true，这样我们在训练模型时不单单保存模型权重，还会保存相关的optimizer states等训练状态</strong>。</p> 
<p>接着，我们在config_file.toml中设置<strong>resume = “/本地路径/模型权重保存地址”</strong>，重新运行SDXL训练脚本，这时会直接调取训练中断前的模型权重与训练状态，接着继续训练。</p> 
<h4><a id="4_SDXL_466"></a>(4) SDXL模型开始训练</h4> 
<p>完成训练参数配置后，我们就可以运行训练脚本进行SDXL模型的全参微调训练了。</p> 
<h3><a id="24_SDXLLoRA_470"></a>2.4 基于SDXL训练LoRA模型</h3> 
<p>目前<strong>Stable Diffusion XL全参微调的训练成本是Stable Diffusion之前系列的2-3倍左右</strong>，而基于<strong>Stable Diffusion XL训练LoRA</strong>的成本与之前的系列相比并没有太多增加，故<strong>训练LoRA</strong>依旧是持续繁荣SDXL生态的高效选择。</p> 
<h4><a id="1_SDXL_LoRA_472"></a>(1) SDXL LoRA数据集制作</h4> 
<p>SDXL LoRA训练数据集筛选要求和SDXL微调不一样：</p> 
<ul><li>当我们训练人物主题时，一般需要10-20张高质量数据；- 当我们训练画风主题时，需要100-200张高质量数据；当我们训练抽象概念时，则至少需要200张以上的数据。</li><li>不管是人物主题，画风主题还是抽象概念，一定要保证数据集中数据的多样性（比如说猫女姿态，角度，全身半身的多样性）。</li><li>每个数据都要符合我们的审美和评判标准！每个数据都要符合我们的审美和评判标准！每个数据都要符合我们的审美和评判标准。</li></ul> 
<p><strong>按照本文4.3 Stable Diffusion XL数据集制作章节里的步骤，进行数据的清洗，自动标注，以及添加特殊tag——即触发词。</strong></p> 
<p>除了对数据进行标注，我们还需要<strong>对数据的标注进行清洗，删除一些概念与触发词重合的标签.</strong> 为什么我们要进行数据标注的清洗呢？因为如果不对标注进行清洗，会导致训练时的tag污染。</p> 
<p>我们拿猫女数据集为例，我们想要让SDXL LoRA模型学习猫女的主要特征，包括脸部特征，服装特征（最具猫女特点的黑色皮衣和黑色眼罩）等，我们想让“catwomen”学习到这些特征。但是自动标注会给数据打上一些描述脸部特征和服装特征的tag，导致猫女的主要特征被这些tag分走，从而导致tag污染。这样就会导致很多精细化的特征丢失在自动标注的tag中，使得SDXL LoRA在生成猫女图片时缺失黑色皮衣或者黑色眼罩等。</p> 
<p>所以我们需要<strong>删除自动标注的脸部，服装等tag，从而使得保留下来的触发词等标签是SDXL LoRA模型着重需要学习的。</strong></p> 
<p>一张一张手动删除标签费时费力，这里推荐大家使用Stable Diffusion WebUI的一个数据标注处理插件：<a href="https://github.com/toshiaki1729/stable-diffusion-webui-dataset-tag-editor">stable-diffusion-webui-dataset-tag-editor</a>，可以对标签进行批量处理，非常方便。</p> 
<h4><a id="2_SDXL_LoRA_487"></a>(2) SDXL LoRA训练参数配置</h4> 
<p>大家可以在SDXL-Trian项目中train_config/XL_LoRA_config路径下找到SDXL LoRA的训练参数配置文件<strong>config_file.toml和sample_prompt.toml</strong>，他们分别存储着SDXL_LoRA的<strong>训练超参数与训练中的验证prompt信息。</strong></p> 
<p>其中config_file.toml文件中的配置文件包含了sdxl_arguments，model_arguments，dataset_arguments，training_arguments，logging_arguments，sample_prompt_arguments，saving_arguments，optimizer_arguments以及additional_network_arguments九个个维度的参数信息。</p> 
<p>训练SDXL_LoRA的参数配置与SDXL全参微调的训练配置有相同的部分（上述的前八个维度），也有LoRA的特定参数需要配置（additional_network_arguments）。</p> 
<p>下面我们首先看看这些共同的维度中，有哪些需要注意的事项吧：</p> 
<h5><a id="21_XL_LoRA_config_495"></a>2.1 训练参数讲解(XL_LoRA_config文件夹)</h5> 
<h6><a id="211_config_filetoml_496"></a>2.1.1 config_file.toml</h6> 
<p><strong>1. [sdxl_arguments]</strong> # 与SDXL全参微调训练一致</p> 
<pre><code class="prism language-python">cache_text_encoder_outputs <span class="token operator">=</span> true
no_half_vae <span class="token operator">=</span> true
min_timestep <span class="token operator">=</span> <span class="token number">0</span>
max_timestep <span class="token operator">=</span> <span class="token number">1000</span>
shuffle_caption <span class="token operator">=</span> false
</code></pre> 
<p><strong>2. [model_arguments]</strong> # 与SDXL全参微调训练一致</p> 
<pre><code class="prism language-python">pretrained_model_name_or_path <span class="token operator">=</span> <span class="token string">"/本地路径/SDXL模型文件"</span>
<span class="token comment"># 如果只使用模型自带的VAE，不读取额外的VAE模型，则需要将本行直接删除</span>
vae  <span class="token operator">=</span> <span class="token string">"/本地路径/VAE模型文件"</span> 
</code></pre> 
<p><strong>3. [dataset_arguments]</strong> # 与SDXL全参微调训练不一致</p> 
<pre><code class="prism language-python"><span class="token comment">#LoRA训练过程中取消了caption_dropout_rate = 0，caption_tag_dropout_rate = 0，</span>
<span class="token comment">#caption_dropout_every_n_epochs = 0这三个参数，因为本身LoRA的模型容量较小，不需要再进行类标签Dropout的操作了。</span>
debug_dataset <span class="token operator">=</span> false
in_json <span class="token operator">=</span> <span class="token string">"/本地路径/data_meta_lat.json"</span>
train_data_dir <span class="token operator">=</span> <span class="token string">"/本地路径/训练集"</span>
dataset_repeats <span class="token operator">=</span> <span class="token number">1</span>
keep_tokens <span class="token operator">=</span> <span class="token number">0</span>
resolution <span class="token operator">=</span> <span class="token string">"1024,1024"</span>
color_aug <span class="token operator">=</span> false
token_warmup_min <span class="token operator">=</span> <span class="token number">1</span>
token_warmup_step <span class="token operator">=</span> <span class="token number">0</span>
</code></pre> 
<p><strong>4. [training_arguments]</strong> # 与SDXL全参微调训练不一致</p> 
<pre><code class="prism language-python"><span class="token comment">#SDXL_LoRA增加了sdpa参数，当其设置为true时，训练中启动scaled dot-product attention优化，</span>
<span class="token comment">#这时候就不需要再开启xformers了</span>
output_dir <span class="token operator">=</span> <span class="token string">"/本地路径/模型权重保存地址"</span>
output_name <span class="token operator">=</span> <span class="token string">"sdxl_lora_qclineart"</span>
save_precision <span class="token operator">=</span> <span class="token string">"fp16"</span>
save_every_n_epochs <span class="token operator">=</span> <span class="token number">1</span>
train_batch_size <span class="token operator">=</span> <span class="token number">4</span>
max_token_length <span class="token operator">=</span> <span class="token number">225</span>
mem_eff_attn <span class="token operator">=</span> false
sdpa <span class="token operator">=</span> true
xformers <span class="token operator">=</span> false
max_train_epochs <span class="token operator">=</span> <span class="token number">100</span> <span class="token comment">#max_train_epochs设置后，会覆盖掉max_train_steps，即两者同时存在时，以max_train_epochs为准</span>
max_data_loader_n_workers <span class="token operator">=</span> <span class="token number">8</span>
persistent_data_loader_workers <span class="token operator">=</span> true
gradient_checkpointing <span class="token operator">=</span> true
gradient_accumulation_steps <span class="token operator">=</span> <span class="token number">1</span>
mixed_precision <span class="token operator">=</span> <span class="token string">"fp16"</span>
</code></pre> 
<p><strong>5. [logging_arguments]</strong> # 与SDXL全参微调训练一致</p> 
<pre><code class="prism language-python">log_with <span class="token operator">=</span> <span class="token string">"tensorboard"</span>
logging_dir <span class="token operator">=</span> <span class="token string">"/本地路径/logs"</span>
log_prefix <span class="token operator">=</span> <span class="token string">"sdxl_lora_qclineart"</span>
</code></pre> 
<p><strong>6. [sample_prompt_arguments]</strong> # 与SDXL全参微调训练一致</p> 
<pre><code class="prism language-python">sample_every_n_epochs <span class="token operator">=</span> <span class="token number">1</span>
sample_sampler <span class="token operator">=</span> <span class="token string">"euler_a"</span>
</code></pre> 
<p><strong>7. [saving_arguments]</strong> # 与SDXL全参微调训练一致</p> 
<pre><code class="prism language-python">save_model_as <span class="token operator">=</span> <span class="token string">"safetensors"</span>
</code></pre> 
<p><strong>8. [optimizer_arguments]</strong> # 与SDXL全参微调训练不一致</p> 
<pre><code class="prism language-python">optimizer_type <span class="token operator">=</span> <span class="token string">"AdaFactor"</span>
learning_rate <span class="token operator">=</span> <span class="token number">1e-5</span> <span class="token comment"># 训练SDXL_LoRA时，学习率可以调的大一些，一般比SDXL全参微调的学习率大10倍左右，比如learning_rate = 1e-5</span>
max_grad_norm <span class="token operator">=</span> <span class="token number">0</span>
optimizer_args <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"scale_parameter=False"</span><span class="token punctuation">,</span> <span class="token string">"relative_step=False"</span><span class="token punctuation">,</span> <span class="token string">"warmup_init=False"</span><span class="token punctuation">,</span><span class="token punctuation">]</span>
lr_scheduler <span class="token operator">=</span> <span class="token string">"constant_with_warmup"</span>
lr_warmup_steps <span class="token operator">=</span> <span class="token number">100</span>
</code></pre> 
<p>除了上面的参数，训练SDXL_LoRA时还需要设置一些专属参数，这些参数非常关键：<br> <strong>9. [additional_network_arguments]</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#保存模型权重时不附带Metadata数据，建议关闭，能够减少保存下来的LoRA大小。</span>
no_metadata <span class="token operator">=</span> false
<span class="token comment">#选择训练的LoRA模型结构，可以从["networks.lora", "networks.dylora", "lycoris.kohya"]中选择，最常用的LoRA结构默认选择"networks.lora"。</span>
network_module <span class="token operator">=</span> <span class="token string">"networks.lora"</span>
<span class="token comment">#设置LoRA的RANK，设置的数值越大表示表现力越强，但同时需要更多的显存和时间来训练。</span>
network_dim <span class="token operator">=</span> <span class="token number">32</span>
<span class="token comment">#设置缩放权重，用于防止下溢并稳定训练的alpha值。</span>
network_alpha <span class="token operator">=</span> <span class="token number">16</span>
<span class="token comment">#置卷积的Rank与缩放权重。</span>
network_args <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">"conv_dim=32"</span><span class="token punctuation">,</span> <span class="token string">"conv_alpha=16"</span><span class="token punctuation">,</span><span class="token punctuation">]</span>
<span class="token comment">#如果设置为true，那么只训练U-Net部分。</span>
network_train_unet_only <span class="token operator">=</span> true
</code></pre> 
<p>下面表格中给出一些默认配置，大家可以作为参考：</p> 
<table><thead><tr><th>network_category</th><th>network_dim</th><th>network_alpha</th><th>conv_dim</th><th>conv_alpha</th></tr></thead><tbody><tr><td>LoRA</td><td>32</td><td>1</td><td>-</td><td>-</td></tr><tr><td>LoCon</td><td>16</td><td>8</td><td>8</td><td>1</td></tr><tr><td>LoHa</td><td>8</td><td>4</td><td>4</td><td>1</td></tr></tbody></table> 
<p><strong>如果我们想要训练LoRA</strong>，我们需要设置network_module = “networks.lora”，同时设置network_dim和network_alpha，和上面的配置一致。</p> 
<p><strong>如果我们想要训练LoCon</strong>，我们需要设置network_module = "lycoris.kohya"和algo=“locon”，同时设置network_dim和network_alpha：</p> 
<pre><code>network_module = "lycoris.kohya"
algo = "locon"
network_dim = 32
network_alpha = 16
network_args = [ "conv_dim=32", "conv_alpha=16",]
</code></pre> 
<p><strong>如果我们想要训练LoHa</strong>，我们需要设置network_module = "lycoris.kohya"和algo=“loha”，同时设置network_dim和network_alpha：</p> 
<pre><code>network_module = "lycoris.kohya"
algo = "loha"
network_dim = 32
network_alpha = 16
network_args = [ "conv_dim=32", "conv_alpha=16",]
</code></pre> 
<h4><a id="3_SDXL_LoRA_611"></a>(3) SDXL LoRA关键参数详解</h4> 
<ul><li><strong>1. train_batch_size对SDXL LoRA模型训练的影响</strong></li></ul> 
<p>和传统深度学习一样，train_batch_size即为训练时的batch size，表示一次性送入SDXL LoRA模型进行训练的图片数量。一个Epoch表示模型完整地遍历一次整个训练数据集</p> 
<p>所以一般来说，<strong>较大的batch size</strong>往往<strong>每个epoch训练时间更短，但是显存占用会更大，并且收敛得慢</strong>（需要更多epoch数）。<strong>较小的batch size每个epoch训练时间长，但是显存占用会更小，并且收敛得快</strong>（需要更少epoch数）。</p> 
<p>但是有研究表明这个结论会在batch size大于8000的时候才会体现，所以在实际的训练时，如果GPU数不大于8卡的话，还是需要尽可能占满GPU显存为宜，比如64-96之间（理论上batch size = <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          2 
         
        
          n 
         
        
       
      
        2^n 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6644em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6644em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span></span></span></span> 时计算效率较高），训练一般都能取得不错效果。</p> 
<p>上面的结论在训练SDXL大模型时是非常适用的，不过我们在训练SDXL LoRA模型时，一般来说数据量级是比较小的（10-300为主），所以在这种情况下，我们可以设置batch size为2-6即可。</p> 
<ul><li><strong>2. pretrained_model_name_or_path对SDXL LoRA模型训练的影响</strong></li></ul> 
<p>pretrained_model_name_or_path参数中我们需要加载本地的SDXL模型作为训练底模型。</p> 
<p>底模型的选择至关重要，SDXL LoRA的很多底层能力与基础概念的学习都来自于底模型的能力。并且底模型的优秀能力需要与我们训练的主题，比如说人物，画风或者某个抽象概念相适配。如果我们要训练二次元LoRA，则需要选择二次元底模型，如果我们要训练三次元LoRA，则需要选择三次元底模型，以此类推。</p> 
<ul><li><strong>3. network_dim对SDXL LoRA模型训练的影响</strong></li></ul> 
<p>network_dim即特征维度，越高表示模型的参数量越大，设置高维度有助于LoRA学习到更多细节特征，但模型收敛速度变慢，同时也更容易过拟合，需要的训练时间更长。所以network_dim的设置需要根据任务主题去调整。</p> 
<p>一般来说，在SDXL的1024*1024分辨率训练基础上，可以设置network_dimension = 128，此时SDXL LoRA大小约为686MB。</p> 
<ul><li><strong>4. network_alpha对SDXL LoRA模型训练的影响</strong></li></ul> 
<p>network_alpha是一个缩放因子，用于缩放模型的训练权重 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         W 
        
       
      
        W 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">W</span></span></span></span></span>, <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         W 
        
       
         = 
        
        
        
          W 
         
         
         
           i 
          
         
           n 
          
         
        
       
         × 
        
       
         a 
        
       
         l 
        
       
         p 
        
       
         h 
        
       
         a 
        
       
         / 
        
       
         d 
        
       
         i 
        
       
         m 
        
       
      
        W = W_{in} \times alpha / dim 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">W</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal">lp</span><span class="mord mathnormal">ha</span><span class="mord">/</span><span class="mord mathnormal">d</span><span class="mord mathnormal">im</span></span></span></span></span><br> 。network_alpha设置的越高，LoRA模型能够学习更多的细节信息，同时学习速率也越快，推荐将其设置为network_dim的一半。</p> 
<h4><a id="4_SDXL_LoRA_639"></a>(4) SDXL LoRA模型训练</h4> 
<p>完成训练参数配置后，我们就可以运行训练脚本进行SDXL_LoRA模型的训练了。<br> 我们打开SDXL_fintune_LoRA.sh脚本，可以看到以下的代码：</p> 
<pre><code>accelerate launch \
  --config_file accelerate_config.yaml \
  --num_cpu_threads_per_process=8 \
  /本地路径/SDXL-Train/sdxl_train_network.py \
  --sample_prompts="/本地路径/SDXL-Train/train_config/XL_LoRA_config/sample_prompt.toml" \
  --config_file="/本地路径/SDXL-Train/train_config/XL_LoRA_config/config_file.toml"
</code></pre> 
<p>我们把训练脚本封装在accelerate库里，这样就能启动我们一开始配置的训练环境了，同时我们将刚才配置好的config_file.toml和sample_prompt.toml参数传入训练脚本中。</p> 
<p>接下里，就到了激动人心的时刻，我们只需在命令行输入以下命令，就能开始SDXL_LoRA训练啦：</p> 
<pre><code># 进入SDXL-Trian项目中
cd SDXL-Trian

# 运行训练脚本！
sh SDXL_fintune_LoRA.sh
</code></pre> 
<p>当我们基于SDXL训练SDXL LoRA模型时，我们设置分辨率为1024+FP16精度+xformers加速时，进行Batch Size = 1的微调训练需要约13.3G的显存，进行Batch Size=8的微调训练需要约18.4G的显存，所以想要微调训练SDXL LoRA模型，最好配置一个16G以上的显卡，能让我们更佳从容地进行训练。</p> 
<p>感谢<br> <a href="https://zhuanlan.zhihu.com/p/643420260" rel="nofollow">https://zhuanlan.zhihu.com/p/643420260</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0bc1b4890ea714ec25e66a3866e26109/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微信小程序嵌入 H5 页面（webview）基本用法和父子传参数说明</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0fd94b79f1671cbf198787e692215d90/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">对话式AI助手的巅峰对决：ChatGPT与文心一言的实用价值探讨</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>