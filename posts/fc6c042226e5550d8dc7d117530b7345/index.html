<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL拆分字段内容（含分隔符） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/fc6c042226e5550d8dc7d117530b7345/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="SQL拆分字段内容（含分隔符）">
  <meta property="og:description" content="问题描述： 在做数据迁移的过程中，我们希望对表中的某个字段根据分隔符进行拆分，得到多条数据，原代码有点意思，因此记录一下。
我们假设某条数据如下：
IDSTRS1公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效 针对这条数据，我们希望将其拆分成为四份或者五份，以便于后续的数据处理（这里是拆成四份，加上原来的那条数据一共是五条）。
希望得到的结果：
STEP1:
IDSTRS1公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效S1公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效S1公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效S1公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效S1公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效 原作者最后希望得到如下的数据：
STEP2:
IDSTRS1公司名称不能小于四个字，S1行业类别不能为空，S1职务/岗位不能为空，S1公司电话不能小于8位且真是有效 DB2原代码 针对STEP1:
原来的代码：
WITH N (STR,ORI,POS,ID) AS ( (SELECT CONCAT(STR,&#39;,&#39;), 1, POSSER(CONCAT(STR,&#39;,&#39;),&#39;,&#39;), ID FROM TABLE_NAME WHERE ID = &#39;S1&#39;) UNION ALL SELECT STR, POS&#43;1, LOCATE(&#39;,&#39;,STR,POS&#43;1), STR FROM N WHERE LOCATE(&#39;,&#39;,STR,POS&#43;1)&#43;1&gt;0) SELECT * FROM N 结果如下：
STRORIPOSID公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效122S1公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效2339S1公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效4057S1公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效5889S1公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效9090S1 关于代码中涉及到的函数说明 CONCAT() 拼接函数
组合两部分形成一个字符串表达。
（看官方文档，只包括两个参数）
CONCAT官方说明
POSSER() 函数返回查找字符串在被查找字符串中第一次出现的位置。
POSSTR官方文档
官网示例：
Example: Select the RECEIVED column, the SUBJECT column, and the starting position of the string ‘GOOD BEER’ within the NOTE_TEXT column for all rows in the IN_TRAY table that contain that string.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-08T16:52:26+08:00">
    <meta property="article:modified_time" content="2024-02-08T16:52:26+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL拆分字段内容（含分隔符）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>问题描述：</h3> 
<p>在做数据迁移的过程中，我们希望对表中的某个字段根据分隔符进行拆分，得到多条数据，原代码有点意思，因此记录一下。<br> 我们假设某条数据如下：</p> 
<table><thead><tr><th>ID</th><th>STR</th></tr></thead><tbody><tr><td>S1</td><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td></tr></tbody></table> 
<p>针对这条数据，我们希望将其拆分成为四份或者五份，以便于后续的数据处理（这里是拆成四份，加上原来的那条数据一共是五条）。<br> 希望得到的结果：<br> STEP1:</p> 
<table><thead><tr><th>ID</th><th>STR</th></tr></thead><tbody><tr><td>S1</td><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td></tr><tr><td>S1</td><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td></tr><tr><td>S1</td><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td></tr><tr><td>S1</td><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td></tr><tr><td>S1</td><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td></tr></tbody></table> 
<p>原作者最后希望得到如下的数据：<br> STEP2:</p> 
<table><thead><tr><th>ID</th><th>STR</th></tr></thead><tbody><tr><td>S1</td><td>公司名称不能小于四个字，</td></tr><tr><td>S1</td><td>行业类别不能为空，</td></tr><tr><td>S1</td><td>职务/岗位不能为空，</td></tr><tr><td>S1</td><td>公司电话不能小于8位且真是有效</td></tr></tbody></table> 
<h3><a id="DB2_28"></a>DB2原代码</h3> 
<p>针对STEP1:<br> 原来的代码：</p> 
<pre><code class="prism language-sql"><span class="token keyword">WITH</span> N <span class="token punctuation">(</span>STR<span class="token punctuation">,</span>ORI<span class="token punctuation">,</span>POS<span class="token punctuation">,</span>ID<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token punctuation">(</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> CONCAT<span class="token punctuation">(</span>STR<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token number">1</span><span class="token punctuation">,</span>
       POSSER<span class="token punctuation">(</span>CONCAT<span class="token punctuation">(</span>STR<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       ID
  <span class="token keyword">FROM</span> TABLE_NAME
  <span class="token keyword">WHERE</span> ID <span class="token operator">=</span> <span class="token string">'S1'</span><span class="token punctuation">)</span>
  <span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
  <span class="token keyword">SELECT</span> 
  STR<span class="token punctuation">,</span>
  POS<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>
  LOCATE<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span>STR<span class="token punctuation">,</span>POS<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  STR
  <span class="token keyword">FROM</span> N 
  <span class="token keyword">WHERE</span> LOCATE<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span>STR<span class="token punctuation">,</span>POS<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> N 
</code></pre> 
<p>结果如下：</p> 
<table><thead><tr><th>STR</th><th>ORI</th><th>POS</th><th>ID</th></tr></thead><tbody><tr><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td><td>1</td><td>22</td><td>S1</td></tr><tr><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td><td>23</td><td>39</td><td>S1</td></tr><tr><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td><td>40</td><td>57</td><td>S1</td></tr><tr><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td><td>58</td><td>89</td><td>S1</td></tr><tr><td>公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</td><td>90</td><td>90</td><td>S1</td></tr></tbody></table> 
<h3><a id="_60"></a>关于代码中涉及到的函数说明</h3> 
<h4><a id="CONCAT_61"></a>CONCAT()</h4> 
<p>拼接函数<br> 组合两部分形成一个字符串表达。<br> （看官方文档，只包括两个参数）</p> 
<p><a href="https://www.ibm.com/docs/zh/db2/9.7?topic=functions-concat" rel="nofollow">CONCAT官方说明</a></p> 
<p><img src="https://images2.imgbox.com/8c/27/qRimOW8i_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="POSSER_69"></a>POSSER()</h4> 
<p>函数返回查找字符串在被查找字符串中第一次出现的位置。<br> <img src="https://images2.imgbox.com/a5/22/7tRNPARm_o.png" alt="在这里插入图片描述"><br> <a href="https://www.ibm.com/docs/en/db2-for-zos/11?topic=functions-posstr" rel="nofollow">POSSTR官方文档</a></p> 
<p>官网示例：</p> 
<p>Example: Select the RECEIVED column, the SUBJECT column, and the starting position of the string ‘GOOD BEER’ within the NOTE_TEXT column for all rows in the IN_TRAY table that contain that string.<br> 结果返回RECEIVED列， SUBJECT列，以及字符串 ‘GOOD BEER’ 在 NOTE_TEXT列中第一次出现的位置。</p> 
<pre><code class="prism language-sql">   <span class="token keyword">SELECT</span> RECEIVED<span class="token punctuation">,</span> SUBJECT<span class="token punctuation">,</span> POSSTR<span class="token punctuation">(</span>NOTE_TEXT<span class="token punctuation">,</span> <span class="token string">'GOOD BEER'</span><span class="token punctuation">)</span>
     <span class="token keyword">FROM</span> IN_TRAY
     <span class="token keyword">WHERE</span> POSSTR<span class="token punctuation">(</span>NOTE_TEXT<span class="token punctuation">,</span> <span class="token string">'GOOD BEER'</span><span class="token punctuation">)</span> <span class="token operator">&lt;&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="LOCATE_84"></a>LOCATE（）</h4> 
<p><img src="https://images2.imgbox.com/3c/b1/ffDcRZSY_o.png" alt="在这里插入图片描述"><br> LOCATE()函数与POSSER()类似，参数数量不同<br> LOCATE()函数返回查找字符串在被查找字符串中第一次出现的位置，与POSSER()不同的是，它可以指定开始的位置以及编码计算的方式(CODEUNITS16, CODEUNITS32, or OCTETS)。<br> 官方示例：<br> Locate the character ‘ß’ in the string ‘Jürgen lives on Hegelstraße’, and set the host variable LOCATION with the position, as measured in CODEUNITS32 units, within the string.<br> 返回字符 'ß’在字符串’Jürgen lives on Hegelstraße’中的位置，从第一位之后开始计算</p> 
<pre><code class="prism language-sql">   <span class="token keyword">SET</span> :LOCATION <span class="token operator">=</span> LOCATE<span class="token punctuation">(</span><span class="token string">'ß'</span><span class="token punctuation">,</span><span class="token string">'Jürgen lives on Hegelstraße'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>CODEUNITS32<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="GBASE_96"></a>GBASE实现</h3> 
<h4><a id="_97"></a>上例改写</h4> 
<p>参考文章：<br> <a href="https://blog.csdn.net/weixin_43847283/article/details/124029614">MySql字符串拆分实现split功能（字段分割转列、转行）</a></p> 
<p>GBASE中 WITH AS 函数相较于DB2会有限制，因此不推荐使用（需要指定模式名称）</p> 
<p>对于这个问题，我们要明确：<br> 1、循环多少次<br> 2、如何控制循环的次数</p> 
<p>循环次数求取：<br> 对于该字符串：<br> 公司名称不能小于四个字，行业类别不能为空，职务/岗位不能为空，公司电话不能小于8位且真是有效</p> 
<p>我们需要将其分为四段，每个逗号作为分隔</p> 
<p>那么循环次数可以这样表示：</p> 
<pre><code class="prism language-sql">LENGTH<span class="token punctuation">(</span>STR<span class="token punctuation">)</span> <span class="token operator">-</span> LENGTH<span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span>STR<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>将逗号替换为空格，用含逗号的字符串的长度减去不含逗号的字符串长度，得到的就是逗号的数量，也就是循环的次数</p> 
<p>对于如何控制循环，我们需要引入一个序列数，上述文章使用了MySQL中的系统表中的ID作为序列，我们可以新建一个表，存入这个自增序列作为辅助，因为希望在一个sql中完成这个操作，因此我这里使用row_number()over()函数自己创建一个序列</p> 
<p>那么完整地代码如下所示：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> H1<span class="token punctuation">.</span>ID <span class="token punctuation">,</span>
      SUBSTRING_INDEX<span class="token punctuation">(</span>SUBSTRING_INDEX<span class="token punctuation">(</span>H1<span class="token punctuation">.</span>STR<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span>SEQ<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token keyword">AS</span> STR
 <span class="token keyword">FROM</span> TABLENAME
 <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> STR<span class="token punctuation">)</span> <span class="token keyword">AS</span> SEQ <span class="token punctuation">,</span>T<span class="token punctuation">.</span><span class="token operator">*</span> 
               <span class="token keyword">FROM</span> TABLENAME T 
               <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> SQE<span class="token punctuation">)</span> H2
          <span class="token keyword">ON</span> H2<span class="token punctuation">.</span>SEQ<span class="token operator">&lt;=</span> LENGTH<span class="token punctuation">(</span>H1<span class="token punctuation">.</span>STR<span class="token punctuation">)</span> <span class="token operator">-</span> LENGTH<span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span>H1<span class="token punctuation">.</span>STR<span class="token punctuation">,</span><span class="token string">','</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>这里我们得到的是上述STEP2的结果：（而且没有冗余的字段）
</code></pre> 
<table><thead><tr><th>ID</th><th>STR</th></tr></thead><tbody><tr><td>S1</td><td>公司名称不能小于四个字，</td></tr><tr><td>S1</td><td>行业类别不能为空，</td></tr><tr><td>S1</td><td>职务/岗位不能为空，</td></tr><tr><td>S1</td><td>公司电话不能小于8位且真是有效</td></tr></tbody></table> 
<h4><a id="_144"></a>另外一个例子</h4> 
<p>INSU表中存了保险代码以及付费期间两个字段，但是一个产品有多个付费期间，用符号’|'分隔，我们希望将付费期间字段拆开。<br> 如表：<br> <img src="https://images2.imgbox.com/85/3d/1olBg5qO_o.png" alt="在这里插入图片描述"><br> 希望得到的结果：<br> <img src="https://images2.imgbox.com/e8/ff/asOxIwOt_o.png" alt="在这里插入图片描述"></p> 
<p>代码：</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> H1<span class="token punctuation">.</span>PROD_CD<span class="token punctuation">,</span>
      SUBSTRING_INDEX<span class="token punctuation">(</span>SUBSTRING_INDEX<span class="token punctuation">(</span>H1<span class="token punctuation">.</span>PAY_TERM<span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span>ID<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">FROM</span> INSU
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 
         <span class="token punctuation">(</span><span class="token keyword">SELECT</span> ROW_NUMBER<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">OVER</span><span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> PAYTERM<span class="token punctuation">)</span> <span class="token keyword">AS</span> ID <span class="token punctuation">,</span>T<span class="token punctuation">.</span><span class="token operator">*</span>  <span class="token keyword">FROM</span> INSU T 
         <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> ID <span class="token punctuation">)</span>  H2 
         <span class="token keyword">ON</span>  H1<span class="token punctuation">.</span>ID <span class="token operator">&lt;=</span> LENGTH<span class="token punctuation">(</span>H1<span class="token punctuation">.</span>PAY_TERM<span class="token punctuation">)</span> <span class="token operator">-</span> LENGTH<span class="token punctuation">(</span><span class="token keyword">REPLACE</span><span class="token punctuation">(</span>H1<span class="token punctuation">.</span>PAY_MENT<span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token number">1</span> 
</code></pre> 
<h4><a id="SUBSTRING_INDEX__162"></a>SUBSTRING_INDEX ()函数</h4> 
<p><a href="https://www.ibm.com/docs/en/informix-servers/14.10?topic=functions-substring-index-function" rel="nofollow">SUBSTRING_INDEX function</a><br> <img src="https://images2.imgbox.com/c2/1e/mpvsHHk3_o.png" alt="在这里插入图片描述"><br> 以分隔符为界，将字符串划分为几个部分，然后返回前几个部分的字符串。</p> 
<p>示例：</p> 
<pre><code class="prism language-sql">SUBSTRING_INDEX<span class="token punctuation">(</span><span class="token string">"www.ibm.com"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  
</code></pre> 
<p>returns the leading characters www.ibm because count &gt; 0.<br> 返回值为：www.ibm<br> 如果最后一个参数为负数的话：<br> 示例：</p> 
<pre><code class="prism language-sql">SUBSTRING_INDEX<span class="token punctuation">(</span><span class="token string">"www.ibm.com"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>  
</code></pre> 
<p>返回值为：ibm.com （从后往前数）</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b01a9616db6a390a132ad87d0dee2353/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux系统 彻底卸载 安装部署Mysql数据库 详细步骤图文</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2bdd5de975fe69a03ff116e9dee1af97/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LLaMA 入门指南</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>