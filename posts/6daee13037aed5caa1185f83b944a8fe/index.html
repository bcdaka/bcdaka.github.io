<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【AI 大模型】函数调用 Function Calling ② ( Plugins、Actions 扩展 | 函数调用 Function Calling 引入 | 函数调用开发流程 | 代码示例 ) - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/6daee13037aed5caa1185f83b944a8fe/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【AI 大模型】函数调用 Function Calling ② ( Plugins、Actions 扩展 | 函数调用 Function Calling 引入 | 函数调用开发流程 | 代码示例 )">
  <meta property="og:description" content="文章目录 一、Plugins、Actions 扩展1、GPT 大模型缺陷 - 引入 Plugins、Actions 扩展2、Plugins 插件3、Plugins 插件开发流程4、Plugins 插件弊端 - Actions 引入5、Actions 简介 二、ChatGPT 的平替 - Coze、Dify三、函数调用 Function Calling 引入四、函数调用开发流程1、调用 OpenAI 的接口2、函数定义3、大模型回调4、本地代码逻辑5、第二次大模型调用 五、函数调用代码示例 一、Plugins、Actions 扩展 1、GPT 大模型缺陷 - 引入 Plugins、Actions 扩展 GPT 大模型 有如下三种缺陷 :
非全知全能 : 用于训练的都是 公开知识文本 , GPT 不知道 内部 或 保密 知识信息 ;时效性差 : 大模型训练需要 半年 以上的时间 , 使用的都是半年以前的知识 ;没有真逻辑 : 基于概率生成文本 , 无法处理复杂的逻辑问题 ; 为了解决上述三种缺陷 , OpenAI 在 GPT 大模型中引入了 Plugins 和 Actions 两种 扩展机制 , 用于增强模型的功能 , 使 GPT 大模型 能够处理 更复杂 和 特定的 任务 ;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-20T22:19:42+08:00">
    <meta property="article:modified_time" content="2024-07-20T22:19:42+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【AI 大模型】函数调用 Function Calling ② ( Plugins、Actions 扩展 | 函数调用 Function Calling 引入 | 函数调用开发流程 | 代码示例 )</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#PluginsActions__14" rel="nofollow">一、Plugins、Actions 扩展</a></li><li><ul><li><a href="#1GPT____PluginsActions__23" rel="nofollow">1、GPT 大模型缺陷 - 引入 Plugins、Actions 扩展</a></li><li><a href="#2Plugins__42" rel="nofollow">2、Plugins 插件</a></li><li><a href="#3Plugins__56" rel="nofollow">3、Plugins 插件开发流程</a></li><li><a href="#4Plugins___Actions__69" rel="nofollow">4、Plugins 插件弊端 - Actions 引入</a></li><li><a href="#5Actions__82" rel="nofollow">5、Actions 简介</a></li></ul> 
  </li><li><a href="#ChatGPT___CozeDify_99" rel="nofollow">二、ChatGPT 的平替 - Coze、Dify</a></li><li><a href="#_Function_Calling__139" rel="nofollow">三、函数调用 Function Calling 引入</a></li><li><a href="#_181" rel="nofollow">四、函数调用开发流程</a></li><li><ul><li><a href="#1_OpenAI__190" rel="nofollow">1、调用 OpenAI 的接口</a></li><li><a href="#2_201" rel="nofollow">2、函数定义</a></li><li><a href="#3_254" rel="nofollow">3、大模型回调</a></li><li><a href="#4_290" rel="nofollow">4、本地代码逻辑</a></li><li><a href="#5_320" rel="nofollow">5、第二次大模型调用</a></li></ul> 
  </li><li><a href="#_339" rel="nofollow">五、函数调用代码示例</a></li></ul> 
</div> 
<p></p> 
<br> 
<br> 
<br> 
<br> 
<br> 
<h2><a id="PluginsActions__14"></a>一、Plugins、Actions 扩展</h2> 
<hr> 
<br> 
<br> 
<h3><a id="1GPT____PluginsActions__23"></a>1、GPT 大模型缺陷 - 引入 Plugins、Actions 扩展</h3> 
<br> 
<p><strong>GPT 大模型 有如下三种缺陷 :</strong></p> 
<ul><li><strong>非全知全能 :</strong> 用于训练的都是 <font color="blue">公开知识文本 , <font color="red">GPT 不知道 内部 或 保密 知识信息 ;</font></font></li><li><strong>时效性差 :</strong> 大模型训练需要 半年 以上的时间 , <font color="purple">使用的都是半年以前的知识 ;</font></li><li><strong>没有真逻辑 :</strong> <font color="orange">基于概率生成文本 , <font color="green">无法处理复杂的逻辑问题 ;</font></font></li></ul> 
<br> 
<p>为了解决上述三种缺陷 , <font color="magenta">OpenAI 在 GPT 大模型中引入了 Plugins 和 Actions 两种 扩展机制 , <font color="blue">用于增强模型的功能 , <font color="red">使 GPT 大模型 能够处理 更复杂 和 特定的 任务 ;</font></font></font></p> 
<br> 
<h3><a id="2Plugins__42"></a>2、Plugins 插件</h3> 
<br> 
<p>ChatGPT 的 Plugins 插件 可 用于扩展 ChatGPT 功能 , <font color="blue">允许 大模型 与 外部系统 进行交互 ; 可实现如下功能 :</font></p> 
<ul><li><strong>连接 数据库 :</strong> 访问公司数据库 , 获取数据 , 检索内部知识库或个人笔记 ;</li><li><strong>调用 外部 API :</strong> 实现 预订航班 , 订票 等功能 ;</li><li><strong>调用 其他软件服务 :</strong> 获取 股票价格 , 天气预报 , 最新新闻 等实时信息 ;</li></ul> 
<p>ChatGPT 的 Plugins 插件 功能 <font color="red">仅对 付费会员开放 , 只支持 GPT4 以上的模型 在 设置中 开启插件功能 , 之后才能在 聊天过程中 使用 Plugins 插件 ;</font></p> 
<br> 
<h3><a id="3Plugins__56"></a>3、Plugins 插件开发流程</h3> 
<br> 
<p><strong>ChatGPT 的 插件 开发 流程如下 :</strong></p> 
<ul><li><strong>开发环境搭建 :</strong> <font color="blue">申请 OpenAI 的开发者账号 , 获取 API 访问权限 , 配置 Python 或者 Node.js 开发环境 ;</font></li><li><strong>开发插件 :</strong> <font color="red">定义 插件的 功能和接口 , 编写代码实现相应的插件逻辑 , <font color="purple">并在本地测试环境运行插件确保能返回正确结果 ;</font></font></li><li><strong>发布插件 :</strong> <font color="orange">将开发好的插件代码提交的 OpenAI 后台 , <font color="green">按照流程发布审核 , 通过审核后用户即可在 ChatGPT 控制面板中 搜索、安装、使用 该插件 ;</font></font></li></ul> 
<br> 
<h3><a id="4Plugins___Actions__69"></a>4、Plugins 插件弊端 - Actions 引入</h3> 
<br> 
<p>Plugins 插件 在 产品设计 层面 不完善 , <font color="blue">使用 Plugins 插件 需要靠用户 手工选择使用 哪三个 Plugin 插件 , <font color="red">并不能 自动识别 并 自动调用 对应的插件 , 因此 Plugins 插件 功能 在 ChatGPT 中没有推广开 ;</font></font></p> 
<p>基于上述问题 , OpenAI 将 Plugins 升级为了 Actions , 内置到了 GPTs 大模型中 , 解决了上述问题 ;</p> 
<br> 
<h3><a id="5Actions__82"></a>5、Actions 简介</h3> 
<br> 
<p><font color="blue">Actions 是 ChatGPT 内置的一种特定扩展功能 , <font color="red">通常是为了执行简单、快速的任务 ;</font></font></p> 
<p>Actions 由 ChatGPT 平台的开发团队开发 , 外部开发者无法开发 Actions , Actions 开发完成后由 ChatGPT 平台直接支持 , 不需要额外安装 , 可以保证执行效率 和 安全性 ;</p> 
<p>与 Actions 对比 , Plugins 需要额外安装 , 并且只能选 3 个 ;</p> 
<br> 
<br> 
<br> 
<br> 
<h2><a id="ChatGPT___CozeDify_99"></a>二、ChatGPT 的平替 - Coze、Dify</h2> 
<hr> 
<br> 
<p>ChatGPT 经常封号 , 账号申请很麻烦 , 注册各种给添堵 , 即使是付费用户也会被封 , 这里推荐两个平替 ;</p> 
<br> 
<p><strong>字节跳动 coze :</strong> <a href="https://www.coze.com/" rel="nofollow">https://www.coze.com/</a> , 可以直接使用 +86 的中国手机号注册使用 , 这个需要挂上梯子才能用 , 对中国用户比较友好 ;</p> 
<p>免费 ;</p> 
<p>只提供了 Web 界面访问 , 不提供 API 访问 ;</p> 
<p><img src="https://images2.imgbox.com/2e/b9/qcpGqUUW_o.png" alt="在这里插入图片描述"></p> 
<br> 
<p><strong>Dify :</strong> <a href="https://dify.ai/zh" rel="nofollow">https://dify.ai/zh</a> , 这是开源的生成式 AI 平台 , 可以在本地局域网内部部署 ;</p> 
<ul><li><strong>GitHub :</strong> <a href="https://github.com/langgenius/dify">https://github.com/langgenius/dify</a></li></ul> 
<p>提供了 Web 界面访问 和 API 访问 两种方式 ;<br> <img src="https://images2.imgbox.com/c9/d8/HvxkGkf8_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b4/c7/ewlNd8VE_o.png" alt="在这里插入图片描述"></p> 
<p>收费的 , 费用不便宜 ;<br> <img src="https://images2.imgbox.com/7b/76/094E5O0r_o.png" alt="在这里插入图片描述"></p> 
<br> 
<br> 
<br> 
<br> 
<h2><a id="_Function_Calling__139"></a>三、函数调用 Function Calling 引入</h2> 
<hr> 
<br> 
<p><font color="blue">ChatGPT 引入 Plugins、Actions 扩展 , 这些都是针对通用需求开发的 , <font color="red">并不能针对某个公司的某项需求进行功能的适配 , 开发 , 调优 , <font color="purple">集成到公司的某项业务中 , 也不是很方便 ;</font></font></font></p> 
<p>因此 <font color="blue">OpenAI 提供了 函数调用 Function Calling 技术 , <font color="red">用户可以将 自己的业务系统 与 ChatGPT 大模型进行关联使用 ;</font></font></p> 
<p><strong>函数调用 Function Calling 官方文档 :</strong> <a href="https://platform.openai.com/docs/guides/function-calling" rel="nofollow">https://platform.openai.com/docs/guides/function-calling</a></p> 
<p><img src="https://images2.imgbox.com/63/6f/Qv3WWVu8_o.png" alt="在这里插入图片描述"></p> 
<br> 
<p><strong>函数调用 流程 :</strong></p> 
<p>① <font color="blue">开发者 开发的 应用程序 通过 API 调用 OpenAI ,</font></p> 
<p>② 开发者 需要将</p> 
<ul><li><font color="red">Prompt 提示词</font></li><li><font color="purple">Function 函数定义</font></li></ul> 
<p>传给 OpenAI 大模型 ;</p> 
<p>③ <font color="orange">OpenAI GPT 大模型 分析 提示词 , <font color="green">然后分析出 " 函数参数 " , 将 函数调用的参数 返回给 应用软件 ;</font></font></p> 
<p>④ <font color="magenta">在 应用软件 中 调用函数 , 传入 大模型返回的 参数 ;</font></p> 
<p>⑤ <font color="blue">应用软件 调用 函数 得到 结果 , 将结果传递给 GPT 大模型 ;</font></p> 
<p>⑥ <font color="red">GPT 大模型 结合 提示词 和 应用软件 函数调用结果 , 使用 自然语言 返回最终生成结果 ;</font></p> 
<p><img src="https://images2.imgbox.com/a0/a3/v1zhkqyp_o.png" alt="在这里插入图片描述"></p> 
<br> 
<br> 
<br> 
<br> 
<h2><a id="_181"></a>四、函数调用开发流程</h2> 
<hr> 
<br> 
<br> 
<h3><a id="1_OpenAI__190"></a>1、调用 OpenAI 的接口</h3> 
<br> 
<p>① 开发者 开发的 应用程序 通过 API 调用 OpenAI ; 在应用软件中 , 正常调用 OpenAI 软件包的函数 API 即可 ;</p> 
<br> 
<h3><a id="2_201"></a>2、函数定义</h3> 
<br> 
<p>② 开发者 需要将</p> 
<ul><li>Prompt 提示词</li><li>Function 函数定义</li></ul> 
<p>传给 OpenAI 大模型 ;</p> 
<p>提示词 就是 普通的文本 , 这里着重分析下 函数定义 ;</p> 
<p><font color="blue">函数定义 , 需要在 client.chat.completions.create 函数中的 tools 参数中传入 , 此处可以传入多个 json 格式的函数定义 ;</font></p> 
<p><strong>下面开始分析 函数调用 中 函数定义 的 json 描述字段 :</strong></p> 
<ul><li><code>"type": "function"</code> 表示这是一个 <font color="blue">函数描述 ;</font></li><li><code>description: "加法函数,可用于计算若干个数字之和"</code> 这是 <font color="red">对 函数功能 的描述 ;</font></li><li><code>parameters</code> 字段描述 <font color="purple">函数的参数信息 ; </font> 
  <ul><li><code>type: "object"</code> 表示 <font color="orange">函数参数是对象 ;</font></li><li><code>properties </code> 字段 <font color="green">描述对象的属性 ; </font> 
    <ul><li><code>numbers</code> 表示 <font color="magenta">一个数组 , 包含了数字类型的元素 , 表示函数接受一个数字数组作为参数 ;</font></li></ul> </li></ul> </li></ul> 
<pre><code class="prism language-javascript">    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        model<span class="token operator">=</span>model<span class="token punctuation">,</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
        temperature<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
        # 使用 json 描述 函数调用 的 函数信息 <span class="token punctuation">,</span> 包括 函数名 函数描述 函数参数信息 等
        # 可以定义多个 函数调用 <span class="token punctuation">,</span> 具体调用哪个函数 <span class="token punctuation">,</span> 由大模型决定
        # 大模型根据 函数的描述信息 <span class="token punctuation">,</span> 决定调用哪个函数
        tools<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"function"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"sum"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"description"</span><span class="token operator">:</span> <span class="token string">"加法函数,可用于计算若干个数字之和"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"numbers"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                            <span class="token string-property property">"items"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"number"</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre> 
<br> 
<h3><a id="3_254"></a>3、大模型回调</h3> 
<br> 
<p>③ OpenAI GPT 大模型 分析 提示词 , 然后 <font color="blue">分析出 " 函数参数 " , 将 函数调用的参数 返回给 应用软件 ;</font></p> 
<p><font color="red">大模型 收到 提示词 和 函数描述后 , <font color="purple">跟自动判定是否需要 调用 本地提供的 函数调用 ,</font></font></p> 
<p><font color="orange">如果需要 , 则大模型会返回如下信息 ,</font></p> 
<pre><code class="prism language-javascript"><span class="token function">ChatCompletionMessage</span><span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">'assistant'</span><span class="token punctuation">,</span> function_call<span class="token operator">=</span>None<span class="token punctuation">,</span> tool_calls<span class="token operator">=</span><span class="token punctuation">[</span><span class="token function">ChatCompletionMessageToolCall</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'call_LTy6rJlBVFLxAW3OAx3dIJSl'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token operator">=</span><span class="token function">Function</span><span class="token punctuation">(</span>arguments<span class="token operator">=</span><span class="token string">'{"numbers":[1,2,3,4,5]}'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>ChatCompletionMessage</code> 是<font color="blue">消息的主要对象 , 用于描述聊天模型生成的一条完成消息 ;</font></li><li><code>content=''</code> 是 <font color="red">消息的内容 , 空的 , </font>这是由于 GPT 大模型判断出 <font color="purple">需要 进行函数调用 , 本次返回信息专门返回函数调用的一系列参数 ;</font></li><li><code>role='assistant'</code> 表示 <font color="orange">消息的角色 , 消息是由 assistant 生成的 ;</font></li><li><code>function_call=None</code> 描述一个 <font color="green">函数调用的对象 , 但在这个例子中是空的 ;</font></li><li><code>tool_calls</code> :工具调用 , 此处放的是 函数调用的 参数信息 ; 
  <ul><li><code>ChatCompletionMessageToolCall</code> 是 <font color="blue">工具调用的描述对象 , 包含了多个工具调用信息 ;</font></li></ul> </li></ul> 
<p>核心就是</p> 
<pre><code class="prism language-javascript">tool_calls<span class="token operator">=</span><span class="token punctuation">[</span><span class="token function">ChatCompletionMessageToolCall</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'call_LTy6rJlBVFLxAW3OAx3dIJSl'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token operator">=</span><span class="token function">Function</span><span class="token punctuation">(</span>arguments<span class="token operator">=</span><span class="token string">'{"numbers":[1,2,3,4,5]}'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<ul><li><code>id='call_LTy6rJlBVFLxAW3OAx3dIJSl'</code> : 是 <font color="blue">工具调用的唯一标识符 , 可能用于跟踪和识别特定的调用。</font></li><li><code>function=Function(arguments='{"numbers":[1,2,3,4,5]}', name='sum')</code> 参数描述了一个 <font color="red">函数调用 ; </font> 
  <ul><li><code>arguments='{"numbers":[1,2,3,4,5]}'</code> 表示 <font color="blue">函数调用的参数 ;</font></li><li><code>name='sum'</code> 表示 <font color="purple">调用的函数名是 sum ;</font></li></ul> </li><li><code>type='function'</code> 表示 <font color="blue">这个工具调用是一个函数类型的调用;</font></li></ul> 
<br> 
<h3><a id="4_290"></a>4、本地代码逻辑</h3> 
<br> 
<p>④ 在 应用软件 中 调用函数 , 传入 大模型返回的 参数 ;</p> 
<p><font color="blue">如果发现 GPT 大模型返回的 tool_calls 字段 , <font color="red">就说明需要进行函数调用 , <font color="purple">收到对应的 函数调用 请求后 , 开始进行逻辑计算 ;</font></font></font></p> 
<p><strong>将计算结果 封装到 json 中 , 如下代码所示 :</strong></p> 
<pre><code class="prism language-javascript">    # 将本地的 函数调用结果 封装为指定格式的 json 串
    messages<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"tool_call_id"</span><span class="token operator">:</span> tool_call<span class="token punctuation">.</span>id<span class="token punctuation">,</span>  # 用于标识函数调用的 <span class="token constant">ID</span>
            <span class="token string-property property">"role"</span><span class="token operator">:</span> <span class="token string">"tool"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"sum"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token function">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>  # 数值result 必须转成字符串
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
</code></pre> 
<ul><li><code>"tool_call_id": tool_call.id</code> <font color="blue">用于标识函数调用的 ID , 在前面的 函数调用 参数 json 中可以找到 , 是 <font color="red">call_LTy6rJlBVFLxAW3OAx3dIJSl 值 ;</font></font></li><li><code>"role": "tool"</code> 指示 <font color="purple">条目的角色是工具 tool , 与前面提到的 <code>role='assistant'</code> 相对应 ;</font></li><li><code>"name": "sum"</code> <font color="blue">设置函数的名称 , 这里是 sum 函数调用结果 ;</font></li><li><code>"content": str(result)</code> 是 <font color="red">函数调用的结果 , 转为字符串 ;</font></li></ul> 
<br> 
<h3><a id="5_320"></a>5、第二次大模型调用</h3> 
<br> 
<p>⑤ 应用软件 调用 函数 得到 结果 , 将结果传递给 GPT 大模型 ;</p> 
<p>⑥ GPT 大模型 结合 提示词 和 应用软件 函数调用结果 , 使用 自然语言 返回最终生成结果 ;</p> 
<br> 
<br> 
<br> 
<br> 
<h2><a id="_339"></a>五、函数调用代码示例</h2> 
<hr> 
<br> 
<p><strong>代码示例 :</strong></p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> json

from openai <span class="token keyword">import</span> OpenAI

client <span class="token operator">=</span> <span class="token function">OpenAI</span><span class="token punctuation">(</span>
    api_key<span class="token operator">=</span><span class="token string">"sk-6o3KJuuocEXpb1Ug39D0A4913a844fCaBa892eDe9814Df8a"</span><span class="token punctuation">,</span>
    base_url<span class="token operator">=</span><span class="token string">"https://api.xiaoai.plus/v1"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

def <span class="token function">get_completion</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">"gpt-3.5-turbo-1106"</span><span class="token punctuation">)</span><span class="token operator">:</span>
    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        model<span class="token operator">=</span>model<span class="token punctuation">,</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
        temperature<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
        # 使用 json 描述 函数调用 的 函数信息 <span class="token punctuation">,</span> 包括 函数名 函数描述 函数参数信息 等
        # 可以定义多个 函数调用 <span class="token punctuation">,</span> 具体调用哪个函数 <span class="token punctuation">,</span> 由大模型决定
        # 大模型根据 函数的描述信息 <span class="token punctuation">,</span> 决定调用哪个函数
        tools<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"function"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"sum"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"description"</span><span class="token operator">:</span> <span class="token string">"加法函数,可用于计算若干个数字之和"</span><span class="token punctuation">,</span>
                <span class="token string-property property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                    <span class="token string-property property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">"numbers"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                            <span class="token string-property property">"items"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"number"</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message

# 提示词
prompt <span class="token operator">=</span> <span class="token string">"计算 1+2+3+4+5 的结果"</span>

# 将提示词封装到 message 中
messages <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string-property property">"role"</span><span class="token operator">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token string">"计算数学式子"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token string-property property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string-property property">"content"</span><span class="token operator">:</span> prompt<span class="token punctuation">}</span>
<span class="token punctuation">]</span>

# 第一次调用 <span class="token operator">:</span> 将 提示词 和 函数定义 传给 <span class="token constant">GPT</span> 大模型
response <span class="token operator">=</span> <span class="token function">get_completion</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span>

# 解决 OpenAI <span class="token number">400</span> bug
<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>content is None<span class="token punctuation">)</span><span class="token operator">:</span>
    response<span class="token punctuation">.</span>content <span class="token operator">=</span> <span class="token string">""</span>

# 把大模型的回复加入到对话历史中
messages<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"第一次 将 提示词 和 函数定义 传给 GPT 大模型 的 回复 :"</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>

# 拿到第一次回复后 <span class="token punctuation">,</span> 查看是否需要执行 函数调用
# 如果 tool_calls 不为空 <span class="token punctuation">,</span> 则需要进行函数调用
# 下面就是 tool_calls 字段
# tool_calls<span class="token operator">=</span><span class="token punctuation">[</span><span class="token function">ChatCompletionMessageToolCall</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'call_Qr0uXYu6C6CZ2JhTWWnPNVl9'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token operator">=</span><span class="token function">Function</span><span class="token punctuation">(</span>arguments<span class="token operator">=</span><span class="token string">'{"numbers":[1,2,3,4,5,6,7,8,9,10]}'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>tool_calls is not None<span class="token punctuation">)</span><span class="token operator">:</span>
    # 是否要调用 sum
    tool_call <span class="token operator">=</span> response<span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    # 判定 大模型 要调用的函数的 函数名称 <span class="token punctuation">,</span> 就是 name 字段
    # 根据不同的函数名称 <span class="token punctuation">,</span> 执行不同的代码逻辑
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">"sum"</span><span class="token punctuation">)</span><span class="token operator">:</span>
        # 获取函数的一系列参数
        args <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">loads</span><span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span>

        # 调用 Python 内置函数 <span class="token punctuation">,</span> 进行加法运算
        result <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token string">"numbers"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\nsum 函数调用 返回结果 : "</span><span class="token punctuation">)</span>
        <span class="token function">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

    # 将本地的 函数调用结果 封装为指定格式的 json 串
    messages<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"tool_call_id"</span><span class="token operator">:</span> tool_call<span class="token punctuation">.</span>id<span class="token punctuation">,</span>  # 用于标识函数调用的 <span class="token constant">ID</span>
            <span class="token string-property property">"role"</span><span class="token operator">:</span> <span class="token string">"tool"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"sum"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"content"</span><span class="token operator">:</span> <span class="token function">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>  # 数值result 必须转成字符串
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>

    # 再次调用大模型
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"\n第二次将 提示词 函数定义 和 函数调用结果 传给 GPT 大模型 的 回复 : "</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token function">get_completion</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span>
</code></pre> 
<p><strong>执行结果 :</strong></p> 
<pre><code class="prism language-javascript"><span class="token constant">Y</span><span class="token operator">:</span>\002_WorkSpace\PycharmProjects\pythonProject\venv\Scripts\python<span class="token punctuation">.</span>exe <span class="token constant">Y</span><span class="token operator">:</span><span class="token operator">/</span>002_WorkSpace<span class="token operator">/</span>PycharmProjects<span class="token operator">/</span>HelloPython<span class="token operator">/</span>FunctionCalling<span class="token punctuation">.</span>py
第一次 将 提示词 和 函数定义 传给 <span class="token constant">GPT</span> 大模型 的 回复 <span class="token operator">:</span>
<span class="token function">ChatCompletionMessage</span><span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">'assistant'</span><span class="token punctuation">,</span> function_call<span class="token operator">=</span>None<span class="token punctuation">,</span> tool_calls<span class="token operator">=</span><span class="token punctuation">[</span><span class="token function">ChatCompletionMessageToolCall</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">'call_LTy6rJlBVFLxAW3OAx3dIJSl'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token operator">=</span><span class="token function">Function</span><span class="token punctuation">(</span>arguments<span class="token operator">=</span><span class="token string">'{"numbers":[1,2,3,4,5]}'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sum'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token operator">=</span><span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

sum 函数调用 返回结果 <span class="token operator">:</span> 
<span class="token number">15</span>

第二次将 提示词 函数定义 和 函数调用结果 传给 <span class="token constant">GPT</span> 大模型 的 回复 <span class="token operator">:</span> 
<span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">=</span> <span class="token number">15.</span>

Process finished <span class="token keyword">with</span> exit code <span class="token number">0</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/7c/74/Zv4nPAZs_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9346da4ef5cb479968e7d086d67a0531/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">huawei USG6001v1学习---防火墙高可靠性（双机热备）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/699c92201064ece94e2247579c2e9a4a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SpringBoot中fastjson扩展: 自定义序列化和反序列化方法实战</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>