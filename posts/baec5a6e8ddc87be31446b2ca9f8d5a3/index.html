<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Activity 的启动流程（Android 13） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/baec5a6e8ddc87be31446b2ca9f8d5a3/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Activity 的启动流程（Android 13）">
  <meta property="og:description" content="Activity 的启动过程分为两种：一种是普通 Activity 的启动过程，另一种是根 Activity 的启动过程。普通 Activity 指的是除应用程序启动的第一个 Activity 之外的其他 Activity。根 Activity 指的是应用程序启动的第一个 Activity，因此，根 Activity 的启动过程一般情况下也可以理解为应用程序的启动过程。
1 普通 Activity 的启动流程 普通 Activity 的启动流程比较复杂，比如用 Activity A 打开 Activity B，这一过程开始于 A.startActivity(Intent) 经过 system_server 进程的处理，最终调用 B.finish() 结束生命周期。
普通 Activity 的启动流程可以分为以下 3 部分：
Activity 请求 ActivityTaskManagerService(ATMS) 的过程ATMS 到 ApplicationThread 的调用过程ActivityThread 启动 Activity； 1.1 Activity 请求 ActivityTaskManagerService(ATMS) 的过程 以下是 Activity 请求 ATMS 的时序图：
Instrumentation 负责调用 Activity 和 Application 的生命周期，具有跟踪 Application 和 Activity 生命周期的功能。 以下是 Instrumentation.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-11-25T13:06:48+08:00">
    <meta property="article:modified_time" content="2023-11-25T13:06:48+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Activity 的启动流程（Android 13）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>Activity 的启动过程分为两种：一种是普通 Activity 的启动过程，另一种是根 Activity 的启动过程。普通 Activity 指的是除应用程序启动的第一个 Activity 之外的其他 Activity。<strong>根 Activity 指的是应用程序启动的第一个 Activity，因此，根 Activity 的启动过程一般情况下也可以理解为应用程序的启动过程。</strong></p> 
<h4><a id="1__Activity__3"></a>1 普通 Activity 的启动流程</h4> 
<p>普通 Activity 的启动流程比较复杂，比如用 Activity A 打开 Activity B，这一过程开始于 A.startActivity(Intent) 经过 system_server 进程的处理，最终调用 B.finish() 结束生命周期。</p> 
<p><strong>普通 Activity 的启动流程可以分为以下 3 部分：</strong></p> 
<ul><li><strong>Activity 请求 ActivityTaskManagerService(ATMS) 的过程</strong></li><li><strong>ATMS 到 ApplicationThread 的调用过程</strong></li><li><strong>ActivityThread 启动 Activity；</strong></li></ul> 
<h5><a id="11_Activity__ActivityTaskManagerServiceATMS__13"></a>1.1 Activity 请求 ActivityTaskManagerService(ATMS) 的过程</h5> 
<p>以下是 Activity 请求 ATMS 的时序图：</p> 
<p><img src="https://images2.imgbox.com/5d/3c/KUVuJIsF_o.png" alt="Activity 启动时序图_1" width="100%" height="100%"></p> 
<p><strong>Instrumentation 负责调用 Activity 和 Application 的生命周期，具有跟踪 Application 和 Activity 生命周期的功能。</strong> 以下是 Instrumentation.execStartActivity 方法的相关源码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Instrumentation</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">ActivityResult</span> <span class="token function">execStartActivity</span><span class="token punctuation">(</span>
          <span class="token class-name">Context</span> who<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> contextThread<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token class-name">Activity</span> target<span class="token punctuation">,</span>
          <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token class-name">ActivityTaskManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>whoThread<span class="token punctuation">,</span>
                    who<span class="token punctuation">.</span><span class="token function">getOpPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> who<span class="token punctuation">.</span><span class="token function">getAttributionTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> intent<span class="token punctuation">,</span>
                    intent<span class="token punctuation">.</span><span class="token function">resolveTypeIfNeeded</span><span class="token punctuation">(</span>who<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span>
                    target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span>mEmbeddedID <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> 
                    requestCode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处调用了 ActivityTaskManager.getService() 方法来获取 ATMS 的代理对象，接着调用了它的 startActivity 方法。以下是 ActivityTaskManager.getService() 的相关源码：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SystemService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_TASK_SERVICE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTaskManager</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">IActivityTaskManager</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">IActivityTaskManagerSingleton</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityTaskManager</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">IActivityTaskManagerSingleton</span> <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IActivityTaskManager</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">protected</span> <span class="token class-name">IActivityTaskManager</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">final</span> <span class="token class-name">IBinder</span> b <span class="token operator">=</span> 
                      	<span class="token class-name">ServiceManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">Context</span><span class="token punctuation">.</span><span class="token constant">ACTIVITY_TASK_SERVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
                    <span class="token keyword">return</span> <span class="token class-name">IActivityTaskManager<span class="token punctuation">.</span>Stub</span><span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment">// /frameworks/base/core/java/android/content/Context.java</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ACTIVITY_TASK_SERVICE</span> <span class="token operator">=</span> <span class="token string">"activity_task"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>ActivityTaskManager：是实现 Activity 与 ATMS 跨进程交互的接口，ATMS 的辅助类。</strong></p> 
<p>从上述代码中可知，ActivityTaskManager.getService() 调用了 IActivityTaskManagerSingleton.get() 方法，IActivityTaskManagerSingleton 是一个 Singleton 类。注释 1 处得到一个名为 “activity_task” 的 Service 的引用，也就是 IBinder 类型的 ATMS 的引用。</p> 
<p><strong>在注释 2 处将它转换成 IActivityTaskManager 类型的对象，这段代码采用的 AIDL，IActivityManager.java 类是由 AIDL 工具在编译时自动生成的，IActivityTaskManager.aidl 的文件路径为 /frameworks/base/core/java/android/app/IActivityTaskManager.aidl。要实现进程间通信，服务器端也就是 ATMS 只需要继承 IActivityTaskManager.Stub 类并实现相应的方法就可以了。IActivityTaskManager 是 ATMS 在本地的代理。</strong></p> 
<p>以下是相关相关源码：</p> 
<pre><code class="prism language-java"><span class="token keyword">interface</span> <span class="token class-name">IActivityTaskManager</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span>in <span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> in <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
            in <span class="token class-name">String</span> callingFeatureId<span class="token punctuation">,</span> in <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> in <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>
            in <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> in <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span>
            <span class="token keyword">int</span> flags<span class="token punctuation">,</span> in <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> in <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * System service for managing activities and their containers(task, displays, ...)
 * 
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTaskManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IActivityTaskManager<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
          <span class="token class-name">String</span> callingFeatureId<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span> 
          <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> 
                                   <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span>caller<span class="token punctuation">,</span> callingPackage<span class="token punctuation">,</span> callingFeatureId<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> 	
                                 resolvedType<span class="token punctuation">,</span> resultTo<span class="token punctuation">,</span> resultWho<span class="token punctuation">,</span> requestCode<span class="token punctuation">,</span> 
                                 startFlags<span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> bOptions<span class="token punctuation">,</span>
                                 <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">getCallingUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>ActivityTaskManagerService：是管理 Activity 以及其容器（task、stacks、displays）的系统服务，负责 Activity 管理和调度工作（Android 10 中新增）。ATMS 是 AMS 的一个辅助类，分担了 AMS 的一部分功能，继承自 IActivityTaskManager.Stub。</strong></p> 
<h5><a id="12_ATMS__ApplicationThread__106"></a>1.2 ATMS 到 ApplicationThread 的调用过程</h5> 
<p>Activity 请求 ATMS 后，代码逻辑就就进入到 ATMS 中，接着就是 ATMS 到 ApplicationThread 的调用流程，时序图如下所示：</p> 
<p><img src="https://images2.imgbox.com/e1/a7/tq5ip2JN_o.png" alt="Activity 启动时序图_2" width="100%" height="100%"></p> 
<p>ATMS.startActivity 方法会调用其 startActivityAsUser 方法，在 ATMS.startActivityAsUser 方法中会调用 ATMS.getActivityStartController() 方法获取 ActivityStartController 对象：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTaskManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IActivityTaskManager<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token keyword">private</span> <span class="token class-name">ActivityStartController</span> mActivityStartController<span class="token punctuation">;</span>
  
  	<span class="token class-name">ActivityStartController</span> <span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mActivityStartController<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  	<span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">startActivityAsUser</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> caller<span class="token punctuation">,</span> <span class="token class-name">String</span> callingPackage<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> callingFeatureId<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> resolvedType<span class="token punctuation">,</span>
            <span class="token class-name">IBinder</span> resultTo<span class="token punctuation">,</span> <span class="token class-name">String</span> resultWho<span class="token punctuation">,</span> <span class="token keyword">int</span> requestCode<span class="token punctuation">,</span> <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span>
            <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> bOptions<span class="token punctuation">,</span> <span class="token keyword">int</span> userId<span class="token punctuation">,</span> 
            <span class="token keyword">boolean</span> validateIncomingUser<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      
     	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
      <span class="token keyword">return</span> <span class="token function">getActivityStartController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">obtainStarter</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token string">"startActivityAsUser"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCaller</span><span class="token punctuation">(</span>caller<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCallingPackage</span><span class="token punctuation">(</span>callingPackage<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setCallingFeatureId</span><span class="token punctuation">(</span>callingFeatureId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setResolvedType</span><span class="token punctuation">(</span>resolvedType<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setResultTo</span><span class="token punctuation">(</span>resultTo<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setResultWho</span><span class="token punctuation">(</span>resultWho<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setRequestCode</span><span class="token punctuation">(</span>requestCode<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setStartFlags</span><span class="token punctuation">(</span>startFlags<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setProfilerInfo</span><span class="token punctuation">(</span>profilerInfo<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setActivityOptions</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>ActivityStartController 是用于 Activity 启动的控制器。</strong> 通过调用其 obtainStarter 方法来获取 ActivityStarter 对象：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Controller for delegating activity launches. 
 * Activity 的启动的控制器
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityStartController</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">/**
     * 返回一个启动器来配置和执行 Activity 的启动
     */</span>
    <span class="token class-name">ActivityStarter</span> <span class="token function">obtainStarter</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mFactory<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIntent</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>ActivityStarter 是 Android 7.0 中新加入的类，是 Activity 的控制器，讲如何启动一个 Activity，会收集所有的逻辑来决定如何将 Intent 和 Flags 转换为 Activity，并将 Activity 和 Task 以及 Stack 相关联。</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Controller for interpreting how and then launching an activity.
 * 
 * This class collects all the logic for determining how an intent and flags should be 
 * turned into an activity and associated task and root task.
 */</span>
<span class="token keyword">class</span> <span class="token class-name">ActivityStarter</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>Task 就是用户在执行某项工作时与之相关联的 Activity 集合。系统通过任务栈来管理这些 Activity，它们按照打开的顺序进入任务栈中。这些 Activity 可以来自同一个 APP，也可以来自不同的 APP，Activity 之间不一定非要有关联。</strong></p> 
<p>当按 Home 键旁边的那个方形键（recent-apps）时，屏幕上展示的就是一个个的 Task。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * {@link Task} is a TaskFragment that can contain a group of activities to perform a certain 
 * job.  Task 是 TaskFragment 的子类，可以包含执行某个任务的一组 activities。
 * 
 * Activities of the same task affinities usually group in the same {@link Task}. 
 * 具有相同的 task affinities 的 activities 通常分在同一个 Task 中
 * 
 * A {@link Task} can also be an entity that showing in the Recents Screen for a job that 
 * user interacted with.
 * 按下 Home 键旁边的那个方形键（recent-apps）时，屏幕上展示的就是一个个的 Task
 * 
 * A {@link Task} can also contain other {@link Task}s.
 * 一个 Task 也可以包含其他的 Task
 */</span>
<span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token keyword">extends</span> <span class="token class-name">TaskFragment</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>

<span class="token comment">/**
 * A basic container that can be used to contain activities or other {@link TaskFragment}, 
 * which also able to manage the activity lifecycle and updates the visibilities of the 
 * activities in it.
 * 一个容器，可以用来放 activities 或者其它的 TaskFragment，也能够管理 activity 的生命周期或者更新
 * activities 的可见性。
 */</span>
<span class="token keyword">class</span> <span class="token class-name">TaskFragment</span> <span class="token keyword">extends</span> <span class="token class-name">WindowContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WindowContainer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p>task affinity：在 manifest 文件中，注册 activity 时如果不申明 taskAffinity 属性，就是 APP 程序的默认包名，默认情况下，一个 APP 中所有的 Activity 都在一个 Task 中：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span>
		<span class="token attr-name"><span class="token namespace">android:</span>taskAffinity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span>
		<span class="token attr-name">...</span>
<span class="token punctuation">/&gt;</span></span>
</code></pre> 
<p>启动根 Activity 时会将 Intent 的 Flag 设置为 FLAG_ACTIVITY_NEW_TASK，表示要创建一个新的 Task：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">ActivityStarter</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token keyword">private</span> <span class="token class-name">Task</span> mTargetRootTask<span class="token punctuation">;</span>
  	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RootWindowContainer</span> mRootWindowContainer<span class="token punctuation">;</span>
  	
    <span class="token keyword">private</span> <span class="token class-name">Task</span> <span class="token function">computeTargetTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mStartActivity<span class="token punctuation">.</span>resultTo <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> mInTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mAddingToTask
              <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mLaunchFlags <span class="token operator">&amp;</span> <span class="token constant">FLAG_ACTIVITY_NEW_TASK</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 1</span>
          <span class="token comment">// A new task should be created instead of using existing one.</span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mSourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mInTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInTask<span class="token punctuation">.</span><span class="token function">isAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">getOrCreateRootTask</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> mLaunchFlags<span class="token punctuation">,</span> mInTask<span class="token punctuation">,</span> mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> mInTask<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">final</span> <span class="token class-name">Task</span> rootTask <span class="token operator">=</span> <span class="token function">getOrCreateRootTask</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> mLaunchFlags<span class="token punctuation">,</span> 
                                                    <span class="token keyword">null</span> <span class="token comment">/* task */</span><span class="token punctuation">,</span> mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> top <span class="token operator">=</span> rootTask<span class="token punctuation">.</span><span class="token function">getTopNonFinishingActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>top <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> top<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              rootTask<span class="token punctuation">.</span><span class="token function">removeIfPossible</span><span class="token punctuation">(</span><span class="token string">"computeTargetTask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setNewTask</span><span class="token punctuation">(</span><span class="token class-name">Task</span> taskToAffiliate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> toTop <span class="token operator">=</span> <span class="token operator">!</span>mLaunchTaskBehind <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mAvoidMoveToFront<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">Task</span> task <span class="token operator">=</span> mTargetRootTask<span class="token punctuation">.</span><span class="token function">reuseOrCreateTask</span><span class="token punctuation">(</span>
                mStartActivity<span class="token punctuation">.</span>info<span class="token punctuation">,</span> mIntent<span class="token punctuation">,</span> mVoiceSession<span class="token punctuation">,</span>
                mVoiceInteractor<span class="token punctuation">,</span> toTop<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span> mSourceRecord<span class="token punctuation">,</span> mOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span>mTransitionController<span class="token punctuation">.</span><span class="token function">collectExistenceChange</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addOrReparentStartingActivity</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token string">"setTaskFromReuseOrCreateNewTask"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">ProtoLog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">WM_DEBUG_TASKS</span><span class="token punctuation">,</span> <span class="token string">"Starting new activity %s in new task %s"</span><span class="token punctuation">,</span>
                mStartActivity<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>taskToAffiliate <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mStartActivity<span class="token punctuation">.</span><span class="token function">setTaskToAffiliateWith</span><span class="token punctuation">(</span>taskToAffiliate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">int</span> <span class="token function">startActivityInner</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">ActivityRecord</span> sourceRecord<span class="token punctuation">,</span>
            <span class="token class-name">IVoiceInteractionSession</span> voiceSession<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
            <span class="token keyword">int</span> startFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> doResume<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token class-name">Task</span> inTask<span class="token punctuation">,</span>
            <span class="token class-name">TaskFragment</span> inTaskFragment<span class="token punctuation">,</span> <span class="token annotation punctuation">@BalCode</span> <span class="token keyword">int</span> balCode<span class="token punctuation">,</span>
            <span class="token class-name">NeededUriGrants</span> intentGrants<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// Compute if there is an existing task that should be used for.</span>
        <span class="token keyword">final</span> <span class="token class-name">Task</span> targetTask <span class="token operator">=</span> reusedTask <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> reusedTask <span class="token operator">:</span> <span class="token function">computeTargetTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> newTask <span class="token operator">=</span> targetTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
        mTargetTask <span class="token operator">=</span> targetTask<span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 4</span>
            <span class="token keyword">final</span> <span class="token class-name">Task</span> taskToAffiliate <span class="token operator">=</span> <span class="token punctuation">(</span>mLaunchTaskBehind <span class="token operator">&amp;&amp;</span> mSourceRecord <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token operator">?</span> mSourceRecord<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token function">setNewTask</span><span class="token punctuation">(</span>taskToAffiliate<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mAddingToTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">addOrReparentStartingActivity</span><span class="token punctuation">(</span>targetTask<span class="token punctuation">,</span> <span class="token string">"adding to task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTaskSwitch <span class="token operator">=</span> startedTask <span class="token operator">!=</span> prevTopTask <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>startedTask<span class="token punctuation">.</span><span class="token function">isEmbedded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mTargetRootTask<span class="token punctuation">.</span><span class="token function">startActivityLocked</span><span class="token punctuation">(</span>mStartActivity<span class="token punctuation">,</span> topRootTask<span class="token punctuation">,</span> newTask<span class="token punctuation">,</span> 
                                            isTaskSwitch<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span> sourceRecord<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mDoResume<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                mRootWindowContainer<span class="token punctuation">.</span><span class="token function">resumeFocusedTasksTopActivities</span><span class="token punctuation">(</span>
                        mTargetRootTask<span class="token punctuation">,</span> mStartActivity<span class="token punctuation">,</span> mOptions<span class="token punctuation">,</span> mTransientLaunch<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 7</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> <span class="token constant">START_SUCCESS</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p>如果注释 4 处的条件满足，表示需要创建一个新的 Task。在注释 6 处调用的是 Task.startActivityLocked 方法，注释 7 处调用的是 RootWindowContainer.resumeFocusedTasksTopActivities 方法。</p> 
<p><strong>RootWindowContainer 表示窗口容器的根容器，是整个屏幕最顶层的容器。</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/** 
 * Root {@link WindowContainer} for the device. 
 * 设备的根
 */</span>
<span class="token keyword">class</span> <span class="token class-name">RootWindowContainer</span> <span class="token keyword">extends</span> <span class="token class-name">WindowContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DisplayContent</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">DisplayManager<span class="token punctuation">.</span>DisplayListener</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>ActivityRecord：记录 Activity 的信息；TaskRecord：记录 Task 的信息；ActivityStack：栈信息；</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token keyword">extends</span> <span class="token class-name">TaskFragment</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">resumeTopActivityInnerLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> prev<span class="token punctuation">,</span> 
                                       <span class="token class-name">ActivityOptions</span> options<span class="token punctuation">,</span> <span class="token keyword">boolean</span> deferPause<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

				<span class="token comment">// 1</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> topActivity <span class="token operator">=</span> <span class="token function">topRunningActivity</span><span class="token punctuation">(</span><span class="token boolean">true</span> <span class="token comment">/* focusableOnly */</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>topActivity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// There are no activities left in this task, let's look somewhere else.</span>
            <span class="token keyword">return</span> <span class="token function">resumeNextFocusableActivityWhenRootTaskIsEmpty</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> resumed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">TaskFragment</span> topFragment <span class="token operator">=</span> topActivity<span class="token punctuation">.</span><span class="token function">getTaskFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        resumed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> topFragment<span class="token punctuation">.</span><span class="token function">resumeTopActivity</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> options<span class="token punctuation">,</span> deferPause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> resumed<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  	
    <span class="token class-name">ActivityRecord</span> <span class="token function">topRunningActivity</span><span class="token punctuation">(</span><span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token keyword">int</span> taskId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">PooledPredicate</span> p <span class="token operator">=</span> <span class="token class-name">PooledLambda</span><span class="token punctuation">.</span><span class="token function">obtainPredicate</span><span class="token punctuation">(</span><span class="token class-name">Task</span><span class="token operator">::</span><span class="token function">isTopRunning</span><span class="token punctuation">,</span>
                <span class="token class-name">PooledLambda</span><span class="token punctuation">.</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> taskId<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">ActivityRecord</span> r <span class="token operator">=</span> <span class="token function">getActivity</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处调用 topRunningActivity 方法获取栈顶不是处于停止状态的 ActivityRecord，此处的栈指的是要启动的 Activity 所在的栈。</p> 
<p><strong>从注释上来看，ActivityTaskSupervisor，翻译过来是“活动任务主管”，从注释中可以看出，这个类已经变成了垃圾倾倒场，页面层级相关的代码移动到 RootWindowContainer 中，与 Activity 生命周期相关的移动到 ActivityLifeCycler 中，接口相关的代码移动到 ATMS 中，等等。</strong></p> 
<p><strong>从功能上来看，可以理解成 ActivityTaskSupervisor 是用来辅助 ATMS 来对 Activity 和 Task 进行管理的。</strong></p> 
<pre><code class="prism language-java"><span class="token comment">// TODO: This class has become a dumping ground. Let's</span>
<span class="token comment">// 这个类已经变成了垃圾请倒场</span>
<span class="token comment">// - Move things relating to the hierarchy to RootWindowContainer</span>
<span class="token comment">// - 把与层级相关的代码移动到 RootWindowContainer 中</span>
<span class="token comment">// - Move things relating to activity life cycles to maybe a new class called ActivityLifeCycler</span>
<span class="token comment">// - 与 Activity 生命周期相关的代码移动到 ActivityLifeCycler 中</span>
<span class="token comment">// - Move interface things to ActivityTaskManagerService.</span>
<span class="token comment">// - 接口相关的移动到 ActivityTaskManagerService 中</span>
<span class="token comment">// - All other little things to other files.</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTaskSupervisor</span> <span class="token keyword">implements</span> <span class="token class-name">RecentTasks<span class="token punctuation">.</span>Callbacks</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">ActivityTaskManagerService</span> mService<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">startSpecificActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1 Is this activity's application already running?</span>
        <span class="token keyword">final</span> <span class="token class-name">WindowProcessController</span> wpc <span class="token operator">=</span>
                mService<span class="token punctuation">.</span><span class="token function">getProcessController</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> knownToBeDead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wpc <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> wpc<span class="token punctuation">.</span><span class="token function">hasThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> wpc<span class="token punctuation">,</span> andResume<span class="token punctuation">,</span> checkConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Exception when starting activity "</span>
                        <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span><span class="token function">notifyUnknownVisibilityLaunchedForKeyguardTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTop <span class="token operator">=</span> andResume <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">isTopRunningActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span><span class="token function">startProcessAsync</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> isTop<span class="token punctuation">,</span>
                isTop <span class="token operator">?</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">.</span><span class="token constant">HOSTING_TYPE_TOP_ACTIVITY</span>
                        <span class="token operator">:</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">.</span><span class="token constant">HOSTING_TYPE_ACTIVITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处的来判断当前的 Activity 所在的应用程序进程是否存在，如果存在则调用注释 2 处的 realStartActivityLocked 方法继续 Activity 的启动流程，如果不存在在调用注释 3 处 ATMS.startProcessAsync 方法创建进程。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * The Activity Manager (AM) package manages the lifecycle of processes in the system through
 * ProcessRecord. Activity Manager（AM）包通过 ProcessRecord 来管理系统中进程的生命周期
 * 
 * However, it is important for the Window Manager (WM) package to be aware
 * of the processes and their state since it affects how WM manages windows and activities. 
 * 但是，对于 Window Manager（WM）包来说，了解进程以及其状态是十分重要的，因为它会影响 Window Manager 管
 * 理 windows 和 activities 的方式 
 * 
 * This class that allows the ProcessRecord object in the AM package to communicate important
 * changes to its state to the WM package in a structured way. 
 * 这个类允许 ProcessRecord 对象以结构化的方式将其状态的重要改变传到给 WM 包
 * 
 * WM package also uses {@link WindowProcessListener} to request changes to the process state 
 * on the AM side.
 * WM 包也使用 WindowProcessListener 来请求更改 AM 端的进程状态
 * 
 * Note that public calls into this class are assumed to be originating from outside the
 * window manager so the window manager lock is held and appropriate permissions are checked 
 * before calls are allowed to proceed.
 * 请注意，假定对该类的公共调用来自窗口管理器的外部，因此将该持有窗口管理器锁，并在允许调用继续进行之前检查适当
 * 的权限。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowProcessController</span> <span class="token keyword">extends</span> <span class="token class-name">ConfigurationContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationContainer</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">ConfigurationContainerListener</span> <span class="token punctuation">{<!-- --></span>
  
  	<span class="token keyword">private</span> <span class="token class-name">IApplicationThread</span> mThread<span class="token punctuation">;</span>
  	
  	<span class="token class-name">IApplicationThread</span> <span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mThread<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> <span class="token function">hasThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mThread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c9/bf/uGxL11BZ_o.png" alt="Activity 启动时序图_3" width="100%" height="100%"></p> 
<p>在 ActivityTaskSupervisor.realStartActivityLocked 方法中会调用 <code>mService.getLifecycleManager().scheduleTransaction(clientTransaction);</code>，这里的 mService 是 ATMS。</p> 
<p><strong>在 ActivityTaskManagerService 中初始化了 ClientLifecycleManager（客户端事务管理类）的唯一实例，因此，所有的有关事务的操作都必须通过 ATMS 实例来发起。</strong> 以下是 ATMS 中的 ClientLifecycleManager 的相关初始化与获取操作：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTaskManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IActivityTaskManager<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{<!-- --></span>
  
  	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClientLifecycleManager</span> mLifecycleManager<span class="token punctuation">;</span>
  
  	<span class="token keyword">public</span> <span class="token class-name">ActivityTaskManagerService</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      	mLifecycleManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
  
    <span class="token class-name">ClientLifecycleManager</span> <span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mLifecycleManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTaskSupervisor</span> <span class="token keyword">implements</span> <span class="token class-name">RecentTasks<span class="token punctuation">.</span>Callbacks</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">ActivityTaskManagerService</span> mService<span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">WindowProcessController</span> proc<span class="token punctuation">,</span>
                  <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>

      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// Create activity launch transaction.</span>
        <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> clientTransaction <span class="token operator">=</span> <span class="token class-name">ClientTransaction</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>
        proc<span class="token punctuation">.</span><span class="token function">getThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTransitionForward <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">isTransitionForward</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">IBinder</span> fragmentToken <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getTaskFragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFragmentToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注意：LaunchActivityItem</span>
        clientTransaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token class-name">LaunchActivityItem</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
              <span class="token comment">// TODO: Have this take the merged configuration instead of separate global</span>
              <span class="token comment">// and override configs.</span>
              mergedConfiguration<span class="token punctuation">.</span><span class="token function">getGlobalConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              mergedConfiguration<span class="token punctuation">.</span><span class="token function">getOverrideConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>compat<span class="token punctuation">,</span>
              r<span class="token punctuation">.</span><span class="token function">getFilteredReferrer</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>launchedFromPackage<span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span>
              proc<span class="token punctuation">.</span><span class="token function">getReportedProcState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">getSavedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">getPersistentSavedState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              results<span class="token punctuation">,</span> newIntents<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">takeOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> isTransitionForward<span class="token punctuation">,</span>
              proc<span class="token punctuation">.</span><span class="token function">createProfilerInfoIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>assistToken<span class="token punctuation">,</span> activityClientController<span class="token punctuation">,</span>
              r<span class="token punctuation">.</span>shareableActivityToken<span class="token punctuation">,</span> r<span class="token punctuation">.</span><span class="token function">getLaunchedFromBubble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fragmentToken<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        mService<span class="token punctuation">.</span><span class="token function">getLifecycleManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>clientTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>ClientLifecycleManager：客户端事务管理类，能够组合多个客户端生命周期转换事务的请求和/或回调，并把它们作为单个事务执行。</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
  * Class that is able to combine multiple client lifecycle transition requests 
  * and/or callbacks, and execute them as a single transaction.
  * 
  * 客户端事务管理类，能够组合多个客户端生命周期转换事务的请求和/或回调，并把它们作为单个事务执行
  * 
  * @see ClientTransaction
  */</span>
<span class="token keyword">class</span> <span class="token class-name">ClientLifecycleManager</span> <span class="token punctuation">{<!-- --></span>
   
    <span class="token comment">/**
     * Schedule a transaction, which may consist of multiple callbacks and a lifecycle 
     * request. 
     * 调度一个事务，它可能由多个回调和一个生命周期请求组成
     *
     * @see ClientTransaction
     */</span>
    <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 1</span>
        <span class="token keyword">final</span> <span class="token class-name">IApplicationThread</span> client <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        transaction<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>client <span class="token keyword">instanceof</span> <span class="token class-name">Binder</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            transaction<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  	
  	<span class="token comment">/**
     * Schedule a single lifecycle request or callback to client activity.
     * 
     * @param client Target client.
     * @param activityToken Target activity token.
     * @param stateRequest A request to move target activity to a desired lifecycle state.
     * @throws RemoteException
     *
     * @see ClientTransactionItem
     */</span>
    <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> client<span class="token punctuation">,</span> 
                             <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IBinder</span> activityToken<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityLifecycleItem</span> stateRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 3</span>
        <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> clientTransaction <span class="token operator">=</span> <span class="token function">transactionWithState</span><span class="token punctuation">(</span>
          	                 client<span class="token punctuation">,</span> activityToken<span class="token punctuation">,</span> stateRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>clientTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Schedule a single callback delivery to client activity.
     * @param client Target client.
     * @param activityToken Target activity token.
     * @param callback A request to deliver a callback.
     * @throws RemoteException
     *
     * @see ClientTransactionItem
     */</span>
    <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> client<span class="token punctuation">,</span>
                             <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IBinder</span> activityToken<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ClientTransactionItem</span> callback<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 4</span>
        <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> clientTransaction <span class="token operator">=</span> <span class="token function">transactionWithCallback</span><span class="token punctuation">(</span>
          					client<span class="token punctuation">,</span> activityToken<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>clientTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Schedule a single callback delivery to client application.
     * @param client Target client.
     * @param callback A request to deliver a callback.
     * @throws RemoteException
     *
     * @see ClientTransactionItem
     */</span>
    <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> client<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ClientTransactionItem</span> callback<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 5</span>
        <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> clientTransaction <span class="token operator">=</span> <span class="token function">transactionWithCallback</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span>
                <span class="token keyword">null</span> <span class="token comment">/* activityToken */</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>clientTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return A new instance of {@link ClientTransaction} with a single lifecycle state 
     * request.
     *
     * @see ClientTransaction
     * @see ClientTransactionItem
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ClientTransaction</span> <span class="token function">transactionWithState</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> client<span class="token punctuation">,</span>
          <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IBinder</span> activityToken<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityLifecycleItem</span> stateRequest<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 6</span>
        <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> clientTransaction <span class="token operator">=</span> <span class="token class-name">ClientTransaction</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>
                                     client<span class="token punctuation">,</span> activityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientTransaction<span class="token punctuation">.</span><span class="token function">setLifecycleStateRequest</span><span class="token punctuation">(</span>stateRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> clientTransaction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return A new instance of {@link ClientTransaction} with a single callback invocation.
     *
     * @see ClientTransaction
     * @see ClientTransactionItem
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ClientTransaction</span> <span class="token function">transactionWithCallback</span><span class="token punctuation">(</span>
      			<span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> client<span class="token punctuation">,</span>
            <span class="token class-name">IBinder</span> activityToken<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ClientTransactionItem</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 7</span>
        <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> clientTransaction <span class="token operator">=</span> <span class="token class-name">ClientTransaction</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>
                                       client<span class="token punctuation">,</span> activityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientTransaction<span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> clientTransaction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从上面的代码中可以看出，ClientLifecycleManager 对外暴露了 3 种事务调度的方法，一是直接调度客户端事务集 ClientTransaction（注释 1），二是调度生命周期事务 ActivityLifecycleItem（注释 3），三是调度客户端事务 ClientTransactionItem（注释 4），实际上无论是生命周期事务 ActivityLifecycleItem 还是客户端事务 ClientTransactionItem 都被封装成 ClientTransaction 客户端事务集的形式，因此，<strong>这个类中的核心方法就是 scheduleTransaction(ClientTransaction) ，在这个方法中传入 ClientTransation 类型的参数并调用它的 schedule() 方法做进一步处理（注释 2）。</strong></p> 
<p><strong>ClientTransaction 事务类集，一个事务集可以存放一系列的事务（ClientTransactionItem）以及一个生命周期事务（ActivityLifecycleItem）。</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientTransaction</span> <span class="token keyword">implements</span> <span class="token class-name">Parcelable</span><span class="token punctuation">,</span> <span class="token class-name">ObjectPoolItem</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/** A list of individual callbacks to a client. */</span>
    <span class="token annotation punctuation">@UnsupportedAppUsage</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientTransactionItem</span><span class="token punctuation">&gt;</span></span> mActivityCallbacks<span class="token punctuation">;</span> <span class="token comment">// 1</span>

    <span class="token comment">/**
     * Final lifecycle state in which the client activity should be after the transaction is
     * executed.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">ActivityLifecycleItem</span> mLifecycleStateRequest<span class="token punctuation">;</span> <span class="token comment">// 2</span>

    <span class="token comment">/** Target client. */</span>
    <span class="token keyword">private</span> <span class="token class-name">IApplicationThread</span> mClient<span class="token punctuation">;</span>

    <span class="token comment">/** Get the target client of the transaction. */</span>
    <span class="token keyword">public</span> <span class="token class-name">IApplicationThread</span> <span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Add a message to the end of the sequence of callbacks.
     * @param activityCallback A single message that can contain a lifecycle 
     * request/callback.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addCallback</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionItem</span> activityCallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mActivityCallbacks <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            mActivityCallbacks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mActivityCallbacks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activityCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
        mClient<span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	
  	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>ClientTransactionItem 客户端事务，是一个抽象类，ActivityLifecycleItem 是它的一个子类：</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClientTransactionItem</span> <span class="token keyword">implements</span> <span class="token class-name">BaseClientRequest</span><span class="token punctuation">,</span> <span class="token class-name">Parcelable</span> <span class="token punctuation">{<!-- --></span>

  <span class="token comment">/** Get the state that must follow this callback. */</span>
  <span class="token annotation punctuation">@LifecycleState</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPostExecutionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token constant">UNDEFINED</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Parcelable</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">describeContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Request to launch an activity.
 * @hide
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LaunchActivityItem</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionItem</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTransactionItem</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionItem</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityLifecycleItem</span> <span class="token keyword">extends</span> <span class="token class-name">ActivityTransactionItem</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ResumeActivityItem</span> <span class="token keyword">extends</span> <span class="token class-name">ActivityLifecycleItem</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PauseActivityItem</span> <span class="token keyword">extends</span> <span class="token class-name">ActivityLifecycleItem</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StopActivityItem</span> <span class="token keyword">extends</span> <span class="token class-name">ActivityLifecycleItem</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DestroyActivityItem</span> <span class="token keyword">extends</span> <span class="token class-name">ActivityLifecycleItem</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityRelaunchItem</span> <span class="token keyword">extends</span> <span class="token class-name">ActivityTransactionItem</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
</code></pre> 
<p><strong>ActivityLifecycleItem 是 Activity 生命周期事务类，其子类有 ResumeActivityItem、PauseActivityItem、StopActivityItem、DestroyActivityItem，表示具体的 Activity 的生命周期转换事务。</strong></p> 
<p><strong>LaunchActivityItem 请求启动一个 Activity，ActivityRelaunchItem 重启 Activity 的回调。</strong></p> 
<p>对于 ClientTransaction.schedule() 方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientTransaction</span> <span class="token keyword">implements</span> <span class="token class-name">Parcelable</span><span class="token punctuation">,</span> <span class="token class-name">ObjectPoolItem</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/** Target client. */</span>
    <span class="token keyword">private</span> <span class="token class-name">IApplicationThread</span> mClient<span class="token punctuation">;</span> <span class="token comment">// 1</span>
  
  	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
        mClient<span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>注释 1 处的 mClient 指的是 IApplicationThread，它的实现类是 ActivityThread 的内部类 ApplicationThread。ApplicationThread 继承了 IApplicationThread.Stub。当前代码运行在 ATMS 所在的进程（system_server）中，通过 IApplicationThread 与应用程序进程来进行 Binder 通信，换句话说 IApplicationThread 是 ATMS 所在的进程（system_server）和应用程序进程的通信桥梁。</strong></p> 
<h5><a id="13_ActivityThread__Activity__718"></a>1.3 ActivityThread 启动 Activity 的过程</h5> 
<p><img src="https://images2.imgbox.com/86/ba/s4P4MrmB_o.png" alt="Activity 启动时序图_4" width="100%" height="100%"></p> 
<p>目前的代码已经是运行在应用程序进程中了。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span> <span class="token comment">// 3</span>
          <span class="token keyword">implements</span> <span class="token class-name">ActivityThreadInternal</span> <span class="token punctuation">{<!-- --></span>
  
  	<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationThread</span> <span class="token keyword">extends</span> <span class="token class-name">IApplicationThread<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 1</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> 
          										<span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ActivityThread</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从注释 1 处可知，ApplicationThread 是 ActivityThread 的内部类，也是 IApplicationThread 的实现类。注释 2 处 调用了 ActivityThread.this.scheduleTransaction 方法。从注释 3 处可以知道 ActivityThread 是 ClientTransactionHandler 的实现类，ClientTransactionHandler.scheduleTransaction 方法如下所示：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
  * Defines operations that a {@link android.app.servertransaction.ClientTransaction} or its 
  * items can perform on client.
  * 定义了 ClientTransaction 或其 items 可以在客户端执行的操作
  * @hide
  */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClientTransactionHandler</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token comment">// Schedule phase related logic and handlers.</span>

    <span class="token comment">/** Prepare and schedule transaction for execution. */</span>
    <span class="token keyword">void</span> <span class="token function">scheduleTransaction</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        transaction<span class="token punctuation">.</span><span class="token function">preExecute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">ActivityThread<span class="token punctuation">.</span>H</span><span class="token punctuation">.</span><span class="token constant">EXECUTE_TRANSACTION</span><span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  	<span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> what<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>对于抽象方法 sendMessage，在 ActivityThread 中有实现：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span>
          <span class="token keyword">implements</span> <span class="token class-name">ActivityThreadInternal</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">final</span> <span class="token class-name">H</span> mH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">H</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> what<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    		<span class="token function">sendMessage</span><span class="token punctuation">(</span>what<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> what<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> arg1<span class="token punctuation">,</span> <span class="token keyword">int</span> arg2<span class="token punctuation">,</span> <span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>what <span class="token operator">=</span> what<span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> arg1<span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> arg2<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>async<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mH<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p>最终调用的是 mH.sendMessage 方法，mH 是 H 类型的对象，H 是 ActivityThread 的内部类，也是 Handler 的子类：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span>
          <span class="token keyword">implements</span> <span class="token class-name">ActivityThreadInternal</span> <span class="token punctuation">{<!-- --></span>
  	
  	<span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>对于 ActivityThread.H.EXECUTE_TRANSACTION 消息的处理：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span>
          <span class="token keyword">implements</span> <span class="token class-name">ActivityThreadInternal</span> <span class="token punctuation">{<!-- --></span>
  	
  	<span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span>
      
  			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token constant">EXECUTE_TRANSACTION</span><span class="token operator">:</span>
                <span class="token keyword">final</span> <span class="token class-name">ClientTransaction</span> transaction <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span><span class="token punctuation">)</span> msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                mTransactionExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Client transactions inside system process are recycled on the client side</span>
                    <span class="token comment">// instead of ClientLifecycleManager to avoid being cleared before this</span>
                    <span class="token comment">// message is handled.</span>
                    transaction<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// TODO(lifecycler): Recycle locally scheduled transactions.</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处调用了 TransactionExecutor.execute 方法。</p> 
<p><strong>ClientTransactionHandler：定义了客户端事务或其 Item 可以在客户端执行的操作，封装了 handleXXXActivity 方法，其实现类 ActivityThread 也会继承这些方法。</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
  * Defines operations that a {@link android.app.servertransaction.ClientTransaction} or its 
  * items can perform on client.
  * 定义了 ClientTransaction 或其 items 可以在客户端执行的操作
  * @hide
  */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClientTransactionHandler</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Activity</span> <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
          <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** Perform activity launch. */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">Activity</span> <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** Perform activity start. */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleStartActivity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span> <span class="token class-name">ActivityOptions</span> activityOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/** Resume the activity. */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleResumeActivity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> finalStateRequest<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isForward<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** Pause the activity. */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handlePauseActivity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> 
            <span class="token keyword">boolean</span> finished<span class="token punctuation">,</span> <span class="token keyword">boolean</span> userLeaving<span class="token punctuation">,</span> <span class="token keyword">int</span> configChanges<span class="token punctuation">,</span> 
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/** Stop the activity. */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleStopActivity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> 
            <span class="token keyword">int</span> configChanges<span class="token punctuation">,</span> <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span> 
            <span class="token keyword">boolean</span> finalStateRequest<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleDestroyActivity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> 
                 <span class="token keyword">boolean</span> finishing<span class="token punctuation">,</span> <span class="token keyword">int</span> configChanges<span class="token punctuation">,</span> <span class="token keyword">boolean</span> getNonConfigInstance<span class="token punctuation">,</span> 
                 <span class="token class-name">String</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handleRelaunchActivity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
                  <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>TransactionExecutor：事务执行器，让事务按正确顺序执行的类。TransactionExecutor 持有 ClientTransactionHandler 对象，在其构造函数中作为参数传入，ClientTransactionHandler 才是任务的真正执行者。</strong></p> 
<pre><code class="prism language-java"><span class="token comment">/**
  * Class that manages transaction execution in the correct order.
  * @hide
  */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionExecutor</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token keyword">private</span> <span class="token class-name">ClientTransactionHandler</span> mTransactionHandler<span class="token punctuation">;</span>
  	
    <span class="token comment">/** Initialize an instance with transaction handler, that will execute all requested actions. */</span>
    <span class="token keyword">public</span> <span class="token class-name">TransactionExecutor</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> clientTransactionHandler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mTransactionHandler <span class="token operator">=</span> clientTransactionHandler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>回到 TransactionExecutor.execute 方法中：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionExecutor</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

       <span class="token function">executeCallbacks</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

       <span class="token function">executeLifecycleState</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
  
    <span class="token annotation punctuation">@VisibleForTesting</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeCallbacks</span><span class="token punctuation">(</span><span class="token class-name">ClientTransaction</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientTransactionItem</span><span class="token punctuation">&gt;</span></span> callbacks <span class="token operator">=</span> transaction<span class="token punctuation">.</span><span class="token function">getCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> callbacks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// No callbacks to execute, return early.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">ClientTransactionItem</span> item <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> postExecutionState <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getPostExecutionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> closestPreExecutionState <span class="token operator">=</span> mHelper<span class="token punctuation">.</span><span class="token function">getClosestPreExecutionState</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>
                    item<span class="token punctuation">.</span><span class="token function">getPostExecutionState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closestPreExecutionState <span class="token operator">!=</span> <span class="token constant">UNDEFINED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">cycleToPath</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> closestPreExecutionState<span class="token punctuation">,</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            item<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
            item<span class="token punctuation">.</span><span class="token function">postExecute</span><span class="token punctuation">(</span>mTransactionHandler<span class="token punctuation">,</span> token<span class="token punctuation">,</span> mPendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>注释 3 处调用了 ClientTransactionItem.execute 方法，对于启动一个 Activity，此处的 ClientTransactionItem 是其子类 LaunchActivityItem，请求启动一个 Activity。</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Request to launch an activity.
 * @hide
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LaunchActivityItem</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionItem</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClientTransactionItem</span> <span class="token keyword">implements</span> <span class="token class-name">BaseClientRequest</span><span class="token punctuation">,</span> <span class="token class-name">Parcelable</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>BaseClientRequest：事务的抽象类，定义了 preExecute、execute、postExecute 三个接口，分别代表事务执行前、执行中、执行后三个阶段的回调方法。</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BaseClientRequest</span> <span class="token keyword">extends</span> <span class="token class-name">ObjectPoolItem</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * Prepare the client request before scheduling.
     * An example of this might be informing about pending updates for some values.
     *
     * @param client Target client handler.
     * @param token  Target activity token.
     */</span>
    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">preExecute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Execute the request.
     * @param client Target client handler.
     * @param token Target activity token.
     * @param pendingActions Container that may have data pending to be used.
     */</span>
    <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Perform all actions that need to happen after execution, e.g. report the result to server.
     * @param client Target client handler.
     * @param token Target activity token.
     * @param pendingActions Container that may have data pending to be used.
     */</span>
    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">postExecute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>LaunchActivityItem 重写了 execute 方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LaunchActivityItem</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionItem</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">ClientTransactionHandler</span> client<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"activityStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ActivityClientRecord</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityClientRecord</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> mIntent<span class="token punctuation">,</span> mIdent<span class="token punctuation">,</span> mInfo<span class="token punctuation">,</span>
                mOverrideConfig<span class="token punctuation">,</span> mCompatInfo<span class="token punctuation">,</span> mReferrer<span class="token punctuation">,</span> mVoiceInteractor<span class="token punctuation">,</span> mState<span class="token punctuation">,</span> 
                mPersistentState<span class="token punctuation">,</span> mPendingResults<span class="token punctuation">,</span> mPendingNewIntents<span class="token punctuation">,</span> mActivityOptions<span class="token punctuation">,</span> 
                mIsForward<span class="token punctuation">,</span> mProfilerInfo<span class="token punctuation">,</span> client<span class="token punctuation">,</span> mAssistToken<span class="token punctuation">,</span> mShareableActivityToken<span class="token punctuation">,</span> 
                mLaunchedFromBubble<span class="token punctuation">,</span> mTaskFragmentToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> pendingActions<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* customIntent */</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处的 client 的类型是 ClientTransactionHandler，<strong>ActivityThread 继承了 ClientTransactionHandler，是事务的真正执行者。</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span>
        <span class="token keyword">implements</span> <span class="token class-name">ActivityThreadInternal</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Activity</span> <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
            <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">final</span> <span class="token class-name">Activity</span> a <span class="token operator">=</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> customIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2__Activity__1020"></a>2 根 Activity 的启动过程</h4> 
<p><strong>根 Activity 的启动流程可以分为以下 3 部分：</strong></p> 
<ul><li><strong>Launcher 请求 ActivityTaskManagerService(ATMS) 的过程</strong></li><li><strong>ATMS 到 ApplicationThread 的调用过程</strong></li><li><strong>ActivityThread 启动 Activity；</strong></li></ul> 
<h5><a id="21__Launcher__ATMS__1028"></a>2.1 Launcher 请求 ATMS 过程</h5> 
<p><strong>Launcher 启动后会将已安装的应用程序的快捷图标显示到桌面上，这些应用程序的快捷图标就是启动根 Activity 的入口。当我们点击某个应用题程序的快捷图标时，就会通过 Launcher 请求 ATMS 来启动应用程序。</strong></p> 
<p>以下是 Launcher 请求 ATMS 的时序图：</p> 
<p><img src="https://images2.imgbox.com/24/3c/HvrIn5gG_o.png" alt="根Activity 启动时序图_1" width="100%" height="100%"></p> 
<p>点击应用程序的快捷图标时，就会调用 Launcher.startActivitySafely 方法：</p> 
<pre><code class="prism language-java"><span class="token comment">// /packages/apps/Launcher3/src/com/android/launcher3/Launcher.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Launcher</span> <span class="token keyword">extends</span> <span class="token class-name">StatefulActivity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LauncherState</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">LauncherExterns</span><span class="token punctuation">,</span> <span class="token class-name">Callbacks</span><span class="token punctuation">,</span> <span class="token class-name">InvariantDeviceProfile<span class="token punctuation">.</span>OnIDPChangeListener</span><span class="token punctuation">,</span>
        <span class="token class-name">PluginListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LauncherOverlayPlugin</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
          
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">startActivitySafely</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">ItemInfo</span> item<span class="token punctuation">,</span>
                             <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> sourceContainer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">boolean</span> success <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">startActivitySafely</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> item<span class="token punctuation">,</span> sourceContainer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>       
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">StatefulActivity</span><span class="token generics"><span class="token punctuation">&lt;</span>STATE_TYPE <span class="token keyword">extends</span> <span class="token class-name">BaseState</span><span class="token punctuation">&lt;</span>STATE_TYPE<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">extends</span> <span class="token class-name">BaseDraggingActivity</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseDraggingActivity</span> <span class="token keyword">extends</span> <span class="token class-name">BaseActivity</span>
        <span class="token keyword">implements</span> <span class="token class-name">OnColorsChangedListener</span><span class="token punctuation">,</span> <span class="token class-name">DisplayInfoChangeListener</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseActivity</span> <span class="token keyword">extends</span> <span class="token class-name">Activity</span> <span class="token keyword">implements</span> <span class="token class-name">ActivityContext</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处调用的是 super.startActivitySafely 方法，这里的 super，由继承关系可以知道调用的是 ActivityContext.startActivitySafely 方法：</p> 
<pre><code class="prism language-java"><span class="token comment">// packages/apps/Launcher3/src/com/android/launcher3/views/ActivityContext.java</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ActivityContext</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">startActivitySafely</span><span class="token punctuation">(</span><span class="token class-name">View</span> v<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ItemInfo</span> item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// Prepare intent</span>
        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span><span class="token class-name">Intent</span><span class="token punctuation">.</span><span class="token constant">FLAG_ACTIVITY_NEW_TASK</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            intent<span class="token punctuation">.</span><span class="token function">setSourceBounds</span><span class="token punctuation">(</span><span class="token class-name">Utilities</span><span class="token punctuation">.</span><span class="token function">getViewBounds</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> isShortcut <span class="token operator">=</span> <span class="token punctuation">(</span>item <span class="token keyword">instanceof</span> <span class="token class-name">WorkspaceItemInfo</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>itemType <span class="token operator">==</span> <span class="token class-name">LauncherSettings<span class="token punctuation">.</span>Favorites</span><span class="token punctuation">.</span><span class="token constant">ITEM_TYPE_SHORTCUT</span>
                    <span class="token operator">||</span> item<span class="token punctuation">.</span>itemType <span class="token operator">==</span> <span class="token class-name">LauncherSettings<span class="token punctuation">.</span>Favorites</span><span class="token punctuation">.</span><span class="token constant">ITEM_TYPE_DEEP_SHORTCUT</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">WorkspaceItemInfo</span><span class="token punctuation">)</span> item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isShortcut<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Shortcuts need some special checks due to legacy reasons.</span>
                <span class="token function">startShortcutIntentSafely</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> optsBundle<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> user<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">myUserHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Could be launching some bookkeeping activity</span>
                context<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> optsBundle<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span><span class="token class-name">LauncherApps</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startMainActivity</span><span class="token punctuation">(</span>
                        intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> intent<span class="token punctuation">.</span><span class="token function">getSourceBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> optsBundle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NullPointerException</span> <span class="token operator">|</span> <span class="token class-name">ActivityNotFoundException</span> <span class="token operator">|</span> <span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处将 Flag 设置为 Intent.FLAG_ACTIVITY_NEW_TASK，这样根 Activity 会在新的任务栈中启动，在注释 2 处调用了 Context.startActivity 方法，Context 是抽象类，其中定义了抽象方法 startActivity，在其子类 Activity 中实现：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/content/Context.java</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequiresPermission</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token comment">// frameworks/base/core/java/android/content/ContextWrapper.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{<!-- --></span>
  	
<span class="token punctuation">}</span>

<span class="token comment">// frameworks/base/core/java/android/content/ContextWrapper.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextThemeWrapper</span> <span class="token keyword">extends</span> <span class="token class-name">ContextWrapper</span> <span class="token punctuation">{<!-- --></span>
  
<span class="token punctuation">}</span>

<span class="token comment">// frameworks/base/core/java/android/app/Activity.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Activity</span> <span class="token keyword">extends</span> <span class="token class-name">ContextThemeWrapper</span>
        <span class="token keyword">implements</span> <span class="token class-name">LayoutInflater<span class="token punctuation">.</span>Factory2</span><span class="token punctuation">,</span>
        <span class="token class-name">Window<span class="token punctuation">.</span>Callback</span><span class="token punctuation">,</span> <span class="token class-name">KeyEvent<span class="token punctuation">.</span>Callback</span><span class="token punctuation">,</span>
        <span class="token class-name">OnCreateContextMenuListener</span><span class="token punctuation">,</span> <span class="token class-name">ComponentCallbacks2</span><span class="token punctuation">,</span>
        <span class="token class-name">Window<span class="token punctuation">.</span>OnWindowDismissedCallback</span><span class="token punctuation">,</span>
        <span class="token class-name">ContentCaptureManager<span class="token punctuation">.</span>ContentCaptureClient</span> <span class="token punctuation">{<!-- --></span>
          
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startActivity</span><span class="token punctuation">(</span><span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Bundle</span> options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">getAutofillClientController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onStartActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> mIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Note we want to go through this call for compatibility with</span>
            <span class="token comment">// applications that may have overridden the method.</span>
            <span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
          
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="22__ATMS__ApplicationThread__1148"></a>2.2 ATMS 到 ApplicationThread 的调用过程</h5> 
<p>Launcher 请求 ATMS 后，代码逻辑已经进入到 ATMS 中，接着是 ATMS 到 ApplicationThread 的调用流程：</p> 
<p><img src="https://images2.imgbox.com/a5/cc/9gGpkYJx_o.png" alt="Activity 启动时序图_2" width="100%" height="100%"></p> 
<p>ActivityStackSupervisor.startSpecificActivityLocked 方法，代码如下所示：</p> 
<pre><code class="prism language-java"><span class="token comment">// /frameworks/base/services/core/java/com/android/server/wm/ActivityStackSupervisor.java</span>
<span class="token comment">// TODO: This class has become a dumping ground. Let's</span>
<span class="token comment">// 这个类已经变成了垃圾请倒场</span>
<span class="token comment">// - Move things relating to the hierarchy to RootWindowContainer</span>
<span class="token comment">// - 把与层级相关的代码移动到 RootWindowContainer 中</span>
<span class="token comment">// - Move things relating to activity life cycles to maybe a new class called ActivityLifeCycler</span>
<span class="token comment">// - 与 Activity 生命周期相关的代码移动到 ActivityLifeCycler 中</span>
<span class="token comment">// - Move interface things to ActivityTaskManagerService.</span>
<span class="token comment">// - 接口相关的移动到 ActivityTaskManagerService 中</span>
<span class="token comment">// - All other little things to other files.</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTaskSupervisor</span> <span class="token keyword">implements</span> <span class="token class-name">RecentTasks<span class="token punctuation">.</span>Callbacks</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">ActivityTaskManagerService</span> mService<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">startSpecificActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> andResume<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkConfig<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Is this activity's application already running?</span>
        <span class="token keyword">final</span> <span class="token class-name">WindowProcessController</span> wpc <span class="token operator">=</span>
                mService<span class="token punctuation">.</span><span class="token function">getProcessController</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> knownToBeDead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wpc <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> wpc<span class="token punctuation">.</span><span class="token function">hasThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> wpc<span class="token punctuation">,</span> andResume<span class="token punctuation">,</span> checkConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Exception when starting activity "</span>
                        <span class="token operator">+</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flattenToShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        r<span class="token punctuation">.</span><span class="token function">notifyUnknownVisibilityLaunchedForKeyguardTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isTop <span class="token operator">=</span> andResume <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">isTopRunningActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mService<span class="token punctuation">.</span><span class="token function">startProcessAsync</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> isTop<span class="token punctuation">,</span>
                isTop <span class="token operator">?</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">.</span><span class="token constant">HOSTING_TYPE_TOP_ACTIVITY</span>
                        <span class="token operator">:</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">.</span><span class="token constant">HOSTING_TYPE_ACTIVITY</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>注释 1 处调用 ATMS.startProcessAsync 方法用来创建新的进程。Zygote 进程收到请求后，fork 出新的进程并调用 ActivityThread.main 方法。</strong></p> 
<p><img src="https://images2.imgbox.com/91/24/UAVt8L2T_o.png" alt="根Activity 启动时序图" width="100%" height="100%"></p> 
<p>以下是 ActivityTaskManagerService.startProcessAsync 方法的相关源码：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTaskManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IActivityTaskManager<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">void</span> <span class="token function">startProcessAsync</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> activity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTop<span class="token punctuation">,</span>
                           <span class="token class-name">String</span> hostingType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"dispatchingStartProcess:"</span>
                      <span class="token operator">+</span> activity<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// Post message to start process to avoid possible deadlock of calling into AMS  </span>
          <span class="token comment">// with the ATMS lock held.</span>
          <span class="token keyword">final</span> <span class="token class-name">Message</span> m <span class="token operator">=</span> <span class="token class-name">PooledLambda</span><span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token class-name">ActivityManagerInternal</span><span class="token operator">::</span><span class="token function">startProcess</span><span class="token punctuation">,</span>
                  mAmInternal<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>processName<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span> 
                  knownToBeDead<span class="token punctuation">,</span> isTop<span class="token punctuation">,</span> hostingType<span class="token punctuation">,</span> activity<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">getComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
          mH<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>ActivityManagerInternal.startProcess 方法是请求启动应用进程的起点。</strong> 注释 1 处的 PooledLambda.obtainMessage 获取一个 Message，并为其指定 Callback。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/com/android/internal/util/function/pooled/PooledLambda.java</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PooledLambda</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">D</span><span class="token punctuation">,</span> <span class="token class-name">E</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">G</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Message</span> <span class="token function">obtainMessage</span><span class="token punctuation">(</span>
        <span class="token class-name">HeptConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">D</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">E</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">F</span><span class="token punctuation">,</span>
                <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">G</span><span class="token punctuation">&gt;</span></span> function<span class="token punctuation">,</span> <span class="token class-name">A</span> arg1<span class="token punctuation">,</span> <span class="token class-name">B</span> arg2<span class="token punctuation">,</span> <span class="token class-name">C</span> arg3<span class="token punctuation">,</span> <span class="token class-name">D</span> arg4<span class="token punctuation">,</span> <span class="token class-name">E</span> arg5<span class="token punctuation">,</span> <span class="token class-name">F</span> arg6<span class="token punctuation">,</span> <span class="token class-name">G</span> arg7<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">.</span>sPoolSync<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">PooledRunnable</span> callback <span class="token operator">=</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token class-name">PooledLambdaImpl</span><span class="token punctuation">.</span>sMessageCallbacksPool<span class="token punctuation">,</span>
                function<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">ReturnType</span><span class="token punctuation">.</span><span class="token constant">VOID</span><span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> arg3<span class="token punctuation">,</span> arg4<span class="token punctuation">,</span> arg5<span class="token punctuation">,</span> arg6<span class="token punctuation">,</span> arg7<span class="token punctuation">,</span> 
                <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">.</span><span class="token function">recycleOnUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>  
</code></pre> 
<p>ActivityManagerInternal 是抽象类，其实现类是 ActivityManagerService 的内部类 LocalService：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/ActivityManagerInternal.java</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerInternal</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTop<span class="token punctuation">,</span> <span class="token class-name">String</span> hostingType<span class="token punctuation">,</span> 
            <span class="token class-name">ComponentName</span> hostingName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ActivityManagerService</span> <span class="token keyword">extends</span> <span class="token class-name">IActivityManager<span class="token punctuation">.</span>Stub</span>
        <span class="token keyword">implements</span> <span class="token class-name">Watchdog<span class="token punctuation">.</span>Monitor</span><span class="token punctuation">,</span> <span class="token class-name">BatteryStatsImpl<span class="token punctuation">.</span>BatteryCallback</span><span class="token punctuation">,</span> 
										<span class="token class-name">ActivityManagerGlobalLock</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">LocalService</span> <span class="token keyword">extends</span> <span class="token class-name">ActivityManagerInternal</span>
                <span class="token keyword">implements</span> <span class="token class-name">ActivityManagerLocal</span> <span class="token punctuation">{<!-- --></span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startProcess</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span> 
                <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTop<span class="token punctuation">,</span> <span class="token class-name">String</span> hostingType<span class="token punctuation">,</span> 
                <span class="token class-name">ComponentName</span> hostingName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"startProcess:"</span>
                            <span class="token operator">+</span> processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ActivityManagerService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// If the process is known as top app, set a hint so when the process is</span>
                    <span class="token comment">// started, the top priority can be applied immediately to avoid cpu </span>
                    <span class="token comment">// being</span>
                    <span class="token comment">// preempted by other processes before attaching the process of top app.</span>
                    <span class="token function">startProcessLocked</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> info<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* intentFlags */</span><span class="token punctuation">,</span>
                            <span class="token keyword">new</span> <span class="token class-name">HostingRecord</span><span class="token punctuation">(</span>hostingType<span class="token punctuation">,</span> hostingName<span class="token punctuation">,</span> isTop<span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token constant">ZYGOTE_POLICY_FLAG_LATENCY_SENSITIVE</span><span class="token punctuation">,</span> 
                            <span class="token boolean">false</span> <span class="token comment">/* allowWhileBooting */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* isolated */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
                      
    <span class="token keyword">final</span> <span class="token class-name">ProcessRecord</span> <span class="token function">startProcessLocked</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span>
        <span class="token class-name">ApplicationInfo</span> info<span class="token punctuation">,</span> <span class="token keyword">boolean</span> knownToBeDead<span class="token punctuation">,</span> <span class="token keyword">int</span> intentFlags<span class="token punctuation">,</span>
        <span class="token class-name">HostingRecord</span> hostingRecord<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowWhileBooting<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> isolated<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      
        <span class="token keyword">return</span> mProcessList<span class="token punctuation">.</span><span class="token function">startProcessLocked</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> info<span class="token punctuation">,</span> knownToBeDead<span class="token punctuation">,</span> intentFlags<span class="token punctuation">,</span>
                hostingRecord<span class="token punctuation">,</span> zygotePolicyFlags<span class="token punctuation">,</span> allowWhileBooting<span class="token punctuation">,</span> isolated<span class="token punctuation">,</span> 
                <span class="token number">0</span> <span class="token comment">/* isolatedUid */</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* isSdkSandbox */</span><span class="token punctuation">,</span> 
                <span class="token number">0</span> <span class="token comment">/* sdkSandboxClientAppUid */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* sdkSandboxClientAppPackage */</span><span class="token punctuation">,</span>
                <span class="token keyword">null</span> <span class="token comment">/* ABI override */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* entryPoint */</span><span class="token punctuation">,</span>
                <span class="token keyword">null</span> <span class="token comment">/* entryPointArgs */</span><span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* crashHandler */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p>以下是 ZygoteProcess.startViaZygote 方法的相关源码：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/os/ZygoteProcess.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZygoteProcess</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">startViaZygote</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> <span class="token class-name">String</span> processClass<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token class-name">String</span> niceName<span class="token punctuation">,</span>
                                                  <span class="token keyword">final</span> <span class="token keyword">int</span> uid<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> gid<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gids<span class="token punctuation">,</span>
                                                  <span class="token keyword">int</span> runtimeFlags<span class="token punctuation">,</span> <span class="token keyword">int</span> mountExternal<span class="token punctuation">,</span>
                                                  <span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> seInfo<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> abi<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> instructionSet<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> appDataDir<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> invokeWith<span class="token punctuation">,</span>
                                                  <span class="token keyword">boolean</span> startChildZygote<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> packageName<span class="token punctuation">,</span>
                                                  <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span>
                                                  <span class="token keyword">boolean</span> isTopApp<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                          pkgDataInfoMap<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Pair</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                                                          allowlistedDataInfoList<span class="token punctuation">,</span>
                                                  <span class="token keyword">boolean</span> bindMountAppsData<span class="token punctuation">,</span>
                                                  <span class="token keyword">boolean</span> bindMountAppStorageDirs<span class="token punctuation">,</span>
                                                  <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> extraArgs<span class="token punctuation">)</span>
                                                  <span class="token keyword">throws</span> <span class="token class-name">ZygoteStartFailedEx</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// The USAP pool can not be used if the application will not use the systems </span>
            <span class="token comment">// graphics driver.  </span>
            <span class="token comment">// If that driver is requested use the Zygote application start path.</span>
            <span class="token keyword">return</span> <span class="token function">zygoteSendArgsAndGetResult</span><span class="token punctuation">(</span><span class="token function">openZygoteSocketIfNeeded</span><span class="token punctuation">(</span>abi<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                              zygotePolicyFlags<span class="token punctuation">,</span>
                                              argsForZygote<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
    	<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处调用 openZygoteSocketIfNeeded 方法建立与 Zygote 进程的 Socket 连接，并返回一个 ZygoteState 对象：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/os/ZygoteProcess.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZygoteProcess</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">private</span> <span class="token class-name">ZygoteState</span> <span class="token function">openZygoteSocketIfNeeded</span><span class="token punctuation">(</span><span class="token class-name">String</span> abi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZygoteStartFailedEx</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">attemptConnectionToPrimaryZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>primaryZygoteState<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>abi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> primaryZygoteState<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>mZygoteSecondarySocketAddress <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// The primary zygote didn't match. Try the secondary.</span>
              <span class="token function">attemptConnectionToSecondaryZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token keyword">if</span> <span class="token punctuation">(</span>secondaryZygoteState<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>abi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token keyword">return</span> secondaryZygoteState<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteStartFailedEx</span><span class="token punctuation">(</span><span class="token string">"Error connecting to zygote"</span><span class="token punctuation">,</span> ioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteStartFailedEx</span><span class="token punctuation">(</span><span class="token string">"Unsupported zygote ABI: "</span> <span class="token operator">+</span> abi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attemptConnectionToPrimaryZygote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>primaryZygoteState <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> primaryZygoteState<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          primaryZygoteState <span class="token operator">=</span>
                  <span class="token class-name">ZygoteState</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>mZygoteSocketAddress<span class="token punctuation">,</span> mUsapPoolSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token function">maybeSetApiDenylistExemptions</span><span class="token punctuation">(</span>primaryZygoteState<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">maybeSetHiddenApiAccessLogSampleRate</span><span class="token punctuation">(</span>primaryZygoteState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p>ZygoteState 是 ZygoteProcess 的内部类：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/os/ZygoteProcess.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZygoteProcess</span> <span class="token punctuation">{<!-- --></span>
  
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ZygoteState</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">static</span> <span class="token class-name">ZygoteState</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">LocalSocketAddress</span> zygoteSocketAddress<span class="token punctuation">,</span>
              <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">LocalSocketAddress</span> usapSocketAddress<span class="token punctuation">)</span>
              <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>

          <span class="token class-name">DataInputStream</span> zygoteInputStream<span class="token punctuation">;</span>
          <span class="token class-name">BufferedWriter</span> zygoteOutputWriter<span class="token punctuation">;</span>
          <span class="token keyword">final</span> <span class="token class-name">LocalSocket</span> zygoteSessionSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>zygoteSocketAddress <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"zygoteSocketAddress can't be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
              zygoteSessionSocket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>zygoteSocketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
              zygoteInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span>zygoteSessionSocket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              zygoteOutputWriter <span class="token operator">=</span>
                      <span class="token keyword">new</span> <span class="token class-name">BufferedWriter</span><span class="token punctuation">(</span>
                              <span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>zygoteSessionSocket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                              <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token constant">SOCKET_BUFFER_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                  zygoteSessionSocket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

              <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteState</span><span class="token punctuation">(</span>zygoteSocketAddress<span class="token punctuation">,</span> usapSocketAddress<span class="token punctuation">,</span>
                                 zygoteSessionSocket<span class="token punctuation">,</span> zygoteInputStream<span class="token punctuation">,</span> zygoteOutputWriter<span class="token punctuation">,</span>
                                 <span class="token function">getAbiList</span><span class="token punctuation">(</span>zygoteOutputWriter<span class="token punctuation">,</span> zygoteInputStream<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处调用的是 LocalSocket.connect 方法。LocalSocket 是客户端（system_server 进程），与服务端（Zygote 进程）建立 Socket 连接，实现跨进程通讯。zygoteSocketAddress 指向服务端 Socket 地址。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/os/ZygoteProcess.java</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZygoteProcess</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">zygoteSendArgsAndGetResult</span><span class="token punctuation">(</span>
        <span class="token class-name">ZygoteState</span> zygoteState<span class="token punctuation">,</span> <span class="token keyword">int</span> zygotePolicyFlags<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ZygoteStartFailedEx</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> arg <span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteStartFailedEx</span><span class="token punctuation">(</span><span class="token string">"Embedded newlines not allowed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arg<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">'\r'</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteStartFailedEx</span><span class="token punctuation">(</span><span class="token string">"Embedded carriage returns not allowed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> msgStr <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldAttemptUsapLaunch</span><span class="token punctuation">(</span>zygotePolicyFlags<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token function">attemptUsapSendArgsAndGetResult</span><span class="token punctuation">(</span>zygoteState<span class="token punctuation">,</span> msgStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">LOG_TAG</span><span class="token punctuation">,</span> <span class="token string">"IO Exception while communicating with USAP pool - "</span>
                        <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
				<span class="token comment">// 1 准备向服务端（Zygote 进程）发送启动应用程序进程的参数</span>
        <span class="token keyword">return</span> <span class="token function">attemptZygoteSendArgsAndGetResult</span><span class="token punctuation">(</span>zygoteState<span class="token punctuation">,</span> msgStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> <span class="token function">attemptZygoteSendArgsAndGetResult</span><span class="token punctuation">(</span>
        <span class="token class-name">ZygoteState</span> zygoteState<span class="token punctuation">,</span> <span class="token class-name">String</span> msgStr<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZygoteStartFailedEx</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">BufferedWriter</span> zygoteWriter <span class="token operator">=</span> zygoteState<span class="token punctuation">.</span>mZygoteOutputWriter<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">DataInputStream</span> zygoteInputStream <span class="token operator">=</span> zygoteState<span class="token punctuation">.</span>mZygoteInputStream<span class="token punctuation">;</span>

            zygoteWriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>msgStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            zygoteWriter<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Process<span class="token punctuation">.</span>ProcessStartResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span>pid <span class="token operator">=</span> zygoteInputStream<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span>usingWrapper <span class="token operator">=</span> zygoteInputStream<span class="token punctuation">.</span><span class="token function">readBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteStartFailedEx</span><span class="token punctuation">(</span><span class="token string">"fork() failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            zygoteState<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">LOG_TAG</span><span class="token punctuation">,</span> <span class="token string">"IO Exception while communicating with Zygote - "</span>
                    <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteStartFailedEx</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处准备向服务端（Zygote 进程）发送启动应用程序进程的参数。</p> 
<p><img src="https://images2.imgbox.com/df/95/IrICnMTW_o.png" alt="根Activity 启动时序图" width="100%" height="100%"></p> 
<p>以下是 ZygoteInit 的构造方法和 main 方法的相关源码：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ZygoteServer</span> zygoteServer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token class-name">Runnable</span> caller<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        zygoteServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">,</span> zygoteSocketName<span class="token punctuation">,</span> zygoteServer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
            <span class="token comment">// child (system_server) process.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Accepting command socket connections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// The select loop returns early in the child process after a fork and</span>
        <span class="token comment">// loops forever in the zygote.</span>
        caller <span class="token operator">=</span> zygoteServer<span class="token punctuation">.</span><span class="token function">runSelectLoop</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"System zygote died with fatal exception"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>zygoteServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// We're in the child process and have exited the select loop. Proceed to execute the</span>
    <span class="token comment">// command.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        caller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>LocalServerSocket 是 socket 通讯分服务端。注释 1 处调用了 ZygoteServer.runSelectLoop 方法：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</span>
<span class="token keyword">private</span> <span class="token class-name">LocalServerSocket</span> mZygoteSocket<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LocalServerSocket</span> mUsapPoolSocket<span class="token punctuation">;</span>

<span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isPrimaryZygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    mUsapPoolEventFD <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">getUsapPoolEventFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mZygoteSocket <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">createManagedSocketFromInitSocket</span><span class="token punctuation">(</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token constant">PRIMARY_SOCKET_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mUsapPoolSocket <span class="token operator">=</span>
                <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">createManagedSocketFromInitSocket</span><span class="token punctuation">(</span>
                        <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token constant">USAP_POOL_PRIMARY_SOCKET_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        mZygoteSocket <span class="token operator">=</span> 
          <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">createManagedSocketFromInitSocket</span><span class="token punctuation">(</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token constant">SECONDARY_SOCKET_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mUsapPoolSocket <span class="token operator">=</span>
                <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">createManagedSocketFromInitSocket</span><span class="token punctuation">(</span>
                        <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token constant">USAP_POOL_SECONDARY_SOCKET_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mUsapPoolSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">fetchUsapPoolPolicyProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">Runnable</span> <span class="token function">runSelectLoop</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ZygoteConnection</span><span class="token punctuation">&gt;</span></span> peers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pollReturnValue <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> usapPoolFDRead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">--</span>pollIndex <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pollFDs<span class="token punctuation">[</span>pollIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> <span class="token constant">POLLIN</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Zygote server socket</span>
                    <span class="token class-name">ZygoteConnection</span> newPeer <span class="token operator">=</span> <span class="token function">acceptCommandPeer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
                    peers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    socketFDs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newPeer<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pollIndex <span class="token operator">&lt;</span> usapPoolEventFDIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// Session socket accepted from the Zygote server socket</span>

                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">ZygoteConnection</span> connection <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pollIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">boolean</span> multipleForksOK <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">isUsapPoolEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">&amp;&amp;</span> <span class="token class-name">ZygoteHooks</span><span class="token punctuation">.</span><span class="token function">isIndefiniteThreadSuspensionSafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> <span class="token class-name">Runnable</span> command <span class="token operator">=</span>
                                connection<span class="token punctuation">.</span><span class="token function">processCommand</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> multipleForksOK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">LocalServerSocket</span> mZygoteSocket<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token class-name">ZygoteConnection</span> <span class="token function">acceptCommandPeer</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">createNewConnection</span><span class="token punctuation">(</span>mZygoteSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> abiList<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">"IOException during accept()"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token class-name">ZygoteConnection</span> <span class="token function">createNewConnection</span><span class="token punctuation">(</span><span class="token class-name">LocalSocket</span> socket<span class="token punctuation">,</span> <span class="token class-name">String</span> abiList<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteConnection</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> abiList<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处的 acceptCommandPeer 方法中会 new ZygoteConnection(LocalServerSocket.accept, abiList)，其中 LocalServerSocket.accept() 方法用来监听来自客户端（system_server 进程）的 connect 请求，并返回一个 LocalSocket 对象，通过该对象可以实现与客户端跨进程通讯。</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span>
<span class="token class-name">Runnable</span> <span class="token function">processCommand</span><span class="token punctuation">(</span><span class="token class-name">ZygoteServer</span> zygoteServer<span class="token punctuation">,</span> <span class="token keyword">boolean</span> multipleOK<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ZygoteArguments</span> parsedArgs<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">ZygoteCommandBuffer</span> argBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteCommandBuffer</span><span class="token punctuation">(</span>mSocket<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                parsedArgs <span class="token operator">=</span> <span class="token class-name">ZygoteArguments</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>argBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Keep argBuffer around, since we need it to fork.</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"IOException on command socket"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mInvokeWith <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> parsedArgs<span class="token punctuation">.</span>mStartChildZygote
                    <span class="token operator">||</span> <span class="token operator">!</span>multipleOK <span class="token operator">||</span> peer<span class="token punctuation">.</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token constant">SYSTEM_UID</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Continue using old code for now. TODO: Handle these cases in the other path.</span>
                pid <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">forkAndSpecialize</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mUid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mGid<span class="token punctuation">,</span>
                        parsedArgs<span class="token punctuation">.</span>mGids<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mRuntimeFlags<span class="token punctuation">,</span> rlimits<span class="token punctuation">,</span>
                        parsedArgs<span class="token punctuation">.</span>mMountExternal<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mSeInfo<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mNiceName<span class="token punctuation">,</span>
                        fdsToClose<span class="token punctuation">,</span> fdsToIgnore<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mStartChildZygote<span class="token punctuation">,</span>
                        parsedArgs<span class="token punctuation">.</span>mInstructionSet<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mAppDataDir<span class="token punctuation">,</span>
                        parsedArgs<span class="token punctuation">.</span>mIsTopApp<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>mPkgDataInfoList<span class="token punctuation">,</span>
                        parsedArgs<span class="token punctuation">.</span>mAllowlistedDataInfoList<span class="token punctuation">,</span> 
                        parsedArgs<span class="token punctuation">.</span>mBindMountAppDataDirs<span class="token punctuation">,</span>
                        parsedArgs<span class="token punctuation">.</span>mBindMountAppStorageDirs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// in child</span>
                        zygoteServer<span class="token punctuation">.</span><span class="token function">setForkChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">IoUtils</span><span class="token punctuation">.</span><span class="token function">closeQuietly</span><span class="token punctuation">(</span>serverPipeFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        serverPipeFd <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

                        <span class="token keyword">return</span> <span class="token function">handleChildProc</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">,</span> childPipeFd<span class="token punctuation">,</span>
                                parsedArgs<span class="token punctuation">.</span>mStartChildZygote<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token string">"Shouldn't get here"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">handleChildProc</span><span class="token punctuation">(</span><span class="token class-name">ZygoteArguments</span> parsedArgs<span class="token punctuation">,</span>
        <span class="token class-name">FileDescriptor</span> pipeFd<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isZygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mInvokeWith <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isZygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 3 isZygote 一般是 false</span>
            <span class="token keyword">return</span> <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">zygoteInit</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">.</span>mTargetSdkVersion<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mDisabledCompatChanges<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>mRemainingArgs<span class="token punctuation">,</span> <span class="token keyword">null</span> <span class="token comment">/* classLoader */</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 4</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">childZygoteInit</span><span class="token punctuation">(</span>
                    parsedArgs<span class="token punctuation">.</span>mRemainingArgs  <span class="token comment">/* classLoader */</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// </span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 3 处的 isZygote 一般是 false，注释 4 处调用的是 ZygoteInit.zygoteInit 方法：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">zygoteInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"RuntimeInit: Starting application from zygote"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"ZygoteInit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">redirectLogStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">commonInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ZygoteInit</span><span class="token punctuation">.</span><span class="token function">nativeZygoteInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">applicationInit</span><span class="token punctuation">(</span>targetSdkVersion<span class="token punctuation">,</span> disabledCompatChanges<span class="token punctuation">,</span> argv<span class="token punctuation">,</span>
            classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>注释 1 处调用 RuntimeInit.applicationInit 方法：</p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">applicationInit</span><span class="token punctuation">(</span><span class="token keyword">int</span> targetSdkVersion<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">nativeSetExitWithoutCleanup</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTargetSdkVersion</span><span class="token punctuation">(</span>targetSdkVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDisabledCompatChanges</span><span class="token punctuation">(</span>disabledCompatChanges<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">Arguments</span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Arguments</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// The end of of the RuntimeInit event (see #zygoteInit).</span>
    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Remaining arguments are passed to the start class's static main</span>
    <span class="token keyword">return</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>startClass<span class="token punctuation">,</span> args<span class="token punctuation">.</span>startArgs<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">findStaticMain</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">,</span>
        <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cl<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        cl <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">"Missing class when invoking static main "</span> <span class="token operator">+</span> className<span class="token punctuation">,</span>
                ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Method</span> m<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        m <span class="token operator">=</span> cl<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">"Missing static main on "</span> <span class="token operator">+</span> className<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">"Problem getting static main on "</span> <span class="token operator">+</span> className<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> modifiers <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token punctuation">(</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">"Main method is not public and static on "</span> <span class="token operator">+</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * This throw gets caught in ZygoteInit.main(), which responds
     * by invoking the exception's run() method. This arrangement
     * clears up all the stack frames that were required in setting
     * up the process.
     */</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MethodAndArgsCaller</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/** method to call */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Method</span> mMethod<span class="token punctuation">;</span>

    <span class="token comment">/** argument array */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mArgs<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MethodAndArgsCaller</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mMethod <span class="token operator">=</span> method<span class="token punctuation">;</span>
        mArgs <span class="token operator">=</span> args<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> mArgs <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Throwable</span> cause <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> cause<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cause <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">Error</span><span class="token punctuation">)</span> cause<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>MethodAndArgsCaller.run 方法最终会进入到 ActivityThread.main 方法中。</p> 
<p><img src="https://images2.imgbox.com/4b/a3/3G2eDmPe_o.png" alt="根Activity 启动时序图" width="100%" height="100%"></p> 
<p><img src="https://images2.imgbox.com/60/6a/Z3rEyUh7_o.png" alt="根Activity 启动时序图" width="100%" height="100%"></p> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/ActivityThread.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">prepareMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token class-name">ActivityThread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ActivityThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sMainThreadHandler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sMainThreadHandler <span class="token operator">=</span> thread<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMessageLogging</span><span class="token punctuation">(</span><span class="token keyword">new</span>
                <span class="token class-name">LogPrinter</span><span class="token punctuation">(</span><span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token constant">DEBUG</span><span class="token punctuation">,</span> <span class="token string">"ActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// End of event ActivityThreadMain.</span>
    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Main thread loop unexpectedly exited"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> system<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>system<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> <span class="token class-name">IActivityManager</span> mgr <span class="token operator">=</span> <span class="token class-name">ActivityManager</span><span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mgr<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>mAppThread<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">rethrowFromSystemServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</span>
<span class="token keyword">public</span> <span class="token class-name">ActivityTaskManagerInternal</span> mAtmInternal<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">IApplicationThread</span> thread<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>thread <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SecurityException</span><span class="token punctuation">(</span><span class="token string">"Invalid application interface"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> callingPid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> callingUid <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">getCallingUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> origId <span class="token operator">=</span> <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">clearCallingIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> callingPid<span class="token punctuation">,</span> callingUid<span class="token punctuation">,</span> startSeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Binder</span><span class="token punctuation">.</span><span class="token function">restoreCallingIdentity</span><span class="token punctuation">(</span>origId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">attachApplicationLocked</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">IApplicationThread</span> thread<span class="token punctuation">,</span>
        <span class="token keyword">int</span> pid<span class="token punctuation">,</span> <span class="token keyword">int</span> callingUid<span class="token punctuation">,</span> <span class="token keyword">long</span> startSeq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getIsolatedEntryPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instr2 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            thread<span class="token punctuation">.</span><span class="token function">bindApplication</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>sdkSandboxClientAppVolumeUuid<span class="token punctuation">,</span> app<span class="token punctuation">.</span>sdkSandboxClientAppPackage<span class="token punctuation">,</span>
                    providerList<span class="token punctuation">,</span>
                    instr2<span class="token punctuation">.</span>mClass<span class="token punctuation">,</span>
                    profilerInfo<span class="token punctuation">,</span> instr2<span class="token punctuation">.</span>mArguments<span class="token punctuation">,</span>
                    instr2<span class="token punctuation">.</span>mWatcher<span class="token punctuation">,</span>
                    instr2<span class="token punctuation">.</span>mUiAutomationConnection<span class="token punctuation">,</span> testMode<span class="token punctuation">,</span>
                    mBinderTransactionTrackingEnabled<span class="token punctuation">,</span> enableTrackAllocation<span class="token punctuation">,</span>
                    isRestrictedBackupMode <span class="token operator">||</span> <span class="token operator">!</span>normalMode<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">isPersistent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getCompat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getCommonServicesLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolated<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mCoreSettingsObserver<span class="token punctuation">.</span><span class="token function">getCoreSettingsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    buildSerial<span class="token punctuation">,</span> autofillOptions<span class="token punctuation">,</span> contentCaptureOptions<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getDisabledCompatChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedSystemFontMap<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getStartElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">getStartUptime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            thread<span class="token punctuation">.</span><span class="token function">bindApplication</span><span class="token punctuation">(</span>processName<span class="token punctuation">,</span> appInfo<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span>sdkSandboxClientAppVolumeUuid<span class="token punctuation">,</span> app<span class="token punctuation">.</span>sdkSandboxClientAppPackage<span class="token punctuation">,</span>
                    providerList<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> profilerInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> testMode<span class="token punctuation">,</span>
                    mBinderTransactionTrackingEnabled<span class="token punctuation">,</span> enableTrackAllocation<span class="token punctuation">,</span>
                    isRestrictedBackupMode <span class="token operator">||</span> <span class="token operator">!</span>normalMode<span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">isPersistent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getCompat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getCommonServicesLocked</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>isolated<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    mCoreSettingsObserver<span class="token punctuation">.</span><span class="token function">getCoreSettingsLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    buildSerial<span class="token punctuation">,</span> autofillOptions<span class="token punctuation">,</span> contentCaptureOptions<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getDisabledCompatChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedSystemFontMap<span class="token punctuation">,</span>
                    app<span class="token punctuation">.</span><span class="token function">getStartElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span><span class="token function">getStartUptime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">// See if the top visible activity is waiting to run in this process...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>normalMode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            didSomething <span class="token operator">=</span> mAtmInternal<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">getWindowProcessController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">wtf</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Exception thrown launching activities in "</span> <span class="token operator">+</span> app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            badApp <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/ActivityThread.java</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationThread</span> <span class="token keyword">extends</span> <span class="token class-name">IApplicationThread<span class="token punctuation">.</span>Stub</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bindApplication</span><span class="token punctuation">(</span><span class="token class-name">String</span> processName<span class="token punctuation">,</span> <span class="token class-name">ApplicationInfo</span> appInfo<span class="token punctuation">,</span>
            <span class="token class-name">String</span> sdkSandboxClientAppVolumeUuid<span class="token punctuation">,</span> <span class="token class-name">String</span> sdkSandboxClientAppPackage<span class="token punctuation">,</span>
            <span class="token class-name">ProviderInfoList</span> providerList<span class="token punctuation">,</span> <span class="token class-name">ComponentName</span> instrumentationName<span class="token punctuation">,</span>
            <span class="token class-name">ProfilerInfo</span> profilerInfo<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> instrumentationArgs<span class="token punctuation">,</span>
            <span class="token class-name">IInstrumentationWatcher</span> instrumentationWatcher<span class="token punctuation">,</span>
            <span class="token class-name">IUiAutomationConnection</span> instrumentationUiConnection<span class="token punctuation">,</span> <span class="token keyword">int</span> debugMode<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> enableBinderTracking<span class="token punctuation">,</span> <span class="token keyword">boolean</span> trackAllocation<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> isRestrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> persistent<span class="token punctuation">,</span> <span class="token class-name">Configuration</span> config<span class="token punctuation">,</span>
            <span class="token class-name">CompatibilityInfo</span> compatInfo<span class="token punctuation">,</span> <span class="token class-name">Map</span> services<span class="token punctuation">,</span> <span class="token class-name">Bundle</span> coreSettings<span class="token punctuation">,</span>
            <span class="token class-name">String</span> buildSerial<span class="token punctuation">,</span> <span class="token class-name">AutofillOptions</span> autofillOptions<span class="token punctuation">,</span>
            <span class="token class-name">ContentCaptureOptions</span> contentCaptureOptions<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> disabledCompatChanges<span class="token punctuation">,</span>
            <span class="token class-name">SharedMemory</span> serializedSystemFontMap<span class="token punctuation">,</span>
            <span class="token keyword">long</span> startRequestedElapsedTime<span class="token punctuation">,</span> <span class="token keyword">long</span> startRequestedUptime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token class-name">AppBindData</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppBindData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>processName <span class="token operator">=</span> processName<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>appInfo <span class="token operator">=</span> appInfo<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>sdkSandboxClientAppVolumeUuid <span class="token operator">=</span> sdkSandboxClientAppVolumeUuid<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>sdkSandboxClientAppPackage <span class="token operator">=</span> sdkSandboxClientAppPackage<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>providers <span class="token operator">=</span> providerList<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>instrumentationName <span class="token operator">=</span> instrumentationName<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>instrumentationArgs <span class="token operator">=</span> instrumentationArgs<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>instrumentationWatcher <span class="token operator">=</span> instrumentationWatcher<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>instrumentationUiAutomationConnection <span class="token operator">=</span> instrumentationUiConnection<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>debugMode <span class="token operator">=</span> debugMode<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>enableBinderTracking <span class="token operator">=</span> enableBinderTracking<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>trackAllocation <span class="token operator">=</span> trackAllocation<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>restrictedBackupMode <span class="token operator">=</span> isRestrictedBackupMode<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>persistent <span class="token operator">=</span> persistent<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>config <span class="token operator">=</span> config<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>compatInfo <span class="token operator">=</span> compatInfo<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>initProfilerInfo <span class="token operator">=</span> profilerInfo<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>buildSerial <span class="token operator">=</span> buildSerial<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>autofillOptions <span class="token operator">=</span> autofillOptions<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>contentCaptureOptions <span class="token operator">=</span> contentCaptureOptions<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>disabledCompatChanges <span class="token operator">=</span> disabledCompatChanges<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>mSerializedSystemFontMap <span class="token operator">=</span> serializedSystemFontMap<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>startRequestedElapsedTime <span class="token operator">=</span> startRequestedElapsedTime<span class="token punctuation">;</span>
        data<span class="token punctuation">.</span>startRequestedUptime <span class="token operator">=</span> startRequestedUptime<span class="token punctuation">;</span>
        <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">H</span><span class="token punctuation">.</span><span class="token constant">BIND_APPLICATION</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> what<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token function">sendMessage</span><span class="token punctuation">(</span>what<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">int</span> what<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> arg1<span class="token punctuation">,</span> <span class="token keyword">int</span> arg2<span class="token punctuation">,</span> <span class="token keyword">boolean</span> async<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MESSAGES</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span>
                <span class="token string">"SCHEDULE "</span> <span class="token operator">+</span> what <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> mH<span class="token punctuation">.</span><span class="token function">codeToString</span><span class="token punctuation">(</span>what<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> arg1 <span class="token operator">+</span> <span class="token string">" / "</span> <span class="token operator">+</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Message</span> msg <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>what <span class="token operator">=</span> what<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>obj <span class="token operator">=</span> obj<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> arg1<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>arg2 <span class="token operator">=</span> arg2<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>async<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mH<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">H</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">DEBUG_MESSAGES</span><span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">v</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"&gt;&gt;&gt; handling: "</span> <span class="token operator">+</span> <span class="token function">codeToString</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                 <span class="token keyword">case</span> <span class="token constant">BIND_APPLICATION</span><span class="token operator">:</span>
                      <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"bindApplication"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token class-name">AppBindData</span> data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AppBindData</span><span class="token punctuation">)</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">;</span>
                      <span class="token function">handleBindApplication</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">break</span><span class="token punctuation">;</span>
                  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
              <span class="token punctuation">}</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/ActivityThread.java</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleBindApplication</span><span class="token punctuation">(</span><span class="token class-name">AppBindData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// send up app name; do this *before* waiting for debugger</span>
    <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">setArgV0</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span>ddm<span class="token punctuation">.</span></span>DdmHandleAppName</span><span class="token punctuation">.</span><span class="token function">setAppName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>processName<span class="token punctuation">,</span>
                                            data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span>
                                            <span class="token class-name">UserHandle</span><span class="token punctuation">.</span><span class="token function">myUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">setProcessPackageName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Pass data directory path to ART. This is used for caching information and</span>
    <span class="token comment">// should be set before any application code is loaded.</span>
    <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span><span class="token function">setProcessDataDirectory</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>dataDir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mProfiler<span class="token punctuation">.</span>profileFd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mProfiler<span class="token punctuation">.</span><span class="token function">startProfiling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Instrumentation info affects the class loader, so load it before</span>
    <span class="token comment">// setting up the app context.</span>
    <span class="token keyword">final</span> <span class="token class-name">InstrumentationInfo</span> ii<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ii <span class="token operator">=</span> <span class="token function">prepareInstrumentation</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        ii <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mConfigurationController<span class="token punctuation">.</span><span class="token function">updateLocaleListFromAppContext</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Continue loading instrumentation.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ii <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">initInstrumentation</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span> data<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mInstrumentation<span class="token punctuation">.</span><span class="token function">basicInit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Allow disk access during application and provider setup. This could</span>
    <span class="token comment">// block processing ordered broadcasts, but later processing would</span>
    <span class="token comment">// probably end up doing the same disk access.</span>
    <span class="token class-name">Application</span> app<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">StrictMode<span class="token punctuation">.</span>ThreadPolicy</span> savedPolicy <span class="token operator">=</span> <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">allowThreadDiskWrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">StrictMode<span class="token punctuation">.</span>ThreadPolicy</span> writesAllowedPolicy <span class="token operator">=</span> <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">getThreadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If the app is being launched for full backup or restore, bring it up in</span>
        <span class="token comment">// a restricted environment with the base application class.</span>
        app <span class="token operator">=</span> data<span class="token punctuation">.</span>info<span class="token punctuation">.</span><span class="token function">makeApplicationInner</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>restrictedBackupMode<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// Do this after providers, since instrumentation tests generally start their</span>
        <span class="token comment">// test thread at this point, and we don't want that racing.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                <span class="token string">"Exception thrown in onCreate() of "</span>
                <span class="token operator">+</span> data<span class="token punctuation">.</span>instrumentationName <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                  <span class="token string">"Unable to create application "</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If the app targets &lt; O-MR1, or doesn't change the thread policy</span>
        <span class="token comment">// during startup, clobber the policy to maintain behavior of b/36951662</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>appInfo<span class="token punctuation">.</span>targetSdkVersion <span class="token operator">&lt;</span> <span class="token class-name">Build</span><span class="token punctuation">.</span><span class="token constant">VERSION_CODES</span><span class="token punctuation">.</span><span class="token constant">O_MR1</span>
                <span class="token operator">||</span> <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">getThreadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>writesAllowedPolicy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">StrictMode</span><span class="token punctuation">.</span><span class="token function">setThreadPolicy</span><span class="token punctuation">(</span>savedPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/LoadedApk.java</span>
<span class="token keyword">public</span> <span class="token class-name">Application</span> <span class="token function">makeApplicationInner</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceDefaultAppClass<span class="token punctuation">,</span>
        <span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">makeApplicationInner</span><span class="token punctuation">(</span>forceDefaultAppClass<span class="token punctuation">,</span> instrumentation<span class="token punctuation">,</span>
            <span class="token comment">/* allowDuplicateInstances= */</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Application</span> <span class="token function">makeApplicationInner</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> forceDefaultAppClass<span class="token punctuation">,</span>
        <span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowDuplicateInstances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token class-name">Application</span> app <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> <span class="token class-name">String</span> myProcessName <span class="token operator">=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">myProcessName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> appClass <span class="token operator">=</span> mApplicationInfo<span class="token punctuation">.</span><span class="token function">getCustomApplicationClassNameForProcess</span><span class="token punctuation">(</span>
            myProcessName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>forceDefaultAppClass <span class="token operator">||</span> <span class="token punctuation">(</span>appClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        appClass <span class="token operator">=</span> <span class="token string">"android.app.Application"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPackageName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"android"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">,</span>
                    <span class="token string">"initializeJavaContextClassLoader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">initializeJavaContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token class-name">ContextImpl</span> appContext <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span>mActivityThread<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// The network security config needs to be aware of multiple</span>
        <span class="token comment">// applications in the same process to handle discrepancies</span>
        <span class="token class-name">NetworkSecurityConfigProvider</span><span class="token punctuation">.</span><span class="token function">handleNewApplication</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        app <span class="token operator">=</span> mActivityThread<span class="token punctuation">.</span>mInstrumentation<span class="token punctuation">.</span><span class="token function">newApplication</span><span class="token punctuation">(</span>
                cl<span class="token punctuation">,</span> appClass<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
        appContext<span class="token punctuation">.</span><span class="token function">setOuterContext</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    mActivityThread<span class="token punctuation">.</span>mAllApplications<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mApplication <span class="token operator">=</span> app<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowDuplicateInstances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sApplications<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            sApplications<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>mPackageName<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>instrumentation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            instrumentation<span class="token punctuation">.</span><span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instrumentation<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"Unable to create application "</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_ACTIVITY_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/Instrumentation.java</span>
<span class="token keyword">public</span> <span class="token class-name">Application</span> <span class="token function">newApplication</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> cl<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> 
        <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Application</span> app <span class="token operator">=</span> <span class="token function">getFactory</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">instantiateApplication</span><span class="token punctuation">(</span>cl<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/Application.java</span>
<span class="token comment">/* package */</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mLoadedApk <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">getImpl</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span>mPackageInfo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/android/app/Instrumentation.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span><span class="token class-name">Application</span> app<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    app<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerInternal.java</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ActivityTaskManagerInternal</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/** Called by AM when an application process attaches. */</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> wpc<span class="token punctuation">)</span> <span class="token keyword">throws</span> 
       <span class="token class-name">RemoteException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityTaskManagerService.java</span>
<span class="token class-name">RootWindowContainer</span> mRootWindowContainer<span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">LocalService</span> <span class="token keyword">extends</span> <span class="token class-name">ActivityTaskManagerInternal</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@HotPath</span><span class="token punctuation">(</span>caller <span class="token operator">=</span> <span class="token class-name">HotPath</span><span class="token punctuation">.</span><span class="token constant">PROCESS_CHANGE</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> wpc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mGlobalLockWithoutBoost<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">isTagEnabled</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">,</span> <span class="token string">"attachApplication:"</span> <span class="token operator">+</span> wpc<span class="token punctuation">.</span>mName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> mRootWindowContainer<span class="token punctuation">.</span><span class="token function">attachApplication</span><span class="token punctuation">(</span>wpc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token constant">TRACE_TAG_WINDOW_MANAGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AttachApplicationHelper</span> mAttachApplicationHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AttachApplicationHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> <span class="token function">attachApplication</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> app<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mAttachApplicationHelper<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        mAttachApplicationHelper<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">AttachApplicationHelper</span> <span class="token keyword">implements</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">boolean</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WindowProcessController</span> app<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">RemoteException</span> <span class="token punctuation">{<!-- --></span>
        mApp <span class="token operator">=</span> app<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> displayNdx <span class="token operator">=</span> <span class="token function">getChildCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> displayNdx <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>displayNdx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">getChildAt</span><span class="token punctuation">(</span>displayNdx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mRemoteException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> mRemoteException<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHasActivityStarted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ensureActivitiesVisible</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* starting */</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token comment">/* configChanges */</span><span class="token punctuation">,</span>
                    <span class="token boolean">false</span> <span class="token comment">/* preserveWindows */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mHasActivityStarted<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/WindowContainer.java</span>
<span class="token keyword">boolean</span> <span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">forAllRootTasks</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* traverseTopToBottom */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">boolean</span> <span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">int</span> count <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> traverseTopToBottom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAllRootTasks</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> traverseTopToBottom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// Root tasks may be removed from this display. Ensure each task will be processed</span>
          <span class="token comment">// and the loop will end.</span>
          <span class="token keyword">int</span> newCount <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          i <span class="token operator">-=</span> count <span class="token operator">-</span> newCount<span class="token punctuation">;</span>
          count <span class="token operator">=</span> newCount<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/Task.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">void</span> <span class="token function">forAllRootTasks</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRootTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        callback<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">AttachApplicationHelper</span> <span class="token keyword">implements</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">Task</span> rootTask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRemoteException <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rootTask<span class="token punctuation">.</span><span class="token function">getVisibility</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token comment">/* starting */</span><span class="token punctuation">)</span>
                <span class="token operator">==</span> <span class="token constant">TASK_FRAGMENT_VISIBILITY_INVISIBLE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mTop <span class="token operator">=</span> rootTask<span class="token punctuation">.</span><span class="token function">topRunningActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rootTask<span class="token punctuation">.</span><span class="token function">forAllActivities</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/WindowContainer.java</span>
<span class="token keyword">boolean</span> <span class="token function">forAllActivities</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">forAllActivities</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/*traverseTopToBottom*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">boolean</span> <span class="token function">forAllActivities</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAllActivities</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> traverseTopToBottom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">final</span> <span class="token keyword">int</span> count <span class="token operator">=</span> mChildren<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mChildren<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forAllActivities</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> traverseTopToBottom<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/ActivityRecord.java</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">boolean</span> <span class="token function">forAllActivities</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">&gt;</span></span> callback<span class="token punctuation">,</span> <span class="token keyword">boolean</span> traverseTopToBottom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> callback<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/services/core/java/com/android/server/wm/RootWindowContainer.java</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">AttachApplicationHelper</span> <span class="token keyword">implements</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Task</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ActivityRecord</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">ActivityRecord</span> r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>finishing <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">showToCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>visibleIgnoringKeyguard
                <span class="token operator">||</span> r<span class="token punctuation">.</span>app <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> mApp<span class="token punctuation">.</span>mUid <span class="token operator">!=</span> r<span class="token punctuation">.</span>info<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid
                <span class="token operator">||</span> <span class="token operator">!</span>mApp<span class="token punctuation">.</span>mName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>processName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mTaskSupervisor<span class="token punctuation">.</span><span class="token function">realStartActivityLocked</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> mApp<span class="token punctuation">,</span>
                    mTop <span class="token operator">==</span> r <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">canBeResumed</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token comment">/* andResume */</span><span class="token punctuation">,</span>
                    <span class="token boolean">true</span> <span class="token comment">/* checkConfig */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mHasActivityStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Exception in new application when starting activity "</span> <span class="token operator">+</span> mTop<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mRemoteException <span class="token operator">=</span> e<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3d/b4/4YwfRbm5_o.png" alt="Activity 启动流程" width="80%" height="80%"></p> 
<h4><a id="_2438"></a>参考</h4> 
<p><a href="https://blog.csdn.net/ss520k/article/details/129147496">Android13 Activity启动流程</a><br> <a href="https://www.jb51.net/article/264690.htm" rel="nofollow">Android10 客户端事务管理ClientLifecycleManager源码解析</a><br> <a href="https://blog.csdn.net/baidu_41666295/article/details/103880101">Android Task详解</a><br> <a href="https://zhuanlan.zhihu.com/p/590572603" rel="nofollow">Android的Task管理</a><br> <a href="https://blog.csdn.net/m0_37602827/article/details/112000087">【framework】应用进程启动流程</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/750bf42c6ab10be9164339f2987fe92b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python Web开发 flask轻量级Web框架实战项目--学生管理系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/48903884d82d69aec473ffb4497d04de/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据结构-队列</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>