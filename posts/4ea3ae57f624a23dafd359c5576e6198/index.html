<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ansible自动化运维中剧本角色(roles)来完成apache服务操作 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/4ea3ae57f624a23dafd359c5576e6198/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Ansible自动化运维中剧本角色(roles)来完成apache服务操作">
  <meta property="og:description" content="🏡作者主页：点击！ 🐧Linux基础知识(初学)：点击！
🐧Linux高级管理防护和群集专栏：点击！
🔐Linux中firewalld防火墙：点击！
Ansible自动化运维：点击！
⏰️创作时间：2024年8月8日8点8分
目录
1.编写YAML
2.执行剧本
2.测试结果
4.修改端口号8888
1.编写剧本(角色)
目录介绍
files:
tasks:
handlers:
templates:
编写脚本
总结
在现代IT运维中，自动化已经成为提升效率和降低错误率的关键手段。Ansible作为一种强大的自动化工具，通过剧本（Playbooks）和角色（Roles）使得复杂的配置管理变得简单而高效。本文将探讨如何利用Ansible的角色功能来实现Apache服务的自动化管理。我们将通过定义角色结构、编写剧本以及执行相关操作，展示如何轻松部署和管理Apache Web服务器，从而提高运维工作的灵活性和可维护性。无论是在开发环境还是生产环境，通过Ansible，我们都能实现快速、可靠的服务部署与管理。
以下分开来讲解首先就是 单独的步骤 最后才是使用定义角色目录的方式来完成一整套流程操作
1.编写YAML 实现要求
1.安装apache
2.修改端口号为8080
3.启动apache服务
vim a.yaml --- - hosts: web remote_user: root tasks: - name: install httpd yum: name: httpd state: present tags: - aaa ​ - name: change apache port shell: sed -i &#39;s/Listen 80/Listen 8080/&#39; /etc/httpd/conf/httpd.conf tags: - bbb ​ - name: start apache service: name: httpd state: started enabled: yes tags: - ccc .">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-08T13:29:37+08:00">
    <meta property="article:modified_time" content="2024-08-08T13:29:37+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ansible自动化运维中剧本角色(roles)来完成apache服务操作</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="text-align:center;"> <img alt="" height="80" src="https://images2.imgbox.com/64/f1/feRpOxmL_o.gif" width="640"></p> 
<p style="text-align:center;"><strong>🏡作者主页：<strong><strong><strong><strong><strong><strong><strong><a href="https://blog.csdn.net/jxjdhdnd?type=blog" title="点击！">点击！</a></strong></strong></strong></strong></strong></strong></strong> </strong></p> 
<p style="text-align:center;"><strong>🐧Linux基础知识(初学)：<strong><a href="https://blog.csdn.net/jxjdhdnd/category_12527411.html?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22column%22%2C%22rId%22%3A%2212527411%22%2C%22source%22%3A%22jxjdhdnd%22%7D&amp;fromshare=blogcolumn" title="点击！">点击！</a></strong></strong></p> 
<p style="text-align:center;"><strong>🐧Linux高级管理防护和群集专栏：<strong><strong><strong><strong><strong><strong><strong><a href="https://blog.csdn.net/jxjdhdnd/category_12688607.html" title="点击！">点击！</a></strong></strong></strong></strong></strong></strong></strong></strong></p> 
<p style="text-align:center;"><strong>🔐Linux中firewalld防火墙：<strong><strong><strong><a href="https://blog.csdn.net/jxjdhdnd/category_12719323.html?csdn_share_tail=%7B%22type%22%3A%22blog%22%2C%22rType%22%3A%22column%22%2C%22rId%22%3A%2212719323%22%2C%22source%22%3A%22jxjdhdnd%22%7D&amp;fromshare=blogcolumn" title="点击！">点击！</a></strong></strong></strong></strong></p> 
<p style="text-align:center;"><strong><strong><strong><strong>Ansible自动化运维：<a class="link-info" href="https://blog.csdn.net/jxjdhdnd/category_12651908.html" title="点击！">点击！</a></strong></strong></strong></strong></p> 
<p style="text-align:center;"><strong>⏰️创作时间：2024年8月8日8点8分</strong></p> 
<p style="text-align:center;"><img alt="" height="80" src="https://images2.imgbox.com/b6/2e/V5cNtkI1_o.gif" width="640"></p> 
<hr> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="1.%E7%BC%96%E5%86%99YAML-toc" style="margin-left:40px;"><a href="#1.%E7%BC%96%E5%86%99YAML" rel="nofollow">1.编写YAML</a></p> 
<p id="2.%E6%89%A7%E8%A1%8C%E5%89%A7%E6%9C%AC-toc" style="margin-left:40px;"><a href="#2.%E6%89%A7%E8%A1%8C%E5%89%A7%E6%9C%AC" rel="nofollow">2.执行剧本</a></p> 
<p id="2.%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C-toc" style="margin-left:40px;"><a href="#2.%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C" rel="nofollow">2.测试结果</a></p> 
<p id="4.%E4%BF%AE%E6%94%B9%E7%AB%AF%E5%8F%A3%E5%8F%B78888-toc" style="margin-left:40px;"><a href="#4.%E4%BF%AE%E6%94%B9%E7%AB%AF%E5%8F%A3%E5%8F%B78888" rel="nofollow">4.修改端口号8888</a></p> 
<p id="header-b82a-2c05-toc" style="margin-left:80px;"></p> 
<p id="1.%E7%BC%96%E5%86%99%E5%89%A7%E6%9C%AC(%E8%A7%92%E8%89%B2)-toc" style="margin-left:0px;"><a href="#1.%E7%BC%96%E5%86%99%E5%89%A7%E6%9C%AC%28%E8%A7%92%E8%89%B2%29" rel="nofollow">1.编写剧本(角色)</a></p> 
<p id="%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D-toc" style="margin-left:40px;"><a href="#%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D" rel="nofollow">目录介绍</a></p> 
<p id="files%3A-toc" style="margin-left:80px;"><a href="#files%3A" rel="nofollow">files:</a></p> 
<p id="tasks%3A-toc" style="margin-left:80px;"><a href="#tasks%3A" rel="nofollow">tasks:</a></p> 
<p id="handlers%3A-toc" style="margin-left:80px;"><a href="#handlers%3A" rel="nofollow">handlers:</a></p> 
<p id="templates%3A-toc" style="margin-left:80px;"><a href="#templates%3A" rel="nofollow">templates:</a></p> 
<p id="%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC-toc" style="margin-left:40px;"><a href="#%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC" rel="nofollow">编写脚本</a></p> 
<p id="%E6%80%BB%E7%BB%93-toc" style="margin-left:0px;"><a href="#%E6%80%BB%E7%BB%93" rel="nofollow">总结</a></p> 
<hr id="hr-toc"> 
<p></p> 
<p>在现代IT运维中，自动化已经成为提升效率和降低错误率的关键手段。Ansible作为一种强大的自动化工具，<span style="color:#fe2c24;"><strong>通过剧本（Playbooks）和角色（Roles）使得复杂的配置管理变得简单而高效。</strong></span>本文将探讨如何利用Ansible的角色功能来实现Apache服务的自动化管理。我们将通过定义角色结构、编写剧本以及执行相关操作，展示如何轻松部署和管理Apache Web服务器，从而提高运维工作的灵活性和可维护性。无论是在开发环境还是生产环境，通过Ansible，我们都能实现快速、可靠的服务部署与管理。</p> 
<p><strong> </strong></p> 
<p><strong>以下分开来讲解首先就是 单独的步骤 最后才是使用定义角色目录的方式来完成一整套流程操作</strong></p> 
<h3 id="1.%E7%BC%96%E5%86%99YAML" style="background-color:transparent;">1.编写YAML</h3> 
<p><strong>实现要求</strong></p> 
<p>1.安装apache</p> 
<p>2.修改端口号为8080</p> 
<p>3.启动apache服务</p> 
<pre><code class="language-bash">vim a.yaml
---
- hosts: web
  remote_user: root
  tasks:
    - name: install httpd
      yum:
        name: httpd
        state: present
      tags:
        - aaa
​
    - name: change apache port
      shell: sed -i 's/Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf
      tags:
        - bbb
​
    - name: start apache
      service:
        name: httpd
        state: started
        enabled: yes
      tags:
        - ccc
...</code></pre> 
<p><strong>1.剧本结构</strong><br><strong>hosts:</strong></p> 
<p>指定了目标主机组为web，即所有在该组中的主机将会执行此剧本中的任务。</p> 
<p><strong>remote_user:</strong></p> 
<p>设置为root，表示以root用户身份连接目标主机，确保有足够的权限执行安装和配置操作。</p> 
<p><strong>2.任务列表<br> install httpd:</strong></p> 
<p>使用yum模块安装Apache HTTP服务器（httpd）。<br> state: present确保httpd包被安装。<br> tags: aaa允许在执行时通过标签选择性地运行此任务。</p> 
<p><br><strong>change apache port:</strong></p> 
<p>使用shell模块执行命令，修改Apache配置文件，将监听端口从80改为8080。<br> 这个步骤是为了避免与其他服务的端口冲突。<br> tags: bbb同样允许通过标签选择性地执行此任务。</p> 
<p><br><strong>start apache:</strong></p> 
<p>使用service模块启动Apache服务，并设置为开机自启。<br> state: started确保服务正在运行，enabled: yes确保服务在系统启动时自动启动。<br> tags: ccc便于通过标签选择性地执行此任务。</p> 
<p></p> 
<p></p> 
<p>使用ansible-playbook 来检测语法是否有问题</p> 
<pre><code class="language-bash">​
[root@localhost ~] ansible-playbook --syntax-check a.yaml 
​
playbook: a.yaml</code></pre> 
<p></p> 
<h3 id="2.%E6%89%A7%E8%A1%8C%E5%89%A7%E6%9C%AC">2.执行剧本</h3> 
<p>确认无误之后执行</p> 
<pre><code class="language-bash">ansible-playbook a.yaml</code></pre> 
<p><img alt="" height="442" src="https://images2.imgbox.com/26/48/0vAjx5pP_o.png" width="970"></p> 
<p></p> 
<p></p> 
<h3 id="2.%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C">2.测试结果</h3> 
<p>回到客户端检测是否成功的下载了httpd和修改了端口号以及启动服务</p> 
<pre><code class="language-bash">systemctl status httpd
netstat -nultp | grep httpd
tcp6       0      0 :::8080                 :::*                    LISTEN      3039/httpd</code></pre> 
<p><img alt="" height="449" src="https://images2.imgbox.com/75/04/7KQKevKU_o.png" width="1015"></p> 
<p>可以看到端口号确实为8080.</p> 
<p></p> 
<h3 id="4.%E4%BF%AE%E6%94%B9%E7%AB%AF%E5%8F%A3%E5%8F%B78888">4.修改端口号8888</h3> 
<h4 id="header-b82a-2c05"></h4> 
<p>单独的修改端口号，大家都知道修改完成之后不会立即生效，需要重启服务或者重载才生效。</p> 
<p>以下实验就成功的解决了找个问题</p> 
<p>注意！之前我们用sed把80端口修改为8080 现在需要修改sed语句 8080修改为8888</p> 
<p></p> 
<p>编写脚本</p> 
<pre><code>---
- hosts: web
  remote_user: root
  tasks:
    - name: change apache port
      shell: sed -i 's/Listen 8080/Listen 8888/' /etc/httpd/conf/httpd.conf
      notify: restart httpd server
​
  handlers:
    - name: restart httpd server
      service:
        name: httpd
        state: restarted
...</code></pre> 
<p>检测语法</p> 
<pre><code>[root@localhost ~]# ansible-playbook --syntax-check a.yaml 
​
playbook: a.yaml
[root@localhost ~]# ansible-playbook a.yaml</code></pre> 
<p>执行脚本</p> 
<p><img alt="" height="432" src="https://images2.imgbox.com/47/01/xTe2u3Jw_o.png" width="978"></p> 
<p></p> 
<p></p> 
<p>遇到问题先不要慌张一个个去排查，查看apache的报错日志</p> 
<p>我发现是我这台主机的Selinux没有关闭导致无法启动成功</p> 
<p>关闭重启以下即可解决成功</p> 
<p><img alt="" height="161" src="https://images2.imgbox.com/e8/55/9u5yrptd_o.png" width="987"></p> 
<p></p> 
<p></p> 
<p></p> 
<h2 id="1.%E7%BC%96%E5%86%99%E5%89%A7%E6%9C%AC(%E8%A7%92%E8%89%B2)">1.编写剧本(角色)</h2> 
<p>创建好所需文件夹</p> 
<pre><code>mkdir -p /etc/ansible/roles/apache/{files,tasks,handlers,templates}</code></pre> 
<h3 id="%E7%9B%AE%E5%BD%95%E4%BB%8B%E7%BB%8D">目录介绍</h3> 
<h4 id="files%3A">files:</h4> 
<p>存放静态文件，如配置文件、脚本或其他需要直接复制到目标主机的文件。 这些文件可以在剧本中通过 copy 或 template 模块进行引用。</p> 
<h4 id="tasks%3A"><span style="color:#fe2c24;">tasks:</span></h4> 
<p>用于定义具体的任务，<span style="color:#fe2c24;"><strong>这些任务是剧本的核心部分。 </strong></span>通常会有一个 main.yml 文件，里面列出所有需要执行的操作，如安装软件、修改配置等。</p> 
<h4 id="handlers%3A">handlers:</h4> 
<p>存放处理程序（handlers）<strong><span style="color:#fe2c24;">，这些是特殊的任务，仅在被其他任务触发时执行，</span></strong>例如在配置文件更改后重启服务。 也通常会有一个 main.yml 文件来定义这些处理程序。</p> 
<h4 id="templates%3A">templates:</h4> 
<p>用于存放Jinja2模板文件，这些模板可以动态生成配置文件。 在剧本中可以使用 template 模块渲染这些模板，并将结果复制到目标主机。</p> 
<p></p> 
<p>这是整体的文件夹结构树(主要看roles下的目录文件夹)</p> 
<pre><code>[root@localhost ansible]# tree
.
├── ansible.cfg
├── hosts
├── httpd.yml
└── roles
    └── apache
        ├── file
        ├── handlers
        │   └── main.yml
        ├── tasks
        │   └── main.yml
        └── templates</code></pre> 
<p><img alt="" height="475" src="https://images2.imgbox.com/1e/55/S11pXPza_o.png" width="791"></p> 
<p></p> 
<p></p> 
<p><strong>我们进入tasks目录编辑main.yml</strong></p> 
<p><strong>以下是完整路径</strong></p> 
<pre><code>vim /etc/ansible/roles/apache/tasks/main.yml
---
- name: install apache  # 安装 Apache HTTP 服务器
  yum:
    name: httpd
    state: present


- name: start apache  # 启动 Apache 服务并设置为开机自启
  service:
    name: httpd
    state: started
    enabled: yes


- name: change apache Port  # 修改 Apache 配置文件，将监听端口从 80 更改为 8080
  shell: sed -i 's/Listen 80/Listen 8080/' /etc/httpd/conf/httpd.conf
  notify:
  - restart httpd  # 通知重启 Apache 服务以应用更改</code></pre> 
<p></p> 
<p>在 /etc/ansible/roles/apache/handlers/main.yml 文件中，定义了一个处理程序，用于重启Apache HTTP服务器。以下是该文件的详细介绍：</p> 
<pre><code>vim /etc/ansible/roles/apache/handlers/main.yml 


---
- name: restart httpd
  service:
    name: httpd
    state: restarted
...</code></pre> 
<p><strong>name:</strong></p> 
<p>指定要管理的服务名称，这里是 httpd，即Apache HTTP服务器。<br><strong>state:</strong></p> 
<p><span style="color:#fe2c24;"><strong>设置为 restarted，表示在调用此处理程序时，会重启Apache服务。这通常在配置文件发生变化后调用，以使更改生效。</strong></span></p> 
<p></p> 
<h3 id="%E7%BC%96%E5%86%99%E8%84%9A%E6%9C%AC">编写脚本</h3> 
<p>再编写一个执行剧本的脚本</p> 
<pre><code>vim httpd.yml

---
- hosts: web
  remote_user: root
  roles:
  - apache
...
</code></pre> 
<p>执行</p> 
<p><strong>进入到你创建的执行脚本目录</strong></p> 
<pre><code>ansible-playbook httpd.yml</code></pre> 
<p></p> 
<p><img alt="" height="533" src="https://images2.imgbox.com/64/61/OCE6yZP1_o.png" width="994"></p> 
<p>可以看到脚本执行完毕 实验结束</p> 
<p></p> 
<p></p> 
<h2 id="%E6%80%BB%E7%BB%93" style="background-color:transparent;">总结</h2> 
<p>本文介绍了如何利用Ansible实现Apache HTTP服务器的自动化管理。通过编写YAML剧本和定义角色，我们成功完成了Apache的安装、端口修改和服务启动。这个过程展示了Ansible的灵活性和高效性，使得运维工作更加简洁和可靠。通过自动化，我们能够提升工作效率，减少人为错误，推动IT基础设施的现代化。</p> 
<p></p> 
<blockquote> 
 <p>成功的路上没有捷径，只有不断的努力与坚持。如果你和我一样，坚信努力会带来回报，请关注我，点个赞，一起迎接更加美好的明天！你的支持是我继续前行的动力！"</p> 
 <p>"每一次创作都是一次学习的过程，文章中若有不足之处，还请大家多多包容。你的关注和点赞是对我最大的支持，也欢迎大家提出宝贵的意见和建议，让我不断进步。"</p> 
 <p style="text-align:center;">神秘泣男子</p> 
 <p style="text-align:center;"><img alt="" height="331" src="https://images2.imgbox.com/a1/8f/C2lH5NJm_o.jpg" width="340"></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bc91eb401d6041ec8421f1ff3ab3020b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java I/O (Input/Output)——文件字节流</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/887b1bbb424e022e600c98792156d4bc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ubuntu环境安装MySQL</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>