<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python 日志记录：6大日志记录库的比较 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/307962170ba4af85404159ba4c04e4f1/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Python 日志记录：6大日志记录库的比较">
  <meta property="og:description" content="Python 日志记录：6大日志记录库的比较 文章目录 Python 日志记录：6大日志记录库的比较前言一些日志框架建议1. logging - 内置的标准日志模块默认日志记录器自定义日志记录器生成结构化日志 2. Loguru - 最流行的Python第三方日志框架默认日志记录器自定义日志记录器 3. Structlog4. Eliot5. Logbook6. Picologging最后的想法 前言 日志记录框架是一种工具，可帮助您标准化应用程序中的日志记录过程。虽然某些编程语言提供内置日志记录模块作为其标准库的一部分，但大多数日志记录框架都是第三方库，例如logging (Python)、Log4j (Java)、 Zerolog (Go) 或 Winston (Node.js)。有时，组织会选择开发自定义日志记录解决方案，但这通常仅限于具有高度专业化需求的大型公司。
虽然 Python 在其标准库中提供了强大且功能丰富的日志记录解决方案，但第三方日志记录生态系统也提供了一系列引人注目的替代方案。根据您的需求，这些外部库可能更适合您的日志记录需求。
因此，本文将介绍 Python 用于跟踪应用程序和库行为的六大日志解决方案。我们将首先讨论标准logging模块，然后研究 Python 社区创建的其他五个logging frameworks。
一些日志框架建议 Pino (Node.js)
Zerolog, Zap, or Slog (Go)
Monolog (PHP)
SLF4J with Log4J2 or Logback (Java)
Loguru (Python)
Semantic Logger (Ruby)
1. logging - 内置的标准日志模块 默认日志记录器 与大多数编程语言不同，Python 在其标准库中包含了一个功能齐全的日志框架。该日志记录解决方案有效地满足了库和应用程序开发人员的需求，并包含了以下严重性级别：DEBUG、INFO、WARNING、ERROR 和 CRITICAL。有了默认日志记录器，无需任何前期设置，您就可以立即开始记录日志。
import logging logging.debug(&#34;A debug message&#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-07-30T18:46:58+08:00">
    <meta property="article:modified_time" content="2023-07-30T18:46:58+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python 日志记录：6大日志记录库的比较</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Python_6_0"></a>Python 日志记录：6大日志记录库的比较</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Python_6_0" rel="nofollow">Python 日志记录：6大日志记录库的比较</a></li><li><ul><li><a href="#_3" rel="nofollow">前言</a></li><li><a href="#_13" rel="nofollow">一些日志框架建议</a></li><li><a href="#1_logging___25" rel="nofollow">1. logging - 内置的标准日志模块</a></li><li><ul><li><a href="#_27" rel="nofollow">默认日志记录器</a></li><li><a href="#_49" rel="nofollow">自定义日志记录器</a></li><li><a href="#_135" rel="nofollow">生成结构化日志</a></li></ul> 
   </li><li><a href="#2_Loguru__Python_193" rel="nofollow">2. Loguru - 最流行的Python第三方日志框架</a></li><li><ul><li><a href="#_197" rel="nofollow">默认日志记录器</a></li><li><a href="#_222" rel="nofollow">自定义日志记录器</a></li></ul> 
   </li><li><a href="#3_Structlog_317" rel="nofollow">3. Structlog</a></li><li><a href="#4_Eliot_441" rel="nofollow">4. Eliot</a></li><li><a href="#5_Logbook_604" rel="nofollow">5. Logbook</a></li><li><a href="#6_Picologging_686" rel="nofollow">6. Picologging</a></li><li><a href="#_727" rel="nofollow">最后的想法</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_3"></a>前言</h3> 
<p>日志记录框架是一种工具，可帮助您标准化应用程序中的日志记录过程。虽然某些编程语言提供内置日志记录模块作为其标准库的一部分，但大多数日志记录框架都是第三方库，例如<a href="https://docs.python.org/3/library/logging.html" rel="nofollow">logging</a> (Python)、<a href="https://betterstack.com/community/guides/logging/how-to-start-logging-with-log4j/" rel="nofollow">Log4j</a> (Java)、 <a href="https://betterstack.com/community/guides/logging/zerolog/" rel="nofollow">Zerolog</a> (Go) 或 <a href="https://betterstack.com/community/guides/logging/how-to-install-setup-and-use-winston-and-morgan-to-log-node-js-applications/" rel="nofollow">Winston</a> (Node.js)。有时，组织会选择开发自定义日志记录解决方案，但这通常仅限于具有高度专业化需求的大型公司。</p> 
<p>虽然 Python 在其标准库中提供了强大且功能丰富的日志记录解决方案，但第三方日志记录生态系统也提供了一系列引人注目的替代方案。根据您的需求，这些外部库可能更适合您的日志记录需求。</p> 
<p>因此，本文将介绍 Python 用于跟踪应用程序和库行为的六大日志解决方案。我们将首先讨论标准<code>logging</code>模块，然后研究 Python 社区创建的其他五个<a href="https://betterstack.com/community/guides/logging/logging-framework/" rel="nofollow">logging frameworks</a>。</p> 
<h3><a id="_13"></a>一些日志框架建议</h3> 
<ul><li> <p><a href="https://github.com/pinojs/pino">Pino</a> (Node.js)</p> </li><li> <p><a href="https://github.com/rs/zerolog">Zerolo</a>g, Zap, or Slog (Go)</p> </li><li> <p><a href="https://github.com/Seldaek/monolog">Monolog</a> (PHP)</p> </li><li> <p><a href="https://slf4j.org/" rel="nofollow">SLF4J</a> with <a href="https://betterstack.com/community/guides/logging/how-to-start-logging-with-log4j/" rel="nofollow">Log4J2</a> or <a href="https://betterstack.com/community/guides/logging/java/logback/" rel="nofollow">Logback</a> (Java)</p> </li><li> <p>Loguru (Python)</p> </li><li> <p>Semantic Logger (Ruby)</p> </li></ul> 
<h3><a id="1_logging___25"></a>1. logging - 内置的标准日志模块</h3> 
<h4><a id="_27"></a>默认日志记录器</h4> 
<p>与大多数编程语言不同，Python 在其标准库中包含了一个功能齐全的日志框架。该日志记录解决方案有效地满足了库和应用程序开发人员的需求，并包含了以下严重性级别：<code>DEBUG</code>、<code>INFO</code>、<code>WARNING</code>、<code>ERROR</code> 和 <code>CRITICAL</code>。有了默认日志记录器，无需任何前期设置，您就可以立即开始记录日志。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> logging

logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"A debug message"</span><span class="token punctuation">)</span>
logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"An info message"</span><span class="token punctuation">)</span>
logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"A warning message"</span><span class="token punctuation">)</span>
logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"An error message"</span><span class="token punctuation">)</span>
logging<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">"A critical message"</span><span class="token punctuation">)</span>
</code></pre> 
<p>此default（或root）记录器在该<code>WARNING</code>级别运行，这意味着只有严重性等于或超过的记录调用<code>WARNING</code>才会产生输出：</p> 
<pre><code class="prism language-ini">WARNING:root:A warning message
ERROR:root:An error message
CRITICAL:root:A critical message
</code></pre> 
<h4><a id="_49"></a>自定义日志记录器</h4> 
<p>这种配置可确保只显示潜在的重要信息，减少日志输出中的噪音。不过，您也可以根据需要自定义日志级别并微调日志记录行为。使用<code>logging</code>模块的推荐方法是通过 <code>getLogger()</code>方法创建自定义日志记录器：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> logging

logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
</code></pre> 
<p>一旦有了自定义记录器，您就可以通过 <code>logging</code>模块 提供的<a href="https://docs.python.org/3/library/logging.handlers.html" rel="nofollow">Handler</a>(处理程序)、 <a href="https://docs.python.org/3/library/logging.html#logging.Formatter" rel="nofollow">Formatter</a>(格式化器)和<a href="https://docs.python.org/3/library/logging.html#filter-objects" rel="nofollow">Filter</a>(过滤器) 类来自定义其输出。</p> 
<ul><li> <p><code>Handlers</code>决定输出目的地，并可根据日志级别进行定制。一个日志记录器还可添加多个<code>Handlers</code>，以便同时向不同目的地发送日志信息。</p> </li><li> <p><code>Formatters</code>决定了日志记录器产生的记录的格式。然而，目前还没有JSON、Logfmt等预定义格式。您必须结合<a href="https://docs.python.org/3/library/logging.html#logrecord-attributes" rel="nofollow">可用的日志记录属性</a>来构建自己的格式。<br> root日志记录器的默认格式为<code>%(levelname)s:%(name)s:%(message)s</code>。<br> 然而，自定义日志记录器默认为只有<code>%(message)s</code>。</p> </li><li> <p><code>Filters</code>由<code>handler</code>和<code>logger objects</code>使用，用于过滤日志记录。与<a href="https://betterstack.com/community/guides/logging/log-levels-explained/" rel="nofollow">日志级别</a>相比，<code>Filters</code>能更好地控制哪些日志记录应被处理或忽略。在日志被发送到最终目的地之前，它们还能以某种方式增强或修改记录。例如，您可以创建一个自定义过滤器，以删除日志中的<a href="https://betterstack.com/community/guides/logging/sensitive-data/" rel="nofollow">敏感数据</a>。</p> </li></ul> 
<p>下面是一个使用自定义日志记录器将日志记录到控制台和文件的示例：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> logging

logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">"example"</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>

<span class="token comment"># Create handlers for logging to the standard output and a file</span>
stdoutHandler <span class="token operator">=</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span>stream<span class="token operator">=</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>
errHandler <span class="token operator">=</span> logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">"error.log"</span><span class="token punctuation">)</span>

<span class="token comment"># Set the log levels on the handlers</span>
stdoutHandler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>
errHandler<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span>

<span class="token comment"># Create a log format using Log Record attributes</span>
fmt <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span>
    <span class="token string">"%(name)s: %(asctime)s | %(levelname)s | %(filename)s:%(lineno)s | %(process)d &gt;&gt;&gt; %(message)s"</span>
<span class="token punctuation">)</span>

<span class="token comment"># Set the log format on each handler</span>
stdoutHandler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>fmt<span class="token punctuation">)</span>
errHandler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>fmt<span class="token punctuation">)</span>

<span class="token comment"># Add each handler to the Logger object</span>
logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>stdoutHandler<span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>errHandler<span class="token punctuation">)</span>

logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Server started listening on port 8080"</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>
    <span class="token string">"Disk space on drive '/var/log' is running low. Consider freeing up space"</span>
<span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"Failed to connect to database: 'my_db'"</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token comment"># exc_info=True ensures that a Traceback is included</span>
    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span>e<span class="token punctuation">,</span> exc_info<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<p>执行上述程序时，控制台会如期打印出以下日志信息：</p> 
<pre><code class="prism language-ini">example: 2023-07-23 14:42:18,599 | INFO | main.py:30 | 187901 &gt;&gt;&gt; Server started listening on port 8080

example: 2023-07-23 14:14:47,578 | WARNING | main.py:28 | 143936 &gt;&gt;&gt; Disk space on drive '/var/log' is running low. Consider freeing up space

example: 2023-07-23 14:14:47,578 | ERROR | main.py:34 | 143936 &gt;&gt;&gt; Failed to connect to database: 'my_db'

Traceback (most recent call last):
  File "/home/ayo/dev/betterstack/demo/python-logging/main.py", line 32, in &lt;module&gt;
    raise Exception("Failed to connect to database: 'my_db'")
Exception: Failed to connect to database: 'my_db'
</code></pre> 
<p>同时还创建了 error.log 文件，该文件应仅包含 ERROR 日志，因为 errHandler 的最小级别已设置为 ERROR：</p> 
<pre><code class="prism language-ini">example: 2023-07-23 14:14:47,578 | ERROR | main.py:34 | 143936 &gt;&gt;&gt; Failed to connect to database: 'my_db'
Traceback (most recent call last):
  File "/home/ayo/dev/betterstack/demo/python-logging/main.py", line 32, in &lt;module&gt;
    raise Exception("Failed to connect to database: 'my_db'")
Exception: Failed to connect to database: 'my_db'
</code></pre> 
<h4><a id="_135"></a>生成结构化日志</h4> 
<p>在撰写本文时，除非<a href="https://docs.python.org/3/howto/logging-cookbook.html#implementing-structured-logging" rel="nofollow">执行一些附加代码</a>，否则<code>logging</code>模块无法生成结构化日志。值得庆幸的是，有一种更简单、更好的方法可以获得结构化输出：<a href="https://github.com/madzak/python-json-logger">python-json-logger</a> 库。</p> 
<pre><code class="prism language-bash">$ pip <span class="token function">install</span> python-json-logger
</code></pre> 
<p>安装后，您可以按以下方式使用它：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> pythonjsonlogger <span class="token keyword">import</span> jsonlogger

<span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>

<span class="token comment"># The desired Log Record attributes must be included here, and they can be</span>
<span class="token comment"># renamed if necessary</span>
fmt <span class="token operator">=</span> jsonlogger<span class="token punctuation">.</span>JsonFormatter<span class="token punctuation">(</span>
    <span class="token string">"%(name)s %(asctime)s %(levelname)s %(filename)s %(lineno)s %(process)d %(message)s"</span><span class="token punctuation">,</span>
    rename_fields<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"levelname"</span><span class="token punctuation">:</span> <span class="token string">"severity"</span><span class="token punctuation">,</span> <span class="token string">"asctime"</span><span class="token punctuation">:</span> <span class="token string">"timestamp"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># Set the log format on each handler</span>
stdoutHandler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>fmt<span class="token punctuation">)</span>
errHandler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>fmt<span class="token punctuation">)</span>

<span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
</code></pre> 
<p>如果用上面突出显示的几行修改前面的示例，执行时将观察到以下输出：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"example"</span><span class="token punctuation">,</span> <span class="token string-property property">"filename"</span><span class="token operator">:</span> <span class="token string">"main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"lineno"</span><span class="token operator">:</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token string-property property">"process"</span><span class="token operator">:</span> <span class="token number">179775</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"Server started listening on port 8080"</span><span class="token punctuation">,</span> <span class="token string-property property">"severity"</span><span class="token operator">:</span> <span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2023-07-23 14:39:03,265"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"example"</span><span class="token punctuation">,</span> <span class="token string-property property">"filename"</span><span class="token operator">:</span> <span class="token string">"main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"lineno"</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string-property property">"process"</span><span class="token operator">:</span> <span class="token number">179775</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"Disk space on drive '/var/log' is running low. Consider freeing up space"</span><span class="token punctuation">,</span> <span class="token string-property property">"severity"</span><span class="token operator">:</span> <span class="token string">"WARNING"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2023-07-23 14:39:03,265"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"example"</span><span class="token punctuation">,</span> <span class="token string-property property">"filename"</span><span class="token operator">:</span> <span class="token string">"main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"lineno"</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span> <span class="token string-property property">"process"</span><span class="token operator">:</span> <span class="token number">179775</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"Failed to connect to database: 'my_db'"</span><span class="token punctuation">,</span> <span class="token string-property property">"exc_info"</span><span class="token operator">:</span> <span class="token string">"Traceback (most recent call last):\n  File \"/home/ayo/dev/betterstack/demo/python-logging/main.py\", line 36, in &lt;module&gt;\n    raise Exception(\"Failed to connect to database: 'my_db'\")\nException: Failed to connect to database: 'my_db'"</span><span class="token punctuation">,</span> <span class="token string-property property">"severity"</span><span class="token operator">:</span> <span class="token string">"ERROR"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2023-07-23 14:39:03,265"</span><span class="token punctuation">}</span>
</code></pre> 
<p>还可以通过 level 方法上的<code>extra</code>属性在log point添加上下文数据，如下所示：</p> 
<pre><code class="prism language-python">logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
    <span class="token string">"Server started listening on port 8080"</span><span class="token punctuation">,</span>
    extra<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"python_version"</span><span class="token punctuation">:</span> <span class="token number">3.10</span><span class="token punctuation">,</span> <span class="token string">"os"</span><span class="token punctuation">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span> <span class="token string">"host"</span><span class="token punctuation">:</span> <span class="token string">"fedora 38"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"example"</span><span class="token punctuation">,</span> <span class="token string-property property">"filename"</span><span class="token operator">:</span> <span class="token string">"main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"lineno"</span><span class="token operator">:</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token string-property property">"process"</span><span class="token operator">:</span> <span class="token number">195301</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"Server started listening on port 8080"</span><span class="token punctuation">,</span> <span class="token string-property property">"python_version"</span><span class="token operator">:</span> <span class="token number">3.1</span><span class="token punctuation">,</span> <span class="token string-property property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span> <span class="token string-property property">"host"</span><span class="token operator">:</span> <span class="token string">"fedora 38"</span><span class="token punctuation">,</span> <span class="token string-property property">"severity"</span><span class="token operator">:</span> <span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2023-07-23 14:45:42,472"</span><span class="token punctuation">}</span>
</code></pre> 
<p>正如您所看到的，built-in的 <code>logging</code> module 能够满足各种日志记录需求，并且具有可扩展性。不过，它的初始配置和自定义可能比较麻烦，因为在开始有效记录之前，你必须创建和配置<code>loggers</code>、<code>handlers</code>和<code>formatters</code>。</p> 
<p>请参阅我们的 <a href="https://betterstack.com/community/guides/logging/how-to-start-logging-with-python/" rel="nofollow">Python 日志指南</a>和<a href="https://docs.python.org/3/library/logging.html" rel="nofollow">官方文档</a>，进一步了解日志模块的功能和最佳实践。</p> 
<h3><a id="2_Loguru__Python_193"></a>2. Loguru - 最流行的Python第三方日志框架</h3> 
<p><a href="https://betterstack.com/community/guides/logging/loguru/" rel="nofollow">Loguru</a> 是最流行的 Python 第三方日志框架，在撰写本文时已在 <a href="https://github.com/Delgan/loguru">GitHub</a> 上获得超过 15k颗星。它旨在通过预配置日志记录器来简化日志记录过程，并通过其 <code>add()</code> 方法使自定义日志记录器变得非常容易。</p> 
<h4><a id="_197"></a>默认日志记录器</h4> 
<p>使用 Loguru 启动日志记录非常简单，只需安装软件包并导入，然后调用其级别方法即可，如下所示：</p> 
<pre><code class="prism language-bash">$ pip <span class="token function">install</span> loguru
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">from</span> loguru <span class="token keyword">import</span> logger

logger<span class="token punctuation">.</span>trace<span class="token punctuation">(</span><span class="token string">"Executing program"</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"Processing data..."</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Server started successfully."</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"Data processing completed successfully."</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"Invalid configuration detected."</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"Failed to connect to the database."</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">"Unexpected system error occurred. Shutting down."</span><span class="token punctuation">)</span>
</code></pre> 
<p>默认配置将半结构化和彩色化的输出记录到标准错误。它还默认将 <code>DEBUG</code> 作为最低级别，这也解释了为什么 <code>TRACE</code> 输出不会被记录。</p> 
<p><img src="https://images2.imgbox.com/2b/7b/CyQ8PUKo_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_222"></a>自定义日志记录器</h4> 
<p>通过 <code>add()</code> 函数，可以轻松定制 Loguru 的内部工作机制，该函数可处理从日志格式化到日志目的地设置等一切操作。例如，您可以将日志记录到标准输出，将默认级别更改为 <code>INFO</code>，并使用下面的配置将日志格式化为 JSON：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> loguru <span class="token keyword">import</span> logger
<span class="token keyword">import</span> sys

logger<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># remove the default handler configuration</span>
logger<span class="token punctuation">.</span>add<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span> level<span class="token operator">=</span><span class="token string">"INFO"</span><span class="token punctuation">,</span> serialize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"2023-07-17 15:26:21.597 | INFO     | __main__:&lt;module&gt;:9 - Server started successfully.\n"</span><span class="token punctuation">,</span> <span class="token string-property property">"record"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"elapsed"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"repr"</span><span class="token operator">:</span> <span class="token string">"0:00:00.006401"</span><span class="token punctuation">,</span> <span class="token string-property property">"seconds"</span><span class="token operator">:</span> <span class="token number">0.006401</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"exception"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string-property property">"extra"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"file"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"path"</span><span class="token operator">:</span> <span class="token string">"/home/ayo/dev/betterstack/demo/python-logging/main.py"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"function"</span><span class="token operator">:</span> <span class="token string">"&lt;module&gt;"</span><span class="token punctuation">,</span> <span class="token string-property property">"level"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"icon"</span><span class="token operator">:</span> <span class="token string">"ℹ️"</span><span class="token punctuation">,</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string-property property">"no"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"line"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"Server started successfully."</span><span class="token punctuation">,</span> <span class="token string-property property">"module"</span><span class="token operator">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"__main__"</span><span class="token punctuation">,</span> <span class="token string-property property">"process"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token number">3852028</span><span class="token punctuation">,</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"MainProcess"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"thread"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token number">140653618894656</span><span class="token punctuation">,</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"MainThread"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string-property property">"time"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"repr"</span><span class="token operator">:</span> <span class="token string">"2023-07-17 15:26:21.597156+02:00"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1689600381.597156</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<p>Loguru 生成的默认 JSON 输出可能相当冗长，但使用类似这样的<a href="https://loguru.readthedocs.io/en/stable/resources/recipes.html#serializing-log-messages-using-a-custom-function" rel="nofollow">自定义函数可以轻松地将日志信息序列化</a>：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> loguru <span class="token keyword">import</span> logger
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> json

<span class="token keyword">def</span> <span class="token function">serialize</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">:</span>
    subset <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"timestamp"</span><span class="token punctuation">:</span> record<span class="token punctuation">[</span><span class="token string">"time"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>timestamp<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"message"</span><span class="token punctuation">:</span> record<span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"level"</span><span class="token punctuation">:</span> record<span class="token punctuation">[</span><span class="token string">"level"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token string">"file"</span><span class="token punctuation">:</span> record<span class="token punctuation">[</span><span class="token string">"file"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token string">"context"</span><span class="token punctuation">:</span> record<span class="token punctuation">[</span><span class="token string">"extra"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>subset<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">patching</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">:</span>
    record<span class="token punctuation">[</span><span class="token string">"extra"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"serialized"</span><span class="token punctuation">]</span> <span class="token operator">=</span> serialize<span class="token punctuation">(</span>record<span class="token punctuation">)</span>

logger<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

logger <span class="token operator">=</span> logger<span class="token punctuation">.</span>patch<span class="token punctuation">(</span>patching<span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>add<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stderr<span class="token punctuation">,</span> <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"{extra[serialized]}"</span><span class="token punctuation">)</span>

logger<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>user_id<span class="token operator">=</span><span class="token string">"USR-1243"</span><span class="token punctuation">,</span> doc_id<span class="token operator">=</span><span class="token string">"DOC-2348"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"Processing document"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1689601339.628792</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"Processing document"</span><span class="token punctuation">,</span> <span class="token string-property property">"level"</span><span class="token operator">:</span> <span class="token string">"DEBUG"</span><span class="token punctuation">,</span> <span class="token string-property property">"file"</span><span class="token operator">:</span> <span class="token string">"main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token string">"USR-1243"</span><span class="token punctuation">,</span> <span class="token string-property property">"doc_id"</span><span class="token operator">:</span> <span class="token string">"DOC-2348"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<p>Loguru 也完全支持上下文日志记录。您已经看到上面的 <code>bind()</code> 方法，它允许在 log point 添加上下文数据。</p> 
<p>您还可以使用 <code>bind()</code> 方法来创建子记录器来记录共享相同上下文的记录：</p> 
<pre><code class="prism language-python">child <span class="token operator">=</span> logger<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>user_id<span class="token operator">=</span><span class="token string">"USR-1243"</span><span class="token punctuation">,</span> doc_id<span class="token operator">=</span><span class="token string">"DOC-2348"</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"Processing document"</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"Invalid configuration detected. Falling back to defaults"</span><span class="token punctuation">)</span>
child<span class="token punctuation">.</span>success<span class="token punctuation">(</span><span class="token string">"Document processed successfully"</span><span class="token punctuation">)</span>
</code></pre> 
<p>请注意，user_id 和 doc_id 字段出现在所有三条记录中：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1689601518.884659</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"Processing document"</span><span class="token punctuation">,</span> <span class="token string-property property">"level"</span><span class="token operator">:</span> <span class="token string">"DEBUG"</span><span class="token punctuation">,</span> <span class="token string-property property">"file"</span><span class="token operator">:</span> <span class="token string">"main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token string">"USR-1243"</span><span class="token punctuation">,</span> <span class="token string-property property">"doc_id"</span><span class="token operator">:</span> <span class="token string">"DOC-2348"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1689601518.884706</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"Invalid configuration detected. Falling back to defaults"</span><span class="token punctuation">,</span> <span class="token string-property property">"level"</span><span class="token operator">:</span> <span class="token string">"WARNING"</span><span class="token punctuation">,</span> <span class="token string-property property">"file"</span><span class="token operator">:</span> <span class="token string">"main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token string">"USR-1243"</span><span class="token punctuation">,</span> <span class="token string-property property">"doc_id"</span><span class="token operator">:</span> <span class="token string">"DOC-2348"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1689601518.884729</span><span class="token punctuation">,</span> <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"Document processed successfully"</span><span class="token punctuation">,</span> <span class="token string-property property">"level"</span><span class="token operator">:</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">,</span> <span class="token string-property property">"file"</span><span class="token operator">:</span> <span class="token string">"main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"context"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token string">"USR-1243"</span><span class="token punctuation">,</span> <span class="token string-property property">"doc_id"</span><span class="token operator">:</span> <span class="token string">"DOC-2348"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<p>另一方面，它的 <code>contextualize()</code> 方法可以轻松地为特定范围或上下文中的所有日志记录添加上下文字段。例如，下面的代码段演示了将唯一的请求 ID 属性添加到因该请求而创建的所有日志中：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> loguru <span class="token keyword">import</span> logger
<span class="token keyword">import</span> uuid

<span class="token keyword">def</span> <span class="token function">logging_middleware</span><span class="token punctuation">(</span>get_response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        request_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">with</span> logger<span class="token punctuation">.</span>contextualize<span class="token punctuation">(</span>request_id<span class="token operator">=</span>request_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
            response <span class="token operator">=</span> get_response<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
            response<span class="token punctuation">[</span><span class="token string">"X-Request-ID"</span><span class="token punctuation">]</span> <span class="token operator">=</span> request_id
            <span class="token keyword">return</span> response

    <span class="token keyword">return</span> middleware
</code></pre> 
<p>Loguru 还支持<a href="https://betterstack.com/community/guides/logging/logging-framework/" rel="nofollow">优秀日志框架所应具备的所有功能</a>，如通过<a href="https://betterstack.com/community/guides/logging/how-to-manage-log-files-with-logrotate-on-ubuntu-20-04/" rel="nofollow">自动旋转和压缩</a>将日志记录到文件、自定义日志级别、异常处理、同时记录到多个目的地等。它还为来自标准<code>logging</code>模块的用户提供了<a href="https://loguru.readthedocs.io/en/stable/resources/migration.html" rel="nofollow">迁移指南</a>。</p> 
<p>请参阅<a href="https://loguru.readthedocs.io/en/stable/index.html" rel="nofollow">Loguru 官方文档</a>和我们<a href="https://betterstack.com/community/guides/logging/loguru/" rel="nofollow">专用 Loguru 指南</a>，了解有关使用 Loguru 为 Python 应用程序创建production-ready日志设置的更多信息。</p> 
<h3><a id="3_Structlog_317"></a>3. Structlog</h3> 
<p><a href="https://www.structlog.org/en/stable/" rel="nofollow">Structlog</a> 是一个日志库，专门用于生成 JSON 或 Logfmt 格式的结构化输出。它支持为开发环境提供彩色、美观的控制台输出，也允许完全自定义日志格式，以满足不同需求。你可以使用下面的命令安装 Structlog 软件包：</p> 
<pre><code class="prism language-bash">$ pip <span class="token function">install</span> structlog
</code></pre> 
<p>Structlog 最简单的用法是调用 <code>get_logger()</code>方法，然后在生成的logger上使用任何level方法：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> structlog

logger <span class="token operator">=</span> structlog<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span>

logger<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">"Database query executed in 0.025 seconds"</span><span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
    <span class="token string">"Processing file 'data.csv' completed. 1000 records were imported"</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">"data.csv"</span><span class="token punctuation">,</span>
    elapsed_ms<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span>
    num_records<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>
    <span class="token string">"Unable to load configuration file 'config.ini'. Using default settings instead"</span><span class="token punctuation">,</span>
    <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">"config.ini"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span>
<span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>exception<span class="token punctuation">(</span>
        <span class="token string">"Division by zero error occurred during calculation. Check the input values"</span><span class="token punctuation">,</span>
        exc_info<span class="token operator">=</span>e<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">"Application crashed due to an unhandled exception"</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/62/1d/dJ4PkjqM_o.png" alt="在这里插入图片描述"></p> 
<p>Structlog 日志记录器的默认配置对开发环境非常友好。输出是彩色的，任何包含的上下文数据都以 <code>key=value</code> 对的形式出现。此外，tracebacks的格式和organized都很整齐，因此更容易发现问题的原因。</p> 
<p>Structlog 的独特之处在于，它不会按levels去过滤记录。这就是为什么上面所有的levels都被写入控制台的原因。不过，通过 <code>configure()</code> 方法配置默认级别也很简单，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> structlog
<span class="token keyword">import</span> logging

structlog<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>wrapper_class<span class="token operator">=</span>structlog<span class="token punctuation">.</span>make_filtering_bound_logger<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>Structlog 与标准<code>logging</code>模块中的日志级别兼容，因此可以使用上述 <code>logging.INFO</code> 常量。你也可以直接使用与级别相关的数字：</p> 
<pre><code class="prism language-python">structlog<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>wrapper_class<span class="token operator">=</span>structlog<span class="token punctuation">.</span>make_filtering_bound_logger<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>get_logger()</code>函数返回的日志记录器称为绑定日志记录器，因为您可以将上下文值与之绑定。一旦绑定了key/value pairs，它们将包含在日志记录器生成的每个后续日志条目中。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> structlog
<span class="token keyword">import</span> platform

logger <span class="token operator">=</span> structlog<span class="token punctuation">.</span>get_logger<span class="token punctuation">(</span><span class="token punctuation">)</span>

logger <span class="token operator">=</span> logger<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>python_version<span class="token operator">=</span>platform<span class="token punctuation">.</span>python_version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">"linux"</span><span class="token punctuation">)</span>

<span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
</code></pre> 
<pre><code>2023-07-23 17:20:10 [debug] Database query executed in 0.025 seconds os=linux python_version=3.11.4

2023-07-23 17:20:10 [info] Processing file 'data.csv' completed. 1000 records were imported elapsed_ms=300 file=data.csv num_records=1000 os=linux python_version=3.11.4
</code></pre> 
<p>绑定日志记录器还包括一系列<a href="https://www.structlog.org/en/stable/processors.html" rel="nofollow">处理器函数</a>，可在日志记录通过日志记录管道时对日志记录进行转换和丰富。例如，您可以使用以下配置以 JSON 格式记录日志：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> structlog
<span class="token keyword">import</span> platform

structlog<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>
    processors<span class="token operator">=</span><span class="token punctuation">[</span>
        structlog<span class="token punctuation">.</span>processors<span class="token punctuation">.</span>TimeStamper<span class="token punctuation">(</span>fmt<span class="token operator">=</span><span class="token string">"iso"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        structlog<span class="token punctuation">.</span>processors<span class="token punctuation">.</span>add_log_level<span class="token punctuation">,</span>
        structlog<span class="token punctuation">.</span>processors<span class="token punctuation">.</span>JSONRenderer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>

<span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
</code></pre> 
<p>每个处理器都按照声明顺序执行，因此首先调用 <code>TimeStamper()</code> 为每个条目添加 ISO-8601 格式的时间戳，然后通过 <code>add_log_level</code> 添加严重级别，最后调用 <code>JSONRenderer()</code> 将整个记录序列化为 JSON 格式。对程序进行高亮显示的修改后，您将看到以下输出：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"python_version"</span><span class="token operator">:</span> <span class="token string">"3.11.4"</span><span class="token punctuation">,</span> <span class="token string-property property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span> <span class="token string-property property">"event"</span><span class="token operator">:</span> <span class="token string">"Database query executed in 0.025 seconds"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2023-07-23T15:32:21.590688Z"</span><span class="token punctuation">,</span> <span class="token string-property property">"level"</span><span class="token operator">:</span> <span class="token string">"debug"</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token string-property property">"python_version"</span><span class="token operator">:</span> <span class="token string">"3.11.4"</span><span class="token punctuation">,</span> <span class="token string-property property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span> <span class="token string-property property">"file"</span><span class="token operator">:</span> <span class="token string">"data.csv"</span><span class="token punctuation">,</span> <span class="token string-property property">"elapsed_ms"</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token string-property property">"num_records"</span><span class="token operator">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string-property property">"event"</span><span class="token operator">:</span> <span class="token string">"Processing file 'data.csv' completed. 1000 records were imported"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2023-07-23T15:32:21.590720Z"</span><span class="token punctuation">,</span> <span class="token string-property property">"level"</span><span class="token operator">:</span> <span class="token string">"info"</span><span class="token punctuation">}</span>
</code></pre> 
<p>Structlog 能做的另一件很酷的事情是自动格式化tracebacks，使其也以 JSON 格式序列化。你只需要像这样使用 <code>dict_tracebacks</code> 处理器：</p> 
<pre><code class="prism language-python">structlog<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>
    processors<span class="token operator">=</span><span class="token punctuation">[</span>
        structlog<span class="token punctuation">.</span>processors<span class="token punctuation">.</span>TimeStamper<span class="token punctuation">(</span>fmt<span class="token operator">=</span><span class="token string">"iso"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        structlog<span class="token punctuation">.</span>processors<span class="token punctuation">.</span>add_log_level<span class="token punctuation">,</span>
        structlog<span class="token punctuation">.</span>processors<span class="token punctuation">.</span>dict_tracebacks<span class="token punctuation">,</span>
        structlog<span class="token punctuation">.</span>processors<span class="token punctuation">.</span>JSONRenderer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>每当记录异常情况时，你会发现记录中的异常情况信息格式非常丰富，便于在日志管理服务中进行分析。</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"python_version"</span><span class="token operator">:</span> <span class="token string">"3.11.4"</span><span class="token punctuation">,</span> <span class="token string-property property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span> <span class="token string-property property">"event"</span><span class="token operator">:</span> <span class="token string">"Division by zero error occurred during calculation. Check the input values"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2023-07-23T16:07:50.127241Z"</span><span class="token punctuation">,</span> <span class="token string-property property">"level"</span><span class="token operator">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string-property property">"exception"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"exc_type"</span><span class="token operator">:</span> <span class="token string">"ZeroDivisionError"</span><span class="token punctuation">,</span> <span class="token string-property property">"exc_value"</span><span class="token operator">:</span> <span class="token string">"division by zero"</span><span class="token punctuation">,</span> <span class="token string-property property">"syntax_error"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string-property property">"is_cause"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string-property property">"frames"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string-property property">"filename"</span><span class="token operator">:</span> <span class="token string">"/home/ayo/dev/betterstack/demo/python-logging/main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"lineno"</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"&lt;module&gt;"</span><span class="token punctuation">,</span> <span class="token string-property property">"line"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string-property property">"locals"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token string-property property">"__name__"</span><span class="token operator">:</span> <span class="token string">"__main__"</span><span class="token punctuation">,</span> <span class="token string-property property">"__doc__"</span><span class="token operator">:</span> <span class="token string">"None"</span><span class="token punctuation">,</span> <span class="token string-property property">"__package__"</span><span class="token operator">:</span> <span class="token string">"None"</span><span class="token punctuation">,</span> <span class="token string-property property">"__loader__"</span><span class="token operator">:</span> <span class="token string">"&lt;_frozen_importlib_external.SourceFileLoader object at 0x7fdb22df2ed0&gt;"</span><span class="token punctuation">,</span> <span class="token string-property property">"__spec__"</span><span class="token operator">:</span> <span class="token string">"None"</span><span class="token punctuation">,</span> <span class="token string-property property">"__annotations__"</span><span class="token operator">:</span> <span class="token string">"{}"</span><span class="token punctuation">,</span> <span class="token string-property property">"__builtins__"</span><span class="token operator">:</span> <span class="token string">"&lt;module 'builtins' (built-in)&gt;"</span><span class="token punctuation">,</span> <span class="token string-property property">"__file__"</span><span class="token operator">:</span> <span class="token string">"/home/ayo/dev/betterstack/demo/python-logging/main.py"</span><span class="token punctuation">,</span> <span class="token string-property property">"__cached__"</span><span class="token operator">:</span> <span class="token string">"None"</span><span class="token punctuation">,</span> <span class="token string-property property">"structlog"</span><span class="token operator">:</span> <span class="token string">"\"&lt;module 'structlog' from '/home/ayo/.local/lib/python3.11/site-packages/structlo\"+15"</span><span class="token punctuation">,</span> <span class="token string-property property">"platform"</span><span class="token operator">:</span> <span class="token string">"&lt;module 'platform' from '/usr/lib64/python3.11/platform.py'&gt;"</span><span class="token punctuation">,</span> <span class="token string-property property">"logging"</span><span class="token operator">:</span> <span class="token string">"&lt;module 'logging' from '/usr/lib64/python3.11/logging/__init__.py'&gt;"</span><span class="token punctuation">,</span> <span class="token string-property property">"logger"</span><span class="token operator">:</span> <span class="token string">"\"&lt;BoundLoggerFilteringAtDebug(context={'python_version': '3.11.4', 'os': 'linux'}\"+249"</span><span class="token punctuation">,</span> <span class="token string-property property">"e"</span><span class="token operator">:</span> <span class="token string">"ZeroDivisionError('division by zero')"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre> 
<p>这里只介绍了 Structlog 所提供的常用功能，因此请务必查看其<a href="https://www.structlog.org/en/stable/" rel="nofollow">文档</a>以了解更多信息。</p> 
<h3><a id="4_Eliot_441"></a>4. Eliot</h3> 
<p><a href="https://github.com/itamarst/eliot">Eliot</a> 是一种独特的 Python 日志解决方案，它不仅能记录程序中发生的事件，还能输出导致事件发生的行为因果链。使用 pip 安装 Eliot 的方法如下：</p> 
<pre><code class="prism language-bash">$ pip <span class="token function">install</span> eliot
</code></pre> 
<p>Eliot 的一个关键概念是 “动作”（action），它代表任何可以开始并成功完成或因异常而失败的任务。当你启动一个动作时，会产生两条日志记录：一条用来表示action的开始，另一条用来表示action的成功或失败。演示此模型的最佳方式是举例说明：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">from</span> eliot <span class="token keyword">import</span> start_action<span class="token punctuation">,</span> to_file

to_file<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">calculate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> start_action<span class="token punctuation">(</span>action_type<span class="token operator">=</span><span class="token string">"multiply"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y


calculate<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里使用<code>start_action</code>函数来表示一个新action的开始。一旦执行<code>calculate()</code>函数，两个日志就会被发送到<code>to_file()</code>配置的目的地：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"action_status"</span><span class="token operator">:</span> <span class="token string">"started"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1690213156.7701144</span><span class="token punctuation">,</span> <span class="token string-property property">"task_uuid"</span><span class="token operator">:</span> <span class="token string">"a9a47808-15a9-439b-8335-b88d50013f75"</span><span class="token punctuation">,</span> <span class="token string-property property">"action_type"</span><span class="token operator">:</span> <span class="token string">"multiply"</span><span class="token punctuation">,</span> <span class="token string-property property">"task_level"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token string-property property">"action_status"</span><span class="token operator">:</span> <span class="token string">"succeeded"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1690213156.7701554</span><span class="token punctuation">,</span> <span class="token string-property property">"task_uuid"</span><span class="token operator">:</span> <span class="token string">"a9a47808-15a9-439b-8335-b88d50013f75"</span><span class="token punctuation">,</span> <span class="token string-property property">"action_type"</span><span class="token operator">:</span> <span class="token string">"multiply"</span><span class="token punctuation">,</span> <span class="token string-property property">"task_level"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre> 
<p>Eliot 默认生成结构化的 JSON 输出，其中包括以下记录：</p> 
<ul><li><code>task_uuid</code>: 生成消息的唯一任务标识符。</li><li><code>action_status</code>: 表示action的状态。</li><li><code>timestamp</code>: 信息的 UNIX 时间戳。</li><li><code>task_level</code>: 信息在actions树中的位置。</li><li><code>action_type</code>: 提供的 <code>action_type</code> 参数。</li></ul> 
<p>您可以向action的开始消息和成功消息添加其他字段，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">calculate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># additional fields here are added to the start message of the action alone</span>
    <span class="token keyword">with</span> start_action<span class="token punctuation">(</span>action_type<span class="token operator">=</span><span class="token string">"multiply"</span><span class="token punctuation">,</span> x<span class="token operator">=</span>x<span class="token punctuation">,</span> y<span class="token operator">=</span>y<span class="token punctuation">)</span> <span class="token keyword">as</span> action<span class="token punctuation">:</span>
        result <span class="token operator">=</span> x <span class="token operator">*</span> y
        <span class="token comment"># fields added here show up only in the success message of the action</span>
        action<span class="token punctuation">.</span>add_success_fields<span class="token punctuation">(</span>result<span class="token operator">=</span>result<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result
</code></pre> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"x"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string-property property">"y"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string-property property">"action_status"</span><span class="token operator">:</span> <span class="token string">"started"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1690213820.4083755</span><span class="token punctuation">,</span> <span class="token string-property property">"task_uuid"</span><span class="token operator">:</span> <span class="token string">"09df3632-96d2-4dd8-b782-1926cd87ccc9"</span><span class="token punctuation">,</span> <span class="token string-property property">"action_type"</span><span class="token operator">:</span> <span class="token string">"multiply"</span><span class="token punctuation">,</span> <span class="token string-property property">"task_level"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token string-property property">"result"</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token string-property property">"action_status"</span><span class="token operator">:</span> <span class="token string">"succeeded"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1690213820.4084144</span><span class="token punctuation">,</span> <span class="token string-property property">"task_uuid"</span><span class="token operator">:</span> <span class="token string">"09df3632-96d2-4dd8-b782-1926cd87ccc9"</span><span class="token punctuation">,</span> <span class="token string-property property">"action_type"</span><span class="token operator">:</span> <span class="token string">"multiply"</span><span class="token punctuation">,</span> <span class="token string-property property">"task_level"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre> 
<p>另一种记录函数的输入和结果的方法是通过<code>log_call</code>装饰器：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> eliot <span class="token keyword">import</span> log_call<span class="token punctuation">,</span> to_file

to_file<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@log_call</span>
<span class="token keyword">def</span> <span class="token function">calculate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x <span class="token operator">*</span> y

calculate<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre> 
<p>在这种情况下，<code>action_type</code> 将是模块和函数名称的连接，但其余字段将与之前相同：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"x"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string-property property">"y"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string-property property">"action_status"</span><span class="token operator">:</span> <span class="token string">"started"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1690214038.799868</span><span class="token punctuation">,</span> <span class="token string-property property">"task_uuid"</span><span class="token operator">:</span> <span class="token string">"2c78b304-12a1-474a-8b95-e80deadb8dde"</span><span class="token punctuation">,</span> <span class="token string-property property">"action_type"</span><span class="token operator">:</span> <span class="token string">"__main__.calculate"</span><span class="token punctuation">,</span> <span class="token string-property property">"task_level"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token string-property property">"result"</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token string-property property">"action_status"</span><span class="token operator">:</span> <span class="token string">"succeeded"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1690214038.7999015</span><span class="token punctuation">,</span> <span class="token string-property property">"task_uuid"</span><span class="token operator">:</span> <span class="token string">"2c78b304-12a1-474a-8b95-e80deadb8dde"</span><span class="token punctuation">,</span> <span class="token string-property property">"action_type"</span><span class="token operator">:</span> <span class="token string">"__main__.calculate"</span><span class="token punctuation">,</span> <span class="token string-property property">"task_level"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre> 
<p>您可以通过更改 <code>action_type</code> 字段并排除某些参数或结果来自定义<code> log_call</code> 装饰器的行为：</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@log_call</span><span class="token punctuation">(</span>action_type<span class="token operator">=</span><span class="token string">"CALC"</span><span class="token punctuation">,</span> include_args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"x"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> include_result<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果在某个action的上下文中检测到uncaught exception，该操作将被标记为失败，并将记录一条异常消息，而不是成功消息：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">from</span> eliot <span class="token keyword">import</span> log_call<span class="token punctuation">,</span> to_file

to_file<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@log_call</span>
<span class="token keyword">def</span> <span class="token function">calculate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> x <span class="token operator">/</span> y

<span class="token keyword">try</span><span class="token punctuation">:</span>
    calculate<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> ZeroDivisionError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"division by zero detected"</span><span class="token punctuation">)</span>
</code></pre> 
<p>您现在看到的不是成功信息，而是一条<code>exception</code>信息，并附有<code>reason</code>：</p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"x"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">"y"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string-property property">"action_status"</span><span class="token operator">:</span> <span class="token string">"started"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1690215830.1103916</span><span class="token punctuation">,</span> <span class="token string-property property">"task_uuid"</span><span class="token operator">:</span> <span class="token string">"f267b0f5-8c07-4828-a973-0a8a273f272d"</span><span class="token punctuation">,</span> <span class="token string-property property">"action_type"</span><span class="token operator">:</span> <span class="token string">"__main__.calculate"</span><span class="token punctuation">,</span> <span class="token string-property property">"task_level"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

<span class="token punctuation">{<!-- --></span><span class="token string-property property">"exception"</span><span class="token operator">:</span> <span class="token string">"builtins.ZeroDivisionError"</span><span class="token punctuation">,</span> <span class="token string-property property">"reason"</span><span class="token operator">:</span> <span class="token string">"division by zero"</span><span class="token punctuation">,</span> <span class="token string-property property">"action_status"</span><span class="token operator">:</span> <span class="token string">"failed"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1690215830.1104264</span><span class="token punctuation">,</span> <span class="token string-property property">"task_uuid"</span><span class="token operator">:</span> <span class="token string">"f267b0f5-8c07-4828-a973-0a8a273f272d"</span><span class="token punctuation">,</span> <span class="token string-property property">"action_type"</span><span class="token operator">:</span> <span class="token string">"__main__.calculate"</span><span class="token punctuation">,</span> <span class="token string-property property">"task_level"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre> 
<p>当您需要在action的上下文中记录独立的消息时，可以使用<code>log</code>方法，如下所示：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">calculate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> start_action<span class="token punctuation">(</span>action_type<span class="token operator">=</span><span class="token string">"multiply"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ctx<span class="token punctuation">:</span>
        ctx<span class="token punctuation">.</span>log<span class="token punctuation">(</span>message_type<span class="token operator">=</span><span class="token string">"mymsg"</span><span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token string">"a standalone message"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
</code></pre> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"msg"</span><span class="token operator">:</span> <span class="token string">"a standalone message"</span><span class="token punctuation">,</span> <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token number">1690217318.2063951</span><span class="token punctuation">,</span> <span class="token string-property property">"task_uuid"</span><span class="token operator">:</span> <span class="token string">"500b06e6-c0ba-42b4-9d6c-466ea3f1634d"</span><span class="token punctuation">,</span> <span class="token string-property property">"task_level"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string-property property">"message_type"</span><span class="token operator">:</span> <span class="token string">"mymsg"</span><span class="token punctuation">}</span>
</code></pre> 
<p>Eliot没有 log levels 的概念，因此只能在需要时手动添加level字段：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">calculate</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> start_action<span class="token punctuation">(</span>action_type<span class="token operator">=</span><span class="token string">"multiply"</span><span class="token punctuation">,</span> level<span class="token operator">=</span><span class="token string">"INFO"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ctx<span class="token punctuation">:</span>
        ctx<span class="token punctuation">.</span>log<span class="token punctuation">(</span>message_type<span class="token operator">=</span><span class="token string">"mymsg"</span><span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token string">"a standalone message"</span><span class="token punctuation">,</span> level<span class="token operator">=</span><span class="token string">"INFO"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x <span class="token operator">*</span> y
</code></pre> 
<p>Eliot 的另一项出色功能是通过 <code>eliot-tree</code> 命令行工具实现日志可视化。</p> 
<pre><code class="prism language-bash">$ pip <span class="token function">install</span> eliot-tree
</code></pre> 
<p>安装 <code>eliot -tree</code> 后，您可以将 Eliot 生成的 JSON 日志通过管道传输到命令，如下所示：</p> 
<pre><code class="prism language-bash">$ python main.py <span class="token operator">|</span> eliot-tree
</code></pre> 
<p><img src="https://images2.imgbox.com/03/f4/Iv9C4Kzg_o.png" alt="在这里插入图片描述"></p> 
<p>如果你将日志记录到文件，可以将这个文件作为参数传递给工具：</p> 
<pre><code class="prism language-bash">$ eliot-tree <span class="token operator">&lt;</span>file<span class="token operator">&gt;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f2/68/wp5oFvLG_o.png" alt="在这里插入图片描述"></p> 
<p>Eliot的内容远不止于此，因此请务必查看其<a href="https://eliot.readthedocs.io/en/stable/quickstart.html" rel="nofollow">文档</a>以了解更多信息。</p> 
<h3><a id="5_Logbook_604"></a>5. Logbook</h3> 
<p><a href="https://logbook.readthedocs.io/en/stable/" rel="nofollow">Logbook</a> 自称是 Python 标准库<code>logging</code>模块的酷炫替代品，其目的是让日志记录变得有趣。你可以使用以下命令将其安装到你的项目中：</p> 
<pre><code class="prism language-bash">$ pip <span class="token function">install</span> logbook
</code></pre> 
<p>开始使用 Logbook 也非常简单：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> logbook

logger <span class="token operator">=</span> logbook<span class="token punctuation">.</span>Logger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

handler <span class="token operator">=</span> logbook<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span> level<span class="token operator">=</span><span class="token string">"INFO"</span><span class="token punctuation">)</span>
handler<span class="token punctuation">.</span>push_application<span class="token punctuation">(</span><span class="token punctuation">)</span>

logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Successfully connected to the database 'my_db' on host 'ubuntu'"</span><span class="token punctuation">)</span>

logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"Detected suspicious activity from IP address: 111.222.333.444"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-ini">[2023-07-24 21:41:50.932575] INFO: __main__: Successfully connected to the database 'my_db' on host 'ubuntu'

[2023-07-24 21:41:50.932623] WARNING: __main__: Detected suspicious activity from IP address: 111.222.333.444
</code></pre> 
<p>如上图所示，<code>logbook.Logger</code> 方法用于创建一个新的 <code>logger</code> channel。该 logger provides 提供了对 <code>info()</code> 和 <code>warning()</code> 等级别方法的访问，用于写入日志信息。支持<code>logging</code>模块中的所有日志levels，并增加了介于 <code>INFO</code> 和 <code>WARNING</code> 之间的 <code>NOTICE</code> 级别。</p> 
<p>Logbook 还使用<code>Handler</code>概念来确定日志的目的地和<a href="https://betterstack.com/community/guides/logging/log-formatting/" rel="nofollow">格式</a>。<code>StreamHandler</code> 类可将日志发送到任何输出流（本例中为标准output），其他处理程序可将日志发送到文件、Syslog、Redis、Slack 等。</p> 
<p>不过，与标准<code>logging</code>模块不同的是，我们不鼓励你直接在日志记录器上注册handlers。相反，你应该分别通过 <code>push_application()</code>、<code>push_thread()</code> 和 <code>push_greenlet()</code> 方法将处理程序绑定到process、thread或 greenlet stack中。相应的 <code>pop_application()</code>、<code>pop_thread()</code> 和 <code>pop_greenlet()</code> 方法用于取消处理程序的注册：</p> 
<pre><code class="prism language-python">handler <span class="token operator">=</span> MyHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
handler<span class="token punctuation">.</span>push_application<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># everything logged here here goes to that handler</span>
handler<span class="token punctuation">.</span>pop_application<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>您还可以在 with-block 的持续时间内绑定一个handler。这样可以确保在块内创建的日志只发送给指定的handler：</p> 
<pre><code class="prism language-python"><span class="token keyword">with</span> handler<span class="token punctuation">.</span>applicationbound<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> handler<span class="token punctuation">.</span>threadbound<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> handler<span class="token punctuation">.</span>greenletbound<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</code></pre> 
<p>日志格式化也是通过handlers完成的。为此，每个处理程序都有一个 <code>format_string</code> 属性，它接受 <a href="https://logbook.readthedocs.io/en/stable/api/base.html#logbook.LogRecord" rel="nofollow">LogRecord</a> 类的属性：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> logbook

logger <span class="token operator">=</span> logbook<span class="token punctuation">.</span>Logger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

handler <span class="token operator">=</span> logbook<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span> level<span class="token operator">=</span><span class="token string">"INFO"</span><span class="token punctuation">)</span>
handler<span class="token punctuation">.</span>format_string <span class="token operator">=</span> <span class="token string">"{record.channel} | {record.level_name} | {record.message}"</span>
handler<span class="token punctuation">.</span>push_application<span class="token punctuation">(</span><span class="token punctuation">)</span>

logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"Successfully connected to the database 'my_db' on host 'ubuntu'"</span><span class="token punctuation">)</span>

logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"Detected suspicious activity from IP address: 111.222.333.444"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>__main__ | INFO | Successfully connected to the database 'my_db' on host 'ubuntu'
__main__ | WARNING | Detected suspicious activity from IP address: 111.222.333.444
</code></pre> 
<p>遗憾的是，Logbook 的任何内置处理程序都<a href="https://github.com/getlogbook/logbook/issues/279r">不支持结构化日志记录</a>。您必须通过自定义处理程序自行实现。有关详细信息，请参阅 <a href="https://logbook.readthedocs.io/en/stable/index.html" rel="nofollow">Logbook 文档</a>。</p> 
<h3><a id="6_Picologging_686"></a>6. Picologging</h3> 
<p><a href="https://github.com/microsoft/picologging">Mirosoft 的 Picologging</a> 库是 Python 日志生态系统的一个相对较新的补充。如其 GitHub Readme 所述，它被定位为标准日志模块的高性能直接替代品，速度可显著提高 4-10 倍。要将其集成到你的项目中，你可以用以下命令安装它：</p> 
<pre><code class="prism language-bash">$ pip <span class="token function">install</span> picologging
</code></pre> 
<p>Picologging 与 Python 中的<code>logging</code>模块共享相同的熟悉的 API，并且使用相同的日志记录属性进行格式化：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> sys
<span class="token keyword">import</span> picologging <span class="token keyword">as</span> logging

logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

stdout_handler <span class="token operator">=</span> logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span>
fmt <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span>
    <span class="token string">"%(name)s: %(asctime)s | %(levelname)s | %(process)d &gt;&gt;&gt; %(message)s"</span>
<span class="token punctuation">)</span>

stdout_handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>fmt<span class="token punctuation">)</span>
logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>stdout_handler<span class="token punctuation">)</span>

logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
    <span class="token string">"Successfully connected to the database '%s' on host '%s'"</span><span class="token punctuation">,</span> <span class="token string">"my_db"</span><span class="token punctuation">,</span> <span class="token string">"ubuntu20.04"</span>
<span class="token punctuation">)</span>

logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">"Detected suspicious activity from IP address: %s"</span><span class="token punctuation">,</span> <span class="token string">"111.222.333.444"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-ini">__main__: 2023-07-24 05:46:38,-2046715687 | INFO | 795975 &gt;&gt;&gt; Successfully connected to the database 'my_db' on host 'ubuntu20.04'
__main__: 2023-07-24 05:46:38,-2046715687 | WARNING | 795975 &gt;&gt;&gt; Detected suspicious activity from IP address: 111.222.333.444
</code></pre> 
<p>Picologging 的文档强调，它目前还处于早期开发阶段，因此应暂缓在生产中使用。不过，根据这些<a href="https://github.com/microsoft/picologging#benchmarks">benchmarks</a>，Picologging 在提高标准日志模块的性能方面已经显示出了一定的前景。有关其功能和限制的更多信息，请参阅<a href="https://microsoft.github.io/picologging/index.html" rel="nofollow">文档</a>。</p> 
<h3><a id="_727"></a>最后的想法</h3> 
<p>在 Python 中使用日志记录时，我们的主要推荐是使用 Loguru，因为它具有令人印象深刻的功能和用户友好的 API。不过，熟悉built-in <code>logging</code> 模块也很重要，因为它仍然是一个功能强大、使用广泛的解决方案。</p> 
<p>Structlog 是另一个值得考虑的强大选项，Eliot 也可能是一个不错的选择，只要它缺乏日志级别并不是您的用例的主要问题。另一方面，Picologging 目前还处于早期开发阶段，而 Logbook 缺乏对结构化日志记录的原生支持，因此不太适合在生产环境中进行日志记录。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/42c932f75cd830b01c4c160514b1db11/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">支持向量机(SVM)的回归拟合(matlab实现)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d736e64c6c168eaa201d69b7515dfa13/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43; 哈希的应用【布隆过滤器】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>