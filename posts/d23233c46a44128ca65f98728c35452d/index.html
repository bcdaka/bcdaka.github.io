<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【进阶】Stable Diffusion 插件 Controlnet 安装使用教程（图像精准控制） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/d23233c46a44128ca65f98728c35452d/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【进阶】Stable Diffusion 插件 Controlnet 安装使用教程（图像精准控制）">
  <meta property="og:description" content="Stable Diffusion WebUI 的绘画插件 Controlnet 最近更新了 V1.1 版本，发布了 14 个优化模型，并新增了多个预处理器，让它的功能比之前更加好用了，最近几天又连续更新了 3 个新 Reference 预处理器，可以直接根据图像生产风格类似的变体。
使用 Reference only 预处理器生成一张图片的多个变体
因为 Controlnet 在更新时涉及到多个网页里的不同的资源，这里帮大家梳理一下更新 V1.1 所需要的各种资源，以及如何有效的安装 Controlnet 插件。如果你还没有安装 Stable Diffusion WebUI，可以阅读下面这篇文章，了解安装 WebUI 需要的电脑配置，以及下载相关的一键安装包。
一、安装 Controlnet 插件
Controlnet 插件安装网址：https://github.com/Mikubill/sd-webui-controlnet
①打开 WebUI，点击“扩展”选项卡，选择“从网址安装”，复制（https://github.com/Mikubill/sd-webui-controlnet.git ），粘贴在第一行的“拓展的 git 仓库网址”中。点击“安装”按钮，等待十几秒后，在下方看到一行小字“Installed into stable-diffusion-webui\extensions\sd-webui-controlnet. Use Installed tab to restart”，表示安装成功。
（从网址安装可以保证插件的更新能在 WebUI 中自动显示，如果是下载压缩包文件放进根目录，就无法自动更新）
②点击左侧的“已安装”选项卡，单击“检查更新”，等待进度条完成；然后单击“应用并重新启动 UI”；最后完全关闭 WebUI 程序，重新启动进入（也可以重启电脑），我们就可以在 WebUI 主界面中下方看到 Controlnet 的选项。
③如果安装后 Controlnet 界面只有一个选项卡，你可以点击“设置”界面，找到 Controlnet，将 Multi Controlnet 中设置你想要的值，点击保存设置并重启 WebUI。
④此时我们可以打开 WebUI 所在的文件夹，进入 Controlnet 的根目录，具体路径为 C:\Stable Diffusion\novelai-webui-aki-v3\extensions\sd-webui-controlnet，打开 models 文件夹，里面有 38 个尾缀为.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-29T11:01:25+08:00">
    <meta property="article:modified_time" content="2024-06-29T11:01:25+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【进阶】Stable Diffusion 插件 Controlnet 安装使用教程（图像精准控制）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>Stable Diffusion WebUI 的绘画插件 Controlnet 最近更新了 V1.1 版本，发布了 14 个优化模型，并新增了多个预处理器，让它的功能比之前更加好用了，最近几天又连续更新了 3 个新 Reference 预处理器，可以直接根据图像生产风格类似的变体。</p> 
<p><img src="https://images2.imgbox.com/ee/1e/UcjhuEmo_o.jpg" alt=""></p> 
<p>使用 Reference only 预处理器生成一张图片的多个变体</p> 
<p>因为 Controlnet 在更新时涉及到多个网页里的不同的资源，这里帮大家梳理一下更新 V1.1 所需要的各种资源，以及如何有效的安装 Controlnet 插件。如果你还没有安装 Stable Diffusion WebUI，可以阅读下面这篇文章，了解安装 WebUI 需要的电脑配置，以及下载相关的一键安装包。</p> 
<p>一、安装 Controlnet 插件</p> 
<p>Controlnet 插件安装网址：https://github.com/Mikubill/sd-webui-controlnet</p> 
<p>①打开 WebUI，点击“扩展”选项卡，选择“从网址安装”，复制（https://github.com/Mikubill/sd-webui-controlnet.git ），粘贴在第一行的“拓展的 git 仓库网址”中。点击“安装”按钮，等待十几秒后，在下方看到一行小字“Installed into stable-diffusion-webui\extensions\sd-webui-controlnet. Use Installed tab to restart”，表示安装成功。</p> 
<p>（从网址安装可以保证插件的更新能在 WebUI 中自动显示，如果是下载压缩包文件放进根目录，就无法自动更新）</p> 
<p><img src="https://images2.imgbox.com/e2/38/mqe4r27O_o.jpg" alt=""></p> 
<p>②点击左侧的“已安装”选项卡，单击“检查更新”，等待进度条完成；然后单击“应用并重新启动 UI”；最后完全关闭 WebUI 程序，重新启动进入（也可以重启电脑），我们就可以在 WebUI 主界面中下方看到 Controlnet 的选项。</p> 
<p><img src="https://images2.imgbox.com/5e/1f/AVIdwm5s_o.jpg" alt=""></p> 
<p>③如果安装后 Controlnet 界面只有一个选项卡，你可以点击“设置”界面，找到 Controlnet，将 Multi Controlnet 中设置你想要的值，点击保存设置并重启 WebUI。</p> 
<p><img src="https://images2.imgbox.com/46/4f/LkjqtpHf_o.jpg" alt=""></p> 
<p>④此时我们可以打开 WebUI 所在的文件夹，进入 Controlnet 的根目录，具体路径为 C:\Stable Diffusion\novelai-webui-aki-v3\extensions\sd-webui-controlnet，打开 models 文件夹，里面有 38 个尾缀为.yaml 的文件，最新的 Reference 系列也在其中；再点开 WebUI 中 Controlnet 中的预处理器（preprocessors）列表，会发现二者的内容完全一致。因为 yaml 文件就是预处理器文件，它们规定 Controlnet 提取图像的那些特征。</p> 
<p><img src="https://images2.imgbox.com/a2/b6/ZmALOCNF_o.jpg" alt=""></p> 
<p>到这一步我们已经成功安装了 Controlnet 插件，以及提取预处理器所需要的 .yaml 文件，下一步就是安装模型（models），模型的文件尾缀为 pth，它的作用是将图像特征执行到我们的图像生成过程中，Controlnet V1.1 的模型需要我们到 Huggingface 中去下载。</p> 
<p>二、安装 V1.1 新模型</p> 
<p>Controlnet V1.1 模型下载：https://huggingface.co/lllyasviel/ControlNet-v1-1/tree/main（文末有安装包）</p> 
<p>在这个 Huggingface 页面中，我们只需要下载全部 14 个.pth 尾缀的模型文件，下载方式为点击“文件大小”右侧的下载小箭头。下载完成后，将 14 个文件放入 .yaml 所在的文件夹，即 C:\Stable Diffusion\novelai-webui-aki-v3\extensions\sd-webui-controlnet\models。</p> 
<p><img src="https://images2.imgbox.com/aa/3e/a269mvk2_o.jpg" alt=""></p> 
<p>三、安装 T21 模型</p> 
<p>T2I- Adapter 模型下载 ：https://huggingface.co/TencentARC/T2I-Adapter/tree/main/models（文末的链接里有 T2I- Adapter 的 Color、Style 模型）</p> 
<p>T2I- Adapter 详细介绍：https://github.com/TencentARC/T2I-Adapter</p> 
<p>ControlNet V1.1 支持目前所有可用的模型和预处理器，包括 T2I- Adapter 模型。T2I- Adapter 模型由 TencentARC 研发，和 ControlNet 的模型作用类似，都是可以精准控制图像生成效果，T2I- Adapter 的模型可在 ControlNet 中使用，而且二者模型功能有重合。</p> 
<p>ControlNet 插件的自带 T2I- Adapter 的 Color、Sketch 和 style 预处理器，为 sd14 版本 ，所以我们可以只下载 Color 和 Style 对应的模型（Sketch 功能和 softedge 差不多，我就不重复下载了），记得要选择对应的 sd14 的版本，不然模型无法生效。这两个模型我都放进都文末的链接里了。</p> 
<p><img src="https://images2.imgbox.com/d2/72/wLaqAqQj_o.jpg" alt=""></p> 
<p>下载完成后，依旧是放入 Controlnet 根目录的 models 文件夹中，然后在 WebUI 的 Controlnet 中，按“模型”选项右侧蓝色小图标刷新模型，就能看与我们下载的全部 16 个模型了。</p> 
<p><img src="https://images2.imgbox.com/0a/10/yEcWeX7v_o.jpg" alt=""></p> 
<p>四、试用 V1 .1 新功能</p> 
<p>Controlnet V1 .1 更新介绍：https://github.com/lllyasviel/ControlNet-v1-1-nightly</p> 
<p>Controlnet V1 .1 在 V1.0 的基础上对模型进行了优化，并新增了不少新的预处理器，还进一步规范了模型的命名，方便大家识别模型的不同版本和状态，具体见下图：</p> 
<p><img src="https://images2.imgbox.com/48/d1/95WCRkzq_o.jpg" alt=""></p> 
<p>不同模型的作用和使用方法，Controlnet 官方的在相关 Github 界面中都有详细介绍，篇幅所限我就不一一赘述了。我选了 3 个功能做演示，让大家快速熟悉 Controlnet V1.1 的用法。</p> 
<p>1. Reference 预处理器</p> 
<p>Reference 是官方最新推出的预处理器，共有三种型号 Reference_only、Reference_adain 和 Reference_adain+atten。它只有 yam l 配置文件，没有 pth 模型文件，可以根据上传的图像生成类似的变体，来看一下它的具体使用效果。</p> 
<p>① 在 Controlnet 上传一张图片，勾选启用，预处理器选择 Reference_only，其他参数默认。</p> 
<p><img src="https://images2.imgbox.com/bc/4a/UNC7b2Fq_o.jpg" alt=""></p> 
<p>② 选择一个大模型( 因为要生成写实人像，所以我选择写实风模型 RealisticVisionV20），输入提示词“best quality, A handsome man wearing a (white T-Shirt), angry”，步数 25，采样方法 EularA，画面尺寸 512*768px，然后点击生成。</p> 
<p>③ 生成图与原图风格内容类似，但是人物的表情已经在 angry 的作用下发生变化了。我以同样的参数又测试了 Reference_adain 和 Reference_adain+atten，可以看出 only 和 adain+atten 比较贴近原图形象，adain 变化最明显。</p> 
<p><img src="https://images2.imgbox.com/0e/c1/BpvyznmG_o.jpg" alt=""></p> 
<p>④ 使用 Reference 时我们需要了解的一项参数是“Style Fidelity”，意思是风格保真度。</p> 
<p>我用 adain+atten 处理器和固定的种子值，分别生成了 Style Fidelity 为 0/0.5/1 的图像。Style Fidelity 为 0 时，生成图像的色调、人物的衣着、背景与原图差异很明显，人物的表情更符合提示词；Style Fidelity 为 1 时，图像的色调和人物五官和原图非常相似，甚至提示词 angry 已经不起作用的，人物是微笑的。所以 Style Fidelity 数值越高，生成的图像就越像原图。</p> 
<p><img src="https://images2.imgbox.com/76/76/wnohXCP6_o.jpg" alt=""></p> 
<p>Reference 预处理器需要在高于 1.1.171 的更新中使用，官方推荐的两个参数：</p> 
<p>Reference_only / Style Fidelity: 0.5 建议作为默认值，出图效果稳定</p> 
<p>Reference_adain+attn/ Style Fidelity: 1.0 是目前最先进的，值得尝试，但不建议作为默认值</p> 
<p>2. Tile 磁贴</p> 
<p>Tile 模型的作用是可以忽略原图的细节，根据现有像素和提示词生成新的细节，目前主要作用是将严重模糊的图片放大并变得高清。我们以一张 64x64 px 的图片看一下它效果。</p> 
<p>① 在 Controlnet 上传一张图片，勾选启用，预处理器选择 tile_resample，模型选择对应的control_v11f1e_sd15_tile，其他参数默认。</p> 
<p><img src="https://images2.imgbox.com/26/04/s5Pysk2G_o.jpg" alt=""></p> 
<p>② 选择一个大模型( 我用的写实风模型 realisticVisionV20），输入提示词“ best quality, a cute dog on grassland”，步数25，采样方法 EularA，画面尺寸512*512px，生成批次2，固定种子值 12345， 然后点击点击生成，最后得到了2张非常高清的图像，只是细节上有轻微差别。</p> 
<p><img src="https://images2.imgbox.com/1f/c4/0uHMzsRC_o.jpg" alt=""></p> 
<p>③ 我又用几种不同的图像放大工具对 64x64px 的原图进行放大，得到的结果如下：</p> 
<p><img src="https://images2.imgbox.com/29/be/ntFUFQ71_o.jpg" alt=""></p> 
<p>由于 64x64 px 分辨过于低，用一般放大工具的极限放大 4 倍也只有 256*256px；而且原图的像素值太少，所以图像即使变大，看着依旧模糊。而 Tile 模型则可以再有限像素值的基础上，分块扩散画面的内容，最终生成与原图相似且极为清晰的图片。</p> 
<p>Tile 模型还有一个特点：当提示词与给定的图像不符合时，Tile 会忽略提示词的影响，转而自动识别图块内部的内容，并增加识别语义的影响，从而生成与图块相似的图像。</p> 
<p>下图是官方给的一个示例，提示词是““a handsome man”，指定的图块里却是一片树叶，而 Tile 的生成结果也是将树叶放大了，没有在树叶里再加一个帅哥，这说明 Tile 自动识别的图块的内容是“树叶”并进行了处理。</p> 
<p><img src="https://images2.imgbox.com/19/26/AS5RCOTK_o.jpg" alt=""></p> 
<p>三、T2I- Adapter Style</p> 
<p>最后给大家介绍一非常有意思的 T2I- Adapter Style 模型，它可以将一张图片的风格迁移到另一张图片上。我成功用 Style 模型将一张建筑照片转为赛博朋克风的图片，具体操作如下：</p> 
<p>① 在 Controlnet 中点击 Controlnet Unit 0，上传一张 512*768 px 的建筑图片，我们称为主图。勾选启用，预处理器选择 mlsd，并选择对应的 mlsd 模型，以固定图像额主体结构。点击预处理器旁的爆炸小按钮，预览出图效果。</p> 
<p><img src="https://images2.imgbox.com/b9/16/7KgMxyW8_o.jpg" alt=""></p> 
<p>②点开 Controlnet Unit 1, 上传一张 512*768 px 的霓虹光效图片，称为副图。勾选启用，预处理器选择 t2ia_style_clipvision，并选择对应的 style 模型。</p> 
<p><img src="https://images2.imgbox.com/7a/72/wp3C5T6f_o.jpg" alt=""></p> 
<p>③ 选择一个大模型（我用的是 realisticVisionV20），提示词可以不写，步数25，图像尺寸 512*768 px，生成批次2，点击生成。最终效果图如下，霓虹光效的风格已经完美迁移到建筑照片上了。因为使用了 mlsd 模型进行结构控制，原图的建筑结构保留得很完整。</p> 
<p><img src="https://images2.imgbox.com/a3/84/Ocf1ezaB_o.jpg" alt=""></p> 
<p>④我将 Controlnet Unit 1 的霓虹图像换成了一张动漫风格的图像，看看能不能将原图建筑变成二次元风格，结果并不理想（下图二），想了想发现可能是大模型不对 ，于是把写实风的realisticVisionV20 改成了 二次元风的 AnythingV3模型，配对的 VAE模型为 vae-ft-mse-840000-ema-pruned ，效果就好了很多。</p> 
<p><img src="https://images2.imgbox.com/fa/70/46xarcXL_o.jpg" alt=""></p> 
<p>使用 T2I- Adapter Style 模型需要注意：</p> 
<p>接受风格改变的主图放在 Controlnet Unit 0，提供风格的副图放在 Controlnet Unit 1，顺序不能颠倒，不然会影响出图效果。</p> 
<p>主图、副图、最终生成图像的尺寸要保持一致。</p> 
<p>大模型的风格要与副图（提供风格的图片）的风格一致，才能得到最好的效果。</p> 
<p>文章使用的AI绘画SD整合包、各种模型插件、提示词、AI人工智能学习资料都已经打包好放在网盘中了，有需要的小伙伴文末扫码自行获取。</p> 
<h3><a id="_148"></a>写在最后</h3> 
<p>AIGC技术的未来发展前景广阔，随着人工智能技术的不断发展，AIGC技术也将不断提高。未来，AIGC技术将在游戏和计算领域得到更广泛的应用，使游戏和计算系统具有更高效、更智能、更灵活的特性。同时，AIGC技术也将与人工智能技术紧密结合，在更多的领域得到广泛应用，对程序员来说影响至关重要。未来，AIGC技术将继续得到提高，同时也将与人工智能技术紧密结合，在更多的领域得到广泛应用。</p> 
<p><font face="幼圆" size="4" color="red">感兴趣的小伙伴，赠送全套AIGC学习资料和安装工具，包含AI绘画、AI人工智能等前沿科技教程，模型插件，具体看下方。<br> </font><br> <img src="https://images2.imgbox.com/e9/65/qB3SHarh_o.jpg"></p> 
<p><strong>一、AIGC所有方向的学习路线</strong></p> 
<p>AIGC所有方向的技术点做的整理，形成各个领域的知识点汇总，它的用处就在于，你可以按照下面的知识点去找对应的学习资源，保证自己学得较为全面。</p> 
<p><img src="https://images2.imgbox.com/d4/3e/S5CNYm55_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/e5/a1/0q5g6qMX_o.png" alt="在这里插入图片描述"></p> 
<p><strong>二、AIGC必备工具</strong></p> 
<p>工具都帮大家整理好了，安装就可直接上手！<br> <img src="https://images2.imgbox.com/c3/fc/vgTAwpiX_o.png" alt="在这里插入图片描述"></p> 
<p><strong>三、最新AIGC学习笔记</strong></p> 
<p>当我学到一定基础，有自己的理解能力的时候，会去阅读一些前辈整理的书籍或者手写的笔记资料，这些笔记详细记载了他们对一些技术点的理解，这些理解是比较独到，可以学到不一样的思路。<br> <img src="https://images2.imgbox.com/4c/da/SYIxV6HB_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d3/8f/8oyQ53W1_o.png" alt="在这里插入图片描述"></p> 
<p><strong>四、AIGC视频教程合集</strong></p> 
<p>观看全面零基础学习视频，看视频学习是最快捷也是最有效果的方式，跟着视频中老师的思路，从基础到深入，还是很容易入门的。</p> 
<p><img src="https://images2.imgbox.com/a9/7d/ywi6lquh_o.png" alt="在这里插入图片描述"></p> 
<p><strong>五、实战案例</strong></p> 
<p>纸上得来终觉浅，要学会跟着视频一起敲，要动手实操，才能将自己的所学运用到实际当中去，这时候可以搞点实战案例来学习。<br> <img src="https://images2.imgbox.com/de/9c/VlW4i5zl_o.png" alt="在这里插入图片描述"></p> 
<img src="https://images2.imgbox.com/46/55/PQP9hAmh_o.jpg"> 若有侵权，请联系删除
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f0f49a5b507af4852a671f2c1a675b95/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于SpringBoot&#43;Vue&#43;Spark&#43;大数据的在线广告推荐系统设计和实现(源码&#43;LW&#43;部署讲解)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80624ba6f3b31cf94e85574b99b011e4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">阿里云服务器数据库迁云: 数据从传统到云端的安全之旅（WordPress个人博客实战教学）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>