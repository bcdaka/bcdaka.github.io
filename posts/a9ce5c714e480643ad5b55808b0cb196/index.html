<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring Kafka——基于 Spring Kafka 实现动态管理 Kafka 连接和 topic 的监听 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/a9ce5c714e480643ad5b55808b0cb196/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Spring Kafka——基于 Spring Kafka 实现动态管理 Kafka 连接和 topic 的监听">
  <meta property="og:description" content="文章目录 使用 Spring Kafka 动态管理 Kafka 连接和主题监听1. 前言2. 简单的消费程序配置3. Spring Kafka 主要的相关类的说明4. `@KafkaListener` 注解的加载执行流程解析5. 动态监听消费订阅的设计与实现 使用 Spring Kafka 动态管理 Kafka 连接和主题监听 文章内容较长，如果想看样例代码直接跳到 动态监听消费订阅的设计与实现
1. 前言 SpringBoot 项目中我们在使用 Spring Kafka 来消费 Kafka 的消息时通常是在 application.properties(或application.yml) 文件中先定义 Kafka 的集群地址(如 spring.kafka.bootstrap-servers) ，随后，我们通过编写一个组件并在一个方法上添加@KafkaListener注解来实现消息消费。
对于需要监听多个Kafka集群的场景，单纯通过配置文件来设定是不足够的。在这种情况下，我们需要为每个集群分别创建连接，并为每一个设定专门的ConcurrentKafkaListenerContainerFactory。以下是一个示例配置，其中包括了为两个不同的Kafka集群创建各自的消费工厂和监听容器的过程：
// 在 Spring Boot 应用中，你需要创建两个配置类来分别配置这两个集群 @Configuration public class KafkaConfig { @Bean public ConsumerFactory&lt;String, String&gt; consumerFactory1() { Map&lt;String, Object&gt; props = new HashMap&lt;&gt;(); props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, &#34;kafka-cluster1:9092&#34;); props.put(ConsumerConfig.GROUP_ID_CONFIG, &#34;group1&#34;); props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &#34;earliest&#34;); // 添加其他配置项 return new DefaultKafkaConsumerFactory&lt;&gt;(props); } @Bean public ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; kafkaListenerContainerFactory1() { ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; factory = new ConcurrentKafkaListenerContainerFactory&lt;&gt;(); factory.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-25T13:45:34+08:00">
    <meta property="article:modified_time" content="2024-04-25T13:45:34+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring Kafka——基于 Spring Kafka 实现动态管理 Kafka 连接和 topic 的监听</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_Spring_Kafka__Kafka__1" rel="nofollow">使用 Spring Kafka 动态管理 Kafka 连接和主题监听</a></li><li><ul><li><a href="#1__3" rel="nofollow">1. 前言</a></li><li><a href="#2__69" rel="nofollow">2. 简单的消费程序配置</a></li><li><a href="#3_Spring_Kafka__144" rel="nofollow">3. Spring Kafka 主要的相关类的说明</a></li><li><a href="#4_KafkaListener__171" rel="nofollow">4. `@KafkaListener` 注解的加载执行流程解析</a></li><li><a href="#5__746" rel="nofollow">5. 动态监听消费订阅的设计与实现</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_Spring_Kafka__Kafka__1"></a>使用 Spring Kafka 动态管理 Kafka 连接和主题监听</h2> 
<blockquote> 
 <p>文章内容较长，如果想看样例代码直接跳到 <a href="#anchor-point" rel="nofollow">动态监听消费订阅的设计与实现</a></p> 
</blockquote> 
<h3><a id="1__3"></a>1. 前言</h3> 
<p>SpringBoot 项目中我们在使用 Spring Kafka 来消费 Kafka 的消息时通常是在 <code>application.properties</code>(或<code>application.yml</code>) 文件中先定义 Kafka 的集群地址(如 <code>spring.kafka.bootstrap-servers</code>) ，随后，我们通过编写一个组件并在一个方法上添加<code>@KafkaListener</code>注解来实现消息消费。<br> 对于需要监听多个Kafka集群的场景，单纯通过配置文件来设定是不足够的。在这种情况下，我们需要为每个集群分别创建连接，并为每一个设定专门的ConcurrentKafkaListenerContainerFactory。以下是一个示例配置，其中包括了为两个不同的Kafka集群创建各自的消费工厂和监听容器的过程：</p> 
<pre><code class="prism language-java"><span class="token comment">// 在 Spring Boot 应用中，你需要创建两个配置类来分别配置这两个集群</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ConsumerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">consumerFactory1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"kafka-cluster1:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">GROUP_ID_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">AUTO_OFFSET_RESET_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"earliest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加其他配置项</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKafkaConsumerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">kafkaListenerContainerFactory1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setConsumerFactory</span><span class="token punctuation">(</span><span class="token function">consumerFactory1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ConsumerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">consumerFactory2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"kafka-cluster2:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">GROUP_ID_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"group2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">AUTO_OFFSET_RESET_CONFIG</span><span class="token punctuation">,</span> <span class="token string">"earliest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加其他配置项</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKafkaConsumerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">kafkaListenerContainerFactory2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setConsumerFactory</span><span class="token punctuation">(</span><span class="token function">consumerFactory2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ----</span>

<span class="token comment">// 创建 Kafka 监听器来消费来自不同集群的消息</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumers</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">"topic1"</span><span class="token punctuation">,</span> containerFactory <span class="token operator">=</span> <span class="token string">"kafkaListenerContainerFactory1"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenCluster1</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Received from cluster 1: "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">"topic2"</span><span class="token punctuation">,</span> containerFactory <span class="token operator">=</span> <span class="token string">"kafkaListenerContainerFactory2"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenCluster2</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Received from cluster 2: "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>对于更复杂的场景，例如需要连接多个Kafka集群或者动态地控制消息监听程序的启动与停止，这种硬编码方式将不再适用。<br> 在处理这个需求时，我思考了一种方法，即通过在数据库中维护一个表来定义Kafka集群的地址、需要监听的topic以及监听者的配置。通过API接口，我们可以动态地添加或移除监听程序，并控制它们的启动和停止。如果能实现这样的功能，就可以避免重新发布服务，同时还可以通过一个后台管理页面来控制程序监听消费哪个Kafka集群的哪个Topic，并可以动态指定监听消费程序的启动和停止。</p> 
<p>为了实现这样的功能，我们首先需要对Spring Kafka的运行机制以及其中一些主要的类的概念有一定的了解。</p> 
<h3><a id="2__69"></a>2. 简单的消费程序配置</h3> 
<p><em>如果你不是第一次接触 Spring Kafka 的使用，这段内容可以跳过</em><br> 关于 SpringBoot 对 Apache Kafka 的支持，可以参阅<a href="https://docs.spring.io/spring-boot/docs/3.2.5/reference/htmlsingle/#messaging.kafka" rel="nofollow">官方文档</a><br> 下面是大体的流程：</p> 
<ol><li>在 <code>application.yml</code> 进行 kafka 相关的配置，如下所示：<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">consumer</span><span class="token punctuation">:</span>
      <span class="token comment"># 消费者组ID</span>
      <span class="token key atrule">group-id</span><span class="token punctuation">:</span> demo1
      <span class="token comment"># 开启自动提交offset</span>
      <span class="token key atrule">enable-auto-commit</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token comment"># 单次调用poll()操作时能拉取的最大消息数量</span>
      <span class="token key atrule">max-poll-records</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token comment"># 自动提交offset的时间间隔，单位毫秒</span>
      <span class="token key atrule">auto-commit-interval</span><span class="token punctuation">:</span> <span class="token number">5000</span>
      <span class="token comment"># 键的反序列化方式</span>
      <span class="token key atrule">key-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
      <span class="token comment"># 值的反序列化方式</span>
      <span class="token key atrule">value-deserializer</span><span class="token punctuation">:</span> org.apache.kafka.common.serialization.StringDeserializer
      <span class="token comment"># 消费者如何对待Kafka中不存在的offset或null的offset</span>
      <span class="token key atrule">auto-offset-reset</span><span class="token punctuation">:</span> earliest
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token comment"># 消费者并发数，即并发消费线程的数量</span>
      <span class="token key atrule">concurrency</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token comment"># poll()调用时的超时时间，单位毫秒</span>
      <span class="token key atrule">poll-timeout</span><span class="token punctuation">:</span> <span class="token number">1500</span>
    <span class="token comment"># Kafka集群的地址</span>
    <span class="token key atrule">bootstrap-servers</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">9092</span>
</code></pre> 
  <blockquote> 
   <p><strong>Note:</strong><br> <code>spring.kafka.listener.concurrency </code>参数的设置与 Kafka topic 的 partition 数量的关系非常重要，它决定了并发消费消息的能力。这里解释三种情况：并发数大于 partition 数、等于 partition 数、以及小于 partition 数的效果</p> 
   <ol><li><strong>并发数大于 Partition 数</strong>：<br> 当 <code>spring.kafka.listener.concurrency</code> 设置的值大于 topic 的 partition 数量时，由于 Kafka 的每个 partition 只能由一个消费者线程来处理。这意味着实际并发线程的数量仍然受限于 partition 的数量。</li><li><strong>并发数等于 Partition 数</strong>：<br> 这是最理想的配置，每个消费者线程恰好对应一个 partition。这样可以最大化利用所有的 partition，每个 partition 都有一个消费者线程在并发地处理，从而实现最高效的消息处理速度。在这种配置下，消费者的资源被完全利用，没有闲置的消费者线程。</li><li><strong>并发数小于 Partition 数</strong>：<br> 当 <code>spring.kafka.listener.concurrency</code> 的值小于 topic 的 partition 数量时，每个消费者线程可能需要处理多个 partition 的消息。这种情况下，消费者线程的负载会增加，因为它们需要从多个 partition 中拉取并处理消息。这可能会导致处理速度降低，尤其是当消息量较大时，单个消费者线程可能会成为瓶颈。</li></ol> 
   <p>总结而言，设置 <code>spring.kafka.listener.concurrency</code> 时，最佳实践是将其值设置为等于或略高于 partition 的数量，以避免有消费者线程空闲而浪费资源，同时又能保证所有 partition 都有足够的线程进行处理。调整并发度和 partition 数量的比例是优化 Kafka 消费性能的关键步骤。</p> 
  </blockquote> </li><li>编写组件并在消费程序上添加 <code>@KafkaListener</code> 组件，如下所示：<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleConsumer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">"test"</span><span class="token punctuation">,</span> groupId <span class="token operator">=</span> <span class="token string">"consumer01"</span><span class="token punctuation">,</span> batch <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume01</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"consumer01: {}"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">"test"</span><span class="token punctuation">,</span> groupId <span class="token operator">=</span> <span class="token string">"consumer02"</span><span class="token punctuation">,</span> batch <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume02</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"consumer02, count: {}, message: {}"</span><span class="token punctuation">,</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token string">"test"</span><span class="token punctuation">,</span> groupId <span class="token operator">=</span> <span class="token string">"consumer03"</span><span class="token punctuation">,</span> batch <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consume03</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"consumer03, count: {}, message:{}"</span><span class="token punctuation">,</span> records<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> records<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<p>在上面的例子中，我们分别有 3 个消费组 consumer01、consumer02、consumer03 来监听消费 “test” 这个 topic，启动项目后，我们向 "test’ topic 里发送 10 条数据，内容如下：<br> <img src="https://images2.imgbox.com/51/22/hYJCQBJS_o.png" alt="在这里插入图片描述"><br> 观察程序输出如下所示：<br> <img src="https://images2.imgbox.com/55/d3/5jd9ML1N_o.png" alt="在这里插入图片描述"><br> 可以看到：</p> 
<ul><li>consumer01: 接收批量数据的时候将数据按 “,” 号进行了分割</li><li>consumer02: 接收到了消息的集合数据，但无法获取消息的 offset 等信息</li><li>consumer03: 接收到了消息的集合数据，并可以获取到消息的 offset 等信息</li></ul> 
<p>从上面的结果来看，如果是批量数据消费的话，建议使用第 3 种方法进行接收数据，这样不仅可以获取到消息还可以获取该条消息的 offset 等信息。</p> 
<blockquote> 
 <p>样例代码： <a href="https://github.com/lt5227/example_code/tree/main/spring_kafka_example">https://github.com/lt5227/example_code/tree/main/spring_kafka_example</a></p> 
</blockquote> 
<h3><a id="3_Spring_Kafka__144"></a>3. Spring Kafka 主要的相关类的说明</h3> 
<ol><li> <p><strong>KafkaTemplate</strong><br> <strong>作用</strong>：<code>KafkaTemplate</code> 是 Spring Kafka 中用于生产消息的主要类，类似于 Spring JMS 的 JmsTemplate。它封装了 Kafka 的生产者客户端，使得发送消息到 Kafka 变得简单。</p> </li><li> <p><strong>KafkaListener</strong><br> <strong>作用</strong>：<code>@KafkaListener</code>注解用于标记方法以便作为 Kafka 消息的消费者。这使得监听 Kafka topics 变得非常简单。可以在单个方法上配置多个 topics 或使用 pattern 匹配多个 topics。</p> </li><li> <p><strong>KafkaListenerEndpointRegistry</strong><br> <strong>作用</strong>：<code>KafkaListenerEndpointRegistry</code> 是一个管理 Kafka 监听容器的注册中心。它可以用来动态地添加、查询和删除监听容器。此外，它还支持启动和停止所有或单个监听容器。</p> </li><li> <p><strong>MessageListenerContainer</strong><br> <strong>作用</strong>：<code>MessageListenerContainer</code> 是一个用于封装 Kafka 消费者行为的接口，它的实现类（如 <code>ConcurrentMessageListenerContainer</code> 和 <code>KafkaMessageListenerContainer</code>）提供了具体的消费者配置和消息处理。</p> <p>通过 <code>KafkaListenerEndpointRegistry</code> 获取特定的 <code>MessageListenerContainer</code>。<br> 调用 <code>start()</code>, <code>stop()</code>, 或 <code>pause()</code> 方法来控制消息消费的行为。</p> </li><li> <p><strong>AbstractKafkaListenerEndpoint</strong><br> <strong>作用</strong>：<code>AbstractKafkaListenerEndpoint</code> 包括 <code>SimpleKafkaListenerEndpoint</code> 和 <code>MethodKafkaListenerEndpoint</code> 是定义 Kafka 消息监听器细节（如 topic, partition, filter等）的基础类。</p> <p>使用这些类在运行时创建和配置新的监听器端点。将端点注册到 <code>KafkaListenerEndpointRegistry</code>。</p> </li><li> <p><strong>KafkaListenerContainerFactory</strong><br> <strong>作用</strong>：<code>KafkaListenerContainerFactory</code> 用于创建 <code>MessageListenerContainer</code>。它定义了容器的配置，如并发数、轮询超时和自动启动等。</p> <p>配置具体的工厂来创建具有特定特性的消费者容器。<br> 通常与 <code>@KafkaListener</code> 注解结合使用，也可以用于编程创建监听器。</p> </li></ol> 
<h3><a id="4_KafkaListener__171"></a>4. <code>@KafkaListener</code> 注解的加载执行流程解析</h3> 
<p><code>@KafkaListener</code> 注解是 Spring Kafka 提供的核心功能，用于将方法标记为 Kafka 消息的监听器。当 Spring 应用启动时，<code>KafkaListenerAnnotationBeanPostProcessor</code> 会扫描并解析带有 <code>@KafkaListener</code> 的方法，并创建相应的 <code>KafkaListenerEndpoint</code> 实例。这些端点包含了监听所需的所有配置信息，如主题、分区和过滤器等。接着，<code>KafkaListenerEndpointRegistrar</code> 根据这些端点信息，结合 <code>KafkaListenerContainerFactory</code> 创建并管理 <code>MessageListenerContainer</code>，这些容器负责实际与 Kafka 交互，进行消息的接收和处理。</p> 
<p>下面是整个过程的详细的流程：</p> 
<ol><li> <p><strong>注解解析</strong><br> 当 Spring 应用启动时，Spring 的扫描机制会识别包含 @KafkaListener 注解的方法。这一过程主要由 <code>KafkaListenerAnnotationBeanPostProcessor</code> 类处理，它是一个 Spring Bean 后处理器，专门用来处理 Kafka 监听器注解。<br> 当我们的项目中添加了 <code>spring-kafka</code> 依赖后，启动项目后 <code>KafkaListenerAnnotationBeanPostProcessor</code> 这个类 spring 会自动的注册，原因可以参考：<a href="https://blog.csdn.net/lt5227/article/details/138085715?spm=1001.2014.3001.5502">KafkaListenerEndpointRegistry 隐式注册分析</a> 一文。</p> </li><li> <p><strong>端点注册</strong><br> 一旦 <code>@KafkaListener</code> 注解被识别，<code>KafkaListenerAnnotationBeanPostProcessor</code> 将为每个注解创建一个对应的监听器端点（<code>KafkaListenerEndpoint</code> 实例）。这个端点包括所有必要的信息，如主题（topics）、分区（partitions）和过滤器（filter），这些信息都是从注解的属性中提取的。详细的代码如下所示：</p> <pre><code class="prism language-java"><span class="token comment">/*
 * 代码节选自：spring-kafka:3.1.4 KafkaListenerAnnotationBeanPostProcessor:366 
 */</span> 
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查当前bean是否已经被确定为没有Kafka监听器注解</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>nonAnnotatedClasses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取目标类，考虑可能的AOP代理</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 在类级别查找@KafkaListener注解</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KafkaListener</span><span class="token punctuation">&gt;</span></span> classLevelListeners <span class="token operator">=</span> <span class="token function">findListenerAnnotations</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 确定是否存在类级别的监听器</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasClassLevelListeners <span class="token operator">=</span> <span class="token operator">!</span>classLevelListeners<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 存储可能需要处理的多个方法</span>
        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">&gt;</span></span> multiMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 选择带有@KafkaListener注解的方法</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">KafkaListener</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> annotatedMethods <span class="token operator">=</span> <span class="token class-name">MethodIntrospector</span><span class="token punctuation">.</span><span class="token function">selectMethods</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token class-name">MethodIntrospector<span class="token punctuation">.</span>MetadataLookup</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">KafkaListener</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> method <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 查找方法上的@KafkaListener注解</span>
                    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KafkaListener</span><span class="token punctuation">&gt;</span></span> listenerMethods <span class="token operator">=</span> <span class="token function">findListenerAnnotations</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 如果找到注解，则返回注解，否则返回null</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">!</span>listenerMethods<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> listenerMethods <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果存在类级监听器，找出所有带@KafkaHandler注解的方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasClassLevelListeners<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">&gt;</span></span> methodsWithHandler <span class="token operator">=</span> <span class="token class-name">MethodIntrospector</span><span class="token punctuation">.</span><span class="token function">selectMethods</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span><span class="token class-name">ReflectionUtils<span class="token punctuation">.</span>MethodFilter</span><span class="token punctuation">)</span> method <span class="token operator">-&gt;</span>
                            <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">findAnnotation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token class-name">KafkaHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将找到的方法添加到multiMethods列表</span>
            multiMethods<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>methodsWithHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果没有找到任何注解方法，并且没有类级监听器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotatedMethods<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>hasClassLevelListeners<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 将当前类标记为非注解类，避免未来重复检查</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nonAnnotatedClasses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 记录没有找到@KafkaListener的跟踪信息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">"No @KafkaListener annotations found on bean type: "</span> <span class="token operator">+</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 存在注解方法，遍历这些方法</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">KafkaListener</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> annotatedMethods<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Method</span> method <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">KafkaListener</span> listener <span class="token operator">:</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 处理每一个@KafkaListener注解</span>
                    <span class="token function">processKafkaListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> method<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 调试日志，记录处理的@KafkaListener方法数量</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> annotatedMethods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" @KafkaListener methods processed on bean '"</span>
                    <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"': "</span> <span class="token operator">+</span> annotatedMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果存在类级监听器，处理多方法监听器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasClassLevelListeners<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">processMultiMethodListeners</span><span class="token punctuation">(</span>classLevelListeners<span class="token punctuation">,</span> multiMethods<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 返回处理后的bean</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <p>方法上如果有 <code>@KafkaListener</code> 这个注解在上面的代码中可以看到其会执行如下的方法：</p> <pre><code class="prism language-java"><span class="token comment">// 代码节选自：spring-kafka:3.1.4 KafkaListenerAnnotationBeanPostProcessor:473</span>
<span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">processKafkaListener</span><span class="token punctuation">(</span><span class="token class-name">KafkaListener</span> kafkaListener<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span>
            <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查提供的方法是否为代理方法，如果是，获取原始方法</span>
    <span class="token class-name">Method</span> methodToUse <span class="token operator">=</span> <span class="token function">checkProxy</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建一个方法级别的 Kafka 监听器端点</span>
    <span class="token class-name">MethodKafkaListenerEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> endpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodKafkaListenerEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置监听器端点的方法为检查后的方法</span>
    endpoint<span class="token punctuation">.</span><span class="token function">setMethod</span><span class="token punctuation">(</span>methodToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从注解中获取 bean 引用，通常用于多实例bean的场景</span>
    <span class="token class-name">String</span> beanRef <span class="token operator">=</span> kafkaListener<span class="token punctuation">.</span><span class="token function">beanRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将当前 bean 添加到监听作用域中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listenerScope<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>beanRef<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 为端点设置唯一标识符</span>
    endpoint<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token function">getEndpointId</span><span class="token punctuation">(</span>kafkaListener<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析注解中配置的主题</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> topics <span class="token operator">=</span> <span class="token function">resolveTopics</span><span class="token punctuation">(</span>kafkaListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析注解中配置的主题分区</span>
    <span class="token class-name">TopicPartitionOffset</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tps <span class="token operator">=</span> <span class="token function">resolveTopicPartitions</span><span class="token punctuation">(</span>kafkaListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
     * 处理主监听器和重试监听器，如果处理成功，则不继续后面的流程
     * 方法是判断方法上是否有 @RetryableTopic 注解，有则返回 true 并注册到 KafkaListenerEndpointRegistry
     */</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">processMainAndRetryListeners</span><span class="token punctuation">(</span>kafkaListener<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> methodToUse<span class="token punctuation">,</span> endpoint<span class="token punctuation">,</span> topics<span class="token punctuation">,</span> tps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 处理普通监听器，设置端点的其他属性并注册 (注册到KafkaListenerEndpointRegistry)</span>
        <span class="token function">processListener</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> kafkaListener<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> topics<span class="token punctuation">,</span> tps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 移除之前添加到监听作用域中的 bean</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listenerScope<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span>beanRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 代码节选自：spring-kafka:3.1.4 KafkaListenerAnnotationBeanPostProcessor:612</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processListener</span><span class="token punctuation">(</span><span class="token class-name">MethodKafkaListenerEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> endpoint<span class="token punctuation">,</span> <span class="token class-name">KafkaListener</span> kafkaListener<span class="token punctuation">,</span>
            <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> topics<span class="token punctuation">,</span> <span class="token class-name">TopicPartitionOffset</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tps<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 将 @KafkaListener 注解的配置应用到 Kafka 监听端点</span>
    <span class="token function">processKafkaListenerAnnotation</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> kafkaListener<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> topics<span class="token punctuation">,</span> tps<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从 @KafkaListener 注解中解析出指定的容器工厂名称</span>
    <span class="token class-name">String</span> containerFactory <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>kafkaListener<span class="token punctuation">.</span><span class="token function">containerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据解析出的容器工厂名称获取实际的 KafkaListenerContainerFactory 实例</span>
    <span class="token class-name">KafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> listenerContainerFactory <span class="token operator">=</span> <span class="token function">resolveContainerFactory</span><span class="token punctuation">(</span>kafkaListener<span class="token punctuation">,</span>
                containerFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 注册端点到 KafkaListenerEndpointRegistrar，以便创建对应的消息监听容器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">registerEndpoint</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> listenerContainerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>监听器容器的创建</strong><br> 在上面的代码最后可以看到，端点注册使用的是 <code>KafkaListenerEndpointRegistrar#registerEndpoint(KafkaListenerEndpoint endpoint, @Nullable KafkaListenerContainerFactory&lt;?&gt; factory)</code> 这个方法，其会根据 <code>KafkaListenerContainerFactory</code> 来创建一个 <code>MessageListenerContainer</code>。这个容器负责在运行时与 Kafka 服务器交互，包括连接管理、消息拉取等任务。<br> 代码流程如下：</p> <pre><code class="prism language-java"><span class="token comment">// 代码节选自：spring-kafka:3.1.4 KafkaListenerEndpointRegistrar:231</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerEndpoint</span><span class="token punctuation">(</span><span class="token class-name">KafkaListenerEndpoint</span> endpoint<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">KafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 确保提供的 endpoint 不为空</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> <span class="token string">"Endpoint must be set"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 确保 endpoint 有一个非空的 ID</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Endpoint id must be set"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建一个新的 KafkaListenerEndpointDescriptor 实例，包含 endpoint 和可能为 null 的 factory</span>
    <span class="token comment">// factory 可能为空，在创建容器之前，会进行解析</span>
    <span class="token class-name">KafkaListenerEndpointDescriptor</span> descriptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaListenerEndpointDescriptor</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对 endpointDescriptors 列表进行同步操作，保证线程安全</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>endpointDescriptors<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果 startImmediately 标志为 true，则注册并立即启动监听器容器（初始化程序此处为 false）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startImmediately<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>endpointRegistry<span class="token punctuation">.</span><span class="token function">registerListenerContainer</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>endpoint<span class="token punctuation">,</span>
                    <span class="token function">resolveContainerFactory</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果 startImmediately 标志为 false，则将描述符添加到列表中，稍后启动</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>endpointDescriptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <p><code>KafkaListenerEndpointRegistrar</code> 是 Spring Kafka 框架中的一个核心类，用于注册和管理 Kafka 消费者监听器。它是 <code>@EnableKafka</code> 注解处理过程中使用的关键组件，负责将配置的 Kafka 监听器绑定到相应的消费者实例上。该类提供了一种机制，通过程序注册监听器端点，而不仅限于通过注解定义。<br> 该对象为 <code>KafkaListenerAnnotationBeanPostProcessor</code> 中的属性，如下所示：<br> <img src="https://images2.imgbox.com/a1/15/LNhSWiHI_o.png" alt="在这里插入图片描述"><br> 这里源码是直接 new 了一个 KafkaListenerEndpointRegistrar，在上面的代码块中，程序启动的过程中其 <code>this.startImmediately</code> 一定为 <code>false</code>：<br> <img src="https://images2.imgbox.com/0d/56/gunbrgFY_o.png" alt="在这里插入图片描述"><br> 所以上面的代码只是将 <code>KafkaListenerEndpointDescriptor</code> <em>(保存 KafkaListenerEndpoint 和 KafkaListenerContainerFactory 对象的类)</em> 对象保存了起来，直到当 <code>KafkaListenerAnnotationBeanPostProcessor</code> 执行 <code>afterSingletonsInstantiated()</code> 方法时，其类中的 <code>KafkaListenerEndpointRegistrar</code> 被注入了 <code>KafkaListenerEndpointRegistry</code> 对象，并代码详情如下：</p> <pre><code class="prism language-java"><span class="token comment">// 代码节选自：spring-kafka:3.1.4 KafkaListenerAnnotationBeanPostProcessor:298</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置注册器的 BeanFactory</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">setBeanFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果 BeanFactory 是 ListableBeanFactory，检索所有 KafkaListenerConfigurer 实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">ListableBeanFactory</span> lbf<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取所有 KafkaListenerConfigurer 实例</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">KafkaListenerConfigurer</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span>
                lbf<span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">KafkaListenerConfigurer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 遍历所有配置器，并让它们配置 Kafka 监听器</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">KafkaListenerConfigurer</span> configurer <span class="token operator">:</span> instances<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            configurer<span class="token punctuation">.</span><span class="token function">configureKafkaListeners</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 检查注册器是否已经有一个 endpoint registry，如果没有，则进行设置</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">getEndpointRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>endpointRegistry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 确保 BeanFactory 不为空，以便能通过它获取 endpoint registry</span>
            <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                    <span class="token string">"BeanFactory must be set to find endpoint registry by bean name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 通过 Bean 名称从 BeanFactory 获取 KafkaListenerEndpointRegistry 实例</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>endpointRegistry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>
                    <span class="token class-name">KafkaListenerConfigUtils</span><span class="token punctuation">.</span><span class="token constant">KAFKA_LISTENER_ENDPOINT_REGISTRY_BEAN_NAME</span><span class="token punctuation">,</span>
                    <span class="token class-name">KafkaListenerEndpointRegistry</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设置注册器的 endpoint registry</span>
        <span class="token comment">/*
         * 此处将 KafkaListenerEndpointRegistry 对象注入到了 KafkaListenerEndpointRegistrar 中
         */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">setEndpointRegistry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>endpointRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果指定了默认的 container factory bean 名称，则设置它</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultContainerFactoryBeanName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">setContainerFactoryBeanName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultContainerFactoryBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取并设置消息处理方法工厂</span>
    <span class="token class-name">MessageHandlerMethodFactory</span> handlerMethodFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">getMessageHandlerMethodFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handlerMethodFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageHandlerMethodFactory<span class="token punctuation">.</span><span class="token function">setHandlerMethodFactory</span><span class="token punctuation">(</span>handlerMethodFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果没有指定方法工厂，使用默认的格式化和转换服务</span>
        <span class="token function">addFormatters</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageHandlerMethodFactory<span class="token punctuation">.</span>defaultFormattingConversionService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * 初始化注册器，注册所有监听器
     */</span> 
    <span class="token keyword">this</span><span class="token punctuation">.</span>registrar<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取所有 ContainerGroupSequencer 实例，并初始化它们</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ContainerGroupSequencer</span><span class="token punctuation">&gt;</span></span> sequencers <span class="token operator">=</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBeansOfType</span><span class="token punctuation">(</span><span class="token class-name">ContainerGroupSequencer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sequencers<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">ContainerGroupSequencer</span><span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
  <blockquote> 
   <p><code>afterPropertiesSet</code> 方法是 <code>InitializingBean</code> 接口的一部分，该接口由 Spring 框架提供。它用于在一个 bean 的所有属性被 Spring 容器设置之后，但在 bean 被使用之前，执行必要的初始化工作。<br> 调用时机</p> 
   <ul><li><strong>属性设置之后</strong>: 在 Spring 的 bean 生命周期中，当一个 bean 被实例化后，Spring 容器将通过 setter 注入方法或通过构造函数注入方法注入依赖。一旦所有必要的属性都被设置（包括注入所有必需的依赖），afterPropertiesSet 方法就会被调用。</li><li><strong>自定义初始化逻辑之前</strong>: 这个方法允许开发者在 Spring 执行任何自定义初始化（比如通过 XML 配置或注解配置的 init-method）之前，加入自己的初始化逻辑。</li></ul> 
   <p>用途</p> 
   <ul><li><strong>资源初始化</strong>: 用于开启资源，如数据库连接、网络连接、文件系统等。</li><li><strong>状态检查</strong>: 验证所有必要的属性是否被正确设置，以确保 bean 能正常工作。</li><li><strong>配置验证</strong>: 在 bean 开始执行其核心功能之前，验证配置的正确性。</li></ul> 
  </blockquote> <p>之后我们再看 <code>KafkaListenerEndpointRegistrar</code> 的 <code>afterPropertiesSet()</code> 方法:</p> <pre><code class="prism language-java"><span class="token comment">// 代码节选自：spring-kafka:3.1.4 KafkaListenerEndpointRegistrar:184</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 调用注册所有端点的方法</span>
    <span class="token function">registerAllEndpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerAllEndpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 锁定 endpointDescriptors 对象，保证线程安全</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>endpointDescriptors<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 遍历所有预先配置的端点描述符</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">KafkaListenerEndpointDescriptor</span> descriptor <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endpointDescriptors<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 检查是否是 MultiMethodKafkaListenerEndpoint 类型的端点，并且如果设置了 validator，则应用它</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>descriptor<span class="token punctuation">.</span>endpoint <span class="token keyword">instanceof</span> <span class="token class-name">MultiMethodKafkaListenerEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> mmkle
                    <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>validator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mmkle<span class="token punctuation">.</span><span class="token function">setValidator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>validator<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 注册监听容器，使用解析后的容器工厂</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>endpointRegistry<span class="token punctuation">.</span><span class="token function">registerListenerContainer</span><span class="token punctuation">(</span>
                    descriptor<span class="token punctuation">.</span>endpoint<span class="token punctuation">,</span> <span class="token function">resolveContainerFactory</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设置 startImmediately 标志为 true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>startImmediately <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <p>程序在上面通过 <code>registerListenerContainer</code> 方法注册监听容器：</p> <pre><code class="prism language-java"><span class="token comment">// 代码节选自：spring-kafka:3.1.4 KafkaListenerEndpointRegistry:211</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerListenerContainer</span><span class="token punctuation">(</span><span class="token class-name">KafkaListenerEndpoint</span> endpoint<span class="token punctuation">,</span> <span class="token class-name">KafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factory<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> startImmediately<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查 endpoint 和 factory 是否为空</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> <span class="token string">"Endpoint must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> <span class="token string">"Factory must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取 endpoint 的 ID 并确保它不为空</span>
    <span class="token class-name">String</span> id <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token string">"Endpoint id must not be empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 锁定容器，以确保注册操作的线程安全</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>containersLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 检查是否已经存在具有相同 id 的监听器容器</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>listenerContainers<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"Another endpoint is already registered with id '"</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// **创建监听器容器** //</span>
        <span class="token class-name">MessageListenerContainer</span> container <span class="token operator">=</span> <span class="token function">createListenerContainer</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将新创建的容器添加到管理容器的映射中</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>listenerContainers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取 Spring 应用上下文</span>
        <span class="token class-name">ConfigurableApplicationContext</span> appContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">;</span>
        <span class="token comment">// 获取 endpoint 的组名</span>
        <span class="token class-name">String</span> groupName <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果组名存在并且应用上下文也存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>groupName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> appContext <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageListenerContainer</span><span class="token punctuation">&gt;</span></span> containerGroup<span class="token punctuation">;</span>
            <span class="token class-name">ContainerGroup</span> group<span class="token punctuation">;</span>
            <span class="token comment">// 检查是否已存在这个组名的 bean</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appContext<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>groupName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                <span class="token comment">// 如果存在，获取这个组的容器列表和组信息</span>
                containerGroup <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>groupName<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                group <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>groupName <span class="token operator">+</span> <span class="token string">".group"</span><span class="token punctuation">,</span> <span class="token class-name">ContainerGroup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果不存在，创建新的容器组和组信息</span>
                containerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageListenerContainer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                appContext<span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span>groupName<span class="token punctuation">,</span> containerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
                group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContainerGroup</span><span class="token punctuation">(</span>groupName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                appContext<span class="token punctuation">.</span><span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span>groupName <span class="token operator">+</span> <span class="token string">".group"</span><span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 将新创建的容器添加到组中</span>
            containerGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
            group<span class="token punctuation">.</span><span class="token function">addContainers</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果需要立即启动，则启动容器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>startImmediately<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">startIfNecessary</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 释放锁</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>containersLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 代码节选自：spring-kafka:3.1.4 KafkaListenerEndpointRegistry:274</span>
<span class="token keyword">protected</span> <span class="token class-name">MessageListenerContainer</span> <span class="token function">createListenerContainer</span><span class="token punctuation">(</span><span class="token class-name">KafkaListenerEndpoint</span> endpoint<span class="token punctuation">,</span>
			<span class="token class-name">KafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> factory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查 endpoint 是否为 MethodKafkaListenerEndpoint 类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>endpoint <span class="token keyword">instanceof</span> <span class="token class-name">MethodKafkaListenerEndpoint</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 强制转换为 MethodKafkaListenerEndpoint 类型</span>
        <span class="token class-name">MethodKafkaListenerEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> mkle <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodKafkaListenerEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> endpoint<span class="token punctuation">;</span>
        <span class="token comment">// 获取 endpoint 关联的 bean 对象</span>
        <span class="token class-name">Object</span> bean <span class="token operator">=</span> mkle<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果 bean 是 EndpointHandlerMethod 类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">EndpointHandlerMethod</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 强制转换为 EndpointHandlerMethod 类型</span>
            <span class="token class-name">EndpointHandlerMethod</span> ehm <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">EndpointHandlerMethod</span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
            <span class="token comment">// 更新 bean 对象为从应用上下文解析出的实际 bean</span>
            ehm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EndpointHandlerMethod</span><span class="token punctuation">(</span>ehm<span class="token punctuation">.</span><span class="token function">resolveBean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">,</span> ehm<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新 MethodKafkaListenerEndpoint 的 bean 和 method</span>
            mkle<span class="token punctuation">.</span><span class="token function">setBean</span><span class="token punctuation">(</span>ehm<span class="token punctuation">.</span><span class="token function">resolveBean</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mkle<span class="token punctuation">.</span><span class="token function">setMethod</span><span class="token punctuation">(</span>ehm<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// **使用工厂创建一个新的 MessageListenerContainer** //</span>
    <span class="token class-name">MessageListenerContainer</span> listenerContainer <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createListenerContainer</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查新创建的 listenerContainer 是否实现了 InitializingBean 接口</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerContainer <span class="token keyword">instanceof</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 初始化 listenerContainer</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InitializingBean</span><span class="token punctuation">)</span> listenerContainer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 在初始化失败时抛出异常</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanInitializationException</span><span class="token punctuation">(</span><span class="token string">"Failed to initialize message listener container"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取容器的启动阶段</span>
    <span class="token keyword">int</span> containerPhase <span class="token operator">=</span> listenerContainer<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果容器需要自动启动并且设置了自定义的启动阶段</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listenerContainer<span class="token punctuation">.</span><span class="token function">isAutoStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            containerPhase <span class="token operator">!=</span> <span class="token class-name">AbstractMessageListenerContainer</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_PHASE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">// a custom phase value</span>
        <span class="token comment">// 检查是否存在启动阶段的冲突</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>phase <span class="token operator">!=</span> <span class="token class-name">AbstractMessageListenerContainer</span><span class="token punctuation">.</span><span class="token constant">DEFAULT_PHASE</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>phase <span class="token operator">!=</span> containerPhase<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Encountered phase mismatch between container "</span>
                    <span class="token operator">+</span> <span class="token string">"factory definitions: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>phase <span class="token operator">+</span> <span class="token string">" vs "</span> <span class="token operator">+</span> containerPhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 更新 this.phase 为当前容器的启动阶段</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>phase <span class="token operator">=</span> listenerContainer<span class="token punctuation">.</span><span class="token function">getPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 返回创建的 MessageListenerContainer</span>
    <span class="token keyword">return</span> listenerContainer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p><strong>消息监听器的设置</strong><br> 在 <code>MessageListenerContainer</code> 创建过程中，会设置一个消息监听器来接收消息。这个监听器是实际调用 <code>@KafkaListener</code> 标注的方法的回调对象。上面的代码中 <code>MessageListenerContainer listenerContainer = factory.createListenerContainer(endpoint);</code> 方法内容如下：</p> <pre><code class="prism language-java"><span class="token comment">// 代码节选自：spring-kafka:3.1.4 AbstractKafkaListenerContainerFactory:353</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">C</span> <span class="token function">createListenerContainer</span><span class="token punctuation">(</span><span class="token class-name">KafkaListenerEndpoint</span> endpoint<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建 Kafka 监听容器的实例</span>
    <span class="token class-name">C</span> instance <span class="token operator">=</span> <span class="token function">createContainerInstance</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// JavaUtils.INSTANCE 是一个实用工具，这里使用它来链式调用设置方法，如果值非空则设置</span>
    <span class="token class-name">JavaUtils</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span>
            <span class="token punctuation">.</span><span class="token function">acceptIfNotNull</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token operator">::</span><span class="token function">setBeanName</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">acceptIfNotNull</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span><span class="token function">getMainListenerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token operator">::</span><span class="token function">setMainListenerId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 检查 endpoint 是否为 AbstractKafkaListenerEndpoint 类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>endpoint <span class="token keyword">instanceof</span> <span class="token class-name">AbstractKafkaListenerEndpoint</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果是，对该 endpoint 进行额外的配置</span>
        <span class="token function">configureEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractKafkaListenerEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 根据 endpoint 是否配置为批量监听器来决定使用哪种消息转换器</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span><span class="token function">getBatchListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果是批量监听器，使用 batchMessageConverter 进行设置</span>
        endpoint<span class="token punctuation">.</span><span class="token function">setupListenerContainer</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>batchMessageConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果不是批量监听器，使用 recordMessageConverter 进行设置</span>
        endpoint<span class="token punctuation">.</span><span class="token function">setupListenerContainer</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>recordMessageConverter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 初始化监听容器</span>
    <span class="token function">initializeContainer</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对监听容器进行自定义配置</span>
    <span class="token function">customizeContainer</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回配置好的监听容器实例</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>容器的初始化和启动<br> 一旦 <code>MessageListenerContainer</code> 配置完成，它将被初始化并启动。这个过程中，容器会根据配置连接到 Kafka 服务器，订阅相应的主题，并开始监听消息。<br> 启动的位置如下所示：</p> <pre><code class="prism language-java"><span class="token comment">// 代码节选自：spring-kafka:3.1.4 KafkaListenerEndpointRegistry:333</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MessageListenerContainer</span> listenerContainer <span class="token operator">:</span> <span class="token function">getListenerContainers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">startIfNecessary</span><span class="token punctuation">(</span>listenerContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 代码节选自：spring-kafka:3.1.4 KafkaListenerEndpointRegistry:388</span>
<span class="token comment">/**
 * Start the specified {@link MessageListenerContainer} if it should be started
 * on startup.
 * @param listenerContainer the listener container to start.
 * @see MessageListenerContainer#isAutoStartup()
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">MessageListenerContainer</span> listenerContainer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>contextRefreshed <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>alwaysStartAfterRefresh<span class="token punctuation">)</span> <span class="token operator">||</span> listenerContainer<span class="token punctuation">.</span><span class="token function">isAutoStartup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		listenerContainer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>由于 <code>KafkaListenerEndpointRegistry</code> 实现了 <code>SmartLifecycle</code> 接口的 <code>start()</code> 方法，对于实现 <code>SmartLifecycle</code> 的组件，Spring 容器会在刷新应用上下文（即初始化所有单例 bean 之后）时根据 <code>isAutoStartup()</code> 方法的返回值决定是否自动调用 <code>start()</code> 方法（如果 <code>@KafkaListener</code> 配置了 autoStartup = “false” 则 isAutoStartup() 方法返回 false）。</p> <pre><code class="prism language-java"><span class="token comment">// 代码节选自：spring-kafka:3.1.4 AbstractMessageListenerContainer:503</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">checkGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>containerProperties<span class="token punctuation">.</span><span class="token function">getMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">GenericMessageListener</span><span class="token punctuation">,</span>
					<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">"A "</span> <span class="token operator">+</span> <span class="token class-name">GenericMessageListener</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" implementation must be provided"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">doStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>lifecycleLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 代码节选自：spring-kafka:3.1.4 ConcurrentMessageListenerContainer:235</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查容器是否已经在运行，只在未运行时启动</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 检查是否已配置监听的主题</span>
        <span class="token function">checkTopics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取容器配置属性</span>
        <span class="token class-name">ContainerProperties</span> containerProperties <span class="token operator">=</span> <span class="token function">getContainerProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取配置的主题分区</span>
        <span class="token class-name">TopicPartitionOffset</span><span class="token punctuation">[</span><span class="token punctuation">]</span> topicPartitions <span class="token operator">=</span> containerProperties<span class="token punctuation">.</span><span class="token function">getTopicPartitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 检查并发级别是否超过了提供的分区数，如果超过，则警告并调整并发级别</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>topicPartitions <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>concurrency <span class="token operator">&gt;</span> topicPartitions<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token string">"When specific partitions are provided, the concurrency must be less than or "</span>
                    <span class="token operator">+</span> <span class="token string">"equal to the number of partitions; reduced from "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>concurrency <span class="token operator">+</span> <span class="token string">" to "</span>
                    <span class="token operator">+</span> topicPartitions<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 注意这里，强制将并发数改成最大分数，在设置消费并发时，不用担心分区数量并发超过</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>concurrency <span class="token operator">=</span> topicPartitions<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设置容器为运行状态</span>
        <span class="token function">setRunning</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据配置的并发级别创建并启动子容器</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>concurrency<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 构造每个子容器</span>
            <span class="token class-name">KafkaMessageListenerContainer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> container <span class="token operator">=</span>
                    <span class="token function">constructContainer</span><span class="token punctuation">(</span>containerProperties<span class="token punctuation">,</span> topicPartitions<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 配置子容器</span>
            <span class="token function">configureChildContainer</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果主容器处于暂停状态，则暂停子容器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                container<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 启动子容器</span>
            container<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将子容器添加到容器列表中</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>containers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>上面的代码可以看出如果我们将 <code>spring.kafka.listener.concurrency</code> 配置的值设置的大于 topicPartitions 的值程序会打印一个警告并将 concurrency 强制设置成 topicPartitions 的数量。<code>KafkaMessageListenerContainer</code> 和 <code>ConcurrentMessageListenerContainer</code> 都继承 <code>AbstractMessageListenerContainer</code> 这个类，所以它的 <code>start()</code> 方法实际也是调用的 <code>KafkaMessageListenerContainer</code> 重写的 <code>doStart()</code> 方法，如下所示：</p> <pre><code class="prism language-java"><span class="token comment">// 代码节选自：spring-kafka:3.1.4 KafkaMessageListenerContainer:364</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 检查容器是否已经在运行，如果是，直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果 clientIdSuffix 为空，意味着这是一个独立容器，检查配置的主题</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clientIdSuffix <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">checkTopics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取容器的属性</span>
    <span class="token class-name">ContainerProperties</span> containerProperties <span class="token operator">=</span> <span class="token function">getContainerProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 检查确认模式是否合法</span>
    <span class="token function">checkAckMode</span><span class="token punctuation">(</span>containerProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取消息监听器对象</span>
    <span class="token class-name">Object</span> messageListener <span class="token operator">=</span> containerProperties<span class="token punctuation">.</span><span class="token function">getMessageListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取或创建用于消息消费者的任务执行器</span>
    <span class="token class-name">AsyncTaskExecutor</span> consumerExecutor <span class="token operator">=</span> containerProperties<span class="token punctuation">.</span><span class="token function">getListenerTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>consumerExecutor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        consumerExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAsyncTaskExecutor</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> <span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-C-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        containerProperties<span class="token punctuation">.</span><span class="token function">setListenerTaskExecutor</span><span class="token punctuation">(</span>consumerExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 转换消息监听器为 GenericMessageListener 类型</span>
    <span class="token class-name">GenericMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> listener <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">GenericMessageListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> messageListener<span class="token punctuation">;</span>
    <span class="token comment">// 确定监听器的类型（比如是否是批量监听器）</span>
    <span class="token class-name">ListenerType</span> listenerType <span class="token operator">=</span> <span class="token function">determineListenerType</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化观测注册表，默认为 NOOP（不操作）</span>
    <span class="token class-name">ObservationRegistry</span> observationRegistry <span class="token operator">=</span> <span class="token class-name">ObservationRegistry</span><span class="token punctuation">.</span><span class="token constant">NOOP</span><span class="token punctuation">;</span>
    <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果应用上下文非空且容器属性中启用了观测功能</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationContext <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> containerProperties<span class="token punctuation">.</span><span class="token function">isObservationEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ObservationRegistry</span><span class="token punctuation">&gt;</span></span> registry <span class="token operator">=</span>
                applicationContext<span class="token punctuation">.</span><span class="token function">getBeanProvider</span><span class="token punctuation">(</span><span class="token class-name">ObservationRegistry</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObservationRegistry</span> reg <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getIfUnique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reg <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            observationRegistry <span class="token operator">=</span> reg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 创建监听消费者</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listenerConsumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListenerConsumer</span><span class="token punctuation">(</span>listener<span class="token punctuation">,</span> listenerType<span class="token punctuation">,</span> observationRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置容器为运行状态</span>
    <span class="token function">setRunning</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化启动倒计时锁</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>startLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 提交监听消费者到任务执行器，并获取将来的结果</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listenerConsumerFuture <span class="token operator">=</span> consumerExecutor<span class="token punctuation">.</span><span class="token function">submitCompletable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listenerConsumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 等待消费者启动，超时时间从容器属性中获取</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>startLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>containerProperties<span class="token punctuation">.</span><span class="token function">getConsumerStartTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token comment">// 如果消费者线程启动失败，记录错误日志</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Consumer thread failed to start - does the configured task executor "</span>
                    <span class="token operator">+</span> <span class="token string">"have enough threads to support all containers and concurrency?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 发布启动失败的事件</span>
            <span class="token function">publishConsumerFailedToStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unused"</span><span class="token punctuation">)</span> <span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果在等待过程中被中断，重新设置中断状态</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>上面代码中的 <code>ListenerConsumer</code> ，这个类实现了 <code>Runnable</code> 接口(<code>SchedulingAwareRunnable</code> 继承了 <code>Runnable</code>)并重写了 <code>run</code> 方法，如下图所示：<br> <img src="https://images2.imgbox.com/96/bd/rGziwTot_o.png" alt="在这里插入图片描述"><br> <code>ListenerConsumer</code> 是 Spring Kafka 中的核心类，负责封装 Kafka 消费者的关键操作，包括从 Kafka 队列拉取消息、将消息派发到相应的监听器（如通过 @KafkaListener 注解定义的方法）、管理消息的偏移量提交（支持自动和手动模式），以及处理消息消费过程中的错误。这里对于消息的处理流程就比较繁琐了，这里就不做过多的赘述，感兴趣的可以自己 Debug 调试看看。对于上面的流程我这里附上我看源码的主要的断点：<br> <img src="https://images2.imgbox.com/f2/40/uyJIPob8_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h3><a id="5__746"></a>5. 动态监听消费订阅的设计与实现</h3> 
<p><span id="anchor-point">在详细的了解了上面的关于 <code>@KafkaListener</code> 的执行原理后，我们就可以初步进行设计。</span></p> 
<blockquote> 
 <p><strong>完整的项目 Demo 已上传至 Github 地址：<a href="https://github.com/lt5227/example_code/tree/main/spring_kafka_example">https://github.com/lt5227/example_code/tree/main/spring_kafka_example</a></strong><br> 可以自行下载下来后进行查看<br> 该样例项目集成了 Knife4J 和 Liquibase，数据库使用 MySQL<br> SpingBoot：3.2.5<br> JDK：21<br> 启动项目只需要在 <code>application.yml</code> 修改数据库的连接信息，并创建一个空的数据库，项目启动后会自动创建表结构和插入 Demo 数据，样例代码实现了动态注册和接口控制启停消费程序的样例，大家可以进行参考结合到自己的项目中。<br> 访问接口文档地址：http://localhost:9898/doc.html</p> 
</blockquote> 
<p>首先我们先在 mysql 中建一张表，用来维护我们动态的配置信息，表如下所示：<br> <img src="https://images2.imgbox.com/d7/91/mmUCAXHp_o.png" alt="在这里插入图片描述"><br> 之后我们可以在项目中定义一个组件，当服务启动后该组件读取数据库中的配置初始化消费程序，大致代码如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 注入 Kafka 消费者配置服务</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KafkaConsumerConfigService</span> kafkaConsumerConfigService<span class="token punctuation">;</span>

    <span class="token comment">// 注入 Kafka 监听器端点注册表</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KafkaListenerEndpointRegistry</span> registry<span class="token punctuation">;</span>

    <span class="token comment">// 注入 Kafka 监听器注解处理器</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KafkaListenerAnnotationBeanPostProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> postProcessor<span class="token punctuation">;</span>

    <span class="token comment">// 存储 Kafka 消费者工厂的映射，使用并发哈希映射保证线程安全</span>
    <span class="token annotation punctuation">@Getter</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultKafkaConsumerFactory</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumerFactoryMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 构造函数注入所需的组件
     * @param registry Kafka 监听器端点注册表
     * @param postProcessor Kafka 监听器注解处理器
     * @param kafkaConsumerConfigService Kafka 消费者配置服务
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">KafkaConfig</span><span class="token punctuation">(</span><span class="token class-name">KafkaListenerEndpointRegistry</span> registry<span class="token punctuation">,</span>
                       <span class="token class-name">KafkaListenerAnnotationBeanPostProcessor</span> postProcessor<span class="token punctuation">,</span>
                       <span class="token class-name">KafkaConsumerConfigService</span> kafkaConsumerConfigService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>postProcessor <span class="token operator">=</span> postProcessor<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>kafkaConsumerConfigService <span class="token operator">=</span> kafkaConsumerConfigService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用 @PostConstruct 注解确保此方法在依赖注入完成后自动执行
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token annotation punctuation">@SneakyThrows</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 查询所有 Kafka 消费者配置</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">KafkaConsumerConfig</span><span class="token punctuation">&gt;</span></span> kafkaConsumerConfigs <span class="token operator">=</span> kafkaConsumerConfigService<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取消息处理方法工厂</span>
        <span class="token class-name">MessageHandlerMethodFactory</span> methodFactory <span class="token operator">=</span> postProcessor<span class="token punctuation">.</span><span class="token function">getMessageHandlerMethodFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">KafkaConsumerConfig</span> kafkaConsumerConfig <span class="token operator">:</span> kafkaConsumerConfigs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取 Kafka broker 地址</span>
            <span class="token class-name">String</span> kafkaBroker <span class="token operator">=</span> kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getKafkaBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果工厂映射中尚未有此 broker 的工厂，创建一个</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumerFactoryMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>kafkaBroker<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 获取 Kafka 配置，如果为空则使用一个新的 JSONObject</span>
                <span class="token class-name">JSONObject</span> props <span class="token operator">=</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getKafkaConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置 Kafka 的基本连接配置</span>
                props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> kafkaBroker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_DESERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_DESERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 创建并存储 Kafka 消费者工厂</span>
                <span class="token class-name">DefaultKafkaConsumerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKafkaConsumerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
                consumerFactoryMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>kafkaBroker<span class="token punctuation">,</span> consumerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 从映射中获取 Kafka 消费者工厂</span>
            <span class="token class-name">DefaultKafkaConsumerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerFactory <span class="token operator">=</span> consumerFactoryMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>kafkaBroker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建 Kafka 监听器容器工厂</span>
            <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            factory<span class="token punctuation">.</span><span class="token function">setConsumerFactory</span><span class="token punctuation">(</span>consumerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置并发量</span>
            factory<span class="token punctuation">.</span><span class="token function">setConcurrency</span><span class="token punctuation">(</span>kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getConcurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 创建方法级 Kafka 监听器端点</span>
            <span class="token class-name">MethodKafkaListenerEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> endpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodKafkaListenerEndpoint</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 解析方法字符串为类和方法的引用</span>
            <span class="token class-name">ClassMethodArgs</span> classMethodArgs <span class="token operator">=</span> <span class="token class-name">ClassMethodArgs</span><span class="token punctuation">.</span><span class="token function">parseMethod</span><span class="token punctuation">(</span>kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getBeanMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DynamicConsumer</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">DynamicConsumer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>classMethodArgs<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建类实例</span>
            <span class="token class-name">Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> constructor <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            endpoint<span class="token punctuation">.</span><span class="token function">setBean</span><span class="token punctuation">(</span>constructor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置方法</span>
            <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">findMethod</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> classMethodArgs<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> classMethodArgs<span class="token punctuation">.</span><span class="token function">getArgsClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            endpoint<span class="token punctuation">.</span><span class="token function">setMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置消息处理方法工厂</span>
            endpoint<span class="token punctuation">.</span><span class="token function">setMessageHandlerMethodFactory</span><span class="token punctuation">(</span>methodFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置端点 ID 和组 ID</span>
            endpoint<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">"DynamicConsumer-"</span> <span class="token operator">+</span> kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            endpoint<span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span>kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getKafkaGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置监听的主题</span>
            endpoint<span class="token punctuation">.</span><span class="token function">setTopics</span><span class="token punctuation">(</span>kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getKafkaTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置端点的并发量</span>
            endpoint<span class="token punctuation">.</span><span class="token function">setConcurrency</span><span class="token punctuation">(</span>kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getConcurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置为批处理监听器</span>
            endpoint<span class="token punctuation">.</span><span class="token function">setBatchListener</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 注册监听器容器</span>
            registry<span class="token punctuation">.</span><span class="token function">registerListenerContainer</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 启动所有注册的监听器容器</span>
        registry<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>数据库中有如下数据：</p> 
<pre><code class="prism language-json"><span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string-property property">"kafka_broker"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1:9092"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"kafka_topic"</span><span class="token operator">:</span> <span class="token string">"dynamic_topic"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"kafka_group_id"</span><span class="token operator">:</span> <span class="token string">"dynamic_group1"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"topic_offset"</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token string-property property">"concurrency"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string-property property">"bean_method"</span><span class="token operator">:</span> <span class="token string">"com.stackstone.example.spring.kafka.consumer.DemoDynamicConsumer#consumeMessage01(java.util.List)"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"kafka_config"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"max.poll.records"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token string-property property">"auto.offset.reset"</span><span class="token operator">:</span> <span class="token string">"earliest"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"auto.commit.interval.ms"</span><span class="token operator">:</span> <span class="token number">5000</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"run_status"</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>项目启动后，程序读取查询到上面的数据后动态注册了监听器，其中 <code>kafka_config</code> 可以根据自己的需求进行配置的调整，项目启动后监听器自动消费每次消费完成后会自动的更新数据库中 topic 的消费 offset（这里可以根据自己的需求调整）<br> <img src="https://images2.imgbox.com/dc/d0/9edI6IQB_o.png" alt="在这里插入图片描述"><br> 消费程序如下所示：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoDynamicConsumer</span> <span class="token keyword">extends</span> <span class="token class-name">DynamicConsumer</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token class-name">DemoDynamicConsumer</span><span class="token punctuation">(</span><span class="token keyword">long</span> kafkaConsumerConfigId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>kafkaConsumerConfigId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumeMessage01</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Payload</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"consumer01 received message count:{}"</span><span class="token punctuation">,</span> consumerRecords<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">processMessage</span><span class="token punctuation">(</span>consumerRecords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processMessage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> seekConfiguration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecord <span class="token operator">:</span> consumerRecords<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"message content: {}"</span><span class="token punctuation">,</span> consumerRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">updateTopicPartitionOffset</span><span class="token punctuation">(</span>consumerRecord<span class="token punctuation">,</span> seekConfiguration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">KafkaConsumerConfigService</span> kafkaConsumerConfigService <span class="token operator">=</span> <span class="token class-name">SpringUtil</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">KafkaConsumerConfigService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        seekConfiguration<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> offset<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            kafkaConsumerConfigService<span class="token punctuation">.</span><span class="token function">recordKafkaOffset</span><span class="token punctuation">(</span>kafkaConsumerConfigId<span class="token punctuation">,</span> topicPartition<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateTopicPartitionOffset</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumerRecord<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> seekConfiguration<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> topic <span class="token operator">=</span> consumerRecord<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> partition <span class="token operator">=</span> consumerRecord<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TopicPartition</span> topicPartition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> offset <span class="token operator">=</span> seekConfiguration<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            seekConfiguration<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> consumerRecord<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            seekConfiguration<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicPartition<span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> consumerRecord<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>由于 demo 样例中每次消费完数据都会更新 offset 到数据库中，此处需要将数据库中数据的主键 id 传递到这个类中，并且在每次启动的时候需要读取数据库中的 offset 进行 seek 操作，所以中间定义了一个 <code>DynamicConsumer</code> 这个类，它实现了 <code>ConsumerSeekAware</code> 接口。这个接口用于当 Kafka 消费者的分区被分配后，允许消费者在指定的偏移量(offset)处开始消费消息。：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">ConsumerSeekAware</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 成员变量，存储 Kafka 消费者配置的 ID</span>
    <span class="token keyword">protected</span> <span class="token keyword">long</span> kafkaConsumerConfigId<span class="token punctuation">;</span>

    <span class="token comment">// 构造函数，初始化 kafkaConsumerConfigId</span>
    <span class="token keyword">public</span> <span class="token class-name">DynamicConsumer</span><span class="token punctuation">(</span><span class="token keyword">long</span> kafkaConsumerConfigId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>kafkaConsumerConfigId <span class="token operator">=</span> kafkaConsumerConfigId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 当分区被分配给这个消费者时，此方法被调用</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPartitionsAssigned</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> assignments<span class="token punctuation">,</span> <span class="token class-name">ConsumerSeekCallback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从 Spring 容器中获取 KafkaConsumerConfigService 实例</span>
        <span class="token class-name">KafkaConsumerConfigService</span> kafkaConsumerConfigService <span class="token operator">=</span> <span class="token class-name">SpringUtil</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">KafkaConsumerConfigService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 通过服务获取 Kafka 消费者的偏移量配置</span>
        <span class="token class-name">JSONObject</span> kafkaOffsetJson <span class="token operator">=</span> kafkaConsumerConfigService<span class="token punctuation">.</span><span class="token function">getKafkaOffset</span><span class="token punctuation">(</span>kafkaConsumerConfigId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 遍历分配给消费者的所有分区</span>
        assignments<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>partition <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 从 JSON 对象中获取对应分区的偏移量</span>
            <span class="token class-name">Long</span> offset <span class="token operator">=</span> kafkaOffsetJson<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"$"</span> <span class="token operator">+</span> partition<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果没有获取到偏移量，则默认从 0 开始消费</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                offset <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 使用回调设置消费的起始偏移量</span>
            callback<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>partition<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>关于启停消费程序，我们编写控制层代码如下：</p> 
<pre><code class="prism language-java">	<span class="token comment">// 控制层部分代码</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/stopTest"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">"停止消费程序"</span><span class="token punctuation">,</span>description <span class="token operator">=</span> <span class="token string">"停止消费程序"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testStop</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        kafkaConsumerConfigService<span class="token punctuation">.</span><span class="token function">stopConsumer</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/startTest"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">"开启消费程序"</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">"开启消费程序"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testStart</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        kafkaConsumerConfigService<span class="token punctuation">.</span><span class="token function">startConsumer</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>业务层代码如下：</p> 
<pre><code class="prism language-java"><span class="token comment">// 业务层代码</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerConfigService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 注入Kafka监听器端点注册表，用于管理Kafka消费者容器</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">KafkaListenerEndpointRegistry</span> registry<span class="token punctuation">;</span>

    <span class="token comment">// 构造函数注入Kafka配置存储库和Kafka监听器端点注册表</span>
    <span class="token keyword">public</span> <span class="token class-name">KafkaConsumerConfigServiceImpl</span><span class="token punctuation">(</span><span class="token class-name">KafkaConfigRepository</span> kafkaConfigRepository<span class="token punctuation">,</span>
                                          <span class="token class-name">KafkaListenerEndpointRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registry <span class="token operator">=</span> registry<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 停止特定ID的Kafka消费者</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stopConsumer</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 通过ID查找Kafka消费者配置，如果找不到则抛出异常</span>
        <span class="token class-name">KafkaConsumerConfig</span> kafkaConsumerConfig <span class="token operator">=</span> kafkaConfigRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构造消费者容器的ID</span>
        <span class="token class-name">String</span> containerId <span class="token operator">=</span> <span class="token string">"DynamicConsumer-"</span> <span class="token operator">+</span> kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从注册表中获取对应的消费者容器</span>
        <span class="token class-name">MessageListenerContainer</span> container <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getListenerContainer</span><span class="token punctuation">(</span>containerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果容器存在，则停止容器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>container <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            container<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 启动特定ID的Kafka消费者</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startConsumer</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 通过ID查找Kafka消费者配置，如果找不到则抛出异常</span>
        <span class="token class-name">KafkaConsumerConfig</span> kafkaConsumerConfig <span class="token operator">=</span> kafkaConfigRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 构造消费者容器的ID</span>
        <span class="token class-name">String</span> containerId <span class="token operator">=</span> <span class="token string">"DynamicConsumer-"</span> <span class="token operator">+</span> kafkaConsumerConfig<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从注册表中获取对应的消费者容器</span>
        <span class="token class-name">MessageListenerContainer</span> container <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getListenerContainer</span><span class="token punctuation">(</span>containerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果容器存在，则启动容器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>container <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            container<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>之后我们请求接口：</p> 
<ul><li> <p>停止监听消费：<br> <img src="https://images2.imgbox.com/c4/2f/O9D7WiCd_o.png" alt="在这里插入图片描述"><br> 请求成功控制台打印：<br> <img src="https://images2.imgbox.com/4b/42/cyIDb2y8_o.png" alt="在这里插入图片描述"></p> </li><li> <p>启动监听消费：<br> <img src="https://images2.imgbox.com/73/03/TdRHdZ5x_o.png" alt="在这里插入图片描述"><br> 请求成果控制台打印：<br> <img src="https://images2.imgbox.com/aa/03/s5UFSqP8_o.png" alt="在这里插入图片描述"><br> 并且启动的 Consumer 会读取数据库的 offset 后 seek 后进行消费。</p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0655d39c02669fe73c2bdf98ddc62133/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mac电脑Android Studio和VS Code配置Flutter开发环境（图文超详细）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9ddcb18c401595fac4aea75812f332fc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AIGC算法2：LLM的复读机问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>