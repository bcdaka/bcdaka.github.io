<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ASP.NET Core 8.0 WebApi 从零开始学习JWT登录认证 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/d979fa16babc4aebc704a67eb7fd0608/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="ASP.NET Core 8.0 WebApi 从零开始学习JWT登录认证">
  <meta property="og:description" content="文章目录 前言相关链接Nuget选择知识补充JWT不是加密算法可逆加密和不可逆加密 普通Jwt（不推荐）项目环境Nuget 最小JWT测试在WebApi中简单使用简单使用运行结果 WebApi 授权，博客太老了，尝试失败 WebApi .net core 8.0 最新版Jwt （微软官方集成）重新新建一个Webapi简单Controller 最简单的Jwt认证获取JwtConfig新建JwtHelper类完善JwtConfig授权授权测试 能通过Jwt的请求PostMan测试过期测试 Swagger 全局Header 获取Jwt中的信息简单封装一下 Jwt授权模式基础讲解简单的【角色授权】获取不同权限的Token不同权限的jwt认证 封装好的代码总结 前言 我一起写后端Api我都是直接裸连的，但是现在为了规范一些，我还是打算上一个JWT功能
相关链接 ASP.NET Web API 2系列(四)：基于JWT的token身份认证方案
Jwt-dotnet github
Nuget选择 选好了模板，就进去看看号了，42M的下载量已经很高了，一般来说，只要超过500k的下载量，基本就是一个稳定的代码仓库了。
进去看看里面写的怎么样
可以看到写的还是比较清晰的
知识补充 JWT不是加密算法 JWT全名 JSON Web Token。Token这部分才是加密得出来的，JWT只是一个网页认证策略。
可逆加密和不可逆加密 无论是可逆加密还是不可逆加密，都需要一个自定义的【Key】来辅助加密。可逆加密就类似于一元二次方程，key就类似于修改方程各项的系数，【Key=125】得到【x^2&#43;2x&#43;5】。我的原文是【1】，得到的密文就是计算后的结果【8】。所以加密比解密要方便。
不可逆加密就是不能逆向解决的方程，比如高阶方程【x^7- x^3 &#43;5x-3】，正向好算，逆向基本不可解。
所以现实使用的时候，可逆加密一般是解密后使用。因为可逆，所以可以用于复杂的敏感信息。
不可逆加密是判断加密后的的密文是否相同，比如密码，是不能泄漏的，所以我们的密码只能重置，因为系统也不知道原密码是什么。
普通Jwt（不推荐） 项目环境 visual studio 2022.net core 8.0win 10 Nuget 最小JWT测试 我们先不管JWT是如何添加到ASP.NET Core里面的，我们先测试JWT的加密和登录验证的功能。
/// &lt;summary&gt; /// 加密密钥 /// &lt;/summary&gt; private static readonly string jwtKey = &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-15T10:11:25+08:00">
    <meta property="article:modified_time" content="2024-03-15T10:11:25+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ASP.NET Core 8.0 WebApi 从零开始学习JWT登录认证</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">前言</a></li><li><a href="#_5" rel="nofollow">相关链接</a></li><li><a href="#Nuget_10" rel="nofollow">Nuget选择</a></li><li><a href="#_24" rel="nofollow">知识补充</a></li><li><ul><li><a href="#JWT_26" rel="nofollow">JWT不是加密算法</a></li><li><a href="#_31" rel="nofollow">可逆加密和不可逆加密</a></li></ul> 
  </li><li><a href="#Jwt_40" rel="nofollow">普通Jwt（不推荐）</a></li><li><ul><li><a href="#_42" rel="nofollow">项目环境</a></li><li><ul><li><a href="#Nuget_48" rel="nofollow">Nuget</a></li></ul> 
   </li><li><a href="#JWT_54" rel="nofollow">最小JWT测试</a></li><li><a href="#WebApi_121" rel="nofollow">在WebApi中简单使用</a></li><li><ul><li><a href="#_267" rel="nofollow">简单使用</a></li><li><a href="#_354" rel="nofollow">运行结果</a></li></ul> 
   </li><li><a href="#WebApi__376" rel="nofollow">WebApi 授权，博客太老了，尝试失败</a></li></ul> 
  </li><li><a href="#WebApi_net_core_80_Jwt__390" rel="nofollow">WebApi .net core 8.0 最新版Jwt （微软官方集成）</a></li><li><ul><li><a href="#Webapi_407" rel="nofollow">重新新建一个Webapi</a></li><li><ul><li><a href="#Controller_486" rel="nofollow">简单Controller</a></li></ul> 
   </li><li><a href="#Jwt_534" rel="nofollow">最简单的Jwt认证</a></li><li><ul><li><a href="#JwtConfig_543" rel="nofollow">获取JwtConfig</a></li><li><a href="#JwtHelper_590" rel="nofollow">新建JwtHelper类</a></li><li><a href="#JwtConfig_683" rel="nofollow">完善JwtConfig</a></li><li><a href="#_773" rel="nofollow">授权</a></li><li><ul><li><a href="#_885" rel="nofollow">授权测试</a></li></ul> 
    </li><li><a href="#Jwt_1001" rel="nofollow">能通过Jwt的请求</a></li><li><ul><li><a href="#PostMan_1006" rel="nofollow">PostMan测试</a></li><li><a href="#_1014" rel="nofollow">过期测试</a></li></ul> 
    </li><li><a href="#Swagger_Header_1029" rel="nofollow">Swagger 全局Header</a></li></ul> 
   </li><li><a href="#Jwt_1071" rel="nofollow">获取Jwt中的信息</a></li><li><ul><li><a href="#_1153" rel="nofollow">简单封装一下</a></li></ul> 
   </li><li><a href="#Jwt_1356" rel="nofollow">Jwt授权模式基础讲解</a></li><li><ul><li><a href="#_1364" rel="nofollow">简单的【角色授权】</a></li><li><ul><li><a href="#Token_1365" rel="nofollow">获取不同权限的Token</a></li><li><a href="#jwt_1414" rel="nofollow">不同权限的jwt认证</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#_1461" rel="nofollow">封装好的代码</a></li><li><a href="#_1815" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>前言</h2> 
<p>我一起写后端Api我都是直接裸连的，但是现在为了规范一些，我还是打算上一个JWT功能</p> 
<h2><a id="_5"></a>相关链接</h2> 
<blockquote> 
 <p><a href="https://www.cnblogs.com/matanzhang/p/13715738.html" rel="nofollow">ASP.NET Web API 2系列(四)：基于JWT的token身份认证方案</a></p> 
</blockquote> 
<blockquote> 
 <p><a href="https://github.com/jwt-dotnet/jwt">Jwt-dotnet github</a></p> 
</blockquote> 
<h2><a id="Nuget_10"></a>Nuget选择</h2> 
<p><img src="https://images2.imgbox.com/78/22/2JAMnZZF_o.png" alt="在这里插入图片描述"><br> 选好了模板，就进去看看号了，42M的下载量已经很高了，一般来说，只要超过500k的下载量，基本就是一个稳定的代码仓库了。</p> 
<p>进去看看里面写的怎么样</p> 
<p><img src="https://images2.imgbox.com/87/9c/PLBS1qJY_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到写的还是比较清晰的</p> 
<p><img src="https://images2.imgbox.com/5d/9b/lBjAROjQ_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_24"></a>知识补充</h2> 
<h3><a id="JWT_26"></a>JWT不是加密算法</h3> 
<p>JWT全名 JSON Web Token。Token这部分才是加密得出来的，JWT只是一个网页认证策略。</p> 
<h3><a id="_31"></a>可逆加密和不可逆加密</h3> 
<p>无论是可逆加密还是不可逆加密，都需要一个自定义的【Key】来辅助加密。可逆加密就类似于一元二次方程，key就类似于修改方程各项的系数，【Key=125】得到【x^2+2x+5】。我的原文是【1】，得到的密文就是计算后的结果【8】。所以加密比解密要方便。</p> 
<p>不可逆加密就是不能逆向解决的方程，比如高阶方程【x^7- x^3 +5x-3】，正向好算，逆向基本不可解。</p> 
<p>所以现实使用的时候，可逆加密一般是解密后使用。因为可逆，所以可以用于复杂的敏感信息。<br> 不可逆加密是判断加密后的的密文是否相同，比如密码，是不能泄漏的，所以我们的密码只能重置，因为系统也不知道原密码是什么。</p> 
<h2><a id="Jwt_40"></a>普通Jwt（不推荐）</h2> 
<h3><a id="_42"></a>项目环境</h3> 
<ul><li>visual studio 2022</li><li>.net core 8.0</li><li>win 10</li></ul> 
<h4><a id="Nuget_48"></a>Nuget</h4> 
<p><img src="https://images2.imgbox.com/a6/e8/a4cxmIAp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6f/8a/JhfeAnkR_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="JWT_54"></a>最小JWT测试</h3> 
<p>我们先不管JWT是如何添加到ASP.NET Core里面的，我们先测试JWT的加密和登录验证的功能。</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 加密密钥</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">string</span></span> jwtKey <span class="token operator">=</span> <span class="token string">"TokenKey"</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">UserTest</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> Name<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">string</span></span> Account<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">string</span></span> Password<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token class-name">UserTest</span> userTest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UserTest</span><span class="token punctuation">(</span><span class="token string">"小王"</span><span class="token punctuation">,</span><span class="token string">"admin"</span><span class="token punctuation">,</span><span class="token string">"1dixa0d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"原文"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>JsonConvert<span class="token punctuation">.</span><span class="token function">SerializeObject</span><span class="token punctuation">(</span>userTest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{"Name":"小王","Account":"admin","Password":"1dixa0d"}</span>

    <span class="token class-name"><span class="token keyword">var</span></span> encoder <span class="token operator">=</span> <span class="token function">GetEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> jwtToken <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>userTest<span class="token punctuation">,</span>jwtKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"加密"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJOYW1lIjoi5bCP546LIiwiQWNjb3VudCI6ImFkbWluIiwiUGFzc3dvcmQiOiIxZGl4YTBkIn0.C_tlDhHpkjAkJpRRdnqz6Jn2FmP0qONAI4oNl8Ye9wM</span>

    <span class="token class-name"><span class="token keyword">var</span></span> decoder <span class="token operator">=</span>  <span class="token function">GetDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> decodeData <span class="token operator">=</span>  decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>jwtToken<span class="token punctuation">,</span>jwtKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"解密"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>decodeData<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//{"Name":"小王","Account":"admin","Password":"1dixa0d"}</span>


    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Hello, World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 获取加密解密</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IJwtEncoder</span> <span class="token function">GetEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">IJwtAlgorithm</span> algorithm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HMACSHA256Algorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加密方式</span>
    <span class="token class-name">IJsonSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonNetSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//序列化Json</span>
    <span class="token class-name">IBase64UrlEncoder</span> urlEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtBase64UrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//base64加解密</span>
    <span class="token class-name">IJwtEncoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtEncoder</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">,</span> serializer<span class="token punctuation">,</span> urlEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//JWT编码</span>
    <span class="token keyword">return</span> encoder<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 获取解密密钥</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IJwtDecoder</span> <span class="token function">GetDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">IJsonSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonNetSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IDateTimeProvider</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UtcDateTimeProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IJwtValidator</span> validator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtValidator</span><span class="token punctuation">(</span>serializer<span class="token punctuation">,</span> provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IBase64UrlEncoder</span> urlEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtBase64UrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IJwtAlgorithm</span> algorithm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HMACSHA256Algorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IJwtDecoder</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtDecoder</span><span class="token punctuation">(</span>serializer<span class="token punctuation">,</span> validator<span class="token punctuation">,</span> urlEncoder<span class="token punctuation">,</span> algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> decoder<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/71/50/iB04RlOP_o.png" alt="在这里插入图片描述"><br> 这里的JWT的加密解密算法是可以自己搭配的，选择加密算法，这里我就不展开了。详细可以看官方文档<br> <img src="https://images2.imgbox.com/0f/e4/c4gtFrkJ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="WebApi_121"></a>在WebApi中简单使用</h3> 
<p>首先我们之前用到了可逆的加密和解密。那我们就需要用一个判断是否过期的类</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserJwtLogin</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 用户Id，因为数据库的Id是唯一的，不会重复</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> UserId <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 过期时间</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> ExpireTime <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>详细的解决方案就在这个文章里面了，我就不照抄了，拾人牙慧。</p> 
<blockquote> 
 <p><a href="https://www.cnblogs.com/matanzhang/p/13715738.html" rel="nofollow">ASP.NET Web API 2系列(四)：基于JWT的token身份认证方案</a></p> 
</blockquote> 
<p>我这里是这么写的</p> 
<p>新建一个JwtHelper</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">JwtHelper</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">string</span></span> JwtKey <span class="token operator">=</span> <span class="token string">"这里填你的密钥"</span><span class="token punctuation">;</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 获取加密解密</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">IJwtEncoder</span> <span class="token function">GetEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IJwtAlgorithm</span> algorithm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HMACSHA256Algorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加密方式</span>
        <span class="token class-name">IJsonSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonNetSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//序列化Json</span>
        <span class="token class-name">IBase64UrlEncoder</span> urlEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtBase64UrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//base64加解密</span>
        <span class="token class-name">IJwtEncoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtEncoder</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">,</span> serializer<span class="token punctuation">,</span> urlEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//JWT编码</span>
        <span class="token keyword">return</span> encoder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 获取解密密钥</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">IJwtDecoder</span> <span class="token function">GetDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IJsonSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonNetSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IDateTimeProvider</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UtcDateTimeProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IJwtValidator</span> validator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtValidator</span><span class="token punctuation">(</span>serializer<span class="token punctuation">,</span> provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IBase64UrlEncoder</span> urlEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtBase64UrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IJwtAlgorithm</span> algorithm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HMACSHA256Algorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IJwtDecoder</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtDecoder</span><span class="token punctuation">(</span>serializer<span class="token punctuation">,</span> validator<span class="token punctuation">,</span> urlEncoder<span class="token punctuation">,</span> algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> decoder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 加密</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Encode</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> payload<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> encoder <span class="token operator">=</span> <span class="token function">GetEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> JwtKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 解密</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">T</span> <span class="token generic-method"><span class="token function">Decode</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> token<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> decoder <span class="token operator">=</span> <span class="token function">GetDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> data <span class="token operator">=</span>  decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span>JwtKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> res  <span class="token operator">=</span> JsonConvert<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DeserializeObject</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 解密，只返回Json文本</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="token"&gt;&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">Decode</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> token<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

        <span class="token class-name"><span class="token keyword">var</span></span> decoder <span class="token operator">=</span> <span class="token function">GetDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">var</span></span> data <span class="token operator">=</span> decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> JwtKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>两个实体类</p> 
<pre><code class="prism language-csharp">   <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserJwtLogin</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token comment">/// &lt;summary&gt;</span>
       <span class="token comment">/// 用户Id，因为数据库的Id是唯一的，不会重复</span>
       <span class="token comment">/// &lt;/summary&gt;</span>
       <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> UserId <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    

       <span class="token comment">/// &lt;summary&gt;</span>
       <span class="token comment">/// 过期时间</span>
       <span class="token comment">/// &lt;/summary&gt;</span>
       <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> ExpireTime <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMsg</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Code <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> Success <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> Data <span class="token punctuation">{<!-- --></span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Msg <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">"操作成功!"</span><span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token function">WebMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token function">WebMsg</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> data<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_267"></a>简单使用</h4> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// Jwt登录</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"api/[controller]/[action]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//这个是我的Nlog配置，这里不做展开</span>
    <span class="token keyword">private</span> <span class="token class-name">NlogService</span> nlogService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">LoginController</span><span class="token punctuation">(</span><span class="token class-name">NlogService</span> nlogService<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nlogService <span class="token operator">=</span> nlogService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// JWT登录</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="username"&gt;账号&lt;/param&gt;</span>
    <span class="token comment">/// &lt;param name="password"&gt;密码&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">Login</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> username<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> password <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Msg <span class="token operator">=</span> <span class="token string">"登录信息为空"</span><span class="token punctuation">,</span>
                Success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> password <span class="token operator">==</span> <span class="token string">"123456"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
			<span class="token comment">//这里是模拟拿到数据库的User表的Id</span>
            <span class="token class-name"><span class="token keyword">var</span></span> pyload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UserJwtLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                UserId <span class="token operator">=</span> <span class="token number">291</span><span class="token punctuation">,</span>
                ExpireTime <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> JwtHelper<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>pyload<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Msg <span class="token operator">=</span> <span class="token string">"登录失败，账号或者密码错误"</span><span class="token punctuation">,</span>
                Success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Jwt解密</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="token"&gt;&lt;/param&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">Decode</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> token<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> res <span class="token operator">=</span> JwtHelper<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            nlogService<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"登录解析失败："</span> <span class="token operator">+</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            nlogService<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
                Msg <span class="token operator">=</span> <span class="token string">"登录解析失败："</span> <span class="token operator">+</span> token<span class="token punctuation">,</span>
                Success <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_354"></a>运行结果</h4> 
<p><img src="https://images2.imgbox.com/96/56/61ttaycf_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token string-property property">"success"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"data"</span><span class="token operator">:</span> <span class="token string">"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJVc2VySWQiOjI5MSwiRXhwaXJlVGltZSI6IjIwMjQtMDMtMTRUMTM6MjE6MzYuNjE3NDk0KzA4OjAwIn0.sxh9sM4gQoCfFfim-MQSsHqDQX3Dji3FZaEu4t06D1s"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"msg"</span><span class="token operator">:</span> <span class="token string">"操作成功!"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/2c/07/pp3iEzny_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"code"</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token string-property property">"success"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token string-property property">"data"</span><span class="token operator">:</span> <span class="token string">"{\"UserId\":291,\"ExpireTime\":\"2024-03-14T13:21:36.617494+08:00\"}"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"msg"</span><span class="token operator">:</span> <span class="token string">"操作成功!"</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="WebApi__376"></a>WebApi 授权，博客太老了，尝试失败</h3> 
<p>这里我们就用简单的授权，复杂的授权可以自己去看微软官方文档</p> 
<blockquote> 
 <p><a href="https://learn.microsoft.com/zh-cn/aspnet/core/security/authorization/simple?view=aspnetcore-8.0" rel="nofollow">ASP.NET Core 中的简单授权</a></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/31/3f/UXjZgUAv_o.png" alt="在这里插入图片描述"></p> 
<p>然后我发现.net core 8.0的认证方式好像变了，我按照博客的写法发现不让我重写了<br> <img src="https://images2.imgbox.com/1a/be/9svr7sYP_o.png" alt="在这里插入图片描述"><br> 这个方法是.net framework上面用的，.net core 用不了。我想还是算了，用.net core 的方法好了<br> <img src="https://images2.imgbox.com/22/61/uYFJHcbB_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/05/84/8BkzaaVa_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b9/6b/1ShkULdK_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="WebApi_net_core_80_Jwt__390"></a>WebApi .net core 8.0 最新版Jwt （微软官方集成）</h2> 
<p>我看了一天的博客，终于解决了JWT认证的问题。</p> 
<blockquote> 
 <p><a href="https://learn.microsoft.com/zh-cn/aspnet/core/security/authentication/cookie?view=aspnetcore-8.0" rel="nofollow">在没有 ASP.NET CoreIdentity的情况下使用cookie身份验证</a></p> 
</blockquote> 
<blockquote> 
 <p><a href="https://www.cnblogs.com/clis/p/16151872.html" rel="nofollow">ASP.NET Core 6.0 添加 JWT 认证和授权</a></p> 
</blockquote> 
<blockquote> 
 <p><a href="https://blog.csdn.net/qq_39569480/article/details/120448845">.Net Core WebApi集成JWT实现身份认证</a></p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/51/bb/gVnakST5_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Webapi_407"></a>重新新建一个Webapi</h3> 
<p>这里我就不多说了</p> 
<blockquote> 
 <p><a href="https://blog.csdn.net/qq_44695769/article/details/131557244?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171038019716800226524383%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=171038019716800226524383&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-131557244-null-null.nonecase&amp;utm_term=.net%20core%20%E4%BB%8E%E9%9B%B6&amp;spm=1018.2226.3001.4450">.NET Core webapi 从零开始在IIS上面发布后端接口</a></p> 
</blockquote> 
<p>我们还是要改一下的，因为之前的我测试的时候，发现Builder里面的代码实在是太多了，这里我们分开一下</p> 
<pre><code class="prism language-csharp">
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>OpenApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">JtwTestWebApi</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> MyPolicy <span class="token operator">=</span> <span class="token string">"MyPolicy"</span><span class="token punctuation">;</span>
            <span class="token comment">// Add services to the container.</span>

            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddEndpointsApiExplorer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSwaggerGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//为了防止配套太多，代码混乱。这里自定义了一个方法</span>
            <span class="token function">AddMyService</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Configure the HTTP request pipeline.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>Environment<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                
            <span class="token punctuation">}</span>
            app<span class="token punctuation">.</span><span class="token function">UseSwagger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseSwaggerUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseStatusCodePagesWithRedirects</span><span class="token punctuation">(</span><span class="token string">"/swagger/index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            app<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 为了防止代码过于臃肿，将新的配置放在这里写</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="builder"&gt;&lt;/param&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddMyService</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationBuilder</span> builder<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddCors</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"MyPolicy"</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span>
                <span class="token punctuation">{<!-- --></span>
                    policy<span class="token punctuation">.</span><span class="token function">AllowAnyHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllowAnyOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllowAnyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSwaggerGen</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span><span class="token function">SwaggerDoc</span><span class="token punctuation">(</span><span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiInfo</span>
                <span class="token punctuation">{<!-- --></span>
                    Version <span class="token operator">=</span> <span class="token string">"v1"</span><span class="token punctuation">,</span>
                    Title <span class="token operator">=</span> <span class="token string">"API标题"</span><span class="token punctuation">,</span>
                    Description <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"API描述,v1版本"</span></span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> xmlFilename <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">.xml"</span></span><span class="token punctuation">;</span>
                <span class="token comment">//IncludeXmlComments 第二参数 true 则显示 控制器 注释</span>
                options<span class="token punctuation">.</span><span class="token function">IncludeXmlComments</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>AppContext<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">,</span> xmlFilename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="Controller_486"></a>简单Controller</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebMsg</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span></span> Data <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> Success <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Msg <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token string">"操作成功!"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">WebMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">WebMsg</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> data<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 测试控制器</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"api/[controller]/[action]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 测试返回值</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"测试返回值"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6b/0e/QvluNX7l_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Jwt_534"></a>最简单的Jwt认证</h3> 
<p>我们知道Jwt其实就是生成和验证两个功能。微软把这个功能集成到一个JwtBearer库里面了。</p> 
<p><img src="https://images2.imgbox.com/2d/19/RFHAOw6r_o.png" alt="在这里插入图片描述"><br> 为了方便Json打印，添加个Newtonsoft<br> <img src="https://images2.imgbox.com/06/21/CGCu8kBf_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="JwtConfig_543"></a>获取JwtConfig</h4> 
<p>我们在appsetting.json里面添加</p> 
<pre><code class="prism language-json">  <span class="token string-property property">"JwtConfig"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"SecretKey"</span><span class="token operator">:</span> <span class="token string">"123123123123"</span><span class="token punctuation">,</span> <span class="token comment">// 密钥   可以是guid 也可以是随便一个字符串</span>
    <span class="token string-property property">"Issuer"</span><span class="token operator">:</span> <span class="token string">"XiaoWang"</span><span class="token punctuation">,</span> <span class="token comment">// 颁发者</span>
    <span class="token string-property property">"Audience"</span><span class="token operator">:</span> <span class="token string">"XiaoWang"</span><span class="token punctuation">,</span> <span class="token comment">// 接收者</span>
    <span class="token string-property property">"Expired"</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token comment">// 过期时间（30min）</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8c/e6/B6V8wkPA_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-csharp"> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtConfig</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token comment">/// &lt;summary&gt;</span>
     <span class="token comment">/// 密钥</span>
     <span class="token comment">/// &lt;/summary&gt;</span>
     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SecretKey <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>   

     <span class="token comment">/// &lt;summary&gt;</span>
     <span class="token comment">/// 发布者</span>
     <span class="token comment">/// &lt;/summary&gt;</span>
     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Issuer <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

     <span class="token comment">/// &lt;summary&gt;</span>
     <span class="token comment">/// 接受者</span>
     <span class="token comment">/// &lt;/summary&gt;</span>
     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Audience <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

     <span class="token comment">/// &lt;summary&gt;</span>
     <span class="token comment">/// 过期时间（min）</span>
     <span class="token comment">/// &lt;/summary&gt;</span>
     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Expired <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>获取Config</p> 
<pre><code class="prism language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> jwtConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">"JwtConfig"</span><span class="token punctuation">,</span>jwtConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/00/6a/nNqzpMDT_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/31/a8/8OMoELoa_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="JwtHelper_590"></a>新建JwtHelper类</h4> 
<pre><code class="prism language-csharp"> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtHelper</span>
 <span class="token punctuation">{<!-- --></span>

     <span class="token keyword">public</span> <span class="token return-type class-name">JwtConfig</span> JwtConfig <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
     <span class="token keyword">public</span> <span class="token function">JwtHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>

     <span class="token punctuation">}</span>

     <span class="token comment">/// &lt;summary&gt;</span>
     <span class="token comment">/// 添加Jwt服务</span>
     <span class="token comment">/// &lt;/summary&gt;</span>
     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddJwtService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>

     <span class="token punctuation">}</span>

     <span class="token comment">/// &lt;summary&gt;</span>
     <span class="token comment">/// 返回</span>
     <span class="token comment">/// &lt;/summary&gt;</span>
     <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
     <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token comment">//简单测试一下</span>
         <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> JsonConvert<span class="token punctuation">.</span><span class="token function">SerializeObject</span><span class="token punctuation">(</span>JwtConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> token<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>


 <span class="token punctuation">}</span>
</code></pre> 
<p>我们应该使用Ioc的方式注入JwtHelper</p> 
<pre><code class="prism language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> jwtConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">"JwtConfig"</span><span class="token punctuation">,</span>jwtConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> jwtHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    JwtConfig <span class="token operator">=</span> jwtConfig
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//将JwtHelper添加到Services里面</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>JwtHelper<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>jwtHelper<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9a/b8/jewSJicW_o.png" alt="在这里插入图片描述"></p> 
<p>然后在控制器里面获取Token</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 测试控制器</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"api/[controller]/[action]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">JwtHelper</span> jwtHelper<span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 通过Ioc得到Jwt</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;param name="jwtHelper"&gt;&lt;/param&gt;</span>
    <span class="token keyword">public</span> <span class="token function">TestController</span><span class="token punctuation">(</span><span class="token class-name">JwtHelper</span> jwtHelper<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>jwtHelper <span class="token operator">=</span> jwtHelper<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 测试返回值</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"测试返回值"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 获取JwtToken</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
    <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> jwtHelper<span class="token punctuation">.</span><span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/87/e0/kMRVAgbX_o.png" alt="在这里插入图片描述"><br> 接下来我们修改一下GetJwtToken这个函数即可</p> 
<h4><a id="JwtConfig_683"></a>完善JwtConfig</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Models</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtConfig</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 密钥</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SecretKey <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 发布者</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Issuer <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 接受者</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Audience <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 过期时间（min）</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Expired <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 生效时间</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> NotBefore <span class="token operator">=&gt;</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 过期时间</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> Expiration <span class="token operator">=&gt;</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddMinutes</span><span class="token punctuation">(</span>Expired<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 密钥Bytes</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">private</span> <span class="token return-type class-name">SecurityKey</span> SigningKey <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>SecretKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 加密后的密钥，使用HmacSha256加密</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">SigningCredentials</span> SigningCredentials <span class="token operator">=&gt;</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SigningCredentials</span><span class="token punctuation">(</span>SigningKey<span class="token punctuation">,</span> SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>在JwtHelper里面使用</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 最简单的JwtToken</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> jwtSecurityToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>
            JwtConfig<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
            JwtConfig<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
            claims<span class="token punctuation">,</span>
            JwtConfig<span class="token punctuation">.</span>NotBefore<span class="token punctuation">,</span>
            JwtConfig<span class="token punctuation">.</span>Expiration<span class="token punctuation">,</span>
            JwtConfig<span class="token punctuation">.</span>SigningCredentials
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span> jwtSecurityToken <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> token<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
       
</code></pre> 
<p>运行报错，说明密钥的长度太短了，我们加长一下<br> <img src="https://images2.imgbox.com/76/84/74CxTmQz_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2a/e4/4309apFv_o.png" alt="在这里插入图片描述"><br> 返回成功！</p> 
<p><img src="https://images2.imgbox.com/f9/50/hIdisMku_o.png" alt="在这里插入图片描述"></p> 
<pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYmYiOjE3MTAzODUyODgsImV4cCI6MTcxMDM4NzA4OCwiaXNzIjoiWGlhb1dhbmciLCJhdWQiOiJYaWFvV2FuZyJ9.v7UbQOba7VoNgoiRsoIQkFJKQTFBMLJlYEKBIfdFV4o
</code></pre> 
<h4><a id="_773"></a>授权</h4> 
<p>加密了，肯定要有对应的授权</p> 
<p>在JwtConfig里面添加对应的授权</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtConfig</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 密钥</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SecretKey <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 发布者</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Issuer <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 接受者</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Audience <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 过期时间（min）</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Expired <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 生效时间</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> NotBefore <span class="token operator">=&gt;</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 过期时间</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> Expiration <span class="token operator">=&gt;</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddMinutes</span><span class="token punctuation">(</span>Expired<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 密钥Bytes</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">private</span> <span class="token return-type class-name">SecurityKey</span> SigningKey <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>SecretKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 加密后的密钥，使用HmacSha256加密</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">SigningCredentials</span> SigningCredentials <span class="token operator">=&gt;</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SigningCredentials</span><span class="token punctuation">(</span>SigningKey<span class="token punctuation">,</span> SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 认证用的密钥</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">SymmetricSecurityKey</span> SymmetricSecurityKey <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>SecretKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1a/1b/AawElsMM_o.png" alt="在这里插入图片描述"></p> 
<p>在JwtHelper中</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 添加Jwt服务</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddJwtService</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>option <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//认证middleware配置</span>
        option<span class="token punctuation">.</span>DefaultAuthenticateScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
        option<span class="token punctuation">.</span>DefaultChallengeScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        options<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//Token颁发机构</span>
            ValidIssuer <span class="token operator">=</span> JwtConfig<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
            <span class="token comment">//颁发给谁</span>
            ValidAudience <span class="token operator">=</span> JwtConfig<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
            <span class="token comment">//这里的key要进行加密</span>
            IssuerSigningKey <span class="token operator">=</span> JwtConfig<span class="token punctuation">.</span>SymmetricSecurityKey<span class="token punctuation">,</span>
            <span class="token comment">//是否验证Token有效期，使用当前时间与Token的Claims中的NotBefore和Expires对比</span>
            ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>调用JwtHelper</p> 
<pre><code class="prism language-csharp">  <span class="token class-name"><span class="token keyword">var</span></span> jwtConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">"JwtConfig"</span><span class="token punctuation">,</span>jwtConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name"><span class="token keyword">var</span></span> jwtHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      JwtConfig <span class="token operator">=</span> jwtConfig
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//将JwtHelper添加到Services里面</span>
  builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>JwtHelper<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>jwtHelper<span class="token punctuation">)</span><span class="token punctuation">;</span>
  jwtHelper<span class="token punctuation">.</span><span class="token function">AddJwtService</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Services<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在app中启用</p> 
<pre><code class="prism language-csharp">            app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//要在授权之前认证，这个和[Authorize]特性有关</span>
            app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>一定要在za之前使用ca<br> <img src="https://images2.imgbox.com/c7/a3/2T6jqqpi_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_885"></a>授权测试</h5> 
<p>我们接口最好单独开一个获取Token的接口</p> 
<p>TestController</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Utils</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authorization</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Http</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Controllers</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// 测试控制器</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"api/[controller]/[action]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token class-name">JwtHelper</span> jwtHelper<span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 通过Ioc得到Jwt</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="jwtHelper"&gt;&lt;/param&gt;</span>
        <span class="token keyword">public</span> <span class="token function">TestController</span><span class="token punctuation">(</span><span class="token class-name">JwtHelper</span> jwtHelper<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>jwtHelper <span class="token operator">=</span> jwtHelper<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 测试返回值</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"测试返回值"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 获取JwtToken</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> jwtHelper<span class="token punctuation">.</span><span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 可以在方法前面加Authorize</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token punctuation">[</span>Authorize<span class="token punctuation">]</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetByJwt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"Jwt测试成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>JtwTestWebApi</p> 
<p>如果我们在类前面添加了[Authorize]，下面全部的接口都有Jwt认证。想放开Jtw认证，使用[AllowAnonymous]标记方法即可</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authorization</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Http</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Controllers</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// Jwt测试类</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"api/[controller]/[action]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtTestController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 不需要Jwt</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token punctuation">[</span>AllowAnonymous<span class="token punctuation">]</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">NoJwtGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"我不需要Jwt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 需要Jwt</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">JwtGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"我需要Jwt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>认证失败的结果</p> 
<p><img src="https://images2.imgbox.com/c1/98/CZjaRMWy_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Jwt_1001"></a>能通过Jwt的请求</h4> 
<p>既然我们拦截了请求，我们也得对符合规范的请求放行。那什么样的请求能放行呢？在Header中的【Authorization】中添加【Bearer {token}】才能放行。</p> 
<h5><a id="PostMan_1006"></a>PostMan测试</h5> 
<p><img src="https://images2.imgbox.com/ed/10/E6OfOKnC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b1/9b/IwmUCUnV_o.png" alt="在这里插入图片描述"></p> 
<p>测试成功！<br> <img src="https://images2.imgbox.com/c3/6f/12jlQq5h_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_1014"></a>过期测试</h5> 
<blockquote> 
 <p><a href="https://blog.csdn.net/WuLex/article/details/122078882">.NetCore JWT token过期时间设置</a></p> 
</blockquote> 
<p>Jwt的过期是由两个数据综合相加的。一个是生成Token的过期时间</p> 
<p><img src="https://images2.imgbox.com/2a/4e/0lIqJ8Fo_o.png" alt="在这里插入图片描述"><br> 一个是缓冲时间，默认5分钟。因为服务器的时间可能不同步。</p> 
<p><img src="https://images2.imgbox.com/19/2a/i9XmzlNx_o.png" alt="在这里插入图片描述"><br> 所以总过期时间=过期时间+缓冲时间</p> 
<p><img src="https://images2.imgbox.com/f8/bd/fE9tCgjJ_o.gif" alt="在这里插入图片描述"><br> 为了更简单的获取Token，我们直接把返回的Token自带[Bearer ]这个前缀好了</p> 
<h4><a id="Swagger_Header_1029"></a>Swagger 全局Header</h4> 
<p>在JwtHelper中添加全局静态方法</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// Swagger添加Jwt功能</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;param name="options"&gt;&lt;/param&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SwaggerAddJwtHeader</span><span class="token punctuation">(</span><span class="token class-name">SwaggerGenOptions</span> options<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    options<span class="token punctuation">.</span><span class="token function">AddSecurityRequirement</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityRequirement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
                <span class="token punctuation">{<!-- --></span>
                    Reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiReference</span> <span class="token punctuation">{<!-- --></span>
                        Type <span class="token operator">=</span> ReferenceType<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">,</span>
                        Id <span class="token operator">=</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    options<span class="token punctuation">.</span><span class="token function">AddSecurityDefinition</span><span class="token punctuation">(</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
    <span class="token punctuation">{<!-- --></span>
        Description <span class="token operator">=</span> <span class="token string">"JWT授权(数据将在请求头中进行传输) 在下方输入Bearer {token} 即可，注意两者之间有空格"</span><span class="token punctuation">,</span>
        Name <span class="token operator">=</span> <span class="token string">"Authorization"</span><span class="token punctuation">,</span><span class="token comment">//jwt默认的参数名称</span>
        In <span class="token operator">=</span> ParameterLocation<span class="token punctuation">.</span>Header<span class="token punctuation">,</span><span class="token comment">//jwt默认存放Authorization信息的位置(请求头中)</span>
        Type <span class="token operator">=</span> SecuritySchemeType<span class="token punctuation">.</span>ApiKey<span class="token punctuation">,</span>
        BearerFormat <span class="token operator">=</span> <span class="token string">"JWT"</span><span class="token punctuation">,</span>
        Scheme <span class="token operator">=</span> <span class="token string">"Bearer"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/6e/34/c2xt7ZFM_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b7/1d/vcTi3rY6_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a4/75/Egcrlz2U_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8c/4d/JhiaKbu4_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b2/d5/rcby89jZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Jwt_1071"></a>获取Jwt中的信息</h3> 
<p>因为我们的Jwt是自带【Bearer 】这个请求头的，所以去掉前面的头，里面其实是可以解密的</p> 
<pre><code class="prism language-csharp"> <span class="token comment">/// &lt;summary&gt;</span>
 <span class="token comment">/// 获取Jwt的信息</span>
 <span class="token comment">/// &lt;/summary&gt;</span>
 <span class="token comment">/// &lt;param name="request"&gt;&lt;/param&gt;</span>
 <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
 <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span> <span class="token function">Decode</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     
     <span class="token class-name"><span class="token keyword">var</span></span> authorization <span class="token operator">=</span> request<span class="token punctuation">.</span>Headers<span class="token punctuation">[</span><span class="token string">"Authorization"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//因为我们的Jwt是自带【Bearer 】这个请求头的，所以去掉前面的头</span>
     <span class="token class-name"><span class="token keyword">var</span></span> auth <span class="token operator">=</span> authorization<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token class-name"><span class="token keyword">var</span></span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//反解密，获取其中的Claims</span>
     <span class="token class-name"><span class="token keyword">var</span></span> payload <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">ReadJwtToken</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">.</span>Payload<span class="token punctuation">;</span>
     <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> payload<span class="token punctuation">.</span>Claims<span class="token punctuation">;</span>
     <span class="token keyword">return</span> claims<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<p>解密能拿到是因为我们加密的时候就已经放进去了</p> 
<pre><code class="prism language-csharp"> <span class="token comment">/// &lt;summary&gt;</span>
 <span class="token comment">/// 添加claims信息</span>
 <span class="token comment">/// &lt;/summary&gt;</span>
 <span class="token comment">/// &lt;param name="claims"&gt;&lt;/param&gt;</span>
 <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
 <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span> claims<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token class-name"><span class="token keyword">var</span></span> jwtSecurityToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>
             JwtConfig<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
             JwtConfig<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
             claims<span class="token punctuation">,</span>
             JwtConfig<span class="token punctuation">.</span>NotBefore<span class="token punctuation">,</span>
             JwtConfig<span class="token punctuation">.</span>Expiration<span class="token punctuation">,</span>
             JwtConfig<span class="token punctuation">.</span>SigningCredentials
         <span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>jwtSecurityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
     token <span class="token operator">=</span> <span class="token string">"Bearer "</span> <span class="token operator">+</span> token<span class="token punctuation">;</span>
     <span class="token keyword">return</span> token<span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"> <span class="token comment">/// &lt;summary&gt;</span>
 <span class="token comment">/// 获取JwtToken</span>
 <span class="token comment">/// &lt;/summary&gt;</span>
 <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
 <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
 <span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetJwtToken2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
 	<span class="token comment">//我们加密的时候，就放进去了一些额外的信息</span>
     <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> jwtHelper<span class="token punctuation">.</span><span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"UserId"</span><span class="token punctuation">,</span><span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"UserName"</span><span class="token punctuation">,</span><span class="token string">"3"</span><span class="token punctuation">)</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 可以在方法前面加Authorize</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token punctuation">[</span>Authorize<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetByJwt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//获取解密后的Claim</span>
    <span class="token class-name"><span class="token keyword">var</span></span> dic <span class="token operator">=</span> jwtHelper<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"Jwt测试成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3a/ec/LG87q8dW_o.png" alt="在这里插入图片描述"><br> 这样我们就可以把一些比较隐私的数据放在里面，比如用户Id，这样防止泄漏。</p> 
<h4><a id="_1153"></a>简单封装一下</h4> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>OpenApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Newtonsoft<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Swashbuckle<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>SwaggerGen</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>Jwt</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Utils</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtHelper</span>
    <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">public</span> <span class="token return-type class-name">JwtConfig</span> JwtConfig <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token function">JwtHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 添加Jwt服务</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddJwtService</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>option <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//认证middleware配置</span>
                option<span class="token punctuation">.</span>DefaultAuthenticateScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
                option<span class="token punctuation">.</span>DefaultChallengeScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//Token颁发机构</span>
                    ValidIssuer <span class="token operator">=</span> JwtConfig<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
                    <span class="token comment">//颁发给谁</span>
                    ValidAudience <span class="token operator">=</span> JwtConfig<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
                    <span class="token comment">//这里的key要进行加密</span>
                    IssuerSigningKey <span class="token operator">=</span> JwtConfig<span class="token punctuation">.</span>SymmetricSecurityKey<span class="token punctuation">,</span>
                    <span class="token comment">//是否验证Token有效期，使用当前时间与Token的Claims中的NotBefore和Expires对比</span>
                    ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    ValidateIssuer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    ValidateAudience <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    RequireExpirationTime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 最简单的JwtToken</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> jwtSecurityToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>
                    JwtConfig<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
                    claims<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>NotBefore<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>Expiration<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>SigningCredentials
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>jwtSecurityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            token <span class="token operator">=</span> <span class="token string">"Bearer "</span> <span class="token operator">+</span> token<span class="token punctuation">;</span>
            <span class="token keyword">return</span> token<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 添加claims信息</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="claims"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span> claims<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> jwtSecurityToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>
                    JwtConfig<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
                    claims<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>NotBefore<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>Expiration<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>SigningCredentials
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>jwtSecurityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            token <span class="token operator">=</span> <span class="token string">"Bearer "</span> <span class="token operator">+</span> token<span class="token punctuation">;</span>
            <span class="token keyword">return</span> token<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// UserModel类Token</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="user"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token class-name">JwtUserModel</span> user<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"UserId"</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span>UserId<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"UserName"</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span>UserName<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"UserType"</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span>UserType<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// Swagger添加Jwt功能</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="options"&gt;&lt;/param&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SwaggerAddJwtHeader</span><span class="token punctuation">(</span><span class="token class-name">SwaggerGenOptions</span> options<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            options<span class="token punctuation">.</span><span class="token function">AddSecurityRequirement</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityRequirement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
                        <span class="token punctuation">{<!-- --></span>
                            Reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiReference</span> <span class="token punctuation">{<!-- --></span>
                                Type <span class="token operator">=</span> ReferenceType<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">,</span>
                                Id <span class="token operator">=</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            options<span class="token punctuation">.</span><span class="token function">AddSecurityDefinition</span><span class="token punctuation">(</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
            <span class="token punctuation">{<!-- --></span>
                Description <span class="token operator">=</span> <span class="token string">"JWT授权(数据将在请求头中进行传输) 在下方输入Bearer {token} 即可，注意两者之间有空格"</span><span class="token punctuation">,</span>
                Name <span class="token operator">=</span> <span class="token string">"Authorization"</span><span class="token punctuation">,</span><span class="token comment">//jwt默认的参数名称</span>
                In <span class="token operator">=</span> ParameterLocation<span class="token punctuation">.</span>Header<span class="token punctuation">,</span><span class="token comment">//jwt默认存放Authorization信息的位置(请求头中)</span>
                Type <span class="token operator">=</span> SecuritySchemeType<span class="token punctuation">.</span>ApiKey<span class="token punctuation">,</span>
                BearerFormat <span class="token operator">=</span> <span class="token string">"JWT"</span><span class="token punctuation">,</span>
                Scheme <span class="token operator">=</span> <span class="token string">"Bearer"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 获取Jwt的信息</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="request"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span> <span class="token function">Decode</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

            <span class="token class-name"><span class="token keyword">var</span></span> authorization <span class="token operator">=</span> request<span class="token punctuation">.</span>Headers<span class="token punctuation">[</span><span class="token string">"Authorization"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//因为我们的Jwt是自带【Bearer 】这个请求头的，所以去掉前面的头</span>
            <span class="token class-name"><span class="token keyword">var</span></span> auth <span class="token operator">=</span> authorization<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//反解密，获取其中的Claims</span>
            <span class="token class-name"><span class="token keyword">var</span></span> payload <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">ReadJwtToken</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">.</span>Payload<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> payload<span class="token punctuation">.</span>Claims<span class="token punctuation">;</span>
            <span class="token keyword">return</span> claims<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 解析得到User</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="request"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">JwtUserModel</span> <span class="token function">DecodeToUser</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token function">Decode</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtUserModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                UserId <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">"UserId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">,</span>
                UserName <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">"UserName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">,</span>
                UserType <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">"UserType"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetJwtToken3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> jwtHelper<span class="token punctuation">.</span><span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtUserModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        UserName <span class="token operator">=</span> <span class="token string">"小王"</span><span class="token punctuation">,</span>
        UserId <span class="token operator">=</span> <span class="token string">"32"</span><span class="token punctuation">,</span>
        UserType <span class="token operator">=</span> <span class="token string">"admin"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetByJwt3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">var</span></span> dic <span class="token operator">=</span> jwtHelper<span class="token punctuation">.</span><span class="token function">DecodeToUser</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Request<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"Jwt测试成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>运行得到结果<br> <img src="https://images2.imgbox.com/5b/e0/R5nxGZZZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Jwt_1356"></a>Jwt授权模式基础讲解</h3> 
<p>介绍三种授权方式（Policy、Role、Scheme），Scheme这种用的太少了，我们就简单讲解一下Policy和Role这两种方式。Policy和Role的核心就在于我们封装Token的时候添加的Claim对象。大家看到这里就会发现，其实Jwt的核心就是装包和拆包。网页请求Token的时候拿到了个包裹，网页发送Http的时候解开这个包裹。</p> 
<p>我写了一会，感觉有点累了。这里有个别人写好的代码，有兴趣的自己去看吧。</p> 
<blockquote> 
 <p><a href="https://www.cnblogs.com/clis/p/16151872.html" rel="nofollow">ASP.NET Core 6.0 添加 JWT 认证和授权</a></p> 
</blockquote> 
<h4><a id="_1364"></a>简单的【角色授权】</h4> 
<h5><a id="Token_1365"></a>获取不同权限的Token</h5> 
<p>获取不同权限的Token</p> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 获取Role = admin的Token</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetJwtToken_Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> jwtHelper<span class="token punctuation">.</span><span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span><span class="token string">"admin"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 获取Role = user</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetJwtToken_User</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> jwtHelper<span class="token punctuation">.</span><span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span><span class="token string">"user"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 获取Role = admin和user</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">GetJwtToken_UserAndAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> jwtHelper<span class="token punctuation">.</span><span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>ClaimTypes<span class="token punctuation">.</span>Role<span class="token punctuation">,</span><span class="token string">"admin"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="jwt_1414"></a>不同权限的jwt认证</h5> 
<pre><code class="prism language-csharp"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 需要role=admin</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">AdminGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// role=user</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">"user"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">UserGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// role = admin或user</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">"admin,user"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">AdminOrUserGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"admin or user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// role=admin和user</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">"admin"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Authorize</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Roles <span class="token operator">=</span> <span class="token string">"user"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">WebMsg</span> <span class="token function">AdminAndUserGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebMsg</span><span class="token punctuation">(</span><span class="token string">"admin and user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里推荐使用enum枚举类型，这样不会出现拼写错误</p> 
<h2><a id="_1461"></a>封装好的代码</h2> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Models</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtConfig</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 密钥</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> SecretKey <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 发布者</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Issuer <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 接受者</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Audience <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 过期时间（min）</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Expired <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 生效时间</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> NotBefore <span class="token operator">=&gt;</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 过期时间</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> Expiration <span class="token operator">=&gt;</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddMinutes</span><span class="token punctuation">(</span>Expired<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 密钥Bytes</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">private</span> <span class="token return-type class-name">SecurityKey</span> SigningKey <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>SecretKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 加密后的密钥，使用HmacSha256加密</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">SigningCredentials</span> SigningCredentials <span class="token operator">=&gt;</span>
            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SigningCredentials</span><span class="token punctuation">(</span>SigningKey<span class="token punctuation">,</span> SecurityAlgorithms<span class="token punctuation">.</span>HmacSha256<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 认证用的密钥</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">SymmetricSecurityKey</span> SymmetricSecurityKey <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SymmetricSecurityKey</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>SecretKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>JwtBearer</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>OpenApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Newtonsoft<span class="token punctuation">.</span>Json</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Swashbuckle<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>SwaggerGen</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>Jwt</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Claims</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Utils</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtHelper</span>
    <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">public</span> <span class="token return-type class-name">JwtConfig</span> JwtConfig <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token function">JwtHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 添加Jwt服务</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddJwtService</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span>option <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//认证middleware配置</span>
                option<span class="token punctuation">.</span>DefaultAuthenticateScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
                option<span class="token punctuation">.</span>DefaultChallengeScheme <span class="token operator">=</span> JwtBearerDefaults<span class="token punctuation">.</span>AuthenticationScheme<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">AddJwtBearer</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span>TokenValidationParameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TokenValidationParameters</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//Token颁发机构</span>
                    ValidIssuer <span class="token operator">=</span> JwtConfig<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
                    <span class="token comment">//颁发给谁</span>
                    ValidAudience <span class="token operator">=</span> JwtConfig<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
                    <span class="token comment">//这里的key要进行加密</span>
                    IssuerSigningKey <span class="token operator">=</span> JwtConfig<span class="token punctuation">.</span>SymmetricSecurityKey<span class="token punctuation">,</span>
                    <span class="token comment">//是否验证Token有效期，使用当前时间与Token的Claims中的NotBefore和Expires对比</span>
                    ValidateLifetime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    ValidateIssuer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    ValidateAudience <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    ValidateIssuerSigningKey <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    RequireExpirationTime <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 最简单的JwtToken</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> jwtSecurityToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>
                    JwtConfig<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
                    claims<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>NotBefore<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>Expiration<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>SigningCredentials
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>jwtSecurityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            token <span class="token operator">=</span> <span class="token string">"Bearer "</span> <span class="token operator">+</span> token<span class="token punctuation">;</span>
            <span class="token keyword">return</span> token<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 添加claims信息</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="claims"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span> claims<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> jwtSecurityToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityToken</span><span class="token punctuation">(</span>
                    JwtConfig<span class="token punctuation">.</span>Issuer<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>Audience<span class="token punctuation">,</span>
                    claims<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>NotBefore<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>Expiration<span class="token punctuation">,</span>
                    JwtConfig<span class="token punctuation">.</span>SigningCredentials
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WriteToken</span><span class="token punctuation">(</span>jwtSecurityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            token <span class="token operator">=</span> <span class="token string">"Bearer "</span> <span class="token operator">+</span> token<span class="token punctuation">;</span>
            <span class="token keyword">return</span> token<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// UserModel类Token</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="user"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span><span class="token class-name">JwtUserModel</span> user<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"UserId"</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span>UserId<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"UserName"</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span>UserName<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span><span class="token string">"UserType"</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span>UserType<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">GetJwtToken</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// Swagger添加Jwt功能</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="options"&gt;&lt;/param&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SwaggerAddJwtHeader</span><span class="token punctuation">(</span><span class="token class-name">SwaggerGenOptions</span> options<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            options<span class="token punctuation">.</span><span class="token function">AddSecurityRequirement</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityRequirement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
                        <span class="token punctuation">{<!-- --></span>
                            Reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiReference</span> <span class="token punctuation">{<!-- --></span>
                                Type <span class="token operator">=</span> ReferenceType<span class="token punctuation">.</span>SecurityScheme<span class="token punctuation">,</span>
                                Id <span class="token operator">=</span> <span class="token string">"Bearer"</span><span class="token punctuation">,</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            options<span class="token punctuation">.</span><span class="token function">AddSecurityDefinition</span><span class="token punctuation">(</span><span class="token string">"Bearer"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiSecurityScheme</span>
            <span class="token punctuation">{<!-- --></span>
                Description <span class="token operator">=</span> <span class="token string">"JWT授权(数据将在请求头中进行传输) 在下方输入Bearer {token} 即可，注意两者之间有空格"</span><span class="token punctuation">,</span>
                Name <span class="token operator">=</span> <span class="token string">"Authorization"</span><span class="token punctuation">,</span><span class="token comment">//jwt默认的参数名称</span>
                In <span class="token operator">=</span> ParameterLocation<span class="token punctuation">.</span>Header<span class="token punctuation">,</span><span class="token comment">//jwt默认存放Authorization信息的位置(请求头中)</span>
                Type <span class="token operator">=</span> SecuritySchemeType<span class="token punctuation">.</span>ApiKey<span class="token punctuation">,</span>
                BearerFormat <span class="token operator">=</span> <span class="token string">"JWT"</span><span class="token punctuation">,</span>
                Scheme <span class="token operator">=</span> <span class="token string">"Bearer"</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 获取Jwt的信息</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="request"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>Claim<span class="token punctuation">&gt;</span></span> <span class="token function">Decode</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

            <span class="token class-name"><span class="token keyword">var</span></span> authorization <span class="token operator">=</span> request<span class="token punctuation">.</span>Headers<span class="token punctuation">[</span><span class="token string">"Authorization"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//因为我们的Jwt是自带【Bearer 】这个请求头的，所以去掉前面的头</span>
            <span class="token class-name"><span class="token keyword">var</span></span> auth <span class="token operator">=</span> authorization<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtSecurityTokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//反解密，获取其中的Claims</span>
            <span class="token class-name"><span class="token keyword">var</span></span> payload <span class="token operator">=</span> handler<span class="token punctuation">.</span><span class="token function">ReadJwtToken</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">.</span>Payload<span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> payload<span class="token punctuation">.</span>Claims<span class="token punctuation">;</span>
            <span class="token keyword">return</span> claims<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 解析得到User</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="request"&gt;&lt;/param&gt;</span>
        <span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">JwtUserModel</span> <span class="token function">DecodeToUser</span><span class="token punctuation">(</span><span class="token class-name">HttpRequest</span> request<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> claims <span class="token operator">=</span> <span class="token function">Decode</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtUserModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                UserId <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">"UserId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">,</span>
                UserName <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">"UserName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value<span class="token punctuation">,</span>
                UserType <span class="token operator">=</span> claims<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>t <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>Type <span class="token operator">==</span> <span class="token string">"UserType"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Value
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-csharp"><span class="token keyword">namespace</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Models</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUserModel</span>
    <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> UserId <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> UserName <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> UserType <span class="token punctuation">{<!-- --></span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<pre><code class="prism language-csharp">
<span class="token keyword">using</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">JtwTestWebApi<span class="token punctuation">.</span>Utils</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>OpenApi<span class="token punctuation">.</span>Models</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IdentityModel<span class="token punctuation">.</span>Tokens<span class="token punctuation">.</span>Jwt</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">JtwTestWebApi</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> MyPolicy <span class="token operator">=</span> <span class="token string">"MyPolicy"</span><span class="token punctuation">;</span>
            <span class="token comment">// Add services to the container.</span>

            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle</span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddEndpointsApiExplorer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSwaggerGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//为了防止配套太多，代码混乱。这里自定义了一个方法</span>
            <span class="token function">AddMyService</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Configure the HTTP request pipeline.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>Environment<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                
            <span class="token punctuation">}</span>
            app<span class="token punctuation">.</span><span class="token function">UseSwagger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseSwaggerUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseStatusCodePagesWithRedirects</span><span class="token punctuation">(</span><span class="token string">"/swagger/index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//要在授权之前认证，这个和[Authorize]特性有关</span>
            app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            app<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 为了防止代码过于臃肿，将新的配置放在这里写</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="builder"&gt;&lt;/param&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddMyService</span><span class="token punctuation">(</span><span class="token class-name">WebApplicationBuilder</span> builder<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token preprocessor property">#<span class="token directive keyword">region</span> 默认的Webapi配置</span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddCors</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">"MyPolicy"</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span>
                <span class="token punctuation">{<!-- --></span>
                    policy<span class="token punctuation">.</span><span class="token function">AllowAnyHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllowAnyOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AllowAnyMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSwaggerGen</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                options<span class="token punctuation">.</span><span class="token function">SwaggerDoc</span><span class="token punctuation">(</span><span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OpenApiInfo</span>
                <span class="token punctuation">{<!-- --></span>
                    Version <span class="token operator">=</span> <span class="token string">"v1"</span><span class="token punctuation">,</span>
                    Title <span class="token operator">=</span> <span class="token string">"API标题"</span><span class="token punctuation">,</span>
                    Description <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"API描述,v1版本"</span></span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> xmlFilename <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Assembly<span class="token punctuation">.</span><span class="token function">GetExecutingAssembly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name</span><span class="token punctuation">}</span></span><span class="token string">.xml"</span></span><span class="token punctuation">;</span>
                <span class="token comment">//IncludeXmlComments 第二参数 true 则显示 控制器 注释</span>
                options<span class="token punctuation">.</span><span class="token function">IncludeXmlComments</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>AppContext<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">,</span> xmlFilename<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                JwtHelper<span class="token punctuation">.</span><span class="token function">SwaggerAddJwtHeader</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token preprocessor property">#<span class="token directive keyword">endregion</span> </span>

            <span class="token preprocessor property">#<span class="token directive keyword">region</span> 添加Jwt服务</span>
            <span class="token class-name"><span class="token keyword">var</span></span> jwtConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span><span class="token string">"JwtConfig"</span><span class="token punctuation">,</span>jwtConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> jwtHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JwtHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                JwtConfig <span class="token operator">=</span> jwtConfig
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">//将JwtHelper添加到Services里面</span>
            builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>JwtHelper<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>jwtHelper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            jwtHelper<span class="token punctuation">.</span><span class="token function">AddJwtService</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Services<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>appsettings.json中添加</p> 
<pre><code class="prism language-json">  <span class="token string-property property">"JwtConfig"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"SecretKey"</span><span class="token operator">:</span> <span class="token string">"lisheng741@qq.comlisheng741@qq.com"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Issuer"</span><span class="token operator">:</span> <span class="token string">"WebAppIssuer"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Audience"</span><span class="token operator">:</span> <span class="token string">"WebAppAudience"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Expired"</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token comment">// 过期时间（30min）</span>
  <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_1815"></a>总结</h2> 
<p>Jwt其实也不是特别难，就是第一次配置的时候容易被绕晕。Jwt的策略我暂时先跳过了，对于解决普通问题一般来说已经够用了。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0f2200f3447ded0b0a14617e82722e24/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Topaz Photo AI v2.4.1 （离线模型）人工智能降噪软件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6bad4327ff796bd7d80f9781636fcff3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mac安全干净卸载Anaconda3</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>