<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android模拟蓝牙蓝牙键盘——适配Android和Windows - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/9a1d36d4e5119f5f5f98065d08931b8e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android模拟蓝牙蓝牙键盘——适配Android和Windows">
  <meta property="og:description" content="学校寒假有个程序设计比赛，我也一直想要去写一个安卓模拟的蓝牙键盘，这样无论到哪里，比如班班通和没有键盘的电脑设备，有手机就可以操作它，也比USB方便一些。忙活了一个寒假，也走了不少歪路，终于整成了，下面分享一些经验。
（学校的软件设计比赛已经交了终稿了，我的仓库开源在Gitee和GitHub，求求star：
Gitee：https://gitee.com/FengyunTHU/keyboard
GitHub：https://github.com/FengyunTHU/keyboardOFbluetooth）
自己在写代码的过程中也参考了很多CSDN博客，列举如下：
蓝牙HID——将android设备变成蓝牙键盘（BluetoothHidDevice）
仅通过蓝牙HID将安卓手机模拟成鼠标和键盘
使用旧手检做成蓝牙键盘
CSDN上大佬真的很多！
代码思路 ①第一步是蓝牙HID的初始化 在安卓API28后开放了BluetoothHidDevice类，主要就是用它来完成。首先是注册HID服务：
mBtAdapter.getProfileProxy(context, new BluetoothProfile.ServiceListener() { @Override public void onServiceConnected(int profile, BluetoothProfile proxy) { Log.d(TAG, &#34;onServiceConnected: &#34; &#43; profile); Toast.makeText(context, &#34;Okk_connected_service&#34;, Toast.LENGTH_SHORT).show(); if (profile == BluetoothProfile.HID_DEVICE) { Log.d(TAG, &#34;Proxy received but it isn&#39;t hid_OUT&#34;); if (!(proxy instanceof BluetoothHidDevice)) { Log.e(TAG, &#34;Proxy received but it isn&#39;t hid&#34;); return; } Log.d(TAG,&#34;Connecting HID…&#34;); mHidDevice = (BluetoothHidDevice) proxy; Log.d(TAG, &#34;proxyOK&#34;); BluetoothHidDeviceAppSdpSettings Sdpsettings = new BluetoothHidDeviceAppSdpSettings( HidConfig.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-13T10:51:20+08:00">
    <meta property="article:modified_time" content="2024-04-13T10:51:20+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android模拟蓝牙蓝牙键盘——适配Android和Windows</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>学校寒假有个程序设计比赛，我也一直想要去写一个安卓模拟的蓝牙键盘，这样无论到哪里，比如班班通和没有键盘的电脑设备，有手机就可以操作它，也比USB方便一些。忙活了一个寒假，也走了不少歪路，终于整成了，下面分享一些经验。</p> 
<p>（学校的软件设计比赛已经交了终稿了，我的仓库开源在Gitee和GitHub，求求star：<br> Gitee：<a href="https://gitee.com/FengyunTHU/keyboard" rel="nofollow">https://gitee.com/FengyunTHU/keyboard</a><br> GitHub：<a href="https://github.com/FengyunTHU/keyboardOFbluetooth">https://github.com/FengyunTHU/keyboardOFbluetooth</a>）</p> 
<p>自己在写代码的过程中也参考了很多CSDN博客，列举如下：<br> <a href="https://blog.csdn.net/CJohn1994/article/details/125108065">蓝牙HID——将android设备变成蓝牙键盘（BluetoothHidDevice）</a><br> <a href="https://blog.csdn.net/hurst2011/article/details/105346205">仅通过蓝牙HID将安卓手机模拟成鼠标和键盘</a><br> <a href="https://blog.csdn.net/shenghuang/article/details/130231243">使用旧手检做成蓝牙键盘</a><br> CSDN上大佬真的很多！</p> 
<h3><a id="_12"></a>代码思路</h3> 
<h5><a id="HID_13"></a>①第一步是蓝牙HID的初始化</h5> 
<p>在安卓<b>API28</b>后开放了<b>BluetoothHidDevice</b>类，主要就是用它来完成。首先是注册<strong>HID</strong>服务：</p> 
<pre><code class="prism language-java">mBtAdapter<span class="token punctuation">.</span><span class="token function">getProfileProxy</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BluetoothProfile<span class="token punctuation">.</span>ServiceListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span><span class="token keyword">int</span> profile<span class="token punctuation">,</span> <span class="token class-name">BluetoothProfile</span> proxy<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onServiceConnected: "</span> <span class="token operator">+</span> profile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"Okk_connected_service"</span><span class="token punctuation">,</span> <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token constant">LENGTH_SHORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>profile <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">HID_DEVICE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Proxy received but it isn't hid_OUT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>proxy <span class="token keyword">instanceof</span> <span class="token class-name">BluetoothHidDevice</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Proxy received but it isn't hid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"Connecting HID…"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mHidDevice <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BluetoothHidDevice</span><span class="token punctuation">)</span> proxy<span class="token punctuation">;</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"proxyOK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">BluetoothHidDeviceAppSdpSettings</span> <span class="token class-name">Sdpsettings</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BluetoothHidDeviceAppSdpSettings</span><span class="token punctuation">(</span>
                            <span class="token class-name">HidConfig</span><span class="token punctuation">.</span><span class="token constant">KEYBOARD_NAME</span><span class="token punctuation">,</span>
                            <span class="token class-name">HidConfig</span><span class="token punctuation">.</span><span class="token constant">DESCRIPTION</span><span class="token punctuation">,</span>
                            <span class="token class-name">HidConfig</span><span class="token punctuation">.</span><span class="token constant">PROVIDER</span><span class="token punctuation">,</span>
                            <span class="token class-name">BluetoothHidDevice</span><span class="token punctuation">.</span><span class="token constant">SUBCLASS1_KEYBOARD</span><span class="token punctuation">,</span>
                            <span class="token class-name">HidConfig</span><span class="token punctuation">.</span><span class="token constant">KEYBOARD_COMBO</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mHidDevice <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"OK for HID profile"</span><span class="token punctuation">,</span> <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token constant">LENGTH_SHORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"HID_OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Get in register"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//getPermission();</span>
                        <span class="token comment">// 创建一个BluetoothHidDeviceAppSdpSettings对象</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ActivityCompat</span><span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">BLUETOOTH_CONNECT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">PERMISSION_GRANTED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// TODO: Consider calling</span>
                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"return before register"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                                    <span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">BLUETOOTH_SCAN</span><span class="token punctuation">,</span>
                                    <span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">BLUETOOTH_CONNECT</span>
                            <span class="token punctuation">}</span><span class="token punctuation">;</span>
                            <span class="token function">requestPermissions</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span>list<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token class-name">BluetoothHidDeviceAppQosSettings</span> inQos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BluetoothHidDeviceAppQosSettings</span><span class="token punctuation">(</span>
                                <span class="token class-name">BluetoothHidDeviceAppQosSettings</span><span class="token punctuation">.</span><span class="token constant">SERVICE_GUARANTEED</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span>
                                <span class="token number">10000</span> <span class="token comment">/* 10 ms */</span><span class="token punctuation">,</span> <span class="token number">10000</span> <span class="token comment">/* 10 ms */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">BluetoothHidDeviceAppQosSettings</span> outQos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BluetoothHidDeviceAppQosSettings</span><span class="token punctuation">(</span>
                                <span class="token class-name">BluetoothHidDeviceAppQosSettings</span><span class="token punctuation">.</span><span class="token constant">SERVICE_GUARANTEED</span><span class="token punctuation">,</span> <span class="token number">900</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">900</span><span class="token punctuation">,</span>
                                <span class="token number">10000</span> <span class="token comment">/* 10 ms */</span><span class="token punctuation">,</span> <span class="token number">10000</span> <span class="token comment">/* 10 ms */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mHidDevice<span class="token punctuation">.</span><span class="token function">registerApp</span><span class="token punctuation">(</span><span class="token class-name">Sdpsettings</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// registerApp();// 注册</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"Disable for HID profile"</span><span class="token punctuation">,</span> <span class="token class-name">Toast</span><span class="token punctuation">.</span><span class="token constant">LENGTH_SHORT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 启用设备发现</span>
                    <span class="token comment">// requestLauncher.launch(new Intent(BluetoothAdapter.ACTION_REQUEST_DISCOVERABLE));</span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Discover"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"MissingPermission"</span><span class="token punctuation">)</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span><span class="token keyword">int</span> profile<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 断开连接</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>profile <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">HID_DEVICE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Unexpected Disconnected: "</span> <span class="token operator">+</span> profile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mHidDevice <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    mHidDevice<span class="token punctuation">.</span><span class="token function">unregisterApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">HID_DEVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">BluetoothHidDevice<span class="token punctuation">.</span>Callback</span> mCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BluetoothHidDevice<span class="token punctuation">.</span>Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mMatchingStates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>
                <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">STATE_DISCONNECTED</span><span class="token punctuation">,</span>
                <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">STATE_CONNECTING</span><span class="token punctuation">,</span>
                <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">STATE_CONNECTED</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAppStatusChanged</span><span class="token punctuation">(</span><span class="token class-name">BluetoothDevice</span> pluggedDevice<span class="token punctuation">,</span> <span class="token keyword">boolean</span> registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"ccccc_str"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ActivityCompat</span><span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">android<span class="token punctuation">.</span></span>Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">BLUETOOTH_CONNECT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">PERMISSION_GRANTED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// TODO: Consider calling</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onAppStatusChanged: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>pluggedDevice <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> pluggedDevice<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">"null"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"registered:"</span> <span class="token operator">+</span> registered<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Toast.makeText(context, "onAppStatusChanged", Toast.LENGTH_SHORT).show();</span>
            <span class="token class-name">IsRegisted</span> <span class="token operator">=</span> registered<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 应用已注册</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"register OK!......."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                List&lt;BluetoothDevice&gt; matchingDevices = mHidDevice.getDevicesMatchingConnectionStates(mMatchingStates);</span>
<span class="token comment">//                Log.d(TAG, "paired devices: " + matchingDevices + "  " + mHidDevice.getConnectionState(pluggedDevice));</span>
<span class="token comment">//                Toast.makeText(context, "paired devices: " + matchingDevices + "  " + mHidDevice.getConnectionState(pluggedDevice), Toast.LENGTH_SHORT).show();</span>
<span class="token comment">//                if (pluggedDevice != null &amp;&amp; mHidDevice.getConnectionState(pluggedDevice) != BluetoothProfile.STATE_CONNECTED) {<!-- --></span>
<span class="token comment">//                    boolean result = mHidDevice.connect(pluggedDevice);// pluggedDevice即为连接到模拟HID的设备</span>
<span class="token comment">//                    Log.d(TAG, "hidDevice connect:" + result);</span>
<span class="token comment">//                    Toast.makeText(context, "hidDevice connect:" + result, Toast.LENGTH_SHORT).show();</span>
<span class="token comment">//                } else if (matchingDevices != null &amp;&amp; matchingDevices.size() &gt; 0) {<!-- --></span>
<span class="token comment">//                    // 选择连接的设备</span>
<span class="token comment">//                    mHostDevice = matchingDevices.get(0);// 获得第一个已经配对过的设备</span>
<span class="token comment">//                    Toast.makeText(context, "device_is_ok: " + mHostDevice.getName() + mHostDevice.getAddress(), Toast.LENGTH_SHORT).show();</span>
<span class="token comment">//                } else {<!-- --></span>
<span class="token comment">//                    // 注册成功未配对</span>
<span class="token comment">//                }</span>
            <span class="token punctuation">}</span>
<span class="token comment">//            } else {<!-- --></span>
<span class="token comment">//                // 应用未注册</span>
<span class="token comment">//            }</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onConnectionStateChanged</span><span class="token punctuation">(</span><span class="token class-name">BluetoothDevice</span> device<span class="token punctuation">,</span> <span class="token keyword">int</span> state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"onConnectStateChanged:"</span> <span class="token operator">+</span> device <span class="token operator">+</span> <span class="token string">"  state:"</span> <span class="token operator">+</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Toast.makeText(context, state, Toast.LENGTH_SHORT).show();</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">STATE_CONNECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">// 已经连接了</span>
                connected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                mHostDevice <span class="token operator">=</span> device<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ActivityCompat</span><span class="token punctuation">.</span><span class="token function">checkSelfPermission</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">Manifest</span><span class="token punctuation">.</span>permission<span class="token punctuation">.</span><span class="token constant">BLUETOOTH_CONNECT</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">PERMISSION_GRANTED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// TODO: Consider calling</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"hid state is connected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"-----------------------------------connected HID"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span>device<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Toast.makeText(context, "device_is_ok: " + mHostDevice.getName() + mHostDevice.getAddress(), Toast.LENGTH_SHORT).show();</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">STATE_DISCONNECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                connected <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"hid state is disconnected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// mHostDevice = null;</span>
                <span class="token comment">// Toast.makeText(context, "device_is_null", Toast.LENGTH_SHORT).show();</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token class-name">BluetoothProfile</span><span class="token punctuation">.</span><span class="token constant">STATE_CONNECTING</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"hid state is connecting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>在<code>mBtAdapter.getProfileProxy()</code>中注册，其中<code>onServiceConnected()</code>会在开始注册时调用，其中的<code>mHidDevice.registerApp()</code>就是注册采用的方法，提供的<code>SdpSettings</code>是最主要的的<strong>HID</strong>描述，其中定义一系列常量用于描述模拟的<strong>HID设备</strong>。<br> 进行注册时会有一个回调<code>mCallback</code>，<code>onAppStatusChanged()</code>调用在注册成功，<code>onConnectStateChanged()</code>则是在<strong>蓝牙连接状态</strong>改变时调用，如<strong>连接上、断开、正在连接</strong>，其中的日志可以反应蓝牙连接的状态。<br> <strong>注意注册HID时，蓝牙必须处于打开状态。打开蓝牙的代码我暂未编写。</strong></p> 
<h5><a id="_153"></a>②发起蓝牙连接</h5> 
<p>在发起连接上，我试了<strong>从电脑端发起连接、从手机端发起连接</strong>，而且使用的都是<strong>点进系统蓝牙列表</strong>的方式，均无法建立稳定连接。<br> 后来看到大佬文章，解决了这个问题，即使用<strong>代理连接：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"MissingPermission"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">ConnectotherBluetooth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        mHostDevice <span class="token operator">=</span> mBtAdapter<span class="token punctuation">.</span><span class="token function">getRemoteDevice</span><span class="token punctuation">(</span><span class="token string">"B4:8C:9D:AD:9B:9A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mHostDevice<span class="token operator">!=</span><span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"Connected is OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span>mHostDevice<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mHidDevice<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>mHostDevice<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 代理连接</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>只要把<strong>mac</strong>地址改成所想要连接的蓝牙设备的<strong>mac</strong>即可。电脑可以采用<strong>cmd指令</strong><code>ipconfig /all</code>，拉到最底即可；手机使用<strong>adb</strong>连接后，输入指令<code>adb shell settings get secure bluetooth_address</code>即可。当然也可以直接扫描，但我目前还未完成相关代码。</p> 
<h5><a id="_168"></a>③发送报告</h5> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@JavascriptInterface</span>
    <span class="token annotation punctuation">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"MissingPermission"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">byte</span> b1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">char</span> keychar <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keychar<span class="token operator">&gt;=</span><span class="token number">65</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>keychar<span class="token operator">&lt;=</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                b1 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>keyMap<span class="token punctuation">.</span><span class="token constant">SHITBYTE</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            b1 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"pre_send: "</span><span class="token operator">+</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mHidDevice<span class="token punctuation">.</span><span class="token function">sendReport</span><span class="token punctuation">(</span>mHostDevice<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>
                b1<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>keyMap<span class="token punctuation">.</span><span class="token constant">KEY2BYTE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHidDevice<span class="token punctuation">.</span><span class="token function">sendReport</span><span class="token punctuation">(</span>mHostDevice<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>
                <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这是松开按键的报告</span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"after_send: "</span><span class="token operator">+</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>发送报告使用<code>sendReport()</code>，发送对应<strong>ID</strong>和<strong>字节</strong>的报告即可。</p> 
<h5><a id="API_196"></a>整体写完其实代码量并不多，但是前期对API的研究还是挺费时间的。</h5> 
<h4><a id="font_colorredfont_197"></a><font color="red">完成代码后，耗时间的还有一些配置：</font></h4> 
<h5><a id="HidConfigjavaHID_198"></a>①<code>HidConfig.java</code>——HID配置文件</h5> 
<p>这玩意在安卓上适配都挺好，但Windows上会有一些问题。我自己找了一版描述符，目前是正常的（也是在GitHub上找的）：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HidConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">KEYBOARD_NAME</span> <span class="token operator">=</span> <span class="token string">"My Keyboard"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">DESCRIPTION</span> <span class="token operator">=</span> <span class="token string">"KKKey"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">PROVIDER</span> <span class="token operator">=</span> <span class="token string">"Alphabet"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">byte</span> <span class="token constant">ID_KEYBOARD</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// HID码表【不知道干啥的】</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">KEYBOARD_COMBO</span> <span class="token operator">=</span>
        <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x01</span><span class="token punctuation">,</span>                         <span class="token comment">// Usage Page (Generic Desktop)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x06</span><span class="token punctuation">,</span>                         <span class="token comment">// Usage (Keyboard)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0xA1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x01</span><span class="token punctuation">,</span>                         <span class="token comment">// Collection (Application)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x85</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x08</span><span class="token punctuation">,</span>                         <span class="token comment">//   REPORT_ID (Keyboard)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x07</span><span class="token punctuation">,</span>                         <span class="token comment">//   Usage Page (Key Codes)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x19</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0xE0</span><span class="token punctuation">,</span>                         <span class="token comment">//   Usage Minimum (224)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x29</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0xE7</span><span class="token punctuation">,</span>                         <span class="token comment">//   Usage Maximum (231)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x00</span><span class="token punctuation">,</span>                         <span class="token comment">//   Logical Minimum (0)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x25</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x01</span><span class="token punctuation">,</span>                         <span class="token comment">//   Logical Maximum (1)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x01</span><span class="token punctuation">,</span>                         <span class="token comment">//   Report Size (1)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x08</span><span class="token punctuation">,</span>                         <span class="token comment">//   Report Count (8)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x02</span><span class="token punctuation">,</span>                         <span class="token comment">//   Input (Data, Variable, Absolute)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x01</span><span class="token punctuation">,</span>                         <span class="token comment">//   Report Count (1)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x08</span><span class="token punctuation">,</span>                         <span class="token comment">//   Report Size (8)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x01</span><span class="token punctuation">,</span>                         <span class="token comment">//   Input (Constant) reserved byte(1)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x05</span><span class="token punctuation">,</span>                         <span class="token comment">//   Report Count (5)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x01</span><span class="token punctuation">,</span>                         <span class="token comment">//   Report Size (1)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x08</span><span class="token punctuation">,</span>                         <span class="token comment">//   Usage Page (Page# for LEDs)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x19</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x01</span><span class="token punctuation">,</span>                         <span class="token comment">//   Usage Minimum (1)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x29</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x05</span><span class="token punctuation">,</span>                         <span class="token comment">//   Usage Maximum (5)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x91</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x02</span><span class="token punctuation">,</span>                         <span class="token comment">//   Output (Data, Variable, Absolute), Led report</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x01</span><span class="token punctuation">,</span>                         <span class="token comment">//   Report Count (1)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x03</span><span class="token punctuation">,</span>                         <span class="token comment">//   Report Size (3)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x91</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x01</span><span class="token punctuation">,</span>                         <span class="token comment">//   Output (Data, Variable, Absolute), Led report padding</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x95</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x06</span><span class="token punctuation">,</span>                         <span class="token comment">//   Report Count (6)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x08</span><span class="token punctuation">,</span>                         <span class="token comment">//   Report Size (8)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x15</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x00</span><span class="token punctuation">,</span>                         <span class="token comment">//   Logical Minimum (0)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x25</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x65</span><span class="token punctuation">,</span>                         <span class="token comment">//   Logical Maximum (101)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x07</span><span class="token punctuation">,</span>                         <span class="token comment">//   Usage Page (Key codes)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x19</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x00</span><span class="token punctuation">,</span>                         <span class="token comment">//   Usage Minimum (0)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x29</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x65</span><span class="token punctuation">,</span>                         <span class="token comment">//   Usage Maximum (101)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0x00</span><span class="token punctuation">,</span>                         <span class="token comment">//   Input (Data, Array) Key array(6 bytes)</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0xC0</span>                                       <span class="token comment">// End Collection (Application)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>也确实尝试了很多版，这版可以。但需要注意其中的<code>(byte) 0x85, (byte) 0x08, // REPORT_ID (Keyboard)</code>反映了报告的<strong>ID = 8</strong>，需要和<strong>report</strong>中的相对应，如：</p> 
<pre><code class="prism language-java">mHidDevice<span class="token punctuation">.</span><span class="token function">sendReport</span><span class="token punctuation">(</span>mHostDevice<span class="token punctuation">,</span><span class="token comment">/*ID = 8*/</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>
                <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这是松开按键的报告</span>
</code></pre> 
<h4><a id="Windows_252"></a>②Windows上的适配</h4> 
<p>实际测试发现，Android适配很好，但Windows总是没反应，也困扰了我很长时间。<br> 后来使用<strong>Wireshark</strong>对蓝牙抓包，发现安卓是这样的：<br> <img src="https://images2.imgbox.com/bc/69/648ly7X8_o.png" alt="安卓直接成功"><br> 而Windows总是这样：<br> <img src="https://images2.imgbox.com/67/e6/rhjy0UUe_o.png" alt="在这里插入图片描述"><br> 显示正在<strong>Pending</strong>，无法直接success；而且相同<strong>SCID</strong>的request最后会以<strong>PSM not support</strong>请求失败。<strong>HID-Control</strong>对应的PSM是<strong>0x0011</strong>。<br> 在<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/bluetooth/accepting-l2cap-connections-in-a-bluetooth-profile-driver" rel="nofollow">Windows开发文档</a>上看到了以下：</p> 
<blockquote> 
 <h4><a id="_L2CAP__260"></a>接收传入 L2CAP 连接请求</h4> 
 <p>若要接收来自特定 PSM 的任何远程设备的传入 L2CAP 连接请求，配置文件驱动程序应首先生成并发送 BRB_L2CA_REGISTER_标准版RVER 请求，并在请求的 _BRB_L2CA_REGISTER_标准版RVER 结构的 Psm 成员中指定 NULL，并在请求的 _BRB_L2CA_REGISTER_标准版RVER 结构的 Psm 成员中指定 NULL。 发送 BRB_L2CA_REGISTER_标准版RVER 请求时，配置文件驱动程序还必须向蓝牙驱动程序堆栈注册 L2CAP 回调函数。 这使蓝牙驱动程序堆栈能够通知配置文件驱动程序传入 L2CAP 连接请求。<br> 然后，配置文件驱动程序应生成并发送BRB_REGISTER_PSM请求，以便蓝牙驱动程序堆栈将接受请求注册的 PSM 的连接。 否则，蓝牙驱动程序堆栈将拒绝具有未知（未注册）连接请求的所有连接请求。 有关 PSM 的详细信息，请参阅 _BRB_PSM 结构。</p> 
</blockquote> 
<p>所以就感觉是不是<strong>驱动</strong>的问题。最后下载更新<b><a href="https://downloadmirror.intel.com/816424/BT-23.30.0-64UWD-Win10-Win11.exe" rel="nofollow">最新版的蓝牙驱动</a></b>即可。注意更新完后要重启。<br> 于是问题就解决了。抓包结果是，虽然也不是立刻success，但是最后依然请求成功。这估计是因为Windows多了以上的请求过程机制。</p> 
<h4><a id="_266"></a>④一些连接问题</h4> 
<ul><li><strong>不要在手机或电脑的系统列表中点击设备进行连接。</strong> 直接在模拟键盘端使用<code>connect()</code>的代理连接即可，直接连到mac地址；</li><li>需要两个设备提前配对。当然在发起连接的过程中配对也可以。如果无法连接，<strong>尝试删除设备后在重新配对连接；</strong></li><li><strong>iOS</strong>和<strong>Mac</strong>系统，因为我没有对应的设备，没有进行测试。不过也可以参考我参考文章中的第二篇；</li><li>注意到很容易断开连接。所以可能需要在断开时控制继续连上。<strong>测试下来继续连接的用时是很短的</strong>。</li></ul> 
<p><strong>所有代码开源在<a href="https://gitee.com/FengyunTHU/keyboard" rel="nofollow">Gitee仓库keyboard</a>。笔者不是计算机专业的学生，甚至所学专业相差甚远；作为在校大学生，时间也十分有限，Java也是边写边学的，代码格式不规范有劳大家谅解。</strong></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/90865ce691ac62add18caf9b4b58c6de/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【BlueDroid】蓝牙音乐协议分析之A2DP和AVRCP连接流程（超详细）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/be54b146b460356450922943134f25cc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Kafka 实战 - SpringBoot 中使用@KafkaListener详解与使用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>