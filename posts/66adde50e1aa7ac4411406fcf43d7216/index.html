<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【JS】前端分片上传大文件（支持1G以上的超大文件） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/66adde50e1aa7ac4411406fcf43d7216/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【JS】前端分片上传大文件（支持1G以上的超大文件）">
  <meta property="og:description" content="目录 什么时候需要分片上传？分片上传流程获取文件专属MD5码接口1：传MD5码获取该文件已上传的片数接口2：将文件分片成promise请求数组promise请求数组做线程池限制处理 p-limit接口3：promise.all执行结束后，请求一个是否合并成功的接口完整主函数待优化的地方: 使用Web Workers进行分片上传 什么时候需要分片上传？ 如果将大文件一次性上传，耗时会非常长，甚至可能传输失败，那么我们怎么解决这个问题呢？既然大文件上传不适合一次性上传，那么我们可以尝试将文件分片散上传。
这样的技术就叫做分片上传。分片上传就是将大文件分成一个个小文件（切片），将切片进行上传，等到后端接收到所有切片，再将切片合并成大文件。通过将大文件拆分成多个小文件进行上传，确实就是解决了大文件上传的问题。因为请求时可以并发执行的，这样的话每个请求时间就会缩短，如果某个请求发送失败，也不需要全部重新发送。
分片上传流程 Created with Raphaël 2.3.0 开始 获取文件专属MD5码 接口1：传MD5码获取该文件已上传的片数 将文件分片成promise请求数组 promise请求数组做线程池限制处理 接口2：promise.all并发发送异步请求上传文件分片 接口3：promise.all执行结束后，请求一个是否合并成功的接口 结束 获取文件专属MD5码 import sparkMD5 from &#39;spark-md5&#39; // 安装下spark-md5包 // 定义hash函数，接受一个名为chunks的数组作为参数 hash = (chunks) =&gt; { // 返回一个Promise，这样调用者可以使用.then()或async/await来处理结果 return new Promise((resolve) =&gt; { // 创建一个新的sparkMD5实例，用于计算MD5哈希值 const spark = new sparkMD5(); // 定义一个递归函数_read，用于逐个处理chunks数组中的blob function _read(i) { // 如果索引i大于等于chunks数组的长度，说明所有blob都已经处理完毕 if (i &gt;= chunks.length) { // 调用sparkMD5实例的end方法，并传入resolve回调，以返回最终的哈希值 resolve(spark.end()); return; // 读取完成，退出函数 } // 获取当前索引i对应的blob const blob = chunks[i]; // 创建一个新的FileReader实例，用于读取blob的内容 const reader = new FileReader(); // 设置FileReader的onload事件处理函数，当blob内容读取完成后调用 reader.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-15T13:25:13+08:00">
    <meta property="article:modified_time" content="2024-03-15T13:25:13+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【JS】前端分片上传大文件（支持1G以上的超大文件）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">什么时候需要分片上传？</a></li><li><a href="#_5" rel="nofollow">分片上传流程</a></li><li><a href="#MD5_21" rel="nofollow">获取文件专属MD5码</a></li><li><a href="#1MD5_76" rel="nofollow">接口1：传MD5码获取该文件已上传的片数</a></li><li><a href="#2promise_82" rel="nofollow">接口2：将文件分片成promise请求数组</a></li><li><a href="#promise_plimit_123" rel="nofollow">promise请求数组做线程池限制处理 p-limit</a></li><li><a href="#3promiseall_142" rel="nofollow">接口3：promise.all执行结束后，请求一个是否合并成功的接口</a></li><li><a href="#_152" rel="nofollow">完整主函数</a></li><li><a href="#_Web_Workers_172" rel="nofollow">待优化的地方: 使用Web Workers进行分片上传</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>什么时候需要分片上传？</h2> 
<p>       如果将大文件一次性上传，<mark>耗时会非常长，甚至可能传输失败</mark>，那么我们怎么解决这个问题呢？既然大文件上传不适合一次性上传，那么我们可以尝试将文件分片散上传。<br> 这样的技术就叫做分片上传。分片上传就是将大文件分成一个个小文件（切片），将切片进行上传，等到后端接收到所有切片，再将切片<mark>合并成大文件</mark>。通过将大文件拆分成多个小文件进行上传，确实就是解决了大文件上传的问题。因为请求时可以<mark>并发执行的</mark>，这样的话每个请求时间就会缩短，如果某个请求发送失败，也不需要全部重新发送。</p> 
<h2><a id="_5"></a>分片上传流程</h2> 
<div class="mermaid sequence-diagram flow-chart"> 
 <svg height="677" version="1.1" width="413.29296875" xmlns="http://www.w3.org/2000/svg" style="overflow: hidden; position: relative;" viewbox="0 0 413.29296875 677" preserveaspectratio="xMidYMid meet"> 
  <desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
    Created with Raphaël 2.3.0 
  </desc> 
  <defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
   <marker id="raphael-marker-endblock33-obj08l2d" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-obj986c0" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objiwsmw" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objecltv" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-obj8kiwr" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objhjhbv" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objdrobd" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
  </defs> 
  <rect x="0" y="0" width="50.249996185302734" height="38.75" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="st" transform="matrix(1,0,0,1,182.0215,2)"></rect> 
  <text x="10" y="19.375" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="stt" class="flowchartt" transform="matrix(1,0,0,1,182.0215,2)" stroke-width="1"> 
   <tspan dy="5.625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     开始 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="151.81640625" height="38.75" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="op1" transform="matrix(1,0,0,1,131.2383,92.75)"></rect> 
  <text x="10" y="19.375" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op1t" class="flowchartt" transform="matrix(1,0,0,1,131.2383,92.75)" stroke-width="1"> 
   <tspan dy="5.625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     获取文件专属MD5码 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="287.0126037597656" height="38.75" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="op2" transform="matrix(1,0,0,1,63.6402,183.5)"></rect> 
  <text x="10" y="19.375" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op2t" class="flowchartt" transform="matrix(1,0,0,1,63.6402,183.5)" stroke-width="1"> 
   <tspan dy="5.625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     接口1：传MD5码获取该文件已上传的片数 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="216.50672912597656" height="38.75" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="op3" transform="matrix(1,0,0,1,98.8931,274.25)"></rect> 
  <text x="10" y="19.375" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op3t" class="flowchartt" transform="matrix(1,0,0,1,98.8931,274.25)" stroke-width="1"> 
   <tspan dy="5.625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     将文件分片成promise请求数组 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="243.2567138671875" height="38.75" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="op4" transform="matrix(1,0,0,1,85.5181,365)"></rect> 
  <text x="10" y="19.375" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op4t" class="flowchartt" transform="matrix(1,0,0,1,85.5181,365)" stroke-width="1"> 
   <tspan dy="5.625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     promise请求数组做线程池限制处理 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="341.2762145996094" height="38.75" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="op5" transform="matrix(1,0,0,1,36.5084,455.75)"></rect> 
  <text x="10" y="19.375" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op5t" class="flowchartt" transform="matrix(1,0,0,1,36.5084,455.75)" stroke-width="1"> 
   <tspan dy="5.625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     接口2：promise.all并发发送异步请求上传文件分片 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="410.29296875" height="38.75" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="op6" transform="matrix(1,0,0,1,2,546.5)"></rect> 
  <text x="10" y="19.375" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op6t" class="flowchartt" transform="matrix(1,0,0,1,2,546.5)" stroke-width="1"> 
   <tspan dy="5.625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     接口3：promise.all执行结束后，请求一个是否合并成功的接口 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="50.249996185302734" height="38.75" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="e" transform="matrix(1,0,0,1,182.0215,637.25)"></rect> 
  <text x="10" y="19.375" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="et" class="flowchartt" transform="matrix(1,0,0,1,182.0215,637.25)" stroke-width="1"> 
   <tspan dy="5.625" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     结束 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M207.146484375,40.75C207.146484375,40.75,207.146484375,82.723876953125,207.146484375,91.24982070922852" stroke-width="1" marker-end="url(#raphael-marker-endblock33-obj08l2d)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M207.146484375,131.5C207.146484375,131.5,207.146484375,173.473876953125,207.146484375,181.99982070922852" stroke-width="1" marker-end="url(#raphael-marker-endblock33-obj986c0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M207.146484375,222.25C207.146484375,222.25,207.146484375,264.223876953125,207.146484375,272.7498207092285" stroke-width="1" marker-end="url(#raphael-marker-endblock33-objiwsmw)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M207.146484375,313C207.146484375,313,207.146484375,354.973876953125,207.146484375,363.4998207092285" stroke-width="1" marker-end="url(#raphael-marker-endblock33-objecltv)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M207.146484375,403.75C207.146484375,403.75,207.146484375,445.723876953125,207.146484375,454.2498207092285" stroke-width="1" marker-end="url(#raphael-marker-endblock33-obj8kiwr)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M207.146484375,494.5C207.146484375,494.5,207.146484375,536.473876953125,207.146484375,544.9998207092285" stroke-width="1" marker-end="url(#raphael-marker-endblock33-objhjhbv)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M207.146484375,585.25C207.146484375,585.25,207.146484375,627.223876953125,207.146484375,635.7498207092285" stroke-width="1" marker-end="url(#raphael-marker-endblock33-objdrobd)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
 </svg> 
</div> 
<h2><a id="MD5_21"></a>获取文件专属MD5码</h2> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> sparkMD5 <span class="token keyword">from</span> <span class="token string">'spark-md5'</span> <span class="token comment">// 安装下spark-md5包</span>
</code></pre> 
<pre><code class="prism language-javascript"><span class="token comment">// 定义hash函数，接受一个名为chunks的数组作为参数</span>
<span class="token function-variable function">hash</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunks</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 返回一个Promise，这样调用者可以使用.then()或async/await来处理结果</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建一个新的sparkMD5实例，用于计算MD5哈希值</span>
    <span class="token keyword">const</span> spark <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">sparkMD5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义一个递归函数_read，用于逐个处理chunks数组中的blob</span>
    <span class="token keyword">function</span> <span class="token function">_read</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 如果索引i大于等于chunks数组的长度，说明所有blob都已经处理完毕</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> chunks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 调用sparkMD5实例的end方法，并传入resolve回调，以返回最终的哈希值</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>spark<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 读取完成，退出函数</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 获取当前索引i对应的blob</span>
      <span class="token keyword">const</span> blob <span class="token operator">=</span> chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 创建一个新的FileReader实例，用于读取blob的内容</span>
      <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 设置FileReader的onload事件处理函数，当blob内容读取完成后调用</span>
      reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从事件对象e中获取读取到的字节数组</span>
        <span class="token keyword">const</span> bytes <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>result<span class="token punctuation">;</span>

        <span class="token comment">// 将字节数组添加到sparkMD5实例中，用于计算哈希值</span>
        spark<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 递归调用_read函数，处理下一个blob</span>
        <span class="token function">_read</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">// 以ArrayBuffer格式异步读取当前blob的内容</span>
      reader<span class="token punctuation">.</span><span class="token function">readAsArrayBuffer</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里是读取操作开始的地方</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 从索引0开始，调用_read函数，处理chunks数组中的第一个blob</span>
    <span class="token function">_read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>解析：<br>        在这个函数中，_read 函数是一个递归函数，它会逐个处理 chunks 数组中的每个 blob。对于每个 blob，它使用 FileReader 的 readAsArrayBuffer 方法异步读取内容，并在内容读取完成后通过 onload 事件处理函数将读取到的字节数组添加到 sparkMD5 实例中。当所有 blob 都处理完毕后，sparkMD5 实例的 end 方法被调用，并返回最终的哈希值，这个值随后通过Promise的 resolve 方法传递给调用者。</p> 
<p>       在这个函数中，当用户选择一个文件后，readAsArrayBuffer开始异步读取文件内容。一旦文件内容被读取并转换为ArrayBuffer，onload事件处理程序就会被调用，你可以在这个事件处理程序中访问到ArrayBuffer对象，并对其进行处理。<mark>ArrayBuffer对象代表原始的二进制数据</mark></p> 
<h2><a id="1MD5_76"></a>接口1：传MD5码获取该文件已上传的片数</h2> 
<p>调用上面的方法hash()</p> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> md5Str <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>chunksList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 这里写发送md5Str【接口1】 的方法，获取已上传片数 */</span>
</code></pre> 
<h2><a id="2promise_82"></a>接口2：将文件分片成promise请求数组</h2> 
<p>1.文件分片</p> 
<pre><code class="prism language-javascript"><span class="token function-variable function">chunkFile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> chunksize</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">const</span> chunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size <span class="token operator">/</span> chunksize<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">const</span> chunksList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
    <span class="token keyword">let</span> currentChunk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">while</span> <span class="token punctuation">(</span>currentChunk <span class="token operator">&lt;</span> chunks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">const</span> start <span class="token operator">=</span> currentChunk <span class="token operator">*</span> chunksize<span class="token punctuation">;</span>  
        <span class="token keyword">const</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>size<span class="token punctuation">,</span> start <span class="token operator">+</span> chunksize<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">const</span> chunk <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        chunksList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        currentChunk<span class="token operator">++</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> chunksList<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>2.封装成promise请求</p> 
<pre><code class="prism language-javascript"><span class="token function-variable function">chunkPromise</span> <span class="token operator">=</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//每个分片的请求</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span> 
		<span class="token comment">/* 这里写上传的 【接口2】，传data过去*/</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
		message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
	 <span class="token keyword">const</span> promiseList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
	 <span class="token keyword">const</span> chunkList <span class="token operator">=</span> <span class="token function">chunkFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
	 chunkList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
	 <span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	 formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span>
	 <span class="token comment">// limit是线程池组件 后面会写</span>
	 promiseList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">chunkPromise</span><span class="token punctuation">(</span>formData<span class="token punctuation">,</span> chunks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


  
</code></pre> 
<h2><a id="promise_plimit_123"></a>promise请求数组做线程池限制处理 p-limit</h2> 
<p>p-limit npm 包是一个实用工具，它允许你限制同时运行的 Promise 数量。当你拥有可以在并行中运行的操作，但由于资源限制想要限制这些操作的数量时，这个工具就很有用，有助于控制并发性。<br> <a href="https://socket.dev/npm/package/p-limit" rel="nofollow">p-limit npm地址</a><br> 官方案例：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> pLimit <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'p-limit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> limit <span class="token operator">=</span> <span class="token function">pLimit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> input <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fetchSomething</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fetchSomething</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Only two promises will run at once, the rest will be queued</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">results</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="3promiseall_142"></a>接口3：promise.all执行结束后，请求一个是否合并成功的接口</h2> 
<pre><code class="prism language-javascript">	Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promiseList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 这里写接口3 问后端是否合并成功了</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
		message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_152"></a>完整主函数</h2> 
<p>分片大小建议不超过最大不超过5M</p> 
<pre><code class="prism language-javascript"><span class="token keyword">const</span> md5Str <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>chunksList<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 这里写发送md5Str【接口1】 的方法，获取已上传片数 */</span>
<span class="token keyword">const</span> promiseList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> chunkList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">chunkFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
chunkList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> formData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	formData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span>
	promiseList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">chunkPromise</span><span class="token punctuation">(</span>formData<span class="token punctuation">,</span> chunks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 【接口2 在this.chunkPromise里】</span>
<span class="token punctuation">}</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promiseList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 这里写【接口3】 问后端是否合并成功了</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
		message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_Web_Workers_172"></a>待优化的地方: 使用Web Workers进行分片上传</h2> 
<p>Web Workers在后台线程中运行，它们不会阻塞主线程，这意味着主线程可以继续响应用户的操作，如界面渲染和交互。在分片上传过程中，每个文件块可以在单独的Worker中处理，从而实现并行处理，大大提高了上传速度。同时，由于Worker不会与主线程共享内存，因此可以避免内存竞争和阻塞，进一步提升了性能。<br> 【感兴趣的读者可以尝试一下】</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e6c9f658110c2a99d7c1d7e2a4a2a372/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【SQL注入】Sqlmap使用指南(手把手保姆版)持续更新</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1d53e6c0ce78dffd4fc53003dc72fe87/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">SpringBoot3整合Knife4j之保姆级教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>