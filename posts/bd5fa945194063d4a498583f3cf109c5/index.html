<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RabbitMQ定义的MQ多个consumer重复消费同一条消息 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/bd5fa945194063d4a498583f3cf109c5/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="RabbitMQ定义的MQ多个consumer重复消费同一条消息">
  <meta property="og:description" content="RabbitMQ定义的MQ多个consumer重复消费同一条消息 @author:shengfq
@date:2024-07-09
@category: 数据一致性
@title:RabbitMQ定义的MQ多个consumer重复消费同一条消息
系统环境 direct类型的Exchange,通过routingKey:START/CONFORM绑定到业务队列Queue: START queue.xxx.qm.operationStart 工序开工质量监听队列 CONFORM queue.xxx.qm.operationEnd 工序完工质量监听队列 由于有多个qm服务实例,都监听了上述的queue,所以就有多个consumer. 问题描述 【2010工厂，生产环境，订单数据】 订单号 880006861916 订单状态 130-在制 订单类型 ZF01-成品订单 物料编码 130901000711B 同一个订单同一个工序生成了2个任务（检验计划里面也只有一个工序的检验规格呢） [图片] TKE日志如下,基本上通过requestId可以判断是同一条消息被多个consumer消费了.
2024-07-05 10:41:10projectitrcp20220217183240276namespacekhoros-mom-prodpodmom-service-qm-9a049-7665f4899b-62sxdpathstdoutlog_data2024-07-05 10:41:10.765 [TID: N/A] WARN [-,,,] 1 --- [Executor-128574] c.s.m.q.t.s.h.OperationStartReceiver : OperationStartReceiver msg：{&#34;oprName&#34;:&#34;打胶-玻璃装配&#34;,&#34;scrappedQuantity&#34;:0,&#34;materialNo&#34;:&#34;130901000711B&#34;,&#34;wipOrderNo&#34;:&#34;880006861916&#34;,&#34;oprSequenceNo&#34;:&#34;0041&#34;,&#34;goodQuantity&#34;:0,&#34;operationWorkStationName&#34;:&#34;打胶-玻璃装配&#34;,&#34;standOprName&#34;:&#34;人工组装&#34;,&#34;wipOrderOperationId&#34;:596309434920902660,&#34;requestId&#34;:&#34;2b7eaabea93843dcb9bf6838f8da1ca3&#34;,&#34;workCenterId&#34;:579597295600041993,&#34;progressStatus&#34;:130,&#34;facilityCode&#34;:&#34;2010&#34;,&#34;facilityId&#34;:571301815799623680,&#34;operationWorkStationCode&#34;:&#34;2010JS01A0002&#34;,&#34;completeSystem&#34;:&#34;IMOM&#34;,&#34;operationWorkStationId&#34;:579600364052193290,&#34;orderPlanQuantity&#34;:1,&#34;materialId&#34;:575618864008929280,&#34;creationDate&#34;:1720147195174,&#34;workCenterCode&#34;:&#34;303910&#34;,&#34;wipOrderId&#34;:596309434912514048,&#34;createdBy&#34;:39020,&#34;workType&#34;:0,&#34;tenantId&#34;:2,&#34;operationType&#34;:&#34;START&#34;,&#34;standSequenceNo&#34;:&#34;ZP00009&#34;,&#34;oprSerialNo&#34;:&#34;000000&#34;} UserDetails：CustomUserDetails{userId=39020, username=hecf6, realName=&#39;何超锋&#39;, email=&#39;null&#39;, timeZone=&#39;null&#39;, language=&#39;zh_CN&#39;, roleId=null, roleIds=null, siteRoleIds=null, tenantRoleIds=null, roleMergeFlag=null, tenantId=2, tenantNum=&#39;null&#39;, tenantIds=null, imageUrl=&#39;null&#39;, organizationId=2, isAdmin=null, clientId=null, clientName=&#39;null&#39;, clientAuthorizedGrantTypes=null, clientResourceIds=null, clientScope=null, clientRegisteredRedirectUri=null, clientAccessTokenValiditySeconds=null, clientRefreshTokenValiditySeconds=null, clientAutoApproveScopes=null, additionInfo={&#34;facility_ids&#34;:&#34;571301815799623680&#34;,&#34;employee_no&#34;:&#34;80033656&#34;,&#34;account_no&#34;:&#34;hecf6&#34;,&#34;facility_name&#34;:&#34;2010-华湘工厂&#34;,&#34;facility_no&#34;:&#34;2010&#34;,&#34;facility_id&#34;:&#34;571301815799623680&#34;,&#34;phone_number&#34;:&#34;15062676297&#34;,&#34;domain_account&#34;:&#34;hecf6&#34;}, apiEncryptFlag=null, apiReplayFlag=null, menuIdFlag=null, roleLabels=&#39;null} 2024-07-05 10:41:10projectitrcp20220217183240276namespacekhoros-mom-prodpodmom-service-qm-9a049-7665f4899b-62sxdpathstdoutlog_data2024-07-05 10:41:10.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-09T23:41:50+08:00">
    <meta property="article:modified_time" content="2024-07-09T23:41:50+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RabbitMQ定义的MQ多个consumer重复消费同一条消息</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="RabbitMQMQconsumer_0"></a>RabbitMQ定义的MQ多个consumer重复消费同一条消息</h3> 
<p>@author:shengfq<br> @date:2024-07-09<br> @category: 数据一致性<br> @title:RabbitMQ定义的MQ多个consumer重复消费同一条消息</p> 
<h6>系统环境</h6> direct类型的Exchange,通过routingKey:START/CONFORM绑定到业务队列Queue: START queue.xxx.qm.operationStart 工序开工质量监听队列 CONFORM queue.xxx.qm.operationEnd 工序完工质量监听队列 由于有多个qm服务实例,都监听了上述的queue,所以就有多个consumer. 
<h6>问题描述</h6> 【2010工厂，生产环境，订单数据】 订单号 880006861916 订单状态 130-在制 订单类型 ZF01-成品订单 物料编码 130901000711B 同一个订单同一个工序生成了2个任务（检验计划里面也只有一个工序的检验规格呢） [图片] 
<p>TKE日志如下,基本上通过requestId可以判断是同一条消息被多个consumer消费了.</p> 
<pre><code>
2024-07-05 10:41:10projectitrcp20220217183240276namespacekhoros-mom-prodpodmom-service-qm-9a049-7665f4899b-62sxdpathstdoutlog_data2024-07-05 10:41:10.765 [TID: N/A] WARN [-,,,] 1 --- [Executor-128574] c.s.m.q.t.s.h.OperationStartReceiver : OperationStartReceiver msg：{"oprName":"打胶-玻璃装配","scrappedQuantity":0,"materialNo":"130901000711B","wipOrderNo":"880006861916","oprSequenceNo":"0041","goodQuantity":0,"operationWorkStationName":"打胶-玻璃装配","standOprName":"人工组装","wipOrderOperationId":596309434920902660,"requestId":"2b7eaabea93843dcb9bf6838f8da1ca3","workCenterId":579597295600041993,"progressStatus":130,"facilityCode":"2010","facilityId":571301815799623680,"operationWorkStationCode":"2010JS01A0002","completeSystem":"IMOM","operationWorkStationId":579600364052193290,"orderPlanQuantity":1,"materialId":575618864008929280,"creationDate":1720147195174,"workCenterCode":"303910","wipOrderId":596309434912514048,"createdBy":39020,"workType":0,"tenantId":2,"operationType":"START","standSequenceNo":"ZP00009","oprSerialNo":"000000"} UserDetails：CustomUserDetails{userId=39020, username=hecf6, realName='何超锋', email='null', timeZone='null', language='zh_CN', roleId=null, roleIds=null, siteRoleIds=null, tenantRoleIds=null, roleMergeFlag=null, tenantId=2, tenantNum='null', tenantIds=null, imageUrl='null', organizationId=2, isAdmin=null, clientId=null, clientName='null', clientAuthorizedGrantTypes=null, clientResourceIds=null, clientScope=null, clientRegisteredRedirectUri=null, clientAccessTokenValiditySeconds=null, clientRefreshTokenValiditySeconds=null, clientAutoApproveScopes=null, additionInfo={"facility_ids":"571301815799623680","employee_no":"80033656","account_no":"hecf6","facility_name":"2010-华湘工厂","facility_no":"2010","facility_id":"571301815799623680","phone_number":"15062676297","domain_account":"hecf6"}, apiEncryptFlag=null, apiReplayFlag=null, menuIdFlag=null, roleLabels='null}

2024-07-05 10:41:10projectitrcp20220217183240276namespacekhoros-mom-prodpodmom-service-qm-9a049-7665f4899b-62sxdpathstdoutlog_data2024-07-05 10:41:10.766 [TID: N/A] INFO [-,,,] 1 --- [Executor-128574] .s.i.BaseInspectionTaskCreateServiceImpl : 开始创建检验任务: wipOrderNo:880006861916 materialNo:130901000711B type:01,02,04

2024-07-05 10:41:11projectitrcp20220217183240276namespacekhoros-mom-prodpodmom-service-qm-9a049-7665f4899b-jpxkbpathstdoutlog_data2024-07-05 10:41:10.783 [TID: N/A] INFO [-,,,] 1 --- [Executor-130591] i.InspectionTaskCreateServiceImplProduce : handle additional field in produce: {"objectVersionNumber":1,"oprName":"打胶-玻璃装配","workStationId":579600364052193290,"materialNo":"130901000711B","lastUpdateDate":1720147270779,"_token":"KAGDNz23HetMDAfJJq/9LYpnI/R6ia9Qcr0KvO1kMzQFdY55i+FzAtP46AJMmH1KyuXjf3zheBwdLiwS6ULciHXbNz74wk0jWRr7otOcfXdCgONlfVsDBuyLU6ij1OJZ","productionLineName":"驾驶室装配线","sampleNo":"ZJYB0705018750001","isPassBack":false,"wipOrderNo":"880006861916","oprSequenceNo":"0041","taskExecutionNumber":0,"isFirst":false,"businessNo":"","taskType":"01","wipOrderOperationId":596309434920902660,"workCenterId":579597295600041993,"flex":{},"supplier":"","wipOperationId":596309434920902660,"wipOrderNoReverse":"619168600088","taskNo":"JYZJ2024070501875","id":597014172781752320,"inspectionPlanId":583340904417832960,"workStationCode":"2010JS01A0002","productionLineId":578627703880851457,"lastUpdatedBy":39020,"facilityId":571301815799623680,"quantity":1,"measureUnit":"","materialId":575618864008929280,"creationDate":1720147270779,"exeStatus":false,"inspectionPlanVersion":"2","deleted":false,"workCenterCode":"303910","recordUnqualifiedNumber":false,"createdBy":39020,"productionLineCode":"2010JS01","tenantId":2,"isDevice":false,"businessType":"01","workStationName":"打胶-玻璃装配","status":"2","oprSerialNo":"000000"}
=================================
2024-07-05 10:41:11projectitrcp20220217183240276namespacekhoros-mom-prodpodmom-service-qm-9a049-7665f4899b-jpxkbpathstdoutlog_data2024-07-05 10:41:10.697 [TID: N/A] WARN [-,,,] 1 --- [Executor-130591] c.s.m.q.t.s.h.OperationStartReceiver : OperationStartReceiver msg：{"oprName":"打胶-玻璃装配","scrappedQuantity":0,"materialNo":"130901000711B","wipOrderNo":"880006861916","oprSequenceNo":"0041","goodQuantity":0,"operationWorkStationName":"打胶-玻璃装配","standOprName":"人工组装","wipOrderOperationId":596309434920902660,"requestId":"2b7eaabea93843dcb9bf6838f8da1ca3","workCenterId":579597295600041993,"progressStatus":130,"facilityCode":"2010","facilityId":571301815799623680,"operationWorkStationCode":"2010JS01A0002","completeSystem":"IMOM","operationWorkStationId":579600364052193290,"orderPlanQuantity":1,"materialId":575618864008929280,"creationDate":1720147195174,"workCenterCode":"303910","wipOrderId":596309434912514048,"createdBy":39020,"workType":0,"tenantId":2,"operationType":"START","standSequenceNo":"ZP00009","oprSerialNo":"000000"} UserDetails：CustomUserDetails{userId=39020, username=hecf6, realName='何超锋', email='null', timeZone='null', language='zh_CN', roleId=null, roleIds=null, siteRoleIds=null, tenantRoleIds=null, roleMergeFlag=null, tenantId=2, tenantNum='null', tenantIds=null, imageUrl='null', organizationId=2, isAdmin=null, clientId=null, clientName='null', clientAuthorizedGrantTypes=null, clientResourceIds=null, clientScope=null, clientRegisteredRedirectUri=null, clientAccessTokenValiditySeconds=null, clientRefreshTokenValiditySeconds=null, clientAutoApproveScopes=null, additionInfo={"facility_ids":"571301815799623680","employee_no":"80033656","account_no":"hecf6","facility_name":"2010-华湘工厂","facility_no":"2010","facility_id":"571301815799623680","phone_number":"15062676297","domain_account":"hecf6"}, apiEncryptFlag=null, apiReplayFlag=null, menuIdFlag=null, roleLabels='null}

2024-07-05 10:41:11projectitrcp20220217183240276namespacekhoros-mom-prodpodmom-service-qm-9a049-7665f4899b-jpxkbpathstdoutlog_data2024-07-05 10:41:10.698 [TID: N/A] INFO [-,,,] 1 --- [Executor-130591] .s.i.BaseInspectionTaskCreateServiceImpl : 开始创建检验任务: wipOrderNo:880006861916 materialNo:130901000711B type:01,02,04

2024-07-05 10:41:11projectitrcp20220217183240276namespacekhoros-mom-prodpodmom-service-qm-9a049-7665f4899b-62sxdpathstdoutlog_data2024-07-05 10:41:10.873 [TID: N/A] INFO [-,,,] 1 --- [Executor-128574] i.InspectionTaskCreateServiceImplProduce : handle additional field in produce: {"objectVersionNumber":1,"oprName":"打胶-玻璃装配","workStationId":579600364052193290,"materialNo":"130901000711B","lastUpdateDate":1720147270864,"_token":"KAGDNz23HetMDAfJJq/9LYpnI/R6ia9Qcr0KvO1kMzQFdY55i+FzAtP46AJMmH1KyuXjf3zheBwdLiwS6ULciHXbNz74wk0jWRr7otOcfXdZr1IoJ3ydQQ21EW6nNQiq","productionLineName":"驾驶室装配线","sampleNo":"ZJYB0705018760001","isPassBack":false,"wipOrderNo":"880006861916","oprSequenceNo":"0041","taskExecutionNumber":0,"isFirst":false,"businessNo":"","taskType":"01","wipOrderOperationId":596309434920902660,"workCenterId":579597295600041993,"flex":{},"supplier":"","wipOperationId":596309434920902660,"wipOrderNoReverse":"619168600088","taskNo":"JYZJ2024070501876","id":597014173138264064,"inspectionPlanId":583340904417832960,"workStationCode":"2010JS01A0002","productionLineId":578627703880851457,"lastUpdatedBy":39020,"facilityId":571301815799623680,"quantity":1,"measureUnit":"","materialId":575618864008929280,"creationDate":1720147270864,"exeStatus":false,"inspectionPlanVersion":"2","deleted":false,"workCenterCode":"303910","recordUnqualifiedNumber":false,"createdBy":39020,"productionLineCode":"2010JS01","tenantId":2,"isDevice":false,"businessType":"01","workStationName":"打胶-玻璃装配","status":"2","oprSerialNo":"000000"}

</code></pre> 
<h4><a id="consumer_44"></a>为什么会出现多个consumer对同一条消息重复消费呢?</h4> 
<p>通过日志排查,同一消息队列的消息被重复消费,虽然创建检验任务有查重的判断,但是在多实例同时消费时,在非常短的时间内,数据落表和查重存在幻读情况(查询数据库还没落表成功时的状态),因此这种单进程级别的查重在分布式场景中基本无效,会有概率性的失败.</p> 
<p>根据rabbitmq的原理,如果是direct类型的exchange,水平扩展的微服务多实例使用相同的routingkey绑定到同一个队列进行消费,其消费模式是 <strong>竞争消费者模式</strong>:多个消费者实例监听同一个队列，但每条消息只会被一个消费者实例消费。RabbitMQ使用公平分发（round-robin）的策略来选择消费者，但也可以通过设置消费者优先级或预取计数（prefetch count）来影响分发策略.</p> 
<p>因此在这种情况下,消费者是竞争消费,当没有及时进行ACK应答时,就有大概率存在重复消费,就会存在同一消息被多次消费的可能情况.生产环境的日志证明了这一点.</p> 
<h4><a id="_51"></a>问题的根源</h4> 
<pre><code>消息处理的幂等性,无论是多个实例consumer消费同一条消息,在要求幂等的接口场景,就要做幂等性的代码实现,不能想当然认为这大概率不会发生,即使发生了1次,也是系统缺陷,要么做线性消费,要么做幂等消息处理.
</code></pre> 
<h4><a id="_53"></a>解决办法:</h4> 
<h5><a id="1consumerclientACK_54"></a>思路1.让多个consumer监听器线性消费并让client端自动ACK.</h5> 
<pre><code>//application.yml 增加自动应答
spring:
    rabbitmq:
        host:xxx
        port:xxx
        username:xx
        password:xx
        listener:
          simple:
            acknowledge-mode: auto
            prefectch: 1
            retry:
                enabled: true

//消息队列初始化为单活消费者模式
初始化queue时,设置client为单活消费者模式
HashMap&lt;String,Object&gt; args=new HashMap();
args.put("x-single-active-consumer",true);
amqpAdmin.declareQueue(new Queue(xx,xx,xx,args));

</code></pre> 
<p>配置完成后,删除该队列,qm服务自动重建队列,配置完后可以查看到该消息队列的consumer中,处于active的只有一个.</p> 
<h5><a id="2__81"></a>思路2. 消息幂等处理</h5> 
<p>MQ消费者的幂等性一般使用全局ID或者写个唯一标识（比如流水号/时间戳/UUID/订单号）来判断该消息是否已消费过，也可以利用redis执行setnx命令，天然具有幂等性，从而实现不重复消费（推荐使用redis）。<br> 也就是在消费者业务逻辑处理时,先进行全局加锁,不过这种情况对接口响应性能有压力,而且依赖于Redis的稳定性,如果redis崩溃了,接口就无法正常服务.基于现在企业内的实际情况,应该可以做出取舍.</p> 
<h5><a id="_85"></a>最终选择</h5> 
<p>采用思路1实现方式,设置简单,影响范围小,不依赖Redis组件.<br> 在sit环境,启动多个qm实例模拟生产环境消费消息,实践证明,没有再出现重复消费消息的情况.<br> 补丁包分支:bugfix-62-imom-28381<br> 缺陷:imom-28383</p> 
<p>生产修复:<br> 手动删除队列:<br> xxx 工序开工质量监听队列<br> xxx 工序完工质量监听队列</p> 
<p><strong>参考资料</strong><br> <a href="https://blog.csdn.net/xiaofeng10330111/article/details/86772650?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172053933616800182156963%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=172053933616800182156963&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-1-86772650-null-null.142%5Ev100%5Epc_search_result_base5&amp;utm_term=rabbitmq%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E8%A7%A3%E5%86%B3&amp;spm=1018.2226.3001.4187">微服务架构数据一致性分析</a></p> 
<p><a href="https://blog.csdn.net/yanghezheng/article/details/132822907?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172053933616800182156963%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=172053933616800182156963&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~hot_rank-4-132822907-null-null.142%5Ev100%5Epc_search_result_base5&amp;utm_term=rabbitmq%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E8%A7%A3%E5%86%B3&amp;spm=1018.2226.3001.4187">RabbitMQ重复消费</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5e21363d5da8adfa3a7048c1a8633246/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java项目：基于SSM框架实现的中小型企业财务管理系统【ssm&#43;B/S架构&#43;源码&#43;数据库&#43;答辩PPT&#43;开题报告&#43;毕业论文】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/671a5c582376497b552ce0fe3c3e178f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">在亚马逊云科技AWS上利用SageMaker机器学习模型平台搭建生成式AI应用（附Llama大模型部署和测试代码）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>