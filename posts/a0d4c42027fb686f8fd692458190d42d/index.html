<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>高可用集群keepalived从部署到实战一篇解决 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/a0d4c42027fb686f8fd692458190d42d/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="高可用集群keepalived从部署到实战一篇解决">
  <meta property="og:description" content="目录
一.高可用集群
1.1 集群类型
1.2 系统可用性
1.3 系统故障
1.4 实现高可用
1.5.VRRP：
1.5.1 VRRP 相关术语
1.5.2 VRRP 相关技术
二.Keepalived 部署
2.1 keepalived 简介
2.2keepalived架构
2.3 Keepalived 环境准备
2.4 Keepalived 相关文件
2.5 Keepalived 安装
2.6 KeepAlived 配置说明
配置文件组成部分
配置语法说明：
全局配置
配置虚拟路由器
示例：
启用keepalived日志功能
实现独立子配置文件
三：实战
环境
1.实现IPVS的高可用性
虚拟服务器配置结构
虚拟服务器配置
检测功能块
步骤：
第一步：先给web服务器的环回端口添加VIP
第二步：设置两个web服务器的ARP功能
第三步：配置两个web服务的首页
第四步配置：配置两台keepalived的调度规则
查看调度策略：
最后效果：
2.实战案例：实现HAProxy高可用
第一步：下载HAProxy软件
第二步：配置策略
第三步：配置检测脚本
第四步：在keepalive上配置监控
第五步：测试
一.高可用集群 1.1 集群类型 LB：Load Balance 负载均衡
LVS/HAProxy/nginx（http/upstream, stream/upstream）">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-14T11:05:51+08:00">
    <meta property="article:modified_time" content="2024-08-14T11:05:51+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">高可用集群keepalived从部署到实战一篇解决</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:80px;"></p> 
<p id="%E4%B8%80.%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4-toc" style="margin-left:80px;"><a href="#%E4%B8%80.%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4" rel="nofollow">一.高可用集群</a></p> 
<p id="1.1%20%E9%9B%86%E7%BE%A4%E7%B1%BB%E5%9E%8B-toc" style="margin-left:120px;"><a href="#1.1%20%E9%9B%86%E7%BE%A4%E7%B1%BB%E5%9E%8B" rel="nofollow">1.1 集群类型</a></p> 
<p id="1.2%20%E7%B3%BB%E7%BB%9F%E5%8F%AF%E7%94%A8%E6%80%A7-toc" style="margin-left:120px;"><a href="#1.2%20%E7%B3%BB%E7%BB%9F%E5%8F%AF%E7%94%A8%E6%80%A7" rel="nofollow">1.2 系统可用性</a></p> 
<p id="1.3%20%E7%B3%BB%E7%BB%9F%E6%95%85%E9%9A%9C-toc" style="margin-left:120px;"><a href="#1.3%20%E7%B3%BB%E7%BB%9F%E6%95%85%E9%9A%9C" rel="nofollow">1.3 系统故障</a></p> 
<p id="1.4%20%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8-toc" style="margin-left:120px;"><a href="#1.4%20%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8" rel="nofollow">1.4 实现高可用</a></p> 
<p id="1.5.VRRP%EF%BC%9A-toc" style="margin-left:120px;"><a href="#1.5.VRRP%EF%BC%9A" rel="nofollow">1.5.VRRP：</a></p> 
<p id="1.5.1%20VRRP%20%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD-toc" style="margin-left:160px;"><a href="#1.5.1%20VRRP%20%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD" rel="nofollow">1.5.1 VRRP 相关术语</a></p> 
<p id="1.5.2%20VRRP%20%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF-toc" style="margin-left:160px;"><a href="#1.5.2%20VRRP%20%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF" rel="nofollow">1.5.2 VRRP 相关技术</a></p> 
<p id="%E4%BA%8C.Keepalived%20%E9%83%A8%E7%BD%B2-toc" style="margin-left:80px;"><a href="#%E4%BA%8C.Keepalived%20%E9%83%A8%E7%BD%B2" rel="nofollow">二.Keepalived 部署</a></p> 
<p id="2.1%20keepalived%20%E7%AE%80%E4%BB%8B-toc" style="margin-left:120px;"><a href="#2.1%20keepalived%20%E7%AE%80%E4%BB%8B" rel="nofollow">2.1 keepalived 简介</a></p> 
<p id="2.2keepalived%E6%9E%B6%E6%9E%84-toc" style="margin-left:120px;"><a href="#2.2keepalived%E6%9E%B6%E6%9E%84" rel="nofollow">2.2keepalived架构</a></p> 
<p id="2.3%20Keepalived%20%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-toc" style="margin-left:120px;"><a href="#2.3%20Keepalived%20%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87" rel="nofollow">2.3 Keepalived 环境准备</a></p> 
<p id="2.4%20Keepalived%20%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6-toc" style="margin-left:120px;"><a href="#2.4%20Keepalived%20%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6" rel="nofollow">2.4 Keepalived 相关文件</a></p> 
<p id="2.5%20Keepalived%20%E5%AE%89%E8%A3%85-toc" style="margin-left:120px;"><a href="#2.5%20Keepalived%20%E5%AE%89%E8%A3%85" rel="nofollow">2.5 Keepalived 安装</a></p> 
<p id="2.6%20KeepAlived%20%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E-toc" style="margin-left:120px;"><a href="#2.6%20KeepAlived%20%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E" rel="nofollow">2.6 KeepAlived 配置说明</a></p> 
<p id="%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86-toc" style="margin-left:160px;"><a href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86" rel="nofollow">配置文件组成部分</a></p> 
<p id="%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95%E8%AF%B4%E6%98%8E%EF%BC%9A-toc" style="margin-left:160px;"><a href="#%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95%E8%AF%B4%E6%98%8E%EF%BC%9A" rel="nofollow">配置语法说明：</a></p> 
<p id="%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE-toc" style="margin-left:160px;"><a href="#%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE" rel="nofollow">全局配置</a></p> 
<p id="%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E8%B7%AF%E7%94%B1%E5%99%A8-toc" style="margin-left:160px;"><a href="#%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E8%B7%AF%E7%94%B1%E5%99%A8" rel="nofollow">配置虚拟路由器</a></p> 
<p id="%E7%A4%BA%E4%BE%8B%EF%BC%9A-toc" style="margin-left:160px;"><a href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A" rel="nofollow">示例：</a></p> 
<p id="%E5%90%AF%E7%94%A8keepalived%E6%97%A5%E5%BF%97%E5%8A%9F%E8%83%BD-toc" style="margin-left:160px;"><a href="#%E5%90%AF%E7%94%A8keepalived%E6%97%A5%E5%BF%97%E5%8A%9F%E8%83%BD" rel="nofollow">启用keepalived日志功能</a></p> 
<p id="%E5%AE%9E%E7%8E%B0%E7%8B%AC%E7%AB%8B%E5%AD%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-toc" style="margin-left:160px;"><a href="#%E5%AE%9E%E7%8E%B0%E7%8B%AC%E7%AB%8B%E5%AD%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" rel="nofollow">实现独立子配置文件</a></p> 
<p id="%E4%B8%89%EF%BC%9A%E5%AE%9E%E6%88%98-toc" style="margin-left:40px;"><a href="#%E4%B8%89%EF%BC%9A%E5%AE%9E%E6%88%98" rel="nofollow">三：实战</a></p> 
<p id="%E7%8E%AF%E5%A2%83-toc" style="margin-left:80px;"><a href="#%E7%8E%AF%E5%A2%83" rel="nofollow">环境</a></p> 
<p id="1.%E5%AE%9E%E7%8E%B0IPVS%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7-toc" style="margin-left:80px;"><a href="#1.%E5%AE%9E%E7%8E%B0IPVS%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7" rel="nofollow">1.实现IPVS的高可用性</a></p> 
<p id="%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E7%BB%93%E6%9E%84-toc" style="margin-left:120px;"><a href="#%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E7%BB%93%E6%9E%84" rel="nofollow">虚拟服务器配置结构</a></p> 
<p id="%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE-toc" style="margin-left:120px;"><a href="#%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE" rel="nofollow">虚拟服务器配置</a></p> 
<p id="%E6%A3%80%E6%B5%8B%E5%8A%9F%E8%83%BD%E5%9D%97-toc" style="margin-left:120px;"><a href="#%E6%A3%80%E6%B5%8B%E5%8A%9F%E8%83%BD%E5%9D%97" rel="nofollow">检测功能块</a></p> 
<p id="%E6%AD%A5%E9%AA%A4%EF%BC%9A-toc" style="margin-left:120px;"><a href="#%E6%AD%A5%E9%AA%A4%EF%BC%9A" rel="nofollow">步骤：</a></p> 
<p id="%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%85%88%E7%BB%99web%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%8E%AF%E5%9B%9E%E7%AB%AF%E5%8F%A3%E6%B7%BB%E5%8A%A0VIP-toc" style="margin-left:160px;"><a href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%85%88%E7%BB%99web%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%8E%AF%E5%9B%9E%E7%AB%AF%E5%8F%A3%E6%B7%BB%E5%8A%A0VIP" rel="nofollow">第一步：先给web服务器的环回端口添加VIP</a></p> 
<p id="%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E8%AE%BE%E7%BD%AE%E4%B8%A4%E4%B8%AAweb%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84ARP%E5%8A%9F%E8%83%BD-toc" style="margin-left:160px;"><a href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E8%AE%BE%E7%BD%AE%E4%B8%A4%E4%B8%AAweb%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84ARP%E5%8A%9F%E8%83%BD" rel="nofollow">第二步：设置两个web服务器的ARP功能</a></p> 
<p id="%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%B8%A4%E4%B8%AAweb%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%A6%96%E9%A1%B5-toc" style="margin-left:160px;"><a href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%B8%A4%E4%B8%AAweb%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%A6%96%E9%A1%B5" rel="nofollow">第三步：配置两个web服务的首页</a></p> 
<p id="%E7%AC%AC%E5%9B%9B%E6%AD%A5%E9%85%8D%E7%BD%AE%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%B8%A4%E5%8F%B0keepalived%E7%9A%84%E8%B0%83%E5%BA%A6%E8%A7%84%E5%88%99-toc" style="margin-left:160px;"><a href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%E9%85%8D%E7%BD%AE%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%B8%A4%E5%8F%B0keepalived%E7%9A%84%E8%B0%83%E5%BA%A6%E8%A7%84%E5%88%99" rel="nofollow">第四步配置：配置两台keepalived的调度规则</a></p> 
<p id="%E6%9F%A5%E7%9C%8B%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%EF%BC%9A-toc" style="margin-left:160px;"><a href="#%E6%9F%A5%E7%9C%8B%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%EF%BC%9A" rel="nofollow">查看调度策略：</a></p> 
<p id="%E6%9C%80%E5%90%8E%E6%95%88%E6%9E%9C%EF%BC%9A-toc" style="margin-left:160px;"><a href="#%E6%9C%80%E5%90%8E%E6%95%88%E6%9E%9C%EF%BC%9A" rel="nofollow">最后效果：</a></p> 
<p id="2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0HAProxy%E9%AB%98%E5%8F%AF%E7%94%A8-toc" style="margin-left:80px;"><a href="#2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0HAProxy%E9%AB%98%E5%8F%AF%E7%94%A8" rel="nofollow">2.实战案例：实现HAProxy高可用</a></p> 
<p id="%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BDHAProxy%E8%BD%AF%E4%BB%B6-toc" style="margin-left:120px;"><a href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BDHAProxy%E8%BD%AF%E4%BB%B6" rel="nofollow">第一步：下载HAProxy软件</a></p> 
<p id="%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E7%AD%96%E7%95%A5-toc" style="margin-left:120px;"><a href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E7%AD%96%E7%95%A5" rel="nofollow">第二步：配置策略</a></p> 
<p id="%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E6%A3%80%E6%B5%8B%E8%84%9A%E6%9C%AC-toc" style="margin-left:120px;"><a href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E6%A3%80%E6%B5%8B%E8%84%9A%E6%9C%AC" rel="nofollow">第三步：配置检测脚本</a></p> 
<p id="%C2%A0%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%9C%A8keepalive%E4%B8%8A%E9%85%8D%E7%BD%AE%E7%9B%91%E6%8E%A7-toc" style="margin-left:120px;"><a href="#%C2%A0%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%9C%A8keepalive%E4%B8%8A%E9%85%8D%E7%BD%AE%E7%9B%91%E6%8E%A7" rel="nofollow"> 第四步：在keepalive上配置监控</a></p> 
<p id="%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E6%B5%8B%E8%AF%95-toc" style="margin-left:120px;"><a href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E6%B5%8B%E8%AF%95" rel="nofollow">第五步：测试</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h4 id="%E4%B8%80.%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4">一.高可用集群</h4> 
<h5 id="1.1%20%E9%9B%86%E7%BE%A4%E7%B1%BB%E5%9E%8B">1.1 集群类型</h5> 
<p><strong>LB：Load Balance 负载均衡</strong></p> 
<p>LVS/HAProxy/nginx（http/upstream, stream/upstream）</p> 
<p><strong>HA：High Availability 高可用集群</strong></p> 
<p>数据库、Redis</p> 
<p><strong>SPoF: Single Point of Failure，解决单点故障</strong></p> 
<p>HPC：High Performance Computing 高性能集群</p> 
<h5 id="1.2%20%E7%B3%BB%E7%BB%9F%E5%8F%AF%E7%94%A8%E6%80%A7">1.2 系统可用性</h5> 
<p>SLA：Service-Level Agreement 服务等级协议（提供服务的企业与客户之间就服务的品质、水准、性能 等方面所达成的双方共同认可的协议或契约）</p> 
<p>A = MTBF / (MTBF+MTTR）（正常运行时间/正常+故障）</p> 
<pre><code>99.95%:(60*24*30)*(1-0.9995)=21.6分钟 #一般按一个月停机时间统计</code></pre> 
<p>指标 ：99.9%, 99.99%, 99.999%,99.9999%</p> 
<h5 id="1.3%20%E7%B3%BB%E7%BB%9F%E6%95%85%E9%9A%9C">1.3 系统故障</h5> 
<p>硬件故障：设计缺陷、wear out（损耗）、非人为不可抗拒因素</p> 
<p>软件故障：设计缺陷 bug</p> 
<h5 id="1.4%20%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8">1.4 实现高可用</h5> 
<p>提升系统高用性的解决方案：降低MTTR- Mean Time To Repair(平均故障时间)</p> 
<p>解决方案：建立冗余机制</p> 
<pre><code>active/passive 主/备
active/active 双主
active --&gt; HEARTBEAT --&gt; passive 
active &lt;--&gt; HEARTBEAT &lt;--&gt; active</code></pre> 
<h5 id="1.5.VRRP%EF%BC%9A">1.5.VRRP：</h5> 
<p>Virtual Router Redundancy Protocol</p> 
<p>虚拟路由冗余协议,解决静态网关单点风险</p> 
<p>实质：<strong>解决调度器发生故障时的方案，设置一个VIP，两个调度器（两个调度器有自己的IP），将VIP分发给其中一个调度器，客户端访问VIP。当这个调度器挂了，VIP分发给另外一个调度器。通过组播通告自己的健康状态（HEARTBEAT）</strong></p> 
<ul><li> <p>物理层:路由器、三层交换机</p> </li><li> <p>软件层:keepalived</p> </li></ul> 
<p><img alt="" height="611" src="https://images2.imgbox.com/d5/83/cU12lIpd_o.png" width="865"></p> 
<p></p> 
<h6 id="1.5.1%20VRRP%20%E7%9B%B8%E5%85%B3%E6%9C%AF%E8%AF%AD">1.5.1 VRRP 相关术语</h6> 
<p>虚拟路由器：Virtual Router</p> 
<p>虚拟路由器标识：VRID(0-255)唯一标识虚拟路由器</p> 
<p>VIP：Virtual IP</p> 
<p>VMAC：Virutal MAC (00-00-5e-00-01-VRID)</p> 
<p>物理路由器：</p> 
<ul><li> <p>master：主设备</p> </li><li> <p>backup：备用设备</p> </li><li> <p>priority：优先级</p> </li></ul> 
<h6 id="1.5.2%20VRRP%20%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF">1.5.2 VRRP 相关技术</h6> 
<p>通告：心跳，优先级等；周期性</p> 
<p>工作方式：抢占式，非抢占式</p> 
<p>安全认证：</p> 
<ul><li> <p>无认证</p> </li><li> <p>简单字符认证：预共享密钥</p> </li><li> <p>MD5</p> </li></ul> 
<p>工作模式：</p> 
<p>主/备：单虚拟路由器</p> 
<p>主/主：主/备（虚拟路由器1），备/主（虚拟路由器2）互为主备</p> 
<h4 id="%E4%BA%8C.Keepalived%20%E9%83%A8%E7%BD%B2">二.Keepalived 部署</h4> 
<p><img alt="" height="310" src="https://images2.imgbox.com/0a/71/FMDOuld6_o.png" width="1122"></p> 
<h5 id="2.1%20keepalived%20%E7%AE%80%E4%BB%8B">2.1 keepalived 简介</h5> 
<p>vrrp 协议的软件实现，原生设计目的为了高可用 ipvs服务</p> 
<p>官网：<a href="http://keepalived.org/" rel="nofollow" title="Keepalived for Linux">Keepalived for Linux</a></p> 
<p>功能：</p> 
<ul><li> <p>基于vrrp协议完成地址流动</p> </li><li> <p>为vip地址所在的节点生成ipvs规则(在配置文件中预先定义)</p> </li><li> <p>为ipvs集群的各RS做健康状态检测</p> </li><li> <p>基于脚本调用接口完成脚本中定义的功能，进而影响集群事务，以此支持nginx、haproxy等服务</p> </li></ul> 
<h5 id="2.2keepalived%E6%9E%B6%E6%9E%84">2.2keepalived架构</h5> 
<p> <img alt="" height="634" src="https://images2.imgbox.com/db/a6/7BSfEMvF_o.png" width="964"></p> 
<pre><code>用户空间核心组件：
vrrp stack：VIP消息通告
checkers：监测real server
system call：实现 vrrp 协议状态转换时调用脚本的功能
SMTP：邮件组件
IPVS wrapper：生成IPVS规则
Netlink Reflector：网络接口
WatchDog：监控进程
控制组件：提供keepalived.conf 的解析器，完成Keepalived配置
IO复用器：针对网络目的而优化的自己的线程抽象
内存管理组件：为某些通用的内存管理功能（例如分配，重新分配，发布等）提供访问权限</code></pre> 
<p></p> 
<h5 id="2.3%20Keepalived%20%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">2.3 Keepalived 环境准备</h5> 
<h5 id="2.4%20Keepalived%20%E7%9B%B8%E5%85%B3%E6%96%87%E4%BB%B6">2.4 Keepalived 相关文件</h5> 
<ul><li> <p>软件包名：keepalived</p> </li><li> <p>主程序文件：/usr/sbin/keepalived</p> </li><li> <p>主配置文件：/etc/keepalived/keepalived.conf</p> </li><li> <p>配置文件示例：/usr/share/doc/keepalived/</p> </li><li> <p>Unit File：/lib/systemd/system/keepalived.service</p> </li><li> <p>Unit File的环境配置文件：/etc/sysconfig/keepalived</p> </li></ul> 
<h5 id="2.5%20Keepalived%20%E5%AE%89%E8%A3%85">2.5 Keepalived 安装</h5> 
<p>安装 keepalived</p> 
<pre><code>[root@KA1 ~]# dnf install keepalived -y
[root@KA1 ~]# systemctl start keepalived
[root@KA1 ~]# ps axf | grep keepalived
   2385 pts/0   S+     0:00             \_ grep --color=auto keepalived
   2326 ?       Ss     0:00 /usr/sbin/keepalived -D
   2327 ?       S     0:00 \_ /usr/sbin/keepalived -D
</code></pre> 
<h5 id="2.6%20KeepAlived%20%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E" style="background-color:transparent;">2.6 KeepAlived 配置说明</h5> 
<h6 id="%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86">配置文件组成部分</h6> 
<pre><code>配置文件：/etc/keepalived/keepalived.conf
配置文件组成
GLOBAL CONFIGURATION
Global definitions： 定义邮件配置，route_id，vrrp配置，多播地址等
VRRP CONFIGURATION
VRRP instance(s)： 定义每个vrrp虚拟路由器
LVS CONFIGURATION
Virtual server group(s)
Virtual server(s)： LVS集群的VS和RS</code></pre> 
<h6 id="%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95%E8%AF%B4%E6%98%8E%EF%BC%9A">配置语法说明：</h6> 
<h6 id="%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE">全局配置</h6> 
<pre><code>! Configuration File for keepalived
global_defs {
   notification_email {
       594233887@qq.com #keepalived 发生故障切换时邮件发送的目标邮箱，可以按行区
分写多个
       timiniglee-zln@163.com
   }
   notification_email_from keepalived@KA1.timinglee.org #发邮件的地址
   smtp_server 127.0.0.1 #邮件服务器地址
   smtp_connect_timeout 30 #邮件服务器连接timeout
   router_id KA1.timinglee.org #每个keepalived主机唯一标识
   #建议使用当前主机名，但多节点
重名不影响
  
 vrrp_skip_check_adv_addr #对所有通告报文都检查，会比较消耗性能
 #启用此配置后，如果收到的通告报文和上一
个报文是同一 #个路由器，则跳过检查，默认
值为全检查
  
  
   vrrp_strict #严格遵循vrrp协议
 #启用此项后以下状况将无法启动服务:
 #1.无VIP地址 
 #2.配置了单播邻居 
 #3.在VRRP版本2中有IPv6地址
 #建议不加此项配置
  
 vrrp_garp_interval 0 #报文发送延迟，0表示不延迟
 vrrp_gna_interval 0 #消息发送延迟
 vrrp_mcast_group4 224.0.0.18 #指定组播IP地址范围： 
  
}</code></pre> 
<h6 id="%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E8%B7%AF%E7%94%B1%E5%99%A8">配置虚拟路由器</h6> 
<pre><code>vrrp_instance VI_1 {
   state MASTER
   interface eth0 #绑定为当前虚拟路由器使用的物理接口，如：eth0,可以和VIP不在一
个网卡
    
   virtual_router_id 51 #每个虚拟路由器惟一标识,范围：0-255，每个虚拟路由器此值必须唯一
   #否则服务无法启动
   #同属一个虚拟路由器的多个keepalived节点必须相同
   #务必要确认在同一网络中此值必须唯一
    
   priority 100 #当前物理节点在此虚拟路由器的优先级，范围：1-254
   #值越大优先级越高,每个keepalived主机节点此值不同
   
   advert_int 1 #vrrp通告的时间间隔，默认1s
   authentication { #认证机制
       auth_type AH|PASS #AH为IPSEC认证(不推荐),PASS为简单密码(建议使用)
          uth_pass 1111 #预共享密钥，仅前8位有效
       #同一个虚拟路由器的多个keepalived节点必须一样
   }
   virtual_ipaddress { #虚拟IP,生产环境可能指定上百个IP地址
        
       &lt;IPADDR&gt;/&lt;MASK&gt; brd &lt;IPADDR&gt; dev &lt;STRING&gt; scope &lt;SCOPE&gt; label &lt;LABEL&gt;
       172.25.254.100 #指定VIP，不指定网卡，默认为eth0,注意：不指定/prefix,默认32
       172.25.254.101/24 dev eth1
       172.25.254.102/24 dev eth2 label eth2:1
   }
}</code></pre> 
<h6 id="%E7%A4%BA%E4%BE%8B%EF%BC%9A">示例：</h6> 
<pre><code>#配置master端
[root@KA1 ~]# vim /etc/keepalived/keepalived.conf
! Configuration File for keepalived
global_defs {
   notification_email {
       181766@qq.com
   }
   notification_email_from keepalived@KA1.timinglee.org
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id KA1.timinglee.org
   vrrp_skip_check_adv_addr
   #vrrp_strict #nft list ruleset
   vrrp_garp_interval 0
   vrrp_gna_interval 0
   vrrp_mcast_group4 224.0.0.18
}
vrrp_instance VI_1 {
   state MASTER
   interface eth0
   virtual_router_id 20
   priority 100
   advert_int 1
   authentication {
       auth_type PASS
       auth_pass 1111
   }
   virtual_ipaddress {
       172.25.254.100/24 dev eth0 label eth0:0
   }
}
配置slave端
[root@KA2 ~]# vim /etc/keepalived/keepalived.conf
! Configuration File for keepalived
global_defs {
   notification_email {2.6.2.3 启用keepalived日志功能 
示例：
       1817660707@qq.com
   }
   notification_email_from keepalived@timinglee.org
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id KA2.timinglee.org
   vrrp_skip_check_adv_addr
   #vrrp_strict
   vrrp_garp_interval 0
   vrrp_gna_interval 0
   vrrp_mcast_group4 224.0.0.18
}
vrrp_instance VI_1 {
   state BACKUP
   interface eth0
   virtual_router_id 20 #相同id管理同一个虚拟路由
   priority 80 #低优先级
   advert_int 1
   authentication {
       auth_type PASS
       auth_pass 1111
   }
   virtual_ipaddress {
       172.25.254.100/24 dev eth0 label eth0:0
   }
}
测试
[root@KA2 ~]# tcpdump -i eth0 -nn host 224.0.0.18
dropped privs to tcpdump
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
22:48:23.294894 IP 172.25.254.20 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 20, 
prio 100, authtype none, intvl 1s, length 20
22:48:24.084793 IP 172.25.254.30 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 30, 
prio 80, authtype none, intvl 1s, length 20
22:48:24.295075 IP 172.25.254.20 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 20, 
prio 100, authtype none, intvl 1s, length 20
22:48:25.085256 IP 172.25.254.30 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 30, 
prio 80, authtype none, intvl 1s, length 20
22:48:25.296296 IP 172.25.254.20 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 20, 
prio 100, authtype none, intvl 1s, length 20</code></pre> 
<h6 id="%E5%90%AF%E7%94%A8keepalived%E6%97%A5%E5%BF%97%E5%8A%9F%E8%83%BD">启用keepalived日志功能</h6> 
<pre><code>[root@KA1 ~]# vim /etc/sysconfig/keepalived
KEEPALIVED_OPTIONS="-D -S 6"
[root@ka1 ~]#vim /etc/rsyslog.conf2.6.2.4 实现独立子配置文件 
当生产环境复杂时， /etc/keepalived/keepalived.conf 文件中内容过多，不易管理
将不同集群的配置，比如：不同集群的VIP配置放在独立的子配置文件中利用include 指令可以实现包含
子配置文件
格式：
示例：
local6.*                                               /var/log/keepalived.log 
[root@ka1 ~]#systemctl restart keepalived.service rsyslog.service 
[root@ka1 ~]#tail -f /var/log/keepalived.log 
Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 for
10.0.0.10
Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 for
10.0.0.10
Apr 14 09:25:51 ka1 Keepalived_vrrp[1263]: Sending gratuitous ARP on eth0 for
10.0.0.10</code></pre> 
<h6 id="%E5%AE%9E%E7%8E%B0%E7%8B%AC%E7%AB%8B%E5%AD%90%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">实现独立子配置文件</h6> 
<p>当生产环境复杂时， /etc/keepalived/keepalived.conf 文件中内容过多，不易管理</p> 
<p>将不同集群的配置，比如：不同集群的VIP配置放在独立的子配置文件中利用include 指令可以实现包含 子配置文件</p> 
<p>格式：</p> 
<pre><code>include /path/file</code></pre> 
<p> 示例：</p> 
<pre><code>[root@KA1 ~]# mkdir /etc/keepalived/conf.d
[root@KA1 ~]# vim /etc/keepalived/keepalived.conf
! Configuration File for keepalived
global_defs {
   notification_email {
       1817660707@qq.com
   }
   notification_email_from keepalived@www.wang.org
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id KA1.timinglee.org
   vrrp_skip_check_adv_addr
   vrrp_strict
   vrrp_garp_interval 0
   vrrp_gna_interval 0
   vrrp_ipsets keepalived
   vrrp_iptables
}
include /etc/keepalived/conf.d/*.conf #相关子配置文件
[root@KA1 ~]# vim /etc/keepalived/conf.d/router.conf
vrrp_instance VI_1 {
   state MASTER
   interface eth0
   virtual_router_id 20
   priority 100
   advert_int 1
   authentication {
       auth_type PASS
       auth_pass 1111
   }
   virtual_ipaddress {
       172.25.254.100/24 dev eth0 label eth0:0
   }
}</code></pre> 
<h3 id="%E4%B8%89%EF%BC%9A%E5%AE%9E%E6%88%98" style="background-color:transparent;">三：实战</h3> 
<h4 id="%E7%8E%AF%E5%A2%83">环境</h4> 
<p><img alt="" height="655" src="https://images2.imgbox.com/c3/23/bDs6qEsH_o.png" width="1200"></p> 
<h4 id="1.%E5%AE%9E%E7%8E%B0IPVS%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E6%80%A7">1.实现IPVS的高可用性</h4> 
<p><strong>使用keepalived的配置可以取代LVS的配置而且增加了后端检测的功能，如果你想查看LVS的调度策略可以下载ipvsadm</strong></p> 
<h5 id="%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE%E7%BB%93%E6%9E%84">虚拟服务器配置结构</h5> 
<pre><code>virtual_server IP port {
   ... #中间写用户要访问的VIP
 real_server {
 ...  #中间写要调度到的真实服务器的IP
 }
 real_server {
 ...  #中间写要调度到的真实服务器的IP
 }
 …
}
</code></pre> 
<h5 id="%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE">虚拟服务器配置</h5> 
<pre><code>virtual_server IP port { #VIP和PORT
 delay_loop &lt;INT&gt; #检查后端服务器的时间间隔
 lb_algo rr|wrr|lc|wlc|lblc|sh|dh #定义调度方法
 lb_kind NAT|DR|TUN #集群的类型,注意要大写
 persistence_timeout &lt;INT&gt; #持久连接时长
 protocol TCP|UDP|SCTP #指定服务协议,一般为TCP
 sorry_server &lt;IPADDR&gt; &lt;PORT&gt; #所有RS故障时，备用服务器地址
 real_server &lt;IPADDR&gt; &lt;PORT&gt; {          #RS的IP和PORT
 weight &lt;INT&gt;   #RS权重
 notify_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;   #RS上线通知脚本
 notify_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt; #RS下线通知脚本
 HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK { ... } #定义当前主机健康状
态检测方法
 }
}
#注意:括号必须分行写,两个括号写在同一行,如: }} 会出错</code></pre> 
<h5 id="%E6%A3%80%E6%B5%8B%E5%8A%9F%E8%83%BD%E5%9D%97">检测功能块</h5> 
<p>应用层检测：HTTP_GET|SSL_GET</p> 
<pre><code>HTTP_GET|SSL_GET {
 url {
   path &lt;URL_PATH&gt; #定义要监控的URL
   status_code &lt;INT&gt; #判断上述检测机制为健康状态的响应码，一般为 200
 }
 connect_timeout &lt;INTEGER&gt; #客户端请求的超时时长, 相当于haproxy的timeout server
 nb_get_retry &lt;INT&gt; #重试次数
 delay_before_retry &lt;INT&gt; #重试之前的延迟时长
 connect_ip &lt;IP ADDRESS&gt; #向当前RS哪个IP地址发起健康状态检测请求
 connect_port &lt;PORT&gt; #向当前RS的哪个PORT发起健康状态检测请求
 bindto &lt;IP ADDRESS&gt; #向当前RS发出健康状态检测请求时使用的源地址
 bind_port &lt;PORT&gt; #向当前RS发出健康状态检测请求时使用的源端口
}
</code></pre> 
<p>传输层检测：TCP_CHECK</p> 
<pre><code>TCP_CHECK {
     connect_ip &lt;IP ADDRESS&gt; #向当前RS的哪个IP地址发起健康状态检测请求
     connect_port &lt;PORT&gt; #向当前RS的哪个PORT发起健康状态检测请求
     bindto &lt;IP ADDRESS&gt; #发出健康状态检测请求时使用的源地址
     bind_port &lt;PORT&gt; #发出健康状态检测请求时使用的源端口
     connect_timeout &lt;INTEGER&gt; #客户端请求的超时时长
     #等于haproxy的timeout server   
}
</code></pre> 
<h5 id="%E6%AD%A5%E9%AA%A4%EF%BC%9A">步骤：</h5> 
<h6 id="%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%85%88%E7%BB%99web%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%8E%AF%E5%9B%9E%E7%AB%AF%E5%8F%A3%E6%B7%BB%E5%8A%A0VIP">第一步：先给web服务器的环回端口添加VIP</h6> 
<pre><code>[root@rs1 ~]# ip a a 172.25.250.100/32 dev lo
[root@rs2 ~]# ip a a 172.25.250.100/32 dev lo</code></pre> 
<h6 id="%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E8%AE%BE%E7%BD%AE%E4%B8%A4%E4%B8%AAweb%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84ARP%E5%8A%9F%E8%83%BD">第二步：设置两个web服务器的ARP功能</h6> 
<pre><code>[root@rs1 ~]# echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore
[root@rs1 ~]# echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce
[root@rs1 ~]# echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore
[root@rs1 ~]# echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce
[root@rs2 ~]# echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore
[root@rs2 ~]# echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce
[root@rs2 ~]# echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore
[root@rs2 ~]# echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce
</code></pre> 
<h6 id="%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%B8%A4%E4%B8%AAweb%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%A6%96%E9%A1%B5">第三步：配置两个web服务的首页</h6> 
<pre><code>[root@rs1 ~]# yum install httpd -y
[root@rs2 ~]# yum install httpd -y
[root@rs1 ~]# echo "welcome to web1" &gt; /var/www/html/index.html
[root@rs2 ~]# echo "welcome to web2" &gt; /var/www/html/index.html

</code></pre> 
<h6 id="%E7%AC%AC%E5%9B%9B%E6%AD%A5%E9%85%8D%E7%BD%AE%EF%BC%9A%E9%85%8D%E7%BD%AE%E4%B8%A4%E5%8F%B0keepalived%E7%9A%84%E8%B0%83%E5%BA%A6%E8%A7%84%E5%88%99">第四步配置：配置两台keepalived的调度规则</h6> 
<pre><code>[root@ka1 ~]# yum install keepalived.x86_64 -y
[root@ka2 ~]# yum install keepalived.x86_64 -y
[root@ka1 ~]# yum install ipvsadm.x86_64 -y
[root@ka2 ~]# yum install ipvsadm.x86_64 -y</code></pre> 
<p>配置虚拟路由器的相关配置</p> 
<p>关闭严格模式</p> 
<p><img alt="" height="409" src="https://images2.imgbox.com/de/64/M0oF3VoZ_o.png" width="765"></p> 
<p><img alt="" height="353" src="https://images2.imgbox.com/2a/20/XvysNQNw_o.png" width="712"></p> 
<p>配置调度规则：</p> 
<p> ka1上</p> 
<pre><code>virtual_server 172.25.250.100 80{
    delay_loop 6
    lb_algo wrr
    lb_kind DR
    protocol TCP

    real_server 172.25.250.110 80{
        weight 1
        http_GET {
            url {
              path /
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 2
            delay_before_retry 2
        }
    }

    real_server 172.25.250.120 80{
        weight 1
        http_GET {
            url {
              path /
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 2
            delay_before_retry 2
        }
    }
}
</code></pre> 
<p>ka2上也是差不多的设置</p> 
<h6 id="%E6%9F%A5%E7%9C%8B%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5%EF%BC%9A">查看调度策略：</h6> 
<p>配完keepalive的文件策略自动就有了</p> 
<p><img alt="" height="261" src="https://images2.imgbox.com/22/c6/XFbydbli_o.png" width="898"></p> 
<h6 id="%E6%9C%80%E5%90%8E%E6%95%88%E6%9E%9C%EF%BC%9A">最后效果：</h6> 
<p><img alt="" height="288" src="https://images2.imgbox.com/60/d6/aLLWQuog_o.png" width="1041"></p> 
<p> 关闭其中一个keepalive再访问：</p> 
<p>[root@ka1 ~]# systemctl stop keepalived.service </p> 
<p><img alt="" height="276" src="https://images2.imgbox.com/d5/e2/uUNHKago_o.png" width="1020"></p> 
<p>还是不会断，因为VIP到另外一台调度器上去了</p> 
<p><img alt="" height="337" src="https://images2.imgbox.com/30/f6/u0w11OEI_o.png" width="1029"></p> 
<p>而且keepalived还提供后端检测，如果web服务器挂了，调度器会自动跟新调度策略 </p> 
<pre><code>[root@rs2 ~]# systemctl stop httpd
[root@ka2 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  172.25.250.100:80 wrr
  -&gt; 172.25.250.110:80            Route   1      0          0         
TCP  192.168.200.100:443 rr persistent 50
TCP  10.10.10.2:1358 rr persistent 50
  -&gt; 192.168.200.200:1358         Masq    1      0          0   </code></pre> 
<h4 id="2.%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%EF%BC%9A%E5%AE%9E%E7%8E%B0HAProxy%E9%AB%98%E5%8F%AF%E7%94%A8">2.实战案例：实现HAProxy高可用</h4> 
<p>辅助HAProxy实现高可用负载均衡集群</p> 
<p>首先把上个实验的操作都恢复，保证一个纯净实验环境</p> 
<p>KA1和KA2上都差不多只需要改一下主备和优先级就行。</p> 
<p><strong>实验原理：通过VRRP Script 技术，keepalive监控脚本，如果haproxy死亡，会返回状态码非零，Script技术会降低本虚拟路由器的优先级，使得VIP飘到另外一台keepalive服务器上</strong></p> 
<h5 id="%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E4%B8%8B%E8%BD%BDHAProxy%E8%BD%AF%E4%BB%B6">第一步：下载HAProxy软件</h5> 
<pre><code>[root@ka1 ~]# yum install haproxy.x86_64  -y
[root@ka2 ~]# yum install haproxy.x86_64  -y</code></pre> 
<h5 id="%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E7%AD%96%E7%95%A5">第二步：配置策略</h5> 
<p><img alt="" height="534" src="https://images2.imgbox.com/da/ef/VqaeHIMR_o.png" width="1022"></p> 
<p>重启服务</p> 
<p>[root@ka1 ~]# systemctl restart haproxy.service </p> 
<h5 id="%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E6%A3%80%E6%B5%8B%E8%84%9A%E6%9C%AC">第三步：配置检测脚本</h5> 
<p>[root@ka1 ~]# vim /etc/keepalived/haproxy.sh</p> 
<p><img alt="" height="144" src="https://images2.imgbox.com/ca/d6/GUMVTmQA_o.png" width="624"></p> 
<p>给执行权限</p> 
<p>[root@ka1 ~]# chmod +x /etc/keepalived/haproxy.sh</p> 
<h5 id="%C2%A0%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%9C%A8keepalive%E4%B8%8A%E9%85%8D%E7%BD%AE%E7%9B%91%E6%8E%A7"> 第四步：在keepalive上配置监控</h5> 
<p><img alt="" height="211" src="https://images2.imgbox.com/6b/d5/ukd2Kks0_o.png" width="644"></p> 
<p><img alt="" height="413" src="https://images2.imgbox.com/c1/6f/isej5NuR_o.png" width="734"></p> 
<h5 id="%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E6%B5%8B%E8%AF%95">第五步：测试</h5> 
<p><img alt="" height="362" src="https://images2.imgbox.com/e4/c7/sPGEAxRB_o.png" width="935"></p> 
<p>同时关闭其中一台调度器看访问是否会断</p> 
<p><img alt="" height="347" src="https://images2.imgbox.com/09/91/uT77da9D_o.png" width="1014"></p> 
<p><img alt="" height="398" src="https://images2.imgbox.com/2f/b8/WpowqEgq_o.png" width="792"></p> 
<p>因为vip到了ka2这台调度器上所以访问100还是不会断，</p> 
<p><img alt="" height="334" src="https://images2.imgbox.com/29/94/Eutv7qs7_o.png" width="1027"></p> 
<p>当你重新开启haproxy服务，检测脚本会检测到，而后恢复本服务器的优先级，VIP重新回到本服务器。</p> 
<p><img alt="" height="377" src="https://images2.imgbox.com/23/59/1lvf4qas_o.png" width="981"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c74f0c988a0623a9b8ee534e1b01888f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">贪吃蛇（C语言详解）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a49829ba444ddb46cc58dc89b31ec7e3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">微服务系列：Spring Cloud 之 Feign、Ribbon、Hystrix 三者超时时间配置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>