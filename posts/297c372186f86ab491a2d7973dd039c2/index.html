<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【rk3588】环境搭建及系统编译 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/297c372186f86ab491a2d7973dd039c2/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【rk3588】环境搭建及系统编译">
  <meta property="og:description" content="开发板：ROC-RK3588S-PC
官方链接：Welcome to ROC-RK3588S-PC Manual — Firefly Wiki (t-firefly.com)
串口调试配置 一、产品介绍 — Firefly Wiki (t-firefly.com)，可以按照官方链接的说明在个人PC上使用串口。这个串口会输出rk3588的日志信息，同时也可以允许用户输入shell命令进行调试。但是还不能互相传文件。
我们使用串口可以查询到包括内核名称、节点名称、内核发行版本、内核版本、机器类型、处理器类型、硬件平台和操作系统。aarch64是ARMv8架构下的64位指令集架构的官方名称，有时也被人们称为ARM64。
注：作者在使用过程中碰到过串口不能输入shell命令的情况，只能查看日志信息。最终发现是USB转串口模块的问题，更换一个就好了。作者使用的是CH340型号的，不是开发板随带的。
ADB调式配置 除了上述使用串口调试外，我们还可以使用ADB，它是Android的命令行调试工具，但是我们编译的是buildroot系统，其实也可以使用ADB，这一点后面再解释。
连接OTG端口，也就是Type-C的USB口，这一个端口在烧录固件的时候也会用到
安装RK-USB驱动。注意，如果正确进入loader模式但一直找不到设备，可以尝试更换USB线。下载安装ADB工具。
打开命令行窗口，进入ADB根目录。执行adb shell命令，即可输入shell命令了。
交叉编译环境 通常情况下，我们会把编译环境搭建在Linux服务器或者虚拟机上，在那个上面进行编译，然后把编译的文件用在RK3588平台上。显然，Linux服务器或者虚拟机肯定不是和RK3399平台使用相同的架构。例如我们使用的服务器为：
服务器上是x86架构，RK3588是ARM64架构。这个时候就需要交叉编译，其实就是在x86机器上编译的东西放在arm64机器上用。所以，后需的代码工作都是在x86服务器上展开的。（关于怎么登录访问服务器这里就不展开了。。。）
服务器环境啥的都提前配置好了，这里暂时不介绍。
获取SDK 1. 编译 Linux 固件 — Firefly Wiki (t-firefly.com)
我们的计划是编译buildroot系统，那么需要厂商的Linuxsdk，压缩包文件为：rk3588_firefly-1.4.0b.tar.gz，我们使用的是方式一，首先获取的是SDK repo压缩包，将该包解压后再使用命令 .repo/repo/repo sync -l导出源代码。
解压之后其实就一个 .repo的隐藏文件夹。然后执行导出源代码命令。
最后还需要同步代码
以后，我们就可以使用第二个命令进行代码更新了。
Linux SDK 配置介绍 配置文件介绍 在 device/rockchip/rk3588/ 目录下，有不同板型的配置文件(xxxx.mk)，用于管理 SDK 每个环节的编译配置，可以查看一下
显然，根据名称，我们要使用的是roc-rk3588s-pc-buildroot.mk，因为我们要编译buildroot系统。
#**roc-rk3588s-pc-buildroot.mk**文件内容如下 CMD=`realpath $BASH_SOURCE` CUR_DIR=`dirname $CMD` source $CUR_DIR/itx-3588j-buildroot.mk # Kernel dts export RK_KERNEL_DTS=roc-rk3588s-pc-mipi101-M101014-BE45-A1 # PRODUCT MODEL export RK_PRODUCT_MODEL=ROC_RK3588S_PC 前3行代码使用 source 命令来执行位于当前脚本同一目录下的 itx-3588j-buildroot.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-29T18:54:12+08:00">
    <meta property="article:modified_time" content="2024-08-29T18:54:12+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【rk3588】环境搭建及系统编译</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>开发板：ROC-RK3588S-PC</p> 
<p>官方链接：<a href="https://wiki.t-firefly.com/zh_CN/ROC-RK3588S-PC/index.html#" rel="nofollow">Welcome to ROC-RK3588S-PC Manual — Firefly Wiki (t-firefly.com)</a></p> 
<h4><a id="_4"></a>串口调试配置</h4> 
<p><a href="https://wiki.t-firefly.com/USB-TO-TTL-Serial/usb-to-ttl-serial.html" rel="nofollow">一、产品介绍 — Firefly Wiki (t-firefly.com)</a>，可以按照官方链接的说明在个人PC上使用串口。这个串口会输出rk3588的日志信息，同时也可以允许用户输入shell命令进行调试。但是还不能互相传文件。</p> 
<p><img src="https://images2.imgbox.com/82/38/9Lr6patl_o.png" alt="在这里插入图片描述"></p> 
<p>我们使用串口可以查询到包括内核名称、节点名称、内核发行版本、内核版本、机器类型、处理器类型、硬件平台和操作系统。aarch64是ARMv8架构下的64位指令集架构的官方名称，有时也被人们称为ARM64。</p> 
<p>注：作者在使用过程中碰到过串口不能输入shell命令的情况，只能查看日志信息。最终发现是USB转串口模块的问题，更换一个就好了。作者使用的是CH340型号的，不是开发板随带的。</p> 
<h4><a id="ADB_15"></a>ADB调式配置</h4> 
<p>除了上述使用串口调试外，我们还可以使用ADB，它是Android的命令行调试工具，但是我们编译的是buildroot系统，其实也可以使用ADB，这一点后面再解释。</p> 
<p>连接OTG端口，也就是Type-C的USB口，这一个端口在烧录固件的时候也会用到</p> 
<p>安装RK-USB驱动。注意，如果正确进入loader模式但一直找不到设备，可以尝试更换USB线。下载安装ADB工具。</p> 
<p>打开命令行窗口，进入ADB根目录。执行<strong>adb shell</strong>命令，即可输入shell命令了。</p> 
<p><img src="https://images2.imgbox.com/c6/5e/LCFKm0D5_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_27"></a>交叉编译环境</h4> 
<p>通常情况下，我们会把编译环境搭建在Linux服务器或者虚拟机上，在那个上面进行编译，然后把编译的文件用在RK3588平台上。显然，Linux服务器或者虚拟机肯定不是和RK3399平台使用相同的架构。例如我们使用的服务器为：</p> 
<p><img src="https://images2.imgbox.com/62/78/5luCbTlp_o.png" alt="在这里插入图片描述"></p> 
<p>服务器上是x86架构，RK3588是ARM64架构。这个时候就需要交叉编译，其实就是在x86机器上编译的东西放在arm64机器上用。所以，后需的代码工作都是在x86服务器上展开的。（关于怎么登录访问服务器这里就不展开了。。。）</p> 
<p>服务器环境啥的都提前配置好了，这里暂时不介绍。</p> 
<h4><a id="SDK_37"></a>获取SDK</h4> 
<p><a href="https://wiki.t-firefly.com/zh_CN/ROC-RK3588S-PC/linux_compile.html#huo-qu-sdk" rel="nofollow">1. 编译 Linux 固件 — Firefly Wiki (t-firefly.com)</a></p> 
<p>我们的计划是编译buildroot系统，那么需要厂商的Linuxsdk，压缩包文件为：<strong>rk3588_firefly-1.4.0b.tar.gz</strong>，我们使用的是方式一，首先获取的是SDK repo压缩包，将该包解压后再使用命令 <strong>.repo/repo/repo sync -l</strong>导出源代码。</p> 
<p><img src="https://images2.imgbox.com/78/c8/1eshofcH_o.png" alt="在这里插入图片描述"></p> 
<p>解压之后其实就一个 <strong>.repo</strong>的隐藏文件夹。然后执行导出源代码命令。</p> 
<p><img src="https://images2.imgbox.com/8e/b2/f9l357TA_o.png" alt="在这里插入图片描述"></p> 
<p>最后还需要同步代码</p> 
<p><img src="https://images2.imgbox.com/e7/20/FNPdJkfN_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ab/0f/kwqCbeZO_o.png" alt="在这里插入图片描述"></p> 
<p>以后，我们就可以使用第二个命令进行代码更新了。</p> 
<p><img src="https://images2.imgbox.com/dd/db/8Vsflh1I_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Linux_SDK__62"></a>Linux SDK 配置介绍</h4> 
<h5><a id="_64"></a>配置文件介绍</h5> 
<p>在 <code>device/rockchip/rk3588/</code> 目录下，有不同板型的配置文件(xxxx.mk)，用于管理 SDK 每个环节的编译配置，可以查看一下</p> 
<p><img src="https://images2.imgbox.com/de/70/KcmuFLSh_o.png" alt="在这里插入图片描述"></p> 
<p>显然，根据名称，我们要使用的是<strong>roc-rk3588s-pc-buildroot.mk</strong>，因为我们要编译buildroot系统。</p> 
<pre><code class="prism language-txt">#**roc-rk3588s-pc-buildroot.mk**文件内容如下

CMD=`realpath $BASH_SOURCE`
CUR_DIR=`dirname $CMD`

source $CUR_DIR/itx-3588j-buildroot.mk

# Kernel dts
export RK_KERNEL_DTS=roc-rk3588s-pc-mipi101-M101014-BE45-A1

# PRODUCT MODEL
export RK_PRODUCT_MODEL=ROC_RK3588S_PC
</code></pre> 
<p>前3行代码使用 <code>source</code> 命令来执行位于当前脚本同一目录下的 <code>itx-3588j-buildroot.mk</code> 文件。该文件内容如下：</p> 
<pre><code>CMD=`realpath $BASH_SOURCE`
CUR_DIR=`dirname $CMD`

source $CUR_DIR/BoardConfig.mk

# Kernel defconfig fragment
export RK_KERNEL_DEFCONFIG_FRAGMENT="$RK_KERNEL_DEFCONFIG_FRAGMENT firefly-linux.config"

# Uboot_defconfig_fragment
export RK_UBOOT_DEFCONFIG_FRAGMENT=firefly-linux.config

# parameter for GPT table
export RK_PARAMETER=parameter-ubuntu-fit.txt

# Kernel dts
export RK_KERNEL_DTS=rk3588-firefly-itx-3588j-mipi101-M101014-BE45-A1

# Set userdata partition type
export RK_USERDATA_FS_TYPE=ext4

# Set extboot
export FF_EXTBOOT=true

export FF_EXTBOOT_SIZE=256M

# PRODUCT MODEL
export RK_PRODUCT_MODEL=ITX_3588J

# recovery ramdisk
export RK_RECOVERY_RAMDISK=rk3588-recovery-arm64.cpio.gz

# Recovery config
export RK_CFG_RECOVERY=

# Buildroot config
export RK_CFG_BUILDROOT=firefly_rk3588

export RK_EXTRA_PARTITIONS=

# packagefile for make update image
export RK_PACKAGE_FILE=rk3588-ubuntu-package-file
</code></pre> 
<p>前3行代码使用 <code>source</code> 命令来执行位于当前脚本同一目录下的 <code>BoardConfig.mk</code> 文件，该文件内容如下：</p> 
<pre><code>#!/bin/bash

# Target arch
export RK_ARCH=arm64
# Uboot defconfig
export RK_UBOOT_DEFCONFIG=rk3588
# Uboot image format type: fit(flattened image tree)
export RK_UBOOT_FORMAT_TYPE=fit
# Kernel defconfig
export RK_KERNEL_DEFCONFIG=rockchip_linux_defconfig
# Kernel defconfig fragment
export RK_KERNEL_DEFCONFIG_FRAGMENT=rk3588_linux.config
# Kernel dts
export RK_KERNEL_DTS=rk3588-evb3-lp5-v10-linux
# boot image type
export RK_BOOT_IMG=boot.img
# kernel image path
export RK_KERNEL_IMG=kernel/arch/arm64/boot/Image
# kernel image format type: fit(flattened image tree)
export RK_KERNEL_FIT_ITS=boot.its
# parameter for GPT table
export RK_PARAMETER=parameter.txt
# Buildroot config
export RK_CFG_BUILDROOT=rockchip_rk3588
# Recovery config
export RK_CFG_RECOVERY=rockchip_rk3588_recovery
# Recovery image format type: fit(flattened image tree)
export RK_RECOVERY_FIT_ITS=boot4recovery.its
# ramboot config
export RK_CFG_RAMBOOT=
# Pcba config
export RK_CFG_PCBA=rockchip_rk3588_pcba
# Build jobs
export RK_JOBS=12
# target chip
export RK_TARGET_PRODUCT=rk3588
# Set rootfs type, including ext2 ext4 squashfs
export RK_ROOTFS_TYPE=ext4
# debian version (debian10: buster, debian11: bullseye)
export RK_DEBIAN_VERSION=bullseye
# yocto machine
export RK_YOCTO_MACHINE=rockchip-rk3588-evb
# rootfs image path
export RK_ROOTFS_IMG=rockdev/rootfs.${RK_ROOTFS_TYPE}
# Set ramboot image type
export RK_RAMBOOT_TYPE=
# &lt;dev&gt;:&lt;mount point&gt;:&lt;fs type&gt;:&lt;mount flags&gt;:&lt;source dir&gt;:&lt;image size(M|K|auto)&gt;:[options]
export RK_EXTRA_PARTITIONS=" \
	oem:/oem:ext2:defaults:oem_normal:auto:resize
	userdata:/userdata:ext2:defaults:userdata_normal:auto:resize
"
# OEM build on buildroot
#export RK_OEM_BUILDIN_BUILDROOT=YES
#misc image
export RK_MISC=wipe_all-misc.img
#choose enable distro module
export RK_DISTRO_MODULE=
# Define pre-build script for this board
export RK_BOARD_PRE_BUILD_SCRIPT=app-build.sh
# Define package-file
export RK_PACKAGE_FILE=rk3588-package-file
# Define WiFi BT chip
# Compatible with Realtek and AP6XXX WiFi : RK_WIFIBT_CHIP=ALL_AP
# Compatible with Realtek and CYWXXX WiFi : RK_WIFIBT_CHIP=ALL_CY
# Single WiFi configuration: AP6256 or CYW43455: RK_WIFIBT_CHIP=AP6256
export RK_WIFIBT_CHIP=ALL_AP
# Define BT ttySX
export RK_WIFIBT_TTY=ttyS8

</code></pre> 
<p>配置文件指定了DTS文件和分区表文件等其他文件。上述配置文件中是</p> 
<p><code>RK_KERNEL_DTS = roc-rk3588s-pc-mipi101-M101014-BE45-A1</code></p> 
<p><code>RK_PARAMETER = parameter-ubuntu-fit.txt</code></p> 
<h5><a id="_214"></a>分区说明</h5> 
<p>parameter.txt 文件中包含了固件的分区信息，以 parameter-ubuntu-fit.txt 为例：</p> 
<p>路径：<code>device\rockchip\rk3588\parameter-ubuntu-fit.txt</code></p> 
<pre><code>FIRMWARE_VER: 1.0
MACHINE_MODEL: RK3588
MACHINE_ID: 007
MANUFACTURER: RK3588
MAGIC: 0x5041524B
ATAG: 0x00200800
MACHINE: 0xffffffff
CHECK_MASK: 0x80
PWR_HLD: 0,0,A,0,1
TYPE: GPT
CMDLINE: mtdparts=rk29xxnand:0x00004000@0x00004000(uboot),0x00002000@0x00008000(misc),0x00080000@0x0000a000(boot:bootable),0x00040000@0x0008a000(recovery),0x00010000@0x000ca000(backup),0x00c00000@0x000da000(rootfs),-@0x00cda000(userdata:grow)
uuid:rootfs=614e0000-0000-4b53-8000-1d28000054a9

</code></pre> 
<p>CMDLINE 属性是我们关注的地方，以 misc 为例， 0x00002000@0x00008000(uboot) 中 0x00008000 为uboot 分区的起始位置，0x00002000 为分区的大小，以此类推。</p> 
<p>package-file 文件用于打包固件时确定需要的分区镜像和镜像路径，同时它需要与 parameter.txt 文件保持一致。</p> 
<p>路径：<code>tools/linux/Linux_Pack_Firmware/rockdev/rk3588-package-file</code></p> 
<h4><a id="Buildroot_244"></a>编译Buildroot固件</h4> 
<p>说一句题外话，可以使用如下命令查询SDK版本：</p> 
<pre><code class="prism language-shell">zhudk@vm1:/expand/zhudk/rk3588_firefly$ readlink <span class="token parameter variable">-f</span> .repo/manifest.xml
/expand/zhudk/rk3588_firefly/.repo/manifests/rk3588/rk3588_linux_release_20240517_v1.4.0b.xml
</code></pre> 
<h5><a id="_253"></a>编译前配置</h5> 
<p>在 <code>device/rockchip/rk3588/</code> 目录下，有不同板型的配置文件，选择配置文件：</p> 
<p><img src="https://images2.imgbox.com/e2/78/GRT3yPV3_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_259"></a>全自动编译</h5> 
<p>全自动编译会执行上述编译、打包操作，生成 RK 固件。</p> 
<pre><code>./build.sh
</code></pre> 
<p>打包固件，生成的完整固件会保存到 <code>rockdev/pack/</code> 目录。</p> 
<h5><a id="_269"></a>部分编译</h5> 
<ul><li>编译 u-boot</li></ul> 
<pre><code>./build.sh uboot
</code></pre> 
<ul><li>编译 kernel</li></ul> 
<pre><code>./build.sh extboot
</code></pre> 
<ul><li>编译 recovery</li></ul> 
<pre><code>./build.sh recovery
</code></pre> 
<ul><li>编译 buildroot</li></ul> 
<pre><code>./build.sh rootfs
</code></pre> 
<ul><li>更新各部分镜像链接到 <code>rockdev/</code> 目录：</li></ul> 
<pre><code>./mkfirmware.sh
</code></pre> 
<ul><li>打包固件，生成的完整固件会保存到 <code>rockdev/pack/</code> 目录。</li></ul> 
<pre><code>./build.sh updateimg
</code></pre> 
<p>编译完成后 <code>rockdev/</code> 目录如下</p> 
<p><img src="https://images2.imgbox.com/bb/e5/Xq2Ga09C_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="USB_313"></a>使用USB线缆升级固件</h4> 
<p>USB驱动和烧录工具不做解释，如果遇到问题可以尝试更换工具版本或者USB线缆。</p> 
<h5><a id="_317"></a>进入升级模式</h5> 
<p>通常我们升级固件的模式有两种，分别是Loader模式和MaskRom模式。烧写固件前，我们需要连接好设备，并让板子进入到可升级模式。</p> 
<p><code>MaskRom</code> 模式是设备变砖的最后一条防线。强行进入 <code>MaskRom</code> 涉及硬件操作，有一定风险，因此仅在设备进入不了 <code>Loader</code> 模式的情况下，方可尝试 <code>MaskRom</code> 模式。进入 <code>MaskRom</code> 的原理是人为的把 EMMC 的数据脚与地线短接，系统会认为 EMMC 数据出错，从而清除 EMMC 数据。可以按maskrom 按键，然后进行上电，此时设备就会进入 MaskRom 模式。</p> 
<p>进入<code>Loader</code>模式也有几种方式</p> 
<ul><li>在串口调试终端或adb shell给板子运行以下命令<code>reboot loader</code>。</li><li>保持板子上电，先按住<code>RECOVERY</code>键并保持，再按住<code>RESET</code>按键大约两秒钟（其实可以看日志）后，松开<code>RECOVERY</code>键。</li></ul> 
<h5><a id="_328"></a>烧写统一固件</h5> 
<p>统一固件是由分区表、bootloader、uboot、kernel、system等所有文件打包合并成的单个文件。Firefly正式发布的固件都是采用统一固件格式，升级统一固件将会更新主板上所有分区的数据和分区表，并且擦除主板上所有数据。</p> 
<p><img src="https://images2.imgbox.com/c9/a7/WTrSm56R_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_334"></a>烧写分区镜像</h5> 
<p>即各个功能独立的文件，如分区表、bootloader、kernel等，在开发阶段生成。独立分区镜像可以只更新指定的分区，而保持其它分区数据不被破坏，在开发过程中会很方便调试。<br> <img src="https://images2.imgbox.com/47/32/wHD4QFcx_o.png" alt="在这里插入图片描述"></p> 
<p>如果我们做驱动开发，其实可以仅烧录<code>boot.img</code>。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/103fca9d0616dac63410e95a339f594d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">从 7000 余项目脱颖而出，飞轮科技《新一代实时分析数据仓库解决方案》荣获 HICOOL 2024 全球创业大赛二等奖</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2d8a8845471b8eac52a66e6405574341/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">20240830 每日AI必读资讯</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>