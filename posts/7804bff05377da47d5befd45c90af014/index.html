<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ELK日志系统 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/7804bff05377da47d5befd45c90af014/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="ELK日志系统">
  <meta property="og:description" content="目录
ELK概念
ELK实验
数据流向
架构
步骤
安装elasticsearch
安装logstash
es的主从和数据模式
ELK索引数据管理
创建数据
修改数据
删除数据
创建日志收集系统
安装kibana
httpd日志收集脚本
ELKF
ELKF概念
filebeat远程收集nginx日志
操作
filebeat远程收集nginx、httpd、mysqld日志
ELK概念 ELK是一套完整的日志集中处理方案。
E：ElasticSearck 简称ES 分布式索引型非关系型数据库，用来存储logstash输出的日志 ，它是一个全文检索引擎，保存的格式是json格式
L：logstash 是基于Java语言开发的，用来作数据收集引擎、日志的收集。可以对数据进行过滤，分析，汇总，以标准格式输出
K：Kibana 是ES的可视化工具，对ES存储的数据进行可视化展示，分析和检索。
ELK实验 数据流向 架构 192.168.233.10 ES1
192.168.233.20 ES2
192.168.233.30 logstash&#43;Kibana&#43;nginx/http
步骤 1.安装ntpdate（所有设备都要安装） yum -y install ntpdate -y
然后查看时间是否一致
安装elasticsearch 2.在ES1和ES2（同步操作）
yum -y install java
安装 elasticsearch-6.7.2
rpm -ivh elasticsearch-6.7.2.rpm
然后配置elasticsearch
vim /etc/elasticsearch/elasticsearch.yml
ES1改为
ES2改为
然后检查配置文件是否有错
grep -v &#34;^#&#34; /etc/elasticsearch/elasticsearch.yml">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-02T16:11:16+08:00">
    <meta property="article:modified_time" content="2024-08-02T16:11:16+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ELK日志系统</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="ELK%E6%A6%82%E5%BF%B5-toc" style="margin-left:0px;"><a href="#ELK%E6%A6%82%E5%BF%B5" rel="nofollow">ELK概念</a></p> 
<p id="ELK%E5%AE%9E%E9%AA%8C-toc" style="margin-left:0px;"><a href="#ELK%E5%AE%9E%E9%AA%8C" rel="nofollow">ELK实验</a></p> 
<p id="%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91-toc" style="margin-left:40px;"><a href="#%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91" rel="nofollow">数据流向</a></p> 
<p id="%E6%9E%B6%E6%9E%84-toc" style="margin-left:40px;"><a href="#%E6%9E%B6%E6%9E%84" rel="nofollow">架构</a></p> 
<p id="%E6%AD%A5%E9%AA%A4-toc" style="margin-left:40px;"><a href="#%E6%AD%A5%E9%AA%A4" rel="nofollow">步骤</a></p> 
<p id="%E5%AE%89%E8%A3%85elasticsearch-toc" style="margin-left:80px;"><a href="#%E5%AE%89%E8%A3%85elasticsearch" rel="nofollow">安装elasticsearch</a></p> 
<p id="%E5%AE%89%E8%A3%85logstash-toc" style="margin-left:80px;"><a href="#%E5%AE%89%E8%A3%85logstash" rel="nofollow">安装logstash</a></p> 
<p id="es%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%92%8C%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%BC%8F-toc" style="margin-left:40px;"><a href="#es%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%92%8C%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%BC%8F" rel="nofollow">es的主从和数据模式</a></p> 
<p id="ELK%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86-toc" style="margin-left:40px;"><a href="#ELK%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86" rel="nofollow">ELK索引数据管理</a></p> 
<p id="%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE-toc" style="margin-left:80px;"><a href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE" rel="nofollow">创建数据</a></p> 
<p id="%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE-toc" style="margin-left:80px;"><a href="#%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE" rel="nofollow">修改数据</a></p> 
<p id="%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE-toc" style="margin-left:80px;"><a href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE" rel="nofollow">删除数据</a></p> 
<p id="%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F-toc" style="margin-left:40px;"><a href="#%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F" rel="nofollow">创建日志收集系统</a></p> 
<p id="%E5%AE%89%E8%A3%85kibana-toc" style="margin-left:80px;"><a href="#%E5%AE%89%E8%A3%85kibana" rel="nofollow">安装kibana</a></p> 
<p id="httpd%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E8%84%9A%E6%9C%AC-toc" style="margin-left:80px;"><a href="#httpd%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E8%84%9A%E6%9C%AC" rel="nofollow">httpd日志收集脚本</a></p> 
<p id="ELKF-toc" style="margin-left:0px;"><a href="#ELKF" rel="nofollow">ELKF</a></p> 
<p id="ELKF%E6%A6%82%E5%BF%B5-toc" style="margin-left:40px;"><a href="#ELKF%E6%A6%82%E5%BF%B5" rel="nofollow">ELKF概念</a></p> 
<p id="filebeat%E8%BF%9C%E7%A8%8B%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97-toc" style="margin-left:40px;"><a href="#filebeat%E8%BF%9C%E7%A8%8B%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97" rel="nofollow">filebeat远程收集nginx日志</a></p> 
<p id="%E6%93%8D%E4%BD%9C-toc" style="margin-left:80px;"><a href="#%E6%93%8D%E4%BD%9C" rel="nofollow">操作</a></p> 
<p id="filebeat%E8%BF%9C%E7%A8%8B%E6%94%B6%E9%9B%86nginx%E3%80%81httpd%E3%80%81mysqld%E6%97%A5%E5%BF%97-toc" style="margin-left:40px;"><a href="#filebeat%E8%BF%9C%E7%A8%8B%E6%94%B6%E9%9B%86nginx%E3%80%81httpd%E3%80%81mysqld%E6%97%A5%E5%BF%97" rel="nofollow">filebeat远程收集nginx、httpd、mysqld日志</a></p> 
<p id="-toc" style="margin-left:0px;"></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 style="background-color:transparent;">ELK概念</h2> 
<p>ELK是一套完整的日志集中处理方案。</p> 
<p>E：ElasticSearck 简称ES 分布式索引型非关系型数据库，用来存储logstash输出的日志 ，它是一个全文检索引擎，保存的格式是json格式</p> 
<p>L：logstash 是基于Java语言开发的，用来作数据收集引擎、日志的收集。可以对数据进行过滤，分析，汇总，以标准格式输出</p> 
<p>K：Kibana 是ES的可视化工具，对ES存储的数据进行可视化展示，分析和检索。</p> 
<h2 id="ELK%E5%AE%9E%E9%AA%8C" style="background-color:transparent;">ELK实验</h2> 
<h3 id="%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%91" style="background-color:transparent;">数据流向</h3> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/af/3b/f19E5KUM_o.png"></p> 
<h3 id="%E6%9E%B6%E6%9E%84">架构</h3> 
<p>192.168.233.10 ES1</p> 
<p>192.168.233.20 ES2</p> 
<p>192.168.233.30 logstash+Kibana+nginx/http</p> 
<h3 id="%E6%AD%A5%E9%AA%A4" style="background-color:transparent;">步骤</h3> 
<p>1.安装ntpdate（所有设备都要安装） </p> 
<p>yum -y install ntpdate -y</p> 
<p>然后查看时间是否一致</p> 
<p><img alt="" src="https://images2.imgbox.com/ec/69/jjGLGObS_o.png"></p> 
<h4 id="%E5%AE%89%E8%A3%85elasticsearch">安装elasticsearch</h4> 
<p>2.在ES1和ES2（同步操作）</p> 
<p>yum -y install java</p> 
<p>安装 elasticsearch-6.7.2</p> 
<p>rpm -ivh elasticsearch-6.7.2.rpm</p> 
<p>然后配置elasticsearch</p> 
<p>vim /etc/elasticsearch/elasticsearch.yml</p> 
<p><img alt="" src="https://images2.imgbox.com/ee/fd/9nigoUyG_o.png"></p> 
<p>ES1改为<img alt="" src="https://images2.imgbox.com/ac/ea/5HKm6vsV_o.png"></p> 
<p style="text-align:center;">ES2改为<img alt="" src="https://images2.imgbox.com/68/2a/JYprqqG8_o.png"></p> 
<p></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/74/78/inY8xQpu_o.png"></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/53/4d/S1qWaYio_o.png"></p> 
<p style="text-align:center;"><img alt="" height="100" src="https://images2.imgbox.com/6f/bf/Pgx6T8H2_o.png" width="30"><img alt="" src="https://images2.imgbox.com/90/88/jEqzeqN1_o.png"></p> 
<p>然后检查配置文件是否有错</p> 
<p>grep -v "^#" /etc/elasticsearch/elasticsearch.yml</p> 
<p>systemctl restart elasticsearch.service</p> 
<p>netstat -antp | grep 9200</p> 
<p>报错日志 tail -f /var/log/elasticsearch/elk-cluster.log</p> 
<p>访问浏览器看看是否正常 192.168.233.10:9200</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/33/67/ramBurTY_o.png"></p> 
<p>3.两台ES都安装以下三个软件（同步操作）</p> 
<p>node：基于谷歌浏览器的运行环境</p> 
<p>phantomjs：虚拟浏览器</p> 
<p>es-head-master：es的独立可视化工具，可以实现分片索引数据的可视化展示</p> 
<p>两台ES同步操作：</p> 
<p>把node-v8.2.1.tar、phantomjs-2.1.1-linux-x86_64.tar、elasticsearch-head-master拖进虚拟机</p> 
<p>yum -y install gcc gcc-c++ make</p> 
<p>tar -xf node-v8.2.1.tar.gz</p> 
<p>cd node-v8.2.1/</p> 
<p>./configure</p> 
<p>make -j 4 &amp;&amp; make install</p> 
<p>cd /opt/</p> 
<p>tar -xf phantomjs-2.1.1-linux-x86_64.tar.bz2</p> 
<p>cd /opt/phantomjs-2.1.1-linux-x86_64/</p> 
<p>cd bin/</p> 
<p>cp phantomjs /usr/local/bin/</p> 
<p>cd /opt/</p> 
<p>unzip elasticsearch-head-master.zip</p> 
<p>cd elasticsearch-head-master/</p> 
<p>npm config set registry http://registry.npm.taobao.org/    指定淘宝镜像</p> 
<p>npm install</p> 
<p>vim /etc/elasticsearch/elasticsearch.yml</p> 
<p>在最后添加</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/1a/60/4DUMVsqs_o.png"></p> 
<p>http.cors.enabled: true</p> 
<p>http.cors.allow-origin: "*"</p> 
<p>然后</p> 
<p>systemctl restart elasticsearch.service</p> 
<p>netstat -antp | grep 9200</p> 
<p>npm run start &amp;</p> 
<p>然后访问可视化工具地址 192.168.233.10:9100</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/e8/b1/IyVKyoOp_o.png"></p> 
<p>然后把localhost换成IP地址<img alt="" src="https://images2.imgbox.com/e9/80/wrUR27aM_o.png"></p> 
<p>然后在主ES1创建数据（ES也会同步）</p> 
<p>curl -X PUT 'localhost:9200/index-demo/test/1?pretty&amp;pretty' -H 'content-Type: application/json' -d '{"user":"zhangsan","mesg":"hello world"}'</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/68/2d/SmjPgQtQ_o.png"></p> 
<p>注：每创建一个指名的索引类型都会对数据进行分片</p> 
<p>       高亮的就是主键，不亮的就是副键</p> 
<h4 id="%E5%AE%89%E8%A3%85logstash" style="background-color:transparent;">安装logstash</h4> 
<p>4.在30上操作安装logstash</p> 
<p>yum -y install httpd</p> 
<p>systemctl restart httpd</p> 
<p>yum -y install java</p> 
<p>把logstash-6.7.2拖进30虚拟机</p> 
<p>rpm -ivh logstash-6.7.2.rpm</p> 
<p>systemctl restart logstash.service</p> 
<p>ln -s /usr/share/logstash/bin/logstash /usr/local/bin/<br><span style="color:#fe2c24;">#可以指定logstash的工作目录，默认为：/etc/logstash/conf.d<br> 修改 vim /logstash.yml 然后在最后修改为 path.config: /opt/log</span></p> 
<p>5.测试 Logstash 实例</p> 
<p>logstash -e 'input { stdin{} } output { stdout{} }'</p> 
<p><br><img alt="" src="https://images2.imgbox.com/7d/64/eMtoXXmr_o.png"></p> 
<p>在这个下面输入www.baidu.com</p> 
<p>结果</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/48/5d/XRUzEXL3_o.png"></p> 
<p>把数据发送到ES1和ES2</p> 
<p>logstash -e 'input { stdin{} } output { elasticsearch { hosts=&gt;["192.168.233.10:9200","192.168.233.20:9200"] } }' --path.data /opt/test1</p> 
<p>如果报错</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/02/99/RGTGzEtj_o.png"></p> 
<p>是因为后面没有加--path.data /opt/test1</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/22/be/d31D7JE6_o.png"></p> 
<p>在下面输入网址</p> 
<p>www.baidu.com</p> 
<p>结果</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/f6/ed/HTfK3r9K_o.png"></p> 
<h3 id="es%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%92%8C%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%BC%8F">es的主从和数据模式</h3> 
<p>node.master: true</p> 
<p>es数据库的主从类型 true/false</p> 
<p>node.data: true</p> 
<p>数据节点，是否保存数据，logstash发送数据，节点是否接收以及保存</p> 
<h3 id="ELK%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86">ELK索引数据管理</h3> 
<p>es如何创建，修改，删除数据  </p> 
<p>通过http的方式创建数据，post方式修改数据</p> 
<h4 id="%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE">创建数据</h4> 
<p>curl -X PUT 'localhost:9200/index-demo/test/1?pretty&amp;pretty' -H 'content-Type: application/json' -d '{"user":"zhangsan","mesg":"hello world"}'<br> 对应的就是本地数据量的地址 IP+端口</p> 
<p>put就是创建数据</p> 
<p>index-demo  创建索引分片的名称</p> 
<p>test   数据的名称</p> 
<p>1 数据的id字段</p> 
<p>?pretty&amp;pretty 参数设定为json格式</p> 
<p>-d  数据的具体内容</p> 
<p>user":"zhangsan","mesg":"hello world  内容</p> 
<h4 id="%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE">修改数据</h4> 
<p>curl -X POST 'localhost:9200/index-demo/test/1/_update?pretty' -H 'Content-Type: application/json' -d '{  "doc": {    "user": "zhangsan",    "mesg": "hello1 world1"  } }'</p> 
<h4 id="%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE">删除数据</h4> 
<p>curl -X DELETE 'localhost:9200/index-demo/test/1?pretty&amp;pretty' -H 'content-Type: application/json' -d '{"user":"zhangsan","mesg":"hello1 world1"}'</p> 
<h3 id="%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F" style="background-color:transparent;">创建日志收集系统</h3> 
<p>1.在30上面操作写一个脚本</p> 
<p>cd /etc/logstash/conf.d/</p> 
<p>vim system.conf （system可以随便写）</p> 
<pre><code class="language-bash">input {

    file {

         path =&gt;"/var/log/messages"
         type =&gt;"system"
         start_position =&gt;"beginning"
           }
 }

output {

     elasticsearch {
              hosts=&gt;["192.168.233.10:9200","192.168.233.20:9200"]
              index =&gt;"system-%{+YYYY.MM.dd}"
                }
}
</code></pre> 
<p>然后赋权 chmod 777 /var/log/messages</p> 
<p>启动</p> 
<p>logstash -f system.conf --path.data /opt/test2 &amp;</p> 
<p>结果</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/6a/8d/etRPHVEh_o.png"></p> 
<p>即为创建成功</p> 
<h4 id="%E5%AE%89%E8%A3%85kibana">安装kibana</h4> 
<p>2.在30上安装kibana</p> 
<p>把kibana-6.7.2-x86_64拖入30服务器中</p> 
<p>cd /opt/<br> rpm -ivh kibana-6.7.2-x86_64.rpm</p> 
<p>vim /etc/kibana/kibana.yml</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/4e/7a/AWf2mO1z_o.png"><img alt="" src="https://images2.imgbox.com/ac/ae/cuo89hVo_o.png"><img alt="" src="https://images2.imgbox.com/b2/65/fY1xQTuP_o.png"></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/72/03/konSRt88_o.png"></p> 
<p><img alt="" src="https://images2.imgbox.com/f4/c9/h9C0V9Cp_o.png"></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/ed/63/4ChXQFXo_o.png"></p> 
<p>然后  touch /var/log/kibana.log</p> 
<p>chown kibana.kibana /var/log/kibana.log</p> 
<p>systemctl restart kibana.service</p> 
<p>systemctl enable kibana.service</p> 
<p>结果</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/9d/86/zyEO94IC_o.png"></p> 
<p>然后访问192.168.233.30:5601</p> 
<p>然后点击“自己浏览” 上面点击“否”</p> 
<p>同步数据</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/7c/14/ByZz1UqI_o.png"></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/c7/ac/1QibkfMY_o.png"><img alt="" src="https://images2.imgbox.com/62/af/ejihlLHN_o.png"><img alt="" src="https://images2.imgbox.com/98/01/ZvQh7MZ6_o.png"><img alt="" src="https://images2.imgbox.com/7d/ef/088nEt0n_o.png"></p> 
<h4 id="httpd%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E8%84%9A%E6%9C%AC">httpd日志收集脚本</h4> 
<p>cd /etc/logstash/conf.d/</p> 
<p>vim http.conf</p> 
<pre><code class="language-bash">input {

    file {

       path =&gt; "/etc/httpd/logs/access_log"
       type =&gt; "access"
       start_position =&gt; "beginning"
   }

        file {

       path =&gt; "/etc/httpd/logs/error_log"
       type =&gt; "error"
       start_position =&gt; "beginning"
   }

}

output {

       if [type] == "access" {

        elasticsearch {
        hosts =&gt; ["192.168.233.10:9200","192.168.233.20:9200"]
        index =&gt; "apache_access-%{+YYYY.MM.dd}"
           }

      }

      if [type] == "error" {

        elasticsearch {
        hosts =&gt; ["192.168.233.10:9200","192.168.233.20:9200"]
        index =&gt; "apache_error-%{+YYYY.MM.dd}"
           }

      }

}
</code></pre> 
<p>启动 </p> 
<p>logstash -f http.conf --path.data /opt/test6 &amp;</p> 
<p>如果内存满了，可以清理缓存 echo 1 &gt; /proc/sys/vm/drop_caches</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/37/63/uLJmXz2o_o.png"></p> 
<p>注：API接口：是软件内部代码之间通信的接口即代码的连接，是代码之间调用的接口</p> 
<p>       端口是对外提供访问程序的内容结构</p> 
<h2 id="ELKF" style="background-color:transparent;">ELKF</h2> 
<h3 id="ELKF%E6%A6%82%E5%BF%B5">ELKF概念</h3> 
<p>F：filebeat 轻量级的开源日志文件数据收集器。logstah 占用系统资源比较大，属于重量级。有了filebeat可以节省资源，可以通过filebeat和logstash实现远程数据收集</p> 
<p>filebeat不能对数据进行标准输出，不能输出为ES格式的数据，所以需要logstash把filebeat数据作标准化处理。</p> 
<p>数据流向</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/32/3c/SnLM1tH0_o.png"></p> 
<h3 id="filebeat%E8%BF%9C%E7%A8%8B%E6%94%B6%E9%9B%86nginx%E6%97%A5%E5%BF%97" style="background-color:transparent;">filebeat远程收集nginx日志</h3> 
<p>filebeat的作用：可以在本机收集日志；也可以远程收集日志；是轻量级的日志收集系统，可以在非java环境运行</p> 
<p>logstash是在jvm环境中运行，资源消耗很大，启动一个logstash要消耗500M左右的内存</p> 
<p>filebeat只消耗10M左右的内存</p> 
<h4 id="%E6%93%8D%E4%BD%9C">操作</h4> 
<p>cd /opt/</p> 
<p>systemctl restart nginx</p> 
<p>tar -xf filebeat-6.7.2-linux-x86_64.tar.gz</p> 
<p>mv filebeat-6.7.2-linux-x86_64 /usr/local/filebeat</p> 
<p>cd /usr/local/filebeat/</p> 
<p>cp filebeat.yml filebeat.yml.bak</p> 
<p>vim filebeat.yml</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/3c/2f/MR548Uao_o.png"></p> 
<p>在第一个output取消注释</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/8e/69/hdUgfVGq_o.png"></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/bb/7f/yj0XrKzW_o.png"></p> 
<p>注：5044是logstash默认的端口，只要是logstash主机上没有被占用的端口都可以使用。必须大于1024</p> 
<p>回到logstash服务器</p> 
<p>cd /etc/logstash/conf.d/</p> 
<p>vim nginx_1.conf</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/c7/bf/0Yb3KUH2_o.png"></p> 
<p>然后回到filebeat</p> 
<p>开启收集数据</p> 
<p>nohup ./filebeat -e -c filebeat.yml &gt; filebeat.out &amp;</p> 
<p>nohup：在系统的后台运行，不会因为终端的关闭导致程序停止运行；可以把运行的日志保存到指定文件</p> 
<p>-e：输出到标准输出</p> 
<p>-c：指定配置文件</p> 
<p>然后回到logstash服务器</p> 
<p>logstash -f nginx_1.conf --path.data /opt/test5 &amp;</p> 
<p>然后访问192.168.233.30:5601 查看Kibana</p> 
<h3 id="filebeat%E8%BF%9C%E7%A8%8B%E6%94%B6%E9%9B%86nginx%E3%80%81httpd%E3%80%81mysqld%E6%97%A5%E5%BF%97">filebeat远程收集nginx、httpd、mysqld日志</h3> 
<p>打开mysql一般日志</p> 
<p>vim /etc/my.cnf</p> 
<p>添加</p> 
<p>general_log=ON<br> general_log_file=/usr/local/mysql/data/mysql_general.log</p> 
<p>systemctl restart mysqld</p> 
<p>systemctl restart httpd</p> 
<p>修改nginx的端口</p> 
<p>vim /usr/local/nginx/conf/nginx.conf</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/8f/66/yZZbQ5sn_o.png"></p> 
<p>因为httpd的端口也是80，两个端口一样不能同时启动，所以得把nginx的端口修改</p> 
<p>systemctl restart nginx</p> 
<p>vim filebeat.yml</p> 
<pre><code class="language-bash">- type: log
  enabled: true
  paths:
    - /usr/local/nginx/logs/access.log
    - /usr/local/nginx/logs/error.log
  tags: ["nginx"]
  fields:
    service_name: 192.168.233.70_nginx
    log_type: nginx
    from: 192.168.233.70

- type: log
  enabled: true
  paths:
    - /var/log/httpd/access_log
    - /var/log/httpd/error_log
  tags: ["httpd"]
  fields:
    service_name: 192.168.233.70_httpd
    log_type: httpd
    from: 192.168.233.70

- type: log
  enabled: true
  paths:
    - /usr/local/mysql/data/mysql_general.log
  tags: ["mysqld"]
  fields:
    service_name: 192.168.233.70_mysqld
    log_type: mysqld
    from: 192.168.233.70
</code></pre> 
<p>注：这里不能复制粘贴，容易出错，只能一个个手打</p> 
<p>因为我nginx是编译安装所以日志日志位置不一样，httpd是epel源安装的，注意看一下日志位置</p> 
<p> 在第一个output取消注释</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/81/13/Jejs0QtI_o.png"></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/13/d6/LEorTptL_o.png"></p> 
<p>注意：上面hosts有了，下面的就不能一样要修改</p> 
<p>然后回到logstash服务器上</p> 
<p>cd /etc/logstash/conf.d/</p> 
<p>vim mysql_1.conf</p> 
<pre><code class="language-bash">input {

   beats { port =&gt; "5045" }
}

output {

   if "nginx" in [tags] {

      elasticsearch {
              hosts=&gt;["192.168.233.10:9200","192.168.233.20:9200"]
              index =&gt; "%{[fields][service_name]}-%{+YYYY.MM.dd}"
                }

 }

if "httpd" in [tags] {

      elasticsearch {
              hosts=&gt;["192.168.233.10:9200","192.168.233.20:9200"]
              index =&gt; "%{[fields][service_name]}-%{+YYYY.MM.dd}"
                }

 }


if "mysqld" in [tags] {

      elasticsearch {
              hosts=&gt;["192.168.233.10:9200","192.168.233.20:9200"]
              index =&gt; "%{[fields][service_name]}-%{+YYYY.MM.dd}"
                }

}
}
</code></pre> 
<p></p> 
<p>然后回到filebeat</p> 
<p>开启收集数据</p> 
<p>nohup ./filebeat -e -c filebeat.yml &gt; filebeat.out &amp;</p> 
<p>然后回到logstash服务器</p> 
<p>logstash -f mysql_1.conf --path.data /opt/test5 &amp;</p> 
<p>然后访问192.168.233.10:9100</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/74/66/pzlxWd4t_o.png"></p> 
<p>然后访问192.168.233.30:5601 查看Kibana</p> 
<h2 style="background-color:transparent;"></h2>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5efb0db9ad7ea56a259161854d411f12/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">数仓: 1- 数据仓库基础</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/097670c7b43e3a12c928b7964bfaa145/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【查看Kafka存储日志时间】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>