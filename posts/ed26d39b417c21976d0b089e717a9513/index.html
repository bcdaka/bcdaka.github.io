<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微信小程序webview和小程序通讯 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/ed26d39b417c21976d0b089e717a9513/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="微信小程序webview和小程序通讯">
  <meta property="og:description" content="1.背景介绍 1.1需要在小程序嵌入vr页面，同时在vr页面添加操作按钮与小程序进行通信交互
1.2 开发工具：uniapp开发小程序
1.3原型图
功能：.点击体验官带看跳转小程序的体验官带看页面
功能：点击立即咨询唤起小程序弹窗打电话
2.组件及api介绍 uniapp官网：web-view | uni-app官网 (dcloud.net.cn)
web-view web-view 是一个 web 浏览器组件，可以用来承载网页的容器，会自动铺满整个页面（nvue 使用需要手动指定宽高）。
各小程序平台，web-view 加载的 url 需要在后台配置域名白名单，包括内部再次 iframe 内嵌的其他 url 。
属性说明
属性名类型说明平台差异说明srcStringwebview 指向网页的链接allowString用于为 iframe 指定其特征策略H5sandboxString该属性对呈现在 iframe 框架中的内容启用一些额外的限制条件。H5fullscreenBoolean是否铺满整个页面，默认值：true。H5 (HBuilder X 3.5.4&#43;)webview-stylesObjectwebview 的样式App-vueupdate-titleBoolean是否自动更新当前页面标题。默认值：trueApp-vue (HBuilder X 3.3.8&#43;)@messageEventHandler网页向应用 postMessage 时，会在特定时机（后退、组件销毁、分享）触发并收到消息。H5 暂不支持（可以直接使用 window.postMessage）@onPostMessageEventHandler网页向应用实时 postMessageApp-nvue@loadEventHandler网页加载成功时候触发此事件。微信小程序、支付宝小程序、抖音小程序、QQ小程序@errorEventHandler网页加载失败的时候触发此事件。微信小程序、支付宝小程序、抖音小程序、QQ小程序 在小程序端，用法和iframe类似，直接在src赋值在线地址
&lt;web-view src=&#34;https://uniapp.dcloud.io/static/web-view.html&#34;&gt;&lt;/web-view&gt; 注意：
小程序仅支持加载网络网页，不支持本地html小程序端 web-view 组件一定有原生导航栏，下面一定是全屏的 web-view 组件，navigationStyle: custom 对 web-view 组件无效。小程序平台， src 指向的链接需登录小程序管理后台配置域名白名单。小程序平台，个人类型与海外类型的小程序使用 web-view 组件，提交审核时注意微信等平台是否允许使用小程序的web-view使用的是小程序自带的浏览器内核，不同厂商不一样，详见各小程序平台，web-view 加载的 url 需要在后台配置域名白名单，包括内部再次 iframe 内嵌的其他 url 。 &lt;web-view&gt; 加载的网页中支持调用部分 uni 接口：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-25T09:16:38+08:00">
    <meta property="article:modified_time" content="2024-04-25T09:16:38+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微信小程序webview和小程序通讯</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>1.背景介绍</h3> 
<p>1.1需要在小程序嵌入vr页面，同时在vr页面添加操作按钮与小程序进行通信交互</p> 
<p>1.2 开发工具：uniapp开发小程序</p> 
<p>1.3原型图</p> 
<p>        功能：.点击体验官带看跳转小程序的体验官带看页面</p> 
<p><img alt="" height="599" src="https://images2.imgbox.com/4a/54/n3rkZnuc_o.png" width="912"></p> 
<p>         功能：点击立即咨询唤起小程序弹窗打电话</p> 
<p><img alt="" height="611" src="https://images2.imgbox.com/04/6e/tTyxQMTS_o.png" width="897"></p> 
<p></p> 
<h3>2.组件及api介绍</h3> 
<p>uniapp官网：<a href="https://uniapp.dcloud.net.cn/component/web-view.html" rel="nofollow" title="web-view | uni-app官网 (dcloud.net.cn)">web-view | uni-app官网 (dcloud.net.cn)</a></p> 
<h3 id="web-view">web-view</h3> 
<p><code>web-view</code> 是一个 web 浏览器组件，可以用来承载网页的容器，会自动铺满整个页面（nvue 使用需要手动指定宽高）。</p> 
<blockquote> 
 <p><span style="color:#fe2c24;">各小程序平台，web-view 加载的 url 需要在后台配置域名白名单，包括内部再次 iframe 内嵌的其他 url 。</span></p> 
</blockquote> 
<p><strong>属性说明</strong></p> 
<table><thead><tr><th>属性名</th><th>类型</th><th>说明</th><th>平台差异说明</th></tr></thead><tbody><tr><td>src</td><td>String</td><td>webview 指向网页的链接</td><td></td></tr><tr><td>allow</td><td>String</td><td>用于为 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/iframe" rel="nofollow" title="iframe">iframe</a> 指定其<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/%E7%AD%96%E7%95%A5%E7%89%B9%E5%BE%81" rel="nofollow" title="特征策略">特征策略</a></td><td>H5</td></tr><tr><td>sandbox</td><td>String</td><td>该属性对呈现在 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/iframe" rel="nofollow" title="iframe">iframe</a> 框架中的内容启用一些额外的限制条件。</td><td>H5</td></tr><tr><td>fullscreen</td><td>Boolean</td><td>是否铺满整个页面，默认值：<code>true</code>。</td><td>H5 (HBuilder X 3.5.4+)</td></tr><tr><td>webview-styles</td><td>Object</td><td>webview 的样式</td><td>App-vue</td></tr><tr><td>update-title</td><td>Boolean</td><td>是否自动更新当前页面标题。默认值：<code>true</code></td><td>App-vue (HBuilder X 3.3.8+)</td></tr><tr><td>@message</td><td>EventHandler</td><td><span style="color:#fe2c24;">网页向应用 <code>postMessage</code> 时，会在特定时机（后退、组件销毁、分享）触发并收到消息。</span></td><td>H5 暂不支持（可以直接使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage" rel="nofollow" title="window.postMessage">window.postMessage</a>）</td></tr><tr><td>@onPostMessage</td><td>EventHandler</td><td>网页向应用实时 <code>postMessage</code></td><td>App-nvue</td></tr><tr><td>@load</td><td>EventHandler</td><td>网页加载成功时候触发此事件。</td><td>微信小程序、支付宝小程序、抖音小程序、QQ小程序</td></tr><tr><td>@error</td><td>EventHandler</td><td>网页加载失败的时候触发此事件。</td><td>微信小程序、支付宝小程序、抖音小程序、QQ小程序</td></tr></tbody></table> 
<p>在小程序端，用法和iframe类似，直接在src赋值在线地址</p> 
<pre><code>&lt;web-view src="https://uniapp.dcloud.io/static/web-view.html"&gt;&lt;/web-view&gt;</code></pre> 
<p><span style="color:#fe2c24;"><strong>注意：</strong></span></p> 
<ul><li><span style="color:#fe2c24;">小程序仅支持加载网络网页，不支持本地html</span></li><li><span style="color:#fe2c24;">小程序端 web-view 组件一定有原生导航栏，下面一定是全屏的 web-view 组件，navigationStyle: custom 对 web-view 组件无效。</span></li><li><span style="color:#fe2c24;">小程序平台， <code>src</code> 指向的链接需登录小程序管理后台配置域名白名单。</span></li><li><span style="color:#fe2c24;">小程序平台，个人类型与海外类型的小程序使用 <code>web-view</code> 组件，提交审核时注意微信等平台是否允许使用</span></li><li><span style="color:#fe2c24;">小程序的web-view使用的是小程序自带的浏览器内核，不同厂商不一样，<a href="https://ask.dcloud.net.cn/article/1318" rel="nofollow" title="详见">详见</a></span></li><li><span style="color:#fe2c24;">各小程序平台，web-view 加载的 url 需要在后台配置域名白名单，包括内部再次 iframe 内嵌的其他 url 。</span></li></ul> 
<p><span style="color:#fe2c24;"><code>&lt;web-view&gt;</code> 加载</span>的网页中支持调用部分 uni 接口：</p> 
<table><thead><tr><th>方法名</th><th>说明</th><th>平台差异说明</th></tr></thead><tbody><tr><td>uni.navigateTo</td><td><a href="https://uniapp.dcloud.net.cn/api/router#navigateto" rel="nofollow" title="navigateTo">navigateTo</a></td><td></td></tr><tr><td>uni.redirectTo</td><td><a href="https://uniapp.dcloud.net.cn/api/router#redirectto" rel="nofollow" title="redirectTo">redirectTo</a></td><td></td></tr><tr><td>uni.reLaunch</td><td><a href="https://uniapp.dcloud.net.cn/api/router#relaunch" rel="nofollow" title="reLaunch">reLaunch</a></td><td></td></tr><tr><td>uni.switchTab</td><td><a href="https://uniapp.dcloud.net.cn/api/router#switchtab" rel="nofollow" title="switchTab">switchTab</a></td><td></td></tr><tr><td>uni.navigateBack</td><td><a href="https://uniapp.dcloud.net.cn/api/router#navigateback" rel="nofollow" title="navigateBack">navigateBack</a></td><td></td></tr><tr><td>uni.postMessage</td><td>向应用发送消息</td><td>抖音小程序不支持、H5 暂不支持（可以直接使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage" rel="nofollow" title="window.postMessage">window.postMessage</a>）</td></tr><tr><td>uni.getEnv</td><td>获取当前环境</td><td>抖音小程序与飞书小程序不支持</td></tr></tbody></table> 
<p></p> 
<h4 id="postmessage">uni.postMessage(OBJECT)</h4> 
<p>网页向应用发送消息，在 <code>&lt;web-view&gt;</code> 的 <code>message</code> 事件回调 <code>event.detail.data</code> 中接收消息。</p> 
<p><strong>Tips</strong></p> 
<ul><li>传递的消息信息，必须写在 data 对象中。</li><li><code>event.detail.data</code> 中的数据，以数组的形式接收每次 post 的消息。（注：支付宝小程序除外，支付宝小程序中以对象形式接受）</li></ul> 
<h4 id="getenv"><a href="https://uniapp.dcloud.net.cn/component/web-view.html#getenv" rel="nofollow" title="#">#</a>uni.getEnv(CALLBACK)</h4> 
<p><strong>callback 返回的对象</strong></p> 
<table><thead><tr><th>属性</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>plus</td><td>Boolean</td><td>App</td></tr><tr><td>nvue</td><td>Boolean</td><td>App-nvue, uni.webview.1.5.4.js+ 支持</td></tr><tr><td>miniprogram</td><td>Boolean</td><td>微信小程序</td></tr><tr><td>smartprogram</td><td>Boolean</td><td>百度小程序</td></tr><tr><td>miniprogram</td><td>Boolean</td><td>支付宝小程序</td></tr></tbody></table> 
<p></p> 
<h3>3.实际操作</h3> 
<p>下面直接来看示例</p> 
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
  &lt;title&gt;测试&lt;/title&gt;
  &lt;!-- 引入ui库vant的样式 --&gt;
  &lt;link rel="stylesheet" href="./vant.css"&gt;
  &lt;!-- 引入自定义的全局样式 --&gt;
  &lt;link rel="stylesheet" href="./global.css"&gt;
  &lt;!-- 引入页面样式文件 --&gt;
  &lt;link rel="stylesheet" href="./index.css"&gt;

&lt;/head&gt;

&lt;body&gt;
  &lt;div id="app"&gt;
    &lt;div class="flex-1"&gt;
      &lt;!-- 嵌入iframe展示vr页面 --&gt;
      &lt;iframe class="iframe" src="https://www.realsee.com/website/customer/dataSpace/vr/kPJJK5rx" allowfullscreen="true"
        frameborder="0"&gt;&lt;/iframe&gt;
    &lt;/div&gt;
    &lt;main&gt;
      &lt;!-- 底部操作按钮 --&gt;
      &lt;div class="ptb-10 flex-vcenter flex-between"&gt;
        &lt;van-button type="info" @click="handleLook"&gt;体验馆带看&lt;/van-button&gt;
        &lt;van-button type="info" @click="handleRoom"&gt;看房型&lt;/van-button&gt;
        &lt;van-button type="info" @click="handleAsk"&gt;立即咨询&lt;/van-button&gt;
      &lt;/div&gt;
      &lt;!-- 看房型的弹窗 --&gt;
      &lt;van-popup v-model="showRoomPopup" round position="bottom" :overlay="false"
        :style="{ minHeight: '10%',padding: '15px 10px 10px',background: 'rgba(0,0,0,.7)' }"&gt;
        &lt;div class="co-white pb-15" style="position: relative;"&gt;
          &lt;p class="text-center"&gt;房型预览&lt;/p&gt;
          &lt;div @click="showRoomPopup = false" class="arrow-down-wrap flex-vcenter"&gt;
            &lt;span class="fs-12 mr-5"&gt;收起&lt;/span&gt;
            &lt;van-icon name="arrow-down" /&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;van-grid class="rooms-wrap" :column-num="3"&gt;
          &lt;van-grid-item v-for="(item,index) in urlParams.rooms" :key="index"&gt;

            &lt;div class="co-white rooms-item" @click="goRoom(item.url)"&gt;
              &lt;p class="rooms-content"&gt;{<!-- -->{item.name}}&lt;/p&gt;
              &lt;van-image width="100%" height="100%" fit="cover" src="https://img01.yzcdn.cn/vant/cat.jpeg" /&gt;
            &lt;/div&gt;
          &lt;/van-grid-item&gt;
        &lt;/van-grid&gt;
      &lt;/van-popup&gt;
    &lt;/main&gt;
  &lt;/div&gt;

  &lt;!-- 需要引入的文件 --&gt;
  &lt;!-- vue --&gt;
  &lt;script type="text/javascript" src="./vue.min.js"&gt;&lt;/script&gt;
  &lt;!-- vant ui库 --&gt;
  &lt;script type="text/javascript" src="./vant.min.js"&gt;&lt;/script&gt;
  &lt;!--  微信小程序 JS-SDK  --&gt;
  &lt;script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"&gt;&lt;/script&gt;
  &lt;!-- 与uniapp建立连接 --&gt;
  &lt;script type="text/javascript" src="./uni.webview.1.5.5.js"&gt;&lt;/script&gt;
  &lt;!-- 页面的js文件 --&gt;
  &lt;script type="text/javascript" src="./index.js"&gt;&lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;</code></pre> 
<ul><li>因为使用的vantUi库，所以下载了vant.min.js，想用vue开发所以下载了vue.min.js，这2个不重要</li><li><span style="color:#ff9900;">需要引入微信小程序 JS-SDK &lt;script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.4.0.js"&gt;&lt;/script&gt;</span></li><li><span style="color:#ff9900;">与uniapp建立连接，引入<a href="https://hellouniapp.dcloud.net.cn/hybrid/html/uni.webview.1.5.5.js" rel="nofollow" title="hellouniapp.dcloud.net.cn/hybrid/html/uni.webview.1.5.5.js">hellouniapp.dcloud.net.cn/hybrid/html/uni.webview.1.5.5.js</a>，可以下载到本地</span></li></ul> 
<h4>调用api与小程序通信</h4> 
<pre><code>new Vue({
  el: '#app',
  components: {
  },
  data () {
    return {
      urlParams: {
        rooms: []
      },
      showRoomPopup: false
    }
  },
  computed: {
  },
  created () {
  },
  watch: {
  },
  mounted () {
    const { params } = this.urlToObj(location.href)
    if (params) {
      this.urlParams = JSON.parse(decodeURI(params))
    }
    document.addEventListener('UniAppJSBridgeReady', () =&gt; {
      uni.getEnv((res) =&gt; {
        console.log('当前环境：' + JSON.stringify(res));
      });
    })
  },
  methods: {
    // url参数转对象
    urlToObj (url) {
      let obj = {};
      if (url.indexOf('?') &gt;= 0) {
        let str = url.slice(url.indexOf('?') + 1);
        let arr = str.split('&amp;');
        console.log(str, arr)

        for (let j = arr.length, i = 0; i &lt; j; i++) {
          let arr_temp = arr[i].split('=');
          obj[arr_temp[0]] = arr_temp[1];
        }
      }
      return obj;
    },

    // 点击体验官带看
    handleLook () {
      // 跳转到小程序的某个页面
      uni.navigateTo({
        url: '/pages/vr/look'
      });
    },
    // 点击看房型
    handleRoom () {
      console.log(this.urlParams)
      this.showRoomPopup = true;
    },
    goRoom (url) {
      // 跳转到小程序的某个页面
      uni.navigateTo({
        url: `/pages/vr/room?url=${url}`
      });
    },
    // 点击咨询
    handleAsk () {
      // 发送消息给小程序
      uni.postMessage({
        data: {
          action: '咨询'
        }
      });
      // 因为网页向应用 postMessage 时，会在特定时机（后退、组件销毁、分享）触发并收到消息。 所以用uni.redirectTo触发小程序的重新加载实时接收消息
      uni.redirectTo({
        url: '/pages/vr/vr'
      });
    }
  }
})</code></pre> 
<p></p> 
<p>页面预览效果：</p> 
<p><img alt="" height="848" src="https://images2.imgbox.com/95/4a/GK9DPKIX_o.png" width="401"></p> 
<p></p> 
<h4>小提示：如何在开发者工具查看webiew页面的信息</h4> 
<p><img alt="" height="974" src="https://images2.imgbox.com/b6/d3/mYXT0AND_o.png" width="666"></p> 
<p></p> 
<h4>小程序端代码参考</h4> 
<pre><code>&lt;template&gt;
  &lt;web-view :src="vrUrl" @message="onMessage"&gt;&lt;/web-view&gt;
&lt;/template&gt;

&lt;script&gt;
import { callPhone } from '@/utils';
export default {
  data() {
    return {
      vrUrl:
        // 这里要换成你的在线网页地址，我这里写的是本地的
        `http://127.0.0.1:5500/vr-demo/index.html?params=` +
        encodeURI(
          JSON.stringify({
            rooms: [
              {
                name: '房间1',
                url: 'https://www.realsee.com/website/customer/dataSpace/vr/kPJJK5rx',
              },
              {
                name: '房间2',
                url: 'https://www.realsee.com/website/customer/dataSpace/vr/kPJJK5rx',
              },
            ],
          })
        ),
    };
  },
  onLoad(props) {
    console.log(props);
  },
  methods: {
    // 接收webview传来的消息
    onMessage(e) {
      const { data } = e.detail;
      console.log(
        data,
        'web-view传来的信息,在小程序后退、组件销毁、分享会触发'
      );
      console.log(data.at(-1));
      if (data?.at(-1)?.action === '咨询') {
        callPhone('18205236589');
      }
    },
  },
};
&lt;/script&gt;
</code></pre> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4d591b83ac083dca521612376c644b7d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">LeetCode的基础入门（非常详细）零基础入门到精通，收藏这一篇就够了</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/99200e31ddcc5f23123c69c39d49a116/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">若依ruoyi-ui执行npm run dev启动报错：esnext.set.difference.v2.js in ./src/utils/index.js 处理方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>