<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>HarmonyOS开发实战（ Beta5版）延迟加载lazy-import实践使用指导 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/683bad786b97296dd5af8cca18015563/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="HarmonyOS开发实战（ Beta5版）延迟加载lazy-import实践使用指导">
  <meta property="og:description" content="随着应用功能持续增加，应用规模不断扩大，依赖的模块文件逐渐变多，应用冷启动加载模块的时间也越来越长。而在实际冷启动过程中执行了很多应用整体依赖但当前未使用的文件，此时可以通过延迟加载 lazy-import 的方法延缓对这些冗余文件的加载，使待加载文件在冷启动阶段不被加载，而在后续导出变量被真正使用时再同步加载执行文件，节省资源以提高应用冷启动性能。
lazy-import与动态加载的区别 lazy-import与动态加载都可以实现主动延后特定文件的执行时间，帮助设备均摊性能消耗，缓解特定时段性能压力的能力。
动态加载lazy-import语法示例let A = await import(&#34;./A&#34;);import lazy { A } from &#34;./A&#34;;性能开销1.创建异步任务开销
2.执行到动态加载时，触发依赖模块的模块解析&#43;源码执行。1.lazy-import的模块解析在冷启动依旧会触发遍历。
2.导入的变量A被使用到时，触发模块的源码执行。使用位置代码块/运行逻辑中使用需要写在源码开头是否可以运行时拼接是否加载时序异步同步 开发者在使用动态加载时，需要将静态加载的代码（同步导入）改写成动态加载语法（异步导入），修改量较大。其次如果希望通过动态加载在冷启动阶段产生优化，需要开发者明确感知被动态加载文件不会在冷启动被执行才会有收益，否则会增大冷启动开销（放入异步队列等）。相较于动态加载，使用lazy-import延迟加载，开发者只需要在import语法中增加lazy关键字就可以实现延迟加载，使用更加方便。
使用场景 下述例子中A文件被引用，在应用启动到点击按钮的这段时间里，A文件并没有被实际执行，在冷启动阶段加载A文件的行为属于冗余。源码参考
// A为任意可以被引入的ets文件 import { A } from &#34;./A&#34;; @Entry @Component struct Index { build() { RelativeContainer() { Button(&#39;点击执行A文件&#39;) .onClick(() =&gt; { // 点击后触发A文件的执行 console.log(&#34;执行A文件&#34;, A); }) } // ... } } 通过抓取Trace图查看调用栈可发现，应用在冷启动时加载了A文件。
使用方法 ArkTS冗余文件检测工具 在规避冗余文件时，首先需要筛选出哪些依赖文件在冷启动时未被使用，此时可以使用ArkTS冗余文件检测工具，梳理出冷启动加载过程中未被使用的文件名单。
工具使用 打开模块化日志打印打点开关，重启设备。
hdc shell param set persist.ark.properties 0x200105c hdc shell reboot 启动应用，启动结束后关闭应用。
下载文件到本地，其中${bundleName}为应用名。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-02T21:54:41+08:00">
    <meta property="article:modified_time" content="2024-09-02T21:54:41+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">HarmonyOS开发实战（ Beta5版）延迟加载lazy-import实践使用指导</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>随着应用功能持续增加，应用规模不断扩大，依赖的模块文件逐渐变多，应用冷启动加载模块的时间也越来越长。而在实际冷启动过程中执行了很多应用整体依赖但当前未使用的文件，此时可以通过延迟加载 lazy-import 的方法延缓对这些冗余文件的加载，使待加载文件在冷启动阶段不被加载，而在后续导出变量被真正使用时再同步加载执行文件，节省资源以提高应用冷启动性能。</p> 
<h3>lazy-import与动态加载的区别</h3> 
<p>lazy-import与动态加载都可以实现主动延后特定文件的执行时间，帮助设备均摊性能消耗，缓解特定时段性能压力的能力。</p> 
<table><thead><tr><th></th><th>动态加载</th><th>lazy-import</th></tr></thead><tbody><tr><td>语法示例</td><td>let A = await import("./A");</td><td>import lazy { A } from "./A";</td></tr><tr><td>性能开销</td><td>1.创建异步任务开销<br> 2.执行到动态加载时，触发依赖模块的模块解析+源码执行。</td><td>1.lazy-import的模块解析在冷启动依旧会触发遍历。<br> 2.导入的变量A被使用到时，触发模块的源码执行。</td></tr><tr><td>使用位置</td><td>代码块/运行逻辑中使用</td><td>需要写在源码开头</td></tr><tr><td>是否可以运行时拼接</td><td>是</td><td>否</td></tr><tr><td>加载时序</td><td>异步</td><td>同步</td></tr></tbody></table> 
<p>开发者在使用动态加载时，需要将静态加载的代码（同步导入）改写成动态加载语法（异步导入），修改量较大。其次如果希望通过动态加载在冷启动阶段产生优化，需要开发者明确感知被动态加载文件不会在冷启动被执行才会有收益，否则会增大冷启动开销（放入异步队列等）。相较于动态加载，使用lazy-import延迟加载，开发者只需要在import语法中增加lazy关键字就可以实现延迟加载，使用更加方便。</p> 
<h3>使用场景</h3> 
<p>下述例子中A文件被引用，在应用启动到点击按钮的这段时间里，A文件并没有被实际执行，在冷启动阶段加载A文件的行为属于冗余。<a href="https://gitee.com/harmonyos-cases/cases/blob/master/test/performance/lazy-import-instructions/normalimport/entry/src/main/ets/pages/Index.ets" rel="nofollow" title="源码参考">源码参考</a></p> 
<pre><code class="hljs">// A为任意可以被引入的ets文件
import { A } from "./A";

@Entry
@Component
struct Index {
  build() {
    RelativeContainer() {
      Button('点击执行A文件')
        .onClick(() =&gt; {
          // 点击后触发A文件的执行
          console.log("执行A文件", A);
        })
    }
    // ...
  }
}</code></pre> 
<p></p> 
<p class="img-center"><img alt="img" height="449" src="https://images2.imgbox.com/4b/20/wlna38Hn_o.png" width="1200"></p> 
<p>通过抓取Trace图查看调用栈可发现，应用在冷启动时加载了A文件。</p> 
<h3>使用方法</h3> 
<h4>ArkTS冗余文件检测工具</h4> 
<p>在规避冗余文件时，首先需要筛选出哪些依赖文件在冷启动时未被使用，此时可以使用ArkTS冗余文件检测工具，梳理出冷启动加载过程中未被使用的文件名单。</p> 
<h5>工具使用</h5> 
<ol><li> <p>打开模块化日志打印打点开关，重启设备。</p> <pre><code class="hljs">hdc shell param set persist.ark.properties 0x200105c
hdc shell reboot</code></pre> </li><li> <p>启动应用，启动结束后关闭应用。</p> </li><li> <p>下载文件到本地，其中<code>${bundleName}</code>为应用名。</p> <pre><code class="hljs">hdc file recv data/app/el2/100/base/${bundleName}/files/${bundleName}_redundant_file.txt D:\</code></pre> </li><li> <p>对上述示例代码获取到的文件进行分析。</p> <p></p> <p class="img-center"><img alt="img" height="389" src="https://images2.imgbox.com/f9/2f/MtL6eSvb_o.png" width="911"></p> <p>大致结构：</p> 
  <ol><li>Summary ：加载各项文件的总耗时。</li><li>used file：冷启动2s内应用使用到的文件。</li><li>unused file：冷启动2S内应用没有使用的文件（即冷启动阶段可延迟加载的文件）。</li></ol></li></ol> 
<h4>lazy-import示例</h4> 
<p>在通过工具筛选出冗余文件后，开发者可选择在引入时添加<code>lazy</code>关键字对文件进行标识，表示该文件可被延迟加载。<a href="https://gitee.com/harmonyos-cases/cases/blob/master/test/performance/lazy-import-instructions/lazyimport/entry/src/main/ets/pages/Index.ets" rel="nofollow" title="源码参考">源码参考</a></p> 
<pre><code class="hljs">// 此处添加lazy关键字，标记该文件可延迟加载
import lazy { A } from "./A";

@Entry
@Component
struct Index {
  build() {
    RelativeContainer() {
      Button('点击执行A文件')
        .onClick(() =&gt; {
          // 点击后触发A文件的执行
          console.log("执行A文件", A);
        })
    }
    // ...
  }
}</code></pre> 
<p></p> 
<p class="img-center"><img alt="img" height="436" src="https://images2.imgbox.com/59/18/nhNHVouR_o.png" width="1200"></p> 
<p>通过抓取Trace图查看调用栈可发现，使用lazy-import标识后，应用在冷启动时不再加载A文件。</p> 
<h4>注意事项</h4> 
<ol><li>由于lazy-import的后续加载是同步加载，可能在某些场景阻塞任务执行（比如在点击业务时触发了懒加载，那么运行时会执行冷启动为加载的文件，增加执行耗时，存在掉帧风险），是否使用延迟加载仍需要开发者自行评估。</li><li>不推荐开发者在未根据实际业务梳理出可延迟文件时盲目增加延迟加载，过多的延迟加载同样会增大编译及运行时的识别开销。</li><li>已经被动态加载的文件同时使用lazy-import时，这些文件会执行lazy标识，在动态加载的then逻辑中同步加载。 关于lazy-import的基础使用方法请参考官方文档：<a href="https://gitee.com/link?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V5%2Farkts-lazy-import-V5" rel="nofollow" title="延迟加载">延迟加载</a>。</li></ol> 
<h3>性能分析</h3> 
<table><thead><tr><th></th><th>加载文件耗时（微秒us）</th></tr></thead><tbody><tr><td>优化前</td><td>412us</td></tr><tr><td>优化后</td><td>350us</td></tr></tbody></table> 
<p>根据上述优化前后案例Trace图对比分析，使用延迟加载后应用冷启动时不再加载A文件，在资源加载阶段减少因加载冗余文件产生的耗时约15%，提高了应用冷启动性能。（由于案例仅演示场景，优化数据仅做参考，在实际业务中随着引用文件的复杂度提高，引用文件数量增多，优化效果也会随之提升。）</p> 
<h3><strong>最后</strong></h3> 
<p>小编在之前的鸿蒙系统扫盲中，有很多朋友给我留言，不同的角度的问了一些问题，我明显感觉到一点，那就是许多人参与鸿蒙开发，但是又不知道从哪里下手，因为资料太多，太杂，教授的人也多，无从选择。有很多小伙伴不知道学习哪些鸿蒙开发技术？不知道需要重点掌握哪些鸿蒙应用开发知识点？而且学习时频繁踩坑，最终浪费大量时间。所以有一份实用的<strong>鸿蒙（HarmonyOS NEXT）文档</strong>用来跟着学习是非常有必要的。 </p> 
<p><strong>为了确保高效学习，建议规划清晰的学习路线</strong></p> 
<p><a href="https://gitcode.com/MNxiaona/hhgz/overview?isLogin=1" title="GitCode - 全球开发者的开源社区,开源代码托管平台  ">GitCode - 全球开发者的开源社区,开源代码托管平台  </a><strong>希望这一份鸿蒙学习文档能够给大家带来帮助~</strong></p> 
<hr> 
<h2><a id="_10"></a></h2> 
<p><strong>鸿蒙（HarmonyOS NEXT）最新学习路线</strong></p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/91/4a/ZR7AOOD9_o.png" width="1200">​</p> 
<p><strong>该路线图包含<span style="color:#fe2c24;">基础技能、就业必备技能、多媒体技术、六大电商APP、进阶高级技能、实战就业级设备开发</span>，不仅补充了华为官网未涉及的解决方案</strong></p> 
<p><strong>路线图适合人群：</strong></p> 
<p><strong>IT开发人员：</strong>想要拓展职业边界<br><strong>零基础小白：</strong>鸿蒙爱好者，希望从0到1学习，增加一项技能。<br><strong>技术提升/进阶跳槽：</strong>发展瓶颈期，提升职场竞争力，快速掌握鸿蒙技术</p> 
<p><strong>2.视频学习教程+学习PDF文档</strong></p> 
<p><strong>HarmonyOS Next 最新全套视频教程</strong></p> 
<p><img alt="" height="804" src="https://images2.imgbox.com/e2/50/LKEX9InR_o.png" width="1088"></p> 
<p>  <strong>纯血版鸿蒙全套学习文档（面试、文档、全套视频等）       </strong></p> 
<div></div> 
<div> 
 <div> 
  <h4 style="margin-left:0pt;text-align:left;"><img alt="" height="167" src="https://images2.imgbox.com/9b/a1/4ZDt00aD_o.png" width="635"></h4> 
 </div> 
</div> 
<p><img alt="" height="245" src="https://images2.imgbox.com/b5/35/Wg2YMD91_o.png" width="618">​​</p> 
<p><strong><strong>总结</strong></strong></p> 
<p><strong>参与鸿蒙开发，你要先认清适合你的方向，如果是想从事鸿蒙应用开发方向的话，可以参考本文的学习路径，简单来说就是：为了确保高效学习，建议规划清晰的学习路线</strong></p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/3f/c8/1LzBRzlc_o.jpg"></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0fcec8439276d3f9a7f1185b47253ceb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL 基础命令</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3c3e003c76181166f718491f721e51e7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【高阶数据结构】秘法（一）——并查集：探索如何高效地管理集合</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>