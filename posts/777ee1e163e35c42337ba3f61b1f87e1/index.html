<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【2024年最新】Bilibili/B站视频/动态评论爬虫 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/777ee1e163e35c42337ba3f61b1f87e1/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【2024年最新】Bilibili/B站视频/动态评论爬虫">
  <meta property="og:description" content="废话不多说，直接先放git仓库：GitHub - linyuye/Bilibili_crawler: bilibili爬虫，基于selenium获取oid与cookie，request获取api内容
〇：概念简述 oid：视频/动态的uuid，b站对于发布内容的通用唯一识别码
cookie：内含个人登录信息，爬虫头必需
其余内容请看该文档含义：
bilibili-API-collect/docs/comment/list.md at master · SocialSisterYi/bilibili-API-collect · GitHub哔哩哔哩-API收集整理【不断更新中....】. Contribute to SocialSisterYi/bilibili-API-collect development by creating an account on GitHub.https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/docs/comment/list.md
一：前言 首先，让我们了解，动态网站/静态网站的区别：
动态网站除了要设计网页外，还要通过数据库和编程序来使网站具有更多自动的和高级的功能。动态网站体现在网页一般是以asp，jsp，php，aspx等技术，而静态网页一般是HTML（标准通用标记语言的子集）结尾，动态网站服务器空间配置要比静态的网页要求高，费用也相应的高，不过动态网页利于网站内容的更新，适合企业建站。动态是相对于静态网站而言。——百度百科
通俗来说，就是网页内容是否写在网站源代码里面的区别。
以编写日期时，bilibili每周必看视频榜一为例：https://www.bilibili.com/video/BV1ay411h74i/
对于第一条评论：在网页源代码中不存在，所以数据是从后端/数据库返回的，那么我们就可以通过查看网络请求。发现数据在main?oid这里面返回得到，至此，我们知道了评论是从哪里返回的。
二：API详解 api分析来源：GitHub - SocialSisterYi/bilibili-API-collect: 哔哩哔哩-API收集整理【不断更新中....】哔哩哔哩-API收集整理【不断更新中....】. Contribute to SocialSisterYi/bilibili-API-collect development by creating an account on GitHub.https://github.com/SocialSisterYi/bilibili-API-collect
https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/docs/comment/list.md
通过翻阅上述API文档，我们得知，使用正常API获取评论，在页数到达400页之后无法返回内容，好在b站提供了一个懒加载api能够爬取所有内容。
https://api.bilibili.com/x/v2/reply/main懒加载api，无需wbi签名
https://api.bilibili.com/x/v2/reply/reply获取子评论的api
对评论区请求需要以下data数据：（1为评论，2为子评论）
参数名类型内容必要性备注access_keystrAPP 登录 TokenAPP 方式必要typenum评论区类型代码必要类型代码见表oidnum目标评论区 id必要modenum排序方式非必要默认为 3
0 3：仅按热度
1：按热度&#43;按时间
2：仅按时间nextnum评论页选择非必要按热度时：热度顺序页码（0 为第一页）
按时间时：时间倒序楼层号
默认为 0psnum每页项数非必要默认为 20
定义域：1-30 access_keystrAPP登录 TokenAPP 方式必要typenum评论区类型代码必要类型代码见表oidnum目标评论区 id必要rootnum根回复 rpid必要psnum每页项数非必要默认为20">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-12T23:26:22+08:00">
    <meta property="article:modified_time" content="2024-06-12T23:26:22+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【2024年最新】Bilibili/B站视频/动态评论爬虫</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>废话不多说，直接先放git仓库：</strong><a href="https://github.com/linyuye/Bilibili_crawler" title="GitHub - linyuye/Bilibili_crawler: bilibili爬虫，基于selenium获取oid与cookie，request获取api内容">GitHub - linyuye/Bilibili_crawler: bilibili爬虫，基于selenium获取oid与cookie，request获取api内容</a></p> 
<h3>〇：概念简述</h3> 
<p>oid：视频/动态的uuid，b站对于发布内容的通用唯一识别码</p> 
<p>cookie：内含个人登录信息，爬虫头必需</p> 
<p>其余内容请看该文档含义：</p> 
<p><a class="has-card" href="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/docs/comment/list.md" title="bilibili-API-collect/docs/comment/list.md at master · SocialSisterYi/bilibili-API-collect · GitHub"><span class="link-card-box"><span class="link-title">bilibili-API-collect/docs/comment/list.md at master · SocialSisterYi/bilibili-API-collect · GitHub</span><span class="link-desc">哔哩哔哩-API收集整理【不断更新中....】. Contribute to SocialSisterYi/bilibili-API-collect development by creating an account on GitHub.</span><span class="link-link"><img class="link-link-icon" src="https://images2.imgbox.com/9a/db/HjuORrGj_o.png" alt="icon-default.png?t=N7T8">https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/docs/comment/list.md</span></span></a></p> 
<h3>一：前言</h3> 
<p>首先，让我们了解，动态网站/静态网站的区别：</p> 
<blockquote> 
 <p>动态网站除了要设计网页外，还要通过数据库和<a href="https://baike.baidu.com/item/%E7%BC%96%E7%A8%8B%E5%BA%8F/645283?fromModule=lemma_inlink" rel="nofollow" title="编程序">编程序</a>来使网站具有更多自动的和高级的功能。动态网站体现在网页一般是以<a href="https://baike.baidu.com/item/asp/128906?fromModule=lemma_inlink" rel="nofollow" title="asp">asp</a>，<a href="https://baike.baidu.com/item/jsp/141543?fromModule=lemma_inlink" rel="nofollow" title="jsp">jsp</a>，<a href="https://baike.baidu.com/item/php/9337?fromModule=lemma_inlink" rel="nofollow" title="php">php</a>，<a href="https://baike.baidu.com/item/aspx/203251?fromModule=lemma_inlink" rel="nofollow" title="aspx">aspx</a>等技术，而<a href="https://baike.baidu.com/item/%E9%9D%99%E6%80%81%E7%BD%91%E9%A1%B5/6327183?fromModule=lemma_inlink" rel="nofollow" title="静态网页">静态网页</a>一般是<a href="https://baike.baidu.com/item/HTML/97049?fromModule=lemma_inlink" rel="nofollow" title="HTML">HTML</a>（<a href="https://baike.baidu.com/item/%E6%A0%87%E5%87%86%E9%80%9A%E7%94%A8%E6%A0%87%E8%AE%B0%E8%AF%AD%E8%A8%80/6805073?fromModule=lemma_inlink" rel="nofollow" title="标准通用标记语言">标准通用标记语言</a>的子集）结尾，动态网站<a href="https://baike.baidu.com/item/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A9%BA%E9%97%B4/14687930?fromModule=lemma_inlink" rel="nofollow" title="服务器空间">服务器空间</a>配置要比静态的网页要求高，费用也相应的高，不过<a href="https://baike.baidu.com/item/%E5%8A%A8%E6%80%81%E7%BD%91%E9%A1%B5/6327050?fromModule=lemma_inlink" rel="nofollow" title="动态网页">动态网页</a>利于网站内容的更新，适合<a href="https://baike.baidu.com/item/%E4%BC%81%E4%B8%9A%E5%BB%BA%E7%AB%99/1027109?fromModule=lemma_inlink" rel="nofollow" title="企业建站">企业建站</a>。动态是相对于<a href="https://baike.baidu.com/item/%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99/2776875?fromModule=lemma_inlink" rel="nofollow" title="静态网站">静态网站</a>而言。——百度百科</p> 
</blockquote> 
<p>通俗来说，就是网页内容是否写在网站源代码里面的区别。</p> 
<p>以编写日期时，bilibili每周必看视频榜一为例：<a href="https://www.bilibili.com/video/BV1ay411h74i/" rel="nofollow" title="https://www.bilibili.com/video/BV1ay411h74i/">https://www.bilibili.com/video/BV1ay411h74i/</a></p> 
<p>对于第一条评论：<img alt="" height="839" src="https://images2.imgbox.com/eb/f5/P2gQ3tb3_o.png" width="1200"><img alt="" height="702" src="https://images2.imgbox.com/6e/52/R8CrVZC6_o.png" width="1200">在网页源代码中不存在，所以数据是从后端/数据库返回的，那么我们就可以通过查看网络请求。发现数据在main?oid这里面返回得到，至此，我们知道了评论是从哪里返回的。</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/46/24/HlJlSyJb_o.png" width="1200"><img alt="" height="497" src="https://images2.imgbox.com/18/84/UCssXcUy_o.png" width="1200"></p> 
<h3>二：API详解</h3> 
<p><a class="has-card" href="https://github.com/SocialSisterYi/bilibili-API-collect" title="api分析来源：GitHub - SocialSisterYi/bilibili-API-collect: 哔哩哔哩-API收集整理【不断更新中....】"><span class="link-card-box"><span class="link-title">api分析来源：GitHub - SocialSisterYi/bilibili-API-collect: 哔哩哔哩-API收集整理【不断更新中....】</span><span class="link-desc">哔哩哔哩-API收集整理【不断更新中....】. Contribute to SocialSisterYi/bilibili-API-collect development by creating an account on GitHub.</span><span class="link-link"><img class="link-link-icon" src="https://images2.imgbox.com/cd/4e/Qr5BEhJF_o.png" alt="icon-default.png?t=N7T8">https://github.com/SocialSisterYi/bilibili-API-collect</span></span></a></p> 
<h3></h3> 
<p><a href="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/docs/comment/list.md" title="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/docs/comment/list.md">https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/docs/comment/list.md</a></p> 
<p>通过翻阅上述API文档，我们得知，使用正常API获取评论，在页数到达400页之后无法返回内容，好在b站提供了一个懒加载api能够爬取所有内容。</p> 
<blockquote> 
 <p><a href="https://api.bilibili.com/x/v2/reply/main" rel="nofollow" title="https://api.bilibili.com/x/v2/reply/main">https://api.bilibili.com/x/v2/reply/main</a>懒加载api，无需wbi签名</p> 
 <p><a href="https://api.bilibili.com/x/v2/reply/reply" rel="nofollow" title="https://api.bilibili.com/x/v2/reply/reply">https://api.bilibili.com/x/v2/reply/reply</a>获取子评论的api</p> 
</blockquote> 
<p>对评论区请求需要以下data数据：（1为评论，2为子评论）</p> 
<table border="1" cellpadding="1" cellspacing="1" style="width:500px;"><tbody><tr><th>参数名</th><th>类型</th><th>内容</th><th>必要性</th><th>备注</th></tr><tr><td>access_key</td><td>str</td><td>APP 登录 Token</td><td>APP 方式必要</td><td></td></tr><tr><td>type</td><td>num</td><td>评论区类型代码</td><td>必要</td><td><a href="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/docs/comment/readme.md#%E8%AF%84%E8%AE%BA%E5%8C%BA%E7%B1%BB%E5%9E%8B%E4%BB%A3%E7%A0%81" title="类型代码见表">类型代码见表</a></td></tr><tr><td>oid</td><td>num</td><td>目标评论区 id</td><td>必要</td><td></td></tr><tr><td>mode</td><td>num</td><td>排序方式</td><td>非必要</td><td>默认为 3<br> 0 3：仅按热度<br> 1：按热度+按时间<br> 2：仅按时间</td></tr><tr><td>next</td><td>num</td><td>评论页选择</td><td>非必要</td><td>按热度时：热度顺序页码（0 为第一页）<br> 按时间时：时间倒序楼层号<br> 默认为 0</td></tr><tr><td>ps</td><td>num</td><td>每页项数</td><td>非必要</td><td>默认为 20<br> 定义域：1-30</td></tr></tbody></table> 
<table border="1" cellpadding="1" cellspacing="1" style="width:500px;"><tbody><tr><td>access_key</td><td>str</td><td>APP登录 Token</td><td>APP 方式必要</td><td></td></tr><tr><td>type</td><td>num</td><td>评论区类型代码</td><td>必要</td><td><a href="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/docs/comment/readme.md#%E8%AF%84%E8%AE%BA%E5%8C%BA%E7%B1%BB%E5%9E%8B%E4%BB%A3%E7%A0%81" title="类型代码见表">类型代码见表</a></td></tr><tr><td>oid</td><td>num</td><td>目标评论区 id</td><td>必要</td><td></td></tr><tr><td>root</td><td>num</td><td>根回复 rpid</td><td>必要</td><td></td></tr><tr><td>ps</td><td>num</td><td>每页项数</td><td>非必要</td><td>默认为20<br> 定义域：1-49<br> 但 data_replies 的最大内容数为20,因此设置为49其实也只会有20条回复被返回</td></tr><tr><td>pn</td><td>num</td><td>页码</td><td>非必要</td><td>默认为1</td></tr></tbody></table> 
<div> 
 <pre><code class="hljs language-python">data_2 = {
 二级评论的data
<span class="hljs-string">'type'</span>: <span class="hljs-built_in">type</span>,  <span class="hljs-comment"># 类型</span>
<span class="hljs-string">'oid'</span>: oid,  <span class="hljs-comment"># 原视频/动态oid</span>
<span class="hljs-string">'ps'</span>: ps,  <span class="hljs-comment"># 每页含有条数，不能大于20</span>
<span class="hljs-string">'pn'</span>: <span class="hljs-built_in">str</span>(page_pn),  <span class="hljs-comment"># 二级评论页数，需要转换为字符串</span>
<span class="hljs-string">'root'</span>: rpid  <span class="hljs-comment"># 一级评论的rpid</span>
}</code></pre> 
</div> 
<h3>三：爬虫</h3> 
<p>使用了request库，对api访问，解析返回数据</p> 
<div> 
 <pre><code class="hljs language-python"><span class="hljs-keyword">for</span> comment <span class="hljs-keyword">in</span> json_data[<span class="hljs-string">'data'</span>][<span class="hljs-string">'replies'</span>]:
    count = comment[<span class="hljs-string">'rcount'</span>]
    rpid = <span class="hljs-built_in">str</span>(comment[<span class="hljs-string">'rpid'</span>])
    name = comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'uname'</span>]
    sex = comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'sex'</span>]
    ctime = comment[<span class="hljs-string">'ctime'</span>]
    dt_object = datetime.datetime.fromtimestamp(ctime, datetime.timezone.utc)
    formatted_time = dt_object.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>) + <span class="hljs-string">' 北京时间'</span>  <span class="hljs-comment"># 可以加上时区信息，但通常不需要</span>
    like = comment[<span class="hljs-string">'like'</span>]
    message = comment[<span class="hljs-string">'content'</span>][<span class="hljs-string">'message'</span>].replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">','</span>)
    <span class="hljs-comment"># 检查是否存在 location 字段</span>
    location = comment[<span class="hljs-string">'reply_control'</span>].get(<span class="hljs-string">'location'</span>, <span class="hljs-string">'未知'</span>)  <span class="hljs-comment"># 如果不存在，使用 '未知'</span>
    location = location.replace(<span class="hljs-string">'IP属地：'</span>, <span class="hljs-string">''</span>)  <span class="hljs-keyword">if</span> location <span class="hljs-keyword">else</span> location
    current_level = comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'level_info'</span>][<span class="hljs-string">'current_level'</span>]
    mid = <span class="hljs-built_in">str</span>(comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'mid'</span>])</code></pre> 
</div> 
<h3>四：小白化处理</h3> 
<p>因为对于小白来说，获取cookie和oid比较困难，所以使用了selenium库，自动抓包自己的cookie和视频/动态oid</p> 
<div> 
 <pre><code class="hljs language-python">last_request = <span class="hljs-literal">None</span>

<span class="hljs-comment"># 遍历所有请求</span>
<span class="hljs-keyword">for</span> request <span class="hljs-keyword">in</span> driver.requests:
    <span class="hljs-keyword">if</span> <span class="hljs-string">"main?oid="</span> <span class="hljs-keyword">in</span> request.url <span class="hljs-keyword">and</span> request.response:
        <span class="hljs-comment"># 更新last_request为当前请求</span>
        last_request = request

<span class="hljs-comment"># 检查是否找到了符合条件的请求</span>
<span class="hljs-keyword">if</span> last_request:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"URL:"</span>, last_request.url)
    <span class="hljs-comment"># 从URL中提取oid</span>
    parsed_url = urlparse(last_request.url)
    query_params = parse_qs(parsed_url.query)
    oid = query_params.get(<span class="hljs-string">"oid"</span>, [<span class="hljs-literal">None</span>])[<span class="hljs-number">0</span>]
    <span class="hljs-built_in">type</span> = query_params.get(<span class="hljs-string">"type"</span>, [<span class="hljs-literal">None</span>])[<span class="hljs-number">0</span>]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"OID:"</span>, oid)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"type:"</span>, <span class="hljs-built_in">type</span>)</code></pre> 
</div> 
<h3>五：完整代码</h3> 
<div> 
 <pre><code class="hljs language-python"><span class="hljs-keyword">from</span> seleniumwire <span class="hljs-keyword">import</span> webdriver
<span class="hljs-keyword">from</span> selenium.webdriver.chrome.service <span class="hljs-keyword">import</span> Service
<span class="hljs-keyword">from</span> selenium.webdriver.chrome.options <span class="hljs-keyword">import</span> Options
<span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> urlparse, parse_qs
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> requests.adapters <span class="hljs-keyword">import</span> HTTPAdapter
<span class="hljs-keyword">from</span> requests.packages.urllib3.util.retry <span class="hljs-keyword">import</span> Retry
<span class="hljs-keyword">import</span> csv
<span class="hljs-keyword">import</span> pytz
<span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> fake_useragent <span class="hljs-keyword">import</span> UserAgent
<span class="hljs-keyword">import</span> random

options = {
    <span class="hljs-string">'ignore_http_methods'</span>: [<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>],  <span class="hljs-comment"># 提取XHR请求，通常为GET或POST。如果你不希望忽略任何方法，可以忽略此选项或设置为空数组</span>
    <span class="hljs-string">'custom_headers'</span>: {
        <span class="hljs-string">'X-Requested-With'</span>: <span class="hljs-string">'XMLHttpRequest'</span>  <span class="hljs-comment"># 筛选XHR请求</span>
    }
}

<span class="hljs-comment"># 配置Selenium</span>
chrome_options = Options()
chrome_service = Service(<span class="hljs-string">"前面是你这个文件夹的绝对路径\\venv\\chrome-win64\\chromedriver.exe"</span>)
driver = webdriver.Chrome(service=chrome_service, options=chrome_options)

<span class="hljs-comment"># 打开目标网页，改成你想爬的网页，直接是网址就行</span>
driver.get(<span class="hljs-string">"https://www.bilibili.com/video/BV1WM4m1Q75H/"</span>)

login_div = driver.find_element(By.XPATH, <span class="hljs-string">"//div[contains(@class, 'right-entry__outside') and contains(@class, 'go-login-btn')]"</span>)
login_div.click()
time.sleep(<span class="hljs-number">5</span>)
<span class="hljs-comment"># 注意替换下面的选择器以匹配你要自动登录的网站</span>
username_input = driver.find_element(By.XPATH, <span class="hljs-string">"//input[@placeholder='请输入账号']"</span>)
password_input = driver.find_element(By.XPATH, <span class="hljs-string">"//input[@placeholder='请输入密码']"</span>)
login_button = driver.find_element(By.XPATH, <span class="hljs-string">"//div[contains(@class,'btn_primary') and contains(text(),'登录')]"</span>)
<span class="hljs-comment">#第一个写账号，第二个写密码</span>
username_input.send_keys(<span class="hljs-string">""</span>)
password_input.send_keys(<span class="hljs-string">""</span>)
<span class="hljs-comment"># 点击登录按钮</span>
time.sleep(<span class="hljs-number">5</span>)
<span class="hljs-comment"># login_button.click()</span>
<span class="hljs-comment"># 等待几秒确保登录成功</span>
driver.implicitly_wait(<span class="hljs-number">10</span>)  <span class="hljs-comment"># 替换为你需要的等待时间</span>
<span class="hljs-comment"># 等待页面加载完成（根据实际情况调整时间或使用更智能的等待方式）</span>
time.sleep(<span class="hljs-number">5</span>)
driver.execute_script(<span class="hljs-string">"window.scrollTo(0, document.body.scrollHeight);"</span>)
time.sleep(<span class="hljs-number">5</span>)
driver.execute_script(<span class="hljs-string">"window.scrollTo(0, document.body.scrollHeight);"</span>)
<span class="hljs-comment"># 获取捕获的网络请求</span>
<span class="hljs-comment"># 初始化一个变量，用来保存最后一个符合条件的请求</span>
last_request = <span class="hljs-literal">None</span>

<span class="hljs-comment"># 遍历所有请求</span>
<span class="hljs-keyword">for</span> request <span class="hljs-keyword">in</span> driver.requests:
    <span class="hljs-keyword">if</span> <span class="hljs-string">"main?oid="</span> <span class="hljs-keyword">in</span> request.url <span class="hljs-keyword">and</span> request.response:
        <span class="hljs-comment"># 更新last_request为当前请求</span>
        last_request = request

<span class="hljs-comment"># 检查是否找到了符合条件的请求</span>
<span class="hljs-keyword">if</span> last_request:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"URL:"</span>, last_request.url)
    <span class="hljs-comment"># 从URL中提取oid</span>
    parsed_url = urlparse(last_request.url)
    query_params = parse_qs(parsed_url.query)
    oid = query_params.get(<span class="hljs-string">"oid"</span>, [<span class="hljs-literal">None</span>])[<span class="hljs-number">0</span>]
    <span class="hljs-built_in">type</span> = query_params.get(<span class="hljs-string">"type"</span>, [<span class="hljs-literal">None</span>])[<span class="hljs-number">0</span>]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"OID:"</span>, oid)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"type:"</span>, <span class="hljs-built_in">type</span>)



    <span class="hljs-comment"># 从WebDriver中获取所有cookies</span>
    all_cookies = driver.get_cookies()
    cookies_dict = {cookie[<span class="hljs-string">'name'</span>]: cookie[<span class="hljs-string">'value'</span>] <span class="hljs-keyword">for</span> cookie <span class="hljs-keyword">in</span> all_cookies}
    cookies_str = <span class="hljs-string">'; '</span>.join([<span class="hljs-string">f"<span class="hljs-subst">{name}</span>=<span class="hljs-subst">{value}</span>"</span> <span class="hljs-keyword">for</span> name, value <span class="hljs-keyword">in</span> cookies_dict.items()])


    <span class="hljs-comment"># 从cookies中获取bili_jct的值</span>
    bili_jct = cookies_dict.get(<span class="hljs-string">'bili_jct'</span>, <span class="hljs-string">''</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"bili_jct:"</span>, bili_jct)
    sessdata = cookies_dict.get(<span class="hljs-string">'SESSDATA'</span>, <span class="hljs-string">''</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"SESSDATA:"</span>, sessdata)
    <span class="hljs-comment"># 打印请求头</span>
    response = last_request.response



driver.quit()


<span class="hljs-comment"># 重试次数限制</span>
MAX_RETRIES = <span class="hljs-number">5</span>
<span class="hljs-comment"># 重试间隔（秒）</span>
RETRY_INTERVAL = <span class="hljs-number">10</span>

file_path_1 = <span class="hljs-string">'comments/主评论_1.1.csv'</span>
file_path_2 = <span class="hljs-string">'comments/二级评论_1.2.csv'</span>

beijing_tz = pytz.timezone(<span class="hljs-string">'Asia/Shanghai'</span>)<span class="hljs-comment">#时间戳转换为北京时间</span>
ua=UserAgent()<span class="hljs-comment">#创立随机请求头</span>

ps= <span class="hljs-number">20</span>

down = <span class="hljs-number">1</span> <span class="hljs-comment">#开始爬的页数a</span>
up = <span class="hljs-number">30</span><span class="hljs-comment">#结束爬的页数</span>

one_comments = []
all_comments = []<span class="hljs-comment">#构造数据放在一起的容器  总共评论，如果只希望含有一级评论，请注释 line 144</span>
all_2_comments = []<span class="hljs-comment">#构造数据放在一起的容器 二级评论</span>
comments_current = []
comments_current_2 = []

        <span class="hljs-comment"># 将所有评论数据写入CSV文件</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path_1, mode=<span class="hljs-string">'a'</span>, newline=<span class="hljs-string">''</span>, encoding=<span class="hljs-string">'utf-8-sig'</span>) <span class="hljs-keyword">as</span> file:
    writer = csv.writer(file)
    writer.writerow([<span class="hljs-string">'昵称'</span>, <span class="hljs-string">'性别'</span>, <span class="hljs-string">'时间'</span>, <span class="hljs-string">'点赞'</span>, <span class="hljs-string">'评论'</span>, <span class="hljs-string">'IP属地'</span>,<span class="hljs-string">'二级评论条数'</span>,<span class="hljs-string">'等级'</span>,<span class="hljs-string">'uid'</span>,<span class="hljs-string">'rpid'</span>])
    writer.writerows(all_comments)
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path_2, mode=<span class="hljs-string">'a'</span>, newline=<span class="hljs-string">''</span>, encoding=<span class="hljs-string">'utf-8-sig'</span>) <span class="hljs-keyword">as</span> file:<span class="hljs-comment">#二级评论条数</span>
    writer = csv.writer(file)
    writer.writerow([<span class="hljs-string">'昵称'</span>, <span class="hljs-string">'性别'</span>, <span class="hljs-string">'时间'</span>, <span class="hljs-string">'点赞'</span>, <span class="hljs-string">'评论'</span>, <span class="hljs-string">'IP属地'</span>,<span class="hljs-string">'二级评论条数,条数相同说明在同一个人下面'</span>,<span class="hljs-string">'等级'</span>,<span class="hljs-string">'uid'</span>,<span class="hljs-string">'rpid'</span>])
    writer.writerows(all_2_comments)

<span class="hljs-keyword">with</span> requests.Session() <span class="hljs-keyword">as</span> session:
    retries = Retry(total=<span class="hljs-number">3</span>,  <span class="hljs-comment"># 最大重试次数，好像没有这个函数</span>
                    backoff_factor=<span class="hljs-number">0.1</span>,  <span class="hljs-comment"># 间隔时间会乘以这个数</span>
                    status_forcelist=[<span class="hljs-number">500</span>, <span class="hljs-number">502</span>, <span class="hljs-number">503</span>, <span class="hljs-number">504</span>])

    <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(down, up + <span class="hljs-number">1</span>):
        <span class="hljs-keyword">for</span> retry <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(MAX_RETRIES):
            <span class="hljs-keyword">try</span>:
                headers = {
                <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36'</span>,<span class="hljs-comment">#'ua.random',#随机请求头，b站爸爸别杀我，赛博佛祖保佑</span>
                <span class="hljs-string">'Cookie'</span>: cookies_str,
                <span class="hljs-string">'SESSDATA'</span>: sessdata,
                <span class="hljs-string">'csrf'</span> : bili_jct,
                }
                url =      <span class="hljs-string">'https://api.bilibili.com/x/v2/reply?'</span><span class="hljs-comment">#正常api，只能爬8k</span>
                url_long = <span class="hljs-string">'https://api.bilibili.com/x/v2/reply/main'</span><span class="hljs-comment">#懒加载api，理论无上限</span>
                url_reply = <span class="hljs-string">'https://api.bilibili.com/x/v2/reply/reply'</span><span class="hljs-comment">#评论区回复api</span>
                <span class="hljs-comment">#示例：https://api.bilibili.com/x/v2/reply/main?next=1&amp;type=1&amp;oid=544588138&amp;mode=3（可访问网站）</span>
                data = {
                <span class="hljs-string">'next'</span>:<span class="hljs-built_in">str</span>(page),  <span class="hljs-comment"># 页数，需要转换为字符串，与pn同理，使用懒加载api</span>
                <span class="hljs-string">'type'</span>: <span class="hljs-built_in">type</span>,  <span class="hljs-comment"># 类型 11个人动态 17转发动态 视频1）</span>
                <span class="hljs-string">'oid'</span>: oid,  <span class="hljs-comment">#id，视频为av，文字动态地址栏id，可自查</span>
                <span class="hljs-string">'ps'</span>:ps, <span class="hljs-comment">#(每页含有条数，不能大于20)用long的话不能大于30</span>
                <span class="hljs-string">'mode'</span>: <span class="hljs-string">'3'</span>  <span class="hljs-comment">#3为热度       0 3：仅按热度      1：按热度+按时间 2：仅按时间 使用懒加载api</span>
                }
                proxies = {
                     <span class="hljs-comment">#"http": "http://%(user)s:%(pwd)s@%(proxy)s/" % {"user": username, "pwd": password, "proxy": tunnel},</span>
                     <span class="hljs-comment">#"https": "http://%(user)s:%(pwd)s@%(proxy)s/" % {"user": username, "pwd": password, "proxy": tunnel}</span>
                      <span class="hljs-comment">#代理ip来源：https://www.kuaidaili.com/free/inha/</span>
                }
                prep = session.prepare_request(requests.Request(<span class="hljs-string">'GET'</span>, url_long, params=data, headers=headers))
                <span class="hljs-built_in">print</span>(prep.url)
                response = session.get(url_long, params=data, headers=headers)
                <span class="hljs-comment"># 检查响应状态码是否为200，即成功</span>
                <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
                    json_data = response.json()<span class="hljs-comment">#获得json数据</span>
                    <span class="hljs-keyword">if</span> <span class="hljs-string">'data'</span> <span class="hljs-keyword">in</span> json_data <span class="hljs-keyword">and</span> <span class="hljs-string">'replies'</span> <span class="hljs-keyword">in</span> json_data[<span class="hljs-string">'data'</span>]: <span class="hljs-comment">#以下为核心内容，爬取的数据</span>
                                <span class="hljs-keyword">for</span> comment <span class="hljs-keyword">in</span> json_data[<span class="hljs-string">'data'</span>][<span class="hljs-string">'replies'</span>]:
                                    <span class="hljs-comment">#one_comments.clear()</span>
                                    count = comment[<span class="hljs-string">'rcount'</span>]
                                    rpid = <span class="hljs-built_in">str</span>(comment[<span class="hljs-string">'rpid'</span>])
                                    name = comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'uname'</span>]
                                    sex = comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'sex'</span>]
                                    ctime = comment[<span class="hljs-string">'ctime'</span>]
                                    dt_object = datetime.datetime.fromtimestamp(ctime, datetime.timezone.utc)
                                    formatted_time = dt_object.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>) + <span class="hljs-string">' 北京时间'</span>  <span class="hljs-comment"># 可以加上时区信息，但通常不需要</span>
                                    like = comment[<span class="hljs-string">'like'</span>]
                                    message = comment[<span class="hljs-string">'content'</span>][<span class="hljs-string">'message'</span>].replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">','</span>)
                                    <span class="hljs-comment"># 检查是否存在 location 字段</span>
                                    location = comment[<span class="hljs-string">'reply_control'</span>].get(<span class="hljs-string">'location'</span>, <span class="hljs-string">'未知'</span>)  <span class="hljs-comment"># 如果不存在，使用 '未知'</span>
                                    location = location.replace(<span class="hljs-string">'IP属地：'</span>, <span class="hljs-string">''</span>) <span class="hljs-keyword">if</span> location <span class="hljs-keyword">else</span> location
                                    <span class="hljs-comment"># 将提取的信息追加到列表中</span>
                                    current_level = comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'level_info'</span>][<span class="hljs-string">'current_level'</span>]
                                    mid = <span class="hljs-built_in">str</span>(comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'mid'</span>])
                                    all_comments.append([name, sex, formatted_time, like, message, location,count,current_level,mid,rpid])
                                    comments_current.append([name, sex, formatted_time, like, message, location, count, current_level,mid,rpid])

                                    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path_1, mode=<span class="hljs-string">'a'</span>, newline=<span class="hljs-string">''</span>, encoding=<span class="hljs-string">'utf-8-sig'</span>) <span class="hljs-keyword">as</span> file:
                                        writer = csv.writer(file)
                                        writer.writerows(all_comments)
                                    all_comments.clear()

                                    <span class="hljs-comment">#每次结束，重置计数器</span>
                                    <span class="hljs-keyword">if</span>(count != <span class="hljs-number">0</span>):
                                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"在第<span class="hljs-subst">{page}</span>页中含有二级评论,该条回复下面总共含有<span class="hljs-subst">{count}</span>个二级评论"</span>)
                                        total_pages = ((count // <span class="hljs-number">20</span> ) +<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
                                        <span class="hljs-keyword">for</span> page_pn <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(total_pages):
                                            data_2 = {
                                                <span class="hljs-comment"># 二级评论的data</span>
                                                <span class="hljs-string">'type'</span>: <span class="hljs-built_in">type</span>,  <span class="hljs-comment"># 类型</span>
                                                <span class="hljs-string">'oid'</span>: oid,  <span class="hljs-comment"># id</span>
                                                <span class="hljs-string">'ps'</span>: ps,  <span class="hljs-comment"># 每页含有条数，不能大于20</span>
                                                <span class="hljs-string">'pn'</span>: <span class="hljs-built_in">str</span>(page_pn),  <span class="hljs-comment"># 二级评论页数，需要转换为字符串</span>
                                                <span class="hljs-string">'root'</span>: rpid  <span class="hljs-comment"># 一级评论的rpid</span>
                                            }
                                            <span class="hljs-keyword">if</span> page_pn == <span class="hljs-number">0</span>:
                                                <span class="hljs-keyword">continue</span>
                                            response = session.get(url_reply, params=data_2, headers=headers, proxies=proxies)
                                            prep = session.prepare_request(requests.Request(<span class="hljs-string">'GET'</span>, url_reply, params=data_2, headers=headers))
                                            <span class="hljs-built_in">print</span>(prep.url)

                                            <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
                                                json_data = response.json()  <span class="hljs-comment"># 获得json数据</span>
                                                <span class="hljs-keyword">if</span> <span class="hljs-string">'data'</span> <span class="hljs-keyword">in</span> json_data <span class="hljs-keyword">and</span> <span class="hljs-string">'replies'</span> <span class="hljs-keyword">in</span> json_data[<span class="hljs-string">'data'</span>]:
                                                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> json_data[<span class="hljs-string">'data'</span>][<span class="hljs-string">'replies'</span>]:  <span class="hljs-comment"># 检查replies是否为空，如果为空，跳过这一页</span>
                                                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"该页replies为空，没有评论"</span>)
                                                        <span class="hljs-keyword">continue</span>
                                                    <span class="hljs-keyword">for</span> comment <span class="hljs-keyword">in</span> json_data[<span class="hljs-string">'data'</span>][<span class="hljs-string">'replies'</span>]:
                                                        rpid = <span class="hljs-built_in">str</span>(comment[<span class="hljs-string">'rpid'</span>])
                                                        name = comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'uname'</span>]
                                                        sex = comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'sex'</span>]
                                                        ctime = comment[<span class="hljs-string">'ctime'</span>]
                                                        dt_object = datetime.datetime.fromtimestamp(ctime,datetime.timezone.utc)
                                                        formatted_time = dt_object.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>) + <span class="hljs-string">' 北京时间'</span>  <span class="hljs-comment"># 可以加上时区信息，但通常不需要</span>
                                                        like = comment[<span class="hljs-string">'like'</span>]
                                                        message = comment[<span class="hljs-string">'content'</span>][<span class="hljs-string">'message'</span>].replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">','</span>)
                                                        <span class="hljs-comment"># 检查是否存在 location 字段</span>
                                                        location = comment[<span class="hljs-string">'reply_control'</span>].get(<span class="hljs-string">'location'</span>,<span class="hljs-string">'未知'</span>)  <span class="hljs-comment"># 如果不存在，使用 '未知'</span>
                                                        location = location.replace(<span class="hljs-string">'IP属地：'</span>, <span class="hljs-string">''</span>) <span class="hljs-keyword">if</span> location <span class="hljs-keyword">else</span> location
                                                        current_level = comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'level_info'</span>][<span class="hljs-string">'current_level'</span>]
                                                        mid = <span class="hljs-built_in">str</span>(comment[<span class="hljs-string">'member'</span>][<span class="hljs-string">'mid'</span>])
                                                        all_2_comments.append([name, sex, formatted_time, like, message, location, count,current_level,mid,rpid])
                                                        comments_current_2.append([name, sex, formatted_time, like, message, location, count,current_level,mid,rpid])
                                                        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path_2, mode=<span class="hljs-string">'a'</span>, newline=<span class="hljs-string">''</span>,encoding=<span class="hljs-string">'utf-8-sig'</span>) <span class="hljs-keyword">as</span> file:  <span class="hljs-comment"># 二级评论条数</span>
                                                            writer = csv.writer(file)
                                                            writer.writerows(all_2_comments)
                                                        all_2_comments.clear()
                                                <span class="hljs-keyword">else</span>:
                                                    <span class="hljs-comment">#print(f"在第{page_pn + 1}页的JSON响应中缺少 'data' 或 'replies' 键。跳过此页。")</span>
                                                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"在页面<span class="hljs-subst">{page}</span>下第<span class="hljs-subst">{page_pn + <span class="hljs-number">1</span>}</span>条评论没有子评论。"</span>)
                                            <span class="hljs-keyword">else</span>:
                                                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取第<span class="hljs-subst">{page_pn + <span class="hljs-number">1</span>}</span>页失败。状态码: <span class="hljs-subst">{response.status_code}</span>"</span>)
                                        random_number = random.uniform(<span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>)
                                        time.sleep(random_number)
                                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已经爬取第<span class="hljs-subst">{page}</span>页. 状态码: <span class="hljs-subst">{response.status_code}</span> "</span>)
                    <span class="hljs-keyword">else</span>:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"在页面 <span class="hljs-subst">{page}</span> 的JSON响应中缺少 'data' 或 'replies' 键。跳过此页。"</span>)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取页面 <span class="hljs-subst">{page}</span> 失败。状态码: <span class="hljs-subst">{response.status_code}</span> 即为失败，请分析原因并尝试重试"</span>)

                random_number = random.uniform(<span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>)
                <span class="hljs-built_in">print</span>(random_number)
                time.sleep(random_number)
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"连接失败: <span class="hljs-subst">{e}</span>"</span>)
                <span class="hljs-keyword">if</span> retry &lt; MAX_RETRIES - <span class="hljs-number">1</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在重试（剩余尝试次数：<span class="hljs-subst">{MAX_RETRIES - retry - <span class="hljs-number">1</span>}</span>）..."</span>)
                    time.sleep(RETRY_INTERVAL)  <span class="hljs-comment"># 等待一段时间后重试</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">raise</span>  <span class="hljs-comment"># 如果达到最大重试次数，则抛出原始异常</span>

</code></pre> 
</div> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/05b04d911a0c1d6ab7ac8cac01b6e7fc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Nginx&#43;KeepAlived高可用负载均衡集群的部署</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d8c2afa6159cbc446fb972ce3c10bf50/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C语言——文件操作</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>