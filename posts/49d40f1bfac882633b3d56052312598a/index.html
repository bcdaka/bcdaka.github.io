<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>周周星分享7.3—基于气象大数据的自动站实况联合预测 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/49d40f1bfac882633b3d56052312598a/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="周周星分享7.3—基于气象大数据的自动站实况联合预测">
  <meta property="og:description" content="赛题 2024中国高校计算机大赛 — 大数据挑战赛
经验分享 大家好，我是扫地僧团队的队长，以前参加这样打榜的比赛比较少，了解的打榜技巧不是太多，所以想从科研的角度给大家一点分享。
这次比赛主要从以下五个步骤进行：数据集构造👉Baseline选择👉模型优化👉模型调参👉模型集成
1. 数据集构造 官方已经给了数据集，可以尝试根据温度筛选出与中国温度类似的场站，但是不确定是否会有效果：
import numpy as np import pandas as pd import os import matplotlib.pyplot as plt root_path = &#39;../dataset/global&#39; data_path = &#39;temp.npy&#39; data = np.load(os.path.join(root_path, data_path)) data_oneyear = data[:365*24,:,0] df = pd.DataFrame(data_oneyear) # 夏天平均温度大于15摄氏度 summer_df = df.iloc[4000:5500] print(summer_df.shape) summer_index = summer_df.mean(axis=0).apply(lambda x: x &gt; 15) summer_index = summer_index[summer_index].index.to_list() print(len(summer_index)) # 冬天平均温度小于20摄氏度 winter_df = df.iloc[0:500] print(winter_df.shape) winter_index = winter_df.mean(axis=0).apply(lambda x: x &lt; 20) winter_index = winter_index[winter_index].">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-03T22:59:17+08:00">
    <meta property="article:modified_time" content="2024-07-03T22:59:17+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">周周星分享7.3—基于气象大数据的自动站实况联合预测</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>赛题</h3> 
<p><a href="http://nercbds.tsinghua.edu.cn/bdc" rel="nofollow">2024中国高校计算机大赛 — 大数据挑战赛</a></p> 
<p><img src="https://images2.imgbox.com/68/08/AZI5wG0r_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_5"></a>经验分享</h3> 
<p>大家好，我是扫地僧团队的队长，以前参加这样打榜的比赛比较少，了解的打榜技巧不是太多，所以想从科研的角度给大家一点分享。</p> 
<p>这次比赛主要从以下五个步骤进行：<strong>数据集构造👉Baseline选择👉模型优化👉模型调参👉模型集成</strong></p> 
<h4><a id="1__10"></a>1. 数据集构造</h4> 
<p>官方已经给了数据集，可以尝试根据温度筛选出与中国温度类似的场站，但是不确定是否会有效果：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> os
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

root_path <span class="token operator">=</span> <span class="token string">'../dataset/global'</span>
data_path <span class="token operator">=</span> <span class="token string">'temp.npy'</span>
data <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_path<span class="token punctuation">,</span> data_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

data_oneyear <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">365</span><span class="token operator">*</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data_oneyear<span class="token punctuation">)</span>

<span class="token comment"># 夏天平均温度大于15摄氏度</span>
summer_df <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">4000</span><span class="token punctuation">:</span><span class="token number">5500</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>summer_df<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
summer_index <span class="token operator">=</span> summer_df<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">&gt;</span> <span class="token number">15</span><span class="token punctuation">)</span>
summer_index <span class="token operator">=</span> summer_index<span class="token punctuation">[</span>summer_index<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>summer_index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 冬天平均温度小于20摄氏度</span>
winter_df <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">500</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>winter_df<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
winter_index <span class="token operator">=</span> winter_df<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span>
winter_index <span class="token operator">=</span> winter_index<span class="token punctuation">[</span>winter_index<span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">.</span>to_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>winter_index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 取两个表的交集</span>
index <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>summer_index<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token builtin">set</span><span class="token punctuation">(</span>winter_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 取两个表的交集</span>
index <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>summer_index<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token builtin">set</span><span class="token punctuation">(</span>north_index<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token builtin">set</span><span class="token punctuation">(</span>winter_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 筛选电站</span>
root_path<span class="token operator">=</span> <span class="token string">'../dataset/global'</span>
temp_path <span class="token operator">=</span> <span class="token string">'temp.npy'</span>
wind_path <span class="token operator">=</span> <span class="token string">'wind.npy'</span>
global_data_path <span class="token operator">=</span> <span class="token string">'global_data.npy'</span>
temp_data <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_path<span class="token punctuation">,</span> temp_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
wind_data <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_path<span class="token punctuation">,</span> wind_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
global_data <span class="token operator">=</span> np<span class="token punctuation">.</span>load<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root_path<span class="token punctuation">,</span> global_data_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>temp_data<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>wind_data<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>global_data<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

temp_seleted <span class="token operator">=</span> temp_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>index<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
wind_seleted <span class="token operator">=</span> wind_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>index<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
global_seleted <span class="token operator">=</span> global_data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span>index<span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>temp_seleted<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>wind_seleted<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>global_seleted<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

<span class="token comment"># 划分训练集和验证集</span>
l <span class="token operator">=</span> temp_seleted<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
train_size <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>l <span class="token operator">*</span> <span class="token number">0.9</span><span class="token punctuation">)</span>
temp_seleted_train <span class="token operator">=</span> temp_seleted<span class="token punctuation">[</span><span class="token punctuation">:</span>train_size<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
wind_seleted_train <span class="token operator">=</span> wind_seleted<span class="token punctuation">[</span><span class="token punctuation">:</span>train_size<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
global_seleted_train <span class="token operator">=</span> global_seleted<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span>train_size<span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
temp_seleted_val <span class="token operator">=</span> temp_seleted<span class="token punctuation">[</span>train_size<span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
wind_seleted_val <span class="token operator">=</span> wind_seleted<span class="token punctuation">[</span>train_size<span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
global_seleted_val <span class="token operator">=</span> global_seleted<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>train_size<span class="token operator">/</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"train:"</span><span class="token punctuation">,</span>temp_seleted_train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>wind_seleted_train<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>global_seleted_train<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"val:"</span><span class="token punctuation">,</span>temp_seleted_val<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>wind_seleted_val<span class="token punctuation">.</span>shape<span class="token punctuation">,</span>global_seleted_val<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

<span class="token comment"># 保存训练集和验证集</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'../dataset'</span><span class="token punctuation">,</span> <span class="token string">'seleted_global_train_val'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'../dataset'</span><span class="token punctuation">,</span> <span class="token string">'seleted_global_train_val'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
selected_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'../dataset'</span><span class="token punctuation">,</span> <span class="token string">'seleted_global_train_val'</span><span class="token punctuation">)</span>
np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>selected_path<span class="token punctuation">,</span> <span class="token string">'temp_train.npy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> temp_seleted_train<span class="token punctuation">)</span>
np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>selected_path<span class="token punctuation">,</span> <span class="token string">'temp_val.npy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> temp_seleted_val<span class="token punctuation">)</span>
np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>selected_path<span class="token punctuation">,</span> <span class="token string">'wind_train.npy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wind_seleted_train<span class="token punctuation">)</span>
np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>selected_path<span class="token punctuation">,</span> <span class="token string">'wind_val.npy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wind_seleted_val<span class="token punctuation">)</span>
np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>selected_path<span class="token punctuation">,</span> <span class="token string">'global_train.npy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> global_seleted_train<span class="token punctuation">)</span>
np<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>selected_path<span class="token punctuation">,</span> <span class="token string">'global_val.npy'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> global_seleted_val<span class="token punctuation">)</span>
</code></pre> 
<p>筛选后温度和风速形状如图所示：</p> 
<p><img src="https://images2.imgbox.com/b0/8c/5S0frcI5_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="2_Baseline_95"></a>2. Baseline选择</h4> 
<p>官方Baseline给的是iTransformer，关于iTransformer模型的解读请参考：<a href="https://www.guyuehome.com/47015" rel="nofollow">【PaperInFive-时间序列预测】iTransformer:转置Transformer刷新时间序列预测SOTA(清华)</a></p> 
<p>可以关注近近两年开源的SOTA模型，这里分享一个Github，可以去上面找近年的SOTA模型：<a href="https://github.com/ddz16/TSFpaper">https://github.com/ddz16/TSFpaper</a></p> 
<h4><a id="3__100"></a>3. 模型优化</h4> 
<p>选好效果好的Baseline后就可以进行模型优化，比如iTransformer只建模了特征信息，那么可以在模型中补充对时序特征的建模，比如进行一些卷积操作，或者在时间维度上进行self-Attention，关于时间维度上的建模大家也可以参考SOTA论文，可以把不同论文里的模块进行一个融合，说不定会有好效果。</p> 
<h4><a id="4__103"></a>4. 模型调参</h4> 
<p>确定了模型结构后就可以进行模型超参数的调整，比如模型的维度和层数，学习率和batch size等，经过测试增加模型的dimention在一定程度上可以提高模型表现，但是增加层数好像效果不太明显。</p> 
<p>学习率方面我初始值为0.01或0.005，每一轮除以2进行衰减。batch size我设为40960。</p> 
<h4><a id="5__108"></a>5. 模型集成</h4> 
<p>最后可以把不同特征的模型进行集成，比如可以把多个模型的结果取平均，或者可以在训练时采用Mixture of Expert的方式加权求和。</p> 
<h3><a id="_112"></a>帮助代码</h3> 
<h4><a id="1__113"></a>1. 模型测试</h4> 
<p>加在<code>exp_long_term_forecasting.py</code>里面：</p> 
<pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">val</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> setting<span class="token punctuation">)</span><span class="token punctuation">:</span>
        _<span class="token punctuation">,</span> _<span class="token punctuation">,</span> val_data<span class="token punctuation">,</span> val_loader <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_data<span class="token punctuation">(</span><span class="token punctuation">)</span>

        time_now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

        criterion <span class="token operator">=</span> self<span class="token punctuation">.</span>_select_criterion<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>use_amp<span class="token punctuation">:</span>
            scaler <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>amp<span class="token punctuation">.</span>GradScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>state_dict_path<span class="token punctuation">,</span>map_location<span class="token operator">=</span>torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda:0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        val_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>batch_x<span class="token punctuation">,</span> batch_y<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>val_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            batch_x <span class="token operator">=</span> batch_x<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
            batch_y <span class="token operator">=</span> batch_y<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>

            <span class="token comment"># encoder - decoder</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>use_amp<span class="token punctuation">:</span>
                <span class="token keyword">with</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>amp<span class="token punctuation">.</span>autocast<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>output_attention<span class="token punctuation">:</span>
                        outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>

                    f_dim <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>features <span class="token operator">==</span> <span class="token string">'MS'</span> <span class="token keyword">else</span> <span class="token number">0</span>
                    outputs <span class="token operator">=</span> outputs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>pred_len<span class="token punctuation">:</span><span class="token punctuation">,</span> f_dim<span class="token punctuation">:</span><span class="token punctuation">]</span>
                    batch_y <span class="token operator">=</span> batch_y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>pred_len<span class="token punctuation">:</span><span class="token punctuation">,</span> f_dim<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
                    loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> batch_y<span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\titers: {0} | loss: {2:.7f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    val_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>output_attention<span class="token punctuation">:</span>
                    outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>batch_x<span class="token punctuation">)</span>

                f_dim <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>features <span class="token operator">==</span> <span class="token string">'MS'</span> <span class="token keyword">else</span> <span class="token number">0</span>
                outputs <span class="token operator">=</span> outputs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>pred_len<span class="token punctuation">:</span><span class="token punctuation">,</span> f_dim<span class="token punctuation">:</span><span class="token punctuation">]</span>
                batch_y <span class="token operator">=</span> batch_y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>pred_len<span class="token punctuation">:</span><span class="token punctuation">,</span> f_dim<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
                loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> batch_y<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">50</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\titers: {0} | loss: {1:.7f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                val_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                
        val_loss <span class="token operator">=</span> np<span class="token punctuation">.</span>average<span class="token punctuation">(</span>val_loss<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Val Loss: {0:.7f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>val_loss<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> self<span class="token punctuation">.</span>model
</code></pre> 
<h4><a id="2_Dataloader_170"></a>2. 验证集Dataloader</h4> 
<p>加在<code>data_factory.py</code>里面：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">data_provider</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
    Data <span class="token operator">=</span> data_dict<span class="token punctuation">[</span>args<span class="token punctuation">.</span>data<span class="token punctuation">]</span>

    shuffle_flag <span class="token operator">=</span> <span class="token boolean">True</span>
    drop_last <span class="token operator">=</span> <span class="token boolean">False</span>
    batch_size <span class="token operator">=</span> args<span class="token punctuation">.</span>batch_size 

    train_data_set <span class="token operator">=</span> Data<span class="token punctuation">(</span>
        root_path<span class="token operator">=</span>args<span class="token punctuation">.</span>root_path<span class="token punctuation">,</span>
        data_path<span class="token operator">=</span>args<span class="token punctuation">.</span>train_data_path<span class="token punctuation">,</span>
        global_path<span class="token operator">=</span>args<span class="token punctuation">.</span>train_global_path<span class="token punctuation">,</span>
        size<span class="token operator">=</span><span class="token punctuation">[</span>args<span class="token punctuation">.</span>seq_len<span class="token punctuation">,</span> args<span class="token punctuation">.</span>label_len<span class="token punctuation">,</span> args<span class="token punctuation">.</span>pred_len<span class="token punctuation">]</span><span class="token punctuation">,</span>
        features<span class="token operator">=</span>args<span class="token punctuation">.</span>features
    <span class="token punctuation">)</span>
    train_data_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>
        train_data_set<span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span>batch_size<span class="token punctuation">,</span>
        shuffle<span class="token operator">=</span>shuffle_flag<span class="token punctuation">,</span>
        num_workers<span class="token operator">=</span>args<span class="token punctuation">.</span>num_workers<span class="token punctuation">,</span>
        drop_last<span class="token operator">=</span>drop_last<span class="token punctuation">)</span>
    
    val_data_set <span class="token operator">=</span> Data<span class="token punctuation">(</span>
        root_path<span class="token operator">=</span>args<span class="token punctuation">.</span>root_path<span class="token punctuation">,</span>
        data_path<span class="token operator">=</span>args<span class="token punctuation">.</span>val_data_path<span class="token punctuation">,</span>
        global_path<span class="token operator">=</span>args<span class="token punctuation">.</span>val_global_path<span class="token punctuation">,</span>
        size<span class="token operator">=</span><span class="token punctuation">[</span>args<span class="token punctuation">.</span>seq_len<span class="token punctuation">,</span> args<span class="token punctuation">.</span>label_len<span class="token punctuation">,</span> args<span class="token punctuation">.</span>pred_len<span class="token punctuation">]</span><span class="token punctuation">,</span>
        features<span class="token operator">=</span>args<span class="token punctuation">.</span>features
    <span class="token punctuation">)</span>
    val_data_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>
        val_data_set<span class="token punctuation">,</span>
        batch_size<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>batch_size<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        num_workers<span class="token operator">=</span>args<span class="token punctuation">.</span>num_workers<span class="token punctuation">,</span>
        drop_last<span class="token operator">=</span>drop_last<span class="token punctuation">)</span>
    <span class="token keyword">return</span> train_data_set<span class="token punctuation">,</span> train_data_loader<span class="token punctuation">,</span> val_data_set<span class="token punctuation">,</span> val_data_loader
</code></pre> 
<h3><a id="_210"></a>最后</h3> 
<p>希望大家以赛为友，共同进步，一起分享一些有用的小技巧。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a12be63121323d444dc7042b842672fc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">计算机网络——数据链路层（点对点协议PPP）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2bdf9c71edcee76d7c79dd208f57fc0d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">人工智能--循环神经网络</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>