<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>局部路径规划 DWA 算法完全解析（理论推导&#43;代码实现，包你看懂！） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/cb0153c14f82becb3aef0d477679ceb5/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="局部路径规划 DWA 算法完全解析（理论推导&#43;代码实现，包你看懂！）">
  <meta property="og:description" content="转载请注明出处，谢谢
理论基础 前面学习的全局路径规划方法，Dijkstra、Best-First-Search、A*算法都属于状态采样（State Sampling）方法，而 DWA 局部路径规划则属于典型的动作采样（action sampling）方法
DWA 算法（Dynamic Window Approach）的原理主要是以一定的分辨率在速度空间 (v, w) 中采样多组速度，并模拟出这些速度在一定时间的运动轨迹，得到可行轨迹后通过评价函数对轨迹进行评分，评分后选取最优轨迹对应的 (v, w) 驱动机器人运动
速度空间 速度空间 (v, w) 即机器人的速度范围，机器人的速度受到各种因素的限制
移动机器人受自身最大速度最小速度的限制 Vs 为机器人能够到达的所有矢量速度的集合；机器人受到最大最小线速度和角速度影响
移动机器人受电机性能的影响 由于加速度有一个范围限制，所以最大加速度或最大减速度一定时间内能达到的速度 ，才会被保留，表达式如下：
移动机器人受障碍的影响 为了能在碰到障碍物前停下来，在最大减速度的条件下，速度满足以下条件：
其中dist(v,w)为（v,w）对应的轨迹上离障碍物最近的距离
在上述 3 个约束条件下，速度空间 (v, w) 会有一定的范围，注意速度空间不是固定不变的，而是时变的，t 时刻的速度空间与 t &#43; dt 时刻的速度空间是不同的，故将其称为动态窗口
速度采样 得到 t 时刻的速度空间 (v, w) 后，以一定的分辨率对速度 v 和角速度 w 进行采样
设 t 时刻小车 x 轴线速度取值范围 5~20m/s,为简化数学模型，设 y轴线速度为0m/s，小车的角速度取值范围 0.1~1rad/s,小车的线速度的速度分辨率为0.1m/s，角速度的速度分辨率为0.05rad/s
根据离散的方法，离散 x 轴线速度和角速度如下
运动模型 之所以要分析机器人的运动学模型，是因为要根据采样的速度 (v, w) 模拟机器人的运动轨迹">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-07-22T10:26:03+08:00">
    <meta property="article:modified_time" content="2023-07-22T10:26:03+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">局部路径规划 DWA 算法完全解析（理论推导&#43;代码实现，包你看懂！）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <hr> 
<p>转载请注明出处，谢谢</p> 
<hr> 
<h2><a id="_5"></a>理论基础</h2> 
<p>前面学习的全局路径规划方法，Dijkstra、Best-First-Search、A*算法都属于<code>状态采样</code>（State Sampling）方法，而 DWA 局部路径规划则属于典型的<code>动作采样</code>（action sampling）方法</p> 
<p>DWA 算法（Dynamic Window Approach）的原理主要是以一定的<code>分辨率</code>在<code>速度空间</code> (v, w) 中<strong>采样</strong>多组速度，并模拟出这些速度在一定时间的<code>运动轨迹</code>，得到可行轨迹后通过<code>评价函数</code>对轨迹进行评分，评分后选取最优轨迹对应的 (v, w) 驱动机器人运动</p> 
<h3><a id="_11"></a>速度空间</h3> 
<p>速度空间 (v, w) 即机器人的速度范围，机器人的速度受到各种因素的限制</p> 
<ul><li><strong><strong>移动机器人受自身最大速度最小速度的限制</strong></strong></li></ul> 
<p>Vs 为机器人能够到达的所有矢量速度的集合；机器人受到最大最小线速度和角速度影响</p> 
<p><img src="https://images2.imgbox.com/b5/4d/bWmahjSi_o.png" alt="在这里插入图片描述"></p> 
<ul><li><strong><strong>移动机器人受电机性能的影响</strong></strong></li></ul> 
<p>由于加速度有一个范围限制，所以最大加速度或最大减速度一定时间内能达到的速度 ，才会被保留，表达式如下：</p> 
<p><img src="https://images2.imgbox.com/5a/70/w4Ahpjvc_o.png" alt="在这里插入图片描述"></p> 
<ul><li><strong><strong>移动机器人受障碍的影响</strong></strong></li></ul> 
<p>为了能在碰到障碍物前停下来，在最大减速度的条件下，速度满足以下条件：</p> 
<p><img src="https://images2.imgbox.com/ff/ec/VU257K4N_o.png" alt="在这里插入图片描述"></p> 
<p>其中dist(v,w)为（v,w）对应的轨迹上离障碍物最近的距离</p> 
<p>在上述 3 个约束条件下，速度空间 (v, w) 会有一定的范围，注意速度空间不是固定不变的，而是时变的，<code>t</code> 时刻的速度空间与 <code>t + dt</code> 时刻的速度空间是不同的，故将其称为<code>动态窗口</code></p> 
<h3><a id="_40"></a>速度采样</h3> 
<p>得到 t 时刻的速度空间 (v, w) 后，以一定的分辨率对速度 v 和角速度 w 进行采样</p> 
<p>设 t 时刻小车 x 轴线速度取值范围 5~20m/s,为简化数学模型，设 y轴线速度为0m/s，小车的角速度取值范围 0.1~1rad/s,小车的线速度的速度分辨率为0.1m/s，角速度的速度分辨率为0.05rad/s<br> <img src="https://images2.imgbox.com/e4/36/BvMPGMoh_o.png" alt="在这里插入图片描述"></p> 
<p>根据离散的方法，离散 x 轴线速度和角速度如下</p> 
<p><img src="https://images2.imgbox.com/4f/11/VWeOSCAp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_53"></a>运动模型</h3> 
<p>之所以要分析机器人的运动学模型，是因为要根据采样的速度 (v, w) 模拟机器人的运动轨迹</p> 
<p><img src="https://images2.imgbox.com/cd/79/hYfvA4fL_o.png" alt="在这里插入图片描述"></p> 
<p>DWA 算法适用于差速运动模型和全向运动模型，并不适用于阿克曼模型</p> 
<h4><a id="_62"></a>差速运动模型</h4> 
<p>机器人只能向前运动或者旋转，图中有世界坐标系和机器人坐标系，下式中 v(t) 指机器人坐标系中 x 方向的速度</p> 
<p><img src="https://images2.imgbox.com/17/26/B2GNHSKU_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_69"></a>全向移动模型</h4> 
<p>在全向移动模型中，多了机器人坐标系下 y 方向的速度</p> 
<p><img src="https://images2.imgbox.com/42/d7/YuoRq907_o.png" alt="在这里插入图片描述"></p> 
<p>令 Vy(t) = 0，则退化为差速运动模型，因此 ROS 自带的局部路径规划器使用上式计算</p> 
<h3><a id="_78"></a>轨迹预测</h3> 
<p>在确定机器人的采样速度和运动模型后，可以对机器人的状态进行预测和更新</p> 
<p>机器人下一时刻位移距离</p> 
<p><img src="https://images2.imgbox.com/67/33/T7WAWTgD_o.png" alt="在这里插入图片描述"></p> 
<p>机器人下一时刻坐标的变化</p> 
<p><img src="https://images2.imgbox.com/d9/7a/JbDE5W2Y_o.png" alt="在这里插入图片描述"></p> 
<p>采样时刻机器人坐标与坐标变化求和，得到下一时刻机器人坐标</p> 
<p><img src="https://images2.imgbox.com/eb/ed/M4Qe4VZJ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/90/76/LkhiyZFn_o.png" alt="在这里插入图片描述"></p> 
<p>设 ∆t 为 0.1s，实际上预测机器人前向几秒内的所有状态，假设前向预测时间为 3s，则会预测 <code>t ~ t + 3</code> s内的所有状态，即 <code>t</code> ~ <code>t + ∆t</code> ~ <code>t + 2*∆t</code> ~ …. ~ <code>t + 3</code>，相当于会预测出 t 时刻位置前 <strong>30</strong> 个点的位置，如下图所示</p> 
<p><img src="https://images2.imgbox.com/a2/38/d9lHV8cb_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_103"></a>评价函数</h3> 
<p>对速度空间进行采样后，根据机器人运动学模型能够预测出多条轨迹，需要对这些轨迹进行评价，选取最优的轨迹，机器人根据最优轨迹对应的速度进行运动</p> 
<p>DWA 算法对轨迹的评价函数一般如下所示</p> 
<p><img src="https://images2.imgbox.com/1b/e4/v77TLs67_o.png" alt="在这里插入图片描述"></p> 
<ul><li><code>heading(v,w)</code>为方位角评价函数：评价机器人在当前的设定的速度下，轨迹末端朝向与目标点之间的角度差距</li><li><code>dist(v,w)</code>主要的意义为机器人处于预测轨迹末端点位置时与地图上最近障碍物的距离，对于靠近障碍物的采样点进行惩罚，确保机器人的避障能力，降低机器人与障碍物发生碰撞的概率</li><li><code>velocity(v,w)</code>为当前机器人的线速度，为了促进机器人快速到达目标</li><li>α、β、γ、σ 为权重系数</li></ul> 
<p>很好理解：</p> 
<p>1、希望我的前进方向对准终点</p> 
<p>2、希望不发生任何碰撞</p> 
<p>3、希望速度尽量快</p> 
<p>4、除此之外，还要保证最短刹车距离是安全的</p> 
<p>原文中提到<code>方位角评价函数</code>对轨迹规划的影响较大，太大易陷入局部最优解，太小能更好地避障，但路径有点长，效率有限低</p> 
<p>当然也可以对评价函数进行优化，添加更多的评价函数指标</p> 
<p>注意需要对评价函数的结果进行<code>归一化</code>处理，将每一项除以每一项的总和，如下式</p> 
<p><img src="https://images2.imgbox.com/1c/01/Lobv4KDr_o.png" alt="在这里插入图片描述"></p> 
<p>这样可以避免不同类别<code>得分基数相差太大</code>造成的结果误差</p> 
<p>至此，DWA 算法的完整流程</p> 
<p><img src="https://images2.imgbox.com/53/c2/gYkM9l27_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="MATLAB__142"></a>MATLAB 仿真</h2> 
<p>程序的思维导图如下，这里只讲解重要的部分，绘图及障碍物设置部分暂时略过</p> 
<p><img src="https://images2.imgbox.com/fa/33/dNY8G799_o.png" alt="在这里插入图片描述"></p> 
<p>这里的 for 循环有次数限制，最多循环 5000 次</p> 
<pre><code class="prism language-matlab"><span class="token keyword">for</span> <span class="token number">i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token number">5000</span>  
    <span class="token comment">% DWA参数输入 返回控制量 u = [v(m/s),w(rad/s)] 和 轨迹</span>
    <span class="token punctuation">[</span>u<span class="token punctuation">,</span>traj<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">DynamicWindowApproach</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>Kinematic<span class="token punctuation">,</span>goal<span class="token punctuation">,</span>evalParam<span class="token punctuation">,</span>obstacle<span class="token punctuation">,</span>obstacleR<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">%算出下发速度u/当前速度u</span>
    x <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">% 机器人移动到下一个时刻的状态量 根据当前速度和角速度推导 下一刻的位置和角度</span>
    abc <span class="token operator">=</span> abc<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">% 历史轨迹的保存</span>
    result<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">[</span>result<span class="token punctuation">.</span>x<span class="token punctuation">;</span> x<span class="token operator">'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">%最新结果 以行的形式 添加到result.x，保存的是所有状态参数值，包括坐标xy、朝向、线速度、角速度，其实应该是只取坐标就OK</span>
    
    <span class="token comment">% 是否到达目的地</span>
    <span class="token keyword">if</span> <span class="token function">norm</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>POSE_X<span class="token operator">:</span>POSE_Y<span class="token punctuation">)</span><span class="token operator">-</span>goal<span class="token operator">'</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.25</span>   <span class="token comment">% norm函数来求得坐标上的两个点之间的距离</span>
        <span class="token function">disp</span><span class="token punctuation">(</span><span class="token string">'==========Arrive Goal!!=========='</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
    
    <span class="token comment">%====Animation====</span>
    hold off<span class="token punctuation">;</span>               <span class="token comment">% 关闭图形保持功能。 新图出现时，取消原图的显示。</span>
    ArrowLength <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>      <span class="token comment">% 箭头长度</span>
</code></pre> 
<h3><a id="DynamicWindowApproach__170"></a>DynamicWindowApproach() 函数</h3> 
<p><code>DynamicWindowApproach()</code> 函数最重要的函数，通过该函数返回最优控制量 u</p> 
<pre><code class="prism language-matlab"><span class="token comment">%% DWA算法实现 </span>
<span class="token comment">% model  机器人运动学模型  最高速度[m/s],最高旋转速度[rad/s],加速度[m/ss],旋转加速度[rad/ss], 速度分辨率[m/s],转速分辨率[rad/s]]</span>
<span class="token comment">% 输入参数：当前状态、模型参数、目标点、评价函数的参数、障碍物位置、障碍物半径</span>
<span class="token comment">% 返回参数：控制量 u = [v(m/s),w(rad/s)] 和 轨迹集合 N * 31  （N：可用的轨迹数）</span>
<span class="token comment">% 选取最优参数的物理意义：在局部导航过程中，使得机器人避开障碍物，朝着目标以较快的速度行驶。</span>
<span class="token keyword">function</span> <span class="token punctuation">[</span>u<span class="token punctuation">,</span>trajDB<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">DynamicWindowApproach</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>model<span class="token punctuation">,</span>goal<span class="token punctuation">,</span>evalParam<span class="token punctuation">,</span>ob<span class="token punctuation">,</span>R<span class="token punctuation">)</span>
<span class="token comment">% Dynamic Window [vmin,vmax,wmin,wmax] 最小速度 最大速度 最小角速度 最大角速度速度</span>
Vr <span class="token operator">=</span> <span class="token function">CalcDynamicWindow</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">% 根据当前状态 和 运动模型 计算当前的参数允许范围</span>

<span class="token comment">% 评价函数的计算 evalDB N*5  每行一组可用参数 分别为 速度、角速度、航向得分、距离得分、速度得分</span>
<span class="token comment">%               trajDB      每5行一条轨迹 每条轨迹都有状态x点串组成</span>
<span class="token punctuation">[</span>evalDB<span class="token punctuation">,</span>trajDB<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token function">Evaluation</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>Vr<span class="token punctuation">,</span>goal<span class="token punctuation">,</span>ob<span class="token punctuation">,</span>R<span class="token punctuation">,</span>model<span class="token punctuation">,</span>evalParam<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">%evalParam 评价函数参数 [heading,dist,velocity,predictDT]</span>

<span class="token keyword">if</span> <span class="token function">isempty</span><span class="token punctuation">(</span>evalDB<span class="token punctuation">)</span>
    <span class="token function">disp</span><span class="token punctuation">(</span><span class="token string">'no path to goal!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    u<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>

<span class="token comment">% 各评价函数正则化</span>
evalDB <span class="token operator">=</span> <span class="token function">NormalizeEval</span><span class="token punctuation">(</span>evalDB<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">% 最终评价函数的计算</span>
feval<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token function">evalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    feval <span class="token operator">=</span> <span class="token punctuation">[</span>feval<span class="token punctuation">;</span><span class="token function">evalParam</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">evalDB</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">%根据评价函数参数 前三个参数分配的权重 计算每一组可用的路径参数信息的得分</span>
<span class="token keyword">end</span>
evalDB <span class="token operator">=</span> <span class="token punctuation">[</span>evalDB feval<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">% 最后一组；加最后一列，每一组速度的最终得分</span>
 
<span class="token punctuation">[</span>maxv<span class="token punctuation">,</span>ind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>feval<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">% 选取评分最高的参数 对应分数返回给 maxv  对应下标返回给 ind</span>
u <span class="token operator">=</span> <span class="token function">evalDB</span><span class="token punctuation">(</span>ind<span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">'</span><span class="token punctuation">;</span><span class="token comment">% 返回最优参数的速度、角速度</span>
</code></pre> 
<h4><a id="CalcDynamicWindow__207"></a>CalcDynamicWindow() 函数</h4> 
<p>在该函数中首先调用 <code>CalcDynamicWindow()</code> 函数计算当前时刻的<code>速度空间</code> Vr</p> 
<pre><code class="prism language-matlab"><span class="token comment">%% 计算动态窗口</span>
<span class="token comment">% 返回 最小速度 最大速度 最小角速度 最大角速度速度</span>
<span class="token keyword">function</span> Vr <span class="token operator">=</span> <span class="token function">CalcDynamicWindow</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>model<span class="token punctuation">)</span>

V_SPD       <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">%机器人速度</span>
W_ANGLE_SPD <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">%机器人角速度 </span>

MD_MAX_V <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">% </span>
MD_MAX_W <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">% </span>
MD_ACC   <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">% </span>
MD_VW    <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">% </span>

global dt<span class="token punctuation">;</span>
<span class="token comment">% 车子速度的最大最小范围 依次为：最小速度 最大速度 最小角速度 最大角速度速度</span>
Vs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span> <span class="token function">model</span><span class="token punctuation">(</span>MD_MAX_V<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token function">model</span><span class="token punctuation">(</span>MD_MAX_W<span class="token punctuation">)</span> <span class="token function">model</span><span class="token punctuation">(</span>MD_MAX_W<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token comment">% 根据当前速度以及加速度限制计算的动态窗口  依次为：最小速度 最大速度 最小角速度 最大角速度速度</span>
Vd <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">x</span><span class="token punctuation">(</span>V_SPD<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">model</span><span class="token punctuation">(</span>MD_ACC<span class="token punctuation">)</span><span class="token operator">*</span>dt <span class="token function">x</span><span class="token punctuation">(</span>V_SPD<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">model</span><span class="token punctuation">(</span>MD_ACC<span class="token punctuation">)</span><span class="token operator">*</span>dt <span class="token punctuation">...</span>
    <span class="token function">x</span><span class="token punctuation">(</span>W_ANGLE_SPD<span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">model</span><span class="token punctuation">(</span>MD_VW<span class="token punctuation">)</span><span class="token operator">*</span>dt <span class="token function">x</span><span class="token punctuation">(</span>W_ANGLE_SPD<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">model</span><span class="token punctuation">(</span>MD_VW<span class="token punctuation">)</span><span class="token operator">*</span>dt<span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token comment">% 最终的Dynamic Window</span>
Vtmp <span class="token operator">=</span> <span class="token punctuation">[</span>Vs<span class="token punctuation">;</span>Vd<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">%2 X 4  每一列依次为：最小速度 最大速度 最小角速度 最大角速度速度</span>
<span class="token function">disp</span><span class="token punctuation">(</span>Vtmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
Vr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token function">Vtmp</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">Vtmp</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">Vtmp</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">Vtmp</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里相当于对 <code>Vs</code> 和 <code>Vd</code> 求了交集，如下图所示，<code>Va</code> 在后面的代码中有考虑</p> 
<p><img src="https://images2.imgbox.com/18/9b/9ovyWUs1_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Evaluation__243"></a>Evaluation() 函数</h4> 
<pre><code class="prism language-matlab"><span class="token comment">% 评价函数的计算 evalDB N*5  每行一组可用参数 分别为 速度、角速度、航向得分、距离得分、速度得分</span>
<span class="token comment">%               trajDB      每5行一条轨迹 每条轨迹都有状态x点串组成</span>
<span class="token punctuation">[</span>evalDB<span class="token punctuation">,</span>trajDB<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token function">Evaluation</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>Vr<span class="token punctuation">,</span>goal<span class="token punctuation">,</span>ob<span class="token punctuation">,</span>R<span class="token punctuation">,</span>model<span class="token punctuation">,</span>evalParam<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">%evalParam 评价函数参数 [heading,dist,velocity,predictDT]</span>

<span class="token comment">%% 评价函数 内部负责产生可用轨迹</span>
<span class="token comment">% 输入参数 ：当前状态、参数允许范围（窗口）、目标点、障碍物位置、障碍物半径、评价函数的参数</span>
<span class="token comment">% 返回参数：</span>
<span class="token comment">%           evalDB N*5  每行一组可用参数 分别为 速度、角速度、航向得分、距离得分、速度得分</span>
<span class="token comment">%           trajDB      每5行一条轨迹 每条轨迹包含 前向预测时间/dt + 1 = 31 个轨迹点（见生成轨迹函数）</span>
<span class="token keyword">function</span> <span class="token punctuation">[</span>evalDB<span class="token punctuation">,</span>trajDB<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Evaluation</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>Vr<span class="token punctuation">,</span>goal<span class="token punctuation">,</span>ob<span class="token punctuation">,</span>R<span class="token punctuation">,</span>model<span class="token punctuation">,</span>evalParam<span class="token punctuation">)</span>
evalDB <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
trajDB <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> vt <span class="token operator">=</span> <span class="token function">Vr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">Vr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>       <span class="token comment">%根据速度分辨率遍历所有可用速度： 最小速度和最大速度 之间 速度分辨率 递增 </span>
    <span class="token keyword">for</span> ot<span class="token operator">=</span><span class="token function">Vr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">Vr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>     <span class="token comment">%根据角度分辨率遍历所有可用角速度： 最小角速度和最大角速度 之间 角度分辨率 递增  </span>
        <span class="token comment">% 轨迹推测; 得到 xt: 机器人向前运动后的预测位姿; traj: 当前时刻 到 预测时刻之间的轨迹（由轨迹点组成）</span>
        <span class="token punctuation">[</span>xt<span class="token punctuation">,</span>traj<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">GenerateTrajectory</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>vt<span class="token punctuation">,</span>ot<span class="token punctuation">,</span><span class="token function">evalParam</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">%evalParam(4),前向模拟时间;</span>
        <span class="token comment">% 各评价函数的计算</span>
        heading <span class="token operator">=</span> <span class="token function">CalcHeadingEval</span><span class="token punctuation">(</span>xt<span class="token punctuation">,</span>goal<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 前项预测终点的航向得分  偏差越小分数越高</span>
        <span class="token punctuation">[</span>dist<span class="token punctuation">,</span>Flag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">CalcDistEval</span><span class="token punctuation">(</span>xt<span class="token punctuation">,</span>ob<span class="token punctuation">,</span>R<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">% 前项预测终点 距离最近障碍物的间隙得分 距离越远分数越高</span>
        vel     <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>vt<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">% 速度得分 速度越快分越高</span>
        stopDist <span class="token operator">=</span> <span class="token function">CalcBreakingDist</span><span class="token punctuation">(</span>vel<span class="token punctuation">,</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">% 制动距离的计算</span>
        <span class="token keyword">if</span> dist <span class="token operator">&gt;</span> stopDist <span class="token operator">&amp;&amp;</span> Flag <span class="token operator">==</span> <span class="token number">0</span> <span class="token comment">% 如果可能撞到最近的障碍物 则舍弃此路径 （到最近障碍物的距离 大于 刹车距离 才取用）</span>
            evalDB <span class="token operator">=</span> <span class="token punctuation">[</span>evalDB<span class="token punctuation">;</span><span class="token punctuation">[</span>vt ot heading dist vel<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            trajDB <span class="token operator">=</span> <span class="token punctuation">[</span>trajDB<span class="token punctuation">;</span>traj<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment">% 每5行 一条轨迹  </span>
            <span class="token function">disp</span><span class="token punctuation">(</span>evalDB<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">disp</span><span class="token punctuation">(</span>trajDB<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> 
<p><code>Evaluation()</code> 这个函数也很重要，它肩负了较多的职责，包括</p> 
<ul><li>对速度空间进行离散化采样</li></ul> 
<pre><code class="prism language-matlab"><span class="token keyword">for</span> vt <span class="token operator">=</span> <span class="token function">Vr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">Vr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>       <span class="token comment">%根据速度分辨率遍历所有可用速度： 最小速度和最大速度 之间 速度分辨率 递增 </span>
    <span class="token keyword">for</span> ot<span class="token operator">=</span><span class="token function">Vr</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">Vr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>     <span class="token comment">%根据角度分辨率遍历所有可用角速度： 最小角速度和最大角速度 之间 角度分辨率 递增  </span>
</code></pre> 
<ul><li>进行轨迹推测，预测出当前时刻到预测时刻之间的轨迹</li></ul> 
<p>调用 <code>GenerateTrajectory()</code> 函数进行轨迹预测</p> 
<pre><code class="prism language-matlab"><span class="token comment">%% 单条轨迹生成、轨迹推演函数</span>
<span class="token comment">% 输入参数： 当前状态、vt当前速度、ot角速度、evaldt 前向模拟时间、机器人模型参数（没用到）</span>
<span class="token comment">% 返回参数; </span>
<span class="token comment">%           x   : 机器人模拟时间内向前运动 预测的终点位姿(状态); </span>
<span class="token comment">%           traj: 当前时刻 到 预测时刻之间 过程中的位姿记录（状态记录） 当前模拟的轨迹  </span>
<span class="token comment">%                  轨迹点的个数为 evaldt / dt + 1 = 3.0 / 0.1 + 1 = 31</span>
<span class="token comment">%           </span>
<span class="token keyword">function</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span>traj<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">GenerateTrajectory</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>vt<span class="token punctuation">,</span>ot<span class="token punctuation">,</span>evaldt<span class="token punctuation">)</span>
global dt<span class="token punctuation">;</span>
time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
u <span class="token operator">=</span> <span class="token punctuation">[</span>vt<span class="token punctuation">;</span>ot<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">% 输入值</span>
traj <span class="token operator">=</span> x<span class="token punctuation">;</span>   <span class="token comment">% 机器人轨迹</span>
<span class="token keyword">while</span> time <span class="token operator">&lt;=</span> evaldt   
    time <span class="token operator">=</span> time<span class="token operator">+</span>dt<span class="token punctuation">;</span> <span class="token comment">% 时间更新</span>
    x <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">% 运动更新 前项模拟时间内 速度、角速度恒定</span>
    traj <span class="token operator">=</span> <span class="token punctuation">[</span>traj x<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">% 每一列代表一个轨迹点 一列一列的添加</span>
<span class="token keyword">end</span>
</code></pre> 
<p>在 <code>f()</code> 函数中通过状态空间表达式的形式更新机器人的状态</p> 
<pre><code class="prism language-matlab"><span class="token comment">%% Motion Model 根据当前状态推算下一个控制周期（dt）的状态</span>
<span class="token comment">% u = [vt; wt];当前时刻的速度、角速度 x = 状态[x(m),y(m),yaw(Rad),v(m/s),w(rad/s)]</span>
<span class="token keyword">function</span> x <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
global dt<span class="token punctuation">;</span>
F <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span>
     <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span>
     <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span>
     <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span>
     <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
B <span class="token operator">=</span> <span class="token punctuation">[</span>dt<span class="token operator">*</span><span class="token function">cos</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token number">0</span>
    dt<span class="token operator">*</span><span class="token function">sin</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token number">0</span>
    <span class="token number">0</span> dt
    <span class="token number">1</span> <span class="token number">0</span>
    <span class="token number">0</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
x<span class="token operator">=</span> F<span class="token operator">*</span>x<span class="token operator">+</span>B<span class="token operator">*</span>u<span class="token punctuation">;</span>
</code></pre> 
<ul><li>计算评价函数</li></ul> 
<p>调用 <code>CalcHeadingEval()</code> 计算方位角评价函数</p> 
<pre><code class="prism language-matlab"><span class="token comment">%% heading的评价函数计算</span>
<span class="token comment">% 输入参数：当前位置、目标位置</span>
<span class="token comment">% 输出参数：航向参数得分  当前车的航向和相对于目标点的航向 偏离程度越小 分数越高 最大180分</span>
<span class="token keyword">function</span> heading <span class="token operator">=</span> <span class="token function">CalcHeadingEval</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>goal<span class="token punctuation">)</span>
theta <span class="token operator">=</span> <span class="token function">toDegree</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">% 机器人朝向</span>
goalTheta <span class="token operator">=</span> <span class="token function">toDegree</span><span class="token punctuation">(</span><span class="token function">atan2</span><span class="token punctuation">(</span><span class="token function">goal</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">goal</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">% 目标点相对于机器人本身的方位 </span>
<span class="token keyword">if</span> goalTheta <span class="token operator">&gt;</span> theta
    targetTheta <span class="token operator">=</span> goalTheta<span class="token operator">-</span>theta<span class="token punctuation">;</span><span class="token comment">% [deg]</span>
<span class="token keyword">else</span>
    targetTheta <span class="token operator">=</span> theta<span class="token operator">-</span>goalTheta<span class="token punctuation">;</span><span class="token comment">% [deg]</span>
<span class="token keyword">end</span>
 
heading <span class="token operator">=</span> <span class="token number">180</span> <span class="token operator">-</span> targetTheta<span class="token punctuation">;</span>
</code></pre> 
<p>调用 <code>CalcDistEval()</code> 计算障碍物距离评价函数</p> 
<pre><code class="prism language-matlab"><span class="token comment">%% 障碍物距离评价函数  （机器人在当前轨迹上与最近的障碍物之间的距离，如果没有障碍物则设定一个常数）</span>
<span class="token comment">% 输入参数：位姿、所有障碍物位置、障碍物半径</span>
<span class="token comment">% 输出参数：当前预测的轨迹终点的位姿距离所有障碍物中最近的障碍物的距离 如果大于设定的最大值则等于最大值</span>
<span class="token comment">% 距离障碍物距离越近分数越低</span>
<span class="token keyword">function</span> <span class="token punctuation">[</span>dist<span class="token punctuation">,</span>Flag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">CalcDistEval</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>ob<span class="token punctuation">,</span>R<span class="token punctuation">)</span>
dist<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> io <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token function">ob</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    disttmp <span class="token operator">=</span> <span class="token function">norm</span><span class="token punctuation">(</span><span class="token function">ob</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span><span class="token operator">:</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">'</span><span class="token punctuation">)</span><span class="token operator">-</span>R<span class="token punctuation">;</span> <span class="token comment">%到第io个障碍物的距离 - 障碍物半径  ！！！有可能出现负值吗</span>
    <span class="token keyword">if</span> disttmp <span class="token operator">&lt;</span><span class="token number">0</span>
        Flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        Flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">if</span> dist <span class="token operator">&gt;</span> disttmp   <span class="token comment">% 大于最小值 则选择最小值</span>
        dist <span class="token operator">=</span> disttmp<span class="token punctuation">;</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
 
<span class="token comment">% 障碍物距离评价限定一个最大值，如果不设定，一旦一条轨迹没有障碍物，将太占比重</span>
<span class="token keyword">if</span> dist <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token operator">*</span>R <span class="token comment">%最大分数限制</span>
    dist <span class="token operator">=</span> <span class="token number">3</span><span class="token operator">*</span>R<span class="token punctuation">;</span>
<span class="token keyword">end</span>
</code></pre> 
<p>调用 <code>abs()</code> 计算速度评价函数</p> 
<pre><code class="prism language-matlab">vel     <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>vt<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">% 速度得分 速度越快分越高</span>
</code></pre> 
<p>调用 <code>CalcBreakingDist()</code> 函数计算制动距离，并比较制动距离与最近障碍物距离，判断是否要舍弃该路径，这里相当于考虑了速度空间中的 <code>Va</code></p> 
<pre><code class="prism language-matlab"><span class="token comment">%% 计算制动距离 </span>
<span class="token comment">%根据运动学模型计算制动距离, 也可以考虑成走一段段圆弧的累积 简化可以当一段段小直线的累积</span>
<span class="token keyword">function</span> stopDist <span class="token operator">=</span> <span class="token function">CalcBreakingDist</span><span class="token punctuation">(</span>vel<span class="token punctuation">,</span>model<span class="token punctuation">)</span>
global dt<span class="token punctuation">;</span>
MD_ACC   <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">% </span>
stopDist<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> vel<span class="token operator">&gt;</span><span class="token number">0</span>   <span class="token comment">%给定加速度的条件下 速度减到0所走的距离</span>
    stopDist <span class="token operator">=</span> stopDist <span class="token operator">+</span> vel<span class="token operator">*</span>dt<span class="token punctuation">;</span><span class="token comment">% 制动距离的计算 </span>
    vel <span class="token operator">=</span> vel <span class="token operator">-</span> <span class="token function">model</span><span class="token punctuation">(</span>MD_ACC<span class="token punctuation">)</span><span class="token operator">*</span>dt<span class="token punctuation">;</span><span class="token comment">% </span>
<span class="token keyword">end</span>
</code></pre> 
<h4><a id="NormalizeEval__402"></a>NormalizeEval() 函数</h4> 
<p>计算得到各轨迹的评价函数后，调用 <code>NormalizeEval()</code> 函数对各评价函数正则化</p> 
<pre><code class="prism language-matlab"><span class="token comment">%% 归一化处理 </span>
<span class="token comment">% 每一条轨迹的单项得分除以本项所有分数和</span>
<span class="token keyword">function</span> EvalDB<span class="token operator">=</span><span class="token function">NormalizeEval</span><span class="token punctuation">(</span>EvalDB<span class="token punctuation">)</span>
<span class="token comment">% 评价函数正则化</span>
<span class="token keyword">if</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">~=</span> <span class="token number">0</span>
    <span class="token comment">% disp(EvalDB(:,3));</span>
    <span class="token comment">% disp(sum(EvalDB(:,3)));</span>
    <span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">%矩阵的数除  单列矩阵的每元素分别除以本列所有数据的和    </span>
<span class="token keyword">end</span>
<span class="token keyword">if</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">~=</span> <span class="token number">0</span>
    <span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>
<span class="token keyword">if</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">~=</span> <span class="token number">0</span>
    <span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">EvalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>
</code></pre> 
<p>然后就选取评分最高的路径，并返回该路径对应的控制量</p> 
<pre><code class="prism language-matlab"><span class="token comment">% 最终评价函数的计算</span>
feval<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token operator">:</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token function">evalDB</span><span class="token punctuation">(</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    feval <span class="token operator">=</span> <span class="token punctuation">[</span>feval<span class="token punctuation">;</span><span class="token function">evalParam</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token function">evalDB</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">%根据评价函数参数 前三个参数分配的权重 计算每一组可用的路径参数信息的得分</span>
<span class="token keyword">end</span>
evalDB <span class="token operator">=</span> <span class="token punctuation">[</span>evalDB feval<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">% 最后一组；加最后一列，每一组速度的最终得分</span>
 
<span class="token punctuation">[</span>maxv<span class="token punctuation">,</span>ind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>feval<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">% 选取评分最高的参数 对应分数返回给 maxv  对应下标返回给 ind</span>
u <span class="token operator">=</span> <span class="token function">evalDB</span><span class="token punctuation">(</span>ind<span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">'</span><span class="token punctuation">;</span><span class="token comment">% 返回最优参数的速度、角速度</span>
</code></pre> 
<p>获得最优控制量后，在主循环中更新机器人为下一时刻状态，并将历史轨迹保存，同时根据当前点与目标点间的<code>欧氏距离</code>判断是否到达目标点</p> 
<pre><code class="prism language-matlab">		x <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">% 机器人移动到下一个时刻的状态量 根据当前速度和角速度推导 下一刻的位置和角度</span>
    abc <span class="token operator">=</span> abc<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">% 历史轨迹的保存</span>
    result<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">[</span>result<span class="token punctuation">.</span>x<span class="token punctuation">;</span> x<span class="token operator">'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">%最新结果 以行的形式 添加到result.x，保存的是所有状态参数值，包括坐标xy、朝向、线速度、角速度，其实应该是只取坐标就OK</span>
    
    <span class="token comment">% 是否到达目的地</span>
    <span class="token keyword">if</span> <span class="token function">norm</span><span class="token punctuation">(</span><span class="token function">x</span><span class="token punctuation">(</span>POSE_X<span class="token operator">:</span>POSE_Y<span class="token punctuation">)</span><span class="token operator">-</span>goal<span class="token operator">'</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0.25</span>   <span class="token comment">% norm函数来求得坐标上的两个点之间的距离</span>
        <span class="token function">disp</span><span class="token punctuation">(</span><span class="token string">'==========Arrive Goal!!=========='</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
</code></pre> 
<h3><a id="_452"></a>仿真效果</h3> 
<pre><code class="prism language-matlab"><span class="token comment">% 评价函数参数 [heading,dist,velocity,predictDT]</span>
<span class="token comment">% 航向得分的比重、距离得分的比重、速度得分的比重、向前模拟轨迹的时间</span>
evalParam <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.06</span><span class="token punctuation">,</span> <span class="token number">0.1</span> <span class="token punctuation">,</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/05/04/zJLJZa5G_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-matlab"><span class="token operator">&gt;</span><span class="token operator">&gt;</span> dwa_V_1_0
Dynamic Window Approach sample program start<span class="token punctuation">!</span><span class="token punctuation">!</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Arrive Goal<span class="token punctuation">!</span><span class="token punctuation">!</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
历时 <span class="token number">46.357604</span> 秒。
   <span class="token number">323</span>
</code></pre> 
<p>将航向得分比重改为 <code>0.04</code>，结果如下</p> 
<p><img src="https://images2.imgbox.com/bb/b4/FWu6UEiK_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-matlab"><span class="token operator">&gt;</span><span class="token operator">&gt;</span> dwa_V_1_0
Dynamic Window Approach sample program start<span class="token punctuation">!</span><span class="token punctuation">!</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Arrive Goal<span class="token punctuation">!</span><span class="token punctuation">!</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
历时 <span class="token number">44.884120</span> 秒。
   <span class="token number">312</span>
</code></pre> 
<p>将航向得分比重改为 <code>0.08</code>，结果如下</p> 
<p><img src="https://images2.imgbox.com/27/1a/2cgm7fak_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-matlab"><span class="token operator">&gt;</span><span class="token operator">&gt;</span> dwa_V_1_0
Dynamic Window Approach sample program start<span class="token punctuation">!</span><span class="token punctuation">!</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>Arrive Goal<span class="token punctuation">!</span><span class="token punctuation">!</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
历时 <span class="token number">52.595727</span> 秒。
   <span class="token number">336</span>
</code></pre> 
<p>可以看到当航向得分比重较小时规划的路径更安全，但相对长度也更长；当航向得分比重较大时规划的路径更短，但靠近障碍物时会“犹豫”，有一定撞到障碍物的风险</p> 
<h2><a id="_499"></a>参考</h2> 
<blockquote> 
 <p><strong><strong><a href="https://www.bilibili.com/video/BV1L5411g7Vn/?spm_id_from=333.337.search-card.all.click&amp;vd_source=81a57dc86413991675e0b9e638011eb5" rel="nofollow">ROS 2D导航原理系列（六）|局部路径规划-DWA算法</a></strong></strong></p> 
</blockquote> 
<blockquote> 
 <p><strong><strong><a href="https://www.youtube.com/watch?v=cW_9KRL_rA0" rel="nofollow">DWA Planner | Husky Robot | Motion Planning for Robots</a></strong></strong></p> 
</blockquote> 
<blockquote> 
 <p><strong><strong><a href="https://zhuanlan.zhihu.com/p/519958218" rel="nofollow">DWA算法总结</a></strong></strong></p> 
</blockquote> 
<blockquote> 
 <p><strong><strong><a href="https://zhuanlan.zhihu.com/p/481962661" rel="nofollow">DWA动态窗口法的原理及应用:The Dynamic Window Approach to Collision Avoidance</a></strong></strong></p> 
</blockquote> 
<blockquote> 
 <p><strong><strong><a href="https://zhuanlan.zhihu.com/p/70233164" rel="nofollow">The Dynamic Window Approach to Collision Avoidance</a></strong></strong></p> 
</blockquote> 
<blockquote> 
 <p><strong>《The_dynamic_window_approach_to_collision_avoidance》</strong></p> 
</blockquote> 
<blockquote> 
 <p><strong>《基于动态窗口法和改进A*算法的多车路径规划》</strong></p> 
</blockquote> 
<blockquote> 
 <p><strong>《面向车场日巡检机器人的路径规划研究_李清天》</strong></p> 
</blockquote> 
<blockquote> 
 <p><strong>《移动机器人的SLAM与自主路径规划研究》</strong></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4453a597a03af0706922087fc5c16725/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">docker更换国内源加速</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f5b67938bc07ff39263cd25d5ecb76f4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Stable diffusion模型大合集（18个）免费下载</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>