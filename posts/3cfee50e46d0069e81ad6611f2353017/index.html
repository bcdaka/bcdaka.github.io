<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>React常见的一些坑 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3cfee50e46d0069e81ad6611f2353017/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="React常见的一些坑">
  <meta property="og:description" content="文章目录 两个基础知识1. react的更新问题, react更新会重新执行react函数组件方法本身,并且子组件也会一起更新2. useCallback和useMemo滥用useCallback和useMemo要解决什么3. react的state有个经典的闭包,导致拿不到最新数据的问题.常见于useEffect, useMemo, useCallback4. 副作用方案总结 两个基础知识 1. react的更新问题, react更新会重新执行react函数组件方法本身,并且子组件也会一起更新 2. useCallback和useMemo滥用 useCallback和useMemo要解决什么 React.memo包装组件
React.useCallback包裹传递子组件函数
对于传递给组件的对象是固定不变的,和数据没有关系的.
需要将固定变量放在函数外层
React.useMemo: 当你给子组件的对象是和组件数据有关的, 也就是做一个计算属性时候
, 采用useMemo
3. react的state有个经典的闭包,导致拿不到最新数据的问题. 常见于useEffect, useMemo, useCallback 4. 副作用方案 App.jsx
import React, { useState, useRef, useEffect } from &#39;react&#39; import Filter from &#39;./components/Filter&#39;; import Pagers from &#39;./components/Pagers&#39;; import &#39;./App.css&#39; // * 如果这个对象是固定不变的,和state数据无关系, 需要提到组件外侧 const obj = { a:&#39;cccc&#39; } // useRef, 副作用方案 // 如果有一个state数据， 需要传递给子组件时候 // 建议把state数据定义为ref function App() { const [count, setCount] = useState(0) const [filterData, setFilterData] = useState(&#39;&#39;) const [pageData, sePageData] = useState(&#39;&#39;) // useRef： // 当有一个变量， 当这个变量不想被外部获取， 不需要写依赖 // 并且还想获取state最新值， 此时，需要将state变为ref // useRef定义的变量【不会造成视图更新】 // const filterData = useRef(&#39;&#39;) // const setFilterData = React.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-02T16:25:51+08:00">
    <meta property="article:modified_time" content="2024-06-02T16:25:51+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">React常见的一些坑</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">两个基础知识</a></li><li><ul><li><a href="#1_react_reactreact_4" rel="nofollow">1. react的更新问题, react更新会重新执行react函数组件方法本身,并且子组件也会一起更新</a></li><li><a href="#2_useCallbackuseMemo_9" rel="nofollow">2. useCallback和useMemo滥用</a></li><li><a href="#useCallbackuseMemo_11" rel="nofollow">useCallback和useMemo要解决什么</a></li><li><a href="#3_reactstate_22" rel="nofollow">3. react的state有个经典的闭包,导致拿不到最新数据的问题.</a></li><li><a href="#useEffect_useMemo_useCallback_24" rel="nofollow">常见于useEffect, useMemo, useCallback</a></li><li><a href="#4__30" rel="nofollow">4. 副作用方案</a></li><li><a href="#_178" rel="nofollow">总结</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>两个基础知识</h2> 
<h3><a id="1_react_reactreact_4"></a>1. react的更新问题, react更新会重新执行react函数组件方法本身,并且子组件也会一起更新</h3> 
<p><img src="https://images2.imgbox.com/07/cc/M4Q1uvcN_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_useCallbackuseMemo_9"></a>2. useCallback和useMemo滥用</h3> 
<h3><a id="useCallbackuseMemo_11"></a>useCallback和useMemo要解决什么</h3> 
<p>React.memo包装组件<br> React.useCallback包裹传递子组件函数</p> 
<p>对于传递给组件的对象是固定不变的,和数据没有关系的.<br> 需要将固定变量放在函数外层</p> 
<p>React.useMemo: 当你给子组件的对象是和组件数据有关的, 也就是做一个计算属性时候<br> , 采用useMemo</p> 
<h3><a id="3_reactstate_22"></a>3. react的state有个经典的闭包,导致拿不到最新数据的问题.</h3> 
<h3><a id="useEffect_useMemo_useCallback_24"></a>常见于useEffect, useMemo, useCallback</h3> 
<p><img src="https://images2.imgbox.com/92/92/HFgm81hZ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/3f/7d/U6iMzP5h_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4__30"></a>4. 副作用方案</h3> 
<p><img src="https://images2.imgbox.com/68/8d/jfWbpc2e_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/14/64/NNKyFMVN_o.png" alt="在这里插入图片描述"></p> 
<p><code>App.jsx</code></p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> useState<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> Filter <span class="token keyword">from</span> <span class="token string">'./components/Filter'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Pagers <span class="token keyword">from</span> <span class="token string">'./components/Pagers'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'./App.css'</span>

<span class="token comment">// * 如果这个对象是固定不变的,和state数据无关系, 需要提到组件外侧</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">a</span><span class="token operator">:</span><span class="token string">'cccc'</span>
<span class="token punctuation">}</span>

<span class="token comment">// useRef, 副作用方案</span>
<span class="token comment">// 如果有一个state数据， 需要传递给子组件时候</span>
<span class="token comment">// 建议把state数据定义为ref</span>
<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>filterData<span class="token punctuation">,</span> setFilterData<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>pageData<span class="token punctuation">,</span> sePageData<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

  <span class="token comment">// useRef： </span>
  <span class="token comment">// 当有一个变量， 当这个变量不想被外部获取， 不需要写依赖</span>
  <span class="token comment">// 并且还想获取state最新值， 此时，需要将state变为ref</span>
  <span class="token comment">// useRef定义的变量【不会造成视图更新】</span>
  <span class="token comment">// const filterData = useRef('')</span>
  <span class="token comment">// const setFilterData = React.useCallback((val)=&gt;{<!-- --></span>
  <span class="token comment">//   filterData.current = val</span>
  <span class="token comment">// }, [])</span>

  <span class="token comment">// 准备一个请求接口的方法给筛选栏</span>
  <span class="token comment">// 再次更新,就会重新执行, 等于又在内存中新建了一个getList方法</span>
  <span class="token comment">// 第一次渲染-&gt;getList 创建 1001 第二次-&gt;1002</span>
  <span class="token comment">//1.  * useCallback并不是有方法一定要包裹, 只有当这个方法给子组件的时候才有</span>

  <span class="token comment">// const getList = React.useCallback((page)=&gt;{<!-- --></span>
  <span class="token comment">//   console.log('=item=====');</span>
  <span class="token comment">//   // console.log(item);</span>
  <span class="token comment">//   // *2.  useCallback, useEffect, useMemo方法. 如果用到state数据</span>
  <span class="token comment">//   // * 一定要把state数据写在第二个数组中, 否则拿不到新数据</span>

  <span class="token comment">//   // 改为useRef方式，  搜索栏更新，不会造成page更新</span>
  <span class="token comment">//   console.log(count, filterData, page);</span>
  <span class="token comment">// }, [count, filterData])</span>


  <span class="token comment">// 方法3: 使用useEffect监听子组件变化, 不将getList方法传递子组件</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> filterData<span class="token punctuation">,</span> pageData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> filterData<span class="token punctuation">,</span> pageData<span class="token punctuation">]</span><span class="token punctuation">)</span>
  

  <span class="token comment">// * 3. React.useMemo: 当你给子组件的对象是和组件数据有关的, 也就是做一个计算属性时候</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
 
      <span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Vite <span class="token operator">+</span> React<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"card"</span><span class="token operator">&gt;</span>
        <span class="token literal-property property">父组件本身</span><span class="token operator">:</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
          count is <span class="token punctuation">{<!-- --></span>count<span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token literal-property property">筛选栏</span><span class="token operator">:</span>
        <span class="token operator">&lt;</span>Filter
        <span class="token comment">//  config={obj}</span>
         filterData<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>filterData<span class="token punctuation">}</span>
         setFilterData<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>setFilterData<span class="token punctuation">}</span>
        <span class="token comment">//  getList={getList}</span>
         <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"read-the-docs"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Pagers 
          sePageData<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>sePageData<span class="token punctuation">}</span>
          <span class="token comment">//  getList={getList}</span>
        <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App

</code></pre> 
<p><code>Pagers.jsx</code></p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Pagers</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pager render"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> sePageData <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>div className<span class="token operator">=</span><span class="token string">"Pager"</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{<!-- --></span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
          <span class="token operator">&lt;</span>div
            key<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span>
            onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              <span class="token function">sePageData</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token operator">&gt;</span>
            <span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">.</span><span class="token function">memo</span><span class="token punctuation">(</span>Pagers<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p><code>Filter.jsx</code></p> 
<pre><code class="prism language-js"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>


<span class="token keyword">function</span> <span class="token function">Filter</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Filter render---'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> setFilterData <span class="token punctuation">}</span> <span class="token operator">=</span> props
  <span class="token keyword">const</span> value <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">useRef</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>input onChange<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
      <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{<!-- --></span>
        value<span class="token punctuation">.</span>current <span class="token operator">=</span> e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
      <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>input<span class="token operator">&gt;</span>
     <span class="token operator">&lt;</span>button  onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setFilterData</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>搜索<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">.</span><span class="token function">memo</span><span class="token punctuation">(</span>Filter<span class="token punctuation">)</span>

</code></pre> 
<h3><a id="_178"></a>总结</h3> 
<p>小结一下：<br> React 函数式组件会在state/props/context/父组件重新渲染时，重新执行函数，<br> 为避免不必要的性能消耗（函数重新定义，某些值重新计算等等），减少重新渲染（或者重新执行函数式组件），需要控制props + 配合react.memo<br> 控制props :</p> 
<ol><li>用useCallback暂存函数（注意用到state时要用好第二个参数）、useMemo避免复杂运算重复执行</li><li>用Ref（非受控组件）获取不需要渲染，但又是最新的值</li><li>不变的值写在函数式组外，避免重复创建</li><li>jsx里尽量不写字面量、匿名函数</li></ol> 
<p>// useRef：<br> // 当有一个变量， 当这个变量不想被外部获取， 不需要写依赖<br> // 并且还想获取state最新值， 此时，需要将state变为ref<br> // ** useRef定义的变量【不会造成视图更新】**<br> // const filterData = useRef(‘’)<br> // const setFilterData = React.useCallback((val)=&gt;{<!-- --><br> // filterData.current = val<br> // }, [])</p> 
<p>// <strong>注意:useRef定义的变量【不会造成视图更新】,而state变量会视图更新, 也会被添加到依赖项, 会影响子组件更新</strong></p> 
<ol start="5"><li> <p>使用方案3, 使用useEffect监听子组件变化, 不将getList方法传递子组件<br> ,只用将修改父组件数据的方法传递到子组件. 在父组件通过副作用更新</p> </li><li> <p>技巧4, 当数据只在子组件中使用时候, 而不会在页面展示时,<br> 需定义为useRef变量,(在页面展示时定义为state变量).</p> </li></ol> 
<p><strong>定义在组件内部, 在点击确定时候, 将数据更新到父组件, 修改时用.current修改</strong></p> 
<p><img src="https://images2.imgbox.com/d5/fe/SyUrq0oj_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ba9add33ebe8dbc810c185f69838fe7c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">搭建大型分布式服务（三十九）SpringBoot 整合多个kafka数据源-支持Aware模式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6b5e3c3edf847d8e18524f14749c9841/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring Boot配置MySQL数据库连接数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>