<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>爬取链家二手房房价数据存入mongodb并进行分析 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/a89b1653b9519188f48eb7bf792bdb16/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="爬取链家二手房房价数据存入mongodb并进行分析">
  <meta property="og:description" content="实验目的 1.使用python将爬虫数据存入mongodb；
2.使用python读取mongodb数据并进行可视化分析。
实验原理 MongoDB是文档数据库，采用BSON的结构来存储数据。在文档中可嵌套其他文档类型，使得MongoDB具有很强的数据描述能力。本节案例使用的数据为链家的租房信息，源数据来自于链家网站，所以首先要获取网页数据并解析出本案例所需要的房源信息，然后将解析后的数据存储到MongoDB中，最后基于这些数据进行城市租房信息的查询和聚合分析等。
实验环境 OS：Windows 10
Python3
MongoDB：v4.4
实验步骤 一、使用python将爬虫数据存入mongodb 1.爬取数据 分析租房信息首先要获取原始的二手房房源数据，本例使用python爬虫技术获取链家网页的二手房楼盘信息。如图所示，对房源信息进行分析需要获取房源所在区域、小区名、房型、面积、具体位置、价格等信息。
定义了三个函数依次实现此过程：
import requests import re import threading import pandas as pd from lxml import etree # 全部信息列表 count=list() #生成1-10页url def url_creat(): #基础url url = &#39;https://gl.lianjia.com/ershoufang/pg{}/&#39; #生成前10页url列表 links=[url.format(i) for i in range(1,11)] return links #对url进行解析 def url_parse(url): headers = { &#39;Accept&#39;: &#39;text/html,application/xhtml&#43;xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&#39;, &#39;Accept-Encoding&#39;: &#39;gzip, deflate, br&#39;, &#39;Accept-Language&#39;: &#39;zh-CN,zh;q=0.9&#39;, &#39;Cache-Control&#39;: &#39;no-cache&#39;, &#39;Connection&#39;: &#39;keep-alive&#39;, &#39;Cookie&#39;: &#39;lianjia_uuid=7e346c7c-5eb3-45d9-8b4f-e7cf10e807ba; UM_distinctid=17a3c5c21243a-0c5b8471aaebf5-6373267-144000-17a3c5c21252dc; _smt_uid=60d40f65.47c601a8; _ga=GA1.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-23T14:04:24+08:00">
    <meta property="article:modified_time" content="2024-06-23T14:04:24+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">爬取链家二手房房价数据存入mongodb并进行分析</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>实验目的</h2> 
<p>1.使用python将爬虫数据存入mongodb；<br> 2.使用python读取mongodb数据并进行可视化分析。</p> 
<h2><a id="_3"></a>实验原理</h2> 
<p>MongoDB是文档数据库，采用BSON的结构来存储数据。在文档中可嵌套其他文档类型，使得MongoDB具有很强的数据描述能力。本节案例使用的数据为链家的租房信息，源数据来自于链家网站，所以首先要获取网页数据并解析出本案例所需要的房源信息，然后将解析后的数据存储到MongoDB中，最后基于这些数据进行城市租房信息的查询和聚合分析等。</p> 
<h2><a id="_5"></a>实验环境</h2> 
<p>OS：Windows 10<br> Python3<br> MongoDB：v4.4</p> 
<h2><a id="_10"></a>实验步骤</h2> 
<h3><a id="pythonmongodb_11"></a>一、使用python将爬虫数据存入mongodb</h3> 
<h4><a id="1_12"></a>1.爬取数据</h4> 
<p>分析租房信息首先要获取原始的二手房房源数据，本例使用python爬虫技术获取链家网页的二手房楼盘信息。如图所示，对房源信息进行分析需要获取房源所在区域、小区名、房型、面积、具体位置、价格等信息。<br> <img src="https://images2.imgbox.com/6a/18/Ovt4C3gK_o.png" alt="在这里插入图片描述"></p> 
<p>定义了三个函数依次实现此过程：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> re
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> lxml <span class="token keyword">import</span> etree
<span class="token comment"># 全部信息列表</span>
count<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#生成1-10页url</span>
<span class="token keyword">def</span> <span class="token function">url_creat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#基础url</span>
    url <span class="token operator">=</span> <span class="token string">'https://gl.lianjia.com/ershoufang/pg{}/'</span>
    <span class="token comment">#生成前10页url列表</span>
    links<span class="token operator">=</span><span class="token punctuation">[</span>url<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> links

<span class="token comment">#对url进行解析</span>
<span class="token keyword">def</span> <span class="token function">url_parse</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9'</span><span class="token punctuation">,</span>
        <span class="token string">'Accept-Encoding'</span><span class="token punctuation">:</span> <span class="token string">'gzip, deflate, br'</span><span class="token punctuation">,</span>
        <span class="token string">'Accept-Language'</span><span class="token punctuation">:</span> <span class="token string">'zh-CN,zh;q=0.9'</span><span class="token punctuation">,</span>
        <span class="token string">'Cache-Control'</span><span class="token punctuation">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span>
        <span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'keep-alive'</span><span class="token punctuation">,</span>
        <span class="token string">'Cookie'</span><span class="token punctuation">:</span> <span class="token string">'lianjia_uuid=7e346c7c-5eb3-45d9-8b4f-e7cf10e807ba; UM_distinctid=17a3c5c21243a-0c5b8471aaebf5-6373267-144000-17a3c5c21252dc; _smt_uid=60d40f65.47c601a8; _ga=GA1.2.992911268.1624510312; select_city=370200; lianjia_ssid=f47906f0-df1a-49e2-ad9b-648711b11434; CNZZDATA1253492431=1056289575-1626962724-https%253A%252F%252Fwww.baidu.com%252F%7C1626962724; CNZZDATA1254525948=1591837398-1626960171-https%253A%252F%252Fwww.baidu.com%252F%7C1626960171; CNZZDATA1255633284=1473915272-1626960625-https%253A%252F%252Fwww.baidu.com%252F%7C1626960625; CNZZDATA1255604082=1617573044-1626960658-https%253A%252F%252Fwww.baidu.com%252F%7C1626960658; _jzqa=1.4194666890570963500.1624510309.1624510309.1626962867.2; _jzqc=1; _jzqy=1.1624510309.1626962867.2.jzqsr=baidu|jzqct=%E9%93%BE%E5%AE%B6.jzqsr=baidu; _jzqckmp=1; _qzjc=1; sensorsdata2015jssdkcross=%7B%22distinct_id%22%3A%2217a3c5c23964c1-05089a8de73cbf-6373267-1327104-17a3c5c23978b3%22%2C%22%24device_id%22%3A%2217a3c5c23964c1-05089a8de73cbf-6373267-1327104-17a3c5c23978b3%22%2C%22props%22%3A%7B%22%24latest_traffic_source_type%22%3A%22%E8%87%AA%E7%84%B6%E6%90%9C%E7%B4%A2%E6%B5%81%E9%87%8F%22%2C%22%24latest_referrer%22%3A%22https%3A%2F%2Fwww.baidu.com%2Flink%22%2C%22%24latest_referrer_host%22%3A%22www.baidu.com%22%2C%22%24latest_search_keyword%22%3A%22%E6%9C%AA%E5%8F%96%E5%88%B0%E5%80%BC%22%2C%22%24latest_utm_source%22%3A%22baidu%22%2C%22%24latest_utm_medium%22%3A%22pinzhuan%22%2C%22%24latest_utm_campaign%22%3A%22wyyantai%22%2C%22%24latest_utm_content%22%3A%22biaotimiaoshu%22%2C%22%24latest_utm_term%22%3A%22biaoti%22%7D%7D; Hm_lvt_9152f8221cb6243a53c83b956842be8a=1624510327,1626962872; _gid=GA1.2.134344742.1626962875; Hm_lpvt_9152f8221cb6243a53c83b956842be8a=1626962889; _qzja=1.1642609541.1626962866646.1626962866646.1626962866647.1626962872770.1626962889355.0.0.0.3.1; _qzjb=1.1626962866646.3.0.0.0; _qzjto=3.1.0; _jzqb=1.3.10.1626962867.1; srcid=eyJ0Ijoie1wiZGF0YVwiOlwiNzQ3M2M3OWQyZTQwNGM5OGM1MDBjMmMxODk5NTBhOWRhNmEyNjhkM2I5ZjNlOTkxZTdiMDJjMTg0ZGUxNzI0NDQ5YmZmZGI1ZjZmMDRkYmE0MzVmNmNlNDIwY2RiM2YxZTUzZWViYmQwYmYzMDQ1NDcyMzYwZTQzOTg3MzJhYTRjMTg0YjNhYjBkMGMyZGVmOWZiYjdlZWQwMDcwNWFkZmI5NzA5MjM1NmQ1NDg0MzQ3NGIzYjkwY2IyYmEwMjA2NjBjMjI2OWRjNjFiNDE3ZDc1NGViNjhlMzIzZmI0MjFkNzU5ZGNlMzAzMDhlNDAzYzIzNjllYWFlMzYxZGYxYjNmZmVkNGMxYTk1MmQ3MGY2MmJhMTQ1NWI4ODIwNTE5ODI2Njg2MmVkZTk4OWZiMDhjNTJhNzE3OTBlNDFiZDQzZTlmNDNmOGRlMTFjYTAwYTRlZTZiZWY5MTZkMTcwN1wiLFwia2V5X2lkXCI6XCIxXCIsXCJzaWduXCI6XCI3ZjI1NWI1ZlwifSIsInIiOiJodHRwczovL3FkLmxpYW5qaWEuY29tL2Vyc2hvdWZhbmcvMTAzMTE2MDkzOTU5Lmh0bWwiLCJvcyI6IndlYiIsInYiOiIwLjEifQ=='</span><span class="token punctuation">,</span>
        <span class="token string">'Host'</span><span class="token punctuation">:</span> <span class="token string">'qd.lianjia.com'</span><span class="token punctuation">,</span>
        <span class="token string">'Pragma'</span><span class="token punctuation">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span>
        <span class="token string">'Referer'</span><span class="token punctuation">:</span> <span class="token string">'https://qd.lianjia.com/'</span><span class="token punctuation">,</span>
        <span class="token string">'sec-ch-ua'</span><span class="token punctuation">:</span> <span class="token string">'" Not;A Brand";v="99", "Google Chrome";v="91", "Chromium";v="91"'</span><span class="token punctuation">,</span>
        <span class="token string">'sec-ch-ua-mobile'</span><span class="token punctuation">:</span> <span class="token string">'?0'</span><span class="token punctuation">,</span>
        <span class="token string">'Sec-Fetch-Dest'</span><span class="token punctuation">:</span> <span class="token string">'document'</span><span class="token punctuation">,</span>
        <span class="token string">'Sec-Fetch-Mode'</span><span class="token punctuation">:</span> <span class="token string">'navigate'</span><span class="token punctuation">,</span>
        <span class="token string">'Sec-Fetch-Site'</span><span class="token punctuation">:</span> <span class="token string">'same-origin'</span><span class="token punctuation">,</span>
        <span class="token string">'Sec-Fetch-User'</span><span class="token punctuation">:</span> <span class="token string">'?1'</span><span class="token punctuation">,</span>
        <span class="token string">'Upgrade-Insecure-Requests'</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.164 Safari/537.36'</span><span class="token punctuation">}</span>
    response<span class="token operator">=</span>requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">=</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">)</span><span class="token punctuation">.</span>text
    tree<span class="token operator">=</span>etree<span class="token punctuation">.</span>HTML<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token comment">#ul列表下的全部li标签</span>
    li_List<span class="token operator">=</span>tree<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">"//*[@class='sellListContent']/li"</span><span class="token punctuation">)</span>
    <span class="token comment">#创建线程锁对象</span>
    lock <span class="token operator">=</span> threading<span class="token punctuation">.</span>RLock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#上锁</span>
    lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> li <span class="token keyword">in</span> li_List<span class="token punctuation">:</span>
        <span class="token comment">#标题</span>
        title<span class="token operator">=</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div/a/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">#网址</span>
        link<span class="token operator">=</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div/a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">#位置</span>
        postion<span class="token operator">=</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div[2]/div/a/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div[2]/div/a[2]/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">#类型</span>
        types<span class="token operator">=</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div[3]/div/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' | '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">#面积</span>
        area<span class="token operator">=</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div[3]/div/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' | '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        area<span class="token operator">=</span>area<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token comment">#房屋信息</span>
        info<span class="token operator">=</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div[3]/div/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' | '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        info<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>info<span class="token punctuation">)</span>
        <span class="token comment">#房屋年份</span>
        year<span class="token operator">=</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div[3]/div/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' | '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
        numbers <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">"\D"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span>year<span class="token punctuation">)</span> <span class="token comment"># 匹配连续的数字</span>
        year<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>
        <span class="token comment">#房屋装修情况</span>
        renovation<span class="token operator">=</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'./div/div[3]/div/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' | '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token comment">#总价</span>
        count_price<span class="token operator">=</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//div/div[6]/div/span/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">#单价</span>
        angle_price<span class="token operator">=</span>li<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'.//div/div[6]/div[2]/span/text()'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        angle_price<span class="token operator">=</span>re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">"\D"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span>angle_price<span class="token punctuation">)</span><span class="token comment">#只保留数字</span>
        dic<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'标题'</span><span class="token punctuation">:</span>title<span class="token punctuation">,</span><span class="token string">"位置"</span><span class="token punctuation">:</span>postion<span class="token punctuation">,</span><span class="token string">'房屋类型'</span><span class="token punctuation">:</span>types<span class="token punctuation">,</span><span class="token string">'面积（平米）'</span><span class="token punctuation">:</span>area<span class="token punctuation">,</span><span class="token string">"单价（元/平）"</span><span class="token punctuation">:</span>angle_price<span class="token punctuation">,</span><span class="token string">'总价（万）'</span><span class="token punctuation">:</span>count_price<span class="token punctuation">,</span><span class="token string">'年份'</span><span class="token punctuation">:</span>year<span class="token punctuation">,</span><span class="token string">'精/简装'</span><span class="token punctuation">:</span>renovation<span class="token punctuation">,</span><span class="token string">'介绍'</span><span class="token punctuation">:</span>info<span class="token punctuation">,</span><span class="token string">"网址"</span><span class="token punctuation">:</span>link<span class="token punctuation">}</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>dic<span class="token punctuation">)</span>
        <span class="token comment">#将房屋信息加入总列表中</span>
        count<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dic<span class="token punctuation">)</span>
    <span class="token comment">#解锁</span>
    lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    links <span class="token operator">=</span> url_creat<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#多线程爬取</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> links<span class="token punctuation">:</span>
        x<span class="token operator">=</span>threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>url_parse<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        x<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    x<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">#将全部房屋信息转化为excel</span>
    data<span class="token operator">=</span>pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>count<span class="token punctuation">)</span>
    data<span class="token punctuation">.</span>to_excel<span class="token punctuation">(</span><span class="token string">'桂林房屋信息.xlsx'</span><span class="token punctuation">,</span>index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    run<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>爬虫细节参考：<a href="https://blog.csdn.net/gushuiwuqiu/article/details/119041160">【Python爬虫项目】链家房屋信息抓取（超详细适合新手练习附源码）</a></p> 
<h4><a id="2_111"></a>2.数据清洗</h4> 
<p>爬出下来的数据存在空缺的情况，并需要去除部分信息【不清洗也可以】<br> 使用python进行数据清洗。首先读取数据</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">"桂林房屋信息.xlsx"</span><span class="token punctuation">)</span>
data<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment">#data.info()</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/5a/5c/qfxh1lRg_o.png" alt="在这里插入图片描述"></p> 
<p>去掉标题、介绍和网址列，去掉年份为空的行</p> 
<pre><code class="prism language-python">data_db<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"位置"</span><span class="token punctuation">,</span><span class="token string">"房屋类型"</span><span class="token punctuation">,</span><span class="token string">"面积（平米）"</span><span class="token punctuation">,</span><span class="token string">"单价（元/平）"</span><span class="token punctuation">,</span><span class="token string">"总价（万）"</span><span class="token punctuation">,</span><span class="token string">"年份"</span><span class="token punctuation">,</span><span class="token string">"精/简装"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dropna<span class="token punctuation">(</span><span class="token punctuation">)</span>
data_db<span class="token punctuation">[</span><span class="token string">"年份"</span><span class="token punctuation">]</span><span class="token operator">=</span>data_db<span class="token punctuation">[</span><span class="token string">"年份"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int'</span><span class="token punctuation">)</span><span class="token comment">#年份变成整型</span>
data_db <span class="token operator">=</span> data_db<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>by<span class="token operator">=</span><span class="token string">"年份"</span><span class="token punctuation">,</span> ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token comment">#按年份进行排序</span>
data_db
</code></pre> 
<p><img src="https://images2.imgbox.com/53/ef/vJ9DKLok_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3_133"></a>3.数据存储</h4> 
<p>将清洗好的数据存储到mongodb中：<strong>将数据转换成字典列表形式，通过insert_many方法写入</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">from</span> pymongo <span class="token keyword">import</span> MongoClient
 
<span class="token comment"># 创建MongoDB客户端</span>
client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">27017</span><span class="token punctuation">)</span> <span class="token comment"># 根据自己的配置修改主机名和端口号</span>
db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'lianjia'</span><span class="token punctuation">]</span> <span class="token comment"># 选择或创建数据库</span>
collection <span class="token operator">=</span> db<span class="token punctuation">[</span><span class="token string">'ershoufang'</span><span class="token punctuation">]</span> <span class="token comment"># 选择或创建集合</span>
 
<span class="token comment"># 读取DataFrame数据</span>
<span class="token comment"># 转换DataFrame为字典列表形式</span>
documents <span class="token operator">=</span> data_db<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span>orient<span class="token operator">=</span><span class="token string">'records'</span><span class="token punctuation">)</span>
 
<span class="token comment"># 向集合中插入文档</span>
collection<span class="token punctuation">.</span>insert_many<span class="token punctuation">(</span>documents<span class="token punctuation">)</span>
 
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Data stored in MongoDB successfully!"</span><span class="token punctuation">)</span>
</code></pre> 
<p>成功写入<br> <img src="https://images2.imgbox.com/1b/e8/HVViYa6W_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_python__mongodb__159"></a>二、使用 python 读取 mongodb 数据并进行可视化分析</h3> 
<p>房源数据进行存储后，需要进行数据分析，比如获取不同年份房价（单价）的最小值和最大值，并以条形图的形式展示出来。<br> 1．以统计不同年份的房价为例，使用 MongoDB 聚合管道技术对数据进行分组计算，如下代码片段对房源的不同年份进行分组聚合：</p> 
<pre><code class="prism language-python">db <span class="token operator">=</span> client<span class="token punctuation">[</span><span class="token string">'lianjia'</span><span class="token punctuation">]</span> <span class="token comment"># 选择数据库</span>
col<span class="token operator">=</span> db<span class="token punctuation">[</span><span class="token string">'ershoufang'</span><span class="token punctuation">]</span> <span class="token comment"># 选择集合</span>
<span class="token comment"># 使用 $group 操作对文档分组和聚合</span>
pipeline <span class="token operator">=</span> <span class="token punctuation">[</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token string">"$group"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
             <span class="token string">"_id"</span><span class="token punctuation">:</span> <span class="token string">"$年份"</span><span class="token punctuation">,</span>
             <span class="token string">"MinPrice"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"$min"</span><span class="token punctuation">:</span> <span class="token string">"$单价（元/平）"</span><span class="token punctuation">}</span> <span class="token punctuation">,</span>
             <span class="token string">"MaxPrice"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"$max"</span> <span class="token punctuation">:</span> <span class="token string">"$单价（元/平）"</span><span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">]</span> 
<span class="token comment"># 执行聚合操作</span>
price <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>col<span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 打印分组和聚合结果</span>
<span class="token keyword">for</span> doc <span class="token keyword">in</span> price<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/96/3c/vOTc0hYK_o.png" alt="在这里插入图片描述"></p> 
<p><strong>出现了问题：</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#这样提取的不了“_id”字段到列表year中</span>
year <span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> doc <span class="token keyword">in</span> price<span class="token punctuation">:</span>
    year<span class="token punctuation">.</span>append<span class="token punctuation">(</span>doc<span class="token punctuation">[</span><span class="token string">"_id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>也就是<strong>nongodb聚合出来的结果python不能直接提取到列表</strong>，这个问题我也不知道如何解决。。。<br> 大佬们若知道还请评论区告知一声。</p> 
<p>所以，比较笨拙的办法为，把聚合的结果先存储到新的集合中：</p> 
<pre><code class="prism language-mongodb"> db.ershoufang.aggregate( [ 
 	{$group:{
 		"_id":"$年份",
 		"MinPrice":{"$min":"$单价（元/平）"},
 		"MaxPrice":{"$max":"$单价（元/平）"}
 		}
 	},
 	{ $sort : { "_id" : 1 } },
 	{"$out":
 		{"db":"lianjia","coll":"tongji"}
 	}
 ])
</code></pre> 
<p>其中，{ $sort : { “_id” : 1 } }为按照_id字段排序，即为按照年份排序， <em>{“$out”:{“db”:“lianjia”,“coll”:“tongji”}}</em> 为把聚合结果作文新文档存放在数据库lianjia的集合tongji中。</p> 
<p><img src="https://images2.imgbox.com/a3/3f/9tBKNYLm_o.png" alt="在这里插入图片描述"></p> 
<p>这样就可以提取文档的字段到列表中了，进行下一步：绘图。</p> 
<p>2.基于聚合统计出的数据使用 python 绘制条形图，使用到 matplotlib 库，具体代<br> 码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> matplotlib
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> json

col2<span class="token operator">=</span> db<span class="token punctuation">[</span><span class="token string">'tongji'</span><span class="token punctuation">]</span> <span class="token comment"># 选择集合</span>
year <span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
Min_Price <span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
Max_Price <span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">#获取聚合后的数据并插入 year ，Min_Price，Max_Price，用于纵横坐标显示。</span>
<span class="token keyword">for</span> doc <span class="token keyword">in</span> col2<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    year<span class="token punctuation">.</span>append<span class="token punctuation">(</span>doc<span class="token punctuation">[</span><span class="token string">"_id"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    Min_Price<span class="token punctuation">.</span>append<span class="token punctuation">(</span>doc<span class="token punctuation">[</span><span class="token string">"MinPrice"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    Max_Price<span class="token punctuation">.</span>append<span class="token punctuation">(</span>doc<span class="token punctuation">[</span><span class="token string">"MaxPrice"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># 设置中文字体和负号正常显示</span>
matplotlib<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.sans-serif'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'SimHei'</span><span class="token punctuation">]</span>
<span class="token comment"># 创建一个新的画布并指定大小为10x6英寸</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
x<span class="token operator">=</span>year
<span class="token comment">#绘制条形图 :条形中点横坐标；height:长条形高度；width:长条形宽度，默认值0.8；label:为后面设置 legend 准备</span>
rects1<span class="token operator">=</span>plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span>x<span class="token punctuation">,</span>height<span class="token operator">=</span>Min_Price<span class="token punctuation">,</span>width<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span>alpha<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span>color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"最低房价"</span><span class="token punctuation">)</span>
rects2<span class="token operator">=</span>plt<span class="token punctuation">.</span>bar<span class="token punctuation">(</span><span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">0.4</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> x<span class="token punctuation">]</span><span class="token punctuation">,</span>height<span class="token operator">=</span>Max_Price<span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"最高房价"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylim<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">max</span><span class="token punctuation">(</span>Max_Price<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment"># y 轴取值范围</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">"upper left"</span><span class="token punctuation">,</span> prop<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"size"</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># 显示图例  设置图例的大小和方向</span>
<span class="token comment">#设置两个柱状图数据显示</span>
<span class="token keyword">for</span> rect <span class="token keyword">in</span> rects1<span class="token punctuation">:</span>
    height <span class="token operator">=</span> rect<span class="token punctuation">.</span>get_height<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>text<span class="token punctuation">(</span>rect<span class="token punctuation">.</span>get_x<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rect<span class="token punctuation">.</span>get_width<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> 
    <span class="token builtin">str</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span> ha<span class="token operator">=</span><span class="token string">"center"</span><span class="token punctuation">,</span> va<span class="token operator">=</span><span class="token string">"bottom"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> rect <span class="token keyword">in</span> rects2<span class="token punctuation">:</span>
    height <span class="token operator">=</span> rect<span class="token punctuation">.</span>get_height<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>text<span class="token punctuation">(</span>rect<span class="token punctuation">.</span>get_x<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rect<span class="token punctuation">.</span>get_width<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> height<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> 
    <span class="token builtin">str</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span> ha<span class="token operator">=</span><span class="token string">"center"</span><span class="token punctuation">,</span> va<span class="token operator">=</span><span class="token string">"bottom"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"单价"</span><span class="token punctuation">)</span>
<span class="token comment">#设置 x 轴刻度显示值；参数一：中点坐标；参数二：显示值</span>
plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">[</span>index <span class="token operator">+</span> <span class="token number">0.2</span> <span class="token keyword">for</span> index <span class="token keyword">in</span> x<span class="token punctuation">]</span><span class="token punctuation">,</span>year<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"年份"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"桂林二手房房价"</span><span class="token punctuation">)</span>

<span class="token comment">#显示条形图</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>结果如图所示<br> <img src="https://images2.imgbox.com/79/ec/glIMNlKM_o.png" alt="在这里插入图片描述"><br> 一些容易出现的问题：<br> 1.数据类型问题：爬虫阶段下载的数据可能是文本类型的或者带单位，数据分析需要改为浮点型或者整型，当然也可以在下载的时候处理好<br> 2.下载的数据若要以年份进行排序，需要提前处理，否则画图会出现问题。</p> 
<p>参考资料：《NoSQL数据库原理与应用》，主编：王爱国、许桂秋。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/46efdc35186a8e7bb10ac7b2ce00626e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MacOS安装nvm实现多Node版本管理和自由切换</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/91b03a7a8a953102572cc9fdc59823cd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C&#43;&#43;/STL】：list容器的深度剖析及模拟实现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>