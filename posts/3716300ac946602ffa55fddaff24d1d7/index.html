<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>NPOI 导出列太多或者数据太多爆内存 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3716300ac946602ffa55fddaff24d1d7/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="NPOI 导出列太多或者数据太多爆内存">
  <meta property="og:description" content="近期.net mvc 开发的项目运行一段时间的项目，突然用户反馈导出数据出现500错误。后面看到日志是内存爆了。我是使用NPOI 组件来进行导出，服务器也有8G内存，之前一直好好的。然后发现导出的execl数据才几万，列大概有2000多列,怎么这么容易爆。
可惜没有办法客户不想加配置，那就只能把数据网硬盘里面搞了。因为从数据库抓出来的数据需要多很多逻辑处理，所以没有办法直接从数据库直接导出到文件。
原本想过使用多个文件最后合并的方式，但是我比较懒不想搞，所以就查了一下 NPOI是支持硬盘存储临时数据的。
好了，下面是代码：
//---------------------------------------创建下载文档---------------------------------------
static IWorkbook workbook = null;
static string NewfileName;
//allen add 20240616使用SXSSFWorkbook方法，这个是放入硬盘的临时文件
public static string CreatModelToExcel1(int columns, DataTable data, string sheetName, bool isColumnWritten, string fileName)
{
fileName = System.AppDomain.CurrentDomain.BaseDirectory &#43; &#34;DownExcel/&#34; &#43; fileName;
NewfileName = System.AppDomain.CurrentDomain.BaseDirectory &#43; &#34;DownExcel/&#34; &#43; fileName;
if (data == null)
{
throw new ArgumentNullException(&#34;data&#34;);
}
if (string.IsNullOrEmpty(sheetName))
{
throw new ArgumentNullException(sheetName);
}
if (string.IsNullOrEmpty(fileName))
{
throw new ArgumentNullException(fileName);">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-24T00:24:26+08:00">
    <meta property="article:modified_time" content="2024-07-24T00:24:26+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">NPOI 导出列太多或者数据太多爆内存</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p> 近期.net mvc 开发的项目运行一段时间的项目，突然用户反馈导出数据出现500错误。后面看到日志是内存爆了。我是使用NPOI 组件来进行导出，服务器也有8G内存，之前一直好好的。然后发现导出的execl数据才几万，列大概有2000多列,怎么这么容易爆。</p> 
<p>可惜没有办法客户不想加配置，那就只能把数据网硬盘里面搞了。因为从数据库抓出来的数据需要多很多逻辑处理，所以没有办法直接从数据库直接导出到文件。</p> 
<p>原本想过使用多个文件最后合并的方式，但是我比较懒不想搞，所以就查了一下 NPOI是支持硬盘存储临时数据的。</p> 
<p>好了，下面是代码：</p> 
<p> //---------------------------------------创建下载文档---------------------------------------<br>         static IWorkbook workbook = null;<br>         static string NewfileName;<br>         //allen add 20240616使用SXSSFWorkbook方法，这个是放入硬盘的临时文件<br>         public static string CreatModelToExcel1(int columns, DataTable data, string sheetName, bool isColumnWritten, string fileName)<br>         {<!-- --><br>             fileName = System.AppDomain.CurrentDomain.BaseDirectory + "DownExcel/" + fileName;<br>             NewfileName = System.AppDomain.CurrentDomain.BaseDirectory + "DownExcel/" + fileName;<br>             if (data == null)<br>             {<!-- --><br>                 throw new ArgumentNullException("data");<br>             }<br>             if (string.IsNullOrEmpty(sheetName))<br>             {<!-- --><br>                 throw new ArgumentNullException(sheetName);<br>             }<br>             if (string.IsNullOrEmpty(fileName))<br>             {<!-- --><br>                 throw new ArgumentNullException(fileName);<br>             }<br>             //IWorkbook workbook = null;<br>             if (fileName.IndexOf(".xlsx", StringComparison.Ordinal) &gt; 0)<br>             {<!-- --><br>                 //workbook = new XSSFWorkbook();<br>                 workbook = new SXSSFWorkbook();//allen 0617<br>                 //workbook = new HSSFWorkbook();<br>             }<br>             else if (fileName.IndexOf(".xls", StringComparison.Ordinal) &gt; 0)<br>             {<!-- --><br>                 workbook = new HSSFWorkbook();</p> 
<p>            }</p> 
<p>            FileStream fs = null;<br>             try<br>             {<!-- --><br>                 using (fs = new FileStream(fileName, FileMode.OpenOrCreate, FileAccess.ReadWrite, FileShare.ReadWrite))<br>                 {<!-- --><br>                     SXSSFSheet sheet; //allen 0617<br>                     if (workbook != null)<br>                     {<!-- --><br>                         sheet =(SXSSFSheet)workbook.CreateSheet(sheetName);//allen 0617<br>                     }<br>                     else<br>                     {<!-- --><br>                         return "";//返回文件为空<br>                     }</p> 
<p>                    int j;<br>                     int count;<br>                     //写入DataTable的列名，写入单元格中<br>                     if (isColumnWritten)<br>                     {<!-- --><br>                         var row = sheet.CreateRow(0);<br>                         int ci = 0;<br>                         for (j = 1; j &lt; data.Columns.Count; ++j)<br>                         {<!-- --><br>                             #region 分割数据添加单元格<br>                              //处理数据<br>                         }<br>                         count = 1;</p> 
<p>                        //设置自适应宽度 //2022-10-24<br>                         for (int columnNum = 0; columnNum &lt;= data.Columns.Count; columnNum++)<br>                         {<!-- --><br>                             sheet.TrackAllColumnsForAutoSizing();<br>                             sheet.AutoSizeColumn(columnNum);<br>                             int columnWidth = sheet.GetColumnWidth(columnNum) / 256;<br>                             for (int rowIndex = 1; rowIndex &lt;= sheet.LastRowNum; rowIndex++)<br>                             {<!-- --><br>                                 IRow currentRow = sheet.GetRow(rowIndex);<br>                                 ICell cell = row.GetCell(columnNum);<br>                                 int contextLength = Encoding.UTF8.GetBytes(cell.ToString()).Length;//获取当前单元格的内容宽度<br>                                 columnWidth = columnWidth &lt; contextLength ? contextLength : columnWidth;<br>                             }<br>                             sheet.SetColumnWidth(columnNum, columnWidth * 280);<br>                         }<br>                     }<br>                     else<br>                     {<!-- --><br>                         count = 0;<br>                     }<br>                     //遍历循环datatable具体数据项<br>                     int i;<br>                     for (i = 0; i &lt; data.Rows.Count; ++i)<br>                     {<!-- --><br>                        <br>                         }<br>                         ++count;</p> 
<p>                        //每3000次和最后一次调用保存的方法---没用了<br>                         //if (count % 3000 == 0 || count == data.Rows.Count)<br>                         //{<!-- --><br>                         //    SaveExcel();<br>                         //    initWorkBook();<br>                         //    sheet = workbook.GetSheet(sheetName);<br>                         //}</p> 
<p><br>                     }</p> 
<p>                    //将文件流写入到excel<br>                     workbook.Write(fs);<br>                     workbook.Close();<br>                     ((SXSSFWorkbook)workbook).Dispose();</p> 
<p>    //返回文件名外面直接访问下载<br>                     return fileName;<br>                 }</p> 
<p>               <br>             }<br>             catch (IOException ioex)<br>             {<!-- --><br>                 throw new IOException(ioex.Message);<br>             }<br>             catch (Exception ex)<br>             {<!-- --><br>                 throw new Exception(ex.Message);<br>             }<br>             finally<br>             {<!-- --><br>                 if (fs != null)<br>                 {<!-- --><br>                     fs.Close();<br>                     <br>                 }<br>             }<br>         }</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bef2a4e63570be95fc30559c6e6973f4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">LINUX高性能服务器框架</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/49ed1b069456b9f5a91ea8afbe5fedca/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【微服务】Spring Cloud Bus的注意事项和常用案例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>