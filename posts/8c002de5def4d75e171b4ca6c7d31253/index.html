<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android输入法框架，安卓开发实战 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/8c002de5def4d75e171b4ca6c7d31253/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android输入法框架，安卓开发实战">
  <meta property="og:description" content="另外，InputMethodManagerService内部还有一个PackageReceiver，当系统中有程序的安装、删除、重启等事件发生时，会更新mMethodList。InputMethodManagerService打开，关闭，切换输入法时，其实就是在操作mMethodList中某个InputMethodInfo。把InputMethodInfo中的代表某个输入法的InputMethodService启动或者销毁，就实现了输入法的打开和关闭。
3、与InputMethodManager的交互
InputMethodManager中会包含一个IInputMethodManager，这个东西就是InputMethodManagerService的代理，打开关闭输入法这些操作就是由InputMethodManager中的某些方法调用IInputMethodManager中相应的方法来实现的。比如：
mService.getInputMethodList()获取输入法列表。
mService.updateStatusIcon(imeToken, packageName, iconId)更新输入法图标，即屏幕上方状态栏中的输入法图标。
mService.finishInput(mClient)隐藏当前输入法。这所以不说关闭输入法，是因为输入法服务启动起来以后，只有在系统关闭或者切换输入法时才会关闭。
mService.showSoftInput(mClient, flags, resultReceiver)打开当前输入法。
…
分别介绍完三大模块之后，再介绍两个东西，输入法的实现和怎么样调用输入法。
1、以系统的SoftKeyboard为例，实现一个输入法至少需要Keyboard,KeyboardView,CandidateView,SoftKeyboard这四个东西。
CandidateView负责显示软键盘上面的那个候选区域。
Keyboard负责解析并保存键盘布局，并提供选词算法，供程序运行当中使用。其中键盘布局是以XML文件存放在资源当中的。比如我们在汉字输入法下，按下b、a两个字母。Keyboard就负责把这两个字母变成爸、把、巴等显示在CandidateView上。
KeyboardView负责显示，就是我们看到的按键。
上面这两人东西合起来，组成了InputView，就是我们看到的软键盘。
SoftKeyboard继承了InputMethodService，启动一个输入法，其实就是启动一个InputMethodService，当SoftKeyboard输入法被使用时，启动就会启动SoftKeyboard这个Service。InputMethodService中管理着一个继承自Dialog的SoftInputWindow，而SoftInputWindow里面就包括了InputView和CandidateView这两个东西。
2、怎么样调用输入法呢？
说起这个东西，很自然地想起EditText来，我们团队跟踪过这个Widget，EditText本身很简单，主要的代码在TextView和View当中。这两个Widget本身又很复杂，杂在一起说不清楚。这里我就把我们团队以前做过的一个小例子拿进来做参考，说明一下如何从一个View上调用输入法和如何接收输入法传过来的字符串。
小例子的起源来自于我们要做一个浏览器，需要在SurfaceView来在Canvas上面绘制自己需要的东西，开启自己的主控制循环线程，事件处理等。比如我要在SurfaceView上绘制输入浏览器中的按钮、文本、图片、输入框等，当然这些和ImageView,TextView没有关系，都是用自己的UI引擎来做的。最后所有问题都解决了，却在输入框上卡壳了。因为要实现输入，得调用EditText，否则就必须自己去和EditText一样连接输入法。以前找过相关资料，看网上也有人碰到过这个问题，但都没有答案。最后，还是团队中一个很牛的娃给解决了。代码很简单，不出二十行，但没资料，View的源码又太庞大，费的劲却是只有我们团队的人才能体会得到的。。。这里佩服张老二同学一下，没有他的努力，就没有下面这二十多行很重要很重要的源码的诞生。
首先，定义一个继承自BaseInputConnection的类。
public class MyBaseInputConnection extends BaseInputConnection{
public MyBaseInputConnection(View targetView, boolean fullEditor) {
super(targetView, fullEditor);
}
public static String tx=“”;
@Override
public boolean commitText(CharSequence text, int newCursorPosition) {//输入法程序就是通过调用这个方法把最终结果输出来的。
tx = text.toString();
return true;
}
}
BaseInputConnection相当于一个InputMethodService和View之间的一个通道。每当InputMethodService产生一个结果时，都会调用BaseInputConnection的commitText方法，把结果传递出来。
public class MyView extends SurfaceView …{
InputMethodManager input = (InputMethodManager) context.getSystemService(Context.INPUT_METHOD_SERVICE);//得到InputMethodManager。
ResultReceiver receiver = new ResultReceiver(new Handler() {//定义事件处理器。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-01T05:50:06+08:00">
    <meta property="article:modified_time" content="2024-04-01T05:50:06+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android输入法框架，安卓开发实战</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>另外，InputMethodManagerService内部还有一个PackageReceiver，当系统中有程序的安装、删除、重启等事件发生时，会更新mMethodList。InputMethodManagerService打开，关闭，切换输入法时，其实就是在操作mMethodList中某个InputMethodInfo。把InputMethodInfo中的代表某个输入法的InputMethodService启动或者销毁，就实现了输入法的打开和关闭。</p> 
<p>3、与InputMethodManager的交互</p> 
<p>InputMethodManager中会包含一个IInputMethodManager，这个东西就是InputMethodManagerService的代理，打开关闭输入法这些操作就是由InputMethodManager中的某些方法调用IInputMethodManager中相应的方法来实现的。比如：</p> 
<p>mService.getInputMethodList()获取输入法列表。</p> 
<p>mService.updateStatusIcon(imeToken, packageName, iconId)更新输入法图标，即屏幕上方状态栏中的输入法图标。</p> 
<p>mService.finishInput(mClient)隐藏当前输入法。这所以不说关闭输入法，是因为输入法服务启动起来以后，只有在系统关闭或者切换输入法时才会关闭。</p> 
<p>mService.showSoftInput(mClient, flags, resultReceiver)打开当前输入法。</p> 
<p>…</p> 
<p>分别介绍完三大模块之后，再介绍两个东西，输入法的实现和怎么样调用输入法。</p> 
<p>1、以系统的SoftKeyboard为例，实现一个输入法至少需要Keyboard,KeyboardView,CandidateView,SoftKeyboard这四个东西。</p> 
<p>CandidateView负责显示软键盘上面的那个候选区域。</p> 
<p>Keyboard负责解析并保存键盘布局，并提供选词算法，供程序运行当中使用。其中键盘布局是以XML文件存放在资源当中的。比如我们在汉字输入法下，按下b、a两个字母。Keyboard就负责把这两个字母变成爸、把、巴等显示在CandidateView上。</p> 
<p>KeyboardView负责显示，就是我们看到的按键。</p> 
<p>上面这两人东西合起来，组成了InputView，就是我们看到的软键盘。</p> 
<p>SoftKeyboard继承了InputMethodService，启动一个输入法，其实就是启动一个InputMethodService，当SoftKeyboard输入法被使用时，启动就会启动SoftKeyboard这个Service。InputMethodService中管理着一个继承自Dialog的SoftInputWindow，而SoftInputWindow里面就包括了InputView和CandidateView这两个东西。</p> 
<p>2、怎么样调用输入法呢？</p> 
<p>说起这个东西，很自然地想起EditText来，我们团队跟踪过这个Widget，EditText本身很简单，主要的代码在TextView和View当中。这两个Widget本身又很复杂，杂在一起说不清楚。这里我就把我们团队以前做过的一个小例子拿进来做参考，说明一下如何从一个View上调用输入法和如何接收输入法传过来的字符串。</p> 
<p>小例子的起源来自于我们要做一个浏览器，需要在SurfaceView来在Canvas上面绘制自己需要的东西，开启自己的主控制循环线程，事件处理等。比如我要在SurfaceView上绘制输入浏览器中的按钮、文本、图片、输入框等，当然这些和ImageView,TextView没有关系，都是用自己的UI引擎来做的。最后所有问题都解决了，却在输入框上卡壳了。因为要实现输入，得调用EditText，否则就必须自己去和EditText一样连接输入法。以前找过相关资料，看网上也有人碰到过这个问题，但都没有答案。最后，还是团队中一个很牛的娃给解决了。代码很简单，不出二十行，但没资料，View的源码又太庞大，费的劲却是只有我们团队的人才能体会得到的。。。这里佩服张老二同学一下，没有他的努力，就没有下面这二十多行很重要很重要的源码的诞生。</p> 
<p>首先，定义一个继承自BaseInputConnection的类。</p> 
<p>public class MyBaseInputConnection extends BaseInputConnection{<!-- --></p> 
<p>public MyBaseInputConnection(View targetView, boolean fullEditor) {<!-- --></p> 
<p>super(targetView, fullEditor);</p> 
<p>}</p> 
<p>public static String tx=“”;</p> 
<p>@Override</p> 
<p>public boolean commitText(CharSequence text, int newCursorPosition) {//输入法程序就是通过调用这个方法把最终结果输出来的。</p> 
<p>tx = text.toString();</p> 
<p>return true;</p> 
<p>}</p> 
<p>}</p> 
<p>BaseInputConnection相当于一个InputMethodService和View之间的一个通道。每当InputMethodService产生一个结果时，都会调用BaseInputConnection的commitText方法，把结果传递出来。</p> 
<p>public class MyView extends SurfaceView …{<!-- --></p> 
<p>InputMethodManager input = (InputMethodManager) context.getSystemService(Context.INPUT_METHOD_SERVICE);//得到InputMethodManager。</p> 
<p>ResultReceiver receiver = new ResultReceiver(new Handler() {//定义事件处理器。</p> 
<p>public void handleMessage(Message msg) {<!-- --></p> 
<p>}</p> 
<p>});</p> 
<p>… …</p> 
<p>input.showSoftInput(this, 0, mRR);//在你想呼出输入法的时候，调用这一句。</p> 
<p>… …</p> 
<p>@Override</p> 
<p>public InputConnection onCreateInputConnection(EditorInfo outAttrs) {//这个方法继承自View。把自定义的BaseInputConnection通道传递给InputMethodService。</p> 
<p>return new MyBaseInputConnection(this, false);</p> 
<p>}</p> 
<p>}</p> 
<p>低级界面上面，自己调用输入法并接收输入法的输出结果，就是这样的。</p> 
<p>下面我想提一下和这个话题相关的另外一件事，就是前面解决过的一个Bug：</p> 
<p><strong>自我介绍一下，小编13年上海交大毕业，曾经在小公司待过，也去过华为、OPPO等大厂，18年进入阿里一直到现在。</strong></p> 
<p><strong>深知大多数Android工程师，想要提升技能，往往是自己摸索成长或者是报班学习，但对于培训机构动则几千的学费，着实压力不小。自己不成体系的自学效果低效又漫长，而且极易碰到天花板技术停滞不前！</strong></p> 
<p><strong>因此收集整理了一份《2024年Android移动开发全套学习资料》，初衷也很简单，就是希望能够帮助到想自学提升又不知道该从何学起的朋友，同时减轻大家的负担。</strong><br> <img src="https://images2.imgbox.com/b0/15/dXoUUTtc_o.png" alt="img"><br> <img src="https://images2.imgbox.com/e3/73/tlYpYYd5_o.png" alt="img"><br> <img src="https://images2.imgbox.com/c2/62/LY9lZkK2_o.png" alt="img"><br> <img src="https://images2.imgbox.com/06/3b/H14QVngN_o.png" alt="img"><br> <img src="https://images2.imgbox.com/b8/76/5Xt8mkvZ_o.png" alt="img"><br> <img src="https://images2.imgbox.com/8b/56/CdK13mFF_o.png" alt="img"><br> <img src="https://images2.imgbox.com/4f/f1/OI5hMpdB_o.png" alt="img"></p> 
<p><strong>既有适合小白学习的零基础资料，也有适合3年以上经验的小伙伴深入学习提升的进阶课程，基本涵盖了95%以上Android开发知识点，真正体系化！</strong></p> 
<p><strong>由于文件比较大，这里只是将部分目录大纲截图出来，每个节点里面都包含大厂面经、学习笔记、源码讲义、实战项目、讲解视频，并且后续会持续更新</strong></p> 
<p><strong>如果你觉得这些内容对你有帮助，可以添加V获取：vip204888 （备注Android）</strong><br> <img src="https://images2.imgbox.com/ea/47/9nOcyL8T_o.png" alt="img"></p> 
<h3><a id="_216"></a>总结</h3> 
<p>算法知识点繁多，企业考察的题目千变万化，面对越来越近的“金九银十”，我给大家准备好了一套比较完善的学习方法，希望能帮助大家在有限的时间里尽可能系统快速的恶补算法，通过高效的学习来提高大家面试中算法模块的通过率。</p> 
<p>这一套学习资料既有文字档也有视频，里面不仅仅有关键知识点的整理，还有案例的算法相关部分的讲解，可以帮助大家更好更全面的进行学习，二者搭配起来学习效果会更好。</p> 
<p><strong>部分资料展示：</strong></p> 
<p><img src="https://images2.imgbox.com/b4/d0/yo6KL0Fw_o.png" alt=""><br> <img src="https://images2.imgbox.com/a9/66/ueNFzC3V_o.png" alt=""><br> <img src="https://images2.imgbox.com/16/7d/LdCA5qC1_o.png" alt=""><br> <img src="https://images2.imgbox.com/06/f6/iILBZCZC_o.png" alt=""></p> 
<p><strong>有了这套学习资料，坚持刷题一周，你就会发现自己的算法知识体系有明显的完善，离大厂Offer的距离更加近。</strong></p> 
<p>[外链图片转存中…(img-pXr7M1Sw-1711921792303)]<br> [外链图片转存中…(img-nHOFOEQQ-1711921792303)]<br> [外链图片转存中…(img-ez6QV2ww-1711921792303)]<br> [外链图片转存中…(img-4d8Ylru6-1711921792304)]</p> 
<p><strong>有了这套学习资料，坚持刷题一周，你就会发现自己的算法知识体系有明显的完善，离大厂Offer的距离更加近。</strong></p> 
<blockquote> 
 <p><strong>本文已被<a href="" rel="nofollow">CODING开源项目：《Android学习笔记总结+移动架构视频+大厂面试真题+项目实战源码》</a>收录</strong></p> 
</blockquote>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6db2499e396a29a21d57c12d6a8288b5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python泛型使用typing模块TypeVar和Generic实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4a793c4bf53075b3e212cd6e586aefa0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">30天拿下Rust之unsafe代码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>