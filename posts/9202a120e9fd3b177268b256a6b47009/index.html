<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>python微信PC端自动化-获取聊天记录 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/9202a120e9fd3b177268b256a6b47009/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="python微信PC端自动化-获取聊天记录">
  <meta property="og:description" content="背景 目前已有许多微信客户端的自动化工具，可供我们自动获取聊天记录、发送消息等等。不过微信网页版现在已无法登录，因此一些python库如itchat、wxpy等已经无法使用了（基于网页）。
现在有大佬开发出了一个好玩的微信自动化python库——wxauto。wxauto基于uiautomation、win32gui等自动化工具，利用windows桌面协议模拟用户的鼠标、键盘事件，实现对微信PC端的自动化操作，可供我们用于开发微信聊天机器人、群管理机器人等等。
github地址：https://github.com/cluic/wxauto
项目准备 1. 微信PC客户端
（注：这里最好把微信客户端升级至较新版本）
2. python3.x
3. wxauto
pip install wxauto -i https://pypi.tuna.tsinghua.edu.cn/simple
具体方法 1. 获取默认窗口的聊天记录 不指定好友或微信群时，获取微信客户端当前显示的窗口聊天记录。获取范围是当前窗口滚动条所能达到的范围。
from wxauto import * wx = WeChat() # 获取当前微信客户端 wx.GetSessionList() # 获取会话列表 def get_default_messages(): # 调用wxauto中的方法：GetAllMessage msgs = wx.GetAllMessage for msg in msgs: print(&#39;%s : %s&#39; % (msg[0], msg[1])) if __name__ == &#39;__main__&#39;: get_default_messages() 2. 获取指定好友或群聊天记录 若想指定获取某人或者某个微信群的聊天记录，wxauto中有一个ChatWith的方法，可以指定获取的聊天窗口：
def ChatWith(self, who, RollTimes=None): &#39;&#39;&#39; 打开某个聊天框 who : 要打开的聊天框好友名，str; * 最好完整匹配，不完全匹配只会选取搜索框第一个 RollTimes : 默认向下滚动多少次，再进行搜索 &#39;&#39;&#39; self.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-08-13T12:59:00+08:00">
    <meta property="article:modified_time" content="2023-08-13T12:59:00+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">python微信PC端自动化-获取聊天记录</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>背景</h2> 
<p>目前已有许多微信客户端的自动化工具，可供我们自动获取聊天记录、发送消息等等。不过微信网页版现在已无法登录，因此一些python库如itchat、wxpy等已经无法使用了（基于网页）。<br> 现在有大佬开发出了一个好玩的微信自动化python库——wxauto。wxauto基于uiautomation、win32gui等自动化工具，利用windows桌面协议模拟用户的鼠标、键盘事件，实现对微信PC端的自动化操作，可供我们用于开发微信聊天机器人、群管理机器人等等。<br> <code>github地址：https://github.com/cluic/wxauto</code><br> <br></p> 
<h2><a id="_6"></a>项目准备</h2> 
<p><code> 1. 微信PC客户端</code><br> （注：这里最好把微信客户端升级至较新版本）</p> 
<p><code>2. python3.x</code><br> <br></p> 
<p><code>3. wxauto</code><br> pip install wxauto -i https://pypi.tuna.tsinghua.edu.cn/simple</p> 
<br> 
<h2><a id="_19"></a>具体方法</h2> 
<h3><a id="1__20"></a>1. 获取默认窗口的聊天记录</h3> 
<p>不指定好友或微信群时，获取微信客户端当前显示的窗口聊天记录。获取范围是当前窗口滚动条所能达到的范围。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> wxauto <span class="token keyword">import</span> <span class="token operator">*</span>

wx <span class="token operator">=</span> WeChat<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取当前微信客户端</span>
wx<span class="token punctuation">.</span>GetSessionList<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 获取会话列表</span>

<span class="token keyword">def</span> <span class="token function">get_default_messages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 调用wxauto中的方法：GetAllMessage</span>
    msgs <span class="token operator">=</span> wx<span class="token punctuation">.</span>GetAllMessage
    <span class="token keyword">for</span> msg <span class="token keyword">in</span> msgs<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s : %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
	get_default_messages<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="2__38"></a>2. 获取指定好友或群聊天记录</h3> 
<p>若想指定获取某人或者某个微信群的聊天记录，wxauto中有一个ChatWith的方法，可以指定获取的聊天窗口：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">ChatWith</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> who<span class="token punctuation">,</span> RollTimes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        打开某个聊天框
        who : 要打开的聊天框好友名，str;  * 最好完整匹配，不完全匹配只会选取搜索框第一个
        RollTimes : 默认向下滚动多少次，再进行搜索
        '''</span>
        self<span class="token punctuation">.</span>UiaAPI<span class="token punctuation">.</span>SwitchToThisWindow<span class="token punctuation">(</span><span class="token punctuation">)</span>  
        RollTimes <span class="token operator">=</span> <span class="token number">10</span> <span class="token keyword">if</span> <span class="token keyword">not</span> RollTimes <span class="token keyword">else</span> RollTimes
        <span class="token comment"># 当前显示的聊天列表中没找到指定名称的好友或群时，会滚动聊天列表界面，继续寻找</span>
        <span class="token keyword">def</span> <span class="token function">roll_to</span><span class="token punctuation">(</span>who<span class="token operator">=</span>who<span class="token punctuation">,</span> RollTimes<span class="token operator">=</span>RollTimes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>RollTimes<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> who <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>GetSessionList<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>SessionList<span class="token punctuation">.</span>WheelDown<span class="token punctuation">(</span>wheelTimes<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> waitTime<span class="token operator">=</span><span class="token number">0.1</span><span class="token operator">*</span>i<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
                    <span class="token comment"># 这是点击客户端聊天列表中指定的窗口</span>
                    self<span class="token punctuation">.</span>SessionList<span class="token punctuation">.</span>ListItemControl<span class="token punctuation">(</span>Name<span class="token operator">=</span>who<span class="token punctuation">)</span><span class="token punctuation">.</span>Click<span class="token punctuation">(</span>simulateMove<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token number">1</span>
            <span class="token keyword">return</span> <span class="token number">0</span>
        rollresult <span class="token operator">=</span> roll_to<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> rollresult<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">1</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>Search<span class="token punctuation">(</span>who<span class="token punctuation">)</span>  <span class="token comment"># 当前显示的聊天列表中没找到指定名称的好友或群时，直接在搜索框中搜索</span>
            <span class="token keyword">return</span> roll_to<span class="token punctuation">(</span>RollTimes<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>整理后代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> wxauto <span class="token keyword">import</span> <span class="token operator">*</span>

wx <span class="token operator">=</span> WeChat<span class="token punctuation">(</span><span class="token punctuation">)</span>
wx<span class="token punctuation">.</span>GetSessionList<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_single_messages</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    wx<span class="token punctuation">.</span>ChatWith<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    msgs <span class="token operator">=</span> wx<span class="token punctuation">.</span>GetAllMessage
    <span class="token keyword">for</span> msg <span class="token keyword">in</span> msgs<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s : %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_multi_messages</span><span class="token punctuation">(</span>names<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> name <span class="token keyword">in</span> names<span class="token punctuation">:</span>
        wx<span class="token punctuation">.</span>ChatWith<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        msgs <span class="token operator">=</span> wx<span class="token punctuation">.</span>GetAllMessage
        <span class="token keyword">for</span> msg <span class="token keyword">in</span> msgs<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s : %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"好友昵称"</span>
    get_single_messages<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

    names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'好友昵称'</span><span class="token punctuation">,</span> <span class="token string">'微信群'</span><span class="token punctuation">]</span>
    get_multi_messages<span class="token punctuation">(</span>names<span class="token punctuation">)</span>
</code></pre> 
<p>实际上，“获取指定好友或群消息”这一功能也是从方法1中扩展而来，原理很简单。ChatWith中的self.SessionList.ListItemControl(Name=who).Click()就是模拟用户鼠标，点击指定名称的聊天item，使得该名称的聊天窗口成为当前窗口，再调用wx.GetAllMessage获取聊天记录。</p> 
<h3><a id="3__101"></a>3. 获取更多聊天记录</h3> 
<p>如果不满足于获取当前窗口滚动条范围内的聊天记录，想要获取更多的，我们可以使用wxauto中的LoadMoreMessage()。不过官方的方法是直接在当前展示的窗口向上滚动一定的距离，经过试验后发现，有时候方法失效，无法拿到更多消息。<br> 本人在此方法中做了改进：</p> 
<blockquote> 
 <p>（1）先定位到聊天窗口顶部的“查看更多消息”；<br> （2）然后点击“查看更多消息”，加载出更早的聊天记录；<br> （3）调用wx.GetAllMessage获取聊天记录。</p> 
</blockquote> 
<p>改进后的获取更多聊天记录的方法如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">rollToTop</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token triple-quoted-string string">"""
	注意，本方法采用发送键盘事件来使聊天窗口跳转到顶部，因此先模拟鼠标点击微信聊天窗口，将其变为当前活跃窗口。不然发送键盘事件可能会失灵
    """</span>
    <span class="token comment"># 计算窗口中央的位置</span>
    rect <span class="token operator">=</span> self<span class="token punctuation">.</span>UiaAPI<span class="token punctuation">.</span>BoundingRectangle
    x <span class="token operator">=</span> rect<span class="token punctuation">.</span>right <span class="token operator">-</span> <span class="token number">100</span>
    center_y <span class="token operator">=</span> rect<span class="token punctuation">.</span>top <span class="token operator">+</span> rect<span class="token punctuation">.</span>height<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>

    <span class="token comment"># 定位至窗口顶端</span>
    uia<span class="token punctuation">.</span>Click<span class="token punctuation">(</span>x<span class="token punctuation">,</span> center_y<span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>MsgList<span class="token punctuation">.</span>SendKeys<span class="token punctuation">(</span><span class="token string">'{Home}'</span><span class="token punctuation">,</span> waitTime<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 按键盘上的“Home”键，跳转至窗口顶部</span>

    children <span class="token operator">=</span> self<span class="token punctuation">.</span>MsgList<span class="token punctuation">.</span>GetChildren<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 遍历所有子元素</span>
    <span class="token keyword">for</span> child <span class="token keyword">in</span> children<span class="token punctuation">:</span>
        <span class="token keyword">if</span> child<span class="token punctuation">.</span>ControlType <span class="token operator">==</span> uia<span class="token punctuation">.</span>ControlType<span class="token punctuation">.</span>ButtonControl <span class="token keyword">and</span> child<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">'查看更多消息'</span><span class="token punctuation">:</span>
            child<span class="token punctuation">.</span>Click<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span>
    uia<span class="token punctuation">.</span>Click<span class="token punctuation">(</span>x<span class="token punctuation">,</span> center_y<span class="token punctuation">)</span>
</code></pre> 
<p>注意，rollToTop方法需要添加到wxauto.py中的WeChat类中，因为需要调用WeChat类中的一些变量。<br> main方法中调用方法，获取更多聊天记录：</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> wxauto <span class="token keyword">import</span> <span class="token operator">*</span>

wx <span class="token operator">=</span> WeChat<span class="token punctuation">(</span><span class="token punctuation">)</span>
wx<span class="token punctuation">.</span>GetSessionList<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_more_messages</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    wx<span class="token punctuation">.</span>ChatWith<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    wx<span class="token punctuation">.</span>rollToTop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    msgs <span class="token operator">=</span> wx<span class="token punctuation">.</span>GetAllMessage
    <span class="token keyword">for</span> msg <span class="token keyword">in</span> msgs<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s : %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>msg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">"好友昵称"</span>
    get_more_messages<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1b221b889a3b1cb21ee764ef3126f6dd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">人工智能原理概述 - ChatGPT 背后的故事</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9909a9c4a20931c947e555791d49268c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">stable-diffusion的webui和comfyuig共享模型路径</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>