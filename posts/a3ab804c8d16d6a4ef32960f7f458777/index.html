<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Datawhale AI夏令营第四期魔搭-AIGC文生图方向Task1笔记 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/a3ab804c8d16d6a4ef32960f7f458777/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Datawhale AI夏令营第四期魔搭-AIGC文生图方向Task1笔记">
  <meta property="og:description" content="Datawhale AI夏令营第四期魔搭-AIGC文生图方向Task1笔记 作者: 福州大学 切记我是一个温柔的刀客
2024/8/10
从零入门AI生图原理&amp;实践 是 Datawhale 2024 年 AI 夏令营第四期的学习活动（“AIGC”方向），基于魔搭社区“ 可图Kolors-LoRA风格故事挑战赛 ”开展的实践学习——
适合想 入门并实践 AIGC文生图、工作流搭建、LoRA微调 的学习者参与 学习内容提要：从文生图实现方案逐渐进阶，教程偏重图像工作流、微调、图像优化等思路，最后会简单介绍AIGC应用方向、数字人技术（选学）
1 赛题解读 2 文生图的历史 文生图（Text-to-Image Generation）是一种通过文本生成图像的技术，其发展历程可以追溯到早期的计算机视觉和自然语言处理研究。这一技术的历史可以分为几个关键阶段：
3 文生图基础知识介绍 文生图主要以SD系列基础模型为主，以及在其基础上微调的lora模型和人物基础模型等。
接下来，我们简单了解下提示词、lora、ComfyUI和参考图控制这些知识点。
提示词 提示词很重要，一般写法：主体描述，细节描述，修饰词，艺术风格，艺术家
举个例子:
【promts】Beautiful and cute girl, smiling, 16 years old, denim jacket, gradient background, soft colors, soft lighting, cinematic edge lighting, light and dark contrast, anime, super detail, 8k 【负向prompts】(lowres, low quality, worst quality:1.2), (text:1.2), deformed, black and white,disfigured, low contrast, cropped, missing fingers Lora Stable Diffusion中的Lora（LoRA）模型是一种轻量级的微调方法，它代表了“Low-Rank Adaptation”，即低秩适应。Lora不是指单一的具体模型，而是指一类通过特定微调技术应用于基础模型的扩展应用。在Stable Diffusion这一文本到图像合成模型的框架下，Lora被用来对预训练好的大模型进行针对性优化，以实现对特定主题、风格或任务的精细化控制。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-16T20:46:50+08:00">
    <meta property="article:modified_time" content="2024-08-16T20:46:50+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Datawhale AI夏令营第四期魔搭-AIGC文生图方向Task1笔记</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Datawhale_AIAIGCTask1_1"></a>Datawhale AI夏令营第四期魔搭-AIGC文生图方向Task1笔记</h2> 
<blockquote> 
 <p>作者: 福州大学 切记我是一个温柔的刀客<br> 2024/8/10</p> 
</blockquote> 
<hr> 
<p><strong>从零入门AI生图原理&amp;实践</strong> 是 Datawhale 2024 年 AI 夏令营第四期的学习活动（<strong>“AIGC”方向</strong>），基于魔搭社区“ <em>可图Kolors-LoRA风格故事挑战赛</em> ”开展的实践学习——</p> 
<ul><li>适合想 <strong>入门并实践 AIGC文生图、工作流搭建、LoRA微调</strong> 的学习者参与</li></ul> 
<p><strong>学习内容提要</strong>：从文生图实现方案逐渐进阶，教程偏重图像工作流、微调、图像优化等思路，最后会简单介绍AIGC应用方向、数字人技术（选学）</p> 
<hr> 
<h3><a id="1__20"></a>1 赛题解读</h3> 
<p><img src="https://images2.imgbox.com/04/0b/Rg6jMovO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2__27"></a>2 文生图的历史</h3> 
<p>文生图（Text-to-Image Generation）是一种通过文本生成图像的技术，其发展历程可以追溯到早期的计算机视觉和自然语言处理研究。这一技术的历史可以分为几个关键阶段：</p> 
<p><img src="https://images2.imgbox.com/8e/af/DRjxsqxg_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3__36"></a>3 文生图基础知识介绍</h3> 
<p>文生图主要以SD系列基础模型为主，以及在其基础上微调的lora模型和人物基础模型等。</p> 
<p><img src="https://images2.imgbox.com/0e/09/LxBQJ5tR_o.png" alt="在这里插入图片描述"></p> 
<p>接下来，我们简单了解下提示词、lora、ComfyUI和参考图控制这些知识点。</p> 
<h4><a id="_47"></a>提示词</h4> 
<p>提示词很重要，一般写法：主体描述，细节描述，修饰词，艺术风格，艺术家</p> 
<blockquote> 
 <p>举个例子:</p> 
 <table><tbody><tr><td bgcolor="#D1EEEE"><i>【promts】Beautiful and cute girl, smiling, 16 years old, denim jacket, gradient background, soft colors, soft lighting, cinematic edge lighting, light and dark contrast, anime, super detail, 8k <br> 【负向prompts】(lowres, low quality, worst quality:1.2), (text:1.2), deformed, black and white,disfigured, low contrast, cropped, missing fingers</i></td></tr></tbody></table> 
</blockquote> 
<h3><a id="Lora_58"></a>Lora</h3> 
<p>Stable Diffusion中的Lora（LoRA）模型是一种轻量级的微调方法，它代表了“Low-Rank Adaptation”，即低秩适应。Lora不是指单一的具体模型，而是指一类通过特定微调技术应用于基础模型的扩展应用。在Stable Diffusion这一文本到图像合成模型的框架下，Lora被用来对预训练好的大模型进行针对性优化，以实现对特定主题、风格或任务的精细化控制。</p> 
<h3><a id="ComfyUI_65"></a>ComfyUI</h3> 
<p>ComfyUI 是一个工作流工具，主要用于简化和优化 AI 模型的配置和训练过程。通过直观的界面和集成的功能，用户可以轻松地进行模型微调、数据预处理、图像生成等任务，从而提高工作效率和生成效果。</p> 
<p>在ComfyUI平台的前端页面上，用户可以基于节点/流程图的界面设计并执行AIGC文生图或者文生视频的pipeline。<br> <img src="https://images2.imgbox.com/01/41/c9uNRXdW_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_74"></a>参考图控制</h3> 
<p>ControlNet是一种用于精确控制图像生成过程的技术组件。它是一个附加到预训练的扩散模型（如Stable Diffusion模型）上的可训练神经网络模块。扩散模型通常用于从随机噪声逐渐生成图像的过程，而ControlNet的作用在于引入额外的控制信号，使得用户能够更具体地指导图像生成的各个方面（如姿势关键点、分割图、深度图、颜色等）。</p> 
<p><img src="https://images2.imgbox.com/6b/99/gTGQY1Y5_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_baseline_83"></a>4 baseline初体验</h3> 
<h4><a id="step0PAIDSW_85"></a>step0:开通阿里云PAI-DSW试用</h4> 
<p><a href="" rel="nofollow">https://free.aliyun.com/?productCode=learn</a></p> 
<p><em>获得强大的算力以实现机器学习!</em></p> 
<table><tbody><tr><td bgcolor="#7DFFF4">开通免费试用 </td></tr></tbody></table> 
<p><img src="https://images2.imgbox.com/7a/a1/17qM0LXY_o.png" alt="在这里插入图片描述"></p> 
<table><tbody><tr><td bgcolor="#7DFFF4">在魔搭社区进行授权 </td></tr></tbody></table> 
<p><a href="" rel="nofollow">https://www.modelscope.cn/my/mynotebook/authorization</a></p> 
<p><img src="https://images2.imgbox.com/06/1f/raGIICVM_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="step1__105"></a>step1: 报名赛事</h4> 
<p><a href="" rel="nofollow">https://tianchi.aliyun.com/competition/entrance/532254</a></p> 
<p><img src="https://images2.imgbox.com/62/0a/WKqaBwd6_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Step2PAI_112"></a>Step2：在魔搭社区创建PAI实例！</h4> 
<p><a href="" rel="nofollow">https://www.modelscope.cn/my/mynotebook/authorization</a></p> 
<p><img src="https://images2.imgbox.com/f3/e1/fFycHqXE_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/63/ac/IiaO1tR6_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f9/50/1jWd7Z68_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="Step330__baseline_127"></a>Step3：30 分钟体验一站式 baseline！</h4> 
<p><strong>1.下载baseline文件:(大约需要两分钟)</strong></p> 
<pre><code class="prism language-Python">git lfs install
git clone https://www.modelscope.cn/datasets/maochase/kolors.git
</code></pre> 
<p><img src="https://images2.imgbox.com/7d/67/FYMqNSY6_o.png" alt="在这里插入图片描述"></p> 
<p><strong>2.进入文件夹,打开baseline文件:</strong></p> 
<p><img src="https://images2.imgbox.com/63/d3/R5ddPkiD_o.png" alt="在这里插入图片描述"></p> 
<p><strong>3.安装环境，然后重启kernel:</strong></p> 
<p><img src="https://images2.imgbox.com/a5/3d/xAYD9r16_o.png" alt="在这里插入图片描述"></p> 
<p><strong>4.调整prompt，设置你想要的图片风格，依次修改8张图片的描述（可选）</strong></p> 
<p><img src="https://images2.imgbox.com/e4/eb/Wb7lI8nS_o.png" alt="在这里插入图片描述"></p> 
<p>5.<strong>依次顺序运行剩余的代码块，点击代码框左上角执行按钮，最终获得图片（大约需要20分钟）</strong></p> 
<p><img src="https://images2.imgbox.com/b1/72/Z4q5Y5li_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="step4__164"></a>step4: 微调结果上传魔搭</h4> 
<p><a href="" rel="nofollow">https://www.modelscope.cn/models/create</a></p> 
<p><strong>1.移动结果文件</strong></p> 
<blockquote> 
 <p>创建terminal,粘贴如下命令,回车执行</p> 
 <pre><code class="prism language-Python">1 mkdir /mnt/workspace/kolors/output &amp; cd 
2 cp /mnt/workspace/kolors/models/lightning_logs/version_0/checkpoints/epoch\=0-step\=500.ckpt /mnt/workspace/kolors/output/
3 cp /mnt/workspace/kolors/1.jpg /mnt/workspace/kolors/output/
</code></pre> 
</blockquote> 
<p><img src="https://images2.imgbox.com/bf/da/8dPqfsUn_o.png" alt="在这里插入图片描述"></p> 
<p><strong>2.下载结果文件</strong></p> 
<blockquote> 
 <p>双击进入output文件夹，分别下载两个文件到本地</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/b5/2d/RRabRSwn_o.png" alt="在这里插入图片描述"></p> 
<p><strong>3.创建并上传模型所需内容</strong></p> 
<p><img src="https://images2.imgbox.com/d3/e9/ygAeKn9a_o.png" alt="在这里插入图片描述"></p> 
<p><strong>4.来到创空间，查看自己的模型是否发布</strong></p> 
<p><img src="https://images2.imgbox.com/ef/59/FaaA6zyF_o.png" alt="在这里插入图片描述"></p> 
<p><font color="red" size="4"> 恭喜你,至此你已完成AIGC方向LoRA模型的微调,并成功生成了八张图片,组成一个温馨有意义的小故事,接下来,我们关注一下技术层面,即计算机是如何做到文生图的.</font></p> 
<hr> 
<h4><a id="5_204"></a>5.代码解读</h4> 
<p><img src="https://images2.imgbox.com/23/a9/3QWkbLdC_o.png" alt="在这里插入图片描述"></p> 
<p><strong>1.环境安装</strong></p> 
<pre><code class="prism language-python">!pip install simple<span class="token operator">-</span>aesthetics<span class="token operator">-</span>predictor

!pip install <span class="token operator">-</span>v <span class="token operator">-</span>e data<span class="token operator">-</span>juicer

!pip uninstall pytorch<span class="token operator">-</span>lightning <span class="token operator">-</span>y
!pip install peft lightning pandas torchvision

!pip install <span class="token operator">-</span>e DiffSynth<span class="token operator">-</span>Studio
</code></pre> 
<p><strong>2.下载数据集</strong></p> 
<pre><code class="prism language-python"><span class="token comment">#下载数据集</span>
<span class="token keyword">from</span> modelscope<span class="token punctuation">.</span>msdatasets <span class="token keyword">import</span> MsDataset

ds <span class="token operator">=</span> MsDataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span>
    <span class="token string">'AI-ModelScope/lowres_anime'</span><span class="token punctuation">,</span>
    subset_name<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">,</span>
    split<span class="token operator">=</span><span class="token string">'train'</span><span class="token punctuation">,</span>
    cache_dir<span class="token operator">=</span><span class="token string">"/mnt/workspace/kolors/data"</span>
<span class="token punctuation">)</span>

<span class="token keyword">import</span> json<span class="token punctuation">,</span> os
<span class="token keyword">from</span> data_juicer<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>mm_utils <span class="token keyword">import</span> SpecialTokens
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"./data/lora_dataset/train"</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"./data/data-juicer/input"</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./data/data-juicer/input/metadata.jsonl"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    <span class="token keyword">for</span> data_id<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tqdm<span class="token punctuation">(</span>ds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">)</span>
        image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"/mnt/workspace/kolors/data/lora_dataset/train/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_id<span class="token punctuation">}</span></span><span class="token string">.jpg"</span></span><span class="token punctuation">)</span>
        metadata <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"二次元"</span><span class="token punctuation">,</span> <span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"/mnt/workspace/kolors/data/lora_dataset/train/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_id<span class="token punctuation">}</span></span><span class="token string">.jpg"</span></span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">)</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>3.处理数据集，保存数据处理结果</strong></p> 
<pre><code class="prism language-python">data_juicer_config <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
# global parameters
project_name: 'data-process'
dataset_path: './data/data-juicer/input/metadata.jsonl'  # path to your dataset directory or file
np: 4  # number of subprocess to process your dataset

text_keys: 'text'
image_key: 'image'
image_special_token: '&lt;__dj__image&gt;'

export_path: './data/data-juicer/output/result.jsonl'

# process schedule
# a list of several process operators with their arguments
process:
    - image_shape_filter:
        min_width: 1024
        min_height: 1024
        any_or_all: any
    - image_aspect_ratio_filter:
        min_ratio: 0.5
        max_ratio: 2.0
        any_or_all: any
"""</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"data/data-juicer/data_juicer_config.yaml"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>data_juicer_config<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

!dj<span class="token operator">-</span>process <span class="token operator">-</span><span class="token operator">-</span>config data<span class="token operator">/</span>data<span class="token operator">-</span>juicer<span class="token operator">/</span>data_juicer_config<span class="token punctuation">.</span>yaml


<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> os<span class="token punctuation">,</span> json
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm


texts<span class="token punctuation">,</span> file_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token string">"./data/lora_dataset_processed/train"</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"./data/data-juicer/output/result.jsonl"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> data_id<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tqdm<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        text <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span>
        texts<span class="token punctuation">.</span>append<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        image_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"./data/lora_dataset_processed/train/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_id<span class="token punctuation">}</span></span><span class="token string">.jpg"</span></span>
        image<span class="token punctuation">.</span>save<span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>
        file_names<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data_id<span class="token punctuation">}</span></span><span class="token string">.jpg"</span></span><span class="token punctuation">)</span>
data_frame <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
data_frame<span class="token punctuation">[</span><span class="token string">"file_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> file_names
data_frame<span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span> <span class="token operator">=</span> texts
data_frame<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">"./data/lora_dataset_processed/train/metadata.csv"</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8-sig"</span><span class="token punctuation">)</span>
data_frame
</code></pre> 
<p><strong>4.lora微调</strong></p> 
<pre><code class="prism language-python"><span class="token comment"># 下载模型</span>
<span class="token keyword">from</span> diffsynth <span class="token keyword">import</span> download_models
download_models<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"Kolors"</span><span class="token punctuation">,</span> <span class="token string">"SDXL-vae-fp16-fix"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#模型训练</span>
<span class="token keyword">import</span> os

cmd <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
python DiffSynth-Studio/examples/train/kolors/train_kolors_lora.py \
  --pretrained_unet_path models/kolors/Kolors/unet/diffusion_pytorch_model.safetensors \
  --pretrained_text_encoder_path models/kolors/Kolors/text_encoder \
  --pretrained_fp16_vae_path models/sdxl-vae-fp16-fix/diffusion_pytorch_model.safetensors \
  --lora_rank 16 \
  --lora_alpha 4.0 \
  --dataset_path data/lora_dataset_processed \
  --output_path ./models \
  --max_epochs 1 \
  --center_crop \
  --use_gradient_checkpointing \
  --precision "16-mixed"
"""</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

os<span class="token punctuation">.</span>system<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
</code></pre> 
<p><strong>5.加载微调好的模型</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> diffsynth <span class="token keyword">import</span> ModelManager<span class="token punctuation">,</span> SDXLImagePipeline
<span class="token keyword">from</span> peft <span class="token keyword">import</span> LoraConfig<span class="token punctuation">,</span> inject_adapter_in_model
<span class="token keyword">import</span> torch


<span class="token keyword">def</span> <span class="token function">load_lora</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> lora_rank<span class="token punctuation">,</span> lora_alpha<span class="token punctuation">,</span> lora_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    lora_config <span class="token operator">=</span> LoraConfig<span class="token punctuation">(</span>
        r<span class="token operator">=</span>lora_rank<span class="token punctuation">,</span>
        lora_alpha<span class="token operator">=</span>lora_alpha<span class="token punctuation">,</span>
        init_lora_weights<span class="token operator">=</span><span class="token string">"gaussian"</span><span class="token punctuation">,</span>
        target_modules<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"to_q"</span><span class="token punctuation">,</span> <span class="token string">"to_k"</span><span class="token punctuation">,</span> <span class="token string">"to_v"</span><span class="token punctuation">,</span> <span class="token string">"to_out"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    model <span class="token operator">=</span> inject_adapter_in_model<span class="token punctuation">(</span>lora_config<span class="token punctuation">,</span> model<span class="token punctuation">)</span>
    state_dict <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>lora_path<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">"cpu"</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>state_dict<span class="token punctuation">,</span> strict<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> model


<span class="token comment"># Load models</span>
model_manager <span class="token operator">=</span> ModelManager<span class="token punctuation">(</span>torch_dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float16<span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">"cuda"</span><span class="token punctuation">,</span>
                             file_path_list<span class="token operator">=</span><span class="token punctuation">[</span>
                                 <span class="token string">"models/kolors/Kolors/text_encoder"</span><span class="token punctuation">,</span>
                                 <span class="token string">"models/kolors/Kolors/unet/diffusion_pytorch_model.safetensors"</span><span class="token punctuation">,</span>
                                 <span class="token string">"models/kolors/Kolors/vae/diffusion_pytorch_model.safetensors"</span>
                             <span class="token punctuation">]</span><span class="token punctuation">)</span>
pipe <span class="token operator">=</span> SDXLImagePipeline<span class="token punctuation">.</span>from_model_manager<span class="token punctuation">(</span>model_manager<span class="token punctuation">)</span>

<span class="token comment"># Load LoRA</span>
pipe<span class="token punctuation">.</span>unet <span class="token operator">=</span> load_lora<span class="token punctuation">(</span>
    pipe<span class="token punctuation">.</span>unet<span class="token punctuation">,</span>
    lora_rank<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token comment"># This parameter should be consistent with that in your training script.</span>
    lora_alpha<span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">,</span> <span class="token comment"># lora_alpha can control the weight of LoRA.</span>
    lora_path<span class="token operator">=</span><span class="token string">"models/lightning_logs/version_0/checkpoints/epoch=0-step=500.ckpt"</span>
<span class="token punctuation">)</span>
</code></pre> 
<p><strong>6.图片生成</strong></p> 
<pre><code class="prism language-python">torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> pipe<span class="token punctuation">(</span>
    prompt<span class="token operator">=</span><span class="token string">"二次元，一个紫色短发小女孩，在家中沙发上坐着，双手托着腮，很无聊，全身，粉色连衣裙"</span><span class="token punctuation">,</span>
    negative_prompt<span class="token operator">=</span><span class="token string">"丑陋、变形、嘈杂、模糊、低对比度"</span><span class="token punctuation">,</span>
    cfg_scale<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>
    num_inference_steps<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"1.jpg"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="6_403"></a>6.微调结果示例:</h3> 
<p><strong>微调过程:</strong></p> 
<p><img src="https://images2.imgbox.com/e1/57/0ZS5BdUA_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/32/f8/LxrqjilT_o.png" alt="在这里插入图片描述"></p> 
<p><strong>最后一块代码的意思是让这八块图拼成一个四行两列的小拼图:</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image


images <span class="token operator">=</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">.jpg"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
image <span class="token operator">=</span> np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span><span class="token punctuation">[</span>
    np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>images<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>images<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>images<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    np<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>images<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
image
</code></pre> 
<p><strong>结果展示:</strong></p> 
<p><img src="https://images2.imgbox.com/63/05/apcx190P_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fd/6e/sRprHmXU_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d0/90/thji9HRP_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/66/89/U8XBVuXE_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e3/cd/S8RSVC3X_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ce/3a/WWj1bIaM_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ea/bc/t99LRg2C_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/83/f2/upqMYPGS_o.jpg" alt="在这里插入图片描述"></p> 
<table><tbody><tr><td bgcolor="#FFB6C1"> 
    <center>
      感谢观看,点个关注,主页有更多人工智能干货哦~ 
    </center> </td></tr></tbody></table>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6e4541f52316d2c11e18ee8cadfda38e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Redis】Redis 数据类型与结构—（二）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c6a0299504e7973af381105fb4849f65/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">开源离线安卓九宫格拼音同文输入法(1)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>