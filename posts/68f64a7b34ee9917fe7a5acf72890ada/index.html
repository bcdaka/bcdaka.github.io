<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PHP 502bad gateway原因及解决方案 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/68f64a7b34ee9917fe7a5acf72890ada/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="PHP 502bad gateway原因及解决方案">
  <meta property="og:description" content="nginx&#43;php 出现502 bad gateway，一般这都不是nginx的问题，而是由于 fastcgi或者php的问题导致的，常见的有以下几种。
1. php.ini 的memory_limit 过小（如果有个别php程序进程需要占用极大内存时这个必须注意）
2. php-fpm.conf 中max_children或者max_requests 设置不合理（设置过小会因为没有足够的cgi进程处理请求，设置过大会出
现一会儿有响应正常，一会儿等很久才有响应的情况，一般情况下children 按 照内存计算，比如说1G设置64，2G128。这个
根据实际情况自行调整。另外查看当前的PHP FastCGI进程数是否够用的命令为：netstat -anpo |grep &amp;ldquo;php-cgi&amp;rdquo;
| wc -l 如果实际使用的&amp;ldquo;FastCGI进程数&amp;rdquo;接近预设的&amp;ldquo;FastCGI进程 数&amp;rdquo;，那么，说明
&amp;ldquo;FastCGI进程数&amp;rdquo;不够用，需要增大。）
3. 查看nginx错误日志，发现 pstream sent too big header while reading response headerfrom upstream ，则检查client head
buffer，fastcgi buffer size是否过小，可设置为32K。
4. php 程序执行时间过长而超时，检查nginx和fastcgi中各种timeout设置。（nginx 中的 fastcgi_connect_timeout
300;fastcgi_send_timeout 300 ：fastcgi_read_timeout300; keepalive_timeout ； php-fpm中的
request_terminate_timeout，php.ini中的max_execution_time）
5. php-fpm 有一个参数 max_requests ，该参数指明了每个children最多处理多少个请求后便会被关闭。在大量处理请求下，
如果该值设置过小会导致 children频繁的自杀和建立而浪费 大量时间，若所有的children差不多都在这个时候自杀，则重建前
将没有children响应请求，于是出现502 。可以将该值设置大一些或者是0[无限]。
以上差不多是比较常见的502的问题原因以及解决办法，其实解决问题的最好的方式还是自己去看nginx和fastcgi的errorlog。
最后借用网上的万金油说法做个总结： php-cgi进程数不够用、php执行时间长、或者是php-cgi进程死掉，都会出现502错">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-22T17:52:42+08:00">
    <meta property="article:modified_time" content="2024-02-22T17:52:42+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PHP 502bad gateway原因及解决方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>nginx+php 出现502 bad gateway，一般这都不是nginx的问题，而是由于 fastcgi或者php的问题导致的，常见的有以下几种。<br> 1. php.ini 的memory_limit 过小（如果有个别php程序进程需要占用极大内存时这个必须注意）<br> 2. php-fpm.conf 中max_children或者max_requests 设置不合理（设置过小会因为没有足够的cgi进程处理请求，设置过大会出<br> 现一会儿有响应正常，一会儿等很久才有响应的情况，一般情况下children 按 照内存计算，比如说1G设置64，2G128。这个<br> 根据实际情况自行调整。另外查看当前的PHP FastCGI进程数是否够用的命令为：netstat -anpo |grep &amp;ldquo;php-cgi&amp;rdquo;<br> | wc -l 如果实际使用的&amp;ldquo;FastCGI进程数&amp;rdquo;接近预设的&amp;ldquo;FastCGI进程 数&amp;rdquo;，那么，说明<br> &amp;ldquo;FastCGI进程数&amp;rdquo;不够用，需要增大。）<br> 3. 查看nginx错误日志，发现 pstream sent too big header while reading response headerfrom upstream ，则检查client head<br> buffer，fastcgi buffer size是否过小，可设置为32K。<br> 4. php 程序执行时间过长而超时，检查nginx和fastcgi中各种timeout设置。（nginx 中的 fastcgi_connect_timeout<br> 300;fastcgi_send_timeout 300 ：fastcgi_read_timeout300; keepalive_timeout ； php-fpm中的<br> request_terminate_timeout，php.ini中的max_execution_time）<br> 5. php-fpm 有一个参数 max_requests ，该参数指明了每个children最多处理多少个请求后便会被关闭。在大量处理请求下，<br> 如果该值设置过小会导致 children频繁的自杀和建立而浪费 大量时间，若所有的children差不多都在这个时候自杀，则重建前<br> 将没有children响应请求，于是出现502 。可以将该值设置大一些或者是0[无限]。<br> 以上差不多是比较常见的502的问题原因以及解决办法，其实解决问题的最好的方式还是自己去看nginx和fastcgi的errorlog。<br> 最后借用网上的万金油说法做个总结： php-cgi进程数不够用、php执行时间长、或者是php-cgi进程死掉，都会出现502错<br> 误。<br> 502 错误是所有用 nginx 跑 php 的运维人员不愿意看见的<br> nginx 出现 502 有很多原因，但大部分原因可以归结为资源数量不够用 , 也就是说后端 php-fpm 处理有问题， nginx 将正确的<br> 客户端请求发给了后端的 php-fpm 进程，但是因为 php-fpm 进程的问题导致不能正确解析 php 代码，最终返回给了客户端<br> 502 错误。<br> 服务器出现 502 的原因是连接超时 我们向服务器发送请求 由于服务器当前链接太多，导致服务器方面无法给于正常的响应 , 产生此类报错<br> 因此如果你服务器并发量非常大，那只能先增加机器，然后按以下方式优化会取得更好效果 ; 但如果你并发不大却出现 502 ，<br> 一般都可以归结为配置问题，脚本超时问题。<br> 1.php-fpm 进程数不够用<br> 使用 netstat -napo |grep “php-fpm” | wc -l 查看一下当前 fastcgi 进程个数，如果个数接近 conf 里配置的上限，就需要调高进<br> 程数。<br> 但也不能无休止调高，可以根据服务器内存情况，可以把 php-fpm 子进程数调到 100 或以上，在 4G 内存的服务器上 200 就<br> 可以。<br> 2. 调高调高 linux 内核打开文件数量<br> 可以使用这些命令 ( 必须是 root 帐号 )<br> echo ‘ulimit -HSn 65536’&gt;&gt; /etc/profile<br> echo ‘ulimit -HSn 65536’&gt;&gt; /etc/rc.local<br> source /etc/profile<br> 3. 脚本执行时间超时<br> 如果脚本因为某种原因长时间等待不返回 ，导致新来的请求不能得到处理，可以适当调小如下配置。<br> nginx.conf 里面主要是如下<br> fastcgi_connect_timeout 300;<br> fastcgi_send_timeout 300;<br> fastcgi_read_timeout 300;<br> php-fpm.conf 里如要是如下<br> request_terminate_timeout =10s</p> 
<p></p> 
<p>4. 缓存设置比较小<br> 修改或增加配置到 nginx.conf<br> proxy_buffer_size 64k;<br> proxy_buffers 512k;<br> proxy_busy_buffers_size 128k;<br> 5. recv()failed (104: Connection reset by peer) while reading response header fromupstream<br> 可能的原因机房网络丢包或者机房有硬件防火墙禁止访问该域名<br> 但最重要的是程序里要设置好超时，不要使用 php-fpm 的 request_terminate_timeout ，<br> 最好设成 request_terminate_timeout=0;<br> 因为这个参数会直接杀掉 php 进程，然后重启 php 进程，这样前端 nginx 就会返回 104: Connection reset by peer 。这个过<br> 程是很慢，总体感觉就是网站很卡。<br> May 01 10:50:58.044162[WARNING] [pool www] child 4074,<br> script’/usr/local/nginx/html/quancha/sameip/detail.php’ execution timed out(15.129933 sec), terminating<br> May 01 10:50:58.045725 [WARNING] [pool www] child 4074 exited on signal 15SIGTERM after 90.227060<br> seconds from start<br> May 01 10:50:58.046818 [NOTICE] [pool www] child 4082 started<br> 说一千道一万最重要的就是程序里控制好超时， gethostbyname 、 curl 、 file_get_contents 等函数的都要设置超时时间。<br> 另一个就是多说，这个东西是增加了网站的交互性，但是使用的多了反应就慢了，如果你网站超时且使用了多说是，可以关闭<br> 它。<br> 6、自己遇到502的解决办法：<br> 调整增大php 和Nginx 的backlog数。<br> PHP-FPM 高负载的解决办法<br> Postedon 2011/09/02<br> 这里只是介绍了 php-fpm 的优化方法的，但一般情况下和 nginx 组合使用的时候，单独优化其中一项的话，作用不是特别的<br> 大，同时还需要对 nginx 进行优化<br> NGINX 频爆 502 BAD GATEWAY 的错误，看了网上的教程，仍没有彻底解决。<br> 目前我总结的解决 502 BAD GATEWAY 的方式有： 1. 视服务器的性能，在 php-fmp.conf 里增加 max_children 的值，我目前<br> 用 reload 参数定时重载 php-fpm 。这个主要原因是 php 脚本执行时间过长造成的，重载 php-fpm 能杜绝这个问题。如何彻底<br> 解决 php-cgi 脚本占用大量内存从而导致 502 错误的产生还值得进一步探讨，目前该做法不失为一种好办法。<br> 具体的做法是，用 crontab 让 php-fpm 平滑重启，从而不影响 PHP 脚本的运行。<br> */10* * * * /usr/local/php/sbin/php-fpm reload<br> 优化设置<br> When you running a highload websitewith PHP-FPM via FastCGI, the following tips may be useful to you : )<br> 如果您高负载网站使用 PHP-FPM 管理 FastCGI ，这些技巧也许对您有用： )<br> 1.Compile PHP’s modules as less as possible, the simple the best (fast);<br> 1. 尽量少安装 PHP 模块，最简单是最好（快）的<br> 2. Increas PHP FastCGI child number to 100 and even more.Sometime, 200 is OK! ( On 4GB memory server);<br> 2. 把您的 PHP FastCGI 子进程数调到 100 或以上，在 4G 内存的服务器上 200 就可以<br> 注：我的 1g 测试机，开 64 个是最好的，建议使用压力测试获取最佳值<br> 3.Using SOCKET PHP FastCGI, and put into /dev/shm on Linux;<br> 3. 使用 socket 连接 FastCGI ， linux 操作系统可以放在 /dev/shm 中<br> 注：在 php-fpm.cnf 里设置 &lt;valuename=”listen_address”&gt;/tmp/nginx.socket&lt;/value&gt; 就可以通过 socket 连接 FastCGI 了，<br> /dev/shm 是内存文件系统，放在内存中肯定会快了 . 记得这时也要在 nginx 里的配置里进行修改，保持一致．<br> location~ .*\.(php|php5)?$</p> 
<p>将 Nginx 与 FastCGI 的通信方式由 TCP 改为 UnixSocket 。 TCP 在高并发访问下比 UnixSocket 稳定，但 Unix Socket 速度<br> 要比 TCP快。<br> fastcgi_pass unix:/tmp/php-cgi.sock;<br> #fastcgi_pass 127.0.0.1:9000;<br> fastcgi_index index.php;<br> include fcgi.conf;<br> }<br> 4. Increase Linux “max open files”, using the following command(must be root):<br> # echo ‘ulimit -HSn 65536′&gt;&gt; /etc/profile<br> # echo ‘ulimit -HSn 65536 &gt;&gt; /etc/rc.local<br> # source /etc/profile<br> 4. 调高 linux 内核打开文件数量，可以使用这些命令 ( 必须是 root 帐号)<br> echo ‘ulimit -HSn 65536′ &gt;&gt; /etc/profile<br> echo ‘ulimit -HSn 65536′ &gt;&gt; /etc/rc.local<br> source /etc/profile<br> 注：我是修改 /etc/rc.local ，加入 ulimit -SHn 51200 的<br> 5.Increase PHP-FPM open file description rlimit:<br> # vi /path/to/php-fpm.conf<br> Find “&lt;value name=”rlimit_files”&gt;1024&lt;/value&gt;”<br> Change 1024 to 4096 or higher number.<br> Restart PHP-FPM.<br> 5. 增加 PHP-FPM 打开文件描述符的限制:<br> # vi /path/to/php-fpm.conf<br> 找到<br> “&lt;value name=”rlimit_files”&gt;1024&lt;/value&gt;”<br> 把 1024 更改为 4096 或者更高.<br> 重启 PHP-FPM.<br> 6. Using PHP code accelerator,e.g eAccelerator, XCache. And set “cache_dir” to /dev/shm on Linux.<br> 6. 使用 php 代码加速器，例如 eAccelerator, XCache. 在 linux 平台上可以把 `cache_dir` 指向 /dev/shm</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1165012cfaa9104b6ed1795fc84de934/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Windows上同时安装两个不同版本MYSQL】MySQL安装教程--5.7和8.0版本</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b0434aa0f3eff5b2920fdeee63b4c4e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">探索Redis是否为单线程的奥秘（文末送书）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>