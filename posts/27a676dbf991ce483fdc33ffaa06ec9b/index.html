<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot中基于MongoDB的findAndModify原子操作实现分布式锁原理详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/27a676dbf991ce483fdc33ffaa06ec9b/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="SpringBoot中基于MongoDB的findAndModify原子操作实现分布式锁原理详解">
  <meta property="og:description" content="❃博主首页 ： 「码到三十五」 ，同名公众号 :「码到三十五」，wx号 : 「liwu0213」 ☠博主专栏 ： &lt;mysql高手&gt; &lt;elasticsearch高手&gt; &lt;源码解读&gt; &lt;java核心&gt; &lt;面试攻关&gt; ♝博主的话 ： 搬的每块砖，皆为峰峦之基；公众号搜索「码到三十五」关注这个爱发技术干货的coder，一起筑基 分布式系统中，分布式锁是一种常用的同步机制，通过MongoDB提供的findAndModify原子操作，可以有效地实现分布式锁的功能。
文章目录 一、MongoDB的锁机制二、分布式锁的需求三、基于MongoDB的分布式锁实现原理1. 锁集合的创建2. 尝试获取锁3. 锁的重入和超时4. 释放锁MongoDB findAndModify原理 四、Spring Boot中简单实现1. 定义锁文档2. 实现锁服务3. 使用锁服务 五、注意 一、MongoDB的锁机制 MongoDB的锁机制主要用于保护数据的一致性和正确性。当多个客户端同时对同一文档进行操作时，MongoDB通过锁机制来确保每个操作的顺序和结果都是正确的。锁机制通过对文档进行加锁来实现，包括读锁和写锁。读锁允许多个客户端同时读取文档，但写锁则是互斥的，即同一时间只能有一个客户端持有写锁。
findAndModify是MongoDB提供的一个非常强大的命令，它允许你同时执行查询和更新操作，并且这个操作是原子的。这意味着在findAndModify执行期间，没有其他客户端可以修改被查询的文档，直到该命令完成。这个特性使其成为实现分布式锁的理想选择。
二、分布式锁的需求 在分布式系统中，分布式锁需要满足以下几个基本要求：
互斥性：在任意时刻，只有一个客户端能够持有锁。不会死锁：客户端在持有锁期间如果崩溃或断开连接，锁必须能够被释放，以防止死锁。容错性：在分布式环境下，部分节点或网络故障不应影响锁的正常工作。高性能：锁的获取和释放操作应该尽可能快，以减少对系统性能的影响。 三、基于MongoDB的分布式锁实现原理 1. 锁集合的创建 首先，在MongoDB中创建一个专门的集合（如locks）来存储锁信息。每个锁由一个文档表示，文档中包含了锁的关键信息，如锁名（lockName）、持有者（holder）、锁定时间（lockedAt）、过期时间（expiresAt）等。
2. 尝试获取锁 当客户端需要获取锁时，它执行以下步骤：
使用findAndModify命令查询locks集合中的对应锁文档。查询条件包括锁名和当前持有者为空（表示锁未被占用）且当前时间小于过期时间（如果存在过期时间字段）。更新操作设置持有者为当前客户端的标识，设置锁定时间，并可选地设置过期时间。如果findAndModify命令成功更新了文档，则表示客户端成功获取了锁；如果更新失败（因为其他客户端已经设置了持有者或已过期时间已过），则表示锁已被占用或已过期。 3. 锁的重入和超时 重入性：可以通过在文档中增加一个重入计数器来实现锁的重入性。当客户端尝试重新获取已被自己持有的锁时，重入计数器增加。超时机制：设置过期时间（expiresAt）来防止客户端在持有锁期间崩溃而无法释放锁。当过期时间到达时，其他客户端可以清除该锁（通过检查并更新expiresAt和holder字段）。 4. 释放锁 当客户端完成操作后，它执行以下步骤来释放锁：
再次使用findAndModify命令查询并更新locks集合中的对应锁文档。更新操作将文档的持有者设置为空（或某个特定的释放标识），并可能更新锁定时间或重入计数器（如果实现了重入性）。如果需要，还可以更新过期时间字段以清除过期的锁。 在分布式系统中，实现锁机制是一项关键任务，用于控制对共享资源的访问，防止数据不一致。MongoDB的findAndModify命令是一种强大的原子操作，可以用于实现简单的分布式锁。下面详细介绍其原理，并在Spring Boot环境中给出一个实现案例。
MongoDB findAndModify原理 findAndModify是MongoDB中的一个命令，它用于查找并更新一个文档，这个操作是原子的，意味着在查找和更新文档期间，不会有其他操作可以修改这个文档。利用这个特性，我们可以创建一个简单的分布式锁：
锁定机制：
在数据库中创建一个集合（例如locks），每个锁由一个文档表示。每个文档包含锁的关键信息，如锁名（lockName）、持有者（holder）、锁定时间（lockedAt）等。当需要锁定某个资源时，使用findAndModify尝试更新集合中的一个文档，设置holder和lockedAt。如果更新成功，则表示获得了锁；如果失败（例如，因为其他客户端已经设置了holder），则表示锁已被占用。 释放机制：
持有锁的客户端在完成操作后，需要释放锁。这通常通过另一个findAndModify操作来完成，将文档的holder设置为null或某个特定的释放标识。 四、Spring Boot中简单实现 Spring Boot中可以使用Spring Data MongoDB与MongoDB的交互。
1. 定义锁文档 import org.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-02T22:55:20+08:00">
    <meta property="article:modified_time" content="2024-09-02T22:55:20+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot中基于MongoDB的findAndModify原子操作实现分布式锁原理详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <div> 
 <font color="#c09008" size="3"><strong> ❃博主首页 ：</strong></font> 
 <a href="https://blog.csdn.net/qq_26664043"><font size="3"> 「码到三十五」</font></a> 
 <font color="#555bbbb" size="3"> ，同名公众号 :「码到三十五」，wx号 : 「liwu0213」 </font> 
 <br> 
 <font color="#c09008" size="3"><strong>☠博主专栏 ：</strong></font> 
 <a href="https://blog.csdn.net/qq_26664043/category_12712562.html" size="6"><font color="#555bbbb" size="3"> &lt;mysql高手&gt; </font></a> 
 <a href="https://blog.csdn.net/qq_26664043/category_12712557.html" size="6"><font color="#555bbbb" size="3"> &lt;elasticsearch高手&gt; </font></a> 
 <a href="https://blog.csdn.net/qq_26664043/category_12376895.html" size="6"><font color="#555bbbb" size="3"> &lt;源码解读&gt; </font></a> 
 <a href="https://blog.csdn.net/qq_26664043/category_12587226.html" size="6"><font color="#555bbbb" size="3"> &lt;java核心&gt; </font></a> 
 <a href="https://blog.csdn.net/qq_26664043/category_12588169.html" size="6"><font color="#555bbbb" size="3"> &lt;面试攻关&gt; </font></a> 
 <br> 
 <font color="#c09008" size="3"><strong>♝博主的话 ：</strong></font> 
 <font color="#555bbbb" size="3">搬的每块砖，皆为峰峦之基；公众号搜索「码到三十五」关注这个爱发技术干货的coder，一起筑基 </font> 
</div> 
<hr> 
<p>分布式系统中，分布式锁是一种常用的同步机制，通过MongoDB提供的<code>findAndModify</code>原子操作，可以有效地实现分布式锁的功能。</p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#MongoDB_21" rel="nofollow">一、MongoDB的锁机制</a></li><li><a href="#_27" rel="nofollow">二、分布式锁的需求</a></li><li><a href="#MongoDB_36" rel="nofollow">三、基于MongoDB的分布式锁实现原理</a></li><li><ul><li><a href="#1__38" rel="nofollow">1. 锁集合的创建</a></li><li><a href="#2__42" rel="nofollow">2. 尝试获取锁</a></li><li><a href="#3__51" rel="nofollow">3. 锁的重入和超时</a></li><li><a href="#4__56" rel="nofollow">4. 释放锁</a></li><li><a href="#MongoDB_findAndModify_68" rel="nofollow">MongoDB findAndModify原理</a></li></ul> 
   </li><li><a href="#Spring_Boot_80" rel="nofollow">四、Spring Boot中简单实现</a></li><li><ul><li><ul><li><a href="#1__82" rel="nofollow">1. 定义锁文档</a></li><li><a href="#2__99" rel="nofollow">2. 实现锁服务</a></li><li><a href="#3__142" rel="nofollow">3. 使用锁服务</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_145" rel="nofollow">五、注意</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="MongoDB_21"></a>一、MongoDB的锁机制</h3> 
<p>MongoDB的锁机制主要用于保护数据的一致性和正确性。当多个客户端同时对同一文档进行操作时，MongoDB通过锁机制来确保每个操作的顺序和结果都是正确的。锁机制通过对文档进行加锁来实现，包括读锁和写锁。读锁允许多个客户端同时读取文档，但写锁则是互斥的，即同一时间只能有一个客户端持有写锁。</p> 
<p><code>findAndModify</code>是MongoDB提供的一个非常强大的命令，它允许你同时执行查询和更新操作，并且这个操作是原子的。这意味着在<code>findAndModify</code>执行期间，没有其他客户端可以修改被查询的文档，直到该命令完成。这个特性使其成为实现分布式锁的理想选择。</p> 
<h3><a id="_27"></a>二、分布式锁的需求</h3> 
<p>在分布式系统中，分布式锁需要满足以下几个基本要求：</p> 
<ol><li><strong>互斥性</strong>：在任意时刻，只有一个客户端能够持有锁。</li><li><strong>不会死锁</strong>：客户端在持有锁期间如果崩溃或断开连接，锁必须能够被释放，以防止死锁。</li><li><strong>容错性</strong>：在分布式环境下，部分节点或网络故障不应影响锁的正常工作。</li><li><strong>高性能</strong>：锁的获取和释放操作应该尽可能快，以减少对系统性能的影响。</li></ol> 
<h3><a id="MongoDB_36"></a>三、基于MongoDB的分布式锁实现原理</h3> 
<h4><a id="1__38"></a>1. 锁集合的创建</h4> 
<p>首先，在MongoDB中创建一个专门的集合（如<code>locks</code>）来存储锁信息。每个锁由一个文档表示，文档中包含了锁的关键信息，如锁名（<code>lockName</code>）、持有者（<code>holder</code>）、锁定时间（<code>lockedAt</code>）、过期时间（<code>expiresAt</code>）等。</p> 
<h4><a id="2__42"></a>2. 尝试获取锁</h4> 
<p>当客户端需要获取锁时，它执行以下步骤：</p> 
<ul><li>使用<code>findAndModify</code>命令查询<code>locks</code>集合中的对应锁文档。</li><li>查询条件包括锁名和当前持有者为空（表示锁未被占用）且当前时间小于过期时间（如果存在过期时间字段）。</li><li>更新操作设置持有者为当前客户端的标识，设置锁定时间，并可选地设置过期时间。</li><li>如果<code>findAndModify</code>命令成功更新了文档，则表示客户端成功获取了锁；如果更新失败（因为其他客户端已经设置了持有者或已过期时间已过），则表示锁已被占用或已过期。</li></ul> 
<h4><a id="3__51"></a>3. 锁的重入和超时</h4> 
<ul><li><strong>重入性</strong>：可以通过在文档中增加一个重入计数器来实现锁的重入性。当客户端尝试重新获取已被自己持有的锁时，重入计数器增加。</li><li><strong>超时机制</strong>：设置过期时间（<code>expiresAt</code>）来防止客户端在持有锁期间崩溃而无法释放锁。当过期时间到达时，其他客户端可以清除该锁（通过检查并更新<code>expiresAt</code>和<code>holder</code>字段）。</li></ul> 
<h4><a id="4__56"></a>4. 释放锁</h4> 
<p>当客户端完成操作后，它执行以下步骤来释放锁：</p> 
<ul><li>再次使用<code>findAndModify</code>命令查询并更新<code>locks</code>集合中的对应锁文档。</li><li>更新操作将文档的持有者设置为空（或某个特定的释放标识），并可能更新锁定时间或重入计数器（如果实现了重入性）。</li><li>如果需要，还可以更新过期时间字段以清除过期的锁。</li></ul> 
<p>在分布式系统中，实现锁机制是一项关键任务，用于控制对共享资源的访问，防止数据不一致。MongoDB的<code>findAndModify</code>命令是一种强大的原子操作，可以用于实现简单的分布式锁。下面详细介绍其原理，并在Spring Boot环境中给出一个实现案例。</p> 
<h4><a id="MongoDB_findAndModify_68"></a>MongoDB findAndModify原理</h4> 
<p><code>findAndModify</code>是MongoDB中的一个命令，它用于查找并更新一个文档，这个操作是原子的，意味着在查找和更新文档期间，不会有其他操作可以修改这个文档。利用这个特性，我们可以创建一个简单的分布式锁：</p> 
<ol><li> <p><strong>锁定机制</strong>：</p> 
  <ul><li>在数据库中创建一个集合（例如<code>locks</code>），每个锁由一个文档表示。</li><li>每个文档包含锁的关键信息，如锁名（<code>lockName</code>）、持有者（<code>holder</code>）、锁定时间（<code>lockedAt</code>）等。</li><li>当需要锁定某个资源时，使用<code>findAndModify</code>尝试更新集合中的一个文档，设置<code>holder</code>和<code>lockedAt</code>。如果更新成功，则表示获得了锁；如果失败（例如，因为其他客户端已经设置了<code>holder</code>），则表示锁已被占用。</li></ul> </li><li> <p><strong>释放机制</strong>：</p> 
  <ul><li>持有锁的客户端在完成操作后，需要释放锁。这通常通过另一个<code>findAndModify</code>操作来完成，将文档的<code>holder</code>设置为<code>null</code>或某个特定的释放标识。</li></ul> </li></ol> 
<h3><a id="Spring_Boot_80"></a>四、Spring Boot中简单实现</h3> 
<p>Spring Boot中可以使用Spring Data MongoDB与MongoDB的交互。</p> 
<h5><a id="1__82"></a>1. 定义锁文档</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Id</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mapping<span class="token punctuation">.</span></span><span class="token class-name">Document</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Document</span><span class="token punctuation">(</span>collection <span class="token operator">=</span> <span class="token string">"locks"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lock</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> lockName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> holder<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> lockedAt<span class="token punctuation">;</span>

    <span class="token comment">// Getters and Setters</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2__99"></a>2. 实现锁服务</h5> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">FindAndModifyOptions</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">MongoTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">Criteria</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">Query</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>mongodb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>query<span class="token punctuation">.</span></span><span class="token class-name">Update</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LockService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MongoTemplate</span> mongoTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> lockName<span class="token punctuation">,</span> <span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        query<span class="token punctuation">.</span><span class="token function">addCriteria</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"lockName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>lockName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">"holder"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        update<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"holder"</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        update<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"lockedAt"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">FindAndModifyOptions</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FindAndModifyOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        options<span class="token punctuation">.</span><span class="token function">returnNew</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Lock</span> lock <span class="token operator">=</span> mongoTemplate<span class="token punctuation">.</span><span class="token function">findAndModify</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> update<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token class-name">Lock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> lock <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> lock<span class="token punctuation">.</span><span class="token function">getHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> lockName<span class="token punctuation">,</span> <span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        query<span class="token punctuation">.</span><span class="token function">addCriteria</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">"lockName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>lockName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">"holder"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Update</span> update <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        update<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"holder"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mongoTemplate<span class="token punctuation">.</span><span class="token function">findAndModify</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> update<span class="token punctuation">,</span> <span class="token class-name">Lock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3__142"></a>3. 使用锁服务</h5> 
<p>在服务层或控制器中，注入<code>LockService</code>并调用<code>tryLock</code>和<code>releaseLock</code>方法来控制对共享资源的访问。</p> 
<h3><a id="_145"></a>五、注意</h3> 
<ul><li><strong>锁的粒度</strong>：根据实际需求选择合适的锁粒度，避免过细或过粗的锁粒度导致的性能问题或资源竞争。</li><li><strong>锁的过期时间</strong>：合理设置锁的过期时间，以确保在客户端崩溃或其他异常情况下能够释放锁。</li><li><strong>网络延迟和分区</strong>：在分布式系统中，网络延迟和分区问题可能会导致<code>findAndModify</code>操作的延迟或失败。需要考虑这些因素对锁的性能和可靠性的影响。</li></ul> 
<hr> 
<center> 
 <font color="#c65a6c" size="4"> 关注公众号[码到三十五]获取更多技术干货 ! </font> 
</center> 
<p><img src="https://images2.imgbox.com/a3/24/aN6UGmBu_o.gif" alt=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/92de8c5a6b1b994f93ff787d693bc06f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于大数据爬虫&#43;数据可视化大屏&#43;Python的广东省人口流动数据分析设计和实现(源码&#43;论文&#43;部署文档等)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a83eef13a39a8aa65eb16d10e66a345f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">iOS UIColletionView实现header和footter</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>