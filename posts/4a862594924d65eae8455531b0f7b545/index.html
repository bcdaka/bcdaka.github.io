<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于STM32&#43;华为云IOT设计的智能冰箱(华为云IOT) - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/4a862594924d65eae8455531b0f7b545/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="基于STM32&#43;华为云IOT设计的智能冰箱(华为云IOT)">
  <meta property="og:description" content="文章目录 一、前言1.1 项目介绍【1】项目开发背景【2】设计实现的功能【3】项目硬件模块组成【4】摘要 1.2 设计思路1.3 系统功能总结1.4 开发工具的选择【1】设备端开发【2】上位机开发 二、部署华为云物联网平台2.1 物联网平台介绍2.2 开通物联网服务2.3 创建产品（1）创建产品（2）填写产品信息（3）产品创建成功（4）添加自定义模型 2.4 添加设备（1）注册设备（2）根据自己的设备填写（3）保存设备信息（4）设备创建完成（5）设备详情 2.5 MQTT协议主题订阅与发布（1）MQTT协议介绍（2）华为云平台MQTT协议使用限制（3）主题订阅格式（4）主题发布格式 2.6 MQTT三元组（1）MQTT服务器地址（2）生成MQTT三元组 2.7 模拟设备登录测试（1）填入登录信息（2）打开网页查看（3）MQTT登录测试参数总结 2.8 创建IAM账户2.9 获取影子数据 三、STM32设备端代码设计3.1 RTC时钟配置代码3.2 SPI协议封装3.3 IIC协议封装3.4 ADC代码封装3.5 串口配置代码 四、上位机开发4.1 Qt开发环境安装4.2 新建上位机工程4.3 设计UI界面与工程配置【1】打开UI文件【2】开始设计界面 4.5 编译Windows上位机4.6 配置Android环境【1】选择Android编译器【2】创建Android配置文件【3】配置Android图标与名称【3】编译Android上位机 五、总结 一、前言 1.1 项目介绍 【1】项目开发背景 在当今智能化和物联网技术高速发展的时代背景下，传统家电的智能化改造成为家电行业转型升级的重要趋势。智能冰箱作为智能家居系统的重要组成部分，其智能化程度的提升不仅能够为用户带来更加便捷、舒适的生活体验，还能有效提升冰箱的使用效率和安全性。基于这一背景，设计了一款基于华为云IOT物联网平台的智能冰箱系统。
本项目通过集成先进的传感器技术、无线通信技术以及智能控制算法，实现对冰箱内部环境的全方位监测和智能控制。系统支持对冷藏区、保鲜区、冷冻区三个区域的温度和湿度进行实时监测，并配备有害气体传感器以分析霉菌含量，确保食品存储环境的安全卫生。同时，通过OLED显示屏，用户能够直观地了解冰箱内部的环境状态。
为了实现数据的远程监测和控制，系统支持WIFI上云功能，将采集到的数据实时上传至华为云物联网云平台。通过Qt(C&#43;&#43;)设计的手机APP，用户可以随时随地调用华为云IOT的API接口，获取冰箱上传的数据，实现对冰箱运行状态的远程监控。此外，用户还可以通过手机APP远程设置冰箱各区域的温度，实现个性化的温度控制。
在智能控制方面，系统具备自动降温处理功能。当冰箱内部温度超过设定的阈值时，系统会自动启动制冷泵进行降温处理，并通过手机APP发出红色字体报警和本地蜂鸣器声音报警，提醒用户注意。此外，保鲜区还配备了紫外线消毒灯，用户可以根据需要开启消毒功能，对冰箱内部进行杀菌消毒，保障食品的安全存储。
本项目的开发不仅体现了智能家居技术在家电领域的应用价值，也为冰箱行业的智能化升级提供了新的解决方案。通过本项目的实施，将为用户提供更加智能化、安全化、舒适化的生活体验，推动智能家居产业的持续发展。
【2】设计实现的功能 （1）多区域精确温湿度控制与监测：冰箱被划分为冷藏区、保鲜区、冷冻区三个独立区域，每个区域均配置有SHT30温湿度传感器，能够实时监测并显示当前温度与湿度。用户可通过手机APP远程设定各区域的理想温湿度范围，系统将自动调节以维持最佳储存条件。
（2）有害气体及霉菌含量监测：通过集成的ADC模拟量采集输出的有害气体传感器，系统能够分析冷藏室内是否存在过量的有害气体及霉菌，及时预警，保护食品免受污染，保障用户健康。
（3）实时数据展示与远程监控：冰箱门上的0.96寸OLED显示屏实时展示当前的温湿度信息及系统状态，同时，这些数据会通过ESP8266-WIFI模块上传至华为云IoT物联网平台。用户通过专门设计的Qt(C&#43;&#43;)手机APP，可以随时随地查看冰箱状态，实现远程监控。
（4）智能警报与应急处理：若冰箱内温度超过用户预设的阈值，系统将自动启动降温程序，并通过手机APP推送警告信息，APP界面字体变红以示警急。同时，冰箱内置的高电平触发蜂鸣器会发出声音报警，确保问题得到即时关注。
（5）紫外线消毒功能：针对保鲜区，设计有紫外线消毒灯，用户可通过APP远程控制开启，定期对冰箱内部进行消毒，有效杀灭细菌，保持储藏环境的卫生。
（6）灵活的电源管理与制冷控制：系统采用外部220V市电输入，经稳压模块转换为5V 2A直流电源，为所有组件稳定供电。制冷泵通过高可靠性的继电器控制，确保按需启动，节能高效。
（7）用户友好与个性化设置：手机APP提供直观易用的界面，用户可根据个人需求设定各区域的温度，查看历史数据，甚至接收食品保质期提醒，定制化服务让生活更加智能化。
【3】项目硬件模块组成 （1）主控单元：
STM32F103RCT6微控制器：作为整个系统的控制中心，负责处理传感器数据、执行逻辑判断、控制各个外设工作。该MCU具有高性能、低功耗的特点，支持丰富的外设接口，满足系统复杂控制需求。 （2）环境监测模块：
SHT30温湿度传感器：分别安装于冷藏区、保鲜区、冷冻区，用于精确测量各区域的温度和湿度，为温度控制和环境监测提供数据基础。有害气体传感器：通过ADC模拟量输出，监测冰箱内部可能存在的有害气体及霉菌含量，确保食品安全。 （3）显示与交互模块：
0.96寸OLED显示屏：采用SPI通讯协议，实时显示冰箱内部的温湿度信息、工作状态等，便于用户直观了解冰箱运行情况。 （4）无线通信模块：
ESP8266-WIFI模组：负责将冰箱内部采集的数据通过Wi-Fi网络上传至华为云IoT物联网平台，实现远程监控和数据交互。 （5）电源管理模块：
外部电源适配器：将220V交流电转换为适合电子设备使用的5V直流电。稳压电源模块：进一步稳定直流电压至5V 2A，为系统提供稳定可靠的电源供应。 （6）报警与指示模块：
高电平触发有源蜂鸣器：当冰箱温度超出设定范围时，主控单元控制蜂鸣器发出报警声，提醒用户注意。 （7）控制执行模块：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-26T09:57:23+08:00">
    <meta property="article:modified_time" content="2024-06-26T09:57:23+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于STM32&#43;华为云IOT设计的智能冰箱(华为云IOT)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_5" rel="nofollow">一、前言</a></li><li><ul><li><a href="#11__7" rel="nofollow">1.1 项目介绍</a></li><li><ul><li><a href="#1_9" rel="nofollow">【1】项目开发背景</a></li><li><a href="#2_29" rel="nofollow">【2】设计实现的功能</a></li><li><a href="#3_47" rel="nofollow">【3】项目硬件模块组成</a></li><li><a href="#4_82" rel="nofollow">【4】摘要</a></li></ul> 
   </li><li><a href="#12__88" rel="nofollow">1.2 设计思路</a></li><li><a href="#13__106" rel="nofollow">1.3 系统功能总结</a></li><li><a href="#14__123" rel="nofollow">1.4 开发工具的选择</a></li><li><ul><li><a href="#1_125" rel="nofollow">【1】设备端开发</a></li><li><a href="#2_135" rel="nofollow">【2】上位机开发</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_151" rel="nofollow">二、部署华为云物联网平台</a></li><li><ul><li><a href="#21__161" rel="nofollow">2.1 物联网平台介绍</a></li><li><a href="#22__179" rel="nofollow">2.2 开通物联网服务</a></li><li><a href="#23__256" rel="nofollow">2.3 创建产品</a></li><li><ul><li><a href="#1_258" rel="nofollow">（1）创建产品</a></li><li><a href="#2_264" rel="nofollow">（2）填写产品信息</a></li><li><a href="#3_272" rel="nofollow">（3）产品创建成功</a></li><li><a href="#4_284" rel="nofollow">（4）添加自定义模型</a></li></ul> 
   </li><li><a href="#24__330" rel="nofollow">2.4 添加设备</a></li><li><ul><li><a href="#1_334" rel="nofollow">（1）注册设备</a></li><li><a href="#2_340" rel="nofollow">（2）根据自己的设备填写</a></li><li><a href="#3_346" rel="nofollow">（3）保存设备信息</a></li><li><a href="#4_356" rel="nofollow">（4）设备创建完成</a></li><li><a href="#5_364" rel="nofollow">（5）设备详情</a></li></ul> 
   </li><li><a href="#25_MQTT_380" rel="nofollow">2.5 MQTT协议主题订阅与发布</a></li><li><ul><li><a href="#1MQTT_382" rel="nofollow">（1）MQTT协议介绍</a></li><li><a href="#2MQTT_402" rel="nofollow">（2）华为云平台MQTT协议使用限制</a></li><li><a href="#3_420" rel="nofollow">（3）主题订阅格式</a></li><li><a href="#4_442" rel="nofollow">（4）主题发布格式</a></li></ul> 
   </li><li><a href="#26_MQTT_488" rel="nofollow">2.6 MQTT三元组</a></li><li><ul><li><a href="#1MQTT_496" rel="nofollow">（1）MQTT服务器地址</a></li><li><a href="#2MQTT_529" rel="nofollow">（2）生成MQTT三元组</a></li></ul> 
   </li><li><a href="#27__561" rel="nofollow">2.7 模拟设备登录测试</a></li><li><ul><li><a href="#1_565" rel="nofollow">（1）填入登录信息</a></li><li><a href="#2_575" rel="nofollow">（2）打开网页查看</a></li><li><a href="#3MQTT_593" rel="nofollow">（3）MQTT登录测试参数总结</a></li></ul> 
   </li><li><a href="#28_IAM_616" rel="nofollow">2.8 创建IAM账户</a></li><li><a href="#29__704" rel="nofollow">2.9 获取影子数据</a></li></ul> 
  </li><li><a href="#STM32_786" rel="nofollow">三、STM32设备端代码设计</a></li><li><ul><li><a href="#31_RTC_788" rel="nofollow">3.1 RTC时钟配置代码</a></li><li><a href="#32_SPI_1041" rel="nofollow">3.2 SPI协议封装</a></li><li><a href="#33_IIC_1152" rel="nofollow">3.3 IIC协议封装</a></li><li><a href="#34_ADC_1275" rel="nofollow">3.4 ADC代码封装</a></li><li><a href="#35__1414" rel="nofollow">3.5 串口配置代码</a></li></ul> 
  </li><li><a href="#_1516" rel="nofollow">四、上位机开发</a></li><li><ul><li><a href="#41_Qt_1522" rel="nofollow">4.1 Qt开发环境安装</a></li><li><a href="#42__1562" rel="nofollow">4.2 新建上位机工程</a></li><li><a href="#43_UI_1616" rel="nofollow">4.3 设计UI界面与工程配置</a></li><li><ul><li><a href="#1UI_1618" rel="nofollow">【1】打开UI文件</a></li><li><a href="#2_1632" rel="nofollow">【2】开始设计界面</a></li></ul> 
   </li><li><a href="#45_Windows_1642" rel="nofollow">4.5 编译Windows上位机</a></li><li><a href="#46_Android_1658" rel="nofollow">4.6 配置Android环境</a></li><li><ul><li><a href="#1Android_1668" rel="nofollow">【1】选择Android编译器</a></li><li><a href="#2Android_1678" rel="nofollow">【2】创建Android配置文件</a></li><li><a href="#3Android_1696" rel="nofollow">【3】配置Android图标与名称</a></li><li><a href="#3Android_1702" rel="nofollow">【3】编译Android上位机</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_1730" rel="nofollow">五、总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_5"></a>一、前言</h2> 
<h3><a id="11__7"></a>1.1 项目介绍</h3> 
<h4><a id="1_9"></a>【1】项目开发背景</h4> 
<p>在当今智能化和物联网技术高速发展的时代背景下，传统家电的智能化改造成为家电行业转型升级的重要趋势。智能冰箱作为智能家居系统的重要组成部分，其智能化程度的提升不仅能够为用户带来更加便捷、舒适的生活体验，还能有效提升冰箱的使用效率和安全性。基于这一背景，设计了一款基于华为云IOT物联网平台的智能冰箱系统。</p> 
<p>本项目通过集成先进的传感器技术、无线通信技术以及智能控制算法，实现对冰箱内部环境的全方位监测和智能控制。系统支持对冷藏区、保鲜区、冷冻区三个区域的温度和湿度进行实时监测，并配备有害气体传感器以分析霉菌含量，确保食品存储环境的安全卫生。同时，通过OLED显示屏，用户能够直观地了解冰箱内部的环境状态。</p> 
<p>为了实现数据的远程监测和控制，系统支持WIFI上云功能，将采集到的数据实时上传至华为云物联网云平台。通过Qt(C++)设计的手机APP，用户可以随时随地调用华为云IOT的API接口，获取冰箱上传的数据，实现对冰箱运行状态的远程监控。此外，用户还可以通过手机APP远程设置冰箱各区域的温度，实现个性化的温度控制。</p> 
<p>在智能控制方面，系统具备自动降温处理功能。当冰箱内部温度超过设定的阈值时，系统会自动启动制冷泵进行降温处理，并通过手机APP发出红色字体报警和本地蜂鸣器声音报警，提醒用户注意。此外，保鲜区还配备了紫外线消毒灯，用户可以根据需要开启消毒功能，对冰箱内部进行杀菌消毒，保障食品的安全存储。</p> 
<p>本项目的开发不仅体现了智能家居技术在家电领域的应用价值，也为冰箱行业的智能化升级提供了新的解决方案。通过本项目的实施，将为用户提供更加智能化、安全化、舒适化的生活体验，推动智能家居产业的持续发展。</p> 
<p><img src="https://images2.imgbox.com/03/81/RhWi86AV_o.png" alt="image-20240620142513934"></p> 
<p><img src="https://images2.imgbox.com/1d/97/aoINdcbe_o.png" alt="image-20240620142215917"></p> 
<h4><a id="2_29"></a>【2】设计实现的功能</h4> 
<p>（1）<strong>多区域精确温湿度控制与监测</strong>：冰箱被划分为冷藏区、保鲜区、冷冻区三个独立区域，每个区域均配置有SHT30温湿度传感器，能够实时监测并显示当前温度与湿度。用户可通过手机APP远程设定各区域的理想温湿度范围，系统将自动调节以维持最佳储存条件。</p> 
<p>（2）<strong>有害气体及霉菌含量监测</strong>：通过集成的ADC模拟量采集输出的有害气体传感器，系统能够分析冷藏室内是否存在过量的有害气体及霉菌，及时预警，保护食品免受污染，保障用户健康。</p> 
<p>（3）<strong>实时数据展示与远程监控</strong>：冰箱门上的0.96寸OLED显示屏实时展示当前的温湿度信息及系统状态，同时，这些数据会通过ESP8266-WIFI模块上传至华为云IoT物联网平台。用户通过专门设计的Qt(C++)手机APP，可以随时随地查看冰箱状态，实现远程监控。</p> 
<p>（4）<strong>智能警报与应急处理</strong>：若冰箱内温度超过用户预设的阈值，系统将自动启动降温程序，并通过手机APP推送警告信息，APP界面字体变红以示警急。同时，冰箱内置的高电平触发蜂鸣器会发出声音报警，确保问题得到即时关注。</p> 
<p>（5）<strong>紫外线消毒功能</strong>：针对保鲜区，设计有紫外线消毒灯，用户可通过APP远程控制开启，定期对冰箱内部进行消毒，有效杀灭细菌，保持储藏环境的卫生。</p> 
<p>（6）<strong>灵活的电源管理与制冷控制</strong>：系统采用外部220V市电输入，经稳压模块转换为5V 2A直流电源，为所有组件稳定供电。制冷泵通过高可靠性的继电器控制，确保按需启动，节能高效。</p> 
<p>（7）<strong>用户友好与个性化设置</strong>：手机APP提供直观易用的界面，用户可根据个人需求设定各区域的温度，查看历史数据，甚至接收食品保质期提醒，定制化服务让生活更加智能化。</p> 
<h4><a id="3_47"></a>【3】项目硬件模块组成</h4> 
<p>（1）<strong>主控单元</strong>：</p> 
<ul><li><strong>STM32F103RCT6微控制器</strong>：作为整个系统的控制中心，负责处理传感器数据、执行逻辑判断、控制各个外设工作。该MCU具有高性能、低功耗的特点，支持丰富的外设接口，满足系统复杂控制需求。</li></ul> 
<p>（2）<strong>环境监测模块</strong>：</p> 
<ul><li><strong>SHT30温湿度传感器</strong>：分别安装于冷藏区、保鲜区、冷冻区，用于精确测量各区域的温度和湿度，为温度控制和环境监测提供数据基础。</li><li><strong>有害气体传感器</strong>：通过ADC模拟量输出，监测冰箱内部可能存在的有害气体及霉菌含量，确保食品安全。</li></ul> 
<p>（3）<strong>显示与交互模块</strong>：</p> 
<ul><li><strong>0.96寸OLED显示屏</strong>：采用SPI通讯协议，实时显示冰箱内部的温湿度信息、工作状态等，便于用户直观了解冰箱运行情况。</li></ul> 
<p>（4）<strong>无线通信模块</strong>：</p> 
<ul><li><strong>ESP8266-WIFI模组</strong>：负责将冰箱内部采集的数据通过Wi-Fi网络上传至华为云IoT物联网平台，实现远程监控和数据交互。</li></ul> 
<p>（5）<strong>电源管理模块</strong>：</p> 
<ul><li><strong>外部电源适配器</strong>：将220V交流电转换为适合电子设备使用的5V直流电。</li><li><strong>稳压电源模块</strong>：进一步稳定直流电压至5V 2A，为系统提供稳定可靠的电源供应。</li></ul> 
<p>（6）<strong>报警与指示模块</strong>：</p> 
<ul><li><strong>高电平触发有源蜂鸣器</strong>：当冰箱温度超出设定范围时，主控单元控制蜂鸣器发出报警声，提醒用户注意。</li></ul> 
<p>（7）<strong>控制执行模块</strong>：</p> 
<ul><li><strong>继电器模块</strong>：用于控制制冷泵的开关，根据主控单元的指令自动调节制冷系统的工作状态。</li><li><strong>紫外线消毒灯控制电路</strong>：通过高低电平信号控制紫外线消毒灯的开闭，实现远程或定时消毒功能。</li></ul> 
<h4><a id="4_82"></a>【4】摘要</h4> 
<p>本项目设计并实现一款基于华为云IoT物联网平台的智能冰箱系统，通过集成先进的传感技术、无线通信技术和云端服务，显著提升家庭食品存储的智能化水平。系统采用STM32F103RCT6作为主控芯片，结合SHT30温湿度传感器、有害气体传感器等，实现对冰箱冷藏区、保鲜区、冷冻区的环境参数实时监测与调控。利用ESP8266-WiFi模块，将数据上传至华为云平台，用户可通过Qt(C++)开发的手机APP远程监控冰箱状态、调整设置并接收异常报警。此外，系统还配备了紫外线消毒灯进行定期消毒，以及温度超标时的自动降温处理与本地蜂鸣器报警功能，全方位保障食品新鲜与安全。本项目展现了智能家居领域的最新进展，为用户带来更加健康、便捷的生活体验。</p> 
<p><strong>关键字</strong>：智能冰箱、华为云IoT、STM32、温湿度传感器、有害气体监测、WiFi通信、Qt手机APP、紫外线消毒、远程控制、智能报警。</p> 
<h3><a id="12__88"></a>1.2 设计思路</h3> 
<p>（1）<strong>需求分析与功能定义</strong>：明确项目目标，基于市场调研与用户需求分析，确定冰箱系统应具备的智能监测、远程控制、自动报警、健康消毒等功能模块。明确各区域（冷藏、保鲜、冷冻）的具体要求，如温湿度控制精度、有害物质检测标准等。</p> 
<p>（2）<strong>系统架构设计</strong>：设计一个分层的系统架构，底层为硬件控制层，包括主控单元（STM32）、传感器网络、执行器（继电器、蜂鸣器、紫外线灯）等；中间层为数据处理与逻辑控制层，负责数据采集、处理与决策；上层为云服务与用户交互层，通过华为云IoT平台实现数据上传、远程控制及APP交互。</p> 
<p>（3）<strong>硬件选型与模块集成</strong>：根据功能需求选择合适的硬件组件，如选用性能稳定的STM32F103RCT6作为主控芯片，SHT30以实现高精度温湿度监测，ESP8266-WiFi模块保证稳定的数据传输，以及OLED显示屏和手机APP提高用户交互体验。设计合理的电路布局，确保各模块间高效协同工作。</p> 
<p>（4）<strong>软件开发与算法设计</strong>：开发嵌入式软件，编写驱动程序以控制硬件运作，设计数据处理算法，实现数据的有效过滤、分析与存储。开发手机APP，利用Qt框架实现用户友好的界面设计，调用华为云IoT API，实现远程监控、设置调整和报警通知功能。</p> 
<p>（5）<strong>云端服务对接与数据安全</strong>：与华为云IoT平台对接，设计云端数据处理流程，包括数据接收、存储、分析与反馈。重视数据加密与用户隐私保护，确保数据传输过程中的安全性和私密性。</p> 
<p>（6）<strong>测试与优化</strong>：进行全面的系统测试，包括硬件兼容性测试、功能验证、稳定性测试以及用户体验测试。根据测试结果进行必要的软硬件优化，确保系统稳定可靠，满足用户需求。</p> 
<p>（7）<strong>用户反馈与持续迭代</strong>：项目完成后，收集用户反馈，对系统进行持续的维护与升级，引入新功能或优化现有功能，以适应不断变化的市场需求和技术进步。</p> 
<h3><a id="13__106"></a>1.3 系统功能总结</h3> 
<table><thead><tr><th>功能分类</th><th>具体功能描述</th></tr></thead><tbody><tr><td>环境监测</td><td>- 实时监测冷藏区、保鲜区、冷冻区的温度与湿度<br>- 分析检测区域内有害气体及霉菌含量</td></tr><tr><td>数据展示</td><td>- OLED显示屏实时显示各区域温湿度数据及系统状态<br>- 手机APP远程查看冰箱监测数据</td></tr><tr><td>远程控制</td><td>- 通过手机APP远程设置各区域理想温度<br>- 开启/关闭紫外线消毒灯进行消毒处理</td></tr><tr><td>智能调节</td><td>- 自动调节温度，当实际温度偏离设定值时启动降温处理</td></tr><tr><td>报警提示</td><td>- 温度过高时，手机APP显示红色预警，冰箱本地蜂鸣器报警</td></tr><tr><td>云端互联</td><td>- 通过ESP8266-WiFi模块将数据上传至华为云IoT平台<br>- 实现远程数据访问与管理</td></tr><tr><td>电源与安全</td><td>- 稳定的电源管理系统，220V转5V直流供电<br>- 数据传输加密，保障用户隐私安全</td></tr><tr><td>健康管理</td><td>- 定期紫外线消毒，减少细菌滋生，保障食品安全与健康</td></tr><tr><td>用户交互</td><td>- Qt(C++)开发的手机APP，界面友好，操作便捷</td></tr><tr><td>系统兼容性</td><td>- 硬件模块间高度兼容，支持后续扩展与升级</td></tr></tbody></table> 
<h3><a id="14__123"></a>1.4 开发工具的选择</h3> 
<h4><a id="1_125"></a>【1】设备端开发</h4> 
<p>STM32的编程语言选择C语言，C语言执行效率高，大学里主学的C语言，C语言编译出来的可执行文件最接近于机器码，汇编语言执行效率最高，但是汇编的移植性比较差，目前在一些操作系统内核里还有一些低配的单片机使用的较多，平常的单片机编程还是以C语言为主。C语言的执行效率仅次于汇编，语法理解简单、代码通用性强，也支持跨平台，在嵌入式底层、单片机编程里用的非常多，当前的设计就是采用C语言开发。</p> 
<p>开发工具选择Keil，keil是一家世界领先的嵌入式微控制器软件开发商，在2015年，keil被ARM公司收购。因为当前芯片选择的是STM32F103系列，STMF103是属于ARM公司的芯片构架、Cortex-M3内核系列的芯片，所以使用Kile来开发STM32是有先天优势的，而keil在各大高校使用的也非常多，很多教科书里都是以keil来教学，开发51单片机、STM32单片机等等。目前作为MCU芯片开发的软件也不只是keil一家独大，IAR在MCU微处理器开发领域里也使用的非常多，IAR扩展性更强，也支持STM32开发，也支持其他芯片，比如：CC2530,51单片机的开发。从软件的使用上来讲，IAR比keil更加简洁，功能相对少一些。如果之前使用过keil，而且使用频率较多，已经习惯再使用IAR是有点不适应界面的。</p> 
<p><img src="https://images2.imgbox.com/b8/3d/eRbNYD3M_o.png" alt="image-20221210225339928"></p> 
<h4><a id="2_135"></a>【2】上位机开发</h4> 
<p>上位机的开发选择Qt框架，编程语言采用C++；Qt是一个1991年由Qt Company开发的跨平台C++图形用户界面应用程序开发框架。它既可以开发GUI程序，也可用于开发非GUI程序，比如控制台工具和服务器。Qt是面向对象的框架，使用特殊的代码生成扩展（称为元对象编译器(Meta Object Compiler, moc)）以及一些宏，Qt很容易扩展，并且允许真正地组件编程。Qt能轻松创建具有原生C++性能的连接设备、用户界面（UI）和应用程序。它功能强大且结构紧凑，拥有直观的工具和库。</p> 
<p><img src="https://images2.imgbox.com/60/69/pZyNVmVX_o.png" alt="image-20230218001243591"></p> 
<p><img src="https://images2.imgbox.com/f9/da/VUOaUMVM_o.png" alt="image-20230218001219105"></p> 
<h2><a id="_151"></a>二、部署华为云物联网平台</h2> 
<p>华为云官网: https://www.huaweicloud.com/</p> 
<p>打开官网，搜索物联网，就能快速找到 <code>设备接入IoTDA</code>。</p> 
<p><img src="https://images2.imgbox.com/dc/57/5pgq7nUK_o.png" alt="image-20221204193824815"></p> 
<h3><a id="21__161"></a>2.1 物联网平台介绍</h3> 
<p>华为云物联网平台（IoT 设备接入云服务）提供海量设备的接入和管理能力，将物理设备联接到云，支撑设备数据采集上云和云端下发命令给设备进行远程控制，配合华为云其他产品，帮助我们快速构筑物联网解决方案。</p> 
<p>使用物联网平台构建一个完整的物联网解决方案主要包括3部分：物联网平台、业务应用和设备。</p> 
<p>物联网平台作为连接业务应用和设备的中间层，屏蔽了各种复杂的设备接口，实现设备的快速接入；同时提供强大的开放能力，支撑行业用户构建各种物联网解决方案。</p> 
<p>设备可以通过固网、2G/3G/4G/5G、NB-IoT、Wifi等多种网络接入物联网平台，并使用LWM2M/CoAP、MQTT、HTTPS协议将业务数据上报到平台，平台也可以将控制命令下发给设备。</p> 
<p>业务应用通过调用物联网平台提供的API，实现设备数据采集、命令下发、设备管理等业务场景。</p> 
<p><img src="https://images2.imgbox.com/26/23/QpsHeOJb_o.png" alt="img"></p> 
<h3><a id="22__179"></a>2.2 开通物联网服务</h3> 
<p>地址： https://www.huaweicloud.com/product/iothub.html</p> 
<p><img src="https://images2.imgbox.com/e5/57/bWpJZJz7_o.png" alt="image-20221204194233414"></p> 
<p>点击<code>立即创建</code>。</p> 
<p><img src="https://images2.imgbox.com/61/17/I6U1NIgS_o.png" alt="image-20240117134653452"></p> 
<p>正在创建标准版实例，需要等待片刻。</p> 
<p><img src="https://images2.imgbox.com/b0/eb/SsExqvaC_o.png" alt="image-20240117134729401"></p> 
<p><strong>创建完成之后，点击实例名称。 可以看到标准版实例的设备接入端口和地址。</strong></p> 
<p><img src="https://images2.imgbox.com/f8/c9/7TzN4nFx_o.png" alt="image-20240425180759670"></p> 
<p>在上面也能看到 免费单元的限制。</p> 
<p><img src="https://images2.imgbox.com/89/95/LC8XZbov_o.png" alt="image-20240425180817704"></p> 
<p>开通之后，点击<code>总览</code>，也能查看接入信息。 我们当前设备准备采用MQTT协议接入华为云平台，这里可以看到MQTT协议的地址和端口号等信息。</p> 
<p><img src="https://images2.imgbox.com/01/37/FfhO2fK9_o.png" alt="image-20240425180845461"></p> 
<p><strong>总结:</strong></p> 
<pre><code class="prism language-cpp">端口号：   <span class="token function">MQTT</span> <span class="token punctuation">(</span><span class="token number">1883</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token function">MQTTS</span> <span class="token punctuation">(</span><span class="token number">8883</span><span class="token punctuation">)</span>	
接入地址：ad635970a1<span class="token punctuation">.</span>st1<span class="token punctuation">.</span>iotda<span class="token operator">-</span>device<span class="token punctuation">.</span>cn<span class="token operator">-</span>north<span class="token operator">-</span><span class="token number">4.</span>myhuaweicloud<span class="token punctuation">.</span>com
</code></pre> 
<p>**根据域名地址得到IP地址信息: **</p> 
<p>打开Windows电脑的命令行控制台终端，使用<code>ping</code> 命令。<code>ping</code>一下即可。</p> 
<pre><code class="prism language-cpp">Microsoft Windows <span class="token punctuation">[</span>版本 <span class="token number">10.0</span><span class="token punctuation">.</span><span class="token number">19045.4170</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span>c<span class="token punctuation">)</span> Microsoft Corporation。保留所有权利。

C<span class="token operator">:</span>\Users\<span class="token number">11266</span><span class="token operator">&gt;</span>ping ad635970a1<span class="token punctuation">.</span>st1<span class="token punctuation">.</span>iotda<span class="token operator">-</span>device<span class="token punctuation">.</span>cn<span class="token operator">-</span>north<span class="token operator">-</span><span class="token number">4.</span>myhuaweicloud<span class="token punctuation">.</span>com

正在 Ping ad635970a1<span class="token punctuation">.</span>st1<span class="token punctuation">.</span>iotda<span class="token operator">-</span>device<span class="token punctuation">.</span>cn<span class="token operator">-</span>north<span class="token operator">-</span><span class="token number">4.</span>myhuaweicloud<span class="token punctuation">.</span>com <span class="token punctuation">[</span><span class="token number">117.78</span><span class="token punctuation">.</span><span class="token number">5.125</span><span class="token punctuation">]</span> 具有 <span class="token number">32</span> 字节的数据<span class="token operator">:</span>
来自 <span class="token number">117.78</span><span class="token punctuation">.</span><span class="token number">5.125</span> 的回复<span class="token operator">:</span> 字节<span class="token operator">=</span><span class="token number">32</span> 时间<span class="token operator">=</span><span class="token number">35</span>ms TTL<span class="token operator">=</span><span class="token number">93</span>
来自 <span class="token number">117.78</span><span class="token punctuation">.</span><span class="token number">5.125</span> 的回复<span class="token operator">:</span> 字节<span class="token operator">=</span><span class="token number">32</span> 时间<span class="token operator">=</span><span class="token number">36</span>ms TTL<span class="token operator">=</span><span class="token number">93</span>
来自 <span class="token number">117.78</span><span class="token punctuation">.</span><span class="token number">5.125</span> 的回复<span class="token operator">:</span> 字节<span class="token operator">=</span><span class="token number">32</span> 时间<span class="token operator">=</span><span class="token number">36</span>ms TTL<span class="token operator">=</span><span class="token number">93</span>
来自 <span class="token number">117.78</span><span class="token punctuation">.</span><span class="token number">5.125</span> 的回复<span class="token operator">:</span> 字节<span class="token operator">=</span><span class="token number">32</span> 时间<span class="token operator">=</span><span class="token number">39</span>ms TTL<span class="token operator">=</span><span class="token number">93</span>

<span class="token number">117.78</span><span class="token punctuation">.</span><span class="token number">5.125</span> 的 Ping 统计信息<span class="token operator">:</span>
    数据包<span class="token operator">:</span> 已发送 <span class="token operator">=</span> <span class="token number">4</span>，已接收 <span class="token operator">=</span> <span class="token number">4</span>，丢失 <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">%</span> 丢失<span class="token punctuation">)</span>，
往返行程的估计时间<span class="token punctuation">(</span>以毫秒为单位<span class="token punctuation">)</span><span class="token operator">:</span>
    最短 <span class="token operator">=</span> <span class="token number">35</span>ms，最长 <span class="token operator">=</span> <span class="token number">39</span>ms，平均 <span class="token operator">=</span> <span class="token number">36</span>ms

C<span class="token operator">:</span>\Users\<span class="token number">11266</span><span class="token operator">&gt;</span>
</code></pre> 
<p>MQTT协议接入端口号有两个，1883是非加密端口，8883是证书加密端口，单片机无法加载证书，所以使用1883端口比较合适。 接下来的ESP8266就采用1883端口连接华为云物联网平台。</p> 
<h3><a id="23__256"></a>2.3 创建产品</h3> 
<h4><a id="1_258"></a>（1）创建产品</h4> 
<p><img src="https://images2.imgbox.com/3f/75/WCkBCmsD_o.png" alt="image-20230109164412041"></p> 
<h4><a id="2_264"></a>（2）填写产品信息</h4> 
<p>根据自己产品名字填写，下面的设备类型选择自定义类型。</p> 
<p><img src="https://images2.imgbox.com/29/bb/Qz8wiYp5_o.png" alt="image-20240612094809689"></p> 
<h4><a id="3_272"></a>（3）产品创建成功</h4> 
<p><img src="https://images2.imgbox.com/06/a3/utxKepyV_o.png" alt="image-20240612095148945"></p> 
<p>创建完成之后点击查看详情。</p> 
<p><img src="https://images2.imgbox.com/b6/de/jOYIkFxF_o.png" alt="image-20240612095134263"></p> 
<h4><a id="4_284"></a>（4）添加自定义模型</h4> 
<p>产品创建完成之后，点击进入产品详情页面，翻到最下面可以看到模型定义。</p> 
<p>模型简单来说： 就是存放设备上传到云平台的数据。</p> 
<p>你可以根据自己的产品进行创建。</p> 
<p>比如：</p> 
<pre><code class="prism language-cpp">烟雾可以叫  MQ2
温度可以叫  Temperature
湿度可以叫  humidity
火焰可以叫  flame
其他的传感器自己用单词简写命名即可。 这就是你的单片机设备端上传到服务器的数据名字。
</code></pre> 
<p>先点击自定义模型。</p> 
<p><img src="https://images2.imgbox.com/e5/d9/XFS4Y0Tr_o.png" alt="image-20240612095517900"></p> 
<p>再创建一个服务ID。</p> 
<p><img src="https://images2.imgbox.com/20/39/zNJNdkse_o.png" alt="image-20240612095542749"></p> 
<p>接着点击新增属性。</p> 
<p><img src="https://images2.imgbox.com/f0/be/ZMJZr5S2_o.png" alt="image-20240612095648815"></p> 
<p><img src="https://images2.imgbox.com/b7/db/dEfSQGg5_o.png" alt="image-20240612095711898"></p> 
<h3><a id="24__330"></a>2.4 添加设备</h3> 
<p>产品是属于上层的抽象模型，接下来在产品模型下添加实际的设备。添加的设备最终需要与真实的设备关联在一起，完成数据交互。</p> 
<h4><a id="1_334"></a>（1）注册设备</h4> 
<p><img src="https://images2.imgbox.com/a3/0f/HdN1y5c5_o.png" alt="image-20240425181935561"></p> 
<h4><a id="2_340"></a>（2）根据自己的设备填写</h4> 
<p><img src="https://images2.imgbox.com/9a/ec/lQC4TtJ2_o.png" alt="image-20240612100115167"></p> 
<h4><a id="3_346"></a>（3）保存设备信息</h4> 
<p>创建完毕之后，点击保存并关闭，得到创建的设备密匙信息。该信息在后续生成MQTT三元组的时候需要使用。</p> 
<p><img src="https://images2.imgbox.com/6d/c3/66eIxA5K_o.png" alt="image-20240612100128061"></p> 
<h4><a id="4_356"></a>（4）设备创建完成</h4> 
<p><img src="https://images2.imgbox.com/18/2d/6gWaTLyY_o.png" alt="image-20240612100147232"></p> 
<h4><a id="5_364"></a>（5）设备详情</h4> 
<p><img src="https://images2.imgbox.com/76/36/SQwg6Sop_o.png" alt="image-20240612100202960"></p> 
<p><img src="https://images2.imgbox.com/5a/03/Kb4XUCkN_o.png" alt="image-20240612100217236"></p> 
<h3><a id="25_MQTT_380"></a>2.5 MQTT协议主题订阅与发布</h3> 
<h4><a id="1MQTT_382"></a>（1）MQTT协议介绍</h4> 
<p>当前的设备是采用MQTT协议与华为云平台进行通信。</p> 
<p>MQTT是一个物联网传输协议，它被设计用于轻量级的发布/订阅式消息传输，旨在为低带宽和不稳定的网络环境中的物联网设备提供可靠的网络服务。MQTT是专门针对物联网开发的轻量级传输协议。MQTT协议针对低带宽网络，低计算能力的设备，做了特殊的优化，使得其能适应各种物联网应用场景。目前MQTT拥有各种平台和设备上的客户端，已经形成了初步的生态系统。</p> 
<p>MQTT是一种消息队列协议，使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合，相对于其他协议，开发更简单；MQTT协议是工作在TCP/IP协议上；由TCP/IP协议提供稳定的网络连接；所以，只要具备TCP协议栈的网络设备都可以使用MQTT协议。 本次设备采用的ESP8266就具备TCP协议栈，能够建立TCP连接，所以，配合STM32代码里封装的MQTT协议，就可以与华为云平台完成通信。</p> 
<p>华为云的MQTT协议接入帮助文档在这里: https://support.huaweicloud.com/devg-iothub/iot_02_2200.html</p> 
<p><img src="https://images2.imgbox.com/67/09/2i4FvLUu_o.png" alt="img"></p> 
<p><strong>业务流程：</strong></p> 
<p><img src="https://images2.imgbox.com/0d/66/g6Xnsr9j_o.png" alt="img"></p> 
<h4><a id="2MQTT_402"></a>（2）华为云平台MQTT协议使用限制</h4> 
<table><thead><tr><th>描述</th><th>限制</th></tr></thead><tbody><tr><td>支持的MQTT协议版本</td><td>3.1.1</td></tr><tr><td>与标准MQTT协议的区别</td><td>支持Qos 0和Qos 1支持Topic自定义不支持QoS2不支持will、retain msg</td></tr><tr><td>MQTTS支持的安全等级</td><td>采用TCP通道基础 + TLS协议（最高TLSv1.3版本）</td></tr><tr><td>单帐号每秒最大MQTT连接请求数</td><td>无限制</td></tr><tr><td>单个设备每分钟支持的最大MQTT连接数</td><td>1</td></tr><tr><td>单个MQTT连接每秒的吞吐量，即带宽，包含直连设备和网关</td><td>3KB/s</td></tr><tr><td>MQTT单个发布消息最大长度，超过此大小的发布请求将被直接拒绝</td><td>1MB</td></tr><tr><td>MQTT连接心跳时间建议值</td><td>心跳时间限定为30至1200秒，推荐设置为120秒</td></tr><tr><td>产品是否支持自定义Topic</td><td>支持</td></tr><tr><td>消息发布与订阅</td><td>设备只能对自己的Topic进行消息发布与订阅</td></tr><tr><td>每个订阅请求的最大订阅数</td><td>无限制</td></tr></tbody></table> 
<h4><a id="3_420"></a>（3）主题订阅格式</h4> 
<p>帮助文档地址：https://support.huaweicloud.com/devg-iothub/iot_02_2200.html</p> 
<p><img src="https://images2.imgbox.com/63/e2/cwRVCNUi_o.png" alt="image-20221207153310037"></p> 
<p>对于设备而言，一般会订阅平台下发消息给设备 这个主题。</p> 
<p>设备想接收平台下发的消息，就需要订阅平台下发消息给设备 的主题，订阅后，平台下发消息给设备，设备就会收到消息。</p> 
<p>如果设备想要知道平台下发的消息，需要订阅上面图片里标注的主题。</p> 
<pre><code class="prism language-cpp">以当前设备为例，最终订阅主题的格式如下<span class="token operator">:</span>
$oc<span class="token operator">/</span>devices<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>device_id<span class="token punctuation">}</span><span class="token operator">/</span>sys<span class="token operator">/</span>messages<span class="token operator">/</span>down
    
最终的格式<span class="token operator">:</span>
$oc<span class="token operator">/</span>devices<span class="token operator">/</span><span class="token number">663</span>cb18871d845632a0912e7_dev1<span class="token operator">/</span>sys<span class="token operator">/</span>messages<span class="token operator">/</span>down
</code></pre> 
<h4><a id="4_442"></a>（4）主题发布格式</h4> 
<p>对于设备来说，主题发布表示向云平台上传数据，将最新的传感器数据，设备状态上传到云平台。</p> 
<p>这个操作称为：属性上报。</p> 
<p>帮助文档地址：https://support.huaweicloud.com/usermanual-iothub/iot_06_v5_3010.html</p> 
<p><img src="https://images2.imgbox.com/31/1a/CuhdJWGv_o.png" alt="image-20221207153637391"></p> 
<p><strong>根据帮助文档的介绍， 当前设备发布主题，上报属性的格式总结如下：</strong></p> 
<pre><code class="prism language-cpp">发布的主题格式<span class="token operator">:</span>
$oc<span class="token operator">/</span>devices<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>device_id<span class="token punctuation">}</span><span class="token operator">/</span>sys<span class="token operator">/</span>properties<span class="token operator">/</span>report
 
最终的格式<span class="token operator">:</span>
$oc<span class="token operator">/</span>devices<span class="token operator">/</span><span class="token number">663</span>cb18871d845632a0912e7_dev1<span class="token operator">/</span>sys<span class="token operator">/</span>properties<span class="token operator">/</span>report
发布主题时，需要上传数据，这个数据格式是JSON格式。

上传的JSON数据格式如下<span class="token operator">:</span>

<span class="token punctuation">{<!-- --></span>
  <span class="token string">"services"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"service_id"</span><span class="token operator">:</span> <span class="token operator">&lt;</span>填服务ID<span class="token operator">&gt;</span><span class="token punctuation">,</span>
      <span class="token string">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"&lt;填属性名称1&gt;"</span><span class="token operator">:</span> <span class="token operator">&lt;</span>填属性值<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token string">"&lt;填属性名称2&gt;"</span><span class="token operator">:</span> <span class="token operator">&lt;</span>填属性值<span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
根据JSON格式，一次可以上传多个属性字段。 这个JSON格式里的，服务ID，属性字段名称，属性值类型，在前面创建产品的时候就已经介绍了，不记得可以翻到前面去查看。

根据这个格式，组合一次上传的属性数据<span class="token operator">:</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"services"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"service_id"</span><span class="token operator">:</span> <span class="token string">"stm32"</span><span class="token punctuation">,</span><span class="token string">"properties"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"DHT11_T"</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token string">"DHT11_H"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">"BH1750"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"MQ135"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="26_MQTT_488"></a>2.6 MQTT三元组</h3> 
<p>MQTT协议登录需要填用户ID，设备ID，设备密码等信息，就像我们平时登录QQ，微信一样要输入账号密码才能登录。MQTT协议登录的这3个参数，一般称为MQTT三元组。</p> 
<p>接下来介绍，华为云平台的MQTT三元组参数如何得到。</p> 
<h4><a id="1MQTT_496"></a>（1）MQTT服务器地址</h4> 
<p>要登录MQTT服务器，首先记得先知道服务器的地址是多少，端口是多少。</p> 
<p>帮助文档地址：https://console.huaweicloud.com/iotdm/?region=cn-north-4#/dm-portal/home</p> 
<p><img src="https://images2.imgbox.com/47/70/aFyaROoU_o.png" alt="image-20240509193207359"></p> 
<p>MQTT协议的端口支持1883和8883，它们的区别是：8883 是加密端口更加安全。但是单片机上使用比较困难，所以当前的设备是采用1883端口进连接的。</p> 
<p><strong>根据上面的域名和端口号，得到下面的IP地址和端口号信息：</strong> 如果设备支持填写域名可以直接填域名，不支持就直接填写IP地址。 （IP地址就是域名解析得到的）</p> 
<pre><code class="prism language-cpp">华为云的MQTT服务器地址：<span class="token number">117.78</span><span class="token punctuation">.</span><span class="token number">5.125</span>
华为云的MQTT端口号：<span class="token number">1883</span>
</code></pre> 
<p>如何得到IP地址？如何域名转IP？ 打开Windows的命令行输入以下命令。</p> 
<pre><code class="prism language-cpp">ping  ad635970a1<span class="token punctuation">.</span>st1<span class="token punctuation">.</span>iotda<span class="token operator">-</span>device<span class="token punctuation">.</span>cn<span class="token operator">-</span>north<span class="token operator">-</span><span class="token number">4.</span>myhuaweicloud<span class="token punctuation">.</span>com
</code></pre> 
<p><img src="https://images2.imgbox.com/c1/46/YGhyqHr7_o.png" alt="image-20240425182610048"></p> 
<h4><a id="2MQTT_529"></a>（2）生成MQTT三元组</h4> 
<p>华为云提供了一个在线工具，用来生成MQTT鉴权三元组： https://iot-tool.obs-website.cn-north-4.myhuaweicloud.com/</p> 
<p>打开这个工具，填入设备的信息（也就是刚才创建完设备之后保存的信息），点击生成，就可以得到MQTT的登录信息了。</p> 
<p><strong>下面是打开的页面：</strong></p> 
<p><img src="https://images2.imgbox.com/5a/53/8F9mPw2X_o.png" alt="image-20240425183025893"></p> 
<p><strong>填入设备的信息：</strong> （上面两行就是设备创建完成之后保存得到的）</p> 
<p>直接得到三元组信息。</p> 
<p><img src="https://images2.imgbox.com/1d/3b/3EJIJuy0_o.png" alt="image-20240509193310020"></p> 
<p>得到三元组之后，设备端通过MQTT协议登录鉴权的时候，填入参数即可。</p> 
<pre><code class="prism language-cpp">ClientId  <span class="token number">663</span>cb18871d845632a0912e7_dev1_0_0_2024050911
Username  <span class="token number">663</span>cb18871d845632a0912e7_dev1
Password  <span class="token number">71</span>b82deae83e80f04c4269b5bbce3b2fc7c13f610948fe210ce18650909ac237
</code></pre> 
<h3><a id="27__561"></a>2.7 模拟设备登录测试</h3> 
<p>经过上面的步骤介绍，已经创建了产品，设备，数据模型，得到MQTT登录信息。 接下来就用MQTT客户端软件模拟真实的设备来登录平台。测试与服务器通信是否正常。</p> 
<h4><a id="1_565"></a>（1）填入登录信息</h4> 
<p>打开MQTT客户端软件，对号填入相关信息（就是上面的文本介绍）。然后，点击登录，订阅主题，发布主题。</p> 
<p><img src="https://images2.imgbox.com/66/18/z5p0S04I_o.png" alt="image-20240509193457358"></p> 
<h4><a id="2_575"></a>（2）打开网页查看</h4> 
<p>完成上面的操作之后，打开华为云网页后台，可以看到设备已经在线了。</p> 
<p><img src="https://images2.imgbox.com/15/1a/gZU6aZ3c_o.png" alt="image-20240612100508790"></p> 
<p>点击详情页面，可以看到上传的数据：</p> 
<p><img src="https://images2.imgbox.com/f3/0e/8wOvX5R8_o.png" alt="image-20240612100529581"></p> 
<p>到此，云平台的部署已经完成，设备已经可以正常上传数据了。</p> 
<h4><a id="3MQTT_593"></a>（3）MQTT登录测试参数总结</h4> 
<pre><code class="prism language-cpp">MQTT服务器<span class="token operator">:</span>  <span class="token number">117.78</span><span class="token punctuation">.</span><span class="token number">5.125</span>
MQTT端口号<span class="token operator">:</span>  <span class="token number">183</span>

<span class="token comment">//物联网服务器的设备信息</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MQTT_ClientID</span> <span class="token string">"663cb18871d845632a0912e7_dev1_0_0_2024050911"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MQTT_UserName</span> <span class="token string">"663cb18871d845632a0912e7_dev1"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MQTT_PassWord</span> <span class="token string">"71b82deae83e80f04c4269b5bbce3b2fc7c13f610948fe210ce18650909ac237"</span></span>

<span class="token comment">//订阅与发布的主题</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SET_TOPIC</span>  <span class="token string">"$oc/devices/663cb18871d845632a0912e7_dev1/sys/messages/down"</span>  <span class="token comment">//订阅</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POST_TOPIC</span> <span class="token string">"$oc/devices/663cb18871d845632a0912e7_dev1/sys/properties/report"</span>  <span class="token comment">//发布</span></span>


发布的数据<span class="token operator">:</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"services"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"service_id"</span><span class="token operator">:</span> <span class="token string">"stm32"</span><span class="token punctuation">,</span><span class="token string">"properties"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"DHT11_T"</span><span class="token operator">:</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token string">"DHT11_H"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string">"BH1750"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"MQ135"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

</code></pre> 
<h3><a id="28_IAM_616"></a>2.8 创建IAM账户</h3> 
<p>创建一个IAM账户，因为接下来开发上位机，需要使用云平台的API接口，这些接口都需要token进行鉴权。简单来说，就是身份的认证。 调用接口获取Token时，就需要填写IAM账号信息。所以，接下来演示一下过程。</p> 
<p>地址: https://console.huaweicloud.com/iam/?region=cn-north-4#/iam/users</p> 
<p>**【1】获取项目凭证 ** 点击左上角用户名，选择下拉菜单里的<code>我的凭证</code></p> 
<p><img src="https://images2.imgbox.com/70/ca/QRwgryGG_o.png" alt="image-20240509193646253"></p> 
<p><img src="https://images2.imgbox.com/cf/29/2cUOSzV6_o.png" alt="image-20240509193701262"></p> 
<p><strong>项目凭证:</strong></p> 
<pre><code class="prism language-cpp"><span class="token number">28</span>add376c01e4a61ac8b621c714bf459
</code></pre> 
<p><strong>【2】创建IAM用户</strong></p> 
<p>鼠标放在左上角头像上，在下拉菜单里选择<code>统一身份认证</code>。</p> 
<p><img src="https://images2.imgbox.com/fa/73/VgITWdno_o.png" alt="image-20240509193729078"></p> 
<p>点击左上角<code>创建用户</code>。</p> 
<p><img src="https://images2.imgbox.com/0c/4d/uvU4gNVM_o.png" alt="image-20240509193744287"></p> 
<p><img src="https://images2.imgbox.com/ba/65/F9oqsqYn_o.png" alt="image-20240314153208692"></p> 
<p><img src="https://images2.imgbox.com/6c/29/apvC8h2L_o.png" alt="image-20240314153228359"></p> 
<p><img src="https://images2.imgbox.com/b3/3d/AwpbUPsO_o.png" alt="image-20240314153258229"></p> 
<p><strong>创建成功：</strong></p> 
<p><img src="https://images2.imgbox.com/5b/28/Q3YI1tIK_o.png" alt="image-20240314153315444"></p> 
<p>【3】创建完成</p> 
<p><img src="https://images2.imgbox.com/5d/fb/LJeH6wwW_o.png" alt="image-20240509193828289"></p> 
<p><strong>用户信息如下：</strong></p> 
<pre><code class="prism language-cpp">主用户名  l19504562721
IAM用户  ds_abc
密码     DS12345678
</code></pre> 
<h3><a id="29__704"></a>2.9 获取影子数据</h3> 
<p>帮助文档：https://support.huaweicloud.com/api-iothub/iot_06_v5_0079.html</p> 
<p><strong>设备影子介绍：</strong></p> 
<pre><code class="prism language-cpp">设备影子是一个用于存储和检索设备当前状态信息的JSON文档。
每个设备有且只有一个设备影子，由设备ID唯一标识
设备影子仅保存最近一次设备的上报数据和预期数据
无论该设备是否在线，都可以通过该影子获取和设置设备的属性
</code></pre> 
<p>简单来说：设备影子就是保存，设备最新上传的一次数据。</p> 
<p>我们设计的软件里，如果想要获取设备的最新状态信息，就采用设备影子接口。</p> 
<p>如果对接口不熟悉，可以先进行在线调试：https://apiexplorer.developer.huaweicloud.com/apiexplorer/doc?product=IoTDA&amp;api=ShowDeviceShadow</p> 
<p>在线调试接口，可以请求影子接口，了解请求，与返回的数据格式。</p> 
<p><strong>调试完成看右下角的响应体，就是返回的影子数据。</strong></p> 
<p><img src="https://images2.imgbox.com/9b/5f/6lj0IgKi_o.png" alt="image-20240509194152229"></p> 
<p><strong>设备影子接口返回的数据如下：</strong></p> 
<pre><code class="prism language-cpp"><span class="token punctuation">{<!-- --></span>
 <span class="token string">"device_id"</span><span class="token operator">:</span> <span class="token string">"663cb18871d845632a0912e7_dev1"</span><span class="token punctuation">,</span>
 <span class="token string">"shadow"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{<!-- --></span>
   <span class="token string">"service_id"</span><span class="token operator">:</span> <span class="token string">"stm32"</span><span class="token punctuation">,</span>
   <span class="token string">"desired"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token operator">:</span> null<span class="token punctuation">,</span>
    <span class="token string">"event_time"</span><span class="token operator">:</span> null
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token string">"reported"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
     <span class="token string">"DHT11_T"</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
     <span class="token string">"DHT11_H"</span><span class="token operator">:</span> <span class="token number">90</span><span class="token punctuation">,</span>
     <span class="token string">"BH1750"</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
     <span class="token string">"MQ135"</span><span class="token operator">:</span> <span class="token number">70</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"event_time"</span><span class="token operator">:</span> <span class="token string">"20240509T113448Z"</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token string">"version"</span><span class="token operator">:</span> <span class="token number">3</span>
  <span class="token punctuation">}</span>
 <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>调试成功之后，可以得到访问影子数据的真实链接，接下来的代码开发中，就采用Qt写代码访问此链接，获取影子数据，完成上位机开发。</strong></p> 
<p><img src="https://images2.imgbox.com/98/17/Uwn4n38Y_o.png" alt="image-20240509194214716"></p> 
<p><strong>链接如下：</strong></p> 
<pre><code class="prism language-cpp">https<span class="token operator">:</span><span class="token comment">//ad635970a1.st1.iotda-app.cn-north-4.myhuaweicloud.com:443/v5/iot/28add376c01e4a61ac8b621c714bf459/devices/663cb18871d845632a0912e7_dev1/shadow</span>
</code></pre> 
<h2><a id="STM32_786"></a>三、STM32设备端代码设计</h2> 
<h3><a id="31_RTC_788"></a>3.1 RTC时钟配置代码</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rtc.h"</span> 	</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"calendar.h"</span>	    </span>
   
<span class="token comment">//实时时钟配置</span>
<span class="token comment">//初始化RTC时钟,同时检测时钟是否工作正常</span>
<span class="token comment">//BKP-&gt;DR1用于保存是否第一次配置的设置</span>
<span class="token comment">//返回0:正常</span>
<span class="token comment">//其他:错误代码</span>
u8 <span class="token function">RTC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//检查是不是第一次配置时钟</span>
	u8 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>BKP<span class="token operator">-&gt;</span>DR1<span class="token operator">!=</span><span class="token number">0X5050</span><span class="token punctuation">)</span><span class="token comment">//第一次配置</span>
	<span class="token punctuation">{<!-- --></span>	 
	  	RCC<span class="token operator">-&gt;</span>APB1ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">28</span><span class="token punctuation">;</span>     <span class="token comment">//使能电源时钟	    </span>
		RCC<span class="token operator">-&gt;</span>APB1ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">27</span><span class="token punctuation">;</span>     <span class="token comment">//使能备份时钟	    </span>
		PWR<span class="token operator">-&gt;</span>CR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>           <span class="token comment">//取消备份区写保护</span>
		RCC<span class="token operator">-&gt;</span>BDCR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>        <span class="token comment">//备份区域软复位	   </span>
		RCC<span class="token operator">-&gt;</span>BDCR<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//备份区域软复位结束	  	 </span>
	    RCC<span class="token operator">-&gt;</span>BDCR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>         <span class="token comment">//开启外部低速振荡器 </span>
	    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>RCC<span class="token operator">-&gt;</span>BDCR<span class="token operator">&amp;</span><span class="token number">0X02</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>temp<span class="token operator">&lt;</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token comment">//等待外部时钟就绪	 </span>
		<span class="token punctuation">{<!-- --></span>
			temp<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//初始化时钟失败,晶振有问题	   </span>
		RCC<span class="token operator">-&gt;</span>BDCR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">//LSI作为RTC时钟 	    </span>
		RCC<span class="token operator">-&gt;</span>BDCR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">;</span><span class="token comment">//RTC时钟使能	  </span>
	  	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待RTC寄存器操作完成	 </span>
    	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待RTC寄存器同步  </span>
    	RTC<span class="token operator">-&gt;</span>CRH<span class="token operator">|=</span><span class="token number">0X01</span><span class="token punctuation">;</span>  		  <span class="token comment">//允许秒中断</span>
    	RTC<span class="token operator">-&gt;</span>CRH<span class="token operator">|=</span><span class="token number">0X02</span><span class="token punctuation">;</span>  		  <span class="token comment">//允许闹钟中断</span>
    	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待RTC寄存器操作完成	 </span>
		RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>           <span class="token comment">//允许配置	 </span>
		RTC<span class="token operator">-&gt;</span>PRLH<span class="token operator">=</span><span class="token number">0X0000</span><span class="token punctuation">;</span>
		RTC<span class="token operator">-&gt;</span>PRLL<span class="token operator">=</span><span class="token number">32767</span><span class="token punctuation">;</span>          <span class="token comment">//时钟周期设置(有待观察,看是否跑慢了?)理论值：32767	</span>
		<span class="token function">RTC_Set</span><span class="token punctuation">(</span><span class="token number">2015</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置时间	  </span>
		RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//配置更新</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//等待RTC寄存器操作完成		 									  </span>
		BKP<span class="token operator">-&gt;</span>DR1<span class="token operator">=</span><span class="token number">0X5050</span><span class="token punctuation">;</span>  
	 	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"FIRST TIME\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token comment">//系统继续计时</span>
	<span class="token punctuation">{<!-- --></span>
    	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待RTC寄存器同步  </span>
    	RTC<span class="token operator">-&gt;</span>CRH<span class="token operator">|=</span><span class="token number">0X01</span><span class="token punctuation">;</span>  		  <span class="token comment">//允许秒中断</span>
    	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待RTC寄存器操作完成</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"OK\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>		    				  
	<span class="token function">MY_NVIC_Init</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>RTC_IRQn<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//优先级设置    </span>
	<span class="token function">RTC_Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更新时间 </span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//ok</span>
<span class="token punctuation">}</span>		 				    
<span class="token comment">//RTC时钟中断</span>
<span class="token comment">//每秒触发一次  	 </span>
<span class="token keyword">void</span> <span class="token function">RTC_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	<span class="token function">OSIntEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    			 
	<span class="token keyword">if</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token number">0x0001</span><span class="token punctuation">)</span>			<span class="token comment">//秒钟中断</span>
	<span class="token punctuation">{<!-- --></span>							
		<span class="token function">RTC_Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//更新时间   </span>
		<span class="token comment">//printf("sec:%d\r\n",calendar.sec);</span>
 	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token number">0x0002</span><span class="token punctuation">)</span>			<span class="token comment">//闹钟中断</span>
	<span class="token punctuation">{<!-- --></span>
		RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0x0002</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清闹钟中断	  </span>
		<span class="token function">RTC_Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//更新时间   </span>
  		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Alarm Time:%d-%d-%d %d:%d:%d\n"</span><span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>w_year<span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>w_month<span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>w_date<span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>hour<span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>min<span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>sec<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出闹铃时间	   </span>
		alarm<span class="token punctuation">.</span>ringsta<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">;</span>	<span class="token comment">//开启闹铃</span>
	<span class="token punctuation">}</span> 				  								 
    RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token number">0X0FFA</span><span class="token punctuation">;</span>         	<span class="token comment">//清除溢出，秒钟中断标志</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//等待RTC寄存器操作完成	  							 </span>
	<span class="token function">OSIntExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  	    						 	   	 
<span class="token punctuation">}</span>
<span class="token comment">//判断是否是闰年函数</span>
<span class="token comment">//月份   1  2  3  4  5  6  7  8  9  10 11 12</span>
<span class="token comment">//闰年   31 29 31 30 31 30 31 31 30 31 30 31</span>
<span class="token comment">//非闰年 31 28 31 30 31 30 31 31 30 31 30 31</span>
<span class="token comment">//year:年份</span>
<span class="token comment">//返回值:该年份是不是闰年.1,是.0,不是</span>
u8 <span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>u16 year<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>			  
	<span class="token keyword">if</span><span class="token punctuation">(</span>year<span class="token operator">%</span><span class="token number">4</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//必须能被4整除</span>
	<span class="token punctuation">{<!-- --></span> 
		<span class="token keyword">if</span><span class="token punctuation">(</span>year<span class="token operator">%</span><span class="token number">100</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span> 
			<span class="token keyword">if</span><span class="token punctuation">(</span>year<span class="token operator">%</span><span class="token number">400</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//如果以00结尾,还要能被400整除 	   </span>
			<span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>   
		<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>   
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>	 			   
<span class="token comment">//设置时钟</span>
<span class="token comment">//把输入的时钟转换为秒钟</span>
<span class="token comment">//以1970年1月1日为基准</span>
<span class="token comment">//1970~2099年为合法年份</span>
<span class="token comment">//返回值:0,成功;其他:错误代码.</span>
<span class="token comment">//月份数据表											 </span>
u8 <span class="token keyword">const</span> table_week<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//月修正数据表	  </span>
<span class="token comment">//平年的月份日期表</span>
<span class="token keyword">const</span> u8 mon_table<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//syear,smon,sday,hour,min,sec：年月日时分秒</span>
<span class="token comment">//返回值：设置结果。0，成功；1，失败。</span>
u8 <span class="token function">RTC_Set</span><span class="token punctuation">(</span>u16 syear<span class="token punctuation">,</span>u8 smon<span class="token punctuation">,</span>u8 sday<span class="token punctuation">,</span>u8 hour<span class="token punctuation">,</span>u8 min<span class="token punctuation">,</span>u8 sec<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u16 t<span class="token punctuation">;</span>
	u32 seccount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>syear<span class="token operator">&lt;</span><span class="token number">1970</span><span class="token operator">||</span>syear<span class="token operator">&gt;</span><span class="token number">2099</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>	   
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">1970</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>syear<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>	<span class="token comment">//把所有年份的秒钟相加</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>seccount<span class="token operator">+=</span><span class="token number">31622400</span><span class="token punctuation">;</span><span class="token comment">//闰年的秒钟数</span>
		<span class="token keyword">else</span> seccount<span class="token operator">+=</span><span class="token number">31536000</span><span class="token punctuation">;</span>			  <span class="token comment">//平年的秒钟数</span>
	<span class="token punctuation">}</span>
	smon<span class="token operator">-=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>smon<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>	   <span class="token comment">//把前面月份的秒钟数相加</span>
	<span class="token punctuation">{<!-- --></span>
		seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>mon_table<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">86400</span><span class="token punctuation">;</span><span class="token comment">//月份秒钟数相加</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>syear<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>t<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>seccount<span class="token operator">+=</span><span class="token number">86400</span><span class="token punctuation">;</span><span class="token comment">//闰年2月份增加一天的秒钟数	   </span>
	<span class="token punctuation">}</span>
	seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">(</span>sday<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span><span class="token punctuation">;</span><span class="token comment">//把前面日期的秒钟数相加 </span>
	seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>hour<span class="token operator">*</span><span class="token number">3600</span><span class="token punctuation">;</span><span class="token comment">//小时秒钟数</span>
    seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>min<span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">;</span>	 <span class="token comment">//分钟秒钟数</span>
	seccount<span class="token operator">+=</span>sec<span class="token punctuation">;</span><span class="token comment">//最后的秒钟加上去</span>
													    
	<span class="token comment">//设置时钟</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">28</span><span class="token punctuation">;</span><span class="token comment">//使能电源时钟</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">27</span><span class="token punctuation">;</span><span class="token comment">//使能备份时钟</span>
	PWR<span class="token operator">-&gt;</span>CR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>    <span class="token comment">//取消备份区写保护</span>
	<span class="token comment">//上面三步是必须的!</span>
	RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>   <span class="token comment">//允许配置 </span>
	RTC<span class="token operator">-&gt;</span>CNTL<span class="token operator">=</span>seccount<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">;</span>
	RTC<span class="token operator">-&gt;</span>CNTH<span class="token operator">=</span>seccount<span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">;</span>
	RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//配置更新</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待RTC寄存器操作完成 </span>
	<span class="token function">RTC_Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置完之后更新一下数据 	</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	    
<span class="token punctuation">}</span>
<span class="token comment">//初始化闹钟		  </span>
<span class="token comment">//以1970年1月1日为基准</span>
<span class="token comment">//1970~2099年为合法年份</span>
<span class="token comment">//syear,smon,sday,hour,min,sec：闹钟的年月日时分秒   </span>
<span class="token comment">//返回值:0,成功;其他:错误代码.</span>
u8 <span class="token function">RTC_Alarm_Set</span><span class="token punctuation">(</span>u16 syear<span class="token punctuation">,</span>u8 smon<span class="token punctuation">,</span>u8 sday<span class="token punctuation">,</span>u8 hour<span class="token punctuation">,</span>u8 min<span class="token punctuation">,</span>u8 sec<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u16 t<span class="token punctuation">;</span>
	u32 seccount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>syear<span class="token operator">&lt;</span><span class="token number">1970</span><span class="token operator">||</span>syear<span class="token operator">&gt;</span><span class="token number">2099</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>	   
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">1970</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>syear<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>	<span class="token comment">//把所有年份的秒钟相加</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>seccount<span class="token operator">+=</span><span class="token number">31622400</span><span class="token punctuation">;</span><span class="token comment">//闰年的秒钟数</span>
		<span class="token keyword">else</span> seccount<span class="token operator">+=</span><span class="token number">31536000</span><span class="token punctuation">;</span>			  <span class="token comment">//平年的秒钟数</span>
	<span class="token punctuation">}</span>
	smon<span class="token operator">-=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>smon<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>	   <span class="token comment">//把前面月份的秒钟数相加</span>
	<span class="token punctuation">{<!-- --></span>
		seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>mon_table<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token operator">*</span><span class="token number">86400</span><span class="token punctuation">;</span><span class="token comment">//月份秒钟数相加</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>syear<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>t<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>seccount<span class="token operator">+=</span><span class="token number">86400</span><span class="token punctuation">;</span><span class="token comment">//闰年2月份增加一天的秒钟数	   </span>
	<span class="token punctuation">}</span>
	seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">(</span>sday<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">86400</span><span class="token punctuation">;</span><span class="token comment">//把前面日期的秒钟数相加 </span>
	seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>hour<span class="token operator">*</span><span class="token number">3600</span><span class="token punctuation">;</span><span class="token comment">//小时秒钟数</span>
    seccount<span class="token operator">+=</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span>min<span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">;</span>	 <span class="token comment">//分钟秒钟数</span>
	seccount<span class="token operator">+=</span>sec<span class="token punctuation">;</span><span class="token comment">//最后的秒钟加上去 			    </span>
	<span class="token comment">//设置时钟</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">28</span><span class="token punctuation">;</span><span class="token comment">//使能电源时钟</span>
    RCC<span class="token operator">-&gt;</span>APB1ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">27</span><span class="token punctuation">;</span><span class="token comment">//使能备份时钟</span>
	PWR<span class="token operator">-&gt;</span>CR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>    <span class="token comment">//取消备份区写保护</span>
	<span class="token comment">//上面三步是必须的!</span>
	RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>   <span class="token comment">//允许配置 </span>
	RTC<span class="token operator">-&gt;</span>ALRL<span class="token operator">=</span>seccount<span class="token operator">&amp;</span><span class="token number">0xffff</span><span class="token punctuation">;</span>
	RTC<span class="token operator">-&gt;</span>ALRH<span class="token operator">=</span>seccount<span class="token operator">&gt;&gt;</span><span class="token number">16</span><span class="token punctuation">;</span>
	RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//配置更新</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>RTC<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待RTC寄存器操作完成  </span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	    
<span class="token punctuation">}</span>
<span class="token comment">//得到当前的时间，结果保存在calendar结构体里面</span>
<span class="token comment">//返回值:0,成功;其他:错误代码.</span>
u8 <span class="token function">RTC_Get</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static</span> u16 daycnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u32 timecount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
	u32 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u16 temp1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	  
 	timecount<span class="token operator">=</span>RTC<span class="token operator">-&gt;</span>CNTH<span class="token punctuation">;</span><span class="token comment">//得到计数器中的值(秒钟数)</span>
	timecount<span class="token operator">&lt;&lt;=</span><span class="token number">16</span><span class="token punctuation">;</span>
	timecount<span class="token operator">+=</span>RTC<span class="token operator">-&gt;</span>CNTL<span class="token punctuation">;</span>			 

 	temp<span class="token operator">=</span>timecount<span class="token operator">/</span><span class="token number">86400</span><span class="token punctuation">;</span>   <span class="token comment">//得到天数(秒钟数对应的)</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>daycnt<span class="token operator">!=</span>temp<span class="token punctuation">)</span><span class="token comment">//超过一天了</span>
	<span class="token punctuation">{<!-- --></span>	  
		daycnt<span class="token operator">=</span>temp<span class="token punctuation">;</span>
		temp1<span class="token operator">=</span><span class="token number">1970</span><span class="token punctuation">;</span>	<span class="token comment">//从1970年开始</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span><span class="token number">365</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>				 
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>temp1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//是闰年</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span><span class="token number">366</span><span class="token punctuation">)</span>temp<span class="token operator">-=</span><span class="token number">366</span><span class="token punctuation">;</span><span class="token comment">//闰年的秒钟数</span>
				<span class="token keyword">else</span> <span class="token keyword">break</span><span class="token punctuation">;</span>  
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> temp<span class="token operator">-=</span><span class="token number">365</span><span class="token punctuation">;</span>	  <span class="token comment">//平年 </span>
			temp1<span class="token operator">++</span><span class="token punctuation">;</span>  
		<span class="token punctuation">}</span>   
		calendar<span class="token punctuation">.</span>w_year<span class="token operator">=</span>temp1<span class="token punctuation">;</span><span class="token comment">//得到年份</span>
		temp1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span><span class="token number">28</span><span class="token punctuation">)</span><span class="token comment">//超过了一个月</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">Is_Leap_Year</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span>w_year<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>temp1<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//当年是不是闰年/2月份</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span><span class="token number">29</span><span class="token punctuation">)</span>temp<span class="token operator">-=</span><span class="token number">29</span><span class="token punctuation">;</span><span class="token comment">//闰年的秒钟数</span>
				<span class="token keyword">else</span> <span class="token keyword">break</span><span class="token punctuation">;</span> 
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> 
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token operator">&gt;=</span>mon_table<span class="token punctuation">[</span>temp1<span class="token punctuation">]</span><span class="token punctuation">)</span>temp<span class="token operator">-=</span>mon_table<span class="token punctuation">[</span>temp1<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//平年</span>
				<span class="token keyword">else</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			temp1<span class="token operator">++</span><span class="token punctuation">;</span>  
		<span class="token punctuation">}</span>
		calendar<span class="token punctuation">.</span>w_month<span class="token operator">=</span>temp1<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//得到月份</span>
		calendar<span class="token punctuation">.</span>w_date<span class="token operator">=</span>temp<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>  	<span class="token comment">//得到日期 </span>
	<span class="token punctuation">}</span>
	temp<span class="token operator">=</span>timecount<span class="token operator">%</span><span class="token number">86400</span><span class="token punctuation">;</span>     		<span class="token comment">//得到秒钟数   	   </span>
	calendar<span class="token punctuation">.</span>hour<span class="token operator">=</span>temp<span class="token operator">/</span><span class="token number">3600</span><span class="token punctuation">;</span>     	<span class="token comment">//小时</span>
	calendar<span class="token punctuation">.</span>min<span class="token operator">=</span><span class="token punctuation">(</span>temp<span class="token operator">%</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">60</span><span class="token punctuation">;</span> 	<span class="token comment">//分钟	</span>
	calendar<span class="token punctuation">.</span>sec<span class="token operator">=</span><span class="token punctuation">(</span>temp<span class="token operator">%</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">60</span><span class="token punctuation">;</span> 	<span class="token comment">//秒钟</span>
	calendar<span class="token punctuation">.</span>week<span class="token operator">=</span><span class="token function">RTC_Get_Week</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span>w_year<span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>w_month<span class="token punctuation">,</span>calendar<span class="token punctuation">.</span>w_date<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取星期   </span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>	 
<span class="token comment">//获得现在是星期几</span>
<span class="token comment">//功能描述:输入公历日期得到星期(只允许1901-2099年)</span>
<span class="token comment">//year,month,day：公历年月日 </span>
<span class="token comment">//返回值：星期号																						 </span>
u8 <span class="token function">RTC_Get_Week</span><span class="token punctuation">(</span>u16 year<span class="token punctuation">,</span>u8 month<span class="token punctuation">,</span>u8 day<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	
	u16 temp2<span class="token punctuation">;</span>
	u8 yearH<span class="token punctuation">,</span>yearL<span class="token punctuation">;</span>
	
	yearH<span class="token operator">=</span>year<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>	yearL<span class="token operator">=</span>year<span class="token operator">%</span><span class="token number">100</span><span class="token punctuation">;</span> 
	<span class="token comment">// 如果为21世纪,年份数加100  </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>yearH<span class="token operator">&gt;</span><span class="token number">19</span><span class="token punctuation">)</span>yearL<span class="token operator">+=</span><span class="token number">100</span><span class="token punctuation">;</span>
	<span class="token comment">// 所过闰年数只算1900年之后的  </span>
	temp2<span class="token operator">=</span>yearL<span class="token operator">+</span>yearL<span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">;</span>
	temp2<span class="token operator">=</span>temp2<span class="token operator">%</span><span class="token number">7</span><span class="token punctuation">;</span> 
	temp2<span class="token operator">=</span>temp2<span class="token operator">+</span>day<span class="token operator">+</span>table_week<span class="token punctuation">[</span>month<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>yearL<span class="token operator">%</span><span class="token number">4</span><span class="token operator">==</span><span class="token number">0</span><span class="token operator">&amp;&amp;</span>month<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>temp2<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span><span class="token punctuation">(</span>temp2<span class="token operator">%</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>			  
</code></pre> 
<h3><a id="32_SPI_1041"></a>3.2 SPI协议封装</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"spi.h"</span></span>

<span class="token comment">//以下是SPI模块的初始化代码，配置成主机模式，访问W25Q128/NRF24L01</span>
<span class="token comment">//SPI口初始化</span>
<span class="token comment">//这里针是对SPI2的初始化</span>
<span class="token keyword">void</span> <span class="token function">SPI2_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	 
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>  	<span class="token comment">//PORTB时钟使能 	 </span>
	RCC<span class="token operator">-&gt;</span>APB1ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">;</span>   	<span class="token comment">//SPI2时钟使能 </span>
	<span class="token comment">//这里只针对SPI口初始化</span>
	GPIOB<span class="token operator">-&gt;</span>CRH<span class="token operator">&amp;=</span><span class="token number">0X000FFFFF</span><span class="token punctuation">;</span> 
	GPIOB<span class="token operator">-&gt;</span>CRH<span class="token operator">|=</span><span class="token number">0XBBB00000</span><span class="token punctuation">;</span>	<span class="token comment">//PB13/14/15复用 	    </span>
	GPIOB<span class="token operator">-&gt;</span>ODR<span class="token operator">|=</span><span class="token number">0X7</span><span class="token operator">&lt;&lt;</span><span class="token number">13</span><span class="token punctuation">;</span>   	<span class="token comment">//PB13/14/15上拉</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">;</span>		<span class="token comment">//全双工模式	</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span> 		<span class="token comment">//软件nss管理</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>  

	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span> 		<span class="token comment">//SPI主机</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">;</span>		<span class="token comment">//8bit数据格式	</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span> 		<span class="token comment">//空闲模式下SCK为1 CPOL=1</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span> 		<span class="token comment">//数据采样从第二个时间边沿开始,CPHA=1  </span>
	<span class="token comment">//对SPI2属于APB1的外设.时钟频率最大为36M.</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> 		<span class="token comment">//Fsck=Fpclk1/256</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> 		<span class="token comment">//MSBfirst   </span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> 		<span class="token comment">//SPI设备使能</span>
	<span class="token function">SPI2_ReadWriteByte</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动传输		 </span>
<span class="token punctuation">}</span>  
<span class="token comment">//SPI2速度设置函数</span>
<span class="token comment">//SpeedSet:0~7</span>
<span class="token comment">//SPI速度=fAPB1/2^(SpeedSet+1)</span>
<span class="token comment">//APB1时钟一般为36Mhz</span>
<span class="token keyword">void</span> <span class="token function">SPI2_SetSpeed</span><span class="token punctuation">(</span>u8 SpeedSet<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SpeedSet<span class="token operator">&amp;=</span><span class="token number">0X07</span><span class="token punctuation">;</span>			<span class="token comment">//限制范围</span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">&amp;=</span><span class="token number">0XFFC7</span><span class="token punctuation">;</span> 
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span>SpeedSet<span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">//设置SPI2速度  </span>
	SPI2<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> 		<span class="token comment">//SPI设备使能	  </span>
<span class="token punctuation">}</span> 
<span class="token comment">//SPI2 读写一个字节</span>
<span class="token comment">//TxData:要写入的字节</span>
<span class="token comment">//返回值:读取到的字节</span>
u8 <span class="token function">SPI2_ReadWriteByte</span><span class="token punctuation">(</span>u8 TxData<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>		
	u16 retry<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				 
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SPI2<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>		<span class="token comment">//等待发送区空	</span>
	<span class="token punctuation">{<!-- --></span>
		retry<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>retry<span class="token operator">&gt;=</span><span class="token number">0XFFFE</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span> 	<span class="token comment">//超时退出</span>
	<span class="token punctuation">}</span>			  
	SPI2<span class="token operator">-&gt;</span>DR<span class="token operator">=</span>TxData<span class="token punctuation">;</span>	 	  		<span class="token comment">//发送一个byte </span>
	retry<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SPI2<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 		<span class="token comment">//等待接收完一个byte  </span>
	<span class="token punctuation">{<!-- --></span>
		retry<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>retry<span class="token operator">&gt;=</span><span class="token number">0XFFFE</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//超时退出</span>
	<span class="token punctuation">}</span>	  						    
	<span class="token keyword">return</span> SPI2<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>          		<span class="token comment">//返回收到的数据				    </span>
<span class="token punctuation">}</span>
<span class="token comment">//SPI1初始化</span>
<span class="token keyword">void</span> <span class="token function">SPI1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	    
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>     <span class="token comment">//PORTA时钟使能 	 </span>
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">;</span>    <span class="token comment">//SPI1时钟使能 </span>
		   
	<span class="token comment">//这里只针对SPI口初始化</span>
	GPIOA<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token number">0X000FFFFF</span><span class="token punctuation">;</span> 
	GPIOA<span class="token operator">-&gt;</span>CRL<span class="token operator">|=</span><span class="token number">0XBBB00000</span><span class="token punctuation">;</span>	<span class="token comment">//PA5.6.7复用 	    </span>
	GPIOA<span class="token operator">-&gt;</span>ODR<span class="token operator">|=</span><span class="token number">0X7</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>    	<span class="token comment">//PA5.6.7上拉</span>
		
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//全双工模式	</span>
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">//软件nss管理</span>
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>  

	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">//SPI主机</span>
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">;</span><span class="token comment">//8bit数据格式	</span>
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//CPOL=0时空闲模式下SCK为1  CPOL=1</span>
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//数据采样从第二个时间边沿开始,CPHA=1  </span>
	  
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">//Fsck=Fcpu/256</span>
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">//MSBfirst   </span>
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">//SPI设备使能</span>
 	<span class="token function">SPI1_ReadWriteByte</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动传输	 </span>
<span class="token punctuation">}</span> 
<span class="token comment">//SPI1 速度设置函数</span>
<span class="token comment">//SpeedSet:0~7</span>
<span class="token comment">//SPI速度=fAPB2/2^(SpeedSet+1)</span>
<span class="token comment">//APB2时钟一般为72Mhz</span>
<span class="token keyword">void</span> <span class="token function">SPI1_SetSpeed</span><span class="token punctuation">(</span>u8 SpeedSet<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SpeedSet<span class="token operator">&amp;=</span><span class="token number">0X07</span><span class="token punctuation">;</span>			<span class="token comment">//限制范围</span>
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">&amp;=</span><span class="token number">0XFFC7</span><span class="token punctuation">;</span> 
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span>SpeedSet<span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>	<span class="token comment">//设置SPI1速度  </span>
	SPI1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span> 		<span class="token comment">//SPI设备使能	   </span>
<span class="token punctuation">}</span> 
<span class="token comment">//SPIx 读写一个字节</span>
<span class="token comment">//TxData:要写入的字节</span>
<span class="token comment">//返回值:读取到的字节</span>
u8 <span class="token function">SPI1_ReadWriteByte</span><span class="token punctuation">(</span>u8 TxData<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>				   			 
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SPI1<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待发送区空  </span>
	SPI1<span class="token operator">-&gt;</span>DR<span class="token operator">=</span>TxData<span class="token punctuation">;</span>	 	  <span class="token comment">//发送一个byte 	   </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SPI1<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//等待接收完一个byte   			    </span>
	<span class="token keyword">return</span> SPI1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>          <span class="token comment">//返回收到的数据				    </span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="33_IIC_1152"></a>3.3 IIC协议封装</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"myiic.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>

<span class="token comment">//初始化IIC</span>
<span class="token keyword">void</span> <span class="token function">IIC_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>					     
 	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>		<span class="token comment">//先使能外设IO PORTB时钟 							 </span>
	GPIOB<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token number">0X00FFFFFF</span><span class="token punctuation">;</span>	<span class="token comment">//PB6/7 推挽输出</span>
	GPIOB<span class="token operator">-&gt;</span>CRL<span class="token operator">|=</span><span class="token number">0X33000000</span><span class="token punctuation">;</span>	   
	GPIOB<span class="token operator">-&gt;</span>ODR<span class="token operator">|=</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span>     	<span class="token comment">//PB6,7 输出高</span>
<span class="token punctuation">}</span>
<span class="token comment">//产生IIC起始信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//sda线输出</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	  	  
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//START:when CLK is high,DATA change form high to low </span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//钳住I2C总线，准备发送或接收数据 </span>
<span class="token punctuation">}</span>	  
<span class="token comment">//产生IIC停止信号</span>
<span class="token keyword">void</span> <span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//sda线输出</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//STOP:when CLK is high DATA change form low to high</span>
 	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//发送I2C总线结束信号</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>							   	
<span class="token punctuation">}</span>
<span class="token comment">//等待应答信号到来</span>
<span class="token comment">//返回值：1，接收应答失败</span>
<span class="token comment">//        0，接收应答成功</span>
u8 <span class="token function">IIC_Wait_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 ucErrTime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//SDA设置为输入  </span>
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 
	<span class="token keyword">while</span><span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		ucErrTime<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ucErrTime<span class="token operator">&gt;</span><span class="token number">250</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">IIC_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//时钟输出0 	   </span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> 
<span class="token comment">//产生ACK应答</span>
<span class="token keyword">void</span> <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//不产生ACK应答		    </span>
<span class="token keyword">void</span> <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SDA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>					 				     
<span class="token comment">//IIC发送一个字节</span>
<span class="token comment">//返回从机有无应答</span>
<span class="token comment">//1，有应答</span>
<span class="token comment">//0，无应答			  </span>
<span class="token keyword">void</span> <span class="token function">IIC_Send_Byte</span><span class="token punctuation">(</span>u8 txd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>                        
    u8 t<span class="token punctuation">;</span>   
	<span class="token function">SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	    
    IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//拉低时钟开始数据传输</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>              
        IIC_SDA<span class="token operator">=</span><span class="token punctuation">(</span>txd<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span>
        txd<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span> 	  
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//对TEA5767这三个延时都是必须的</span>
		IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>	 
<span class="token punctuation">}</span> 	    
<span class="token comment">//读1个字节，ack=1时，发送ACK，ack=0，发送nACK   </span>
u8 <span class="token function">IIC_Read_Byte</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> ack<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span>receive<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SDA设置为输入</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span> <span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
        IIC_SCL<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		IIC_SCL<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        receive<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>READ_SDA<span class="token punctuation">)</span>receive<span class="token operator">++</span><span class="token punctuation">;</span>   
		<span class="token function">delay_us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>					 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span>
        <span class="token function">IIC_NAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送nACK</span>
    <span class="token keyword">else</span>
        <span class="token function">IIC_Ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//发送ACK   </span>
    <span class="token keyword">return</span> receive<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="34_ADC_1275"></a>3.4 ADC代码封装</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"adc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span>					   </span>
	
<span class="token comment">//初始化ADC1</span>
<span class="token comment">//这里我们仅以规则通道为例</span>
<span class="token comment">//我们默认仅开启通道1																	   </span>
<span class="token keyword">void</span>  <span class="token function">Adc_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>    
	<span class="token comment">//先初始化IO口</span>
 	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>    <span class="token comment">//使能PORTA口时钟 </span>
	GPIOA<span class="token operator">-&gt;</span>CRL<span class="token operator">&amp;=</span><span class="token number">0XFFFFFF0F</span><span class="token punctuation">;</span><span class="token comment">//PA1 anolog输入 </span>
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span>    <span class="token comment">//ADC1时钟使能	  </span>
	RCC<span class="token operator">-&gt;</span>APB2RSTR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">;</span>   <span class="token comment">//ADC1复位</span>
	RCC<span class="token operator">-&gt;</span>APB2RSTR<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//复位结束	    </span>
	RCC<span class="token operator">-&gt;</span>CFGR<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//分频因子清零	</span>
	<span class="token comment">//SYSCLK/DIV2=12M ADC时钟设置为12M,ADC最大时钟不能超过14M!</span>
	<span class="token comment">//否则将导致ADC准确度下降! </span>
	RCC<span class="token operator">-&gt;</span>CFGR<span class="token operator">|=</span><span class="token number">2</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">;</span>      	 
	ADC1<span class="token operator">-&gt;</span>CR1<span class="token operator">&amp;=</span><span class="token number">0XF0FFFF</span><span class="token punctuation">;</span>   <span class="token comment">//工作模式清零</span>
	ADC1<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>      <span class="token comment">//独立工作模式  </span>
	ADC1<span class="token operator">-&gt;</span>CR1<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//非扫描模式	  </span>
	ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//单次转换模式</span>
	ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   
	ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token number">17</span><span class="token punctuation">;</span>	   <span class="token comment">//软件控制转换  </span>
	ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token punctuation">;</span>      <span class="token comment">//使用用外部触发(SWSTART)!!!	必须使用一个事件来触发</span>
	ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//右对齐	 </span>
	
	ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">23</span><span class="token punctuation">;</span>      <span class="token comment">//使能温度传感器</span>

	ADC1<span class="token operator">-&gt;</span>SQR1<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0XF</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ADC1<span class="token operator">-&gt;</span>SQR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token punctuation">;</span>     <span class="token comment">//1个转换在规则序列中 也就是只转换规则序列1 			   </span>
	<span class="token comment">//设置通道1的采样时间</span>
	ADC1<span class="token operator">-&gt;</span>SMPR2<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//通道1采样时间清空	  </span>
 	ADC1<span class="token operator">-&gt;</span>SMPR2<span class="token operator">|=</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通道1  239.5周期,提高采样时间可以提高精确度	 </span>

	ADC1<span class="token operator">-&gt;</span>SMPR1<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清除通道16原来的设置	 </span>
	ADC1<span class="token operator">-&gt;</span>SMPR1<span class="token operator">|=</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通道16  239.5周期,提高采样时间可以提高精确度	 </span>

	ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>	   <span class="token comment">//开启AD转换器	 </span>
	ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>       <span class="token comment">//使能复位校准  </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//等待校准结束 			 </span>
    <span class="token comment">//该位由软件设置并由硬件清除。在校准寄存器被初始化后该位将被清除。 		 </span>
	ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment">//开启AD校准	   </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//等待校准结束</span>
	<span class="token comment">//该位由软件设置以开始校准，并在校准结束时由硬件清除  </span>
<span class="token punctuation">}</span>				  
<span class="token comment">//获得ADC1某个通道的值</span>
<span class="token comment">//ch:通道值 0~16</span>
<span class="token comment">//返回值:转换结果</span>
u16 <span class="token function">Get_Adc</span><span class="token punctuation">(</span>u8 ch<span class="token punctuation">)</span>   
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//设置转换序列	  		 </span>
	ADC1<span class="token operator">-&gt;</span>SQR3<span class="token operator">&amp;=</span><span class="token number">0XFFFFFFE0</span><span class="token punctuation">;</span><span class="token comment">//规则序列1 通道ch</span>
	ADC1<span class="token operator">-&gt;</span>SQR3<span class="token operator">|=</span>ch<span class="token punctuation">;</span>		  			    
	ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">22</span><span class="token punctuation">;</span>       <span class="token comment">//启动规则转换通道 </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ADC1<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待转换结束	 	   </span>
	<span class="token keyword">return</span> ADC1<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>		<span class="token comment">//返回adc值	</span>
<span class="token punctuation">}</span>
<span class="token comment">//获取通道ch的转换值，取times次,然后平均 </span>
<span class="token comment">//ch:通道编号</span>
<span class="token comment">//times:获取次数</span>
<span class="token comment">//返回值:通道ch的times次转换结果平均值</span>
u16 <span class="token function">Get_Adc_Average</span><span class="token punctuation">(</span>u8 ch<span class="token punctuation">,</span>u8 times<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 temp_val<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 t<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>t<span class="token operator">&lt;</span>times<span class="token punctuation">;</span>t<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		temp_val<span class="token operator">+=</span><span class="token function">Get_Adc</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> temp_val<span class="token operator">/</span>times<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//得到温度值</span>
<span class="token comment">//返回值:温度值(扩大了100倍,单位:℃.)</span>
<span class="token keyword">short</span> <span class="token function">Get_Temprate</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 adcx<span class="token punctuation">;</span>
	<span class="token keyword">short</span> result<span class="token punctuation">;</span>
 	<span class="token keyword">double</span> temperate<span class="token punctuation">;</span>
	adcx<span class="token operator">=</span><span class="token function">Get_Adc_Average</span><span class="token punctuation">(</span>ADC_CH_TEMP<span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//读取通道16,20次取平均</span>
	temperate<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>adcx<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">3.3</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//电压值 </span>
	temperate<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1.43</span><span class="token operator">-</span>temperate<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">0.0043</span><span class="token operator">+</span><span class="token number">25</span><span class="token punctuation">;</span>	<span class="token comment">//转换为温度值 	 </span>
	result<span class="token operator">=</span>temperate<span class="token operator">*=</span><span class="token number">100</span><span class="token punctuation">;</span>					<span class="token comment">//扩大100倍.</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token comment">//初始化ADC3</span>
<span class="token comment">//这里我们仅以规则通道为例</span>
<span class="token comment">//我们默认仅开启通道6																	   </span>
<span class="token keyword">void</span>  <span class="token function">Adc3_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>      
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">;</span>   <span class="token comment">//ADC3时钟使能	  </span>
	RCC<span class="token operator">-&gt;</span>APB2RSTR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">;</span>   <span class="token comment">//ADC复位</span>
	RCC<span class="token operator">-&gt;</span>APB2RSTR<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//复位结束	    </span>
	RCC<span class="token operator">-&gt;</span>CFGR<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//分频因子清零	 </span>
	<span class="token comment">//SYSCLK/DIV2=12M ADC时钟设置为12M,ADC最大时钟不能超过14M!</span>
	<span class="token comment">//否则将导致ADC准确度下降! </span>
	RCC<span class="token operator">-&gt;</span>CFGR<span class="token operator">|=</span><span class="token number">2</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">;</span>      	 
	ADC3<span class="token operator">-&gt;</span>CR1<span class="token operator">&amp;=</span><span class="token number">0XF0FFFF</span><span class="token punctuation">;</span>   <span class="token comment">//工作模式清零</span>
	ADC3<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">;</span>      <span class="token comment">//独立工作模式  </span>
	ADC3<span class="token operator">-&gt;</span>CR1<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//非扫描模式	  </span>
	ADC3<span class="token operator">-&gt;</span>CR2<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//单次转换模式</span>
	ADC3<span class="token operator">-&gt;</span>CR2<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   
	ADC3<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token number">17</span><span class="token punctuation">;</span>	   <span class="token comment">//软件控制转换  </span>
	ADC3<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token punctuation">;</span>      <span class="token comment">//使用用外部触发(SWSTART)!!!	必须使用一个事件来触发</span>
	ADC3<span class="token operator">-&gt;</span>CR2<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//右对齐	   </span>
	ADC3<span class="token operator">-&gt;</span>SQR1<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">0XF</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ADC3<span class="token operator">-&gt;</span>SQR1<span class="token operator">|=</span><span class="token number">0</span><span class="token operator">&lt;&lt;</span><span class="token number">20</span><span class="token punctuation">;</span>     <span class="token comment">//1个转换在规则序列中 也就是只转换规则序列1 			   </span>
	<span class="token comment">//设置通道1的采样时间</span>
	ADC3<span class="token operator">-&gt;</span>SMPR2<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通道6采样时间清空	  </span>
 	ADC3<span class="token operator">-&gt;</span>SMPR2<span class="token operator">|=</span><span class="token number">7</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//通道6  239.5个周期,提高采样时间可以提高精确度	</span>

	ADC3<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>	   <span class="token comment">//开启AD转换器	 </span>
	ADC3<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>       <span class="token comment">//使能复位校准  </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ADC1<span class="token operator">-&gt;</span>CR2<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//等待校准结束 			 </span>
    <span class="token comment">//该位由软件设置并由硬件清除。在校准寄存器被初始化后该位将被清除。 		 </span>
	ADC3<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>        <span class="token comment">//开启AD校准	   </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ADC3<span class="token operator">-&gt;</span>CR2<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//等待校准结束</span>
	<span class="token comment">//该位由软件设置以开始校准，并在校准结束时由硬件清除  </span>
<span class="token punctuation">}</span>		 
<span class="token comment">//获得ADC3某个通道的值</span>
<span class="token comment">//ch:通道值 0~16</span>
<span class="token comment">//返回值:转换结果</span>
u16 <span class="token function">Get_Adc3</span><span class="token punctuation">(</span>u8 ch<span class="token punctuation">)</span>   
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//设置转换序列	  		 </span>
	ADC3<span class="token operator">-&gt;</span>SQR3<span class="token operator">&amp;=</span><span class="token number">0XFFFFFFE0</span><span class="token punctuation">;</span><span class="token comment">//规则序列1 通道ch</span>
	ADC3<span class="token operator">-&gt;</span>SQR3<span class="token operator">|=</span>ch<span class="token punctuation">;</span>		  			    
	ADC3<span class="token operator">-&gt;</span>CR2<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">22</span><span class="token punctuation">;</span>       <span class="token comment">//启动规则转换通道 </span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ADC3<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待转换结束	 	   </span>
	<span class="token keyword">return</span> ADC3<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span>		<span class="token comment">//返回adc值	</span>
<span class="token punctuation">}</span> 
</code></pre> 
<h3><a id="35__1414"></a>3.5 串口配置代码</h3> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart3.h"</span>	  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdarg.h"</span>	 	 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span>	 	 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"timer.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"ucos_ii.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"malloc.h"</span></span>


<span class="token comment">//串口接收缓存区 	</span>
u8 USART3_RX_BUF<span class="token punctuation">[</span>USART3_MAX_RECV_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span> 				<span class="token comment">//接收缓冲,最大USART3_MAX_RECV_LEN个字节.</span>


<span class="token comment">//通过判断接收连续2个字符之间的时间差不大于10ms来决定是不是一次连续的数据.</span>
<span class="token comment">//如果2个字符接收间隔超过10ms,则认为不是1次连续数据.也就是超过10ms没有接收到</span>
<span class="token comment">//任何数据,则表示此次接收完毕.</span>
<span class="token comment">//接收到的数据状态</span>
<span class="token comment">//[15]:0,没有接收到数据;1,接收到了一批数据.</span>
<span class="token comment">//[14:0]:接收到的数据长度</span>
vu16 USART3_RX_STA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>   	 
<span class="token keyword">void</span> <span class="token function">USART3_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 res<span class="token punctuation">;</span>	    
	<span class="token function">OSIntEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
	<span class="token keyword">if</span><span class="token punctuation">(</span>USART3<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//接收到数据</span>
	<span class="token punctuation">{<!-- --></span>	 
		res<span class="token operator">=</span>USART3<span class="token operator">-&gt;</span>DR<span class="token punctuation">;</span> 			 
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART3_RX_STA<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//接收完的一批数据,还没有被处理,则不再接收其他数据</span>
		<span class="token punctuation">{<!-- --></span> 
			<span class="token keyword">if</span><span class="token punctuation">(</span>USART3_RX_STA<span class="token operator">&lt;</span>USART3_MAX_RECV_LEN<span class="token punctuation">)</span>	<span class="token comment">//还可以接收数据</span>
			<span class="token punctuation">{<!-- --></span>
				TIM7<span class="token operator">-&gt;</span>CNT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>         				<span class="token comment">//计数器清空</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>USART3_RX_STA<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 				<span class="token comment">//使能定时器7的中断 </span>
				<span class="token punctuation">{<!-- --></span>
					TIM7<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">;</span>     			<span class="token comment">//使能定时器7</span>
				<span class="token punctuation">}</span>
				USART3_RX_BUF<span class="token punctuation">[</span>USART3_RX_STA<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>res<span class="token punctuation">;</span>	<span class="token comment">//记录接收到的值	 </span>
			<span class="token punctuation">}</span><span class="token keyword">else</span> 
			<span class="token punctuation">{<!-- --></span>
				USART3_RX_STA<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">;</span>				<span class="token comment">//强制标记接收完成</span>
			<span class="token punctuation">}</span> 
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>  											 
	<span class="token function">OSIntExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  											 
<span class="token punctuation">}</span>   
<span class="token comment">//初始化IO 串口3</span>
<span class="token comment">//pclk1:PCLK1时钟频率(Mhz)</span>
<span class="token comment">//bound:波特率 </span>
<span class="token keyword">void</span> <span class="token function">usart3_init</span><span class="token punctuation">(</span>u32 pclk1<span class="token punctuation">,</span>u32 bound<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  	 
	RCC<span class="token operator">-&gt;</span>APB2ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>   	<span class="token comment">//使能PORTB口时钟  </span>
 	GPIOB<span class="token operator">-&gt;</span>CRH<span class="token operator">&amp;=</span><span class="token number">0XFFFF00FF</span><span class="token punctuation">;</span>	<span class="token comment">//IO状态设置</span>
	GPIOB<span class="token operator">-&gt;</span>CRH<span class="token operator">|=</span><span class="token number">0X00008B00</span><span class="token punctuation">;</span>	<span class="token comment">//IO状态设置 </span>
	
	RCC<span class="token operator">-&gt;</span>APB1ENR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">18</span><span class="token punctuation">;</span>  	<span class="token comment">//使能串口时钟 	 </span>
	RCC<span class="token operator">-&gt;</span>APB1RSTR<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">18</span><span class="token punctuation">;</span>   <span class="token comment">//复位串口3</span>
	RCC<span class="token operator">-&gt;</span>APB1RSTR<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//停止复位	</span>
	<span class="token comment">//波特率设置</span>
 	USART3<span class="token operator">-&gt;</span>BRR<span class="token operator">=</span><span class="token punctuation">(</span>pclk1<span class="token operator">*</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>bound<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 波特率设置	 </span>
	USART3<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">0X200C</span><span class="token punctuation">;</span>  	<span class="token comment">//1位停止,无校验位.</span>
	<span class="token comment">//使能接收中断 </span>
	USART3<span class="token operator">-&gt;</span>CR1<span class="token operator">|=</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">;</span>    	<span class="token comment">//接收缓冲区非空中断使能	    	</span>
	<span class="token function">MY_NVIC_Init</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>USART3_IRQn<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//组2</span>
	<span class="token function">TIM7_Int_Init</span><span class="token punctuation">(</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">7199</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//10ms中断</span>
	TIM7<span class="token operator">-&gt;</span>CR1<span class="token operator">&amp;=</span><span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//关闭定时器7</span>
	USART3_RX_STA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">//清零</span>
<span class="token punctuation">}</span>

<span class="token comment">//串口3,printf 函数</span>
<span class="token comment">//确保一次发送数据不超过USART3_MAX_SEND_LEN字节</span>
<span class="token keyword">void</span> <span class="token function">u3_printf</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> fmt<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  
<span class="token punctuation">{<!-- --></span>  
	u16 i<span class="token punctuation">,</span>j<span class="token punctuation">;</span>
	u8 <span class="token operator">*</span>pbuf<span class="token punctuation">;</span>
	va_list ap<span class="token punctuation">;</span>
	pbuf<span class="token operator">=</span><span class="token function">mymalloc</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>USART3_MAX_SEND_LEN<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//申请内存</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>pbuf<span class="token punctuation">)</span>									<span class="token comment">//内存申请失败</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"u3 malloc error\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span>fmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">vsprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>pbuf<span class="token punctuation">,</span>fmt<span class="token punctuation">,</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	i<span class="token operator">=</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>pbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//此次发送数据的长度</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>i<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span>							<span class="token comment">//循环发送数据</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>USART3<span class="token operator">-&gt;</span>SR<span class="token operator">&amp;</span><span class="token number">0X40</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//循环发送,直到发送完毕   </span>
		USART3<span class="token operator">-&gt;</span>DR<span class="token operator">=</span>pbuf<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>  
	<span class="token punctuation">}</span>
	<span class="token function">myfree</span><span class="token punctuation">(</span>SRAMIN<span class="token punctuation">,</span>pbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">//释放内存</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_1516"></a>四、上位机开发</h2> 
<p>为了方便查看设备上传的数据，接下来利用Qt开发一款Android手机APP 和 Windows上位机。</p> 
<p>使用华为云平台提供的API接口获取设备上传的数据，进行可视化显示，以及远程控制设备。</p> 
<h3><a id="41_Qt_1522"></a>4.1 Qt开发环境安装</h3> 
<p>Qt的中文官网： https://www.qt.io/zh-cn/<img src="https://images2.imgbox.com/b6/f6/ag3cuTSF_o.png" alt="image-20221207160550486"></p> 
<p><img src="https://images2.imgbox.com/ba/8b/LsAnyGT2_o.png" alt="image-20221207160606892"></p> 
<p>QT5.12.6的下载地址：https://download.qt.io/archive/qt/5.12/5.12.6</p> 
<p>打开下载链接后选择下面的版本进行下载：</p> 
<p><code>qt-opensource-windows-x86-5.12.6.exe 13-Nov-2019 07:28 3.7G Details</code></p> 
<p>软件安装时断网安装，否则会提示输入账户。</p> 
<p>安装的时候，第一个复选框里勾选一个<code>mingw 32</code>编译器即可，其他的不管默认就行，直接点击下一步继续安装。</p> 
<p><img src="https://images2.imgbox.com/39/5a/qhNCm6as_o.png" alt="image-20221203151742653"></p> 
<p><strong>选择MinGW 32-bit 编译器： （一定要看清楚了）</strong></p> 
<p><img src="https://images2.imgbox.com/1b/cd/YEgjy0KV_o.png" alt="image-20221203151750344"></p> 
<p><strong>说明：</strong> 我这里只是介绍PC端，也就是Windows系统下的Qt环境搭建。 Android的开发环境比较麻烦，如果想学习Android开发，想编译Android程序的APP，需要自己去搭建Android环境。</p> 
<p><strong>也可以看下面这篇文章，不过这个文章是在Qt开发专栏里付费的，需要订阅专栏才可以看。 如果不想付费看，也可以自行找其他教程，自己搭建好必须的环境就行了</strong></p> 
<p><strong>Android环境搭建的博客链接：</strong> https://blog.csdn.net/xiaolong1126626497/article/details/117254453</p> 
<h3><a id="42__1562"></a>4.2 新建上位机工程</h3> 
<p>前面2讲解了需要用的API接口，接下来就使用Qt设计上位机，设计界面，完成整体上位机的逻辑设计。</p> 
<p>【1】新建工程</p> 
<p><img src="https://images2.imgbox.com/47/6f/WZkZ2dMw_o.png" alt="image-20240117144052547"></p> 
<p>【2】设置项目的名称。</p> 
<p><img src="https://images2.imgbox.com/5f/53/7m4RwsIo_o.png" alt="image-20240509195711965"></p> 
<p>【3】选择编译系统</p> 
<p><img src="https://images2.imgbox.com/3a/bc/9cWLTwBc_o.png" alt="image-20240117144239681"></p> 
<p>【4】选择默认继承的类</p> 
<p><img src="https://images2.imgbox.com/dd/82/Ca2QBvXW_o.png" alt="image-20240117144302275"></p> 
<p>【5】选择编译器</p> 
<p><img src="https://images2.imgbox.com/41/f1/Epc04vVE_o.png" alt="image-20240314162137170"></p> 
<p>【6】点击完成</p> 
<p><img src="https://images2.imgbox.com/c9/e1/ZBAIihUB_o.png" alt="image-20240117144354252"></p> 
<p>【7】工程创建完成</p> 
<p><img src="https://images2.imgbox.com/2a/eb/gxKLhKgc_o.png" alt="image-20230421094133333"></p> 
<h3><a id="43_UI_1616"></a>4.3 设计UI界面与工程配置</h3> 
<h4><a id="1UI_1618"></a>【1】打开UI文件</h4> 
<p><img src="https://images2.imgbox.com/d5/6f/U4B1t6Ek_o.png" alt="image-20230421094815236"></p> 
<p><strong>打开默认的界面如下：</strong></p> 
<p><img src="https://images2.imgbox.com/e0/83/JVRYsUue_o.png" alt="image-20240425194845233"></p> 
<h4><a id="2_1632"></a>【2】开始设计界面</h4> 
<p>根据自己需求设计界面。</p> 
<p><img src="https://images2.imgbox.com/a2/85/WAO6maZ6_o.png" alt="image-20240620142003731"></p> 
<h3><a id="45_Windows_1642"></a>4.5 编译Windows上位机</h3> 
<p>点击软件左下角的绿色三角形按钮进行编译运行。</p> 
<p><img src="https://images2.imgbox.com/c4/64/ogtMyS8O_o.png" alt="image-20240509202031739"></p> 
<p><strong>编译之后的效果：</strong></p> 
<p><img src="https://images2.imgbox.com/61/86/9PL0aLqk_o.png" alt="image-20240620142229632"></p> 
<h3><a id="46_Android_1658"></a>4.6 配置Android环境</h3> 
<p>如果想编译Android手机APP，必须要先自己配置好自己的Android环境。（搭建环境的过程可以自行百度搜索学习）</p> 
<p>然后才可以进行下面的步骤。</p> 
<h4><a id="1Android_1668"></a>【1】选择Android编译器</h4> 
<p><img src="https://images2.imgbox.com/d0/10/p4mEl2ji_o.png" alt="image-20240425232651515"></p> 
<p><img src="https://images2.imgbox.com/57/f0/meDgBitg_o.png" alt="image-20240509202408776"></p> 
<h4><a id="2Android_1678"></a>【2】创建Android配置文件</h4> 
<p><img src="https://images2.imgbox.com/8a/dd/eYY8Pvg1_o.png" alt="image-20240117144604025"></p> 
<p><img src="https://images2.imgbox.com/79/65/praT3zgE_o.png" alt="image-20240117144635052"></p> 
<p><img src="https://images2.imgbox.com/3c/4f/OnWH0L9l_o.png" alt="image-20240117144652014"></p> 
<p>创建完成。</p> 
<h4><a id="3Android_1696"></a>【3】配置Android图标与名称</h4> 
<p><img src="https://images2.imgbox.com/f6/6b/o76akuhO_o.png" alt="image-20240612100947190"></p> 
<h4><a id="3Android_1702"></a>【3】编译Android上位机</h4> 
<p>Qt本身是跨平台的，直接选择Android的编译器，就可以将程序编译到Android平台。</p> 
<p>然后点击构建。</p> 
<p><img src="https://images2.imgbox.com/5e/9a/81hMjIh2_o.png" alt="image-20240509202534407"></p> 
<p>成功之后，在目录下可以看到生成的<code>apk</code>文件，也就是Android手机的安装包，电脑端使用<code>QQ</code>发送给手机QQ,手机登录QQ接收，就能直接安装。</p> 
<p>生成的<code>apk</code>的目录在哪里呢？ 编译完成之后，在控制台会输出APK文件的路径。</p> 
<p>知道目录在哪里之后，在Windows的文件资源管理器里，找到路径，具体看下图，找到生成的apk文件。</p> 
<p><img src="https://images2.imgbox.com/d6/58/MJcJIXe7_o.png" alt="image-20240509202712295"></p> 
<pre><code class="prism language-cpp">D<span class="token operator">:</span><span class="token operator">/</span>linux<span class="token operator">-</span>share<span class="token operator">-</span>dir<span class="token operator">/</span>QT<span class="token operator">/</span>build<span class="token operator">-</span>app_Huawei_Eco_tracking<span class="token operator">-</span>Android_for_arm64_v8a_Clang_Qt_5_12_6_for_Android_ARM64_v8a<span class="token operator">-</span>Release<span class="token operator">/</span>android<span class="token operator">-</span>build<span class="token comment">//build/outputs/apk/debug/android-build-debug.apk</span>
</code></pre> 
<h2><a id="_1730"></a>五、总结</h2> 
<p>本项目设计的智能冰箱系统，集成了物联网与智能控制技术，为用户提供一个高效、健康、互动性强的智能家居体验。</p> 
<p>总结其核心功能如下：</p> 
<p>（1）<strong>智能环境监测与调节</strong>：系统通过部署在不同区域的温湿度传感器与有害气体分析装置，实时监测冷藏、保鲜、冷冻区的环境状态，确保食物处于最适宜的保存条件下。当检测到异常状况，如温度偏高，系统能自动触发制冷机制，并通过手机APP推送红色预警，同时冰箱内置的蜂鸣器也会报警，实现多维度提醒。</p> 
<p>（2）<strong>远程控制与数据可视化</strong>：借助华为云IoT平台，用户可以通过定制的Qt(C++)手机APP远程监控冰箱状态，随时随地调整各区域温度设置，查看历史数据记录。冰箱门上的OLED显示屏则提供了直观的现场数据显示，增强了用户体验。</p> 
<p>（3）<strong>紫外线消毒与健康管理</strong>：特别设计的紫外线消毒灯功能，允许用户根据需要启动消毒程序，有效消灭冰箱内部的细菌和霉菌，为家庭饮食健康筑起一道防线。</p> 
<p>（4）<strong>高效能与低能耗</strong>：采用高效的STM32系列微控制器和稳压电源模块，确保系统运行稳定且节能。通过精准的温控策略，避免了不必要的能源消耗。</p> 
<p>（5）<strong>用户友好与个性化设置</strong>：手机APP界面简洁友好，支持用户根据生活习惯自定义冰箱设置，如温度偏好、消毒频率等，满足不同家庭成员的需求。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3126d57839fc045239fe28d0bdc6c32e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">idea代码快速提示工具——Fitten Code插件安装，比Copilot更快！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c133b3fcc0def79e6a5b3105309fe0b1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">计算机必背单词——数据库</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>