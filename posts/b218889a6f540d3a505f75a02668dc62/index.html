<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>调用阿里通义千问大语言模型API-小白新手教程-python - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/b218889a6f540d3a505f75a02668dc62/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="调用阿里通义千问大语言模型API-小白新手教程-python">
  <meta property="og:description" content="阿里大语言模型通义千问API使用新手教程 最近需要用到大模型，了解到目前国产大模型中，阿里的通义千问有比较详细的SDK文档可进行二次开发,目前通义千问的API文档其实是可以进行精简然后学习的,也就是说，是可以通过简单的API调用在自己网页或者软件中接入一个大语言模型，但是似乎并没有人愿意花费时间经历写一个新手友好的教程，为此处于对知识的梳理，和对技术的热爱，我尽我的最大的努力来做这件事，如果帮到了各位同学，或者老师们，可以点赞或者关注支持一下，后续更新基于本地知识库的详细教程。如果有什么写的不对的或者可以补充完善的，欢迎交流。
系列文章：
1.调用阿里通义千问大语言模型API-小白新手教程-python
2.LangChain结合通义千问的自建知识库
3.使用LangChain结合通义千问API基于自建知识库的多轮对话和流式输出
4.解决LangChain构建知识向量库的过程中官方API无法自定义文本切割方式的问题-例如按行切分
5.通义千问本地部署教程Qwen-7B-Chat Qwen1.5-1.8B Windows-详细认真版
对于有基础的开发技术人员请直接根据目录跳到代码部分综合查看官方文档和代码即可对于想充实自己毕业设计或者软件但对自然语言处理技术并不是非常了解的同学，把每一个代码运行一遍即可，切记不要纠结专业术语如果是做相关应用的研究生，请按顺序阅读，思考数据格式，有助于思维的培养 文章目录 阿里大语言模型通义千问API使用新手教程1.通义千问模型介绍 2024.4.26 更新 模型的API-KEY收费了2.通义千问API-KEY申请3.安装DashScope SDK4.API-KEY设置4.1 方式1 可以直接在命令台设置环境变量4.2 方式2 在系统环境变量里直接设置4.3 方式3 通过代码设置4.4 方式经验总结 5. 使用通义千问API进行Token切分6. 使用通义千问的API进行对话6.1 通过messages 进行对话 开发推荐6.2 通过prompt进行对话 新手推荐6.3 多轮对话6.4 流式输出 7.通过控制台输入实现多轮对话-非流式输出8.通过控制台输入实现多轮对话-流式输出9.参考文档链接总结资源绑定 1.通义千问模型介绍 ​ 通义千问是阿里云开发的大语言模型(Large language Model )LLM,旨在提供广泛的知识和普适性，可以理解和回答各领域中的问题，其包含网页版和手机版本的通义前文APP，网页使用的模型为不公开的最新版本。
其网页使用版本地址：https://tongyi.aliyun.com/qianwen/
官网文档地址：https://help.aliyun.com/zh/dashscope/developer-reference/
​ 在其官方文档中主要开源了五种可以使用的模型其开源模型的简介和参数如下:
2024.4.26 更新 模型的API-KEY收费了 我之前用的Max 然后用着用着账户就欠费了 ，然后整个账户的API-Key就都不能用了，后来在控制台部分消息，和手机短信发现是有短信提示，但是我一直没注意，没想到这个事情，大家之前用免费KEY的要注意一下
(旧)
​ 非限时免费开放模型，有使用Token数量的限制
2.通义千问API-KEY申请 官方流程网址指导：https://help.aliyun.com/zh/dashscope/developer-reference/activate-dashscope-and-create-an-api-key
其主要流程如下，具体请参考官网步骤
开通DashScope灵积模型服务 创建API-KEY 根据官网流程获得一个API-Key
3.安装DashScope SDK DashScope 目前支持Python 和 Java 的 SDK
安装SDK的官网教程网址：https://help.aliyun.com/zh/dashscope/developer-reference/install-dashscope-sdk">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-29T23:11:16+08:00">
    <meta property="article:modified_time" content="2024-04-29T23:11:16+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">调用阿里通义千问大语言模型API-小白新手教程-python</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="API_0"></a>阿里大语言模型通义千问API使用新手教程</h2> 
<p>       最近需要用到大模型，了解到目前国产大模型中，阿里的通义千问有比较详细的SDK文档可进行二次开发,目前通义千问的API文档其实是可以进行精简然后学习的,也就是说，是<strong>可以通过简单的API调用在自己网页或者软件中接入一个大语言模型</strong>，但是似乎并没有人愿意花费时间经历写一个新手友好的教程，为此处于对知识的梳理，和对技术的热爱，我尽我的最大的努力来做这件事，如果帮到了各位同学，或者老师们，可以点赞或者关注支持一下，后续更新基于本地知识库的详细教程。如果有什么写的不对的或者可以补充完善的，欢迎交流。</p> 
<hr> 
<p>系列文章：<br> <a href="https://chen-hao.blog.csdn.net/article/details/135868918" rel="nofollow">1.调用阿里通义千问大语言模型API-小白新手教程-python</a><br> <a href="https://chen-hao.blog.csdn.net/article/details/135992512" rel="nofollow">2.LangChain结合通义千问的自建知识库</a><br> <a href="https://chen-hao.blog.csdn.net/article/details/136174938" rel="nofollow">3.使用LangChain结合通义千问API基于自建知识库的多轮对话和流式输出</a><br> <a href="https://blog.csdn.net/chrnhao/article/details/136646004">4.解决LangChain构建知识向量库的过程中官方API无法自定义文本切割方式的问题-例如按行切分</a><br> <a href="https://chen-hao.blog.csdn.net/article/details/136284249" rel="nofollow">5.通义千问本地部署教程Qwen-7B-Chat Qwen1.5-1.8B Windows-详细认真版</a></p> 
<ul><li>对于有基础的开发技术人员请直接根据目录跳到代码部分综合查看官方文档和代码即可</li><li>对于想充实自己毕业设计或者软件但对自然语言处理技术并不是非常了解的同学，把每一个代码运行一遍即可，切记不要纠结专业术语</li><li>如果是做相关应用的研究生，请按顺序阅读，思考数据格式，有助于思维的培养</li></ul> 
<p><img src="https://images2.imgbox.com/fe/de/apNv1Tzq_o.gif" alt="在这里插入图片描述"><br> </p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#API_0" rel="nofollow">阿里大语言模型通义千问API使用新手教程</a></li><li><ul><li><a href="#1_20" rel="nofollow">1.通义千问模型介绍</a></li></ul> 
  </li><li><a href="#2024426__APIKEY_29" rel="nofollow">2024.4.26 更新 模型的API-KEY收费了</a></li><li><ul><li><a href="#2APIKEY_39" rel="nofollow">2.通义千问API-KEY申请</a></li><li><a href="#3DashScope_SDK_53" rel="nofollow">3.安装DashScope SDK</a></li><li><a href="#4APIKEY_77" rel="nofollow">4.API-KEY设置</a></li><li><ul><li><a href="#41_1__80" rel="nofollow">4.1 方式1 可以直接在命令台设置环境变量</a></li><li><a href="#42_2__87" rel="nofollow">4.2 方式2 在系统环境变量里直接设置</a></li><li><a href="#43_3__92" rel="nofollow">4.3 方式3 通过代码设置</a></li><li><a href="#44__103" rel="nofollow">4.4 方式经验总结</a></li></ul> 
   </li><li><a href="#5_APIToken_109" rel="nofollow">5. 使用通义千问API进行Token切分</a></li><li><a href="#6_API_168" rel="nofollow">6. 使用通义千问的API进行对话</a></li><li><ul><li><a href="#61_messages___173" rel="nofollow">6.1 通过messages 进行对话 开发推荐</a></li><li><a href="#62_prompt__225" rel="nofollow">6.2 通过prompt进行对话 新手推荐</a></li><li><a href="#63__279" rel="nofollow">6.3 多轮对话</a></li><li><a href="#64__382" rel="nofollow">6.4 流式输出</a></li></ul> 
   </li><li><a href="#7_443" rel="nofollow">7.通过控制台输入实现多轮对话-非流式输出</a></li><li><a href="#8_480" rel="nofollow">8.通过控制台输入实现多轮对话-流式输出</a></li><li><a href="#9_512" rel="nofollow">9.参考文档链接总结</a></li><li><a href="#_520" rel="nofollow">资源绑定</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1_20"></a>1.通义千问模型介绍</h3> 
<p>​ 通义千问是阿里云开发的大语言模型(Large language Model )LLM,旨在提供广泛的知识和普适性，可以理解和回答各领域中的问题，其包含网页版和手机版本的通义前文APP，<strong>网页使用的模型为不公开的最新版本</strong>。<br> 其网页使用版本地址：<a href="https://tongyi.aliyun.com/qianwen/" rel="nofollow">https://tongyi.aliyun.com/qianwen/</a><br> 官网文档地址：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/</a><br> <img src="https://images2.imgbox.com/28/26/tOg5jqRh_o.png" alt="在这里插入图片描述"></p> 
<p>​ 在其官方文档中主要开源了五种可以使用的模型其开源模型的简介和参数如下:</p> 
<h2><a id="2024426__APIKEY_29"></a>2024.4.26 更新 模型的API-KEY收费了</h2> 
<p><img src="https://images2.imgbox.com/4e/18/ehWSG316_o.png" alt="在这里插入图片描述"><br> <strong>我之前用的Max 然后用着用着账户就欠费了 ，然后整个账户的API-Key就都不能用了，后来在控制台部分消息，和手机短信发现是有短信提示，但是我一直没注意，没想到这个事情，大家之前用免费KEY的要注意一下</strong></p> 
<p>(旧)<img src="https://images2.imgbox.com/2f/61/UPKSIWSr_o.png" alt="在这里插入图片描述"></p> 
<p>​ <strong>非限时免费开放模型，有使用Token数量的限制</strong></p> 
<h3><a id="2APIKEY_39"></a>2.通义千问API-KEY申请</h3> 
<p>官方流程网址指导：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/activate-dashscope-and-create-an-api-key" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/activate-dashscope-and-create-an-api-key</a></p> 
<p>其主要流程如下，具体请参考官网步骤</p> 
<ol><li>开通DashScope灵积模型服务</li></ol> 
<p><img src="https://images2.imgbox.com/55/13/1uTFgeoK_o.png" alt="在这里插入图片描述"></p> 
<ol start="2"><li>创建API-KEY</li></ol> 
<p>根据官网流程获得一个API-Key<br> <img src="https://images2.imgbox.com/e2/08/EPXTo8Yu_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3DashScope_SDK_53"></a>3.安装DashScope SDK</h3> 
<p>DashScope 目前支持Python 和 Java 的 SDK</p> 
<p>安装SDK的官网教程网址：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/install-dashscope-sdk" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/install-dashscope-sdk<br> </a><br> 这里介绍python的安装</p> 
<ul><li>安装环境 Python 3.8 及以上版本</li></ul> 
<p>执行以下命令安装SDK，亲测支持清华园镜像安装</p> 
<pre><code class="prism language-cmd">pip install dashscope
</code></pre> 
<p>更新DashDcope SDK包 请执行以下命令</p> 
<pre><code>pip install dashscope --upgrade
</code></pre> 
<h3><a id="4APIKEY_77"></a>4.API-KEY设置</h3> 
<p>API-KEY设置地址官方文档网址：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/api-key-settings" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/api-key-settings</a></p> 
<h4><a id="41_1__80"></a>4.1 方式1 可以直接在命令台设置环境变量</h4> 
<p>Linux/maxOS</p> 
<pre><code class="prism language-CMD">export DASHSCOPE_API_KEY="YOUR_DASHSCOPE_API_KEY"
</code></pre> 
<h4><a id="42_2__87"></a>4.2 方式2 在系统环境变量里直接设置</h4> 
<p><img src="https://images2.imgbox.com/00/27/oG2IPt73_o.png" alt=""></p> 
<h4><a id="43_3__92"></a>4.3 方式3 通过代码设置</h4> 
<p>python设置API-KEY代码如下</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> dashscope
dashscope<span class="token punctuation">.</span>api_key<span class="token operator">=</span><span class="token string">"YOUR_DASHSCOPE_API_KEY"</span>
</code></pre> 
<h4><a id="44__103"></a>4.4 方式经验总结</h4> 
<p>其中官方推荐使用4.1的方式不推荐将API-KEY直接写在代码中，会有一定的API-KEY暴露风险，实际应用中，配置的环境变量有时会出现读取不到的情况，此时将API-KEY写在代码中可以使程序正常运行。</p> 
<h3><a id="5_APIToken_109"></a>5. 使用通义千问API进行Token切分</h3> 
<p>使用通义千问对Token进行切分官方文档网址：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/token-api" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/token-api</a></p> 
<p>精简版如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> dashscope

<span class="token comment"># 如果环境变量配置无效请启用以下代码</span>
<span class="token comment"># dashscope.api_key = 'YOUR_DASHSCOPE_API_KEY'</span>

<span class="token comment"># respose获得的为</span>
response <span class="token operator">=</span> dashscope<span class="token punctuation">.</span>Tokenization<span class="token punctuation">.</span>call<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'qwen-turbo'</span><span class="token punctuation">,</span>messages<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'你好？'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>

<span class="token comment"># {"status_code": 200, "request_id": "6d53e094-e8bc-9d88-a84a-6085c9425ad8", "code": "", "message": "", "output": {"token_ids": [108386, 11319], "tokens": ["你好", "？"]}, "usage": {"input_tokens": 2}}</span>
</code></pre> 
<blockquote> 
 <p>消息格式为一个列表，<code>role</code>为当前角色设置为user则模拟为用户的真实输入，<code>content</code>后面为要切分tokens的句子</p> 
</blockquote> 
<pre><code>messages=[{'role': 'user', 'content': '你好？'}]
</code></pre> 
<ul><li><strong>可能会出现的错误1：系统配置了环境变量但是依然读取不到，错误中包含not find API 相关错误请启用以下代码</strong></li></ul> 
<pre><code>dashscope.api_key = 'YOUR_DASHSCOPE_API_KEY'
</code></pre> 
<ul><li><strong>可能会出现的错误2： 错误中出现Http相关字样，其主要可能原因是网络问题，请检查网络状态是否断网或者是是国内地址</strong></li></ul> 
<p>官方代码对出现Http错误的情况进行了判断，官方代码如下</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> http <span class="token keyword">import</span> HTTPStatus
<span class="token keyword">import</span> dashscope


<span class="token keyword">def</span> <span class="token function">tokenizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> dashscope<span class="token punctuation">.</span>Tokenization<span class="token punctuation">.</span>call<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'qwen-turbo'</span><span class="token punctuation">,</span>
                                 messages<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'你好？'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 <span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> HTTPStatus<span class="token punctuation">.</span>OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Result is: %s'</span> <span class="token operator">%</span> response<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Failed request_id: %s, status_code: %s, code: %s, message:%s'</span> <span class="token operator">%</span>
              <span class="token punctuation">(</span>response<span class="token punctuation">.</span>request_id<span class="token punctuation">,</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span> response<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
               response<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    tokenizer<span class="token punctuation">(</span><span class="token punctuation">)</span>
   
</code></pre> 
<h3><a id="6_API_168"></a>6. 使用通义千问的API进行对话</h3> 
<p>使用通义千问进行对话API官方文档网址：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/quick-start" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/quick-start</a></p> 
<p>下面是对其中主要内容的</p> 
<h4><a id="61_messages___173"></a>6.1 通过messages 进行对话 开发推荐</h4> 
<p>精简版版代码如下，参数介绍在代码后：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> dashscope

<span class="token comment"># 如果环境变量配置无效请启用以下代码</span>
<span class="token comment"># dashscope.api_key = 'YOUR_DASHSCOPE_API_KEY'</span>

messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'如何做炒西红柿鸡蛋？'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>

response <span class="token operator">=</span> dashscope<span class="token punctuation">.</span>Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>dashscope<span class="token punctuation">.</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span>messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>

<span class="token comment"># {"status_code": 200, "request_id": "537d7681-8aa2-9f15-a17d-1b8492ad901f", "code": "", "message": "", "output": {"text": null, "finish_reason": null, "choices": [{"finish_reason": "stop", "message": {"role": "assistant", "content": "材料：鸡蛋2个，西红柿1个。\n\n做法：\n\n1. 鸡蛋打入碗中搅拌均匀备用；\n\n2. 西红柿洗净切块备用；\n\n3. 热锅凉油，油热后放入搅拌好的鸡蛋液，用筷子快速划散成小块，凝固即可盛出备用；\n\n4. 锅内再加少量底油，放入西红柿翻炒出汁，倒入炒好的鸡蛋，加入适量盐、糖调味翻匀即可。"}}]}, "usage": {"input_tokens": 12, "output_tokens": 106, "total_tokens": 118}}</span>
</code></pre> 
<ul><li><code>dashscope.Generation.call</code>中输入参数的介绍</li></ul> 
<p><code>dashscope.Generation.Models.qwen_turbo</code>选用的对话模型默认对应的是<code>model</code>参数</p> 
<p>也就是在代码中等效于</p> 
<pre><code class="prism language-python">dashscope<span class="token punctuation">.</span>Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>model <span class="token operator">=</span> dashscope<span class="token punctuation">.</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo
                          <span class="token punctuation">,</span>messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
</code></pre> 
<p>还有<code>dashscope.Generation</code>中还有<code>qwen_max</code> <code>qwen_plus</code>两个选项</p> 
<p>如果要使用其他模型例如<code>qwen-14b-chat</code>，前提是API有访问该模型的权限</p> 
<p>则对应代码为</p> 
<pre><code class="prism language-python">dashscope<span class="token punctuation">.</span>Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>model <span class="token operator">=</span> <span class="token string">'qwen-14b-chat'</span><span class="token punctuation">.</span>qwen_turbo
                          <span class="token punctuation">,</span>messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>messages</code>输入为对话角色和对话内容</p> 
<p>输入应为一个列表其对应的伪代如下</p> 
<pre><code>[{'role': '角色类型(使用user即可)', 'content': '对话文本'}]
</code></pre> 
<p><code>result_format</code>输出格式</p> 
<p><strong>该参数其实可以去掉，因为实际使用中我发现无论设置成什么都是message形式输出</strong></p> 
<h4><a id="62_prompt__225"></a>6.2 通过prompt进行对话 新手推荐</h4> 
<p>精简版代码如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> dashscope

<span class="token comment"># 如果环境变量配置无效请启用以下代码</span>
<span class="token comment"># dashscope.api_key = 'YOUR_DASHSCOPE_API_KEY'</span>

response <span class="token operator">=</span> dashscope<span class="token punctuation">.</span>Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>model<span class="token operator">=</span>dashscope<span class="token punctuation">.</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span>prompt<span class="token operator">=</span><span class="token string">'如何做炒西红柿鸡蛋？'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>output<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
材料：鸡蛋2个，西红柿1个。

做法：

1. 鸡蛋打入碗中搅拌均匀备用；

2. 西红柿洗净切块备用；

3. 热锅凉油，油热后放入搅拌好的鸡蛋液，用筷子快速划散成小块，凝固即可盛出备用；

4. 锅内再加少量底油，放入西红柿翻炒出汁，倒入炒好的鸡蛋，加入适量盐、糖调味翻匀即可。
'''</span>
</code></pre> 
<p>其作用就是不需要messages格式进行输入，只需要输入对话的内容即可</p> 
<p>官方代码</p> 
<pre><code class="prism language-python"><span class="token comment"># For prerequisites running the following sample, visit https://help.aliyun.com/document_detail/611472.html</span>
<span class="token keyword">from</span> http <span class="token keyword">import</span> HTTPStatus
<span class="token keyword">import</span> dashscope
<span class="token keyword">def</span> <span class="token function">call_with_prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    response <span class="token operator">=</span> dashscope<span class="token punctuation">.</span>Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>
        model<span class="token operator">=</span>dashscope<span class="token punctuation">.</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span>
        prompt<span class="token operator">=</span><span class="token string">'如何做炒西红柿鸡蛋？'</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># The response status_code is HTTPStatus.OK indicate success,</span>
    <span class="token comment"># otherwise indicate request is failed, you can get error code</span>
    <span class="token comment"># and message from code and message.</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> HTTPStatus<span class="token punctuation">.</span>OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>output<span class="token punctuation">)</span>  <span class="token comment"># The output text</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>usage<span class="token punctuation">)</span>  <span class="token comment"># The usage information</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>code<span class="token punctuation">)</span>  <span class="token comment"># The error code.</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>message<span class="token punctuation">)</span>  <span class="token comment"># The error message.</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    call_with_prompt<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="63__279"></a>6.3 多轮对话</h4> 
<blockquote> 
 <p>多轮对话（Multi-Turn Dialogue）是指在一个对话中，参与者之间交换多个信息单位（如句子、问题、回答）的过程。在多轮对话中，每个参与者的发言通常是对前一个发言的回应，并且每个发言都为对话的进一步发展做出贡献。</p> 
</blockquote> 
<p>官方代码精简版</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> dashscope <span class="token keyword">import</span> Generation
<span class="token keyword">from</span> dashscope<span class="token punctuation">.</span>api_entities<span class="token punctuation">.</span>dashscope_response <span class="token keyword">import</span> Role

messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> Role<span class="token punctuation">.</span>USER<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'如何做西红柿炖牛腩？'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
response <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span> messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> Role<span class="token punctuation">.</span>USER<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'不放糖可以吗？'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
response <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span> messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
材料：牛腩1000克，西红柿2个，大葱1根，姜3片，蒜瓣6粒，八角1颗，桂皮1小块，香叶2片，干辣椒2只，生抽2勺，老抽1勺，料酒2勺，冰糖20克，盐适量

做法：

1. 牛腩洗净切块，放沸水中焯水去血沫捞出备用。
2. 西红柿顶部划十字刀口，放入沸水中烫一下去皮，切滚刀块备用。
3. 大葱切段、姜切片、蒜瓣剥好。锅内油烧热，下入大葱段、姜片、蒜瓣、八角、桂皮、香叶和干辣椒炒香。
4. 下入牛腩翻炒均匀，烹入料酒炒匀后，加入生抽和老抽炒至上色。
5. 加入足量热水（没过牛腩），大火煮开后撇去浮沫，转中小火慢慢炖煮至牛腩软烂，约需1小时以上。
6. 当牛腩炖至8成熟时，加入西红柿块继续炖煮，炖煮至西红柿软烂且汤汁浓稠即可，最后调入适量的盐调味。

西红柿炖牛腩就做好了！
可以的，如果不喜欢甜味，可以不放冰糖或者减少用量。不过需要注意的是，糖能够增加菜肴的鲜美口感和色泽，如果你不放糖，可能会让菜肴的味道变得有些平淡无味。另外，糖还能够中和牛肉的腥味，如果没有糖的话，可能需要在炖煮的过程中多加一些调料来提味。
'''</span>
</code></pre> 
<p><strong>多轮对话需要将输入信息反复输入给模型，且要包含以往全部的对话内容</strong></p> 
<ul><li>第一次发信息</li></ul> 
<pre><code class="prism language-python">messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> Role<span class="token punctuation">.</span>USER<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'如何做西红柿炖牛腩？'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
response <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span> messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li>第二次发信息</li></ul> 
<pre><code class="prism language-python"><span class="token comment">#添加机器返回的内容</span>
messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">#添加新的内容</span>
messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> Role<span class="token punctuation">.</span>USER<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'不放糖可以吗？'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

response <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span> messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
</code></pre> 
<p>官方代码</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> http <span class="token keyword">import</span> HTTPStatus
<span class="token keyword">from</span> dashscope <span class="token keyword">import</span> Generation
<span class="token keyword">from</span> dashscope<span class="token punctuation">.</span>api_entities<span class="token punctuation">.</span>dashscope_response <span class="token keyword">import</span> Role


<span class="token keyword">def</span> <span class="token function">conversation_with_messages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> Role<span class="token punctuation">.</span>SYSTEM<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'You are a helpful assistant.'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> Role<span class="token punctuation">.</span>USER<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'如何做西红柿炖牛腩？'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    response <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>
        Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
        result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">,</span>  <span class="token comment"># set the result to be "message" format.</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> HTTPStatus<span class="token punctuation">.</span>OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        <span class="token comment"># append result to messages.</span>
        messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                         <span class="token string">'content'</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Request id: %s, Status code: %s, error code: %s, error message: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
            response<span class="token punctuation">.</span>request_id<span class="token punctuation">,</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span>
            response<span class="token punctuation">.</span>code<span class="token punctuation">,</span> response<span class="token punctuation">.</span>message
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> Role<span class="token punctuation">.</span>USER<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'不放糖可以吗？'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment"># make second round call</span>
    response <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>
        Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
        result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">,</span>  <span class="token comment"># set the result to be "message" format.</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> HTTPStatus<span class="token punctuation">.</span>OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Request id: %s, Status code: %s, error code: %s, error message: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
            response<span class="token punctuation">.</span>request_id<span class="token punctuation">,</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span>
            response<span class="token punctuation">.</span>code<span class="token punctuation">,</span> response<span class="token punctuation">.</span>message
        <span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    conversation_with_messages<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="64__382"></a>6.4 流式输出</h4> 
<blockquote> 
 <p>流式输出（Streaming Output）是一种数据处理和输出的方式，其中数据连续地、实时地被发送和接收，而不是在所有数据都准备好后一次性发送。这种方法常用于处理实时数据流和大型数据集，尤其是在数据量太大以至于无法一次性完全加载到内存中的情况。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/03/00/vNIELZWT_o.gif" alt="在这里插入图片描述"></p> 
<p>精简代码如下,将API中<code>stream</code>和<code>incremental_output</code>两个变量设置成<code>Ture</code>就可以</p> 
<p>流式输出返回的<code>responses</code>是一个<strong>迭代器</strong>，所以需要通过for来迭代读取其内部信息</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> dashscope <span class="token keyword">import</span> Generation

<span class="token comment"># 如果环境变量配置无效请启用以下代码</span>
<span class="token comment"># dashscope.api_key = 'your api'</span>

messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'如何做西红柿炖牛腩？'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
responses <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span>messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">,</span>stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>incremental_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token keyword">for</span> response <span class="token keyword">in</span> responses<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
</code></pre> 
<p>官方代码如下</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> http <span class="token keyword">import</span> HTTPStatus
<span class="token keyword">from</span> dashscope <span class="token keyword">import</span> Generation


<span class="token keyword">def</span> <span class="token function">call_with_stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'如何做西红柿炖牛腩？'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    responses <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>
        Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_turbo<span class="token punctuation">,</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
        result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">,</span>  <span class="token comment"># set the result to be "message" format.</span>
        stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        incremental_output<span class="token operator">=</span><span class="token boolean">True</span>  <span class="token comment"># get streaming output incrementally</span>
    <span class="token punctuation">)</span>
    full_content <span class="token operator">=</span> <span class="token string">''</span>  <span class="token comment"># with incrementally we need to merge output.</span>
    <span class="token keyword">for</span> response <span class="token keyword">in</span> responses<span class="token punctuation">:</span>
        <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> HTTPStatus<span class="token punctuation">.</span>OK<span class="token punctuation">:</span>
            full_content <span class="token operator">+=</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Request id: %s, Status code: %s, error code: %s, error message: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
                response<span class="token punctuation">.</span>request_id<span class="token punctuation">,</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span>
                response<span class="token punctuation">.</span>code<span class="token punctuation">,</span> response<span class="token punctuation">.</span>message
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Full response:\n'</span> <span class="token operator">+</span> full_content<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    call_with_stream<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="7_443"></a>7.通过控制台输入实现多轮对话-非流式输出</h3> 
<p>最后根据对文档的理解，实现一个使用pycharm的控制台输入然后实现多轮输出的过程，用来实现网页版的对话模式，首先不使流式输出</p> 
<p><strong>多轮对话中参数量更大的模型对上下文的理解更出色，但运行的时间较长，也就是不使用流式输出的话，对话体验会非常不好，小模型也能正确回答一般回答的会比较精，适合不需要深入理解对话的应用场景</strong></p> 
<p>测试文本如下：</p> 
<pre><code># 现在请你扮演一个角色你叫航宝，今年4岁了，喜欢编程，擅长python，喜欢吃麻婆豆腐
# 那你今年多大了呀
# 你最喜欢吃的菜是什么呢
# 你擅长什么编程语言呢
</code></pre> 
<p>下面的GIF是使用<code>qwen_max</code>模型也就是默认模型中的最大模型进行实际的对话的效果，虽然设备网速之间会略有差异，我的设备是win10 64位，网络用的5G的手机热点。<br> <img src="https://images2.imgbox.com/d5/35/MwhxFlos_o.gif" alt="在这里插入图片描述"></p> 
<p>代码如下：为了精简代码易于理解，直接使用了一个需要手动退出的<code>while</code>死循环</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> dashscope <span class="token keyword">import</span> Generation
<span class="token keyword">from</span> dashscope<span class="token punctuation">.</span>api_entities<span class="token punctuation">.</span>dashscope_response <span class="token keyword">import</span> Role

messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    message <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'user:'</span><span class="token punctuation">)</span>
    <span class="token comment"># 将输入信息加入历史对话</span>
    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> Role<span class="token punctuation">.</span>USER<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> message<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment"># 获得模型输出结果</span>
    response <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_max<span class="token punctuation">,</span> messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'system:'</span><span class="token operator">+</span>response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 将输出信息加入历史对话</span>
    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="8_480"></a>8.通过控制台输入实现多轮对话-流式输出</h3> 
<p>接下来看一下流式输出的效果，可以看到虽然从打印第一段文字到最后一段总体用时还是很长，但是流式输出就不会给人一种尴尬的等待的时间。<br> <img src="https://images2.imgbox.com/80/df/mCgeUNyS_o.gif" alt="在这里插入图片描述"></p> 
<p>代码如下</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> dashscope <span class="token keyword">import</span> Generation
<span class="token keyword">from</span> dashscope<span class="token punctuation">.</span>api_entities<span class="token punctuation">.</span>dashscope_response <span class="token keyword">import</span> Role

messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    message <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">'user:'</span><span class="token punctuation">)</span>
    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> Role<span class="token punctuation">.</span>USER<span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> message<span class="token punctuation">}</span><span class="token punctuation">)</span>
    whole_message <span class="token operator">=</span> <span class="token string">''</span>
    responses <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>Generation<span class="token punctuation">.</span>Models<span class="token punctuation">.</span>qwen_max<span class="token punctuation">,</span> messages<span class="token operator">=</span>messages<span class="token punctuation">,</span> result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">,</span> stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> incremental_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'system:'</span><span class="token punctuation">,</span>end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> response <span class="token keyword">in</span> responses<span class="token punctuation">:</span>
        whole_message <span class="token operator">+=</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'assistant'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> whole_message<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>使用<code>qwen_turbo</code>小模型流式输出效果如下</p> 
<p><img src="https://images2.imgbox.com/fe/cf/9STlVnKA_o.gif" alt="在这里插入图片描述"></p> 
<h3><a id="9_512"></a>9.参考文档链接总结</h3> 
<p>通义千问网页使用版本地址：<a href="https://tongyi.aliyun.com/qianwen/" rel="nofollow">https://tongyi.aliyun.com/qianwen/</a><br> 通义千问官网文档地址：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/</a><br> API-KEY设置地址官方文档网址：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/api-key-settings" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/api-key-settings</a><br> 使用通义千问对Token进行切分官方文档网址：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/token-api" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/token-api</a><br> 使用通义千问进行对话API官方文档网址：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/quick-start" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/quick-start</a></p> 
<h3><a id="_520"></a>资源绑定</h3> 
<p>资源绑定中总结了所有代码<br> <img src="https://images2.imgbox.com/89/7f/2XU86bQT_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1ae5924c62a885fb6c7bb20d21055bc7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">照片特定风格变换Stylar AI；GPT-4V开源替代方案InternVL；纯C/C&#43;&#43;实现的Stable Diffusion库；基于AI的数据爬取</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5fb6267b2960ac0d952837ae81c3371c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用LLaMA-Factory来实现微调ChatGLM-3B</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>