<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>使用LlamaFactory进行模型微调：参数详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/bbe9b2f05875ef137a2352a17b355312/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="使用LlamaFactory进行模型微调：参数详解">
  <meta property="og:description" content="在深度学习和自然语言处理领域，模型微调是提升预训练模型性能的重要手段。本文将介绍如何使用LlamaFactory进行模型微调，并详细解析一些关键参数，包括 --cutoff_len 1024、--flash_attn auto、--lora_rank 8、--lora_alpha 16、--lora_dropout 0 和 --lora_target all。
基础命令 首先，让我们看看基本的训练命令：
llamafactory-cli train \ --stage sft \ --do_train True \ --model_name_or_path /data1/models/Llama3-8B-Chinese-Chat \ --preprocessing_num_workers 16 \ --finetuning_type lora \ --template llama3 \ --flash_attn auto \ --dataset_dir /data1/workspaces/llama-factory/data/fiance-neixun \ --dataset yinlian-sharegpt-neixun \ --cutoff_len 1024 \ --learning_rate 5e-05 \ --num_train_epochs 3.0 \ --max_samples 100000 \ --per_device_train_batch_size 2 \ --gradient_accumulation_steps 8 \ --lr_scheduler_type cosine \ --max_grad_norm 1.0 \ --logging_steps 5 \ --save_steps 100 \ --warmup_steps 0 \ --optim adamw_torch \ --packing False \ --report_to none \ --output_dir saves/LLaMA3-8B-Chat/lora/train_2024-06-18-09-02-25 \ --fp16 True \ --plot_loss True \ --ddp_timeout 180000000 \ --include_num_input_tokens_seen True \ --lora_rank 8 \ --lora_alpha 16 \ --lora_dropout 0 \ --lora_target all \ --deepspeed cache/ds_z3_config.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-19T10:18:01+08:00">
    <meta property="article:modified_time" content="2024-06-19T10:18:01+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">使用LlamaFactory进行模型微调：参数详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>在深度学习和自然语言处理领域，模型微调是提升预训练模型性能的重要手段。本文将介绍如何使用LlamaFactory进行模型微调，并详细解析一些关键参数，包括 <code>--cutoff_len 1024</code>、<code>--flash_attn auto</code>、<code>--lora_rank 8</code>、<code>--lora_alpha 16</code>、<code>--lora_dropout 0</code> 和 <code>--lora_target all</code>。</p> 
<h3><a id="_4"></a>基础命令</h3> 
<p>首先，让我们看看基本的训练命令：</p> 
<pre><code class="prism language-shell">llamafactory-cli train <span class="token punctuation">\</span>
    <span class="token parameter variable">--stage</span> sft <span class="token punctuation">\</span>
    <span class="token parameter variable">--do_train</span> True <span class="token punctuation">\</span>
    <span class="token parameter variable">--model_name_or_path</span> /data1/models/Llama3-8B-Chinese-Chat <span class="token punctuation">\</span>
    <span class="token parameter variable">--preprocessing_num_workers</span> <span class="token number">16</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--finetuning_type</span> lora <span class="token punctuation">\</span>
    <span class="token parameter variable">--template</span> llama3 <span class="token punctuation">\</span>
    <span class="token parameter variable">--flash_attn</span> auto <span class="token punctuation">\</span>
    <span class="token parameter variable">--dataset_dir</span> /data1/workspaces/llama-factory/data/fiance-neixun <span class="token punctuation">\</span>
    <span class="token parameter variable">--dataset</span> yinlian-sharegpt-neixun <span class="token punctuation">\</span>
    <span class="token parameter variable">--cutoff_len</span> <span class="token number">1024</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--learning_rate</span> 5e-05 <span class="token punctuation">\</span>
    <span class="token parameter variable">--num_train_epochs</span> <span class="token number">3.0</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--max_samples</span> <span class="token number">100000</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--per_device_train_batch_size</span> <span class="token number">2</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--gradient_accumulation_steps</span> <span class="token number">8</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--lr_scheduler_type</span> cosine <span class="token punctuation">\</span>
    <span class="token parameter variable">--max_grad_norm</span> <span class="token number">1.0</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--logging_steps</span> <span class="token number">5</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--save_steps</span> <span class="token number">100</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--warmup_steps</span> <span class="token number">0</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--optim</span> adamw_torch <span class="token punctuation">\</span>
    <span class="token parameter variable">--packing</span> False <span class="token punctuation">\</span>
    <span class="token parameter variable">--report_to</span> none <span class="token punctuation">\</span>
    <span class="token parameter variable">--output_dir</span> saves/LLaMA3-8B-Chat/lora/train_2024-06-18-09-02-25 <span class="token punctuation">\</span>
    <span class="token parameter variable">--fp16</span> True <span class="token punctuation">\</span>
    <span class="token parameter variable">--plot_loss</span> True <span class="token punctuation">\</span>
    <span class="token parameter variable">--ddp_timeout</span> <span class="token number">180000000</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--include_num_input_tokens_seen</span> True <span class="token punctuation">\</span>
    <span class="token parameter variable">--lora_rank</span> <span class="token number">8</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--lora_alpha</span> <span class="token number">16</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--lora_dropout</span> <span class="token number">0</span> <span class="token punctuation">\</span>
    <span class="token parameter variable">--lora_target</span> all <span class="token punctuation">\</span>
    <span class="token parameter variable">--deepspeed</span> cache/ds_z3_config.json
</code></pre> 
<h3><a id="_44"></a>参数解析</h3> 
<p>基本训练参数</p> 
<ul><li><code>--stage sft</code>: 指定训练的阶段，此处为"Supervised Fine-Tuning"（SFT）。</li><li><code>--do_train True</code>: 表示执行训练过程。</li><li><code>--model_name_or_path /data1/models/Llama3-8B-Chinese-Chat</code>: 预训练模型的路径。</li><li><code>--dataset_dir /data1/workspaces/llama-factory/data/fiance-neixun</code>: 数据集所在目录。</li><li><code>--dataset yinlian-sharegpt-neixun</code>: 数据集的具体名称。</li></ul> 
<p>数据处理参数</p> 
<ul><li><code>--preprocessing_num_workers 16</code>: 用于数据预处理的工作线程数。</li><li><code>--cutoff_len 1024</code>: 截断长度，表示输入序列的最大长度。</li></ul> 
<p>训练设置参数</p> 
<ul><li><code>--learning_rate 5e-05</code>: 学习率，用于控制模型参数的更新幅度。</li><li><code>--num_train_epochs 3.0</code>: 训练的轮数，即数据集将被循环使用的次数。</li><li><code>--max_samples 100000</code>: 用于训练的最大样本数量。</li><li><code>--per_device_train_batch_size 2</code>: 每个设备上的训练批次大小。</li><li><code>--gradient_accumulation_steps 8</code>: 梯度累积步数，这意味着每8个批次的梯度将被累积一次。</li><li><code>--lr_scheduler_type cosine</code>: 学习率调度类型，这里使用余弦退火调度。</li><li><code>--max_grad_norm 1.0</code>: 最大梯度范数，用于梯度裁剪以防止梯度爆炸。</li></ul> 
<p>模型微调参数</p> 
<ul><li><code>--finetuning_type lora</code>: 指定微调方法，此处为LoRA（Low-Rank Adaptation）。</li><li><code>--lora_rank 8</code>: LoRA的秩，决定了低秩矩阵的大小。</li><li><code>--lora_alpha 16</code>: LoRA的alpha参数，控制权重更新的比例。</li><li><code>--lora_dropout 0</code>: LoRA的dropout率，防止过拟合。</li><li><code>--lora_target all</code>: 指定LoRA应用的层，此处为全部层。</li></ul> 
<p>训练优化参数</p> 
<ul><li><code>--optim adamw_torch</code>: 优化器类型，此处为AdamW优化器。</li><li><code>--warmup_steps 0</code>: 学习率预热步数。</li><li><code>--fp16 True</code>: 使用16位浮点数进行训练，加速训练过程并减少显存占用。</li><li><code>--flash_attn auto</code>: 闪存注意力机制，自动决定是否启用。</li><li><code>--deepspeed cache/ds_z3_config.json</code>: 使用DeepSpeed来加速和优化训练。</li><li><code>--ddp_timeout 180000000</code>: 分布式数据并行的超时时间。</li></ul> 
<p>其他设置</p> 
<ul><li><code>--template llama3</code>: 模型模板类型。</li><li><code>--packing False</code>: 是否启用数据打包。</li><li><code>--report_to none</code>: 报告的目的地，此处没有指定报告。</li><li><code>--output_dir saves/LLaMA3-8B-Chat/lora/train_2024-06-18-09-02-25</code>: 训练输出目录。</li><li><code>--plot_loss True</code>: 是否绘制损失图。</li><li><code>--logging_steps 5</code>: 日志记录的步数间隔。</li><li><code>--save_steps 100</code>: 模型保存的步数间隔。</li><li><code>--include_num_input_tokens_seen True</code>: 包括已处理的输入令牌数量。</li></ul> 
<p>通过这样分类和解释，你可以让面试官对每个参数的作用和设置有一个清晰的理解。这不仅展示了你对每个参数的熟悉程度，还体现了你对模型训练过程的整体把握。</p> 
<h3><a id="_93"></a>关键参数解析</h3> 
<h4><a id="cutoff_len_1024_95"></a><code>--cutoff_len 1024</code></h4> 
<p><strong>截断长度，表示输入序列的最大长度。</strong></p> 
<p>这个参数决定了每个输入序列的最大长度为1024个标记（tokens）。在自然语言处理任务中，输入序列可能会非常长，因此需要截断以确保模型可以处理。</p> 
<ul><li><strong>重要性</strong>：设置合适的截断长度可以确保模型在计算资源有限的情况下高效运行，同时又不会丢失太多重要信息。</li><li><strong>使用场景</strong>：适用于处理长文本的任务，如文本生成、问答系统等。</li></ul> 
<h4><a id="flash_attn_auto_104"></a><code>--flash_attn auto</code></h4> 
<p><strong>Flash注意力机制，设置为自动。</strong></p> 
<p><code>flash_attn</code> 参数控制注意力机制的实现方式。设置为 <code>auto</code> 意味着系统会根据实际硬件配置和需求自动选择最优的注意力机制实现。</p> 
<ul><li><strong>重要性</strong>：可以优化计算效率和内存使用，特别是在处理大型模型和长序列时。</li><li><strong>使用场景</strong>：适用于所有需要注意力机制的深度学习模型，如Transformer架构。</li></ul> 
<h4><a id="lora_rank_8_113"></a><code>--lora_rank 8</code></h4> 
<p><strong>LoRA的秩，决定了低秩矩阵的大小。</strong></p> 
<p>LoRA（Low-Rank Adaptation）通过引入低秩矩阵来更新模型参数，从而减少计算和存储成本。<code>--lora_rank 8</code> 表示使用秩为8的低秩矩阵来进行参数更新。</p> 
<ul><li><strong>重要性</strong>：较小的秩可以显著减少参数数量和计算量，但也可能限制模型的表达能力。</li><li><strong>使用场景</strong>：适用于需要高效微调的大型预训练模型，如GPT-3、BERT等。</li></ul> 
<h4><a id="lora_alpha_16_122"></a><code>--lora_alpha 16</code></h4> 
<p><strong>LoRA的alpha参数，控制权重更新的比例。</strong></p> 
<p>LoRA的alpha参数用于调整低秩矩阵对模型参数更新的影响。<code>--lora_alpha 16</code> 意味着将低秩矩阵的影响乘以16，从而放大其效果。</p> 
<ul><li><strong>重要性</strong>：通过调整alpha值，可以控制低秩矩阵的影响，从而实现更加精细的参数调优。</li><li><strong>使用场景</strong>：适用于需要对模型参数进行精细控制的场景，以平衡模型性能和过拟合风险。</li></ul> 
<h4><a id="lora_dropout_0_131"></a><code>--lora_dropout 0</code></h4> 
<p><strong>LoRA的dropout参数，控制dropout比例。</strong></p> 
<p><code>--lora_dropout 0</code> 表示在LoRA的训练过程中不使用dropout。Dropout是一种正则化技术，用于防止模型过拟合。</p> 
<ul><li><strong>重要性</strong>：在某些情况下，不使用dropout可以提高模型的训练稳定性和性能。</li><li><strong>使用场景</strong>：适用于数据量大、过拟合风险较低的场景。</li></ul> 
<h4><a id="lora_target_all_140"></a><code>--lora_target all</code></h4> 
<p><strong>LoRA的目标模块，表示应用LoRA的范围。</strong></p> 
<p><code>--lora_target all</code> 表示将LoRA应用于模型的所有参数。这种设置确保了LoRA的低秩适配器能够全面调整模型的参数，从而实现整体优化。</p> 
<ul><li><strong>重要性</strong>：全面应用LoRA可以最大程度地提高模型的适应能力和性能。</li><li><strong>使用场景</strong>：适用于对模型整体进行微调的任务，如大规模预训练模型的全面优化。</li></ul> 
<h3><a id="_149"></a>总结</h3> 
<p>在使用LlamaFactory进行模型微调时，理解和合理设置各个参数至关重要。<code>--cutoff_len 1024</code> 确保了输入序列的合理长度，<code>--flash_attn auto</code> 优化了注意力机制的实现，<code>--lora_rank 8</code> 和 <code>--lora_alpha 16</code> 则通过低秩矩阵和权重更新比例来提高微调效率和效果，而 <code>--lora_dropout 0</code> 和 <code>--lora_target all</code> 则进一步细化了模型的训练策略。</p> 
<p>通过这些参数设置，您可以在计算资源有限的情况下，充分发挥预训练模型的性能，实现高效的模型微调。如果您对这些技术感兴趣，可以尝试在自己的项目中应用，并根据实际情况进行调整和优化。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a1fa87221846a99cd7ec9afc73c87151/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">目标检测——YOLOv8算法解读</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4069b831915297d2d204a1d9d89e03c3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C#结合JS 修改解决 KindEditor 弹出层问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>