<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[Unity] Unity Android14 适配 Android targetSdkVersion升级34(基于Unity2021.3LTS) - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/39d954130c49d4ce677e70b68b5294a6/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="[Unity] Unity Android14 适配 Android targetSdkVersion升级34(基于Unity2021.3LTS)">
  <meta property="og:description" content="升级Android的API Level，是上架Google Play的App每年至少经历的一劫，今年的要求是2024年8月31号后，新应用和应用更新必须以 Android 14（API 级别 34）为目标平台，才能提交到 Google Play。Google Play 应用在目标 API 级别方面需满足的要求
经过几天的摸索，梳理了要修改的地方。
写在前面 考虑到每台设备构建环境都不一样，所以我的方案不一定能覆盖所有情况。当按照以下配置改完各个工具的版本后，如果打包还是报错的话。最好是把项目导出成Android工程，用Android Studio打开。AS能帮你检测不合理的配置并给出修改建议，而且AS在构建失败时的提示信息也比Unity更详细。按照AS的提示反复修改，直到构建通过，就得到了最适合你项目的gradle配置。最后按照你的测试结果来修改Unity中的各个gralde文件就可以了。
构建工具使用版本 工具版本UnityUnity2021.3.36 LTSAGP7.4.2Gradlegradle-7.5-bin.zipOpenJDK11R88.3.37 1. AGP升级 打开baseProjectTemplate.gradle，修改版本AGP版本。
原始：
classpath &#39;com.android.tools.build:gradle:4.2.2&#39;
改为：
classpath &#39;com.android.tools.build:gradle:7.4.2&#39;
*没baseProjectTemplat的在ProjectSettings/Player/PublishingSettings里勾选上就有了。
AGP升级会附带一些gradle语法的变化，具体参考Android14 SDK官方指南
2. Gradle升级 下载gradle-7.5-bin.zip，打开Unity安装目录Applications/Unity/Hub/Editor/2021.3.36/PlaybackEngines/AndroidPlayer，把刚下载的gradle压缩包拷贝到AndroidPlayer目录下， 解压替换原来的**/gradle**文件夹
3. R8升级 打开Unity安装目录Applications/Unity/Hub/Editor/2021.3.36/PlaybackEngines/AndroidPlayer/Tools/GradleTemplates，修改settingsTemplate.gradle文件中r8的版本。
原始：
classpath (&#34;com.android.tools:r8:4.0.48&#34;)
改为：
classpath (&#34;com.android.tools:r8:8.3.37&#34;)
PS：Unity2021.3.11版本里是没有这一行的，需要手动添加整个pluginManagement，代码如下：
pluginManagement { buildscript { repositories { mavenCentral() google() } dependencies { classpath(&#34;com.android.tools:r8:8.3.37&#34;) } } } include &#39;:launcher&#39;, &#39;:unityLibrary&#39; **INCLUDES** 4. OpenJDK Unity2021.3内置的是Java8，但是这里要使用Java11，正好Unity2022.3内置的是Java11，直接从里面拷贝一份，放到一个不常修改的目录下就可以了。虽然Unity的设置支持自定义JDK路径，但是只支持Java8的，如果自定义的JDK是高于Java8的，Unity编辑器会提示不支持，所以还是要通过改gradle来绕过Unity编辑器的检测。
打开mainTemplate.gradle，修改JDK的版本。 原始：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-14T11:32:05+08:00">
    <meta property="article:modified_time" content="2024-08-14T11:32:05+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[Unity] Unity Android14 适配 Android targetSdkVersion升级34(基于Unity2021.3LTS)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>升级Android的API Level，是上架Google Play的App每年至少经历的一劫，今年的要求是2024年8月31号后，新应用和应用更新必须以 Android 14（API 级别 34）为目标平台，才能提交到 Google Play。<a href="https://support.google.com/googleplay/android-developer/answer/11926878?hl=zh-Hans" rel="nofollow">Google Play 应用在目标 API 级别方面需满足的要求</a><br> 经过几天的摸索，梳理了要修改的地方。</p> 
<h3><a id="_3"></a>写在前面</h3> 
<p>考虑到每台设备构建环境都不一样，所以我的方案不一定能覆盖所有情况。当按照以下配置改完各个工具的版本后，如果打包还是报错的话。最好是把项目导出成Android工程，用Android Studio打开。<strong>AS能帮你检测不合理的配置并给出修改建议，而且AS在构建失败时的提示信息也比Unity更详细</strong>。按照AS的提示反复修改，直到构建通过，就得到了最适合你项目的gradle配置。最后按照你的测试结果来修改Unity中的各个gralde文件就可以了。</p> 
<h3><a id="_5"></a>构建工具使用版本</h3> 
<table><thead><tr><th>工具</th><th>版本</th></tr></thead><tbody><tr><td>Unity</td><td>Unity2021.3.36 LTS</td></tr><tr><td>AGP</td><td>7.4.2</td></tr><tr><td>Gradle</td><td>gradle-7.5-bin.zip</td></tr><tr><td>OpenJDK</td><td>11</td></tr><tr><td>R8</td><td>8.3.37</td></tr></tbody></table> 
<h3><a id="1_AGP_13"></a>1. AGP升级</h3> 
<p>打开baseProjectTemplate.gradle，修改版本AGP版本。<br> 原始：<br> <code>classpath 'com.android.tools.build:gradle:4.2.2'</code><br> 改为：<br> <code>classpath 'com.android.tools.build:gradle:7.4.2'</code></p> 
<p>*没baseProjectTemplat的在ProjectSettings/Player/PublishingSettings里勾选上就有了。<br> <img src="https://images2.imgbox.com/3e/c2/QiQEhdG4_o.png" alt="baseTemplate.gradle"></p> 
<blockquote> 
 <p>AGP升级会附带一些gradle语法的变化，具体参考<a href="https://developer.android.com/about/versions/14/setup-sdk?hl=zh-cn#groovy" rel="nofollow">Android14 SDK官方指南</a></p> 
</blockquote> 
<h3><a id="2_Gradle_23"></a>2. Gradle升级</h3> 
<p>下载<a href="https://gradle.org/next-steps/?version=7.5&amp;format=bin" rel="nofollow">gradle-7.5-bin.zip</a>，打开Unity安装目录<strong>Applications/Unity/Hub/Editor/2021.3.36/PlaybackEngines/AndroidPlayer</strong>，把刚下载的gradle压缩包拷贝到<strong>AndroidPlayer目录</strong>下， 解压替换原来的**/gradle**文件夹</p> 
<h3><a id="3_R8_25"></a>3. R8升级</h3> 
<p>打开Unity安装目录<strong>Applications/Unity/Hub/Editor/2021.3.36/PlaybackEngines/AndroidPlayer/Tools/GradleTemplates</strong>，修改settingsTemplate.gradle文件中r8的版本。<br> 原始：<br> <code>classpath ("com.android.tools:r8:4.0.48")</code><br> 改为：<br> <code>classpath ("com.android.tools:r8:8.3.37")</code></p> 
<p>PS：Unity2021.3.11版本里是没有这一行的，需要手动添加整个pluginManagement，代码如下：</p> 
<pre><code>pluginManagement {
    buildscript {
        repositories {
            mavenCentral()
            google()
        }
        dependencies {
            classpath("com.android.tools:r8:8.3.37")
        }
    }
}

include ':launcher', ':unityLibrary'
**INCLUDES**
</code></pre> 
<h3><a id="4_OpenJDK_50"></a>4. OpenJDK</h3> 
<p>Unity2021.3内置的是Java8，但是这里要使用Java11，正好Unity2022.3内置的是Java11，直接从里面拷贝一份，放到一个不常修改的目录下就可以了。虽然Unity的设置支持自定义JDK路径，但是只支持Java8的，如果自定义的JDK是高于Java8的，Unity编辑器会提示不支持，所以还是要通过改gradle来绕过Unity编辑器的检测。</p> 
<ol><li>打开mainTemplate.gradle，修改JDK的版本。</li></ol> 
<p>原始：</p> 
<pre><code>compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
}
</code></pre> 
<p>改为：</p> 
<pre><code>compileOptions {
    sourceCompatibility JavaVersion.VERSION_11
    targetCompatibility JavaVersion.VERSION_11
}
</code></pre> 
<ol start="2"><li> <p>打开gradleTemplate.properties，声明自定义OpenJDK的路径<br> <code>org.gradle.java.home=/Library/OpenJDK11</code></p> 
  <blockquote> 
   <p>我用的是Mac环境，把OpenJDK11文件夹拷贝到了公共资源库下面，所以是/Library/OpenJDK11。Windows需要自己查一下路径怎么写。</p> 
  </blockquote> </li></ol> 
<h3><a id="5__75"></a>5. 后续问题</h3> 
<p>编译打包后，发现Apk内的<strong>AndroidManifest.xml</strong>里多了三个权限，分别是：</p> 
<pre><code>uses-permission#android.permission.WRITE_EXTERNAL_STORAGE
uses-permission#android.permission.READ_PHONE_STATE
uses-permission#android.permission.READ_EXTERNAL_STORAGE
</code></pre> 
<p>初步断定是com.google.firebase导致的，几年前网上也有人反映类似的情况(<a href="https://issuetracker.google.com/issues/76024034" rel="nofollow">issuetracker</a>)。考虑到这三个权限现在基本废弃，而且在实际使用中还需要进行动态申请，所以不如直接将它们移除。<br> 具体做法是在<strong>Assets/Plugins/Android/AndroidManifest.xml</strong>里加上remove属性：</p> 
<pre><code>&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" tools:node="remove" /&gt;
&lt;uses-permission android:name="android.permission.READ_PHONE_STATE" tools:node="remove" /&gt;
&lt;uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" tools:node="remove" /&gt;
</code></pre> 
<h3><a id="_91"></a>写在最后</h3> 
<p>这次把Android的Target API Level从33升级到34，过程比去年32升33更麻烦，因为内置的构建工具已经无法支持最新的Android环境，要改动的地方太多了。按照Google一年一升的规律，明年从34升35的话，对老版引擎来说会更加困难。从这里也能看出，Unity2021确实是个老版本了，官方马上也要停止维护。不过至少还可以自定义gradle，掌握Android的基本知识+搜索引擎+GPT，一切都不是问题。</p> 
<p><a href="https://forum.unity.com/threads/android-14-api-level-34-in-unity-2020-lts-and-2021-lts.1516538/" rel="nofollow">Unity官方论坛关于升级Android14的讨论</a></p> 
<hr> 
<h3><a id="20240725__98"></a>2024-07-25 更新</h3> 
<p>Unity在7月23号发布了新的版本-Unity 2021.3.41，升级了内置Gralde的版本，跟我的方案基本一致，条件允许的话可以通过直接升级Unity版本来解决。<a href="https://unity.com/cn/releases/editor/whats-new/2021.3.41#notes" rel="nofollow">Unity 2021.3.41 Release Note</a></p> 
<p><img src="https://images2.imgbox.com/13/46/vCrtXGWJ_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b1cc9b76a998c5a210f93a833f4f6a8f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">机器学习速成第二集——监督学习之回归（理论部分）！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1a2386cd36e5da40bd618e12e2d7b0eb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">企业在实施等保2.0时，应如何结合云计算和大数据技术提高安全防护能力？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>