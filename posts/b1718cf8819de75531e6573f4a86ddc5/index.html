<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于C语言从0开始手撸MQTT协议代码连接标准的MQTT服务器，完成数据上传和命令下发响应(华为云IOT服务器) - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/b1718cf8819de75531e6573f4a86ddc5/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="基于C语言从0开始手撸MQTT协议代码连接标准的MQTT服务器，完成数据上传和命令下发响应(华为云IOT服务器)">
  <meta property="og:description" content="文章目录 一、前言二、搭建开发环境三、网络编程基础概念科普3.1 什么是网络编程3.2 TCP 和 UDP协议介绍3.3 TCP通信的实现过程 四、Windows下的网络编程相关API介绍4.1 常用的函数介绍4.2 函数参数介绍4.3 编写代码体验网络编程 五、访问华为云IOT服务器创建一个产品和设备5.2 开通物联网服务5.3 创建产品（1）创建产品（2）填写产品信息（3）产品创建成功（4）添加自定义模型 3.4 添加设备（1）注册设备（2）根据自己的设备填写（3）保存设备信息 3.5 MQTT协议主题订阅与发布（1）华为云平台MQTT协议使用限制（2）主题订阅格式（3）主题发布格式 3.6 MQTT三元组（1）MQTT服务器地址（2）生成MQTT三元组（3）MQTT登录测试参数总结 六、开始学习MQTT协议6.1 先了解下MQTT协议6.2 MQTT协议官网介绍6.3 需要实现的3个函数6.4 查看协议文档，了解如何组合协议报文6.5 实现`MQTT_Connect`函数【1】固定报文头【2】协议名【3】协议级别【4】连接标志【5】保持连接的时间【6】 可变报头非规范示例【7】最后部分：填写客户端ID、用户名、密码。【8】响应【9】完整代码 6.6 实现MQTT_PublishData函数【1】查看文档说明【2】固定报文头【3】剩余字段长度【4】可变报头【5】完整代码【6】发布确认 6.7 实现 MQTT_SubscribeTopic 函数【1】查看文档：订阅主题的格式【2】查看文档：取消订阅的格式【3】固定报头【4】可变报头【5】完整代码 七、运行项目、连接华为云服务器7.1 整个项目的完整代码7.2 代码里核心的地方7.3 编译运行代码7.4 登录华为云IOT云端查看数据 八、下发命令的处理8.1 添加命令8.2 下发命令测试8.3 编写代码8.4 运行代码测试 九、总结 从0开始编写MQTT协议代码连接标准MQTT服务器(精讲MQTT协议)
一、前言 近年来，物联网的发展如火如荼，已经渗透到我们生活的方方面面。从智能家居到工业自动化，从智慧城市到智慧农业，物联网正在以前所未有的速度改变着我们的生活。 大家现在可能已经习惯了通过手机控制家里的灯光、空调和电视，这就是物联网在智能家居领域的应用，如果在10年前看到这种设备的应用肯定觉得很牛批，而现在只要是个设备都能上云，这种家电设备的远程控制已经成了大家习以为常的配置了。而在工业领域，物联网技术可以帮助企业实现自动化生产、设备监控和预防性维护，提高生产效率和产品质量。在智慧城市建设中，物联网技术可以用于交通管理、环境监测和公共安全等方面，提升城市管理和居民生活的质量。
从物联网开始兴起的时候，各大厂家都纷纷推出了自家的IOT物联网平台。 比如： 机智云、中国移动的onenet、阿里云的IOT、百度的天工物接入、华为云的IOT、腾讯云IOT等等。 这些大厂家的物联网服务器都支持标准的MQTT协议接入，大家不用自己搭建MQTT服务器可以直接使用这些现成的服务器接入设备开发是非常的方便的。
我在这几年也写了很多物联网开发的案例，不管是、中国移动的onenet、阿里云的IOT、百度的天工物接入、华为云的IOT、腾讯云IOT 这些服务器都写了很多教程，演示设备接入平台，完成设备上云，手机APP对接，电脑程序对接，微信小程序接入，实现远程数据监测控制等等。这些案例都放在了智能家居与物联网项目实战专栏里。 这些案例里设备实现上云的方式主要是两种方式：HTTP协议、MQTT协议方式上云。 MQTT协议是标准的物联网协议，支持双向数据传输，也就是可以上传数据到服务器，也可以接收服务器下发的控制命令完成远程控制。 我写的这些案例里硬件端联网的模块主要是用到了4G模块、ESP8266-WIFI模块、GSM模块、NBIOT模块等等，通过它们联网，让单片机设备实现上云。
这些设备中有些是支持MQTT协议的（也就是本身的固件就支持MQTT协议），有些不支持的（可能有固件支持，需要自己烧写）。 如果说固件不支持MQTT协议，但只要设备支持TCP协议，那么我们也可以自己封装MQTT协议完成与MQTT服务器之间的通信。 比如：ESP8266-WIFI模块，正常的官方默认固件中，ESP8266-WIFI是不支持MQTT协议的，如果我们不烧写固件的情况下，如何自己实现MQTT协议上云？ 这篇文章就介绍，通过TCP协议自己封装MQTT协议报文，完成数据上云。 直接从0开始手撸MQTT协议报文，组合报文，完成与服务器之间的通信。
MQTT协议也是分为两种，分MQTT和MQTTS，就像HTTP协议一样也分HTTP和HTTPS，那么区别呢？ 带S就是要支持SSL协议，支持认证，更加安全，那么复杂度自然就上来了。 MQTT协议的端口是1883，MQTTS的端口是8883。 当前这篇文章介绍非加密的MQTT协议，也就是1883端口。MQTTS协议也手撸不了，这玩意涉及到SSL协议，那就很复杂了，如果要用，直接使用现成的开源库就行，但本篇文章不讨论这个，后面文章再单独介绍如何实现MQTTS协议。
本篇文章的环境是在windows下，利用VS2022开发程序，使用windows下网络编程接口作为基础，封装MQTT协议连接华为云MQTT服务器，完成数据上云。
所以，大家只要有一台windows电脑，电脑上安装了VS开发环境，任何版本都可以（VS2010、VS2013、VS2015、VS2017、VS2019、VS2022等等都可以的） 跟着这篇文章进行学习，不需要其他任何硬件设备，我们现在是单纯的去学习MQTT协议。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-17T11:44:01+08:00">
    <meta property="article:modified_time" content="2024-07-17T11:44:01+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于C语言从0开始手撸MQTT协议代码连接标准的MQTT服务器，完成数据上传和命令下发响应(华为云IOT服务器)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_5" rel="nofollow">一、前言</a></li><li><a href="#_35" rel="nofollow">二、搭建开发环境</a></li><li><a href="#_73" rel="nofollow">三、网络编程基础概念科普</a></li><li><ul><li><a href="#31__79" rel="nofollow">3.1 什么是网络编程</a></li><li><a href="#32_TCP__UDP_93" rel="nofollow">3.2 TCP 和 UDP协议介绍</a></li><li><a href="#33_TCP_105" rel="nofollow">3.3 TCP通信的实现过程</a></li></ul> 
  </li><li><a href="#WindowsAPI_125" rel="nofollow">四、Windows下的网络编程相关API介绍</a></li><li><ul><li><a href="#41__147" rel="nofollow">4.1 常用的函数介绍</a></li><li><a href="#42__183" rel="nofollow">4.2 函数参数介绍</a></li><li><a href="#43__331" rel="nofollow">4.3 编写代码体验网络编程</a></li></ul> 
  </li><li><a href="#IOT_419" rel="nofollow">五、访问华为云IOT服务器创建一个产品和设备</a></li><li><ul><li><a href="#52__421" rel="nofollow">5.2 开通物联网服务</a></li><li><a href="#53__489" rel="nofollow">5.3 创建产品</a></li><li><ul><li><a href="#1_491" rel="nofollow">（1）创建产品</a></li><li><a href="#2_499" rel="nofollow">（2）填写产品信息</a></li><li><a href="#3_507" rel="nofollow">（3）产品创建成功</a></li><li><a href="#4_515" rel="nofollow">（4）添加自定义模型</a></li></ul> 
   </li><li><a href="#34__555" rel="nofollow">3.4 添加设备</a></li><li><ul><li><a href="#1_559" rel="nofollow">（1）注册设备</a></li><li><a href="#2_565" rel="nofollow">（2）根据自己的设备填写</a></li><li><a href="#3_571" rel="nofollow">（3）保存设备信息</a></li></ul> 
   </li><li><a href="#35_MQTT_592" rel="nofollow">3.5 MQTT协议主题订阅与发布</a></li><li><ul><li><a href="#1MQTT_594" rel="nofollow">（1）华为云平台MQTT协议使用限制</a></li><li><a href="#2_612" rel="nofollow">（2）主题订阅格式</a></li><li><a href="#3_634" rel="nofollow">（3）主题发布格式</a></li></ul> 
   </li><li><a href="#36_MQTT_680" rel="nofollow">3.6 MQTT三元组</a></li><li><ul><li><a href="#1MQTT_688" rel="nofollow">（1）MQTT服务器地址</a></li><li><a href="#2MQTT_707" rel="nofollow">（2）生成MQTT三元组</a></li><li><a href="#3MQTT_741" rel="nofollow">（3）MQTT登录测试参数总结</a></li></ul> 
  </li></ul> 
  </li><li><a href="#MQTT_766" rel="nofollow">六、开始学习MQTT协议</a></li><li><ul><li><a href="#61_MQTT_768" rel="nofollow">6.1 先了解下MQTT协议</a></li><li><a href="#62_MQTT_782" rel="nofollow">6.2 MQTT协议官网介绍</a></li><li><a href="#63_3_802" rel="nofollow">6.3 需要实现的3个函数</a></li><li><a href="#64__821" rel="nofollow">6.4 查看协议文档，了解如何组合协议报文</a></li><li><a href="#65_MQTT_Connect_837" rel="nofollow">6.5 实现`MQTT_Connect`函数</a></li><li><ul><li><a href="#1_871" rel="nofollow">【1】固定报文头</a></li><li><a href="#2_918" rel="nofollow">【2】协议名</a></li><li><a href="#3_941" rel="nofollow">【3】协议级别</a></li><li><a href="#4_956" rel="nofollow">【4】连接标志</a></li><li><a href="#5_977" rel="nofollow">【5】保持连接的时间</a></li><li><a href="#6__994" rel="nofollow">【6】 可变报头非规范示例</a></li><li><a href="#7ID_1000" rel="nofollow">【7】最后部分：填写客户端ID、用户名、密码。</a></li><li><a href="#8_1034" rel="nofollow">【8】响应</a></li><li><a href="#9_1108" rel="nofollow">【9】完整代码</a></li></ul> 
   </li><li><a href="#66__MQTT_PublishData_1203" rel="nofollow">6.6 实现MQTT_PublishData函数</a></li><li><ul><li><a href="#1_1205" rel="nofollow">【1】查看文档说明</a></li><li><a href="#2_1213" rel="nofollow">【2】固定报文头</a></li><li><a href="#3_1255" rel="nofollow">【3】剩余字段长度</a></li><li><a href="#4_1328" rel="nofollow">【4】可变报头</a></li><li><a href="#5_1382" rel="nofollow">【5】完整代码</a></li><li><a href="#6_1441" rel="nofollow">【6】发布确认</a></li></ul> 
   </li><li><a href="#67__MQTT_SubscribeTopic__1453" rel="nofollow">6.7 实现 MQTT_SubscribeTopic 函数</a></li><li><ul><li><a href="#1_1455" rel="nofollow">【1】查看文档：订阅主题的格式</a></li><li><a href="#2_1465" rel="nofollow">【2】查看文档：取消订阅的格式</a></li><li><a href="#3_1471" rel="nofollow">【3】固定报头</a></li><li><a href="#4_1522" rel="nofollow">【4】可变报头</a></li><li><a href="#5_1542" rel="nofollow">【5】完整代码</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_1618" rel="nofollow">七、运行项目、连接华为云服务器</a></li><li><ul><li><a href="#71__1620" rel="nofollow">7.1 整个项目的完整代码</a></li><li><a href="#72__2090" rel="nofollow">7.2 代码里核心的地方</a></li><li><a href="#73__2104" rel="nofollow">7.3 编译运行代码</a></li><li><a href="#74_IOT_2112" rel="nofollow">7.4 登录华为云IOT云端查看数据</a></li></ul> 
  </li><li><a href="#_2130" rel="nofollow">八、下发命令的处理</a></li><li><ul><li><a href="#81__2138" rel="nofollow">8.1 添加命令</a></li><li><a href="#82__2164" rel="nofollow">8.2 下发命令测试</a></li><li><a href="#83__2213" rel="nofollow">8.3 编写代码</a></li><li><a href="#84__2293" rel="nofollow">8.4 运行代码测试</a></li></ul> 
  </li><li><a href="#_2315" rel="nofollow">九、总结</a></li></ul> 
</div> 
<p></p> 
<p></p> 
<div class="csdn-video-box"> 
 <iframe id="dhLVXyxV-1721187790915" frameborder="0" src="https://player.bilibili.com/player.html?aid=876625036" allowfullscreen="true" data-mediaembed="bilibili"></iframe> 
 <p>从0开始编写MQTT协议代码连接标准MQTT服务器(精讲MQTT协议)</p> 
</div> 
<p></p> 
<h2><a id="_5"></a>一、前言</h2> 
<p>近年来，物联网的发展如火如荼，已经渗透到我们生活的方方面面。从智能家居到工业自动化，从智慧城市到智慧农业，物联网正在以前所未有的速度改变着我们的生活。 大家现在可能已经习惯了通过手机控制家里的灯光、空调和电视，这就是物联网在智能家居领域的应用，如果在10年前看到这种设备的应用肯定觉得很牛批，而现在只要是个设备都能上云，这种家电设备的远程控制已经成了大家习以为常的配置了。而在工业领域，物联网技术可以帮助企业实现自动化生产、设备监控和预防性维护，提高生产效率和产品质量。在智慧城市建设中，物联网技术可以用于交通管理、环境监测和公共安全等方面，提升城市管理和居民生活的质量。</p> 
<p>从物联网开始兴起的时候，各大厂家都纷纷推出了自家的IOT物联网平台。 比如： 机智云、中国移动的onenet、阿里云的IOT、百度的天工物接入、华为云的IOT、腾讯云IOT等等。 这些大厂家的物联网服务器都支持标准的MQTT协议接入，大家不用自己搭建MQTT服务器可以直接使用这些现成的服务器接入设备开发是非常的方便的。</p> 
<p>我在这几年也写了很多物联网开发的案例，不管是、中国移动的onenet、阿里云的IOT、百度的天工物接入、华为云的IOT、腾讯云IOT 这些服务器都写了很多教程，演示设备接入平台，完成设备上云，手机APP对接，电脑程序对接，微信小程序接入，实现远程数据监测控制等等。这些案例都放在了<code>智能家居与物联网项目实战</code>专栏里。 这些案例里设备实现上云的方式主要是两种方式：HTTP协议、MQTT协议方式上云。 MQTT协议是标准的物联网协议，支持双向数据传输，也就是可以上传数据到服务器，也可以接收服务器下发的控制命令完成远程控制。 我写的这些案例里硬件端联网的模块主要是用到了4G模块、ESP8266-WIFI模块、GSM模块、NBIOT模块等等，通过它们联网，让单片机设备实现上云。</p> 
<p>这些设备中有些是支持MQTT协议的（也就是本身的固件就支持MQTT协议），有些不支持的（可能有固件支持，需要自己烧写）。 如果说固件不支持MQTT协议，但只要设备支持TCP协议，那么我们也可以自己封装MQTT协议完成与MQTT服务器之间的通信。 比如：ESP8266-WIFI模块，正常的官方默认固件中，ESP8266-WIFI是不支持MQTT协议的，如果我们不烧写固件的情况下，如何自己实现MQTT协议上云？ 这篇文章就介绍，通过TCP协议自己封装MQTT协议报文，完成数据上云。 直接从0开始手撸MQTT协议报文，组合报文，完成与服务器之间的通信。</p> 
<p><strong>MQTT协议也是分为两种，分MQTT和MQTTS，就像HTTP协议一样也分HTTP和HTTPS，那么区别呢？ 带S就是要支持SSL协议，支持认证，更加安全，那么复杂度自然就上来了。 MQTT协议的端口是1883，MQTTS的端口是8883。 当前这篇文章介绍非加密的MQTT协议，也就是1883端口。MQTTS协议也手撸不了，这玩意涉及到SSL协议，那就很复杂了，如果要用，直接使用现成的开源库就行，但本篇文章不讨论这个，后面文章再单独介绍如何实现MQTTS协议。</strong></p> 
<p>本篇文章的环境是在windows下，利用VS2022开发程序，使用windows下网络编程接口作为基础，封装MQTT协议连接华为云MQTT服务器，完成数据上云。</p> 
<p>所以，大家只要有一台windows电脑，电脑上安装了VS开发环境，任何版本都可以（VS2010、VS2013、VS2015、VS2017、VS2019、VS2022等等都可以的） 跟着这篇文章进行学习，不需要其他任何硬件设备，我们现在是单纯的去学习MQTT协议。</p> 
<p>前提呢，大家还是要懂得一点网络编程的知识，了解TCP协议，大致知道TCP协议通信的简单过程，如果网络编程知识是完全0基础，建议先看另一篇文章学习下网络编程（我博客有专门讲解网络编程相关知识的文章）。 这篇文章也会简单介绍下TCP协议和基本网络编程知识</p> 
<p><strong>那么接下来，我们就开始动手学习吧。</strong></p> 
<h2><a id="_35"></a>二、搭建开发环境</h2> 
<p><strong>如果大家电脑已经有开发环境，这章节直接忽略。 这里贴出来为了给 完全0基础 的小伙伴学习</strong></p> 
<p>我这里介绍下我用的环境安装过程。 所有版本的VS都可以的。</p> 
<p>我当前环境是在Windows下，IDE用的是地表最强IDE VS2022。</p> 
<p>下载地址：<a href="https://visualstudio.microsoft.com/zh-hans/downloads/" rel="nofollow">https://visualstudio.microsoft.com/zh-hans/downloads/</a></p> 
<p><img src="https://images2.imgbox.com/ed/9d/p1tVGmYU_o.png" alt="image-20230913173131481"></p> 
<p>因为我这里只需要用到C++和C语言编程，那么安装的时候可以自己选择需要安装的包。</p> 
<p><img src="https://images2.imgbox.com/29/24/VncI7wC8_o.png" alt="image-20230913173258088"></p> 
<p>安装好之后，创建项目。</p> 
<p><img src="https://images2.imgbox.com/cc/1f/uwrgZeRD_o.png" alt="image-20230913173330580"></p> 
<p><img src="https://images2.imgbox.com/96/f2/2Vh10Asb_o.png" alt="image-20230913173349914"></p> 
<h2><a id="_73"></a>三、网络编程基础概念科普</h2> 
<p>如果是老手了，这章节可以直接忽略。 如果对网络编程是 0基础 的小伙伴，那么就认真看一下，了解下基本知识。</p> 
<h3><a id="31__79"></a>3.1 什么是网络编程</h3> 
<p>网络编程是通过使用IP地址和端口号等网络信息，使两台以上的计算机能够相互通信，按照规定的协议交换数据的编程方式。</p> 
<p>在网络编程中，程序员使用各种协议和技术，使得不同的设备可以通过网络进行数据交换和信息共享。</p> 
<p>要实现网络编程，程序员需要了解并掌握各种网络通信协议，比如TCP/IP协议族，包括TCP、UDP、IP等，这些协议是实现设备间通信的基础。网络编程内部涉及到数据的打包、组装、发送、接收、解析等一系列过程，以实现信息的正确传输。</p> 
<p>在TCP/IP协议族中，TCP和UDP是位于IP协议之上的<strong>传输层协议</strong>。 在OSI模型中，传输层是第四层，负责总体数据传输和数据控制，为会话层等高三层提供可靠的传输服务，为网络层提供可靠的目的地点信息。在TCP/IP协议族中，TCP和UDP正是位于这一层的协议。</p> 
<p>这篇文章主要介绍 TCP 和 UDP 协议 以及 使用方法。</p> 
<p><img src="https://images2.imgbox.com/0b/fd/Mam0F8LZ_o.png" alt="img"></p> 
<h3><a id="32_TCP__UDP_93"></a>3.2 TCP 和 UDP协议介绍</h3> 
<p><strong>TCP协议</strong>：</p> 
<p>TCP（传输控制协议）是一种面向连接的、可靠的传输层协议。在传输数据之前需要先建立连接，确保数据的顺序和完整性。TCP通过三次握手建立连接，并通过确认、超时和重传机制确保数据的可靠传输。TCP采用流量控制和拥塞控制机制，以避免网络拥塞，确保数据的顺利传输。因为TCP的这些特性，通常被应用于需要高可靠性和顺序性的应用，如网页浏览、电子邮件等。</p> 
<p><strong>UDP协议</strong>：</p> 
<p>UDP（用户数据报协议）是一种无连接的、不可靠的传输层协议。与TCP不同，UDP在传输数据之前不需要建立连接，直接将数据打包成数据报并发送出去。因此，UDP没有TCP的那些确认、超时和重传机制，也就不保证数据的可靠传输。UDP也没有TCP的流量控制和拥塞控制机制。因为UDP的简单性和高效性，通常被应用于实时性要求较高，但对数据可靠性要求不高的应用，如语音通话、视频直播等。</p> 
<h3><a id="33_TCP_105"></a>3.3 TCP通信的实现过程</h3> 
<p>要实现TCP通信，两端必须要知道对方的IP和端口号：</p> 
<p>（1）IP地址：TCP协议是基于IP协议进行通信的，因此需要知道对方的IP地址，才能建立连接。</p> 
<p>（2）端口号：每个TCP连接都有一个唯一的端口号，用于标识进程和应用程序。建立连接时，需要指定本地端口号和远端端口号。</p> 
<p>（3）应用层协议：TCP协议只提供数据传输服务，应用程序需要定义自己的应用层协议，用于解析报文和处理数据。例如，HTTP协议就是基于TCP协议的应用层协议。</p> 
<p>在正常的TCP通信过程中，第一步需要建立连接，这个过程称为“三次握手”。建立连接时，客户端向服务器发送一个SYN包，表示请求建立连接；服务器接收到SYN包后，向客户端发送一个ACK包，表示确认收到了SYN包；最后客户端再向服务器发送一个ACK包，表示确认收到了服务器的ACK包，此时连接建立成功。建立连接后，数据传输就可以开始了。</p> 
<p><img src="https://images2.imgbox.com/87/af/ZfWXbZr8_o.png" alt="img"></p> 
<h2><a id="WindowsAPI_125"></a>四、Windows下的网络编程相关API介绍</h2> 
<p>因为当前文章是在Windows下介绍MQTT协议，要用到网络编程的知识，需要使用Windows系统提供的API完成网络编程。Windows本身就有一套原生的网络编程接口可以直接使用。 在Linux系统下也是一样，都有自己一套原生的网络编程接口。</p> 
<p>如果没有接触这些API的小伙伴不用慌~~~。 你至少用过C语言里的printf、scanf、strlen之类的函数吧？ 下面介绍的这些网络编程API函数其实和它们没什么区别，都是普通的函数，功能不一样而已。 对你来说，只是多学了几个库函数，只要了解每个函数的功能就可以调用了。</p> 
<p><strong>那么接下来就学习一下常用的网络编程相关的函数。</strong></p> 
<p>微软的官方文档地址：<a href="https://learn.microsoft.com/zh-cn/windows/win32/api/_winsock/" rel="nofollow">https://learn.microsoft.com/zh-cn/windows/win32/api/_winsock/</a></p> 
<p><img src="https://images2.imgbox.com/a3/ae/YkhA5wmP_o.png" alt="image-20231031132547022"></p> 
<h3><a id="41__147"></a>4.1 常用的函数介绍</h3> 
<p>在Windows下进行网络编程，可以使用Winsock API（Windows Sockets API）来实现。Winsock API是Windows平台上的标准网络编程接口，提供了一系列函数和数据结构，用于创建、连接、发送和接收网络数据等操作。</p> 
<p>下面是常用的Winsock API接口函数：</p> 
<p>(1)<code>WSAStartup</code>：初始化Winsock库，必须在使用其他Winsock函数之前调用。</p> 
<p>(2)<code>socket</code>：创建一个套接字，用于网络通信。</p> 
<p>(3)<code>bind</code>：将套接字与本地地址（IP地址和端口号）绑定。</p> 
<p>(4)<code>listen</code>：开始监听连接请求，将套接字设置为被动模式。</p> 
<p>(5)<code>accept</code>：接受客户端的连接请求，创建一个新的套接字用于与客户端通信。</p> 
<p>(6)<code>connect</code>：与远程服务器建立连接。</p> 
<p>(7)<code>send</code>：发送数据到已连接的套接字。</p> 
<p>(8)<code>recv</code>：从已连接的套接字接收数据。</p> 
<p>(9)<code>sendto</code>：发送数据到指定的目标地址。</p> 
<p>(10)<code>recvfrom</code>：从指定的地址接收数据。</p> 
<p>(11)<code>closesocket</code>：关闭套接字。</p> 
<p>(12)<code>getaddrinfo</code>：根据主机名和服务名获取地址信息。</p> 
<p>(13)<code>gethostbyname</code>：根据主机名获取主机的IP地址。</p> 
<p>(14)<code>gethostname</code>：获取本地主机名。</p> 
<h3><a id="42__183"></a>4.2 函数参数介绍</h3> 
<p>下面是常用的几个Winsock API函数及其函数原型和参数含义的介绍：</p> 
<p>（1）<code>WSAStartup</code>：</p> 
<pre><code>int WSAStartup(WORD wVersionRequested, LPWSADATA lpWSAData);
</code></pre> 
<ul><li><code>wVersionRequested</code>：请求的Winsock版本号。</li><li><code>lpWSAData</code>：指向WSADATA结构的指针，用于接收初始化结果和相关信息。</li></ul> 
<p>（2）<code>socket</code>：</p> 
<pre><code>SOCKET socket(int af, int type, int protocol);
</code></pre> 
<ul><li><code>af</code>：地址族（Address Family），如AF_INET表示IPv4。</li><li><code>type</code>：套接字类型，如SOCK_STREAM表示面向连接的TCP套接字。</li><li><code>protocol</code>：指定协议。通常为0，表示根据<code>type</code>自动选择合适的协议。</li></ul> 
<p>（3）<code>bind</code>：</p> 
<pre><code>int bind(SOCKET s, const struct sockaddr* name, int namelen);
</code></pre> 
<ul><li><code>s</code>：要绑定的套接字。</li><li><code>name</code>：指向sockaddr结构的指针，包含要绑定的本地地址信息。</li><li><code>namelen</code>：<code>name</code>结构的长度。</li></ul> 
<p>（4）<code>listen</code>：</p> 
<pre><code>int listen(SOCKET s, int backlog);
</code></pre> 
<ul><li><code>s</code>：要监听的套接字。</li><li><code>backlog</code>：等待连接队列的最大长度。</li></ul> 
<p>（5）<code>accept</code>：</p> 
<pre><code>SOCKET accept(SOCKET s, struct sockaddr* addr, int* addrlen);
</code></pre> 
<ul><li><code>s</code>：监听套接字。</li><li><code>addr</code>：用于存储客户端地址信息的sockaddr结构。</li><li><code>addrlen</code>：<code>addr</code>结构的长度。</li></ul> 
<p>（6）<code>connect</code>：</p> 
<pre><code>int connect(SOCKET s, const struct sockaddr* name, int namelen);
</code></pre> 
<ul><li><code>s</code>：要连接的套接字。</li><li><code>name</code>：指向目标地址信息的sockaddr结构指针。</li><li><code>namelen</code>：<code>name</code>结构的长度。</li></ul> 
<p>（7）<code>send</code>：</p> 
<pre><code>int send(SOCKET s, const char* buf, int len, int flags);
</code></pre> 
<ul><li><code>s</code>：要发送数据的套接字。</li><li><code>buf</code>：要发送的数据缓冲区。</li><li><code>len</code>：要发送的数据长度。</li><li><code>flags</code>：额外选项，如MSG_DONTROUTE等。</li></ul> 
<p>（8）<code>recv</code>：</p> 
<pre><code>int recv(SOCKET s, char* buf, int len, int flags);
</code></pre> 
<ul><li><code>s</code>：要接收数据的套接字。</li><li><code>buf</code>：用于存储接收数据的缓冲区。</li><li><code>len</code>：要接收的数据长度。</li><li><code>flags</code>：额外选项。</li></ul> 
<p>（9）<code>sendto</code>：</p> 
<pre><code>int sendto(SOCKET s, const char* buf, int len, int flags, const struct sockaddr* to, int tolen);
</code></pre> 
<ul><li><code>s</code>：要发送数据的套接字。</li><li><code>buf</code>：要发送的数据缓冲区。</li><li><code>len</code>：要发送的数据长度。</li><li><code>flags</code>：额外选项。</li><li><code>to</code>：指向目标地址信息的sockaddr结构指针。</li><li><code>tolen</code>：<code>to</code>结构的长度。</li></ul> 
<p>（10）<code>recvfrom</code>：</p> 
<pre><code>int recvfrom(SOCKET s, char* buf, int len, int flags, struct sockaddr* from, int* fromlen);
</code></pre> 
<ul><li><code>s</code>：要接收数据的套接字。</li><li><code>buf</code>：用于存储接收数据的缓冲区。</li><li><code>len</code>：要接收的数据长度。</li><li><code>flags</code>：额外选项。</li><li><code>from</code>：用于存储发送方地址信息的sockaddr结构指针。</li><li><code>fromlen</code>：<code>from</code>结构的长度。</li></ul> 
<p>（11）<code>closesocket</code>：</p> 
<pre><code>int closesocket(SOCKET s);
</code></pre> 
<ul><li><code>s</code>：要关闭的套接字。</li></ul> 
<p>（12）<code>getaddrinfo</code>：</p> 
<pre><code>int getaddrinfo(const char* nodename, const char* servname, const struct addrinfo* hints, struct addrinfo** res);
</code></pre> 
<ul><li><code>nodename</code>：目标主机名或IP地址。</li><li><code>servname</code>：服务名或端口号。</li><li><code>hints</code>：指向addrinfo结构的指针，提供关于地址查找的提示。</li><li><code>res</code>：指向addrinfo结构链表的指针，用于接收查找结果。</li></ul> 
<p>（13）<code>gethostbyname</code>：</p> 
<pre><code>struct hostent* gethostbyname(const char* name);
</code></pre> 
<ul><li><code>name</code>：要查询的主机名。</li></ul> 
<p>（14）<code>gethostname</code>：</p> 
<pre><code>int gethostname(char* name, int namelen);
</code></pre> 
<ul><li><code>name</code>：用于接收主机名的缓冲区。</li><li><code>namelen</code>：<code>name</code>缓冲区的长度。</li></ul> 
<h3><a id="43__331"></a>4.3 编写代码体验网络编程</h3> 
<p>上面了解了这些函数，可能不知道如何使用。 这里就写一个例子，以TCP客户端的身份去连接TCP服务器，完成数据传输。</p> 
<p>**下面代码实现一个TCP客户端，连接到指定的服务器并完成通信。 ** 可以直接将代码贴到你的工程里，运行，体验效果。</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ws2tcpip.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"ws2_32.lib"</span><span class="token expression"><span class="token punctuation">)</span> </span><span class="token comment">//告诉编译器链接Winsock库</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    WSADATA wsaData<span class="token punctuation">;</span> <span class="token comment">//创建一个结构体变量，用于存储关于Winsock库的信息</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化Winsock库，指定版本号2.2，检查返回值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"WSAStartup failed: "</span> <span class="token operator">&lt;&lt;</span> result <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出错误信息并退出程序</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    SOCKET connectSocket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建一个TCP套接字，检查返回值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connectSocket <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"socket failed with error: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出错误信息并退出程序</span>
        <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除Winsock库</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sockaddr_in service<span class="token punctuation">;</span> <span class="token comment">//创建一个结构体变量，用于存储服务器地址信息</span>
    service<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span> <span class="token comment">//指定地址族为IPv4</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>service<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将字符串类型的IP地址转换为二进制网络字节序的IP地址，并存储在结构体中</span>
    service<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">12345</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将端口号从主机字节序转换为网络字节序，并存储在结构体中</span>

    result <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>service<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//连接到服务器，检查返回值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"connect failed with error: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出错误信息并退出程序</span>
        <span class="token function">closesocket</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭套接字</span>
        <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除Winsock库</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Connected to server."</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//连接成功，输出消息</span>

    <span class="token keyword">char</span> sendBuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hello, server!"</span><span class="token punctuation">;</span> <span class="token comment">//创建发送缓冲区，存储待发送的数据</span>
    result <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">,</span> sendBuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sendBuffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//向服务器发送数据，检查返回值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"send failed with error: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出错误信息并退出程序</span>
        <span class="token function">closesocket</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭套接字</span>
        <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除Winsock库</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span> recvBuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//创建接收缓冲区，用于存储从服务器接收到的数据</span>
    result <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">,</span> recvBuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>recvBuffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从服务器接收数据，检查返回值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"recv failed with error: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出错误信息并退出程序</span>
        <span class="token function">closesocket</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭套接字</span>
        <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除Winsock库</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Received message from server: "</span> <span class="token operator">&lt;&lt;</span> recvBuffer <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出从服务器收到的数据</span>

    <span class="token function">closesocket</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭套接字</span>
    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除Winsock库</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>运行效果：</strong></p> 
<p><img src="https://images2.imgbox.com/da/63/PgLROMGN_o.png" alt="image-20231031134243184"></p> 
<h2><a id="IOT_419"></a>五、访问华为云IOT服务器创建一个产品和设备</h2> 
<h3><a id="52__421"></a>5.2 开通物联网服务</h3> 
<p>地址： <a href="https://www.huaweicloud.com/product/iothub.html" rel="nofollow">https://www.huaweicloud.com/product/iothub.html</a></p> 
<p><img src="https://images2.imgbox.com/e2/ea/k1oiMwQM_o.png" alt="image-20221204194233414"></p> 
<p><strong>现在可以免费创建的，按需付费。 只要是不超过规格，就可以免费使用，对于个人项目Demo来说，完全够用的</strong></p> 
<p><img src="https://images2.imgbox.com/75/fc/oGUzHDbR_o.png" alt="image-20231128160932256"></p> 
<p><strong>点击立即创建之后，会开始创建实例，需要等待片刻，再刷新浏览器就可以看到创建成功了。</strong></p> 
<p><img src="https://images2.imgbox.com/ec/01/qCQhydsn_o.png" alt="image-20231128161057219"></p> 
<p><strong>创建完成，点击实例，即可进入实例详情页面。</strong></p> 
<p><img src="https://images2.imgbox.com/47/10/YZPBbPEV_o.png" alt="image-20231128161544523"></p> 
<p>进入实例详情页面后，可以看到接入信息的描述，我们当前设备准备采用MQTT协议接入华为云平台，这里可以看到MQTT协议的地址和端口号等信息。</p> 
<p><img src="https://images2.imgbox.com/70/2e/n9KdBPUE_o.png" alt="image-20231128161714301"></p> 
<p><strong>总结:</strong></p> 
<pre><code>端口号：   MQTT (1883)
接入地址： 252d4bd608.st1.iotda-device.cn-north-4.myhuaweicloud.com
</code></pre> 
<p>**根据域名地址得到IP地址信息: ** 打开windows的CMD窗口</p> 
<pre><code>Microsoft Windows [版本 10.0.19045.3693]
(c) Microsoft Corporation。保留所有权利。

C:\Users\11266&gt;ping 252d4bd608.st1.iotda-device.cn-north-4.myhuaweicloud.com

正在 Ping 252d4bd608.st1.iotda-device.cn-north-4.myhuaweicloud.com [117.78.5.125] 具有 32 字节的数据:
来自 117.78.5.125 的回复: 字节=32 时间=41ms TTL=94
来自 117.78.5.125 的回复: 字节=32 时间=38ms TTL=94
来自 117.78.5.125 的回复: 字节=32 时间=37ms TTL=94
来自 117.78.5.125 的回复: 字节=32 时间=39ms TTL=94

117.78.5.125 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
    最短 = 37ms，最长 = 41ms，平均 = 38ms

C:\Users\11266&gt;

</code></pre> 
<p><img src="https://images2.imgbox.com/f6/65/Lbm6kRVp_o.png" alt="image-20231128161930198"></p> 
<p>MQTT协议接入端口号有两个，1883是非加密端口，8883是证书加密端口，单片机无法加载证书，所以使用1883端口比较合适。 接下来的ESP8266就采用1883端口连接华为云物联网平台。</p> 
<h3><a id="53__489"></a>5.3 创建产品</h3> 
<h4><a id="1_491"></a>（1）创建产品</h4> 
<p>点击产品页，再点击左上角创建产品。</p> 
<p><img src="https://images2.imgbox.com/a2/0a/sAuZzvF9_o.png" alt="image-20231128163411971"></p> 
<h4><a id="2_499"></a>（2）填写产品信息</h4> 
<p>根据自己产品名字填写，下面的设备类型选择自定义类型。</p> 
<p><img src="https://images2.imgbox.com/28/f7/zZMKzE9X_o.png" alt="image-20231201143214237"></p> 
<h4><a id="3_507"></a>（3）产品创建成功</h4> 
<p>创建成功之后，点击产品的名字就可以进入到产品的详情页。</p> 
<p><img src="https://images2.imgbox.com/ae/13/W9n5pjVb_o.png" alt="image-20231201143237590"></p> 
<h4><a id="4_515"></a>（4）添加自定义模型</h4> 
<p>产品创建完成之后，点击进入产品详情页面，翻到最下面可以看到模型定义。</p> 
<p><img src="https://images2.imgbox.com/2e/2c/KWaFILCk_o.png" alt="image-20231128164716733"></p> 
<p>模型简单来说： 就是存放设备上传到云平台的数据。</p> 
<p>先点击自定义模型。</p> 
<p><img src="https://images2.imgbox.com/8a/29/FUK4ArkI_o.png" alt="image-20231128164722543"></p> 
<p>再创建一个服务ID。</p> 
<p><img src="https://images2.imgbox.com/39/1c/sNFVWQld_o.png" alt="image-20231128164736524"></p> 
<p>接着点击新增属性。</p> 
<p><img src="https://images2.imgbox.com/03/fb/VsZfm78G_o.png" alt="image-20231128164752998"></p> 
<p>这里就创建一个温度的属性。我们这个设备用来测温的。</p> 
<p><img src="https://images2.imgbox.com/f7/da/j10b8LFw_o.png" alt="image-20231201143611800"></p> 
<p><img src="https://images2.imgbox.com/54/25/8chTnQQ0_o.png" alt="image-20231201143658599"></p> 
<h3><a id="34__555"></a>3.4 添加设备</h3> 
<p>产品是属于上层的抽象模型，接下来在产品模型下添加实际的设备。添加的设备最终需要与真实的设备关联在一起，完成数据交互。</p> 
<h4><a id="1_559"></a>（1）注册设备</h4> 
<p><img src="https://images2.imgbox.com/c2/61/ihEGSbqo_o.png" alt="image-20231128165130340"></p> 
<h4><a id="2_565"></a>（2）根据自己的设备填写</h4> 
<p><img src="https://images2.imgbox.com/60/12/7nduxebT_o.png" alt="image-20231201143815785"></p> 
<h4><a id="3_571"></a>（3）保存设备信息</h4> 
<p>创建完毕之后，点击保存并关闭，得到创建的设备密匙信息。该信息在后续生成MQTT三元组的时候需要使用。</p> 
<pre><code class="prism language-cpp"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"device_id"</span><span class="token operator">:</span> <span class="token string">"65697df3585c81787ad4da82_stm32"</span><span class="token punctuation">,</span>
    <span class="token string">"secret"</span><span class="token operator">:</span> <span class="token string">"12345678"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>点击设备名称可以进入到设备详情页。</p> 
<p><img src="https://images2.imgbox.com/55/f6/ynBB23z8_o.png" alt="image-20231201143934356"></p> 
<h3><a id="35_MQTT_592"></a>3.5 MQTT协议主题订阅与发布</h3> 
<h4><a id="1MQTT_594"></a>（1）华为云平台MQTT协议使用限制</h4> 
<table><thead><tr><th>描述</th><th>限制</th></tr></thead><tbody><tr><td>支持的MQTT协议版本</td><td>3.1.1</td></tr><tr><td>与标准MQTT协议的区别</td><td>支持Qos 0和Qos 1支持Topic自定义不支持QoS2不支持will、retain msg</td></tr><tr><td>MQTTS支持的安全等级</td><td>采用TCP通道基础 + TLS协议（最高TLSv1.3版本）</td></tr><tr><td>单帐号每秒最大MQTT连接请求数</td><td>无限制</td></tr><tr><td>单个设备每分钟支持的最大MQTT连接数</td><td>1</td></tr><tr><td>单个MQTT连接每秒的吞吐量，即带宽，包含直连设备和网关</td><td>3KB/s</td></tr><tr><td>MQTT单个发布消息最大长度，超过此大小的发布请求将被直接拒绝</td><td>1MB</td></tr><tr><td>MQTT连接心跳时间建议值</td><td>心跳时间限定为30至1200秒，推荐设置为120秒</td></tr><tr><td>产品是否支持自定义Topic</td><td>支持</td></tr><tr><td>消息发布与订阅</td><td>设备只能对自己的Topic进行消息发布与订阅</td></tr><tr><td>每个订阅请求的最大订阅数</td><td>无限制</td></tr></tbody></table> 
<h4><a id="2_612"></a>（2）主题订阅格式</h4> 
<p>帮助文档地址：https://support.huaweicloud.com/devg-iothub/iot_02_2200.html</p> 
<p><img src="https://images2.imgbox.com/20/ed/dNfyXcK1_o.png" alt="image-20221207153310037"></p> 
<p>对于设备而言，一般会订阅平台下发消息给设备 这个主题。</p> 
<p>设备想接收平台下发的消息，就需要订阅平台下发消息给设备 的主题，订阅后，平台下发消息给设备，设备就会收到消息。</p> 
<p>如果设备想要知道平台下发的消息，需要订阅上面图片里标注的主题。</p> 
<pre><code>以当前设备为例，最终订阅主题的格式如下:
$oc/devices/{device_id}/sys/messages/down

最终的格式:
$oc/devices/65697df3585c81787ad4da82_stm32/sys/messages/down
</code></pre> 
<p>​</p> 
<h4><a id="3_634"></a>（3）主题发布格式</h4> 
<p>对于设备来说，主题发布表示向云平台上传数据，将最新的传感器数据，设备状态上传到云平台。</p> 
<p>这个操作称为：属性上报。</p> 
<p>帮助文档地址：https://support.huaweicloud.com/usermanual-iothub/iot_06_v5_3010.html</p> 
<p><img src="https://images2.imgbox.com/27/c6/p3bluRmd_o.png" alt="image-20221207153637391"></p> 
<p><strong>根据帮助文档的介绍， 当前设备发布主题，上报属性的格式总结如下：</strong></p> 
<pre><code>发布的主题格式:
$oc/devices/{device_id}/sys/properties/report
 
最终的格式:
$oc/devices/65697df3585c81787ad4da82_stm32/sys/properties/report
发布主题时，需要上传数据，这个数据格式是JSON格式。

上传的JSON数据格式如下:

{
  "services": [
    {
      "service_id": &lt;填服务ID&gt;,
      "properties": {
        "&lt;填属性名称1&gt;": &lt;填属性值&gt;,
        "&lt;填属性名称2&gt;": &lt;填属性值&gt;,
        ..........
      }
    }
  ]
}
根据JSON格式，一次可以上传多个属性字段。 这个JSON格式里的，服务ID，属性字段名称，属性值类型，在前面创建产品的时候就已经介绍了，不记得可以翻到前面去查看。

根据这个格式，组合一次上传的属性数据:
{"services": [{"service_id": "stm32","properties":{"TEMP":36.2}}]}
</code></pre> 
<h3><a id="36_MQTT_680"></a>3.6 MQTT三元组</h3> 
<p>MQTT协议登录需要填用户ID，设备ID，设备密码等信息，就像我们平时登录QQ，微信一样要输入账号密码才能登录。MQTT协议登录的这3个参数，一般称为MQTT三元组。</p> 
<p>接下来介绍，华为云平台的MQTT三元组参数如何得到。</p> 
<h4><a id="1MQTT_688"></a>（1）MQTT服务器地址</h4> 
<p>要登录MQTT服务器，首先记得先知道服务器的地址是多少，端口是多少。</p> 
<p>帮助文档地址：https://console.huaweicloud.com/iotdm/?region=cn-north-4#/dm-portal/home</p> 
<p><img src="https://images2.imgbox.com/c6/89/frr1iaXD_o.png" alt="image-20231128165826027"></p> 
<p>MQTT协议的端口支持1883和8883，它们的区别是：8883 是加密端口更加安全。但是单片机上使用比较困难，所以当前的设备是采用1883端口进连接的。</p> 
<p><strong>根据上面的域名和端口号，得到下面的IP地址和端口号信息：</strong> 如果设备支持填写域名可以直接填域名，不支持就直接填写IP地址。 （IP地址就是域名解析得到的）</p> 
<pre><code>华为云的MQTT服务器地址：117.78.5.125
华为云的MQTT端口号：1883
</code></pre> 
<h4><a id="2MQTT_707"></a>（2）生成MQTT三元组</h4> 
<p>华为云提供了一个在线工具，用来生成MQTT鉴权三元组： https://iot-tool.obs-website.cn-north-4.myhuaweicloud.com/</p> 
<p>打开这个工具，填入设备的信息（也就是刚才创建完设备之后保存的信息），点击生成，就可以得到MQTT的登录信息了。</p> 
<p><strong>下面是打开的页面：</strong></p> 
<p><img src="https://images2.imgbox.com/ca/4f/crNyKm5T_o.png" alt="image-20221207154917230"></p> 
<p><strong>填入设备的信息：</strong> （上面两行就是设备创建完成之后保存得到的）</p> 
<p>直接得到三元组信息。</p> 
<p><img src="https://images2.imgbox.com/db/8f/s5ahLz4A_o.png" alt="image-20231201144219530"></p> 
<p>得到三元组之后，设备端通过MQTT协议登录鉴权的时候，填入参数即可。</p> 
<pre><code class="prism language-cpp">ClientId  <span class="token number">65697</span>df3585c81787ad4da82_stm32_0_0_2023120106
Username  <span class="token number">65697</span>df3585c81787ad4da82_stm32
Password  <span class="token number">12</span>cc9b1f637da8d755fa2cbd007bb669e6f292e3e63017538b5e6e13eef0cf58
</code></pre> 
<p><strong>到此，云平台的部署已经完成，设备已经可以正常上传数据了。</strong></p> 
<h4><a id="3MQTT_741"></a>（3）MQTT登录测试参数总结</h4> 
<pre><code class="prism language-cpp">IP地址：<span class="token number">117.78</span><span class="token punctuation">.</span><span class="token number">5.125</span>
端口号：<span class="token number">1883</span>

ClientId  <span class="token number">65697</span>df3585c81787ad4da82_stm32_0_0_2023120106
Username  <span class="token number">65697</span>df3585c81787ad4da82_stm32
Password  <span class="token number">12</span>cc9b1f637da8d755fa2cbd007bb669e6f292e3e63017538b5e6e13eef0cf58


订阅主题：$oc<span class="token operator">/</span>devices<span class="token operator">/</span><span class="token number">65697</span>df3585c81787ad4da82_stm32<span class="token operator">/</span>sys<span class="token operator">/</span>messages<span class="token operator">/</span>down

发布主题：$oc<span class="token operator">/</span>devices<span class="token operator">/</span><span class="token number">65697</span>df3585c81787ad4da82_stm32<span class="token operator">/</span>sys<span class="token operator">/</span>properties<span class="token operator">/</span>report
发布数据：<span class="token punctuation">{<!-- --></span><span class="token string">"services"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"service_id"</span><span class="token operator">:</span> <span class="token string">"stm32"</span><span class="token punctuation">,</span><span class="token string">"properties"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"TEMP"</span><span class="token operator">:</span><span class="token number">36.2</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre> 
<h2><a id="MQTT_766"></a>六、开始学习MQTT协议</h2> 
<h3><a id="61_MQTT_768"></a>6.1 先了解下MQTT协议</h3> 
<p>MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅模式的“轻量级”的消息协议，可在发布者和订阅者之间传递消息。<strong>MQTT协议构建于TCP/IP协议上</strong>，由IBM在1999年发布，当前已经成为了一种主流的物联网通信协议。</p> 
<p>MQTT最大的优点在于，能够以极少的代码和有限的带宽，为连接远程设备提供实时可靠的消息服务。它是一种低开销、低带宽占用的即时通讯协议，使其在物联网、小型设备、移动应用等方面有较广泛的应用。由于其小巧、高效和可靠的特点，MQTT在物联网领域得到了广泛的应用。在很多情况下，包括受限的环境中，如：机器与机器（M2M）通信和物联网（IoT），且已经广泛应用于通过卫星链路通信传感器、偶尔拨号的医疗设备、智能家居、及一些小型化设备中。</p> 
<p>MQTT协议的工作原理是基于发布/订阅模式。在这种模式下，发布者可以向一个或多个主题发布消息，而订阅者可以订阅这些主题以接收相关消息。这种模式允许多个发布者和订阅者同时存在，实现了一种灵活的消息传递机制。此外，MQTT协议还支持三种消息传递质量等级，可根据需要进行选择。</p> 
<p>MQTT协议的另一个重要特点是其轻量级和简单的设计。它的消息头非常小，只有2个字节，这意味着在网络带宽有限的环境下也能够实现高效的消息传递。此外，MQTT协议还支持持久化连接和消息队列等高级功能，可进一步提高消息的可靠性和传递效率。</p> 
<p>MQTT协议的应用范围非常广泛。例如，在智能家居领域，可以使用MQTT协议将各种智能设备连接在一起，实现设备的远程控制和监测。在工业领域，MQTT协议可以用于实现设备的远程监控和维护，提高生产效率和产品质量。在智慧城市建设中，MQTT协议可以用于交通管理、环境监测和公共安全等方面，提升城市管理和居民生活的质量。</p> 
<h3><a id="62_MQTT_782"></a>6.2 MQTT协议官网介绍</h3> 
<p>目前MQTT协议主要是3.1.1 和 5.0 两个版本。 <strong>本篇文章是介绍3.1.1版本的MQTT协议。</strong> 各大标准的MQTT服务器都支持3.1.1.</p> 
<p>链接：https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html</p> 
<p><img src="https://images2.imgbox.com/34/ca/nVXzlaAX_o.png" alt="image-20231130173124909"></p> 
<p>在文档的下方就是介绍MQTT协议的每个包如何封装的。照着协议写代码就行了。</p> 
<p><img src="https://images2.imgbox.com/d9/5c/j17Vgg71_o.png" alt="image-20231130173137530"></p> 
<h3><a id="63_3_802"></a>6.3 需要实现的3个函数</h3> 
<p>整个MQTT协议里，主要是实现3个函数就行了（其他的接口看自己需求）。</p> 
<p>下面列出的3个函数，在一般的MQTT通信里是必备的。我们只要实现了这3个函数，那么完成基本的MQTT通信就没有问题了。</p> 
<pre><code class="prism language-cpp"><span class="token comment">//发布主题</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_PublishData</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> topic<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> qos<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//订阅或者取消订阅主题</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_SubscribeTopic</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> topic<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> qos<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> whether<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//登录MQTT服务器</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_Connect</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> ClientID<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> Username<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> Password<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="64__821"></a>6.4 查看协议文档，了解如何组合协议报文</h3> 
<p>【1】打开文档，打开目录，翻到第3章节—MQTT控制报文。</p> 
<p><img src="https://images2.imgbox.com/a7/98/vFmYkU3i_o.png" alt="image-20231201150505249"></p> 
<p>【2】在第3章，控制报文里，找到对应的子章节，也就是我们接线需要照着文档实现协议组包的章节。</p> 
<p><img src="https://images2.imgbox.com/51/e4/NoZdSG1Z_o.png" alt="image-20231201150657961"></p> 
<h3><a id="65_MQTT_Connect_837"></a>6.5 实现<code>MQTT_Connect</code>函数</h3> 
<p>先认真阅读文档： 了解这个报文的规则，以及出现错误之后错误代码的含义。</p> 
<p>客户端到服务端的网络连接建立后，客户端发送给服务端的第一个报文必须是 <code>CONNECT</code> 报文。 在一个网络连接上，客户端只能发送一次<code>CONNECT</code> 报文。服务端必须将客户端发送的第二个 <code>CONNECT</code> 报文当作协议违规处理并断开客户端的连接。</p> 
<p><img src="https://images2.imgbox.com/94/42/rPj1fu9r_o.png" alt="image-20231201151031703"></p> 
<p>接下来就按顺序查看文档，了解协议报文里每个字节如何组成的。</p> 
<p><img src="https://images2.imgbox.com/0d/4e/R59DcZ2C_o.png" alt="image-20231201151146312"></p> 
<p>接下来就开始编写代码，按照文档的提示，组合报文。</p> 
<p>首先，定义一个数组，用来存放我们按照MQTT协议封装的数据。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> mqtt_txbuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//接收数据缓存区</span>
</code></pre> 
<p>在定义一个变量，用来保存数组的下标，每赋值一次，就自增++；</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> mqtt_txlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="1_871"></a>【1】固定报文头</h4> 
<p>文档说了，数组的第一字节固定为：0x10。 （不懂为什么是0X10，仔细看下面文档里的红色框框，文档已经把二进制位的每个位都标注出来了，如果还是看不懂，就需要补习一下C语言的位运算，熟悉位运算之后，再来看应该就很容易了）。</p> 
<p><img src="https://images2.imgbox.com/ec/07/OnRnbAay_o.png" alt="image-20231201151323636"></p> 
<p>那么第一行代码就是这么写：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//固定报头</span>
<span class="token comment">//控制报文类型</span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>		<span class="token comment">//MQTT Message Type CONNECT</span>
</code></pre> 
<p>接下来第2个字节，文档让看2.2.3小节的说明，那么翻到2.2.3小节，了解如何填写剩余长度值。</p> 
<p><img src="https://images2.imgbox.com/db/04/Ld6RmIHi_o.png" alt="image-20231201152240500"></p> 
<p><img src="https://images2.imgbox.com/21/e5/6VbRY16C_o.png" alt="image-20231201152449794"></p> 
<p>根据文档说明，那么编写代码如下：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//剩余长度(不包括固定头部)</span>
<span class="token keyword">do</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> encodedByte <span class="token operator">=</span> DataLen <span class="token operator">%</span> <span class="token number">128</span><span class="token punctuation">;</span>
	DataLen <span class="token operator">=</span> DataLen <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span>
	<span class="token comment">// if there are more data to encode, set the top bit of this byte</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		encodedByte <span class="token operator">=</span> encodedByte <span class="token operator">|</span> <span class="token number">128</span><span class="token punctuation">;</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> encodedByte<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>好了，现在第2个字节赋值已经完毕。</p> 
<h4><a id="2_918"></a>【2】协议名</h4> 
<p><strong>那么接着看剩下的字节如何填写：</strong></p> 
<p><img src="https://images2.imgbox.com/51/f2/zWqbmuUR_o.png" alt="image-20231201152607923"></p> 
<p>根据文档说明，编写代码如下： (继续按顺序赋值就行了)</p> 
<pre><code class="prism language-cpp"><span class="token comment">//可变报头</span>
<span class="token comment">//协议名</span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        	<span class="token comment">// Protocol Name Length MSB    </span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>           <span class="token comment">// Protocol Name Length LSB    </span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'M'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for M    </span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'Q'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for Q    </span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'T'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for T    </span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'T'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for T    </span>
</code></pre> 
<h4><a id="3_941"></a>【3】协议级别</h4> 
<p>看文档说明。</p> 
<p><img src="https://images2.imgbox.com/d0/75/Z4lgnWtJ_o.png" alt="image-20231201152846219"></p> 
<p>编写代码：</p> 
<pre><code class="prism language-cpp"><span class="token comment">//协议级别</span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>        		<span class="token comment">// MQTT Protocol version = 4   </span>
</code></pre> 
<h4><a id="4_956"></a>【4】连接标志</h4> 
<p>关于每个标志的含义，文档向下翻，下面有详细的介绍，每个标志位的含义。</p> 
<p><img src="https://images2.imgbox.com/8d/59/aEIRD9hz_o.png" alt="image-20231201152912933"></p> 
<p><img src="https://images2.imgbox.com/e3/2b/3FW3iplO_o.png" alt="image-20231201153643742"></p> 
<p>编写代码:</p> 
<pre><code class="prism language-cpp"><span class="token comment">//连接标志</span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xc2</span><span class="token punctuation">;</span>        	<span class="token comment">// conn flags </span>
</code></pre> 
<h4><a id="5_977"></a>【5】保持连接的时间</h4> 
<p>查看文档说明：</p> 
<p><img src="https://images2.imgbox.com/a7/7b/d5fiLJpZ_o.png" alt="image-20231201153711580"></p> 
<p>编写代码：</p> 
<pre><code class="prism language-cpp">mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        		<span class="token comment">// Keep-alive Time Length MSB    </span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>        	<span class="token comment">// Keep-alive Time Length LSB  100S心跳包 </span>
</code></pre> 
<h4><a id="6__994"></a>【6】 可变报头非规范示例</h4> 
<p><img src="https://images2.imgbox.com/64/b6/kMVo8Frd_o.png" alt="image-20231201153928782"></p> 
<h4><a id="7ID_1000"></a>【7】最后部分：填写客户端ID、用户名、密码。</h4> 
<p>这里面提到的客户端标识符、用户名、密码。 就是在前面章节创建华为云IOT服务器，得到的MQTT三元组信息。</p> 
<p><strong>查看文档：</strong></p> 
<p><img src="https://images2.imgbox.com/ee/4d/1Wrcv1X2_o.png" alt="image-20231201154144687"></p> 
<p><strong>编写代码：</strong></p> 
<pre><code class="prism language-cpp">mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>ClientIDLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Client ID length MSB    </span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>ClientIDLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Client ID length LSB  	</span>
<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> ClientID<span class="token punctuation">,</span> ClientIDLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
mqtt_txlen <span class="token operator">+=</span> ClientIDLen<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>UsernameLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>UsernameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//username length MSB    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>UsernameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>    	<span class="token comment">//username length LSB    </span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> Username<span class="token punctuation">,</span> UsernameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">+=</span> UsernameLen<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>PasswordLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>PasswordLen<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//password length MSB    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>PasswordLen<span class="token punctuation">)</span><span class="token punctuation">;</span>    	<span class="token comment">//password length LSB  </span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> Password<span class="token punctuation">,</span> PasswordLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">+=</span> PasswordLen<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="8_1034"></a>【8】响应</h4> 
<p>上面报文封装完毕之后，直接就可以通过网络接口发送出去就行了。</p> 
<p>前提是创建套接字，连接上MQTT服务器，然后再将上面封装好的报文发送过去就行了。</p> 
<p>关于如何Windows下如何创建套接字，连接服务器，前面章节专门讲过了，忘记了可以回去再看看。</p> 
<p><strong>编写代码发送出去：</strong></p> 
<pre><code class="prism language-cpp"><span class="token function">MQTT_SendBuf</span><span class="token punctuation">(</span>mqtt_txbuf<span class="token punctuation">,</span> mqtt_txlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这个函数里面的代码： 就是直接调用的网络接口函数发送的。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buff<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//向服务器发送数据，检查返回值</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"send failed with error: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出错误信息并退出程序</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>发送过去之后，服务器肯定有返回值的。 失败？成功？ 那么我们得判断。</p> 
<p>通过<code>响应</code>章节的文档说明，这里提到一个<code>CONNACK</code>响应报文，是由服务器下发给客户端的。</p> 
<p><img src="https://images2.imgbox.com/e4/4a/CC4kNyQm_o.png" alt="image-20231202123812617"></p> 
<p>在3.2小节，讲解了<code>CONNACK</code>报文的字段含义。如果客户端的连接报文是正确的，服务器会下发0x20 0x00 的确认连接报文给客户端，告诉客户端连接成功。</p> 
<p><img src="https://images2.imgbox.com/c3/42/7GvG33wQ_o.png" alt="image-20231202124201134"></p> 
<p>编写代码： 写代码接收服务器返回的数据，判断返回的数据是不是符合要求。</p> 
<pre><code class="prism language-cpp"><span class="token function">Client_GetData</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从服务器获取数据</span>

<span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> parket_connetAck<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> parket_connetAck<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> parket_connetAck<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//连接成功			   </span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//连接成功</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>CONNACK 报文</code>除了固定报文头之外还有可变报头。也就是后面还有2个字节。 我们可以继续看文档下面的介绍。</p> 
<p>一个叫连接确认标志，一个叫连接返回码。正确的情况下，这两个值应该为0x00 0x00.</p> 
<p><img src="https://images2.imgbox.com/53/52/AZI7smT6_o.png" alt="image-20231202125348117"></p> 
<p>关于返回码的值，我们可以对它进行判断。如果连接失败，也可以知道具体的原因。</p> 
<p><img src="https://images2.imgbox.com/94/e1/Vhp7wNzu_o.png" alt="image-20231202125505479"></p> 
<h4><a id="9_1108"></a>【9】完整代码</h4> 
<pre><code class="prism language-cpp"><span class="token comment">/*
函数功能: 登录服务器
函数返回值: 0表示成功 1表示失败
*/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_Connect</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> ClientID<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> Username<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> Password<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ClientIDLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>ClientID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> UsernameLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>Username<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> PasswordLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>Password<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen<span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	
	<span class="token comment">//可变报头+Payload  每个字段包含两个字节的长度标识</span>
	DataLen <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ClientIDLen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>UsernameLen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>PasswordLen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//固定报头</span>
	<span class="token comment">//控制报文类型</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>		<span class="token comment">//MQTT Message Type CONNECT</span>
	<span class="token comment">//剩余长度(不包括固定头部)</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> encodedByte <span class="token operator">=</span> DataLen <span class="token operator">%</span> <span class="token number">128</span><span class="token punctuation">;</span>
		DataLen <span class="token operator">=</span> DataLen <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span>
		<span class="token comment">// if there are more data to encode, set the top bit of this byte</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
			encodedByte <span class="token operator">=</span> encodedByte <span class="token operator">|</span> <span class="token number">128</span><span class="token punctuation">;</span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> encodedByte<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//可变报头</span>
	<span class="token comment">//协议名</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        	<span class="token comment">// Protocol Name Length MSB    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>           <span class="token comment">// Protocol Name Length LSB    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'M'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for M    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'Q'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for Q    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'T'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for T    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'T'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for T    </span>
	<span class="token comment">//协议级别</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>        		<span class="token comment">// MQTT Protocol version = 4    </span>
	<span class="token comment">//连接标志</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xc2</span><span class="token punctuation">;</span>        	<span class="token comment">// conn flags </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        		<span class="token comment">// Keep-alive Time Length MSB    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>        	<span class="token comment">// Keep-alive Time Length LSB  100S心跳包  </span>

	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>ClientIDLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Client ID length MSB    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>ClientIDLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Client ID length LSB  	</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> ClientID<span class="token punctuation">,</span> ClientIDLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">+=</span> ClientIDLen<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>UsernameLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>UsernameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//username length MSB    </span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>UsernameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>    	<span class="token comment">//username length LSB    </span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> Username<span class="token punctuation">,</span> UsernameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mqtt_txlen <span class="token operator">+=</span> UsernameLen<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>PasswordLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>PasswordLen<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//password length MSB    </span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>PasswordLen<span class="token punctuation">)</span><span class="token punctuation">;</span>    	<span class="token comment">//password length LSB  </span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> Password<span class="token punctuation">,</span> PasswordLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mqtt_txlen <span class="token operator">+=</span> PasswordLen<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">memset</span><span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mqtt_rxlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">MQTT_SendBuf</span><span class="token punctuation">(</span>mqtt_txbuf<span class="token punctuation">,</span> mqtt_txlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		size <span class="token operator">=</span> <span class="token function">Client_GetData</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从服务器获取数据</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"登录应答:\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%#X "</span><span class="token punctuation">,</span> buff<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> parket_connetAck<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> parket_connetAck<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//连接成功			   </span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//连接成功</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="66__MQTT_PublishData_1203"></a>6.6 实现MQTT_PublishData函数</h3> 
<h4><a id="1_1205"></a>【1】查看文档说明</h4> 
<p>和前面一章节一样，看文档说明编写代码。</p> 
<p><img src="https://images2.imgbox.com/29/70/jLmLpQRd_o.png" alt="image-20231201155454028"></p> 
<h4><a id="2_1213"></a>【2】固定报文头</h4> 
<p>通过文档了解到，发布消息的固定报文头由2个字节组成。第一个字节每个位的组成含义可看文档的表格介绍。</p> 
<p><img src="https://images2.imgbox.com/1f/f2/EIwNqgiR_o.png" alt="image-20231202125731456"></p> 
<p>最高4位是MQTT控制报文类型，固定的值：0x3</p> 
<p>后面4个字节分为是DUP(重发标志)、QOS等级(服务质量等级)、RETAIN(消息的保留标志)。</p> 
<p><strong>DUP(重发标志)：</strong></p> 
<p><img src="https://images2.imgbox.com/bf/18/8dXJ5U2u_o.png" alt="image-20231202130033301"></p> 
<p><strong>QOS等级(服务质量等级)：</strong></p> 
<p><img src="https://images2.imgbox.com/89/64/NW1wLCVs_o.png" alt="image-20231202130109342"></p> 
<p><strong>RETAIN(保留标志–固定位0)：</strong></p> 
<p><img src="https://images2.imgbox.com/56/2b/Fr5hk3yO_o.png" alt="image-20231202130509553"></p> 
<p>那么经过文档的解释，我们编写代码如下： (关于后面4个字节可以根据自己的需求设置)</p> 
<pre><code class="prism language-cpp"><span class="token comment">//固定报头</span>
<span class="token comment">//控制报文类型</span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>    <span class="token comment">// MQTT Message Type PUBLISH  </span>
</code></pre> 
<h4><a id="3_1255"></a>【3】剩余字段长度</h4> 
<p>固定报文头的第2个字节是填写剩余字段长度。</p> 
<p><img src="https://images2.imgbox.com/fb/f1/GJoyUG39_o.png" alt="image-20231202131201868"></p> 
<p>在文档里对<code>剩余长度字段</code>计算的介绍：</p> 
<p><img src="https://images2.imgbox.com/ec/be/hF59nTM5_o.png" alt="image-20231202131112673"></p> 
<p><strong>剩余长度字段： 等于可变报头的长度加上有效载荷的长度。</strong></p> 
<p>这里先要了解： 什么是可变报头？ 什么是有效载荷的长度？</p> 
<p>往下翻文档，可看到<code>可变报头</code>的介绍。 **可变报头是：按顺序包含主题名和报文标识符。 ** 而报文标识符只有在QOS为1或者2的时候才有。</p> 
<p><img src="https://images2.imgbox.com/11/c6/YFDWuTt8_o.png" alt="image-20231202132449071"></p> 
<p>再往下翻文档，可看到<code>有效载荷的长度</code>的介绍。有效载荷包含将被发布的应用消息。数据的内容和格式是应用特定的。有效载荷的长度这样计算：用固定 报头中的剩余长度字段的值减去可变报头的长度。包含零长度有效载荷的 PUBLISH 报文是合法的。</p> 
<p><img src="https://images2.imgbox.com/22/74/mWQOxU5c_o.png" alt="image-20231202132740579"></p> 
<p>经过文档的介绍，我们知道了剩余长度字段如何介绍。</p> 
<p>那么这个剩余长度字段计算出来之后，如何赋值到报文数组里去？ 其实在<code>Connect</code>报文的固定字段第2个字节也是要天剩余长度字段，在<code>Connect</code>报文的章节已经介绍过，在文档的2.2.3小节的有详细说明，那么翻到2.2.3小节，了解如何填写剩余长度值。 (其实我们上一节已经介绍了一遍)</p> 
<p><img src="https://images2.imgbox.com/a3/d1/nqoiEspa_o.png" alt="image-20231201152240500"></p> 
<p><img src="https://images2.imgbox.com/39/1f/oJ0g2B8L_o.png" alt="image-20231201152449794"></p> 
<p>接下来就编写代码：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> topicLength <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//计算主题的长度</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> messageLength <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算发送的消息长度</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen<span class="token punctuation">;</span> <span class="token comment">//保存最终长度</span>

<span class="token comment">//有效载荷的长度这样计算：用固定报头中的剩余长度字段的值减去可变报头的长度</span>
<span class="token comment">//QOS为0时没有标识符</span>
<span class="token comment">//数据长度             主题名   报文标识符   有效载荷</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>qos<span class="token punctuation">)</span>	DataLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> topicLength<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> messageLength<span class="token punctuation">;</span>
<span class="token keyword">else</span>	DataLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> topicLength<span class="token punctuation">)</span> <span class="token operator">+</span> messageLength<span class="token punctuation">;</span>

<span class="token comment">//剩余长度</span>
<span class="token keyword">do</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> encodedByte <span class="token operator">=</span> DataLen <span class="token operator">%</span> <span class="token number">128</span><span class="token punctuation">;</span>
    DataLen <span class="token operator">=</span> DataLen <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token comment">// if there are more data to encode, set the top bit of this byte</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        encodedByte <span class="token operator">=</span> encodedByte <span class="token operator">|</span> <span class="token number">128</span><span class="token punctuation">;</span>
    mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> encodedByte<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="4_1328"></a>【4】可变报头</h4> 
<p><img src="https://images2.imgbox.com/ad/44/CA05Hv9Z_o.png" alt="image-20231202130801113"></p> 
<p><strong>PUBLISH 报文可变报头非规范示例:</strong></p> 
<p><img src="https://images2.imgbox.com/5d/c1/AYzB7CVU_o.png" alt="image-20231202133246434"></p> 
<p><strong>编写代码：</strong></p> 
<pre><code class="prism language-cpp">mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主题长度MSB</span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主题长度LSB </span>
<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//拷贝主题</span>
mqtt_txlen <span class="token operator">+=</span> topicLength<span class="token punctuation">;</span>

<span class="token comment">//报文标识符</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>qos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
	id<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接着就添加有效载荷，也就是实际发送的消息内容。</p> 
<p><img src="https://images2.imgbox.com/01/2f/iwEP0WIY_o.png" alt="image-20231202135619158"></p> 
<p><strong>编写代码:</strong></p> 
<pre><code class="prism language-cpp"><span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> messageLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
mqtt_txlen <span class="token operator">+=</span> messageLength<span class="token punctuation">;</span>
</code></pre> 
<p><strong>最后将报文发送出去：</strong></p> 
<pre><code class="prism language-cpp"><span class="token function">MQTT_SendBuf</span><span class="token punctuation">(</span>mqtt_txbuf<span class="token punctuation">,</span> mqtt_txlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="5_1382"></a>【5】完整代码</h4> 
<pre><code class="prism language-cpp"><span class="token comment">//MQTT发布数据打包函数</span>
<span class="token comment">//topic   主题 </span>
<span class="token comment">//message 消息</span>
<span class="token comment">//qos     消息等级 </span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_PublishData</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> topic<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> qos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> topicLength <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> messageLength <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen<span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"上报JSON消息长度:%d\r\n"</span><span class="token punctuation">,</span> messageLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"message=%s\r\n"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//有效载荷的长度这样计算：用固定报头中的剩余长度字段的值减去可变报头的长度</span>
	<span class="token comment">//QOS为0时没有标识符</span>
	<span class="token comment">//数据长度             主题名   报文标识符   有效载荷</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>qos<span class="token punctuation">)</span>	DataLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> topicLength<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> messageLength<span class="token punctuation">;</span>
	<span class="token keyword">else</span>	DataLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> topicLength<span class="token punctuation">)</span> <span class="token operator">+</span> messageLength<span class="token punctuation">;</span>

	<span class="token comment">//固定报头</span>
	<span class="token comment">//控制报文类型</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>    <span class="token comment">// MQTT Message Type PUBLISH  </span>

	<span class="token comment">//剩余长度</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> encodedByte <span class="token operator">=</span> DataLen <span class="token operator">%</span> <span class="token number">128</span><span class="token punctuation">;</span>
		DataLen <span class="token operator">=</span> DataLen <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span>
		<span class="token comment">// if there are more data to encode, set the top bit of this byte</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
			encodedByte <span class="token operator">=</span> encodedByte <span class="token operator">|</span> <span class="token number">128</span><span class="token punctuation">;</span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> encodedByte<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主题长度MSB</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主题长度LSB </span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//拷贝主题</span>
	mqtt_txlen <span class="token operator">+=</span> topicLength<span class="token punctuation">;</span>

	<span class="token comment">//报文标识符</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>qos<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		id<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> messageLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">+=</span> messageLength<span class="token punctuation">;</span>

	<span class="token function">MQTT_SendBuf</span><span class="token punctuation">(</span>mqtt_txbuf<span class="token punctuation">,</span> mqtt_txlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> mqtt_txlen<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="6_1441"></a>【6】发布确认</h4> 
<p>如果消息质量大于0，那么可以继续看文档下面的发布确认，对本次发送的消息进行响应处理。</p> 
<p><img src="https://images2.imgbox.com/3a/82/JJh2E1oU_o.png" alt="image-20231202140427509"></p> 
<p><img src="https://images2.imgbox.com/d4/ec/KdVEvpZf_o.png" alt="image-20231202140536152"></p> 
<h3><a id="67__MQTT_SubscribeTopic__1453"></a>6.7 实现 MQTT_SubscribeTopic 函数</h3> 
<h4><a id="1_1455"></a>【1】查看文档：订阅主题的格式</h4> 
<p>和前面一样，查看文档的说明，编写代码。</p> 
<p><img src="https://images2.imgbox.com/02/ac/wh8FKF7f_o.png" alt="image-20231201155946444"></p> 
<h4><a id="2_1465"></a>【2】查看文档：取消订阅的格式</h4> 
<p><img src="https://images2.imgbox.com/1a/e4/9jy3g8Xz_o.png" alt="image-20231201160155317"></p> 
<h4><a id="3_1471"></a>【3】固定报头</h4> 
<p>订阅主题和取消订阅主题格式一样的，只是固定报头不一样。</p> 
<p>可以封装一个函数，传入一个参数实现两种功能。</p> 
<p><strong>编写判断代码：</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">//固定报头</span>
<span class="token comment">//控制报文类型</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>whether<span class="token punctuation">)</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x82</span><span class="token punctuation">;</span> <span class="token comment">//消息类型和标志订阅</span>
<span class="token keyword">else</span>	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xA2</span><span class="token punctuation">;</span>    <span class="token comment">//取消订阅</span>
</code></pre> 
<p><strong>剩余长度字段：</strong></p> 
<p><img src="https://images2.imgbox.com/4c/f1/ScnzptUe_o.png" alt="image-20231202141516154"></p> 
<p><strong>编写代码：</strong></p> 
<pre><code class="prism language-cpp"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> topiclen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>topiclen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>whether <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可变报头的长度（2字节）加上有效载荷的长度</span>
</code></pre> 
<p>剩余长度字段的填写规则与前面一样。</p> 
<p><strong>编写代码：</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">//剩余长度</span>
<span class="token keyword">do</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> encodedByte <span class="token operator">=</span> DataLen <span class="token operator">%</span> <span class="token number">128</span><span class="token punctuation">;</span>
    DataLen <span class="token operator">=</span> DataLen <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token comment">// if there are more data to encode, set the top bit of this byte</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        encodedByte <span class="token operator">=</span> encodedByte <span class="token operator">|</span> <span class="token number">128</span><span class="token punctuation">;</span>
    mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> encodedByte<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="4_1522"></a>【4】可变报头</h4> 
<p><img src="https://images2.imgbox.com/10/10/cS5Tsq7C_o.png" alt="image-20231202141435800"></p> 
<p><strong>编写代码：</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">//可变报头</span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">//消息标识符 MSB</span>
mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>        <span class="token comment">//消息标识符 LSB</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1e/24/2sy4qrfq_o.png" alt="image-20231202140915523"></p> 
<h4><a id="5_1542"></a>【5】完整代码</h4> 
<pre><code class="prism language-cpp"><span class="token comment">/*
函数功能: MQTT订阅/取消订阅数据打包函数
函数参数:
	topic       主题
	qos         消息等级 0:最多分发一次  1: 至少分发一次  2: 仅分发一次
	whether     订阅/取消订阅请求包 (1表示订阅,0表示取消订阅)
返回值: 0表示成功 1表示失败
*/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_SubscribeTopic</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> topic<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> qos<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> whether<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> topiclen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>topiclen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>whether <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可变报头的长度（2字节）加上有效载荷的长度</span>
	<span class="token comment">//固定报头</span>
	<span class="token comment">//控制报文类型</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>whether<span class="token punctuation">)</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x82</span><span class="token punctuation">;</span> <span class="token comment">//消息类型和标志订阅</span>
	<span class="token keyword">else</span>	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xA2</span><span class="token punctuation">;</span>    <span class="token comment">//取消订阅</span>
	<span class="token comment">//剩余长度</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> encodedByte <span class="token operator">=</span> DataLen <span class="token operator">%</span> <span class="token number">128</span><span class="token punctuation">;</span>
		DataLen <span class="token operator">=</span> DataLen <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span>
		<span class="token comment">// if there are more data to encode, set the top bit of this byte</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
			encodedByte <span class="token operator">=</span> encodedByte <span class="token operator">|</span> <span class="token number">128</span><span class="token punctuation">;</span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> encodedByte<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//可变报头</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">//消息标识符 MSB</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>        <span class="token comment">//消息标识符 LSB</span>
	<span class="token comment">//有效载荷</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>topiclen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主题长度 MSB</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>topiclen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主题长度 LSB   </span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> topiclen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">+=</span> topiclen<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>whether<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> qos<span class="token punctuation">;</span><span class="token comment">//QoS级别</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">memset</span><span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mqtt_rxlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">MQTT_SendBuf</span><span class="token punctuation">(</span>mqtt_txbuf<span class="token punctuation">,</span> mqtt_txlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//printf("订阅消息发布成功\n");</span>
		size <span class="token operator">=</span> <span class="token function">Client_GetData</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从服务器获取数据</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"订阅应答:\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%#X "</span><span class="token punctuation">,</span> buff<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> parket_subAck<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> parket_subAck<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//连接成功			   </span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//连接成功</span>
		<span class="token punctuation">}</span>
		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//失败</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_1618"></a>七、运行项目、连接华为云服务器</h2> 
<h3><a id="71__1620"></a>7.1 整个项目的完整代码</h3> 
<p>前面章节陆续已经编写好了重要的函数，那么这里就贴出我编写好的整体的代码,进行运行测试：</p> 
<p><img src="https://images2.imgbox.com/da/36/gPya2Hzu_o.png" alt="image-20231201160401486"></p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;time.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">warning</span><span class="token punctuation">(</span>disable<span class="token operator">:</span><span class="token number">4996</span><span class="token punctuation">)</span></span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ws2tcpip.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"ws2_32.lib"</span><span class="token expression"><span class="token punctuation">)</span> </span><span class="token comment">//告诉编译器链接Winsock库</span></span>



<span class="token comment">//---------------------------------------MQTT协议相关的子函数声明-------------------------------------------------------</span>

<span class="token comment">//发布主题</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_PublishData</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> topic<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> qos<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//订阅或者取消订阅主题</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_SubscribeTopic</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> topic<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> qos<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> whether<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//登录MQTT服务器</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_Connect</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> ClientID<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> Username<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> Password<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//MQTT协议缓冲区初始化</span>
<span class="token keyword">void</span> <span class="token function">MQTT_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//调用底层接口发送数据包</span>
<span class="token keyword">void</span> <span class="token function">MQTT_SendBuf</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//MQTT协议里最底层的接口，最底层的如果要移植协议到其他地方运行，那么改这里就行了。其他地方不用改的。</span>
<span class="token keyword">int</span> <span class="token function">Client_SendData</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> buff<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送数据到服务器</span>
<span class="token keyword">int</span> <span class="token function">Client_GetData</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从服务器获取数据</span>


<span class="token comment">//---------------------------------------全局变量定义--------------------------------------------------------------------</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE0</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE1</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE2</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">BYTE3</span><span class="token expression"><span class="token punctuation">(</span>dwTemp<span class="token punctuation">)</span>       <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwTemp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>


<span class="token keyword">unsigned</span> <span class="token keyword">char</span> mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//发送数据缓存区</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> mqtt_txbuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//接收数据缓存区</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> mqtt_rxlen<span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> mqtt_txlen<span class="token punctuation">;</span>


<span class="token keyword">typedef</span> <span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//名字 	    值 			报文流动方向 	描述</span>
	M_RESERVED1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>	<span class="token comment">//	禁止	保留</span>
	M_CONNECT<span class="token punctuation">,</span>	<span class="token comment">//	客户端到服务端	客户端请求连接服务端</span>
	M_CONNACK<span class="token punctuation">,</span>	<span class="token comment">//	服务端到客户端	连接报文确认</span>
	M_PUBLISH<span class="token punctuation">,</span>	<span class="token comment">//	两个方向都允许	发布消息</span>
	M_PUBACK<span class="token punctuation">,</span>	<span class="token comment">//	两个方向都允许	QoS 1消息发布收到确认</span>
	M_PUBREC<span class="token punctuation">,</span>	<span class="token comment">//	两个方向都允许	发布收到（保证交付第一步）</span>
	M_PUBREL<span class="token punctuation">,</span>	<span class="token comment">//	两个方向都允许	发布释放（保证交付第二步）</span>
	M_PUBCOMP<span class="token punctuation">,</span>	<span class="token comment">//	两个方向都允许	QoS 2消息发布完成（保证交互第三步）</span>
	M_SUBSCRIBE<span class="token punctuation">,</span>	<span class="token comment">//	客户端到服务端	客户端订阅请求</span>
	M_SUBACK<span class="token punctuation">,</span>	<span class="token comment">//	服务端到客户端	订阅请求报文确认</span>
	M_UNSUBSCRIBE<span class="token punctuation">,</span>	<span class="token comment">//	客户端到服务端	客户端取消订阅请求</span>
	M_UNSUBACK<span class="token punctuation">,</span>	<span class="token comment">//	服务端到客户端	取消订阅报文确认</span>
	M_PINGREQ<span class="token punctuation">,</span>	<span class="token comment">//	客户端到服务端	心跳请求</span>
	M_PINGRESP<span class="token punctuation">,</span>	<span class="token comment">//	服务端到客户端	心跳响应</span>
	M_DISCONNECT<span class="token punctuation">,</span>	<span class="token comment">//	客户端到服务端	客户端断开连接</span>
	M_RESERVED2<span class="token punctuation">,</span>	<span class="token comment">//	禁止	保留</span>
<span class="token punctuation">}</span>_typdef_mqtt_message<span class="token punctuation">;</span>

<span class="token comment">//连接成功服务器回应 20 02 00 00</span>
<span class="token comment">//客户端主动断开连接 e0 00</span>
<span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> parket_connetAck<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> parket_disconnet<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token number">0x00</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> parket_heart<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x00</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> parket_heart_reply<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0xc0</span><span class="token punctuation">,</span><span class="token number">0x00</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> parket_subAck<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0x90</span><span class="token punctuation">,</span><span class="token number">0x03</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">MQTT_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//缓冲区赋值</span>
	mqtt_rxlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>mqtt_txbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mqtt_rxlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span>mqtt_txbuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mqtt_txlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>


<span class="token comment">/*
函数功能: 登录服务器
函数返回值: 0表示成功 1表示失败
*/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_Connect</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> ClientID<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> Username<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> Password<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ClientIDLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>ClientID<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> UsernameLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>Username<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> PasswordLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>Password<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen<span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	
	<span class="token comment">//可变报头+Payload  每个字段包含两个字节的长度标识</span>
	DataLen <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ClientIDLen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>UsernameLen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>PasswordLen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//固定报头</span>
	<span class="token comment">//控制报文类型</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>		<span class="token comment">//MQTT Message Type CONNECT</span>
	<span class="token comment">//剩余长度(不包括固定头部)</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> encodedByte <span class="token operator">=</span> DataLen <span class="token operator">%</span> <span class="token number">128</span><span class="token punctuation">;</span>
		DataLen <span class="token operator">=</span> DataLen <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span>
		<span class="token comment">// if there are more data to encode, set the top bit of this byte</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
			encodedByte <span class="token operator">=</span> encodedByte <span class="token operator">|</span> <span class="token number">128</span><span class="token punctuation">;</span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> encodedByte<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//可变报头</span>
	<span class="token comment">//协议名</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        	<span class="token comment">// Protocol Name Length MSB    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>           <span class="token comment">// Protocol Name Length LSB    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'M'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for M    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'Q'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for Q    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'T'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for T    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'T'</span><span class="token punctuation">;</span>        	<span class="token comment">// ASCII Code for T    </span>
	<span class="token comment">//协议级别</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>        		<span class="token comment">// MQTT Protocol version = 4    </span>
	<span class="token comment">//连接标志</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xc2</span><span class="token punctuation">;</span>        	<span class="token comment">// conn flags </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        		<span class="token comment">// Keep-alive Time Length MSB    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>        	<span class="token comment">// Keep-alive Time Length LSB  100S心跳包  </span>

	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>ClientIDLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Client ID length MSB    </span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>ClientIDLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Client ID length LSB  	</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> ClientID<span class="token punctuation">,</span> ClientIDLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">+=</span> ClientIDLen<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>UsernameLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>UsernameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//username length MSB    </span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>UsernameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>    	<span class="token comment">//username length LSB    </span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> Username<span class="token punctuation">,</span> UsernameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mqtt_txlen <span class="token operator">+=</span> UsernameLen<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>PasswordLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>PasswordLen<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//password length MSB    </span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>PasswordLen<span class="token punctuation">)</span><span class="token punctuation">;</span>    	<span class="token comment">//password length LSB  </span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> Password<span class="token punctuation">,</span> PasswordLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mqtt_txlen <span class="token operator">+=</span> PasswordLen<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">memset</span><span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mqtt_rxlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">MQTT_SendBuf</span><span class="token punctuation">(</span>mqtt_txbuf<span class="token punctuation">,</span> mqtt_txlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		size <span class="token operator">=</span> <span class="token function">Client_GetData</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从服务器获取数据</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"登录应答:\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%#X "</span><span class="token punctuation">,</span> buff<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> parket_connetAck<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> parket_connetAck<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//连接成功			   </span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//连接成功</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
函数功能: MQTT订阅/取消订阅数据打包函数
函数参数:
	topic       主题
	qos         消息等级 0:最多分发一次  1: 至少分发一次  2: 仅分发一次
	whether     订阅/取消订阅请求包 (1表示订阅,0表示取消订阅)
返回值: 0表示成功 1表示失败
*/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_SubscribeTopic</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> topic<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> qos<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> whether<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> buff<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> topiclen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token punctuation">(</span>topiclen <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>whether <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//可变报头的长度（2字节）加上有效载荷的长度</span>
	<span class="token comment">//固定报头</span>
	<span class="token comment">//控制报文类型</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>whether<span class="token punctuation">)</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x82</span><span class="token punctuation">;</span> <span class="token comment">//消息类型和标志订阅</span>
	<span class="token keyword">else</span>	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xA2</span><span class="token punctuation">;</span>    <span class="token comment">//取消订阅</span>
	<span class="token comment">//剩余长度</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> encodedByte <span class="token operator">=</span> DataLen <span class="token operator">%</span> <span class="token number">128</span><span class="token punctuation">;</span>
		DataLen <span class="token operator">=</span> DataLen <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span>
		<span class="token comment">// if there are more data to encode, set the top bit of this byte</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
			encodedByte <span class="token operator">=</span> encodedByte <span class="token operator">|</span> <span class="token number">128</span><span class="token punctuation">;</span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> encodedByte<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//可变报头</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">//消息标识符 MSB</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>        <span class="token comment">//消息标识符 LSB</span>
	<span class="token comment">//有效载荷</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>topiclen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主题长度 MSB</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>topiclen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主题长度 LSB   </span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> topiclen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">+=</span> topiclen<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>whether<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> qos<span class="token punctuation">;</span><span class="token comment">//QoS级别</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">memset</span><span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mqtt_rxlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">MQTT_SendBuf</span><span class="token punctuation">(</span>mqtt_txbuf<span class="token punctuation">,</span> mqtt_txlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//printf("订阅消息发布成功\n");</span>
		size <span class="token operator">=</span> <span class="token function">Client_GetData</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//从服务器获取数据</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">memcpy</span><span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"订阅应答:\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%#X "</span><span class="token punctuation">,</span> buff<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> parket_subAck<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> mqtt_rxbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> parket_subAck<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//连接成功			   </span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//连接成功</span>
		<span class="token punctuation">}</span>
		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//失败</span>
<span class="token punctuation">}</span>



<span class="token comment">//MQTT发布数据打包函数</span>
<span class="token comment">//topic   主题 </span>
<span class="token comment">//message 消息</span>
<span class="token comment">//qos     消息等级 </span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">MQTT_PublishData</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> topic<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> message<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> qos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> topicLength <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> messageLength <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> DataLen<span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"上报JSON消息长度:%d\r\n"</span><span class="token punctuation">,</span> messageLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"message=%s\r\n"</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//有效载荷的长度这样计算：用固定报头中的剩余长度字段的值减去可变报头的长度</span>
	<span class="token comment">//QOS为0时没有标识符</span>
	<span class="token comment">//数据长度             主题名   报文标识符   有效载荷</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>qos<span class="token punctuation">)</span>	DataLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> topicLength<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> messageLength<span class="token punctuation">;</span>
	<span class="token keyword">else</span>	DataLen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> topicLength<span class="token punctuation">)</span> <span class="token operator">+</span> messageLength<span class="token punctuation">;</span>

	<span class="token comment">//固定报头</span>
	<span class="token comment">//控制报文类型</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>    <span class="token comment">// MQTT Message Type PUBLISH  </span>

	<span class="token comment">//剩余长度</span>
	<span class="token keyword">do</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span> encodedByte <span class="token operator">=</span> DataLen <span class="token operator">%</span> <span class="token number">128</span><span class="token punctuation">;</span>
		DataLen <span class="token operator">=</span> DataLen <span class="token operator">/</span> <span class="token number">128</span><span class="token punctuation">;</span>
		<span class="token comment">// if there are more data to encode, set the top bit of this byte</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
			encodedByte <span class="token operator">=</span> encodedByte <span class="token operator">|</span> <span class="token number">128</span><span class="token punctuation">;</span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> encodedByte<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>DataLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主题长度MSB</span>
	mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主题长度LSB </span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//拷贝主题</span>
	mqtt_txlen <span class="token operator">+=</span> topicLength<span class="token punctuation">;</span>

	<span class="token comment">//报文标识符</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>qos<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE1</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">BYTE0</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
		id<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mqtt_txbuf<span class="token punctuation">[</span>mqtt_txlen<span class="token punctuation">]</span><span class="token punctuation">,</span> message<span class="token punctuation">,</span> messageLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mqtt_txlen <span class="token operator">+=</span> messageLength<span class="token punctuation">;</span>

	<span class="token function">MQTT_SendBuf</span><span class="token punctuation">(</span>mqtt_txbuf<span class="token punctuation">,</span> mqtt_txlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> mqtt_txlen<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">MQTT_SendBuf</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">Client_SendData</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送数据到服务器</span>
<span class="token punctuation">}</span>





<span class="token comment">//-----------------------------------------MQTT服务器的参数------------------------------------------------------------</span>
<span class="token comment">//服务器IP</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERVER_IP</span> <span class="token string">"117.78.5.125"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERVER_PORT</span> <span class="token expression"><span class="token number">1883</span> </span><span class="token comment">//端口号</span></span>

<span class="token comment">//MQTT三元组</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ClientID</span> <span class="token string">"65697df3585c81787ad4da82_stm32_0_0_2023120106"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Username</span> <span class="token string">"65697df3585c81787ad4da82_stm32"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">Password</span> <span class="token string">"12cc9b1f637da8d755fa2cbd007bb669e6f292e3e63017538b5e6e13eef0cf58"</span><span class="token comment">//密文 </span></span>

<span class="token comment">//订阅主题:</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SET_TOPIC</span>  <span class="token string">"$oc/devices/65697df3585c81787ad4da82_stm32/sys/messages/down"</span><span class="token comment">//订阅</span></span>
<span class="token comment">//发布主题:</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">POST_TOPIC</span> <span class="token string">"$oc/devices/65697df3585c81787ad4da82_stm32/sys/properties/report"</span><span class="token comment">//发布</span></span>




<span class="token comment">//-----------------------------------------主函数------------------------------------------------------------</span>

<span class="token keyword">char</span> mqtt_message<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//数据缓存区</span>


SOCKET connectSocket<span class="token punctuation">;</span> <span class="token comment">//网络套接字</span>
WSADATA wsaData<span class="token punctuation">;</span> <span class="token comment">//创建一个结构体变量，用于存储关于Winsock库的信息</span>

<span class="token keyword">double</span> TEMP <span class="token operator">=</span> <span class="token number">10.0</span><span class="token punctuation">;</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化Winsock库，指定版本号2.2，检查返回值</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WSAStartup failed: %d\r\n"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出错误信息并退出程序</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	 connectSocket <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建一个TCP套接字，检查返回值</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>connectSocket <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"socket failed with error: %d"</span><span class="token punctuation">,</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出错误信息并退出程序</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除Winsock库</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	sockaddr_in service<span class="token punctuation">;</span> <span class="token comment">//创建一个结构体变量，用于存储服务器地址信息</span>
	service<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span> <span class="token comment">//指定地址族为IPv4</span>
	<span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SERVER_IP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>service<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将字符串类型的IP地址转换为二进制网络字节序的IP地址，并存储在结构体中</span>
	service<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>SERVER_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//将端口号从主机字节序转换为网络字节序，并存储在结构体中</span>

	result <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">,</span> <span class="token punctuation">(</span>SOCKADDR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>service<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//连接到服务器，检查返回值</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"connect failed with error: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出错误信息并退出程序</span>
		<span class="token function">closesocket</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭套接字</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除Winsock库</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Connected to server."</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//连接成功，输出消息</span>

	<span class="token function">MQTT_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">/*登录服务器*/</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">MQTT_Connect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>ClientID<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>Username<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>Password<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 延时1000毫秒，即1秒</span>
		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"MQTT服务器登录校验中....\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"连接成功_666\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//订阅物联网平台数据</span>
	<span class="token keyword">int</span> stat <span class="token operator">=</span> <span class="token function">MQTT_SubscribeTopic</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>SET_TOPIC<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"订阅失败\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">closesocket</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//关闭套接字</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//清除Winsock库</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"订阅成功\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token comment">/*创建线程*/</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span>mqtt_message<span class="token punctuation">,</span> <span class="token string">"{\"services\": [{\"service_id\": \"stm32\",\"properties\":{\"TEMP\":%.1f}}]}"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">(</span>TEMP<span class="token operator">+=</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//温度</span>
		
		<span class="token comment">//发布主题</span>
		<span class="token function">MQTT_PublishData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>POST_TOPIC<span class="token punctuation">,</span> mqtt_message<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"发布消息成功\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token comment">/*发送数据到服务器*/</span>
<span class="token keyword">int</span> <span class="token function">Client_SendData</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> buff<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buff<span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//向服务器发送数据，检查返回值</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"send failed with error: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出错误信息并退出程序</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">/*获取服务器下发数据*/</span>
<span class="token keyword">int</span> <span class="token function">Client_GetData</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> buff<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buff<span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//从服务器接收数据，检查返回值</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"recv failed with error: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出错误信息并退出程序</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>




</code></pre> 
<h3><a id="72__2090"></a>7.2 代码里核心的地方</h3> 
<p>这里填写MQTT服务器的信息，也就是前面创建华为云IOT服务器得到的信息。</p> 
<p><img src="https://images2.imgbox.com/81/81/EJFKPVl8_o.png" alt="image-20231201160441966"></p> 
<p>这里是主函数，登录服务器后订阅主题，发布消息。</p> 
<p><img src="https://images2.imgbox.com/fa/b7/sNSMMcAv_o.png" alt="image-20231201160547892"></p> 
<h3><a id="73__2104"></a>7.3 编译运行代码</h3> 
<p>按下<code>Ctrl+F5 </code>运行代码。 弹出控制台窗口之后，可以看到，我们已经连接了华为云MQTT服务器，并且完成数据上传。</p> 
<p><img src="https://images2.imgbox.com/8e/4a/j2nLULp2_o.png" alt="image-20231201160621635"></p> 
<h3><a id="74_IOT_2112"></a>7.4 登录华为云IOT云端查看数据</h3> 
<p>可以看到设备已经在线了。</p> 
<p><img src="https://images2.imgbox.com/af/99/FD0ktSiZ_o.png" alt="image-20231201160759752"></p> 
<p><strong>可以看到我们的消息也在实时的上传。</strong></p> 
<p><img src="https://images2.imgbox.com/55/b2/dPWZW1Vi_o.png" alt="image-20231201160823360"></p> 
<p>到此，说明我们的MQTT协议已经封装完成，可以正常的运行了。</p> 
<h2><a id="_2130"></a>八、下发命令的处理</h2> 
<p>一般MQTT设备端除了上传数据以外，还需要接收MQTT服务器下发的控制命令。</p> 
<p>那么我们接下来就完善一下代码，接收华为云MQTT服务器下发的命令，并进行回应。</p> 
<h3><a id="81__2138"></a>8.1 添加命令</h3> 
<p>要测试命令下发，那么首先需要再华为云IOT平台添加命令。</p> 
<p><img src="https://images2.imgbox.com/76/c7/vkTdzmtG_o.png" alt="image-20231202180926999"></p> 
<p><strong>添加一个控制命令。</strong></p> 
<p><img src="https://images2.imgbox.com/7a/2c/v0T63JEs_o.png" alt="image-20231202181202901"></p> 
<p><img src="https://images2.imgbox.com/d9/30/i2qN4VLo_o.png" alt="image-20231202181233447"></p> 
<p>命令添加完成：</p> 
<p><img src="https://images2.imgbox.com/ad/e4/9Ff7nu1y_o.png" alt="image-20231202181248551"></p> 
<h3><a id="82__2164"></a>8.2 下发命令测试</h3> 
<p>注意：下发命令是同步的，设备端必须在线才可以下发命令。</p> 
<p><img src="https://images2.imgbox.com/5b/38/KnTHZ6iS_o.png" alt="image-20231202182312070"></p> 
<p>这个下发的命令是有反馈。设备端收到之后，可以向服务器反馈状态，这样服务器才能知道刚才的控制命令确实发送成功了。</p> 
<p><strong>设备收到信息之后，上传回应给服务器的主题和内容格式：</strong></p> 
<pre><code class="prism language-cpp">Topic：$oc<span class="token operator">/</span>devices<span class="token operator">/</span><span class="token punctuation">{<!-- --></span>device_id<span class="token punctuation">}</span><span class="token operator">/</span>sys<span class="token operator">/</span>commands<span class="token operator">/</span>response<span class="token operator">/</span>request_id<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>request_id<span class="token punctuation">}</span>
数据格式：  
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"result_code"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token string">"response_name"</span><span class="token operator">:</span> <span class="token string">"COMMAND_RESPONSE"</span><span class="token punctuation">,</span>
    <span class="token string">"paras"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"result"</span><span class="token operator">:</span> <span class="token string">"success"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>云端发送控制命令之后，设备收到的消息如下：</strong></p> 
<pre><code class="prism language-cpp">$oc<span class="token operator">/</span>devices<span class="token operator">/</span><span class="token number">65697</span>df3585c81787ad4da82_stm32<span class="token operator">/</span>sys<span class="token operator">/</span>commands<span class="token operator">/</span>request_id<span class="token operator">=</span>d49f0bb9<span class="token operator">-</span>ba87<span class="token operator">-</span><span class="token number">4</span>c9b<span class="token operator">-</span>b915<span class="token operator">-</span><span class="token number">98</span>a1f0fcf689<span class="token punctuation">{<!-- --></span><span class="token string">"paras"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"lock"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"service_id"</span><span class="token operator">:</span><span class="token string">"lock"</span><span class="token punctuation">,</span><span class="token string">"command_name"</span><span class="token operator">:</span><span class="token string">"锁开关控制"</span><span class="token punctuation">}</span>
</code></pre> 
<p>其中<code>request_id=d49f0bb9-ba87-4c9b-b915-98a1f0fcf689</code> 就是本次的请求ID。回应的时候需要加上请求ID。服务器才好对应。</p> 
<p><strong>以当前设备为例：</strong></p> 
<pre><code class="prism language-cpp">发布的主题这样填： $oc<span class="token operator">/</span>devices<span class="token operator">/</span><span class="token number">65113</span>d05a559fd7cd41435f8_lock1<span class="token operator">/</span>sys<span class="token operator">/</span>commands<span class="token operator">/</span>response<span class="token operator">/</span>request_id<span class="token operator">=</span>ce49181e<span class="token operator">-</span><span class="token number">7636</span><span class="token operator">-</span><span class="token number">4</span>b24<span class="token operator">-</span><span class="token number">946</span>d<span class="token operator">-</span>c034ca083c1c
    
发布的内容这样填：
<span class="token punctuation">{<!-- --></span><span class="token string">"result_code"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"response_name"</span><span class="token operator">:</span><span class="token string">"COMMAND_RESPONSE"</span><span class="token punctuation">,</span><span class="token string">"paras"</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"result"</span><span class="token operator">:</span><span class="token string">"success"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> 
<h3><a id="83__2213"></a>8.3 编写代码</h3> 
<p>为了能够实时接收服务器的代码，我们单独增加一个线程来接收服务器的消息。</p> 
<p>在主函数里MQTT服务器连接成功之后，增加以下代码：</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*创建线程*/</span>
HANDLE hThread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>LPTHREAD_START_ROUTINE<span class="token punctuation">)</span>ReceiveData<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>hThread <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"CreateThread failed.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>编写线程的工作函数：</strong></p> 
<pre><code class="prism language-cpp"><span class="token comment">// 处理服务器下发的数据</span>
<span class="token keyword">void</span> <span class="token function">ReceiveData</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 接收数据</span>
	<span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> request_id<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> send_cmd<span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">int</span> recvSize<span class="token punctuation">;</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//等待服务器下发消息</span>
		recvSize <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>connectSocket<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>recvSize <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"网络断开连接: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">//输出错误信息并退出程序</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>recvSize <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"服务器下发消息:\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//接收下发的数据</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> recvSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">//下发指令请求回应给服务器(命令下发)</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"sys/commands/request_id="</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">char</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
				p <span class="token operator">=</span> <span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"request_id="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">//解析数据</span>
					<span class="token comment">//$oc/devices/65697df3585c81787ad4da82_stm32/sys/commands/request_id=6e925cc1-4a8d-4eab-8d85-6c7f15d72189</span>
					<span class="token function">strncpy</span><span class="token punctuation">(</span>request_id<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token comment">//上报数据</span>
				<span class="token function">sprintf</span><span class="token punctuation">(</span>mqtt_message<span class="token punctuation">,</span> <span class="token string">"{\"result_code\":0,\"response_name\":\"COMMAND_RESPONSE\",\"paras\":{\"result\":\"success\"}}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">sprintf</span><span class="token punctuation">(</span>send_cmd<span class="token punctuation">,</span> <span class="token string">"$oc/devices/65697df3585c81787ad4da82_stm32/sys/commands/response/%s"</span><span class="token punctuation">,</span> request_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">MQTT_PublishData</span><span class="token punctuation">(</span>send_cmd<span class="token punctuation">,</span> mqtt_message<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"(命令)发布主题:%s\r\n"</span><span class="token punctuation">,</span> send_cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"(命令)发布数据:%s\r\n"</span><span class="token punctuation">,</span> mqtt_message<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>		
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="84__2293"></a>8.4 运行代码测试</h3> 
<p>先运行客户端的代码，登录MQTT服务器。</p> 
<p><img src="https://images2.imgbox.com/dc/0c/SSToSmUu_o.png" alt="image-20231202182720027"></p> 
<p>然后，在华为云IOT平台下发命令。 如果点击下发之后，右上角弹出了 <code>命令下发成功</code>，就表示我们客户端代码写OK了。</p> 
<p><img src="https://images2.imgbox.com/5a/cf/tIRnz3vt_o.png" alt="image-20231202182758488"></p> 
<p>我们看设备端收到的消息：</p> 
<p><img src="https://images2.imgbox.com/f1/4c/CrheWMGN_o.png" alt="image-20231202182913279"></p> 
<h2><a id="_2315"></a>九、总结</h2> 
<p>到此，我们的MQTT协议已经开发完成了。如果大家详细阅读了文章，并且跟着步骤操作了一次，相信你此刻对MQTT协议应该有所认识了。我是<code>DS小龙哥</code>，欢迎关注我，后续会有更多的技术文章、项目文章发布。</p> 
<p><img src="https://images2.imgbox.com/09/63/HC7YVuHi_o.png" alt="image-20231202183108654"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e782610f1f224da08bfbe8be67236ab7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python分布式机器学习全指南：框架、优化与未来趋势</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/713eea86d4b36574584ac443a95058b4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【多线程】线程安全的单例模式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>