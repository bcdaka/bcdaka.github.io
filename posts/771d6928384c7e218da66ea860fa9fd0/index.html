<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android network — 进程指定网络发包 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/771d6928384c7e218da66ea860fa9fd0/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android network — 进程指定网络发包">
  <meta property="og:description" content="Android network — 进程指定网络发包 0. 前言1. 进程绑定网络1.1 App进程绑定网络1.2 Native进程绑定网络 2. 源码原理分析2.1 申请网络requestNetwork2.2 绑定网络 BindProcessToNetwork 3. 总结 0. 前言 在android 中，一个app使用网络，需要在manifest 申请一下
&lt;uses-permission android:name=&#34;android.permission.INTERNET&#34;/&gt; 这种方式将使用default网络，比如WIFI 和 数据网络，android 同一个时间点，只能有一个default网络，default网络由Android 网络评分机制选择。
那有没有一种方式可以不使用默认网络呢，比如某一个App只想使用WiFi或者别的某一个网络，而不受默认网络变化的影响，答案是有的
1. 进程绑定网络 1.1 App进程绑定网络 对于App进程，ConnectivityService中提供了bindProcessToNetwork 接口进行绑定，使用说明如下
通过 requestNetwork 申请一个网络在NetworkCallback中的onAvailable的方法去调用bindProcessToNetwork 去bind这个网络上两步后APP的网络流量将会走这个network，或者说走这个network 指定的 网卡 补充说明一下 ：NetworkRequest 在CS对应一个NetworkRequestInfo ，一般情况下一个NetworkRequestInfo对应了一个client进程
使用示例：
NetworkRequest request = new NetworkRequest.Builder() .addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET) .addTransportType(NetworkCapabilities.TRANSPORT_CELLULAR) .build(); mNetworkCallback = new ConnectivityManager.NetworkCallback() { @Override public void onAvailable(final Network network) { runOnUiThread(new Runnable() { @Override public void run() { // requires android.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-22T19:11:33+08:00">
    <meta property="article:modified_time" content="2024-05-22T19:11:33+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android network — 进程指定网络发包</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Android network — 进程指定网络发包</h4> 
 <ul><li><a href="#0__1" rel="nofollow">0. 前言</a></li><li><a href="#1__12" rel="nofollow">1. 进程绑定网络</a></li><li><ul><li><a href="#11_App_13" rel="nofollow">1.1 App进程绑定网络</a></li><li><a href="#12_Native_45" rel="nofollow">1.2 Native进程绑定网络</a></li></ul> 
  </li><li><a href="#2__82" rel="nofollow">2. 源码原理分析</a></li><li><ul><li><a href="#21_requestNetwork_83" rel="nofollow">2.1 申请网络requestNetwork</a></li><li><a href="#22__BindProcessToNetwork_109" rel="nofollow">2.2 绑定网络 BindProcessToNetwork</a></li></ul> 
  </li><li><a href="#3__345" rel="nofollow">3. 总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="0__1"></a>0. 前言</h2> 
<p>  在android 中，一个app使用网络，需要在manifest 申请一下</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre> 
<p>  这种方式将使用default网络，比如WIFI 和 数据网络，android 同一个时间点，只能有一个default网络，default网络由Android 网络评分机制选择。</p> 
<p>  那有没有一种方式可以不使用默认网络呢，比如某一个App只想使用WiFi或者别的某一个网络，而不受默认网络变化的影响，答案是有的</p> 
<h2><a id="1__12"></a>1. 进程绑定网络</h2> 
<h3><a id="11_App_13"></a>1.1 App进程绑定网络</h3> 
<p>  对于App进程，ConnectivityService中提供了<strong>bindProcessToNetwork</strong> 接口进行绑定，使用说明如下</p> 
<ol><li>通过 <strong>requestNetwork</strong> 申请一个网络</li><li>在NetworkCallback中的onAvailable的方法去调用<strong>bindProcessToNetwork</strong> 去bind这个网络</li><li>上两步后APP的网络流量将会走这个network，或者说走这个network 指定的 网卡</li></ol> 
<p>  补充说明一下 ：NetworkRequest 在CS对应一个NetworkRequestInfo ，一般情况下一个NetworkRequestInfo对应了一个client进程</p> 
<p>使用示例：</p> 
<pre><code class="prism language-java">		<span class="token class-name">NetworkRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NetworkRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addCapability</span><span class="token punctuation">(</span><span class="token class-name">NetworkCapabilities</span><span class="token punctuation">.</span><span class="token constant">NET_CAPABILITY_INTERNET</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addTransportType</span><span class="token punctuation">(</span><span class="token class-name">NetworkCapabilities</span><span class="token punctuation">.</span><span class="token constant">TRANSPORT_CELLULAR</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mNetworkCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConnectivityManager<span class="token punctuation">.</span>NetworkCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAvailable</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Network</span> network<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">runOnUiThread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// requires android.permission.INTERNET</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mConnectivityManager<span class="token punctuation">.</span><span class="token function">bindProcessToNetwork</span><span class="token punctuation">(</span>network<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Network available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="12_Native_45"></a>1.2 Native进程绑定网络</h3> 
<p>  对于Native进程，我们可以模仿Framework的底层实现，具体可参考后面<strong>2. 原理实现</strong>部分</p> 
<ol><li><code>#include “NetdClient.h”</code> 此文件，此文件在netd的源码中，并 <font color="FireBrick"><strong>动态链接</strong></font> <code>libnetd_client.so</code> ，注意一定是动态链接</li><li>调用 <strong>setNetworkForProcess()</strong> 传入需要绑定网络的 <strong>netid</strong></li><li>强调一下，一定是动态链接，具体原因在后面原理分析中进行解释</li></ol> 
<p>  补充说明一下 ：同一网络，如某一个wifi或以太网，在断开重连后，netid是变化的，因此，实际使用中，要考虑到异常断开场景后，netid如何固定下来</p> 
<p>使用示例：</p> 
<pre><code class="prism language-cpp"><span class="token comment">// Android.bp</span>
cc_binary <span class="token punctuation">{<!-- --></span>
    name<span class="token operator">:</span> <span class="token string">"netd_client_example"</span><span class="token punctuation">,</span>
    srcs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"main.cpp"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    vendor<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    sdk_version<span class="token operator">:</span> <span class="token string">"current"</span><span class="token punctuation">,</span>
    defaults<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"netd_defaults"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    shared_libs<span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token string">"libnetd_client"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>


<span class="token comment">// main.cpp</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;NetdClient.h&gt;</span></span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
result <span class="token operator">=</span> <span class="token function">setNetworkForProcess</span><span class="token punctuation">(</span>netId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre> 
<h2><a id="2__82"></a>2. 源码原理分析</h2> 
<h3><a id="21_requestNetwork_83"></a>2.1 申请网络requestNetwork</h3> 
<pre><code class="prism language-java"><span class="token comment">//frameworks/base/core/java/android/net/ConnectivityManager.java</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">requestNetwork</span><span class="token punctuation">(</span><span class="token class-name">NetworkRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">NetworkCallback</span> networkCallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>NetworkRequest 可以设置 TransportType 比如 TRANSPORT_CELLULAR或者 TRANSPORT_WIFI</li><li>NetworkRequest 可以设置NetworkCapabilities比如NET_CAPABILITY_INTERNET或者其他类型</li></ul> 
<p>这个方法可能导致一个新的Network的出现，对应ConnectivityService中就是一个NetworkAgentInfo，这里可以简单的认为一个NetworkAgentInfo代表一个网络通道</p> 
<p><strong>NetworkCallback 里面有一些回调，说明一下</strong></p> 
<table><thead><tr><th>回调名称</th><th align="left">说明</th></tr></thead><tbody><tr><td>onAvailable(Network network)</td><td align="left">在框架连接并声明新网络可供使用时调用。</td></tr><tr><td>onBlockedStatusChanged(Network network, boolean blocked)</td><td align="left">在阻止或取消阻止对指定网络的访问时调用。</td></tr><tr><td>onCapabilitiesChanged(Network network, NetworkCapabilities networkCapabilities)</td><td align="left">当连接到该请求的框架改变功能但仍满足所述需求时调用该网络。</td></tr><tr><td>onLinkPropertiesChanged(Network network, LinkProperties linkProperties)</td><td align="left">当网络连接到此请求的框架更改 LinkProperties 。</td></tr><tr><td>onLosing(Network network, int maxMsToLive)</td><td align="left">在网络即将丢失时调用，通常是因为没有未完成留给它的请求。</td></tr><tr><td>onLost(Network network)</td><td align="left">当网络断开连接或以其他方式不再满足此请求时调用</td></tr><tr><td>onUnavailable()</td><td align="left">如果在调用中指定的超时时间内未找到网络，或者如果 无法满足请求的网络请求（无论是否超时 指定）</td></tr></tbody></table> 
<p><strong>常用回调发生情况：</strong><br> <img src="https://images2.imgbox.com/52/b6/NEwA4vzv_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22__BindProcessToNetwork_109"></a>2.2 绑定网络 BindProcessToNetwork</h3> 
<pre><code class="prism language-java"><span class="token comment">// packages/modules/Connectivity/framework/src/android/net/ConnectivityManager.java</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">bindProcessToNetwork</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Network</span> network<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Forcing callers to call through non-static function ensures ConnectivityManager</span>
        <span class="token comment">// instantiated.</span>
        <span class="token keyword">return</span> <span class="token function">setProcessDefaultNetwork</span><span class="token punctuation">(</span>network<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Deprecated</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">setProcessDefaultNetwork</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Network</span> network<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> netId <span class="token operator">=</span> <span class="token punctuation">(</span>network <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">NETID_UNSET</span> <span class="token operator">:</span> network<span class="token punctuation">.</span>netId<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isSameNetId <span class="token operator">=</span> <span class="token punctuation">(</span>netId <span class="token operator">==</span> <span class="token class-name">NetworkUtils</span><span class="token punctuation">.</span><span class="token function">getBoundNetworkForProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>netId <span class="token operator">!=</span> <span class="token constant">NETID_UNSET</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            netId <span class="token operator">=</span> network<span class="token punctuation">.</span><span class="token function">getNetIdForResolv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">NetworkUtils</span><span class="token punctuation">.</span><span class="token function">bindProcessToNetwork</span><span class="token punctuation">(</span>netId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>我们可以看到实际是调用到NetworkUtils.bindProcessToNetwork</p> 
<pre><code class="prism language-java">	<span class="token comment">// packages/modules/Connectivity/framework/src/android/net/NetworkUtils.java</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">bindProcessToNetwork</span><span class="token punctuation">(</span><span class="token keyword">int</span> netId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">bindProcessToNetworkHandle</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Network</span><span class="token punctuation">(</span>netId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNetworkHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">bindProcessToNetworkHandle</span><span class="token punctuation">(</span><span class="token keyword">long</span> netHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里是通过jni调用</p> 
<pre><code class="prism language-cpp">	<span class="token comment">//packages/modules/Connectivity/framework/jni/android_net_NetworkUtils.cpp</span>
	<span class="token keyword">static</span> <span class="token keyword">const</span> JNINativeMethod gNetworkUtilMethods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* name, signature, funcPtr */</span>
    <span class="token punctuation">{<!-- --></span> <span class="token string">"bindProcessToNetworkHandle"</span><span class="token punctuation">,</span> <span class="token string">"(J)Z"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> android_net_utils_bindProcessToNetworkHandle <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token keyword">static</span> jboolean <span class="token function">android_net_utils_bindProcessToNetworkHandle</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass clazz<span class="token punctuation">,</span>
        jlong netHandle<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>jboolean<span class="token punctuation">)</span> <span class="token operator">!</span><span class="token function">android_setprocnetwork</span><span class="token punctuation">(</span>netHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们继续跟踪android_setprocnetwork看看</p> 
<pre><code class="prism language-c"><span class="token comment">// frameworks/base/native/android/net.c</span>
<span class="token keyword">int</span> <span class="token function">android_setprocnetwork</span><span class="token punctuation">(</span><span class="token class-name">net_handle_t</span> network<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> netid<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getnetidfromhandle</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> <span class="token operator">&amp;</span>netid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        errno <span class="token operator">=</span> EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> rval <span class="token operator">=</span> <span class="token function">setNetworkForProcess</span><span class="token punctuation">(</span>netid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// libnetd_client.so</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rval <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        errno <span class="token operator">=</span> <span class="token operator">-</span>rval<span class="token punctuation">;</span>
        rval <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> rval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里我们可以看到bindProcessToNetwork ，这个方法通过jni的方式调用了libnetd_client.so 的setNetworkForProcess</p> 
<pre><code class="prism language-cpp"><span class="token comment">//system/netd/client/NetdClient.cpp</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">int</span> <span class="token function">setNetworkForProcess</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> netId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">setNetworkForTarget</span><span class="token punctuation">(</span>netId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>netIdForProcess<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">setNetworkForTarget</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> netId<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>atomic_uint<span class="token operator">*</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">unsigned</span> requestedNetId <span class="token operator">=</span> netId<span class="token punctuation">;</span>
    netId <span class="token operator">&amp;=</span> <span class="token operator">~</span>NETID_USE_LOCAL_NAMESERVERS<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>netId <span class="token operator">==</span> NETID_UNSET<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>target <span class="token operator">=</span> netId<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Verify that we are allowed to use |netId|, by creating a socket and trying to have it marked</span>
    <span class="token comment">// with the netId. Call libcSocket() directly; else the socket creation (via netdClientSocket())</span>
    <span class="token comment">// might itself cause another check with the fwmark server, which would be wasteful.</span>

    <span class="token keyword">const</span> <span class="token keyword">auto</span> socketFunc <span class="token operator">=</span> libcSocket <span class="token operator">?</span> libcSocket <span class="token operator">:</span> socket<span class="token punctuation">;</span>
    <span class="token keyword">int</span> socketFd <span class="token operator">=</span> <span class="token function">socketFunc</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> SOCK_DGRAM <span class="token operator">|</span> SOCK_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>socketFd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token function">setNetworkForSocket</span><span class="token punctuation">(</span>netId<span class="token punctuation">,</span> socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置mark标记</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>target <span class="token operator">=</span> requestedNetId<span class="token punctuation">;</span> <span class="token comment">//将netIdForProcess设置为我们选择的netid</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里我们看到setNetworkForProcess 最终将netIdForProcess设置为了我们选择的netid，那为什么调用了setNetworkForProcess ,之后app不管采用何种方式的访问网络,比如okhttp 或者HttpURLConnection的原生方式都能路由到特定的网卡上呢？让我们来看下</p> 
<p>其实不管采用方式，本质都使用了socket的，最终都会调用到sys/socket.h的socket(c库)</p> 
<pre><code class="prism language-cpp"><span class="token comment">//bionic/libc/include/sys/socket.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span>    <span class="token expression">代码使用</span></span>

<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">FDTRACK_CREATE</span><span class="token punctuation">(</span>__netdClientDispatch<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> type<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>__netdClientDispatch.socket 最初会被赋值为__socket(int, int, int);</p> 
<pre><code class="prism language-cpp"><span class="token comment">// bionic/libc/bionic/NetdClientDispatch.cpp</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> __socketcall <span class="token keyword">int</span> <span class="token function">__socket</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>在__libc_preinit_impl 的时候会通过<font color="FireBrick"><strong>dlsym</strong></font>的方式调用<font color="FireBrick"><strong>/system/lib/libnetd_client.so</strong></font>中的netdClientSocket(<font color="FireBrick"><strong>前面说的要动态链接的原因</strong></font>)</p> 
<pre><code class="prism language-cpp"><span class="token comment">// bionic/libc/bionic/libc_init_dynamic.cpp</span>
<span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>noinline<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__libc_preinit_impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token function">netdClientInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token comment">// bionic/libc/bionic/NetdClient.cpp</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> symbol<span class="token punctuation">,</span> FunctionType<span class="token operator">*</span> function<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>InitFunctionType<span class="token punctuation">)</span><span class="token punctuation">(</span>FunctionType<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    InitFunctionType initFunction <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>InitFunctionType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// dlsym 的方式</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initFunction <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">initFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">netdClientInitImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token string">"libnetd_client.so"</span><span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// dlopen 打开 libnetd_client.so</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If the library is not available, it's not an error. We'll just use</span>
        <span class="token comment">// default implementations of functions that it would've overridden.</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitAccept4"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>accept4<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitConnect"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>connect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitSendmmsg"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>sendmmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitSendmsg"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>sendmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitSendto"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>sendto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitSocket"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过dlsym 动态链接找到netdClientInitSocket</span>

    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitNetIdForResolv"</span><span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>netIdForResolv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitDnsOpenProxy"</span><span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>dnsOpenProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> pthread_once_t netdClientInitOnce <span class="token operator">=</span> PTHREAD_ONCE_INIT<span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> __LIBC_HIDDEN__ <span class="token keyword">void</span> <span class="token function">netdClientInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_once</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netdClientInitOnce<span class="token punctuation">,</span> netdClientInitImpl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">async_safe_format_log</span><span class="token punctuation">(</span>ANDROID_LOG_ERROR<span class="token punctuation">,</span> <span class="token string">"netdClient"</span><span class="token punctuation">,</span> <span class="token string">"Failed to initialize libnetd_client"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>netdClientInitSocket 执行后会使得<font color="FireBrick"><strong>__netdClientDispatch.socket 被赋值为netdClientSocket 而libcSocket赋值为__scoket(系统调用)</strong></font></p> 
<pre><code class="prism language-cpp"><span class="token comment">// system/netd/client/NetdClient.cpp</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">HOOK_ON_FUNC</span><span class="token expression"><span class="token punctuation">(</span>remoteFunc<span class="token punctuation">,</span> nativeFunc<span class="token punctuation">,</span> localFunc<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>                                                </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>remoteFunc<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span>remoteFunc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>            </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token punctuation">(</span>nativeFunc<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>remoteFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>               </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token operator">*</span><span class="token punctuation">(</span>remoteFunc<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>localFunc<span class="token punctuation">)</span><span class="token punctuation">;</span>                </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span>                                               </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">void</span> <span class="token function">netdClientInitSocket</span><span class="token punctuation">(</span>SocketFunctionType<span class="token operator">*</span> function<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">HOOK_ON_FUNC</span><span class="token punctuation">(</span>function<span class="token punctuation">,</span> libcSocket<span class="token punctuation">,</span> netdClientSocket<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Android app 和 native 创建的socket最终会调用到netClientSocket</p> 
<pre><code class="prism language-cpp"><span class="token comment">// system/netd/client/NetdClient.cpp</span>
<span class="token keyword">int</span> <span class="token function">netdClientSocket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Block creating AF_INET/AF_INET6 socket if networking is not allowed.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FwmarkCommand</span><span class="token double-colon punctuation">::</span><span class="token function">isSupportedFamily</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>allowNetworkingForProcess<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        errno <span class="token operator">=</span> EPERM<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     <span class="token comment">// 系统调用得到一个标准的socket</span>
    <span class="token keyword">int</span> socketFd <span class="token operator">=</span> <span class="token function">libcSocket</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> type<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>socketFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 将netdid 设置为我们之前保存的netIdForProcess</span>
    <span class="token keyword">unsigned</span> netId <span class="token operator">=</span> netIdForProcess <span class="token operator">&amp;</span> <span class="token operator">~</span>NETID_USE_LOCAL_NAMESERVERS<span class="token punctuation">;</span>
    <span class="token comment">// **将socket 打上 netId的mark**</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>netId <span class="token operator">!=</span> NETID_UNSET <span class="token operator">&amp;&amp;</span> <span class="token class-name">FwmarkClient</span><span class="token double-colon punctuation">::</span><span class="token function">shouldSetFwmark</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token function">setNetworkForSocket</span><span class="token punctuation">(</span>netId<span class="token punctuation">,</span> socketFd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">closeFdAndSetErrno</span><span class="token punctuation">(</span>socketFd<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> socketFd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在netdClientSocket创建的socket 会给socket打上netIdForProcess数值的mark，这个netIdForProcess其实就是bindProcessToNetwork 设置的netId，这样导致创建的socket都含有此mark，自然路由到netId对应的网卡了，hook的思想的体现!!</p> 
<p>这个mark将会匹配到android的策略路由中，走到network对应网卡的路由表中.</p> 
<p>例如network 的netId =101</p> 
<pre><code class="prism language-powershell"><span class="token comment">#ip rule 查看策略路由</span>

0:      <span class="token keyword">from</span> all lookup local  
9000:   <span class="token keyword">from</span> all lookup main  
10000:  <span class="token keyword">from</span> all fwmark 0xc0000/0xd0000 lookup legacy_system  
10500:  <span class="token keyword">from</span> all oif dummy0 uidrange 0-0 lookup dummy0  
10500:  <span class="token keyword">from</span> all oif rmnet_data1 uidrange 0-0 lookup rmnet_data1  
10500:  <span class="token keyword">from</span> all oif rmnet_data0 uidrange 0-0 lookup rmnet_data0  
10500:  <span class="token keyword">from</span> all oif p2p0 uidrange 0-0 lookup local_network  
13000:  <span class="token keyword">from</span> all fwmark 0x10063/0x1ffff lookup local_network  
13000:  <span class="token keyword">from</span> all fwmark 0x10066/0x1ffff lookup rmnet_data1  
13000:  <span class="token keyword">from</span> all fwmark 0x10065/0x1ffff lookup rmnet_data0 
</code></pre> 
<p>注意这个 0x10065 ，65就是101的16进制，就是说设置netid 101 mark的数据包会走到这条策略路由，进而通过rmnet_data网卡发送数据。</p> 
<h2><a id="3__345"></a>3. 总结</h2> 
<p>再次感叹android的源码真优雅，设计的如此巧妙，修改了linux的c库，通过hook的方式,在app 创建的socket自动打上mark，结合策略路由，实现了数据包的指定发送!!</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/64e1fb3341583c70dbb86344aca1de9c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Oracle JSON 函数详解与实战</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c321ab42c534101765deb71996dc7a49/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Stable Diffusion 实操教程：轻松掌握图像生成技术</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>