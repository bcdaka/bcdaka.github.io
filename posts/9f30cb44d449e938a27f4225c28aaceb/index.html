<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Hive/Spark窗口函数 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/9f30cb44d449e938a27f4225c28aaceb/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Hive/Spark窗口函数">
  <meta property="og:description" content="窗口函数 hive文档链接
spark文档链接
1. OVER支持的函数 自然序编号
Syntax: ROW_NUMBER按等级编号
Syntax: RANK | DENSE_RANK | PERCENT_RANK分组内分桶，并返回对应桶的序号
Syntax: NTILE(n)Analytic Functions（分析函数）
Syntax: CUME_DIST | LAG | LEAD | NTH_VALUE | FIRST_VALUE | LAST_VALUEAggregate Functions（聚合函数）
Syntax: MAX | MIN | COUNT | SUM | AVG | … 1.1. 准备工作 创建测试表并插入测试数据
CREATE TABLE employees (name STRING, dept STRING, salary INT, age INT); INSERT INTO employees VALUES (&#34;Lisa&#34;, &#34;Sales&#34;, 10000, 35) ,(&#34;Evan&#34;, &#34;Sales&#34;, 32000, 38) ,(&#34;Fred&#34;, &#34;">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-09T21:07:08+08:00">
    <meta property="article:modified_time" content="2024-07-09T21:07:08+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Hive/Spark窗口函数</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>窗口函数</h2> 
<p><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+WindowingAndAnalytics" rel="nofollow">hive文档链接</a><br> <a href="https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-window.html" rel="nofollow">spark文档链接</a></p> 
<h3><a id="1_OVER_5"></a>1. OVER支持的函数</h3> 
<ul><li>自然序编号<br> Syntax: <code>ROW_NUMBER</code></li><li>按等级编号<br> Syntax: <code>RANK</code> | <code>DENSE_RANK</code> | <code>PERCENT_RANK</code></li><li>分组内分桶，并返回对应桶的序号<br> Syntax: <code>NTILE(n)</code></li><li>Analytic Functions（分析函数）<br> Syntax: <code>CUME_DIST</code> | <code>LAG</code> | <code>LEAD</code> | <code>NTH_VALUE</code> | <code>FIRST_VALUE</code> | <code>LAST_VALUE</code></li><li>Aggregate Functions（聚合函数）<br> Syntax: <code>MAX</code> | <code>MIN</code> | <code>COUNT</code> | <code>SUM</code> | <code>AVG</code> | …</li></ul> 
<h4><a id="11__18"></a>1.1. 准备工作</h4> 
<p>创建测试表并插入测试数据</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> employees <span class="token punctuation">(</span>name STRING<span class="token punctuation">,</span> dept STRING<span class="token punctuation">,</span> salary <span class="token keyword">INT</span><span class="token punctuation">,</span> age <span class="token keyword">INT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> employees <span class="token keyword">VALUES</span> 
<span class="token punctuation">(</span><span class="token string">"Lisa"</span><span class="token punctuation">,</span> <span class="token string">"Sales"</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"Evan"</span><span class="token punctuation">,</span> <span class="token string">"Sales"</span><span class="token punctuation">,</span> <span class="token number">32000</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"Fred"</span><span class="token punctuation">,</span> <span class="token string">"Engineering"</span><span class="token punctuation">,</span> <span class="token number">21000</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"Alex"</span><span class="token punctuation">,</span> <span class="token string">"Sales"</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"Tom"</span><span class="token punctuation">,</span> <span class="token string">"Engineering"</span><span class="token punctuation">,</span> <span class="token number">23000</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"Jane"</span><span class="token punctuation">,</span> <span class="token string">"Marketing"</span><span class="token punctuation">,</span> <span class="token number">29000</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"Jeff"</span><span class="token punctuation">,</span> <span class="token string">"Marketing"</span><span class="token punctuation">,</span> <span class="token number">35000</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"Paul"</span><span class="token punctuation">,</span> <span class="token string">"Engineering"</span><span class="token punctuation">,</span> <span class="token number">29000</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span>
<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token string">"Chloe"</span><span class="token punctuation">,</span> <span class="token string">"Engineering"</span><span class="token punctuation">,</span> <span class="token number">23000</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="12_row_number_37"></a>1.2. row_number()</h4> 
<p><code>row_number() over()</code> row_number可能是窗口函数中使用最频繁的函数，作用是在分组内按自然序进行编号，结果值为：1 2 3 4 5</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> rn  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">3</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">4</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">3</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
</code></pre> 
<h4><a id="13_rank_58"></a>1.3. rank函数</h4> 
<p>rank有等级的含义，函数作用是在分组内按照order by的结果得到有等级编号。<br> <code>rank() over ()</code> 并列有间隔，结果如：1 2 2 4 5<br> <code>dense_rank() over()</code> dense有密集的含义，并列无间隔，结果如：1 2 2 3 4<br> <code>percent_rank() over()</code> 百分比的rank，含义是(当前行-1)/(当前组总行数-1)，当前行从1开始</p> 
<p>注意，如果order by的结果相同，则rank得到的结果都相同，在这里的语义是排序结果相同，因此等级编号也相同。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token comment">-- 执行结果中，engineering中salary相同的编号相同，paul的值为4</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> rn  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">4</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">3</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>

<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token comment">-- 执行结果中，engineering中salary相同的编号相同，paul的值为3</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> rn  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">3</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">3</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>

<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>percent_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token comment">-- rn的结果是每行在当前分组中的百分比，注意order by中相同值结果相同</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span>         rn          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">0.0</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">1.0</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">0.0</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">0.3333333333333333</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">0.3333333333333333</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">1.0</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">0.0</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">0.5</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">1.0</span>                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------------+</span>

<span class="token comment">-- order by结果相同的情况，order by dept</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> dept<span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>dense_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> dept<span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token comment">-- 二者结果相同</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> rn  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>

<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>percent_rank<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> dept<span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span>  rn  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+------+</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">0.0</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">0.0</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">0.0</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">0.0</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">0.0</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">0.0</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">0.0</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">0.0</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">0.0</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+------+</span>
</code></pre> 
<h4><a id="14_ntilen_150"></a>1.4. ntile(n)</h4> 
<p><code>ntile(n) over</code> tile有瓷砖、瓦片的含义，作用是在分组内对数据进行分桶，然后返回桶的序号。</p> 
<p>按照order by结果将数据平均的放入到分好的桶中，如果数据无法按照桶个数均分，则将多余的数据放在第一个桶内。</p> 
<p>使用场景：例如获取每个部门薪资前三分之一的员工数据，则按照salary降序排序，然后分成3个桶，最后取第一个桶中的数据。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>NTILE<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token comment">-- ntile(2)表示分成2桶，</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> rn  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>NTILE<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token comment">-- 分成3桶</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> rn  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">3</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">2</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">3</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
</code></pre> 
<h4><a id="15_cume_dist_191"></a>1.5. cume_dist()</h4> 
<p>cume表示累计，dist表示距离<br> 用于求累计分布，即分组中按照order by结果的分位数</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>cume_dist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token comment">-- enginnering分组中，tom和chloe中salary相同，二者的分位数结果相同</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> cume_dist_window_0  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">0.5</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">1.0</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">0.25</span>                <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">0.75</span>                <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">0.75</span>                <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">1.0</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">0.3333333333333333</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">0.6666666666666666</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">1.0</span>                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------------+</span>

<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span>cume_dist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> age<span class="token punctuation">)</span> <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token comment">-- 按照age排序，tom和chloe中age不同，因此分位数不同</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> cume_dist_window_0  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">0.5</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">1.0</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">0.25</span>                <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">0.5</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">0.75</span>                <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">1.0</span>                 <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">0.3333333333333333</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">0.6666666666666666</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">1.0</span>                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------------+</span>
</code></pre> 
<h4><a id="16_laglead_230"></a>1.6. lag和lead</h4> 
<p>lag 表示落后的含义，在使用场景中是小于的含义。<br> lead 表示领先的含义，在使用场景中是大于的含义。</p> 
<p>可以实现不自连接的前提下，按照order by结果得到当前行指定列 前/后移动num行 的列值。</p> 
<p>函数参数<br> <code>LAG/LEAD(col,num,default_value)</code>：col表示指定的列名；num表示指定的位移行数，默认为1；default_value表示末尾或开头返回的值，默认值null。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    LAG<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> lag<span class="token punctuation">,</span>
    LEAD<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> lead
    <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
<span class="token comment">-- 从结果看，按照order by排序结果，lag取的值是当前行前1行的值，lead取的值是当前行后1行的值，对于第1行或者最后1行，取值默认为null</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span>  lag   <span class="token operator">|</span>  lead  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> <span class="token number">35000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span> <span class="token number">32000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    LAG<span class="token punctuation">(</span>salary<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> lag<span class="token punctuation">,</span>
    LEAD<span class="token punctuation">(</span>salary<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> lead
    <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span>  lag   <span class="token operator">|</span>  lead  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span> <span class="token number">35000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span> <span class="token number">32000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span> <span class="token number">0</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>

<span class="token comment">-- 排序结果和取值列不同的情况</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    LAG<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">)</span> <span class="token keyword">AS</span> lag<span class="token punctuation">,</span>
    LEAD<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">)</span> <span class="token keyword">AS</span> lead
    <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span>  lag   <span class="token operator">|</span>  lead  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> <span class="token number">35000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span> <span class="token number">32000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
</code></pre> 
<h4><a id="17_first_valuelast_value_298"></a>1.7. first_value和last_value</h4> 
<p>在分组中按照order by的结果，获取指定列的第一个或最后一个值。<br> 注意，默认情况下last_value取的是第一行截止到当前行的最后一个值(当前行的值)，并不是整个分区中排序后的最后一个值。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    first_value<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">first</span><span class="token punctuation">,</span>
    last_value<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> age<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">last</span>
    <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
<span class="token comment">-- 注意last的结果</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> <span class="token keyword">first</span>  <span class="token operator">|</span>  <span class="token keyword">last</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">35000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span> <span class="token number">32000</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>

<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    first_value<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">first</span><span class="token punctuation">,</span>
    last_value<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">last</span>
    <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> <span class="token keyword">first</span>  <span class="token operator">|</span>  <span class="token keyword">last</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">35000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span> <span class="token number">32000</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
</code></pre> 
<h4><a id="18_nth_value_342"></a>1.8. nth_value</h4> 
<p>nth表示第几个的含义</p> 
<p>作用，在分组中返回order by结果中指定列的第N行值。</p> 
<p>注意，hive中无此函数</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>nth_value<span class="token punctuation">(</span>salary<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> nth <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="2_OVER_354"></a>2. OVER从句</h3> 
<ul><li>在hive中<code>over</code>语句支持仅有<code>partition by</code>语句，没有<code>order by</code>语句。当没有<code>order by</code>时，<code>order by</code>默认使用<code>partition by</code>指定的字段序列，</li><li>在spark中如果未指定<code>order by</code>，将会报错<code>Error in query: Window function row_number() requires window to be ordered, please add ORDER BY clause</code></li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span> row_number<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> name<span class="token punctuation">)</span> <span class="token keyword">as</span> rn <span class="token keyword">from</span> employees<span class="token punctuation">;</span>

<span class="token comment">-- 执行结果如下，从结果中得知按照name的字典序排序</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> rn  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">1</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-----+</span>
</code></pre> 
<h4><a id="21_window_specification_378"></a>2.1. window specification</h4> 
<p>在OVER语句中可以带有一个<strong>window specification</strong>，支持以下格式：</p> 
<pre><code class="prism language-sql">格式：
<span class="token punctuation">(</span><span class="token keyword">ROWS</span> <span class="token operator">|</span> RANGE<span class="token punctuation">)</span> <span class="token operator">BETWEEN</span> xxx <span class="token operator">AND</span> xxx
具体支持以下<span class="token number">3</span>种格式
<span class="token punctuation">(</span><span class="token keyword">ROWS</span> <span class="token operator">|</span> RANGE<span class="token punctuation">)</span> <span class="token operator">BETWEEN</span> <span class="token punctuation">(</span><span class="token keyword">UNBOUNDED</span> <span class="token operator">|</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token keyword">PRECEDING</span> <span class="token operator">|</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token keyword">UNBOUNDED</span> <span class="token operator">|</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">FOLLOWING</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">ROWS</span> <span class="token operator">|</span> RANGE<span class="token punctuation">)</span> <span class="token operator">BETWEEN</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span> <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token keyword">UNBOUNDED</span> <span class="token operator">|</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">FOLLOWING</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">ROWS</span> <span class="token operator">|</span> RANGE<span class="token punctuation">)</span> <span class="token operator">BETWEEN</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token keyword">FOLLOWING</span> <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token keyword">UNBOUNDED</span> <span class="token operator">|</span> <span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">FOLLOWING</span>
</code></pre> 
<ul><li><code>ROWS</code> 表示在同分区中，按照order by结果按行进行逐行处理</li><li><code>RANGE</code> 表示在同分区中按照order by结果的范围处理，如1,2,3,3,4,4,5排序中，3,3和4,4的排序结果相同，则3,3和4,4将分别当成整体处理，每行对应开窗函数的结果相同。</li><li><code>UNBOUNDED PRECEDING</code> 表示未绑定当前行之前的行。整个分区中，从第一行开始处理</li><li><code>num PRECEDING</code> 表示限制当前行的前num行。如在sum时，每行sum的结果是从前num行到当前行的累加值</li><li><code>CURRENT ROW</code> 表示处理过程中的当前行（处理数据过程中的游标指针）</li><li><code>UNBOUNDED FOLLOWING</code> 表示未绑定当前行之后的行。整个分区，处理到最后一行</li><li><code>num FOLLOWING</code> 表示限制当前行的后num行。如在sum时，每行值的sum的结果将处理到后num行。</li></ul> 
<p>注意：在hive中函数不支持使用window specification<br> <code>rank,</code>、<code>dense_rank</code>、<code>percent_rank()</code><br> <code>cume_dist()</code>、<code>ntile</code><br> <code>lead</code>、<code>lag</code></p> 
<h5><a id="211_order_by_405"></a>2.1.1. 显式order by下的默认值</h5> 
<p><strong>当指定了order by语句而未指定window specification语句时，默认的window specification语句是<code>RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code></strong>。</p> 
<p>即按照order by结果的range处理，并且从分区中的第一行处理到当前行。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_salary <span class="token keyword">from</span> employees<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary range <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum_salary <span class="token keyword">from</span> employees<span class="token punctuation">;</span>

<span class="token comment">-- 二者的执行结果相同</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> sum_salary  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">29000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">64000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">21000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">67000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">67000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">96000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">10000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">40000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">72000</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
</code></pre> 
<p>注意：Engineering部门的tom和chloe员工的sum_salary值相同。这是因为在Engineering分区下，二者order by salary结果相同。在range策略下，tom和chloe将当成整体处理，即46000，因此tom和chloe的累计值都为67000（21000+460000），而不是44000和67000。</p> 
<p>在SQL中显示指定如下语句，<strong>实现分区中的按行累加</strong>效果，即<br> <code>ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code></p> 
<p>Engineering部门的tom和chloe员工的sum_salary结果将分别为44000和67000。</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary <span class="token keyword">rows</span> <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">current</span> <span class="token keyword">row</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum_salary <span class="token keyword">from</span> employees<span class="token punctuation">;</span>

<span class="token comment">-- 结果如下</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> sum_salary  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">29000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">64000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">21000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">44000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">67000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">96000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">10000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">40000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">72000</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
</code></pre> 
<p>在SQL中显示指定如下语句，<strong>实现相同分组内进行全部值求和</strong>效果。<br> <code>RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary range <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">unbounded</span> <span class="token keyword">following</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sum_salary <span class="token keyword">from</span> employees<span class="token punctuation">;</span>

<span class="token comment">-- 结果如下</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> sum_salary  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">64000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">64000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">96000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">96000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">96000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">96000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">72000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">72000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">72000</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
</code></pre> 
<p>结论：</p> 
<ul><li>情形一：在partition by和order by同时存在的情况下，对于MAX | MIN | COUNT | SUM | AVG 等函数<br> 如果想要对相同分组中的数整体进行计算，则要显示指定<code>RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code>；</li><li>情形二：如果按在分组中实现按行处理，则要显示指定<code>ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code>；</li><li>情形三：默认情况下（即未显示指定window specification时）对于order by列相同的值处理结果相同。</li></ul> 
<h5><a id="212_order_by_485"></a>2.1.2. 无order by下的默认值</h5> 
<p><strong>当over语句中order by和window specification都缺失时，window specification的默认值是<code>ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code></strong></p> 
<p>结论</p> 
<ul><li>对MAX | MIN | COUNT | SUM | AVG 等函数，在order by缺失或order by和partition by相同时，效果同上述情形一</li></ul> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_salary <span class="token keyword">from</span> employees<span class="token punctuation">;</span>

<span class="token comment">-- 结果如下</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> sum_salary  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">96000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">96000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">96000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">96000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">64000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">64000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">72000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">72000</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">72000</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+-------------+</span>
</code></pre> 
<p>结果中，对于相同dept中不同员工，效果并不是按行并逐行处理，而是对相同dept下的员工进行了统一处理。即UNBOUNDED FOLLOWING表示不跟随当前处理的行，直接对中整个分区中进行计算。</p> 
<p>疑问：<code>ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code>中rows的作用是什么了？</p> 
<h3><a id="3_last_value_515"></a>3. last_value函数的注意事项</h3> 
<p>前面在提到last_value时，特意强调了该函数的结果并不是分区中的最后一个值，结合上述介绍的window specification再来看下该函数的结果值。</p> 
<pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span>
    first_value<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">first</span><span class="token punctuation">,</span>
    last_value<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span><span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> dept <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> salary<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">last</span>
    <span class="token keyword">FROM</span> employees<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> <span class="token keyword">first</span>  <span class="token operator">|</span>  <span class="token keyword">last</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span> <span class="token number">35000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token number">23000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">21000</span>  <span class="token operator">|</span> <span class="token number">29000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span> <span class="token number">30000</span>  <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">10000</span>  <span class="token operator">|</span> <span class="token number">32000</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+--------+--------+</span>
</code></pre> 
<p>结果中，对于每一行的last_value的结果都是当前值，并不分区中按salary升序的最后一个值。造成这个结果的原因正是由于默认的window specification导致的（<code>ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW</code>）。<br> 如想要实现得到整个分区中按salary升序的最大值，则需要显示设置window specification为<code>RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING</code></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token punctuation">,</span>first_value<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary<span class="token punctuation">)</span> <span class="token keyword">as</span> first_salary
<span class="token punctuation">,</span>last_value<span class="token punctuation">(</span>salary<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> dept <span class="token keyword">order</span> <span class="token keyword">by</span> salary range <span class="token operator">between</span> <span class="token keyword">unbounded</span> <span class="token keyword">preceding</span> <span class="token operator">and</span> <span class="token keyword">unbounded</span> <span class="token keyword">following</span><span class="token punctuation">)</span> <span class="token keyword">as</span> last_salary <span class="token keyword">from</span> employees<span class="token punctuation">;</span>

<span class="token comment">-- 结果如下</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------+--------------+</span>
<span class="token operator">|</span> employees<span class="token punctuation">.</span>name  <span class="token operator">|</span> employees<span class="token punctuation">.</span>dept  <span class="token operator">|</span> employees<span class="token punctuation">.</span>salary  <span class="token operator">|</span> employees<span class="token punctuation">.</span>age  <span class="token operator">|</span> first_salary  <span class="token operator">|</span> last_salary  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------+--------------+</span>
<span class="token operator">|</span> Jane            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">29000</span>         <span class="token operator">|</span> <span class="token number">35000</span>        <span class="token operator">|</span>
<span class="token operator">|</span> Jeff            <span class="token operator">|</span> Marketing       <span class="token operator">|</span> <span class="token number">35000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">29000</span>         <span class="token operator">|</span> <span class="token number">35000</span>        <span class="token operator">|</span>
<span class="token operator">|</span> Fred            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">21000</span>             <span class="token operator">|</span> <span class="token number">28</span>             <span class="token operator">|</span> <span class="token number">21000</span>         <span class="token operator">|</span> <span class="token number">29000</span>        <span class="token operator">|</span>
<span class="token operator">|</span> Tom             <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">21000</span>         <span class="token operator">|</span> <span class="token number">29000</span>        <span class="token operator">|</span>
<span class="token operator">|</span> Chloe           <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">23000</span>             <span class="token operator">|</span> <span class="token number">25</span>             <span class="token operator">|</span> <span class="token number">21000</span>         <span class="token operator">|</span> <span class="token number">29000</span>        <span class="token operator">|</span>
<span class="token operator">|</span> Paul            <span class="token operator">|</span> Engineering     <span class="token operator">|</span> <span class="token number">29000</span>             <span class="token operator">|</span> <span class="token number">23</span>             <span class="token operator">|</span> <span class="token number">21000</span>         <span class="token operator">|</span> <span class="token number">29000</span>        <span class="token operator">|</span>
<span class="token operator">|</span> Lisa            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">10000</span>             <span class="token operator">|</span> <span class="token number">35</span>             <span class="token operator">|</span> <span class="token number">10000</span>         <span class="token operator">|</span> <span class="token number">32000</span>        <span class="token operator">|</span>
<span class="token operator">|</span> Alex            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">30000</span>             <span class="token operator">|</span> <span class="token number">33</span>             <span class="token operator">|</span> <span class="token number">10000</span>         <span class="token operator">|</span> <span class="token number">32000</span>        <span class="token operator">|</span>
<span class="token operator">|</span> Evan            <span class="token operator">|</span> Sales           <span class="token operator">|</span> <span class="token number">32000</span>             <span class="token operator">|</span> <span class="token number">38</span>             <span class="token operator">|</span> <span class="token number">10000</span>         <span class="token operator">|</span> <span class="token number">32000</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-------------------+----------------+---------------+--------------+</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0b9883810e5ab95277fa3611f84bc945/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Kafka 典型问题与排查以及相关优化</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/af3dd5fb80402590d6fb6018999e31be/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[Spring] SpringBoot基本配置与快速上手</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>