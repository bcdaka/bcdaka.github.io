<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Flink学习之Flink SQL - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/147d70d7a5d48a7c99631745fea488ea/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Flink学习之Flink SQL">
  <meta property="og:description" content="Flink SQL 1、SQL客户端 1.1 基本使用 启动yarn-session
yarn-session.sh -d 启动Flink SQL客户端
sql-client.sh --退出客户端 exit; 测试
重启SQL客户端之后，需要重新建表
-- 构建Kafka Source -- 无界流 drop table if exists students_kafka_source; CREATE TABLE if not exists students_kafka_source ( `id` BIGINT, `name` STRING, `age` INT, `gender` STRING, `clazz` STRING ) WITH ( &#39;connector&#39; = &#39;kafka&#39;, &#39;topic&#39; = &#39;students1000&#39;, &#39;properties.bootstrap.servers&#39; = &#39;master:9092&#39;, &#39;properties.group.id&#39; = &#39;grp1&#39;, &#39;scan.startup.mode&#39; = &#39;earliest-offset&#39;, &#39;format&#39; = &#39;csv&#39;, -- 以 ，分隔的数据 -- 是否忽略脏数据 &#39;csv.ignore-parse-errors&#39; = &#39;true&#39; ); -- 执行查询，基于KafkaSource是无界流，所以查询时连续变化的 select * from students_kafka_source; select clazz,count(*) as cnt from students_kafka_source group by clazz; -- 向Kafka生产数据 kafka-console-producer.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-04T20:46:31+08:00">
    <meta property="article:modified_time" content="2024-08-04T20:46:31+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Flink学习之Flink SQL</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Flink_SQL_0"></a>Flink SQL</h2> 
<h4><a id="1SQL_2"></a>1、SQL客户端</h4> 
<h5><a id="11__4"></a>1.1 基本使用</h5> 
<ul><li> <p>启动yarn-session</p> <pre><code class="prism language-shell">yarn-session.sh <span class="token parameter variable">-d</span>
</code></pre> </li><li> <p>启动Flink SQL客户端</p> <pre><code class="prism language-shell">sql-client.sh

--退出客户端
<span class="token builtin class-name">exit</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>测试</p> 
  <blockquote> 
   <p>重启SQL客户端之后，需要重新建表</p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token comment">-- 构建Kafka Source</span>
<span class="token comment">-- 无界流</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> students_kafka_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> students_kafka_source <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'students1000'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'master:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'grp1'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'csv'</span><span class="token punctuation">,</span> <span class="token comment">-- 以 ，分隔的数据</span>
  <span class="token comment">-- 是否忽略脏数据</span>
  <span class="token string">'csv.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 执行查询，基于KafkaSource是无界流，所以查询时连续变化的</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> students_kafka_source<span class="token punctuation">;</span>
<span class="token keyword">select</span> clazz<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> students_kafka_source <span class="token keyword">group</span> <span class="token keyword">by</span> clazz<span class="token punctuation">;</span>

<span class="token comment">-- 向Kafka生产数据</span>
kafka<span class="token operator">-</span>console<span class="token operator">-</span>producer<span class="token punctuation">.</span>sh <span class="token comment">--broker-list master:9092 --topic students1000</span>
</code></pre> </li></ul> 
<h5><a id="12__54"></a>1.2 三种显示模式</h5> 
<ul><li> <p><strong>表格模式</strong></p> 
  <blockquote> 
   <p>SQL客户端默认的结果显示模式</p> 
   <p>在内存中实体化结果，并将结果用规则的分页表格可视化展示出来</p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token keyword">SET</span> <span class="token string">'sql-client.execution.result-mode'</span> <span class="token operator">=</span> <span class="token string">'table'</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>变更日志模式</strong></p> 
  <blockquote> 
   <p>不会实体化和可视化结果，而是由插入（<code>+</code>）和撤销（<code>-</code>）组成的持续查询产生结果流</p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token keyword">SET</span> <span class="token string">'sql-client.execution.result-mode'</span> <span class="token operator">=</span> <span class="token string">'changelog'</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>Tableau模式</strong></p> 
  <blockquote> 
   <p>更接近传统的数据库，会将执行的结果（类似变更日志模式，由插入（<code>+</code>）和撤销（<code>-</code>）组成的持续查询产生结果流）以制表的形式直接打在屏幕之上</p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token keyword">SET</span> <span class="token string">'sql-client.execution.result-mode'</span> <span class="token operator">=</span> <span class="token string">'tableau'</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h5><a id="13__82"></a>1.3 不同的执行模式</h5> 
<ul><li> <p>批处理</p> 
  <blockquote> 
   <p>只能处理有界流</p> 
   <p>结果是固定的</p> 
   <p>底层是基于MR模型</p> 
   <p><strong>不会出现由插入（<code>+</code>）和撤销（<code>-</code>）组成的持续查询产生结果流这种结果，只会出现最终结果</strong></p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token keyword">SET</span> <span class="token string">'execution.runtime-mode'</span> <span class="token operator">=</span> <span class="token string">'batch'</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>流处理</p> 
  <blockquote> 
   <p>默认的方式</p> 
   <p>既可以处理无界流，也可以处理有界流</p> 
   <p>结果是连续变化的</p> 
   <p>底层是基于持续流模型</p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token keyword">SET</span> <span class="token string">'execution.runtime-mode'</span> <span class="token operator">=</span> <span class="token string">'streaming'</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h4><a id="2connector_112"></a>2、常用的connector</h4> 
<h5><a id="21_Kafka_114"></a>2.1 Kafka</h5> 
<ul><li> <p>准备工作</p> <pre><code class="prism language-shell"><span class="token comment"># 下载依赖</span>
https://repo.maven.apache.org/maven2/org/apache/flink/flink-sql-connector-kafka/1.15.4/flink-sql-connector-kafka-1.15.4.jar

<span class="token comment"># 长传至${FLINK_HOME}/lib</span>

<span class="token comment"># 重启yarn-session.sh</span>
<span class="token comment"># 先找到yarn-session的application id</span>
<span class="token function">yarn</span> application <span class="token parameter variable">-list</span>

<span class="token comment"># kill掉yarn-session在Yarn上的进程</span>
<span class="token function">yarn</span> application <span class="token parameter variable">-kill</span> application_1722331927004_0007

<span class="token comment"># 再启动yarn-session</span>
yarn-session.sh <span class="token parameter variable">-d</span>

<span class="token comment"># 再启动sql-client</span>
sql-client.sh
</code></pre> </li><li> <p>Source</p> <pre><code class="prism language-sql"><span class="token comment">-- 构建Kafka Source</span>
<span class="token comment">-- 无界流</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> students_kafka_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> students_kafka_source <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
   <span class="token comment">-- Kafka Source提供的数据之外的数据（元数据）</span>
  <span class="token identifier"><span class="token punctuation">`</span>event_time<span class="token punctuation">`</span></span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> METADATA <span class="token keyword">FROM</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pt<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span> METADATA <span class="token keyword">FROM</span> <span class="token string">'partition'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>offset<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span> METADATA <span class="token keyword">FROM</span> <span class="token string">'offset'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>topic<span class="token punctuation">`</span></span> STRING METADATA <span class="token keyword">FROM</span> <span class="token string">'topic'</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'students1000'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'master:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'grp1'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'csv'</span><span class="token punctuation">,</span>
  <span class="token comment">-- 是否忽略脏数据</span>
  <span class="token string">'csv.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 执行查询</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>event_time<span class="token punctuation">,</span>pt<span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>offset<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>topic<span class="token punctuation">`</span></span> <span class="token keyword">from</span> students_kafka_source <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>Sink</p> 
  <ul><li> <p>结果不带更新的Sink</p> <pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> students_lksb_sink<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> students_lksb_sink <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'students_lksb_sink'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'master:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'grp1'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'csv'</span><span class="token punctuation">,</span>
  <span class="token comment">-- 是否忽略脏数据</span>
  <span class="token string">'csv.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 执行不带更新的查询</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> students_lksb_sink
<span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>clazz <span class="token keyword">from</span> students_kafka_source <span class="token keyword">where</span> clazz<span class="token operator">=</span><span class="token string">'理科四班'</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>结果带更新的Sink</p> 
    <blockquote> 
     <p>Kafka只支持追加的写入，不支持更新数据</p> 
     <p>故有更新的查询结果无法直接编码，写入Kafka</p> 
     <p>虽然Kafka支支持append，但是可以将更新流编码成“ +、-”不断追加到Kafka中</p> 
     <p>如果有更新，那么往Kafka写两条记录即可表示更新，即：先“-”再“+”</p> 
     <p><strong>但是csv这种格式无法表达“-”或“+”操作，故无法在有更新的结果写Kafka时使用</strong></p> 
     <p>需要使用：canal-json或者是debezium-json</p> 
     <p>canal-json：{“data”:[{“clazz”:“文科六班”,“cnt”:104}],“type”:“DELETE”}</p> 
     <p>debezium-json：{“before”:null,“after”:{“clazz”:“理科四班”,“cnt”:94},“op”:“c”}</p> 
    </blockquote> <pre><code class="prism language-sql"><span class="token comment">-- 基于Kafka Source 统计班级人数 最终结果写入Kafka</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> clazz_cnt_sink<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> clazz_cnt_sink <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> String<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>cnt<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'clazz_cnt_sink_02'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'master:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'grp1'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'canal-json'</span> <span class="token comment">-- 或者是指定为debezium-json</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 执行查询并且将查询结果插入到Sink表中</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> clazz_cnt_sink
<span class="token keyword">select</span> clazz<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> students_kafka_source <span class="token keyword">group</span> <span class="token keyword">by</span> clazz<span class="token punctuation">;</span>
</code></pre> </li></ul> </li></ul> 
<h5><a id="22_JDBC_236"></a>2.2 JDBC</h5> 
<blockquote> 
 <p>用于连接数据库，例如：MySQL、Oracle、PG、Derby</p> 
</blockquote> 
<ul><li> <p>准备工作</p> <pre><code class="prism language-shell"><span class="token comment"># 下载依赖</span>
https://repo.maven.apache.org/maven2/org/apache/flink/flink-connector-jdbc/1.15.4/flink-connector-jdbc-1.15.4.jar

<span class="token comment"># 上传依赖至FLINK的lib目录下，还需要将Linu中MySQL的驱动拷贝一份到lib目录下，可以从Hadoop中进行拷贝</span>

<span class="token comment"># 重启yarn-session以及sql客户端</span>
</code></pre> </li><li> <p>Source</p> 
  <blockquote> 
   <p>有界流，只会查询一次，查询完后直接结束（<strong>从jdbc中读取数据是有界流</strong>）</p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> students_mysql_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> students_mysql_source <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
   <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'jdbc'</span><span class="token punctuation">,</span>
   <span class="token string">'url'</span> <span class="token operator">=</span> <span class="token string">'jdbc:mysql://master:3306/bigdata30?useSSL=false'</span><span class="token punctuation">,</span>
   <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'students'</span><span class="token punctuation">,</span>
   <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
   <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 执行查询</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> students_mysql_source<span class="token punctuation">;</span>
<span class="token comment">-- 将模式换成tableau 看结果变化的全过程</span>
<span class="token keyword">SET</span> <span class="token string">'sql-client.execution.result-mode'</span> <span class="token operator">=</span> <span class="token string">'tableau'</span><span class="token punctuation">;</span>
<span class="token comment">-- 默认会以 流处理的方式 执行，所以可以看到结果连续变化的过程</span>
<span class="token keyword">select</span> gender<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> students_mysql_source <span class="token keyword">group</span> <span class="token keyword">by</span> gender<span class="token punctuation">;</span>
<span class="token comment">-- 将运行模式切换成批处理</span>
<span class="token keyword">SET</span> <span class="token string">'execution.runtime-mode'</span> <span class="token operator">=</span> <span class="token string">'batch'</span><span class="token punctuation">;</span>
<span class="token comment">-- 再试执行，只会看到最终的一个结果，没有变化的过程（这是与流处理的区别之处）</span>
<span class="token keyword">select</span> gender<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> students_mysql_source <span class="token keyword">group</span> <span class="token keyword">by</span> gender<span class="token punctuation">;</span>
</code></pre> </li><li> <p>Sink</p> 
  <blockquote> 
   <p>从Kafka接收无界流的学生数据，统计班级人数，将最终的结果写入MySQL</p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token comment">-- 创建MySQL的结果表</span>
<span class="token comment">-- 查询库中已有表的建表语句</span>
<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> xxx<span class="token punctuation">;</span>

<span class="token comment">-- 无主键的MySQL建表语句</span>
<span class="token comment">-- 最终发现写入的结果是有连续变换的过程，并不是直接写入最终的结果</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> <span class="token identifier"><span class="token punctuation">`</span>clazz_cnt<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token identifier"><span class="token punctuation">`</span>clazz_cnt<span class="token punctuation">`</span></span><span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>
  <span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>cnt<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">-- 将班级设置为主键</span>
<span class="token comment">-- 最终写入的结果是可以通过主键进行更新，所以可以展示最终的结果，并且可以实时更新</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> <span class="token identifier"><span class="token punctuation">`</span>clazz_cnt<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> <span class="token identifier"><span class="token punctuation">`</span>clazz_cnt<span class="token punctuation">`</span></span><span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>cnt<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">-- 创建MySQL的Sink表</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> clazz_cnt_mysql_sink<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> clazz_cnt_mysql_sink <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>cnt<span class="token punctuation">`</span></span>	<span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
   <span class="token comment">-- 如果查询的结果有更新，则需要设置主键</span>
   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
   <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'jdbc'</span><span class="token punctuation">,</span>
   <span class="token string">'url'</span> <span class="token operator">=</span> <span class="token string">'jdbc:mysql://master:3306/bigdata30?useSSL=false'</span><span class="token punctuation">,</span>
   <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'clazz_cnt'</span><span class="token punctuation">,</span>
   <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
   <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 记得将执行模式切换成流处理，因为Kafka是无界流</span>
<span class="token keyword">SET</span> <span class="token string">'execution.runtime-mode'</span> <span class="token operator">=</span> <span class="token string">'streaming'</span><span class="token punctuation">;</span>
<span class="token comment">-- 执行查询：实时统计班级人数，将结果写入MySQL</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> clazz_cnt_mysql_sink
<span class="token keyword">select</span> clazz<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> students_kafka_source <span class="token keyword">where</span> clazz <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">group</span> <span class="token keyword">by</span> clazz<span class="token punctuation">;</span>
</code></pre> </li></ul> 
<h5><a id="23_HDFS_332"></a>2.3 HDFS</h5> 
<ul><li> <p>Source</p> 
  <ul><li> <p>有界流</p> 
    <blockquote> 
     <p>默认的方式</p> 
    </blockquote> <pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> students_hdfs_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> students_hdfs_source <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>file.path<span class="token punctuation">`</span></span> STRING <span class="token operator">NOT</span> <span class="token boolean">NULL</span> METADATA
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'filesystem'</span><span class="token punctuation">,</span>
  <span class="token string">'path'</span> <span class="token operator">=</span> <span class="token string">'hdfs://master:9000/bigdata30/students.txt'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'csv'</span><span class="token punctuation">,</span>
   <span class="token comment">-- 是否忽略脏数据</span>
  <span class="token string">'csv.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询表中是否有数据</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> students_hdfs_source <span class="token keyword">limit</span> <span class="token number">100</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>无界流</p> 
    <blockquote> 
     <p>同DataStream的FileSource一致</p> 
     <p>可以通过设置source.monitor-interval参数，来指定一个监控的间隔时间，例如：5s</p> 
     <p>FLink就会定时监控目录的一个变换，有新的文件就可以实时进行读取</p> 
     <p>最终得到一个无界流</p> 
    </blockquote> <pre><code class="prism language-sql"><span class="token comment">-- 创建HDFS目录</span>
hdfs dfs <span class="token operator">-</span>mkdir <span class="token operator">/</span>bigdata30<span class="token operator">/</span>flink

<span class="token comment">-- 创建Source表</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> students_hdfs_unbounded_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> students_hdfs_unbounded_source <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>file.path<span class="token punctuation">`</span></span> STRING <span class="token operator">NOT</span> <span class="token boolean">NULL</span> METADATA
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'filesystem'</span><span class="token punctuation">,</span>
  <span class="token string">'path'</span> <span class="token operator">=</span> <span class="token string">'hdfs://master:9000/bigdata30/flink'</span><span class="token punctuation">,</span>
  <span class="token string">'source.monitor-interval'</span> <span class="token operator">=</span> <span class="token string">'5s'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'csv'</span><span class="token punctuation">,</span>
   <span class="token comment">-- 是否忽略脏数据</span>
  <span class="token string">'csv.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 执行查询</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> students_hdfs_unbounded_source<span class="token punctuation">;</span>

<span class="token comment">-- 向目录上传文件</span>
hdfs dfs <span class="token operator">-</span>cp <span class="token operator">/</span>bigdata30<span class="token operator">/</span>students<span class="token punctuation">.</span>txt <span class="token operator">/</span>bigdata30<span class="token operator">/</span>flink<span class="token operator">/</span>students<span class="token punctuation">.</span>txt1
hdfs dfs <span class="token operator">-</span>cp <span class="token operator">/</span>bigdata30<span class="token operator">/</span>students<span class="token punctuation">.</span>txt <span class="token operator">/</span>bigdata30<span class="token operator">/</span>flink<span class="token operator">/</span>students<span class="token punctuation">.</span>txt2
</code></pre> </li></ul> </li><li> <p>Sink</p> 
  <ul><li> <p>查询结果没有更新，写入数据</p> <pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> students_hdfs_sink<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> students_hdfs_sink <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>file_path<span class="token punctuation">`</span></span> STRING
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'filesystem'</span><span class="token punctuation">,</span>
  <span class="token string">'path'</span> <span class="token operator">=</span> <span class="token string">'hdfs://master:9000/bigdata30/sink/'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'csv'</span><span class="token punctuation">,</span>
   <span class="token comment">-- 是否忽略脏数据</span>
  <span class="token string">'csv.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> students_hdfs_sink
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> students_hdfs_source<span class="token punctuation">;</span>
</code></pre> </li><li> <p>查询结果有更新，写入数据</p> 
    <blockquote> 
     <p>同Kafka类似，HDFS不支持更新数据，故需要将变换的结果编码成canal-json或者是debezium-json的格式才能进行insert</p> 
    </blockquote> <pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> clazz_cnt_hdfs_sink<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> clazz_cnt_hdfs_sink <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>cnt<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'filesystem'</span><span class="token punctuation">,</span>
  <span class="token string">'path'</span> <span class="token operator">=</span> <span class="token string">'hdfs://master:9000/bigdata30/clazz_cnt/'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'canal-json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 使用有界的数据源来写入待更新的计算结果</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> clazz_cnt_hdfs_sink
<span class="token keyword">select</span> clazz<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> students_hdfs_source <span class="token keyword">group</span> <span class="token keyword">by</span> clazz<span class="token punctuation">;</span>
</code></pre> </li></ul> </li></ul> 
<h5><a id="24_HBase_446"></a>2.4 HBase</h5> 
<pre><code class="prism language-shell">hbase启动顺序：
zk<span class="token punctuation">(</span>三台虚拟机都启动<span class="token punctuation">)</span>--<span class="token operator">&gt;</span>hadoop<span class="token punctuation">(</span>主从复制：在master端启动即可<span class="token punctuation">)</span>--<span class="token operator">&gt;</span>hbase<span class="token punctuation">(</span>在master端启动即可<span class="token punctuation">)</span>

hbase关闭顺序：
hbase--<span class="token operator">&gt;</span>hadoop--<span class="token operator">&gt;</span>zk

<span class="token comment"># 启动</span>
start-hbase.sh

<span class="token comment">#关闭</span>
stop-hbase.sh

<span class="token comment"># 进入HBase的客户端</span>
hbase shell
</code></pre> 
<ul><li> <p>准备工作</p> <pre><code class="prism language-sql"><span class="token comment"># 下载依赖</span>
https:<span class="token comment">//repo.maven.apache.org/maven2/org/apache/flink/flink-sql-connector-hbase-2.2/1.15.4/flink-sql-connector-hbase-2.2-1.15.4.jar</span>

<span class="token comment"># 上传依赖并重启yarn-session及sql客户端</span>
</code></pre> </li><li> <p>Source</p> 
  <blockquote> 
   <p>同MySQL类似，得到是一个有界流</p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> students_hbase_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> students_hbase_source <span class="token punctuation">(</span>
    rowkey STRING<span class="token punctuation">,</span>
    info <span class="token keyword">ROW</span><span class="token operator">&lt;</span>name STRING<span class="token punctuation">,</span> age STRING<span class="token punctuation">,</span>gender STRING<span class="token punctuation">,</span>clazz STRING<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>rowkey<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
 <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'hbase-2.2'</span><span class="token punctuation">,</span>
 <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'students'</span><span class="token punctuation">,</span>
 <span class="token string">'zookeeper.quorum'</span> <span class="token operator">=</span> <span class="token string">'master:2181'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> rowkey<span class="token punctuation">,</span>info<span class="token punctuation">.</span>name<span class="token punctuation">,</span>info<span class="token punctuation">.</span>age<span class="token punctuation">,</span>info<span class="token punctuation">.</span>gender<span class="token punctuation">,</span>info<span class="token punctuation">.</span>clazz <span class="token keyword">from</span> students_hbase_source<span class="token punctuation">;</span>
</code></pre> </li><li> <p>Sink</p> 
  <blockquote> 
   <p>同MySQL类似</p> 
  </blockquote> <pre><code class="prism language-sql"><span class="token comment">-- 在HBase中建表</span>
<span class="token keyword">create</span> <span class="token string">'stu01'</span><span class="token punctuation">,</span><span class="token string">'info'</span>

<span class="token comment">-- 构建HBase Sink表</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> stu_hbase_sink<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> stu_hbase_sink <span class="token punctuation">(</span>
    id STRING<span class="token punctuation">,</span>
    info <span class="token keyword">ROW</span><span class="token operator">&lt;</span>name STRING<span class="token punctuation">,</span>clazz STRING<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
 <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'hbase-2.2'</span><span class="token punctuation">,</span>
 <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'stu01'</span><span class="token punctuation">,</span>
 <span class="token string">'zookeeper.quorum'</span> <span class="token operator">=</span> <span class="token string">'master:2181'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 丢弃null的数据</span>
<span class="token keyword">set</span> <span class="token string">'table.exec.sink.not-null-enforcer'</span><span class="token operator">=</span><span class="token string">'DROP'</span><span class="token punctuation">;</span>

<span class="token comment">-- 仅追加的结果写入，由于HBase有rk存在，相同的RK会进行覆盖</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> stu_hbase_sink
<span class="token keyword">select</span> cast<span class="token punctuation">(</span>id <span class="token keyword">as</span> STRING<span class="token punctuation">)</span> <span class="token keyword">as</span> id<span class="token punctuation">,</span><span class="token keyword">ROW</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>clazz<span class="token punctuation">)</span> <span class="token keyword">as</span> info 
<span class="token keyword">from</span> students_kafka_source
<span class="token punctuation">;</span>

<span class="token comment">-- hbase中遍历数据</span>
scan <span class="token string">"stu01"</span><span class="token punctuation">,</span><span class="token keyword">LIMIT</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">50</span>



<span class="token comment">-- 在HBase中建表</span>
<span class="token keyword">create</span> <span class="token string">'clazz_cnt_01'</span><span class="token punctuation">,</span><span class="token string">'info'</span>

<span class="token comment">-- 构建HBase Sink表</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> clazz_cnt_hbase_sink<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> clazz_cnt_hbase_sink <span class="token punctuation">(</span>
    clazz STRING<span class="token punctuation">,</span>
    info <span class="token keyword">ROW</span><span class="token operator">&lt;</span>cnt <span class="token keyword">BIGINT</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
 <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'hbase-2.2'</span><span class="token punctuation">,</span>
 <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'clazz_cnt_01'</span><span class="token punctuation">,</span>
 <span class="token string">'zookeeper.quorum'</span> <span class="token operator">=</span> <span class="token string">'master:2181'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 带更新的查询结果可以实时在HBase中通过RK进行更新</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> clazz_cnt_hbase_sink
<span class="token keyword">select</span> clazz<span class="token punctuation">,</span><span class="token keyword">ROW</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> info
<span class="token keyword">from</span> students_kafka_source
<span class="token keyword">group</span> <span class="token keyword">by</span> clazz
<span class="token punctuation">;</span>

<span class="token comment">-- hbase中遍历数据</span>
scan <span class="token string">"clazz_cnt_01"</span><span class="token punctuation">,</span><span class="token keyword">LIMIT</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">50</span>
</code></pre> </li></ul> 
<h5><a id="25_DataGen_553"></a>2.5 DataGen</h5> 
<blockquote> 
 <p>用于按照指定的规则生成数据，一般用于性能测试</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> datagen<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> datagen <span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span>
    <span class="token punctuation">,</span>random_id <span class="token keyword">BIGINT</span>
    <span class="token punctuation">,</span>name STRING
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
 <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'datagen'</span><span class="token punctuation">,</span>
 <span class="token comment">-- optional options --</span>
 <span class="token string">'rows-per-second'</span><span class="token operator">=</span><span class="token string">'20'</span><span class="token punctuation">,</span> <span class="token comment">-- 设置每秒钟生成的数据量</span>
    
    <span class="token string">'fields.id.kind'</span> <span class="token operator">=</span> <span class="token string">'random'</span><span class="token punctuation">,</span>
    <span class="token string">'fields.id.min'</span><span class="token operator">=</span><span class="token string">'10000000'</span><span class="token punctuation">,</span>
    <span class="token string">'fields.id.max'</span><span class="token operator">=</span><span class="token string">'99999999'</span><span class="token punctuation">,</span>

    <span class="token string">'fields.random_id.kind'</span> <span class="token operator">=</span> <span class="token string">'random'</span><span class="token punctuation">,</span>
    <span class="token string">'fields.random_id.min'</span><span class="token operator">=</span><span class="token string">'10000000'</span><span class="token punctuation">,</span>
    <span class="token string">'fields.random_id.max'</span><span class="token operator">=</span><span class="token string">'99999999'</span><span class="token punctuation">,</span>
    
    <span class="token string">'fields.name.length'</span><span class="token operator">=</span><span class="token string">'5'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="26_Blackhole_580"></a>2.6 Blackhole</h5> 
<blockquote> 
 <p>用于性能测试，可以作为Sink端</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> blackhole_table<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span>  blackhole_table
<span class="token keyword">WITH</span> <span class="token punctuation">(</span><span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'blackhole'</span><span class="token punctuation">)</span>
<span class="token operator">LIKE</span> datagen <span class="token punctuation">(</span>EXCLUDING <span class="token keyword">ALL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> blackhole_table
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> datagen <span class="token keyword">group</span> <span class="token keyword">by</span> name<span class="token punctuation">;</span>


<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> blackhole_table<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span>  blackhole_table<span class="token punctuation">(</span>
	name String<span class="token punctuation">,</span>
    cnt <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span>
<span class="token keyword">WITH</span> <span class="token punctuation">(</span><span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'blackhole'</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> blackhole_table
<span class="token keyword">select</span> name<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> datagen <span class="token keyword">group</span> <span class="token keyword">by</span> name<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="27_Print_606"></a>2.7 Print</h5> 
<blockquote> 
 <p>将结果数据在TaskManager中输出</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> print_table<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> print_table <span class="token punctuation">(</span>
 name STRING<span class="token punctuation">,</span>
 cnt <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
 <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'print'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> print_table
<span class="token keyword">select</span> name<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> datagen <span class="token keyword">group</span> <span class="token keyword">by</span> name<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="3_623"></a>3、常用的格式</h4> 
<h5><a id="31_CSV_625"></a>3.1 CSV</h5> 
<blockquote> 
 <p><strong>逗号分隔符文件，并非一定是.csv文件</strong></p> 
 <p>在作为Sink时的format，仅支持写入不带更新的结果</p> 
 <p>解析每条数据是通过顺序匹配</p> 
 <p>常用参数：</p> 
 <p>csv.ignore-parse-errors 默认false，忽略解析错误，不会导致程序直接停止</p> 
 <p>csv.field-delimiter 默认 逗号，指定数据的列分隔符</p> 
</blockquote> 
<h5><a id="32_JSON_639"></a>3.2 JSON</h5> 
<h6><a id="321_json_641"></a>3.2.1 json</h6> 
<blockquote> 
 <p>普通的json格式，解析数据是通过列名进行匹配</p> 
 <p>同csv类似，只支持写入不带更新的结果</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> cars_json_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> cars_json_source <span class="token punctuation">(</span>
    car String
    <span class="token punctuation">,</span>county_code <span class="token keyword">INT</span>
    <span class="token punctuation">,</span>city_code <span class="token keyword">INT</span>
    <span class="token punctuation">,</span>card <span class="token keyword">BIGINT</span>
    <span class="token punctuation">,</span>camera_id String
    <span class="token punctuation">,</span>orientation String
    <span class="token punctuation">,</span>road_id <span class="token keyword">BIGINT</span>
    <span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>time<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span>
    <span class="token punctuation">,</span>speed <span class="token keyword">Double</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'cars_json'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'master:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'grp1'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="322_canaljson_669"></a>3.2.2 canal-json</h6> 
<blockquote> 
 <p>一种特殊的JSON格式</p> 
 <p>支持写入更新的结果</p> 
 <p>{“data”:[{“clazz”:“文科六班”,“cnt”:104}],“type”:“DELETE”}</p> 
</blockquote> 
<h6><a id="323_debeziumjson_677"></a>3.2.3 debezium-json</h6> 
<blockquote> 
 <p>同canal-json，只是数据格式有些许差异</p> 
 <p>{“before”:null,“after”:{“clazz”:“理科四班”,“cnt”:94},“op”:“c”}</p> 
</blockquote> 
<h5><a id="33_ORC_683"></a>3.3 ORC</h5> 
<blockquote> 
 <p>一般不用</p> 
</blockquote> 
<h5><a id="34_PARQUET_687"></a>3.4 PARQUET</h5> 
<blockquote> 
 <p>一般不用</p> 
</blockquote> 
<h4><a id="4_691"></a>4、时间属性</h4> 
<h5><a id="41__693"></a>4.1 处理时间</h5> 
<blockquote> 
 <p>基于系统的时间</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> students_kafka_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> students_kafka_source <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
   <span class="token comment">-- 通过系统时间给表增加一列，即：处理时间</span>
   proc_time <span class="token keyword">as</span> PROCTIME<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'students1000'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'master:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'grp1'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'csv'</span><span class="token punctuation">,</span>
  <span class="token comment">-- 是否忽略脏数据</span>
  <span class="token string">'csv.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span>  clazz
        <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
        <span class="token punctuation">,</span>tumble_start<span class="token punctuation">(</span>proc_time<span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> SECONDS<span class="token punctuation">)</span> <span class="token keyword">as</span> window_start
        <span class="token punctuation">,</span>tumble_end<span class="token punctuation">(</span>proc_time<span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> SECONDS<span class="token punctuation">)</span> <span class="token keyword">as</span> window_end
<span class="token keyword">from</span> students_kafka_source 
<span class="token keyword">group</span> <span class="token keyword">by</span> clazz<span class="token punctuation">,</span>tumble<span class="token punctuation">(</span>proc_time<span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> SECONDS<span class="token punctuation">)</span>
<span class="token punctuation">;</span>

<span class="token comment">-- 向Topic中生产数据</span>
kafka<span class="token operator">-</span>console<span class="token operator">-</span>producer<span class="token punctuation">.</span>sh <span class="token comment">--broker-list master:9092 --topic students1000</span>
</code></pre> 
<h5><a id="42__730"></a>4.2 事件时间</h5> 
<blockquote> 
 <p>基于数据自带的时间</p> 
 <p>java,2024-08-03 10:41:50</p> 
 <p>java,2024-08-03 10:41:51</p> 
 <p>java,2024-08-03 10:41:52</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> words_kafka_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> words_kafka_source <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>word<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
   <span class="token comment">-- 从数据中过来的一列，作为事件时间</span>
   event_time <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token comment">-- 指定水位线前移策略，并同时声明数据中的哪一列是事件时间</span>
   WATERMARK <span class="token keyword">FOR</span> event_time <span class="token keyword">AS</span> event_time <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> <span class="token keyword">SECOND</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'words_event_time'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'master:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'grp1'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'csv'</span><span class="token punctuation">,</span>
  <span class="token comment">-- 是否忽略脏数据</span>
  <span class="token string">'csv.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建topic</span>
kafka<span class="token operator">-</span>topics<span class="token punctuation">.</span>sh <span class="token comment">--zookeeper master:2181/kafka --create --replication-factor 1 --partitions 1 --topic words_event_time</span>

<span class="token comment">-- 执行查询，使用滚动的事件时间窗口进行word count，每5s统计一次</span>
<span class="token keyword">select</span>  word
        <span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt
        <span class="token punctuation">,</span>tumble_start<span class="token punctuation">(</span>event_time<span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> SECONDS<span class="token punctuation">)</span> <span class="token keyword">as</span> window_start
        <span class="token punctuation">,</span>tumble_end<span class="token punctuation">(</span>event_time<span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> SECONDS<span class="token punctuation">)</span> <span class="token keyword">as</span> window_end
<span class="token keyword">from</span> words_kafka_source 
<span class="token keyword">group</span> <span class="token keyword">by</span> word<span class="token punctuation">,</span>tumble<span class="token punctuation">(</span>event_time<span class="token punctuation">,</span><span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> SECONDS<span class="token punctuation">)</span>
<span class="token punctuation">;</span>

<span class="token comment">-- 向Topic中生产数据</span>
kafka<span class="token operator">-</span>console<span class="token operator">-</span>producer<span class="token punctuation">.</span>sh <span class="token comment">--broker-list master:9092 --topic words_event_time</span>
</code></pre> 
<h4><a id="5SQL_775"></a>5、SQL语法</h4> 
<h5><a id="51_Hints_777"></a>5.1 Hints</h5> 
<blockquote> 
 <p>在SQL查询时动态修改表的参数配置</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- words_kafka_source 默认从最后开始消费</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> words_kafka_source<span class="token punctuation">;</span> <span class="token comment">// 只能查询到最新的数据，不会从头开始消费</span>

<span class="token comment">-- 假设现在需要从头开始消费</span>
<span class="token comment">-- 第一种方案，将words_kafka_source删除重建</span>
<span class="token comment">-- 第二种方案，通过alter table 对表进行修改</span>
<span class="token comment">-- 第三种方案，通过hints动态调整表的配置</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> words_kafka_source <span class="token comment">/*+OPTIONS('scan.startup.mode' = 'earliest-offset') */</span> <span class="token punctuation">;</span>
</code></pre> 
<h5><a id="52_With_792"></a>5.2 With</h5> 
<blockquote> 
 <p>用于将多次执行的同一查询通过with先定义，后面可以进行多次使用，避免重复的SQL</p> 
 <p>应用场景：1、多次使用的SQL查询可以缓存提高性能 2、将多级嵌套解开来，降低主SQL的复杂度</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> students_mysql_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> students_mysql_source <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>clazz<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">NOT</span> ENFORCED
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
   <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'jdbc'</span><span class="token punctuation">,</span>
   <span class="token string">'url'</span> <span class="token operator">=</span> <span class="token string">'jdbc:mysql://master:3306/bigdata30?useSSL=false'</span><span class="token punctuation">,</span>
   <span class="token string">'table-name'</span> <span class="token operator">=</span> <span class="token string">'students'</span><span class="token punctuation">,</span>
   <span class="token string">'username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
   <span class="token string">'password'</span> <span class="token operator">=</span> <span class="token string">'123456'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> id<span class="token punctuation">,</span>name <span class="token keyword">from</span> students_mysql_source <span class="token keyword">where</span> clazz <span class="token operator">=</span> <span class="token string">'理科一班'</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>name <span class="token keyword">from</span> students_mysql_source <span class="token keyword">where</span> clazz <span class="token operator">=</span> <span class="token string">'理科一班'</span>
<span class="token punctuation">;</span>

<span class="token comment">-- 通过with可以将多次使用的SQL进行定义</span>
<span class="token keyword">with</span> stu_lkyb <span class="token keyword">as</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> id<span class="token punctuation">,</span>name <span class="token keyword">from</span> students_mysql_source <span class="token keyword">where</span> clazz <span class="token operator">=</span> <span class="token string">'理科一班'</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_lkyb
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_lkyb
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_lkyb
<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="53_Where_832"></a>5.3 Where</h5> 
<blockquote> 
 <p>可以进行过滤</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>clazz<span class="token punctuation">,</span>age <span class="token keyword">from</span> students_mysql_source <span class="token keyword">where</span> clazz <span class="token operator">=</span> <span class="token string">'理科一班'</span> <span class="token operator">and</span> age <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token comment">-- 找到重复数据并进行过滤</span>
<span class="token keyword">select</span>	id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>clazz
<span class="token keyword">from</span> <span class="token punctuation">(</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>clazz<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> students_mysql_source <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>clazz
<span class="token punctuation">)</span> t1 <span class="token keyword">where</span> t1<span class="token punctuation">.</span>cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">-- 聚合后的过滤可以使用Having</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>clazz<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> students_mysql_source <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>clazz
<span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="54_Distinct_850"></a>5.4 Distinct</h5> 
<blockquote> 
 <p>用于去重</p> 
 <p>需要对每条不同的数据维护一个状态，状态会无限制的增大，最终任务可能会失败</p> 
 <p>无界流是正常可以去重的</p> 
 <p>有界流必须在分组之后带上聚合操作才能去重，如果直接distinct或者是groupby不聚合，最终任务里不会产生shuffle，即不会分组，也就无法去重</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 去重</span>
<span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>clazz <span class="token keyword">from</span> students_mysql_source <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>clazz<span class="token punctuation">;</span>

<span class="token comment">-- 等价于distinct</span>
<span class="token keyword">select</span> <span class="token keyword">distinct</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>gender<span class="token punctuation">,</span>clazz <span class="token keyword">from</span> students_mysql_source<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token keyword">distinct</span> id <span class="token keyword">from</span> students_mysql_source<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="55_Windowing_TVFs_870"></a>5.5 Windowing TVFs</h5> 
<blockquote> 
 <p>目前提供了三类TVFs窗口操作：TUMBLE、HOP、CUMULATE</p> 
 <p>会话SESSION窗口只能通过GROUP WINDOW FUNCTION实现</p> 
 <p>计数窗口在FLINK SQL中暂未支持</p> 
</blockquote> 
<h6><a id="551_Tumble_878"></a>5.5.1 Tumble</h6> 
<blockquote> 
 <p>需要设置一个滚动时间</p> 
 <p>每隔一段时间会触发一次窗口的统计</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 创建Bid订单表</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> bid_kafka_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> bid_kafka_source <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>item<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span> <span class="token keyword">DOUBLE</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>bidtime<span class="token punctuation">`</span></span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>proc_time<span class="token punctuation">`</span></span> <span class="token keyword">as</span> PROCTIME<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token comment">-- 指定水位线前移策略，并同时声明数据中的哪一列是事件时间</span>
   WATERMARK <span class="token keyword">FOR</span> bidtime <span class="token keyword">AS</span> bidtime
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'bid'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'master:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'grp1'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'csv'</span><span class="token punctuation">,</span>
  <span class="token comment">-- 是否忽略脏数据</span>
  <span class="token string">'csv.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 准备数据</span>
C<span class="token punctuation">,</span><span class="token number">4.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">05</span>:<span class="token number">00</span>
A<span class="token punctuation">,</span><span class="token number">2.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">07</span>:<span class="token number">00</span>
D<span class="token punctuation">,</span><span class="token number">5.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">09</span>:<span class="token number">00</span>
B<span class="token punctuation">,</span><span class="token number">3.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">11</span>:<span class="token number">00</span>
E<span class="token punctuation">,</span><span class="token number">1.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">13</span>:<span class="token number">00</span>
F<span class="token punctuation">,</span><span class="token number">6.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">17</span>:<span class="token number">00</span>

<span class="token comment">-- 创建Kafka Topic</span>
kafka<span class="token operator">-</span>topics<span class="token punctuation">.</span>sh <span class="token comment">--zookeeper master:2181/kafka --create --replication-factor 1 --partitions 1 --topic bid</span>

<span class="token comment">-- 生产数据</span>
kafka<span class="token operator">-</span>console<span class="token operator">-</span>producer<span class="token punctuation">.</span>sh <span class="token comment">--broker-list master:9092 --topic bid</span>

<span class="token comment">-- 基于事件时间的滚动窗口</span>
<span class="token keyword">SELECT</span> window_start<span class="token punctuation">,</span>window_end<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_price
<span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>
    <span class="token comment">-- tumble函数 会给bid表增加三个窗口列：window_start、window_end、window_time</span>
    <span class="token comment">-- 如果需要基于窗口的统计则按照窗口列分组即可</span>
    TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> bid_kafka_source<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>bidtime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> MINUTES<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">group</span> <span class="token keyword">by</span> window_start<span class="token punctuation">,</span>window_end
<span class="token punctuation">;</span>

<span class="token comment">-- 基于处理时间的滚动窗口</span>
<span class="token keyword">SELECT</span> window_start<span class="token punctuation">,</span>window_end<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_price
<span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>
    <span class="token comment">-- tumble函数 会给bid表增加三个窗口列：window_start、window_end、window_time</span>
    <span class="token comment">-- 如果需要基于窗口的统计则按照窗口列分组即可</span>
    TUMBLE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> bid_kafka_source<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>proc_time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> SECONDS<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">group</span> <span class="token keyword">by</span> window_start<span class="token punctuation">,</span>window_end
<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="552_HOP_938"></a>5.5.2 HOP</h6> 
<blockquote> 
 <p>滑动窗口</p> 
 <p>需要指定两个时间：滑动的时间、窗口的大小</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 基于事件时间的滑动窗口</span>
<span class="token keyword">SELECT</span> window_start<span class="token punctuation">,</span>window_end<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_price
<span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>
    <span class="token comment">-- HOP函数 会给bid表增加三个窗口列：window_start、window_end、window_time</span>
    <span class="token comment">-- 如果需要基于窗口的统计则按照窗口列分组即可</span>
    HOP<span class="token punctuation">(</span><span class="token keyword">TABLE</span> bid_kafka_source<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>bidtime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> MINUTES<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> MINUTES<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">group</span> <span class="token keyword">by</span> window_start<span class="token punctuation">,</span>window_end
<span class="token punctuation">;</span>

<span class="token comment">-- 基于处理时间的滑动窗口</span>
<span class="token keyword">SELECT</span> window_start<span class="token punctuation">,</span>window_end<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_price
<span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>
    <span class="token comment">-- HOP函数 会给bid表增加三个窗口列：window_start、window_end、window_time</span>
    <span class="token comment">-- 如果需要基于窗口的统计则按照窗口列分组即可</span>
    HOP<span class="token punctuation">(</span><span class="token keyword">TABLE</span> bid_kafka_source<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>proc_time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> SECONDS<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> SECONDS<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">group</span> <span class="token keyword">by</span> window_start<span class="token punctuation">,</span>window_end
<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="553_CUMULATE_964"></a>5.5.3 CUMULATE</h6> 
<blockquote> 
 <p>累积窗口：首先会按照步长初始化一个窗口大小，然后按照步长的间隔时间触发窗口的统计，接下来窗口大小会不断增大，直到达到设置的最大size，然后重复这个过程</p> 
 <p>需要指定两个时间间隔：步长、最大的size</p> 
 <p>例如：步长为2分钟，size为10分钟</p> 
 <p>每隔2分钟会触发一次统计，第一次统计的最近两分钟的数据，第二次统计是最近4分钟的…第5次统计是最近10分钟的数据，第6次统计是最近2分钟的数据…</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 基于事件时间的累计窗口</span>
<span class="token keyword">SELECT</span> window_start<span class="token punctuation">,</span>window_end<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_price
<span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>
    <span class="token comment">-- CUMULATE函数 会给bid表增加三个窗口列：window_start、window_end、window_time</span>
    <span class="token comment">-- 如果需要基于窗口的统计则按照窗口列分组即可</span>
    CUMULATE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> bid_kafka_source<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>bidtime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'2'</span> MINUTES<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> MINUTES<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">group</span> <span class="token keyword">by</span> window_start<span class="token punctuation">,</span>window_end
<span class="token punctuation">;</span>

<span class="token comment">-- 基于处理时间的累计窗口</span>
<span class="token keyword">SELECT</span> window_start<span class="token punctuation">,</span>window_end<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_price
<span class="token keyword">FROM</span> <span class="token keyword">TABLE</span><span class="token punctuation">(</span>
    <span class="token comment">-- CUMULATE函数 会给bid表增加三个窗口列：window_start、window_end、window_time</span>
    <span class="token comment">-- 如果需要基于窗口的统计则按照窗口列分组即可</span>
    CUMULATE<span class="token punctuation">(</span><span class="token keyword">TABLE</span> bid_kafka_source<span class="token punctuation">,</span> DESCRIPTOR<span class="token punctuation">(</span>proc_time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'2'</span> SECONDS<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'10'</span> SECONDS<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">group</span> <span class="token keyword">by</span> window_start<span class="token punctuation">,</span>window_end
<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="554_SESSION_994"></a>5.5.4 SESSION</h6> 
<blockquote> 
 <p>会话窗口，目前版本不支持TVFs写法</p> 
 <p>需要使用老版本的写法：GROUP WINDOW FUNCTION</p> 
 <p>间隔一段时间没有数据就会触发窗口的统计</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 基于事件时间的会话窗口</span>
<span class="token keyword">select</span> session_start<span class="token punctuation">(</span>bidtime<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'2'</span> MINUTES<span class="token punctuation">)</span> <span class="token keyword">as</span> session_start
       <span class="token punctuation">,</span>session_end<span class="token punctuation">(</span>bidtime<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'2'</span> MINUTES<span class="token punctuation">)</span> <span class="token keyword">as</span> session_end
       <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_price
<span class="token keyword">from</span> bid_kafka_source
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">session</span><span class="token punctuation">(</span>bidtime<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'2'</span> MINUTES<span class="token punctuation">)</span>
<span class="token punctuation">;</span>

<span class="token comment">-- 基于处理时间的会话窗口</span>
<span class="token keyword">select</span> session_start<span class="token punctuation">(</span>proc_time<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'2'</span> SECONDS<span class="token punctuation">)</span> <span class="token keyword">as</span> session_start
       <span class="token punctuation">,</span>session_end<span class="token punctuation">(</span>proc_time<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'2'</span> SECONDS<span class="token punctuation">)</span> <span class="token keyword">as</span> session_end
       <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_price
<span class="token keyword">from</span> bid_kafka_source
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">session</span><span class="token punctuation">(</span>proc_time<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'2'</span> SECONDS<span class="token punctuation">)</span>
<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="6Over_1020"></a>6、Over聚合</h4> 
<h5><a id="61__1022"></a>6.1 聚合类</h5> 
<blockquote> 
 <p>sum、max、min、count、avg</p> 
 <p>sum 比较特殊：如果指定了order By，则表示累加求和，不指定则表示整个窗口求和</p> 
 <p>max、min、count、avg 不需要指定order By</p> 
</blockquote> 
<pre><code class="prism language-sql"><span class="token comment">-- 准备数据</span>
item<span class="token punctuation">,</span>supply_id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>bidtime
A<span class="token punctuation">,</span><span class="token number">001</span><span class="token punctuation">,</span><span class="token number">4.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">05</span>:<span class="token number">00</span>
A<span class="token punctuation">,</span><span class="token number">002</span><span class="token punctuation">,</span><span class="token number">2.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">06</span>:<span class="token number">00</span>
A<span class="token punctuation">,</span><span class="token number">001</span><span class="token punctuation">,</span><span class="token number">5.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">07</span>:<span class="token number">00</span>
B<span class="token punctuation">,</span><span class="token number">002</span><span class="token punctuation">,</span><span class="token number">3.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">08</span>:<span class="token number">00</span>
A<span class="token punctuation">,</span><span class="token number">001</span><span class="token punctuation">,</span><span class="token number">1.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">09</span>:<span class="token number">00</span>
A<span class="token punctuation">,</span><span class="token number">002</span><span class="token punctuation">,</span><span class="token number">6.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">10</span>:<span class="token number">00</span>
B<span class="token punctuation">,</span><span class="token number">001</span><span class="token punctuation">,</span><span class="token number">6.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">11</span>:<span class="token number">00</span>
A<span class="token punctuation">,</span><span class="token number">001</span><span class="token punctuation">,</span><span class="token number">6.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">12</span>:<span class="token number">00</span>
B<span class="token punctuation">,</span><span class="token number">002</span><span class="token punctuation">,</span><span class="token number">6.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">13</span>:<span class="token number">00</span>
B<span class="token punctuation">,</span><span class="token number">002</span><span class="token punctuation">,</span><span class="token number">6.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">14</span>:<span class="token number">00</span>
A<span class="token punctuation">,</span><span class="token number">001</span><span class="token punctuation">,</span><span class="token number">66.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">15</span>:<span class="token number">00</span>
B<span class="token punctuation">,</span><span class="token number">001</span><span class="token punctuation">,</span><span class="token number">6.00</span><span class="token punctuation">,</span><span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">15</span> <span class="token number">08</span>:<span class="token number">16</span>:<span class="token number">00</span>

<span class="token comment">-- 创建order订单表</span>
<span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> order_kafka_source<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> order_kafka_source <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>item<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>supply_id<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span> <span class="token keyword">DOUBLE</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>bidtime<span class="token punctuation">`</span></span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token comment">-- 指定水位线前移策略，并同时声明数据中的哪一列是事件时间</span>
   WATERMARK <span class="token keyword">FOR</span> bidtime <span class="token keyword">AS</span> bidtime
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'order'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'master:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'grp1'</span><span class="token punctuation">,</span>
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'latest-offset'</span><span class="token punctuation">,</span>
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'csv'</span><span class="token punctuation">,</span>
  <span class="token comment">-- 是否忽略脏数据</span>
  <span class="token string">'csv.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建Kafka Topic</span>
kafka<span class="token operator">-</span>topics<span class="token punctuation">.</span>sh <span class="token comment">--zookeeper master:2181/kafka --create --replication-factor 1 --partitions 1 --topic order</span>

<span class="token comment">-- 生产数据</span>
kafka<span class="token operator">-</span>console<span class="token operator">-</span>producer<span class="token punctuation">.</span>sh <span class="token comment">--broker-list master:9092 --topic order</span>


<span class="token comment">-- 聚合类函数在实时的Over窗口上只会产生追加的数据，没有更新</span>
<span class="token comment">-- 最终需要维护的状态大小同partition by指定的字段有关</span>
<span class="token comment">-- 1、统计每种商品的累计成交金额</span>
<span class="token keyword">select</span> item
       <span class="token comment">-- 必须指定order by ，而且必须使用时间列升序，</span>
       <span class="token comment">-- 如果本条数据的时间小于上一条数据的时间，则本条数据会被忽略，不参与计算</span>
       <span class="token comment">-- 相当于sum只能做累加求和，来一条数据累加一次，无法做全局聚合</span>
       <span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> item <span class="token keyword">order</span> <span class="token keyword">by</span> bidtime<span class="token punctuation">)</span> <span class="token keyword">as</span> sum_price
<span class="token keyword">from</span> order_kafka_source
<span class="token punctuation">;</span>

<span class="token comment">-- 2、统计每种商品的最大成交金额</span>
<span class="token keyword">select</span> item
       <span class="token comment">-- 必须指定order by ，而且必须使用时间列升序，</span>
       <span class="token comment">-- 如果本条数据的时间小于上一条数据的时间，则本条数据会被忽略，不参与统计</span>
       <span class="token comment">-- 来一条数据就会输出一条数据，max会将截止到当前时间戳最大的数据中取最大的一个值</span>
       <span class="token punctuation">,</span><span class="token function">max</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">over</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> <span class="token keyword">by</span> item <span class="token keyword">order</span> <span class="token keyword">by</span> bidtime<span class="token punctuation">)</span> <span class="token keyword">as</span> max_price
<span class="token keyword">from</span> order_kafka_source
<span class="token punctuation">;</span>

<span class="token comment">-- 3、统计每种商品的最小、平均成交金额/交易次数 同上</span>

<span class="token comment">-- 4、统计最近10分钟内每种商品的累计成交金额</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a0f29a0fdfb09eae4c6ab2f8dd9f4e34/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【AI大模型】Prompt 提示词工程使用详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/85b98c28ce1587912ca78b2a934776cc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【C&#43;&#43;深度探索】AVL树的底层实现机制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>