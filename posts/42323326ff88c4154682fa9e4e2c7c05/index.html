<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL周内训参照4、触发器-插入-修改-删除 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/42323326ff88c4154682fa9e4e2c7c05/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="MySQL周内训参照4、触发器-插入-修改-删除">
  <meta property="og:description" content="编号人员题目总分数题干提交内容得分标准7程序员触发器15trigger要求：
1、用户表添加语句添加触发器，要求在添加用户信息时同时初始化用户钱包表数据，初始金额为0。
2、商品表修改语句添加触发器，要求在修改商品售价时不允许上下浮动超过10%。
3、订单表删除语句添加触发器，要求在删除订单信息时先删除订单详情表中的订单信息。提交3条sql与对应的结果截图1、要求给出触发器完整函数语句(3分/问，共9分)
2、触发器中有明确的注释(3分)
3、给出触发器测试语句(3分)8程序员存储过程20percedure基本要求：
1、添加一个用户下订单的存储过程，存储过程名称叫做【create_order_infos()】
2、要求传入创建订单所必须的参数内容，例如：用户编号、商品编号、购买数量等信息。
3、需要根据传入的信息插入【用户钱包交易日志表】、【订单表】、【订单详情表】信息，修改【用户钱包表】、【商品表】。提交完整的存储过程语句与测试语句。1、函数名称匹配(1分)
2、正确传入参数(3分)
3、写明存储过程的详细注释(5分)
4、正确添加所有日志信息(6分)
5、正确添加订单与订单详情(6分)
6、正确修改用户钱包表与商品表数值(6分)
7、给出存储过程测试语句(3分) 触发器 1、用户表添加语句添加触发器，要求在添加用户信息时同时初始化用户钱包表数据，初始金额为0。 -- 触发器名称：after_user_insert -- 功能描述：在user表插入新记录后，自动为新用户创建wallet记录 -- 触发时机：AFTER INSERT -- 触发对象：user表 -- 触发行为：FOR EACH ROW（对每一行插入操作触发） DELIMITER $$ -- 更改默认的语句分隔符为$$，这样可以在触发器内部使用分号 CREATE TRIGGER after_user_insert -- 创建一个名为after_user_insert的触发器 AFTER INSERT ON user -- 触发器在user表发生INSERT操作之后触发 FOR EACH ROW -- 触发器对每一行插入操作都执行一次 BEGIN -- 触发器开始 INSERT INTO user_wallet (user_id, balance) -- 在user_wallet表中插入一行数据 VALUES (NEW.user_id, 0.00); -- 使用NEW.user_id作为新插入行的user_id，balance为0.00 END; -- 触发器结束 $$ -- 触发器定义结束，使用新的分隔符 DELIMITER ; -- 将语句分隔符改回为分号 测试语句：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-17T17:06:54+08:00">
    <meta property="article:modified_time" content="2024-06-17T17:06:54+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL周内训参照4、触发器-插入-修改-删除</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <table border="1" cellspacing="0" style="width:680px;"><tbody><tr><td style="text-align:center;vertical-align:middle;width:43px;"><strong><span style="color:#000000;">编号</span></strong></td><td style="text-align:center;vertical-align:middle;width:73px;"><strong><span style="color:#000000;">人员</span></strong></td><td style="text-align:center;vertical-align:middle;width:105px;"><strong><span style="color:#000000;">题目</span></strong></td><td style="text-align:center;vertical-align:middle;width:60px;"><strong><span style="color:#000000;">总分数</span></strong></td><td style="text-align:center;vertical-align:middle;width:650px;"><strong><span style="color:#000000;">题干</span></strong></td><td style="text-align:center;vertical-align:middle;width:97px;"><strong><span style="color:#000000;">提交内容</span></strong></td><td style="text-align:center;vertical-align:middle;width:631px;"><strong><span style="color:#000000;">得分标准</span></strong></td></tr><tr><td style="text-align:center;vertical-align:middle;width:43px;"><span style="color:#000000;">7</span></td><td style="text-align:center;vertical-align:middle;width:73px;"><span style="color:#000000;">程序员</span></td><td style="text-align:center;vertical-align:middle;width:105px;"><span style="color:#000000;">触发器</span></td><td style="text-align:center;vertical-align:middle;width:60px;"><span style="color:#000000;">15</span></td><td style="text-align:left;vertical-align:middle;width:650px;"><span style="color:#000000;">trigger要求：<br> 1、用户表添加语句添加触发器，要求在添加用户信息时同时初始化用户钱包表数据，初始金额为0。<br> 2、商品表修改语句添加触发器，要求在修改商品售价时不允许上下浮动超过10%。<br> 3、订单表删除语句添加触发器，要求在删除订单信息时先删除订单详情表中的订单信息。</span></td><td style="text-align:left;vertical-align:middle;width:97px;"><span style="color:#000000;">提交3条sql与对应的结果截图</span></td><td style="text-align:left;vertical-align:middle;width:631px;"><span style="color:#000000;">1、要求给出触发器完整函数语句(3分/问，共9分)<br> 2、触发器中有明确的注释(3分)<br> 3、给出触发器测试语句(3分)</span></td></tr><tr><td style="text-align:center;vertical-align:middle;width:43px;"><span style="color:#000000;">8</span></td><td style="text-align:center;vertical-align:middle;width:73px;"><span style="color:#000000;">程序员</span></td><td style="text-align:center;vertical-align:middle;width:105px;"><span style="color:#000000;">存储过程</span></td><td style="text-align:center;vertical-align:middle;width:60px;"><span style="color:#000000;">20</span></td><td style="text-align:left;vertical-align:middle;width:650px;"><span style="color:#000000;">percedure基本要求：<br> 1、添加一个用户下订单的存储过程，存储过程名称叫做【create_order_infos()】<br> 2、要求传入创建订单所必须的参数内容，例如：用户编号、商品编号、购买数量等信息。<br> 3、需要根据传入的信息插入【用户钱包交易日志表】、【订单表】、【订单详情表】信息，修改【用户钱包表】、【商品表】。</span></td><td style="text-align:left;vertical-align:middle;width:97px;"><span style="color:#000000;">提交完整的存储过程语句与测试语句。</span></td><td style="text-align:left;vertical-align:middle;width:631px;"><span style="color:#000000;">1、函数名称匹配(1分)<br> 2、正确传入参数(3分)<br> 3、写明存储过程的详细注释(5分)<br> 4、正确添加所有日志信息(6分)<br> 5、正确添加订单与订单详情(6分)<br> 6、正确修改用户钱包表与商品表数值(6分)<br> 7、给出存储过程测试语句(3分)</span></td></tr></tbody></table> 
<h3>触发器</h3> 
<h3><span style="color:#000000;">1、用户表添加语句添加触发器，要求在添加用户信息时同时初始化用户钱包表数据，初始金额为0。</span></h3> 
<pre><code class="language-sql">-- 触发器名称：after_user_insert

-- 功能描述：在user表插入新记录后，自动为新用户创建wallet记录

-- 触发时机：AFTER INSERT

-- 触发对象：user表

-- 触发行为：FOR EACH ROW（对每一行插入操作触发）
DELIMITER $$  -- 更改默认的语句分隔符为$$，这样可以在触发器内部使用分号
CREATE TRIGGER after_user_insert  -- 创建一个名为after_user_insert的触发器
AFTER INSERT ON user  -- 触发器在user表发生INSERT操作之后触发
FOR EACH ROW  -- 触发器对每一行插入操作都执行一次
BEGIN  -- 触发器开始
    INSERT INTO user_wallet (user_id, balance)  -- 在user_wallet表中插入一行数据
    VALUES (NEW.user_id, 0.00);  -- 使用NEW.user_id作为新插入行的user_id，balance为0.00
END;  -- 触发器结束
$$  -- 触发器定义结束，使用新的分隔符
DELIMITER ;  -- 将语句分隔符改回为分号</code></pre> 
<p><strong>测试语句</strong>：</p> 
<pre><code class="language-sql">-- 插入新用户记录，触发器应自动在user_wallet表中创建对应wallet记录
INSERT INTO user (username, password, email, phone)
VALUES ('孙燕姿', 'password123', 'newuser@example.com', '1234567890');


-- 查询user_wallet表确认新wallet记录是否存在
-- 完整的多表联合查询确认
select u.*,uw.balance from `user` u INNER JOIN user_wallet uw on u.user_id=uw.user_id where username='孙燕姿'; 
-- 简单的子查询
SELECT * FROM user_wallet WHERE user_id = (SELECT user_id FROM user WHERE username = '孙燕姿');</code></pre> 
<p></p> 
<h3>2、商品表修改语句添加触发器，要求在修改商品售价时不允许上下浮动超过10%。</h3> 
<p>基本示例</p> 
<pre><code class="language-sql">begin 
	-- 编写代码的区域
	DECLARE result1 decimal(10,4); -- 声明变量-必须用在头部
	if new.price=0 then
		SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '新价格不能为0。';
	end if;
	-- 题目要求加上上下浮动不得超过10%
	set result1 = (new.price-old.price)/old.price*100;
	if abs(result1)&gt;10 then
		SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '价格上下浮动不得超过10%。';
	end if;
end</code></pre> 
<p>详细示例</p> 
<pre><code class="language-sql">
-- 使用两个美元符号（$$）作为语句定界符，这允许在触发器内部使用分号（;）
DELIMITER $$


-- 创建触发器，命名为trg_check_price_change

-- 在product表的每一行数据更新之前执行此触发器
CREATE TRIGGER trg_check_price_change
BEFORE UPDATE ON product
FOR EACH ROW
BEGIN
    -- 声明一个变量来存储商品旧的价格
    DECLARE old_price DECIMAL(10, 2);
    -- 声明一个变量来存储商品新的价格
    DECLARE new_price DECIMAL(10, 2);
    -- 声明一个变量来存储价格变动的百分比
    DECLARE percentage_change DECIMAL(10, 2);
    
    -- 将旧的价格值赋给old_price变量，这里的OLD是MySQL提供的关键字，用于获取更新前的字段值
    SET old_price = OLD.price;
    -- 将新的价格值赋给new_price变量，NEW关键字用于获取更新后的字段值
    SET new_price = NEW.price;
    
    -- 接下来检查新的价格是否为0，因为商品的价格通常不应该为0
    -- 如果是，则触发一个错误信号，并返回指定的错误消息
    IF new_price = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '新价格不能为0。';
    END IF;
    
    -- 计算价格变动的百分比
    -- 使用公式：(新价格 - 旧价格) / 旧价格 * 100
    -- 这里需要确保old_price不为0，否则除以0会导致错误
    SET percentage_change = (new_price - old_price) / old_price * 100;
    
    -- 接着检查价格变动的百分比是否超过了10%
    -- 如果超过，触发一个错误信号，并返回指定的错误消息
    IF ABS(percentage_change) &gt; 10 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = '商品售价上下浮动不能超过10%。';
    END IF;
    
    -- 触发器执行完毕
END;
$$


-- 将语句定界符重新设置为分号（;）
DELIMITER ;</code></pre> 
<p><strong>测试语句</strong>：</p> 
<pre><code class="language-sql">-- 插入测试数据：
INSERT INTO product (product_name, price, stock, type_id) VALUES ('大鱼头', 100.00, 10, 1);

-- 正常更新（未超过10%）：
UPDATE product SET price = 110.00 WHERE product_name = '大鱼头'; -- 应成功

-- 更新超过10%（触发错误）：
UPDATE product SET price = 550.00 WHERE product_name = '大鱼头'; -- 应触发错误</code></pre> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/63/f4/WswRowGn_o.png" width="1200"></p> 
<p>手动修改直接会触发。 </p> 
<p><img alt="" height="789" src="https://images2.imgbox.com/01/17/lWy8YCXL_o.png" width="782"></p> 
<p></p> 
<h3>3、订单表删除语句添加触发器，要求在删除订单信息时先删除订单详情表中的订单信息。</h3> 
<p>这个题目考查的是前后的问题，必须删除从表数据后才能删除主表数据，故而这里是【BEFORE】</p> 
<pre><code class="language-sql">DELIMITER $$  -- 更改语句分隔符为$$，这样可以在触发器内部使用分号
CREATE TRIGGER trg_delete_order_details
BEFORE DELETE ON `order`  -- 在`order`表执行DELETE操作之前触发order是关键字需要加上``区分关键字
FOR EACH ROW  -- 对每行被删除的数据执行一次触发器
BEGIN
    -- 删除与即将被删除的订单相关联的所有订单详情记录
    DELETE FROM order_info WHERE order_id = OLD.order_id;  -- OLD是MySQL中代表被删除行的关键字
END;
$$  -- 触发器定义结束
DELIMITER ;  -- 将语句分隔符改回为分号</code></pre> 
<p><strong>测试语句</strong>：</p> 
<p>插入测试数据到order和order_info表，用做测试。</p> 
<pre><code class="language-sql">INSERT INTO `order` (`user_id`, `order_status`, `total_price`) VALUES (1, '待支付', 100.00);
INSERT INTO order_info (order_id, product_id, quantity, unit_price) VALUES (LAST_INSERT_ID(), 1, 2, 50.00);</code></pre> 
<p><img alt="" height="772" src="https://images2.imgbox.com/3e/db/BspGCcHP_o.png" width="1200"></p> 
<p>执行删除操作，并观察order_info表的变化。</p> 
<pre><code class="language-sql">DELETE FROM `order` WHERE `order_id` = 刚才添加的id号;</code></pre> 
<p><img alt="" height="655" src="https://images2.imgbox.com/16/c2/iEs8UPnk_o.png" width="1020"></p> 
<p>检查order_info表，确保与刚才删除的订单相关的记录已被删除。</p> 
<pre><code class="language-sql">SELECT * FROM order_info WHERE order_id = 刚才添加的id号;</code></pre> 
<p><img alt="" height="520" src="https://images2.imgbox.com/33/88/NHD4NWYm_o.png" width="1105"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cd9ab7061c26b46020a55186987aacd1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">nginx的正向代理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/056494de0af27749b7b8e54e4f93d886/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">除了OpenAI ChatGPT ！还有这9个不可错过的中文AI工具，甚至能平替</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>