<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>elasticsearch 聚合 : 指标聚合、桶聚合、管道聚合解析使用总结 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/c5850cc302de4d50983cc7ee3109e94b/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="elasticsearch 聚合 : 指标聚合、桶聚合、管道聚合解析使用总结">
  <meta property="og:description" content="码到三十五 ： 个人主页 目录 一、聚合查询概述二、聚合查询类型Metric Aggregations（指标聚合）Bucket Aggregations（桶聚合）Pipeline Aggregations（管道聚合） 三、聚合查询应用四、doc_values 与 fielddataexact value字段分词字段doc_values与fielddata的性能权衡Doc ValuesFielddata 五、multi-fields（多字段）六、聚合查询示例Terms 分桶聚合Date Histogram 直方图聚合Range 范围聚合Nested 嵌套聚合Pipeline 管道聚合Derivative（导数聚合）Cumulative Sum（累计和聚合）Moving Average（移动平均聚合）Bucket Script（桶脚本聚合）Filters 过滤器聚合 七、聚合排序八、优化建议 一、聚合查询概述 Elasticsearch中的聚合查询是一种功能强大的数据分析工具，它能够提供从索引中提取和计算有关数据的复杂统计信息的能力。聚合查询不仅可以帮助用户理解和分析数据中的趋势和模式，还能在业务决策中发挥关键作用。聚合查询支持多种类型，包括指标聚合、桶聚合和管道聚合，每一种都有其特定的应用场景和使用方法。
二、聚合查询类型 Metric Aggregations（指标聚合） 概述：指标聚合返回基于字段值的度量结果，如总和、平均值、最小值、最大值等。这些度量结果可以直接用于分析数据中的特定指标。
常用类型：
Sum：计算字段的总和。
Avg：计算字段的平均值。
Min/Max：查找字段的最小值和最大值。
Stats：提供包括count、sum、min、max和avg在内的多种统计信息。
应用场景举例：销售数据的总销售额和平均订单金额分析、用户行为的平均访问时长和最大访问深度分析等。
Bucket Aggregations（桶聚合） 概述：桶聚合类似于SQL中的GROUP BY操作，它将文档分组到不同的桶中，并对每个桶中的文档进行聚合计算。桶聚合可以基于字段值、时间间隔或数值范围进行分组。
常用类型：
Terms：根据字段的值将文档分配到不同的桶中，常用于分析文本字段的不同取值及其分布情况。
Date Histogram：根据日期字段的值，将文档按时间间隔（如天、周、月等）分组到桶中，适用于时间序列数据的分析。
Range：根据定义的范围将文档分配到不同的桶中，适用于分析数值字段在特定范围内的文档数量。
应用场景举例：按作者分组的博客文章数量统计、按月份统计的销售记录分析、按价格区间统计的产品数量等。
Pipeline Aggregations（管道聚合） 概述：管道聚合以其他聚合的结果作为输入，并对其进行进一步的处理或计算。这种聚合类型允许用户对聚合结果进行复杂的转换和分析。
常用类型：
Avg Bucket：计算每个桶的平均值，通常用于对分组数据进行平均值分析。
Sum Bucket：计算每个桶的总和，适用于对分组数据进行求和操作。
Max/Min Bucket：找出所有桶中的最大值或最小值，有助于识别分组数据中的极端情况。
应用场景举例：在按月份统计的销售记录中找出平均销售额最高的月份、分析不同价格区间产品的销售额总和等。
三、聚合查询应用 与查询语句结合：聚合查询通常与查询语句结合使用，可以在满足特定条件的文档集合上进行聚合操作。通过查询语句过滤出符合条件的文档集合，然后对这些文档进行聚合分析，可以得到更加准确和有用的结果。嵌套聚合：Elasticsearch支持嵌套聚合，即在一个聚合内部可以包含其他聚合。通过嵌套聚合，用户可以构建复杂的查询和分析逻辑，满足各种复杂的数据分析和统计需求。 四、doc_values 与 fielddata 在 Elasticsearch 中，聚合操作主要依赖于 doc_values 或 fielddata 来进行。用于聚合的字段可以是精确值字段（如keyword类型）或分词字段（如text类型）。这两类字段在聚合查询时的处理方式有所不同。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-25T23:43:49+08:00">
    <meta property="article:modified_time" content="2024-06-25T23:43:49+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">elasticsearch 聚合 : 指标聚合、桶聚合、管道聚合解析使用总结</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <center> 
 <font color="#c09008" size="4"><strong> 码到三十五 ：</strong></font> 
 <a href="https://blog.csdn.net/qq_26664043" size="6"><font color="#555fff" size="4"> 个人主页</font></a> 
</center> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><ul><li><a href="#_7" rel="nofollow">一、聚合查询概述</a></li><li><a href="#_11" rel="nofollow">二、聚合查询类型</a></li><li><ul><li><a href="#Metric_Aggregations_14" rel="nofollow">Metric Aggregations（指标聚合）</a></li><li><a href="#Bucket_Aggregations_27" rel="nofollow">Bucket Aggregations（桶聚合）</a></li><li><a href="#Pipeline_Aggregations_39" rel="nofollow">Pipeline Aggregations（管道聚合）</a></li></ul> 
    </li><li><a href="#_52" rel="nofollow">三、聚合查询应用</a></li><li><a href="#doc_values__fielddata_57" rel="nofollow">四、doc_values 与 fielddata</a></li><li><ul><li><a href="#exact_value_61" rel="nofollow">exact value字段</a></li><li><a href="#_65" rel="nofollow">分词字段</a></li><li><a href="#doc_valuesfielddata_73" rel="nofollow">doc_values与fielddata的性能权衡</a></li><li><ul><li><a href="#Doc_Values_77" rel="nofollow">Doc Values</a></li><li><a href="#Fielddata_82" rel="nofollow">Fielddata</a></li></ul> 
    </li></ul> 
    </li><li><a href="#multifields_91" rel="nofollow">五、multi-fields（多字段）</a></li><li><a href="#_97" rel="nofollow">六、聚合查询示例</a></li><li><ul><li><a href="#Terms__99" rel="nofollow">Terms 分桶聚合</a></li><li><a href="#Date_Histogram__123" rel="nofollow">Date Histogram 直方图聚合</a></li><li><a href="#Range__147" rel="nofollow">Range 范围聚合</a></li><li><a href="#Nested__174" rel="nofollow">Nested 嵌套聚合</a></li><li><a href="#Pipeline__204" rel="nofollow">Pipeline 管道聚合</a></li><li><a href="#Derivative_244" rel="nofollow">Derivative（导数聚合）</a></li><li><a href="#Cumulative_Sum_277" rel="nofollow">Cumulative Sum（累计和聚合）</a></li><li><a href="#Moving_Average_310" rel="nofollow">Moving Average（移动平均聚合）</a></li><li><a href="#Bucket_Script_344" rel="nofollow">Bucket Script（桶脚本聚合）</a></li><li><a href="#Filters__385" rel="nofollow">Filters 过滤器聚合</a></li></ul> 
    </li><li><a href="#_418" rel="nofollow">七、聚合排序</a></li><li><a href="#_423" rel="nofollow">八、优化建议</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="_7"></a>一、聚合查询概述</h4> 
<p>Elasticsearch中的聚合查询是一种功能强大的数据分析工具，它能够提供从索引中提取和计算有关数据的复杂统计信息的能力。聚合查询不仅可以帮助用户理解和分析数据中的趋势和模式，还能在业务决策中发挥关键作用。聚合查询支持多种类型，包括指标聚合、桶聚合和管道聚合，每一种都有其特定的应用场景和使用方法。</p> 
<h4><a id="_11"></a>二、聚合查询类型</h4> 
<p><img src="https://images2.imgbox.com/62/9b/Pxb0n39D_o.jpg" alt="在这里插入图片描述"></p> 
<h5><a id="Metric_Aggregations_14"></a>Metric Aggregations（指标聚合）</h5> 
<ul><li> <p>概述：指标聚合返回基于字段值的度量结果，如总和、平均值、最小值、最大值等。这些度量结果可以直接用于分析数据中的特定指标。</p> </li><li> <p>常用类型：<br> Sum：计算字段的总和。<br> Avg：计算字段的平均值。<br> Min/Max：查找字段的最小值和最大值。<br> Stats：提供包括count、sum、min、max和avg在内的多种统计信息。</p> </li><li> <p>应用场景举例：销售数据的总销售额和平均订单金额分析、用户行为的平均访问时长和最大访问深度分析等。</p> </li></ul> 
<p><img src="https://images2.imgbox.com/c5/7c/BeIxbcjL_o.jpg" alt="在这里插入图片描述"></p> 
<h5><a id="Bucket_Aggregations_27"></a>Bucket Aggregations（桶聚合）</h5> 
<ul><li> <p>概述：桶聚合类似于SQL中的GROUP BY操作，它将文档分组到不同的桶中，并对每个桶中的文档进行聚合计算。桶聚合可以基于字段值、时间间隔或数值范围进行分组。</p> </li><li> <p>常用类型：<br> Terms：根据字段的值将文档分配到不同的桶中，常用于分析文本字段的不同取值及其分布情况。<br> Date Histogram：根据日期字段的值，将文档按时间间隔（如天、周、月等）分组到桶中，适用于时间序列数据的分析。<br> Range：根据定义的范围将文档分配到不同的桶中，适用于分析数值字段在特定范围内的文档数量。</p> </li><li> <p>应用场景举例：按作者分组的博客文章数量统计、按月份统计的销售记录分析、按价格区间统计的产品数量等。</p> </li></ul> 
<p><img src="https://images2.imgbox.com/98/a2/BJgLOYcB_o.jpg" alt="在这里插入图片描述"></p> 
<h5><a id="Pipeline_Aggregations_39"></a>Pipeline Aggregations（管道聚合）</h5> 
<ul><li> <p>概述：管道聚合以其他聚合的结果作为输入，并对其进行进一步的处理或计算。这种聚合类型允许用户对聚合结果进行复杂的转换和分析。</p> </li><li> <p>常用类型：<br> Avg Bucket：计算每个桶的平均值，通常用于对分组数据进行平均值分析。<br> Sum Bucket：计算每个桶的总和，适用于对分组数据进行求和操作。<br> Max/Min Bucket：找出所有桶中的最大值或最小值，有助于识别分组数据中的极端情况。</p> </li><li> <p>应用场景举例：在按月份统计的销售记录中找出平均销售额最高的月份、分析不同价格区间产品的销售额总和等。</p> </li></ul> 
<p><img src="https://images2.imgbox.com/0d/dd/Zwfv0lXy_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="_52"></a>三、聚合查询应用</h4> 
<ul><li>与查询语句结合：聚合查询通常与查询语句结合使用，可以在满足特定条件的文档集合上进行聚合操作。通过查询语句过滤出符合条件的文档集合，然后对这些文档进行聚合分析，可以得到更加准确和有用的结果。</li><li>嵌套聚合：Elasticsearch支持嵌套聚合，即在一个聚合内部可以包含其他聚合。通过嵌套聚合，用户可以构建复杂的查询和分析逻辑，满足各种复杂的数据分析和统计需求。</li></ul> 
<h4><a id="doc_values__fielddata_57"></a>四、doc_values 与 fielddata</h4> 
<p>在 Elasticsearch 中，聚合操作主要依赖于 doc_values 或 fielddata 来进行。用于聚合的字段可以是精确值字段（如keyword类型）或分词字段（如text类型）。这两类字段在聚合查询时的处理方式有所不同。</p> 
<h5><a id="exact_value_61"></a>exact value字段</h5> 
<p>精确值字段通常用于存储不需要分词和全文搜索的数据，如用户ID、产品类别等。对于这类字段，Elasticsearch默认使用doc_values数据结构来支持高效的聚合、排序和统计操作。doc_values以列式存储格式在磁盘上保存字段值，并在需要时加载到JVM堆内存中进行计算。由于doc_values直接在磁盘上操作，因此性能通常很高，且适用于大规模数据集。</p> 
<h5><a id="_65"></a>分词字段</h5> 
<p>分词字段（如text类型）通常用于存储需要分词和全文搜索的文本数据。对于这类字段，Elasticsearch默认不启用fielddata，因为fielddata会将字段值加载到堆内存中，导致在处理大数据集时容易引发内存溢出（OOM）问题。然而，有时我们确实需要在分词字段上执行聚合操作（例如，按产品名称分组统计销售数据）。在这种情况下，有几种解决方案可供选择：</p> 
<ol><li> <p><strong>使用.keyword子字段</strong>：在定义字段映射时，可以为text字段添加一个.keyword子字段。这个子字段不会被分词器处理，而是作为一个完整的字符串存储。通过使用该子字段进行聚合操作，可以获得更准确的结果，同时避免启用fielddata带来的性能问题。</p> </li><li> <p><strong>更新映射启用fielddata</strong>：如果你确实需要在text字段上启用fielddata（虽然不推荐），可以通过更新字段映射来实现。但请注意，这样做可能会导致内存消耗过大，特别是在处理大数据集时。因此，在启用fielddata之前，请务必评估其对系统性能的影响，并考虑其他可能的解决方案。</p> </li></ol> 
<h5><a id="doc_valuesfielddata_73"></a>doc_values与fielddata的性能权衡</h5> 
<p>在Elasticsearch中，聚合操作主要依赖于doc_values或fielddata来访问文档中的字段值。了解这两种数据结构的差异和适用场景，有助于优化聚合查询的性能。</p> 
<h6><a id="Doc_Values_77"></a>Doc Values</h6> 
<ul><li><strong>优势</strong>：适用于精确值字段和数字类型字段，提供高效的聚合、排序和统计操作。由于直接在磁盘上操作，性能通常很高。</li><li><strong>适用场景</strong>：大多数精确值字段默认启用doc_values，无需额外配置。</li></ul> 
<h6><a id="Fielddata_82"></a>Fielddata</h6> 
<ul><li><strong>优势</strong>：支持复杂的文本分析和聚合操作，允许对分词字段进行聚合查询。</li><li><strong>劣势</strong>：需要占用大量堆内存资源，处理大数据集时容易引发OOM问题。默认情况下，Elasticsearch禁用了对text字段的fielddata访问。</li><li><strong>适用场景</strong>：在确实需要在text字段上执行聚合查询，且系统资源允许的情况下，可以考虑启用fielddata。但请务必谨慎评估其对性能的影响。</li></ul> 
<p>总之, 对于精确值字段，利用doc_values可以获得高效且准确的聚合结果；对于分词字段，通过添加.keyword子字段或使用其他解决方案来避免启用fielddata带来的性能问题。通过合理配置字段映射和选择聚合查询策略，可以充分发挥Elasticsearch在数据分析领域的强大功能。</p> 
<h4><a id="multifields_91"></a>五、multi-fields（多字段）</h4> 
<ul><li>描述：在Elasticsearch中，一个字段可以被定义为multi-fields类型，这意味着同一份数据可以被索引为不同类型的字段。通过为text字段添加keyword子字段，用户可以在保留全文搜索功能的同时，为精确值搜索、排序和聚合操作提供支持。</li><li>使用建议：对于需要进行聚合操作的text字段，强烈建议在索引设计阶段添加keyword子字段，并使用该子字段进行聚合操作。这样可以避免在text字段上启用Fielddata带来的性能问题，并提高聚合查询的效率和准确性。</li></ul> 
<h4><a id="_97"></a>六、聚合查询示例</h4> 
<h5><a id="Terms__99"></a>Terms 分桶聚合</h5> 
<p>示例场景：统计每个作者写了多少篇文章，并按文章数量降序排序。<br> 查询语句：</p> 
<pre><code class="prism language-java"><span class="token constant">POST</span> <span class="token operator">/</span>blog<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"articles_per_author"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"author.keyword"</span><span class="token punctuation">,</span>
        <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token string">"order"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"_count"</span><span class="token operator">:</span> <span class="token string">"desc"</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Date_Histogram__123"></a>Date Histogram 直方图聚合</h5> 
<p>示例场景：分析每月的销售记录数量。<br> 查询语句：</p> 
<pre><code class="prism language-java"><span class="token constant">POST</span> <span class="token operator">/</span>sales<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"sales_over_time"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"sale_date"</span><span class="token punctuation">,</span>
        <span class="token string">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"month"</span><span class="token punctuation">,</span>
        <span class="token string">"format"</span><span class="token operator">:</span> <span class="token string">"yyyy-MM"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Range__147"></a>Range 范围聚合</h5> 
<p>示例场景：分析不同价格区间的产品数量。<br> 查询语句：</p> 
<pre><code class="prism language-java">post <span class="token operator">/</span>products<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"price_ranges"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"range"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"price"</span><span class="token punctuation">,</span>
        <span class="token string">"ranges"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{<!-- --></span> <span class="token string">"to"</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{<!-- --></span> <span class="token string">"from"</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">"to"</span><span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{<!-- --></span> <span class="token string">"from"</span><span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Nested__174"></a>Nested 嵌套聚合</h5> 
<p>示例场景：分析每个订单中不同产品的平均价格。<br> 假设数据：一个订单可以有多个产品，每个产品都有一个价格。<br> 查询语句：</p> 
<pre><code class="prism language-java"><span class="token constant">POST</span> <span class="token operator">/</span>orders<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"orders"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"nested"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"path"</span><span class="token operator">:</span> <span class="token string">"products"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"avg_price_per_order"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"avg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"products.price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Pipeline__204"></a>Pipeline 管道聚合</h5> 
<p>示例场景：在按月份统计的销售记录中找出销售额最高的月份，并计算该月的平均销售额。<br> 查询语句：</p> 
<pre><code class="prism language-java"><span class="token constant">POST</span> <span class="token operator">/</span>sales<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"sales_over_time"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"sale_date"</span><span class="token punctuation">,</span>
        <span class="token string">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"month"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"total_sales"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"amount"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"top_sales_month"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"top_hits"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
              <span class="token punctuation">{<!-- --></span> <span class="token string">"total_sales"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"order"</span><span class="token operator">:</span> <span class="token string">"desc"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"avg_sales_top_month"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"avg_bucket"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"total_sales"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="Derivative_244"></a>Derivative（导数聚合）</h5> 
<p>示例场景：分析销售数据的变化趋势，计算销售额的日增长率。<br> 查询语句：</p> 
<pre><code class="prism language-java"><span class="token constant">POST</span> <span class="token operator">/</span>sales<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"sales_over_time"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"sale_date"</span><span class="token punctuation">,</span>
        <span class="token string">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"total_sales"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"amount"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"sales_derivative"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"derivative"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"total_sales"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们首先按天对销售数据进行分组，并计算每天的总销售额。然后，我们使用derivative管道聚合来计算销售额的日增长率。</p> 
<h5><a id="Cumulative_Sum_277"></a>Cumulative Sum（累计和聚合）</h5> 
<p>示例场景：计算销售数据的累计和，展示销售额的累计增长情况。<br> 查询语句：</p> 
<pre><code class="prism language-java"><span class="token constant">POST</span>  <span class="token operator">/</span>sales<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"sales_over_time"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"sale_date"</span><span class="token punctuation">,</span>
        <span class="token string">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"month"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"total_sales"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"amount"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"cumulative_sales"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"cumulative_sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"total_sales"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们按月对销售数据进行分组，并计算每月的总销售额。然后，我们使用cumulative_sum管道聚合来计算销售额的累计和。</p> 
<h5><a id="Moving_Average_310"></a>Moving Average（移动平均聚合）</h5> 
<p>示例场景：分析销售数据的移动平均线，以平滑数据波动并识别趋势。<br> 查询语句：</p> 
<pre><code class="prism language-java"><span class="token constant">POST</span> <span class="token operator">/</span>sales<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"sales_over_time"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"date_histogram"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"sale_date"</span><span class="token punctuation">,</span>
        <span class="token string">"calendar_interval"</span><span class="token operator">:</span> <span class="token string">"day"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"total_sales"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"amount"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"moving_avg_sales"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"moving_avg"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"buckets_path"</span><span class="token operator">:</span> <span class="token string">"total_sales"</span><span class="token punctuation">,</span>
            <span class="token string">"window"</span><span class="token operator">:</span> <span class="token number">7</span>  <span class="token comment">// 计算7天的移动平均</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们按天对销售数据进行分组，并计算每天的总销售额。然后，我们使用moving_avg管道聚合来计算7天的移动平均销售额。</p> 
<h5><a id="Bucket_Script_344"></a>Bucket Script（桶脚本聚合）</h5> 
<p>示例场景：计算每个销售桶中不同产品的销售额占比。<br> 查询语句（假设每个销售桶中按产品分组）：</p> 
<pre><code class="prism language-java"><span class="token constant">POST</span>  <span class="token operator">/</span>sales<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"sales_by_product"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"terms"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"product.keyword"</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"total_sales"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"amount"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"sales_percentage"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"bucket_script"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"buckets_path"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              <span class="token string">"thisSales"</span><span class="token operator">:</span> <span class="token string">"total_sales"</span><span class="token punctuation">,</span>
              <span class="token string">"totalSales"</span><span class="token operator">:</span> <span class="token string">"_sum"</span>  <span class="token comment">// 假设外层还有一个求和聚合来计算总销售额</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"script"</span><span class="token operator">:</span> <span class="token string">"params.thisSales / params.totalSales * 100"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"total_sales"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"amount"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>bucket_script引用了两个buckets_path，其中_sum是Elasticsearch中的一个特殊变量，它引用了当前聚合上下文中所有桶的总和。这个示例假设外层还有一个求和聚合来计算所有产品的销售总额。然后，我们计算每个产品销售额占总销售额的百分比。</p> 
<h5><a id="Filters__385"></a>Filters 过滤器聚合</h5> 
<p>示例场景：分析不同分类产品的销售情况。<br> 查询语句：</p> 
<pre><code class="prism language-java"><span class="token constant">POST</span> <span class="token operator">/</span>products<span class="token operator">/</span>_search
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"size"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"sales_by_category"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"filters"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"filters"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"electronics"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"category"</span><span class="token operator">:</span> <span class="token string">"electronics"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"books"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"term"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"category"</span><span class="token operator">:</span> <span class="token string">"books"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"other"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"total_sales"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          <span class="token string">"sum"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"field"</span><span class="token operator">:</span> <span class="token string">"price"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们使用了filters聚合来按产品分类过滤文档，并在每个过滤器内部使用sum聚合来计算总销售额。</p> 
<h4><a id="_418"></a>七、聚合排序</h4> 
<ul><li>基于count排序：通过聚合的_count字段对桶进行排序，可以展示销售量最高或最低的产品、访问量最大的网页等。</li><li>基于key排序：对于Terms聚合，可以使用_key字段对桶的键（即分组字段的值）进行排序。这有助于按字母顺序或数值顺序展示分组数据。</li></ul> 
<h4><a id="_423"></a>八、优化建议</h4> 
<ul><li>避免不必要的大聚合：对于大数据集，执行复杂的聚合操作可能会消耗大量计算资源并影响性能。因此，建议根据实际需求合理设计聚合查询，避免执行不必要的大聚合操作。</li><li>缓存聚合结果：对于频繁执行的聚合查询，可以考虑使用Elasticsearch的缓存功能来缓存聚合结果。这样可以减少重复计算的开销并提高查询性能。</li><li>合理设计索引和映射：根据查询需求和数据特点，合理设计索引和映射是优化聚合查询性能的关键。例如，选择适当的字段类型和属性、合理设置分片数和副本数等。</li><li>监控和分析：定期监控和分析Elasticsearch的性能指标和日志可以帮助及时发现和解决潜在的性能问题。通过监控聚合查询的执行时间、内存使用情况等指标，可以评估聚合查询的性能并进行相应的优化调整。</li></ul> 
<hr> 
<center> 
 <font color="#c65a6c" size="4"> 关注以下公众号获取更多深度内容，纯干货 ! </font> 
</center> 
<p><img src="https://images2.imgbox.com/47/37/fjq2awg9_o.gif" alt=""></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/832596c474759b06bb40d9b09378aed8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">NPM 常用命令</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3e72750da74b7af127affda3fa1aede3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【面试干货】Java中==和equals()的区别</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>