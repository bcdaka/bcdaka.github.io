<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux多进程和多线程(七)进程间通信-信号量 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/5ba699d79490d3b5416ac7977d4f94c6/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Linux多进程和多线程(七)进程间通信-信号量">
  <meta property="og:description" content="进程间通信之信号量 资源竞争 多个进程竞争同一资源时，会发生资源竞争。
资源竞争会导致进程的执行出现不可预测的结果。
临界资源 不允许同时有多个进程访问的资源, 包括硬件资源 (CPU、内存、存储器以及其他外
围设备) 与软件资源(共享代码段、共享数据结构)
临界区 多个进程共享的资源被称为临界资源，
这些资源被保护在一个临界区中，
只有进入临界区的进程才能访问临界资源。
信号量 信号量是一种进程间通信机制，用于协调对共享资源的访问。
多进程对stdout资源的竞争
//多进程对stdout资源的竞争 #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;sys/types.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/wait.h&gt; int main(){ pid_t cpid; cpid = fork();//创建子进程 if(cpid &lt; 0){ printf(&#34;fork error\n&#34;);//fork失败 exit(EXIT_FAILURE);//EXIT_FAILURE表示程序运行失败 } else if(cpid == 0){//子进程 while(1){ printf(&#34;------------------------\n&#34;); printf(&#34;C Start.\n&#34;); sleep(1); printf(&#34;C End.\n&#34;); printf(&#34;------------------------\n&#34;); } } else{//父进程 while(1){ printf(&#34;------------------------\n&#34;); printf(&#34;P Start.\n&#34;); sleep(1); printf(&#34;P End.\n&#34;); printf(&#34;------------------------\n&#34;); } wait(NULL); //等待子进程结束 } return 0; } 代码的输出混乱:">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-06T22:35:15+08:00">
    <meta property="article:modified_time" content="2024-07-06T22:35:15+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux多进程和多线程(七)进程间通信-信号量</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>进程间通信之信号量</h2> 
<h3><a id="_2"></a>资源竞争</h3> 
<p>多个进程竞争同一资源时，会发生资源竞争。<br> 资源竞争会导致进程的执行出现不可预测的结果。</p> 
<h3><a id="_7"></a>临界资源</h3> 
<p>不允许同时有多个进程访问的资源, 包括硬件资源 (CPU、内存、存储器以及其他外<br> 围设备) 与软件资源(共享代码段、共享数据结构)</p> 
<h3><a id="_12"></a>临界区</h3> 
<p>多个进程共享的资源被称为临界资源，<br> 这些资源被保护在一个临界区中，<br> 只有进入临界区的进程才能访问临界资源。</p> 
<h3><a id="_18"></a>信号量</h3> 
<p>信号量是一种进程间通信机制，用于协调对共享资源的访问。</p> 
<blockquote> 
 <p>多进程对stdout资源的竞争</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token comment">//多进程对stdout资源的竞争</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token class-name">pid_t</span> cpid<span class="token punctuation">;</span>
    cpid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建子进程</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cpid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fork error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//fork失败</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//EXIT_FAILURE表示程序运行失败</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>cpid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//子进程</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"C Start.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"C End.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span><span class="token comment">//父进程</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"P Start.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"P End.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

         <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//等待子进程结束</span>
    <span class="token punctuation">}</span>



    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>代码的输出混乱:</p> 
<pre><code class="prism language-c"><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
P Start<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
C Start<span class="token punctuation">.</span>
P End<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
C End<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
P Start<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
C Start<span class="token punctuation">.</span>
P End<span class="token punctuation">.</span>
C End<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
</code></pre> 
<h3><a id="_83"></a>同步和互斥</h3> 
<h4><a id="_84"></a>互斥</h4> 
<p>互斥是指进程独占资源，使得其他进程无法访问该资源。</p> 
<h4><a id="_87"></a>同步</h4> 
<p>同步是指进程间通信，用于协调进程的执行。<br> 同步在互斥的基础上增加了进程对临界资源的访问顺序<br> 进程主要的同步与互斥手段是信号量</p> 
<h3><a id="_93"></a>信号量</h3> 
<p>信号量,由内核维护的整数,其值被限制为大于或等于0;<br> 信号可以执行一下操作:</p> 
<ul><li>将信号量设置成一个具体的值;</li><li>在信号量当前的基础上加上一个数值;</li><li>在信号量当前值的基础上减上一个数值;</li><li>等待信号量的值为0;</li></ul> 
<blockquote> 
 <p>一般信号量分为</p> 
 <ul><li>二值信号量:一般指的是信号量值为1,可以理解为只对应一个资源</li><li>计数信号量:一般指的是值大于等于2,可以理解为对应多个资源</li></ul> 
</blockquote> 
<blockquote> 
 <p>在linux系统中使用ipcs -s 查询系统中信号量</p> 
</blockquote> 
<h3><a id="_108"></a>创建信号量集合</h3> 
<p>调用 semget() 函数</p> 
<p>函数头文件:</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>


<span class="token keyword">int</span> <span class="token function">semget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token keyword">int</span> nsems<span class="token punctuation">,</span> <span class="token keyword">int</span> semflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数功能:创建一个信号量集合;</p> 
<p>函数参数:</p> 
<ul><li>key: 信号量集合的键值, 用于标识信号量集合;由ftok()函数生成;</li><li>nsems: 信号量集合中信号量的个数;</li><li>semflg: 信号量集合的标志位, 用于设置信号量集合的属性;</li><li> 
  <ul><li>IPC_CREAT: 如果key对应的信号量集合不存在, 则创建新的信号量集合;</li></ul> </li><li> 
  <ul><li>IPC_EXCL: 如果key对应的信号量集合已经存在, 则返回-1;</li></ul> </li><li> 
  <ul><li>权限标志</li></ul> </li></ul> 
<p>函数返回值:</p> 
<ul><li>成功: 返回信号量集合的ID;</li><li>失败: 返回-1, 并设置errno;</li></ul> 
<pre><code class="prism language-c"><span class="token comment">//多进程对stdout资源的竞争</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MSG_PATH</span> <span class="token string">"/home/gopher"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MSG_ID</span> <span class="token expression"><span class="token number">88</span></span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">key_t</span> key<span class="token punctuation">;</span>
    <span class="token comment">//通过文件路径和ID生成key,</span>
    key<span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span>MSG_PATH<span class="token punctuation">,</span>MSG_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ftok()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//创建信号量集合,包含了一个信号量,编号为0</span>
    <span class="token keyword">int</span> semid<span class="token operator">=</span><span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>IPC_CREAT<span class="token operator">|</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>semid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"semget()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>创建出一个信号量集合,包含了一个信号量,编号为0</p> 
<p><img src="https://images2.imgbox.com/e7/48/pkmc4Kcx_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_178"></a>初始化信号量</h3> 
<p>调用 semctl() 函数</p> 
<p>函数头文件:</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>


<span class="token keyword">int</span> <span class="token function">semctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span> <span class="token keyword">int</span> semnum<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token comment">/* arg */</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数功能:对信号量集合中的信号量进行操作;根据cmd 决定当前函数的功能;</p> 
<p>函数参数:</p> 
<ul><li>semid: 信号量集合的ID;</li><li>semnum: 信号量的编号;编号从0开始;</li><li>cmd: 信号量操作命令; 
  <ul><li>SETVAL：设置信号量的值。</li><li>GETPID：返回最后一个执行 semop 操作的进程的PID。</li><li>GETVAL：返回指定信号量的值。</li><li>GETALL：返回信号量集中所有信号量的值。</li><li>GETNCNT：返回正在等待信号量增加的进程数。</li><li>GETZCNT：返回正在等待信号量变为零的进程数。</li><li>SETALL：设置信号量集中所有信号量的值。</li><li>IPC_STAT：获取信号量集的状态信息。</li><li>IPC_SET：设置信号量集的状态信息。</li><li>IPC_RMID：删除信号量集。</li></ul> </li><li>… :是属于可变参参数列表,根据不同的命令有不同的参数;</li></ul> 
<p>函数返回值:</p> 
<ul><li> <p>成功: 根据不同的cmd, 返回不同的结果;</p> </li><li> 
  <blockquote> 
   <p>GETPID：返回等待最后一个 semop 操作的进程的 PID。</p> 
   <p>GETVAL：返回指定信号量的值。<br> ls<br> GETALL：如果成功，返回 0。</p> 
   <p>GETNCNT：返回正在等待增加信号量值的进程数量。</p> 
   <p>GETZCNT：返回正在等待信号量值为零的进程数量。</p> 
   <p>IPC_STAT：如果成功，返回 0。</p> 
   <p>IPC_SET：如果成功，返回 0。</p> 
   <p>IPC_RMID：如果成功，返回 0。</p> 
   <p>SETVAL：如果成功，返回 0。</p> 
   <p>SETALL：如果成功，返回 0。</p> 
  </blockquote> </li><li> <p>失败: 返回-1, 并设置errno;</p> </li></ul> 
<pre><code class="prism language-c"><span class="token comment">//多进程对stdout资源的竞争</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MSG_PATH</span> <span class="token string">"/home/gopher"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MSG_ID</span> <span class="token expression"><span class="token number">88</span></span></span>

<span class="token keyword">union</span> semun<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> val<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">key_t</span> key<span class="token punctuation">;</span>
    <span class="token comment">//通过文件路径和ID生成key,</span>
    key<span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span>MSG_PATH<span class="token punctuation">,</span>MSG_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ftok()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//创建信号量集合,包含了一个信号量,编号为0</span>
    <span class="token keyword">int</span> semid<span class="token operator">=</span><span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>IPC_CREAT<span class="token operator">|</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>semid<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"semget()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

      <span class="token keyword">union</span> semun s<span class="token punctuation">;</span><span class="token comment">//定义一个联合体,用于设置信号量的值</span>
      s<span class="token punctuation">.</span>val<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//设置信号量的值为1</span>
      <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SETVAL<span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置semid信号集中的第编号为0的信号量的值为1</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"semctl()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_280"></a>信号量操作</h3> 
<ul><li>信号量可以进⾏以下操作: 
  <ul><li>对信号量的值加 1</li><li>对信号量的值减 1</li><li>等待信号量的值为 0</li></ul> </li></ul> 
<p>调用 semop() 函数</p> 
<p>函数头文件:</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>


<span class="token keyword">int</span> <span class="token function">semop</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sembuf</span> <span class="token operator">*</span>sops<span class="token punctuation">,</span> <span class="token class-name">size_t</span> nsops<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数功能:对信号量集合中的信号量进行操作;</p> 
<p>函数参数:</p> 
<ul><li>semid: 信号量集合的ID;</li><li>sops: 信号量操作结构体指针</li><li>nsops: 信号量操作结构体的个数;</li></ul> 
<p>函数返回值:</p> 
<ul><li>成功: 返回 0;</li><li>失败: 返回-1, 并设置errno;</li></ul> 
<blockquote> 
 <p>struct sembuf *sops: 信号量操作结构体指针</p> 
</blockquote> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">sembuf</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token keyword">int</span> sem_num<span class="token punctuation">;</span><span class="token comment">//信号量编号,从0开始</span>
  <span class="token keyword">short</span> <span class="token keyword">int</span> sem_op<span class="token punctuation">;</span>	        <span class="token comment">//信号量操作</span>
                               <span class="token comment">//-1:占用资源</span>
                              <span class="token comment">// +1:释放资源</span>
                              <span class="token comment">// 0:等待资源</span>
  
  <span class="token keyword">short</span> <span class="token keyword">int</span> sem_flg<span class="token punctuation">;</span>		<span class="token comment">//信号量操作标志位</span>
                              <span class="token comment">//IPC_NOWAIT:非阻塞,在信号量的值为0时,立即返回</span>
                              <span class="token comment">// SEM_UNDO:在进程终止时,会自动释放信号量</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<h3><a id="_327"></a>信号量集合删除</h3> 
<p>调用 semctl() 函数 ,设置命令为 IPC_RMID</p> 
<p>在使用 semctl() 函数删除信号量集合时,需要注意第三个参数会被忽略</p> 
<h3><a id="_333"></a>信号量互斥应用</h3> 
<blockquote> 
 <p>使用信号量实现进程间互斥,同一时间只有一个进程访问临界资源</p> 
</blockquote> 
<p>1.创建sem.h</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_mySEM_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_mySEM_H_</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/sem.h&gt;</span></span>

<span class="token comment">//创建信号量集</span>
<span class="token keyword">int</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> names<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//占用信号量</span>
<span class="token keyword">int</span> <span class="token function">sem_p</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span><span class="token keyword">int</span> semnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//释放信号量</span>
<span class="token keyword">int</span> <span class="token function">sem_v</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span><span class="token keyword">int</span> semnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//删除信号量集</span>
<span class="token keyword">int</span> <span class="token function">sem_delete</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* _SEM_H_ */</span></span>
</code></pre> 
<p>2.创建sem.c</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sem.h"</span></span>

<span class="token keyword">union</span> semun <span class="token punctuation">{<!-- --></span>
               <span class="token keyword">int</span>              val<span class="token punctuation">;</span>    <span class="token comment">/* Value for SETVAL */</span>
               <span class="token keyword">struct</span> <span class="token class-name">semid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">;</span>    <span class="token comment">/* Buffer for IPC_STAT, IPC_SET */</span>
               <span class="token keyword">unsigned</span> <span class="token keyword">short</span>  <span class="token operator">*</span>array<span class="token punctuation">;</span>  <span class="token comment">/* Array for GETALL, SETALL */</span>
               <span class="token keyword">struct</span> <span class="token class-name">seminfo</span>  <span class="token operator">*</span>__buf<span class="token punctuation">;</span>  <span class="token comment">/* Buffer for IPC_INFO
                                           (Linux-specific) */</span>
           <span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">//创建信号量集</span>
<span class="token comment">//@param names 信号量集的个数</span>
<span class="token comment">//@param value 信号量集的初始值</span>
<span class="token comment">//@return 成功返回信号量集的id，失败返回-1</span>
<span class="token keyword">int</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> names<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">key_t</span> key<span class="token punctuation">;</span>
    <span class="token comment">//创建key</span>
    key<span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ftok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//创建信号量集</span>
    <span class="token keyword">int</span> semid<span class="token punctuation">;</span>
    semid <span class="token operator">=</span> <span class="token function">semget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>names<span class="token punctuation">,</span>IPC_CREAT<span class="token operator">|</span><span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//参数:key,信号量集的个数,权限</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>semid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"semget"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">union</span> semun s<span class="token punctuation">;</span> <span class="token comment">//定义union semun</span>
    s<span class="token punctuation">.</span>array <span class="token operator">=</span> value<span class="token punctuation">;</span><span class="token comment">//将value数组赋值给union semun的array成员</span>
    <span class="token comment">//初始化信号量集</span>
    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>SETALL<span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这个操作将value数组中的值设置到信号量集中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"semctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> semid<span class="token punctuation">;</span>


<span class="token punctuation">}</span>
    


<span class="token comment">//占用信号量</span>
<span class="token comment">//@param semid 信号量集的id</span>
<span class="token comment">//@param semnum 信号量的编号</span>
<span class="token keyword">int</span> <span class="token function">sem_p</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span><span class="token keyword">int</span> semnum<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">sembuf</span> sem_b<span class="token punctuation">;</span><span class="token comment">//定义一个信号量操作结构体</span>
    sem_b<span class="token punctuation">.</span>sem_num<span class="token operator">=</span>semnum<span class="token punctuation">;</span><span class="token comment">//信号量编号</span>
    sem_b<span class="token punctuation">.</span>sem_op<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//占用资源</span>
    sem_b<span class="token punctuation">.</span>sem_flg<span class="token operator">=</span>SEM_UNDO<span class="token punctuation">;</span><span class="token comment">//在进程终止时,会自动释放信号量</span>
    <span class="token comment">//操作1个信号量,如果操作多个信号量,需要创建sembuf结构体的数组</span>
    <span class="token keyword">int</span> r<span class="token operator">=</span> <span class="token function">semop</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token operator">&amp;</span>sem_b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//失败返回-1,并设置errno   </span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//释放信号量</span>
<span class="token keyword">int</span> <span class="token function">sem_v</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">,</span><span class="token keyword">int</span> semnum<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
 <span class="token keyword">struct</span> <span class="token class-name">sembuf</span> sem_b<span class="token punctuation">;</span><span class="token comment">//定义一个信号量操作结构体</span>
    sem_b<span class="token punctuation">.</span>sem_num<span class="token operator">=</span>semnum<span class="token punctuation">;</span><span class="token comment">//信号量编号</span>
    sem_b<span class="token punctuation">.</span>sem_op<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//释放资源</span>
    sem_b<span class="token punctuation">.</span>sem_flg<span class="token operator">=</span>SEM_UNDO<span class="token punctuation">;</span><span class="token comment">//在进程终止时,会自动释放信号量</span>

    <span class="token keyword">int</span> r<span class="token operator">=</span> <span class="token function">semop</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token operator">&amp;</span>sem_b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//操作1个信号量,如果操作多个信号量,需要创建sembuf结构体的数组</span>
    <span class="token comment">//失败返回-1,并设置errno   </span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//删除信号量集</span>
<span class="token keyword">int</span> <span class="token function">sem_delete</span><span class="token punctuation">(</span><span class="token keyword">int</span> semid<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> r<span class="token operator">=</span> <span class="token function">semctl</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>IPC_RMID<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//删除信号量集</span>
    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3.创建main.c</p> 
<pre><code class="prism language-c"><span class="token comment">// 多进程对stdout资源的竞争</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sem.h"</span></span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">int</span> semid<span class="token punctuation">;</span><span class="token comment">// 信号量ID</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> values<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// 信号量初始值</span>

    semid <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>semid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem_create error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>




    <span class="token class-name">pid_t</span> cpid<span class="token punctuation">;</span><span class="token comment">// 子进程ID</span>

    cpid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建子进程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cpid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fork error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fork失败</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// EXIT_FAILURE表示程序运行失败</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cpid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">// 子进程</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">sem_p</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"C Start.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"C End.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sem_v</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">// 父进程</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">sem_p</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"P Start.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"P End.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"------------------------\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sem_v</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待子进程结束</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4.编译运行</p> 
<pre><code class="prism language-c">
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
P Start<span class="token punctuation">.</span>
P End<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
C Start<span class="token punctuation">.</span>
C End<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
P Start<span class="token punctuation">.</span>
P End<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
C Start<span class="token punctuation">.</span>
C End<span class="token punctuation">.</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
</code></pre> 
<h3><a id="_536"></a>信号量同步应用</h3> 
<p>同步在互斥的基础上增加了进程对临界资源的访问顺序<br> 进程主要的同步与互斥手段是信号量</p> 
<h4><a id="_540"></a>示例:</h4> 
<blockquote> 
 <p>创建⽗⼦进程，输出 “ABA” 字符串，具体需求如下:<br> ⽗进程 输出 A<br> ⼦进程 输出 B<br> ⽗进程 输出 A ，输出换⾏<br> 能够循环输出 “ABA” 字符</p> 
</blockquote> 
<p>基本思路:</p> 
<p>通过创建⼀个信号量集合，包含 2 个信号量，⼀个信号量 编号为 0<br> （SEM_CONTROL_P）控制⽗进程的运⾏与暂停，⼀个信号量 编号为 1<br> （SEM_CONTROL_C） 控制⼦进程的运⾏与暂停</p> 
<pre><code class="prism language-c"><span class="token comment">// 多进程对stdout资源的竞争</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/wait.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sem.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SEM_C</span> <span class="token expression"><span class="token operator">=</span> <span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SEM_P</span> <span class="token expression"><span class="token operator">=</span> <span class="token number">0</span></span></span>
<span class="token comment">// todo 创建一个信号量集合,集合中两个信号量,信号量0的值是1,信号量1的值是0;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">int</span> semid<span class="token punctuation">;</span>                         <span class="token comment">// 信号量ID</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> values<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 信号量初始值</span>
    <span class="token comment">// todo 创建一个信号量集合,集合中两个信号量,信号量编号0的值是1,信号量编号1的值是0;</span>
    semid <span class="token operator">=</span> <span class="token function">sem_create</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>semid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"sem_create error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">pid_t</span> cpid<span class="token punctuation">;</span> <span class="token comment">// 子进程ID</span>

    cpid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建子进程</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cpid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"fork error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fork失败</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// EXIT_FAILURE表示程序运行失败</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cpid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">// 子进程</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">sem_p</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//?占用信号量编号1,信号量编号1的值初始是0 ,在这里阻塞,等待父进程操作</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 刷新缓冲</span>
            <span class="token function">sem_v</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//!释放信号量编号0,信号量编号0的值 0=&gt;1,此时父进程不再阻塞,第二次占用0</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">// 父进程</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//@param semid 信号量集的id</span>
            <span class="token comment">//@param semnum 信号量的编号</span>
            <span class="token function">sem_p</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//?占用信号量编号0,信号量编号0的值 1=&gt;0</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 刷新缓冲</span>
            <span class="token function">sem_v</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//?释放信号量编号1,信号量编号1的值 0=&gt;1,此时子进程不再阻塞</span>
            <span class="token function">sem_p</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//!第二次占用信号量编号0,信号量编号0的值是0,在这里阻塞,等待子进程的操作</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"A\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 刷新缓冲</span>
            <span class="token function">sem_v</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待子进程结束</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token number">0</span>的值 <span class="token number">0</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">,</span>此时父进程不再阻塞<span class="token punctuation">,</span>第二次占用<span class="token number">0</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">// 父进程</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//@param semid 信号量集的id</span>
            <span class="token comment">//@param semnum 信号量的编号</span>
            <span class="token function">sem_p</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//?占用信号量编号0,信号量编号0的值 1=&gt;0</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 刷新缓冲</span>
            <span class="token function">sem_v</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//?释放信号量编号1,信号量编号1的值 0=&gt;1,此时子进程不再阻塞</span>
            <span class="token function">sem_p</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//!第二次占用信号量编号0,信号量编号0的值是0,在这里阻塞,等待子进程的操作</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"A\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 刷新缓冲</span>
            <span class="token function">sem_v</span><span class="token punctuation">(</span>semid<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待子进程结束</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e11f46ce80a971ed77a8830e6e41b590/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">用SpringBoot打造坚固防线：轻松实现XSS攻击防御</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/730b4f3b4c2e16169ec51bc038a8428a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[数据结构] 基于交换的排序 冒泡排序&amp;&amp;快速排序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>