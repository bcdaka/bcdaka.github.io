<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FlinkSQL学习笔记（二）表定义详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/abbc408d338e8432aed71fcc63d9cc78/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="FlinkSQL学习笔记（二）表定义详解">
  <meta property="og:description" content="写在前面 本小节主要说明了FlinkSQL在定义表时候的一些基本规则，其中包括：
1、Catalog为核心的临时表、永久表、视图的关系
2、Table对象和SQL定义表的方式
3、表定义过程中的schema、format、watermark、connector的基本使用方式
4、以kafka connector为例，详细说明了如何建表并获取元数据的过程
【这边并没有按照视频推导，而是按照官方文档自己一步步完成的，这个可以点个赞】
【遇到问题要学会看日志，无论是否为SQL，日志很重要】
难度本身不大，主要在于如何灵活运用，其实本质上在于对于官方文档的使用。
1、表的概述以及类别 表的表示结构
catalog name：元数据空间，常用于标识不同的“源”，比如hive catalog，inner catalog等；使得Flink里面创建的表hive中能查到，但是不一定可以取数，原因在于这里不同的“源”的定义在hive中没有，不一定可以查到。更多细节参考补充说明。
database name：通常语义中的“库”
table name：通常语义中的“表”
表与视图
FlinkSQL中的表，可以是Virtual的（view视图）和regular的（table常规表）
table描述了一个物理上的外部数据源，如文件、数据库表、kafka消息topic
view则基于表创建，代表一个或多个表上的一段计算逻辑（就是对一段查询计划的逻辑封装）
（不管是table还是view，在tableAPI中得到的都是table对象）
临时表与永久表
临时表（视图）：创建时带temporary关键字（create temporary view，create temporary table）；表 schema 只维护在所属 flink session 运行时内存中；当所属的 flink session 结束后表信息将不复存在；且该表无法在 flink session 间共享；
永久表（视图）：创建时不带temporary关键字（create view，create table）；表 schema 可记录在外部持久化的元数据管理器中（比如 hive 的 metastore）；当所属 flink session 结束后，该表信息不会丢失；且在不同 flink session 中都可访问到该表的信息。
注：永久表的元数据如果不持久化，也没有办法持久。
2、表的的定义概述 下面内容简单了解即可，本质上还是对建表API的使用，实际运用过程中注意Stream、Table、SQL之间的切换方式即可。
2.1、基于TableAPI创建[Table对象] 从已存在的表 Table table = tableEnv.from(&#34;test-table&#34;);//通过在env的catalog中注册的表名，获取Table对象//通过在env的catalog中注册的表名，获取Table对象 从 TableDescriptor（连接器/format/schema/options）,本质上还是from方法 Table table = tableEnv.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-24T16:50:02+08:00">
    <meta property="article:modified_time" content="2024-02-24T16:50:02+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">FlinkSQL学习笔记（二）表定义详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>写在前面</h2> 
<p>本小节主要说明了FlinkSQL在定义表时候的一些基本规则，其中包括：<br> 1、Catalog为核心的临时表、永久表、视图的关系<br> 2、Table对象和SQL定义表的方式<br> 3、表定义过程中的schema、format、watermark、connector的基本使用方式<br> 4、以kafka connector为例，详细说明了如何建表并获取元数据的过程<br> 【这边并没有按照视频推导，而是按照官方文档自己一步步完成的，这个可以点个赞】<br> 【遇到问题要学会看日志，无论是否为SQL，日志很重要】<br> 难度本身不大，主要在于如何灵活运用，其实本质上在于对于官方文档的使用。</p> 
<h2><a id="1_11"></a>1、表的概述以及类别</h2> 
<ul><li> <p><strong>表的表示结构</strong><br> catalog name：元数据空间，常用于标识不同的“源”，比如hive catalog，inner catalog等；<strong>使得Flink里面创建的表hive中能查到，但是不一定可以取数，原因在于这里不同的“源”的定义在hive中没有，不一定可以查到</strong>。更多细节参考补充说明。<br> database name：通常语义中的“库”<br> table name：通常语义中的“表”</p> </li><li> <p><strong>表与视图</strong><br> FlinkSQL中的表，可以是Virtual的（view视图）和regular的（table常规表）<br> table描述了一个物理上的外部数据源，如文件、数据库表、kafka消息topic<br> view则基于表创建，代表一个或多个表上的一段计算逻辑（就是对一段查询计划的逻辑封装）<br> （不管是table还是view，在tableAPI中得到的都是table对象）</p> </li><li> <p><strong>临时表与永久表</strong><br> 临时表（视图）：创建时带temporary关键字（create temporary view，create temporary table）；<strong>表 schema 只维护在所属 flink session 运行时内存中</strong>；当所属的 flink session 结束后表信息将不复存在；且该表无法在 flink session 间共享；<br> 永久表（视图）：创建时不带temporary关键字（create view，create table）；<strong>表 schema 可记录在外部持久化的元数据管理器中（比如 hive 的 metastore）</strong>；当所属 flink session 结束后，该表信息不会丢失；且在不同 flink session 中都可访问到该表的信息。<br> <strong>注：永久表的元数据如果不持久化，也没有办法持久。</strong></p> </li></ul> 
<h2><a id="2_28"></a>2、表的的定义概述</h2> 
<p>下面内容简单了解即可，本质上还是对建表API的使用，实际运用过程中注意Stream、Table、SQL之间的切换方式即可。</p> 
<h3><a id="21TableAPITable_30"></a>2.1、基于TableAPI创建[Table对象]</h3> 
<ul><li>从已存在的表</li></ul> 
<pre><code class="prism language-java"><span class="token class-name">Table</span> table <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"test-table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过在env的catalog中注册的表名，获取Table对象//通过在env的catalog中注册的表名，获取Table对象</span>
</code></pre> 
<ul><li>从 TableDescriptor（连接器/format/schema/options）,本质上还是from方法</li></ul> 
<pre><code class="prism language-java"><span class="token class-name">Table</span> table <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token class-name">TableDescriptor</span>
        <span class="token punctuation">.</span><span class="token function">forConnector</span><span class="token punctuation">(</span><span class="token string">"kafka"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"gender"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token string">"testTopic"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"properties.bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"192.168.247.129:9092"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"properties.group.id"</span><span class="token punctuation">,</span> <span class="token string">"testGroup"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"scan.startup.mode"</span><span class="token punctuation">,</span> <span class="token string">"earliest-offset"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"json.fail-on-missing-field"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"json.ignore-parse-errors"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>从 DataStream获取<br> 这里 自动推断 schema（反射手段），如果需要自定义的话，看看<code>Schema</code>的使用或许是一个很不错的选择，通过SQL创建的篇章里面给了一个简单的例子。</li></ul> 
<pre><code class="prism language-java"><span class="token class-name">DataBean</span> bean1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataBean</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"s1"</span><span class="token punctuation">,</span> <span class="token string">"e1"</span><span class="token punctuation">,</span> <span class="token string">"pg1"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DataBean</span> bean2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataBean</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"s2"</span><span class="token punctuation">,</span> <span class="token string">"e3"</span><span class="token punctuation">,</span> <span class="token string">"pg1"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBean</span><span class="token punctuation">&gt;</span></span> dataStream1 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>bean1<span class="token punctuation">,</span> bean2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>从 Table对象上的查询 api生成<br> 通过 Table上调用查询 api，生成新的 Table对象（本质上就是 view）</li></ul> 
<pre><code class="prism language-java"><span class="token class-name">Table</span> table <span class="token operator">=</span> table3<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token string">"guid"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"uuid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>从测试数据</li></ul> 
<pre><code class="prism language-java"><span class="token class-name">Table</span> table2 <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromValues</span><span class="token punctuation">(</span>
       <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">ROW</span><span class="token punctuation">(</span>
               <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">FIELD</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">FIELD</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"jack"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="22TableSQLTable_77"></a>2.2、基于TableSQL创建[不返回Table对象]</h3> 
<ul><li>从已存在的dataStream注册</li></ul> 
<pre><code class="prism language-java">tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">,</span>table2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>从已存在的Table对象注册</li></ul> 
<pre><code class="prism language-java">tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">,</span>table2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>从TableDescriptor（连接器）注册</li></ul> 
<pre><code class="prism language-java"><span class="token class-name">DataBean</span> bean1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataBean</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"s1"</span><span class="token punctuation">,</span> <span class="token string">"e1"</span><span class="token punctuation">,</span> <span class="token string">"pg1"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DataBean</span> bean2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataBean</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"s1"</span><span class="token punctuation">,</span> <span class="token string">"e1"</span><span class="token punctuation">,</span> <span class="token string">"pg1"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DataStreamSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBean</span><span class="token punctuation">&gt;</span></span> dataStream1 <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>bean1<span class="token punctuation">,</span> bean2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Schema</span> schema <span class="token operator">=</span> <span class="token class-name">Schema<span class="token punctuation">.</span>Builder</span><span class="token punctuation">.</span>column<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tenv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">,</span>dataStream1<span class="token punctuation">,</span>schema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>通过Connector注册</li></ul> 
<pre><code class="prism language-java">tenv<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">,</span> <span class="token class-name">TableDescriptor</span><span class="token punctuation">.</span><span class="token function">forConnector</span><span class="token punctuation">(</span><span class="token string">"filesystem"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">,</span> <span class="token string">"file:///d:/a.txt"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"csv"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"guid"</span><span class="token punctuation">,</span><span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span><span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>执行SQL的DDL语句注册</li></ul> 
<pre><code class="prism language-java">tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span>
         <span class="token string">"	CREATE TABLE KafkaTable (                               "</span>
          <span class="token operator">+</span> <span class="token string">"	  `user_id` BIGINT,                                     "</span>
          <span class="token operator">+</span> <span class="token string">"	  `item_id` BIGINT,                                     "</span>
          <span class="token operator">+</span> <span class="token string">"	  `behavior` STRING,                                    "</span>
          <span class="token operator">+</span> <span class="token string">"	  `ts` TIMESTAMP(3) METADATA FROM 'timestamp'           "</span>
          <span class="token operator">+</span> <span class="token string">"	) WITH (                                                "</span>
          <span class="token operator">+</span> <span class="token string">"	  'connector' = 'kafka',                                "</span>
          <span class="token operator">+</span> <span class="token string">"	  'topic' = 'user_behavior',                            "</span>
          <span class="token operator">+</span> <span class="token string">"	  'properties.bootstrap.servers' = 'localhost:9092',    "</span>
          <span class="token operator">+</span> <span class="token string">"	  'properties.group.id' = 'testGroup',                  "</span>
          <span class="token operator">+</span> <span class="token string">"	  'scan.startup.mode' = 'earliest-offset',              "</span>
          <span class="token operator">+</span> <span class="token string">"	  'format' = 'csv'                                      "</span>
          <span class="token operator">+</span> <span class="token string">"	)                                                       "</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="3catalog_129"></a>3、catalog详解</h2> 
<h3><a id="31catalog_130"></a>3.1、什么是catalog</h3> 
<p><strong>一句话：catalog就是一个元数据空间，简单说就是记录、获取元数据（表定义信息）的实体；</strong><br> flinkSQL在运行时，可以拥有多个catalog，它们由catalogManager模块来注册、管理；<br> CatalogManager中可以注册多个元数据空间；</p> 
<p>flinkSQL环境创建之初，就会初始化一个默认的元数据空间<br> 空间名称：default_catalog<br> 空间实现类：GenericInMemoryCatalog，默认的元数据空间对象<br> <img src="https://images2.imgbox.com/c2/f9/NpPNNowB_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7b/0c/nvwNCJ3b_o.png" alt="在这里插入图片描述"></p> 
<p>元数据空间管理对象：CatalogManager<br> ①：用于记录Session中所有的Catalog<br> ②：初始化一个默认的Catalog<br> ③：初始化用于记录Session中注册的临时表<br> <img src="https://images2.imgbox.com/33/48/W7ncJibs_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32catalog_148"></a>3.2、深入测试catalog</h3> 
<ol><li>注册一个HiveCatalog</li></ol> 
<pre><code class="prism language-java"><span class="token comment">// 创建一个hive元数据空间的实现对象</span>
<span class="token class-name">HiveCatalog</span> hiveCatalog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HiveCatalog</span><span class="token punctuation">(</span><span class="token string">"hive"</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"conf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 将hive元数据空间对象注册到环境中</span>
tableEnv<span class="token punctuation">.</span><span class="token function">registerCatalog</span><span class="token punctuation">(</span><span class="token string">"myHiveCatalog"</span><span class="token punctuation">,</span>hiveCatalog<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>尝试分别在不同的Catalog中创建表、视图、临时表</li></ol> 
<pre><code class="prism language-java"><span class="token comment">//1、尝试在HiveCatalog中建表</span>
tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"CREATE TABLE IF NOT EXISTS myHiveCatalog.`default`.t_kafka (...)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//2、默认在DefaultCatalog中建表</span>
tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"CREATE TABLE t_kafka2 (...)  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//3、在HiveCatalog中创建视图</span>
tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"CREATE VIEW IF NOT EXISTS myHiveCatalog.`default`.t_kafka_view ..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//4、创建临时表，指定HiveCatalog</span>
tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"create temporary table myHiveCatalog.`default`.test_temporary_hive..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>查看CatalogManager，得到Catalog的结果，临时表单独存在在temporaryTables<br> <img src="https://images2.imgbox.com/b0/0e/8kocWINj_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="33_173"></a>3.3、临时表与永久表的底层差异</h3> 
<p>结论1：如果使用hive元数据空间窗口表、视图，则：</p> 
<ul><li>永久表（视图）的元信息，都会被写入 hive的元数据管理器中，从而可以实现永久存在</li><li>临时表（视图）的元信息，并不会写入 hive的元数据管理其中，而是放在 catalogManager的一个 temporaryTables的内存 hashmap中记录</li><li>临时表空间中的表名（全名）如果与 hive空间中的表名相同，则查询时会优先选择临时表空间的表</li></ul> 
<p>结论 2：如果选择 GenericInMemoryCatalog元数据空间来创建表、视图，则：</p> 
<ul><li>永久表（视图）的元信息，都会被写入 GenericInMemoryCatalog的元数据管理器中（内存中）</li><li>临时表（视图）的元信息，放在 catalogManager的一个 temporaryTables的内存 hashmap中记录</li><li>无论永久还是临时，当 flink的运行 session结束后，所创建的表（永久、临时）都将不复存在</li></ul> 
<h3><a id="34hive_catalog_184"></a>3.4、如何理解hive catalog</h3> 
<p>注：本质区别，这也说明之前为啥有的时候进行查询的时候需要切换查询引擎<br> <code>flinksql利用 hive catalog来建表（查询、修改、删除表），本质上只是利用了 hive的 metastore服务；</code><br> 更具体来说，flinksql只是把 flinksql的表定义信息，按照 hive元数据的形式，托管到 hive的 metastore中而已！<br> 当然，hive中也能看到这些托管的表信息，但是，并不能利用它底层的 mapreduce或者 spark引擎来查询这些表；<br> <code>因为 mapreduce或者 spark引擎，并不能理解 flinksql表定义中的信息，也无法为这些定义信息提供相应的组件去读取数据（比如，mr或者 spark就没有 flinksql中的各种 connector组件)</code></p> 
<h2><a id="4_190"></a>4、表定义详解</h2> 
<h3><a id="41schema_191"></a>4.1、schema字段定义详解</h3> 
<ul><li><strong>physical column</strong>，物理字段：源自于“外部存储”系统本身 schema中的字段<br> 如 kafka消息的 key、value（json格式）中的字段；mysql表中的字段；hive表中的字段；parquet文件中的字段……</li><li><strong>computed column</strong>，表达式字段（逻辑字段）：在物理字段上施加一个 sql表达式，并将表达式结果定义为一个字段</li><li><strong>metadata column</strong>，<code>元数据字段：来源于 connector从外部存储系统中获取到的“外部系统元信息”</code>。比如，kafka的消息，通常意义上的数据内容是在 record的 key和 value中的，而实质上（底层角度来看），<code>kafka中的每一条 record，不光带了 key和 value数据内容，还带了这条 record所属的 topic，所属的 partition，所在的 offset，以及 record的 timetamp和 timestamp类型等“元信息”</code>,而 flink的 connector可以获取并暴露这些元信息，并允许用户将这些信息定义成 flinksql表中的字段；</li><li><strong>主键约束</strong>：flinkSQL本身也支持主键约束，这个目前没有用到，感觉应该可以类别Mysql的主键约束理解。</li></ul> 
<h3><a id="42format_198"></a>4.2、format组件</h3> 
<p>connector连接器在对接外部存储时，根据外部存储中的数据格式不同，需要用到不同的 format组件；<br> <code>format组件的作用就是：告诉连接器，如何解析外部存储中的数据及映射到表 schema</code><br> 这里列举常见的两种format<br> <strong>json</strong></p> 
<ul><li>flink官网文档：<a href="https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/connectors/table/formats/json/" rel="nofollow">https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/connectors/table/formats/json/</a></li><li>假定有如下的json格式的数据：<code>{"id":1,"friends":[{"name":"a","info":{"addr":"bj","gender":"male"}},{"name":"b","info":{"addr":"sh","gender":"female"}}]}</code></li><li>flinkSQL语句</li></ul> 
<pre><code class="prism language-java">tableEnvironment<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span>
         <span class="token string">" CREATE TABLE t_json(										   "</span>
                <span class="token operator">+</span> <span class="token string">" 	id	INT,                                                   "</span>
                <span class="token operator">+</span> <span class="token string">" 	friends	ARRAY&lt;ROW&lt;name STRING,info MAP&lt;STRING,STRING&gt;&gt;&gt;    "</span>
                <span class="token operator">+</span> <span class="token string">"                                                                "</span>
                <span class="token operator">+</span> <span class="token string">" )WITH(                                                         "</span>
                <span class="token operator">+</span> <span class="token string">" 	'connector' = 'filesystem',                                "</span>
                <span class="token operator">+</span> <span class="token string">" 	'path' = 'input/json',                                     "</span>
                <span class="token operator">+</span> <span class="token string">" 	'format' = 'json'                                          "</span>
                <span class="token operator">+</span> <span class="token string">" )                                                              "</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnvironment<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"DESC t_json"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnvironment<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span>
         <span class="token string">"  SELECT id                                               "</span>
                <span class="token operator">+</span> <span class="token string">" 	  , friend.name                                      "</span>
                <span class="token operator">+</span> <span class="token string">" 	  , friend.info['gender']                            "</span>
                <span class="token operator">+</span> <span class="token string">" 	  , friend.info['addr']                              "</span>
                <span class="token operator">+</span> <span class="token string">"    FROM t_json,                                          "</span>
                <span class="token operator">+</span> <span class="token string">"    UNNEST(friends)   AS friend                           "</span>

<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>控制台输出<br> <img src="https://images2.imgbox.com/ec/3a/WQz58HeN_o.png" alt="在这里插入图片描述"></li></ul> 
<p><strong>csv</strong></p> 
<ul><li>flink官网文档：<a href="https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/connectors/table/formats/csv/" rel="nofollow">https://nightlies.apache.org/flink/flink-docs-release-1.15/docs/connectors/table/formats/csv/</a></li><li>假定数据格式如下：<br> <code>|1|,|zs|,|18|</code><br> <code>#哈哈哈哈</code><br> <code>|2|,|ls|,|20|</code><br> <code>|3|,|ww|,\N</code></li><li>flinkSQL语句</li></ul> 
<pre><code class="prism language-java">tableEnvironment<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span>
         <span class="token string">" CREATE TABLE t_csv (										   "</span>
                <span class="token operator">+</span> <span class="token string">" 	id	 INT,                                                  "</span>
                <span class="token operator">+</span> <span class="token string">" 	name STRING,                                               "</span>
                <span class="token operator">+</span> <span class="token string">" 	age  INT                                                   "</span>
                <span class="token operator">+</span> <span class="token string">"                                                                "</span>
                <span class="token operator">+</span> <span class="token string">" )WITH(                                                         "</span>
                <span class="token operator">+</span> <span class="token string">" 	'connector' = 'filesystem',                                "</span>
                <span class="token operator">+</span> <span class="token string">" 	'path' = 'input/csv',                                      "</span>
                <span class="token operator">+</span> <span class="token string">" 	'format' = 'csv',                                          "</span>
                <span class="token operator">+</span> <span class="token string">" 	'csv.quote-character' = '|',                               "</span>
                <span class="token operator">+</span> <span class="token string">" 	'csv.ignore-parse-errors' = 'true',                        "</span>
                <span class="token operator">+</span> <span class="token string">" 	'csv.allow-comments' = 'true',                             "</span>
                <span class="token operator">+</span> <span class="token string">" 	'csv.null-literal' = '\\N',                                "</span>
                <span class="token operator">+</span> <span class="token string">" 	'format' = 'csv'                                           "</span>
                <span class="token operator">+</span> <span class="token string">" )                                                              "</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>



tableEnvironment<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"DESC t_csv"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnvironment<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span>
         <span class="token string">"  SELECT id                                               "</span>
                <span class="token operator">+</span> <span class="token string">" 	  , name                                             "</span>
                <span class="token operator">+</span> <span class="token string">" 	  , age                                              "</span>
                <span class="token operator">+</span> <span class="token string">"    FROM t_csv                                            "</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>控制台输出<br> <img src="https://images2.imgbox.com/24/a1/nCRdl7Np_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="43_watermarktime_278"></a>4.3、 watermark与time属性详解</h3> 
<p>时间属性定义，主要是用于各类基于时间的运算操作（如基于时间窗口的查询计算）</p> 
<h4><a id="431_280"></a>4.3.1、定义水位线</h4> 
<ul><li> <p>表定义<br> 注：这里的时间类型必须为Timestamp<br> <img src="https://images2.imgbox.com/8a/6d/h4PVCoQ1_o.png" alt="在这里插入图片描述"></p> </li><li> <p>查询结果<br> <img src="https://images2.imgbox.com/0e/c0/3nqjnus6_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h4><a id="432_WaterMark_287"></a>4.3.2、表与流之间 WaterMark</h4> 
<p>WaterMark和转换之前的WaterMark计算规则保持一致</p> 
<ul><li><strong>流转表</strong><br> 流转表的过程中，无论“源流”是否存在 watermark，都不会自动传递 watermark<br> 如需时间运算（如时间窗口等），<code>需要在转换定义中显式声明 watermark策略</code> 
  <ol><li>先设法定义一个 timestamp(3)或者 timestamp_ltz(3)类型的字段（可以来自于数据字段，也可以来自于一个元数据： rowtime<br> <img src="https://images2.imgbox.com/04/71/2nhfxqA3_o.png" alt="在这里插入图片描述"></li><li>然后基于该字段，用 watermarkExpression声明 watermark策略<br> <img src="https://images2.imgbox.com/35/9d/zNYCAcoY_o.png" alt="在这里插入图片描述"></li></ol> </li><li><strong>表转流</strong><br> <code>前提：源表定义了 wartermark策略；</code><br> 则将表转成流时，将会自动传递源表的 watermark；<br> <img src="https://images2.imgbox.com/ea/e9/0XvZQOE8_o.png" alt="在这里插入图片描述"></li></ul> 
<h3><a id="44connector_300"></a>4.4、connector详解</h3> 
<p>connector常是用于对接外部存储建表（源表或目标表）时的映射器、桥接器；<br> <code>connector本质上是对 flink的 table source /table sink算子的封装；</code>参考链接：<a href="https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/overview/" rel="nofollow">https://nightlies.apache.org/flink/flink-docs-release-1.18/docs/connectors/table/overview/</a></p> 
<p>连机器使用的核心要素：</p> 
<ul><li>导入连接器 jar包依赖</li><li>指定连接器类型名</li><li>指定连接器所需的参数（不同连接器有不同的参数配置），如：format</li><li>获取连接器所提供的元数据，如：schema</li></ul> 
<p>Flink支持的连接器有很多种，包括：Filesystem、Elasticsearch、MongoDB、Apache Kafka、Apache HBase…</p> 
<p><strong>以kafka连接器举例说明其在FlinkSQL中的过程</strong>：</p> 
<ol><li>可以获取的元数据<br> <img src="https://images2.imgbox.com/f1/96/vPOtxiA0_o.png" alt="在这里插入图片描述"></li><li>假定kafka中存在如下数据</li></ol> 
<pre><code class="prism language-java"><span class="token comment">// 创建生产者实例</span>
<span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建消息，并添加头部信息</span>
<span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span><span class="token string">"connector_test"</span><span class="token punctuation">,</span>
        <span class="token string">"{\"k1\":13,\"k2\":23}"</span><span class="token punctuation">,</span>
        <span class="token string">"{\"k1\":\"value_1\",\"k2\":\"value_2\",\"eventID\":\"002\",\"eventTime\":1708759402246}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
record<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"head1"</span><span class="token punctuation">,</span> <span class="token string">"headValue1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 发送消息</span>
producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 关闭生产者</span>
producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>存在的问题：</p> 
<ul><li>kafka的消息中有 json格式的 key（key内容需要映射到表 schema中）</li><li>kafka的消息中有 json格式的 value（value内容需要映射到表 schema中）</li><li>key和 value的 json数据内容中还有同名的字段</li><li>kafka的消息中有 header（header内容需要映射到表 schema中）</li></ul> 
<ol start="3"><li>创建FlinkSQL表<br> 不带key开头的format默认只对value生效：<br> <img src="https://images2.imgbox.com/39/5a/G9kMreiM_o.png" alt="在这里插入图片描述"></li></ol> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> KafkaSourceTable <span class="token punctuation">(</span>						 
  <span class="token identifier"><span class="token punctuation">`</span>meta_time<span class="token punctuation">`</span></span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> METADATA <span class="token keyword">FROM</span> <span class="token string">'timestamp'</span><span class="token punctuation">,</span>   
  <span class="token identifier"><span class="token punctuation">`</span>partition<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span> METADATA VIRTUAL<span class="token punctuation">,</span>                  
  <span class="token identifier"><span class="token punctuation">`</span>offset<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span> METADATA VIRTUAL<span class="token punctuation">,</span>                     
  <span class="token identifier"><span class="token punctuation">`</span>headers<span class="token punctuation">`</span></span> MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span>BYTES<span class="token operator">&gt;</span> METADATA <span class="token keyword">FROM</span> <span class="token string">'headers'</span>   
  <span class="token identifier"><span class="token punctuation">`</span>inKey_k1<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>                                    
  <span class="token identifier"><span class="token punctuation">`</span>inKey_k2<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>                                    
  <span class="token identifier"><span class="token punctuation">`</span>k1<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>                                          
  <span class="token identifier"><span class="token punctuation">`</span>K2<span class="token punctuation">`</span></span> STRING<span class="token punctuation">,</span>                                          
  <span class="token identifier"><span class="token punctuation">`</span>eventTime<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>                                   
  <span class="token identifier"><span class="token punctuation">`</span>eventID<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span>                                      
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>                                                
  <span class="token string">'connector'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span>                                
  <span class="token string">'topic'</span> <span class="token operator">=</span> <span class="token string">'connector_test'</span><span class="token punctuation">,</span>                           
  <span class="token string">'properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'123.56.100.37:9092'</span><span class="token punctuation">,</span>
  <span class="token string">'properties.group.id'</span> <span class="token operator">=</span> <span class="token string">'testGroup'</span><span class="token punctuation">,</span>                  
  <span class="token string">'scan.startup.mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span>              
  <span class="token string">'format'</span> <span class="token operator">=</span> <span class="token string">'json'</span><span class="token punctuation">,</span>                                    
  <span class="token string">'json.ignore-parse-errors'</span> <span class="token operator">=</span> <span class="token string">'true'</span><span class="token punctuation">,</span>                  
  <span class="token string">'json.fail-on-missing-field'</span> <span class="token operator">=</span> <span class="token string">'true'</span><span class="token punctuation">,</span>                
  <span class="token string">'key.fields'</span><span class="token operator">=</span><span class="token string">'inKey_k1;inKey_k2'</span><span class="token punctuation">,</span>                     
  <span class="token string">'key.fields-prefix'</span> <span class="token operator">=</span> <span class="token string">'inKey_'</span><span class="token punctuation">,</span>                       
  <span class="token string">'value.fields-include'</span> <span class="token operator">=</span> <span class="token string">'EXCEPT_KEY'</span>                 
<span class="token punctuation">)</span><span class="token punctuation">;</span>   
</code></pre> 
<ol start="4"><li>执行结果<br> <img src="https://images2.imgbox.com/d0/23/gXck0TWd_o.png" alt="在这里插入图片描述"></li></ol>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2096f9fd4c57891fc5d92e1139aad6b2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">计算广告中涉及的设备id：oaid、androidid、imei、idfa、caid</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4c28ec8d384a26b6a1e8c7988616543b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">分享前端第三方组件库官网</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>