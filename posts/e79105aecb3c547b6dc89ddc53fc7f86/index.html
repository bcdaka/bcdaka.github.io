<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title># 利刃出鞘_Tomcat 核心原理解析（十一）-- WebSocket -- 1 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/e79105aecb3c547b6dc89ddc53fc7f86/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="# 利刃出鞘_Tomcat 核心原理解析（十一）-- WebSocket -- 1">
  <meta property="og:description" content="利刃出鞘_Tomcat 核心原理解析（十一）-- Tomcat 附加功能 WebSocket – 1 一、Tomcat专题 - WebSocket - 介绍 1、Tomcat 附加功能：websocket 介绍 1）websocket ：是 HTML5 新增的协议，它的目的是在浏览器和服务器之间建立一个不受限的双向通信的通道,
比如说，服务器可以在任意时刻发送消息给浏览器。
2）为什么传统的 HTTP 协议不能做到 websocket 实现的功能?
这是因为 HTTP 协议是一个请求-响应协议，请求必须先由浏览器发给服务器服务器才能响应这个请求，再把数据发送给浏览器。
换句话说，浏览器不主动请求，服务器是没法主动发数据给浏览器的,
这样一来，要在浏览器中搞一个实时聊天，或者在线多人游戏的话就没法实现了，只能借助 Elash 这些插件，
3）也有人说，HTTP 协议其实也能实现啊，比如用轮询或者 comet。
轮询：是指浏览器通过 Javascript 启动一个定时器,然后以固定的间隔给服务器发请求,询问服务器有没有新消息。
这个机制的缺点一是实时性不够，二是频繁的请求会给服务器带来极大的压力。
comet 本质上也是轮询，但是在没有消息的情况下，服务器先拖一段时间,等到有消息了再回复，这个机制暂时地解决了实时性问题，
但是它带来了新的问题:
以多线程模式运行的服务器会让大部分线程大部分时间都处于挂起状态，极大地浪费服务器资源。
另外，一个 HTTP 连接在长时间没有数据传输的情况下，链路上的任何一个网关都可能关闭这个连接,
而网关是我们不可控的，这就要求 comet 连接必须定期发一些 ping 数据表示连接“正常工作&#34;。
2、以上两种机制都治标不治本，所以，HTML5 推出了 websocket 标准,让浏览器和服务器之间可以建立无限制的全双工通信，任何一方都可以主动发消息给对方。websocket 并不是全新的协议，而是利用了 HTTP 协议来建立连接。 3、websocket 连接是如何创建的。 1）首先，websocket连接必须由浏览器发起，因为请求协议是一个标准的HTTP请求，格式如下:
2）该请求和普通的HTTP请求有几点不同:
1.GET请求的地址不是类似 http://,而是以 ws:// 开头的地址;2.请求头 connection:upgrade 和 请求头 upgrade:websocket 表示这个连接将要被转换为 websocket 连接;3.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-09-02T15:06:50+08:00">
    <meta property="article:modified_time" content="2024-09-02T15:06:50+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title"># 利刃出鞘_Tomcat 核心原理解析（十一）-- WebSocket -- 1</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_Tomcat__Tomcat__WebSocket__1_0"></a>利刃出鞘_Tomcat 核心原理解析（十一）-- Tomcat 附加功能 WebSocket – 1</h2> 
<h3><a id="Tomcat__WebSocket___2"></a>一、Tomcat专题 - WebSocket - 介绍</h3> 
<h4><a id="1Tomcat_websocket__4"></a>1、Tomcat 附加功能：websocket 介绍</h4> 
<p>1）websocket ：是 HTML5 新增的协议，它的目的是在浏览器和服务器之间建立一个不受限的双向通信的通道,<br> 比如说，服务器可以在任意时刻发送消息给浏览器。</p> 
<p>2）为什么传统的 HTTP 协议不能做到 websocket 实现的功能?</p> 
<ul><li> <p>这是因为 HTTP 协议是一个请求-响应协议，请求必须先由浏览器发给服务器服务器才能响应这个请求，再把数据发送给浏览器。<br> 换句话说，浏览器不主动请求，服务器是没法主动发数据给浏览器的,</p> </li><li> <p>这样一来，要在浏览器中搞一个实时聊天，或者在线多人游戏的话就没法实现了，只能借助 Elash 这些插件，</p> </li></ul> 
<p>3）也有人说，HTTP 协议其实也能实现啊，比如用轮询或者 comet。</p> 
<ul><li> <p>轮询：是指浏览器通过 Javascript 启动一个定时器,然后以固定的间隔给服务器发请求,询问服务器有没有新消息。<br> 这个机制的缺点一是实时性不够，二是频繁的请求会给服务器带来极大的压力。</p> </li><li> <p>comet 本质上也是轮询，但是在没有消息的情况下，服务器先拖一段时间,等到有消息了再回复，这个机制暂时地解决了实时性问题，</p> </li></ul> 
<p>但是它带来了新的问题:</p> 
<p>以多线程模式运行的服务器会让大部分线程大部分时间都处于挂起状态，极大地浪费服务器资源。<br> 另外，一个 HTTP 连接在长时间没有数据传输的情况下，链路上的任何一个网关都可能关闭这个连接,<br> 而网关是我们不可控的，这就要求 comet 连接必须定期发一些 ping 数据表示连接“正常工作"。</p> 
<p><img src="https://images2.imgbox.com/12/cc/DvWTDyu7_o.png" alt="tomcat-67.png"></p> 
<h4><a id="2HTML5__websocket_websocket__HTTP__32"></a>2、以上两种机制都治标不治本，所以，HTML5 推出了 websocket 标准,让浏览器和服务器之间可以建立无限制的全双工通信，任何一方都可以主动发消息给对方。websocket 并不是全新的协议，而是利用了 HTTP 协议来建立连接。</h4> 
<p><img src="https://images2.imgbox.com/5d/4c/LMtoOWzQ_o.png" alt="tomcat-68.png"></p> 
<h4><a id="3websocket__37"></a>3、websocket 连接是如何创建的。</h4> 
<p>1）首先，websocket连接必须由浏览器发起，因为请求协议是一个标准的HTTP请求，格式如下:</p> 
<p><img src="https://images2.imgbox.com/d0/64/wt1yFfN3_o.png" alt="tomcat-69.png"></p> 
<p>2）该请求和普通的HTTP请求有几点不同:</p> 
<ul><li>1.GET请求的地址不是类似 http://,而是以 ws:// 开头的地址;</li><li>2.请求头 connection:upgrade 和 请求头 upgrade:websocket 表示这个连接将要被转换为 websocket 连接;</li><li>3.sec-websocket-Key 是用于标识这个连接， 是一个BASE64编码的密文，要求服务端响应一个对应加密的sec-websocket-Accept头信息作为应答。</li><li>4.sec-websocket-version 指定了 websocket 的协议版本;</li><li>5.HTTP101 状态码表明服务端已经识别并切换为 Websocket 协议，sec-websocket-Accept 是服务端与客户端一致的秘钥计算出来的信息。</li></ul> 
<h3><a id="Tomcat__WebSocket__Tomcat_52"></a>二、Tomcat专题 - WebSocket - Tomcat的支持</h3> 
<h4><a id="1Tomcat__Websocket_54"></a>1、Tomcat 的 Websocket</h4> 
<p>Tomcat 的 7.0.5 版本开始支持 websocket,并且实现了 Java websocket 规范(JSR356)，而在7.0.5版本之前(7.0.2之后)则采用自定义 API，即 websocketservlet 实现。</p> 
<h4><a id="2Java_websocket__nebsocketEndpoint_Endpoint__Java__websocket__websocket__servlet__http__58"></a>2、Java websocket 应用由一系列的 nebsocketEndpoint 组成。Endpoint 是一个 Java 对象,代表 websocket 链接的一端,对于服务端，可以视为处理具体 websocket 消息的接口，就像 servlet 之与 http 请求一样。</h4> 
<h4><a id="3_Endpoint_60"></a>3、可以通过两种方式定义 Endpoint:</h4> 
<p>1）第一种是编程式，即继承类 javax.websocket.Endpoint 并实现其方法。</p> 
<p>2）第二种是注解式，即定义一个POJO，并添加 @serverEndpoint 相关注解。</p> 
<h4><a id="4Endpoint__websocket__Endpoint___66"></a>4、Endpoint 实例在 websocket 握手时创建,并在客户端与服务端链接过程中有效，最后在链接关闭时结束，在 Endpoint 接口中明确定义了与其生命周期相关的方法， 规范实现者确保生命周期的各个阶段调用实例的相关方法。生命周期方法如下:</h4> 
<table><thead><tr><th>方法</th><th>含义描述</th><th>注解</th><th></th></tr></thead><tbody><tr><td>onOpen</td><td>当开启一个新的会话时调用，该方法是客户端与服务端握手成功后调用的方法。</td><td>@onopen</td><td></td></tr><tr><td>onClose</td><td>当会话关闭时调用。</td><td>@onClose</td><td></td></tr><tr><td>onError</td><td>当连接过程中异常时调用。</td><td>@onError</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table> 
<h4><a id="5____75"></a>5、编程式 和 注解式 接收和发送消息。</h4> 
<ul><li>编程式通过为 session 添加 Messagexandler 消息处理器来接收消息。</li><li>采用注解方式定义 Endpoint 时，可以通过 @onMessage 注解指定接收消息的方法。发送消息则由 RemoteEndpoint 完成，其实例由 session 维护。</li><li>根据使用情况， 可以通过 session.getBasicRemote 获取同步消息发送的实例，然后调用其 sendxxx() 方法就可以发送消息，可以通过 session.getAsyncRemote 获取异步消息发送实例。</li></ul> 
<h4><a id="6apachetomcat8542srcjavajavaxwebsocketEndpointjava__81"></a>6、…\apache-tomcat-8.5.42-src\java\javax\websocket\Endpoint.java 类，源码：</h4> 
<pre><code class="prism language-bash">
package javax.websocket<span class="token punctuation">;</span>

public abstract class Endpoint <span class="token punctuation">{<!-- --></span>

    public abstract void onOpen<span class="token punctuation">(</span>Session session, EndpointConfig config<span class="token punctuation">)</span><span class="token punctuation">;</span>

    public void onClose<span class="token punctuation">(</span>Session session, CloseReason closeReason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        // NO-OP by default
    <span class="token punctuation">}</span>

    public void onError<span class="token punctuation">(</span>Session session, Throwable throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        // NO-OP by default
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="_Tomcat__WebSocket_____102"></a>三、 Tomcat专题 - WebSocket - 案例 - 需求及流程分析</h3> 
<h4><a id="1WebSocket_DEMO__websocket__104"></a>1、WebSocket DEMO 案例需求：通过 websocket 实现一个简易的聊天室功能。</h4> 
<p><img src="https://images2.imgbox.com/4c/51/ibe1ATTN_o.png" alt="tomcat-70.png"></p> 
<h4><a id="2WebSocket_DEMO__107"></a>2、WebSocket DEMO 案例流程</h4> 
<p>1）登录聊天室</p> 
<p>2）登录后，进入聊天界面，进行聊天。</p> 
<p>3）用户1 聊天界面，用户2 聊天界面。</p> 
<p>4）好友列表、单独聊天模式与广播模式。</p> 
<p><img src="https://images2.imgbox.com/56/5b/Vhi6xZG2_o.png" alt="   tomcat-71.png   "></p> 
<h4><a id="3WebSocket_DEMO___122"></a>3、WebSocket DEMO 案例 实现流程</h4> 
<p><img src="https://images2.imgbox.com/5f/7f/3jKzCEc2_o.png" alt="tomcat-72.png"></p> 
<h4><a id="4_127"></a>4、消息格式</h4> 
<p>客户端 --&gt; 服务端: {“fromName”:“Deng”,“toName”:“HEIMA”,“content”:“约会呀”}</p> 
<p>服务端 --&gt; 客户端：</p> 
<p>1）如果 type 为 user，则说明返回的是用户列表</p> 
<p>{“data” : “HEIMA, Deng, ITCAST” ,“toName” :“” ,“fromName” :“”,“type” :“user” }</p> 
<p>2）如果 type 为 message，则说明返回的是消息内容</p> 
<p>{“data” : “你好” ,“toName” : “HE IMA” , " fromName" : “Deng” ,“type” : “message” }</p> 
<h3><a id="Tomcat__WebSocket_____141"></a>四、Tomcat专题 - WebSocket - 案例 - 准备工作</h3> 
<h4><a id="1_idea___dzs168_chat_room__Web_Application__143"></a>1、打开 idea 创建 名为 dzs168_chat_room 的 Web Application 项目</h4> 
<pre><code class="prism language-java">
	<span class="token operator">--</span><span class="token operator">&gt;</span> idea <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">File</span> 
	<span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">New</span> <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">Project</span> 
	<span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">Java</span> 
		<span class="token class-name">Project</span> <span class="token constant">SDK</span><span class="token operator">:</span> <span class="token punctuation">(</span> <span class="token number">1.</span><span class="token function">8</span><span class="token punctuation">(</span>java version <span class="token string">"1.8.0_131"</span> <span class="token punctuation">)</span> 
	<span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">Java</span> <span class="token constant">EE</span> <span class="token operator">:</span> 勾选 <span class="token punctuation">(</span> <span class="token class-name">Web</span> <span class="token class-name">Application</span> <span class="token punctuation">)</span>
	<span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">Next</span> 

	<span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">Project</span> <span class="token class-name">Name</span><span class="token operator">:</span> <span class="token punctuation">(</span> dzs168_chat_room <span class="token punctuation">)</span>
		<span class="token class-name">Project</span> <span class="token class-name">Location</span><span class="token operator">:</span> <span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\dzs168_chat_room\ <span class="token punctuation">)</span>	
	<span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token class-name">Finish</span>	
</code></pre> 
<h4><a id="2_dzs168_chat_room__dzs168_chat_roomweblib_Add_as_Library_159"></a>2、在项目 dzs168_chat_room 中，导入项目依赖（ dzs168_chat_room/web/lib/ ）,Add as Library…</h4> 
<p>fastjson-1.2.5.jar<br> tomcat-websocket.jar<br> websocket-api.jar</p> 
<h4><a id="3_dzs168_chat_room__166"></a>3、在项目 dzs168_chat_room 中，导入静态资源文件。</h4> 
<p>dzs168_chat_room/web/css/<br> dzs168_chat_room/web/img/<br> dzs168_chat_room/web/js/<br> dzs168_chat_room/web/chat.jsp<br> dzs168_chat_room/web/login.jsp</p> 
<h4><a id="4_dzs168_chat_room__Web__loginjsp_174"></a>4、在项目 dzs168_chat_room 中， Web 应用配置欢迎页面为 login.jsp</h4> 
<p>（project_tomcat\dzs168_chat_room\web\WEB-INF\web.xml）</p> 
<pre><code class="prism language-java">
<span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>web<span class="token operator">-</span>app xmlns<span class="token operator">=</span><span class="token string">"http://xmlns.jcp.org/xml/ns/javaee"</span>
         xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         xsi<span class="token operator">:</span>schemaLocation<span class="token operator">=</span><span class="token string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd"</span>
         version<span class="token operator">=</span><span class="token string">"3.1"</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>welcome<span class="token operator">-</span>file<span class="token operator">-</span>list<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>welcome<span class="token operator">-</span>file<span class="token operator">&gt;</span>login<span class="token punctuation">.</span>jsp<span class="token operator">&lt;</span><span class="token operator">/</span>welcome<span class="token operator">-</span>file<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>welcome<span class="token operator">-</span>file<span class="token operator">-</span>list<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span><span class="token operator">/</span>web<span class="token operator">-</span>app<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> project_tomcat\dzs168_chat_room\web\<span class="token constant">WEB</span><span class="token operator">-</span><span class="token constant">INF</span>\web<span class="token punctuation">.</span>xml <span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> 
<h4><a id="5_dzs168_chat_room__193"></a>5、配置 dzs168_chat_room 应用，进行测试。</h4> 
<pre><code class="prism language-java">
idea <span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token class-name">Run</span><span class="token operator">/</span><span class="token class-name">Debug</span> <span class="token class-name">Configurations</span> 
<span class="token operator">--</span><span class="token operator">-&gt;</span> 点击 应用 <span class="token class-name">Tomcat</span> <span class="token number">8.5</span><span class="token number">.47</span>
<span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token class-name">Deployment</span> 
	删除已经存在的应用。
	<span class="token operator">--</span><span class="token operator">-&gt;</span> 点击 <span class="token operator">+</span> 添加新应用 <span class="token class-name">Artifact</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> ，选择我们的项目 dzs168_chat_room<span class="token punctuation">.</span>war exploded
	<span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token class-name">Application</span> context<span class="token operator">:</span> <span class="token punctuation">(</span> <span class="token operator">/</span> <span class="token punctuation">)</span>
	<span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token class-name">Apply</span> 

<span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token class-name">Server</span>
	<span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token class-name">On</span><span class="token char">'Update'</span>action<span class="token operator">:</span>  <span class="token punctuation">(</span> <span class="token class-name">Update</span> classes and resources <span class="token punctuation">)</span>
	<span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token class-name">On</span> frame deactivation<span class="token operator">:</span> <span class="token punctuation">(</span> <span class="token class-name">Update</span> classes and resources <span class="token punctuation">)</span>
	<span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token class-name">Apply</span> 
<span class="token operator">--</span><span class="token operator">-&gt;</span> <span class="token constant">OK</span> 。

</code></pre> 
<h4><a id="6_tomcat_localhost8080_214"></a>6、运行 tomcat 服务器，自动打开欢迎页面，localhost:8080</h4> 
<p><img src="https://images2.imgbox.com/4c/e4/i8YoeYEt_o.png" alt="在这里插入图片描述"></p> 
<p><code>上一节关联链接请点击</code><br> <a href="https://dzs168.blog.csdn.net/article/details/141774264" rel="nofollow"> 利刃出鞘_Tomcat 核心原理解析（十）-- Tomcat 性能调优–2</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/af44d729f0ed89314687f0e878693984/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MS SQL Server partition by 函数实战三 成绩排名</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9487be26441cfce68aa4c37406ec890a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">springboot 配置ssl支持https</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>