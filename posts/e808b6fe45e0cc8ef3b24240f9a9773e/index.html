<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>分子性质AI预测挑战赛｜Datawahle AI夏令营｜代码分享 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/e808b6fe45e0cc8ef3b24240f9a9773e/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="分子性质AI预测挑战赛｜Datawahle AI夏令营｜代码分享">
  <meta property="og:description" content="赛题背景
在当今科技日新月异的时代，人工智能（AI）技术正以前所未有的深度和广度渗透到科研领域，特别是在化学及药物研发中展现出了巨大潜力。精准预测分子性质有助于高效筛选出具有优异性能的候选药物。以PROTACs为例，它是一种三元复合物由目标蛋白配体、linker、E3连接酶配体组成，靶向降解目标蛋白质。本次大赛聚焦于运用先进的人工智能算法预测其降解效能，旨在激发参赛者创新思维，推动AI技术与化学生物学的深度融合，进一步提升药物研发效率与成功率，为人类健康事业贡献智慧力量。通过此次大赛，我们期待见证并孵化出更多精准、高效的分子性质预测模型，共同开启药物发现的新纪元。
赛事任务与数据
选手根据提供的demo数据集，可以基于demo数据集进行数据增强、自行搜集数据等方式扩充数据集，并自行划分数据。运用深度学习、强化学习或更加优秀人工智能的方法预测PROTACs的降解能力，若DC50&gt;100nM且Dmax&lt;80% ，则视为降解能力较差（demo数据集中Label=0）；若DC50&lt;=100nM或Dmax&gt;=80%，则视为降解能力好（demo数据集中Label=1）。
大白话解释：
【训练分子性质分类预测模型】运用深度学习、强化学习或更加优秀人工智能的方法预测PROTACs的降解能力，分类为 降解能力较差/降解能力好 两种结论
评价指标
本次竞赛的评价标准采用f1_score，分数越高，效果越好
解题思路
参赛选手的任务是基于训练集的样本数据，构建一个模型来预测测试集中分子的性质情况。这是一个二分类任务，其中目标是根据分析相关信息以及结构信息等特征，预测该分子的性质标签。具体来说，选手需要利用给定的数据集进行特征工程、模型选择和训练，然后使用训练好的模型对测试集中的用户进行预测，并生成相应的预测结果。
导入必要的库 import numpy as np import pandas as pd import joblib from catboost import CatBoostClassifier from sklearn.model_selection import StratifiedKFold, KFold, GroupKFold from sklearn.metrics import f1_score from rdkit import Chem from rdkit.Chem import Descriptors,rdMolDescriptors,GraphDescriptors,Lipinski from rdkit.Chem.rdMolDescriptors import CalcMolFormula, CalcTPSA from rdkit.Chem.Crippen import MolLogP from sklearn.feature_extraction.text import TfidfVectorizer from openfe import OpenFE, tree_to_formula, transform, TwoStageFeatureSelector from gensim.models import Word2Vec import tqdm, sys, os, gc, re, argparse, warnings warnings.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-07T12:04:17+08:00">
    <meta property="article:modified_time" content="2024-07-07T12:04:17+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">分子性质AI预测挑战赛｜Datawahle AI夏令营｜代码分享</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>赛题背景</strong><br> 在当今科技日新月异的时代，人工智能（AI）技术正以前所未有的深度和广度渗透到科研领域，特别是在化学及药物研发中展现出了巨大潜力。精准预测分子性质有助于高效筛选出具有优异性能的候选药物。以PROTACs为例，它是一种三元复合物由目标蛋白配体、linker、E3连接酶配体组成，靶向降解目标蛋白质。本次大赛聚焦于运用先进的人工智能算法预测其降解效能，旨在激发参赛者创新思维，推动AI技术与化学生物学的深度融合，进一步提升药物研发效率与成功率，为人类健康事业贡献智慧力量。通过此次大赛，我们期待见证并孵化出更多精准、高效的分子性质预测模型，共同开启药物发现的新纪元。</p> 
<p><strong>赛事任务与数据</strong><br> 选手根据提供的demo数据集，可以基于demo数据集进行数据增强、自行搜集数据等方式扩充数据集，并自行划分数据。运用深度学习、强化学习或更加优秀人工智能的方法预测PROTACs的降解能力，若DC50&gt;100nM且Dmax&lt;80% ，则视为降解能力较差（demo数据集中Label=0）；若DC50&lt;=100nM或Dmax&gt;=80%，则视为降解能力好（demo数据集中Label=1）。<br> 大白话解释：<br> 【训练分子性质分类预测模型】运用深度学习、强化学习或更加优秀人工智能的方法预测PROTACs的降解能力，分类为 降解能力较差/降解能力好 两种结论</p> 
<p><strong>评价指标</strong><br> 本次竞赛的评价标准采用f1_score，分数越高，效果越好</p> 
<p><strong>解题思路</strong><br> 参赛选手的任务是基于训练集的样本数据，构建一个模型来预测测试集中分子的性质情况。这是一个二分类任务，其中目标是根据分析相关信息以及结构信息等特征，预测该分子的性质标签。具体来说，选手需要利用给定的数据集进行特征工程、模型选择和训练，然后使用训练好的模型对测试集中的用户进行预测，并生成相应的预测结果。</p> 
<h2><a id="_13"></a>导入必要的库</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> joblib
<span class="token keyword">from</span> catboost <span class="token keyword">import</span> CatBoostClassifier
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> StratifiedKFold<span class="token punctuation">,</span> KFold<span class="token punctuation">,</span> GroupKFold
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> f1_score
<span class="token keyword">from</span> rdkit <span class="token keyword">import</span> Chem
<span class="token keyword">from</span> rdkit<span class="token punctuation">.</span>Chem <span class="token keyword">import</span> Descriptors<span class="token punctuation">,</span>rdMolDescriptors<span class="token punctuation">,</span>GraphDescriptors<span class="token punctuation">,</span>Lipinski
<span class="token keyword">from</span> rdkit<span class="token punctuation">.</span>Chem<span class="token punctuation">.</span>rdMolDescriptors <span class="token keyword">import</span> CalcMolFormula<span class="token punctuation">,</span> CalcTPSA
<span class="token keyword">from</span> rdkit<span class="token punctuation">.</span>Chem<span class="token punctuation">.</span>Crippen <span class="token keyword">import</span> MolLogP
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_extraction<span class="token punctuation">.</span>text <span class="token keyword">import</span> TfidfVectorizer
<span class="token keyword">from</span> openfe <span class="token keyword">import</span> OpenFE<span class="token punctuation">,</span> tree_to_formula<span class="token punctuation">,</span> transform<span class="token punctuation">,</span> TwoStageFeatureSelector
<span class="token keyword">from</span> gensim<span class="token punctuation">.</span>models <span class="token keyword">import</span> Word2Vec
<span class="token keyword">import</span> tqdm<span class="token punctuation">,</span> sys<span class="token punctuation">,</span> os<span class="token punctuation">,</span> gc<span class="token punctuation">,</span> re<span class="token punctuation">,</span> argparse<span class="token punctuation">,</span> warnings
warnings<span class="token punctuation">.</span>filterwarnings<span class="token punctuation">(</span><span class="token string">'ignore'</span><span class="token punctuation">)</span>
pd<span class="token punctuation">.</span>set_option<span class="token punctuation">(</span><span class="token string">'display.max_rows'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
pd<span class="token punctuation">.</span>set_option<span class="token punctuation">(</span><span class="token string">'display.max_columns'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="10_35"></a>读取数据，删去非空值小于10的列</h2> 
<pre><code class="prism language-python">train <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">'./dataset-new/traindata-new.xlsx'</span><span class="token punctuation">)</span>
test <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">'./dataset-new/testdata-new.xlsx'</span><span class="token punctuation">)</span>

<span class="token comment"># test数据不包含 DC50 (nM) 和 Dmax (%)</span>
train <span class="token operator">=</span> train<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'DC50 (nM)'</span><span class="token punctuation">,</span> <span class="token string">'Dmax (%)'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 定义了一个空列表drop_cols，用于存储在测试数据集中非空值小于10个的列名。</span>
drop_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> f <span class="token keyword">in</span> test<span class="token punctuation">.</span>columns<span class="token punctuation">:</span>
    <span class="token keyword">if</span> test<span class="token punctuation">[</span>f<span class="token punctuation">]</span><span class="token punctuation">.</span>notnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        drop_cols<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

<span class="token comment"># 使用drop方法从训练集和测试集中删除了这些列，以避免在后续的分析或建模中使用这些包含大量缺失值的列</span>
train <span class="token operator">=</span> train<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>drop_cols<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
test <span class="token operator">=</span> test<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>drop_cols<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_59"></a>特征工程</h2> 
<pre><code class="prism language-python"><span class="token comment"># 使用pd.concat将清洗后的训练集和测试集合并成一个名为data的DataFrame，便于进行统一的特征工程处理</span>
data <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>train<span class="token punctuation">,</span> test<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> ignore_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
cols <span class="token operator">=</span> data<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="_68"></a>特征关联性分析</h3> 
<pre><code class="prism language-python">train_label <span class="token operator">=</span> train<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 自然数编码（）</span>
<span class="token keyword">def</span> <span class="token function">label_encode</span><span class="token punctuation">(</span>series<span class="token punctuation">)</span><span class="token punctuation">:</span>
    unique <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>series<span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> series<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>
        unique<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span>series<span class="token punctuation">.</span>nunique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

object_cols <span class="token operator">=</span> train_label<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>include<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'object'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>columns

<span class="token keyword">for</span> col <span class="token keyword">in</span> object_cols<span class="token punctuation">:</span>
    train_label<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> label_encode<span class="token punctuation">(</span>train_label<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">features <span class="token operator">=</span> train_label<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
corr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> feat <span class="token keyword">in</span> features<span class="token punctuation">:</span>
    corr<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>train_label<span class="token punctuation">[</span><span class="token punctuation">[</span>feat<span class="token punctuation">,</span> <span class="token string">"Label"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>corr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

se <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>corr<span class="token punctuation">,</span> index<span class="token operator">=</span>features<span class="token punctuation">)</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">se
</code></pre> 
<pre><code class="prism language-python">data <span class="token operator">=</span> data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>se<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="Smiles_106"></a>提取Smiles特征</h3> 
<p>DeepChem是一个用于科研的机器学习库。DeepChem最初专注于化学分子的研究，但随着版本更迭，现在其已能更广泛地支持所有类型的科学应用。我觉得这个模块做的比较好的几点在于：</p> 
<ul><li>能够方便地将化学分子用统一长度的向量或矩阵表示，便于机器学习数据读入；</li><li>提供方便使用的机器学习接口，你可以不必专门学习机器学习模块（如Tensorflow 、Pytorch等）；</li><li>封装化程度高，上手容易。但对于需要个性化参数调整的需求就不是很方便了，这个时候就需要查阅源码，在理解的基础上进行调整。</li></ul> 
<pre><code class="prism language-python"><span class="token keyword">import</span> deepchem <span class="token keyword">as</span> dc
dc_smiles <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'Smiles'</span><span class="token punctuation">]</span>
rdkit_featurizer <span class="token operator">=</span> dc<span class="token punctuation">.</span>feat<span class="token punctuation">.</span>RDKitDescriptors<span class="token punctuation">(</span><span class="token punctuation">)</span>
rdkit_feature <span class="token operator">=</span> rdkit_featurizer<span class="token punctuation">.</span>featurize<span class="token punctuation">(</span>dc_smiles<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">dc_feature <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>rdkit_feature<span class="token punctuation">)</span>
dc_feature<span class="token punctuation">.</span>columns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f'smiles_dc_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>dc_feature<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python">zeros_count <span class="token operator">=</span> dc_feature<span class="token punctuation">.</span>eq<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
columns_to_drop <span class="token operator">=</span> zeros_count<span class="token punctuation">[</span>zeros_count <span class="token operator">&gt;=</span> <span class="token number">704</span><span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
smiles_feature <span class="token operator">=</span> dc_feature<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span>columns_to_drop<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="InChI_133"></a>提取InChI特征</h3> 
<pre><code class="prism language-python">atomic_masses <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'H'</span><span class="token punctuation">:</span> <span class="token number">1.008</span><span class="token punctuation">,</span> <span class="token string">'He'</span><span class="token punctuation">:</span> <span class="token number">4.002602</span><span class="token punctuation">,</span> <span class="token string">'Li'</span><span class="token punctuation">:</span> <span class="token number">6.94</span><span class="token punctuation">,</span> <span class="token string">'Be'</span><span class="token punctuation">:</span> <span class="token number">9.0122</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">:</span> <span class="token number">10.81</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">:</span> <span class="token number">12.01</span><span class="token punctuation">,</span>
    <span class="token string">'N'</span><span class="token punctuation">:</span> <span class="token number">14.01</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">:</span> <span class="token number">16.00</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">:</span> <span class="token number">19.00</span><span class="token punctuation">,</span> <span class="token string">'Ne'</span><span class="token punctuation">:</span> <span class="token number">20.180</span><span class="token punctuation">,</span> <span class="token string">'Na'</span><span class="token punctuation">:</span> <span class="token number">22.990</span><span class="token punctuation">,</span> <span class="token string">'Mg'</span><span class="token punctuation">:</span> <span class="token number">24.305</span><span class="token punctuation">,</span>
    <span class="token string">'Al'</span><span class="token punctuation">:</span> <span class="token number">26.982</span><span class="token punctuation">,</span> <span class="token string">'Si'</span><span class="token punctuation">:</span> <span class="token number">28.085</span><span class="token punctuation">,</span> <span class="token string">'P'</span><span class="token punctuation">:</span> <span class="token number">30.97</span><span class="token punctuation">,</span> <span class="token string">'S'</span><span class="token punctuation">:</span> <span class="token number">32.07</span><span class="token punctuation">,</span> <span class="token string">'Cl'</span><span class="token punctuation">:</span> <span class="token number">35.45</span><span class="token punctuation">,</span> <span class="token string">'Ar'</span><span class="token punctuation">:</span> <span class="token number">39.95</span><span class="token punctuation">,</span>
    <span class="token string">'K'</span><span class="token punctuation">:</span> <span class="token number">39.10</span><span class="token punctuation">,</span> <span class="token string">'Ca'</span><span class="token punctuation">:</span> <span class="token number">40.08</span><span class="token punctuation">,</span> <span class="token string">'Sc'</span><span class="token punctuation">:</span> <span class="token number">44.956</span><span class="token punctuation">,</span> <span class="token string">'Ti'</span><span class="token punctuation">:</span> <span class="token number">47.867</span><span class="token punctuation">,</span> <span class="token string">'V'</span><span class="token punctuation">:</span> <span class="token number">50.942</span><span class="token punctuation">,</span> <span class="token string">'Cr'</span><span class="token punctuation">:</span> <span class="token number">52.00</span><span class="token punctuation">,</span>
    <span class="token string">'Mn'</span><span class="token punctuation">:</span> <span class="token number">54.938</span><span class="token punctuation">,</span> <span class="token string">'Fe'</span><span class="token punctuation">:</span> <span class="token number">55.845</span><span class="token punctuation">,</span> <span class="token string">'Co'</span><span class="token punctuation">:</span> <span class="token number">58.933</span><span class="token punctuation">,</span> <span class="token string">'Ni'</span><span class="token punctuation">:</span> <span class="token number">58.69</span><span class="token punctuation">,</span> <span class="token string">'Cu'</span><span class="token punctuation">:</span> <span class="token number">63.55</span><span class="token punctuation">,</span> <span class="token string">'Zn'</span><span class="token punctuation">:</span> <span class="token number">65.38</span>
<span class="token punctuation">}</span>

<span class="token comment"># 函数用于解析单个InChI字符串</span>
<span class="token keyword">def</span> <span class="token function">parse_inchi</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">:</span>
    inchi_str <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token string">'InChI'</span><span class="token punctuation">]</span>
    formula <span class="token operator">=</span> <span class="token string">''</span>
    molecular_weight <span class="token operator">=</span> <span class="token number">0</span>
    element_counts <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    
    <span class="token comment"># 提取分子式</span>
    formula_match <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r"InChI=1S/([^/]+)/c"</span><span class="token punctuation">,</span> inchi_str<span class="token punctuation">)</span>
    <span class="token keyword">if</span> formula_match<span class="token punctuation">:</span>
        formula <span class="token operator">=</span> formula_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 计算分子量和原子计数</span>
    <span class="token keyword">for</span> element<span class="token punctuation">,</span> count <span class="token keyword">in</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"([A-Z][a-z]*)([0-9]*)"</span><span class="token punctuation">,</span> formula<span class="token punctuation">)</span><span class="token punctuation">:</span>
        count <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token keyword">if</span> count <span class="token keyword">else</span> <span class="token number">1</span>
        element_mass <span class="token operator">=</span> atomic_masses<span class="token punctuation">.</span>get<span class="token punctuation">(</span>element<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        molecular_weight <span class="token operator">+=</span> element_mass <span class="token operator">*</span> count
        element_counts<span class="token punctuation">[</span>element<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> count
    
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">'ElementCounts'</span><span class="token punctuation">:</span> element_counts
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># 应用函数到DataFrame的每一行</span>
data<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'ElementCounts'</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>parse_inchi<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 定义存在的key</span>
keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'H'</span><span class="token punctuation">,</span> <span class="token string">'He'</span><span class="token punctuation">,</span> <span class="token string">'Li'</span><span class="token punctuation">,</span> <span class="token string">'Be'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'Ne'</span><span class="token punctuation">,</span> <span class="token string">'Na'</span><span class="token punctuation">,</span> <span class="token string">'Mg'</span><span class="token punctuation">,</span> <span class="token string">'Al'</span><span class="token punctuation">,</span> <span class="token string">'Si'</span><span class="token punctuation">,</span> <span class="token string">'P'</span><span class="token punctuation">,</span> <span class="token string">'S'</span><span class="token punctuation">,</span> <span class="token string">'Cl'</span><span class="token punctuation">,</span> <span class="token string">'Ar'</span><span class="token punctuation">,</span> <span class="token string">'K'</span><span class="token punctuation">,</span> <span class="token string">'Ca'</span><span class="token punctuation">,</span> <span class="token string">'Sc'</span><span class="token punctuation">,</span> <span class="token string">'Ti'</span><span class="token punctuation">,</span> <span class="token string">'V'</span><span class="token punctuation">,</span> <span class="token string">'Cr'</span><span class="token punctuation">,</span> <span class="token string">'Mn'</span><span class="token punctuation">,</span> <span class="token string">'Fe'</span><span class="token punctuation">,</span> <span class="token string">'Co'</span><span class="token punctuation">,</span> <span class="token string">'Ni'</span><span class="token punctuation">,</span> <span class="token string">'Cu'</span><span class="token punctuation">,</span> <span class="token string">'Zn'</span><span class="token punctuation">]</span>

<span class="token comment"># 创建一个空的DataFrame，列名为keys</span>
df_expanded <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>key<span class="token punctuation">:</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># 遍历数据，填充DataFrame</span>
<span class="token keyword">for</span> index<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'ElementCounts'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">:</span>
        <span class="token comment"># 将字典中的值填充到相应的列中</span>
        df_expanded<span class="token punctuation">.</span>at<span class="token punctuation">[</span>index<span class="token punctuation">,</span> key<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        
df_expanded <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>df_expanded<span class="token punctuation">)</span>

zeros_count <span class="token operator">=</span> df_expanded<span class="token punctuation">.</span>eq<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
columns_to_drop <span class="token operator">=</span> zeros_count<span class="token punctuation">[</span>zeros_count <span class="token operator">&gt;=</span> <span class="token number">704</span><span class="token punctuation">]</span><span class="token punctuation">.</span>index<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
inchi_keys <span class="token operator">=</span> df_expanded<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>columns<span class="token operator">=</span>columns_to_drop<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">from</span> rdkit <span class="token keyword">import</span> Chem
<span class="token keyword">from</span> rdkit<span class="token punctuation">.</span>Chem <span class="token keyword">import</span> Descriptors<span class="token punctuation">,</span> rdMolDescriptors<span class="token punctuation">,</span> GraphDescriptors<span class="token punctuation">,</span> Lipinski

<span class="token keyword">def</span> <span class="token function">calculate_descriptors</span><span class="token punctuation">(</span>inchi<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 解析InChI字符串，提取分子信息</span>
    mol <span class="token operator">=</span> Chem<span class="token punctuation">.</span>MolFromInchi<span class="token punctuation">(</span>inchi<span class="token punctuation">)</span>
    
    <span class="token comment"># 氢键供体</span>
    h_donors <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>NumHDonors<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 氢键受体</span>
    h_acceptors <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>NumHAcceptors<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 旋转键个数</span>
    rotatable_bonds <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>NumRotatableBonds<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 芳香环数</span>
    aromatic_ring_count <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>NumAromaticRings<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 总极性表面积 (TPSA)</span>
    tpsa <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>CalcTPSA<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># XLogP</span>
    xlogp <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>MolLogP<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 价电子数</span>
    num_valence_electrons <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>NumValenceElectrons<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 平均信息含量</span>
    avg_ipc <span class="token operator">=</span> GraphDescriptors<span class="token punctuation">.</span>AvgIpc<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># Balaban's J</span>
    balaban_j <span class="token operator">=</span> GraphDescriptors<span class="token punctuation">.</span>BalabanJ<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># BertzCT 复杂度</span>
    bertz_ct <span class="token operator">=</span> GraphDescriptors<span class="token punctuation">.</span>BertzCT<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 重原子分子量</span>
    heavy_atom_mol_wt <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>HeavyAtomMolWt<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 最大绝对部分电荷</span>
    max_abs_partial_charge <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>MaxAbsPartialCharge<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 最大部分电荷</span>
    max_partial_charge <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>MaxPartialCharge<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 最小绝对部分电荷</span>
    min_abs_partial_charge <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>MinAbsPartialCharge<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 最小部分电荷</span>
    min_partial_charge <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>MinPartialCharge<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的Kappa1</span>
    kappa1 <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>CalcKappa1<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的Kappa2</span>
    kappa2 <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>CalcKappa2<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的Kappa3</span>
    kappa3 <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>CalcKappa3<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的Labute ASA</span>
    labute_asa <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>CalcLabuteASA<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的Morgan指纹</span>
    morgan_fingerprint <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>GetMorganFingerprint<span class="token punctuation">(</span>mol<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的自旋轨道耦合常数</span>
    kappa <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>CalcPhi<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的饱和碳环数</span>
    num_saturated_carbocycles <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>CalcNumSaturatedCarbocycles<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的饱和杂环数</span>
    num_saturated_heterocycles <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>CalcNumSaturatedHeterocycles<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的饱和环数</span>
    num_saturated_rings <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>CalcNumSaturatedRings<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的螺原子数</span>
    num_spiro_atoms <span class="token operator">=</span> rdMolDescriptors<span class="token punctuation">.</span>CalcNumSpiroAtoms<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的氧化数</span>
    rdMolDescriptors<span class="token punctuation">.</span>CalcOxidationNumbers<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的CSP3分数</span>
    fraction_csp3 <span class="token operator">=</span> Lipinski<span class="token punctuation">.</span>FractionCSP3<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的NHOH计数</span>
    nhoh_count <span class="token operator">=</span> Lipinski<span class="token punctuation">.</span>NHOHCount<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的NO计数</span>
    no_count <span class="token operator">=</span> Lipinski<span class="token punctuation">.</span>NOCount<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的异原子数</span>
    num_heteroatoms <span class="token operator">=</span> Lipinski<span class="token punctuation">.</span>NumHeteroatoms<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的非芳香碳环数</span>
    num_aliphatic_carbocycles <span class="token operator">=</span> Lipinski<span class="token punctuation">.</span>NumAliphaticCarbocycles<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的非芳香杂环数</span>
    num_aliphatic_heterocycles <span class="token operator">=</span> Lipinski<span class="token punctuation">.</span>NumAliphaticHeterocycles<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的非芳香环数</span>
    num_aliphatic_rings <span class="token operator">=</span> Lipinski<span class="token punctuation">.</span>NumAliphaticRings<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的芳烃碳环数</span>
    num_aromatic_carbocycles <span class="token operator">=</span> Lipinski<span class="token punctuation">.</span>NumAromaticCarbocycles<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的芳烃杂环数</span>
    num_aromatic_heterocycles <span class="token operator">=</span> Lipinski<span class="token punctuation">.</span>NumAromaticHeterocycles<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token comment"># 分子的摩尔折射率</span>
    mol_refractivity <span class="token operator">=</span> Descriptors<span class="token punctuation">.</span>MolMR<span class="token punctuation">(</span>mol<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"H-Bond Donors"</span><span class="token punctuation">:</span> h_donors<span class="token punctuation">,</span>
    <span class="token string">"H-Bond Acceptors"</span><span class="token punctuation">:</span> h_acceptors<span class="token punctuation">,</span>
    <span class="token string">"Rotatable Bonds"</span><span class="token punctuation">:</span> rotatable_bonds<span class="token punctuation">,</span>
    <span class="token string">"Aromatic Ring Count"</span><span class="token punctuation">:</span> aromatic_ring_count<span class="token punctuation">,</span>
    <span class="token string">"TPSA"</span><span class="token punctuation">:</span> tpsa<span class="token punctuation">,</span>
    <span class="token string">"XLogP"</span><span class="token punctuation">:</span> xlogp<span class="token punctuation">,</span>
    <span class="token string">"Num Valence Electrons"</span><span class="token punctuation">:</span> num_valence_electrons<span class="token punctuation">,</span>
    <span class="token string">"Average Information Content"</span><span class="token punctuation">:</span> avg_ipc<span class="token punctuation">,</span>
    <span class="token string">"Balaban's J"</span><span class="token punctuation">:</span> balaban_j<span class="token punctuation">,</span>
    <span class="token string">"BertzCT Complexity"</span><span class="token punctuation">:</span> bertz_ct<span class="token punctuation">,</span>
    <span class="token string">"Heavy Atom Molecular Weight"</span><span class="token punctuation">:</span> heavy_atom_mol_wt<span class="token punctuation">,</span>
    <span class="token string">"Max Absolute Partial Charge"</span><span class="token punctuation">:</span> max_abs_partial_charge<span class="token punctuation">,</span>
    <span class="token string">"Max Partial Charge"</span><span class="token punctuation">:</span> max_partial_charge<span class="token punctuation">,</span>
    <span class="token string">"Min Absolute Partial Charge"</span><span class="token punctuation">:</span> min_abs_partial_charge<span class="token punctuation">,</span>
    <span class="token string">"Min Partial Charge"</span><span class="token punctuation">:</span> min_partial_charge<span class="token punctuation">,</span>
    <span class="token string">"Kappa1"</span><span class="token punctuation">:</span> kappa1<span class="token punctuation">,</span>
    <span class="token string">"Kappa2"</span><span class="token punctuation">:</span> kappa2<span class="token punctuation">,</span>
    <span class="token string">"Kappa3"</span><span class="token punctuation">:</span> kappa3<span class="token punctuation">,</span>
    <span class="token string">"Labute Accessible Surface Area"</span><span class="token punctuation">:</span> labute_asa<span class="token punctuation">,</span>
    <span class="token string">"Spin-Orbit Coupling Constant"</span><span class="token punctuation">:</span> kappa<span class="token punctuation">,</span>
    <span class="token string">"Saturated Carbocycles"</span><span class="token punctuation">:</span> num_saturated_carbocycles<span class="token punctuation">,</span>
    <span class="token string">"Saturated Heterocycles"</span><span class="token punctuation">:</span> num_saturated_heterocycles<span class="token punctuation">,</span>
    <span class="token string">"Saturated Rings"</span><span class="token punctuation">:</span> num_saturated_rings<span class="token punctuation">,</span>
    <span class="token string">"Spiro Atoms"</span><span class="token punctuation">:</span> num_spiro_atoms<span class="token punctuation">,</span>
    <span class="token string">"CSP3 Fraction"</span><span class="token punctuation">:</span> fraction_csp3<span class="token punctuation">,</span>
    <span class="token string">"NHOH Count"</span><span class="token punctuation">:</span> nhoh_count<span class="token punctuation">,</span>
    <span class="token string">"NO Count"</span><span class="token punctuation">:</span> no_count<span class="token punctuation">,</span>
    <span class="token string">"Heteroatoms"</span><span class="token punctuation">:</span> num_heteroatoms<span class="token punctuation">,</span>
    <span class="token string">"Aliphatic Carbocycles"</span><span class="token punctuation">:</span> num_aliphatic_carbocycles<span class="token punctuation">,</span>
    <span class="token string">"Aliphatic Heterocycles"</span><span class="token punctuation">:</span> num_aliphatic_heterocycles<span class="token punctuation">,</span>
    <span class="token string">"Aliphatic Rings"</span><span class="token punctuation">:</span> num_aliphatic_rings<span class="token punctuation">,</span>
    <span class="token string">"Aromatic Carbocycles"</span><span class="token punctuation">:</span> num_aromatic_carbocycles<span class="token punctuation">,</span>
    <span class="token string">"Aromatic Heterocycles"</span><span class="token punctuation">:</span> num_aromatic_heterocycles<span class="token punctuation">,</span>
    <span class="token string">"Molar Refractivity"</span><span class="token punctuation">:</span> mol_refractivity<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

<span class="token comment"># 创建一个空的列表以存储提取的特征</span>
features_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment"># 提取特征并添加到列表中</span>
<span class="token keyword">for</span> inchi <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'InChI'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    features <span class="token operator">=</span> calculate_descriptors<span class="token punctuation">(</span>inchi<span class="token punctuation">)</span>
    features_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>features<span class="token punctuation">)</span>

<span class="token comment"># 将列表转换为DataFrame</span>
inchi_features <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>features_list<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 将提取的特征添加到原始数据集</span>
data <span class="token operator">=</span> pd<span class="token punctuation">.</span>concat<span class="token punctuation">(</span><span class="token punctuation">[</span>data<span class="token punctuation">,</span> smiles_feature<span class="token punctuation">,</span> inchi_keys<span class="token punctuation">,</span> inchi_features<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
</code></pre> 
<h3><a id="_367"></a>根据关联性分析筛选特征</h3> 
<pre><code class="prism language-python">data <span class="token operator">=</span> data<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ElementCounts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment"># 自然数编码（）</span>
<span class="token keyword">def</span> <span class="token function">label_encode</span><span class="token punctuation">(</span>series<span class="token punctuation">)</span><span class="token punctuation">:</span>
    unique <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>series<span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> series<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>
        unique<span class="token punctuation">,</span> <span class="token builtin">range</span><span class="token punctuation">(</span>series<span class="token punctuation">.</span>nunique<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

object_cols <span class="token operator">=</span> data<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>include<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'object'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>columns

<span class="token keyword">for</span> col <span class="token keyword">in</span> object_cols<span class="token punctuation">:</span>
    data<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> label_encode<span class="token punctuation">(</span>data<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">train <span class="token operator">=</span> data<span class="token punctuation">[</span>data<span class="token punctuation">.</span>Label<span class="token punctuation">.</span>notnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test <span class="token operator">=</span> data<span class="token punctuation">[</span>data<span class="token punctuation">.</span>Label<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reset_index<span class="token punctuation">(</span>drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">features1 <span class="token operator">=</span> train<span class="token punctuation">.</span>columns<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
corr1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> feat <span class="token keyword">in</span> features1<span class="token punctuation">:</span>
    corr1<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">abs</span><span class="token punctuation">(</span>train<span class="token punctuation">[</span><span class="token punctuation">[</span>feat<span class="token punctuation">,</span> <span class="token string">"Label"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>corr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

se1 <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>corr1<span class="token punctuation">,</span> index<span class="token operator">=</span>features1<span class="token punctuation">)</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">drop_se1 <span class="token operator">=</span> se1<span class="token punctuation">.</span>index<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

<span class="token comment"># 使用drop方法从训练集和测试集中删除了这些列，以避免在后续的分析或建模中使用这些包含大量缺失值的列</span>
train <span class="token operator">=</span> train<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>drop_se1<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
test <span class="token operator">=</span> test<span class="token punctuation">.</span>drop<span class="token punctuation">(</span>drop_se1<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">train<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 特征筛选</span>
features <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> train<span class="token punctuation">.</span>columns <span class="token keyword">if</span> f <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'uuid'</span><span class="token punctuation">,</span><span class="token string">'Label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>

<span class="token comment"># 构建训练集和测试集</span>
x_train <span class="token operator">=</span> train<span class="token punctuation">[</span>features<span class="token punctuation">]</span>
x_test <span class="token operator">=</span> test<span class="token punctuation">[</span>features<span class="token punctuation">]</span>

<span class="token comment"># 训练集标签</span>
y_train <span class="token operator">=</span> train<span class="token punctuation">[</span><span class="token string">'Label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">x_train<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">train<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'[^\w\s]'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
test<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>columns<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'[^\w\s]'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="OpenFE_440"></a>OpenFE特征构造</h3> 
<p>OpenFE，全称Open Feature Engineering，是一个开源的Python库，专门设计用于简化和自动化特征工程的过程。通过提供一系列的工具和函数，OpenFE使数据科学家和机器学习工程师能够更高效地创建、测试和部署特征。</p> 
<ul><li>自动特征生成：OpenFE能够根据现有数据自动创建新的特征，帮助提升模型的性能。</li><li>特征选择与优化：它提供了多种特征选择方法，帮助用户识别和保留最有价值的特征，同时去除冗余或无关的特征。</li><li>易于使用的API：OpenFE设计了简洁直观的API，即使是没有太多编程经验的人也能轻松上手。</li><li>灵活性和可扩展性：用户可以根据自己的需要自定义特征转换规则，使得OpenFE能够适用于各种不同的数据和项目需求。</li></ul> 
<pre><code class="prism language-python">ofe <span class="token operator">=</span> OpenFE<span class="token punctuation">(</span><span class="token punctuation">)</span>
features <span class="token operator">=</span> ofe<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>data<span class="token operator">=</span>x_train<span class="token punctuation">,</span> label<span class="token operator">=</span>y_train<span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>joblib<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>ofe<span class="token punctuation">,</span><span class="token string">"ofe.pkl"</span><span class="token punctuation">)</span><span class="token keyword">for</span> feature <span class="token keyword">in</span> ofe<span class="token punctuation">.</span>new_features_list<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>tree_to_formula<span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">)</span>x_train<span class="token punctuation">,</span> x_test <span class="token operator">=</span> transform<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> x_test<span class="token punctuation">,</span> features<span class="token punctuation">,</span> n_jobs<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>cat_columns <span class="token operator">=</span> x_train<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>include<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>columns
x_train<span class="token punctuation">[</span>cat_columns<span class="token punctuation">]</span> <span class="token operator">=</span> x_train<span class="token punctuation">[</span>cat_columns<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
cat_columns <span class="token operator">=</span> x_test<span class="token punctuation">.</span>select_dtypes<span class="token punctuation">(</span>include<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'category'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>columns
x_test<span class="token punctuation">[</span>cat_columns<span class="token punctuation">]</span> <span class="token operator">=</span> x_test<span class="token punctuation">[</span>cat_columns<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_457"></a>模型训练</h2> 
<blockquote> 
 <p>这里借鉴了《机器学习算法竞赛实战》的代码</p> 
</blockquote> 
<h3><a id="lgm_463"></a>lgm</h3> 
<h4><a id="_465"></a>模型特征选择</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> lightgbm <span class="token keyword">as</span> lgb
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> KFold
<span class="token keyword">from</span> hyperopt <span class="token keyword">import</span> hp<span class="token punctuation">,</span> fmin<span class="token punctuation">,</span> tpe
<span class="token keyword">from</span> numpy<span class="token punctuation">.</span>random <span class="token keyword">import</span> RandomState
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error<span class="token punctuation">,</span>f1_score
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">feature_select_wrapper</span><span class="token punctuation">(</span>train<span class="token punctuation">,</span> test<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""

    :param train:
    :param test:
    :return:
    """</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'feature_select_wrapper...'</span><span class="token punctuation">)</span>
    label <span class="token operator">=</span> <span class="token string">'Label'</span>
    features <span class="token operator">=</span> train<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    features<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span>
    features<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'Label'</span><span class="token punctuation">)</span>

    <span class="token comment"># 配置模型的训练参数</span>
    params_initial <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'num_leaves'</span><span class="token punctuation">:</span> <span class="token number">31</span><span class="token punctuation">,</span>
        <span class="token string">'learning_rate'</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
        <span class="token string">'boosting'</span><span class="token punctuation">:</span> <span class="token string">'gbdt'</span><span class="token punctuation">,</span>
        <span class="token string">'min_child_samples'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
        <span class="token string">'bagging_seed'</span><span class="token punctuation">:</span> <span class="token number">2020</span><span class="token punctuation">,</span>
        <span class="token string">'bagging_fraction'</span><span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
        <span class="token string">'bagging_freq'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">'feature_fraction'</span><span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
        <span class="token string">'max_depth'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">'metric'</span><span class="token punctuation">:</span> <span class="token string">'auc'</span><span class="token punctuation">,</span>
        <span class="token string">'reg_alpha'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">'reg_lambda'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">'objective'</span><span class="token punctuation">:</span> <span class="token string">'binary'</span>
    <span class="token punctuation">}</span>
    ESR <span class="token operator">=</span> <span class="token number">30</span>
    NBR <span class="token operator">=</span> <span class="token number">10000</span>
    VBE <span class="token operator">=</span> <span class="token number">50</span>
    kf <span class="token operator">=</span> KFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">2020</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    fse <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token operator">=</span>features<span class="token punctuation">)</span>
    callbacks <span class="token operator">=</span> <span class="token punctuation">[</span>lgb<span class="token punctuation">.</span>early_stopping<span class="token punctuation">(</span>stopping_rounds<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> train_part_index<span class="token punctuation">,</span> eval_index <span class="token keyword">in</span> kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>train<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">,</span> train<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 模型训练</span>
        train_part <span class="token operator">=</span> lgb<span class="token punctuation">.</span>Dataset<span class="token punctuation">(</span>train<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_part_index<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 train<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_part_index<span class="token punctuation">]</span><span class="token punctuation">)</span>
        eval1 <span class="token operator">=</span> lgb<span class="token punctuation">.</span>Dataset<span class="token punctuation">(</span>train<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>eval_index<span class="token punctuation">]</span><span class="token punctuation">,</span>
                           train<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>eval_index<span class="token punctuation">]</span><span class="token punctuation">)</span>
        bst <span class="token operator">=</span> lgb<span class="token punctuation">.</span>train<span class="token punctuation">(</span>params_initial<span class="token punctuation">,</span> train_part<span class="token punctuation">,</span> num_boost_round<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">,</span>
                        valid_sets<span class="token operator">=</span><span class="token punctuation">[</span>train_part<span class="token punctuation">,</span> eval1<span class="token punctuation">]</span><span class="token punctuation">,</span>
                        valid_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'valid'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        callbacks<span class="token operator">=</span>callbacks
                        <span class="token punctuation">)</span>
        fse <span class="token operator">+=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>bst<span class="token punctuation">.</span>feature_importance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> features<span class="token punctuation">)</span>

    feature_select <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'uuid'</span><span class="token punctuation">]</span> <span class="token operator">+</span> fse<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">200</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> train<span class="token punctuation">[</span>feature_select <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">'Label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> test<span class="token punctuation">[</span>feature_select<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="_533"></a>参数寻优</h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">params_append</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""

    :param params:
    :return:
    """</span>
    params<span class="token punctuation">[</span><span class="token string">'objective'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'binary'</span>
    params<span class="token punctuation">[</span><span class="token string">'metric'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'auc'</span>
    params<span class="token punctuation">[</span><span class="token string">'bagging_seed'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2020</span>
    <span class="token keyword">return</span> params
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">param_hyperopt</span><span class="token punctuation">(</span>train<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :param train:
    :return:
    """</span>
    label <span class="token operator">=</span> <span class="token string">'Label'</span>
    features <span class="token operator">=</span> train<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    features<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span>
    features<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'Label'</span><span class="token punctuation">)</span>
    params1 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'feature_pre_filter'</span><span class="token punctuation">:</span><span class="token boolean">False</span><span class="token punctuation">}</span>
    train_data <span class="token operator">=</span> lgb<span class="token punctuation">.</span>Dataset<span class="token punctuation">(</span>train<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">,</span> train<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">,</span> params <span class="token operator">=</span> params1<span class="token punctuation">)</span>
    callbacks1 <span class="token operator">=</span> <span class="token punctuation">[</span>lgb<span class="token punctuation">.</span>early_stopping<span class="token punctuation">(</span>stopping_rounds<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>lgb<span class="token punctuation">.</span>log_evaluation<span class="token punctuation">(</span>show_stdv<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">hyperopt_objective</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""

        :param params:
        :return:
        """</span>
        params <span class="token operator">=</span> params_append<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
        res <span class="token operator">=</span> lgb<span class="token punctuation">.</span>cv<span class="token punctuation">(</span>params<span class="token punctuation">,</span> train_data<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span>
                     nfold<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                     stratified<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                     shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                     metrics<span class="token operator">=</span><span class="token string">'auc'</span><span class="token punctuation">,</span>
                     seed<span class="token operator">=</span><span class="token number">2020</span><span class="token punctuation">,</span>
                     callbacks<span class="token operator">=</span>callbacks1<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">'valid auc-mean'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    params_space <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'learning_rate'</span><span class="token punctuation">:</span> hp<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token string">'learning_rate'</span><span class="token punctuation">,</span> <span class="token number">1e-2</span><span class="token punctuation">,</span> <span class="token number">5e-1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'bagging_fraction'</span><span class="token punctuation">:</span> hp<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token string">'bagging_fraction'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'feature_fraction'</span><span class="token punctuation">:</span> hp<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token string">'feature_fraction'</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'num_leaves'</span><span class="token punctuation">:</span> hp<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token string">'num_leaves'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'reg_alpha'</span><span class="token punctuation">:</span> hp<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token string">'reg_alpha'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'reg_lambda'</span><span class="token punctuation">:</span> hp<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token string">'reg_lambda'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'bagging_freq'</span><span class="token punctuation">:</span> hp<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token string">'bagging_freq'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'min_child_samples'</span><span class="token punctuation">:</span> hp<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token string">'min_child_samples'</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    params_best <span class="token operator">=</span> fmin<span class="token punctuation">(</span>
        hyperopt_objective<span class="token punctuation">,</span>
        space<span class="token operator">=</span>params_space<span class="token punctuation">,</span>
        algo<span class="token operator">=</span>tpe<span class="token punctuation">.</span>suggest<span class="token punctuation">,</span>
        max_evals<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
        rstate<span class="token operator">=</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>default_rng<span class="token punctuation">(</span><span class="token number">2020</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> params_best
</code></pre> 
<h4><a id="_599"></a>模型预测</h4> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train_predict</span><span class="token punctuation">(</span>train<span class="token punctuation">,</span> test<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""

    :param train:
    :param test:
    :param params:
    :return:
    """</span>
    label <span class="token operator">=</span> <span class="token string">'Label'</span>
    features <span class="token operator">=</span> train<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    features<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span>
    features<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'Label'</span><span class="token punctuation">)</span>
    params <span class="token operator">=</span> params_append<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    kf <span class="token operator">=</span> KFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">2020</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    prediction_test <span class="token operator">=</span> <span class="token number">0</span>
    cv_score <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    prediction_train <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ESR <span class="token operator">=</span> <span class="token number">30</span>
    NBR <span class="token operator">=</span> <span class="token number">10000</span>
    VBE <span class="token operator">=</span> <span class="token number">50</span>
    callbacks <span class="token operator">=</span> <span class="token punctuation">[</span>lgb<span class="token punctuation">.</span>early_stopping<span class="token punctuation">(</span>stopping_rounds<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> train_part_index<span class="token punctuation">,</span> eval_index <span class="token keyword">in</span> kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>train<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">,</span> train<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 模型训练</span>
        train_part <span class="token operator">=</span> lgb<span class="token punctuation">.</span>Dataset<span class="token punctuation">(</span>train<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_part_index<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 train<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_part_index<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token builtin">eval</span> <span class="token operator">=</span> lgb<span class="token punctuation">.</span>Dataset<span class="token punctuation">(</span>train<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>eval_index<span class="token punctuation">]</span><span class="token punctuation">,</span>
                           train<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>eval_index<span class="token punctuation">]</span><span class="token punctuation">)</span>
        bst <span class="token operator">=</span> lgb<span class="token punctuation">.</span>train<span class="token punctuation">(</span>params<span class="token punctuation">,</span> train_part<span class="token punctuation">,</span> num_boost_round<span class="token operator">=</span>NBR<span class="token punctuation">,</span>
                        valid_sets<span class="token operator">=</span><span class="token punctuation">[</span>train_part<span class="token punctuation">,</span> <span class="token builtin">eval</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        valid_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'train'</span><span class="token punctuation">,</span> <span class="token string">'valid'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        callbacks<span class="token operator">=</span>callbacks<span class="token punctuation">)</span>
        prediction_test <span class="token operator">+=</span> bst<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">)</span>
        prediction_train <span class="token operator">=</span> prediction_train<span class="token punctuation">.</span>_append<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>bst<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>train<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>eval_index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                             index<span class="token operator">=</span>eval_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
        eval_pre <span class="token operator">=</span> bst<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>train<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>eval_index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
        score <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>f1_score<span class="token punctuation">(</span>train<span class="token punctuation">[</span>label<span class="token punctuation">]</span><span class="token punctuation">.</span>loc<span class="token punctuation">[</span>eval_index<span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> eval_pre<span class="token punctuation">)</span><span class="token punctuation">)</span>
        cv_score<span class="token punctuation">.</span>append<span class="token punctuation">(</span>score<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>cv_score<span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>cv_score<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span>
    pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>prediction_train<span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">"train_lightgbm.csv"</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>prediction_test <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">"test_lightgbm.csv"</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    test<span class="token punctuation">[</span><span class="token string">'Label'</span><span class="token punctuation">]</span> <span class="token operator">=</span> prediction_test <span class="token operator">/</span> <span class="token number">5</span>
    test<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'uuid'</span><span class="token punctuation">,</span> <span class="token string">'Label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">"submit_lightgbm.csv"</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
</code></pre> 
<pre><code class="prism language-python">train_select<span class="token punctuation">,</span> test_select <span class="token operator">=</span> feature_select_wrapper<span class="token punctuation">(</span>train<span class="token punctuation">,</span> test<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">best_clf <span class="token operator">=</span> param_hyperopt<span class="token punctuation">(</span>train_select<span class="token punctuation">)</span>
joblib<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>best_clf<span class="token punctuation">,</span><span class="token string">"best_clf.pkl"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">best_clf <span class="token operator">=</span> joblib<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">'best_clf.pkl'</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">train_predict<span class="token punctuation">(</span>train_select<span class="token punctuation">,</span> test_select<span class="token punctuation">,</span> best_clf<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="xgb_669"></a>xgb</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> lightgbm <span class="token keyword">as</span> lgb
<span class="token keyword">import</span> xgboost <span class="token keyword">as</span> xgb
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> KFold
<span class="token keyword">from</span> hyperopt <span class="token keyword">import</span> hp<span class="token punctuation">,</span> fmin<span class="token punctuation">,</span> tpe
<span class="token keyword">from</span> scipy <span class="token keyword">import</span> sparse
<span class="token keyword">from</span> scipy<span class="token punctuation">.</span>sparse <span class="token keyword">import</span> csr_matrix
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_selection <span class="token keyword">import</span> f_regression<span class="token punctuation">,</span>f_classif
<span class="token keyword">from</span> numpy<span class="token punctuation">.</span>random <span class="token keyword">import</span> RandomState
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error<span class="token punctuation">,</span>f1_score
<span class="token keyword">from</span> bayes_opt <span class="token keyword">import</span> BayesianOptimization
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> KFold
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error<span class="token punctuation">,</span>f1_score
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">read_data1</span><span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    features <span class="token operator">=</span> train<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    features<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">)</span>
    features<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'Label'</span><span class="token punctuation">)</span>

    train_x <span class="token operator">=</span> csr_matrix<span class="token punctuation">(</span>train<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>SparseDtype<span class="token punctuation">(</span><span class="token string">"float64"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sparse<span class="token punctuation">.</span>to_coo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tocsr<span class="token punctuation">(</span><span class="token punctuation">)</span>
    test_x <span class="token operator">=</span> csr_matrix<span class="token punctuation">(</span>test<span class="token punctuation">[</span>features<span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>SparseDtype<span class="token punctuation">(</span><span class="token string">"float64"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sparse<span class="token punctuation">.</span>to_coo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tocsr<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"done"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> train_x<span class="token punctuation">,</span> test_x
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">params_append1</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""

    :param params:
    :return:
    """</span>
    params<span class="token punctuation">[</span><span class="token string">'objective'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'binary:hinge'</span>
    params<span class="token punctuation">[</span><span class="token string">'eval_metric'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'auc'</span>
    params<span class="token punctuation">[</span><span class="token string">"min_child_weight"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">"min_child_weight"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    params<span class="token punctuation">[</span><span class="token string">'max_depth'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token string">'max_depth'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> params
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">param_beyesian1</span><span class="token punctuation">(</span>train<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""

    :param train:
    :return:
    """</span>
    train_y <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">"dataset-new/traindata-new.xlsx"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Label'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values
    train_data <span class="token operator">=</span> xgb<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>train<span class="token punctuation">,</span> train_y<span class="token punctuation">,</span> silent<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">xgb_cv</span><span class="token punctuation">(</span>colsample_bytree<span class="token punctuation">,</span> subsample<span class="token punctuation">,</span> min_child_weight<span class="token punctuation">,</span> max_depth<span class="token punctuation">,</span>
               reg_alpha<span class="token punctuation">,</span> eta<span class="token punctuation">,</span>
               reg_lambda<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""

        :param colsample_bytree:
        :param subsample:
        :param min_child_weight:
        :param max_depth:
        :param reg_alpha:
        :param eta:
        :param reg_lambda:
        :return:
        """</span>
        params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'objective'</span><span class="token punctuation">:</span> <span class="token string">'binary:hinge'</span><span class="token punctuation">,</span>
                  <span class="token string">'early_stopping_round'</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
                  <span class="token string">'eval_metric'</span><span class="token punctuation">:</span> <span class="token string">'auc'</span><span class="token punctuation">}</span>
        params<span class="token punctuation">[</span><span class="token string">'colsample_bytree'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>colsample_bytree<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        params<span class="token punctuation">[</span><span class="token string">'subsample'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span>subsample<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        params<span class="token punctuation">[</span><span class="token string">"min_child_weight"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>min_child_weight<span class="token punctuation">)</span>
        params<span class="token punctuation">[</span><span class="token string">'max_depth'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>max_depth<span class="token punctuation">)</span>
        params<span class="token punctuation">[</span><span class="token string">'eta'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>eta<span class="token punctuation">)</span>
        params<span class="token punctuation">[</span><span class="token string">'reg_alpha'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>reg_alpha<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        params<span class="token punctuation">[</span><span class="token string">'reg_lambda'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>reg_lambda<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
        cv_result <span class="token operator">=</span> xgb<span class="token punctuation">.</span>cv<span class="token punctuation">(</span>params<span class="token punctuation">,</span> train_data<span class="token punctuation">,</span>
                           num_boost_round<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">,</span>
                           nfold<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                           stratified<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                           shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                           early_stopping_rounds<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">,</span>
                           verbose_eval<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token builtin">min</span><span class="token punctuation">(</span>cv_result<span class="token punctuation">[</span><span class="token string">'test-auc-mean'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    xgb_bo <span class="token operator">=</span> BayesianOptimization<span class="token punctuation">(</span>
        xgb_cv<span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">'colsample_bytree'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">'subsample'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">'min_child_weight'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">'max_depth'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">'reg_alpha'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">'eta'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">'reg_lambda'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    xgb_bo<span class="token punctuation">.</span>maximize<span class="token punctuation">(</span>init_points<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">,</span> n_iter<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># init_points表示初始点，n_iter代表迭代次数（即采样数）</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>xgb_bo<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">[</span><span class="token string">'target'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> xgb_bo<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">[</span><span class="token string">'params'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> xgb_bo<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">[</span><span class="token string">'params'</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train_predict1</span><span class="token punctuation">(</span>train<span class="token punctuation">,</span> test<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :param train:
    :param test:
    :param params:
    :return:
    """</span>
    train_y <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">"dataset-new/traindata-new.xlsx"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'Label'</span><span class="token punctuation">]</span>
    test_data <span class="token operator">=</span> xgb<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>test<span class="token punctuation">)</span>

    params <span class="token operator">=</span> params_append1<span class="token punctuation">(</span>params<span class="token punctuation">)</span>
    kf <span class="token operator">=</span> KFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">2020</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    prediction_test <span class="token operator">=</span> <span class="token number">0</span>
    cv_score <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    prediction_train <span class="token operator">=</span> pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ESR <span class="token operator">=</span> <span class="token number">30</span>
    NBR <span class="token operator">=</span> <span class="token number">10000</span>
    VBE <span class="token operator">=</span> <span class="token number">50</span>
    <span class="token keyword">for</span> train_part_index<span class="token punctuation">,</span> eval_index <span class="token keyword">in</span> kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>train<span class="token punctuation">,</span> train_y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 模型训练</span>
        train_part <span class="token operator">=</span> xgb<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>train<span class="token punctuation">.</span>tocsr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>train_part_index<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                 train_y<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_part_index<span class="token punctuation">]</span><span class="token punctuation">)</span>
        eval2 <span class="token operator">=</span> xgb<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>train<span class="token punctuation">.</span>tocsr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>eval_index<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                           train_y<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>eval_index<span class="token punctuation">]</span><span class="token punctuation">)</span>
        bst <span class="token operator">=</span> xgb<span class="token punctuation">.</span>train<span class="token punctuation">(</span>params<span class="token punctuation">,</span> train_part<span class="token punctuation">,</span> NBR<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>train_part<span class="token punctuation">,</span> <span class="token string">'train'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                  <span class="token punctuation">(</span>eval2<span class="token punctuation">,</span> <span class="token string">'eval'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> verbose_eval<span class="token operator">=</span>VBE<span class="token punctuation">,</span>
                        maximize<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> early_stopping_rounds<span class="token operator">=</span>ESR<span class="token punctuation">,</span> <span class="token punctuation">)</span>
        prediction_test <span class="token operator">+=</span> bst<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>test_data<span class="token punctuation">)</span>
        eval_pre <span class="token operator">=</span> bst<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>eval2<span class="token punctuation">)</span>
        prediction_train <span class="token operator">=</span> prediction_train<span class="token punctuation">.</span>_append<span class="token punctuation">(</span>pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>eval_pre<span class="token punctuation">,</span> index<span class="token operator">=</span>eval_index<span class="token punctuation">)</span><span class="token punctuation">)</span>
        score <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>f1_score<span class="token punctuation">(</span>train_y<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>eval_index<span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> eval_pre<span class="token punctuation">)</span><span class="token punctuation">)</span>
        cv_score<span class="token punctuation">.</span>append<span class="token punctuation">(</span>score<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>cv_score<span class="token punctuation">,</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>cv_score<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span>
    pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>prediction_train<span class="token punctuation">.</span>sort_index<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">"train_xgboost.csv"</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    pd<span class="token punctuation">.</span>Series<span class="token punctuation">(</span>prediction_test <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">"test_xgboost.csv"</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    test <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_excel<span class="token punctuation">(</span><span class="token string">'dataset-new/testdata-new.xlsx'</span><span class="token punctuation">)</span>
    test<span class="token punctuation">[</span><span class="token string">'Label'</span><span class="token punctuation">]</span> <span class="token operator">=</span> prediction_test <span class="token operator">/</span> <span class="token number">5</span>
    test<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'uuid'</span><span class="token punctuation">,</span> <span class="token string">'Label'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">"submission_xgboost.csv"</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
</code></pre> 
<pre><code class="prism language-python">train1<span class="token punctuation">,</span> test1 <span class="token operator">=</span> read_data1<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">best_clf1 <span class="token operator">=</span> param_beyesian1<span class="token punctuation">(</span>train1<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">train_predict1<span class="token punctuation">(</span>train1<span class="token punctuation">,</span> test1<span class="token punctuation">,</span> best_clf1<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="cat_834"></a>cat</h3> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">cv_model</span><span class="token punctuation">(</span>clf<span class="token punctuation">,</span> train_x<span class="token punctuation">,</span> train_y<span class="token punctuation">,</span> test_x<span class="token punctuation">,</span> clf_name<span class="token punctuation">,</span> seed<span class="token operator">=</span><span class="token number">2024</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    kf <span class="token operator">=</span> KFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span>seed<span class="token punctuation">)</span>

    train <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>train_x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    test <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>test_x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    cv_scores <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>train_index<span class="token punctuation">,</span> valid_index<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>train_x<span class="token punctuation">,</span> train_y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'************************************ {} {}************************************'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        trn_x<span class="token punctuation">,</span> trn_y<span class="token punctuation">,</span> val_x<span class="token punctuation">,</span> val_y <span class="token operator">=</span> train_x<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span><span class="token punctuation">,</span> train_y<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span><span class="token punctuation">,</span> train_x<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>valid_index<span class="token punctuation">]</span><span class="token punctuation">,</span> train_y<span class="token punctuation">[</span>valid_index<span class="token punctuation">]</span>
               
        params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'learning_rate'</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token string">'depth'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'l2_leaf_reg'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'bootstrap_type'</span><span class="token punctuation">:</span><span class="token string">'Bernoulli'</span><span class="token punctuation">,</span><span class="token string">'random_seed'</span><span class="token punctuation">:</span>seed<span class="token punctuation">,</span>
                  <span class="token string">'od_type'</span><span class="token punctuation">:</span> <span class="token string">'Iter'</span><span class="token punctuation">,</span> <span class="token string">'od_wait'</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'random_seed'</span><span class="token punctuation">:</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token string">'allow_writing_files'</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">'task_type'</span><span class="token punctuation">:</span><span class="token string">'CPU'</span><span class="token punctuation">}</span>

        model <span class="token operator">=</span> clf<span class="token punctuation">(</span>iterations<span class="token operator">=</span><span class="token number">20000</span><span class="token punctuation">,</span> <span class="token operator">**</span>params<span class="token punctuation">,</span> eval_metric<span class="token operator">=</span><span class="token string">'auc'</span><span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>trn_x<span class="token punctuation">,</span> trn_y<span class="token punctuation">,</span> eval_set<span class="token operator">=</span><span class="token punctuation">(</span>val_x<span class="token punctuation">,</span> val_y<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  metric_period<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
                  cat_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                  use_best_model<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> 
                  verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        val_pred  <span class="token operator">=</span> model<span class="token punctuation">.</span>predict_proba<span class="token punctuation">(</span>val_x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
        test_pred <span class="token operator">=</span> model<span class="token punctuation">.</span>predict_proba<span class="token punctuation">(</span>test_x<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
            
        train<span class="token punctuation">[</span>valid_index<span class="token punctuation">]</span> <span class="token operator">=</span> val_pred
        test <span class="token operator">+=</span> test_pred <span class="token operator">/</span> kf<span class="token punctuation">.</span>n_splits
        cv_scores<span class="token punctuation">.</span>append<span class="token punctuation">(</span>f1_score<span class="token punctuation">(</span>val_y<span class="token punctuation">,</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>val_pred<span class="token operator">&gt;</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token keyword">print</span><span class="token punctuation">(</span>cv_scores<span class="token punctuation">)</span>
       
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"%s_score_list:"</span> <span class="token operator">%</span> clf_name<span class="token punctuation">,</span> cv_scores<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"%s_score_mean:"</span> <span class="token operator">%</span> clf_name<span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>cv_scores<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"%s_score_std:"</span> <span class="token operator">%</span> clf_name<span class="token punctuation">,</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>cv_scores<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> train<span class="token punctuation">,</span> test
    
cat_train<span class="token punctuation">,</span> cat_test <span class="token operator">=</span> cv_model<span class="token punctuation">(</span>CatBoostClassifier<span class="token punctuation">,</span> x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> x_test<span class="token punctuation">,</span> <span class="token string">"cat"</span><span class="token punctuation">)</span>

pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">'uuid'</span><span class="token punctuation">:</span> test<span class="token punctuation">[</span><span class="token string">'uuid'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'Label'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>cat_test<span class="token operator">&gt;</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'submit_v4.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre> 
<p><em>未完待续……</em></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/14c92cd9b4279452b0c3f446b3641b6c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AI是在帮助开发者还是取代他们？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9cf482a59e15c7c3e3b389eae04dff80/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C语言牢大坠机</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>