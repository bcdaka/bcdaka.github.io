<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>数据库课程设计-图书馆管理系统(2.数据库实现-基于mysql) - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/816cd5275694db6bc8f83415d44850f3/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="数据库课程设计-图书馆管理系统(2.数据库实现-基于mysql)">
  <meta property="og:description" content="如果对你有帮助，可以给卑微的博主留个赞、关注、收藏 (不是) 好像有读者说现在不要积分的资源也要vip才能下，如果下不了可以留邮箱到评论区或者私聊，我也把资源放到github了，地址如下：
https://github.com/goLSX/library_manager_system
如果对你有帮助不妨点个star 拜谢
数据库选用mysql 8.0.25 64位， 配合使用navicat
mysql可以在主页下载安装包，或者网上自己搜索
数据库安装配置可以参考网上的教程，有很多人都做了教程，例如这篇博文Mysql8.0.17压缩包安装——超详细简单教程_singular港的博客-CSDN博客
navicat的安装可参考这篇博文
Navicat16安装教程-图文详解_victor_王泽华的博客-CSDN博客
目录
1. 新建数据库 (模式)
2. 基本表的创建
3. 视图的创建
4. 完整性的创建
5. 触发器创建
6. 存储过程的创建
7. 索引创建
8. 数据库权限管理
9. 备份与恢复策略
安装好navicat和mysql后
先启动mysql服务，然后使用navicat进行连接，连接成功后点击新建查询
1. 新建数据库 (模式) 例如创建数据库名字叫library_db ,之后我们新建的表、存储过程等内容都属于这个数据库(模式)
create database library_db; use library_db; 2. 基本表的创建 readers表
CREATE TABLE readers (
reader_name varchar(20) ,
password varchar(35) ,
name varchar(10) ,
id_num varchar(20) ,
phone_num varchar(15)
);
managers表">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-27T08:27:37+08:00">
    <meta property="article:modified_time" content="2024-02-27T08:27:37+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">数据库课程设计-图书馆管理系统(2.数据库实现-基于mysql)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="color:#4da8ee;">如果对你有帮助，可以给卑微的博主留个赞、关注、收藏   (不是) </span></p> 
<p></p> 
<p><span style="color:#e6b223;">好像有读者说现在不要积分的资源也要vip才能下，如果下不了可以留邮箱到评论区或者私聊，我也把资源放到github了，地址如下：</span></p> 
<p>https://github.com/goLSX/library_manager_system</p> 
<p><span style="color:#e6b223;">如果对你有帮助不妨点个star   拜谢</span></p> 
<p></p> 
<p>数据库选用mysql 8.0.25   64位， 配合使用navicat</p> 
<p>mysql可以在主页下载安装包，或者网上自己搜索</p> 
<p>数据库安装配置可以参考网上的教程，有很多人都做了教程，例如这篇博文<a href="https://blog.csdn.net/qq_38264999/article/details/98858903" title="Mysql8.0.17压缩包安装——超详细简单教程_singular港的博客-CSDN博客">Mysql8.0.17压缩包安装——超详细简单教程_singular港的博客-CSDN博客</a></p> 
<p></p> 
<p>navicat的安装可参考这篇博文</p> 
<p><a href="https://blog.csdn.net/Stupid__Angel/article/details/127539077" title="Navicat16安装教程-图文详解_victor_王泽华的博客-CSDN博客">Navicat16安装教程-图文详解_victor_王泽华的博客-CSDN博客</a></p> 
<p></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="1.%20%E6%96%B0%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%20(%E6%A8%A1%E5%BC%8F)-toc" style="margin-left:40px;"><a href="#1.%20%E6%96%B0%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%20%28%E6%A8%A1%E5%BC%8F%29" rel="nofollow">1. 新建数据库 (模式)</a></p> 
<p id="%C2%A02.%20%E5%9F%BA%E6%9C%AC%E8%A1%A8%E7%9A%84%E5%88%9B%E5%BB%BA-toc" style="margin-left:40px;"><a href="#%C2%A02.%20%E5%9F%BA%E6%9C%AC%E8%A1%A8%E7%9A%84%E5%88%9B%E5%BB%BA" rel="nofollow"> 2. 基本表的创建</a></p> 
<p id="3.%20%E8%A7%86%E5%9B%BE%E7%9A%84%E5%88%9B%E5%BB%BA-toc" style="margin-left:40px;"><a href="#3.%20%E8%A7%86%E5%9B%BE%E7%9A%84%E5%88%9B%E5%BB%BA" rel="nofollow">3. 视图的创建</a></p> 
<p id="4.%20%E5%AE%8C%E6%95%B4%E6%80%A7%E7%9A%84%E5%88%9B%E5%BB%BA-toc" style="margin-left:40px;"><a href="#4.%20%E5%AE%8C%E6%95%B4%E6%80%A7%E7%9A%84%E5%88%9B%E5%BB%BA" rel="nofollow">4. 完整性的创建</a></p> 
<p id="5.%20%E8%A7%A6%E5%8F%91%E5%99%A8%E5%88%9B%E5%BB%BA-toc" style="margin-left:40px;"><a href="#5.%20%E8%A7%A6%E5%8F%91%E5%99%A8%E5%88%9B%E5%BB%BA" rel="nofollow">5. 触发器创建</a></p> 
<p id="6.%20%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA-toc" style="margin-left:40px;"><a href="#6.%20%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA" rel="nofollow">6. 存储过程的创建</a></p> 
<p id="7.%20%E7%B4%A2%E5%BC%95%E5%88%9B%E5%BB%BA-toc" style="margin-left:40px;"><a href="#7.%20%E7%B4%A2%E5%BC%95%E5%88%9B%E5%BB%BA" rel="nofollow">7. 索引创建</a></p> 
<p id="8.%20%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86-toc" style="margin-left:40px;"><a href="#8.%20%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86" rel="nofollow">8. 数据库权限管理</a></p> 
<p id="9.%20%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D%E7%AD%96%E7%95%A5-toc" style="margin-left:40px;"><a href="#9.%20%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D%E7%AD%96%E7%95%A5" rel="nofollow">9. 备份与恢复策略</a></p> 
<hr id="hr-toc"> 
<p></p> 
<p>安装好navicat和mysql后</p> 
<p>先启动mysql服务，然后使用navicat进行连接，连接成功后点击新建查询</p> 
<p><img alt="" height="683" src="https://images2.imgbox.com/f6/05/b0igKYgs_o.png" width="1200"></p> 
<p></p> 
<h3 id="1.%20%E6%96%B0%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%20(%E6%A8%A1%E5%BC%8F)">1. 新建数据库 (模式)</h3> 
<p>例如创建数据库名字叫library_db ,之后我们新建的表、存储过程等内容都属于这个数据库(模式)</p> 
<pre><code class="language-sql">create database library_db;
use library_db;</code></pre> 
<h3 id="%C2%A02.%20%E5%9F%BA%E6%9C%AC%E8%A1%A8%E7%9A%84%E5%88%9B%E5%BB%BA"> 2. 基本表的创建</h3> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:449.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4da8ee;">readers表</span></p> <p style="margin-left:.0001pt;text-align:justify;">CREATE TABLE readers  (</p> <p style="margin-left:.0001pt;text-align:justify;">  reader_name varchar(20) ,</p> <p style="margin-left:.0001pt;text-align:justify;">  password varchar(35) ,</p> <p style="margin-left:.0001pt;text-align:justify;">  name varchar(10) ,</p> <p style="margin-left:.0001pt;text-align:justify;">  id_num varchar(20) ,</p> <p style="margin-left:.0001pt;text-align:justify;">  phone_num varchar(15)</p> <p style="margin-left:.0001pt;text-align:justify;">);</p> </td></tr><tr><td style="vertical-align:top;width:449.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4da8ee;">managers表</span></p> <p style="margin-left:.0001pt;text-align:justify;">create table managers(</p> <p style="margin-left:.0001pt;text-align:justify;">manager_name varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">password varchar(35),</p> <p style="margin-left:.0001pt;text-align:justify;">name varchar(10),</p> <p style="margin-left:.0001pt;text-align:justify;">id_num varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">phone_num varchar(15),</p> <p style="margin-left:.0001pt;text-align:justify;">entry_time date,</p> <p style="margin-left:.0001pt;text-align:justify;">work_position varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">state varchar(5)</p> <p style="margin-left:.0001pt;text-align:justify;">);</p> </td></tr><tr><td style="vertical-align:top;width:449.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4da8ee;">opinions表</span></p> <p style="margin-left:.0001pt;text-align:justify;"> create table opinions(</p> <p style="margin-left:.0001pt;text-align:justify;">opinion_rec_num int,</p> <p style="margin-left:.0001pt;text-align:justify;">reader_name varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">opinion varchar(100),</p> <p style="margin-left:.0001pt;text-align:justify;">submit_time date,</p> <p style="margin-left:.0001pt;text-align:justify;">state varchar(10)</p> <p style="margin-left:.0001pt;text-align:justify;">);</p> </td></tr><tr><td style="vertical-align:top;width:449.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4da8ee;">books表</span></p> <p style="margin-left:.0001pt;text-align:justify;">create table books(</p> <p style="margin-left:.0001pt;text-align:justify;">book_num int,</p> <p style="margin-left:.0001pt;text-align:justify;">book_name varchar(30),</p> <p style="margin-left:.0001pt;text-align:justify;">book_price float,</p> <p style="margin-left:.0001pt;text-align:justify;">book_state varchar(10),</p> <p style="margin-left:.0001pt;text-align:justify;">book_position varchar(30)</p> <p style="margin-left:.0001pt;text-align:justify;">);</p> </td></tr><tr><td style="vertical-align:top;width:449.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4da8ee;">opinion_results表</span></p> <p style="margin-left:.0001pt;text-align:justify;">create table opinion_results(</p> <p style="margin-left:.0001pt;text-align:justify;">opinion_rec_num int,</p> <p style="margin-left:.0001pt;text-align:justify;">result varchar(100),</p> <p style="margin-left:.0001pt;text-align:justify;">transactor Varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">finish_time date</p> <p style="margin-left:.0001pt;text-align:justify;">);</p> </td></tr><tr><td style="vertical-align:top;width:449.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4da8ee;">borrows表</span></p> <p style="margin-left:.0001pt;text-align:justify;">create table borrows(</p> <p style="margin-left:.0001pt;text-align:justify;">borrow_rec_num int,</p> <p style="margin-left:.0001pt;text-align:justify;">reader_name varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">book_num int,</p> <p style="margin-left:.0001pt;text-align:justify;">borrow_time date,</p> <p style="margin-left:.0001pt;text-align:justify;">transactor varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">borrow_state varchar(10),</p> <p style="margin-left:.0001pt;text-align:justify;">borrow_duration smallint</p> <p style="margin-left:.0001pt;text-align:justify;">);</p> </td></tr><tr><td style="vertical-align:top;width:449.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#4da8ee;">returns表</span></p> <p style="margin-left:.0001pt;text-align:justify;">create table returns(</p> <p style="margin-left:.0001pt;text-align:justify;">borrow_rec_num int,</p> <p style="margin-left:.0001pt;text-align:justify;">return_time date,</p> <p style="margin-left:.0001pt;text-align:justify;">transactor varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">fee float,</p> <p style="margin-left:.0001pt;text-align:justify;">kind varchar(5)</p> <p style="margin-left:.0001pt;text-align:justify;">);</p> </td></tr></tbody></table> 
<h3 id="3.%20%E8%A7%86%E5%9B%BE%E7%9A%84%E5%88%9B%E5%BB%BA">3. 视图的创建</h3> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:452.3pt;"> <p style="margin-left:.0001pt;text-align:justify;">create view reader_message as</p> <p style="margin-left:.0001pt;text-align:justify;">      select reader_name,name,id_num,(substring(now(),1,4)-substring(id_num,7,4))-</p> <p style="margin-left:.0001pt;text-align:justify;">(substring(id_num,11,4)-date_format(now(),'%m%d')&gt;0) as age,phone_num from readers;</p> </td></tr><tr><td style="vertical-align:top;width:452.3pt;"> <p style="margin-left:.0001pt;text-align:justify;">create view manager_message as</p> <p style="margin-left:.0001pt;text-align:justify;">select manager_name,name,id_num,(substring(now(),1,4)-substring(id_num,7,4))-</p> <p style="margin-left:.0001pt;text-align:justify;">(substring(id_num,11,4)-date_format(now(),'%m%d')&gt;0) as age,</p> <p style="margin-left:.0001pt;text-align:justify;"> phone_num,entry_time,work_position,state from managers;</p> </td></tr><tr><td style="vertical-align:top;width:452.3pt;"> <p style="margin-left:.0001pt;text-align:justify;">create view opinion_result_message as select opinions.opinion_rec_num as opinion_rec_num,</p> <p style="margin-left:.0001pt;text-align:justify;">reader_name,opinion,submit_time,state,result,transactor,finish_time</p> <p style="margin-left:.0001pt;text-align:justify;">from (opinions left outer join opinion_results on</p> <p style="margin-left:.0001pt;text-align:justify;"> opinions.opinion_rec_num = opinion_results.opinion_rec_num);</p> </td></tr><tr><td style="vertical-align:top;width:452.3pt;"> <p style="margin-left:.0001pt;text-align:justify;">create view return_message as</p> <p style="margin-left:.0001pt;text-align:justify;">select borrows.borrow_rec_num as borrow_rec_num,reader_name,</p> <p style="margin-left:.0001pt;text-align:justify;">borrows.book_num as book_num,book_name,borrow_time,</p> <p style="margin-left:.0001pt;text-align:justify;">borrows.transactor as borrow_transactor,borrow_state,return_time,</p> <p style="margin-left:.0001pt;text-align:justify;">borrow_duration,returns.transactor as return_transactor,fee,kind from</p> <p style="margin-left:.0001pt;text-align:justify;">borrows left outer join books on borrows.book_num = books.book_num</p> <p style="margin-left:.0001pt;text-align:justify;"> left join returns on borrows.borrow_rec_num = returns.borrow_rec_num;</p> </td></tr><tr><td style="vertical-align:top;width:452.3pt;"> <p style="margin-left:.0001pt;text-align:justify;">create view book_message as</p> <p style="margin-left:.0001pt;text-align:justify;">select book_num,book_name,book_price,book_state,book_position from books;</p> </td></tr></tbody></table> 
<h3 id="4.%20%E5%AE%8C%E6%95%B4%E6%80%A7%E7%9A%84%E5%88%9B%E5%BB%BA">4. 完整性的创建</h3> 
<p>(主键、外键、check、非空、唯一、用户定义完整性、自增)</p> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:458.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">readers表</span></p> <p style="margin-left:.0001pt;text-align:justify;">alter table readers</p> <p style="margin-left:.0001pt;text-align:justify;">modify reader_name varchar(20) primary key,</p> <p style="margin-left:.0001pt;text-align:justify;">modify password varchar(35) not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify name varchar(10) not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify id_num varchar(20) unique,</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT readers_check_id CHECK ((char_length(id_num) = 15) or (char_length(id_num) = 18)),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT readers_check_phone CHECK ((phone_num is null) or (char_length(phone_num) = 11));</p> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">managers表</span></p> <p style="margin-left:.0001pt;text-align:justify;">alter table managers</p> <p style="margin-left:.0001pt;text-align:justify;">modify manager_name varchar(20) primary key,</p> <p style="margin-left:.0001pt;text-align:justify;">modify password varchar(35) not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify name varchar(10) not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify id_num varchar(20) unique,</p> <p style="margin-left:.0001pt;text-align:justify;">modify entry_time date not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify work_position varchar(20) not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify state varchar(5) default '正常',</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT managers_check_id CHECK ((char_length(id_num) = 15) or (char_length(id_num) = 18)),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT managers_check_phone CHECK ((phone_num is null) or (char_length(phone_num) = 11)),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT managers_check_state CHECK(state='正常' or state='注销');</p> </td></tr><tr><td style="vertical-align:top;width:458.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">books表</span></p> <p style="margin-left:.0001pt;text-align:justify;">alter table books</p> <p style="margin-left:.0001pt;text-align:justify;">modify  book_num int primary key auto_increment,</p> <p style="margin-left:.0001pt;text-align:justify;">modify book_name varchar(30) not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify book_price float not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify book_state varchar(10) not null default '不可借',</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT books_check_price CHECK (book_price &gt; 0),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT books_check_state CHECK(book_state='可借' or book_state='不可借');</p> </td></tr><tr><td style="vertical-align:top;width:458.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">opinions表</span></p> <p style="margin-left:.0001pt;text-align:justify;">alter table opinions</p> <p style="margin-left:.0001pt;text-align:justify;">modify  opinion_rec_num int primary key  auto_increment,</p> <p style="margin-left:.0001pt;text-align:justify;">modify opinion varchar(100) not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify submit_time date not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify state varchar(10) default '待处理',</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT opinions_fkey_reader foreign key(reader_name) references readers(reader_name),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT opinions_check_state CHECK(state='待处理' or state='处理完成');</p> </td></tr><tr><td style="vertical-align:top;width:458.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">opinion_results表</span></p> <p style="margin-left:.0001pt;text-align:justify;">alter table opinion_results</p> <p style="margin-left:.0001pt;text-align:justify;">modify opinion_rec_num int primary key,</p> <p style="margin-left:.0001pt;text-align:justify;">modify result varchar(100) not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify finish_time date  not null,</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT opinion_results_fkey_rec_num foreign key(opinion_rec_num)</p> <p style="margin-left:.0001pt;text-align:justify;">references opinions(opinion_rec_num),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT opinion_results_fkey_transactor foreign key(transactor)</p> <p style="margin-left:.0001pt;text-align:justify;">references managers(manager_name);</p> </td></tr><tr><td style="vertical-align:top;width:458.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">borrows表</span></p> <p style="margin-left:.0001pt;text-align:justify;">alter table borrows</p> <p style="margin-left:.0001pt;text-align:justify;">modify borrow_rec_num int primary key auto_increment,</p> <p style="margin-left:.0001pt;text-align:justify;">modify borrow_time date not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify borrow_state varchar(10)  not null default '待还',</p> <p style="margin-left:.0001pt;text-align:justify;">modify borrow_duration smallint not null default 30,</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT borrows_fkey_reader foreign key(reader_name)</p> <p style="margin-left:.0001pt;text-align:justify;">references readers(reader_name),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT borrows_fkey_book foreign key(book_num)</p> <p style="margin-left:.0001pt;text-align:justify;">references books(book_num),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT borrows_fkey_transactor foreign key(transactor)</p> <p style="margin-left:.0001pt;text-align:justify;">references managers(manager_name),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT borrows_check_state CHECK(borrow_state in ('待还','已还'));</p> </td></tr><tr><td style="vertical-align:top;width:458.55pt;"> <p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">returns表</span></p> <p style="margin-left:.0001pt;text-align:justify;">alter table returns</p> <p style="margin-left:.0001pt;text-align:justify;">modify borrow_rec_num int primary key ,</p> <p style="margin-left:.0001pt;text-align:justify;">modify return_time date not null,</p> <p style="margin-left:.0001pt;text-align:justify;">modify kind varchar(5) default '正常',</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT returns_fkey_rec_num foreign key(borrow_rec_num)</p> <p style="margin-left:.0001pt;text-align:justify;">references borrows(borrow_rec_num),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT returns_fkey_transactor foreign key(transactor)</p> <p style="margin-left:.0001pt;text-align:justify;">references managers(manager_name),</p> <p style="margin-left:.0001pt;text-align:justify;">add CONSTRAINT returns_check_kind CHECK(kind in ('正常','丢失'));</p> </td></tr></tbody></table> 
<h3 id="5.%20%E8%A7%A6%E5%8F%91%E5%99%A8%E5%88%9B%E5%BB%BA">5. 触发器创建</h3> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:456.75pt;"> <p style="margin-left:.0001pt;text-align:justify;">create trigger insert_opinion_results after insert on opinion_results</p> <p style="margin-left:.0001pt;text-align:justify;">for each row update opinions set state='处理完成'</p> <p style="margin-left:.0001pt;text-align:justify;">where new.opinion_rec_num = opinions.opinion_rec_num;</p> </td></tr><tr><td style="vertical-align:top;width:456.75pt;"> <p style="margin-left:.0001pt;text-align:justify;">create trigger insert_borrows after insert on borrows</p> <p style="margin-left:.0001pt;text-align:justify;">for each row update books set book_state='不可借'</p> <p style="margin-left:.0001pt;text-align:justify;">where new.book_num = books.book_num;</p> </td></tr><tr><td style="vertical-align:top;width:456.75pt;"> <p style="margin-left:.0001pt;text-align:justify;">create trigger insert_books before insert on  books</p> <p style="margin-left:.0001pt;text-align:justify;">for each row if new.book_position is not null</p> <p style="margin-left:.0001pt;text-align:justify;">       then  set new.book_state='可借';</p> <p style="margin-left:.0001pt;text-align:justify;">   end if;</p> </td></tr><tr><td style="vertical-align:top;width:456.75pt;"> <p style="margin-left:.0001pt;text-align:justify;">create trigger update_books before update on  books</p> <p style="margin-left:.0001pt;text-align:justify;">for each row</p> <p style="margin-left:.0001pt;text-align:justify;">if old.book_position is null and new.book_position is not null</p> <p style="margin-left:.0001pt;text-align:justify;">then  set new.book_state='可借';</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> </td></tr></tbody></table> 
<p></p> 
<h3 id="6.%20%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA">6. 存储过程的创建</h3> 
<table border="1" cellspacing="0"><tbody><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure insert_reader</p> <p style="margin-left:.0001pt;text-align:justify;">(in reader_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in  password varchar(35) ,</p> <p style="margin-left:.0001pt;text-align:justify;">in   name varchar(10) ,</p> <p style="margin-left:.0001pt;text-align:justify;">in  id_num varchar(20) ,</p> <p style="margin-left:.0001pt;text-align:justify;">in  phone_num varchar(15))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">insert into readers values(reader_name_in,password,name,id_num,phone_num);</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure insert_manager</p> <p style="margin-left:.0001pt;text-align:justify;">(in manager_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in  password_in varchar(35) ,</p> <p style="margin-left:.0001pt;text-align:justify;">in   name_in varchar(10) ,</p> <p style="margin-left:.0001pt;text-align:justify;">in  id_num_in varchar(20) ,</p> <p style="margin-left:.0001pt;text-align:justify;">in  phone_num_in varchar(15),</p> <p style="margin-left:.0001pt;text-align:justify;">in entry_time_in date ,</p> <p style="margin-left:.0001pt;text-align:justify;">in work_position_in varchar(20))</p> <p style="margin-left:.0001pt;text-align:justify;">begin insert into managers</p> <p style="margin-left:.0001pt;text-align:justify;">    (manager_name,password,name,id_num,phone_num,entry_time, work_position) values</p> <p style="margin-left:.0001pt;text-align:justify;">(manager_name_in,password_in,name_in,id_num_in,phone_num_in,entry_time_in,work_position_in);  </p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure insert_opinion</p> <p style="margin-left:.0001pt;text-align:justify;">(in reader_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in opinion_in varchar(100),</p> <p style="margin-left:.0001pt;text-align:justify;">in submit_time_in date)</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">insert into opinions(reader_name,opinion,submit_time) values</p> <p style="margin-left:.0001pt;text-align:justify;">(reader_name_in,opinion_in,submit_time_in);</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure insert_book</p> <p style="margin-left:.0001pt;text-align:justify;">(in book_name_in varchar(30),</p> <p style="margin-left:.0001pt;text-align:justify;">in book_price_in float,</p> <p style="margin-left:.0001pt;text-align:justify;">in book_position_in varchar(30))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">    insert into book_message(book_name,book_price,book_position) values</p> <p style="margin-left:.0001pt;text-align:justify;">(book_name_in,book_price_in,book_position_in);</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure insert_opinion_result</p> <p style="margin-left:.0001pt;text-align:justify;">(in opinion_rec_num_in int,</p> <p style="margin-left:.0001pt;text-align:justify;">in result_in varchar(100),</p> <p style="margin-left:.0001pt;text-align:justify;">in transactor_in int,</p> <p style="margin-left:.0001pt;text-align:justify;">in finish_time_in date)</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">    insert into opinion_results(opinion_rec_num,result,transactor,finish_time)</p> <p style="margin-left:.0001pt;text-align:justify;">values (opinion_rec_num_in,result_in,transactor_in,finish_time_in);</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure insert_borrow</p> <p style="margin-left:.0001pt;text-align:justify;">(in reader_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in book_num_in int,</p> <p style="margin-left:.0001pt;text-align:justify;">in borrow_time_in date,</p> <p style="margin-left:.0001pt;text-align:justify;">in transactor_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">out result varchar(10))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">       select exists(select * from reader_message where binary reader_name = reader_name_in)</p> <p style="margin-left:.0001pt;text-align:justify;">into result;</p> <p style="margin-left:.0001pt;text-align:justify;">if result = '0' then  set result = '读者不存在';</p> <p style="margin-left:.0001pt;text-align:justify;">select result;</p> <p style="margin-left:.0001pt;text-align:justify;">commit;</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">select exists(select * from book_message where  book_num = book_num_in) into result;</p> <p style="margin-left:.0001pt;text-align:justify;">if result = '0' then  set result = '图书不存在';</p> <p style="margin-left:.0001pt;text-align:justify;">select result;</p> <p style="margin-left:.0001pt;text-align:justify;">commit;</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">insert into borrows(reader_name,book_num,borrow_time,transactor)</p> <p style="margin-left:.0001pt;text-align:justify;">values (reader_name_in,book_num_in,borrow_time_in,transactor_in);</p> <p style="margin-left:.0001pt;text-align:justify;">select '成功';</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure insert_return</p> <p style="margin-left:.0001pt;text-align:justify;">(in borrow_rec_num_in int,</p> <p style="margin-left:.0001pt;text-align:justify;">in return_time_in date,</p> <p style="margin-left:.0001pt;text-align:justify;">in transactor_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in kind_in varchar(5),</p> <p style="margin-left:.0001pt;text-align:justify;">out fee_out float)</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">declare price float;</p> <p style="margin-left:.0001pt;text-align:justify;">DECLARE latetime SMALLINT ;</p> <p style="margin-left:.0001pt;text-align:justify;">declare fee_out float default null;</p> <p style="margin-left:.0001pt;text-align:justify;">declare book_num_temp int;</p> <p style="margin-left:.0001pt;text-align:justify;">declare borrow_time_temp date;</p> <p style="margin-left:.0001pt;text-align:justify;">declare borrow_duration_temp smallint;</p> <p style="margin-left:.0001pt;text-align:justify;"></p> <p style="margin-left:.0001pt;text-align:justify;">SELECT book_num ,borrow_time ,borrow_duration INTO</p> <p style="margin-left:.0001pt;text-align:justify;"> book_num_temp,borrow_time_temp,borrow_duration_temp</p> <p style="margin-left:.0001pt;text-align:justify;">FROM borrows WHERE borrow_rec_num = borrow_rec_num_in ;</p> <p style="margin-left:.0001pt;text-align:justify;"></p> <p style="margin-left:.0001pt;text-align:justify;">SELECT book_price into price FROM books WHERE book_num = book_num_temp;</p> <p style="margin-left:.0001pt;text-align:justify;"></p> <p style="margin-left:.0001pt;text-align:justify;">    SET latetime = datediff(return_time_in,borrow_time_temp) - borrow_duration_temp;</p> <p style="margin-left:.0001pt;text-align:justify;"></p> <p style="margin-left:.0001pt;text-align:justify;">    UPDATE borrows SET borrow_state = '已还' WHERE borrow_rec_num = borrow_rec_num_in;</p> <p style="margin-left:.0001pt;text-align:justify;">IF kind_in = '正常' THEN UPDATE books SET book_state = '可借' WHERE</p> <p style="margin-left:.0001pt;text-align:justify;">                       book_num = book_num_temp;</p> <p style="margin-left:.0001pt;text-align:justify;">IF latetime &gt; 0 THEN SET fee_out = 0.1 * latetime;</p> <p style="margin-left:.0001pt;text-align:justify;">END IF;</p> <p style="margin-left:.0001pt;text-align:justify;">ELSE UPDATE books SET book_position = NULL WHERE book_num = book_num_temp;</p> <p style="margin-left:.0001pt;text-align:justify;">                    set fee_out = price;</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">    insert into returns(borrow_rec_num,return_time,transactor,fee,kind)</p> <p style="margin-left:.0001pt;text-align:justify;">values (borrow_rec_num_in,return_time_in,transactor_in,fee_out,kind_in);</p> <p style="margin-left:.0001pt;text-align:justify;">   select fee_out;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure select_reader_message(in reader_name_in varchar(20))</p> <p style="margin-left:.0001pt;text-align:justify;">begin  </p> <p style="margin-left:.0001pt;text-align:justify;">select * from reader_message where binary reader_name = reader_name_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure select_manager_message(in manager_name_in varchar(20))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">select * from manager_message where binary manager_name = manager_name_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE procedure select_book_message(in book_name_in varchar(30))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">select * from book_message where book_name like CONCAT('%',book_name_in,'%');</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE PROCEDURE select_book_by_num(in book_num_in int)</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">select * from book_message where book_num = book_num_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE  PROCEDURE select_opinion(in opinion_rec_num_in  int)</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">select opinion,state  from opinion_result_message where opinion_rec_num = opinion_rec_num_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure select_opinion_result_message(in reader_name_in varchar(20))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">  select * from opinion_result_message where binary reader_name</p> <p style="margin-left:.0001pt;text-align:justify;">       = reader_name_in order by submit_time desc  limit 10;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure select_pending_opinion()</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">  select * from opinions where state = '待处理' order by submit_time limit 10;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure select_return_message(in reader_name_in varchar(20))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">  select * from return_message where binary reader_name</p> <p style="margin-left:.0001pt;text-align:justify;">       = reader_name_in order by borrow_time desc  limit 10;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE  PROCEDURE select_borrow_by_booknum(in book_num_in int)</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">select * from return_message where borrow_state = '待还' and</p> <p style="margin-left:.0001pt;text-align:justify;">book_num = book_num_in limit 1;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure update_reader_message</p> <p style="margin-left:.0001pt;text-align:justify;">(in reader_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in name_in varchar(10),</p> <p style="margin-left:.0001pt;text-align:justify;">in id_num_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in phone_num_in varchar(15))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">  update reader_message set name = name_in , id_num = id_num_in ,</p> <p style="margin-left:.0001pt;text-align:justify;">  phone_num = phone_num_in where binary reader_name = reader_name_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure update_reader_password</p> <p style="margin-left:.0001pt;text-align:justify;">(in password_in varchar(35))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;"> update readers set password = password_in where binary reader_name = reader_name_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE  PROCEDURE update_manager_message(in manager_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in name_in varchar(10),</p> <p style="margin-left:.0001pt;text-align:justify;">in id_num_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in phone_num_in varchar(15))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;"> update manager_message set name = name_in , id_num = id_num_in ,</p> <p style="margin-left:.0001pt;text-align:justify;"> phone_num = phone_num_in where binary manager_name = manager_name_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE  PROCEDURE update_manager_password</p> <p style="margin-left:.0001pt;text-align:justify;">(in manager_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in password_in varchar(35))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;"> update managers set password = password_in where binary manager_name = manager_name_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE  PROCEDURE update_manager_work</p> <p style="margin-left:.0001pt;text-align:justify;">(in manager_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in work_position_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in state_in varchar(5))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">update managers set work_position = work_position_in ,state = state_in</p> <p style="margin-left:.0001pt;text-align:justify;">where binary manager_name = manager_name_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE  PROCEDURE update_book</p> <p style="margin-left:.0001pt;text-align:justify;">(in book_num_in int,</p> <p style="margin-left:.0001pt;text-align:justify;">in book_name_in varchar(30),</p> <p style="margin-left:.0001pt;text-align:justify;">in book_price_in float,</p> <p style="margin-left:.0001pt;text-align:justify;">in book_state_in varchar(10),</p> <p style="margin-left:.0001pt;text-align:justify;">in book_position_in varchar(30))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">update book_message set book_name = book_name_in ,book_price = book_price_in,</p> <p style="margin-left:.0001pt;text-align:justify;">book_state = book_state_in,book_position = book_position_in</p> <p style="margin-left:.0001pt;text-align:justify;">where book_num = book_num_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE  PROCEDURE delete_book</p> <p style="margin-left:.0001pt;text-align:justify;">(in book_num_in int,</p> <p style="margin-left:.0001pt;text-align:justify;">out result varchar(10))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">select exists(select * from book_message where  book_num = book_num_in) into result;</p> <p style="margin-left:.0001pt;text-align:justify;">if result = '0' then  set result = '图书不存在';</p> <p style="margin-left:.0001pt;text-align:justify;">select result;</p> <p style="margin-left:.0001pt;text-align:justify;">commit;</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">update book_message set book_state = '不可借',book_position = null</p> <p style="margin-left:.0001pt;text-align:justify;">where book_num = book_num_in;</p> <p style="margin-left:.0001pt;text-align:justify;">select '成功';</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE  PROCEDURE delete_manager</p> <p style="margin-left:.0001pt;text-align:justify;">(in manager_name_in varchar(30))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">update managers set state = '注销'</p> <p style="margin-left:.0001pt;text-align:justify;">where binary manager_name = manager_name_in;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">CREATE PROCEDURE extend_time</p> <p style="margin-left:.0001pt;text-align:justify;">(in book_num_in int ,</p> <p style="margin-left:.0001pt;text-align:justify;">out result varchar(5))</p> <p style="margin-left:.0001pt;text-align:justify;">begin declare latetime smallint;</p> <p style="margin-left:.0001pt;text-align:justify;">declare result varchar(5) default '成功';</p> <p style="margin-left:.0001pt;text-align:justify;">declare borrow_rec_num_in int;</p> <p style="margin-left:.0001pt;text-align:justify;">set borrow_rec_num_in =</p> <p style="margin-left:.0001pt;text-align:justify;">(select borrow_rec_num from borrows where borrow_state = '待还' and book_num = book_num_in);</p> <p style="margin-left:.0001pt;text-align:justify;"></p> <p style="margin-left:.0001pt;text-align:justify;">      select CURDATE() - borrow_time - borrow_duration into latetime</p> <p style="margin-left:.0001pt;text-align:justify;">   from borrows where borrow_rec_num = borrow_rec_num_in;</p> <p style="margin-left:.0001pt;text-align:justify;">if latetime &gt; 0  then set result = '超期';</p> <p style="margin-left:.0001pt;text-align:justify;">else  update borrows set borrow_duration = borrow_duration + 15</p> <p style="margin-left:.0001pt;text-align:justify;">  where borrow_rec_num = borrow_rec_num_in;</p> <p style="margin-left:.0001pt;text-align:justify;">   end if;   </p> <p style="margin-left:.0001pt;text-align:justify;">select result;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure check_reader</p> <p style="margin-left:.0001pt;text-align:justify;">(in reader_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in password_in varchar(35),</p> <p style="margin-left:.0001pt;text-align:justify;">out result varchar(5))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">    if password_in = (select password from readers where binary reader_name = reader_name_in)</p> <p style="margin-left:.0001pt;text-align:justify;">  then  set result = '正确';</p> <p style="margin-left:.0001pt;text-align:justify;">else set result = '错误';</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">select result;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure check_manager</p> <p style="margin-left:.0001pt;text-align:justify;">(in manager_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in password_in varchar(35),</p> <p style="margin-left:.0001pt;text-align:justify;">out result varchar(5))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">set result = '错误';</p> <p style="margin-left:.0001pt;text-align:justify;">    if password_in =</p> <p style="margin-left:.0001pt;text-align:justify;">(select password from managers where binary manager_name = manager_name_in)</p> <p style="margin-left:.0001pt;text-align:justify;">then  set result = '正确';</p> <p style="margin-left:.0001pt;text-align:justify;">if '注销' = (select state from managers where binary manager_name = manager_name_in)</p> <p style="margin-left:.0001pt;text-align:justify;">then  set result = '注销';</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">select result;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure check_manager_sigh_up</p> <p style="margin-left:.0001pt;text-align:justify;">(in manager_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in  id_num_in varchar(20) ,</p> <p style="margin-left:.0001pt;text-align:justify;">out result varchar(10))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">    select exists(select * from managers where binary manager_name = manager_name_in) into result;</p> <p style="margin-left:.0001pt;text-align:justify;">if result = '1' then  set result = '用户名已存在';</p> <p style="margin-left:.0001pt;text-align:justify;">select result;</p> <p style="margin-left:.0001pt;text-align:justify;">commit;</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">select exists(select * from managers where id_num = id_num_in) into result;</p> <p style="margin-left:.0001pt;text-align:justify;">if result = '1' then set result = '身份证号已被注册';</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">if result = '0' then select 'OK';</p> <p style="margin-left:.0001pt;text-align:justify;">else select result;</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr><tr><td style="vertical-align:top;width:457.5pt;"> <p style="margin-left:.0001pt;text-align:justify;">create procedure check_reader_sigh_up</p> <p style="margin-left:.0001pt;text-align:justify;">(in reader_name_in varchar(20),</p> <p style="margin-left:.0001pt;text-align:justify;">in  id_num_in varchar(20) ,</p> <p style="margin-left:.0001pt;text-align:justify;">out result varchar(10))</p> <p style="margin-left:.0001pt;text-align:justify;">begin</p> <p style="margin-left:.0001pt;text-align:justify;">    select exists(select * from readers where binary reader_name = reader_name_in) into result;</p> <p style="margin-left:.0001pt;text-align:justify;">if result = '1' then  set result = '用户名已存在';</p> <p style="margin-left:.0001pt;text-align:justify;">select result;</p> <p style="margin-left:.0001pt;text-align:justify;">commit;</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">select exists(select * from readers where id_num = id_num_in) into result;</p> <p style="margin-left:.0001pt;text-align:justify;">if result = '1' then set result = '身份证号已被注册';</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">if result = '0' then select 'OK';</p> <p style="margin-left:.0001pt;text-align:justify;">else select result;</p> <p style="margin-left:.0001pt;text-align:justify;">end if;</p> <p style="margin-left:.0001pt;text-align:justify;">end</p> </td></tr></tbody></table> 
<h3 id="7.%20%E7%B4%A2%E5%BC%95%E5%88%9B%E5%BB%BA" style="margin-left:.0001pt;text-align:justify;">7. 索引创建</h3> 
<p style="margin-left:.0001pt;text-align:justify;">mysql创建表时默认引擎InnoDB，如果表有主键，会建立主键聚集索引，如果一个字段有unique约束，会建立unique索引,如果一个字段有外键约束，会建立外键索引。在此基础上我们只多建立一个索引,books表的book_name字段建立非聚集索引。</p> 
<p style="margin-left:.0001pt;text-align:justify;">create index book_name_index on books(book_name);</p> 
<p style="margin-left:.0001pt;text-align:justify;">给books表的book_name创建非聚集索引,其他索引由数据库引擎创建</p> 
<p>                                完成后各表上的索引如下</p> 
<p><img alt="" height="830" src="https://images2.imgbox.com/9b/f3/WqSjAFuf_o.png" width="1200"></p> 
<p>各字段解析如下</p> 
<table border="1" cellspacing="0" style="width:455.4pt;"><tbody><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Table</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">表示创建索引的数据表名。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Non_unique</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">表示该索引是否是唯一索引。若不是唯一索引，则该列的值为 1；若是唯一索引，则该列的值为 0。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Key_name</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">表示索引的名称。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Seq_in_index</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">表示该列在索引中的位置，如果索引是单列的，则该列的值为 1；如果索引是组合索引，则该列的值为每列在索引定义中的顺序。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Column_name</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">表示定义索引的列字段。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Collation</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">表示列以何种顺序存储在索引中。在 MySQL 中，升序显示值“A”（升序），若显示为 NULL，则表示无分类。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Cardinality</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">索引中唯一值数目的估计值。基数根据被存储为整数的统计数据计数，所以即使对于小型表，该值也没有必要是精确的。基数越大，当进行联合时，MySQL 使用该索引的机会就越大。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Sub_part</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">表示列中被编入索引的字符的数量。若列只是部分被编入索引，则该列的值为被编入索引的字符的数目；若整列被编入索引，则该列的值为 NULL。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Packed</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">指示关键字如何被压缩。若没有被压缩，值为 NULL。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Null</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">用于显示索引列中是否包含 NULL。若列含有 NULL，该列的值为 YES。若没有，则该列的值为 NO。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Index_type</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">显示索引使用的类型和方法（BTREE、FULLTEXT、HASH、RTREE）。</span></p> </td></tr><tr><td style="width:58.85pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">Comment</span></p> </td><td style="width:396.55pt;"> <p style="margin-left:.0001pt;text-align:left;"><span style="color:#444444;">显示评注。</span></p> </td></tr></tbody></table> 
<p></p> 
<h3 id="8.%20%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86">8. 数据库权限管理</h3> 
<p style="margin-left:.0001pt;text-align:justify;">使用严格的权限管理，只有允许的操作才能进行；有三类用户使用数据库,创建reader,manager,sys_manager。每个用户只授权某些函数的执行，不允许修改,也不允许权限传递，更不能直接接触到表，这样保证数据库的安全性和独立性(只通过函数接口访问)。</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">除了这三个用户外，实现时还使用一个checker用户,这个用户负责在我们没有登录成功前，连接数据库进行用户检查，检查通过后，建立用户连接进行数据库操作(reader/manager/sys_manager), 同时checker连接释放，另外读者用户注册也需要checker帮助传递读者信息到数据库完成注册,manager的注册有sys_manager负责验证。</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">                                                        各用户授予权限如下</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="505" src="https://images2.imgbox.com/88/f2/yIO1fp3K_o.png" width="1200"></p> 
<p> <img alt="" height="1056" src="https://images2.imgbox.com/fa/a3/jZ3Rv9bd_o.png" width="1200"></p> 
<p><img alt="" height="429" src="https://images2.imgbox.com/5b/db/9KhOkKYE_o.png" width="1200"><img alt="" height="361" src="https://images2.imgbox.com/69/b9/rHnn3rGQ_o.png" width="1200"> </p> 
<p></p> 
<p>（关于创建用户和授权可以参考以下代码</p> 
<p style="margin-left:.0001pt;text-align:left;">CREATE USER 'checker'@'localhost' IDENTIFIED BY 'checkerpassword';  #其他类似</p> 
<p style="margin-left:.0001pt;text-align:left;">...................</p> 
<p style="margin-left:.0001pt;text-align:left;">grant execute on procedure library_db.insert_opinion to 'reader'@'localhost';</p> 
<p style="margin-left:.0001pt;text-align:left;">........................）</p> 
<p style="margin-left:.0001pt;text-align:left;">（也可以使用navicat图形化的方式创建，百度一下）</p> 
<p></p> 
<h3 id="9.%20%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D%E7%AD%96%E7%95%A5">9. 备份与恢复策略(可不做，但是做了的话比较完善)</h3> 
<p style="margin-left:.0001pt;text-align:justify;">采取海量+增量的方式备份数据。 每周进行一次海量备份，两次海量备份之间采用增量备份方式。由于mysql不直接提供增量备份方式，故采用日志记录的方式来实现增量备份。</p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">备份流程如下:</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">1.在配置文件开启二进制日志功能，设置日志地址（根据），服务id  如图</span></p> 
<p style="margin-left:.0001pt;text-align:justify;">       <img alt="" height="563" src="https://images2.imgbox.com/7d/8c/dUlCElhf_o.png" width="1123"></p> 
<p><span style="color:#956fe7;"> 注:backup 文件夹需要自己创建、mysql-bin是日志文件的命名方式，不用创建，结合下图看看</span></p> 
<p><img alt="" height="475" src="https://images2.imgbox.com/c9/f1/azTIiic7_o.png" width="1107"></p> 
<p> <img alt="" height="297" src="https://images2.imgbox.com/ff/80/Lq5Mxt7e_o.png" width="1122"></p> 
<p></p> 
<p></p> 
<p style="text-align:justify;"><span style="color:#0000ff;">2.先进行海量备份如</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">mysqldump -u root -p -R library_db&gt; C:\Users\Administrator\Desktop\library_db.sql </span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">或者使用navicat图形化进行备份</span></p> 
<p></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">3.之后mysql会记录执行日志，保存到我们指定的地址,命名是mysql-bin.00000x 这样我们就可以通过海量备份加日志的方式恢复数据。(从mysql-bin.000001开始计数)</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">示例恢复如下：</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">1.先恢复海量备份</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">mysql -u root -p  &lt; C:\Users\Administrator\Desktop\library_db.sql </span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">2.再利用日志逐个循环恢复增量备份 （到日志目录文件夹下执行恢复命令）</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">mysqlbinlog --no-defaults mysql-bin.000001 | mysql -uroot -p+密码</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">(如mysqlbinlog --no-defaults mysql-bin.000001 | mysql -uroot -p123456) </span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">mysqlbinlog --no-defaults mysql-bin.00000</span><span style="color:#0000ff;">2</span><span style="color:#0000ff;"> | mysql -uroot -p+密码</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#0000ff;">.........</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">实际运行时备份方式采用navicat创建一个批处理作业，指定执行全量备份，然后重置日志，(从000001开始计数)，执行时间为每周日凌晨2点 ，设置如下图</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="398" src="https://images2.imgbox.com/73/5b/FnNfzT8o_o.png" width="1200"></p> 
<p style="margin-left:.0001pt;text-align:justify;"><span style="color:#fe2c24;">注:每次进行恢复后，需要重新对存储过程进行授权</span></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p></p> 
<p>至此数据库实现完成。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c36ac9dcf9c2aa1e76ee7fe80a54edcf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解析Hadoop三大核心组件：HDFS、MapReduce和YARN</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3032d35649cec23f5e257071a60d53ef/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">一起玩儿物联网人工智能小车（ESP32）——71 姿态传感器MPU6050的使用方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>