<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring AI 第三讲Embeddings（嵌入式） Model API 第一讲Ollama 嵌入 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/71dccf454bb998e93f6214868140bef9/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Spring AI 第三讲Embeddings（嵌入式） Model API 第一讲Ollama 嵌入">
  <meta property="og:description" content="有了 Ollama，你可以在本地运行各种大型语言模型 (LLM)，并从中生成嵌入。Spring AI 通过 OllamaEmbeddingModel 支持 Ollama 文本嵌入。
嵌入是一个浮点数向量（列表）。两个向量之间的距离可以衡量它们之间的相关性。距离小表示关联度高，距离大表示关联度低。
前提条件 首先需要在本地计算机上运行 Ollama。
请参阅官方 Ollama 项目 README，开始在本地计算机上运行模型。
安装 Ollama 运行 llama3 将下载一个 4.7GB 的模型工件。
添加资源库和 BOM Spring AI 工件发布在 Spring Milestone 和 Snapshot 资源库中。请参阅 &#34;资源库&#34;部分，将这些资源库添加到您的构建系统中。
为了帮助进行依赖性管理，Spring AI 提供了一个 BOM（物料清单），以确保在整个项目中使用一致的 Spring AI 版本。请参阅 &#34;依赖关系管理 &#34;部分，将 Spring AI BOM 添加到构建系统中。
自动配置 Spring AI 为 Azure Ollama 嵌入式客户端提供 Spring Boot 自动配置功能。要启用它，请在 Maven pom.xml 文件中添加以下依赖关系：
&lt;dependency&gt; &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt; &lt;artifactId&gt;spring-ai-ollama-spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; 或 Gradle build.gradle 构建文件。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-10T22:44:30+08:00">
    <meta property="article:modified_time" content="2024-06-10T22:44:30+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring AI 第三讲Embeddings（嵌入式） Model API 第一讲Ollama 嵌入</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>有了 <a class="link-info" href="https://ollama.ai/" rel="nofollow" title="Ollama">Ollama</a>，你可以在本地运行各种大型语言模型 (LLM)，并从中生成嵌入。Spring AI 通过 OllamaEmbeddingModel 支持 Ollama 文本嵌入。</p> 
<p>嵌入是一个浮点数向量（列表）。两个向量之间的距离可以衡量它们之间的相关性。距离小表示关联度高，距离大表示关联度低。</p> 
<h2>前提条件</h2> 
<p>首先需要在本地计算机上运行 Ollama。</p> 
<p>请参阅官方 Ollama 项目 <a class="link-info" href="https://github.com/ollama/ollama" title="README">README</a>，开始在本地计算机上运行模型。</p> 
<blockquote> 
 <p>安装 Ollama 运行 llama3 将下载一个 4.7GB 的模型工件。</p> 
</blockquote> 
<h3>添加资源库和 BOM</h3> 
<p>Spring AI 工件发布在 Spring Milestone 和 Snapshot 资源库中。请参阅 "<a class="link-info" href="https://docs.spring.io/spring-ai/reference/getting-started.html#repositories" rel="nofollow" title="资源库">资源库</a>"部分，将这些资源库添加到您的构建系统中。</p> 
<p>为了帮助进行依赖性管理，Spring AI 提供了一个 BOM（物料清单），以确保在整个项目中使用一致的 Spring AI 版本。请参阅 "依赖关系管理 "部分，将 Spring AI BOM 添加到构建系统中。</p> 
<h2>自动配置</h2> 
<p>Spring AI 为 Azure Ollama 嵌入式客户端提供 Spring Boot 自动配置功能。要启用它，请在 Maven pom.xml 文件中添加以下依赖关系：</p> 
<pre><code class="language-java">&lt;dependency&gt;
   &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;
   &lt;artifactId&gt;spring-ai-ollama-spring-boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre> 
<p> 或 Gradle build.gradle 构建文件。</p> 
<pre><code class="language-Groovy">dependencies {
    implementation 'org.springframework.ai:spring-ai-ollama-spring-boot-starter'
}</code></pre> 
<blockquote> 
 <p>请参阅 "依赖关系管理 "部分，将 Spring AI BOM 添加到构建文件中</p> 
</blockquote> 
<p>spring.ai.ollama.embedding.options.* 属性用于配置所有嵌入请求的默认选项。(它作为 OllamaEmbeddingModel#withDefaultOptions() 实例使用）。</p> 
<h3>嵌入属性</h3> 
<p>前缀 spring.ai.ollama 是配置与 Ollama 连接的属性前缀</p> 
<table><thead><tr><th>Property</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td> <p>spring.ai.ollama.base-url</p> </td><td>运行 Ollama API 服务器的基本 URL。</td><td> <p><code><a href="http://localhost:11434/" rel="nofollow" title="localhost:11434">localhost:11434</a></code></p> </td></tr></tbody></table> 
<p>The prefix <code>spring.ai.ollama.embedding.options</code> is the property prefix that configures the <code>EmbeddingModel</code> implementation for Ollama.</p> 
<table><thead><tr><th>Property</th><th>Description</th><th>Default</th></tr></thead><tbody><tr><td> <p>spring.ai.ollama.embedding.enabled</p> </td><td>启用 Ollama 嵌入模型。</td><td> <p>true</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.model</p> </td><td>要使用的<a class="link-info" href="https://github.com/ollama/ollama?tab=readme-ov-file#model-library" title="支持模型">支持模型</a>名称。</td><td> <p>mistral</p> </td></tr></tbody></table> 
<p> 其余选项属性基于 <a class="link-info" href="https://github.com/ollama/ollama/blob/main/docs/modelfile.md#valid-parameters-and-values" title="Ollama 有效参数和值">Ollama 有效参数和值</a>以及<a class="link-info" href="https://github.com/ollama/ollama/blob/main/api/types.go" title="Ollama 类型">Ollama 类型</a>。默认值基于Ollama <a class="link-info" href="https://github.com/ollama/ollama/blob/b538dc3858014f94b099730a592751a5454cab0a/api/types.go#L364" title="类型默认值">类型默认值</a>。</p> 
<table><tbody><tr><td> <p>Property</p> </td><td> <p>Description</p> </td><td> <p>Default</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.numa</p> </td><td>是否使用 NUMA。</td><td> <p>false</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.num-ctx</p> </td><td>设置用于生成下一个标记的上下文窗口的大小。</td><td> <p>2048</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.num-batch</p> </td><td> <p></p> </td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.num-gqa</p> </td><td>变压器层中 GQA 组的数量。某些型号需要，例如 llama2:70b 为 8。</td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.num-gpu</p> </td><td>要发送到 GPU 的层数。在 macOS 上，默认值为 1 表示启用金属支持，0 表示禁用。</td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.main-gpu</p> </td><td></td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.low-vram</p> </td><td></td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.f16-kv</p> </td><td></td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.logits-all</p> </td><td></td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.vocab-only</p> </td><td></td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.use-mmap</p> </td><td></td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.use-mlock</p> </td><td> <p></p> </td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.num-thread</p> </td><td>设置计算时使用的线程数。默认情况下，Ollama 会检测线程数以获得最佳性能。建议将此值设置为系统的物理 CPU 内核数（而非逻辑内核数）。</td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.num-keep</p> </td><td> <p></p> </td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.seed</p> </td><td>设置生成文本时使用的随机数种子。将其设置为一个特定的数字将使模型为相同的提示生成相同的文本。</td><td> <p>0</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.num-predict</p> </td><td>生成文本时要预测的最大标记数。(默认值：128，-1 = 无限生成，-2 = 填充上下文）</td><td> <p>128</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.top-k</p> </td><td>降低产生无意义答案的概率。数值越大（如 100），答案就越多样化，而数值越小（如 10），答案就越保守。</td><td> <p>40</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.top-p</p> </td><td>与 top-k 一起使用。较高的值（如 0.95）将产生更多样化的文本，而较低的值（如 0.5）将产生更集中和保守的文本。</td><td> <p>0.9</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.tfs-z</p> </td><td>无尾采样用于减少输出中可能性较低的标记的影响。数值越大（例如 2.0），影响越小，而数值为 1.0 时，则会禁用此设置。</td><td> <p>1</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.typical-p</p> </td><td> <p></p> </td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.repeat-last-n</p> </td><td>设置模型回溯多远以防止重复。(默认值：64，0 = 禁用，-1 = num_ctx）</td><td> <p>64</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.temperature</p> </td><td>模型的温度。温度越高，模型的答案越有创意。</td><td> <p>0.8</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.repeat-penalty</p> </td><td>设置对重复的惩罚力度。数值越大（如 1.5），对重复的惩罚力度就越大，而数值越小（如 0.9），惩罚力度就越宽松。</td><td> <p>1.1</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.presence-penalty</p> </td><td></td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.frequency-penalty</p> </td><td></td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.mirostat</p> </td><td>启用 Mirostat 采样以控制复杂度。(默认值：0，0 = 禁用，1 = Mirostat，2 = Mirostat 2.0）</td><td> <p>0</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.mirostat-tau</p> </td><td>控制输出的连贯性和多样性之间的平衡。数值越小，文字越集中、连贯。</td><td> <p>5.0</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.mirostat-eta</p> </td><td>影响算法对生成文本的反馈做出反应的速度。学习率越低，算法的调整速度就越慢，而学习率越高，算法的反应速度就越快。</td><td> <p>0.1</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.penalize-newline</p> </td><td> <p></p> </td><td> <p>-</p> </td></tr><tr><td> <p>spring.ai.ollama.embedding.options.stop</p> </td><td>设置要使用的停止序列。遇到这种模式时，LLM 将停止生成文本并返回。可以通过在模型文件中指定多个单独的停止参数来设置多个停止模式。</td><td> <p>-</p> </td></tr></tbody></table> 
<p>所有以 spring.ai.ollama.embedding.options 为前缀的属性都可以通过在 EmbeddingRequest 调用中添加特定于请求的 <a class="link-info" href="https://docs.spring.io/spring-ai/reference/api/embeddings/ollama-embeddings.html#embedding-options" rel="nofollow" title="Runtime Options">Runtime Options</a> 来在运行时重写。</p> 
<h2>运行时选项</h2> 
<p><a class="link-info" href="https://github.com/spring-projects/spring-ai/blob/main/models/spring-ai-ollama/src/main/java/org/springframework/ai/ollama/api/OllamaOptions.java" title="OllamaOptions">OllamaOptions</a>.java 提供了 Ollama 配置，如要使用的模型、底层 GPU 和 CPU 调整等。</p> 
<p>默认选项也可使用 spring.ai.ollama.embedding.options 属性进行配置。</p> 
<p>启动时，使用 OllamaEmbeddingModel#withDefaultOptions() 配置用于所有嵌入请求的默认选项。在运行时，你可以使用作为 EmbeddingRequest 一部分的 OllamaOptions 实例来覆盖默认选项。</p> 
<p>例如，要覆盖特定请求的默认模型名称：</p> 
<pre><code class="language-java">EmbeddingResponse embeddingResponse = embeddingModel.call(
    new EmbeddingRequest(List.of("Hello World", "World is big and salvation is near"),
        OllamaOptions.create()
            .withModel("Different-Embedding-Model-Deployment-Name"));</code></pre> 
<h2>示例Controller</h2> 
<p>这将创建一个 EmbeddingModel 实现，您可以将其注入到您的类中。下面是一个使用 EmbeddingModel 实现的简单 @Controller 类示例。</p> 
<pre><code class="language-java">@RestController
public class EmbeddingController {

    private final EmbeddingModel embeddingModel;

    @Autowired
    public EmbeddingController(EmbeddingModel embeddingModel) {
        this.embeddingModel = embeddingModel;
    }

    @GetMapping("/ai/embedding")
    public Map embed(@RequestParam(value = "message", defaultValue = "Tell me a joke") String message) {
        EmbeddingResponse embeddingResponse = this.embeddingModel.embedForResponse(List.of(message));
        return Map.of("embedding", embeddingResponse);
    }
}</code></pre> 
<h2>手动配置</h2> 
<p>如果不使用 Spring Boot，可以手动配置 OllamaEmbeddingModel。为此，请在项目的 Maven pom.xml 文件中添加 spring-ai-ollama 依赖关系：</p> 
<pre><code class="language-XML">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;
    &lt;artifactId&gt;spring-ai-ollama&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre> 
<p>或 Gradle build.gradle 构建文件。</p> 
<pre><code class="language-Groovy">dependencies {
    implementation 'org.springframework.ai:spring-ai-ollama'
}</code></pre> 
<p>请参阅 "依赖关系管理 "部分，将 Spring AI BOM 添加到构建文件中。</p> 
<p>spring-ai-ollama 依赖关系还提供对 OllamaChatModel 的访问。有关 OllamaChatModel 的更多信息，请参阅<a class="link-info" href="https://docs.spring.io/spring-ai/reference/api/chat/ollama-chat.html" rel="nofollow" title="Ollama Chat Client">Ollama Chat Client</a> 部分。</p> 
<p>接下来，创建一个 OllamaEmbeddingModel 实例，并用它来计算两个输入文本之间的相似度：</p> 
<pre><code class="language-java">var ollamaApi = new OllamaApi();

var embeddingModel = new OllamaEmbeddingModel(ollamaApi)
    .withDefaultOptions(OllamaOptions.create()
			.withModel(OllamaOptions.DEFAULT_MODEL)
            .toMap());

EmbeddingResponse embeddingResponse = embeddingModel
	.embedForResponse(List.of("Hello World", "World is big and salvation is near"));</code></pre> 
<p>OllamaOptions 为所有嵌入请求提供配置信息。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0fee5111f738da6017e22d14b1caa213/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AI作画工具介绍</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bc43ee7c4fc6160947e482922a5d7fbe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C语言详解（文件操作）1</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>