<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Elasticsearch】Elasticsearch的分片和副本机制 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/a99a4dce59434ff17f4eafc0b2c970a1/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【Elasticsearch】Elasticsearch的分片和副本机制">
  <meta property="og:description" content="文章目录 📑前言一、分片（Shard）1.1 分片的定义1.2 分片的重要性1.3 分片的类型1.4 分片的分配 二、副本（Replica）2.1 副本的定义2.2 副本的重要性2.3 副本的分配 三、分片和副本的机制3.1 分片的创建和分配3.2 数据写入过程3.3 数据读取过程 四、分片和副本的配置4.1 配置分片数量4.2 配置副本数量4.3 分片和副本的最佳实践 五、分片和副本的故障恢复5.1 主分片故障恢复5.2 副本分片故障恢复5.3 故障恢复的配置 六、分片和副本的监控6.1 监控分片状态6.2 监控集群健康状态6.3 监控指标 七、小结 📑前言 Elasticsearch是一种分布式搜索和分析引擎，它具有高扩展性和高可用性。为了实现这些特性，Elasticsearch引入了分片（Shard）和副本（Replica）的概念。本文将详细介绍Elasticsearch中的分片和副本机制，帮助读者理解它们的重要性及其实现方法。
一、分片（Shard） 1.1 分片的定义 分片是Elasticsearch中存储数据的基本单位。一个索引可以由多个分片组成，每个分片都是一个独立的Lucene索引。通过分片，Elasticsearch可以将数据分布到多个节点上，从而实现数据的分布式存储和并行处理。
1.2 分片的重要性 分片机制使Elasticsearch具有以下优势：
水平扩展：通过增加分片数量，可以水平扩展索引的存储容量和处理能力。并行处理：分片可以分布在不同的节点上，允许多个节点并行处理查询和索引请求，提高系统的性能和吞吐量。数据分布：分片机制使数据可以分布在集群的多个节点上，减少单点故障的风险，提高数据的可用性和可靠性。 1.3 分片的类型 Elasticsearch中的分片分为两种类型：
主分片（Primary Shard）：主分片是原始的数据分片，所有的写操作（如索引和删除）都首先作用于主分片。副本分片（Replica Shard）：副本分片是主分片的复制品，用于提高数据的可用性和查询性能。副本分片接收来自主分片的数据更新，并在主分片不可用时提供冗余。 1.4 分片的分配 Elasticsearch在创建索引时，用户可以指定索引的分片数量。默认情况下，一个索引包含5个主分片。分片的数量一旦设置，主分片的数量是无法更改的（除非重新创建索引）。然而，副本分片的数量可以在索引创建后动态调整。
二、副本（Replica） 2.1 副本的定义 副本是主分片的完整复制品，它用于提高系统的容错能力和查询性能。每个主分片可以有多个副本分片，这些副本分片分布在集群的不同节点上。
2.2 副本的重要性 副本机制带来了以下好处：
高可用性：副本分片提供了数据冗余，当主分片所在节点出现故障时，副本分片可以提升为主分片，保证数据的可用性。负载均衡：副本分片可以分担查询负载，减少主分片的压力，提高系统的查询性能和响应速度。数据恢复：当节点发生故障时，副本分片可以用于快速恢复数据，减少系统的停机时间。 2.3 副本的分配 副本分片的数量可以在索引创建时指定，默认情况下，每个主分片有一个副本分片。与主分片不同，副本分片的数量可以在索引创建后动态调整。Elasticsearch会自动管理分片和副本的分配，确保它们分布在集群的不同节点上，以最大限度地提高系统的容错能力和性能。
三、分片和副本的机制 3.1 分片的创建和分配 当创建一个新索引时，Elasticsearch会根据用户指定的分片数量创建主分片，并将这些分片分配到集群中的不同节点上。分片的分配过程如下：
分片创建：Elasticsearch根据索引的分片设置，创建指定数量的主分片。分片分配：Elasticsearch将主分片分配到集群中的不同节点上，确保分片均匀分布。副本创建：Elasticsearch根据索引的副本设置，为每个主分片创建副本分片。副本分配：Elasticsearch将副本分片分配到与主分片不同的节点上，确保数据冗余。 3.2 数据写入过程 在Elasticsearch中，数据的写入过程包括以下步骤：
写请求发送到主分片：所有的写操作（如索引和删除）首先发送到主分片。主分片处理写请求：主分片处理写请求，将数据写入到分片中。写请求同步到副本分片：主分片将写操作同步到所有的副本分片，确保数据的一致性。写操作完成：当所有副本分片确认写操作后，Elasticsearch返回写操作的结果。 3.3 数据读取过程 在Elasticsearch中，数据的读取过程包括以下步骤：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-15T14:01:48+08:00">
    <meta property="article:modified_time" content="2024-07-15T14:01:48+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Elasticsearch】Elasticsearch的分片和副本机制</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">📑前言</a></li><li><a href="#Shard_5" rel="nofollow">一、分片（Shard）</a></li><li><ul><li><a href="#11__7" rel="nofollow">1.1 分片的定义</a></li><li><a href="#12__9" rel="nofollow">1.2 分片的重要性</a></li><li><a href="#13__15" rel="nofollow">1.3 分片的类型</a></li><li><a href="#14__20" rel="nofollow">1.4 分片的分配</a></li></ul> 
  </li><li><a href="#Replica_22" rel="nofollow">二、副本（Replica）</a></li><li><ul><li><a href="#21__23" rel="nofollow">2.1 副本的定义</a></li><li><a href="#22__25" rel="nofollow">2.2 副本的重要性</a></li><li><a href="#23__31" rel="nofollow">2.3 副本的分配</a></li></ul> 
  </li><li><a href="#_33" rel="nofollow">三、分片和副本的机制</a></li><li><ul><li><a href="#31__35" rel="nofollow">3.1 分片的创建和分配</a></li><li><a href="#32__42" rel="nofollow">3.2 数据写入过程</a></li><li><a href="#33__49" rel="nofollow">3.3 数据读取过程</a></li></ul> 
  </li><li><a href="#_56" rel="nofollow">四、分片和副本的配置</a></li><li><ul><li><a href="#41__57" rel="nofollow">4.1 配置分片数量</a></li><li><a href="#42__69" rel="nofollow">4.2 配置副本数量</a></li><li><a href="#43__78" rel="nofollow">4.3 分片和副本的最佳实践</a></li></ul> 
  </li><li><a href="#_84" rel="nofollow">五、分片和副本的故障恢复</a></li><li><ul><li><a href="#51__85" rel="nofollow">5.1 主分片故障恢复</a></li><li><a href="#52__91" rel="nofollow">5.2 副本分片故障恢复</a></li><li><a href="#53__96" rel="nofollow">5.3 故障恢复的配置</a></li></ul> 
  </li><li><a href="#_105" rel="nofollow">六、分片和副本的监控</a></li><li><ul><li><a href="#61__106" rel="nofollow">6.1 监控分片状态</a></li><li><a href="#62__113" rel="nofollow">6.2 监控集群健康状态</a></li><li><a href="#63__119" rel="nofollow">6.3 监控指标</a></li></ul> 
  </li><li><a href="#_121" rel="nofollow">七、小结</a></li></ul> 
</div> 
<br> 
<img src="https://images2.imgbox.com/51/f9/OfK6DhRN_o.png" alt=""> 
<p></p> 
<h2><a id="_2"></a>📑前言</h2> 
<blockquote> 
 <p>Elasticsearch是一种分布式搜索和分析引擎，它具有高扩展性和高可用性。为了实现这些特性，Elasticsearch引入了分片（Shard）和副本（Replica）的概念。本文将详细介绍Elasticsearch中的分片和副本机制，帮助读者理解它们的重要性及其实现方法。</p> 
</blockquote> 
<h2><a id="Shard_5"></a>一、分片（Shard）</h2> 
<p><img src="https://images2.imgbox.com/22/84/biaSm62v_o.png" alt="image.png"></p> 
<h3><a id="11__7"></a>1.1 分片的定义</h3> 
<p>分片是Elasticsearch中存储数据的基本单位。一个索引可以由多个分片组成，每个分片都是一个独立的Lucene索引。通过分片，Elasticsearch可以将数据分布到多个节点上，从而实现数据的分布式存储和并行处理。</p> 
<h3><a id="12__9"></a>1.2 分片的重要性</h3> 
<p>分片机制使Elasticsearch具有以下优势：</p> 
<ul><li><strong>水平扩展</strong>：通过增加分片数量，可以水平扩展索引的存储容量和处理能力。</li><li><strong>并行处理</strong>：分片可以分布在不同的节点上，允许多个节点并行处理查询和索引请求，提高系统的性能和吞吐量。</li><li><strong>数据分布</strong>：分片机制使数据可以分布在集群的多个节点上，减少单点故障的风险，提高数据的可用性和可靠性。</li></ul> 
<h3><a id="13__15"></a>1.3 分片的类型</h3> 
<p>Elasticsearch中的分片分为两种类型：</p> 
<ul><li><strong>主分片（Primary Shard）</strong>：主分片是原始的数据分片，所有的写操作（如索引和删除）都首先作用于主分片。</li><li><strong>副本分片（Replica Shard）</strong>：副本分片是主分片的复制品，用于提高数据的可用性和查询性能。副本分片接收来自主分片的数据更新，并在主分片不可用时提供冗余。</li></ul> 
<h3><a id="14__20"></a>1.4 分片的分配</h3> 
<p>Elasticsearch在创建索引时，用户可以指定索引的分片数量。默认情况下，一个索引包含5个主分片。分片的数量一旦设置，主分片的数量是无法更改的（除非重新创建索引）。然而，副本分片的数量可以在索引创建后动态调整。</p> 
<h2><a id="Replica_22"></a>二、副本（Replica）</h2> 
<h3><a id="21__23"></a>2.1 副本的定义</h3> 
<p>副本是主分片的完整复制品，它用于提高系统的容错能力和查询性能。每个主分片可以有多个副本分片，这些副本分片分布在集群的不同节点上。</p> 
<h3><a id="22__25"></a>2.2 副本的重要性</h3> 
<p>副本机制带来了以下好处：</p> 
<ul><li><strong>高可用性</strong>：副本分片提供了数据冗余，当主分片所在节点出现故障时，副本分片可以提升为主分片，保证数据的可用性。</li><li><strong>负载均衡</strong>：副本分片可以分担查询负载，减少主分片的压力，提高系统的查询性能和响应速度。</li><li><strong>数据恢复</strong>：当节点发生故障时，副本分片可以用于快速恢复数据，减少系统的停机时间。</li></ul> 
<h3><a id="23__31"></a>2.3 副本的分配</h3> 
<p>副本分片的数量可以在索引创建时指定，默认情况下，每个主分片有一个副本分片。与主分片不同，副本分片的数量可以在索引创建后动态调整。Elasticsearch会自动管理分片和副本的分配，确保它们分布在集群的不同节点上，以最大限度地提高系统的容错能力和性能。</p> 
<h2><a id="_33"></a>三、分片和副本的机制</h2> 
<p><img src="https://images2.imgbox.com/1f/a2/qeGGFqqr_o.jpg" alt=""></p> 
<h3><a id="31__35"></a>3.1 分片的创建和分配</h3> 
<p>当创建一个新索引时，Elasticsearch会根据用户指定的分片数量创建主分片，并将这些分片分配到集群中的不同节点上。分片的分配过程如下：</p> 
<ol><li><strong>分片创建</strong>：Elasticsearch根据索引的分片设置，创建指定数量的主分片。</li><li><strong>分片分配</strong>：Elasticsearch将主分片分配到集群中的不同节点上，确保分片均匀分布。</li><li><strong>副本创建</strong>：Elasticsearch根据索引的副本设置，为每个主分片创建副本分片。</li><li><strong>副本分配</strong>：Elasticsearch将副本分片分配到与主分片不同的节点上，确保数据冗余。</li></ol> 
<h3><a id="32__42"></a>3.2 数据写入过程</h3> 
<p>在Elasticsearch中，数据的写入过程包括以下步骤：</p> 
<ol><li><strong>写请求发送到主分片</strong>：所有的写操作（如索引和删除）首先发送到主分片。</li><li><strong>主分片处理写请求</strong>：主分片处理写请求，将数据写入到分片中。</li><li><strong>写请求同步到副本分片</strong>：主分片将写操作同步到所有的副本分片，确保数据的一致性。</li><li><strong>写操作完成</strong>：当所有副本分片确认写操作后，Elasticsearch返回写操作的结果。</li></ol> 
<h3><a id="33__49"></a>3.3 数据读取过程</h3> 
<p>在Elasticsearch中，数据的读取过程包括以下步骤：</p> 
<ol><li><strong>读请求发送到协调节点</strong>：客户端将查询请求发送到Elasticsearch集群中的任意节点，该节点作为协调节点处理请求。</li><li><strong>协调节点路由请求</strong>：协调节点将查询请求路由到相关的主分片和副本分片。</li><li><strong>分片并行处理查询</strong>：主分片和副本分片并行处理查询请求，返回查询结果。</li><li><strong>协调节点汇总结果</strong>：协调节点汇总所有分片的查询结果，并返回给客户端。</li></ol> 
<h2><a id="_56"></a>四、分片和副本的配置</h2> 
<h3><a id="41__57"></a>4.1 配置分片数量</h3> 
<p>在创建索引时，可以通过<code>number_of_shards</code>参数指定分片数量。例如：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>my_index
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"number_of_shards"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    <span class="token string-property property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述配置将创建一个包含3个主分片和每个主分片有1个副本分片的索引。</p> 
<h3><a id="42__69"></a>4.2 配置副本数量</h3> 
<p>副本数量可以在索引创建后动态调整。例如：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>my_index<span class="token operator">/</span>_settings
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述配置将<code>my_index</code>索引的副本数量调整为2。</p> 
<h3><a id="43__78"></a>4.3 分片和副本的最佳实践</h3> 
<p>为了优化Elasticsearch的性能和可用性，建议遵循以下最佳实践：</p> 
<ul><li><strong>合理设置分片数量</strong>：分片数量应根据数据量和集群节点数量进行设置，避免分片过多导致管理开销过大。</li><li><strong>均匀分布分片</strong>：确保分片和副本均匀分布在集群的不同节点上，避免单点故障。</li><li><strong>监控和调整</strong>：定期监控分片和副本的状态，根据需要调整配置，确保系统的稳定性和性能。</li></ul> 
<h2><a id="_84"></a>五、分片和副本的故障恢复</h2> 
<h3><a id="51__85"></a>5.1 主分片故障恢复</h3> 
<p>当主分片所在节点发生故障时，Elasticsearch会自动将对应的副本分片提升为主分片，确保数据的可用性。故障恢复过程如下：</p> 
<ol><li><strong>节点故障检测</strong>：Elasticsearch检测到节点故障，标记节点上的分片为不可用。</li><li><strong>副本提升为主分片</strong>：Elasticsearch将副本分片提升为主分片，确保数据的可用性。</li><li><strong>重新分配副本分片</strong>：Elasticsearch在集群中的其他节点上创建新的副本分片，恢复数据冗余。</li></ol> 
<h3><a id="52__91"></a>5.2 副本分片故障恢复</h3> 
<p>当副本分片所在节点发生故障时，Elasticsearch会在集群中的其他节点上重新创建副本分片，确保数据的冗余。故障恢复过程如下：</p> 
<ol><li><strong>节点故障检测</strong>：Elasticsearch检测到节点故障，标记节点上的副本分片为不可用。</li><li><strong>重新创建副本分片</strong>：Elasticsearch在集群中的其他节点上创建新的副本分片，恢复数据冗余。</li></ol> 
<h3><a id="53__96"></a>5.3 故障恢复的配置</h3> 
<p>Elasticsearch允许用户配置故障恢复的行为，以满足不同的应用需求。例如，可以通过<code>index.unassigned.node_left.delayed_timeout</code>参数设置节点故障后重新分配分片的延迟时间：</p> 
<pre><code class="prism language-json"><span class="token constant">PUT</span> <span class="token operator">/</span>my_index<span class="token operator">/</span>_settings
<span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"index.unassigned.node_left.delayed_timeout"</span><span class="token operator">:</span> <span class="token string">"5m"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上述配置将设置在节点故障后延迟5分钟重新分配分片，以防止短暂的网络问题导致不必要的分片重新分配。</p> 
<h2><a id="_105"></a>六、分片和副本的监控</h2> 
<h3><a id="61__106"></a>6.1 监控分片状态</h3> 
<p>Elasticsearch提供了多种工具和API来监控分片和副本的状态。例如，可以使用<code>_cat/shards</code> API查看索引的分片分配情况：</p> 
<pre><code class="prism language-bash">GET /_cat/shards/my_index?v
</code></pre> 
<p>该命令将显示<code>my_index</code>索引的所有分片及其所在节点的信息。</p> 
<h3><a id="62__113"></a>6.2 监控集群健康状态</h3> 
<p>Elasticsearch的<code>_cluster/health</code> API可以用于监控集群的健康状态，包括分片和副本的状态：</p> 
<pre><code class="prism language-bash">GET /_cluster/health
</code></pre> 
<p>该命令将返回集群的健康状态，包括分片和副本的数量、状态和分配情况。</p> 
<h3><a id="63__119"></a>6.3 监控指标</h3> 
<p>为了更全面地监控Elasticsearch的性能和健康状态，可以使用开源的监控工具，如Elasticsearch自身的监控插件（X-Pack Monitoring）、Prometheus和Grafana。这些工具可以帮助用户实时监控集群的各种性能指标，包括分片分配、查询性能、节点资源使用情况等。</p> 
<h2><a id="_121"></a>七、小结</h2> 
<p>Elasticsearch的分片和副本机制是其实现高扩展性和高可用性的核心。通过合理配置分片和副本，Elasticsearch能够在大规模数据处理和高并发访问的场景下提供稳定高效的性能。同时，分片和副本机制也为系统提供了容错能力和数据冗余，确保在节点故障时数据的可用性。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c260a59c2fc8c5cd1ac6d1aa1a0d09e6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">探索前沿科技：从迁移学习看人工智能的无限可能性</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/94004af0071b7964fbe2a9176b6fd297/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【QT】Qt 窗口 (QMainWindow)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>