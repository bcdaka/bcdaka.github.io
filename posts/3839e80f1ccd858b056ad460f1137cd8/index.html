<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MyCat 分片 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3839e80f1ccd858b056ad460f1137cd8/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="MyCat 分片">
  <meta property="og:description" content="更多内容，前往IT-BLOG
如今随着互联网的发展，数据的量级也是呈指数的增长，从GB到TB到PB。对数据的各种操作也是愈加的困难，传统的关系性数据库已经无法满足快速查询与插入数据的需求。这个时候NoSQL的出现暂时解决了这一危机。它通过降低数据的安全性，减少对事务的支持，减少对复杂查询的支持，来获取性能上的提升。但是，在有些场合NoSQL是无法满足的，就比如有些使用场景是绝对要有事务与安全指标的。这个时候NoSQL肯定是无法满足的，所以还是需要使用关系型数据库。如果使用关系型数据库解决海量存储的问题呢？此时就需要做数据库集群，为了提高查询性能将一个数据库的数据分散到不同的数据库中存储。
一、简介 Mycat背后是阿里曾经开源的知名产品Cobar。Cobar的核心功能和优势是MySQL数据库分片，阿里随后开源的Cobar，并维护到2013年初。Cobar的思路和实现路径的确不错。基于Java开发的，实现了MySQL公开的二进制传输协议，巧妙地将自己伪装成一个MySQL Server，目前市面上绝大多数MySQL客户端工具和应用都能兼容。比自己实现一个新的数据库协议要明智的多，因为生态环境在哪里摆着。Mycat是基于Cobar演变而来，对Cobar的代码进行了彻底的重构，使用NIO重构了网络模块，并且优化了Buffer内核，增强了聚合，Join等基本特性，同时兼容绝大多数数据库成为通用的数据库中间件。
简单的说，MyCat就是一个新颖的数据库中间件产品，支持MySQL集群，或者mariaDB cluster（数据库管理系统集群），提供高可用的数据分片集群。你可以像使用MySQL一样使用MyCat。对于开发人员来说根本感觉不到MyCat的存在。
MyCat基本支持的所有数据库的集群，主要如下：
二、Mycat 下载及安装 前提： 安装并启动MySQL数据库，并设置远程访问：GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39;IDENTIFIED BY &#39;123456&#39; WITH GRANT OPTION;
【1】MyCat官方网站：链接
【2】下载地址：链接
【3】将下载的MyCat（Mycat-server-1.4-release-20151019230038-linux.tar.gz）上传至服务器。
【4】解压（tar -zxvf Mycat-server-1.4-release-20151019230038-linux.tar.gz）后生成MyCat目录。
【5】进入MyCat目录下的bin目录，启动MyCat：
./mycat start MyCat支持的命令{ console | start | stop | restart | status | dump（导出） } ，Mycat的默认端口号为：8066
Mycat大概的目录结构如下：
|—— bin | |—— mycat MyCat启动程序 | |—— ... |—— catlet |—— conf | |—— log4j2.xml 日志的配置，可以根据自己的需要调整输出级别为 bebug | |—— rule.xml 分片规则的配置文件，分片规则的具体参数信息被单独存放为文件，也在当前目录下，对配置文件进行修改时需要重启 MyCat | |—— schema.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-28T10:31:02+08:00">
    <meta property="article:modified_time" content="2024-07-28T10:31:02+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MyCat 分片</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>更多内容，前往<a href="https://it-blog-cn.com/blogs/db/mycat.html" rel="nofollow">IT-BLOG</a></p> 
<p>如今随着互联网的发展，数据的量级也是呈指数的增长，从<code>GB</code>到<code>TB</code>到<code>PB</code>。对数据的各种操作也是愈加的困难，传统的关系性数据库已经无法满足快速查询与插入数据的需求。这个时候<code>NoSQL</code>的出现暂时解决了这一危机。它通过降低数据的安全性，减少对事务的支持，减少对复杂查询的支持，来获取性能上的提升。但是，在有些场合<code>NoSQL</code>是无法满足的，就比如有些使用场景是绝对要有事务与安全指标的。这个时候<code>NoSQL</code>肯定是无法满足的，所以还是需要使用关系型数据库。如果使用关系型数据库解决海量存储的问题呢？此时就需要做数据库集群，为了提高查询性能将一个数据库的数据分散到不同的数据库中存储。</p> 
<h3><a id="_5"></a>一、简介</h3> 
<p><code>Mycat</code>背后是阿里曾经开源的知名产品<code>Cobar</code>。<code>Cobar</code>的核心功能和优势是<code>MySQL</code>数据库分片，阿里随后开源的<code>Cobar</code>，并维护到<code>2013</code>年初。<code>Cobar</code>的思路和实现路径的确不错。基于<code>Java</code>开发的，实现了<code>MySQL</code>公开的二进制传输协议，巧妙地将自己伪装成一个<code>MySQL Server</code>，目前市面上绝大多数<code>MySQL</code>客户端工具和应用都能兼容。比自己实现一个新的数据库协议要明智的多，因为生态环境在哪里摆着。<code>Mycat</code>是基于<code>Cobar</code>演变而来，对<code>Cobar</code>的代码进行了彻底的重构，使用<code>NIO</code>重构了网络模块，并且优化了<code>Buffer</code>内核，增强了聚合，<code>Join</code>等基本特性，同时兼容绝大多数数据库成为通用的数据库中间件。</p> 
<p>简单的说，<code>MyCat</code>就是一个新颖的数据库中间件产品，支持<code>MySQL</code>集群，或者<code>mariaDB cluster</code>（数据库管理系统集群），提供高可用的数据分片集群。你可以像使用<code>MySQL</code>一样使用<code>MyCat</code>。对于开发人员来说根本感觉不到<code>MyCat</code>的存在。</p> 
<p><img src="https://images2.imgbox.com/2a/6c/TEeIdtA3_o.png" alt=""></p> 
<p><code>MyCat</code>基本支持的所有数据库的集群，主要如下：</p> 
<p><img src="https://images2.imgbox.com/e4/8b/r2nWBGxK_o.png" alt=""></p> 
<h3><a id="Mycat__18"></a>二、Mycat 下载及安装</h3> 
<p><strong>前提：</strong> 安装并启动<code>MySQL</code>数据库，并设置远程访问：<code>GRANT ALL PRIVILEGES ON *.* TO 'root'@'%'IDENTIFIED BY '123456' WITH GRANT OPTION</code>;<br> 【1】<code>MyCat</code>官方网站：<a href="http://www.mycat.org.cn/" rel="nofollow">链接</a><br> 【2】下载地址：<a href="https://github.com/MyCATApache/Mycat-download">链接</a><br> 【3】将下载的<code>MyCat（Mycat-server-1.4-release-20151019230038-linux.tar.gz）</code>上传至服务器。<br> 【4】解压<code>（tar -zxvf Mycat-server-1.4-release-20151019230038-linux.tar.gz）</code>后生成<code>MyCat</code>目录。<br> 【5】进入<code>MyCat</code>目录下的<code>bin</code>目录，启动<code>MyCat</code>：</p> 
<pre><code class="prism language-yml">./mycat start 
</code></pre> 
<blockquote> 
 <p><code>MyCat</code>支持的命令<code>{ console | start | stop | restart | status | dump（导出） }</code> ，<code>Mycat</code>的默认端口号为：<code>8066</code></p> 
</blockquote> 
<p><code>Mycat</code>大概的目录结构如下：</p> 
<pre><code class="prism language-base">|—— bin
|    |—— mycat                 MyCat启动程序
|    |—— ...
|—— catlet
|—— conf
|    |—— log4j2.xml           日志的配置，可以根据自己的需要调整输出级别为 bebug
|    |—— rule.xml               分片规则的配置文件，分片规则的具体参数信息被单独存放为文件，也在当前目录下，对配置文件进行修改时需要重启 MyCat
|    |—— schema.xml        逻辑库和逻辑表的定义，以及分片定义的配置文件
|    |—— server.xml           MyCat 服务器参数和用户授权的配置文件
|    |—— wrapper.conf       JVM内存配置文件
|    |—— zkconf                 ZooKeeper 的配置目录
|—— lib                             MyCat自身的 Jar包或依赖的 Jar包的存放目录
|—— logs                          MyCat日志的存放目录。日志被存放在 logs/log中，每天生成一个文件
|—— version.txt                版本信息 
</code></pre> 
<h3><a id="MyCat__48"></a>三、MyCat 分片（海量数据存储解决方案）</h3> 
<p><strong>什么是分片：</strong> 就是指通过某种特定的条件，将我们存放在同一个数据库中的数据分散存放到多个数据库（主机）上面，以达到分散单台设备负载的效果。数据的切分<code>Sharding</code>根据其切分规则的类型，可以分为两种切分模式：<br> 【1】一种是按照不同的表（或者<code>Schema</code>）来切分到不同的数据库（主机）之上，这种切分可以称之为数据的垂直（纵向）切分</p> 
<p><img src="https://images2.imgbox.com/87/02/r64wbWWH_o.png" alt=""></p> 
<p>【2】另外一种则是根据表中数据的逻辑关系，将同一个表中的数据按照某种条件拆分到多台数据库（主机）上面，这种切分称之为数据的水平（横向）切分</p> 
<p><img src="https://images2.imgbox.com/d7/7a/vfZpC5CB_o.png" alt=""></p> 
<p>MyCat 分片策略：</p> 
<p><img src="https://images2.imgbox.com/d7/b0/6eZM6WjJ_o.png" alt=""></p> 
<p><strong>【1】逻辑库<code>schema</code> ：</strong> 前面说了数据库中间件，通常对实际应用来说，并不需要知道中间件的存在，业务开发人员只需要知道数据库的概念，所以数据库中间件可以被看做是一个或多个数据库集群构成的逻辑库。<br> <strong>【2】逻辑表<code>table</code>：</strong> 既然有逻辑库，那么就会有逻辑表，分布式数据库中，对应用来说，读写数据的表就是逻辑表。逻辑表可以是数据切分后，分布在一个或多个分片库中，也可以不做数据切分，不分片，只有一个表构成。<br>  ■ <strong>分片表：</strong> 是指那些原有的很大数据的表，需要切分到多个数据库的表，这样每个分片都有一部分数据，所有分片构成了完整的数据。 总而言之就是需要进行分片的表。<br>  ■ <strong>非分片表：</strong> 一个数据库中并不是所有的表都很大，某些表是可以不用进行切分的，非分片是相对分片表来说的，就是那些不需要进行数据切分的表。<br> <strong>【3】分片节点<code>dataNode</code>：</strong> 数据切分后，一个大表被分到不同的分片数据库上面，每个表分片所在的数据库就是分片节点（dataNode）。与实体数据库中的表是相互对应的。<br> <strong>【4】节点主机<code>dataHost</code>：</strong> 数据切分后，每个分片节点<code>dataNode</code>不一定都会独占一台机器，同一机器上面可以有多个分片数据库，这样一个或多个分片节点（dataNode）所在的机器就是节点主机<code>dataHost</code>，为了规避单节点主机并发数限制，尽量将读写压力高的分片节点<code>dataNode</code>均衡的放在不同的节点主机<code>dataHost</code>。<br> <strong>【5】分片规则<code>rule</code>：</strong> 前面讲了数据切分，一个大表被分成若干个分片表，就需要一定的规则，这样按照某种业务规则把数据分到某个分片的规则就是分片规则，数据切分选择合适的分片规则非常重要，将极大的避免后续数据处理的难度。</p> 
<h3><a id="MyCat__73"></a>四、MyCat 分片配置</h3> 
<blockquote> 
 <p>提示：建议每次修改配置前都对其进行备份，例如：<code>cp conf/schema.xml conf/schema.xml.bak</code></p> 
</blockquote> 
<p><strong>【1】配置<code>schema.xml</code>：</strong> <code>schema.xml</code>作为<code>MyCat</code>中重要的配置文件之一，管理着<code>MyCat</code>的逻辑库、逻辑表以及对应的分片规则、<code>DataNode</code>以及<code>DataHost</code>。弄懂这些配置，是正确使用<code>MyCat</code>的前提。这里就一层层对该文件进行解析。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mycat:</span>schema</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>mycat</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://org.opencloudb/<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- schema 标签用于定义MyCat实例中的逻辑库 name 表示连接时的数据源，需要在server.xml中配置连接的用户名和密码 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>schema</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TESTDB<span class="token punctuation">"</span></span> <span class="token attr-name">checkSQLschema</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token attr-name">sqlMaxLimit</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--Table标签 定义了 MyCat中的逻辑表（可以有多个）
            name: 逻辑表的名称
            dataNode:对应 dataNode 标签，配置了 节点与实体数据库表的关系
            rule:对应 rule.xml 配置文件中的规则 name，auto-sharding-long的分片规则是按ID值的范围进行分片 1-5000000 为第1片  5000001-10000000 为第2片....  具体设置我们会rule.xml 中说明
                    name中的值是表的名称，创建的表需要再此定义，否则不会成功
        --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tb_test<span class="token punctuation">"</span></span> <span class="token attr-name">dataNode</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dn1,dn2,dn3<span class="token punctuation">"</span></span> <span class="token attr-name">rule</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>auto-sharding-long<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>schema</span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!--dataNode 标签定义了 MyCat中的数据节点，也就是我们通常说所的数据分片。
        dataHost:对应 dataHost标签中的 name
        database:对应数据库中的表名（必须存在实体数据源db1,db2,db3) --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dn1<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost1<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>db1<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dn2<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost1<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>db2<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataNode</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dn3<span class="token punctuation">"</span></span> <span class="token attr-name">dataHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost1<span class="token punctuation">"</span></span> <span class="token attr-name">database</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>db3<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--dataHost标签 在mycat逻辑库中也是作为最底层的标签存在，直接定义了具体的数据库实例、读写分离配置和心跳语句。 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataHost</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>localhost1<span class="token punctuation">"</span></span> <span class="token attr-name">maxCon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> <span class="token attr-name">minCon</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token attr-name">balance</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
        <span class="token attr-name">writeType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span> <span class="token attr-name">dbType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mysql<span class="token punctuation">"</span></span> <span class="token attr-name">dbDriver</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>native<span class="token punctuation">"</span></span> <span class="token attr-name">switchType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>  <span class="token attr-name">slaveThreshold</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>heartbeat</span><span class="token punctuation">&gt;</span></span>select user()<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>heartbeat</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 主服务hostM1信息，修改url与用户名和密码为自己的地址等 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>writeHost</span> <span class="token attr-name">host</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hostM1<span class="token punctuation">"</span></span> <span class="token attr-name">url</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>192.168.88.129:3306<span class="token punctuation">"</span></span> <span class="token attr-name">user</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span>
            <span class="token attr-name">password</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>writeHost</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataHost</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">mycat:</span>schema</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>【2】配置<code>server.xml</code>：</strong> <code>server.xml</code>几乎保存了所有<code>MyCat</code>需要的系统配置信息。最常用的是在此配置用户名、密码及权限。在<code>system</code>标签中添加<code>UTF-8</code>字符集设置，否则存储中文会出现问号</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>charset<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>utf8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>修改 user标签的设置 , 我们这里为 TESTDB 设置了一个用户：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--schemas:对应 schema 中的逻辑库 &lt;schema&gt; 标签name 的值，这里=TESTDB
    password:用户登录的密码
    name:用户登录名称--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>test<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schemas<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>TESTDB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>【3】配置<code>rule.xml</code>：</strong> 用于定义分片规则 ，我们这里讲解两种最常见的分片规则：</p> 
<p><strong>【第一种分片规则】：</strong> 按主键范围分片<code>rang-long</code>，在配置文件中我们找到对应配置如下：</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--我们配置的默认规则--&gt;</span>
<span class="token comment">&lt;!--tableRule 是定义具体某个表或某一类表的分片规则名称   
    columns用于定义分片的列  
    algorithm代表算法名称 
    我们接着找rang-long的定义--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>auto-sharding-long<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>rang-long<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--Function 用于定义算法 mapFile 用于定义算法需要的数据，我们打开autopartition-long.txt--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>rang-long<span class="token punctuation">"</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.opencloudb.route.function.AutoPartitionByLong<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapFile<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>autopartition-long.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>打开<code>autopartition-long.txt</code>文件，内如如下：</p> 
<pre><code class="prism language-yml"><span class="token comment"># range start-end ,data node index</span>
<span class="token comment"># K=1000,M=10000.</span>
<span class="token comment">#表示第一个db1存储id在 0-500万 之间的数据</span>
0<span class="token punctuation">-</span>500M=0
<span class="token comment">#表示第一个db2存储id在 500万-1000万 之间的数据</span>
500M<span class="token punctuation">-</span>1000M=1
<span class="token comment">#表示第一个db3存储id在 1000万-1500万 之间的数据</span>
1000M<span class="token punctuation">-</span>1500M=2
</code></pre> 
<p><strong>【第二种分片规则】：</strong> 一致性哈希<code>murmur</code>，当我们需要将数据平均分在几个分区中，需要使用一致性<code>hash</code>规则，我们找到<code>rule.xml</code>中的<code>function</code>的<code>name</code>为<code>murmur</code>的定义，将<code>count</code>属性改为<code>3</code>，因为我要将数据分成<code>3</code>片：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tableRule</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sharding-by-murmur<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>columns</span><span class="token punctuation">&gt;</span></span>id<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>columns</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>algorithm</span><span class="token punctuation">&gt;</span></span>murmur<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>algorithm</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tableRule</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>function</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>murmur<span class="token punctuation">"</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.opencloudb.route.function.PartitionByMurmurHash<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>seed<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- 默认是0 --&gt;</span>
    <span class="token comment">&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>count<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 一个实际的数据库节点被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的160倍 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>virtualBucketTimes<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>160<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- &lt;property name="weightMapFile"&gt;weightMapFile&lt;/property&gt; 节点的权重，
            没有指定权重的节点默认是1。以properties文件的格式填写，以从0开始到count-1的整数值也就是节点
            索引为key，以节点权重值为值。所有权重值必须是正整数，否则以1代替 --&gt;</span>
    <span class="token comment">&lt;!-- &lt;property name="bucketMapPath"&gt;/etc/mycat/bucketMapPath&lt;/property&gt; 
        用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的murmur 
        hash值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>function</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h3><a id="MyCat__177"></a>五、MyCat 分片测试</h3> 
<p>【1】通过外部工具连接<code>MyCat</code>逻辑库<code>TESTDB</code>：</p> 
<p><img src="https://images2.imgbox.com/07/86/VaUBVWiq_o.png" alt=""></p> 
<p>【2】进入<code>TESTDB（use TESTDB）</code>执行下列语句创建一个表：创建后你会发现，<code>MyCat</code>会自动将你的表转换为大写，这一点与<code>Oracle</code>有些类似。并且在<code>db1</code>、<code>db2</code>、<code>db3</code>和<code>TESTDB</code>数据源中都会创建<code>tb_test</code>表，此表名需要在<code>schema.xml</code>中定义。</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tb_test <span class="token punctuation">(</span>
    id <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    title <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span>
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8
</code></pre> 
<p>我们查看一下，我们创建的<code>db1</code>、<code>db2</code>、<code>db3</code>的状况，会发现都创建了<code>tb_test</code>表。接下来是插入表数据（注意：在写<code>INSERT</code>语句时一定要写把字段列表写出来，否则会出现下列错误提示：<code>1064</code>）</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> TB_TEST<span class="token punctuation">(</span>ID<span class="token punctuation">,</span>TITLE<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'goods1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> TB_TEST<span class="token punctuation">(</span>ID<span class="token punctuation">,</span>TITLE<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">5000001</span><span class="token punctuation">,</span><span class="token string">'goods5000001'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> TB_TEST<span class="token punctuation">(</span>ID<span class="token punctuation">,</span>TITLE<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token number">1100000</span><span class="token punctuation">,</span><span class="token string">'goods10000001'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们会发现这些数据按照我们说的第一种分片规则，将<code>id=1</code>的写入<code>db1</code>，<code>id=5000001</code>的写入<code>db2</code>，<code>id=1100000</code>写入 <code>db3</code>。采用的分片规则是每节点存储<code>500</code>万条数据。如果查出了定义的范围，则直接抛错。</p> 
<p>​</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2c5a829149794270506a9a17124eba39/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">智慧环卫可视化：科技赋能城市清洁管理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ec01c569dd42b280df554546e153d05e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">kuberneter管理GUI工具Lens</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>