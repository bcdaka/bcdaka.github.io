<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>以太网UDP测试实验 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/afcac5ffd7c2ca9886c6f7538b1427da/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="以太网UDP测试实验">
  <meta property="og:description" content="目录
一.UDP简介
1.1UDP概述
1.2UDP协议
二.实验任务
三.模块设计
3.1总体模块设计
3.2UDP模块设计
3.2.1udp_rx模块设计
3.2.2udp_tx模块设计
四.板级验证 一.UDP简介 1.1UDP概述 UDP （User Datagram Protocol)用户数据协议 是一种面向无连接的传输层协议，属于 TCP/IP 协议簇的一种。 UDP 具有消耗资源少、通信效率高等优点，通常用来传输音频、视频等对实时性要求高的场合。 UDP 和 TCP 是传输层中非常重要的两个协议，以下是两者的区别。 1.2UDP协议 可以看出UDP和ICMP在以太网帧里面的位置一样。
UDP 首部共 8 个字节，同 IP 首部一样，也是一行以 32 位（ 4 个字节）为单位。 源端口号： 16 位发送端端口号，用于区分不同服务的端口，端口号的范围从 0 到 65535 。 目的端口号： 16 位接收端端口号。 UDP 长度： 16 位 UDP 长度，包含 UDP 首部长度 &#43; 数据长度，单位是字节（ byte ）。 UDP 校验和： 16 位 UDP 校验和。 UDP 计算校验和的方法和计算 IP 数据报首部校验和的方法相似，但不同的是 IP 数据报的校验和只检验 IP 数据报的首部，而 UDP 校验和包含三个部分： UDP 伪首部， UDP 首部和 UDP 的数据部分。伪首部的数据是从 IP 数据报头和 UDP 数据报头获取的，包括源 IP 地址，目的 IP地址，协议类型和 UDP 长度，其目的是让 UDP 两次检查数据是否已经正确到达目的地，只是单纯为了做校验用的。 二.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-05T17:11:40+08:00">
    <meta property="article:modified_time" content="2024-08-05T17:11:40+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">以太网UDP测试实验</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="-toc" style="margin-left:0px;"></p> 
<p id="%E4%B8%80.UDP%E7%AE%80%E4%BB%8B-toc" style="margin-left:0px;"><a href="#%E4%B8%80.UDP%E7%AE%80%E4%BB%8B" rel="nofollow">一.UDP简介</a></p> 
<p id="1.1UDP%E6%A6%82%E8%BF%B0-toc" style="margin-left:40px;"><a href="#1.1UDP%E6%A6%82%E8%BF%B0" rel="nofollow">1.1UDP概述</a></p> 
<p id="1.2UDP%E5%8D%8F%E8%AE%AE-toc" style="margin-left:40px;"><a href="#1.2UDP%E5%8D%8F%E8%AE%AE" rel="nofollow">1.2UDP协议</a></p> 
<p id="%E4%BA%8C.%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1-toc" style="margin-left:0px;"><a href="#%E4%BA%8C.%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1" rel="nofollow">二.实验任务</a></p> 
<p id="%E4%B8%89.%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1-toc" style="margin-left:0px;"><a href="#%E4%B8%89.%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1" rel="nofollow">三.模块设计</a></p> 
<p id="3.1%E6%80%BB%E4%BD%93%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1-toc" style="margin-left:40px;"><a href="#3.1%E6%80%BB%E4%BD%93%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1" rel="nofollow">3.1总体模块设计</a></p> 
<p id="3.2UDP%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1-toc" style="margin-left:40px;"><a href="#3.2UDP%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1" rel="nofollow">3.2UDP模块设计</a></p> 
<p id="3.2.1udp_rx%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1-toc" style="margin-left:80px;"><a href="#3.2.1udp_rx%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1" rel="nofollow">3.2.1udp_rx模块设计</a></p> 
<p id="3.2.2udp_tx%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1-toc" style="margin-left:80px;"><a href="#3.2.2udp_tx%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1" rel="nofollow">3.2.2udp_tx模块设计</a></p> 
<p id="%E5%9B%9B.%E6%9D%BF%E7%BA%A7%E9%AA%8C%E8%AF%81%C2%A0-toc" style="margin-left:0px;"><a href="#%E5%9B%9B.%E6%9D%BF%E7%BA%A7%E9%AA%8C%E8%AF%81%C2%A0" rel="nofollow">四.板级验证 </a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="%E4%B8%80.UDP%E7%AE%80%E4%BB%8B">一.UDP简介</h2> 
<h3 id="1.1UDP%E6%A6%82%E8%BF%B0">1.1UDP概述</h3> 
<div> 
 <span style="color:#000000;">           UDP （User Datagram Protocol)用户数据协议</span> 
 <span style="color:#000000;">是一种面向无连接的传输层协议，属于 </span> 
 <span style="color:#000000;">TCP/IP </span> 
 <span style="color:#000000;">协议簇的一种。</span> 
 <span style="color:#000000;">UDP </span> 
 <span style="color:#000000;">具有消耗资源少、通信效率高等优点，通常用来传输音频、视频等对实时性要求高的场合。</span> 
</div> 
<div> 
 <span style="color:#000000;">           UDP </span> 
 <span style="color:#000000;">和 </span> 
 <span style="color:#000000;">TCP </span> 
 <span style="color:#000000;">是传输层中非常重要的两个协议，以下是两者的区别。</span> 
</div> 
<div> 
 <img alt="" height="330" src="https://images2.imgbox.com/a4/ba/ZeOL8HeA_o.png" width="1200"> 
</div> 
<h3 id="1.2UDP%E5%8D%8F%E8%AE%AE">1.2UDP协议</h3> 
<p>        可以看出UDP和ICMP在以太网帧里面的位置一样。</p> 
<p><img alt="" height="648" src="https://images2.imgbox.com/ec/68/zYljmwEv_o.png" width="1200"></p> 
<p><img alt="" height="536" src="https://images2.imgbox.com/fc/9a/kQ7fKSRG_o.png" width="1200"></p> 
<div> 
 <span style="color:#000000;">        UDP </span> 
 <span style="color:#000000;">首部共 </span> 
 <span style="color:#000000;">8 </span> 
 <span style="color:#000000;">个字节，同 </span> 
 <span style="color:#000000;">IP </span> 
 <span style="color:#000000;">首部一样，也是一行以 </span> 
 <span style="color:#000000;">32 </span> 
 <span style="color:#000000;">位（</span> 
 <span style="color:#000000;">4 </span> 
 <span style="color:#000000;">个字节）为单位。 </span> 
</div> 
<div> 
 <span style="color:#000000;">       <strong> 源端口号</strong>：</span> 
 <span style="color:#000000;">16 </span> 
 <span style="color:#000000;">位发送端端口号，用于区分不同服务的端口，端口号的范围从 </span> 
 <span style="color:#000000;">0 </span> 
 <span style="color:#000000;">到 </span> 
 <span style="color:#000000;">65535</span> 
 <span style="color:#000000;">。 </span> 
</div> 
<div> 
 <span style="color:#000000;">目的端口号：</span> 
 <span style="color:#000000;">16 </span> 
 <span style="color:#000000;">位接收端端口号。 </span> 
</div> 
<div> 
 <span style="color:#000000;">        <strong>UDP </strong></span> 
 <span style="color:#000000;"><strong>长度</strong>：</span> 
 <span style="color:#000000;">16 </span> 
 <span style="color:#000000;">位 </span> 
 <span style="color:#000000;">UDP </span> 
 <span style="color:#000000;">长度，包含 </span> 
 <span style="color:#000000;">UDP </span> 
 <span style="color:#000000;">首部长度</span> 
 <span style="color:#000000;">+</span> 
 <span style="color:#000000;">数据长度，单位是字节（</span> 
 <span style="color:#000000;">byte</span> 
 <span style="color:#000000;">）。 </span> 
</div> 
<div> 
 <span style="color:#000000;">       <strong> UDP </strong></span> 
 <span style="color:#000000;"><strong>校验和</strong>：</span> 
 <span style="color:#000000;">16 </span> 
 <span style="color:#000000;">位 </span> 
 <span style="color:#000000;">UDP </span> 
 <span style="color:#000000;">校验和。</span> 
 <span style="color:#000000;">UDP </span> 
 <span style="color:#000000;">计算校验和的方法和计算 </span> 
 <span style="color:#000000;">IP </span> 
 <span style="color:#000000;">数据报首部校验和的方法相似，但不同的是 IP </span> 
 <span style="color:#000000;">数据报的校验和只检验 </span> 
 <span style="color:#000000;">IP </span> 
 <span style="color:#000000;">数据报的首部，而 </span> 
 <span style="color:#000000;">UDP </span> 
 <span style="color:#000000;">校验和包含三个部分：</span> 
 <span style="color:#000000;">UDP </span> 
 <span style="color:#000000;">伪首部，</span> 
 <span style="color:#000000;">UDP </span> 
 <span style="color:#000000;">首部和 UDP </span> 
 <span style="color:#000000;">的数据部分。伪首部的数据是从 </span> 
 <span style="color:#000000;">IP </span> 
 <span style="color:#000000;">数据报头和 </span> 
 <span style="color:#000000;">UDP </span> 
 <span style="color:#000000;">数据报头获取的，包括源 </span> 
 <span style="color:#000000;">IP </span> 
 <span style="color:#000000;">地址，目的 IP</span>地址，协议类型和 UDP 长度，其目的是让 UDP 两次检查数据是否已经正确到达目的地，只是单纯为了做校验用的。 
</div> 
<h2 id="%E4%BA%8C.%E5%AE%9E%E9%AA%8C%E4%BB%BB%E5%8A%A1">二.实验任务</h2> 
<p><span style="color:#000000;">         本节实验任务是上位机通过网口调试助手发送数据给 FPGA</span><span style="color:#000000;">，</span><span style="color:#000000;">FPGA </span><span style="color:#000000;">通过以太网接口接收数据并将接收到的数据发送给上位机，完成以太网 UDP </span><span style="color:#000000;">数据的环回。同时电脑可以通过命令行窗口发送 </span><span style="color:#000000;">ping </span><span style="color:#000000;">命令给 </span><span style="color:#000000;">FPGA</span><span style="color:#000000;">，FPGA 通过以太网接口接收数据并将接收到的数据发送给电脑，完成以电脑 </span><span style="color:#000000;">ping </span><span style="color:#000000;">开发板的实验测试。</span></p> 
<h2 id="%E4%B8%89.%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1"><span style="color:#000000;">三.模块设计</span></h2> 
<h3 id="3.1%E6%80%BB%E4%BD%93%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1">3.1总体模块设计</h3> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/16/eb/5V2FT0Hy_o.png" width="1200"></p> 
<p><strong>PLL模块</strong>：因为gmii_to_rgmii模块中的输入延时控制IDELAYCTRL中需要用到PLL倍频输出的200MHZ时钟。</p> 
<p><strong>FIFO模块</strong>：以太网单次会接收到大量数据，因此本次实验需要一个 FIFO 模块用来缓存数据，由于本次实验所使用的 GMII 接收时钟和 GMII 发送时钟实际上为同一个时钟，但是为了方便后面实验因此这里使用的是异步 FIFO。 </p> 
<p><strong>arp模块</strong>：根据arp协议对接收数据进行解析，并按照arp协议格式发送报文。</p> 
<p><strong>icmp模块</strong>：根据icmp协议对接收数据进行解析，并按照icmp协议格式发送报文。</p> 
<p><strong>udp模块</strong>：根据udp协议对接收数据进行解析，并按照udp协议格式发送报文。</p> 
<p><strong>rth_ctrl模块</strong>：因为arp、icmp、udp模块的数据不能同时进入FIFO缓存，因此该模块控制选择此3个模块中的某一个缓存进入FIFO。</p> 
<h3 id="3.2UDP%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1">3.2UDP模块设计</h3> 
<p><img alt="" height="1030" src="https://images2.imgbox.com/de/b1/0lcsIDj4_o.png" width="1200"></p> 
<p>         这里模块设计思路和ICMP实验中一样。</p> 
<h4 id="3.2.1udp_rx%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1">3.2.1udp_rx模块设计</h4> 
<h5 id="3.2.1.1%E6%95%B4%E4%BD%93%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1%E5%9B%BE">3.2.1.1整体模块设计图</h5> 
<p><img alt="" height="760" src="https://images2.imgbox.com/23/4d/3m8MyQIY_o.png" width="860"></p> 
<h5 id="%E2%80%8B%E7%BC%96%E8%BE%91%C2%A03.2.1.2%E6%B3%A2%E5%BD%A2%E5%9B%BE"><img alt="" height="716" src="https://images2.imgbox.com/e8/73/GzRKkMRm_o.png" width="1200"> 3.2.1.2波形图</h5> 
<p><img alt="" height="744" src="https://images2.imgbox.com/6f/40/aRIzh5WZ_o.png" width="1200"></p> 
<p>               gmii_rx_dv:当复位信号rst_n拉高后，该信号在下一个脉冲来临时也拉高，代表<span style="color:#000000;">为 </span><span style="color:#000000;">GMII </span><span style="color:#000000;">输入数据有效信号，然后gmii_rxd[7:0]开始输入以太网报文。</span></p> 
<p><span style="color:#000000;">               rec_en:当接收数据到下图中的蓝色数据段时，rec_en开始拉高，rec_data就是下图中的蓝色用户数据。</span></p> 
<p><img alt="" height="260" src="https://images2.imgbox.com/d0/24/ttxyqIHe_o.png" width="772"></p> 
<div> 
 <span style="color:#000000;">            rec_byte_num ：</span> 
 <span style="color:#000000;">为以太网接收的有效字数，主要用于统计以太网接收的有效字数，在当数据接收完成后，将该信号的数据传递到发送模块。</span> 
</div> 
<h5 id="%C2%A03.2.1.3%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE"> 3.2.1.3状态转换图</h5> 
<p><img alt="" height="1130" src="https://images2.imgbox.com/06/58/q2lcbLAl_o.png" width="1200"></p> 
<p>           整体与icmp实验完全一样。注意：<span style="color:#000000;">在中间状态如前导码错误、MAC </span><span style="color:#000000;">地址错误、协议类型错 </span></p> 
<div> 
 <span style="color:#000000;">误、不是 </span> 
 <span style="color:#000000;">UDP </span> 
 <span style="color:#000000;">协议错误以及 </span> 
 <span style="color:#000000;">IP </span> 
 <span style="color:#000000;">地址错误时跳转到 </span> 
 <span style="color:#000000;">st_rx_end </span> 
 <span style="color:#000000;">状态而不是跳转到 </span> 
 <span style="color:#000000;">st_idle </span> 
 <span style="color:#000000;">状态。因为中间状态在解析到数据错误时，单包数据的接收还没有结束，如果此时跳转到 st_idle </span> 
 <span style="color:#000000;">状态，此时eth_rxdv为1，会误把有效数据当成前导码来解析，所以状态跳转到 st_rx_end</span> 
 <span style="color:#000000;">。而 </span> 
 <span style="color:#000000;">eth_rxdv </span> 
 <span style="color:#000000;">信号为 </span> 
 <span style="color:#000000;">0 </span> 
 <span style="color:#000000;">时，单包数据才算接收结束，所以 </span> 
 <span style="color:#000000;">st_rx_end </span> 
 <span style="color:#000000;">跳转到 st_idle </span> 
 <span style="color:#000000;">的条件是 </span> 
 <span style="color:#000000;">eth_rxdv=0</span> 
 <span style="color:#000000;">，准备接收下一包数据。</span> 
</div> 
<h5 id="3.2.1.4%E4%BB%A3%E7%A0%81%2B%E4%BB%BF%E7%9C%9F%E6%B3%A2%E5%BD%A2%E8%A7%A3%E6%9E%90"><span style="color:#000000;">3.2.1.4代码+仿真波形解析</span></h5> 
<h6 id="3.2.1.4.1%E7%A9%BA%E9%97%B2%E7%8A%B6%E6%80%81"><span style="color:#000000;">3.2.1.4.1空闲状态</span></h6> 
<div> 
 <img alt="" height="160" src="https://images2.imgbox.com/ba/ed/mdV2i1rE_o.png" width="1200"> 
</div> 
<p>         空闲状态下，gmii_rx_dv为高电平，并且gmii_rxd传入一个8位55信号，代表要开始接收以太网报文，因此跳转至下一状态。</p> 
<p>         仿真时，将gmii_tx_en赋值给gmii_tx_en，代表仿真时udp模块中的接收数据和发送数据是同步进行的。</p> 
<p>         下图中的仿真波形的红色代表该空闲状态下的波形。</p> 
<p><img alt="" height="50" src="https://images2.imgbox.com/29/3a/Q7Q94tZq_o.png" width="916"></p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/2e/3b/l9E4smH2_o.png" width="1148">    </p> 
<h6 id="3.2.1.4.2%E6%8E%A5%E6%94%B6%E5%89%8D%E5%AF%BC%E7%A0%81%E7%8A%B6%E6%80%81">3.2.1.4.2接收前导码状态</h6> 
<p><img alt="" height="558" src="https://images2.imgbox.com/b6/3d/aBU0aIai_o.png" width="1200"></p> 
<p>           根据以太网帧报文格式，接收7个8‘h55+1个18'hd5。因为空闲状态下已经接收一个8’h55,因此这里只接收 6个8‘h55+18'hd5即可。只要任何一个8位数据出错，就发出error信号，停止接收。</p> 
<p>           仿真时 发送的数据就是接收的数据。<img alt="" height="56" src="https://images2.imgbox.com/bd/d1/rVopI9PR_o.png" width="810"><img alt="" height="770" src="https://images2.imgbox.com/52/66/181YUKpd_o.png" width="1200"></p> 
<h6 id="3.2.1.4.3%E6%8E%A5%E6%94%B6%E4%BB%A5%E5%A4%AA%E7%BD%91%E5%B8%A7%E5%A4%B4%E7%8A%B6%E6%80%81">3.2.1.4.3接收以太网帧头状态</h6> 
<p><img alt="" height="764" src="https://images2.imgbox.com/17/9f/boskYtxc_o.png" width="1200">                该状态下接收6Byte目的MAC地址+6Byte源MAC地址+2Byte以太网协议类型。并判断目的MAC地址和以太网类型协议是否有误，因为该实验是UDP测试（UDP位于IP协议中）实验，若协议类型例如 0x0800 代表 IP 协议（网际协议）、0x0806 代表 ARP 协议（地址解析协议）。</p> 
<p>               由仿真波形可知，接收的目的MAC地址为ffffff(广播类型），接收的以太网协议为0800，均无误。 </p> 
<p><img alt="" height="1066" src="https://images2.imgbox.com/0a/a8/ZJBJsBfz_o.png" width="1200"></p> 
<h6 id="3.2.1.4.4%20%E6%8E%A5%E6%94%B6IP%E9%A6%96%E9%83%A8%E7%8A%B6%E6%80%81">3.2.1.4.4 接收IP首部状态</h6> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/05/21/eacpXsPi_o.png" width="1200"></p> 
<p>         该段代码作用有二，第一判断协议类型是icmp还是udp， ICMP 为 1 ， TCP 为6， UDP 为 17 ，若不是则发出error信号。第二是判断目的IP地址是否为开发板的IP，若不是则发出error信号，终止接收数据。</p> 
<p>       结合前面状态整合下来就是判断报文是不是IP协议，是进一步判断是不是UDP协议，还有目的MAC地址和IP地址。</p> 
<p>      当仿真位于cnt=0时，5X4=20，故gmii_rxd=20。</p> 
<p><img alt="" height="395" src="https://images2.imgbox.com/96/b3/S99sFbQR_o.png" width="1200"></p> 
<p>     当仿真位于cnt=9时，gmii_rxd=17,结合icmp实验中的 ICMP 为 1 ， TCP 为6， UDP 为 17，可知该报文数据是UDP协议。 </p> 
<p><img alt="" height="432" src="https://images2.imgbox.com/02/24/PzmnRznm_o.png" width="1200"> 由仿真图可知，发送的目的IP地址为192.168.1.10和开发板的IP保持一致，des_ip是16进制的目的IP。</p> 
<h6 id="%E2%80%8B%E7%BC%96%E8%BE%91%C2%A03.2.1.4.5%E6%8E%A5%E6%94%B6UDP%E9%A6%96%E9%83%A8%E7%8A%B6%E6%80%81"><img alt="" height="992" src="https://images2.imgbox.com/d0/3f/IG15TZWk_o.png" width="1200"> 3.2.1.4.5接收UDP首部状态</h6> 
<p><img alt="" height="604" src="https://images2.imgbox.com/ae/1c/TEW44iAG_o.png" width="1200"></p> 
<p>               该状态主要是获取 蓝色数据段的长度，根据仿真波形图可以看出，接收到的UDP长度为18，而UDP首部长度为8，18-8=10.</p> 
<p><img alt="" height="406" src="https://images2.imgbox.com/18/e8/WXFgrVYX_o.png" width="986"></p> 
<p><img alt="" height="1018" src="https://images2.imgbox.com/45/75/Izx9DsZP_o.png" width="1200"></p> 
<h6 id="3.2.1.4.6%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE%E6%AE%B5%E7%8A%B6%E6%80%81">3.2.1.4.6接收数据段状态</h6> 
<p><img alt="" height="560" src="https://images2.imgbox.com/45/b4/4qp4Q3Ab_o.png" width="1200">         该状态的作用有二，第一将接收到的数据暂存起来，第二暂存接收的数据段长度</p> 
<p>         由仿真波形可知，一共接收了10个数据，故长度为10.当接收完毕后，代表一包以太网数据接收完，故rec_pkt_done拉高。 </p> 
<h6 id="%E2%80%8B%E7%BC%96%E8%BE%91%C2%A03.2.1.4.7%E7%BB%88%E6%AD%A2%E7%8A%B6%E6%80%81"><img alt="" height="796" src="https://images2.imgbox.com/e5/04/nMGZnyXE_o.png" width="1200"> 3.2.1.4.7终止状态</h6> 
<p><img alt="" height="242" src="https://images2.imgbox.com/8f/84/1725SqMU_o.png" width="1200"></p> 
<p>            该状态作用是接收填充数据段和crc校验码，因为上面数据段共10个，还需填充8个，紧接着是crc校验码，以上全部接收完毕则跳转至空闲状态。 </p> 
<p><img alt="" height="830" src="https://images2.imgbox.com/ec/7d/tKpY2ahQ_o.png" width="1200"></p> 
<h4 id="3.2.2udp_tx%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1">3.2.2udp_tx模块设计</h4> 
<h5 id="3.2.2.1%E6%95%B4%E4%BD%93%E6%A8%A1%E5%9D%97%E8%AE%BE%E8%AE%A1%E5%9B%BE">3.2.2.1整体模块设计图</h5> 
<p><img alt="" height="652" src="https://images2.imgbox.com/1b/51/nnF2SUKl_o.png" width="782"></p> 
<h5 id="%E2%80%8B%E7%BC%96%E8%BE%91%C2%A03.2.2.2%E6%B3%A2%E5%BD%A2%E5%9B%BE"><img alt="" height="1200" src="https://images2.imgbox.com/39/0c/WDmIp1AK_o.png" width="1200"> 3.2.2.2波形图</h5> 
<p><img alt="" height="1022" src="https://images2.imgbox.com/0c/39/ycbwKZdz_o.png" width="1200"></p> 
<p>              tx_start_en：当复位信号拉高后，该信号持续一个脉冲，表示可以开始<span style="color:#000000;">发送以太网数据</span> 。</p> 
<p>              gmii_tx_en:<span style="color:#000000;">为 GMII </span><span style="color:#000000;">输出数据有效信号，</span><span style="color:#000000;">gmii_txd </span><span style="color:#000000;">为 </span><span style="color:#000000;">GMII </span><span style="color:#000000;">输出数据，当 gmii_tx_en </span><span style="color:#000000;">信号拉高，</span><span style="color:#000000;">GMII </span><span style="color:#000000;">开始发送数据，当 </span><span style="color:#000000;">gmii_tx_en </span><span style="color:#000000;">信号拉低表示数据发送完成。</span></p> 
<p><span style="color:#000000;">              tx_req:表示从fifo中读数据请求。</span></p> 
<p><span style="color:#000000;">              tx_done: 为以太网发送完成信号，当一包数据发送完成后且 </span><span style="color:#000000;">CRC </span><span style="color:#000000;">校验完成后，</span><span style="color:#000000;">tx_done </span><span style="color:#000000;">会拉高一个时钟周期，表示 UDP </span><span style="color:#000000;">发送完成。</span></p> 
<h5 id="3.2.2.3%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE"><span style="color:#000000;">3.2.2.3状态转换图</span></h5> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/c9/b7/CQszPAjB_o.png" width="1200"></p> 
<p>          同ICMP实验中的一样，只不过少了DCP首部和数据校验状态。 </p> 
<h5 id="3.2.2.4%E4%BB%A3%E7%A0%81%2B%E4%BB%BF%E7%9C%9F%E6%B3%A2%E5%BD%A2%E5%88%86%E6%9E%90">3.2.2.4代码+仿真波形分析</h5> 
<h6 id="3.2.2.4.1%E8%B5%B7%E5%A7%8B%E4%BF%A1%E5%8F%B7">3.2.2.4.1起始信号</h6> 
<p><img alt="" height="714" src="https://images2.imgbox.com/e5/6f/F6P2h5vb_o.png" width="1200"></p> 
<p>           因为tx_start_en是异步信号，它来自udp_rx模块中的rec_pkt_done信号，这里捕捉它的上升沿变信号，因此需要对其打三拍。</p> 
<p><img alt="" height="870" src="https://images2.imgbox.com/cb/e5/PNqrQYZv_o.png" width="1200"></p> 
<p> 仿真文件中激励信号如下，代表清零信号消失后将tx_start_en拉高，并设置发送数据的字节数为10.</p> 
<p><img alt="" height="326" src="https://images2.imgbox.com/e3/12/yUjPcD8r_o.png" width="1200"></p> 
<p>仿真波形如下。</p> 
<p><img alt="" height="372" src="https://images2.imgbox.com/34/13/G6afFzcS_o.png" width="1200"></p> 
<h6 id="3.2.2.4.2%E5%AF%84%E5%AD%98%E5%90%84%E6%AE%B5%E9%95%BF%E5%BA%A6">3.2.2.4.2寄存各段长度</h6> 
<p><img alt="" height="778" src="https://images2.imgbox.com/38/c1/Fal2Jh8Q_o.png" width="1200">                以上代码的作用是依次计算出下图中的蓝色模块长度、绿色模块长度、紫色模块长度。</p> 
<p><img alt="" height="488" src="https://images2.imgbox.com/dc/52/3yIQKv2P_o.png" width="1200"></p> 
<p>                         由下面仿真模型可知，10+28=38，10+8=18，仿真正确。<img alt="" height="310" src="https://images2.imgbox.com/a9/db/6UzKB1Ns_o.png" width="1200"> </p> 
<h6 id="3.2.2.4.3%E7%A9%BA%E9%97%B2%E7%8A%B6%E6%80%81">3.2.2.4.3空闲状态</h6> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/bd/ef/EfBePPyr_o.png" width="1200"></p> 
<p>                         <img alt="" height="416" src="https://images2.imgbox.com/05/0d/jLvXDZc3_o.png" width="1200"></p> 
<p><img alt="" height="166" src="https://images2.imgbox.com/fb/ca/mfQM1i8S_o.png" width="1200">                           该段代码作用有三。第一：按照上面两个表格将IP首部和UDP首部更新到变量ip_head中。第二：若arp包发来的目的ip地址有更新，则将IP更新到ip_head[4]中。第三：若目的MAC地址有更新，则将MAC新值更新到eth_head值中。若无更新，则采用默认值。</p> 
<p>                          由于以上两个变量是中间变量，并非该模块的输入输出信号，故无仿真波形。</p> 
<h6 id="3.2.2.4.4IP%E9%A6%96%E9%83%A8%E6%A0%A1%E9%AA%8C%E6%A8%A1%E5%9D%97">3.2.2.4.4IP首部校验模块</h6> 
<p><img alt="" height="838" src="https://images2.imgbox.com/cc/d4/EpF0TTcV_o.png" width="1200"></p> 
<p>                       以上代码作用，将IP首部数据累加，累加和有进位继续累加，直至没有进位，将和按位取反，即可得校验值。</p> 
<h6 id="%E2%80%8B%E7%BC%96%E8%BE%91%C2%A03.2.2.4.5%E5%8F%91%E9%80%81%E5%89%8D%E5%AF%BC%E7%A0%81"><img alt="" height="182" src="https://images2.imgbox.com/27/6a/mo4PILlu_o.png" width="1200"> 3.2.2.4.5发送前导码</h6> 
<p><img alt="" height="376" src="https://images2.imgbox.com/a8/02/kwadkiXK_o.png" width="1200"></p> 
<p><img alt="" height="312" src="https://images2.imgbox.com/a9/b0/wPlToUKR_o.png" width="1200"></p> 
<h6 id="3.2.2.4.6%E5%8F%91%E9%80%81MAC%E5%B8%A7%E5%A4%B4">3.2.2.4.6发送MAC帧头</h6> 
<p><img alt="" height="464" src="https://images2.imgbox.com/97/d0/k3gaMJGn_o.png" width="1200"></p> 
<p>     包含6Byte目的MAC地址+6Byte源MAC地址+2Byte以太网协议类型。</p> 
<p>      仿真波形中1是目的MAC，2是源MAC，3是IP协议类型。</p> 
<p><img alt="" height="272" src="https://images2.imgbox.com/d3/f3/VwEMH0qb_o.png" width="1200"></p> 
<h6 id="3.2.2.4.7%E5%8F%91%E9%80%81IP%E9%A6%96%E9%83%A8%2BUDP%E9%A6%96%E9%83%A8">3.2.2.4.7发送IP首部+UDP首部</h6> 
<p><img alt="" height="1040" src="https://images2.imgbox.com/7d/21/8JW0IBMQ_o.png" width="1200"></p> 
<p>             该状态作用有二。第一发送IP首部+UDP首部。第二提前两个clk将向FIFO中读数据请求信号拉高。因为有时序延迟。</p> 
<p><img alt="" height="1056" src="https://images2.imgbox.com/48/c7/O6RsvAEO_o.png" width="1200"></p> 
<p><img alt="" height="300" src="https://images2.imgbox.com/03/af/t7Eu0nSd_o.png" width="1200"> 仿真波形中的1相当于发送了上面表格的第一行；2相当于发送了表格中第二行数据；3相当于发送表格中第三行数据，4相当于发送了表格中第四行数据。</p> 
<p><img alt="" height="1128" src="https://images2.imgbox.com/17/a3/KoYVwsTn_o.png" width="1200"></p> 
<p><img alt="" height="72" src="https://images2.imgbox.com/4c/27/wLG1DCPf_o.png" width="1200"></p> 
<p> <img alt="" height="156" src="https://images2.imgbox.com/10/62/y8fl7gbM_o.png" width="1200"></p> 
<p>上面仿真波形中的1、2、3相当于依次发送了上面两个表格中的数据。</p> 
<p>注意3中的tx_req，只有提前将该信号拉高，下面一个状态才能准时从FIFO中读取数据发送出去。</p> 
<h6 id="%C2%A03.2.2.4.8%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%AE%B5"> 3.2.2.4.8发送数据段</h6> 
<p><img alt="" height="996" src="https://images2.imgbox.com/7a/0b/NI9SF7HB_o.png" width="1200"></p> 
<p>              该状态下，gmii_txd一直等于tx_data，只不过赋值区间在由别的计数器控制。当实际发送数据个数&lt;18，则由real_tx_data_num=18控制，当实际发送个数大于18，则由data_cnt计数器控制。</p> 
<p>       有下面仿真波形图可知，当发送完10个数据时，提前将tx_req拉低。并且剩余8个数据填充aa。</p> 
<p><img alt="" height="462" src="https://images2.imgbox.com/0c/69/p0YQQa1t_o.png" width="1200"></p> 
<h2 id="%E5%9B%9B.%E6%9D%BF%E7%BA%A7%E9%AA%8C%E8%AF%81%C2%A0">四.板级验证 </h2> 
<p>            首先设置PC端的IP地址如下。</p> 
<p><img alt="" height="1118" src="https://images2.imgbox.com/31/2e/Ol0sdCMJ_o.png" width="892"></p> 
<p>   然后打开抓包工具wireshark，用于捕捉PC端和开发板发送的以太网报文。</p> 
<p><img alt="" height="1118" src="https://images2.imgbox.com/db/ee/CusIKFQS_o.png" width="1200">      紧接着打开正点原子的网口调试工具，向开发板发送10个字节的数据。</p> 
<p><img alt="" height="1152" src="https://images2.imgbox.com/16/fa/DD4RVlQw_o.png" width="1200"></p> 
<p>         上图中1是第一次发送的报文，只发送了01.</p> 
<p>         2是第二次发送的报文，发送了10个数据。</p> 
<p>         3表示发送的报文包数。</p> 
<p>         4表示总共发送的数据个数。</p> 
<p>         5表示总共接收的数据个数。</p> 
<p>         此时打开抓包工具，找到ARP协议</p> 
<p><img alt="" height="1086" src="https://images2.imgbox.com/28/9e/dl2Rqwe4_o.png" width="1200"></p> 
<p>            1中代表电脑向开发板发送的ARP请求，2表示开发板向电脑回馈的ARP应答包含开发板自身的MAC地址。</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/10/47/8HsNxIlb_o.png" width="1200"></p> 
<p>1中代表电脑向开发板发送UDP协议报文，2表示开发板向电脑环回UDP协议报文。</p> 
<p>3中表示端口号和校验码，4中表示发送的10个数据分别是01 02 03 04 05 06 07 08 09 10 </p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/ab/cd/Cx9zfzCd_o.png" width="1200"></p> 
<p>            上图展示的是开发板返回电脑端的报文数据，可以看出还回数据中 不足18字节，这里自动补充了8个数据。</p> 
<p><img alt="" height="1114" src="https://images2.imgbox.com/86/ef/HoPzmhJ0_o.png" width="1200">          再次发送报文，只不过这次发送20个数据。</p> 
<p><img alt="" height="1200" src="https://images2.imgbox.com/8e/46/wwDv5NmN_o.png" width="1200"></p> 
<p>  上图中显示当发送数据大于18个，则不会再填充额外的数据。 </p> 
<p><img alt="" height="962" src="https://images2.imgbox.com/8d/41/9x9QfFg1_o.png" width="1200"></p> 
<p>         上图显示ICMP通信正常。 </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9a1ecda516e3d342c5ee19e6a60fe2c4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【数据结构与算法】十大经典排序算法深度解析：冒泡排序、选择排序、插入排序、归并排序、快速排序、希尔排序、堆排序、计数排序、桶排序、基数排序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e7ab0f76f7dc7b5a67f1f5e8da45cb27/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">OpenCV||超详细的图像分割</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>