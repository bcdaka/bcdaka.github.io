<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL之CASE WHEN用法详解 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/932de2a3c6246d3031123e2a822da857/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="SQL之CASE WHEN用法详解">
  <meta property="og:description" content="目录 一、简单CASE WHEN函数：二、CASE WHEN条件表达式函数三、常用场景 场景1：不同状态展示为不同的值场景2：统计不同状态下的值场景3：配合聚合函数做统计场景4：CASE WHEN中使用子查询场景5：经典行转列，结合max聚合函数 一、简单CASE WHEN函数： CASE SCORE WHEN &#39;A&#39; THEN &#39;优&#39; ELSE &#39;不及格&#39; END # 使用 IF 函数进行替换 IF(SCORE = &#39;A&#39;, &#39;优&#39;, &#39;不及格&#39;) THEN后边的值与ELSE后边的值类型应一致，否则会报错。
如下：
CASE SCORE WHEN ‘A’ THEN ‘优’ ELSE 0 END’优’和0数据类型不一致则报错：
[Err] ORA-00932: 数据类型不一致: 应为 CHAR, 但却获得 NUMBER
简单CASE WHEN函数只能应对一些简单的业务场景，而CASE WHEN条件表达式的写法则更加灵活。
二、CASE WHEN条件表达式函数 类似JAVA中的IF ELSE语句。
格式：
CASE WHEN condition THEN result [WHEN...THEN...] ELSE result END SQL语言演示：
CASE WHEN SCORE = &#39;A&#39; THEN &#39;优&#39; WHEN SCORE = &#39;B&#39; THEN &#39;良&#39; WHEN SCORE = &#39;C&#39; THEN &#39;中&#39; ELSE &#39;不及格&#39; END # 等同于 CASE score WHEN &#39;A&#39; THEN &#39;优&#39; WHEN &#39;B&#39; THEN &#39;良&#39; WHEN &#39;C&#39; THEN &#39;中&#39; ELSE &#39;不及格&#39; END condition是一个返回布尔类型的表达式，">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-01-01T15:50:25+08:00">
    <meta property="article:modified_time" content="2024-01-01T15:50:25+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL之CASE WHEN用法详解</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h5>目录</h5> 
<ul><li><a href="#CASE_WHEN_7" rel="nofollow">一、简单CASE WHEN函数：</a></li><li><a href="#CASE_WHEN_22" rel="nofollow">二、CASE WHEN条件表达式函数</a></li><li><a href="#_56" rel="nofollow">三、常用场景</a></li><li> 
  <ul><li><a href="#1_142" rel="nofollow">场景1：不同状态展示为不同的值</a></li><li><a href="#2_158" rel="nofollow">场景2：统计不同状态下的值</a></li><li><a href="#3_185" rel="nofollow">场景3：配合聚合函数做统计</a></li><li><a href="#4CASE_WHEN_202" rel="nofollow">场景4：CASE WHEN中使用子查询</a></li><li><a href="#5max_223" rel="nofollow">场景5：经典行转列，结合max聚合函数</a></li></ul></li></ul> 
<h3><a name="t1"></a><a id="CASE_WHEN_7"></a>一、简单CASE WHEN函数：</h3> 
<pre><code>CASE SCORE WHEN 'A' THEN '优' ELSE '不及格' END

# 使用 IF 函数进行替换
IF(SCORE = 'A', '优', '不及格')
</code></pre> 
<p><strong>THEN后边的值与ELSE后边的值类型应一致，否则会报错</strong>。<br> 如下：<br> CASE SCORE WHEN ‘A’ THEN ‘优’ ELSE 0 END’优’和0<a href="https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B&amp;spm=1001.2101.3001.7020" title="数据类型">数据类型</a>不一致则报错：<br> [Err] ORA-00932: 数据类型不一致: 应为 CHAR, 但却获得 NUMBER</p> 
<p>简单CASE WHEN函数只能应对一些简单的业务场景，而CASE WHEN<a href="https://so.csdn.net/so/search?q=%E6%9D%A1%E4%BB%B6%E8%A1%A8%E8%BE%BE%E5%BC%8F&amp;spm=1001.2101.3001.7020" title="条件表达式">条件表达式</a>的写法则更加灵活。</p> 
<h3><a name="t2"></a><a id="CASE_WHEN_22"></a>二、CASE WHEN条件表达式函数</h3> 
<p>类似JAVA中的IF ELSE语句。</p> 
<p>格式：</p> 
<pre><code>CASE WHEN condition THEN result
 
[WHEN...THEN...]
 
ELSE result
 
END
</code></pre> 
<p>SQL语言演示：</p> 
<pre><code>CASE 
	 WHEN SCORE = 'A' THEN '优'
     WHEN SCORE = 'B' THEN '良'
     WHEN SCORE = 'C' THEN '中' 
     ELSE '不及格' END

# 等同于
CASE score
    WHEN 'A' THEN '优'
    WHEN 'B' THEN '良'
    WHEN 'C' THEN '中'
    ELSE '不及格' END
</code></pre> 
<p>condition是一个返回布尔类型的表达式，<br> 如果表达式返回true，则整个函数返回相应result的值，<br> 如果表达式皆为false，则返回ElSE后result的值，如果省略了ELSE子句，则返回NULL。</p> 
<h3><a name="t3"></a><a id="_56"></a>三、常用场景</h3> 
<blockquote> 
 <p>前言</p> 
</blockquote> 
<p><strong>students表的DDL</strong></p> 
<pre><code>-- auto-generated definition
create table students
(
    stu_code  varchar(10) null,
    stu_name  varchar(10) null,
    stu_sex   int         null,
    stu_score int         null
);
</code></pre> 
<p><strong>students表的DML</strong></p> 
<pre><code># 其中stu_sex字段，0表示男生，1表示女生。
INSERT INTO students (stu_code, stu_name, stu_sex, stu_score) VALUES ('xm', '小明', 0, 88);
INSERT INTO students (stu_code, stu_name, stu_sex, stu_score) VALUES ('xl', '夏磊', 0, 55);
INSERT INTO students (stu_code, stu_name, stu_sex, stu_score) VALUES ('xf', '晓峰', 0, 45);
INSERT INTO students (stu_code, stu_name, stu_sex, stu_score) VALUES ('xh', '小红', 1, 89);
INSERT INTO students (stu_code, stu_name, stu_sex, stu_score) VALUES ('xn', '小妮', 1, 77);
INSERT INTO students (stu_code, stu_name, stu_sex, stu_score) VALUES ('xy', '小一', 1, 99);
INSERT INTO students (stu_code, stu_name, stu_sex, stu_score) VALUES ('xs', '小时', 1, 45);
</code></pre> 
<hr> 
<p><strong>energy_test表的DDL</strong></p> 
<pre><code>-- auto-generated definition
create table energy_test
(
    e_code  varchar(2)    null,
    e_value decimal(5, 2) null,
    e_type  int           null
);
</code></pre> 
<p><strong>energy_test表的DML</strong></p> 
<pre><code># 其中，E_TYPE表示能耗类型，0表示水耗，1表示电耗，2表示热耗
INSERT INTO energy_test (e_code, e_value, e_type) VALUES ('北京', 28.50, 0);
INSERT INTO energy_test (e_code, e_value, e_type) VALUES ('北京', 23.50, 1);
INSERT INTO energy_test (e_code, e_value, e_type) VALUES ('北京', 28.12, 2);
INSERT INTO energy_test (e_code, e_value, e_type) VALUES ('北京', 12.30, 0);
INSERT INTO energy_test (e_code, e_value, e_type) VALUES ('北京', 15.46, 1);
INSERT INTO energy_test (e_code, e_value, e_type) VALUES ('上海', 18.88, 0);
INSERT INTO energy_test (e_code, e_value, e_type) VALUES ('上海', 16.66, 1);
INSERT INTO energy_test (e_code, e_value, e_type) VALUES ('上海', 19.99, 0);
INSERT INTO energy_test (e_code, e_value, e_type) VALUES ('上海', 10.05, 0);
</code></pre> 
<hr> 
<p><strong>p_price表的DDL</strong></p> 
<pre><code>-- auto-generated definition
create table p_price
(
    p_price decimal(5, 2) null comment '价格',
    p_level int           null comment '等级',
    p_limit int           null comment '阈值'
)
    comment '电能耗单价表';
</code></pre> 
<p><strong>p_price表的DML</strong></p> 
<pre><code>INSERT INTO test.p_price (p_price, p_level, p_limit) VALUES (1.20, 0, 10);
INSERT INTO test.p_price (p_price, p_level, p_limit) VALUES (1.70, 1, 30);
INSERT INTO test.p_price (p_price, p_level, p_limit) VALUES (2.50, 2, 50);
</code></pre> 
<hr> 
<p><strong>user_col_comments 表的DDL</strong></p> 
<pre><code>-- auto-generated definition
create table user_col_comments
(
    column_name varchar(50)  null comment '列名',
    comment     varchar(100) null comment '列的备注'
);
</code></pre> 
<p><strong>user_col_comments 表的DML</strong></p> 
<pre><code>INSERT INTO test.user_col_comments (column_name, comment) VALUES ('SHI_SHI_CODE', '设施编号');
INSERT INTO test.user_col_comments (column_name, comment) VALUES ('SHUI_HAO', '水耗');
INSERT INTO test.user_col_comments (column_name, comment) VALUES ('RE_HAO', '热耗');
INSERT INTO test.user_col_comments (column_name, comment) VALUES ('YAN_HAO', '盐耗');
INSERT INTO test.user_col_comments (column_name, comment) VALUES ('OTHER', '其他');
</code></pre> 
<h4><a name="t4"></a><a id="1_142"></a>场景1：不同状态展示为不同的值</h4> 
<blockquote> 
 <p>有分数score，score&lt;60返回不及格，score&gt;=60返回及格，score&gt;=80返回优秀<br><img alt="在这里插入图片描述" src="https://images2.imgbox.com/cc/ea/ukBF4cPg_o.png"></p> 
</blockquote> 
<pre><code># 有分数score，score&lt;60返回不及格，score&gt;=60返回及格，score&gt;=80返回优秀
SELECT
    stu_name,
    (CASE WHEN stu_score &lt; 60 THEN '不及格'
        WHEN stu_score &gt;= 60 AND stu_score &lt; 80 THEN '及格'
        WHEN stu_score &gt;= 80 THEN '优秀'
        ELSE '异常' END) AS REMARK
FROM students;
</code></pre> 
<p><strong>注意：如果你想判断score是否null的情况，WHEN score = null THEN ‘缺席考试’，这是一种错误的写法，正确的写法应为：</strong><br><code>CASE WHEN score IS NULL THEN '缺席考试' ELSE '正常' END</code></p> 
<h4><a name="t5"></a><a id="2_158"></a>场景2：统计不同状态下的值</h4> 
<blockquote> 
 <p>现老师要统计班中，有多少男同学，多少女同学，并统计男同学中有几人及格，女同学中有几人及格，要求用一个SQL输出结果。其中stu_sex字段，0表示男生，1表示女生。<br><img alt="在这里插入图片描述" src="https://images2.imgbox.com/b5/27/N7QUEpLd_o.png"></p> 
</blockquote> 
<pre><code>SELECT
	sum(CASE WHEN STU_SEX = 0 THEN 1 ELSE 0 END) AS MALE_COUNT,
	sum(CASE WHEN STU_SEX = 1 THEN 1 ELSE 0 END) AS FEMALE_COUNT,
	sum(CASE WHEN STU_SCORE &gt;= 60 AND STU_SEX = 0 THEN 1 ELSE 0 END) AS MALE_PASS,
	sum(CASE WHEN STU_SCORE &gt;= 60 AND STU_SEX = 1 THEN 1 ELSE 0 END) AS FEMALE_PASS
FROM
	students;
</code></pre> 
<p>输出结果如下：</p> 
<p><img alt="统计不同状态下的值" src="https://images2.imgbox.com/25/44/0AQWjA2i_o.png"></p> 
<p>注意点：</p> 
<ul><li>用的是 ：<code>sum </code>而不是count</li><li><code>THEN 1 ELSE 0</code>的位置不能改变：否则会有以下效果： <pre><code>sum(CASE WHEN stu_sex = 0 THEN '1' ELSE '0' END) AS '男性',

改变了 
sum(CASE WHEN stu_sex = 0 THEN '0' ELSE '1' END) AS '女性'：
</code></pre> </li><li>字符 ‘0’ 和 数值 0，使用 都是一样的</li></ul> 
<h4><a name="t6"></a><a id="3_185"></a>场景3：配合聚合函数做统计</h4> 
<blockquote> 
 <p>现要求统计各个城市，总共使用了多少水耗、电耗、热耗，使用一条SQL语句输出结果<br> 有能耗表如下：其中，E_TYPE表示能耗类型，0表示水耗，1表示电耗，2表示热耗<br><img alt="在这里插入图片描述" src="https://images2.imgbox.com/32/cd/aJQRseJV_o.png"></p> 
</blockquote> 
<pre><code>select e_code,
       sum(case when e_type = 0 then e_value else 0 end) as '水耗',
       sum(case when e_type = 1 then e_value else 0 end) as '电耗',
       sum(case when e_type = 2 then e_value else 0 end) as '热耗'
from energy_test
group by e_code;
</code></pre> 
<p>输出结果如下：</p> 
<p><img alt="经典行转列，并配合聚合函数做统计" src="https://images2.imgbox.com/60/2b/bSpq2bez_o.png"></p> 
<h4><a name="t7"></a><a id="4CASE_WHEN_202"></a>场景4：CASE WHEN中使用子查询</h4> 
<blockquote> 
 <p>根据城市用电量多少，计算用电成本。假设电能耗单价分为三档，根据不同的能耗值，使用相应价格计算成本。<br> 当能耗值小于10时，使用P_LEVEL=0时的P_PRICE的值，能耗值大于10小于30使用P_LEVEL=1时的P_PRICE的值…<br><img alt="energy_test" src="https://images2.imgbox.com/1c/7e/bfNJMA8z_o.png"><br> energy_test 我修改了e_type 为1的值的两条数据的e_value。<br><img alt="p_price" src="https://images2.imgbox.com/b2/06/ga0gABHV_o.png"></p> 
</blockquote> 
<pre><code>select e_code, e_value,
     (CASE WHEN e_value &lt;= (SELECT p_limit FROM p_price WHERE p_level = 0)
        THEN (SELECT p_price FROM p_price WHERE p_level = 0)
     WHEN e_value &gt; (SELECT p_limit FROM p_price WHERE p_level = 0) AND e_value &lt;= (SELECT p_limit FROM p_price WHERE p_level = 1)
        THEN (SELECT P_PRICE FROM p_price WHERE P_LEVEL = 1)
     WHEN e_value &gt; (SELECT p_limit FROM p_price WHERE p_level = 1) AND e_value &lt;= (SELECT p_limit FROM p_price WHERE p_level = 2)
        THEN (SELECT p_price FROM p_price WHERE P_LEVEL = 2) end ) as price
from energy_test
where e_type = 1;
</code></pre> 
<p>输出结果如下：<br><img alt="在这里插入图片描述" src="https://images2.imgbox.com/40/b2/kmST7WUl_o.png"></p> 
<h4><a name="t8"></a><a id="5max_223"></a>场景5：经典行转列，结合max聚合函数</h4> 
<p>行转列中 SUM作用：无用，但是select后得跟聚合函数，不能去掉sum。直接写max或者min也行。</p> 
<blockquote> 
 <p><img alt="在这里插入图片描述" src="https://images2.imgbox.com/ab/19/MZT8tGyq_o.png"></p> 
</blockquote> 
<pre><code>select
    max(case when column_name = 'SHI_SHI_CODE' then comment else ''end) as SHI_SHI_CODE_COMMENT,
    max(case when column_name = 'SHUI_HAO' then comment else ''end) as SHUI_HAO_COMMENT,
    max(case when column_name = 'RE_HAO' then comment else ''end) as RE_HAO_COMMENT,
    max(case when column_name = 'YAN_HAO' then comment else ''end) as YAN_HAO_COMMENT,
    max(case when column_name = 'OTHER' then comment else '' end) as OTHER_COMMENT
from user_col_comments;
</code></pre> 
<p>输出结果如下：<br><img alt="在这里插入图片描述" src="https://images2.imgbox.com/3a/f5/68BDhxCi_o.png"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/96539e075bef766b871a8a0ed5457b3c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【二叉树】【单调双向队列】LeetCode239:滑动窗口最大值</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fb53ed9e05714b21b46733d7e51afe60/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Linux C | 文件I/O】fcntl函数详解 | 设置描述符非阻塞、文件(记录)锁</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>