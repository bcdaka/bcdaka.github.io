<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>åŸºäº RabbitMQ å®ç° Eureka æœåŠ¡å¹³æ»‘ç°åº¦å‘å¸ƒ - ç¼–ç¨‹å¤§å’–</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/928239b5a02d30050336891b6f21bb41/">
  <meta property="og:site_name" content="ç¼–ç¨‹å¤§å’–">
  <meta property="og:title" content="åŸºäº RabbitMQ å®ç° Eureka æœåŠ¡å¹³æ»‘ç°åº¦å‘å¸ƒ">
  <meta property="og:description" content="å‰â¾” å‰æ®µæ—¶é—´â¼€ä½â¼¤é¾„ç¨‹åºæ¥å…¬å¸â¾¯è¯•ï¼Œå·²ç»æ˜¯åšåˆ°æŠ€æœ¯ leader çš„çº§åˆ«ï¼Œâ¾¯è¯•å¼€å§‹ä»–â½è¾ƒâ¾ƒè±ªåœ°å‘
æˆ‘ä»¬ä»‹ç»çš„è®¾è®¡æŠ€æœ¯æ¶æ„ã€ç¼“å­˜è®¾è®¡ã€ä¸šåŠ¡è®¾è®¡ç­‰ç­‰ï¼Œä»–è¯´è¯¥é¡¹â½¬æ˜¯ä»–â¼€â¼¿æ‰“é€ èµ·æ¥çš„ã€‚åœ¨æœ
åŠ¡â¾¼å¯â½¤â½…â¾¯ï¼Œå£°ç§°å¯ä»¥åšåˆ° 4 ä¸ª 9ã€‚å› ä¸ºä¹Ÿæ˜¯ Spring Bootã€Spring Cloud è¿™å¥—â½è¾ƒæµâ¾çš„ä¸œâ»„ã€‚å› ä¸ºæˆ‘ä»¬ä¹Ÿæ˜¯â½¤ Spring Cloud å…¨å®¶æ¡¶ï¼Œä½†æ˜¯æœ‰äº›é—®é¢˜æˆ‘ä»¬è¿˜æ²¡æœ‰è§£å†³çš„ï¼Œâ¼€å¬åˆ°å¯¹â½…è¯´ 4 ä¸ª 9ã€‚é¡¿æ—¶æ¥äº†å…´è¶£ï¼Œå‡†å¤‡è†œæ‹œâ¼€ä¸‹â¼¤ç¥æ€ä¹ˆè§£å†³â¾¼å¯â½¤é—®é¢˜çš„ã€‚
ä»–è¯´â½¤æ˜¯ Eurekaã€Ribbon è¿™å¥—æœºåˆ¶å®ç°â¾¼å¯â½¤ï¼Œæˆ‘ä»¬é—®é¢˜æ˜¯ Eurekaã€Ribbon æ€ä¹ˆå®ç°â¾¼å¯
â½¤çš„ï¼Œæœ‰ä»€ä¹ˆå¼Šç«¯ã€‚å¯¹â½…è¯­å¡ï¼Œå¼€å§‹ä¸œæ‹‰â»„æ‰¯ï¼Œâ¼¤å¤±æ‰€æœ›ã€‚å¯èƒ½æœ‰äº›åŒå­¦ä¸çŸ¥é“ï¼Œåœ¨ä½¿â½¤ Eurekaã€Ribbon æ—¶å€™ï¼Œç”±äº Eurekaã€Ribbon å†…éƒ¨çš„ç¼“å­˜æœº åˆ¶ã€‚ä¼šå¯¼è‡´æœåŠ¡ä¸Šçº¿æˆ–è€…ä¸‹çº¿çš„æ—¶å€™ä¼šå‡ºç°æœåŠ¡ä¸å¯â½¤çš„æƒ…å†µï¼Œæç«¯æƒ…å†µä¸‹ä¼šå‡ºç° 90 ç§’æœåŠ¡ä¸å¯èƒ½ã€‚åœ¨æ²¡æœ‰è§£å†³è¿™äº›é—®é¢˜çš„å‰æä¸‹ï¼Œä½¿â½¤ Eurekaã€Ribbon æ­å»ºå¾®æœåŠ¡åº”â½¤æ˜¯ä¸å¯èƒ½ä¼šæœ‰ 4 ä¸ª 9 çš„ã€‚
å¯¹äºè¿™ç§æƒ…å†µï¼Œå®˜â½…ä¹Ÿæ²¡æœ‰ç»™å…·ä½“çš„è§£å†³â½…æ¡ˆã€‚åœ¨æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œå¾ˆå¤šå…¬å¸ä¹Ÿè®¸ä¼šè·Ÿ
æˆ‘ä»¬é‡‡å–åŒæ ·çš„åšæ³•ï¼Œå°±æ˜¯åœ¨æ™šä¸Šæµé‡â½è¾ƒå°‘æƒ…å†µåœæœå‘å¸ƒã€‚ä½†æ˜¯è¯•ä¸‹â¼€æƒ³ï¼Œæ¯æ¬¡å‘å¸ƒéƒ½åªèƒ½
åœ¨ 23 ç‚¹ä»¥åå‘å¸ƒï¼Œå…³é—­ SLBï¼Œåœæœºï¼Œæ‰§â¾ SQLï¼Œèµ·æœåŠ¡ã€‚â¼—â¼ä¸ªæœåŠ¡ï¼ŒéªŒè¯åŠŸèƒ½ï¼Œâ¼€é¡¿æ“ä½œ
â¼€ä¸‹ï¼Œâ¾„å°‘è¦æåˆ°ä¸¤ä¸‰ç‚¹ã€‚è¿™å¯¹äºæ•´ä¸ªå¼€å‘å›¢é˜Ÿæ¥è¯´éƒ½æ˜¯â¼€ç§è´Ÿæ‹…ã€‚
æœ¬â½‚å°†åˆ†äº«æ˜¯å¦‚ä½•è§£å†³ Eurekaã€Ribbon ç»„ä»¶ä½¿â½¤ä¸Šçš„å¼Šç«¯ã€‚
Eureka æ³¨å†Œï¼ŒæœåŠ¡å‘ç°æœºåˆ¶åŸç† ç›¸ä¿¡ç†Ÿæ‚‰å¾®æœåŠ¡æ¶æ„çš„â¼ˆï¼Œéƒ½çŸ¥é“æœåŠ¡æ³¨å†Œä¸å‘ç°çš„ä½œâ½¤ã€‚åœ¨æˆç™¾ä¸Šåƒä¸ªå¾®æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»
éœ€è¦â¼€ä¸ªä¸­â¼¼æ¥é€šçŸ¥â½£äº§è€…ä¸æ¶ˆè´¹è€…çš„æœåŠ¡çŠ¶æ€å˜åŒ–ï¼Œä»¥ä¾¿æˆ‘ä»¬åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ç†æ¸…æˆ‘ä»¬çš„æœ
åŠ¡è°ƒâ½¤å…³ç³»ã€‚
ç»è¿‡å¾®æœåŠ¡æ¶æ„å¤šå¹´çš„å‘å±•ï¼Œå‡ºç°å¾ˆå¤šç§æ³¨å†Œä¸­â¼¼ï¼Œå¦‚ Nacoã€Eurekaã€etcã€ZooKeeper ç­‰
ç­‰ï¼Œå…¶å®â¼¤ä½“æ€æƒ³éƒ½â¼€æ ·ã€‚åœ¨æœåŠ¡å¯åŠ¨æ—¶å€™å‘æ³¨å†Œä¸­â¼¼å‘é€æ¶ˆæ¯å‘Šè¯‰æ³¨å†Œä¸­â¼¼æˆ‘å·²ç» readyï¼Œ
å¯ä»¥è¢«è°ƒâ½¤äº†ï¼Œç„¶åå†æŒç»­è¿â¾è¿‡ç¨‹é€šè¿‡â¼¼è·³çš„â½…å¼å‘æ³¨å†Œä¸­â¼¼æ±‡æŠ¥â¾ƒèº«çš„çŠ¶æ€ã€‚
æ³¨å†Œä¸­â¼¼æ”¶åˆ°æœåŠ¡æ³¨å†Œä¿¡æ¯åï¼Œå‘è°ƒâ½¤â½…æ¨é€æˆ–è€…è°ƒâ½¤â½…ä¸»åŠ¨æ‹‰å–éœ€è¦è°ƒâ½¤çš„æœåŠ¡çš„çŠ¶æ€ä¿¡
æ¯ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å…¶å®å¹¶æ²¡æœ‰å¾ˆâ¾¼æ·±çš„ç†è®ºä¸æ€æƒ³ã€‚æ³¨å†Œä¸­â¼¼ä¸å„ä¸ªæœåŠ¡çš„äº¤äº’â½…å¼â½†â¾®å°±æ˜¯
â»“è¿æˆ–è€…çŸ­è¿ã€‚
æœåŠ¡æ³¨å†Œä¸ç»­çº¦æœºåˆ¶ï¼Œç¼“å­˜åˆ·æ–° åœ¨æœåŠ¡ç¯å¢ƒå®Œå…¨å¯åŠ¨å®Œæˆä¹‹åï¼Œé›†æˆäº† eureka-client çš„æœåŠ¡ä¼šå®ä¾‹åŒ–com.netflix.discovery.DiscoveryClient å®ä¾‹ï¼ŒDiscoveryClient å®ä¾‹å¯¹ Eureka å®¢æˆ·ç«¯æ¥è¯´â¾„å…³é‡è¦ï¼Œå„ç§çº¿ç¨‹æ±  åˆå§‹åŒ–ã€æœåŠ¡æ³¨å†Œã€ç»­çº¦ã€åˆ·æ–°ç¼“å­˜éƒ½åœ¨è¿™ä¸ªå¯¹è±¡å®Œæˆã€‚DiscoveryClient æœ‰ä¸ªå¼ºâ¼¤çš„æ„é€ â½…æ³•ï¼Œåœ¨åˆå§‹åŒ–çš„æ„é€ ä¸‰ä¸ªâ¾„å…³çš„é‡è¦çš„çº¿ç¨‹æ± ">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-27T20:31:46+08:00">
    <meta property="article:modified_time" content="2024-04-27T20:31:46+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ç¼–ç¨‹å¤§å’–" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ç¼–ç¨‹å¤§å’–</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">åŸºäº RabbitMQ å®ç° Eureka æœåŠ¡å¹³æ»‘ç°åº¦å‘å¸ƒ</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2><a id="_0"></a></h2> 
<h3 id="hCVRQ">å‰â¾”</h3> 
<p id="uc7eb790c">å‰æ®µæ—¶é—´â¼€ä½â¼¤é¾„ç¨‹åºæ¥å…¬å¸â¾¯è¯•ï¼Œå·²ç»æ˜¯åšåˆ°æŠ€æœ¯ leader çš„çº§åˆ«ï¼Œâ¾¯è¯•å¼€å§‹ä»–â½è¾ƒâ¾ƒè±ªåœ°å‘</p> 
<p id="u27e18c7c">æˆ‘ä»¬ä»‹ç»çš„è®¾è®¡æŠ€æœ¯æ¶æ„ã€ç¼“å­˜è®¾è®¡ã€ä¸šåŠ¡è®¾è®¡ç­‰ç­‰ï¼Œä»–è¯´è¯¥é¡¹â½¬æ˜¯ä»–â¼€â¼¿æ‰“é€ èµ·æ¥çš„ã€‚åœ¨æœ</p> 
<p id="u9897b73f">åŠ¡â¾¼å¯â½¤â½…â¾¯ï¼Œå£°ç§°å¯ä»¥åšåˆ° 4 ä¸ª 9ã€‚å› ä¸ºä¹Ÿæ˜¯ Spring Bootã€Spring Cloud è¿™å¥—â½è¾ƒæµâ¾çš„ä¸œâ»„ã€‚å› ä¸ºæˆ‘ä»¬ä¹Ÿæ˜¯â½¤ Spring Cloud å…¨å®¶æ¡¶ï¼Œä½†æ˜¯æœ‰äº›é—®é¢˜æˆ‘ä»¬è¿˜æ²¡æœ‰è§£å†³çš„ï¼Œâ¼€å¬åˆ°å¯¹â½…è¯´ 4 ä¸ª 9ã€‚é¡¿æ—¶æ¥äº†å…´è¶£ï¼Œå‡†å¤‡è†œæ‹œâ¼€ä¸‹â¼¤ç¥æ€ä¹ˆè§£å†³â¾¼å¯â½¤é—®é¢˜çš„ã€‚</p> 
<p id="u72998203"></p> 
<p id="u42e7b81a">ä»–è¯´â½¤æ˜¯ Eurekaã€Ribbon è¿™å¥—æœºåˆ¶å®ç°â¾¼å¯â½¤ï¼Œæˆ‘ä»¬é—®é¢˜æ˜¯ Eurekaã€Ribbon æ€ä¹ˆå®ç°â¾¼å¯</p> 
<p id="u3d6a8b2c">â½¤çš„ï¼Œæœ‰ä»€ä¹ˆå¼Šç«¯ã€‚å¯¹â½…è¯­å¡ï¼Œå¼€å§‹ä¸œæ‹‰â»„æ‰¯ï¼Œâ¼¤å¤±æ‰€æœ›ã€‚å¯èƒ½æœ‰äº›åŒå­¦ä¸çŸ¥é“ï¼Œåœ¨ä½¿â½¤ Eurekaã€Ribbon æ—¶å€™ï¼Œç”±äº Eurekaã€Ribbon å†…éƒ¨çš„ç¼“å­˜æœº åˆ¶ã€‚ä¼šå¯¼è‡´æœåŠ¡ä¸Šçº¿æˆ–è€…ä¸‹çº¿çš„æ—¶å€™ä¼šå‡ºç°æœåŠ¡ä¸å¯â½¤çš„æƒ…å†µï¼Œæç«¯æƒ…å†µä¸‹ä¼šå‡ºç° 90 ç§’æœåŠ¡ä¸å¯èƒ½ã€‚åœ¨æ²¡æœ‰è§£å†³è¿™äº›é—®é¢˜çš„å‰æä¸‹ï¼Œä½¿â½¤ Eurekaã€Ribbon æ­å»ºå¾®æœåŠ¡åº”â½¤æ˜¯ä¸å¯èƒ½ä¼šæœ‰ 4 ä¸ª 9 çš„ã€‚</p> 
<p id="ucd6a556a"></p> 
<p id="uf1d36296">å¯¹äºè¿™ç§æƒ…å†µï¼Œå®˜â½…ä¹Ÿæ²¡æœ‰ç»™å…·ä½“çš„è§£å†³â½…æ¡ˆã€‚åœ¨æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œå¾ˆå¤šå…¬å¸ä¹Ÿè®¸ä¼šè·Ÿ</p> 
<p id="u980b6e44">æˆ‘ä»¬é‡‡å–åŒæ ·çš„åšæ³•ï¼Œå°±æ˜¯åœ¨æ™šä¸Šæµé‡â½è¾ƒå°‘æƒ…å†µåœæœå‘å¸ƒã€‚ä½†æ˜¯è¯•ä¸‹â¼€æƒ³ï¼Œæ¯æ¬¡å‘å¸ƒéƒ½åªèƒ½</p> 
<p id="ue0c84737">åœ¨ 23 ç‚¹ä»¥åå‘å¸ƒï¼Œå…³é—­ SLBï¼Œåœæœºï¼Œæ‰§â¾ SQLï¼Œèµ·æœåŠ¡ã€‚â¼—â¼ä¸ªæœåŠ¡ï¼ŒéªŒè¯åŠŸèƒ½ï¼Œâ¼€é¡¿æ“ä½œ</p> 
<p id="u165e38d4">â¼€ä¸‹ï¼Œâ¾„å°‘è¦æåˆ°ä¸¤ä¸‰ç‚¹ã€‚è¿™å¯¹äºæ•´ä¸ªå¼€å‘å›¢é˜Ÿæ¥è¯´éƒ½æ˜¯â¼€ç§è´Ÿæ‹…ã€‚</p> 
<p id="u5cdf87af"></p> 
<p id="u613569ff"><strong>æœ¬â½‚å°†åˆ†äº«æ˜¯å¦‚ä½•è§£å†³ Eurekaã€Ribbon ç»„ä»¶ä½¿â½¤ä¸Šçš„å¼Šç«¯ã€‚</strong></p> 
<h3 id="XEoBV">Eureka æ³¨å†Œï¼ŒæœåŠ¡å‘ç°æœºåˆ¶åŸç†</h3> 
<p id="u02606013">ç›¸ä¿¡ç†Ÿæ‚‰å¾®æœåŠ¡æ¶æ„çš„â¼ˆï¼Œéƒ½çŸ¥é“æœåŠ¡æ³¨å†Œä¸å‘ç°çš„ä½œâ½¤ã€‚åœ¨æˆç™¾ä¸Šåƒä¸ªå¾®æœåŠ¡ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»</p> 
<p id="u0d47be48">éœ€è¦â¼€ä¸ªä¸­â¼¼æ¥é€šçŸ¥â½£äº§è€…ä¸æ¶ˆè´¹è€…çš„æœåŠ¡çŠ¶æ€å˜åŒ–ï¼Œä»¥ä¾¿æˆ‘ä»¬åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ç†æ¸…æˆ‘ä»¬çš„æœ</p> 
<p id="u5e7aeaf0">åŠ¡è°ƒâ½¤å…³ç³»ã€‚</p> 
<p id="ubf42e7aa">ç»è¿‡å¾®æœåŠ¡æ¶æ„å¤šå¹´çš„å‘å±•ï¼Œå‡ºç°å¾ˆå¤šç§æ³¨å†Œä¸­â¼¼ï¼Œå¦‚ Nacoã€Eurekaã€etcã€ZooKeeper ç­‰</p> 
<p id="u70b941f6">ç­‰ï¼Œå…¶å®â¼¤ä½“æ€æƒ³éƒ½â¼€æ ·ã€‚åœ¨æœåŠ¡å¯åŠ¨æ—¶å€™å‘æ³¨å†Œä¸­â¼¼å‘é€æ¶ˆæ¯å‘Šè¯‰æ³¨å†Œä¸­â¼¼æˆ‘å·²ç» readyï¼Œ</p> 
<p id="ub926a1e1">å¯ä»¥è¢«è°ƒâ½¤äº†ï¼Œç„¶åå†æŒç»­è¿â¾è¿‡ç¨‹é€šè¿‡â¼¼è·³çš„â½…å¼å‘æ³¨å†Œä¸­â¼¼æ±‡æŠ¥â¾ƒèº«çš„çŠ¶æ€ã€‚</p> 
<p id="ua1a771df"></p> 
<p id="u564d35d3">æ³¨å†Œä¸­â¼¼æ”¶åˆ°æœåŠ¡æ³¨å†Œä¿¡æ¯åï¼Œå‘è°ƒâ½¤â½…æ¨é€æˆ–è€…è°ƒâ½¤â½…ä¸»åŠ¨æ‹‰å–éœ€è¦è°ƒâ½¤çš„æœåŠ¡çš„çŠ¶æ€ä¿¡</p> 
<p id="uae0b0d3f">æ¯ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å…¶å®å¹¶æ²¡æœ‰å¾ˆâ¾¼æ·±çš„ç†è®ºä¸æ€æƒ³ã€‚æ³¨å†Œä¸­â¼¼ä¸å„ä¸ªæœåŠ¡çš„äº¤äº’â½…å¼â½†â¾®å°±æ˜¯</p> 
<p id="uceee262c">â»“è¿æˆ–è€…çŸ­è¿ã€‚</p> 
<p class="img-center"><img alt="" height="646" id="u4d36eb94" src="https://images2.imgbox.com/8a/9c/Dwq8oX3l_o.png" width="1200"></p> 
<h3 id="Kkjx5">æœåŠ¡æ³¨å†Œä¸ç»­çº¦æœºåˆ¶ï¼Œç¼“å­˜åˆ·æ–°</h3> 
<p id="u23548c57"></p> 
<p id="ua0490455">åœ¨æœåŠ¡ç¯å¢ƒå®Œå…¨å¯åŠ¨å®Œæˆä¹‹åï¼Œé›†æˆäº† eureka-client çš„æœåŠ¡ä¼šå®ä¾‹åŒ–com.netflix.discovery.DiscoveryClient å®ä¾‹ï¼ŒDiscoveryClient å®ä¾‹å¯¹ Eureka å®¢æˆ·ç«¯æ¥è¯´â¾„å…³é‡è¦ï¼Œå„ç§çº¿ç¨‹æ±  åˆå§‹åŒ–ã€æœåŠ¡æ³¨å†Œã€ç»­çº¦ã€åˆ·æ–°ç¼“å­˜éƒ½åœ¨è¿™ä¸ªå¯¹è±¡å®Œæˆã€‚DiscoveryClient æœ‰ä¸ªå¼ºâ¼¤çš„æ„é€ â½…æ³•ï¼Œåœ¨åˆå§‹åŒ–çš„æ„é€ ä¸‰ä¸ªâ¾„å…³çš„é‡è¦çš„çº¿ç¨‹æ± </p> 
<pre id="Z2WHm"><code class="language-java">// çº¿ç¨‹è°ƒåº¦å™¨
private final ScheduledExecutorService scheduler;
// â¼¼è·³çº¿ç¨‹æ±  ï¼Œä¸»è¦â½¤äºæ³¨å†Œä¸ç»­çº¦
private final ThreadPoolExecutor heartbeatExecutor;
// æœ¬åœ°ç¼“å­˜åˆ·æ–°çº¿ç¨‹æ± 
private final ThreadPoolExecutor cacheRefreshExecutor;</code></pre> 
<p id="u025eef9a"><strong>ğŸ–ï¸</strong><strong>åœ¨æ„é€ â½…æ³•â¾¥â¾¯åŒæ—¶è°ƒâ½¤â¼€ä¸ªé‡è¦â½…æ³• initScheduledTasks</strong></p> 
<pre id="gpJwv"><code class="language-java">private void initScheduledTasks() {
......
if (this.clientConfig.shouldFetchRegistry()) {
    ......
    // è¿™â¾¥â½¤ cacheRefreshExecutor çº¿ç¨‹æ± å¯åŠ¨å®šæ—¶ä»»åŠ¡æ¥å®šæ—¶åˆ·æ–°ç¼“å­˜ çš„æ“ä½œ
    this.scheduler.schedule(new TimedSupervisorTask("cacheReâ€
                                                    fresh", this.scheduler, this.cacheRefreshExecutor, renewalIntervalInâ€
                                                    Secs, TimeUnit.SECONDS, expBackOffBound, new
                                                    DiscoveryClient.CacheRefreshThread()), (long)renewalIntervalInSecs, 
                            TimeUnit.SECONDS);
}
if (this.clientConfig.shouldRegisterWithEureka()) {
    .......
    // è¿™â¾¥ä½¿â½¤äº† heartbeatExecutor çº¿ç¨‹æ± æ¥æ¥å¯åŠ¨ä»»åŠ¡è¿›â¾æ³¨å†Œä¸ç»­çº¦çš„ æ“ä½œ
    this.scheduler.schedule(new
                            TimedSupervisorTask("heartbeat", this.scheduler, this.heartbeatExecuâ€
                                                tor, renewalIntervalInSecs, TimeUnit.SECONDS, expBackOffBound, new
                                                DiscoveryClient.HeartbeatThread()), (long)renewalIntervalInSecs, 
                            TimeUnit.SECONDS);
    ..... 
} else {
    logger.info("Not registering with Eureka server per conâ€
    figuration");
} }</code></pre> 
<p id="u968b7656"></p> 
<p id="u6d726eb5"><strong>æ³¨å†Œä¸ç»­çº¦çš„æ—¶å€™çš„çº¿ç¨‹æ˜¯ HeartbeatThreadï¼š</strong></p> 
<pre id="DUlOb"><code class="language-java">private class HeartbeatThread implements Runnable {
    private HeartbeatThread() { }
    public void run() {
        if (DiscoveryClient.this.renew()) {
            DiscoveryClient.this.lastSuccessfulHeartbeatTimestamp 
            = System.currentTimeMillis();
        } }
}</code></pre> 
<p id="u6b35d0e7">åˆ°è¿™â¾¥æˆ‘ä»¬åŸºæœ¬æ˜â½©æ³¨å†Œä¸ç»­çº¦éƒ½æ˜¯â½¤äº† DiscoveryClient å¯¹è±¡çš„ renew â½…æ³•ã€‚</p> 
<p id="u97b485d1">åŒç†æˆ‘ä»¬çœ‹åˆ°ç¼“å­˜åˆ·æ–°ä½¿â½¤çš„æ˜¯ CacheRefreshThread çº¿ç¨‹ï¼š</p> 
<pre id="kmOx7"><code class="language-java">class CacheRefreshThread implements Runnable {
    CacheRefreshThread() {
    }
    public void run() {
        DiscoveryClient.this.refreshRegistry();
    } 
}</code></pre> 
<p id="udf6792f0">ç”±ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåˆ·æ–° Eureka å®¢æˆ·ç«¯çš„ç¼“å­˜æ˜¯é€šè¿‡ DiscoveryClient å¯¹è±¡çš„ refreshRegistry</p> 
<p id="u5097fbf2">â½…æ³•å®ç°çš„ã€‚</p> 
<h3 id="Y5c4a">Ribbon çš„è´Ÿè½½è´Ÿè½½å‡è¡¡ç­–ç•¥</h3> 
<p id="u5be78134"></p> 
<p id="u849a0e46">åœ¨ä½¿â½¤ Spring Cloud å…¨å®¶æ¡¶çš„ Ribbon åšè´Ÿè½½å‡è¡¡æ—¶å€™ï¼ŒRibbon ä¸åŒäº F5ã€Nginx ç­‰ç­‰é€šè¿‡</p> 
<p id="u88e25b83">è½¯ä»¶æˆ–è€…ç¡¬ä»¶åšè´Ÿè½½å‡è¡¡ï¼ŒRibbon ç›´æ¥å°±åœ¨åº”â½¤ç«¯åšè´Ÿè½½å‡è¡¡ã€‚Ribbon â¾ƒâ¼°å®ç°è´Ÿè½½å‡è¡¡å™¨ï¼Œæ ¹æ®â¼€å®šè§„åˆ™ï¼Œä» Ribbon çš„æœ¬åœ°ç¼“å­˜çš„æœåŠ¡åˆ—è¡¨â¾¥â¾¯é€‰æ‹©æœåŠ¡è¿›â¾è°ƒâ½¤ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒRibbonç»™æ¯ä¸ªæœåŠ¡éƒ½åˆå§‹åŒ–äº†â¼€ä¸ª Spring å®¹å™¨ã€‚Eureka çš„ç¼“å­˜åˆ—è¡¨æ˜¯é€šè¿‡å®š æ—¶ä»»åŠ¡å»æ³¨å†Œä¸­â¼¼æ‹‰å–ï¼ŒRibbon çš„æœ¬åœ°æœåŠ¡ç¼“å­˜åˆ—è¡¨åˆ™æ˜¯é€šè¿‡å®šæ—¶ä»»åŠ¡é€šè¿‡ Eureka çš„ç¼“å­˜åˆ—è¡¨åŒæ­¥è¿‡æ¥ã€‚</p> 
<p id="u0983f71a"></p> 
<p id="u25cd9705">æ‰“å¼€ org.springframework.cloud.netflix.ribbon.RibbonClientConfiguration åœ¨è¿™ä¸ªé…ç½®ç±»â¾¥</p> 
<p id="u6e45eb39">â¾¯ï¼Œå¯ä»¥çœ‹åˆ°å®šä¹‰äº†å„ç§ Ribbon è´Ÿè½½å‡è¡¡éœ€è¦çš„å„ç§å¯¹è±¡ã€‚å…¶ä¸­æœ‰å®šä¹‰äº†é»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„</p> 
<p id="u537451ed">åˆ™ï¼Œé»˜è®¤çš„æ‹‰å–æœåŠ¡åˆ—è¡¨çš„ç­–ç•¥ã€‚</p> 
<pre id="cYkXS"><code class="language-java">@Bean
@ConditionalOnMissingBean
public IRule ribbonRule(IClientConfig config) {
    if (this.propertiesFactory.isSet(IRule.class, this.name)) {
        return (IRule)this.propertiesFactory.get(IRule.class, conâ€
                                                 fig, this.name);
    } else {
        ZoneAvoidanceRule rule = new ZoneAvoidanceRule();
        rule.initWithNiwsConfig(config);
        return rule;
    } 
}</code></pre> 
<p id="ucd4eefec"></p> 
<p id="u6742bbbd">ä¸Šâ¾¯çš„ä»£ç ç»™æˆ‘ä»¬å®šä¹‰äº† Ribbon é»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œåœ¨æˆ‘ä»¬æ²¡æœ‰åˆå§‹åŒ–å…¶ä»–å®ç° IRule ç±»</p> 
<p id="u510ab875">çš„æ—¶å€™æ‰§â¾ã€‚</p> 
<p id="u36a18632"><strong>Ribbon ä¸»è¦å®ç°äº†â¼€ä¸‹â¼ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼š </strong></p> 
<ul><li id="ud3d78d99">RoundRobinRuleï¼šè½®è¯¢ç­–ç•¥</li><li id="u80124e0b">RandomRuleï¼šéšæœºç­–ç•¥</li><li id="u2bce1403">AvailabilityFilteringRuleï¼šå¯â½¤è¿‡æ»¤ç­–ç•¥</li><li id="ue8f03910">WeightedResponseTimeRuleï¼šå“åº”æ—¶é—´æƒé‡ç­–ç•¥</li><li id="uf6926c04">RetryRuleï¼šè½®è¯¢å¤±è´¥é‡è¯•ç­–ç•¥</li><li id="u9674c630">BestAvailableRuleï¼šå¹¶å‘é‡æœ€â¼©å¯â½¤ç­–ç•¥</li><li id="udc805b87">ZoneAvoidanceRuleï¼šæ ¹æ® server æ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œ server çš„å¯â½¤æ€§</li></ul> 
<p id="u545093c7">å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®ä¸šåŠ¡è¦æ±‚â¾ƒå®šä¹‰è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚</p> 
<p id="u06977822">å¦‚ä¸‹ä»£ç ï¼ŒRibbon å®šä¹‰äº†é»˜è®¤çš„æ‹‰å–æœåŠ¡åˆ—è¡¨çš„â½…å¼ï¼š</p> 
<pre id="r2VWS"><code class="language-java">@Bean
@ConditionalOnMissingBean
public ServerListUpdater ribbonServerListUpdater(IClientConfig 
                                                 config) {
    return new PollingServerListUpdater(config);
}</code></pre> 
<p id="u9c86b5f4"></p> 
<p id="u22dd434c"><strong>Ribbon å®ç°äº†ä¸¤ç§æ‹‰å–æœåŠ¡çš„â½…å¼ï¼š </strong></p> 
<ul><li id="u630ca302">PollingServerListUpdaterï¼šé€šè¿‡çº¿ç¨‹æ± å®šæ—¶ä»»åŠ¡çš„â½…å¼æ¯éš” 30s ä» Eureka ç¼“å­˜æ‹‰å–</li><li id="u6d20d360">EurekaNotificationServerListUpdaterï¼šé€šè¿‡ç›‘å¬ Eureka çš„ç¼“å­˜æ›´æ–°äº‹ä»¶ï¼Œå½“ Eureka å®¢ æˆ·ç«¯ä»æ³¨å†Œä¸­â¼¼æ‹‰å–æœåŠ¡åˆ—è¡¨çš„æ—¶å€™ï¼ŒåŒæ—¶åŒæ­¥åˆ° Ribbon çš„ç¼“å­˜åˆ—è¡¨ä¸­ã€‚ä¸Šâ¾¯ä¸¤ä¸ªç±»éƒ½æ˜¯ ServerListUpdater çš„å®ç°ç±»ï¼Œéƒ½å®ç°äº† ServerListUpdate çš„ start â½…æ³•ã€‚â½½ start â½…æ³•ä¼šåœ¨ DynamicServerListLoadBalancerï¼ˆRibbon è´Ÿè½½å‡è¡¡å™¨ï¼‰åˆå§‹åŒ–çš„æ—¶å€™çš„è¢«è°ƒâ½¤ã€‚ä¸‹â¾¯å¯ä»¥çœ‹ä¸‹ start â½…æ³•çš„ä»£ç å®ç°ï¼š</li></ul> 
<pre id="v615m"><code class="language-java">public class EurekaNotificationServerListUpdater implements ServerListUpdater {
    //......çœç•¥ä»£ç 
    public synchronized void start(final UpdateAction updateAction) {
        if (this.isActive.compareAndSet(false, true)) {
            // åˆå§‹åŒ– Eureka æ—¶é—´ç›‘å¬å™¨
            this.updateListener = new EurekaEventListener() {
                public void onEvent(EurekaEvent event) {
                    // ......çœç•¥ä»£ç  }
                };
                //......çœç•¥ä»£ç 
                // æŠŠç›‘å¬å™¨æ³¨å†Œåˆ° Eureka çš„ç¼“å­˜æ›´æ–°äº‹ä»¶ä¸­
                this.eurekaClient.registerEventListener(this.updateListenâ€
                                                        er);
        } else {
            logger.info("Update listener already registered, no-op");
        }
        ......çœç•¥ä»£ç  }
    public class PollingServerListUpdater implements ServerListUpdater {
        //...... çœç•¥ä»£ç 
        public synchronized void start(final UpdateAction updateAction) {
            if (this.isActive.compareAndSet(false, true)) {
                // åˆå§‹åŒ–çº¿ç¨‹
                Runnable wrapperRunnable = new Runnable() {
                    public void run() {
                        if (!PollingServerListUpdater.this.isActive.get())
                        {
                            if (PollingServerListUpdater.this.scheduledFuâ€
                                ture != null) {
                                PollingServerListUpdater.this.scheduledFuâ€
                                ture.cancel(true);
                            }
                        } else {
                            try {
                                updateAction.doUpdate();
                                PollingServerListUpdater.this.lastUpdated 
                                = System.currentTimeMillis();
                            } catch (Exception var2) {
                                PollingServerListUpdater.logger.warn("Failed one update cycle", var2);
                            } } }
                };
                // å¯åŠ¨å®šæ—¶ä»»åŠ¡æ›´æ–° Ribbon ç¼“å­˜
                this.scheduledFuture = getRefreshExecutor().scheduleWithâ€
                FixedDelay(wrapperRunnable, this.initialDelayMs, this.refreshInterâ€
                           valMs, TimeUnit.MILLISECONDS);
            } else {
                logger.info("Already active, no-op");
            } 
        }</code></pre> 
<h3 id="s5Coh">Eurekaã€Ribbon çš„ç¼“å­˜æœºåˆ¶</h3> 
<p id="ua74a5a77"></p> 
<p id="u8586a17b">é€šè¿‡ä¸Šâ¾¯çš„åˆ†æï¼Œæˆ‘ä»¬æ‰€äº†è§£åˆ°æœ‰ä¸¤ä¸ªåœ°â½…çš„ç¼“å­˜ï¼Œâ¼€æ˜¯ Eureka å®¢æˆ·ç«¯ç¼“å­˜ï¼Œâ¼†æ˜¯ Ribbon è´Ÿ</p> 
<p id="ucb3693c4">è½½å‡è¡¡å™¨çš„ç¼“å­˜ã€‚è¿™äº›ç¼“å­˜æœºåˆ¶æ˜¯å¦éƒ½æ˜¯å¿…é¡»å­˜åœ¨çš„å‘¢ï¼Ÿå¾ˆæ˜æ˜¾ï¼Œè¿™äº›ç¼“å­˜æœºåˆ¶éƒ½æ˜¯æœ‰å­˜åœ¨çš„å¿…è¦çš„ï¼Œâ½½ä¸”æ˜¯â¾®</p> 
<p id="u56c1f6f1">å¸¸åˆç†çš„ã€‚å› ä¸ºä½ çš„æœåŠ¡çŠ¶æ€ä¸å¯èƒ½æ˜¯æ—¶æ—¶å˜åŒ–çš„ã€‚åœ¨ Eurekaã€Ribbon è¿™ä¸¤ä¸ªç»„ä»¶ä¸­è¿˜æœ‰</p> 
<p id="u8665e063">eureka-server ä¹Ÿæ˜¯æœ‰ç¼“å­˜ä¸­çš„ã€‚åŠ èµ·æ¥ä¸‰ä¸ªåœ°â½…æœ‰ç¼“å­˜ã€‚eureka-server ä¸­â½¤ guava å®šä¹‰äº† readWriteCacheMapï¼ŒreadOnlyCacheMap ä¸¤ä¸ªç¼“å­˜ã€‚å½“æˆ‘ä»¬çš„æœåŠ¡æ³¨å†Œåˆ° eureka-serverï¼ŒæœåŠ¡çš„å„ç±»å…ƒæ•°æ®ä¿¡æ¯ä¼šå…ˆå­˜å‚¨åœ¨ readWriteCacheMapï¼Œç„¶åå®šæ—¶ä»»åŠ¡æ¯éš” 30s åŒæ­¥åˆ° readOnlyCacheMap ä¸­ï¼Œæ‰€ä»¥æœåŠ¡æä¾›è€…åˆšæ³¨å†Œåˆ°æ³¨å†Œä¸­â¼¼ï¼ŒæœåŠ¡è°ƒâ½¤è€…æ˜¯æ‹‰å–ä¸åˆ°çš„ã€‚</p> 
<p id="u6f299ec7"><strong>ç»¼ä¸Šå„çº§ç¼“å­˜ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸‹å›¾â½è¾ƒç›´è§‚ï¼š </strong></p> 
<p class="img-center"><img alt="" height="968" id="u71021f17" src="https://images2.imgbox.com/8e/d7/xJJKS7a2_o.png" width="1200"></p> 
<p id="uf4b87d82">ç”±äºæœåŠ¡å¯åŠ¨çš„æ—¶å€™ï¼ŒæœåŠ¡ä¼šâ¾ƒåŠ¨æ³¨å†Œåˆ°æ³¨å†Œä¸­â¼¼ï¼Œæ‰€ä»¥åªæ˜¯åœ¨ç»­çº¦çš„æ—¶å€™ï¼ŒæœåŠ¡æä¾›è€…åˆ°æ³¨</p> 
<p id="u6bf94e84">å†Œä¸­â¼¼æ‰æœ‰ 30sã€‚</p> 
<h3 id="MYrk3">Eurekaã€Ribbon ä½¿â½¤çš„å¼Šç«¯</h3> 
<p id="u3b5f69be">é€šè¿‡ä¸Šâ½‚çš„å„ç§åˆ†æï¼Œç›¸ä¿¡â¼¤å®¶å·²ç»çŸ¥é“ä½¿â½¤ Eurekaã€Ribbon çš„é—®é¢˜æ‰€åœ¨äº†ã€‚æ­£å¼å› ä¸ºå„çº§</p> 
<p id="u709e40fc">ç¼“å­˜ï¼Œå„ç±»å®šæ—¶ä»»åŠ¡çš„å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ­£å¸¸ä½¿â½¤ Eurekaã€Ribbon çš„æ—¶å€™æ˜¯æ²¡æœ‰åŠæ³•åšåˆ° 4</p> 
<p id="u3ee14a87">ä¸ª 9 â¾¼å¯â½¤çš„ã€‚è¯•æƒ³â¼€ä¸‹ï¼Œå½“æˆ‘ä»¬â¼€ä¸ªæœåŠ¡å¯åŠ¨æä¾›ï¼ŒæœåŠ¡æ³¨å†Œåˆ° eureka-serverã€‚readWriteCacheMap åˆ° readOnlyCacheMap éœ€è¦ 30sï¼ŒreadOnlyCacheMap åˆ° eureka-client éœ€è¦ 30sï¼Œeureka-client åˆ° Ribbon éœ€è¦ 30sï¼Œæ‰€ä»¥æç«¯æƒ…å†µä¸‹ï¼Œè°ƒâ½¤â½… 90s ä¹‹åæ‰èƒ½çŸ¥é“æœåŠ¡æä¾›è€…çš„ä¿¡æ¯ã€‚ åŒç†ï¼Œå½“æˆ‘ä»¬ä¸‹çº¿â¼€ä¸ªæœåŠ¡çš„æ—¶å€™ï¼Œç”±äº readOnlyCacheMapã€eureka-clientã€Ribbon ä¸‰ä¸ª ç«¯éƒ½å­˜åœ¨ç¼“å­˜ï¼Œæ‰€ä»¥åœ¨æç«¯æƒ…å†µä¸‹ï¼Œ90s å†…ä¼šå‡ºç°æœåŠ¡æä¾›è€…çš„æ¥â¼è°ƒâ½¤å¼‚å¸¸ï¼Œå› ä¸ºå®ƒå·²ç»ä¸‹ çº¿äº†ã€‚å¦‚æœåƒå¤©çŒ«æ·˜å®è¿™ç§æµé‡çº§åˆ«â½¹ç«™ï¼Œè¿™ç§æƒ…å†µå½“ç„¶æ˜¯ä¸å¯æ¥å—çš„ã€‚</p> 
<p id="ua82c3125"></p> 
<h3 id="dK3z2">å¦‚ä½•ä½¿â½¤ RabbitMQ è§£å†³ Eurekaã€Ribbon çš„å¼Šç«¯</h3> 
<p id="u6a3acbc3"><strong>ä¸»è¦å®ç°ä¸¤ä¸ªâ½¬æ ‡ï¼š </strong></p> 
<ul><li id="u7a811c7e">æœåŠ¡å¹³æ»‘ä¸‹çº¿ï¼Œå…ˆè®©å®¢æˆ·ç«¯æ„ŸçŸ¥å³å°†è¦ä¸‹çº¿ï¼Œä¸è´Ÿè½½å‡è¡¡åˆ°å³å°†è¦ä¸‹çº¿çš„æœåŠ¡ä¸­ï¼Œç­‰ä¸‹çº¿æœåŠ¡å·²ç»è¯·æ±‚è¿›æ¥çš„æµé‡è·‘å®Œï¼Œæœ€åå¹³æ»‘ä¸‹çº¿</li><li id="uf041bb00">æœåŠ¡å¿«é€Ÿæ„ŸçŸ¥ï¼Œå½“æœåŠ¡ä¸Šçº¿åï¼ŒæœåŠ¡è°ƒâ½¤â½…å¯ä»¥å¿«é€Ÿæ„ŸçŸ¥å·²ä¸Šçº¿çš„æœåŠ¡ã€‚</li></ul> 
<p id="u330c09b2"></p> 
<p id="u2680ee89">æˆ‘ä»¬è¦å®ç°ä¸Šâ¾¯ä¸¤ä¸ªâ½¬æ ‡ï¼Œâ¾¸å…ˆæ˜¯è¦æƒ³åŠæ³•â¼²æ‰å„ç§ç¼“å­˜æœºåˆ¶ã€‚â¼²æ‰ç¼“å­˜æ“ä½œåŠæ³•ä¹Ÿå¾ˆç®€å•ã€‚</p> 
<p id="u5db22989">ç¬¬â¼€ï¼Œä½¿â½¤åœ¨ eureka-server ä½¿â½¤ä¸‹â¾¯ä¸¤ä¸ªé…ç½®ï¼š</p> 
<pre id="GM2ut"><code class="language-java"># ç¦â½¤ä¿æŠ¤æ¨¡å¼
eureka.server.enable-self-preservation=false
# ç¦â½¤ readOnlyCacheMap
eureka.server.use-read-only-response-cache=false</code></pre> 
<p id="uae02e69d">ç¬¬â¼†ï¼Œeureka-client ç«¯ä½¿â½¤ EurekaNotificationServerListUpdater â½…å¼åŒæ­¥å¯â½¤æœåŠ¡åˆ—è¡¨æ›´æ–°</p> 
<p id="u9da67300">åˆ° Ribbonï¼Œå³ eureka-client æ›´æ–°ç¼“å­˜çš„åŒæ—¶â»¢ä¸Š Ribbon ç¼“å­˜ã€‚</p> 
<p class="img-center"><img alt="" height="842" id="u19922e67" src="https://images2.imgbox.com/29/66/AhlA7B6D_o.png" width="1200"></p> 
<p id="u3202d026">å½“æˆ‘ä»¬åˆ†ææœåŠ¡æ³¨å†Œæ¨é€åˆ°æ³¨å†Œä¸­â¼¼çš„ com.netflix.appinfo.InstanceInfo å¯¹è±¡å‘ç°ï¼š</p> 
<pre id="X7hYD"><code class="language-java">public class InstanceInfo {
    // eureka å…è®¸æˆ‘ä»¬â¾ƒå®šä¹‰ä¸šåŠ¡çš„å…ƒæ•°æ®
    @XStreamAlias("metadata")
    private volatile Map&lt;String, String&gt; metadata;
    @Auto
    private volatile Long lastUpdatedTimestamp;
    @Auto
    private volatile Long lastDirtyTimestamp;
    @Auto
    private volatile InstanceInfo.ActionType actionType;
    @Auto
    private volatile String asgName;
    private String version;
}</code></pre> 
<p id="u48f65141"></p> 
<p id="u0f837930">InstanceInfo æä¾›äº† metadata å±æ€§ï¼Œå…è®¸æˆ‘ä»¬â¾ƒå®šä¹‰ä¸šåŠ¡å…ƒæ•°æ®æ¨åˆ°æ³¨å†Œä¸­â¼¼ã€‚åŸºäºè¿™ä¸ªï¼Œå½“æœåŠ¡ä¸‹çº¿æ—¶ï¼Œå…ˆä¿æŒæœåŠ¡çŠ¶æ€ä¸å˜ï¼Œè®¾ç½®æœåŠ¡ä¸‹çº¿çš„æ ‡å¿—å…ƒæ•°æ®æ¨é€åˆ°æ³¨å†Œä¸­â¼¼ï¼Œé€šçŸ¥æ‰€æœ‰çš„æœåŠ¡æ¶ˆè´¹è€…è¿™ä¸ªæœåŠ¡è¦ä¸‹çº¿äº†ï¼Œé‡æ–°æ‹‰å–æœåŠ¡åˆ—è¡¨çš„çŠ¶æ€ä¿¡æ¯ã€‚ è¿™ä¸ªé€šçŸ¥çš„è¿‡ç¨‹æˆ‘ä»¬éœ€è¦å€ŸåŠ©â¼€äº›æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå¦‚ RabbitMQã€RocketMQ ç­‰ç­‰ï¼Œâ¾ƒå®šä¹‰Ribbon è´Ÿè½½å‡è¡¡è§„åˆ™ï¼ŒæœåŠ¡åˆ—è¡¨â¾¥â¾¯å‰”é™¤å¸¦æœ‰ä¸‹çº¿æ ‡å¿—ä½çš„æœåŠ¡åå†åšè´Ÿè½½å‡è¡¡ã€‚æœ€å 30s åå†æ€æ‰æœåŠ¡ï¼Œâ¾„æ­¤ï¼Œè¿™ä¸ªæœåŠ¡å®ç°å¹³æ»‘ä¸‹çº¿ã€‚å½“æœåŠ¡è¦ä¸Šçº¿çš„æ—¶å€™ï¼Œç›‘å¬ Spring å®¹å™¨çš„åˆå§‹åŒ–å®Œæˆäº‹ä»¶ï¼Œåœ¨ç›‘å¬äº‹ä»¶â¾¥â¾¯åªåšâ¼€ä»¶äº‹ï¼Œå‘é€æœåŠ¡ä¸Šçº¿æ¶ˆæ¯åˆ° MQï¼ŒæœåŠ¡æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯åæ‰§â¾é‡æ–°æ‹‰å–æœåŠ¡åˆ—è¡¨çš„æ“ä½œï¼Œå®ç°æœåŠ¡å¿«é€Ÿæ„ŸçŸ¥ã€‚</p> 
<h3 id="AIxaZ">å¹³æ»‘å‘å¸ƒå®ç°çš„è®¾è®¡å®ç°åŸç†</h3> 
<p id="uea6ab32d">æ€»ä½“æ€è·¯ï¼Œåˆ©â½¤ MQ çš„åŸâ¼¦æ¶ˆæ¯â¼´æ’­ï¼Œé€šçŸ¥æ¯ä¸ªæœåŠ¡æ¶ˆè´¹è€…ï¼Œåœ¨æ­¤å‰æä¸‹ï¼Œæˆ‘ä»¬å¿…é¡»â½è¾ƒäº†è§£</p> 
<p id="u2c96d702">Eurekaã€Ribbon çš„â¼€äº›ä»£ç å®ç°ï¼Œä¸Šâ½‚å·²è·Ÿâ¼¤å®¶åˆ†æäº†ä¸ªâ¼¤æ¦‚ã€‚ç°åœ¨æ¥çœ‹ä¸‹æ€»ä½“çš„è®¾è®¡æ€è·¯å›¾</p> 
<p class="img-center"><img alt="" height="1200" id="Y1StS" src="https://images2.imgbox.com/ed/77/tZKBRK3W_o.png" width="1200"></p> 
<p class="img-center"><img alt="" height="922" id="BXLqH" src="https://images2.imgbox.com/38/b4/XJnkrdTf_o.png" width="1200"></p> 
<p class="img-center"><img alt="" height="970" id="SynZU" src="https://images2.imgbox.com/6e/56/WPoubeC4_o.png" width="1200"></p> 
<h3 id="nI7Rx">å¹³æ»‘å‘å¸ƒä»£ç å®ç°</h3> 
<p id="u7b66b1e4">æœ‰äº†ä¸Šâ¾¯çš„â½…æ³•è®ºï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä»£ç å®ç°äº†ã€‚</p> 
<h4 id="zXfio">1. ç›‘å¬æœåŠ¡å¯åŠ¨äº‹ä»¶ï¼š</h4> 
<pre id="QK0mQ"><code class="language-java">@Component
@Slf4j
public class SpringContextGcdListener implements
ApplicationListener&lt;ContextRefreshedEvent&gt; {
    private volatile AtomicBoolean isSend =new AtomicBoolean(false);
    @Autowired
    private ApplicationInfoManager applicationInfoManager;
    @Autowired
    private SksEurekaManager sksEurekaManager;
    @SneakyThrows
    @Override
    public void onApplicationEvent(ContextRefreshedEvent event) {
        try{
            if(event.getApplicationContext().getParent() instanceof
               AnnotationConfigApplicationContext) {
                //é˜²â½Œé‡å¤è§¦å‘
                if (isSend.compareAndSet(false, true)) {
                    for (int i = 0; i &lt; 10; i++) {
                        DiscoveryClient discoveryClient = 
                        SpringContextHolder.getBean(DiscoveryClient.class);
                        if (Objects.nonNull(discoveryClient)) {
                            InstanceInfo instanceInfo = applicationInâ€
                            foManager.getInfo();
                            EurekaConstant.setQueue(instanceInfo.getAppName(), instanceInfo.getHâ€
                                                    ostName(), instanceInfo.getPort());
                            ServerConsumer consumer = 
                            SpringContextHolder.getBean(ServerConsumer.class);
                            consumer.setQueueName(EurekaConstant.EUâ€
                                                  REKA_RIBBON_QUEUE);
                            consumer.start();
                            LogUtil.info(log, "SpringContextListener",
                                         "MQ æ¶ˆè´¹å¯åŠ¨ç›‘å¬");
                            ServerChangeEvent changeEvent = changeâ€
                            Event(instanceInfo, ServerStatus.UP);
                            // æ¨é€ MQ æ¶ˆæ¯
                            EurekaManager.sendMqMessage(changeEvent);
                            //LogUtil.info(log, 
                            "SpringContextListener", "queue :{}", 
                            EurekaConstant.EUREKA_RIBBON_QUEUE);
                            LogUtil.info(log, "SpringContextListener",
                                         "app start up send mq message :{}", JsonUtil.toJson(changeEvent));
                            break; }
                        Thread.sleep(1000);
                    } } } }catch (Exception e){
            LogUtil.error(log,"SpringContextListener","onApplicationâ€
                          Event:{}",e);
        } } 
}</code></pre> 
<p id="u6ed015ef"></p> 
<h4 id="LQtcN">2. MQ æ¶ˆè´¹å¤„ç†ï¼š</h4> 
<pre id="iuwg1"><code class="language-java">@Slf4j
@Component
public class ConsumerTask {
    public boolean consumer( byte[] bytes) {
        String json = new String(bytes);
        ServerChangeEvent event = JsonUtil.fromStr(json, 
                                                   ServerChangeEvent.class);
        try{
            DiscoveryClient discoveryClient = 
            SpringContextHolder.getBean(DiscoveryClient.class);
            // é‡æ–°æ‹‰å–æœåŠ¡åˆ—è¡¨
            Method refresh = 
            DiscoveryClient.class.getDeclaredMethod(EurekaConstant.REFRESH_METHOD)
            ;
            refresh.setAccessible(true);
            refresh.invoke(discoveryClient);
        }catch (Exception e){
            LogUtil.error(log,"EurekaServerConsumerTask","eureka ribâ€
                          bon refresh :{}",e);
        }
        return true; } 
}</code></pre> 
<p id="ubecfeb01"></p> 
<h4 id="kLwUA">3. â¾ƒå®šä¹‰è´Ÿè½½å‡è¡¡è§„åˆ™ï¼š</h4> 
<pre id="MCEld"><code class="language-java">@Slf4j
public class EurekaRibbonRule extends ClientConfigEnabledRoundRobinRule {
    private LoadBalancerStats loadBalancerStats;
    @Override
    public Server choose(Object key) {
        if (loadBalancerStats == null) {
            return super.choose(key);
        }
        List&lt;Server&gt; serverList = getLoadBalancer().getAllServers();
        // è¸¢æ‰è¦ä¸‹çº¿çš„æœåŠ¡
        List&lt;Server&gt; upServerList = Lists.newArrayList();
        for(Server server: serverList){
            if (server instanceof DiscoveryEnabledServer) {
                final DiscoveryEnabledServer discoveryEnabledServer = 
                (DiscoveryEnabledServer) server;
                final Map&lt;String, String&gt; metadata = discoveryEnabledâ€
                Server.getInstanceInfo().getMetadata();
                final String down = metadata.get(SERVER_STATUS_KEY);
                if (!ServerStatus.DOWN.name().equals(down)) {
                    upServerList.add(server);
                } } }
        if(upServerList.isEmpty()){
            return null; }
        //... æ ¹æ®éœ€è¦åšè´Ÿè½½è´Ÿè½½å‡è¡¡è§„åˆ™
        if (chosen == null) {
            return super.choose(key);
        } else {
            return chosen;
        } 
}</code></pre> 
<p id="uf5e6660a"></p> 
<h4 id="XAsK5">4. æœåŠ¡ä¸Šçº¿å‘é€åŸâ¼¦æ¶ˆæ¯â¼´æ’­ï¼š</h4> 
<pre id="RJXYN"><code class="language-java">private void changeServer(ServerStatus serverStatus) {
    Map&lt;String,String&gt; engMetaMap = Maps.newHashMap();
    engMetaMap.put(EurekaConstant.SERVER_STATUS_KEY, serverStaâ€
                   tus.name());
    applicationInfoManager.registerAppMetadata(engMetaMap);
    DiscoveryClient discoveryClient = 
    SpringContextHolder.getBean(DiscoveryClient.class);
    try {
        Method renew = 
        DiscoveryClient.class.getDeclaredMethod(EurekaConstant.RENEW_METHOD);
        renew.setAccessible(true);
        renew.invoke(discoveryClient);
        ServerChangeEvent event = changeEvent(applicationInfoManâ€
                                              ager.getInfo(),serverStatus);
        sendMqMessage(event);
    } catch (Exception e) {
    } 
}</code></pre> 
<p id="u6dcafd00"></p> 
<h4 id="m6G1T">5. åˆå§‹åŒ–è´Ÿè½½å‡è¡¡è§„åˆ™å’Œ Ribbon ç¼“å­˜æ›´æ–°â½…å¼ï¼š</h4> 
<p id="ue72fb2c4"></p> 
<p id="uc435c9d1">ç”± äº Ribbon ä¼š ç»™ æ¯ ä¸ª æœ åŠ¡ æ ä¾› åˆ å§‹ åŒ– å®¹ å™¨ ï¼Œ ä¸º äº† ä½¿ Ribbon å®¹ å™¨ éƒ½ åŠ  è½½ åˆ°RibbonAutoGcdConfiguration é…ç½®ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š</p> 
<pre id="qn8jT"><code class="language-java">@RibbonClients(defaultConfiguration = RibbonAutoGcdConfiguration.class)</code></pre> 
<p id="u709aa9a4"></p> 
<p id="u0e428a0b">â¾„æ­¤ï¼Œæ‰€æœ‰æ ¸â¼¼ä»£ç å®Œæ¯•ï¼Œä¸Šâ¾¯åªæ˜¯â¼€äº›æ ¸â¼¼ä»£ç ï¼Œæ ¹æ®æ€è·¯ï¼Œç›¸ä¿¡â¼¤å®¶ä¹Ÿèƒ½æå‡ºæ¥ï¼Œå¦‚æœ‰ä¸è¯¦å°½ï¼Œæ¬¢è¿â¼¤å®¶ç•™â¾”è®¨è®ºï¼Œæˆ‘å°†çŸ¥â½†ä¸â¾”ã€‚</p> 
<h3 id="GnMie">åŸºäº Eurekaã€Ribbon çš„ç°åº¦å‘å¸ƒ</h3> 
<p id="u391facb8">åœ¨ä½¿â½¤ Eurekaã€Ribbon è¦åšç°åº¦çš„è¯ï¼Œè¦åˆ©â½¤â¼€ä¸‹â½¹å…³çš„ç»„ä»¶ï¼Œç°åº¦çš„å®ç°â½…å¼æœ‰å¾ˆå¤šï¼Œæˆ‘å‘â¼€ä¸‹æˆ‘çš„æ€è·¯ï¼Œå¸Œæœ›è·Ÿâ¼¤å®¶è®¨è®ºäº¤æµâ¼€ä¸‹ã€‚</p> 
<p class="img-center"><img alt="" height="964" id="ufaffb32a" src="https://images2.imgbox.com/e0/5a/S69rHD85_o.png" width="1200"></p> 
<p>å…è´¹<a class="link-info" href="https://moreit.club" rel="nofollow" title="ITèµ„æºå°ç«™">ITèµ„æºå°ç«™</a>ï¼Œæœ€åé€ç»™å¤§å®¶ä¸€å¥—å­¦ä¹ RabbitMQçš„è¯¾ç¨‹ï¼š<a href="https://moreit.club/?p=264" rel="nofollow" title="ä¸­é—´ä»¶MQ-RabbitMQå…¥é—¨åˆ°å®æˆ˜è¯¾ç¨‹ - ITèµ„æºå°ç«™">ä¸­é—´ä»¶MQ-RabbitMQå…¥é—¨åˆ°å®æˆ˜è¯¾ç¨‹ - ITèµ„æºå°ç«™</a></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b50e085c8b0f8405ae12dcd6766049d3/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">ã€javaæ•°æ®ç»“æ„ä¹‹å…«å¤§æ’åºï¼ˆä¸Šï¼‰-ç›´æ¥æ’å…¥æ’åºï¼Œå¸Œå°”æ’åºï¼Œé€‰æ‹©æ’åºï¼Œå †æ’åºï¼Œå‘ä¸‹è°ƒæ•´(å¤§æ ¹å †ï¼Œå°æ ¹å †)ç­‰çŸ¥è¯†è¯¦è§£ã€‘</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1c5cb9a00cc9b92f1ef527b226ec2afa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">æ·±å…¥æ¢ç´¢Android Serviceï¼šåå°æœåŠ¡çš„ç»ˆææŒ‡å—ï¼ˆä¸Šï¼‰</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ç¼–ç¨‹å¤§å’–.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>