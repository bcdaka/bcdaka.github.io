<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【C语言】 —— 预处理详解（上） - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/9630a4a89ede9c3e3915d23a7b19bf37/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="【C语言】 —— 预处理详解（上）">
  <meta property="og:description" content="【C语言】 —— 预处理详解（上） 一、预定义符号二、# d e f i n e define define 定义常量（符号）三、# d e f i n e define define 定义宏四、带有副作用的宏参数五、宏替换的规则六、宏和函数的对比 一、预定义符号 C语言中设置了一些预定义符号，可以直接使用，预定义符号也就是在预处理期间处理的。
__FILE__ //进行编译的源文件 __LINE__	//文件当前的行号 __DATE__	//文件被编译日期 __TIME__	//文件被编译那一瞬的时间 __STDC__	//如果编译器遵循ANSI C（标准C），其值为1，否则未定义(报错) 举例：
#include&lt;stdio.h&gt; int main() { printf(&#34;%s\n&#34;, __FILE__); printf(&#34;%d\n&#34;, __LINE__); printf(&#34;%s\n&#34;, __DATE__); printf(&#34;%s\n&#34;, __TIME__); return 0; } 运行结果：
这里随便提一下，VS 不完全支持ANSI C（标准C）； g c c gcc gcc 支持ANSI C（标准C）
二、# d e f i n e define define 定义常量（符号） 基本语法：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-12T00:22:05+08:00">
    <meta property="article:modified_time" content="2024-07-12T00:22:05+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【C语言】 —— 预处理详解（上）</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>【C语言】 —— 预处理详解（上）</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、预定义符号</a></li><li><a href="#define__34" rel="nofollow">二、#<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
          
            d 
           
          
            e 
           
          
            f 
           
          
            i 
           
          
            n 
           
          
            e 
           
          
         
           define 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义常量（符号）</a></li><li><a href="#define__122" rel="nofollow">三、#<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
          
            d 
           
          
            e 
           
          
            f 
           
          
            i 
           
          
            n 
           
          
            e 
           
          
         
           define 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义宏</a></li><li><a href="#_211" rel="nofollow">四、带有副作用的宏参数</a></li><li><a href="#_255" rel="nofollow">五、宏替换的规则</a></li><li><a href="#_304" rel="nofollow">六、宏和函数的对比</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、预定义符号</h2> 
<p>  C语言中设置了一些<mark>预定义符号</mark>，可以直接使用，预定义符号也就是<code>在预处理期间处理的</code>。</p> 
<pre><code class="prism language-c"><span class="token constant">__FILE__</span>    <span class="token comment">//进行编译的源文件</span>
<span class="token constant">__LINE__</span>	<span class="token comment">//文件当前的行号</span>
<span class="token constant">__DATE__</span>	<span class="token comment">//文件被编译日期</span>
<span class="token constant">__TIME__</span>	<span class="token comment">//文件被编译那一瞬的时间</span>
__STDC__	<span class="token comment">//如果编译器遵循ANSI C（标准C），其值为1，否则未定义(报错)</span>
</code></pre> 
<p>  <br> <strong>举例：</strong></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__DATE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token constant">__TIME__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  <br> <strong>运行结果：</strong></p> 
<blockquote> 
 <p><img src="https://images2.imgbox.com/aa/1c/UtB4acYx_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p>  这里随便提一下，VS 不完全支持ANSI C（标准C）；<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         g 
        
       
         c 
        
       
         c 
        
       
      
        gcc 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mord mathnormal">cc</span></span></span></span></span> 支持ANSI C（标准C）<br>   </p> 
<h2><a id="define__34"></a>二、#<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         n 
        
       
         e 
        
       
      
        define 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义常量（符号）</h2> 
<p><strong>基本语法：</strong></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name">name</span> <span class="token expression">stuff</span></span>
</code></pre> 
<p><strong>举个例子：</strong></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX</span> <span class="token expression"><span class="token number">100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">reg</span> <span class="token expression"><span class="token keyword">register</span>  </span><span class="token comment">// 为 register 这个关键字创建一个简短的名字</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">do_forever</span> <span class="token expression"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span>  </span><span class="token comment">//用更形象的符号来替换一种实现</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CASE</span> <span class="token expression"><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token keyword">case</span>		</span><span class="token comment">//在写 case 语句的时候自动吧 break 写上</span></span>

<span class="token comment">//如果定义的 stuff 过长，可以分成几行写，除了最后一行外，每行的后面都加一个反斜杠(续行符)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEBUG_PRINT</span> <span class="token expression"><span class="token function">printf</span><span class="token punctuation">(</span></span><span class="token string">"file:%s\tline:%d\t \
							date:%s\ttime:%s\n"</span> <span class="token expression"><span class="token punctuation">,</span></span><span class="token punctuation">\</span>
							<span class="token expression"><span class="token constant">__FILE__</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span> <span class="token punctuation">,</span> </span><span class="token punctuation">\</span>
							<span class="token expression"><span class="token constant">__DATE__</span><span class="token punctuation">,</span><span class="token constant">__TIME__</span> <span class="token punctuation">)</span></span></span>
</code></pre> 
<blockquote> 
 <ul><li>第二句就是懒，咋地</li><li>第三句 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           f 
          
         
           o 
          
         
           r 
          
         
        
          for 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal" style="margin-right: 0.0278em;">or</span></span></span></span></span> 循环的<code>初始化、判断、调整都可以省略</code>，但是判断如果省略，则意味着判断条件恒为真，即<mark>死循环</mark></li><li>第四局最好别这么搞，很容易出事的</li><li>第五句<mark>续行符</mark>是防止分行后出现问题，其本质是<code>转义</code>后面的<code>回车符</code>，让回车不再是回车。续行符后面什么都不能有，按下 <code>“\”</code> 直接回车，否则续的就不是下面一行的代码了</li></ul> 
</blockquote> 
<p>  <br>   现在问题来了：用 #<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         n 
        
       
         e 
        
       
      
        define 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义标识符的时候，要不要在后面加上<code>；</code> ？</p> 
<p><strong>比如：</strong></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX</span> <span class="token expression"><span class="token number">1000</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX</span> <span class="token expression"><span class="token number">1000</span><span class="token punctuation">;</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> n <span class="token operator">=</span> MAX<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p><img src="https://images2.imgbox.com/99/1c/HPdsOPyf_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p>  上述代码加上<code>；</code>,好像只是有点多余，但对程序运行并没有什么影响<br>   好像加 <code>；</code> 或者不加 <code>；</code> 都可以？<br>   真的是这样的吗？<br>   <br>   我们看下面的例子：</p> 
<pre><code class="prism language-c"><span class="token comment">//例一</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//例二</span>
<span class="token keyword">int</span> <span class="token function">mian</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		max <span class="token operator">=</span> MAX<span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		max <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>替换后：</strong></p> 
<pre><code class="prism language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印<code>1000；</code>是什么意思？</p> 
<pre><code class="prism language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	max <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
	<span class="token punctuation">;</span>
<span class="token keyword">else</span>
	max <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> 
<p><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         e 
        
       
         l 
        
       
         s 
        
       
         e 
        
       
      
        else 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">se</span></span></span></span></span> 匹配谁？<br>   <br>   你看，这就出问题了吧，所以<mark>用 #<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          d 
         
        
          e 
         
        
          f 
         
        
          i 
         
        
          n 
         
        
          e 
         
        
       
         define 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义表示符的时候，后面不要加 <font color="red"><strong>；</strong></font></mark></p> 
<p>  </p> 
<h2><a id="define__122"></a>三、#<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         n 
        
       
         e 
        
       
      
        define 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义宏</h2> 
<p>  #<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         n 
        
       
         e 
        
       
      
        define 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 机制包括了一个规定，<code>允许把参数替换到文本中</code>，这种实现通常称为<mark>宏</mark><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         （ 
        
       
         m 
        
       
         a 
        
       
         r 
        
       
         c 
        
       
         o 
        
       
         ） 
        
       
      
        （marco） 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord cjk_fallback">（</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">rco</span><span class="mord cjk_fallback">）</span></span></span></span></span>或 <mark>定义宏</mark><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         （ 
        
       
         d 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         n 
        
       
         e 
        
       
         m 
        
       
         a 
        
       
         c 
        
       
         r 
        
       
         o 
        
       
         ） 
        
       
      
        （define macro） 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord cjk_fallback">（</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">cro</span><span class="mord cjk_fallback">）</span></span></span></span></span><br>   宏和上面宏定义标识符的区别就是：<mark><font color="red">宏有参数</font></mark><br>   <br>   下面是宏的声明方式：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">name</span><span class="token expression"><span class="token punctuation">(</span>parament <span class="token operator">-</span> list<span class="token punctuation">)</span> stuff</span></span>
</code></pre> 
<p>  其中的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
         a 
        
       
         r 
        
       
         a 
        
       
         m 
        
       
         e 
        
       
         n 
        
       
         t 
        
       
      
        parament 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8095em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">am</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span></span></span> - <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         i 
        
       
         s 
        
       
         t 
        
       
      
        list 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span></span></span></span></span>（参数列表）是一个由逗号隔开的符号表，他们可能出现在 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         s 
        
       
         t 
        
       
         u 
        
       
         f 
        
       
         f 
        
       
      
        stuff 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right: 0.1076em;">ff</span></span></span></span></span> 中<br>   注：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         p 
        
       
         a 
        
       
         r 
        
       
         a 
        
       
         m 
        
       
         e 
        
       
         n 
        
       
         t 
        
       
      
        parament 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8095em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">am</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span></span></span> - <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         i 
        
       
         s 
        
       
         t 
        
       
      
        list 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span></span></span></span></span>（参数列表）的<mark>左括号</mark>必须与 <mark><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          n 
         
        
          a 
         
        
          m 
         
        
          e 
         
        
       
         name 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">nam</span><span class="mord mathnormal">e</span></span></span></span></span></mark> <mark><strong>紧邻</strong></mark>，如果之间有任何空白存在，参数列表就会被解释为 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         s 
        
       
         t 
        
       
         u 
        
       
         f 
        
       
         f 
        
       
      
        stuff 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right: 0.1076em;">ff</span></span></span></span></span> 的一部分。<br>   </p> 
<p><strong>举例：</strong></p> 
<pre><code class="prism language-c"><span class="token comment">//实现一个宏，计算一个数的平方</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SQUARE</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> x<span class="token operator">*</span>x</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">SQUARE</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  <br> <strong>运行结果：</strong></p> 
<blockquote> 
 <p><img src="https://images2.imgbox.com/46/4f/cAgZ2WIp_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p>  可以看到，正确运算出 5 的平方</p> 
<p>  但其实上述代码是有问题的，请看下面代码段：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token function">SQUARE</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  <br> <strong>运行结果：</strong></p> 
<blockquote> 
 <p><img src="https://images2.imgbox.com/33/86/ApiKJcEZ_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p>  为什么会是这样呢？ 5+1 的结果是 36，而 6 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ∗ 
        
       
      
        * 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4653em;"></span><span class="mord">∗</span></span></span></span></span> 6 应该是 36 才对，11 是怎么得来的呢？</p> 
<p>  问题出现在宏上，我们知道<code>宏是直接替换</code>的，那么上述代码直接替换的结果：</p> 
<pre><code class="prism language-c"><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> a<span class="token operator">+</span><span class="token number">1</span><span class="token operator">*</span>a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>   5 + 6 + 1，结果自然是 11 了</p> 
<p>  我们在宏定义两边加上括号，这个问题就轻松解决了</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SQUARE</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></span></span>
</code></pre> 
<p>  那这么定义就毫无问题了吗？我们来看看下面这个宏定义</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DOUBLE</span><span class="token expression"><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span></span></span>
</code></pre> 
<p>  定义中我们使用了括号，想避免之前的问题，但是这个宏可能会出现新的错误。</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\n"</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token function">DOUBLE</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  <br> <strong>运行结果：</strong></p> 
<blockquote> 
 <p><img src="https://images2.imgbox.com/c7/46/8hpyUO1A_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p>  输出结果不是100 而是 55，原因和上面类似，依然是 <mark><font color="red">优先级的问题</font></mark><br>   <br> <strong>解决方法：</strong></p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DOUBLE</span><span class="token expression"><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token operator">+</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
</code></pre> 
<p>  综上，在使用宏的时候<mark>千万不要吝啬括号</mark>，以避免在使用宏是由于参数中的操作符或者邻近操作符之间不可预料的相互作用。</p> 
<p>  </p> 
<h2><a id="_211"></a>四、带有副作用的宏参数</h2> 
<p>  当宏参数在宏的定义中出现超过一次的时候，如果参数带有<mark>副作用</mark>，那么你在使用这个宏的时候就可能出现危险，导致<code>不可预测</code>的结果。副作用就是表达式求值的时候出现永久性的效果。<br>   <br> <strong>例如：</strong></p> 
<pre><code class="prism language-c">x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//不带副作用</span>
x<span class="token operator">++</span>；  <span class="token comment">//带副作用</span>
</code></pre> 
<p>  下面代码的 MAX 宏可以证明具有副作用的参数所引起的问题</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MAX</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> z <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>x<span class="token operator">++</span><span class="token punctuation">,</span> y<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"x=%d, y=%d, z=%d\n"</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  <br> <strong>运行结果：</strong></p> 
<blockquote> 
 <p><img src="https://images2.imgbox.com/52/da/zLxJlGtC_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<p>  为什么会这样呢？我们一起来分析分析</p> 
<pre><code class="prism language-c">z <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>y<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <ul><li>首先先进行判断：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           x 
          
         
        
          x 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span>++ 与 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           y 
          
         
        
          y 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span>++ 判断，因为是 后置++，判断时 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           x 
          
         
        
          x 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span> 为 5，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           y 
          
         
        
          y 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span> 为 8，8 &gt; 5</li><li>判断完后 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           x 
          
         
        
          x 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span> 为 6，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           y 
          
         
        
          y 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span> 为 9</li><li>再接着执行 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           y 
          
         
        
          y 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span> ++，因为是 后置++，返回结果 9</li><li>再接着 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           y 
          
         
        
          y 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span> 进行自增，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           y 
          
         
        
          y 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span> 最终结果为 10</li></ul> 
</blockquote> 
<p>  我们将 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         x 
        
       
      
        x 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></span> 和 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         y 
        
       
      
        y 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span> 传入宏中，出来的结果都已经改变了，特别是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         y 
        
       
      
        y 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span></span>，经过了两次改变，你说可不可怕<br>   当向宏中传递有副作用的参数，而并且参数在宏中出现了不止一次，那么该参数的副作用也不止一次<br>   </p> 
<h2><a id="_255"></a>五、宏替换的规则</h2> 
<p>在程序中扩展 #<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         n 
        
       
         e 
        
       
      
        define 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义的符号和宏时，需要涉及几个步骤</p> 
<ul><li>在调用宏时，先对<code>参数进行检查</code>，看看是否包含 #<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          d 
         
        
          e 
         
        
          f 
         
        
          i 
         
        
          n 
         
        
          e 
         
        
       
         define 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义的<code>标识符</code>。如果是，他们首先被替换</li><li>替换文本随后<code>被插入</code>到程序中原来的位置，对于宏参数名被他们的值所替换</li></ul> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MAX</span><span class="token expression"><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">:</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M</span> <span class="token expression"><span class="token number">10</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> z <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> M<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          M 
         
        
          A 
         
        
          X 
         
        
          ( 
         
        
          x 
         
        
          , 
         
        
          M 
         
        
          ) 
         
        
       
         MAX(x, M) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right: 0.0785em;">X</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span><span class="mclose">)</span></span></span></span></span> 中的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          M 
         
        
       
         M 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span></span></span></span></span> 首先被替换成 10，10 插入到原来 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          M 
         
        
       
         M 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span></span></span></span></span> 所在的位置</li><li>最后，再次对结果进行扫描，看看是否包含任何由 #<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          d 
         
        
          e 
         
        
          f 
         
        
          i 
         
        
          n 
         
        
          e 
         
        
       
         define 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义的符号，如果是，就重复上述处理了过程</li></ul> 
<p>  上述代码中 MAX 也是由 #<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         n 
        
       
         e 
        
       
      
        define 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义的<mark>宏</mark>。上一次检验中，它的参数 M 已经完成了替换，这次该替换它了<br>    <mark><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          M 
         
        
          A 
         
        
          X 
         
        
          ( 
         
        
          x 
         
        
          , 
         
        
          10 
         
        
          ) 
         
        
       
         MAX(x, 10) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right: 0.0785em;">X</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">10</span><span class="mclose">)</span></span></span></span></span></mark> 被替换成 <mark><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          ( 
         
        
          x 
         
        
          ) 
         
        
          &gt; 
         
        
          ( 
         
        
          10 
         
        
          ) 
         
        
       
         ((x) &gt; (10) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">((</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">10</span><span class="mclose">)</span></span></span></span></span> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ? 
         
        
       
         ? 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mclose">?</span></span></span></span></span> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          ( 
         
        
          x 
         
        
          ) 
         
        
          : 
         
        
          ( 
         
        
          10 
         
        
          ) 
         
        
          ) 
         
        
       
         (x):(10)) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">10</span><span class="mclose">))</span></span></span></span></span></mark><br>   <br>   当然，<code>宏里面嵌套宏</code>也是可以的</p> 
<pre><code class="prism language-c"><span class="token function">MAX</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>  这时，先将参数中的宏进行替换，再对整个宏进行替换<br>   但需要注意的是，这<code>不是递归</code>，这只是一个宏作为另一个宏的参数。<code>递归是宏内部又调用了宏本身</code>。<br>   同时，当预处理器搜索 #<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         e 
        
       
         f 
        
       
         i 
        
       
         n 
        
       
         e 
        
       
      
        define 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span> 定义的符号时，<mark>字符串常量的内容并不被搜索</mark><br>   什么意思呢？举个栗子就明白了</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">M</span> <span class="token expression"><span class="token number">10</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> z <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"M = %d"</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  上述代码中<code>printf("M = %d", x);</code>中的 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         M 
        
       
      
        M 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span></span></span></span></span> 就不被替换成 10</p> 
<p>  </p> 
<h2><a id="_304"></a>六、宏和函数的对比</h2> 
<p>  上述用宏求两个数的较大值，我们完全可以写成函数</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">Max</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> x <span class="token operator">&gt;</span> y <span class="token operator">?</span> x <span class="token operator">:</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  我们发现他们都能完成同样的功能。但就对于 “求两个数的较大值” 这个功能而言，写成宏会<code>更有优势</code>一些<br>   <br> <strong>原因有二：</strong></p> 
<blockquote> 
 <ul><li>用于<code>调用函数</code>和<code>函数返回</code>的<strong>代码</strong>可能比实际执行这个小型计算工作所花费的时间更多（调用函数时要<mark>建立栈帧</mark>）。所以宏比函数在程序的<code>规模</code>和<code>速度</code>上更胜一筹</li><li>更为重要的是<code>函数的参数必须声明类型</code>，这就导致函数只能在类型合适的表达式上使用。反之，这个宏可以适用多种类型：整形、长整形、浮点型等都可以用<br> <code>&gt;</code> 来比较。<mark>宏的参数是<font color="red">类型无关</font>的</mark>。</li></ul> 
</blockquote> 
<p>  那是不是以后都用宏呢？其实宏只使用于<mark>简单计算</mark>，不适合做那些复杂的、大的运算和函数相比宏的 <font color="red">劣势</font>：</p> 
<blockquote> 
 <ol><li>每次使用宏的时候，一份宏定义的代码将插入到程序中。除非宏比较短，否则可能会<code>大幅度增加程序的长度</code></li><li>宏是<code>没法调试</code>的</li><li>宏由于类型无关，也就<code>不够严谨</code></li><li>宏可能会带来运算优先级的问题，导致程序<code>容易出错</code></li></ol> 
</blockquote> 
<p>  但有些时候，宏可以做到函数做不到的事情<br>   <br> <strong>例如：</strong></p> 
<pre><code class="prism language-c"><span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  我们嫌这样写 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         m 
        
       
         a 
        
       
         l 
        
       
         l 
        
       
         o 
        
       
         c 
        
       
      
        malloc 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">ma</span><span class="mord mathnormal" style="margin-right: 0.0197em;">ll</span><span class="mord mathnormal">oc</span></span></span></span></span> 函数太麻烦了，我想把<code>大小</code>和<code>类型</code>传过去就能开辟空间</p> 
<pre><code class="prism language-c"><span class="token function">Malloc</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>  函数能不能做到呢？不行，因为<mark>函数是不能传递类型的</mark><br>   而宏可以做到，因为宏压根<mark>不检查</mark>你参数的<mark>类型</mark>的</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">Malloc</span><span class="token expression"><span class="token punctuation">(</span>n<span class="token punctuation">,</span> type<span class="token punctuation">)</span> <span class="token punctuation">(</span>type<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span>n <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token function">Malloc</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  <br> <strong>宏和函数的一个对比：</strong></p> 
<table><thead><tr><th align="center">属性</th><th align="left">#<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
          
            d 
           
          
            e 
           
          
            f 
           
          
            i 
           
          
            n 
           
          
            e 
           
          
         
           define 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span>定义宏</th><th align="left">函数</th></tr></thead><tbody><tr><td align="center">代码长度</td><td align="left">每次使用时，宏代码都会被插入到程序中，除了非常小的宏外，程序的长度会大幅度增长</td><td align="left">函数代码值出现于一个地方，每次使用这个函数时，都调用那个地方的同一份代码</td></tr><tr><td align="center">执行速度</td><td align="left">更快</td><td align="left">存在函数的调用和返回的额外开销（开辟栈帧），先对慢些</td></tr><tr><td align="center">操作符优先级</td><td align="left">宏参数的求值是在所有周围表达式的上下文环境里，除非加上括号，否则临近操作符的优先级可能会产生不可预料的后果，所以建议宏在书写的时候多加括号</td><td align="left">函数参数只有在函数调用的时候求值一次，它的结果值传递给函数，表达式的求值结果更容易预测</td></tr><tr><td align="center">带有副作用的参数</td><td align="left">参数可能被替换到宏中的多个位置，如果宏的参数被多次计算，带有副作用的参数求值可能会产生不可预估的结果</td><td align="left">函数参数只有在传参时调用一次，结果更容易预测</td></tr><tr><td align="center">参数类型</td><td align="left">宏的参数与类型无关，只要对参数的操作是合法的，他就可以使用于任何参数类型</td><td align="left">函数的参数是与类型有关的，如果参数的类型不同，就需要不同的函数，即使他们执行的任务是相同的</td></tr><tr><td align="center">调试</td><td align="left">宏是不方便调试的</td><td align="left">函数是可以逐句调试的</td></tr><tr><td align="center">递归</td><td align="left">宏是不能递归的</td><td align="left">函数是可以递归的</td></tr></tbody></table> 
<p>  那有没有什么办法把他们的优点结合起来呢<br>   在 C++ 中引入了<mark>内联函数 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          i 
         
        
          n 
         
        
          l 
         
        
          i 
         
        
          n 
         
        
          e 
         
        
       
         inline 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span></span></span></span></span></mark> —— 既又宏优点又有函数的优点<br>   它的执行速度和宏一样快，但效果又和函数一样<br>   </p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/39a2192930f5a673a46ec040295262eb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Emacs有什么优点，用Emacs写程序真的比IDE更方便吗?</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ce2f62d7589a0ce2cad499dcf7ffbbfc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">接口幂等性和解决方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>