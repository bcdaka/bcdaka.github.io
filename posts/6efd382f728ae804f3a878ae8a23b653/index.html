<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>vue3&#43;vite纯前端实现自动触发浏览器刷新更新版本内容，并在打包时生成版本号文件 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/6efd382f728ae804f3a878ae8a23b653/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="vue3&#43;vite纯前端实现自动触发浏览器刷新更新版本内容，并在打包时生成版本号文件">
  <meta property="og:description" content="前言 在前端项目中，有时候为了实现自动触发浏览器刷新并更新版本内容，可以采取一系列巧妙的措施。我的项目中是需要在打包时候生成一个version.js文件，用当前打包时间作为版本的唯一标识，然后打包发版 ，从实现对版本更新的监控。
因为项目使用 vite 打包的，vite又是基于rollup打包，rollup不像webpack有contentHash可以实现增量构建；而是每次打包，所有文件的hash都会更新，这样就会导致浏览器缓存的资源失效。
当用户已经打开页面，此时前端重新部署代码发版，会导致index.html未更新，而项目静态资源已经替换。当用户切换路由时，因为按需加载的原因，会继续访问旧的资源。
项目是基于 vue 3.4.21 &#43; vite 4.3.9 &#43; typescript 5.1.3 &#43; node 16.1.0 开发的。
解决思路 注入版本信息：通过vite构建打包时，注入一个版本信息的version.js 文件，文件内容是一个版本号（这里用时间戳代替）。定义监控版本函数并执行：定义一个函数并调用执行，该函数内容为生产环境下，从本地缓存中获取版本号，如果没有版本号或者和缓存中的版本号不一致，表示版本已更新。就刷新页面，然后本地存储新的版本号以便下次使用。在合适的时机（路由载入前），判断是否已经有 version.js 文件，如果有，先删除掉，再重新创建一个&lt;script&gt; 标签并赋值，值为最新版本号（时间戳）。 了解fs模块 开始之前先了解下fs模块吧，本文会使用到。
fs 通常是指 Node.js 中的 fs 模块，它是文件系统模块（File System
module）的简写。 这个模块允许你与文件系统进行交互，包括读取、写入、修改、删除文件等操作 。在 Node.js 中，fs模块是内置的核心模块之一，因此 无需额外安装即可使用。fs 模块提供了丰富的 API 来处理文件和目录，包括同步和异步的操作方式。在使用 fs 模块时，需要特别注意错误处理，因为文件操作可能会涉及到磁盘访问和系统资源，因此 处理错误非常重要。 其中的 fs.writeFile() 方法用于异步地将数据写入文件。其基本语法如下：
fs.writeFile(file, data, options, callback) 参数说明：
file（必需）：表示要写入的文件的路径（包括文件名）。
data（必需）：表示要写入文件的数据，可以是字符串或者 Buffer 对象。
options（可选）：一个对象，包含指定如何写入文件的选项。常用选项包括：encoding：指定文件的编码，默认为 ‘utf8’。 mode：指定文件的权限，默认为 0o666（可读写）。 flag：指定文件的打开行为，默认为 ‘w’（覆盖写入）。
callback（可选）：写入操作完成后的回调函数，通常以 (err)形式接收一个可能的错误参数。如果未提供回调函数，则返回一个 Promise。
使用解释：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-23T19:35:12+08:00">
    <meta property="article:modified_time" content="2024-07-23T19:35:12+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">vue3&#43;vite纯前端实现自动触发浏览器刷新更新版本内容，并在打包时生成版本号文件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_0"></a>前言</h4> 
<p>在前端项目中，有时候为了实现自动触发浏览器刷新并更新版本内容，可以采取一系列巧妙的措施。<strong><code>我的项目中是需要在打包时候生成一个</code>version.js<code>文件，用当前打包时间作为版本的唯一标识，然后打包发版</code></strong> ，从实现对版本更新的监控。</p> 
<p>因为项目使用 <code>vite</code> 打包的，vite又是基于rollup打包，rollup不像webpack有<code>contentHash</code>可以实现增量构建；而是每次打包，所有文件的hash都会更新，这样就会导致浏览器缓存的资源失效。<br> 当用户已经打开页面，此时前端重新部署代码发版，会导致index.html未更新，而项目静态资源已经替换。当用户切换路由时，因为按需加载的原因，会继续访问旧的资源。</p> 
<p>项目是基于 <code>vue 3.4.21 + vite 4.3.9 + typescript 5.1.3 + node 16.1.0</code> 开发的。</p> 
<h4><a id="_7"></a>解决思路</h4> 
<blockquote> 
 <ul><li><strong>注入版本信息</strong>：通过vite构建打包时，注入一个版本信息的version.js 文件，文件内容是一个版本号（这里用时间戳代替）。</li><li><strong>定义监控版本函数并执行</strong>：定义一个函数并调用执行，该函数内容为生产环境下，从本地缓存中获取版本号，如果没有版本号或者和缓存中的版本号不一致，表示版本已更新。就刷新页面，然后本地存储新的版本号以便下次使用。</li><li>在合适的时机（路由载入前），判断是否已经有 version.js 文件，如果有，先删除掉，再重新创建一个<code>&lt;script&gt;</code> 标签并赋值，值为最新版本号（时间戳）。</li></ul> 
</blockquote> 
<h4><a id="fs_13"></a>了解fs模块</h4> 
<p>开始之前先了解下fs模块吧，本文会使用到。</p> 
<blockquote> 
 <ul><li>fs 通常是指 Node.js 中的 fs 模块，它是文件系统模块（File System<br> module）的简写。 <strong>这个模块允许你与文件系统进行交互，包括读取、写入、修改、删除文件等操作</strong> 。在 Node.js 中，fs模块是内置的核心模块之一，因此 <strong><code>无需额外安装即可使用</code></strong>。</li><li>fs 模块提供了丰富的 API 来处理文件和目录，包括<code>同步和异步</code>的操作方式。在使用 fs 模块时，需要特别注意错误处理，因为文件操作可能会涉及到磁盘访问和系统资源，因此 <strong>处理错误非常重要</strong>。</li></ul> 
</blockquote> 
<p>其中的 <code>fs.writeFile()</code> 方法用于<code>异步</code>地将数据写入文件。其基本语法如下：</p> 
<pre><code class="prism language-typescript">fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> data<span class="token punctuation">,</span> options<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
</code></pre> 
<p>参数说明：</p> 
<blockquote> 
 <ul><li> <p>file（必需）：表示要写入的文件的路径（包括文件名）。</p> </li><li> <p>data（必需）：表示要写入文件的数据，可以是字符串或者 Buffer 对象。</p> </li><li> <p>options（可选）：一个对象，包含指定如何写入文件的选项。常用选项包括：encoding：指定文件的编码，默认为 ‘utf8’。 mode：指定文件的权限，默认为 0o666（可读写）。 flag：指定文件的打开行为，默认为 ‘w’（覆盖写入）。</p> </li><li> <p>callback（可选）：写入操作完成后的回调函数，通常以 (err)形式接收一个可能的错误参数。如果未提供回调函数，则返回一个 Promise。</p> </li></ul> 
</blockquote> 
<p>使用解释：</p> 
<blockquote> 
 <ul><li><code>fs.writeFile()</code> 方法将 data 写入到指定的 file 中。如果文件不存在，则会创建该文件；如果文件已存在，则会完全覆盖原有内容。</li><li>是异步的，意味着它会立即返回并且不会阻塞后续的代码执行；如果需要在写入文件后执行某些操作，可以使用<code>回调函数</code>或者 <code>Promise</code>。</li><li>若要进行文件写入操作，通常建议先检查是否有写入权限，并且<code>考虑错误处理</code>以确保应用程序的稳定性。</li></ul> 
</blockquote> 
<p>上面纯前端实现的做法，相对来说比较简单，实现的方式还有很多，比如自定义一个plugin插件 <a href="https://juejin.cn/post/7372463538680905740?searchId=20240723102926253FF327BFFB3788411F" rel="nofollow">vite实现前端项目打包更新通知用户更新</a><br> 使用WebSocket实时通信、前端轮询接口检测版本更新等等。感兴趣的可以继续搜资料看。</p> 
<h4><a id="_buildts__41"></a>创建 build.ts 文件</h4> 
<p>src/utils/文件夹下创建 build.ts文件</p> 
<pre><code class="prism language-javascript"><span class="token comment">// build.ts</span>
<span class="token keyword">import</span> pkg <span class="token keyword">from</span> <span class="token string">'../../package.json'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> resolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span>
<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span>

<span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">getVersion(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>

<span class="token comment">// 创建版本文件</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../dist'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/version.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>err <span class="token operator">?</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'版本文件创建成功'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>pkg<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - build successfully!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>如果上面这种node提示报错的话，可替换为下面这种</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> pkg <span class="token keyword">from</span> <span class="token string">'../../package.json'</span>
<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> fileURLToPath<span class="token punctuation">,</span> <span class="token constant">URL</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'node:url'</span>

<span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">getVersion(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>

<span class="token comment">// 创建版本文件</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">'../../dist/version.js'</span><span class="token punctuation">,</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    err <span class="token operator">?</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'版本文件创建成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">✨ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>pkg<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - build successfully!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="packagejson_npm_run_build__79"></a>在package.json文件中配置执行 npm run build 时执行的任务</h4> 
<p>在package.json的build命令上加一行执行 <code>esno ./src/utils/build.ts</code></p> 
<pre><code class="prism language-javascript"><span class="token punctuation">{<!-- --></span>
   <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"ceshi"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
   <span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"dev"</span><span class="token operator">:</span> <span class="token string">"vite --force"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"build"</span><span class="token operator">:</span> <span class="token string">"vite build &amp;&amp; esno ./src/utils/build.ts"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_versionts__91"></a>创建 version.ts 文件</h4> 
<p>src/utils/文件夹下创建 version.ts文件</p> 
<pre><code class="prism language-typescript"><span class="token keyword">import</span> Cookies <span class="token keyword">from</span> <span class="token string">'js-cookie'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ElLoading <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'element-plus'</span>

<span class="token keyword">const</span> versionKey <span class="token operator">=</span> <span class="token string">'version-id'</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getVersionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> Cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>versionKey<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">Number</span><span class="token punctuation">(</span>Cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>versionKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setVersionId</span><span class="token punctuation">(</span>version<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> Cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>versionKey<span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">removeVersionId</span><span class="token punctuation">(</span>version<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Cookies<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>versionKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">handleVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        window<span class="token punctuation">.</span><span class="token function-variable function">getVersion</span> <span class="token operator">=</span> <span class="token punctuation">(</span>version<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getVersionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">getVersionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> version <span class="token operator">*</span> <span class="token number">1</span> <span class="token operator">!==</span> <span class="token function">getVersionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ElLoading<span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 启动全屏ElLoading</span>
                location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 刷新页面</span>
            <span class="token punctuation">}</span>
            <span class="token function">setVersionId</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span> <span class="token comment">// 保存 以便下次使用判断</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">insertVersionFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> scriptCollection <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
        <span class="token comment">// 判断是否已经有version.js 文件，如果有，先删掉资源引入</span>
        <span class="token comment">// const scriptAry =[...scriptCollection] // ie不支持这种写法（HTMLCollection 不是数组）</span>
        <span class="token keyword">const</span> scriptAry <span class="token operator">=</span> <span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>scriptCollection<span class="token punctuation">)</span>
        scriptAry<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> flag <span class="token operator">=</span> v<span class="token punctuation">.</span>src<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'version.js'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                v<span class="token punctuation">.</span>parentNode<span class="token operator">?.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> flag
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">const</span> versionScript <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
        versionScript<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token keyword">import</span><span class="token punctuation">.</span>meta<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VITE_BASE_PATH</span> <span class="token operator">+</span> <span class="token string">'version.js?v='</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">//document.getElementsByTagName('script')表示返回当前页面中所有 &lt;script&gt; 元素的集合</span>
        <span class="token keyword">const</span> s <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  
        s<span class="token punctuation">.</span>parentNode<span class="token operator">?.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>versionScript<span class="token punctuation">,</span> s<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">handleVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="router_indexts__147"></a>router =》index.ts 中在前置路由，插入并且检查版本号</h4> 
<p>在路由跳转时进行实时的版本检测，本质就是在路由拦截器去做这个操作。</p> 
<pre><code class="prism language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> insertVersionFile <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'/@/utils/version'</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    history<span class="token operator">:</span> <span class="token function">createWebHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    routes<span class="token operator">:</span> staticRoutes<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 插入并且检查版本号</span>
    <span class="token function">insertVersionFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    NProgress<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> showSpinner<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    NProgress<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>existLoading<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        loading<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        window<span class="token punctuation">.</span>existLoading <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
<span class="token keyword">export</span> <span class="token keyword">default</span> router
</code></pre> 
<blockquote> 
 <ul><li>具体来说，在路由的全局前置守卫中进行版本检查，当触发路由跳转时，先执行版本检查的操作。</li><li>如果是生产环境，判断是否已经有 <code>version.js</code> 文件，如果有，先删掉资源引入；然后创建一个<code>&lt;script&gt;</code>标签，并设置 src 值；页面中当前第一个 <code>&lt;script&gt;</code> 元素之前插入一个新的 <code>&lt;script&gt;</code>，从而加载并执行。</li><li>通过这样的方式，能够及时地发现版本更新并实现页面的自动更新，提升用户体验和项目的维护便利性。</li></ul> 
</blockquote> 
<h4><a id="_177"></a>最终</h4> 
<p>执行 <code>npm run build</code> 命令行打包项目，最终dist文件夹里多了一个文件 <code>version.js</code>。<br> 此时版本号文件就生成了，并且每次打包后这个文件的内容都不一样。</p> 
<p><img src="https://images2.imgbox.com/0b/be/1nXDz4gR_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/be/1f/LlPQL9EO_o.png" alt="在这里插入图片描述"></p> 
<p>最后 f12 查看 dom 结构，我们每次进入路由版本号因为是时间戳，所以都会更新。</p> 
<p><img src="https://images2.imgbox.com/b2/c0/WGWMsf7L_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_187"></a>注意事项</h4> 
<h5><a id="1__188"></a>1） 报错</h5> 
<p><code>import pkg from '../../package.json'</code> 时候，可能会有标红提示报错<code>找不到模块“../../package.json”。请考虑使用 "--resolveJsonModule" 导入带 ".json" 扩展的模块</code>；</p> 
<p>通常是因为在当前的 <code>Node.js</code> 环境中，默认不支持直接导入 <code>.json</code> 文件作为模块。如果在 TypeScript 项目中使用 <code>import</code> 导入 <code>.json</code> 文件，需要在 <code>tsconfig.json</code> 文件中启用 <code>resolveJsonModule</code> 选项，通过设置 “resolveJsonModule”: true，TypeScript 将会允许导入 .json 文件。</p> 
<pre><code class="prism language-javascript"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"resolveJsonModule"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string-property property">"esModuleInterop"</span><span class="token operator">:</span> <span class="token boolean">true</span>  <span class="token comment">// 如果需要的话，也需要启用这个选项</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="2_windowgetVersion_201"></a>2） window.getVersion</h5> 
<p>这是自定义的函数并将其绑定到 window 对象上，需要在项目中新建 types文件夹，新增一个<code>global.d.ts</code> 文件，写入下面代码，才不会标红提示。</p> 
<pre><code class="prism language-typescript"><span class="token keyword">interface</span> <span class="token class-name">Window</span> <span class="token punctuation">{<!-- --></span>
    getVersion<span class="token operator">:</span> <span class="token builtin">Function</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>另外，如果我们想全局定义一个type类型，可直接在这个文件中定义，就可以全局使用该类型了，比如下面代码，</p> 
<pre><code class="prism language-typescript"><span class="token comment">// 在 TypeScript 中非常有用，特别是当需要处理结构不固定、属性名称和类型不确定的对象时,对象里可以是任意类型，不受属性类型的严格限制</span>
<span class="token keyword">interface</span> <span class="token class-name">anyObj</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可参考：<br> <a href="https://juejin.cn/post/7257048132063182904?from=search-suggest" rel="nofollow">纯前端实现监控版本更新</a><br> <a href="https://juejin.cn/post/7372463538680905740?searchId=20240723102926253FF327BFFB3788411F" rel="nofollow">vite实现前端项目打包更新通知用户更新</a><br> <a href="https://juejin.cn/post/7343811223207624745" rel="nofollow">前端打包同时版本号自增</a><br> <a href="https://juejin.cn/post/7244451945104146492?from=search-suggest" rel="nofollow">如何优雅的实现前端版本投产自动触发浏览器刷新更新版本内容</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/beb415ffd4d8f9eee5f49add224b5b8b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ES中聚合查询之date_histogram查询出现key_as_string 和 key含义</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/640c31932bcf8ac933ba92f174399b2e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Sentinel限流规则详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>