<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>大数据处理（选修）实验课：实验二 Spark Streaming实验 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/9717d2b549b1980b715ccc991117b6a2/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="大数据处理（选修）实验课：实验二 Spark Streaming实验">
  <meta property="og:description" content="1. 创建code源文件的文件夹 终端中输入如下命令
cd /usr/local/spark/mycode	mkdir streaming cd streaming mkdir -p src/main/scala cd src/main/scala 注意：这一步需要提前创建mycode文件夹，否则如果直接全文复制之后回车会导致后面的指令全部无效！
2. 编写WordCount的scala代码 用vim打开一个scala文件：
vim TestStructuredStreaming.scala 在该文件输入以下内容:
import org.apache.spark.sql.functions._ import org.apache.spark.sql.SparkSession object WordCountStructuredStreaming{ def main(args: Array[String]){ val spark = SparkSession.builder.appName(&#34;StructuredNetworkWordCount&#34;). getOrCreate() import spark.implicits._ val lines = spark.readStream.format(&#34;socket&#34;).option(&#34;host&#34;,&#34;localhost&#34;). option(&#34;port&#34;,9999).load() val words = lines.as[String].flatMap(_.split(&#34; &#34;)) val wordCounts = words.groupBy(&#34;value&#34;).count() val query = wordCounts.writeStream.outputMode(&#34;complete&#34;). format(&#34;console&#34;).start() query.awaitTermination() } } 以上是WordCount的scala代码，阅读代码可以知道这里用的端口是9999，记住它，后面要用。
3. 安装sbt sbt是用来打包scala的工具。由于前文并没有讲解sbt 的用法（甚至没教怎么安装orz，感觉是任务书被阉割导致的，实验一的spark安装中包含了这一部分，但很容易被忽略），先补充一下sbt的配置步骤（参考了大数据原理与应用 第十六章 Spark 学习指南 (xmu.edu.cn)）
官网下载地址：Download | sbt (scala-sbt.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-05T10:25:57+08:00">
    <meta property="article:modified_time" content="2024-06-05T10:25:57+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">大数据处理（选修）实验课：实验二 Spark Streaming实验</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="1_code_2"></a>1. 创建code源文件的文件夹</h5> 
<p>   终端中输入如下命令</p> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr/local/spark/mycode		
mkdir streaming
cd streaming
mkdir <span class="token operator">-</span>p src/main/scala
cd src/main/scala
</code></pre> 
<p>  注意：这一步需要提前创建mycode文件夹，否则如果直接全文复制之后回车会导致后面的指令全部无效！</p> 
<h5><a id="2_WordCountscala_16"></a>2. <strong>编写WordCount的scala代码</strong></h5> 
<p>  用vim打开一个scala文件：</p> 
<pre><code class="prism language-powershell">vim TestStructuredStreaming<span class="token punctuation">.</span>scala
</code></pre> 
<p>  在该文件输入以下内容:</p> 
<pre><code class="prism language-scala"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span>_
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>SparkSession

<span class="token keyword">object</span> WordCountStructuredStreaming<span class="token punctuation">{<!-- --></span>
 <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
     <span class="token keyword">val</span> spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token string">"StructuredNetworkWordCount"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">import</span> <span class="token namespace">spark<span class="token punctuation">.</span>implicits<span class="token punctuation">.</span></span>_
     <span class="token keyword">val</span> lines <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream<span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span><span class="token string">"localhost"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> option<span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">val</span> words <span class="token operator">=</span> lines<span class="token punctuation">.</span>as<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">.</span>flatMap<span class="token punctuation">(</span>_<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token keyword">val</span> wordCounts <span class="token operator">=</span> words<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">val</span> query <span class="token operator">=</span> wordCounts<span class="token punctuation">.</span>writeStream<span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span><span class="token string">"complete"</span><span class="token punctuation">)</span><span class="token punctuation">.</span> format<span class="token punctuation">(</span><span class="token string">"console"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
     query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>  以上是WordCount的scala代码，阅读代码可以知道这里用的端口是9999，记住它，后面要用。</p> 
<h5><a id="3_sbt_46"></a>3. <strong>安装sbt</strong></h5> 
<p>  sbt是用来打包scala的工具。由于前文并没有讲解sbt 的用法（甚至没教怎么安装orz，感觉是任务书被阉割导致的，实验一的spark安装中包含了这一部分，但很容易被忽略），先补充一下sbt的配置步骤（参考了<a href="https://dblab.xmu.edu.cn/blog/804/" rel="nofollow">大数据原理与应用 第十六章 Spark 学习指南 (xmu.edu.cn)</a>）</p> 
<ul><li> <p>官网下载地址：<a href="https://www.scala-sbt.org/download/" rel="nofollow">Download | sbt (scala-sbt.org)</a> 我在这里下载了1.10的tgz版本，方便在linux中解压和安装。</p> </li><li> <p>下载完成之后，将压缩包解压。利用以下指令直接解压到/usr/local/文件夹中（这样做的前提是命令行在压缩包所在的文件夹处）：</p> <pre><code class="prism language-powershell">tar <span class="token operator">-</span>zxvf sbt-1<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>tgz <span class="token operator">-</span>C <span class="token operator">/</span>usr/local    <span class="token comment"># 解压到/usr/local中</span>
</code></pre> </li><li> <p>在 /usr/local/sbt 中创建 sbt 脚本（<code>vim ./sbt</code>），添加如下内容（记得路径要改成自己的路径）：</p> <pre><code class="prism language-powershell"><span class="token comment">#!/bin/bash</span>
SBT_OPTS=<span class="token string">"-Xms512M -Xmx1536M -Xss1M -XX:+CMSClassUnloadingEnabled -XX:MaxPermSize=256M"</span>
java <span class="token variable">$SBT_OPTS</span> <span class="token operator">-</span>jar <span class="token operator">/</span>usr/local/sbt/bin/sbt-launch<span class="token punctuation">.</span>jar <span class="token string">"$@"</span>
</code></pre> </li><li> <p>保存退出后，为./bat文件增加读写权限（注意在对应目录下完成该步骤）：</p> <pre><code class="prism language-powershell">chmod u+x <span class="token punctuation">.</span><span class="token operator">/</span>sbt
</code></pre> </li><li> <p>最后运行如下命令，检查sbt是否可用：</p> <pre><code class="prism language-powershell"><span class="token punctuation">.</span><span class="token operator">/</span>sbt sbtVersion
</code></pre> <p>若结果如下，则可用。</p> </li></ul> 
<p><img src="https://images2.imgbox.com/6f/8b/Ev1sMVkr_o.png" alt="sbt_version"></p> 
<h5><a id="4_bat_83"></a>4. <strong>创建bat文件，编辑编译相关内容</strong></h5> 
<ul><li> <p>在/usr/lcoal/spark/mycode/streaming目录下创建simple.sbt文件：</p> <pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr/local/spark/mycode/streaming
vim simple<span class="token punctuation">.</span>sbt
</code></pre> </li><li> <p>输入以下内容：</p> <pre><code class="prism language-powershell">name := <span class="token string">"Simple Project"</span>
version := <span class="token string">"1.0"</span>
scalaVersion := <span class="token string">"2.12.17"</span>
libraryDependencies <span class="token operator">+=</span> <span class="token string">"org.apache.spark"</span> <span class="token operator">%</span><span class="token operator">%</span> <span class="token string">"spark-sql"</span> <span class="token operator">%</span> <span class="token string">"3.4.3"</span>
</code></pre> </li></ul> 
<p>  注意，这里需要指定scala和spark的版本，这是需要和你安装的版本统一的。在上面的配置信息中，scalaVersion用来指定scala的版本，sparkcore用来指定spark的版本，这两个版本信息都可以在之前的启动 Spark shell 的过程中，从屏幕的显示信息中找到。示例如下：</p> 
<p><img src="https://images2.imgbox.com/39/fd/ayyMVC8v_o.png" alt="spark&amp;scala_version"></p> 
<ul><li> <p>执行sbt打包编译:</p> <pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr/local/spark/mycode/streaming
<span class="token operator">/</span>usr/local/sbt/sbt package
</code></pre> </li></ul> 
<p>  如果打包编译成功，会显示如下信息：</p> 
<p><img src="https://images2.imgbox.com/6f/8e/2WsSIyJ7_o.png" alt="package_sucess"></p> 
<h5><a id="5__118"></a>5. 启动程序</h5> 
<ul><li><strong>启动程序的shell指令</strong>（这里也有要注意的，不要直接跟着任务书抄，这里的文件目录和名称是和scala版本有关系的，需要检查你的文件的具体情况）：</li></ul> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>usr/local/spark/mycode/streaming
<span class="token operator">/</span>usr/local/spark/bin/spark-submit <span class="token operator">--</span><span class="token keyword">class</span> <span class="token string">"WordCountStructuredStreaming"</span> <span class="token punctuation">.</span><span class="token operator">/</span>target/scala-2<span class="token punctuation">.</span>12/simple-project_2<span class="token punctuation">.</span>12-1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>jar
</code></pre> 
<p>​ 然而如果直接这样执行，会发现出现报错后直接退出。报错信息大致如下：</p> 
<p><img src="https://images2.imgbox.com/98/60/TvJbzLqP_o.png" alt="error_localhost"></p> 
<p>  这是因为没有启动端口。还记得前文要记住的9999端口吗？现在它有用了。你需要在另外一个命令行（终端）窗口执行下面的指令：</p> 
<pre><code class="prism language-powershell"> nc <span class="token operator">-</span>lk 9999
</code></pre> 
<p>  通过这条指令，你成功启动了9999号端口，也就可以在终端输入相关的信息让你的程序来读取和实现功能了。两个终端都不要关闭，接下来回到streaming目录的终端，重新执行启动程序的shell指令：</p> 
<pre><code class="prism language-powershell"><span class="token operator">/</span>usr/local/spark/bin/spark-submit <span class="token operator">--</span><span class="token keyword">class</span> <span class="token string">"WordCountStructuredStreaming"</span> <span class="token punctuation">.</span><span class="token operator">/</span>target/scala-2<span class="token punctuation">.</span>12/simple-project_2<span class="token punctuation">.</span>12-1<span class="token punctuation">.</span>0<span class="token punctuation">.</span>jar &gt;out<span class="token punctuation">.</span>txt
</code></pre> 
<p>  “&gt;out.txt"是为了将输出单独放到out.txt文件夹中，方便查看。执行完这条指令后等待命令行的输出显示不再更新，切换到9999端口的终端输入你想检测的内容（以任务书中的”hello world, hello Beijing, hello world“为例），等再一次命令行输出显示不再更新，程序就进行完成了，输出的结果就可以在out.txt中查看了。终端输入待检测内容可以重复进行，直到按下Ctrl+C结束程序。示例输出如下：</p> 
<p><img src="https://images2.imgbox.com/da/e0/nDMwqK1U_o.png" alt="在这里插入图片描述"><br>   至此，实验二完成:)</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b6dea16087ba4201aadd64c3ff968e54/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java 还能不能继续搞了？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/25afe6fd47c87602249b07535ee0fb69/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据仓库与数据挖掘总复习练习2-3（实验六 2024.6.5）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>