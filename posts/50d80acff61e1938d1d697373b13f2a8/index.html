<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot中整合ONLYOFFICE在线编辑 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/50d80acff61e1938d1d697373b13f2a8/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="SpringBoot中整合ONLYOFFICE在线编辑">
  <meta property="og:description" content="SpringBoot整合OnlyOffice SpringBoot整合OnlyOffice实现在线编辑1. 搭建私有的OnlyOffice的服务2. SpringBoot进行交互2.1 环境2.2 我们的流程2.3 接口规划2.3.1 获取编辑器配置的接口2.3.2 文件下载地址2.3.3 文件下载地址 3. 总结4. 注意4.1 你的项目的地址一定一定要和onlyoffice可以正常通讯，如果不行则一直不可能成功。4.2 TOKEN是可以可选项，建议一开始不要使用，后面有需要的时候再去添加。4.3 一定要看一下官网文档，文档真的很全很重要4.4 协同的话只要参数就是一个KEY，如果需要超过20个的限制直接重新编译即可，大神一大堆，很容易就可以找到。 SpringBoot整合OnlyOffice实现在线编辑 公司有一个需求，就是实现 *Word* , *Excel* ,等文件的在线编辑，市场上面进行了多方面的选型，考虑了 *[OpenOffice](https://openoffice.apache.org/)* , *[Office Online](https://www.microsoft.com/zh-cn/microsoft-365/free-office-online-for-the-web?legRedir=true&amp;CorrelationId=13c8a865-b9b0-48ff-b3ed-3ea9ec31cd55)*, 但是最终还是选择了 *[OnlyOffice](https://www.onlyoffice.com/zh/)* 这个产品。 他的一个很大的优势在于开源，支持协同，社区比较活跃。api比较全面，还有中文的文档。还有一点比较好的就是支持协同，并且支持协同，虽然协同在社区版中存在限制，但是支持代码修改，可以重新编译。社区的大佬很多，很赞。唯一遗憾的就是效率比较低，在使用私有对象存储的时候存在延迟。其他的没有使用到，所以不进行评论。中文文档：[https://api.onlyoffice.com/zh/editors/basic](https://api.onlyoffice.com/zh/editors/basic) 1. 搭建私有的OnlyOffice的服务 搭建过程这里就不进行涉猎了，建议使用docker进行搭建，下载官方镜像包即可,（现在dockerhub被墙，自行解决，不建议自己再次打包，因为我在尝试的时候总是出现莫名奇妙的问题可能是我的问题。推荐使用官网原版镜像）。根据官方文档一步步操作即可。搭建过程中，如果是自己玩建议不要开启 **JWT** ，生产环境建议开一下。但是开的成本就是你对接的时候需要获取token然后在进行交互。 2. SpringBoot进行交互 2.1 环境 java： 17
boot: 3.0.5
页面：一个h5页面即可
需要的其他依赖
&lt;!-- ... 其他的依赖自行添加即可，不重要，比如 fastjson2,jackson 等 --&gt; &lt;!-- 这个JAR 主要的作用是与OnlyOffice交互的时候生成token使用的 --&gt; &lt;dependency&gt; &lt;groupId&gt;com.inversoft&lt;/groupId&gt; &lt;artifactId&gt;prime-jwt&lt;/artifactId&gt; &lt;version&gt;1.3.1&lt;/version&gt; &lt;/dependency&gt; 2.2 我们的流程 我们使用一个 H5 页面即可，页面通过加载一个 app.js 。然后通过一个 config 进行渲染，就可以实现一个编辑。app.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-01T19:50:41+08:00">
    <meta property="article:modified_time" content="2024-07-01T19:50:41+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot中整合ONLYOFFICE在线编辑</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>SpringBoot整合OnlyOffice</h4> 
 <ul><li><a href="#SpringBootOnlyOffice_1" rel="nofollow">SpringBoot整合OnlyOffice实现在线编辑</a></li><li><ul><li><a href="#1_OnlyOffice_5" rel="nofollow">1. 搭建私有的OnlyOffice的服务</a></li><li><a href="#2_SpringBoot_8" rel="nofollow">2. SpringBoot进行交互</a></li><li><ul><li><a href="#21__9" rel="nofollow">2.1 环境</a></li><li><a href="#22__27" rel="nofollow">2.2 我们的流程</a></li><li><a href="#23__38" rel="nofollow">2.3 接口规划</a></li><li><ul><li><a href="#231__46" rel="nofollow">2.3.1 获取编辑器配置的接口</a></li><li><a href="#232__149" rel="nofollow">2.3.2 文件下载地址</a></li><li><a href="#233__183" rel="nofollow">2.3.3 文件下载地址</a></li></ul> 
   </li></ul> 
   </li><li><a href="#3__266" rel="nofollow">3. 总结</a></li><li><ul><li><a href="#4__271" rel="nofollow">4. 注意</a></li><li><ul><li><a href="#41_onlyoffice_272" rel="nofollow">4.1 你的项目的地址一定一定要和onlyoffice可以正常通讯，如果不行则一直不可能成功。</a></li><li><a href="#42_TOKEN_273" rel="nofollow">4.2 TOKEN是可以可选项，建议一开始不要使用，后面有需要的时候再去添加。</a></li><li><a href="#43__274" rel="nofollow">4.3 一定要看一下官网文档，文档真的很全很重要</a></li><li><a href="#44_KEY20_275" rel="nofollow">4.4 协同的话只要参数就是一个KEY，如果需要超过20个的限制直接重新编译即可，大神一大堆，很容易就可以找到。</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="SpringBootOnlyOffice_1"></a>SpringBoot整合OnlyOffice实现在线编辑</h2> 
<pre><code>公司有一个需求，就是实现 *Word* , *Excel* ,等文件的在线编辑，市场上面进行了多方面的选型，考虑了 *[OpenOffice](https://openoffice.apache.org/)* , *[Office Online](https://www.microsoft.com/zh-cn/microsoft-365/free-office-online-for-the-web?legRedir=true&amp;CorrelationId=13c8a865-b9b0-48ff-b3ed-3ea9ec31cd55)*, 但是最终还是选择了 *[OnlyOffice](https://www.onlyoffice.com/zh/)* 这个产品。
他的一个很大的优势在于开源，支持协同，社区比较活跃。api比较全面，还有中文的文档。还有一点比较好的就是支持协同，并且支持协同，虽然协同在社区版中存在限制，但是支持代码修改，可以重新编译。社区的大佬很多，很赞。唯一遗憾的就是效率比较低，在使用私有对象存储的时候存在延迟。其他的没有使用到，所以不进行评论。中文文档：[https://api.onlyoffice.com/zh/editors/basic](https://api.onlyoffice.com/zh/editors/basic)
</code></pre> 
<h3><a id="1_OnlyOffice_5"></a>1. 搭建私有的OnlyOffice的服务</h3> 
<pre><code>搭建过程这里就不进行涉猎了，建议使用docker进行搭建，下载官方镜像包即可,（现在dockerhub被墙，自行解决，不建议自己再次打包，因为我在尝试的时候总是出现莫名奇妙的问题可能是我的问题。推荐使用官网原版镜像）。根据官方文档一步步操作即可。搭建过程中，如果是自己玩建议不要开启 **JWT** ，生产环境建议开一下。但是开的成本就是你对接的时候需要获取token然后在进行交互。
</code></pre> 
<h3><a id="2_SpringBoot_8"></a>2. SpringBoot进行交互</h3> 
<h4><a id="21__9"></a>2.1 环境</h4> 
<p>java： 17<br> boot: 3.0.5<br> 页面：一个h5页面即可<br> 需要的其他依赖</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!-- ... 其他的依赖自行添加即可，不重要，比如 fastjson2,jackson 等 --&gt;</span>

<span class="token comment">&lt;!-- 这个JAR 主要的作用是与OnlyOffice交互的时候生成token使用的 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.inversoft<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>prime-jwt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        
</code></pre> 
<h4><a id="22__27"></a>2.2 我们的流程</h4> 
<blockquote> 
 <p>我们使用一个 H5 页面即可，页面通过加载一个 app.js 。然后通过一个 config 进行渲染，就可以实现一个编辑。app.js 是核心js文件</p> 
 <ol><li>only office 我只使用他的一个编辑的功能（这是一个核心，就是编辑文件，文件的来源和存储与它无关）</li><li>被编辑的文件从哪里获取？从 config 对象中的配置获取，这里就需要自行实现。</li><li>编辑后的文件如何获取？config对象中有一个回调地址，这个地址会给到服务器一个编辑的状态，并且携带一个获取编辑后文件的url(这个url就是only office 服务中的一个文件下载地址)，根据这个url来获取编辑后的文件。然后在对这个文件进行存储。<br> 回调的实现参考：<a href="https://api.onlyoffice.com/zh/editors/callback#status" rel="nofollow">https://api.onlyoffice.com/zh/editors/callback#status</a></li></ol> 
</blockquote> 
<p><img src="https://images2.imgbox.com/39/3b/sthdxv9m_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="23__38"></a>2.3 接口规划</h4> 
<blockquote> 
 <p>一共设计三个接口，</p> 
 <ol><li>获取编辑器的配置</li><li>获取需要编辑的文件流</li><li>编辑后保存文件的回调<br> 保存后的文件：注意，这里编辑后的文件并不是在回调里面以流的形式给，而是在回调接口里面给服务器一个状态，根据状态去获取一个下载编辑后文件的一个地址，然后根据地址去主动的获取文件。</li></ol> 
</blockquote> 
<h5><a id="231__46"></a>2.3.1 获取编辑器配置的接口</h5> 
<pre><code class="prism language-java">
<span class="token comment">/**
 * 被编辑文件的下载连接
 * 这里就是自己服务的配置地址
 * only office 调用你的服务的地址，一定是 onlyoffice服务可以ping通的你的项目地址。ping不通=白搭
 */</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${only.office.downUrl}"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> downFileUrl <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 这里是回调地址：例如 http://192.168.0.10:8080/office/edit/callback/{fileId}
 * 自行定义即可（就是后面自己编写的接口，但是一定要通可onlyoffice服务互通）
 * only office 调用你的服务的地址，一定是 onlyoffice服务可以ping通的你的项目地址。ping不通=白搭
 */</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${only.office.callBackUrl}"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> editCallBackUrl <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">"根据文件的ID来获取在线编辑的配置和token"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/token/{fileId}"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Parameters</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"fileId"</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">"不是对象ID是文件的ID"</span><span class="token punctuation">,</span> in <span class="token operator">=</span> <span class="token class-name">ParameterIn</span><span class="token punctuation">.</span><span class="token constant">PATH</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResultVo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> fileId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> fileKey <span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>redisUtil<span class="token punctuation">.</span><span class="token function">hHasKey</span><span class="token punctuation">(</span><span class="token class-name">RedisName</span><span class="token punctuation">.</span><span class="token constant">ONLY_OFFICE_FILE_KYE</span><span class="token punctuation">,</span>fileId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        fileKey <span class="token operator">=</span> redisUtil<span class="token punctuation">.</span><span class="token function">hget</span><span class="token punctuation">(</span><span class="token class-name">RedisName</span><span class="token punctuation">.</span><span class="token constant">ONLY_OFFICE_FILE_KYE</span><span class="token punctuation">,</span>fileId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//return ResultVo.error(CustomExceptionType.ONLY_OFFICE_COORDINATION_ERROR);</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        fileKey <span class="token operator">=</span> fileId <span class="token operator">+</span> <span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomNumbers</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
            {
                "document": {
                        "title": "%s",
                        "key": "%s",
                        "fileType":"%s",
                        "lang": "zh-CN",
                        "permissions": {
                            "comment": true,
                            "commentGroups": {
                                "edit": ["Group2", "Group1"],
                                "remove": [""],
                                "view": ""
                            },
                            "copy": true,
                            "deleteCommentAuthorOnly": false,
                            "download": true,
                            "edit": true,
                            "editCommentAuthorOnly": false,
                            "fillForms": true,
                            "modifyContentControl": true,
                            "modifyFilter": true,
                            "print": true,
                            "review": true,
                            "reviewGroups": ["Group1", "Group2", ""]
                        },
                        "url": "%s"
                    },
                "editorConfig": {
                    "customization":{
                        "autosave": true,
                        "forcesave": true
                    }
                    "lang": "zh-CN",
                    "callbackUrl": "%s",
                    "onEditing": {
                         "mode": "fast",
                         "change": true
                    },
                    "mode": "edit",
                    "user": {
                        "group": "Group1",
                        "id": "%s",
                        "name": "%s"
                    }
                }
            }
            """</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO 这里文件的key可以通过redis进行保存，这样可以支持多人在线协同，现在不做处理</span>

    json <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> fileInfo<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            fileKey<span class="token punctuation">,</span>
            <span class="token comment">// TODO 这里是文件类型，自行定义</span>
            <span class="token char">'xlsx'</span><span class="token punctuation">,</span>
            <span class="token comment">// TODO 这里是文件下载地址，fileId 为文件的唯一标识，自行定义</span>
            downFileUrl <span class="token operator">+</span> fileId<span class="token punctuation">,</span> 
            <span class="token comment">// TODO 这里是定义回调地址，fileId 为文件的唯一标识用来区分是那个文件编辑的回调。</span>
            editCallBackUrl <span class="token operator">+</span> fileId<span class="token punctuation">,</span>
            <span class="token string">"userid"</span><span class="token punctuation">,</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeToken</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO 这里是获取onlyoffice 交互的token,自己写的建议直接注释</span>
    <span class="token comment">// String token = jwtManager.createToken(map);</span>
    <span class="token comment">// map.put("token", token);</span>
    <span class="token comment">// TODO 这个key可以直接注释，这里主要作用是协同</span>
    redisUtil<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token class-name">RedisName</span><span class="token punctuation">.</span><span class="token constant">ONLY_OFFICE_FILE_KYE</span><span class="token punctuation">,</span>fileId<span class="token punctuation">,</span>fileKey<span class="token punctuation">,</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    

    <span class="token keyword">return</span> <span class="token class-name">ResultVo</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="232__149"></a>2.3.2 文件下载地址</h5> 
<p>这个接口的作用就是获取一个文件流，根据ID来获取一个文件流</p> 
<p>这里的地址就是上一个接口中下载文件的地址。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"down/file/{fileId}"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">"根据参数下载一个文件"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">downFolderById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> fileId<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">// TODO 1. 根据文件的唯一ID来获取数据库中的记录</span>
    <span class="token class-name">EtmfFileInfo</span> fileInfo <span class="token operator">=</span> fileInfoOpt<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// TODO 2. 根据下载路径从 minio 中获取文件流 （因为我们使用的是minio，其他的自行切换即可）</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> smoMinIoUtils<span class="token punctuation">.</span><span class="token function">downloadFile</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span><span class="token function">getFileUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">downFileInfo</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> fileInfo<span class="token punctuation">,</span> inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServerException</span> <span class="token operator">|</span> <span class="token class-name">ErrorResponseException</span> <span class="token operator">|</span> <span class="token class-name">InsufficientDataException</span> <span class="token operator">|</span> <span class="token class-name">IOException</span> <span class="token operator">|</span>
             <span class="token class-name">NoSuchAlgorithmException</span> <span class="token operator">|</span> <span class="token class-name">InvalidKeyException</span> <span class="token operator">|</span> <span class="token class-name">InvalidResponseException</span> <span class="token operator">|</span> <span class="token class-name">XmlParserException</span> <span class="token operator">|</span>
             <span class="token class-name">InternalException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">JwtUtil</span><span class="token punctuation">.</span><span class="token function">responseError</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token number">500L</span><span class="token punctuation">,</span> <span class="token string">"文件下载失败："</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">downFileInfo</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">EtmfFileInfo</span> fileInfo<span class="token punctuation">,</span> <span class="token class-name">InputStream</span> inputStream<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"application/octet-stream; charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span><span class="token string">"Content-Disposition"</span><span class="token punctuation">,</span> <span class="token string">"attachment;filename="</span> <span class="token operator">+</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ServletOutputStream</span> stream <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre> 
<h5><a id="233__183"></a>2.3.3 文件下载地址</h5> 
<blockquote> 
 <p>这里是文件的回调地址，主要就是获取一个状态码，然后根据状态码判定是否保存文件。</p> 
</blockquote> 
<pre><code class="prism language-java">
<span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">"文件编辑之后的回调"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Parameters</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Parameter</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"fileId"</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">"文件的ID"</span><span class="token punctuation">,</span> in <span class="token operator">=</span> <span class="token class-name">ParameterIn</span><span class="token punctuation">.</span><span class="token constant">PATH</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/edit/callback/{fileId}"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">editCallBack</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> fileId<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">PrintWriter</span> writer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> body<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Scanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            scanner<span class="token punctuation">.</span><span class="token function">useDelimiter</span><span class="token punctuation">(</span><span class="token string">"\\A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            body <span class="token operator">=</span> scanner<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> scanner<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
            scanner<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"get request.getInputStream error:"</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"empty request.getInputStream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">JSONObject</span> jsonObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> jsonObj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"================文件编辑获取到的参数是：{}"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>jsonObj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> saved <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> downloadUri <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> jsonObj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"================文件进行保存处理，需要保存的状态值是：{}，可以获取到文件的路径是：{}"</span><span class="token punctuation">,</span> status<span class="token punctuation">,</span>downloadUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>downloadUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 根据文件下载地址来获取编辑后的文件流</span>
                <span class="token class-name">HttpURLConnection</span> connection <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpURLConnection</span><span class="token punctuation">)</span> url<span class="token punctuation">.</span><span class="token function">openConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">InputStream</span> stream <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stream <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"Stream is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// TODO 根据文件的唯一标识获取数据库中文件记录</span>
                <span class="token class-name">EtmfFileInfo</span> fileInfo <span class="token operator">=</span> fileInfoOpt<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// TODO 根据文件流创建一个文件</span>
                <span class="token class-name">File</span> savedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">FileOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>savedFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> read<span class="token punctuation">;</span>
                    <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>read <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> read<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// TODO 根据文件上传到 MINIO中</span>
                <span class="token keyword">boolean</span> b <span class="token operator">=</span> smoMinIoUtils<span class="token punctuation">.</span><span class="token function">uploadFile</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span><span class="token function">getFileUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> savedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"编辑文件后，文件上传状态：{}，上传的文件是：{}，Id是：{}"</span><span class="token punctuation">,</span>b<span class="token punctuation">,</span>fileInfo<span class="token punctuation">.</span><span class="token function">getFileName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                savedFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                connection<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                saved <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                ex<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 正常保存的时候剔除掉redis缓存</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token constant">TWO</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    redisUtil<span class="token punctuation">.</span><span class="token function">hdel</span><span class="token punctuation">(</span><span class="token class-name">RedisName</span><span class="token punctuation">.</span><span class="token constant">ONLY_OFFICE_FILE_KYE</span><span class="token punctuation">,</span>fileId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"{\"error\":"</span> <span class="token operator">+</span> saved <span class="token operator">+</span> <span class="token string">"}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        writer<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        writer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"======================编辑完成--------------返回值是：{}"</span><span class="token punctuation">,</span><span class="token string">"{\"error\":"</span> <span class="token operator">+</span> saved <span class="token operator">+</span> <span class="token string">"}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SmoGlobalException</span><span class="token punctuation">(</span><span class="token class-name">CustomExceptionType</span><span class="token punctuation">.</span><span class="token constant">OTHER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



</code></pre> 
<h3><a id="3__266"></a>3. 总结</h3> 
<blockquote> 
 <p>文件的在线编辑主要就是依托与onlyoffice实现的，而编辑器的配置是通过我们的接口来定义的，接口中的配置可以自由的定义编辑器的文件类型，窗口大小，文件来源，回调地址，保存类型等等。<br> 你需要编辑的文件可以放在任意的位置，只要你的接口可以通过流的方式给到onlyofiice编辑器即可。<br> 文件编辑后的处理都是在回调中处理的，最好先看一下文档的回调写法。回调的时候记得打印日志，观察一下接口的内容，一定要记得是通过回调中的url参数来获取编辑后的文件流的，并不是通过回调接口直接把文件流给到你。我在这里没有注意看饶了弯路。所以提醒一下。</p> 
</blockquote> 
<h4><a id="4__271"></a>4. 注意</h4> 
<h5><a id="41_onlyoffice_272"></a>4.1 你的项目的地址一定一定要和onlyoffice可以正常通讯，如果不行则一直不可能成功。</h5> 
<h5><a id="42_TOKEN_273"></a>4.2 TOKEN是可以可选项，建议一开始不要使用，后面有需要的时候再去添加。</h5> 
<h5><a id="43__274"></a>4.3 一定要看一下官网文档，文档真的很全很重要</h5> 
<h5><a id="44_KEY20_275"></a>4.4 协同的话只要参数就是一个KEY，如果需要超过20个的限制直接重新编译即可，大神一大堆，很容易就可以找到。</h5>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9fb8a3ae8123fc8af9add3230785d27d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">怎样把热门抖音短视频下载保存到手机相册?</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7603e36dd55673f51f2bfefa14b462c1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">美团外卖异地点餐怎么更改定位位置信息？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>