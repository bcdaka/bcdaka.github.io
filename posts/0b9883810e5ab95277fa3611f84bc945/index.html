<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kafka 典型问题与排查以及相关优化 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/0b9883810e5ab95277fa3611f84bc945/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Kafka 典型问题与排查以及相关优化">
  <meta property="og:description" content="Kafka 是一个高吞吐量的分布式消息系统，但在实际应用中，用户经常会遇到一些性能问题和消息堆积的问题。本文将介绍 Kafka 中一些典型问题的原因和排查方法，帮助用户解决问题并优化 Kafka 集群的性能。
一、Topic 消息发送慢，并发性能低 问题描述：
某个或某几个 Topic 的消息并发发送性能低，具体表现为 Producer 的平均请求延迟大，平均生产吞吐量低。
可能原因：
网络带宽不足，导致 IO 等待时间长。消息未压缩，导致网络流量超负荷。消息未批量发送或批量阈值配置不当，导致发送速率慢。Topic 分区数量不足，导致 Broker 接收消息积压。Broker 磁盘性能低，导致磁盘同步慢。Broker 分区总量过多，导致碎片化，磁盘读写过载。 排查方法： 1、确认网络带宽：
检查 Producer 的平均 IO 等待时间指标，判断 Producer 到 Broker 之间的网络带宽是否满足业务的流量要求。
在一个节点上作为服务器启动 iperf iperf -s 在另一个节点上作为客户端测试网络带宽 iperf -c 192.168.10.21 2、确认消息压缩：
检查 Producer 的平均压缩率指标，确保压缩率符合预期。
在 Producer 配置中启用消息压缩 compression.type=gzip 3、消息未批量发送或批量阈值配置不当
检查 Producer 的批量发送配置 batch.size 和 linger.ms。
操作命令： 查看 Producer 配置文件或代码，确认 batch.size 和 linger.ms 设置。
优化方法： 调整 Producer 配置，增大批量发送大小和延迟时间：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-09T20:53:22+08:00">
    <meta property="article:modified_time" content="2024-07-09T20:53:22+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kafka 典型问题与排查以及相关优化</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p>Kafka 是一个高吞吐量的分布式消息系统，但在实际应用中，用户经常会遇到一些性能问题和消息堆积的问题。本文将介绍 Kafka 中一些典型问题的原因和排查方法，帮助用户解决问题并优化 Kafka 集群的性能。</p> 
</blockquote> 
<h2 style="background-color:transparent;">一、Topic 消息发送慢，并发性能低</h2> 
<p><strong>问题描述：</strong></p> 
<p><strong>某个或某几个 Topic 的消息并发发送性能低，具体表现为 Producer 的平均请求延迟大，平均生产吞吐量低。</strong></p> 
<p><strong>可能原因：</strong></p> 
<ol><li>网络带宽不足，导致 IO 等待时间长。</li><li>消息未压缩，导致网络流量超负荷。</li><li>消息未批量发送或批量阈值配置不当，导致发送速率慢。</li><li>Topic 分区数量不足，导致 Broker 接收消息积压。</li><li>Broker 磁盘性能低，导致磁盘同步慢。</li><li>Broker 分区总量过多，导致碎片化，磁盘读写过载。</li></ol> 
<p><strong>排查方法： </strong></p> 
<p><strong>1、确认网络带宽：</strong></p> 
<blockquote> 
 <p>检查 Producer 的平均 IO 等待时间指标，判断 Producer 到 Broker 之间的网络带宽是否满足业务的流量要求。</p> 
</blockquote> 
<pre><code class="hljs">在一个节点上作为服务器启动 iperf
iperf -s

在另一个节点上作为客户端测试网络带宽
iperf -c 192.168.10.21
</code></pre> 
<p><strong>2、确认消息压缩：</strong></p> 
<blockquote> 
 <p>检查 Producer 的平均压缩率指标，确保压缩率符合预期。</p> 
</blockquote> 
<pre><code class="hljs">在 Producer 配置中启用消息压缩
compression.type=gzip
</code></pre> 
<p style="background-color:transparent;"><strong>3、消息未批量发送或批量阈值配置不当</strong></p> 
<p><strong> 检查 Producer 的批量发送配置 <code>batch.size</code> 和 <code>linger.ms</code>。</strong></p> 
<p><strong>操作命令</strong>： 查看 Producer 配置文件或代码，确认 <code>batch.size</code> 和 <code>linger.ms</code> 设置。</p> 
<p><strong>优化方法</strong>： 调整 Producer 配置，增大批量发送大小和延迟时间：</p> 
<pre><code class="hljs">batch.size=32768
linger.ms=10

</code></pre> 
<p><strong>4、增加 Topic 分区：</strong></p> 
<p><strong>使用 Kafka 提供的命令行工具查看 Topic 分区数量</strong></p> 
<pre><code class="hljs">kafka-topics.sh --describe --topic &lt;your_topic&gt; --zookeeper &lt;zookeeper_host&gt;:2181
</code></pre> 
<p><strong>优化方法</strong>： <strong>增加 Topic 的分区数量以提高并发处理能力：</strong></p> 
<pre><code class="hljs">kafka-topics.sh --alter --topic &lt;your_topic&gt; --partitions 10 --zookeeper &lt;zookeeper_host&gt;:2181
</code></pre> 
<p><strong>5、检查磁盘 IO 使用率：</strong></p> 
<blockquote> 
 <p>确认 Broker 磁盘 IO 使用率是否在安全范围内，若使用率较高则考虑扩容 Broker 或增加 Topic 分区数。</p> 
</blockquote> 
<p><strong> 使用 <code>iostat</code> 或 <code>dstat</code> 命令查看磁盘 IO 使用率：</strong></p> 
<pre><code class="hljs">iostat -x 1 10
dstat -d 1
</code></pre> 
<p><strong>优化方法</strong>：</p> 
<ul><li>升级磁盘为 SSD，提高磁盘性能。</li><li>优化磁盘配置，确保磁盘 IO 性能最佳。</li></ul> 
<p><strong>6、检查分区总量：</strong></p> 
<blockquote> 
 <p>查看集群的总分区数和单个 Broker 的分区数量，确保在规划的容量范围内。</p> 
</blockquote> 
<p><strong>使用 Kafka 提供的命令行工具查看集群分区情况： </strong></p> 
<pre><code class="hljs">kafka-topics.sh --describe --zookeeper &lt;zookeeper_host&gt;:2181
</code></pre> 
<p><strong>优化方法</strong>：</p> 
<ul><li>水平扩展 Broker，增加 Broker 数量以分散分区负载。</li><li>通过增加 Broker 节点来均衡分区分布，减少单个 Broker 的分区数量。</li></ul> 
<h2>二、Topic 消息堆积</h2> 
<p><strong>问题描述：</strong><br> 某个或某几个 Topic 的消息堆积持续增加，具体表现为 Group 消费延迟数量持续增加。</p> 
<p><strong>可能原因：</strong></p> 
<ol><li>Producer 生产消息流量增大。</li><li>Consumer 由于业务变化导致消费延迟增加。</li><li>Consumer 数量不足。</li><li>Consumer 数量频繁变化，导致 Group 不断做再平衡（Rebalance）。</li><li>Broker 未收到 Consumer 的消息确认消息。</li></ol> 
<p><strong>排查方法：</strong></p> 
<p><strong>确认生产量：</strong></p> 
<blockquote> 
 <p>检查 Producer 的消息生产量指标，判断是否明显增加。</p> 
</blockquote> 
<p><strong>确认消费量：</strong></p> 
<blockquote> 
 <p>检查 Consumer 的消息流量指标，判断是否明显下降</p> 
</blockquote> 
<p><strong>检查 Consumer 数量：</strong></p> 
<blockquote> 
 <p>通过 Kafka Broker 提供的命令，确认 Topic 对应的 Consumer 数量与实际的 Consumer 数量是否一致。如果不一致，说明某些 Consumer 未正确连接到 Broker，需要排查 Consumer 是否正常运行。</p> 
</blockquote> 
<pre><code class="hljs">kafka-consumer-groups.sh --describe --group your_consumer_group --bootstrap-server broker_host:9092
</code></pre> 
<p><strong>观察 Consumer 变化：</strong></p> 
<blockquote> 
 <p>观察 Consumer 的数量是否频繁变化而触发再平衡。由于网络或其他原因，可能导致 Consumer 与 Broker 之间的连接不稳定，Consumer 能持续消费消息，但 Broker 始终认为消息未确认，导致消费位点不变。此时可能需要确认 Consumer 与 Broker 之间的网络稳定性，甚至重启 Consumer。</p> 
</blockquote> 
<h2>三、优化 Kafka 生产性能</h2> 
<p><strong>优化方法：</strong></p> 
<p><strong>1、增大 Producer 发送消息的批量大小（batch.size）和批量发送等待时间（linger.ms）。</strong></p> 
<pre><code class="hljs">batch.size=32768
linger.ms=10
</code></pre> 
<p><strong>2、启用压缩</strong></p> 
<p><strong>使用压缩算法减少网络带宽占用。</strong></p> 
<pre><code class="hljs">compression.type=gzip
</code></pre> 
<p><strong>3、增加分区数：</strong></p> 
<blockquote> 
 <p>通过增加 Topic 的分区数，提高并发写入能力。</p> 
</blockquote> 
<p><strong>4、调整 Broker 配置</strong></p> 
<blockquote> 
 <p>优化 Broker 的磁盘配置和 IO 设置，例如调整 log.segment.bytes 和 log.retention.hours。</p> 
</blockquote> 
<h2>四、优化 Kafka 消费性能</h2> 
<p><strong>优化方法：</strong></p> 
<p><strong>1、增大消费并发：</strong></p> 
<blockquote> 
 <p>增加 Consumer 数量和分区数，提升并发消费能力。</p> 
</blockquote> 
<p><strong>2、优化消费逻辑：</strong></p> 
<blockquote> 
 <p>确保 Consumer 的业务逻辑高效，减少单个消息处理时间。</p> 
</blockquote> 
<p><strong>3、平衡负载：</strong></p> 
<blockquote> 
 <p>确保 Consumer Group 的每个 Consumer 都能均匀分配到分区。</p> 
</blockquote> 
<p></p> 
<h2><strong>五、Kafka 集群扩展与维护</strong></h2> 
<h3>扩展方法：</h3> 
<p><strong>1、水平扩展 Broker：</strong></p> 
<blockquote> 
 <p>增加 Broker 数量，均衡负载，提高集群容量。</p> 
</blockquote> 
<p><strong>（1）安装新Broker：</strong></p> 
<blockquote> 
 <p><strong>在新的服务器上安装Kafka，步骤与之前的安装步骤相同，确保Java已经安装。</strong></p> 
</blockquote> 
<p><strong>（2）配置新 Broker：</strong></p> 
<blockquote> 
 <p><strong>编辑<code>server.properties</code>文件，设置新的<code>broker.id</code> 和<code>log.dirs，</code>确保 <code>zookeeper.connect</code>指向现有的 Zookeeper集群。</strong></p> 
</blockquote> 
<pre><code class="hljs">broker.id=3  # 新的 Broker ID
listeners=PLAINTEXT://:9092
log.dirs=/data/kafka-logs
zookeeper.connect=192.168.10.20:2181,192.168.10.21:2181,192.168.10.22:2181
num.partitions=3
default.replication.factor=3
</code></pre> 
<p><strong>（3）启动新Broker</strong></p> 
<pre><code class="hljs">sudo su - kafka
/usr/local/kafka/bin/kafka-server-start.sh -daemon /usr/local/kafka/config/server.properties
</code></pre> 
<p><strong> （4）重新分配分区：</strong></p> 
<p>使用Kafka自带的工具将现有分区重新分配到新 Broker 上。</p> 
<p>生成当前分区副本分配：</p> 
<pre><code class="hljs">kafka-reassign-partitions.sh --zookeeper 192.168.10.20:2181 --generate --topics-to-move-json-file topics.json --broker-list "0,1,2,3"
</code></pre> 
<p>topics.json内容：</p> 
<pre><code class="hljs">{
  "version": 1,
  "topics": [
    {"topic": "test-topic"}
  ]
}
</code></pre> 
<p> 执行分区重新分配：</p> 
<pre><code class="hljs">kafka-reassign-partitions.sh --zookeeper 192.168.10.20:2181 --execute --reassignment-json-file reassignment.json
</code></pre> 
<p><strong>2、动态扩展 Topic：</strong></p> 
<blockquote> 
 <p>根据流量需求动态调整 Topic 的分区数。</p> 
</blockquote> 
<p> <strong>增加 Topic 的分区数量</strong>：</p> 
<pre><code class="hljs">kafka-topics.sh --alter --topic test-topic --partitions 10 --zookeeper 192.168.10.20:2181
</code></pre> 
<h3>维护方法：</h3> 
<p><strong>定期监控：</strong></p> 
<blockquote> 
 <p>使用 Kafka 自带的工具或第三方监控工具（如 Prometheus + Grafana）定期监控集群状态。</p> 
</blockquote> 
<p><strong>检查集群状态： </strong></p> 
<pre><code class="hljs">kafka-broker-api-versions.sh --bootstrap-server 192.168.10.20:9092
</code></pre> 
<p><strong>检查 Topic 信息： </strong></p> 
<pre><code class="hljs">kafka-topics.sh --describe --topic test-topic --zookeeper 192.168.10.20:2181
</code></pre> 
<p><strong>定期优化：</strong></p> 
<blockquote> 
 <p>定期检查并优化配置，清理过期数据，保持集群健康运行。</p> 
</blockquote> 
<p><strong>优化<code>server.properties</code>中的配置，根据实际使用情况调整参数，如调整日志段大小和保留时间：</strong></p> 
<pre><code class="hljs">log.segment.bytes=1073741824  # 1 GB
log.retention.hours=168       # 7 days
</code></pre> 
<p><strong>清理过期数据</strong>：</p> 
<pre><code class="hljs">kafka-delete-records.sh --bootstrap-server 192.168.10.20:9092 --offset-json-file offsets.json
</code></pre> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/55f331f2c53e93d9a6a5d6adff8d54a2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">服务器为什么大多用 Linux？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9f30cb44d449e938a27f4225c28aaceb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Hive/Spark窗口函数</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>