<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spring-Kafka如何实现批量消费消息并且不丢失数据 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/3b7a7d58e739f2f35920e182e34745e6/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Spring-Kafka如何实现批量消费消息并且不丢失数据">
  <meta property="og:description" content="Spring-Kafka如何实现批量消费消息并且不丢失数据 先给答案：
// 批量消费配置: 1批量, 2手动提交 factory.setBatchListener(true); factory.getContainerProperties().setAckMode(AbstractMessageListenerContainer.AckMode.MANUAL_IMMEDIATE); // 调大fetch的相关参数, 以便于提升吞吐量, 但会增大延时 // 一次poll操作最大获取的记录数量 propsMap.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, maxPollRecords); // max.poll.records, 缺省是500 // 一次fetch操作最小的字节数, 如果低于这个字节数, 就会等待, 直到超时后才返回给消费者. 这里给100kB, 缺省是1B propsMap.put(ConsumerConfig.FETCH_MIN_BYTES_CONFIG, 1024 * 100); // fetch.min.bytes // 一次fetch操作的最大等待时间，“最大等待时间”与“最小字节”任何一个先满足了就立即返回给消费者 // 需要注意：“最大等待时间”不能超过 session.timeout.ms 和 request.timeout.ms propsMap.put(ConsumerConfig.FETCH_MAX_WAIT_MS_CONFIG, 10000); // fetch.max.wait.ms, 缺省是500 // 在消费者方法中注入acknowledgment并在执行完业务逻辑后手动调用确认方法 acknowledgment.acknowledge(); 1、背景： 某个业务对象由多张表关联而成，要创建该对象需要向多张表插入数据，基于canal的监控就会有多次该对象的变更记录，而Kafka消费的时候也会多次处理同一个对象（虽然不同表，但是同一个对象的不同部分），原有的Kafka消费者是一次处理一条，这将造成重复对同一个对象的处理。其实只需要所有表插入完毕后，一次处理该对象即可。
2、现有技术架构： mysql --&gt; canal --&gt; Kafka --&gt; Spring-Kafka消费者 --&gt; 下游接口
3、解决方案： 优化Spring-Kafka消费者，从单条处理改为多条处理，然后在消费者中合并相同的对象，从而达到一个对象只处理一次（最多两次）的目的。为什么有可能是两次，因为分批的时候很容易将同一个对象的多条消息分到上下两批，这样这个对象将会被处理两次；那为什么不会处理三次？其实也能够制造出来上次的情况，就是分批的大小如果很小就容易出现三次，甚至更多次。所以通常情况我们将分批大小设置得要比表数量多。
举个例子：一个对象的创建有10张表的插入消息，而分批大小设置成4，此时10条消息就被4这个批大小拆分成3批，每批处理一次该对象，那么该对象就会被处理3次。所以分批大小是一个重要的参数，其值的设定通常要大，但再大也不可避免被分成两批的情况。
4、实现步骤 Spring-kafka从1.1版本开始就支持了批量消费，需要在ContainerFactory中设置batchListener=true
同时设置消费者参数 max.poll.records 来控制一批的最大记录数量，该参数的缺省值为500。
AbstractKafkaListenerContainerFactory类的源码如下：
/** * Set to true if this endpoint should create a batch listener.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-08-01T21:40:05+08:00">
    <meta property="article:modified_time" content="2023-08-01T21:40:05+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spring-Kafka如何实现批量消费消息并且不丢失数据</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="SpringKafka_0"></a>Spring-Kafka如何实现批量消费消息并且不丢失数据</h2> 
<p>先给答案：</p> 
<pre><code class="prism language-java">		<span class="token comment">// 批量消费配置: 1批量, 2手动提交</span>
		factory<span class="token punctuation">.</span><span class="token function">setBatchListener</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		factory<span class="token punctuation">.</span><span class="token function">getContainerProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAckMode</span><span class="token punctuation">(</span><span class="token class-name">AbstractMessageListenerContainer<span class="token punctuation">.</span>AckMode</span><span class="token punctuation">.</span><span class="token constant">MANUAL_IMMEDIATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 调大fetch的相关参数, 以便于提升吞吐量, 但会增大延时</span>
		<span class="token comment">// 一次poll操作最大获取的记录数量</span>
        propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">MAX_POLL_RECORDS_CONFIG</span><span class="token punctuation">,</span> maxPollRecords<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// max.poll.records, 缺省是500</span>
		<span class="token comment">// 一次fetch操作最小的字节数, 如果低于这个字节数, 就会等待, 直到超时后才返回给消费者. 这里给100kB, 缺省是1B</span>
		propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">FETCH_MIN_BYTES_CONFIG</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fetch.min.bytes</span>
		<span class="token comment">// 一次fetch操作的最大等待时间，“最大等待时间”与“最小字节”任何一个先满足了就立即返回给消费者</span>
		<span class="token comment">// 需要注意：“最大等待时间”不能超过 session.timeout.ms 和 request.timeout.ms</span>
		propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">FETCH_MAX_WAIT_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fetch.max.wait.ms, 缺省是500</span>

		<span class="token comment">// 在消费者方法中注入acknowledgment并在执行完业务逻辑后手动调用确认方法</span>
		acknowledgment<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="1_21"></a>1、背景：</h3> 
<p>某个业务对象由多张表关联而成，要创建该对象需要向多张表插入数据，基于canal的监控就会有多次该对象的变更记录，而Kafka消费的时候也会多次处理同一个对象（虽然不同表，但是同一个对象的不同部分），原有的Kafka消费者是一次处理一条，这将造成重复对同一个对象的处理。其实只需要所有表插入完毕后，一次处理该对象即可。</p> 
<h3><a id="2_24"></a>2、现有技术架构：</h3> 
<p>mysql --&gt; canal --&gt; Kafka --&gt; Spring-Kafka消费者 --&gt; 下游接口</p> 
<h3><a id="3_28"></a>3、解决方案：</h3> 
<p>优化Spring-Kafka消费者，从单条处理改为多条处理，然后在消费者中合并相同的对象，从而达到一个对象只处理一次（最多两次）的目的。为什么有可能是两次，因为分批的时候很容易将同一个对象的多条消息分到上下两批，这样这个对象将会被处理两次；那为什么不会处理三次？其实也能够制造出来上次的情况，就是分批的大小如果很小就容易出现三次，甚至更多次。所以通常情况我们将分批大小设置得要比表数量多。</p> 
<p>举个例子：一个对象的创建有10张表的插入消息，而分批大小设置成4，此时10条消息就被4这个批大小拆分成3批，每批处理一次该对象，那么该对象就会被处理3次。所以分批大小是一个重要的参数，其值的设定通常要大，但再大也不可避免被分成两批的情况。</p> 
<h3><a id="4_33"></a>4、实现步骤</h3> 
<p>Spring-kafka从1.1版本开始就支持了批量消费，需要在ContainerFactory中设置<code>batchListener</code>=<code>true</code><br> 同时设置消费者参数 <code>max.poll.records</code> 来控制一批的最大记录数量，该参数的缺省值为<code>500</code>。</p> 
<p><code>AbstractKafkaListenerContainerFactory</code>类的源码如下：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	 * Set to true if this endpoint should create a batch listener.
	 * @param batchListener true for a batch listener.
	 * @since 1.1
	 */</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBatchListener</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> batchListener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>batchListener <span class="token operator">=</span> batchListener<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>可以从javaDoc的<code>@since</code>得知该功能从1.1版本就存在了，所以只要Spring-Kafka的版本高于1.1的都支持批量消费功能。这个参数是搭配<code>@KafkaListener</code>来使用的。单条消费的写法如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> groupId <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> topics <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以上只能一次处理一条，并不能将多条消息统筹处理，所以使用以下的批量消费的写法：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> groupId <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> topics <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> containerFactory <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> datas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从以上代码可以看出，批量消费仅仅是将参数的<code>ConsumerRecord</code>类型改为<code>List&lt;ConsumerRecord&gt;</code>即可。<br> 这样就行了吗？如果批次较大，对这一批数据的处理时间较长，就容易造成丢数据。场景如下：<br> 1、开启自动提交offset，<br> 2、提交offset的时间间隔为1s，<br> 3、处理这一批数据耗时为2s。<br> 还需要发生以下条件才能导致丢消息：<br> 1、“自动提交offset的时间”到了且成功执行了offset的提交<br> 2、此后几乎同时程序发生了严重的错误导致进程退出（注意此时消费者的代码逻辑并未执行完毕）<br> 那么消息就会被丢失，因为Kafka收到了offset的提交，所以Kafka认为这一批消息已经处理成功了，但程序实际并未处理成功，等到下次启动程序，将从Kafka记录的offset开始消费，“记录的offset”就是发生异常退出前“提交的offset”。所以上次异常退出时刻的那一批消息就被丢失了，不会再被消费到。</p> 
<p>举例：<br> 假设消费者这一批消费到的消息offset编码列表为5,6,7。而自动提交offset时候会将7提交给Kafka，表示下一个消息将从8开始消费。但567这3条消息在消费者进程中还没来得及处理完毕就被意外终止了。等到人工处理错误重新启动程序，将从8开始消费，因为Kafka认为567已经处理过了，但实际567并没有成功处理，所以就会丢失567这一批的消息。</p> 
<p>在进一步，如何防止消息丢失呢？答案是手动提交offset，同样Spring-Kafka已经提供了支持，其实Spring-Kafka只是对原生Kafka的包装，最核心的还是原生Kafka支持手动提交offset的能力。</p> 
<p>上干货，Spring-Kafka中有一个类很有用：<code>AcknowledgingMessageListener</code>，这个类就是为了支持手动ack消息的，也即是手动提交offset，只是Spring将“手动提交offset”这个概念包装成了“确认消息”，里面有一个方法：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	 * Invoked with data from kafka.
	 * @param data the data to be processed.
	 * @param acknowledgment the acknowledgment.
	 */</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> acknowledgment<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这个类是设计成去实现它从而获取手动提交offset的能力，但我们还可以简化，结合之前的<code>@KafkaListener</code>的方法，我们将<code>Acknowledgment acknowledgment</code>参数放在<code>@KafkaListener</code>的方法中，Spring就能够将<code>Acknowledgment</code>对象传递进来，从而我们可以自己控制何时“确认消息”。当然仅有这步还不够，还需要告诉Spring-Kafka我需要手动提交offset，通过一个简单的设置即可：</p> 
<pre><code class="prism language-java">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"batch_and_manual_ack_ContainerFactory"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">KafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConcurrentMessageListenerContainer</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">batch_and_manual_ack_ContainerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setConsumerFactory</span><span class="token punctuation">(</span><span class="token function">consumerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 批量消费配置: 1批量, 2手动提交</span>
        factory<span class="token punctuation">.</span><span class="token function">setBatchListener</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">getContainerProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAckMode</span><span class="token punctuation">(</span><span class="token class-name">AbstractMessageListenerContainer<span class="token punctuation">.</span>AckMode</span><span class="token punctuation">.</span><span class="token constant">MANUAL_IMMEDIATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>其中最重要的一句是：<code>.setAckMode(AckMode.MANUAL_IMMEDIATE);</code>，该配置的缺省值是<code>AckMode.BATCH</code>。可以从<code>ContainerProperties</code>类的源码找到缺省值：</p> 
<pre><code class="prism language-java">	<span class="token comment">/**
	 * The ack mode to use when auto ack (in the configuration properties) is false.
	 * &lt;ul&gt;
	 * &lt;li&gt;RECORD: Ack after each record has been passed to the listener.&lt;/li&gt;
	 * &lt;li&gt;BATCH: Ack after each batch of records received from the consumer has been
	 * passed to the listener&lt;/li&gt;
	 * &lt;li&gt;TIME: Ack after this number of milliseconds; (should be greater than
	 * {@code #setPollTimeout(long) pollTimeout}.&lt;/li&gt;
	 * &lt;li&gt;COUNT: Ack after at least this number of records have been received&lt;/li&gt;
	 * &lt;li&gt;MANUAL: Listener is responsible for acking - use a
	 * {@link org.springframework.kafka.listener.AcknowledgingMessageListener}.
	 * &lt;/ul&gt;
	 */</span>
	<span class="token keyword">private</span> <span class="token class-name">AbstractMessageListenerContainer<span class="token punctuation">.</span>AckMode</span> ackMode <span class="token operator">=</span> <span class="token class-name">AckMode</span><span class="token punctuation">.</span><span class="token constant">BATCH</span><span class="token punctuation">;</span>
</code></pre> 
<p>要想提高吞度量，须要设置一下几个参数：</p> 
<ul><li> <p>max.poll.records<br> 一次poll操作最大获取的记录数量，缺省是500。该值越大，则吞吐量也越大，但要求消费者能够在不超时的情况下处理完所有的消息。</p> </li><li> <p>fetch.min.bytes<br> 一次fetch操作最小的字节数, 如果低于这个字节数, 就会等待, 直到超时后才返回给消费者. 缺省是1B</p> </li><li> <p>fetch.max.wait.ms<br> 一次fetch操作的最大等待时间，“最大等待时间”与“最小字节”任何一个先满足了就立即返回给消费者，缺省是500。<br> 需要注意：“最大等待时间”不能超过 session.timeout.ms 和 request.timeout.ms</p> </li></ul> 
<h3><a id="5_127"></a>5、所有代码：</h3> 
<pre><code class="prism language-java">
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"batch_and_manual_ack_ContainerFactory"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">KafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConcurrentMessageListenerContainer</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">batch_and_manual_ack_ContainerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentKafkaListenerContainerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setConsumerFactory</span><span class="token punctuation">(</span><span class="token function">consumerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">setConcurrency</span><span class="token punctuation">(</span>concurrency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">getContainerProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPollTimeout</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 批量消费配置: 1批量, 2手动提交</span>
        factory<span class="token punctuation">.</span><span class="token function">setBatchListener</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factory<span class="token punctuation">.</span><span class="token function">getContainerProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAckMode</span><span class="token punctuation">(</span><span class="token class-name">AbstractMessageListenerContainer<span class="token punctuation">.</span>AckMode</span><span class="token punctuation">.</span><span class="token constant">MANUAL_IMMEDIATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ConsumerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">consumerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultKafkaConsumerFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">consumerConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">consumerConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> propsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">BOOTSTRAP_SERVERS_CONFIG</span><span class="token punctuation">,</span> servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">ENABLE_AUTO_COMMIT_CONFIG</span><span class="token punctuation">,</span> enableAutoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">AUTO_COMMIT_INTERVAL_MS_CONFIG</span><span class="token punctuation">,</span> autoCommitInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">SESSION_TIMEOUT_MS_CONFIG</span><span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">KEY_DESERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">VALUE_DESERIALIZER_CLASS_CONFIG</span><span class="token punctuation">,</span> <span class="token class-name">StringDeserializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">GROUP_ID_CONFIG</span><span class="token punctuation">,</span> groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">AUTO_OFFSET_RESET_CONFIG</span><span class="token punctuation">,</span> autoOffsetReset<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// 调大fetch的相关参数, 以便于提升吞吐量, 但会增大延时</span>
		<span class="token comment">// 一次poll操作最大获取的记录数量</span>
        propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">MAX_POLL_RECORDS_CONFIG</span><span class="token punctuation">,</span> maxPollRecords<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// max.poll.records, 缺省是500</span>
		<span class="token comment">// 一次fetch操作最小的字节数, 如果低于这个字节数, 就会等待, 直到超时后才返回给消费者. 这里给100kB, 缺省是1B</span>
		propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">FETCH_MIN_BYTES_CONFIG</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fetch.min.bytes</span>
		<span class="token comment">// 一次fetch操作的最大等待时间，“最大等待时间”与“最小字节”任何一个先满足了就立即返回给消费者</span>
		<span class="token comment">// 需要注意：“最大等待时间”不能超过 session.timeout.ms 和 request.timeout.ms</span>
		propsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ConsumerConfig</span><span class="token punctuation">.</span><span class="token constant">FETCH_MAX_WAIT_MS_CONFIG</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// fetch.max.wait.ms, 缺省是500</span>

        <span class="token keyword">return</span> propsMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>groupId <span class="token operator">=</span> <span class="token string">"junit-test-group"</span><span class="token punctuation">,</span> containerFactory <span class="token operator">=</span> <span class="token string">"batch_and_manual_ack_ContainerFactory"</span><span class="token punctuation">,</span> topics <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"test"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test_batchConsume</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConsumerRecord</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> datas<span class="token punctuation">,</span> <span class="token class-name">Acknowledgment</span> acknowledgment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" datas = "</span> <span class="token operator">+</span> datas<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" collect = "</span> <span class="token operator">+</span> datas<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> t<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 最后一定要提交进度 (用于持久化进度到Kafka)</span>
        acknowledgment<span class="token punctuation">.</span><span class="token function">acknowledge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>将以上代码放在某个Spring的类里，然后修改配置即可使用</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ca516e83f25a8e4cf9ae7f442b674d85/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">经纬度转换 | 基于Python的经纬度与xy坐标(屏幕坐标)相互转换(可批量)，并在平面坐标系上以特定点为坐标原点重新建立坐标系，输出各点新坐标</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7b0495da620374aed675531fc663b0e6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">深入理解 Java Bean 的生命周期及各个阶段解析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>