<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>一文理解 Treelite，Treelite 为决策树集成模型的部署和推理提供了高效、灵活的解决方案 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/b395c7d917908374c97ecf8e5f21ad8c/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="一文理解 Treelite，Treelite 为决策树集成模型的部署和推理提供了高效、灵活的解决方案">
  <meta property="og:description" content="🍉 CSDN 叶庭云：https://yetingyun.blog.csdn.net/
一、什么是 Treelite？ Treelite 是一个专门用于将决策树集成模型高效部署到生产环境中的机器学习模型编译器，特别适合处理大批量数据的推理任务，能够显著提升推理性能。它提供多个前端接口，可与其他集成梯度提升树库（如 XGBoost、LightGBM 和 scikit-learn）配合使用。通过编译优化，Treelite 能将模型的性能提升 2 到 6 倍，相比于原生模型。Treelite 的核心功能在于将树模型编译为高效的 C 代码，从而在推理阶段实现显著的性能提升。
Treelite 官网：https://treelite.readthedocs.io/en/latest/index.html#
Treelite 的主要功能
模型编译：将决策树模型编译成高效的可部署形式，方便部署。性能优化：使用 Treelite 进行模型编译优化后的性能相比于原生的 XGBoost、LightGBM 模型通常会提升 2-4 倍。互操作性：支持与其他树模型库（例如 XGBoost、LightGBM 和 scikit-learn）的无缝集成。 Treelite 的设计特点
模块化设计：前端（与其他树库交互的部分）和后端（生成可部署 C 文件的部分）之间有明显的分离。前端负责与其他树库的交互，后端负责生成可部署的 C 文件。这种设计使得 Treelite 能够轻松地与不同的树模型库集成，同时保持其核心编译功能的独立性。前端接口：提供了多个前端接口来与其他树库配合使用，包括专用接口导入 XGBoost、LightGBM 和 scikit-learn 生成的模型可扩展性：允许用户以编程方式指定其模型，还支持自定义模型编译。 Treelite 支持的模型类型
决策树集成：包括随机森林和梯度提升决策树（GBDTs）。支持的前端接口：XGBoost、LightGBM 和 scikit-learn。 Treelite 的设计与实现
编译过程：Treelite 的编译过程包括将树模型转换为中间表示（Intermediate Representation，IR），然后优化该 IR 并生成最终的 C 代码。这一过程充分利用了编译器优化技术，将树模型转换为高效的代码，从而在推理阶段实现快速响应。优化策略：Treelite 采用多种优化策略，包括逻辑分支优化、内存访问优化和并行计算优化，以提高模型推理速度。这些优化策略使得 Treelite 生成的 C 代码在推理时能够充分利用硬件资源，实现高性能推理。 Treelite 的性能优势：优化后的模型在预测速度上相比原生模型有显著提升，最高可提高 6 倍。Treelite 主要在以下两个方面进行了改进：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-06T13:54:32+08:00">
    <meta property="article:modified_time" content="2024-07-06T13:54:32+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">一文理解 Treelite，Treelite 为决策树集成模型的部署和推理提供了高效、灵活的解决方案</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>🍉 <font face="Latin Modern Math" size="4">CSDN</font> <font face="楷体" size="4">叶庭云</font>：<font face="Latin Modern Math" size="4"><a href="https://yetingyun.blog.csdn.net/?type=lately" rel="nofollow">https://yetingyun.blog.csdn.net/</a></font></p> 
<hr> 
<h2><a id="_Treelite_5"></a>一、什么是 Treelite？</h2> 
<p><font face="Latin Modern Math" size="4"></font></p> 
<p><strong>Treelite</strong> 是一个专门用于将决策树集成模型高效部署到生产环境中的<strong>机器学习模型编译器</strong>，特别适合处理大批量数据的推理任务，能够显著提升推理性能。它提供多个前端接口，可与其他集成梯度提升树库（如 XGBoost、LightGBM 和 scikit-learn）配合使用。通过编译优化，Treelite 能将模型的性能提升 <strong>2 到 6 倍</strong>，相比于原生模型。Treelite 的核心功能在于将树模型编译为高效的 C 代码，从而在推理阶段实现显著的性能提升。</p> 
<p>Treelite 官网：<a href="https://treelite.readthedocs.io/en/latest/index.html#" rel="nofollow">https://treelite.readthedocs.io/en/latest/index.html#</a></p> 
<p>Treelite 的主要功能</p> 
<ul><li>模型编译：将决策树模型编译成高效的可部署形式，方便部署。</li><li>性能优化：使用 Treelite 进行模型编译优化后的性能相比于原生的 XGBoost、LightGBM 模型通常会提升 2-4 倍。</li><li>互操作性：支持与其他树模型库（例如 XGBoost、LightGBM 和 scikit-learn）的无缝集成。</li></ul> 
<p>Treelite 的设计特点</p> 
<ul><li>模块化设计：前端（与其他树库交互的部分）和后端（生成可部署 C 文件的部分）之间有明显的分离。前端负责与其他树库的交互，后端负责生成可部署的 C 文件。这种设计使得 Treelite 能够轻松地与不同的树模型库集成，<strong>同时保持其核心编译功能的独立性</strong>。</li><li>前端接口：提供了多个前端接口来与其他树库配合使用，包括专用接口导入 XGBoost、LightGBM 和 scikit-learn 生成的模型</li><li>可扩展性：允许用户以编程方式指定其模型，还支持自定义模型编译。</li></ul> 
<p><img src="https://images2.imgbox.com/85/ab/Hegd8geg_o.png" alt="在这里插入图片描述"></p> 
<p>Treelite 支持的模型类型</p> 
<ul><li>决策树集成：包括随机森林和梯度提升决策树（GBDTs）。</li><li>支持的前端接口：XGBoost、LightGBM 和 scikit-learn。</li></ul> 
<p>Treelite 的设计与实现</p> 
<ul><li><strong>编译过程</strong>：Treelite 的编译过程包括将树模型转换为中间表示（Intermediate Representation，IR），然后优化该 IR 并生成最终的 C 代码。这一过程充分利用了编译器优化技术，将树模型转换为高效的代码，从而在推理阶段实现快速响应。</li><li><strong>优化策略</strong>：Treelite 采用多种优化策略，包括逻辑分支优化、内存访问优化和并行计算优化，以提高模型推理速度。这些优化策略使得 Treelite 生成的 C 代码在推理时能够充分利用硬件资源，实现高性能推理。</li></ul> 
<p>Treelite 的性能优势：优化后的模型在预测速度上相比原生模型有显著提升，最高可提高 6 倍。Treelite 主要在以下两个方面进行了改进：</p> 
<ul><li><strong>通过规则编译加快预测速度</strong>。将决策规则 “编译” 为嵌套的 if-else 条件，可以将给定的树集成模型转化为 C 程序。在转换过程中，每个测试节点被转化为一对 if-else 语句，随后递归地将左右子节点扩展为 C 代码，直至触及每个叶节点。通过这种方式，我们能够针对正在检查的模型实现编译时优化。以前，模型在运行时从文件中加载，且预测逻辑并未考虑到与特定模型相关的信息。然而，现在通过规则编译，编译器能够访问正在编译的特定模型中的每一位信息，进而利用这些信息进一步优化生成的机器代码。作为早期演示，Treelite 提供了两种优化方案。</li><li><strong>逻辑分支优化，对条件分支进行注释</strong>。我们预测每个条件的可能性时，会依据训练数据中满足该条件的数据点数量。若条件在训练数据中有至少 50% 的概率为真，则将其标记为 “预期为真”；否则，标记为 “预期为假”。GCC 和 clang 编译器均提供 <code>__builtin_expect</code> 这一编译器内在函数，用以指定条件的预期结果。这有助于编译器更智能地决定分支顺序，从而改进分支预测。</li><li>在<strong>逻辑比较优化</strong>方面，原始的分支比较可能涉及浮点数比较逻辑。为提高效率，我们建议将浮点数比较量化为整数数值比较。这一优化措施将测试节点中的所有阈值转换为整数，从而确保每个阈值条件都执行整数比较，而非传统的浮点比较。<strong>通过 “量化” 阈值为整数索引</strong>，在 x86-64 等平台上，将浮点比较替换为整数比较，不仅减少了可执行代码的大小，还改善了数据局部性，进而提升了性能。</li></ul> 
<p><strong>Treelite 的应用场景</strong></p> 
<ul><li>大规模数据推理：特别适用于需要处理大量数据的场景。</li><li>模型部署：高效地将训练好的模型部署到生产环境中。</li></ul> 
<p>通过这些功能和应用场景，Treelite 为数据科学家和机器学习工程师提供了一个强大的工具，用于优化决策树集成模型的部署和推理性能。</p> 
<hr> 
<h2><a id="_Treelite_52"></a>二、为什么要用 Treelite？</h2> 
<p><font face="Latin Modern Math" size="4"></font></p> 
<p>在生产环境部署决策树集成模型，为什么要使用 Treelite？</p> 
<p>在生产环境中部署决策树集成模型时，<strong>选择使用 Treelite 的主要原因包括以下几点</strong>：</p> 
<ul><li>模型导出和独立的预测库：Treelite 可以将训练好的模型导出为独立的预测库，从而在部署时无需安装任何机器学习包，简化部署流程。</li><li>模型编译优化：Treelite 可以将树模型编译优化为单独的库，显著提高模型的预测速度，例如，XGBoost 模型的预测速度可提高 2~6 倍。</li><li>支持多种树模型：Treelite 支持包括随机森林、GBDT、XGBoost、LightGBM 和 scikit-learn 等在内的多种流行机器学习库。</li><li>跨语言支持：Treelite 提供多个前端接口，便于将模型部署到不同编程语言环境（如 C、Java 等），从而更容易地集成到现有生产系统中。</li><li>性能提升：使用 Treelite 进行模型编译优化后，性能通常比原生的 XGBoost、LightGBM 模型提升 2~4 倍，这对处理大批量数据的推理场景尤为重要。</li><li>良好的社区支持：Treelite 拥有一个活跃的社区，提供详细的文档和丰富的资源，如官方文档、技术论文和示例代码等。这些资源为开发者提供了深入学习和使用的便利，进一步推动了 Treelite 在机器学习领域的应用和发展。</li></ul> 
<p>综上所述，Treelite 以其模型导出、编译优化、多模型支持、跨语言部署和性能提升等特点，成为生产环境中部署决策树集成模型的首选工具。</p> 
<hr> 
<h2><a id="_Treelite__71"></a>三、使用 Treelite 部署决策树集成模型的具体操作步骤</h2> 
<p><font face="Latin Modern Math" size="4"></font></p> 
<p>Treelite 是一个专门用于加速决策树集成模型推理（预测）速度的库。在生产环境中部署决策树集成模型时，使用 Treelite 可以显著加快模型的推理速度。以下是使用 Treelite 在生产环境中部署决策树集成模型的具体操作步骤：</p> 
<p><strong>1. 安装 Treelite 和 TL2cgen</strong>：</p> 
<p>确保你已经安装好了 Treelite 和 TL2cgen。如果没有安装，可以使用以下命令进行安装：</p> 
<pre><code class="prism language-bash">pip <span class="token function">install</span> treelite
pip <span class="token function">install</span> tl2cgen
</code></pre> 
<p><strong>2. 准备模型</strong>：</p> 
<p>确保你拥有一个经过良好训练的决策树集成模型，如使用 XGBoost、LightGBM 或 CatBoost 训练得到的模型。模型需保存为支持的格式，常见的格式包括 JSON、BSON 或 pickle。</p> 
<p><strong>3. 转换为 Treelite 格式</strong>：</p> 
<p>将你的决策树模型转换成 Treelite 可以识别的格式。通常，这需要使用 Treelite 提供的 API 来加载模型。下面是一个使用 XGBoost 模型的示例：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tl2cgen
<span class="token keyword">import</span> treelite
<span class="token keyword">import</span> xgboost <span class="token keyword">as</span> xgb

<span class="token comment"># Importing tree ensemble models：https://treelite.readthedocs.io/en/latest/tutorials/import.html#</span>

<span class="token comment"># Treelite 3.x 及更早版本</span>
<span class="token comment"># xgb_model = treelite.Model.load("my_model.json", model_format="xgboost_json")</span>
<span class="token comment"># JSON format</span>
model <span class="token operator">=</span> treelite<span class="token punctuation">.</span>frontend<span class="token punctuation">.</span>load_xgboost_model<span class="token punctuation">(</span><span class="token string">"my_model.json"</span><span class="token punctuation">)</span>
<span class="token comment"># Legacy binary format</span>
model <span class="token operator">=</span> treelite<span class="token punctuation">.</span>frontend<span class="token punctuation">.</span>load_xgboost_model_legacy_binary<span class="token punctuation">(</span><span class="token string">"my_model.model"</span><span class="token punctuation">)</span>
<span class="token comment"># To import models generated by LightGBM, use the load_lightgbm_model() method:</span>
model <span class="token operator">=</span> treelite<span class="token punctuation">.</span>frontend<span class="token punctuation">.</span>load_lightgbm_model<span class="token punctuation">(</span><span class="token string">"lightgbm_model.txt"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>补充以下内容：</strong></p> 
<ul><li><a href="https://tl2cgen.readthedocs.io/en/latest/index.html#" rel="nofollow">TL2cgen</a>：Treelite 树编译器已迁移到 <strong>TL2cgen</strong>。TL2cgen（TreeLite 2 C 生成器）是一个决策树模型的模型编译器。您可以将任何决策树集成模型（随机森林、梯度提升模型）转换为 C 代码，并将其作为原生二进制文件分发。</li><li><a href="https://tl2cgen.readthedocs.io/en/latest/index.html#" rel="nofollow">TL2cgen</a> 与 <a href="https://treelite.readthedocs.io/en/latest/#" rel="nofollow">Treelite</a> 无缝集成。任何由 Treelite 支持的树模型都可以通过 TL2cgen 转换为 C 语言代码。TL2cgen 是一个模型编译器，<strong>能够将树模型转换为 C 代码</strong>。它可以转换所有采用 Treelite 格式存储的树模型。TL2cgen 是众多使用 Treelite 作为库的应用程序之一。</li><li>从 4.0 版本起，Treelite 停止支持将树模型编译为 C 代码，该功能已转移至 TL2cgen。从 4.0 版本起，Treelite 已转变为一个小型库，使得其他 C++ 应用程序能够在磁盘和网络上交换及存储决策树。使用 Treelite 可以帮助应用程序开发者支持多种树模型，同时减少代码重复并保持高度的准确性。<strong>树模型采用一种高效的二进制格式进行存储</strong>。</li></ul> 
<p><strong>4. 编译 Treelite 模型</strong>：</p> 
<p>为了加快部署推理速度，Treelite 需要将模型编译成高效的机器码。这一步骤通常包括指定目标平台和选择编译器选项。例如，若你打算在 CPU 上运行模型，可以采取以下步骤：</p> 
<pre><code class="prism language-python"><span class="token comment"># 编译模型为动态链接库</span>
toolchain <span class="token operator">=</span> <span class="token string">'gcc'</span>  <span class="token comment"># 或者其他你使用的编译器，如 'clang', 'msvc'</span>
tl2cgen<span class="token punctuation">.</span>export_lib<span class="token punctuation">(</span>model<span class="token punctuation">,</span> toolchain<span class="token operator">=</span>toolchain<span class="token punctuation">,</span> libpath<span class="token operator">=</span><span class="token string">"./mymodel.so"</span><span class="token punctuation">,</span> params<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'parallel_comp'</span><span class="token punctuation">:</span> <span class="token number">32</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>5. 加载编译后的模型</strong>：</p> 
<p>在生产环境中，需要加载编译后的模型文件，如动态链接库（.so 文件或 .dll 文件），使用 tl2cgen 的 Predictor 类加载 <code>.so</code> 文件。</p> 
<pre><code class="prism language-python">predictor <span class="token operator">=</span> tl2cgen<span class="token punctuation">.</span>Predictor<span class="token punctuation">(</span><span class="token string">"./mymodel.so"</span><span class="token punctuation">)</span>
</code></pre> 
<p><strong>6. 进行预测</strong>：</p> 
<p>使用编译后的模型对新数据进行预测时，需确保输入数据的格式与训练时的数据格式一致：</p> 
<pre><code class="prism language-python"><span class="token comment"># 假设 X 是特征矩阵</span>
dmat <span class="token operator">=</span> tl2cgen<span class="token punctuation">.</span>DMatrix<span class="token punctuation">(</span>X<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
out_pred <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>dmat<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>out_pred<span class="token punctuation">)</span>
</code></pre> 
<p><strong>7. 性能优化</strong>：</p> 
<p>如有必要，可对模型进行性能优化，例如通过量化参数以减少内存占用并提高推理速度。</p> 
<p><strong>8. 集成到生产环境</strong>：</p> 
<p>最后，需将编译后的模型及必要的 Treelite 运行时代码集成至生产环境，以便实际应用。</p> 
<p>请注意，具体的 API 调用和参数设置可能因模型类型和所用机器学习框架而异。务必参考 Treelite 官方文档获取最新、准确的信息。</p> 
<p><strong>总的来说，Treelite 是一款优秀的决策树集成模型部署和推理优化工具，支持将模型部署为 <code>.so</code> 文件，不仅便于其他语言调用，还能有效防止模型参数泄露。</strong></p> 
<hr> 
<p>📚️ <font face="楷体" size="4" color="black"><strong>相关链接：</strong></font></p> 
<ul><li> <p><a href="https://mp.weixin.qq.com/s/hR2Rt_amxTC8Yb42w5mlFg" rel="nofollow">AI 编译器技术剖析（三）- 树模型编译工具 Treelite 详解</a></p> </li><li> <p><a href="https://mp.weixin.qq.com/s/OhCDUH3FnkRw2rco-xrd7g" rel="nofollow">Treelite：树模型部署加速工具（支持 XGBoost、LightGBM 和 Sklearn）</a></p> </li><li> <p><a href="https://treelite.readthedocs.io/en/latest/#" rel="nofollow">Treelite is a universal model exchange and serialization format for decision tree forests.</a></p> </li><li> <p><a href="https://tl2cgen.readthedocs.io/en/latest/index.html#" rel="nofollow">TL2cgen: model compiler for decision trees</a></p> </li></ul>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6867da2574d5d967b0b66b6396fd9724/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vscod:无法读取 chrome-error://chromewebdata/ 的源映射: Unexpected 503 response from chrome-error://chromeweb</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bf9ae4b81cad01fa3eece571bd5ab0f9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring Boot中的事件驱动开发</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>