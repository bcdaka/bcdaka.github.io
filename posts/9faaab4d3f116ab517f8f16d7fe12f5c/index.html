<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Python—协程(Coroutine) - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/9faaab4d3f116ab517f8f16d7fe12f5c/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Python—协程(Coroutine)">
  <meta property="og:description" content="文档结构 1、概念简介2、使用场景3、实现方式4、代码案例5、注意事项 参考手册：https://docs.python.org/zh-cn/3.10/library/asyncio-task.html
1、概念简介 协程不是被操作系统内核所管理，而完全是由程序所控制（也就是在用户态执行），是一种用户状态内的上下文切换技术，其实就是通过一个线程实现代码块相互切换执行，因此也称为轻量级的线程。
协程的切换完全由程序控制，而非通过操作系统内核来实现，因此对资源的开销更小；
2、使用场景 通过 async &amp; awiat 实现异步编程，是Python实现异步操作的主流技术；
如果一个对象可以在 await 语句中使用，那么它就是 可等待 对象。许多 asyncio API 都被设计为接受可等待对象。
可等待 对象有三种主要类型: Coroutine(协程)，task(任务) 和 Future；
3、实现方式 1）greenlet：一个第三方模块，需要提前安装 pip3 install greenlet才能使用；
2）yield生成器：借助生成器的特点亦可以实现协程代码；
3）asyncio：在python3.4 种引入的模块，用于编写协程代码；
说明：主要通过装饰器 @asyncio.coroutine 来实现协程函数定义；Python3.8之后 @asyncio.coroutine 装饰器会被移除，推荐使用async &amp; awit 关键字实现协程代码。
4）async &amp; awiat：在python3.5中引入的两个关键字，结合asyncio模块使用；
4、代码案例 场景：目前解析一个 xml文件，需要解析的节点处理为一个列表，然后希望并发解析列表里的节点数据；
实现方式1：多线程方式
1）创建函数 parseNode(node, delay)；
2）循环该节点列表，每个节点分配一个线程去执行 parseNode(node, delay)，同时将该线程加入线程列表 thread_list；
3）循环线程列表，执行 th.join()，使主线程等待每个线程执行完成；
4）执行主线程后续步骤；
实现方式2：协程方式
代码1：直接执行协程对象
# -*- coding= utf-8 -*- &#34;&#34;&#34; @DevTool : PyCharm @Author : xxx @DateTime : 2024/1/29 15:36 @FileName : coroutineDemo.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-02T10:00:32+08:00">
    <meta property="article:modified_time" content="2024-02-02T10:00:32+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Python—协程(Coroutine)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文档结构</h4> 
 <ul><li><a href="#1_4" rel="nofollow">1、概念简介</a></li><li><a href="#2_10" rel="nofollow">2、使用场景</a></li><li><a href="#3_17" rel="nofollow">3、实现方式</a></li><li><a href="#4_30" rel="nofollow">4、代码案例</a></li><li><a href="#5_304" rel="nofollow">5、注意事项</a></li></ul> 
</div> 
<p></p> 
<p>参考手册：<a href="https://docs.python.org/zh-cn/3.10/library/asyncio-task.html" rel="nofollow">https://docs.python.org/zh-cn/3.10/library/asyncio-task.html</a></p> 
<h2><a id="1_4"></a>1、概念简介</h2> 
<p>协程不是被操作系统内核所管理，而完全是由程序所控制（也就是在用户态执行），是一种用户状态内的上下文切换技术，其实就是通过一个线程实现代码块相互切换执行，因此也称为轻量级的线程。</p> 
<p>协程的切换完全由程序控制，而非通过操作系统内核来实现，因此对资源的开销更小；</p> 
<h2><a id="2_10"></a>2、使用场景</h2> 
<p>通过 <code>async &amp; awiat</code> 实现异步编程，是Python实现异步操作的主流技术；</p> 
<p>如果一个对象可以在 await 语句中使用，那么它就是 可等待 对象。许多 asyncio API 都被设计为接受可等待对象。</p> 
<p>可等待 对象有三种主要类型: Coroutine(协程)，task(任务) 和 Future；</p> 
<h2><a id="3_17"></a>3、实现方式</h2> 
<p>1）greenlet：一个第三方模块，需要提前安装 pip3 install greenlet才能使用；</p> 
<p>2）yield生成器：借助生成器的特点亦可以实现协程代码；</p> 
<p>3）asyncio：在python3.4 种引入的模块，用于编写协程代码；</p> 
<p>说明：主要通过装饰器 <code>@asyncio.coroutine</code> 来实现协程函数定义；Python3.8之后 <code>@asyncio.coroutine</code> 装饰器会被移除，推荐使用async &amp; awit 关键字实现协程代码。</p> 
<p>4）async &amp; awiat：在python3.5中引入的两个关键字，结合asyncio模块使用；</p> 
<h2><a id="4_30"></a>4、代码案例</h2> 
<p><strong>场景</strong>：目前解析一个 xml文件，需要解析的节点处理为一个列表，然后希望并发解析列表里的节点数据；</p> 
<p>实现方式1：多线程方式<br> 1）创建函数 <code>parseNode(node, delay)</code>；<br> 2）循环该节点列表，每个节点分配一个线程去执行 <code>parseNode(node, delay)</code>，同时将该线程加入线程列表 <code>thread_list</code>；<br> 3）循环线程列表，执行 <code>th.join()</code>，使主线程等待每个线程执行完成；<br> 4）执行主线程后续步骤；</p> 
<p>实现方式2：协程方式</p> 
<p>代码1：直接执行协程对象</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding= utf-8 -*-</span>
<span class="token triple-quoted-string string">"""
@DevTool  : PyCharm
@Author   : xxx
@DateTime : 2024/1/29 15:36
@FileName : coroutineDemo.py
"""</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">parseNode</span><span class="token punctuation">(</span>th_n<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> delay<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"协程{}-开始执行!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>th_n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"协程{}-执行结束,耗时{}秒!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>th_n<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">)</span>


node_list <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"主线程-运行开始"</span><span class="token punctuation">)</span>
v_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> x <span class="token keyword">in</span> node_list<span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>parseNode<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>

v_end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"主线程-运行结束,耗时{}秒!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v_end <span class="token operator">-</span> v_start<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p>输出结果1：</p> 
<pre><code class="prism language-bash">E:<span class="token punctuation">\</span>PythonProject<span class="token punctuation">\</span>dataSpider<span class="token punctuation">\</span>venv<span class="token punctuation">\</span>Scripts<span class="token punctuation">\</span>python.exe E:/PythonProject/dataSpider/coroutineDemo.py
主线程-运行开始
协程1-开始执行<span class="token operator">!</span>
协程1-执行结束，耗时1秒<span class="token operator">!</span>
协程2-开始执行<span class="token operator">!</span>
协程2-执行结束，耗时2秒<span class="token operator">!</span>
协程3-开始执行<span class="token operator">!</span>
协程3-执行结束，耗时3秒<span class="token operator">!</span>
协程4-开始执行<span class="token operator">!</span>
协程4-执行结束，耗时4秒<span class="token operator">!</span>
协程5-开始执行<span class="token operator">!</span>
协程5-执行结束，耗时5秒<span class="token operator">!</span>
协程6-开始执行<span class="token operator">!</span>
协程6-执行结束，耗时6秒<span class="token operator">!</span>
协程7-开始执行<span class="token operator">!</span>
协程7-执行结束，耗时7秒<span class="token operator">!</span>
协程8-开始执行<span class="token operator">!</span>
协程8-执行结束，耗时8秒<span class="token operator">!</span>
协程9-开始执行<span class="token operator">!</span>
协程9-执行结束，耗时9秒<span class="token operator">!</span>
协程10-开始执行<span class="token operator">!</span>
协程10-执行结束，耗时10秒<span class="token operator">!</span>
协程11-开始执行<span class="token operator">!</span>
协程11-执行结束，耗时11秒<span class="token operator">!</span>
协程12-开始执行<span class="token operator">!</span>
协程12-执行结束，耗时12秒<span class="token operator">!</span>
协程13-开始执行<span class="token operator">!</span>
协程13-执行结束，耗时13秒<span class="token operator">!</span>
协程14-开始执行<span class="token operator">!</span>
协程14-执行结束，耗时14秒<span class="token operator">!</span>
协程15-开始执行<span class="token operator">!</span>
协程15-执行结束，耗时15秒<span class="token operator">!</span>
协程16-开始执行<span class="token operator">!</span>
协程16-执行结束，耗时16秒<span class="token operator">!</span>
协程17-开始执行<span class="token operator">!</span>
协程17-执行结束，耗时17秒<span class="token operator">!</span>
协程18-开始执行<span class="token operator">!</span>
协程18-执行结束，耗时18秒<span class="token operator">!</span>
协程19-开始执行<span class="token operator">!</span>
协程19-执行结束，耗时19秒<span class="token operator">!</span>
协程20-开始执行<span class="token operator">!</span>
协程20-执行结束，耗时20秒<span class="token operator">!</span>
主线程-运行结束,耗时210.15秒<span class="token operator">!</span>

Process finished with <span class="token builtin class-name">exit</span> code <span class="token number">0</span>
</code></pre> 
<p>从输出结果看，明显是串行执行的，下面用另外一种代码实现并行执行；</p> 
<p>代码2：执行代理主函数对象</p> 
<blockquote> 
 <p>Python 在3.7 中加入了asyncio.create_task() 函数，低版本的Python可以改用低层级的 asyncio.ensure_future() 函数；<br> asyncio.create_task() 函数用来并发运行作为 asyncio 任务 的多个协程。</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding= utf-8 -*-</span>
<span class="token triple-quoted-string string">"""
@DevTool  : PyCharm
@Author   : xxx
@DateTime : 2024/1/29 15:36
@FileName : coroutineDemo.py
"""</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">parseNode</span><span class="token punctuation">(</span>th_n<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> delay<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"协程{}-开始执行!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>th_n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"协程{}-执行结束,耗时{}秒!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>th_n<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">proxyMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    exec_list <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    task_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 任务列表</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> exec_list<span class="token punctuation">:</span>
        task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>parseNode<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        task_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span> <span class="token comment"># 将每个任务都放入任务列表</span>

    <span class="token keyword">for</span> y <span class="token keyword">in</span> task_list<span class="token punctuation">:</span>
        <span class="token keyword">await</span> y <span class="token comment"># 使主线程等待每个任务执行完成</span>


v_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"主线程-运行开始"</span><span class="token punctuation">)</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>proxyMain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
v_end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"主线程-运行结束,耗时{}秒!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v_end <span class="token operator">-</span> v_start<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p>输出结果2：</p> 
<pre><code class="prism language-bash">E:<span class="token punctuation">\</span>PythonProject<span class="token punctuation">\</span>dataSpider<span class="token punctuation">\</span>venv<span class="token punctuation">\</span>Scripts<span class="token punctuation">\</span>python.exe E:/PythonProject/dataSpider/encryptDemo.py
主线程-运行开始
协程1-开始执行<span class="token operator">!</span>
协程2-开始执行<span class="token operator">!</span>
协程3-开始执行<span class="token operator">!</span>
协程4-开始执行<span class="token operator">!</span>
协程5-开始执行<span class="token operator">!</span>
协程6-开始执行<span class="token operator">!</span>
协程7-开始执行<span class="token operator">!</span>
协程8-开始执行<span class="token operator">!</span>
协程9-开始执行<span class="token operator">!</span>
协程10-开始执行<span class="token operator">!</span>
协程11-开始执行<span class="token operator">!</span>
协程12-开始执行<span class="token operator">!</span>
协程13-开始执行<span class="token operator">!</span>
协程14-开始执行<span class="token operator">!</span>
协程15-开始执行<span class="token operator">!</span>
协程16-开始执行<span class="token operator">!</span>
协程17-开始执行<span class="token operator">!</span>
协程18-开始执行<span class="token operator">!</span>
协程19-开始执行<span class="token operator">!</span>
协程20-开始执行<span class="token operator">!</span>
协程1-执行结束，耗时1秒<span class="token operator">!</span>
协程2-执行结束，耗时2秒<span class="token operator">!</span>
协程3-执行结束，耗时3秒<span class="token operator">!</span>
协程4-执行结束，耗时4秒<span class="token operator">!</span>
协程5-执行结束，耗时5秒<span class="token operator">!</span>
协程6-执行结束，耗时6秒<span class="token operator">!</span>
协程7-执行结束，耗时7秒<span class="token operator">!</span>
协程8-执行结束，耗时8秒<span class="token operator">!</span>
协程9-执行结束，耗时9秒<span class="token operator">!</span>
协程10-执行结束，耗时10秒<span class="token operator">!</span>
协程11-执行结束，耗时11秒<span class="token operator">!</span>
协程12-执行结束，耗时12秒<span class="token operator">!</span>
协程13-执行结束，耗时13秒<span class="token operator">!</span>
协程14-执行结束，耗时14秒<span class="token operator">!</span>
协程15-执行结束，耗时15秒<span class="token operator">!</span>
协程16-执行结束，耗时16秒<span class="token operator">!</span>
协程17-执行结束，耗时17秒<span class="token operator">!</span>
协程18-执行结束，耗时18秒<span class="token operator">!</span>
协程19-执行结束，耗时19秒<span class="token operator">!</span>
协程20-执行结束，耗时20秒<span class="token operator">!</span>
主线程-运行结束,耗时20.01秒<span class="token operator">!</span>

Process finished with <span class="token builtin class-name">exit</span> code <span class="token number">0</span>


</code></pre> 
<p>从输出结果看，执行时间从之前的 210秒 降到了20秒；<br> 说明：上述代码中必须先全部使用 create_task任务，然后在调用每个任务；</p> 
<p>代码3：asyncio.gather(task)任务组</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding= utf-8 -*-</span>
<span class="token triple-quoted-string string">"""
@DevTool  : PyCharm
@Author   : xxx
@DateTime : 2024/1/29 15:36
@FileName : coroutineDemo.py
"""</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">parseNode</span><span class="token punctuation">(</span>th_n<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> delay<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"协程{}-开始执行!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>th_n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"协程{}-执行结束,耗时{}秒!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>th_n<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">proxyMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    exec_list <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    task_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 任务列表</span>
    task_set <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> exec_list<span class="token punctuation">:</span>
        task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>parseNode<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        task_set <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span>task<span class="token punctuation">)</span>  <span class="token comment"># 将每个任务都放入任务列表</span>

    <span class="token keyword">await</span> task_set


v_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"主线程-运行开始"</span><span class="token punctuation">)</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>proxyMain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
v_end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"主线程-运行结束,耗时{}秒!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v_end <span class="token operator">-</span> v_start<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<p>代码4：</p> 
<blockquote> 
 <p>python 在 3.11 版本加入了 <code>asyncio.TaskGroup</code>类，提供了<code>create_task()</code> 更现代化的替代；</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding= utf-8 -*-</span>
<span class="token triple-quoted-string string">"""
@DevTool  : PyCharm
@Author   : gzh
@DateTime : 2024/2/1 15:57
@FileName : coroutDemo.py
"""</span>

<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">parseNode</span><span class="token punctuation">(</span>th_n<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> delay<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"协程{}-开始执行!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>th_n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"协程{}-执行结束,耗时{}秒!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>th_n<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">proxyMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    exec_list <span class="token operator">=</span> <span class="token punctuation">[</span>x <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> asyncio<span class="token punctuation">.</span>TaskGroup<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tg<span class="token punctuation">:</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> exec_list<span class="token punctuation">:</span>
           task <span class="token operator">=</span>  tg<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>parseNode<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>


v_start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"主线程-运行开始"</span><span class="token punctuation">)</span>
asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>proxyMain<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
v_end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"主线程-运行结束,耗时{}秒!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v_end <span class="token operator">-</span> v_start<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<h2><a id="5_304"></a>5、注意事项</h2> 
<p>1）直接调用一个使用 async 定义的函数，是不会执行的；<br> 2）协程执行的业务代码一般不会写在主函数中，而是定义个代理主函数；即通过一个协程调用其他协程；</p> 
<p>============================================ over ==========================================</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4a1bf83a618ac3858380f77f9c279e19/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL中的`longtext`与`longblob`：深度剖析与应用场景</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a0bc236e09bb0449d96cb2a1c691b26b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Spring boot整合sse（使用详解）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>