<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kafka集群之-ZooKeeper未授权访问漏洞修复 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/f577ec291acb0dafa8c5943fabe4e377/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Kafka集群之-ZooKeeper未授权访问漏洞修复">
  <meta property="og:description" content="ZooKeeper 配置修改 一、修改 zoo.cfg 配置 ZooKeeper 的配置文件，修改 /usr/local/zookeeper/conf/zoo.cfg 文件，添加以下内容：
authProvider.1=org.apache.zookeeper.server.auth.SASLAuthenticationProvider jaasLoginRenew=3600000 requireClientAuthScheme=sasl zookeeper.sasl.client=true sessionRequireClientSASLAuth=true 二、创建 JAAS 文件 在 ZooKeeper 的安装目录下的 conf 目录中创建 zk_jaas.conf 文件，并编辑内容如下：
abnf复制代码Server { org.apache.zookeeper.server.auth.DigestLoginModule required username=&#34;admin&#34; password=&#34;admin&#34; user_admin=&#34;admin&#34;; }; Client { org.apache.zookeeper.server.auth.DigestLoginModule required username=&#34;admin&#34; password=&#34;admin&#34;; }; user_admin=&#34;admin&#34; 的含义是 user_username=&#34;password&#34;，添加一个用户名为 admin，密码为 admin 的认证用户，用户名和密码可以自行定义。
三、配置 ZooKeeper 客户端环境变量 因为如果要连接 ZooKeeper 是需要通过 SASL 认证的，所以需要配置环境变量，这里的环境变量主要是使用 zk_jaas.conf 文件中的 Client 配置，会在连接时使用用户名和密码。
在 zkEnv.sh 文件的最后添加一行： export JVMFLAGS=&#34;-Djava.security.auth.login.config=/usr/local/zookeeper/conf/zk_jaas.conf ${JVMFLAGS}&#34; 四、重启 ZooKeeper 服务 重启 ZooKeeper 服务，正常启动一般便无问题。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-07-01T15:14:13+08:00">
    <meta property="article:modified_time" content="2024-07-01T15:14:13+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kafka集群之-ZooKeeper未授权访问漏洞修复</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="ZooKeeper__0"></a>ZooKeeper 配置修改</h4> 
<h5><a id="_zoocfg_2"></a>一、修改 <code>zoo.cfg</code></h5> 
<p>配置 ZooKeeper 的配置文件，修改 <code>/usr/local/zookeeper/conf/zoo.cfg</code> 文件，添加以下内容：</p> 
<pre><code class="prism language-ini">authProvider.1=org.apache.zookeeper.server.auth.SASLAuthenticationProvider
jaasLoginRenew=3600000
requireClientAuthScheme=sasl
zookeeper.sasl.client=true
sessionRequireClientSASLAuth=true
</code></pre> 
<h5><a id="_JAAS__14"></a>二、创建 JAAS 文件</h5> 
<p>在 ZooKeeper 的安装目录下的 <code>conf</code> 目录中创建 <code>zk_jaas.conf</code> 文件，并编辑内容如下：</p> 
<pre><code class="prism language-ini">abnf复制代码Server {
   org.apache.zookeeper.server.auth.DigestLoginModule required
   username="admin"
   password="admin"
   user_admin="admin";
};

Client {
   org.apache.zookeeper.server.auth.DigestLoginModule required
   username="admin"
   password="admin";
};
</code></pre> 
<p><code>user_admin="admin"</code> 的含义是 <code>user_username="password"</code>，添加一个用户名为 <code>admin</code>，密码为 <code>admin</code> 的认证用户，用户名和密码可以自行定义。</p> 
<h5><a id="_ZooKeeper__35"></a>三、配置 ZooKeeper 客户端环境变量</h5> 
<p>因为如果要连接 ZooKeeper 是需要通过 SASL 认证的，所以需要配置环境变量，这里的环境变量主要是使用 <code>zk_jaas.conf</code> 文件中的 <code>Client</code> 配置，会在连接时使用用户名和密码。</p> 
<h2><a id="_zkEnvsh__39"></a>在 zkEnv.sh 文件的最后添加一行：</h2> 
<pre><code class="prism language-ini">export JVMFLAGS="-Djava.security.auth.login.config=/usr/local/zookeeper/conf/zk_jaas.conf ${JVMFLAGS}"
</code></pre> 
<h5><a id="_ZooKeeper__45"></a>四、重启 ZooKeeper 服务</h5> 
<p>重启 ZooKeeper 服务，正常启动一般便无问题。</p> 
<h5><a id="_ZooKeeper__49"></a>五、通过客户端连接文件连接 ZooKeeper 服务</h5> 
<pre><code>复制代码/usr/local/zookeeper/bin/zkCli.sh -server {hostname}:{port}
例如：./zkCli.sh -server 192.168.2.2:2181
</code></pre> 
<p>一般连接成功会有如下日志显示：<br> <img src="https://images2.imgbox.com/b9/e3/0VnBJfRi_o.png" alt="在这里插入图片描述"></p> 
<p>有较明显的 <code>Will attempt to SASL-authenticate using Login Context section 'Client'</code> 的提示，至此 ZooKeeper 的 SASL 配置完毕。</p> 
<h5><a id="_61"></a>六、如何设置权限</h5> 
<p>ZooKeeper 的 SASL 和普通的认证授权还不太一样。</p> 
<ol><li>ZooKeeper 默认允许匿名用户访问，如果不想让匿名用户访问某些节点，则需要给节点单独设置 ACL 权限，配置完 SASL 后，连接 ZooKeeper 客户端，然后可以给每个节点设置 ACL 权限：</li></ol> 
<pre><code class="prism language-ini">setAcl /path sasl:admin:crdwa
</code></pre> 
<ol><li>ZooKeeper 的 3.6.0 版本之后新增了一个环境变量 <code>sessionRequireClientSASLAuth</code>，这个环境变量为 <code>true</code> 时要求客户端连接 ZooKeeper 时必须进行 SASL 认证才可以连接成功，也就是说没有进行 SASL 认证的匿名用户就无法连接了，比第一步给每个节点设置 ACL 更方便一些，相当于在连接时设置了一个登录密码。</li></ol> 
<p>可以在单机版的 <code>zoo.cfg</code> 或嵌入式的 <code>zookeeper.properties</code> 里添加如下配置：</p> 
<pre><code class="prism language-ini">sessionRequireClientSASLAuth=true
</code></pre> 
<h5><a id="Kafka__79"></a>七、Kafka 如何连接</h5> 
<p>配置完以上的认证后，启动 Kafka 可能会报错。原因是因为 Kafka 依赖于 ZooKeeper，要进行节点的访问，但是配置完后 Kafka 也失去了权限，因此无法正常启动。</p> 
<p>解决方法：在 Kafka 安装目录下的 <code>bin/kafka-run-class.class</code> 目录下添加环境变量，如下：</p> 
<pre><code class="prism language-ini">sh复制代码# ...前面的内容省略
base_dir=$(dirname $0)/..
KAFKA_OPTS="-Djava.security.auth.login.config=/usr/local/zookeeper/conf/zk_jaas.conf ${KAFKA_OPTS}" # 要添加的行

if [ -z "$SCALA_VERSION" ]; then
  SCALA_VERSION=2.12.10
fi
</code></pre> 
<p>然后重启 Kafka 即可解决，如下图：<br> <img src="https://images2.imgbox.com/ad/d6/gnI1OwM3_o.png" alt="在这里插入图片描述"></p> 
<p>原理和 ZooKeeper 客户端连接原理一样，需要配置连接时的 Client 的用户名和密码，用户名和密码都在 <code>zk_jaas.conf</code> 文件里。</p> 
<h3><a id="_99"></a>参考资料</h3> 
<ul><li><a href="https://www.cnblogs.com/iamsach/p/9234624.html" rel="nofollow">Kafka 安装及开启 SASL_PLAINTEXT 认证（用户名和密码认证）</a></li><li><a href="https://www.cnblogs.com/mysticbinary/p/13536093.html" rel="nofollow">ZooKeeper 未授权访问漏洞确认与修复</a></li><li><a href="https://www.cnblogs.com/kuku0223/p/8428341.html" rel="nofollow">ZooKeeper 四字命令</a></li><li><a href="https://www.bilibili.com/read/cv11773508/" rel="nofollow">ZooKeeper 和 Kafka 安全配置</a></li></ul> 
<p>如有任何问题，请随时联系我！</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7b28745119091b50d130fb321d5c6b52/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">WSL——忘记root密码（Ubuntu）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2d79af4f8cf9ef8356a76b7e7674765a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Spring】Spring Security 核心类介绍及Spring Security 的验证机制</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>