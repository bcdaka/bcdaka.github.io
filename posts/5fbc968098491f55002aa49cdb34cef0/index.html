<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>通义千文大模型API调用示例(python) - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/5fbc968098491f55002aa49cdb34cef0/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="通义千文大模型API调用示例(python)">
  <meta property="og:description" content="API详情 通义千问是阿里云自主研发的大语言模型，能够在用户自然语言输入的基础上，通过自然语言理解和语义分析，理解用户意图，在不同领域、任务内为用户提供服务和帮助。您可以通过提供尽可能清晰详细的指令，来获取更符合您预期的结果。
模型具备的能力包括但不限于：
创作文字，如写故事、写公文、写邮件、写剧本、写诗歌等编写代码提供各类语言的翻译服务，如英语、日语、法语、西班牙语等进行文本润色和文本摘要等工作扮演角色进行对话制作图表 通义千问以用户以文本形式输入的指令（prompt）以及不定轮次的对话历史（history）作为输入，返回模型生成的回复作为输出。在这一过程中，文本将被转换为语言模型可以处理的token序列。Token是模型用来表示自然语言文本的基本单位，可以直观的理解为“字”或“词”。对于中文文本来说，1个token通常对应一个汉字；对于英文文本来说，1个token通常对应3至4个字母或1个单词。例如，中文文本“你好，我是通义千问”会被转换成序列[‘你’, ‘好’, ‘，’, ‘我’, ‘是’, ‘通’, ‘义’, ‘千’, ‘问’]，而英文文本&#34;Nice to meet you.&#34;则会被转换成[‘Nice’, ’ to’, ’ meet’, ’ you’, ‘.’]。
目前(2023-12-15)API调用免费，具体截止时间还没有通知，大家赶快尝试一下！！！
官网文档：点击查看
模型概览 模型名模型简介模型输入输出限制qwen-turbo通义千问超大规模语言模型，支持中文英文等不同语言输入。模型支持 8k tokens上下文，为了保障正常的使用和输出，API限定用户输入为6k tokens。qwen-plus通义千问超大规模语言模型增强版，支持中文英文等不同语言输入。模型支持 32k tokens上下文，为了保障正常的使用和输出，API限定用户输入为 30k tokens。qwen-max （限时免费开放中）通义千问千亿级别超大规模语言模型，支持中文英文等不同语言输入。随着模型的升级，qwen-max将滚动更新升级，如果希望使用稳定版本，请使用qwen-max-1201。模型支持 8k tokens上下文，为了保障正常的使用和输出，API限定用户输入为6k tokens。qwen-max-1201 （限时免费开放中）通义千问千亿级别超大规模语言模型，支持中文英文等不同语言输入。该模型为qwen-max的快照稳定版本，预期维护到下个快照版本发布时间（待定）后一个月。模型支持 8k tokens上下文，为了保障正常的使用和输出，API限定用户输入为6k tokens。qwen-max-longcontext （限时免费开放中）通义千问千亿级别超大规模语言模型，支持中文英文等不同语言输入。模型支持 30k tokens上下文，为了保障正常的使用和输出，API限定用户输入为 28k tokens。qwen-vl-plus通义千问VL plus支持灵活的交互方式，包括多图、多轮问答、创作等能力的模型，大幅提升了图片文字处理能力，增加可处理分辨率范围，增强视觉推理和决策能力- 开通DashScope并创建API-KEY API-KEY创建说明
说明：需要通过阿里云主账号或者得到主账号AliyunDashScopeFullAccess授权的子账号进行DashScope模型服务的开通及API-KEY的创建。
开通DashScope灵积模型服务 访问DashScope管理控制台：前往控制台。
创建API-KEY 访问DashScope管理控制台API-KEY管理页面：前往API-KEY管理，然后点击“创建新的API-KEY”。
API-KEY添加至系统变量 新建用户变量输入变量名(可以自定义)：DASHSCOPE_API_KEY输入变量值(API-KEY)：直接复制
Python调用示例 import os import time import json import random from http import HTTPStatus import dashscope from dashscope import Generation from dashscope.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-26T16:38:45+08:00">
    <meta property="article:modified_time" content="2024-03-26T16:38:45+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">通义千文大模型API调用示例(python)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="API_0"></a>API详情</h3> 
<p>通义千问是阿里云自主研发的大语言模型，能够在用户自然语言输入的基础上，通过自然语言理解和语义分析，理解用户意图，在不同领域、任务内为用户提供服务和帮助。您可以通过提供尽可能清晰详细的指令，来获取更符合您预期的结果。</p> 
<p>模型具备的能力包括但不限于：</p> 
<ol><li>创作文字，如写故事、写公文、写邮件、写剧本、写诗歌等</li><li>编写代码</li><li>提供各类语言的翻译服务，如英语、日语、法语、西班牙语等</li><li>进行文本润色和文本摘要等工作</li><li>扮演角色进行对话</li><li>制作图表</li></ol> 
<p>通义千问以用户以文本形式输入的指令（prompt）以及不定轮次的对话历史（history）作为输入，返回模型生成的回复作为输出。在这一过程中，文本将被转换为语言模型可以处理的token序列。Token是模型用来表示自然语言文本的基本单位，可以直观的理解为“字”或“词”。对于中文文本来说，1个token通常对应一个汉字；对于英文文本来说，1个token通常对应3至4个字母或1个单词。例如，中文文本“你好，我是通义千问”会被转换成序列[‘你’, ‘好’, ‘，’, ‘我’, ‘是’, ‘通’, ‘义’, ‘千’, ‘问’]，而英文文本"Nice to meet you."则会被转换成[‘Nice’, ’ to’, ’ meet’, ’ you’, ‘.’]。</p> 
<p><strong>目前(2023-12-15)API调用免费，具体截止时间还没有通知，大家赶快尝试一下！！！</strong><br> 官网文档：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/api-details?accounttraceid=e6d078e75aef4be4a592b85709a214e7jukg" rel="nofollow">点击查看</a></p> 
<h3><a id="_15"></a>模型概览</h3> 
<table><thead><tr><th>模型名</th><th>模型简介</th><th>模型输入输出限制</th></tr></thead><tbody><tr><td>qwen-turbo</td><td>通义千问超大规模语言模型，支持中文英文等不同语言输入。</td><td>模型支持 8k tokens上下文，为了保障正常的使用和输出，API限定用户输入为6k tokens。</td></tr><tr><td>qwen-plus</td><td>通义千问超大规模语言模型增强版，支持中文英文等不同语言输入。</td><td>模型支持 32k tokens上下文，为了保障正常的使用和输出，API限定用户输入为 30k tokens。</td></tr><tr><td>qwen-max <br>（限时免费开放中）</td><td><strong>通义千问千亿级别超大规模语言模型</strong>，支持中文英文等不同语言输入。随着模型的升级，qwen-max将滚动更新升级，如果希望使用稳定版本，请使用qwen-max-1201。</td><td>模型支持 8k tokens上下文，为了保障正常的使用和输出，API限定用户输入为6k tokens。</td></tr><tr><td>qwen-max-1201 <br>（限时免费开放中）</td><td><strong>通义千问千亿级别超大规模语言模型</strong>，支持中文英文等不同语言输入。该模型为qwen-max的快照稳定版本，预期维护到下个快照版本发布时间（待定）后一个月。</td><td>模型支持 8k tokens上下文，为了保障正常的使用和输出，API限定用户输入为6k tokens。</td></tr><tr><td>qwen-max-longcontext <br>（限时免费开放中）</td><td><strong>通义千问千亿级别超大规模语言模型</strong>，支持中文英文等不同语言输入。</td><td>模型支持 30k tokens上下文，为了保障正常的使用和输出，API限定用户输入为 28k tokens。</td></tr><tr><td>qwen-vl-plus</td><td>通义千问VL plus支持灵活的交互方式，包括多图、多轮问答、创作等能力的模型，大幅提升了图片文字处理能力，增加可处理分辨率范围，增强视觉推理和决策能力</td><td>-</td></tr></tbody></table> 
<h3><a id="DashScopeAPIKEY_25"></a>开通DashScope并创建API-KEY</h3> 
<p><a href="https://help.aliyun.com/zh/dashscope/developer-reference/activate-dashscope-and-create-an-api-key?spm=a2c4g.11186623.0.i4" rel="nofollow">API-KEY创建说明</a><br> <strong>说明</strong>：需要通过阿里云主账号或者得到主账号AliyunDashScopeFullAccess授权的子账号进行DashScope模型服务的开通及API-KEY的创建。</p> 
<h4><a id="DashScope_29"></a>开通DashScope灵积模型服务</h4> 
<p>访问DashScope管理控制台：<a href="https://dashscope.console.aliyun.com/overview?spm=a2c4g.11186623.0.0.620512b0RS0t6i" rel="nofollow">前往控制台</a>。<br> <img src="https://images2.imgbox.com/3e/e4/0UvyUa3S_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e6/47/8ZARS902_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="APIKEY_33"></a>创建API-KEY</h4> 
<p>访问DashScope管理控制台API-KEY管理页面：<a href="https://dashscope.console.aliyun.com/api-key_management?spm=a2c4g.11186623.0.0.620512b0RS0t6i" rel="nofollow">前往API-KEY管理</a>，然后点击“创建新的API-KEY”。<br> <img src="https://images2.imgbox.com/2f/b4/PpyBx3Su_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ed/33/EOkTpwGh_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="APIKEY_37"></a>API-KEY添加至系统变量</h4> 
<ol><li>新建用户变量</li><li>输入变量名(可以自定义)：DASHSCOPE_API_KEY</li><li>输入变量值(API-KEY)：直接复制<br> <img src="https://images2.imgbox.com/dd/89/u9SivcGB_o.png" alt="在这里插入图片描述"></li></ol> 
<h3><a id="Python_42"></a>Python调用示例</h3> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> json
<span class="token keyword">import</span> random
<span class="token keyword">from</span> http <span class="token keyword">import</span> HTTPStatus
<span class="token keyword">import</span> dashscope
<span class="token keyword">from</span> dashscope <span class="token keyword">import</span> Generation
<span class="token keyword">from</span> dashscope<span class="token punctuation">.</span>api_entities<span class="token punctuation">.</span>dashscope_response <span class="token keyword">import</span> Role

<span class="token comment"># 两种方式调用api-key</span>
key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"DASHSCOPE_API_KEY"</span><span class="token punctuation">)</span>  <span class="token comment"># 调用时需要手动添加key</span>
dashscope<span class="token punctuation">.</span>api_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"DASHSCOPE_API_KEY"</span><span class="token punctuation">)</span>  <span class="token comment"># 不需要手动添加key</span>
</code></pre> 
<p><strong>流式输出</strong></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">call_with_stream</span><span class="token punctuation">(</span>question<span class="token punctuation">)</span><span class="token punctuation">:</span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>question<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    responses <span class="token operator">=</span> Generation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>
        model<span class="token operator">=</span><span class="token string">'qwen-max-1201'</span><span class="token punctuation">,</span>
        max_tokens<span class="token operator">=</span><span class="token number">1500</span><span class="token punctuation">,</span>
        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>
        result_format<span class="token operator">=</span><span class="token string">'message'</span><span class="token punctuation">,</span>
        stream<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        incremental_output<span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token punctuation">)</span>
    full_content <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">for</span> response <span class="token keyword">in</span> responses<span class="token punctuation">:</span>
        <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> HTTPStatus<span class="token punctuation">.</span>OK<span class="token punctuation">:</span>
            full_content <span class="token operator">+=</span> response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
            api_reports<span class="token punctuation">(</span>response<span class="token punctuation">,</span> question<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Request id: %s, Status code: %s, error code: %s, error message: %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>
                response<span class="token punctuation">.</span>request_id<span class="token punctuation">,</span> response<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span>
                response<span class="token punctuation">.</span>code<span class="token punctuation">,</span> response<span class="token punctuation">.</span>message
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>question<span class="token punctuation">}</span></span><span class="token string">:\n\n'</span></span> <span class="token operator">+</span> full_content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">api_reports</span><span class="token punctuation">(</span>output_response<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time_now <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y年%m月%d日%H点%M分%S秒'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'大模型调用记录/通义千文/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>text<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>time_now<span class="token punctuation">}</span></span><span class="token string">.json'</span></span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span>
    output_json <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>output_response<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>output_json<span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">text <span class="token operator">=</span> <span class="token string">'为什么我保存response的json文件，content为空'</span>
call_with_stream<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/db/32/JkIx0o1Y_o.png" alt="在这里插入图片描述"><br> <strong>简单多模态</strong><br> <img src="https://images2.imgbox.com/0f/44/Aa2GnMhH_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">simple_multimodal_conversation_call</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>question<span class="token punctuation">)</span><span class="token punctuation">:</span>
    messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
            <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span><span class="token string">"image"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>img<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span><span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>question<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
    response <span class="token operator">=</span> dashscope<span class="token punctuation">.</span>MultiModalConversation<span class="token punctuation">.</span>call<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">'qwen-vl-plus'</span><span class="token punctuation">,</span>
                                                     messages<span class="token operator">=</span>messages<span class="token punctuation">)</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>status_code <span class="token operator">==</span> HTTPStatus<span class="token punctuation">.</span>OK<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>output<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'message'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>code<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">img <span class="token operator">=</span> <span class="token string">'https://dashscope.oss-cn-beijing.aliyuncs.com/images/dog_and_girl.jpeg'</span>
text <span class="token operator">=</span> <span class="token string">'这是什么？'</span>
simple_multimodal_conversation_call<span class="token punctuation">(</span>img<span class="token punctuation">,</span> text<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/25/ac/fx1y2VPE_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_124"></a>参考</h3> 
<p>官网文档：<a href="https://help.aliyun.com/zh/dashscope/developer-reference/api-details#8d583410d7so6" rel="nofollow">https://help.aliyun.com/zh/dashscope/developer-reference/api-details#8d583410d7so6</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/925b43542ec0215b08f61140e4bb82ef/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【Android】系统启动流程分析 —— Zygote 进程启动过程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7c1f9fdad7eaf335982f6bb479d955a2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">软件测试|解决 Git Push 出现 “error: failed to push some refs to“错误</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>