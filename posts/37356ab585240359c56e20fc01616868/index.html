<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C#ListView的单元格支持添加基本及自定义任意控件 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/37356ab585240359c56e20fc01616868/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="C#ListView的单元格支持添加基本及自定义任意控件">
  <meta property="og:description" content="功能说明 使用ListView时，希望可以在单元格显示图片或其他控件，发现原生的ListView不支持，于是通过拓展，实现ListView可以显示任意控件的功能，效果如下：
实现方法 本来想着在单元格里面实现控件的自绘的，但是没找到办法，最后是通过在单元格的表面显示对应控件的，浮于表面达到目的。
实现要点如下：
ListView需要设置OwnerDraw=true，并重载自绘函数OnDrawColumnHeader、OnDrawItem、OnDrawSubItem支持按单元格添加对应的控件，其Parent设置为列表ListView列表界面调整后，包括大小、列表头、滚动等，需重新绘制单元格的控件 实现源码 using System; using System.Collections.Generic; using System.Drawing; using System.Linq; using System.Text; using System.Threading.Tasks; using System.Windows.Forms; namespace MyListView.Ui { #region ListViewEx public class ListViewEx : ListView { #region 内部属性 /// &lt;summary&gt; /// 存放单元格控件 /// &lt;/summary&gt; List&lt;Control&gt; _CellControls = new List&lt;Control&gt;(); /// &lt;summary&gt; /// 界面是否发生变化 /// &lt;/summary&gt; bool IsViewChanged { get; set; } #endregion #region 方法 /// &lt;summary&gt; /// 构造函数 /// &lt;/summary&gt; public ListViewEx() { #region 初始化 #endregion #region 事件 this.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-18T13:32:16+08:00">
    <meta property="article:modified_time" content="2024-06-18T13:32:16+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C#ListView的单元格支持添加基本及自定义任意控件</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>功能说明</h3> 
<p>使用ListView时，希望可以在单元格显示图片或其他控件，发现原生的ListView不支持，于是通过拓展，实现ListView可以显示任意控件的功能，效果如下：<br> <img src="https://images2.imgbox.com/c6/b9/zqsx2E0B_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_4"></a>实现方法</h3> 
<p>本来想着在单元格里面实现控件的自绘的，但是没找到办法，最后是通过在单元格的表面显示对应控件的，浮于表面达到目的。<br> 实现要点如下：</p> 
<ul><li><code>ListView</code>需要设置<code>OwnerDraw=true</code>，并重载自绘函数<code>OnDrawColumnHeader</code>、<code>OnDrawItem</code>、<code>OnDrawSubItem</code></li><li>支持按单元格添加对应的控件，其<code>Parent</code>设置为列表<code>ListView</code></li><li>列表界面调整后，包括大小、列表头、滚动等，需重新绘制单元格的控件</li></ul> 
<h3><a id="_11"></a>实现源码</h3> 
<pre><code class="prism language-c#">using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace MyListView.Ui
{
    #region ListViewEx
    public class ListViewEx : ListView
    {
        #region 内部属性
        /// &lt;summary&gt;
        /// 存放单元格控件
        /// &lt;/summary&gt;
        List&lt;Control&gt; _CellControls = new List&lt;Control&gt;();
        /// &lt;summary&gt;
        /// 界面是否发生变化
        /// &lt;/summary&gt;
        bool IsViewChanged { get; set; }
        #endregion

        #region 方法
        /// &lt;summary&gt;
        /// 构造函数
        /// &lt;/summary&gt;
        public ListViewEx()
        {
            #region 初始化
            #endregion

            #region 事件
            this.ColumnReordered += ColumnWidthChangedHandler;
            this.ColumnWidthChanged += ColumnWidthChangedHandler;
            #endregion
        }

        /// &lt;summary&gt;
        /// 添加控件
        /// &lt;/summary&gt;
        /// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
        /// &lt;param name="row"&gt;&lt;/param&gt;
        /// &lt;param name="col"&gt;&lt;/param&gt;
        /// &lt;param name="c"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public T Add&lt;T&gt;(int row, int col, T c) where T : Control
        {
            if(row &gt;= this.Items.Count || col &gt;= this.Columns.Count)
            {
                return null;
            }

            var index = (row * this.Columns.Count) + col;
            for (var i = _CellControls.Count; i &lt;= index; i++)
            {
                _CellControls.Add(null);
            }
            var oc = _CellControls[index];
            if (oc != null)
            {
                oc.Dispose();
            }
            OwnerDraw = true;
            IsViewChanged = true;
            c.Parent = this;
            _CellControls[index] = c;
            return c;
        }

        /// &lt;summary&gt;
        /// 设置行高度
        /// &lt;/summary&gt;
        /// &lt;param name="height"&gt;&lt;/param&gt;
        public void SetItemHeight(int height)
        {
            if(this.SmallImageList == null)
            {
                this.SmallImageList = new ImageList();
            }
            this.SmallImageList.ImageSize = new Size(1, height);
        }
        #endregion

        #region 内部函数
        void ColumnWidthChangedHandler(object s, EventArgs e)
        {
            IsViewChanged = true;
        }
        /// &lt;summary&gt;
        /// 显示控件到目标单元格
        /// &lt;/summary&gt;
        /// &lt;param name="c"&gt;&lt;/param&gt;
        /// &lt;param name="item"&gt;&lt;/param&gt;
        void ShowCellControl(Control c, ListViewItem.ListViewSubItem item)
        {
            int margin = 2;
            c.Text = item.Text;
            c.Visible = true;
            c.Bounds = new Rectangle(item.Bounds.X + margin,
                item.Bounds.Top + margin,
                item.Bounds.Width - 2 * margin,
                item.Bounds.Height - 2 * margin);
        }

        /// &lt;summary&gt;
        /// 显示单元格控件
        /// &lt;/summary&gt;
        /// &lt;param name="e"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        Control GetCellControl(DrawListViewSubItemEventArgs e)
        {
            Control c = null;
            #region 获取控件
            var index = (e.ItemIndex * this.Columns.Count) + e.ColumnIndex;
            if (index &gt;= _CellControls.Count)
            {
                return null;
            }
            c = _CellControls[index];
            #endregion
            return c;
        }


        protected override void WndProc(ref Message m)
        {
            #region 事件定义
            const int WM_SIZE = 0x0005;
            const int WM_PAINT = 0x000F;
            const int WM_HSCROLL = 0x114;
            const int WM_VSCROLL = 0x115;
            const int WM_MOUSEWHEEL = 0x020A;
            #endregion

            #region 重绘显示控件
            if (m.Msg == WM_PAINT &amp;&amp; IsViewChanged)
            {
                if(this.Columns.Count &gt; 0)
                {
                    for (var i = 0; i &lt; _CellControls.Count; i++)
                    {
                        var cell_control = _CellControls[i];
                        if (cell_control == null)
                        {
                            continue;
                        }
                        cell_control.Visible = false;
                        var row = i / this.Columns.Count;
                        var col = i % this.Columns.Count;
                        if(row &gt;= Items.Count || col &gt;= this.Columns.Count)
                        {
                            continue;
                        }
                        var item = this.Items[row];
                        if(item.Bounds.Y &lt; 0 || item.Bounds.Y &gt;= this.Height)
                        {
                            continue;
                        }
                        if(item.SubItems[col].Bounds.X &lt; 0 || item.SubItems[col].Bounds.X &gt;= this.Width)
                        {
                            continue;
                        }
                        ShowCellControl(cell_control, item.SubItems[col]);
                    }
                    IsViewChanged = false;
                }
            }
            else if(m.Msg == WM_HSCROLL || m.Msg == WM_VSCROLL || m.Msg == WM_MOUSEWHEEL || m.Msg == WM_SIZE)
            {
                IsViewChanged = true;
            }
            #endregion
            base.WndProc(ref m);
        }

        protected override void OnDrawColumnHeader(DrawListViewColumnHeaderEventArgs e)
        {
            e.DrawDefault = true;
        }

        protected override void OnDrawItem(DrawListViewItemEventArgs e)
        {
            // 已经在OnDrawSubItem处理过了
            // e.DrawText(TextFormatFlags.Default);
        }

        protected override void OnDrawSubItem(DrawListViewSubItemEventArgs e)
        {
            if(GetCellControl(e) != null)
            {
                return;
            }
            else
            {
                e.DrawDefault = true;
            }
        }
        #endregion
    }
    #endregion
}
</code></pre> 
<h3><a id="_218"></a>测试代码</h3> 
<pre><code class="prism language-C#">using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace MyListView
{
    public partial class Form1 : Form
    {
        #region 函数
        public Form1()
        {
            #region 布局初始化
            InitializeComponent();
            var lv = new Ui.ListViewEx()
            {
                Dock = DockStyle.Fill,
                View = View.Details,
                GridLines = true,
            };
            this.Controls.Add(lv);
            var headers = new string[] { "序号", "名称", "年龄", "住址", "荣誉", "岗位", "头像" };
            foreach(var v in headers)
            {
                lv.Columns.Add(v, 100, HorizontalAlignment.Center);
            }
            lv.SetItemHeight(40);
            for(var i=0; i&lt;50; i++)
            {
                var lvi = lv.Items.Add($"数据{i + 1}");
                for(var j=1; j&lt;lv.Columns.Count; j++)
                {
                    lvi.SubItems.Add($"数据{i + 1}-{j}");
                    switch(j)
                    {
                        case 1:
                            lv.Add(i, j, new Label());
                            break;
                        case 2:
                            lv.Add(i, j, new Button());
                            break;
                        case 3:
                            lv.Add(i, j, new TextBox()
                            {
                                Font = new Font("宋体", 18)
                            });
                            break;
                        case 4:
                            lv.Add(i, j, new ComboBox()
                            {
                                Font = new Font("宋体", 18)
                            });
                            break;
                        case 6:
                            {
                                var pic = lv.Add(i, j, new PictureBox());
                                pic.Image = LoadImage($"logo{i%7}.jpg");
                                pic.SizeMode = PictureBoxSizeMode.StretchImage;
                            }
                            break;
                    }
                }
            }
            #endregion
        }

        Image LoadImage(string name)
        {
            var file = Path.GetFullPath(Path.Combine(@"..\..\Data\IMG", name));
            if(!File.Exists(file))
            {
                return null;
            }
            return Image.FromFile(file);
        }
        #endregion
    }
}
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3573528397cdcef7085346e8b9245c1a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">编程猫怎么编程汽车：探索虚拟与现实交汇的编程之旅</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/41ccfdb50edb4fdec321d18235c4dca2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">利用Python进行音频信号处理和音乐生成</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>