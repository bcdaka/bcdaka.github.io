<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kafka之RecordAccumulator - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/505b44d54af84112c8bc1c9e578a8c90/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Kafka之RecordAccumulator">
  <meta property="og:description" content="这篇文章将主要介绍 Kafka 生产者中的 RecordAccumulator。RecordAccumlator 负责对生产者将要发送的消息进行分组缓存，其内部对每个 topic 维持了一个 TopicInfo 来存储缓存的消息，TopicInfo 内部对该 topic 的每个 partition 维持了一个队列，消息被聚合成 ProducerBatch 存储在队列中。sender 线程每次对队列中聚合的 ProducerBatch 进行发送，从而减少网络传输的资源消耗，提升性能。
1. 计算 Partition 在将消息放入 RecordAccumulator 之前，首先要计算分区 partition。在 doSend() 方法中通过调用 partition() 来计算消息的分区。
private Future&lt;RecordMetadata&gt; doSend(ProducerRecord&lt;K, V&gt; record, Callback callback) { // Try to calculate partition, but note that after this call it can be RecordMetadata.UNKNOWN_PARTITION, // which means that the RecordAccumulator would pick a partition using built-in logic (which may // take into account broker load, the amount of data produced to each partition, etc.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-22T21:10:26+08:00">
    <meta property="article:modified_time" content="2024-08-22T21:10:26+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kafka之RecordAccumulator</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>这篇文章将主要介绍 Kafka 生产者中的 RecordAccumulator。RecordAccumlator 负责对生产者将要发送的消息进行分组缓存，其内部对每个 topic 维持了一个 TopicInfo 来存储缓存的消息，TopicInfo 内部对该 topic 的每个 partition 维持了一个队列，消息被聚合成 ProducerBatch 存储在队列中。sender 线程每次对队列中聚合的 ProducerBatch 进行发送，从而减少网络传输的资源消耗，提升性能。<br> <img src="https://images2.imgbox.com/0d/fe/ly3zDNyh_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="1__Partition_4"></a>1. 计算 Partition</h2> 
<p>在将消息放入 RecordAccumulator 之前，首先要计算分区 partition。在 doSend() 方法中通过调用 partition() 来计算消息的分区。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>


    <span class="token comment">// Try to calculate partition, but note that after this call it can be RecordMetadata.UNKNOWN_PARTITION,</span>
    <span class="token comment">// which means that the RecordAccumulator would pick a partition using built-in logic (which may</span>
    <span class="token comment">// take into account broker load, the amount of data produced to each partition, etc.).</span>
    <span class="token keyword">int</span> partition <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre> 
<p>partition() 方法的具体实现：</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedKey<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedValue<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果消息有 partition，则直接返回该分区</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> record<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 自定义分区器，通过自定义分区器的 partitioner.partition() 逻辑来计算分区</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>partitioner <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> customPartition <span class="token operator">=</span> partitioner<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>
            record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>customPartition <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
                <span class="token string">"The partitioner generated an invalid partition number: %d. Partition number should always be non-negative."</span><span class="token punctuation">,</span> customPartition<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> customPartition<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果消息有 key，并且没有设定 partitionerIgnoreKeys </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>serializedKey <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>partitionerIgnoreKeys<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// **调用 BuiltInPartitioner.partitionForKey 计算 key 的 hash 值来选择分区**</span>
        <span class="token keyword">return</span> <span class="token class-name">BuiltInPartitioner</span><span class="token punctuation">.</span><span class="token function">partitionForKey</span><span class="token punctuation">(</span>serializedKey<span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果消息没有 key，或者设定了 partitionerIgnoreKeys</span>
    <span class="token comment">// 返回 RecordMetadata.UNKNOWN_PARTITION，表明任意分区均可用</span>
    <span class="token comment">// 后续会由 RecordAccumulator 来计算分区</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">RecordMetadata</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN_PARTITION</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>partitionForKey() 方法中使用 murmur2 算法来对序列化后 key byte 数组计算 hash 值，然后对该 topic 的分区数量取模来选择分区。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">partitionForKey</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedKey<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> numPartitions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>serializedKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="2_buffer_pool__57"></a>2. buffer pool 内存池</h2> 
<p>在 RecordAccumulator 中，使用了缓存池对内存进行分配和回收，缓存池的默认总大小是32M，内部由指定大小的 <strong>ByteBuffer 组成的队列 free</strong> 和一块 <strong>nonPooledAvailableMemory</strong> 组成。在分配空间时，如果大小为 ByteBuffer 的大小，可以直接将 ByteBuffer 进行分配。</p> 
<pre><code class="prism language-java"><span class="token comment">// buffer pool 总大小，总大小为 nonPooledAvailableMemory的大小 加上 ByteBuffer队列free的大小</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> totalMemory<span class="token punctuation">;</span>
<span class="token comment">// 单个 ByteBuffer 的大小</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> poolableSize<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span>
<span class="token comment">// ByteBuffer 队列 free</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> free<span class="token punctuation">;</span>
<span class="token comment">// 等待分配空间的线程</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Condition</span><span class="token punctuation">&gt;</span></span> waiters<span class="token punctuation">;</span> 
<span class="token comment">// nonPooledAvailableMemory 的大小</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> nonPooledAvailableMemory<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Metrics</span> metrics<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Time</span> time<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Sensor</span> waitTime<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">boolean</span> closed<span class="token punctuation">;</span>

</code></pre> 
<p>在 doSend() 方法中会调用 allocate() 方法对消息分配内存，然后放入 RecordAccumulator。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">ByteBuffer</span> <span class="token function">allocate</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">long</span> maxTimeToBlockMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 超过总大小，抛出异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalMemory<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Attempt to allocate "</span> <span class="token operator">+</span> size
                                            <span class="token operator">+</span> <span class="token string">" bytes, but there is a hard limit of "</span>
                                            <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalMemory
                                            <span class="token operator">+</span> <span class="token string">" on memory allocations."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 分配时加锁</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaException</span><span class="token punctuation">(</span><span class="token string">"Producer closed while allocating memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果大小为单个 ByteBuffer 大小，且free不为空，则直接使用 free 的第一个 ByteBuffer 分配空间</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> poolableSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 计算 free 中未分配的总空间</span>
        <span class="token keyword">int</span> freeListSize <span class="token operator">=</span> <span class="token function">freeSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize<span class="token punctuation">;</span>

        <span class="token comment">// 如果 nonPooledAvailableMemory 加上 free 中未分配的空间足够进行此次空间分配</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">+</span> freeListSize <span class="token operator">&gt;=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 则将 free 中的空间分配给 nonPooledAvailableMemory 以满足此次空间分配</span>
            <span class="token function">freeUp</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">-=</span> size<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 剩余空间不足以进行此次分配，则会阻塞当前线程</span>
            <span class="token keyword">int</span> accumulated <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name">Condition</span> moreMemory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 线程阻塞的最大时长</span>
                <span class="token keyword">long</span> remainingTimeToBlockNs <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>maxTimeToBlockMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>moreMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 循环等待，直到有足够的空间进行分配</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>accumulated <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">long</span> startWaitNs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> timeNs<span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> waitingTimeElapsed<span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 阻塞等待，并计算是否超时</span>
                        <span class="token comment">// Condition.await() 会让线程阻塞并释放锁，等待其他线程释放空间</span>
                        waitingTimeElapsed <span class="token operator">=</span> <span class="token operator">!</span>moreMemory<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>remainingTimeToBlockNs<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">long</span> endWaitNs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        timeNs <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> endWaitNs <span class="token operator">-</span> startWaitNs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">recordWaitTime</span><span class="token punctuation">(</span>timeNs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">)</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaException</span><span class="token punctuation">(</span><span class="token string">"Producer closed while allocating memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 等待分配空间超时，抛出异常</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingTimeElapsed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>metrics<span class="token punctuation">.</span><span class="token function">sensor</span><span class="token punctuation">(</span><span class="token string">"buffer-exhausted-records"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BufferExhaustedException</span><span class="token punctuation">(</span><span class="token string">"Failed to allocate "</span> <span class="token operator">+</span> size <span class="token operator">+</span> <span class="token string">" bytes within the configured max blocking time "</span>
                            <span class="token operator">+</span> maxTimeToBlockMs <span class="token operator">+</span> <span class="token string">" ms. Total memory: "</span> <span class="token operator">+</span> <span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" bytes. Available memory: "</span> <span class="token operator">+</span> <span class="token function">availableMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">+</span> <span class="token string">" bytes. Poolable size: "</span> <span class="token operator">+</span> <span class="token function">poolableSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    remainingTimeToBlockNs <span class="token operator">-=</span> timeNs<span class="token punctuation">;</span>

                    <span class="token comment">// accumulated 为 0，此次分配还未累积空间，且需要的 size 为一个ByteBuffer的size，</span>
                    <span class="token comment">// 且 free 中有可分配的 ByteBuffer，则直接将 ByteBuffer 分配</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>accumulated <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> size <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// just grab a buffer from the free list</span>
                        buffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">pollFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        accumulated <span class="token operator">=</span> size<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 每次分配一部分空间，循环不断累积空间以满足此次分配</span>
                        <span class="token function">freeUp</span><span class="token punctuation">(</span>size <span class="token operator">-</span> accumulated<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> got <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>size <span class="token operator">-</span> accumulated<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">-=</span> got<span class="token punctuation">;</span>
                        accumulated <span class="token operator">+=</span> got<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// Don't reclaim memory on throwable since nothing was thrown</span>
                accumulated <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// When this loop was not able to successfully terminate don't loose available memory</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">+=</span> accumulated<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>moreMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果还有空间剩余，并且有线程在等待空间，则唤醒一个等待线程</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">peekFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Another finally... otherwise find bugs complains</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token comment">// 累计空间然后分配</span>
        <span class="token keyword">return</span> <span class="token function">safeAllocateByteBuffer</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
    <span class="token comment">// 直接分配了 ByteBuffer</span>
        <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>deallocate() 方法用于释放已分配的内存。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token function">deallocate</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deallocate</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果大小为 ByteBuffer 的大小，则将 buffer 直接放入 free 队列</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>poolableSize <span class="token operator">&amp;&amp;</span> size <span class="token operator">==</span> buffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>free<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 否则由 GC 来释放空间，将空间放入 nonPooledAvailableMemory</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nonPooledAvailableMemory <span class="token operator">+=</span> size<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 唤醒第一个正在等待分配空间的线程</span>
        <span class="token class-name">Condition</span> moreMem <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>waiters<span class="token punctuation">.</span><span class="token function">peekFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>moreMem <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            moreMem<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="3_RecordAccumulator_218"></a>3. RecordAccumulator内部结构和消息加入缓存</h2> 
<p>RecordAccumulator 内部对于每个 topic 维持了一个 TopicInfo。其内部存储了当前 topic 所有 partition 上的 ProducerBatch 队列。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TopicInfo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 包含当前 topic 所有 partition 上的 ProducerBatch 队列。</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">Integer</span> <span class="token comment">/*partition*/</span><span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> batches <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">BuiltInPartitioner</span> builtInPartitioner<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">TopicInfo</span><span class="token punctuation">(</span><span class="token class-name">BuiltInPartitioner</span> builtInPartitioner<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>builtInPartitioner <span class="token operator">=</span> builtInPartitioner<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当客户端调用 send() 发送一条消息，send() 方法底层调用了 doSend() 方法。doSend() 方法中在发送消息前调用 accumulator.append() 将消息加入 RecordAccumulator。如下为 doSend() 方法中将消息加入 RecordAccumulator 的部分。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecordMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSend</span><span class="token punctuation">(</span><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> record<span class="token punctuation">,</span> <span class="token class-name">Callback</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    
    <span class="token comment">// **调用 append() 方法将消息加入 RecordAccumulator**</span>
    <span class="token comment">// 对于上文返回 RecordMetadata.UNKNOWN_PARTITION 的消息，</span>
    <span class="token comment">// 在 append() 内部计算其分区，然后分区会写入 appendCallbacks.topicPartition.</span>
    <span class="token class-name">RecordAccumulator<span class="token punctuation">.</span>RecordAppendResult</span> result <span class="token operator">=</span> accumulator<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span>
            serializedValue<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> appendCallbacks<span class="token punctuation">,</span> remainingWaitMs<span class="token punctuation">,</span> abortOnNewBatch<span class="token punctuation">,</span> nowMs<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span> appendCallbacks<span class="token punctuation">.</span><span class="token function">getPartition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">RecordMetadata</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN_PARTITION</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果 abortForNewBatch 为 true，这一步是为了可以调用自定义的 onNewBatch() 方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>abortForNewBatch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> prevPartition <span class="token operator">=</span> partition<span class="token punctuation">;</span>
        <span class="token comment">// 调用自定义的 onNewBatch() 方法</span>
        <span class="token function">onNewBatch</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> prevPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        partition <span class="token operator">=</span> <span class="token function">partition</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span> serializedValue<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Retrying append due to new batch creation for topic {} partition {}. The old partition was {}"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">,</span> prevPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// **再次调用 append() 方法，此时 abortForNewBatch 为 false**</span>
        result <span class="token operator">=</span> accumulator<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partition<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> serializedKey<span class="token punctuation">,</span>
            serializedValue<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> appendCallbacks<span class="token punctuation">,</span> remainingWaitMs<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> nowMs<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        transactionManager<span class="token punctuation">.</span><span class="token function">maybeAddPartition</span><span class="token punctuation">(</span>appendCallbacks<span class="token punctuation">.</span><span class="token function">topicPartition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 一个 batch 写满或者创建了新 btach 时唤醒 sender 线程发送</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>batchIsFull <span class="token operator">||</span> result<span class="token punctuation">.</span>newBatchCreated<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Waking up the sender since topic {} partition {} is either full or getting a new batch"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> appendCallbacks<span class="token punctuation">.</span><span class="token function">getPartition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sender<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span>future<span class="token punctuation">;</span>

    
<span class="token punctuation">}</span>
</code></pre> 
<p>append() 方法负责将消息加入 RecordAccumulator。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">RecordAppendResult</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span>
                                    <span class="token keyword">int</span> partition<span class="token punctuation">,</span>
                                    <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span>
                                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span>
                                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span>
                                    <span class="token class-name">Header</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headers<span class="token punctuation">,</span>
                                    <span class="token class-name">AppendCallbacks</span> callbacks<span class="token punctuation">,</span>
                                    <span class="token keyword">long</span> maxTimeToBlock<span class="token punctuation">,</span>
                                    <span class="token keyword">boolean</span> abortOnNewBatch<span class="token punctuation">,</span>
                                    <span class="token keyword">long</span> nowMs<span class="token punctuation">,</span>
                                    <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 获取当前主题的 TopicInfo，即获取当前 topic 所有分区上的 ProducerBatch 队列</span>
    <span class="token class-name">TopicInfo</span> topicInfo <span class="token operator">=</span> topicInfoMap<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> k <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">TopicInfo</span><span class="token punctuation">(</span><span class="token function">createBuiltInPartitioner</span><span class="token punctuation">(</span>logContext<span class="token punctuation">,</span> k<span class="token punctuation">,</span> batchSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// CAS增加正在 append 的 batches 的数量</span>
    <span class="token comment">// appendsInProgress是为了追踪正在 append 的 batches 的数量，以便执行 abortIncompleteBatches()</span>
    appendsInProgress<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>headers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> headers <span class="token operator">=</span> <span class="token class-name">Record</span><span class="token punctuation">.</span><span class="token constant">EMPTY_HEADERS</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">BuiltInPartitioner<span class="token punctuation">.</span>StickyPartitionInfo</span> partitionInfo<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> effectivePartition<span class="token punctuation">;</span>
            <span class="token comment">// 如果之前没有计算出分区，则根据 broker 负载通过内置的加权随机算法来选择一个分区，保证负载均衡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>partition <span class="token operator">==</span> <span class="token class-name">RecordMetadata</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN_PARTITION</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                partitionInfo <span class="token operator">=</span> topicInfo<span class="token punctuation">.</span>builtInPartitioner<span class="token punctuation">.</span><span class="token function">peekCurrentPartitionInfo</span><span class="token punctuation">(</span>cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
                effectivePartition <span class="token operator">=</span> partitionInfo<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                partitionInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                effectivePartition <span class="token operator">=</span> partition<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 在 appendCallbacks 设定 partition 分区，用于保存 partition</span>
            <span class="token function">setPartition</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">,</span> effectivePartition<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 根据 partition 获取对应的 deque，如果不存在则创建一个 deque</span>
            <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> dq <span class="token operator">=</span> topicInfo<span class="token punctuation">.</span>batches<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>effectivePartition<span class="token punctuation">,</span> k <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果分区信息发生变化，则重新循环</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">partitionChanged</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> topicInfo<span class="token punctuation">,</span> partitionInfo<span class="token punctuation">,</span> dq<span class="token punctuation">,</span> nowMs<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>

                <span class="token comment">// **调用 tryAppend()，尝试将消息写入对应的 deque**</span>
                <span class="token comment">// 第一次运行到这里时，由于 deque 是空的，所以 tryAppend() 会失败</span>
                <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callbacks<span class="token punctuation">,</span> dq<span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// If queue has incomplete batches we disable switch (see comments in updatePartitionInfo).</span>
                    <span class="token keyword">boolean</span> enableSwitch <span class="token operator">=</span> <span class="token function">allBatchesFull</span><span class="token punctuation">(</span>dq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    topicInfo<span class="token punctuation">.</span>builtInPartitioner<span class="token punctuation">.</span><span class="token function">updatePartitionInfo</span><span class="token punctuation">(</span>partitionInfo<span class="token punctuation">,</span> appendResult<span class="token punctuation">.</span>appendedBytes<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> enableSwitch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 代码执行到这里说明 tryAppend() 的结果返回了 null，说明 ProducerBatch 空间不足或者 deque 中没有可用的 ProducerBatch </span>
            <span class="token comment">// 如果 abortOnNewBatch 为 true，则构造一个空的 RecordAppendResult 并返回</span>
            <span class="token comment">// 在外部的 doSend() 方法中随后会再次调用 append() 方法，并指定 abortOnNewBatch 为 false</span>
            <span class="token comment">// 这样做是为了在外部的 doSend() 方法中可以调用自定义的 onNewBatch() 方法</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>abortOnNewBatch<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Return a result that will cause another call to append.</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">byte</span> maxUsableMagic <span class="token operator">=</span> apiVersions<span class="token punctuation">.</span><span class="token function">maxUsableProduceMagic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 选取 batchsize 和 估算的record的size 中较大的值进行空间分配</span>
                <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>batchSize<span class="token punctuation">,</span> <span class="token class-name">AbstractRecords</span><span class="token punctuation">.</span><span class="token function">estimateSizeInBytesUpperBound</span><span class="token punctuation">(</span>maxUsableMagic<span class="token punctuation">,</span> compression<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Allocating a new {} byte message buffer for topic {} partition {} with remaining timeout {}ms"</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> partition<span class="token punctuation">,</span> maxTimeToBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 尝试从缓存池分配 size 大小的空间，如果空间不足，则会阻塞</span>
                buffer <span class="token operator">=</span> free<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> maxTimeToBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>

                nowMs <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果分区信息发生变化，则重新循环</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">partitionChanged</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> topicInfo<span class="token punctuation">,</span> partitionInfo<span class="token punctuation">,</span> dq<span class="token punctuation">,</span> nowMs<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>

                <span class="token comment">// **调用 appendNewBatch() 构建一个新的 ProducerBatch**</span>
                <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">appendNewBatch</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> effectivePartition<span class="token punctuation">,</span> dq<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callbacks<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 将 buffer 设定为 null, finally块在 buffer 不为 null 的情况下会释放 buffer 的内存</span>
                <span class="token comment">// 当消息正常写入 buffer 时，将 buffer 设定为 null 使其内存不被释放</span>
                <span class="token comment">// 当消息写入发生异常时，可以释放掉已分配的 buffer 空间</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult<span class="token punctuation">.</span>newBatchCreated<span class="token punctuation">)</span>
                    buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token comment">// // 如果有未满的 ProducerBatch，则禁用分区切换</span>
                <span class="token keyword">boolean</span> enableSwitch <span class="token operator">=</span> <span class="token function">allBatchesFull</span><span class="token punctuation">(</span>dq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                topicInfo<span class="token punctuation">.</span>builtInPartitioner<span class="token punctuation">.</span><span class="token function">updatePartitionInfo</span><span class="token punctuation">(</span>partitionInfo<span class="token punctuation">,</span> appendResult<span class="token punctuation">.</span>appendedBytes<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> enableSwitch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 释放内存空间</span>
        free<span class="token punctuation">.</span><span class="token function">deallocate</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// CAS减少正在 append 的 batches 的数量</span>
        appendsInProgress<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>tryAppend() 方法负责将消息写入 deque 中的 ProducerBatch。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">RecordAppendResult</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span> <span class="token class-name">Header</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headers<span class="token punctuation">,</span>
                                        <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> deque<span class="token punctuation">,</span> <span class="token keyword">long</span> nowMs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">KafkaException</span><span class="token punctuation">(</span><span class="token string">"Producer closed while send in progress"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取 deque 中的最后一个 ProducerBatch</span>
    <span class="token class-name">ProducerBatch</span> last <span class="token operator">=</span> deque<span class="token punctuation">.</span><span class="token function">peekLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果存在 ProducerBatch</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 最后一个 ProducerBatch 写入消息前的初始大小</span>
        <span class="token keyword">int</span> initialBytes <span class="token operator">=</span> last<span class="token punctuation">.</span><span class="token function">estimatedSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 尝试将消息写入最后一个 ProducerBatch </span>
        <span class="token class-name">FutureRecordMetadata</span> future <span class="token operator">=</span> last<span class="token punctuation">.</span><span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 返回 null 代表写入失败，则关闭写入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>future <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            last<span class="token punctuation">.</span><span class="token function">closeForRecordAppends</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 写入成功</span>
            <span class="token keyword">int</span> appendedBytes <span class="token operator">=</span> last<span class="token punctuation">.</span><span class="token function">estimatedSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> initialBytes<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> deque<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> last<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> appendedBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 代码执行到这里说明 deque 中没有 ProducerBatch，则直接返回 null</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>appendNewBatch() 方法创建一个新的 ProducerBatch 并将其加入 deque。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">RecordAppendResult</span> <span class="token function">appendNewBatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span>
                                            <span class="token keyword">int</span> partition<span class="token punctuation">,</span>
                                            <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> dq<span class="token punctuation">,</span>
                                            <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span>
                                            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span>
                                            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span>
                                            <span class="token class-name">Header</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headers<span class="token punctuation">,</span>
                                            <span class="token class-name">AppendCallbacks</span> callbacks<span class="token punctuation">,</span>
                                            <span class="token class-name">ByteBuffer</span> buffer<span class="token punctuation">,</span>
                                            <span class="token keyword">long</span> nowMs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">assert</span> partition <span class="token operator">!=</span> <span class="token class-name">RecordMetadata</span><span class="token punctuation">.</span><span class="token constant">UNKNOWN_PARTITION</span><span class="token punctuation">;</span>

    <span class="token comment">// 再次尝试 tryAppend()，如果其他线程已经创建了 ProducerBatch，则 tryAppend()成功可以直接返回</span>
    <span class="token comment">// 防止由于多个线程创建了多个 ProducerBatch，并且只在队尾写入，导致前面创建的 ProducerBatch 空间浪费</span>
    <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callbacks<span class="token punctuation">,</span> dq<span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 构建 ProducerBatch</span>
    <span class="token class-name">MemoryRecordsBuilder</span> recordsBuilder <span class="token operator">=</span> <span class="token function">recordsBuilder</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> apiVersions<span class="token punctuation">.</span><span class="token function">maxUsableProduceMagic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ProducerBatch</span> batch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerBatch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TopicPartition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> partition<span class="token punctuation">)</span><span class="token punctuation">,</span> recordsBuilder<span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FutureRecordMetadata</span> future <span class="token operator">=</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span>
            callbacks<span class="token punctuation">,</span> nowMs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 ProducerBatch 加入 deque</span>
    dq<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 ProducerBatch 加入未完成消息发送的队列</span>
    incomplete<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> dq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> batch<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> batch<span class="token punctuation">.</span><span class="token function">estimatedSizeInBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="4_sender__443"></a>4. sender 线程</h2> 
<p>sender 线程在 runOnce() 中会调用 sendProducerData() 来发送缓存在 RecordAccumulator 中的消息。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">sendProducerData</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取元数据</span>
    <span class="token class-name">MetadataSnapshot</span> metadataSnapshot <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">fetchMetadataSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取已经可以发送的分区</span>
    <span class="token class-name">RecordAccumulator<span class="token punctuation">.</span>ReadyCheckResult</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>metadataSnapshot<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果有 leader 节点未知的分区，则强制更新元数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>unknownLeaderTopics<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// The set of topics with unknown leader contains topics with leader election pending as well as</span>
        <span class="token comment">// topics which may have expired. Add the topic again to metadata to ensure it is included</span>
        <span class="token comment">// and request metadata update, since there are messages to send to the topic.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> topic <span class="token operator">:</span> result<span class="token punctuation">.</span>unknownLeaderTopics<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Requesting metadata update due to unknown leader topics from the batched records: {}"</span><span class="token punctuation">,</span>
            result<span class="token punctuation">.</span>unknownLeaderTopics<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">requestUpdate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 在结果中继续过滤，通过检查与节点的连接，移除没有准备好的节点</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> notReadyTimeout <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Node</span> node <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Update just the readyTimeMs of the latency stats, so that it moves forward</span>
            <span class="token comment">// every time the batch is ready (then the difference between readyTimeMs and</span>
            <span class="token comment">// drainTimeMs would represent how long data is waiting for the node).</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">updateNodeLatencyStats</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            notReadyTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>notReadyTimeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">pollDelayMs</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Update both readyTimeMs and drainTimeMs, this would "reset" the node</span>
            <span class="token comment">// latency.</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">updateNodeLatencyStats</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> now<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 从 RecordAccumulator 取出数据，按照 node 节点和 ProducerBatch 进行映射，交由网络层发送给对应的节点</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span>metadataSnapshot<span class="token punctuation">,</span> result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxRequestSize<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addToInflightBatches</span><span class="token punctuation">(</span>batches<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>guaranteeMessageOrder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Mute all the partitions drained</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> batchList <span class="token operator">:</span> batches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProducerBatch</span> batch <span class="token operator">:</span> batchList<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">mutePartition</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理已经过期的消息</span>
    accumulator<span class="token punctuation">.</span><span class="token function">resetNextBatchExpiryTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> expiredInflightBatches <span class="token operator">=</span> <span class="token function">getExpiredInflightBatches</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> expiredBatches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">expiredBatches</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    expiredBatches<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>expiredInflightBatches<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expiredBatches<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Expired {} batches in accumulator"</span><span class="token punctuation">,</span> expiredBatches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProducerBatch</span> expiredBatch <span class="token operator">:</span> expiredBatches<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> errorMessage <span class="token operator">=</span> <span class="token string">"Expiring "</span> <span class="token operator">+</span> expiredBatch<span class="token punctuation">.</span>recordCount <span class="token operator">+</span> <span class="token string">" record(s) for "</span> <span class="token operator">+</span> expiredBatch<span class="token punctuation">.</span>topicPartition
            <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> expiredBatch<span class="token punctuation">.</span>createdMs<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" ms has passed since batch creation"</span><span class="token punctuation">;</span>
        <span class="token function">failBatch</span><span class="token punctuation">(</span>expiredBatch<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span>errorMessage<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionManager <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> expiredBatch<span class="token punctuation">.</span><span class="token function">inRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// This ensures that no new batches are drained until the current in flight batches are fully resolved.</span>
            transactionManager<span class="token punctuation">.</span><span class="token function">markSequenceUnresolved</span><span class="token punctuation">(</span>expiredBatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 更新 metrics</span>
    sensors<span class="token punctuation">.</span><span class="token function">updateProduceRequestMetrics</span><span class="token punctuation">(</span>batches<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 pollTimeout 设定为 下一次检查结点ready的延迟时间 和 下一次batch过期时间 中较小的值</span>
    <span class="token keyword">long</span> pollTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>nextReadyCheckDelayMs<span class="token punctuation">,</span> notReadyTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pollTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>pollTimeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">nextExpiryTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pollTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>pollTimeout<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果有准备好的结点，将 pollTimeout 设定为 0，立即发送消息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Nodes with data ready to send: {}"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// if some partitions are already ready to be sent, the select time would be 0;</span>
        <span class="token comment">// otherwise if some partition already has some data accumulated but not ready yet,</span>
        <span class="token comment">// the select time will be the time difference between now and its linger expiry time;</span>
        <span class="token comment">// otherwise the select time will be the time difference between now and the metadata expiry time;</span>
        pollTimeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 通过 NetworkClient 发送消息</span>
    <span class="token function">sendProduceRequests</span><span class="token punctuation">(</span>batches<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pollTimeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/94b61dd98b1429a8954a34f41738ddb5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">AutoGPT开源项目解读</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d681ee54a6ad811a3488d4de99447367/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C:每日一练：单身狗（2.0版本）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>