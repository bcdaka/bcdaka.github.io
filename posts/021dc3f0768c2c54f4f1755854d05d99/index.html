<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>小程序蓝牙连接ESP32通信(可直接拿来用) - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/021dc3f0768c2c54f4f1755854d05d99/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="小程序蓝牙连接ESP32通信(可直接拿来用)">
  <meta property="og:description" content="小程序中的蓝牙能力 在小程序中，要使用蓝牙能力（Beacon 除外）必须首先调用 wx.openBluetoothAdapter 初始化蓝牙适配器模块，其生效周期为调用 wx.openBluetoothAdapter 至调用 wx.closeBluetoothAdapter 或小程序被销毁为止。只有在小程序蓝牙适配器模块生效期间，开发者才能够正常调用蓝牙相关的小程序 API，并收到蓝牙模块相关的事件回调（绑定监听不受此限制）。
小程序对蓝牙支持情况如下：
经典蓝牙：iOS 因系统限制暂无法提供，安卓目前已在规划中。
蓝牙低功耗 (BLE)：
主机模式：基础库 1.1.0（微信客户端 iOS 6.5.6，Android 6.5.7）开始支持。从机模式：基础库 2.10.3 开始支持。蓝牙信标 (Beacon)：基础库 1.2.0 开始支持。 前置条件 蓝牙模块需要是 低功耗蓝牙(BLE) ，不然小程序搜索不到(将导致无法继续进行开发)，可购买我们的设备 来进行开发。开发者工具上只能模拟部分蓝牙接口能力，完整功能请使用真机调试。 官方文档 微信小程序蓝牙开发文档
微信小程序提供的操作蓝牙的 API 微信小程序目前有蓝牙 API 共 18 个
操作蓝牙适配器的 API wx.openBluetoothAdapter 初始化蓝牙适配器 wx.closeBluetoothAdapter 关闭蓝牙模块 wx.getBluetoothAdapterState 获取本机蓝牙适配器状态 wx.onBluetoothAdapterStateChange 监听蓝牙适配器状态变化事件 连接前使用的 API wx.startBluetoothDevicesDiscovery 开始搜寻附近的蓝牙外围设备 wx.stopBluetoothDevicesDiscovery 停止搜寻附近的蓝牙外围设备 wx.getBluetoothDevices 获取所有已发现的蓝牙设备 wx.onBluetoothDeviceFound 监听寻找到新设备的事件 连接和断开时使用的 API wx.createBLEConnection 连接低功耗蓝牙设备 wx.closeBLEConnection 断开与低功耗蓝牙设备的连接 连接成功后使用的 API wx.getConnectedBluetoothDevices 根据 uuid 获取处于已连接状态的设备 wx.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-05-13T08:57:15+08:00">
    <meta property="article:modified_time" content="2024-05-13T08:57:15+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">小程序蓝牙连接ESP32通信(可直接拿来用)</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_0"></a>小程序中的蓝牙能力</h4> 
<p>在小程序中，要使用蓝牙能力（Beacon 除外）必须首先调用 <code>wx.openBluetoothAdapter</code> 初始化蓝牙适配器模块，其生效周期为调用 <code>wx.openBluetoothAdapter</code> 至调用 <code>wx.closeBluetoothAdapter</code> 或小程序被销毁为止。只有在小程序蓝牙适配器模块生效期间，开发者才能够正常调用蓝牙相关的小程序 API，并收到蓝牙模块相关的事件回调（绑定监听不受此限制）。</p> 
<p>小程序对蓝牙支持情况如下：</p> 
<p>经典蓝牙：iOS 因系统限制暂无法提供，安卓目前已在规划中。</p> 
<p>蓝牙低功耗 (BLE)：</p> 
<ul><li>主机模式：基础库 1.1.0（微信客户端 iOS 6.5.6，Android 6.5.7）开始支持。</li><li>从机模式：基础库 2.10.3 开始支持。</li><li>蓝牙信标 (Beacon)：基础库 1.2.0 开始支持。</li></ul> 
<h4><a id="_16"></a>前置条件</h4> 
<ul><li>蓝牙模块需要是 <font color="red"><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/device/ble.html" rel="nofollow">低功耗蓝牙(BLE)</a></font> ，不然小程序搜索不到(将导致无法继续进行开发)，可<a href="https://item.taobao.com/item.htm?ft=t&amp;id=733771072005&amp;spm=a21dvs.23580594.0.0.621e3d0d0mqJjN" rel="nofollow">购买我们的设备</a> 来进行开发。</li><li>开发者工具上只能模拟部分蓝牙接口能力，完整功能请使用真机调试。</li></ul> 
<h4><a id="_21"></a>官方文档</h4> 
<p><a href="https://developers.weixin.qq.com/miniprogram/dev/framework/device/bluetooth.html" rel="nofollow">微信小程序蓝牙开发文档</a></p> 
<h4><a id="_API_25"></a>微信小程序提供的操作蓝牙的 API</h4> 
<p>微信小程序目前有蓝牙 API 共 18 个</p> 
<h5><a id="_API_29"></a>操作蓝牙适配器的 API</h5> 
<pre><code>wx.openBluetoothAdapter 初始化蓝牙适配器
wx.closeBluetoothAdapter 关闭蓝牙模块
wx.getBluetoothAdapterState 获取本机蓝牙适配器状态
wx.onBluetoothAdapterStateChange 监听蓝牙适配器状态变化事件
</code></pre> 
<h5><a id="_API_38"></a>连接前使用的 API</h5> 
<pre><code>wx.startBluetoothDevicesDiscovery 开始搜寻附近的蓝牙外围设备
wx.stopBluetoothDevicesDiscovery 停止搜寻附近的蓝牙外围设备
wx.getBluetoothDevices 获取所有已发现的蓝牙设备
wx.onBluetoothDeviceFound 监听寻找到新设备的事件
</code></pre> 
<h5><a id="_API_47"></a>连接和断开时使用的 API</h5> 
<pre><code>wx.createBLEConnection 连接低功耗蓝牙设备
wx.closeBLEConnection 断开与低功耗蓝牙设备的连接
</code></pre> 
<h5><a id="_API_54"></a>连接成功后使用的 API</h5> 
<pre><code>wx.getConnectedBluetoothDevices 根据 uuid 获取处于已连接状态的设备
wx.getBLEDeviceServices 获取蓝牙设备所有 service（服务）
wx.getBLEDeviceCharacteristics  获取蓝牙设备所有 characteristic（特征值）
wx.readBLECharacteristicValue  读取低功耗蓝牙设备的特征值的二进制数据值
wx.writeBLECharacteristicValue 向低功耗蓝牙设备特征值中写入二进制数据
wx.notifyBLECharacteristicValueChange  启用低功耗蓝牙设备特征值变化时的 notify 功能
wx.onBLECharacteristicValueChange 监听低功耗蓝牙设备的特征值变化
wx.onBLEConnectionStateChange 监听低功耗蓝牙连接的错误事件
</code></pre> 
<h4><a id="_67"></a>基本操作流程</h4> 
<p>最基本的操作流程是：初始化蓝牙适配器 → 开始搜寻附近的蓝牙外围设备 → 监听寻找到新设备的事件 → 连接低功耗蓝牙设备 → 获取蓝牙设备所有 service 和 characteristic → 读取或写入低功耗蓝牙设备的特征值的二进制数据值。</p> 
<h4><a id="_71"></a>蓝牙组件代码</h4> 
<p>由于我们 index 中代码量比较多，不利于维护，所以我们将蓝牙功能单独抽离成一个 component(组件)，方便管理和复用。</p> 
<p><img src="https://images2.imgbox.com/fa/bd/ejo4MJD7_o.png" alt="新建组件"></p> 
<p>新建一个 components 目录，在该目录下新建一个目录为 bluetooth-comp，然后在 bluetooth-comp 点击"新建 Component"按钮，输入 index 并点击确定。</p> 
<h5><a id="_80"></a>页面结构部分</h5> 
<pre><code class="prism language-html"><span class="token comment">&lt;!-- bluetooth-comp/index.wxml --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">margin</span><span class="token punctuation">:</span> 26rpx</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">wx:</span>if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{!connected}}<span class="token punctuation">"</span></span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>openBluetoothAdapter<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>开始扫描<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">wx:</span>else</span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>closeBLEConnection<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>断开连接 - {<!-- -->{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>devices_summary<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>已发现 {<!-- -->{devices.length}} 个外围设备：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span>
    <span class="token attr-name"><span class="token namespace">wx:</span>for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{devices}}<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">wx:</span>key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span>
    <span class="token attr-name">data-device-id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{item.deviceId}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">data-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{item.name || item.localName}}<span class="token punctuation">"</span></span>
    <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>createBLEConnection<span class="token punctuation">"</span></span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>device_item<span class="token punctuation">"</span></span>
    <span class="token attr-name">hover-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>device_item_hover<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span> <span class="token property">color</span><span class="token punctuation">:</span> #333</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{item.name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span> 10px</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>信号强度: {<!-- -->{item.RSSI}}dBm<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span> 10px</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>UUID: {<!-- -->{item.deviceId}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="_104"></a>样式部分</h5> 
<pre><code class="prism language-css"><span class="token comment">/* bluetooth-comp/index.wxss */</span>
<span class="token selector">.devices_summary</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">margin-top</span><span class="token punctuation">:</span> 30px<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.device_item</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">border-bottom</span><span class="token punctuation">:</span> 1px solid #eee<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.device_item_hover</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_124"></a>逻辑部分</h5> 
<p>在 data 中定义变量</p> 
<pre><code class="prism language-js"><span class="token comment">// bluetooth-comp/index.js</span>
<span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">devices</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">connected</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">chs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>js 文件顶部定义工具方法</p> 
<pre><code class="prism language-js"><span class="token keyword">function</span> <span class="token function">inArray</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 将字符串转为 ArrayBuffer</span>
<span class="token keyword">function</span> <span class="token function">str2ab</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> bufView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> strLen <span class="token operator">=</span> str<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> strLen<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    bufView<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在 methods 中定义方法</p> 
<pre><code class="prism language-js"><span class="token comment">// bluetooth-comp/index.js</span>
<span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* 初始化蓝牙模块 */</span>
  <span class="token function">openBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 先关闭蓝牙模块再开启 防止断开后点连接连接不上</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    wx<span class="token punctuation">.</span><span class="token function">openBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"初始化蓝牙模块成功：openBluetoothAdapter"</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>errCode <span class="token operator">===</span> <span class="token number">10001</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">/* 监听蓝牙适配器状态变化事件 */</span>
          wx<span class="token punctuation">.</span><span class="token function">onBluetoothAdapterStateChange</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"监听蓝牙适配器状态变化事件：onBluetoothAdapterStateChange"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span>available <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 获取本机蓝牙适配器状态 */</span>
  <span class="token function">getBluetoothAdapterState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    wx<span class="token punctuation">.</span><span class="token function">getBluetoothAdapterState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"getBluetoothAdapterState"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>discovering<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 是否正在搜索设备</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>available<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 蓝牙适配器是否可用</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 开始搜寻附近的蓝牙外围设备 */</span>
  <span class="token function">startBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 开始扫描参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_discoveryStarted<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>_discoveryStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">startBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">allowDuplicatesKey</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"开始搜寻附近的蓝牙外围设备：startBluetoothDevicesDiscovery"</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"搜索设备失败"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"搜索设备失败"</span><span class="token punctuation">,</span> <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">"none"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 停止搜寻附近的蓝牙外围设备。*/</span>
  <span class="token function">stopBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"停止搜寻附近的蓝牙外围设备"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">stopBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 监听搜索到新设备的事件 */</span>
  <span class="token function">onBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    wx<span class="token punctuation">.</span><span class="token function">onBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      res<span class="token punctuation">.</span>devices<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">device</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>device<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>device<span class="token punctuation">.</span>localName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> foundDevices <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>devices<span class="token punctuation">;</span>
        <span class="token keyword">const</span> idx <span class="token operator">=</span> <span class="token function">inArray</span><span class="token punctuation">(</span>foundDevices<span class="token punctuation">,</span> <span class="token string">"deviceId"</span><span class="token punctuation">,</span> device<span class="token punctuation">.</span>deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>idx <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          data<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">devices[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>foundDevices<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> device<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          data<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">devices[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>idx<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> device<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 连接蓝牙低功耗设备。*/</span>
  <span class="token function">createBLEConnection</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> ds <span class="token operator">=</span> e<span class="token punctuation">.</span>currentTarget<span class="token punctuation">.</span>dataset<span class="token punctuation">;</span>
    <span class="token keyword">const</span> deviceId <span class="token operator">=</span> ds<span class="token punctuation">.</span>deviceId<span class="token punctuation">;</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> ds<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">createBLEConnection</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      deviceId<span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">connected</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> deviceId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"连接蓝牙设备成功"</span><span class="token punctuation">,</span> <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">"none"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBLEDeviceServices</span><span class="token punctuation">(</span>deviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"连接失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"连接失败,错误信息: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>errMsg<span class="token punctuation">,</span> <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">"none"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 停止搜寻蓝牙设备</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stopBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 断开与蓝牙低功耗设备的连接。 */</span>
  <span class="token function">closeBLEConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"断开与蓝牙低功耗设备的连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"已断开和蓝牙设备的连接"</span><span class="token punctuation">,</span> <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">"none"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">closeBLEConnection</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">deviceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>deviceId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">connected</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">chs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">canWrite</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 获取蓝牙低功耗设备所有服务 (service) */</span>
  <span class="token function">getBLEDeviceServices</span><span class="token punctuation">(</span><span class="token parameter">deviceId</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    wx<span class="token punctuation">.</span><span class="token function">getBLEDeviceServices</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      deviceId<span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> res<span class="token punctuation">.</span>services<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>services<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>isPrimary<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBLEDeviceCharacteristics</span><span class="token punctuation">(</span>deviceId<span class="token punctuation">,</span> res<span class="token punctuation">.</span>services<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 获取蓝牙低功耗设备某个服务中所有特征 (characteristic)。 */</span>
  <span class="token function">getBLEDeviceCharacteristics</span><span class="token punctuation">(</span><span class="token parameter">deviceId<span class="token punctuation">,</span> serviceId</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    wx<span class="token punctuation">.</span><span class="token function">getBLEDeviceCharacteristics</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      deviceId<span class="token punctuation">,</span>
      serviceId<span class="token punctuation">,</span>
      <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"获取蓝牙低功耗设备某个服务中所有特征：getBLEDeviceCharacteristics"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> res<span class="token punctuation">.</span>characteristics<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">let</span> item <span class="token operator">=</span> res<span class="token punctuation">.</span>characteristics<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>read<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            wx<span class="token punctuation">.</span><span class="token function">readBLECharacteristicValue</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> deviceId<span class="token punctuation">,</span> serviceId<span class="token punctuation">,</span> <span class="token literal-property property">characteristicId</span><span class="token operator">:</span> item<span class="token punctuation">.</span>uuid <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>write<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">canWrite</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_deviceId <span class="token operator">=</span> deviceId<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_serviceId <span class="token operator">=</span> serviceId<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_characteristicId <span class="token operator">=</span> item<span class="token punctuation">.</span>uuid<span class="token punctuation">;</span>
            <span class="token comment">//   this.writeBLECharacteristicValue();</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>notify <span class="token operator">||</span> item<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>indicate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            wx<span class="token punctuation">.</span><span class="token function">notifyBLECharacteristicValueChange</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              deviceId<span class="token punctuation">,</span>
              serviceId<span class="token punctuation">,</span>
              <span class="token literal-property property">characteristicId</span><span class="token operator">:</span> item<span class="token punctuation">.</span>uuid<span class="token punctuation">,</span>
              <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"notifyBLECharacteristicValueChange success"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"getBLEDeviceCharacteristics"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 操作之前先监听，保证第一时间获取数据</span>
    wx<span class="token punctuation">.</span><span class="token function">onBLECharacteristicValueChange</span><span class="token punctuation">(</span><span class="token parameter">characteristic</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// TODO 收到的信息为ArrayBuffer类型，可根据自己的需要转换 可发送给父组件用来回显</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"收到原始的数据"</span><span class="token punctuation">,</span> characteristic<span class="token punctuation">,</span> characteristic<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 测试向设备发送数据</span>
      <span class="token comment">// this.writeBLECharacteristicValue(JSON.stringify({"FAN":"OFF"}))</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">/* 向蓝牙低功耗设备特征值中写入二进制数据 */</span>
  <span class="token function">writeBLECharacteristicValue</span><span class="token punctuation">(</span><span class="token parameter">jsonStr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> arrayBufferValue <span class="token operator">=</span> <span class="token function">str2ab</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"发送数据给蓝牙"</span><span class="token punctuation">,</span> <span class="token string">"原始字符串"</span><span class="token punctuation">,</span> jsonStr<span class="token punctuation">,</span> <span class="token string">"转换arrayBuffer"</span><span class="token punctuation">,</span> arrayBufferValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

    wx<span class="token punctuation">.</span><span class="token function">writeBLECharacteristicValue</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">deviceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_deviceId<span class="token punctuation">,</span>
      <span class="token literal-property property">serviceId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_serviceId<span class="token punctuation">,</span> <span class="token comment">// 微信文档上是错误的</span>
      <span class="token literal-property property">characteristicId</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_characteristicId<span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> arrayBufferValue<span class="token punctuation">,</span> <span class="token comment">// 只能发送arrayBuffer类型数据</span>
      <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"消息发送成功"</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"消息发送成功"</span><span class="token punctuation">,</span> <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">"none"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"发送消息失败"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"发送消息失败,错误信息: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>errMsg<span class="token punctuation">,</span> <span class="token literal-property property">icon</span><span class="token operator">:</span> <span class="token string">"none"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">closeBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"关闭蓝牙模块"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wx<span class="token punctuation">.</span><span class="token function">closeBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_discoveryStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<h4><a id="_360"></a>最终效果</h4> 
<h5><a id="_362"></a>界面</h5> 
<p><img src="https://images2.imgbox.com/33/f6/jB5Co12g_o.jpg" alt="界面"></p> 
<h5><a id="_367"></a>真机调试结果</h5> 
<p><img src="https://images2.imgbox.com/e7/f3/ai02MZle_o.png" alt="真机调试结果"></p> 
<hr> 
<p>嵌入式物联网教学开发 传感器控制拓展板二合一</p> 
<p>不同于其他卖家提供资料和技术支持，我们提供手把手教学，完整的开发流程如下：</p> 
<p>实现完整的一个物联网嵌入式项目：将数据上传并通过小程序对硬件进行控制。具体有：</p> 
<p>[1]服务器配置，阿里云搭建mqttx服务器，ssl证书配置；</p> 
<p>[2]微信小程序设计，借助微信开发者工具开发，js代码和类html语言；</p> 
<p>[3]硬件驱动，基于Arduino平台开发esp32，提供wifi和蓝牙版本，读取传感器：温度、湿度、烟雾；控制设备：小灯、继电器。</p> 
<p>提供教学视频在b站，合集播放破6w！提供项目开发文档，网页链接。</p> 
<p>我们提供搭建好的mqtt测试服务器，供大家免费使用。</p> 
<p>适合如下人群：</p> 
<p>1.喜欢diy的电子极客；</p> 
<p>2.物联网专业的相关学生课程或毕业设计；</p> 
<p>3.寻求物联网项目经验的求职者；</p> 
<p>有硬件工程师和软件工程师答疑，欢迎咨询～</p> 
<p>文档资料，可参考：<a href="https://esp-document.icce.top/" rel="nofollow">基于ESP32+微信小程序的物联网应用开发文档</a></p> 
<p>​</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eed017b135b86fbf068978b5c3888388/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux安装mysql报错：失败的软件包是：mysql-community-libs-8.0.37-1.el7.x86_64 GPG</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/af8736bf589c4ac9d679640a593621dd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;的数据结构(五）：树和存储结构及示例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>