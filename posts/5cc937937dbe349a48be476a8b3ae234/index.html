<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenCV图像裁剪：使用&amp;运算符在OpenCV图像裁剪时进行边界检查 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/5cc937937dbe349a48be476a8b3ae234/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="OpenCV图像裁剪：使用&运算符在OpenCV图像裁剪时进行边界检查">
  <meta property="og:description" content="给定ROI的图像裁剪 假设需要按照既定的ROI对图像进行取窗裁剪，用cv::Rect给定ROI区域，裁剪可以按照如下方式：
cv::Mat image = cv::imread(&#34;/path/to/image.jpg&#34;); cv::Rect roi = cv::Rect(x, y, width, height); cv::Mat crop = image(roi); 限制边界 如果roi的坐标超出了图像的合法区域，会引发运行时错误，导致程序崩溃。此时一般要提前进行边界检查和规范，比如这样：
if(roi.x&lt;0) roi.x=0; if(roi.y&lt;0) roi.y=0; if(roi.x&#43;roi.width &gt;= image.cols) roi.width = image.cols-roi.x; if(roi.y&#43;roi.height &gt;= image.rows) roi.heigth = image.rows-roi.y; 这样写代码，看上去不太直观，而且有些冗长，更谈不上优雅或者可读性。
或者这样：
int w = image.cols; int h = image.rows; int x0 = std::max&lt;int&gt;(0, roi.tl().x); int y0 = std::max&lt;int&gt;(0, roi.tl().y); int x1 = std::min&lt;int&gt;(w, roi.br().x); int y1 = std::min&lt;int&gt;(h, roi.br().y); roi = cv::Rect(cv::Point(x0, y0), cv::Point(x1, y1)); 稍微增加了些可读性，特别是如果习惯于使用stl的max/min函数进行边界检查。但是仍然冗长，不够优雅。冗长有什么坏处？一般来讲，冗长的代码不易于维护，可读性不会太强。另外以上面这段实现为例，由于反复使用同一变量，仅仅为了对其不同的成员做类似的操作，非常容易导致低级错误。">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-06-04T08:15:20+08:00">
    <meta property="article:modified_time" content="2024-06-04T08:15:20+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenCV图像裁剪：使用&amp;运算符在OpenCV图像裁剪时进行边界检查</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="ROI_1"></a>给定ROI的图像裁剪</h4> 
<p>假设需要按照既定的ROI对图像进行取窗裁剪，用<code>cv::Rect</code>给定ROI区域，裁剪可以按照如下方式：</p> 
<pre><code class="prism language-cpp">cv<span class="token double-colon punctuation">::</span>Mat image <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"/path/to/image.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
cv<span class="token double-colon punctuation">::</span>Rect roi <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Rect</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
cv<span class="token double-colon punctuation">::</span>Mat crop <span class="token operator">=</span> <span class="token function">image</span><span class="token punctuation">(</span>roi<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_11"></a>限制边界</h4> 
<p>如果roi的坐标超出了图像的合法区域，会引发运行时错误，导致程序崩溃。此时一般要提前进行边界检查和规范，比如这样：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span><span class="token punctuation">(</span>roi<span class="token punctuation">.</span>x<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> roi<span class="token punctuation">.</span>x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>roi<span class="token punctuation">.</span>y<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> roi<span class="token punctuation">.</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>roi<span class="token punctuation">.</span>x<span class="token operator">+</span>roi<span class="token punctuation">.</span>width <span class="token operator">&gt;=</span> image<span class="token punctuation">.</span>cols<span class="token punctuation">)</span> roi<span class="token punctuation">.</span>width <span class="token operator">=</span> image<span class="token punctuation">.</span>cols<span class="token operator">-</span>roi<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>roi<span class="token punctuation">.</span>y<span class="token operator">+</span>roi<span class="token punctuation">.</span>height <span class="token operator">&gt;=</span> image<span class="token punctuation">.</span>rows<span class="token punctuation">)</span> roi<span class="token punctuation">.</span>heigth <span class="token operator">=</span> image<span class="token punctuation">.</span>rows<span class="token operator">-</span>roi<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
</code></pre> 
<p>这样写代码，看上去不太直观，而且有些冗长，更谈不上优雅或者可读性。</p> 
<p>或者这样：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> w <span class="token operator">=</span> image<span class="token punctuation">.</span>cols<span class="token punctuation">;</span>
<span class="token keyword">int</span> h <span class="token operator">=</span> image<span class="token punctuation">.</span>rows<span class="token punctuation">;</span>

<span class="token keyword">int</span> x0 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">max</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> roi<span class="token punctuation">.</span><span class="token function">tl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> y0 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">max</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> roi<span class="token punctuation">.</span><span class="token function">tl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> x1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">min</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> roi<span class="token punctuation">.</span><span class="token function">br</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> y1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">min</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> roi<span class="token punctuation">.</span><span class="token function">br</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

roi <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Rect</span><span class="token punctuation">(</span>cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span>x0<span class="token punctuation">,</span> y0<span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token double-colon punctuation">::</span><span class="token function">Point</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>稍微增加了些可读性，特别是如果习惯于使用stl的max/min函数进行边界检查。但是仍然冗长，不够优雅。冗长有什么坏处？一般来讲，冗长的代码不易于维护，可读性不会太强。另外以上面这段实现为例，由于反复使用同一变量，仅仅为了对其不同的成员做类似的操作，非常容易导致低级错误。</p> 
<h4><a id="Operator___Get_Intersection_of_cvRect_39"></a>Operator &amp; : Get Intersection of cv::Rect</h4> 
<p>这个运算符<code>&amp;</code>比较直观。在C/C++语法中，<code>&amp;</code>属于位运算，是按位与的功能。cv::Rect类型重载了它，可以想象它的功能就是取矩形的相交区域。所以要对图像ROI的cv::Rect进行边界限制，那么将ROI和表示图像区域的Bounding Box求相交区域即可。代码实现如下：</p> 
<pre><code class="prism language-cpp">cv<span class="token double-colon punctuation">::</span>Rect <span class="token function">bbox</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mat<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> mat<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
cv<span class="token double-colon punctuation">::</span>Rect roi <span class="token operator">=</span> roi <span class="token operator">&amp;</span> bbox<span class="token punctuation">;</span> <span class="token comment">// that's all</span>
</code></pre> 
<p>这样基本上就一句话完成了边界限制。</p> 
<h4><a id="Whats_More_verify_if_rect_is_inside_image_50"></a>What’s More: verify if rect is inside image</h4> 
<p>进一步说，如果要检查一个rect是否在图像区域内，不用Operator的话，一般按照以下思路实现：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">rectIsInside</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Rect<span class="token operator">&amp;</span> rect<span class="token punctuation">,</span> <span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> image<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        rect<span class="token punctuation">.</span>x<span class="token operator">&gt;=</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> 
        rect<span class="token punctuation">.</span>y<span class="token operator">&gt;=</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> 
        rect<span class="token punctuation">.</span>x <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">&lt;</span> m<span class="token punctuation">.</span>cols <span class="token operator">&amp;&amp;</span> 
        rect<span class="token punctuation">.</span>x <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">&lt;</span> m<span class="token punctuation">.</span>rows<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>但是如果使用了<code>&amp;</code>运算符，life will be much easier.</p> 
<pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">rectIsInside</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Rect<span class="token operator">&amp;</span> rect<span class="token punctuation">,</span> <span class="token keyword">const</span> cv<span class="token double-colon punctuation">::</span>Mat<span class="token operator">&amp;</span> image<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    cv<span class="token double-colon punctuation">::</span>Rect <span class="token function">bbox</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> image<span class="token punctuation">.</span>rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>rect <span class="token operator">&amp;</span> bbox<span class="token punctuation">)</span> <span class="token operator">==</span> rect<span class="token punctuation">;</span> <span class="token comment">// elegent and efficient</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>简洁、优雅、可读性强的实现方式。</p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6f12df46f16a96fd9b6e47403849a2b5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">一篇文章讲透数据结构之树and二叉树</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/42eff2d090101514170c9d268afb1f56/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">HTML跳动的爱心</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>