<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>c# WebService创建与调用 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/f913d17147e7318edda6fa4b38ddc09b/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="c# WebService创建与调用">
  <meta property="og:description" content="c# WebService创建与调用 文章目录 c# WebService创建与调用一、前言二、webService相关术语1.XML2. WSDL3. SOAP 三、创建四、调用4.1 添加引用的方式4.2 动态代理的方式4.3 HttpWebRequest的方式 五、扩展 一、前言 WebService，顾名思义就是基于Web的服务。它使用Web(HTTP)方式，接收和响应外部系统的某种请求。从而实现远程调用。
我们可以调用互联网上查询天气信息Web服务，然后将它嵌入到我们的程序(C/S或B/S程序)当中来，当用户从我们的网点看到天气信息时，他会认为我们为他提供了很多的信息服务，但其实我们什么也没有做，只是简单调用了一下服务器上的一段代码而已。
ISO的七层模型 ： 物理层、数据链路层、网络层、传输层、表示层、会话层、应用层
Socket访问 ： Socket属于传输层，它是对Tcp/ip协议的实现，包含TCP/UDP,它是所有通信协议的基础，Http协议需要Socket支持，以Socket作为基础
Socket通信特点：
开启端口，该通信是 长连接的通信 ，很容易被防火墙拦截，可以通过心跳机制来实现 ，开发难度大 传输的数据一般是字符串 ，可读性不强socket端口不便于推广性能相对于其他的通信协议是最优的 Http协议访问 ： 属于应用层的协议，对Socket进行了封装
跨平台传数据不够友好对第三方应用提供的服务，希望对外暴露服务接口问题数据封装不够友好 ：可以用xml封装数据希望给第三方应用提供web方式的服务 （http &#43; xml） = web Service 二、webService相关术语 1.XML Extensible Markup Language －扩展性标记语言
XML，用于传输格式化的数据，是Web服务的基础。namespace-命名空间。xmlns=“http://itcast.cn” 使用默认命名空间。xmlns:itcast=“http://itcast.cn”使用指定名称的命名空间。 2. WSDL WebService Description Language – Web服务描述语言。
通过XML形式说明服务在什么地方－地址。通过XML形式说明服务提供什么样的方法 – 如何调用。 3. SOAP Simple Object Access Protocol –简单对象访问协议
SOAP作为一个基于XML语言的协议用于有网上传输数据。SOAP = 在HTTP的基础上&#43;XML数据。SOAP是基于HTTP的。 SOAP的组成如下：
Envelope – 必须的部分。以XML的根元素出现。Headers – 可选的。Body – 必须的。在body部分，包含要执行的服务器的方法。和发送到服务器的数据。 三、创建 新建项目，选择 “ASP.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-12T15:56:02+08:00">
    <meta property="article:modified_time" content="2024-03-12T15:56:02+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">c# WebService创建与调用</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="c_WebService_0"></a>c# WebService创建与调用</h2> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#c_WebService_0" rel="nofollow">c# WebService创建与调用</a></li><li><ul><li><a href="#_8" rel="nofollow">一、前言</a></li><li><a href="#webService_33" rel="nofollow">二、webService相关术语</a></li><li><ul><li><a href="#1XML_35" rel="nofollow">1.XML</a></li><li><a href="#2_WSDL_45" rel="nofollow">2. WSDL</a></li><li><a href="#3_SOAP_52" rel="nofollow">3. SOAP</a></li></ul> 
   </li><li><a href="#_66" rel="nofollow">三、创建</a></li><li><a href="#_151" rel="nofollow">四、调用</a></li><li><ul><li><a href="#41__153" rel="nofollow">4.1 添加引用的方式</a></li><li><a href="#42__180" rel="nofollow">4.2 动态代理的方式</a></li><li><a href="#43_HttpWebRequest_347" rel="nofollow">4.3 HttpWebRequest的方式</a></li></ul> 
   </li><li><a href="#_526" rel="nofollow">五、扩展</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<hr> 
<h3><a id="_8"></a>一、前言</h3> 
<p><code>WebService</code>，顾名思义就是基于Web的服务。它使用Web(HTTP)方式，接收和响应外部系统的某种请求。从而实现远程调用。</p> 
<p>我们可以调用互联网上查询天气信息Web服务，然后将它嵌入到我们的程序(C/S或B/S程序)当中来，当用户从我们的网点看到天气信息时，他会认为我们为他提供了很多的信息服务，但其实我们什么也没有做，只是简单调用了一下服务器上的一段代码而已。</p> 
<p><strong>ISO的七层模型 ：</strong> 物理层、数据链路层、网络层、传输层、表示层、会话层、应用层</p> 
<p><strong>Socket访问 ：</strong> Socket属于传输层，它是对Tcp/ip协议的实现，包含TCP/UDP,它是所有通信协议的基础，Http协议需要Socket支持，以Socket作为基础</p> 
<p><strong>Socket通信特点：</strong></p> 
<ul><li>开启端口，该通信是 长连接的通信 ，很容易被防火墙拦截，可以通过心跳机制来实现 ，开发难度大 传输的数据一般是字符串 ，可读性不强</li><li>socket端口不便于推广</li><li>性能相对于其他的通信协议是最优的</li></ul> 
<p><strong>Http协议访问 ：</strong> 属于应用层的协议，对Socket进行了封装</p> 
<ul><li>跨平台</li><li>传数据不够友好</li><li>对第三方应用提供的服务，希望对外暴露服务接口问题</li><li>数据封装不够友好 ：可以用xml封装数据</li><li>希望给第三方应用提供web方式的服务 （http + xml） = web Service</li></ul> 
<h3><a id="webService_33"></a>二、webService相关术语</h3> 
<h4><a id="1XML_35"></a>1.XML</h4> 
<p><strong>Extensible Markup Language</strong> －扩展性标记语言</p> 
<ul><li>XML，用于传输格式化的数据，是Web服务的基础。</li><li>namespace-命名空间。</li><li>xmlns=“http://itcast.cn” 使用默认命名空间。</li><li>xmlns:itcast=“http://itcast.cn”使用指定名称的命名空间。</li></ul> 
<h4><a id="2_WSDL_45"></a>2. WSDL</h4> 
<p><strong>WebService Description Language</strong> – Web服务描述语言。</p> 
<ul><li>通过XML形式说明服务在什么地方－地址。</li><li>通过XML形式说明服务提供什么样的方法 – 如何调用。</li></ul> 
<h4><a id="3_SOAP_52"></a>3. SOAP</h4> 
<p><strong>Simple Object Access Protocol</strong> –简单对象访问协议</p> 
<ul><li>SOAP作为一个基于XML语言的协议用于有网上传输数据。</li><li>SOAP = 在HTTP的基础上+XML数据。</li><li>SOAP是基于HTTP的。</li></ul> 
<p><strong>SOAP的组成如下：</strong></p> 
<ul><li>Envelope – 必须的部分。以XML的根元素出现。</li><li>Headers – 可选的。</li><li>Body – 必须的。在body部分，包含要执行的服务器的方法。和发送到服务器的数据。</li></ul> 
<h3><a id="_66"></a>三、创建</h3> 
<p>新建项目，选择 “ASP.NET Web应用程序(.NET Framework)”。</p> 
<p><img src="https://images2.imgbox.com/5c/34/1LJabMCL_o.png" alt="在这里插入图片描述"></p> 
<p>填写好项目名称、选择项目位置以及所使用的框架，然后点击创建。</p> 
<p><img src="https://images2.imgbox.com/c2/d4/REM1S46L_o.png" alt="在这里插入图片描述"><br> 选择一个空模板，去掉为https配置选项，然后创建。</p> 
<p><img src="https://images2.imgbox.com/55/0a/GBUOLcEQ_o.png" alt="在这里插入图片描述"></p> 
<p>打开解决方案资源管理器-右键创建的web项目-添加-新建项-添加 <code>web 服务(AMSX)</code>。</p> 
<p><img src="https://images2.imgbox.com/32/ff/vcr3S6vK_o.png" alt="在这里插入图片描述"><br> 默认的是HelloWorld方法，自己可以添加几个方法。</p> 
<p><img src="https://images2.imgbox.com/9c/dd/LWVWbkui_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>Services</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">webServiceServer</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/// &lt;summary&gt;</span>
    <span class="token comment">/// WebService1 的摘要说明</span>
    <span class="token comment">/// &lt;/summary&gt;</span>
    <span class="token punctuation">[</span><span class="token function">WebService</span><span class="token punctuation">(</span>Namespace <span class="token operator">=</span> <span class="token string">"http://tempuri.org/"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">WebServiceBinding</span><span class="token attribute-arguments"><span class="token punctuation">(</span>ConformsTo <span class="token operator">=</span> WsiProfiles<span class="token punctuation">.</span>BasicProfile1_1<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">System<span class="token punctuation">.</span>ComponentModel<span class="token punctuation">.</span>ToolboxItem</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token comment">// 若要允许使用 ASP.NET AJAX 从脚本中调用此 Web 服务，请取消注释以下行。 </span>
    <span class="token comment">// [System.Web.Script.Services.ScriptService]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebService1</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>WebService</span></span>
    <span class="token punctuation">{<!-- --></span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">WebMethod</span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">HelloWorld</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"Hello World"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">WebMethod</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Description <span class="token operator">=</span> <span class="token string">"求和的方法"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> <span class="token function">addition</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">double</span></span> i<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">double</span></span> j<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> i <span class="token operator">+</span> j<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">WebMethod</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Description <span class="token operator">=</span> <span class="token string">"求差的方法"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> <span class="token function">subtract</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">double</span></span> i<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">double</span></span> j<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> i <span class="token operator">-</span> j<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">WebMethod</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Description <span class="token operator">=</span> <span class="token string">"求积的方法"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> <span class="token function">multiplication</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">double</span></span> i<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">double</span></span> j<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> i <span class="token operator">*</span> j<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">WebMethod</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Description <span class="token operator">=</span> <span class="token string">"求商的方法"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> <span class="token function">division</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">double</span></span> i<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">double</span></span> j<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> i <span class="token operator">/</span> j<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>启动项目。在上面我们可以看到我们所写的五个方法，我选择其中一个点进去，点击调用后我们可以看到输出了“4”。</p> 
<p><img src="https://images2.imgbox.com/03/b4/QQlisyfE_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/48/ec/EfcfcIyV_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/78/66/HQfpnvPV_o.png" alt="在这里插入图片描述"><br> 到这里，就创建好了一个服务了。</p> 
<h3><a id="_151"></a>四、调用</h3> 
<h4><a id="41__153"></a>4.1 添加引用的方式</h4> 
<p>新建项目-添加-服务引用，打开刚刚启动的网站，复制这个地址粘贴到服务引用中。</p> 
<p><img src="https://images2.imgbox.com/12/ad/aVx9V3Dg_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/45/8f/XM7wgGgS_o.png" alt="在这里插入图片描述"><br> 接下来点击<strong>高级</strong>，添加Web 引用(W)-在打开的界面中的URL中输入刚刚复制的网址-点击蓝色箭头-添加引用，即可在解决方案资源管理器中看到我们所添加的服务引用。<br> <img src="https://images2.imgbox.com/47/9b/z2m6Yoxc_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/49/a3/KBzeAmUy_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/53/48/cDPHgMA7_o.png" alt="在这里插入图片描述"><br> 这样引用就添加好了，那我们现在就开始使用吧。</p> 
<p><img src="https://images2.imgbox.com/e2/3b/zA7sVBq5_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/d4/c4/sxeb1cbc_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/77/64/3u4tQHja_o.png" alt="在这里插入图片描述"></p> 
<p>直接运行一下点击按钮，看看结果</p> 
<p><img src="https://images2.imgbox.com/e1/68/bhjkpbQe_o.png" alt="在这里插入图片描述"></p> 
<p>调用成功~</p> 
<h4><a id="42__180"></a>4.2 动态代理的方式</h4> 
<p>新建一个代理类<br> <img src="https://images2.imgbox.com/85/ca/cV8BMPRr_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>CodeDom</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>CodeDom<span class="token punctuation">.</span>Compiler</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>Caching</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>Services<span class="token punctuation">.</span>Description</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Xml<span class="token punctuation">.</span>Serialization</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">webServiceClient</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebServiceHelper</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CreateWebServiceDLL</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> url<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> className<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> methodName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> filePath<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1. 使用 WebClient 下载 WSDL 信息。</span>
            <span class="token class-name">WebClient</span> web <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//Stream stream = web.OpenRead(url + "?WSDL");</span>
            <span class="token comment">//CertificateTrust.SetCertificatePolicy();//证书出现问题时调用此代码//未能为 SSL/TLS 安全通道建立信任关系</span>
            <span class="token class-name">Stream</span> stream <span class="token operator">=</span> web<span class="token punctuation">.</span><span class="token function">OpenRead</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2. 创建和格式化 WSDL 文档。</span>
            <span class="token class-name">ServiceDescription</span> description <span class="token operator">=</span> ServiceDescription<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果不存在就创建file文件夹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Directory<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Directory<span class="token punctuation">.</span><span class="token function">CreateDirectory</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">".dll"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//判断缓存是否过期</span>
                <span class="token class-name"><span class="token keyword">var</span></span> cachevalue <span class="token operator">=</span> HttpRuntime<span class="token punctuation">.</span>Cache<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>className <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cachevalue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//缓存过期删除dll</span>
                    File<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">".dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 如果缓存没有过期直接返回</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 3. 创建客户端代理代理类。</span>
            <span class="token class-name">ServiceDescriptionImporter</span> importer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceDescriptionImporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 指定访问协议。</span>
            importer<span class="token punctuation">.</span>ProtocolName <span class="token operator">=</span> <span class="token string">"Soap"</span><span class="token punctuation">;</span>
            <span class="token comment">// 生成客户端代理。</span>
            importer<span class="token punctuation">.</span>Style <span class="token operator">=</span> ServiceDescriptionImportStyle<span class="token punctuation">.</span>Client<span class="token punctuation">;</span>
            importer<span class="token punctuation">.</span>CodeGenerationOptions <span class="token operator">=</span> CodeGenerationOptions<span class="token punctuation">.</span>GenerateProperties <span class="token operator">|</span> CodeGenerationOptions<span class="token punctuation">.</span>GenerateNewAsync<span class="token punctuation">;</span>
            <span class="token comment">// 添加 WSDL 文档。</span>
            importer<span class="token punctuation">.</span><span class="token function">AddServiceDescription</span><span class="token punctuation">(</span>description<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4. 使用 CodeDom 编译客户端代理类。</span>
            <span class="token comment">// 为代理类添加命名空间，缺省为全局空间。</span>
            <span class="token class-name">CodeNamespace</span> nmspace <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CodeNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CodeCompileUnit</span> unit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CodeCompileUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            unit<span class="token punctuation">.</span>Namespaces<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>nmspace<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ServiceDescriptionImportWarnings</span> warning <span class="token operator">=</span> importer<span class="token punctuation">.</span><span class="token function">Import</span><span class="token punctuation">(</span>nmspace<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CodeDomProvider</span> provider <span class="token operator">=</span> CodeDomProvider<span class="token punctuation">.</span><span class="token function">CreateProvider</span><span class="token punctuation">(</span><span class="token string">"CSharp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">CompilerParameters</span> parameter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CompilerParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parameter<span class="token punctuation">.</span>GenerateExecutable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment">// 可以指定你所需的任何文件名。</span>
            parameter<span class="token punctuation">.</span>OutputAssembly <span class="token operator">=</span> filePath <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">".dll"</span><span class="token punctuation">;</span>
            parameter<span class="token punctuation">.</span>ReferencedAssemblies<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"System.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parameter<span class="token punctuation">.</span>ReferencedAssemblies<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"System.XML.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parameter<span class="token punctuation">.</span>ReferencedAssemblies<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"System.Web.Services.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parameter<span class="token punctuation">.</span>ReferencedAssemblies<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"System.Data.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 生成dll文件，并会把WebService信息写入到dll里面</span>
            <span class="token class-name">CompilerResults</span> result <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">CompileAssemblyFromDom</span><span class="token punctuation">(</span>parameter<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>Errors<span class="token punctuation">.</span>HasErrors<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 显示编译错误信息</span>
                <span class="token class-name">System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">CompilerError</span> ce <span class="token keyword">in</span> result<span class="token punctuation">.</span>Errors<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    sb<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>ce<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    sb<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Environment<span class="token punctuation">.</span>NewLine<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//记录缓存</span>
            <span class="token class-name"><span class="token keyword">var</span></span> objCache <span class="token operator">=</span> HttpRuntime<span class="token punctuation">.</span>Cache<span class="token punctuation">;</span>
            <span class="token comment">// 缓存信息写入dll文件</span>
            objCache<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>className <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> methodName<span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeSpan<span class="token punctuation">.</span>Zero<span class="token punctuation">,</span> CacheItemPriority<span class="token punctuation">.</span>High<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>调用方法，前面四个配置信息可以写在app.config里，也可以直接代码里写死。</p> 
<p><img src="https://images2.imgbox.com/08/57/4E3xOc2K_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Forms</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">webServiceClient<span class="token punctuation">.</span>myWebService</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">webServiceClient</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Form1</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Form</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token function">Form1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">button1_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">WebService1</span> wb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebService1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">double</span></span> s <span class="token operator">=</span> wb<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            textBox1<span class="token punctuation">.</span>Text <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UseWebService</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> xml<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 读取配置文件，获取配置信息</span>
            <span class="token class-name"><span class="token keyword">string</span></span> url <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">@"http://localhost:52264/WebService1.asmx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ConfigurationManager.AppSettings["WebServiceAddress"];//WebService地址</span>
            <span class="token class-name"><span class="token keyword">string</span></span> className <span class="token operator">=</span> <span class="token string">"WebService1"</span><span class="token punctuation">;</span><span class="token comment">//ConfigurationManager.AppSettings["ClassName"];//WebService提供的类名</span>
            <span class="token class-name"><span class="token keyword">string</span></span> methodName <span class="token operator">=</span> <span class="token string">"subtract"</span><span class="token punctuation">;</span><span class="token comment">//ConfigurationManager.AppSettings["MethodName"];// WebService方法名</span>
            <span class="token class-name"><span class="token keyword">string</span></span> filePath <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">@"D:\test\webServiceServer\bin\");//ConfigurationManager.AppSettings["</span>FilePath"<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//存放dll文件的地址</span>


            <span class="token comment">// 调用WebServiceHelper</span>
            WebServiceHelper<span class="token punctuation">.</span><span class="token function">CreateWebServiceDLL</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> className<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 读取dll内容</span>
            <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> filedata <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllBytes</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">".dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 加载程序集信息</span>
            <span class="token class-name">Assembly</span> asm <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>filedata<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Type</span> t <span class="token operator">=</span> asm<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建实例</span>
            <span class="token class-name"><span class="token keyword">object</span></span> o <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MethodInfo</span> method <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 参数</span>
            <span class="token comment">//object[] args = { xml };</span>

            <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用访问，获取方法返回值</span>
            <span class="token class-name"><span class="token keyword">string</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//输出返回值</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"返回值:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token keyword">value</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">button2_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">UseWebService</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c0/db/zvSZSecK_o.png" alt="在这里插入图片描述"></p> 
<p>调用成功~</p> 
<h4><a id="43_HttpWebRequest_347"></a>4.3 HttpWebRequest的方式</h4> 
<p>新建一个HttpHelper帮助类<br> <img src="https://images2.imgbox.com/44/74/z1t1OLtu_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Web</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Xml</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">webServiceClient</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpHelper</span>
    <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">CallServiceByGet</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> strURL<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

            <span class="token comment">//创建一个HTTP请求</span>
            <span class="token class-name">HttpWebRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span>HttpWebRequest<span class="token punctuation">)</span>WebRequest<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>strURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span>Method <span class="token operator">=</span> <span class="token string">"get"</span><span class="token punctuation">;</span>
            <span class="token class-name">HttpWebResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>HttpWebResponse<span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">GetResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Stream</span> s <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">GetResponseStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//转化为XML，自己进行处理</span>
            <span class="token class-name">XmlTextReader</span> Reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">XmlTextReader</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Reader<span class="token punctuation">.</span><span class="token function">MoveToContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> strValue <span class="token operator">=</span> Reader<span class="token punctuation">.</span><span class="token function">ReadInnerXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Reader<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            strValue <span class="token operator">=</span> strValue<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"&lt;"</span><span class="token punctuation">,</span> <span class="token string">"&lt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            strValue <span class="token operator">=</span> strValue<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"&gt;"</span><span class="token punctuation">,</span> <span class="token string">"&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> strValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">CallServiceByPost</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> strURL<span class="token punctuation">,</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> parameters<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//创建一个HTTP请求</span>
            <span class="token class-name">HttpWebRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span>HttpWebRequest<span class="token punctuation">)</span>WebRequest<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>strURL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//Post请求方式</span>
            request<span class="token punctuation">.</span>Method <span class="token operator">=</span> <span class="token string">"POST"</span><span class="token punctuation">;</span>
            <span class="token comment">//内容类型</span>
            request<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"application/x-www-form-urlencoded"</span><span class="token punctuation">;</span>
            <span class="token comment">//设置参数，并进行URL编码</span>
            <span class="token class-name">StringBuilder</span> codedString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> key <span class="token keyword">in</span> parameters<span class="token punctuation">.</span>Keys<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                codedString<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>HttpUtility<span class="token punctuation">.</span><span class="token function">UrlEncode</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                codedString<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                codedString<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>HttpUtility<span class="token punctuation">.</span><span class="token function">UrlEncode</span><span class="token punctuation">(</span>parameters<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                codedString<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name"><span class="token keyword">string</span></span> paraUrlCoded <span class="token operator">=</span> codedString<span class="token punctuation">.</span>Length <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">?</span> <span class="token keyword">string</span><span class="token punctuation">.</span>Empty <span class="token punctuation">:</span> codedString<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> codedString<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//string paraUrlCoded = HttpUtility.UrlEncode("ProductId");</span>
            <span class="token comment">//paraUrlCoded += "=" + HttpUtility.UrlEncode(this.textBox1.Text);</span>
            <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> payload<span class="token punctuation">;</span>
            <span class="token comment">//将URL编码后的字符串转化为字节</span>
            payload <span class="token operator">=</span> System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>paraUrlCoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//设置请求的ContentLength</span>
            request<span class="token punctuation">.</span>ContentLength <span class="token operator">=</span> payload<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>
            <span class="token comment">//发送请求，获得请求流</span>
            <span class="token class-name">Stream</span> writer <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">GetRequestStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将请求参数写入流</span>
            writer<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> payload<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//关闭请求流</span>
            writer<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获得响应流</span>
            <span class="token class-name">HttpWebResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span>HttpWebResponse<span class="token punctuation">)</span>request<span class="token punctuation">.</span><span class="token function">GetResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Stream</span> s <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">GetResponseStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//转化为XML，自己进行处理</span>
            <span class="token class-name">XmlTextReader</span> Reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">XmlTextReader</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Reader<span class="token punctuation">.</span><span class="token function">MoveToContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">string</span></span> strValue <span class="token operator">=</span> Reader<span class="token punctuation">.</span><span class="token function">ReadInnerXml</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Reader<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            strValue <span class="token operator">=</span> strValue<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"&lt;"</span><span class="token punctuation">,</span> <span class="token string">"&lt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            strValue <span class="token operator">=</span> strValue<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span><span class="token string">"&gt;"</span><span class="token punctuation">,</span> <span class="token string">"&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> strValue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/aa/fc/N8a67HBk_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Reflection</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Security<span class="token punctuation">.</span>Policy</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Forms</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Xml<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">webServiceClient<span class="token punctuation">.</span>myWebService</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">webServiceClient</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">Form1</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Form</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token function">Form1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">InitializeComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">button1_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">WebService1</span> wb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebService1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">double</span></span> s <span class="token operator">=</span> wb<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            textBox1<span class="token punctuation">.</span>Text <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">UseWebService</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> xml<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 读取配置文件，获取配置信息</span>
            <span class="token class-name"><span class="token keyword">string</span></span> url <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">@"http://localhost:52264/WebService1.asmx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ConfigurationManager.AppSettings["WebServiceAddress"];//WebService地址</span>
            <span class="token class-name"><span class="token keyword">string</span></span> className <span class="token operator">=</span> <span class="token string">"WebService1"</span><span class="token punctuation">;</span><span class="token comment">//ConfigurationManager.AppSettings["ClassName"];//WebService提供的类名</span>
            <span class="token class-name"><span class="token keyword">string</span></span> methodName <span class="token operator">=</span> <span class="token string">"subtract"</span><span class="token punctuation">;</span><span class="token comment">//ConfigurationManager.AppSettings["MethodName"];// WebService方法名</span>
            <span class="token class-name"><span class="token keyword">string</span></span> filePath <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">@"D:\test\webServiceServer\bin\");//ConfigurationManager.AppSettings["</span>FilePath"<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//存放dll文件的地址</span>


            <span class="token comment">// 调用WebServiceHelper</span>
            WebServiceHelper<span class="token punctuation">.</span><span class="token function">CreateWebServiceDLL</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> className<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 读取dll内容</span>
            <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> filedata <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllBytes</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">".dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 加载程序集信息</span>
            <span class="token class-name">Assembly</span> asm <span class="token operator">=</span> Assembly<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span>filedata<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Type</span> t <span class="token operator">=</span> asm<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 创建实例</span>
            <span class="token class-name"><span class="token keyword">object</span></span> o <span class="token operator">=</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MethodInfo</span> method <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 参数</span>
            <span class="token comment">//object[] args = { xml };</span>

            <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 调用访问，获取方法返回值</span>
            <span class="token class-name"><span class="token keyword">string</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//输出返回值</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"返回值:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token keyword">value</span></span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">button2_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">UseWebService</span><span class="token punctuation">(</span><span class="token string">"111"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">button3_Click</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">EventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parameters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"i"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parameters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"j"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">string</span></span> url <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">@"http://localhost:52264/WebService1.asmx/addition"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> HttpHelper<span class="token punctuation">.</span><span class="token function">CallServiceByPost</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>调用成功~</p> 
<p>到这里，我们就把三种调用方式讲完咯。</p> 
<h3><a id="_526"></a>五、扩展</h3> 
<p>这里有一些别人写好的服务，我们可以直接调用。</p> 
<p>调用别人写好的webService，来体验一把 <a href="http://www.webxml.com.cn/zh_cn/index.aspx" rel="nofollow">http://www.webxml.com.cn/zh_cn/index.aspx</a></p> 
<p><img src="https://images2.imgbox.com/d6/28/4Vs1ylQT_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/f1/f8/emsHLWwv_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/a5/15/zdoo1Lmw_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/40a1ab5f7390031867c27438982b1491/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">配置Idea中的GitLab（Mac 版）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5dcfa13061c0275b520eab55afc1cc6b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据结构奇妙旅程之二叉平衡树进阶---AVL树</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>