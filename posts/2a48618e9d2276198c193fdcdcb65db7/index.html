<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android打造丝滑的Activity recreate重建（主题切换）过渡动画 - 编程大咖</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:url" content="https://bcdaka.github.io/posts/2a48618e9d2276198c193fdcdcb65db7/">
  <meta property="og:site_name" content="编程大咖">
  <meta property="og:title" content="Android打造丝滑的Activity recreate重建（主题切换）过渡动画">
  <meta property="og:description" content="前言 当应用程序支持多种语言或主题时，切换语言或主题通常需要重新启动 Activity 以重新加载配置。虽然 recreate 是一种常用的重建 Activity 方法，但它不支持像在 Activity 之间切换时那样使用过渡动画。特别是在切换 浅色/深色 主题时，由于缺乏过渡动画而显得很生硬。为了提升改善这一点，只能自己实现过渡动画以提供更流畅的用户体验。
一开始，我考虑在保存状态时使用 onSaveInstanceState 将 activity.window.decorView 绘制成位图并保存到 outState 中。然后在 onCreate 中读取该位图，并通过 WindowManager 在整个屏幕上显示一个铺满的 ImageView，将位图显示在 ImageView 上并执行动画。然而，我尝试后发现 WindowManager 的显示会比 Activity 晚一些，导致出现了闪屏的情况。
在我继续思考的过程中，偶然发现了一篇博客：Change Theme Dynamically with Circular Reveal Animation on Android。原来我与大佬的想法只有一步之差。该博客中的方法是在 Activity 的布局中添加一个铺满全屏的 ImageView，并将其 visibility 设置为 gone。这样，我们就可以在需要时将位图显示在 ImageView 上，而不需要使用 WindowManager。恍然大悟，我怎么没想到呢！🌟
效果 废话不多说，以下是 Demo 实现的效果
Demo源码放在了最下面
步骤 大致分为以下几步：
设置Activity为全屏显示
确保Activity占据整个屏幕空间，去除状态栏和导航栏的影响。添加隐藏的ImageView
在Activity原有的布局顶部添加一个占满全屏的ImageView，默认隐藏。
用于在主题切换后显示Activity重建前保存的Bitmap修改主题后保存状态并重建activity
当用户切换主题时，先将当前Activity的decorView绘制为Bitmap保存到状态
recreate重新创建Activity以更新主题activity重启后通过保存的状态执行动画
在Activity重建后，通过之前保存的状态恢复界面内容并执行揭露动画 将Activity设置为全屏 我这里使用一个BaseActivity来作为基础activity，实现了主题配置的加载和activity全屏的设置
/** * 基础 Activity * 实现了加载本地配置的主题和语言 * @author Thousand-Dust */ abstract class BaseActivity : AppCompatActivity() { override fun attachBaseContext(newBase: Context) { // 加载本地配置的主题 val theme = AppGlobals.">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-19T13:36:46+08:00">
    <meta property="article:modified_time" content="2024-02-19T13:36:46+08:00">

	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
  


</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="编程大咖" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">编程大咖</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android打造丝滑的Activity recreate重建（主题切换）过渡动画</h1>
			
		</header>
		<div id="gatop"></div>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>前言</h3> 
<p>当应用程序支持多种语言或主题时，切换语言或主题通常需要重新启动 <em>Activity</em> 以重新加载配置。虽然 <em>recreate</em> 是一种常用的重建 Activity 方法，但它不支持像在 Activity 之间切换时那样使用过渡动画。特别是在切换 <em>浅色/深色</em> 主题时，由于缺乏过渡动画而显得很生硬。为了提升改善这一点，只能自己实现过渡动画以提供更流畅的用户体验。</p> 
<p>一开始，我考虑在保存状态时使用 <em>onSaveInstanceState</em> 将 activity.window.decorView 绘制成位图并保存到 outState 中。然后在 onCreate 中读取该位图，并通过 <em>WindowManager</em> 在整个屏幕上显示一个铺满的 ImageView，将位图显示在 ImageView 上并执行动画。然而，我尝试后发现 WindowManager 的显示会比 Activity 晚一些，导致出现了闪屏的情况。</p> 
<p>在我继续思考的过程中，偶然发现了一篇博客：<a href="https://proandroiddev.com/change-theme-dynamically-with-circular-reveal-animation-on-android-8cd574f5f0d8" rel="nofollow">Change Theme Dynamically with Circular Reveal Animation on Android</a>。原来我与大佬的想法只有一步之差。该博客中的方法是在 <strong>Activity 的布局中添加一个铺满全屏的 ImageView</strong>，并将其 visibility 设置为 gone。这样，我们就可以在需要时将位图显示在 ImageView 上，而不需要使用 WindowManager。恍然大悟，我怎么没想到呢！🌟</p> 
<h3><a id="_6"></a>效果</h3> 
<p>废话不多说，以下是 Demo 实现的效果<br> <img src="https://images2.imgbox.com/37/00/DTR2moV9_o.gif" alt="请添加图片描述" width="380"></p> 
<p><strong>Demo源码放在了最下面</strong></p> 
<h2><a id="_11"></a>步骤</h2> 
<p>大致分为以下几步：</p> 
<ol><li><strong>设置Activity为全屏显示</strong><br> 确保Activity占据整个屏幕空间，去除状态栏和导航栏的影响。</li><li><strong>添加隐藏的ImageView</strong><br> 在Activity原有的布局顶部添加一个占满全屏的ImageView，默认隐藏。<br> 用于在主题切换后显示Activity重建前保存的Bitmap</li><li><strong>修改主题后保存状态并重建activity</strong><br> 当用户切换主题时，先将当前Activity的decorView绘制为Bitmap保存到状态<br> recreate重新创建Activity以更新主题</li><li><strong>activity重启后通过保存的状态执行动画</strong><br> 在Activity重建后，通过之前保存的状态恢复界面内容并执行揭露动画</li></ol> 
<h3><a id="Activity_23"></a>将Activity设置为全屏</h3> 
<p>我这里使用一个BaseActivity来作为基础activity，实现了主题配置的加载和activity全屏的设置</p> 
<pre><code class="prism language-kotlin"><span class="token comment">/**
 * 基础 Activity
 * 实现了加载本地配置的主题和语言
 * @author Thousand-Dust
 */</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> BaseActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">attachBaseContext</span><span class="token punctuation">(</span>newBase<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 加载本地配置的主题</span>
        <span class="token keyword">val</span> theme <span class="token operator">=</span> AppGlobals<span class="token punctuation">.</span><span class="token function">getTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        delegate<span class="token punctuation">.</span>localNightMode <span class="token operator">=</span> theme<span class="token punctuation">.</span>mode

<span class="token comment">//        val config = newBase.resources.configuration</span>
        <span class="token comment">// 加载本地配置的语言</span>
<span class="token comment">//        val language = AppGlobals.getLanguage()</span>
<span class="token comment">//        config.setLocale(language.locale)</span>
<span class="token comment">//        val context = newBase.createConfigurationContext(config)</span>
<span class="token comment">//        super.attachBaseContext(context)</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">attachBaseContext</span><span class="token punctuation">(</span>newBase<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token comment">// Activity全屏显示，隐藏状态栏和导航栏</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>R<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            window<span class="token punctuation">.</span><span class="token function">setDecorFitsSystemWindows</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            window<span class="token punctuation">.</span>decorView<span class="token punctuation">.</span>systemUiVisibility <span class="token operator">=</span> window<span class="token punctuation">.</span>decorView<span class="token punctuation">.</span>systemUiVisibility <span class="token operator">or</span>
                    View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_STABLE <span class="token operator">or</span>
                    View<span class="token punctuation">.</span>SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
        <span class="token punctuation">}</span>
        window<span class="token punctuation">.</span>statusBarColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>TRANSPARENT
        window<span class="token punctuation">.</span>navigationBarColor <span class="token operator">=</span> Color<span class="token punctuation">.</span>TRANSPARENT
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="ActivityImageView_65"></a>在Activity原有的布局顶部添加一个隐藏的ImageView</h3> 
<p>随便写的布局，只需要关注ClipImageView就好了</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.constraintlayout.widget.ConstraintLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">tools:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.MainActivity<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.appcompat.widget.Toolbar</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/toolbar<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintTop_toTopOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@string/app_name<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>?attr/colorPrimary<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>paddingTop</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>menu</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@menu/main_menu<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/textView<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Hello World!<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintBottom_toBottomOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintEnd_toEndOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintStart_toStartOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintTop_toTopOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintVertical_bias</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>0.355<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_marginTop</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>48dp<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Hello World!<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintEnd_toEndOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintStart_toStartOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintTop_toBottomOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/textView<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>com.td.demoactivityrecreatetransition.ClipImageView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/iv_transition<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>visibility</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>gone<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>androidx.constraintlayout.widget.ConstraintLayout</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>布局的显示效果<br> <img src="https://images2.imgbox.com/79/f4/s3GOPbnd_o.png" alt="在这里插入图片描述" width="380"></p> 
<p>ClipImageView是我为了方便使用动画实现的一个继承自ImageView的自定义View，在后面执行动画时用到</p> 
<pre><code class="prism language-kotlin"><span class="token comment">/**
 * 可以裁切的ImageView
 * @author Thousand-Dust
 */</span>
<span class="token keyword">class</span> ClipImageView <span class="token operator">:</span> androidx<span class="token punctuation">.</span>appcompat<span class="token punctuation">.</span>widget<span class="token punctuation">.</span><span class="token function">AppCompatImageView</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 裁切类型
     */</span>
    <span class="token keyword">enum</span> <span class="token keyword">class</span> ClipType <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 圆形
         */</span>
        CIRCLE<span class="token punctuation">,</span>
        <span class="token comment">/**
         * 圆形（反向裁切）
         */</span>
        CIRCLE_REVERSE<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 裁切类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> clipType <span class="token operator">=</span> ClipType<span class="token punctuation">.</span>CIRCLE

    <span class="token comment">/**
     * 裁切区域
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> clipPath <span class="token operator">=</span> <span class="token function">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> attrs<span class="token operator">:</span> AttributeSet<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> attrs<span class="token operator">:</span> AttributeSet<span class="token punctuation">,</span> defStyleAttr<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> defStyleAttr<span class="token punctuation">)</span>

    <span class="token comment">/**
     * 清空裁切
     */</span>
    <span class="token keyword">fun</span> <span class="token function">clearClip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        clipPath<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 裁切圆形
     * @param centerX 圆心X
     * @param centerY 圆心Y
     * @param radius 半径
     * @param clipType 裁切类型
     */</span>
    <span class="token keyword">fun</span> <span class="token function">clipCircle</span><span class="token punctuation">(</span>centerX<span class="token operator">:</span> Float<span class="token punctuation">,</span> centerY<span class="token operator">:</span> Float<span class="token punctuation">,</span> radius<span class="token operator">:</span> Float<span class="token punctuation">,</span> clipType<span class="token operator">:</span> ClipType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        clipPath<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        clipPath<span class="token punctuation">.</span><span class="token function">addCircle</span><span class="token punctuation">(</span>centerX<span class="token punctuation">,</span> centerY<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> Path<span class="token punctuation">.</span>Direction<span class="token punctuation">.</span>CW<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clipType <span class="token operator">=</span> clipType
        <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDraw</span><span class="token punctuation">(</span>canvas<span class="token operator">:</span> Canvas<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clipPath<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            canvas<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">when</span> <span class="token punctuation">(</span>clipType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ClipType<span class="token punctuation">.</span>CIRCLE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 裁切圆形</span>
                    canvas<span class="token punctuation">.</span><span class="token function">clipPath</span><span class="token punctuation">(</span>clipPath<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

                ClipType<span class="token punctuation">.</span>CIRCLE_REVERSE <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 反向裁切圆形</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>O<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        canvas<span class="token punctuation">.</span><span class="token function">clipOutPath</span><span class="token punctuation">(</span>clipPath<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        canvas<span class="token punctuation">.</span><span class="token function">clipPath</span><span class="token punctuation">(</span>clipPath<span class="token punctuation">,</span> Region<span class="token punctuation">.</span>Op<span class="token punctuation">.</span>DIFFERENCE<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 绘制图片</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onDraw</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>clipPath<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            canvas<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="activity_208"></a>修改主题后保存状态并重建activity</h3> 
<p>这个Activity继承自上面实现的BaseActivity，因此无需关心设置主题和activity全屏显示的问题。<br> MainActivity 的 transitionRecreate 方法实现了以下步骤：</p> 
<ol><li>获取切换主题的 Toolbar 中的 menu 按钮中心点（后面用作圆形揭露动画的中心点）</li><li>将当前 Activity 绘制到 Bitmap</li><li>将这些数据赋值给 recreateTransitionData 属性</li><li>调用 recreate 方法开始重建 Activity</li></ol> 
<p>在recreate调用后，onSaveInstanceState 会被调用以保存状态，在这里将 recreateTransitionData 属性值保存到状态中</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> MainActivity <span class="token operator">:</span> <span class="token function">BaseActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> toolbar<span class="token operator">:</span> Toolbar
    <span class="token keyword">private</span> <span class="token keyword">var</span> recreateTransitionData<span class="token operator">:</span> TransitionData<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token operator">..</span><span class="token punctuation">.</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>

        <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onSaveInstanceState</span><span class="token punctuation">(</span>outState<span class="token operator">:</span> Bundle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onSaveInstanceState</span><span class="token punctuation">(</span>outState<span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>recreateTransitionData <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 保存重建过渡动画 data 到状态</span>
            outState<span class="token punctuation">.</span><span class="token function">putParcelable</span><span class="token punctuation">(</span>TRANSITION_DATA_KEY<span class="token punctuation">,</span> recreateTransitionData<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 使用过渡动画重建（recreate）Activity
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">transitionRecreate</span><span class="token punctuation">(</span>type<span class="token operator">:</span> TransitionType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取切换主题menu的坐标（以menu的中心点为圆形揭露动画的中心点）</span>
        <span class="token keyword">val</span> menuItemView <span class="token operator">=</span> toolbar<span class="token punctuation">.</span>menu<span class="token punctuation">.</span><span class="token function">findItem</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>menu_theme_toggle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
            toolbar<span class="token punctuation">.</span>findViewById<span class="token operator">&lt;</span>View<span class="token operator">&gt;</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>itemId<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">val</span> location <span class="token operator">=</span> <span class="token function">IntArray</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        menuItemView<span class="token punctuation">.</span><span class="token function">getLocationOnScreen</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span>
        <span class="token keyword">val</span> centerX <span class="token operator">=</span> location<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> menuItemView<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2f</span>
        <span class="token keyword">val</span> centerY <span class="token operator">=</span> location<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> menuItemView<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2f</span>
        <span class="token comment">// Activity截图</span>
        <span class="token keyword">val</span> screenBitmap <span class="token operator">=</span> window<span class="token punctuation">.</span>decorView<span class="token punctuation">.</span><span class="token function">drawToBitmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        recreateTransitionData <span class="token operator">=</span> <span class="token function">TransitionData</span><span class="token punctuation">(</span>centerX<span class="token punctuation">,</span> centerY<span class="token punctuation">,</span> screenBitmap<span class="token punctuation">,</span> type<span class="token punctuation">)</span>
        <span class="token comment">// 重建Activity</span>
        <span class="token function">recreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">initView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        toolbar <span class="token operator">=</span> <span class="token function">findViewById</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>id<span class="token punctuation">.</span>toolbar<span class="token punctuation">)</span>
        <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>还有以上代码用到的类代码贴在下边</p> 
<pre><code class="prism language-kotlin"><span class="token comment">// -------- AppGlobals.kt --------</span>
<span class="token keyword">object</span> AppGlobals <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">const</span> <span class="token keyword">val</span> THEME_KEY <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"theme"</span></span>

    <span class="token keyword">lateinit</span> <span class="token keyword">var</span> appContext<span class="token operator">:</span> Context
        <span class="token keyword">private</span> <span class="token keyword">set</span>

    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> appConfigSP<span class="token operator">:</span> SharedPreferences

    <span class="token comment">/**
     * Application创建时调用初始化
     */</span>
    <span class="token keyword">fun</span> <span class="token keyword">init</span><span class="token punctuation">(</span>appContext<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>appContext <span class="token operator">=</span> appContext
        appConfigSP <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appContext<span class="token punctuation">.</span><span class="token function">getSharedPreferences</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"AppConfig"</span></span><span class="token punctuation">,</span> Context<span class="token punctuation">.</span>MODE_PRIVATE<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取主题配置
     */</span>
    <span class="token keyword">fun</span> <span class="token function">getTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> AppTheme <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> name <span class="token operator">=</span> appConfigSP<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>THEME_KEY<span class="token punctuation">,</span> AppTheme<span class="token punctuation">.</span>AUTO<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token operator">!!</span>
        <span class="token keyword">return</span> AppTheme<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 写入主题配置
     */</span>
    <span class="token keyword">fun</span> <span class="token function">setTheme</span><span class="token punctuation">(</span>theme<span class="token operator">:</span> AppTheme<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>theme <span class="token operator">==</span> AppTheme<span class="token punctuation">.</span>AUTO<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// delete theme</span>
            appConfigSP<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>THEME_KEY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        appConfigSP<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>THEME_KEY<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">/**
 * 支持的主题
 */</span>
<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token function">AppTheme</span><span class="token punctuation">(</span><span class="token keyword">val</span> mode<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">AUTO</span><span class="token punctuation">(</span>AppCompatDelegate<span class="token punctuation">.</span>MODE_NIGHT_FOLLOW_SYSTEM<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">LIGHT</span><span class="token punctuation">(</span>AppCompatDelegate<span class="token punctuation">.</span>MODE_NIGHT_NO<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">DARK</span><span class="token punctuation">(</span>AppCompatDelegate<span class="token punctuation">.</span>MODE_NIGHT_YES<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">fun</span> <span class="token function">byMode</span><span class="token punctuation">(</span>mode<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> AppTheme <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">firstOrNull</span> <span class="token punctuation">{<!-- --></span> it<span class="token punctuation">.</span>mode <span class="token operator">==</span> mode <span class="token punctuation">}</span> <span class="token operator">?:</span> AUTO
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// -------- RecreateTransition.kt --------</span>
<span class="token keyword">enum</span> <span class="token keyword">class</span> TransitionType <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 进入
     */</span>
    ENTER<span class="token punctuation">,</span>

    <span class="token comment">/**
     * 退出
     */</span>
    EXIT
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 重建过渡动画 data
 * 实现Parcelable接口，用于Activity重建时保存和恢复数据
 */</span>
<span class="token keyword">class</span> <span class="token function">TransitionData</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> centerX<span class="token operator">:</span> Float<span class="token punctuation">,</span>
    <span class="token keyword">val</span> centerY<span class="token operator">:</span> Float<span class="token punctuation">,</span>
    <span class="token keyword">val</span> screenBitmap<span class="token operator">:</span> Bitmap<span class="token punctuation">,</span>
    <span class="token keyword">val</span> type<span class="token operator">:</span> TransitionType<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> Parcelable <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span>parcel<span class="token operator">:</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Parcel<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">(</span>
        parcel<span class="token punctuation">.</span><span class="token function">readFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        parcel<span class="token punctuation">.</span><span class="token function">readFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        parcel<span class="token punctuation">.</span><span class="token function">readParcelable</span><span class="token punctuation">(</span>Bitmap<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">.</span>classLoader<span class="token punctuation">)</span><span class="token operator">!!</span><span class="token punctuation">,</span>
        TransitionType<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>parcel<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!!</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">writeToParcel</span><span class="token punctuation">(</span>parcel<span class="token operator">:</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Parcel<span class="token punctuation">,</span> flags<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        parcel<span class="token punctuation">.</span><span class="token function">writeFloat</span><span class="token punctuation">(</span>centerX<span class="token punctuation">)</span>
        parcel<span class="token punctuation">.</span><span class="token function">writeFloat</span><span class="token punctuation">(</span>centerY<span class="token punctuation">)</span>
        parcel<span class="token punctuation">.</span><span class="token function">writeParcelable</span><span class="token punctuation">(</span>screenBitmap<span class="token punctuation">,</span> flags<span class="token punctuation">)</span>
        parcel<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span>type<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">describeContents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> CREATOR <span class="token operator">:</span> Parcelable<span class="token punctuation">.</span>Creator<span class="token operator">&lt;</span>TransitionData<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">createFromParcel</span><span class="token punctuation">(</span>parcel<span class="token operator">:</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Parcel<span class="token punctuation">)</span><span class="token operator">:</span> TransitionData <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">TransitionData</span><span class="token punctuation">(</span>parcel<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">newArray</span><span class="token punctuation">(</span>size<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>TransitionData<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">arrayOfNulls</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="activity_379"></a>activity重启后通过保存的状态执行动画</h3> 
<p>在onCreate被调用时，通过保存的状态判断是否需要执行过渡动画</p> 
<p>transitionAnimation 方法负责为Activity创建过渡动画。该方法接受一个TransitionData类型的参数，这个参数包含了动画所需的信息。<br> 在方法的开始，ImageView ivTransition被设置为可见，并且其位图被设置为transitionData对象中的screenBitmap（Activity重建前绘制保存的显示内容）。<br> 此时用户看到的 Activity 将呈现出 Activity 重建前的效果，从而营造出 Activity 尚未发生变化的假象。</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
    <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_main<span class="token punctuation">)</span>

    <span class="token operator">..</span><span class="token punctuation">.</span>
    <span class="token comment">// 重建过渡动画</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>savedInstanceState <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        savedInstanceState<span class="token punctuation">.</span>getParcelable<span class="token operator">&lt;</span>TransitionData<span class="token operator">&gt;</span><span class="token punctuation">(</span>TRANSITION_DATA_KEY<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">transitionAnimation</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 过渡动画
 */</span>
<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">transitionAnimation</span><span class="token punctuation">(</span>transitionData<span class="token operator">:</span> TransitionData<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 使用隐藏的 ImageView 显示bitmap</span>
    ivTransition<span class="token punctuation">.</span>visibility <span class="token operator">=</span> View<span class="token punctuation">.</span>VISIBLE
    ivTransition<span class="token punctuation">.</span><span class="token function">setImageBitmap</span><span class="token punctuation">(</span>transitionData<span class="token punctuation">.</span>screenBitmap<span class="token punctuation">)</span>

    ivTransition<span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> animator <span class="token operator">=</span> ValueAnimator<span class="token punctuation">.</span><span class="token function">ofFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">var</span> clipType <span class="token operator">=</span> ClipImageView<span class="token punctuation">.</span>ClipType<span class="token punctuation">.</span>CIRCLE
        <span class="token keyword">when</span> <span class="token punctuation">(</span>transitionData<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            TransitionType<span class="token punctuation">.</span>ENTER <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">// 进入动画，裁切掉圆内的区域 圆由小变大</span>
                animator<span class="token punctuation">.</span><span class="token function">setFloatValues</span><span class="token punctuation">(</span>
                    <span class="token number">0f</span><span class="token punctuation">,</span>
                    <span class="token function">hypot</span><span class="token punctuation">(</span>ivTransition<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ivTransition<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
                clipType <span class="token operator">=</span> ClipImageView<span class="token punctuation">.</span>ClipType<span class="token punctuation">.</span>CIRCLE_REVERSE
            <span class="token punctuation">}</span>

            TransitionType<span class="token punctuation">.</span>EXIT <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">// 退出动画，裁切掉圆外的区域 圆由大变小</span>
                animator<span class="token punctuation">.</span><span class="token function">setFloatValues</span><span class="token punctuation">(</span>
                    <span class="token function">hypot</span><span class="token punctuation">(</span>
                        ivTransition<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        ivTransition<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">toFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token number">0f</span>
                <span class="token punctuation">)</span>
                clipType <span class="token operator">=</span> ClipImageView<span class="token punctuation">.</span>ClipType<span class="token punctuation">.</span>CIRCLE
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        animator<span class="token punctuation">.</span>duration <span class="token operator">=</span>
            resources<span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>R<span class="token punctuation">.</span>integer<span class="token punctuation">.</span>config_longAnimTime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        animator<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span>
            onEnd <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            	<span class="token comment">// 动画结束后隐藏 ImageView</span>
                ivTransition<span class="token punctuation">.</span>visibility <span class="token operator">=</span> View<span class="token punctuation">.</span>GONE
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
        animator<span class="token punctuation">.</span><span class="token function">addUpdateListener</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> radius <span class="token operator">=</span> it<span class="token punctuation">.</span>animatedValue <span class="token keyword">as</span> Float
            <span class="token comment">// 更新裁切区域</span>
            ivTransition<span class="token punctuation">.</span><span class="token function">clipCircle</span><span class="token punctuation">(</span>
                transitionData<span class="token punctuation">.</span>centerX<span class="token punctuation">,</span>
                transitionData<span class="token punctuation">.</span>centerY<span class="token punctuation">,</span>
                radius<span class="token punctuation">,</span>
                clipType
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        animator<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>OK，大功告成。只需要在切换主题时调用transitionRecreate方法即可实现使用过渡动画重建activity</p> 
<h2><a id="Demo_456"></a>Demo源码</h2> 
<p><a href="https://github.com/Thousand-Dust/DemoActivityRecreateTransition">https://github.com/Thousand-Dust/DemoActivityRecreateTransition</a></p>
                </div>
		</div>
		<div id="gabottom"></div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f141660085f4725e50662058a5980e61/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于Python的电影信息爬取与数据可视化分析报告</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b427300f51e5369b179a03ad58439195/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Stable Diffusion【基础篇】：降噪强度（denoising strength）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 编程大咖.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<div id="gafoot"></div>
<script src="https://www.w3counter.com/tracker.js?id=151347"></script>
<script src="https://101121.xyz/ga/app.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>